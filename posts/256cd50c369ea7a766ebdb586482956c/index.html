<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>[1166]CDH集群删除主机节点 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="[1166]CDH集群删除主机节点" />
<meta property="og:description" content="CM 集群下线节点，主要参考官方文档：
操作前调优文档： https://docs.cloudera.com/documentation/enterprise/6/latest/topics/cm_mc_decomm_host.html#concept_urw_wyw_cy操作文档：https://docs.cloudera.com/documentation/enterprise/6/latest/topics/cm_mc_host_maint.html#cm_mc_host_maint 具体步骤如下：
1、开始下线前的自检
# 自检 hdfs 文件是否有损坏 hdfs fsck / -list-corruptfileblocks -openforwrite -files -blocks -locations # 如果文件有损坏，需要进行修复 hdfs fsck file_name -move 2、选择需要下线的主机，开始下线。为了避免下线过程中出现数据丢失的风险，一次下线的主机数量要小于 hdfs block 的副本数量。
3、选择迁移时是否要同步迁移数据，一般时要选择同步迁移数据。然后开始下线节点
4、接着会显示节点下线的进度。同时在NameNode web ui 上会显示 hdfs block 文件向其他节点的同步进度（主要看 Number of Under-Replicated Blocks）。
在 NameNode Summary 页面，可以看到正在下线的节点数量和待迁移的 hdfs block 数量。
5、下线结束后，可以去集群后台使用命令查看各个节点在迁移后的磁盘使用率
hdfs dfsadmin -report 在下线过程中，可能存在以下情况：
参数调优时，设置参数过大，同步速度快但是集群负载高，导致失败；
网络波动导致 NameNode 主备切换，web界面显示下线过程结束了，但后台还在进行；这时会出现block还未迁移完的情况（Under-replicated blocks显示不为0），可以等hdfs自动修复(推荐)，也可以手动修复（速度也很慢）。 手动修复执行脚本如下：
hdfs fsck / | grep &#39;Under replicated&#39; | awk -F&#39;:&#39; &#39;{print $1}&#39; &gt;&gt; /tmp/under_replicated_files 然后循环修复： for hdfsfile in `cat /tmp/under_replicated_files`; do echo &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/256cd50c369ea7a766ebdb586482956c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-22T19:09:53+08:00" />
<meta property="article:modified_time" content="2022-10-22T19:09:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">[1166]CDH集群删除主机节点</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>CM 集群下线节点，主要参考官方文档：</p> 
<ul><li>操作前调优文档： https://docs.cloudera.com/documentation/enterprise/6/latest/topics/cm_mc_decomm_host.html#concept_urw_wyw_cy</li><li>操作文档：https://docs.cloudera.com/documentation/enterprise/6/latest/topics/cm_mc_host_maint.html#cm_mc_host_maint</li></ul> 
<p>具体步骤如下：<br> 1、开始下线前的自检</p> 
<pre><code># 自检 hdfs 文件是否有损坏
hdfs fsck / -list-corruptfileblocks -openforwrite -files -blocks -locations
# 如果文件有损坏，需要进行修复
hdfs fsck file_name -move
</code></pre> 
<p>2、选择需要下线的主机，开始下线。<strong>为了避免下线过程中出现数据丢失的风险，一次下线的主机数量要小于 hdfs block 的副本数量。</strong><br> <img src="https://images2.imgbox.com/96/08/rkFhJ8Ad_o.png" alt="image.png"></p> 
<p>3、选择迁移时是否要同步迁移数据，一般时要选择同步迁移数据。然后开始下线节点<br> <img src="https://images2.imgbox.com/12/96/ajkQCbEt_o.png" alt="image.png"></p> 
<p>4、接着会显示节点下线的进度。同时在NameNode web ui 上会显示 hdfs block 文件向其他节点的同步进度（主要看 Number of Under-Replicated Blocks）。<br> <img src="https://images2.imgbox.com/ea/2d/daC5Gxig_o.png" alt="image.png"></p> 
<p>在 NameNode Summary 页面，可以看到正在下线的节点数量和待迁移的 hdfs block 数量。<br> <img src="https://images2.imgbox.com/90/d1/Hfmzd7K7_o.png" alt="image.png"></p> 
<p>5、下线结束后，可以去集群后台使用命令查看各个节点在迁移后的磁盘使用率</p> 
<pre><code>hdfs dfsadmin -report
</code></pre> 
<p>在下线过程中，可能存在以下情况：</p> 
<ul><li>参数调优时，设置参数过大，同步速度快但是集群负载高，导致失败；<br> 网络波动导致 NameNode 主备切换，web界面显示下线过程结束了，但后台还在进行；</li><li>这时会出现block还未迁移完的情况（Under-replicated blocks显示不为0），可以等hdfs自动修复(推荐)，也可以手动修复（速度也很慢）。</li></ul> 
<p>手动修复执行脚本如下：</p> 
<pre><code>hdfs fsck / | grep 'Under replicated' | awk -F':' '{print $1}' &gt;&gt; /tmp/under_replicated_files 
然后循环修复：
for hdfsfile in `cat /tmp/under_replicated_files`; do echo "Fixing $hdfsfile :" ;  hadoop fs -setrep 3 $hdfsfile; done
</code></pre> 
<p>6、数据迁移完后，开始从CM上删除节点。先进行从<strong>集群中删除主机</strong>，然后进行<strong>Remove Hosts From Cloudera Manager</strong>，直接在对应的页面中使用默认选项确定即可，注意<strong>Remove Hosts From Cloudera Manager</strong>中需要先去下线节点上<strong>手动</strong>停止cm-agent：<br> <img src="https://images2.imgbox.com/fb/0e/nXlVDVq0_o.png" alt="image.png"></p> 
<p><code>systemctl stop cloudera-scm-agent</code>然后直接点击确定即可，这里貌似也会解除授权角色，自动进行数据迁移到其他节点，但我没有这么操作过。</p> 
<h4><a id="_49"></a>附录：</h4> 
<p>hdfs fsck 参数详解：</p> 
<ul><li> <p>Total size ： hdfs集群存储大小，不包括复本大小。</p> </li><li> <p>Total blocks (validated) : 总共的块数量，不包括复本。</p> </li><li> <p>Number of data-nodes ： datanode的节点数量</p> </li><li> <p>Number of racks ： 机架数量</p> </li><li> <p>Default replication factor ： 默认的复制因子</p> </li><li> <p>Average block replication ： 当前块的平均复制数，如果小 default replication factor，则有块丢失</p> </li><li> <p>Under-replicated blocks ： 正在复制块数量，可采用 hadoop fsck -blocks 解决问题</p> </li><li> <p>Mis-replicated blocks ： 正复制的缺少复制块的数量</p> </li><li> <p>Missing replicas ： 缺少复制块的数量，通常情况下Under-replicated blocks\Mis-replicated blocks\Missing replicas 都为0，则集群健康，如果不为0，则缺失块了</p> </li><li> <p>Corrupt blocks ： 坏块的数量，这个值不为0，则说明当前集群有不可恢复的块，即数据有丢失了</p> </li></ul> 
<p>当下架节点时Under-replicated blocks\Mis-replicated blocks\Missing replicas，这三个参数会显示当前，需要补的块的数量，集群会自动补全，当三个参数都为0时，则集群块的复制块完全了。</p> 
<hr> 
<ol><li>登录CM主页 --&gt; 选择“主机” --&gt; “所有主机”，勾选要删除的主机 --&gt;“停止主机上的角色”；</li></ol> 
<p><img src="https://images2.imgbox.com/3a/ae/Oq0z9Dw8_o.png" alt="image.png"></p> 
<p><img src="https://images2.imgbox.com/94/58/OsLizScv_o.png" alt="image.png"></p> 
<ol start="2"><li>后台登录到要被删除的主机，停掉agent服务；已经设置了开机自启动的，要disable掉。</li></ol> 
<pre><code>sudo /etc/init.d/cloudera-scm-agent  stop

systemctl status cloudera-scm-agent
</code></pre> 
<ol start="3"><li>再次登录CM主页 - 主机 - 所有主机，勾选要删除的主机 - 从集群中删除；</li></ol> 
<p><img src="https://images2.imgbox.com/c8/76/wsG1VDwd_o.png" alt="image.png"><br> <img src="https://images2.imgbox.com/59/01/GX5DKzKD_o.png" alt="image.png"></p> 
<ol start="4"><li>再次勾选要删除的主机 - Remove Hosts from Cloudera Manager。<br> <img src="https://images2.imgbox.com/20/0b/13awkygo_o.png" alt="image.png"></li></ol> 
<p>参考：<br> https://blog.csdn.net/lifewujianqiang/article/details/122854978<br> https://blog.csdn.net/hcq_lxq/article/details/121625914<br> https://www.ngui.cc/el/1446007.html?action=onClick</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2baf74a0327cdbad7cf4aabe99b8fe6a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Required Long parameter ‘xx‘ is not present,请求的Long类型参数不存在</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/91b78b985682c12995089886bda3f80b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">从txt文件中读取复制图像</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>