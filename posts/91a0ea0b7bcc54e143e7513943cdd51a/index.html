<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>利用LSTM进行股票预测分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="利用LSTM进行股票预测分析" />
<meta property="og:description" content="需要使用的库：
tusharepytorchpandasnumpymatplotlib 1. 数据导入 import tushare as ts ts.set_token(&#39;98edbe9c3e444002decb09646838a02f0307e41bd5ce51bb5b2a99c8&#39;) ts_pro = ts.pro_api() help(ts) Help on package tushare: NAME tushare - # -*- coding:utf-8 -*- PACKAGE CONTENTS bond (package) coins (package) data (package) fund (package) futures (package) internet (package) pro (package) stock (package) subs (package) trader (package) util (package) VERSION 1.2.62 AUTHOR Jimmy Liu FILE e:\anaconda3\lib\site-packages\tushare\__init__.py # 股票代码 ts_code = &#39;002069.SZ&#39; # 开始时间 start_date = &#39;2006-01-01&#39; # 结束时间 end_date = &#39;2020-01-01&#39; df = ts_pro." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/91a0ea0b7bcc54e143e7513943cdd51a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-08T19:55:10+08:00" />
<meta property="article:modified_time" content="2020-12-08T19:55:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">利用LSTM进行股票预测分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><strong>需要使用的库：</strong></p> 
<ul><li>tushare</li><li>pytorch</li><li>pandas</li><li>numpy</li><li>matplotlib</li></ul> 
<h4><a id="1__7"></a>1. 数据导入</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tushare <span class="token keyword">as</span> ts 

ts<span class="token punctuation">.</span>set_token<span class="token punctuation">(</span><span class="token string">'98edbe9c3e444002decb09646838a02f0307e41bd5ce51bb5b2a99c8'</span><span class="token punctuation">)</span>
ts_pro <span class="token operator">=</span> ts<span class="token punctuation">.</span>pro_api<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token builtin">help</span><span class="token punctuation">(</span>ts<span class="token punctuation">)</span>
</code></pre> 
<pre><code>Help on package tushare:

NAME
    tushare - # -*- coding:utf-8 -*-

PACKAGE CONTENTS
    bond (package)
    coins (package)
    data (package)
    fund (package)
    futures (package)
    internet (package)
    pro (package)
    stock (package)
    subs (package)
    trader (package)
    util (package)

VERSION
    1.2.62

AUTHOR
    Jimmy Liu

FILE
    e:\anaconda3\lib\site-packages\tushare\__init__.py
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 股票代码</span>
ts_code <span class="token operator">=</span> <span class="token string">'002069.SZ'</span>

<span class="token comment"># 开始时间</span>
start_date <span class="token operator">=</span> <span class="token string">'2006-01-01'</span>

<span class="token comment"># 结束时间</span>
end_date <span class="token operator">=</span> <span class="token string">'2020-01-01'</span>

df <span class="token operator">=</span> ts_pro<span class="token punctuation">.</span>daily<span class="token punctuation">(</span>
        ts_code<span class="token operator">=</span>ts_code<span class="token punctuation">,</span>
        start_date<span class="token operator">=</span>start_date<span class="token punctuation">,</span>
        end_date<span class="token operator">=</span>end_date<span class="token punctuation">)</span>

<span class="token comment"># 将获取的文件存储在本地</span>
df<span class="token punctuation">.</span>to_csv<span class="token punctuation">(</span><span class="token string">'002069.csv'</span><span class="token punctuation">,</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd 

df <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'002069.csv'</span><span class="token punctuation">)</span>

<span class="token comment"># 按照时间进行排序，方便预测处理</span>
df <span class="token operator">=</span> df<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'trade_date'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

<span class="token comment"># 简要查看文件信息</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>ts_code</th><th>trade_date</th><th>open</th><th>high</th><th>low</th><th>close</th><th>pre_close</th><th>change</th><th>pct_chg</th><th>vol</th><th>amount</th></tr></thead><tbody><tr><th>3034</th><td>002069.SZ</td><td>20060928</td><td>60.89</td><td>64.48</td><td>58.00</td><td>62.11</td><td>25.00</td><td>37.11</td><td>148.44</td><td>169301.73</td><td>1.028809e+06</td></tr><tr><th>3033</th><td>002069.SZ</td><td>20060929</td><td>64.10</td><td>67.00</td><td>62.48</td><td>62.99</td><td>62.11</td><td>0.88</td><td>1.42</td><td>49290.44</td><td>3.182028e+05</td></tr><tr><th>3032</th><td>002069.SZ</td><td>20061009</td><td>63.00</td><td>66.15</td><td>62.16</td><td>65.00</td><td>62.99</td><td>2.01</td><td>3.19</td><td>28449.04</td><td>1.827514e+05</td></tr><tr><th>3031</th><td>002069.SZ</td><td>20061010</td><td>64.89</td><td>71.50</td><td>64.00</td><td>71.49</td><td>65.00</td><td>6.49</td><td>9.98</td><td>34935.76</td><td>2.381439e+05</td></tr><tr><th>3030</th><td>002069.SZ</td><td>20061011</td><td>70.20</td><td>71.80</td><td>69.22</td><td>69.99</td><td>71.49</td><td>-1.50</td><td>-2.10</td><td>15807.24</td><td>1.109196e+05</td></tr></tbody></table> 
<h4><a id="2__197"></a>2. 数据预处理</h4> 
<pre><code class="prism language-python"><span class="token comment"># 选取这几个属性作为输入特征</span>
use_cols <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'open'</span><span class="token punctuation">,</span> <span class="token string">'high'</span><span class="token punctuation">,</span> <span class="token string">'low'</span><span class="token punctuation">,</span> <span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token string">'pre_close'</span><span class="token punctuation">,</span> <span class="token string">'vol'</span><span class="token punctuation">,</span> <span class="token string">'amount'</span><span class="token punctuation">]</span>
df <span class="token operator">=</span> df<span class="token punctuation">[</span>use_cols<span class="token punctuation">]</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>open</th><th>high</th><th>low</th><th>close</th><th>pre_close</th><th>vol</th><th>amount</th></tr></thead><tbody><tr><th>3034</th><td>60.89</td><td>64.48</td><td>58.00</td><td>62.11</td><td>25.00</td><td>169301.73</td><td>1.028809e+06</td></tr><tr><th>3033</th><td>64.10</td><td>67.00</td><td>62.48</td><td>62.99</td><td>62.11</td><td>49290.44</td><td>3.182028e+05</td></tr><tr><th>3032</th><td>63.00</td><td>66.15</td><td>62.16</td><td>65.00</td><td>62.99</td><td>28449.04</td><td>1.827514e+05</td></tr><tr><th>3031</th><td>64.89</td><td>71.50</td><td>64.00</td><td>71.49</td><td>65.00</td><td>34935.76</td><td>2.381439e+05</td></tr><tr><th>3030</th><td>70.20</td><td>71.80</td><td>69.22</td><td>69.99</td><td>71.49</td><td>15807.24</td><td>1.109196e+05</td></tr></tbody></table> 
<pre><code class="prism language-python"><span class="token comment"># 为了归一化后复现原来数据</span>
close_min <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
close_max <span class="token operator">=</span> df<span class="token punctuation">[</span><span class="token string">'close'</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 归一化处理（0，1）</span>
df<span class="token operator">=</span>df<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> x<span class="token punctuation">:</span><span class="token punctuation">(</span>x<span class="token operator">-</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token operator">-</span><span class="token builtin">min</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
df<span class="token punctuation">.</span>head<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<div> 
</div> 
<table border="1" class="dataframe"><thead><tr><th></th><th>open</th><th>high</th><th>low</th><th>close</th><th>pre_close</th><th>vol</th><th>amount</th></tr></thead><tbody><tr><th>3034</th><td>0.401512</td><td>0.416768</td><td>0.404243</td><td>0.401345</td><td>0.151699</td><td>0.166571</td><td>0.800115</td></tr><tr><th>3033</th><td>0.423566</td><td>0.433710</td><td>0.436792</td><td>0.407265</td><td>0.401345</td><td>0.047720</td><td>0.247007</td></tr><tr><th>3032</th><td>0.416008</td><td>0.427995</td><td>0.434467</td><td>0.420787</td><td>0.407265</td><td>0.027080</td><td>0.141577</td></tr><tr><th>3031</th><td>0.428993</td><td>0.463964</td><td>0.447835</td><td>0.464447</td><td>0.420787</td><td>0.033504</td><td>0.184693</td></tr><tr><th>3030</th><td>0.465476</td><td>0.465981</td><td>0.485760</td><td>0.454356</td><td>0.464447</td><td>0.014561</td><td>0.085666</td></tr></tbody></table> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np 
<span class="token comment"># 序列长度为30，即用前一个月的数据预测之后一天的数据</span>
sequence <span class="token operator">=</span> <span class="token number">30</span>

X <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
Y <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-</span>sequence<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># 选择use_cols作为特征</span>
    X<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span>i<span class="token punctuation">:</span><span class="token punctuation">(</span>i<span class="token operator">+</span>sequence<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">]</span><span class="token punctuation">.</span>values<span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment"># 选择close作为标签输出</span>
    Y<span class="token punctuation">.</span>append<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>df<span class="token punctuation">.</span>iloc<span class="token punctuation">[</span><span class="token punctuation">(</span>i<span class="token operator">+</span>sequence<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dtype<span class="token operator">=</span>np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># 划分训练集和测试集</span>
trainx<span class="token punctuation">,</span> trainy <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token operator">*</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Y<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token operator">*</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
testx<span class="token punctuation">,</span> testy <span class="token operator">=</span> X<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token operator">*</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> Y<span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">(</span><span class="token number">0.8</span><span class="token operator">*</span>df<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>trainx<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>testx<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>2428
577
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">as</span> Data 
torch<span class="token punctuation">.</span>manual_seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>&lt;torch._C.Generator at 0x271cfb1a110&gt;
</code></pre> 
<pre><code class="prism language-python"><span class="token comment"># list -&gt; numpy</span>
trainx <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>trainx<span class="token punctuation">)</span>
trainy <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>trainy<span class="token punctuation">)</span>
testx <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>testx<span class="token punctuation">)</span>
testy <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>testy<span class="token punctuation">)</span>

<span class="token comment"># numpy -&gt; torch</span>
trainx <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>trainx<span class="token punctuation">)</span>
trainy <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>trainy<span class="token punctuation">)</span>
testx <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>testx<span class="token punctuation">)</span>
testy <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>testy<span class="token punctuation">)</span>

<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'trainx size: '</span><span class="token punctuation">,</span> trainx<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'trainy size: '</span><span class="token punctuation">,</span> trainy<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'testx size: '</span><span class="token punctuation">,</span> testx<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'testy size: '</span><span class="token punctuation">,</span> testy<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code>trainx size:  torch.Size([2428, 30, 7])
trainy size:  torch.Size([2428])
testx size:  torch.Size([577, 30, 7])
testy size:  torch.Size([577])
</code></pre> 
<pre><code class="prism language-python"><span class="token comment">#  批处理 batch的大小为32</span>
train_dataset <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>trainx<span class="token punctuation">,</span> trainy<span class="token punctuation">)</span>
test_dataset <span class="token operator">=</span> Data<span class="token punctuation">.</span>TensorDataset<span class="token punctuation">(</span>testx<span class="token punctuation">,</span> testy<span class="token punctuation">)</span>

train_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>train_dataset<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">)</span>

test_loader <span class="token operator">=</span> Data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>
    dataset<span class="token operator">=</span>test_dataset<span class="token punctuation">,</span>
    batch_size<span class="token operator">=</span><span class="token number">32</span><span class="token punctuation">,</span>
    shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
    num_workers<span class="token operator">=</span><span class="token number">2</span>
<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="3__486"></a>3. 定义网络模型</h4> 
<pre><code class="prism language-python">input_size <span class="token operator">=</span> <span class="token number">7</span>
seq_len <span class="token operator">=</span> <span class="token number">30</span>
hidden_size <span class="token operator">=</span> <span class="token number">32</span>
output_size <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F 
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable

<span class="token keyword">class</span> <span class="token class-name">MyNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> input_size<span class="token operator">=</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token operator">=</span>hidden_size<span class="token punctuation">,</span> output_size<span class="token operator">=</span>output_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>MyNet<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>input_size <span class="token operator">=</span> input_size
        self<span class="token punctuation">.</span>hidden_size <span class="token operator">=</span> hidden_size
        self<span class="token punctuation">.</span>output_size <span class="token operator">=</span> output_size
        self<span class="token punctuation">.</span>lstm <span class="token operator">=</span> nn<span class="token punctuation">.</span>LSTM<span class="token punctuation">(</span>input_size<span class="token operator">=</span>input_size<span class="token punctuation">,</span> hidden_size<span class="token operator">=</span>hidden_size<span class="token punctuation">,</span> batch_first<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidden_size<span class="token operator">*</span>seq_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>output_size<span class="token punctuation">)</span>
    
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        out<span class="token punctuation">,</span>_ <span class="token operator">=</span> self<span class="token punctuation">.</span>lstm<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        b<span class="token punctuation">,</span> s<span class="token punctuation">,</span> h <span class="token operator">=</span> out<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
        out <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>out<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>b<span class="token punctuation">,</span> s<span class="token operator">*</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> out 

net <span class="token operator">=</span> MyNet<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>net<span class="token punctuation">)</span>

</code></pre> 
<pre><code>MyNet(
  (lstm): LSTM(7, 32, batch_first=True)
  (fc): Linear(in_features=960, out_features=1, bias=True)
)
</code></pre> 
<h4><a id="4__526"></a>4. 选择损失函数及优化器</h4> 
<pre><code class="prism language-python"><span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim 
<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm

loss_function <span class="token operator">=</span> nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span><span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    total_loss <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> _<span class="token punctuation">,</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> Variable<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        pred <span class="token operator">=</span> net<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
        label <span class="token operator">=</span> Variable<span class="token punctuation">(</span>label<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        label <span class="token operator">=</span> label<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        loss <span class="token operator">=</span> loss_function<span class="token punctuation">(</span>pred<span class="token punctuation">,</span> label<span class="token punctuation">)</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
        total_loss <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
        
    <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Epoch: '</span><span class="token punctuation">,</span> epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">' loss: '</span><span class="token punctuation">,</span> total_loss<span class="token punctuation">)</span>
</code></pre> 
<pre><code> 10%|█         | 10/100 [00:17&lt;02:32,  1.70s/it]Epoch:  10  loss:  0.03518655754669453
 20%|██        | 20/100 [00:34&lt;02:14,  1.68s/it]Epoch:  20  loss:  0.023873500191257335
 30%|███       | 30/100 [00:53&lt;02:11,  1.88s/it]Epoch:  30  loss:  0.02149457185441861
 40%|████      | 40/100 [01:14&lt;02:07,  2.13s/it]Epoch:  40  loss:  0.017912164659719565
 50%|█████     | 50/100 [01:31&lt;01:25,  1.72s/it]Epoch:  50  loss:  0.013031252356086043
 60%|██████    | 60/100 [01:51&lt;01:14,  1.87s/it]Epoch:  60  loss:  0.014165752041662927
 70%|███████   | 70/100 [02:10&lt;01:02,  2.09s/it]Epoch:  70  loss:  0.011516284157551127
 80%|████████  | 80/100 [02:27&lt;00:35,  1.79s/it]Epoch:  80  loss:  0.01033103184090578
 90%|█████████ | 90/100 [02:47&lt;00:17,  1.74s/it]Epoch:  90  loss:  0.010540407126427453
100%|██████████| 100/100 [03:07&lt;00:00,  1.88s/it]Epoch:  100  loss:  0.01101792572899285
</code></pre> 
<h4><a id="5__566"></a>5. 测试模型</h4> 
<pre><code class="prism language-python">pred_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
label_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">for</span> _<span class="token punctuation">,</span> <span class="token punctuation">(</span>data<span class="token punctuation">,</span> label<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
    data <span class="token operator">=</span> Variable<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    pred <span class="token operator">=</span> net<span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    pred_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>pred<span class="token punctuation">.</span>data<span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    label_list<span class="token punctuation">.</span>extend<span class="token punctuation">(</span>label<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

</code></pre> 
<pre><code class="prism language-python">pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>[0.003661651164293289,
 0.004493666812777519,
 0.017206232994794846,
 0.004013188183307648,
 -0.003268543630838394]
</code></pre> 
<pre><code class="prism language-python">label_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code>[0.005449041372351158,
 0.007938109653548601,
 0.015136226034308779,
 0.00538176925664312,
 0.0014127144298688192]
</code></pre> 
<p>简单查看预测结果与真实值，发现相差不是特别明显</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt 


plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> pred_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'pred'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span><span class="token punctuation">[</span>i<span class="token operator">*</span><span class="token punctuation">(</span>close_max<span class="token operator">-</span>close_min<span class="token punctuation">)</span><span class="token operator">+</span>close_min <span class="token keyword">for</span> i <span class="token keyword">in</span> label_list<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'real'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'Stock Forecast'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/9d/71/9BLJIXup_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dbc96cf22afb7a6bc8710f4daa145f7c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">5G智慧路灯杆场景应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80e05ac4d191071e483a7c09b0fcaaf9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HTML注释——小白篇(5)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>