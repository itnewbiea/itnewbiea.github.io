<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>图数据库初探——7. 以红楼梦数据集为例进行Nebula Graph使用 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="图数据库初探——7. 以红楼梦数据集为例进行Nebula Graph使用" />
<meta property="og:description" content="文章目录 0. 关键命令全流程1. 基本操作1. 图的操作 2. 插入节点和关系数据2.0 scheme概念设计2.1 创建schema2.1.1 控制台创建2.1.2 Schema创建 2.2 上传数据2.3 插入数据2.3.1 插入节点2.3.1 插入关系（边） 2.4 经验 3. Nebula Studio的图探索使用3.1 建立索引3.2 查询3.3 查看图探索 报错排查1. Studio连接数据库504 gateway timeout2. SemanticError: Can&#39;t solve the start vids from the sentence: MATCH (v:role) RETURN v3. 返回结果只有三个 有些疑问的地方 0. 关键命令 管理Nebula Service的命令
# 启动所有服务（一般都是启动所有，也可以单独启动某个服务） sudo /usr/local/nebula/scripts/nebula.service start all # 停止所有服务 sudo /usr/local/nebula/scripts/nebula.service stop all # 查看服务状态 sudo /usr/local/nebula/scripts/nebula.service status all 先连接Nebula Graph
cd C:\shaiic_work\nebula_console\ ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4ce2546dde85076f04424bf504f876d0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-02T09:07:58+08:00" />
<meta property="article:modified_time" content="2022-12-02T09:07:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">图数据库初探——7. 以红楼梦数据集为例进行Nebula Graph使用</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#0__1" rel="nofollow">0. 关键命令</a></li><li><a href="#_35" rel="nofollow">全流程</a></li><li><a href="#1__45" rel="nofollow">1. 基本操作</a></li><li><ul><li><a href="#1__46" rel="nofollow">1. 图的操作</a></li></ul> 
  </li><li><a href="#2__85" rel="nofollow">2. 插入节点和关系数据</a></li><li><ul><li><a href="#20_scheme_89" rel="nofollow">2.0 scheme概念设计</a></li><li><a href="#21_schema_110" rel="nofollow">2.1 创建schema</a></li><li><ul><li><a href="#211__120" rel="nofollow">2.1.1 控制台创建</a></li><li><a href="#212_Schema_125" rel="nofollow">2.1.2 Schema创建</a></li></ul> 
   </li><li><a href="#22__132" rel="nofollow">2.2 上传数据</a></li><li><a href="#23__156" rel="nofollow">2.3 插入数据</a></li><li><ul><li><a href="#231__158" rel="nofollow">2.3.1 插入节点</a></li><li><a href="#231__175" rel="nofollow">2.3.1 插入关系（边）</a></li></ul> 
   </li><li><a href="#24__198" rel="nofollow">2.4 经验</a></li></ul> 
  </li><li><a href="#3_Nebula_Studio_202" rel="nofollow">3. Nebula Studio的图探索使用</a></li><li><ul><li><a href="#31__204" rel="nofollow">3.1 建立索引</a></li><li><a href="#32__277" rel="nofollow">3.2 查询</a></li><li><a href="#33__286" rel="nofollow">3.3 查看图探索</a></li></ul> 
  </li><li><a href="#_305" rel="nofollow">报错排查</a></li><li><ul><li><a href="#1_Studio504_gateway_timeout_306" rel="nofollow">1. Studio连接数据库504 gateway timeout</a></li><li><a href="#2_SemanticError_Cant_solve_the_start_vids_from_the_sentence_MATCH_vrole_RETURN_v_324" rel="nofollow">2. SemanticError: Can't solve the start vids from the sentence: MATCH (v:role) RETURN v</a></li><li><a href="#3__351" rel="nofollow">3. 返回结果只有三个</a></li></ul> 
  </li><li><a href="#_407" rel="nofollow">有些疑问的地方</a></li></ul> 
</div> 
<p></p> 
<h2><a id="0__1"></a>0. 关键命令</h2> 
<p>管理Nebula Service的命令</p> 
<pre><code class="prism language-bash"><span class="token comment"># 启动所有服务（一般都是启动所有，也可以单独启动某个服务）</span>
<span class="token function">sudo</span> /usr/local/nebula/scripts/nebula.service start all

<span class="token comment"># 停止所有服务</span>
<span class="token function">sudo</span> /usr/local/nebula/scripts/nebula.service stop all

<span class="token comment"># 查看服务状态</span>
<span class="token function">sudo</span> /usr/local/nebula/scripts/nebula.service status all
</code></pre> 
<p>先连接Nebula Graph</p> 
<pre><code class="prism language-bash"> <span class="token builtin class-name">cd</span> C:<span class="token punctuation">\</span>shaiic_work<span class="token punctuation">\</span>nebula_console<span class="token punctuation">\</span>
./nebula-console.exe <span class="token parameter variable">-addr</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-port</span> <span class="token number">9669</span> <span class="token parameter variable">-u</span> root <span class="token parameter variable">-p</span> <span class="token number">123456</span>
</code></pre> 
<p>启动 Nebula Studio和关闭的，访问<code>ip:7001</code></p> 
<pre><code class="prism language-bash">```bash
<span class="token function">kill</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">lsof</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-i</span> :8080<span class="token variable">)</span></span>
<span class="token builtin class-name">cd</span> nebula-graph-studio
<span class="token function">npm</span> run stop <span class="token comment"># stop nebula-graph-studio</span>

<span class="token builtin class-name">cd</span> nebula-http-gateway
<span class="token function">nohup</span> ./nebula-httpd <span class="token operator">&amp;</span>

<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/nebula-graph-studio
<span class="token function">npm</span> run start
</code></pre> 
<p>以<a href="http://www.openkg.cn/dataset/honglou" rel="nofollow">红楼梦数据集</a>为例，跑一边流程。(这个数据集似乎更新了，和网上大部分红楼梦知识图谱的内容都不一样)</p> 
<hr> 
<h2><a id="_35"></a>全流程</h2> 
<ol><li>创建图<pre><code class="prism language-bash"><span class="token punctuation">(</span>root@nebula<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>none<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> create space <span class="token keyword">if</span> not exists HouLou<span class="token punctuation">(</span>partition_num<span class="token operator">=</span><span class="token number">5</span>,replica_factor<span class="token operator">=</span><span class="token number">1</span>,vid_type <span class="token operator">=</span>int<span class="token punctuation">)</span>
Execution succeeded <span class="token punctuation">(</span>time spent <span class="token number">1089</span>/29335 us<span class="token punctuation">)</span>

Thu, <span class="token number">23</span> Dec <span class="token number">2021</span> <span class="token number">12</span>:47:05 CST
</code></pre> </li></ol> 
<hr> 
<h2><a id="1__45"></a>1. 基本操作</h2> 
<h3><a id="1__46"></a>1. 图的操作</h3> 
<p>关于创建图的语句，参考<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/9.space-statements/1.create-space/" rel="nofollow">这里</a></p> 
<pre><code class="prism language-bash"><span class="token comment"># 完整语法</span>
CREATE SPACE <span class="token punctuation">[</span>IF NOT EXISTS<span class="token punctuation">]</span> <span class="token operator">&lt;</span>graph_space_name<span class="token operator">&gt;</span> <span class="token punctuation">(</span>
    <span class="token punctuation">[</span>partition_num <span class="token operator">=</span> <span class="token operator">&lt;</span>partition_number<span class="token operator">&gt;</span>,<span class="token punctuation">]</span>
    <span class="token punctuation">[</span>replica_factor <span class="token operator">=</span> <span class="token operator">&lt;</span>replica_number<span class="token operator">&gt;</span>,<span class="token punctuation">]</span>
    vid_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>FIXED_STRING<span class="token punctuation">(</span><span class="token operator">&lt;</span>N<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">|</span> INT<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
    <span class="token punctuation">[</span>ON <span class="token operator">&lt;</span>group_name<span class="token operator">&gt;</span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span>COMMENT <span class="token operator">=</span> <span class="token string">'&lt;comment&gt;'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token comment"># 示例</span>
CREATE SPACE basketballplayer<span class="token punctuation">(</span>partition_num<span class="token operator">=</span><span class="token number">15</span>, <span class="token assign-left variable">replica_factor</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">vid_type</span><span class="token operator">=</span>fixed_string<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">))</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/46/27/QJs1rbsA_o.png" alt="在这里插入图片描述" width="800"><br> 对于我来说，我其实就是单机部署，所以硬盘就1个。。。所以我使用的语句类似：</p> 
<pre><code class="prism language-bash">create space <span class="token keyword">if</span> not exists Persona<span class="token punctuation">(</span>partition_num<span class="token operator">=</span><span class="token number">5</span>,replica_factor<span class="token operator">=</span><span class="token number">1</span>,vid_type <span class="token operator">=</span>int<span class="token punctuation">)</span>
</code></pre> 
<ul><li>Persona：用户画像的英语名。。。</li><li>partition_num=5：因为只有1个硬盘，建议设置为5倍的集群硬盘数量</li><li>replica_factor=1：每个分片的副本数量，建议测试环境中设置为1 
  <ul><li>如果将副本数设置为 1，用户将无法使用 BALANCE 命令为 Nebula Graph 的存储服务平衡负载或扩容。</li></ul> </li><li>vid_type: 
  <ul><li>VID表示点（Vertex） ID。在 Nebula Graph 2.0 中支持字符串和整数，需要在创建图空间时设置</li><li>INT64，也就是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
        
         
          
           
           
             2 
            
           
             64 
            
           
          
         
           2^{64} 
          
         
       </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.814108em; vertical-align: 0em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">6</span><span class="mord mtight">4</span></span></span></span></span></span></span></span></span></span></span></span></span>，约等于1.8亿亿，所以可以存很多很多的点。。。</li><li>neo4j中每个节点也有vid<br> <img src="https://images2.imgbox.com/11/f5/gn1a2GlE_o.png" alt="在这里插入图片描述" width="800"></li></ul> </li></ul> 
<hr> 
<p>另外，还有一些额外注意事项</p> 
<ul><li><code>graph_space_name</code>, <code>partition_num</code>, <code>replica_factor</code>, <code>vid_type</code>, <code>comment</code> 设置后就无法改变。除非 <code>DROP SPACE</code>，并重新<code>CREATE SPACE</code>。</li><li>关于大小写的问题，参考<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/1.nGQL-overview/identifier-case-sensitivity/" rel="nofollow">这里</a>： 
  <ul><li>标识符区分大小写(比如space名称，节点名称等，用户定义的东西)</li><li>关键字不区分大小写，函数不区分大小写</li></ul> </li></ul> 
<hr> 
<h2><a id="2__85"></a>2. 插入节点和关系数据</h2> 
<ul><li>在 Nebula Graph 中，+ 想使用nebula studio的可视化的方式直接导入数据，用户必须先有 Schema，再向其中写入点数据和边数据</li><li>可以使用 Nebula Studio 的 控制台 或 Schema 功能创建 Schema</li></ul> 
<h3><a id="20_scheme_89"></a>2.0 scheme概念设计</h3> 
<p>大致会使用两个csv文件：</p> 
<p>第一个是：<code>relation_refined</code></p> 
<pre><code class="prism language-txt">"","人物1","人物2","关系","家族1","家族2"
"1","贾演","贾代化","父亲","贾家宁国府","贾家宁国府"
"2","贾代化","贾演","儿子","贾家宁国府","贾家宁国府"
"3","贾敬","贾代化","儿子","贾家宁国府","贾家宁国府"
"4","贾代化","贾敬","父亲","贾家宁国府","贾家宁国府
</code></pre> 
<p>第二个是：<code>name_use</code></p> 
<pre><code>"","文中名字","标准姓名"
"1","宝钗","薛宝钗"
"2","宝二爷","贾宝玉"
"3","宝哥哥","贾宝玉"
</code></pre> 
<ul><li>设置人物和家族两种节点类型，人物的属性主要是别名和人物名，家族的属性就只有家族名称。</li><li>其中，人物和人物之间具有亲属关系；人物和家族之间具有属于关系。</li></ul> 
<h3><a id="21_schema_110"></a>2.1 创建schema</h3> 
<p>参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/nebula-studio/quick-start/st-ug-create-schema/" rel="nofollow">创建 Schema</a></p> 
<p>边和节点的类型都不支持中文！<br> <img src="https://images2.imgbox.com/96/da/AbWol5Ee_o.png" alt="在这里插入图片描述" width="400"><br> 但是属性的值是支持中文的，属性名称也不支持中文<br> <img src="https://images2.imgbox.com/d7/a9/lwNwWNir_o.png" alt="在这里插入图片描述" width="200"></p> 
<h4><a id="211__120"></a>2.1.1 控制台创建</h4> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> edge <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> no_property<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="212_Schema_125"></a>2.1.2 Schema创建</h4> 
<p>参考：</p> 
<ul><li><a href="https://docs.nebula-graph.com.cn/2.6.1/nebula-studio/manage-schema/st-ug-crud-tag/" rel="nofollow">操作 Tag（点类型）</a></li><li><a href="https://docs.nebula-graph.com.cn/2.6.1/nebula-studio/manage-schema/st-ug-crud-edge-type/" rel="nofollow">操作 Edge type</a></li></ul> 
<p>看图点点，没啥难度，重点是schema的设计。。如果点类型和边类型很多，那就考虑用API去使用python或者C++之类的语言去连接操作。</p> 
<h3><a id="22__132"></a>2.2 上传数据</h3> 
<p>可以看下示例，<code>csv</code>文件不许有标题行（表头），是在上传之后，选择每一列对应的内容的。<br> 但是报错了，</p> 
<ul><li>如果<code>csv</code>文件不是很整齐的三元组之类的数据，要么整理一遍格式之后再去上传。 
  <ul><li>建议的形式是，一个实体/节点类型，一张表，第一列是节点名称，后面列是属性</li><li>一个关系一张表，头节点，尾节点，可能后面还有边的属性。</li></ul> </li><li>要么直接用nSQL语言去上传，或者使用python等语言接口去上传。</li></ul> 
<p>我整理之后的红楼梦数据类似：</p> 
<p><strong>人物角色实体</strong><br> <img src="https://images2.imgbox.com/87/f4/9VxRtsaM_o.png" alt="在这里插入图片描述" width="600"><br> <strong>家族实体</strong><br> <img src="https://images2.imgbox.com/54/01/tOdkujEs_o.png" alt="在这里插入图片描述" width="300"><br> <strong>人物属于家族关系</strong><br> <img src="https://images2.imgbox.com/7f/02/zayQaK3T_o.png" alt="在这里插入图片描述" width="500"><br> <strong>人物之间亲属关系</strong><br> <img src="https://images2.imgbox.com/52/3a/SzjUKFtt_o.png" alt="在这里插入图片描述" width="600"></p> 
<h3><a id="23__156"></a>2.3 插入数据</h3> 
<p>schema虽然使用nebula studio创建很快，但是如果传数据有问题（数据格式不太好的话）。可以考虑直接使用语句进行插入</p> 
<h4><a id="231__158"></a>2.3.1 插入节点</h4> 
<p>参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/12.vertex-statements/1.insert-vertex/" rel="nofollow">https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/12.vertex-statements/1.insert-vertex/</a></p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> VERTEX <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>tag_name<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>prop_name_list<span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>tag_name<span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span>prop_name_list<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
     {<!-- --><span class="token keyword">VALUES</span> <span class="token operator">|</span> <span class="token keyword">VALUE</span>} VID: <span class="token punctuation">(</span><span class="token operator">&lt;</span>prop_value_list<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>prop_value_list<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

prop_name_list:
  <span class="token punctuation">[</span>prop_name <span class="token punctuation">[</span><span class="token punctuation">,</span> prop_name<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

prop_value_list:
  <span class="token punctuation">[</span>prop_value <span class="token punctuation">[</span><span class="token punctuation">,</span> prop_value<span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

</code></pre> 
<p>例如：创建<code>family</code>类型的节点。一次插入多个这种类型的节点。</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> vertex <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> family <span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token string">"family1"</span>:<span class="token punctuation">(</span><span class="token string">"其他"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"family2"</span>:<span class="token punctuation">(</span><span class="token string">"史家"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"family3"</span>:<span class="token punctuation">(</span><span class="token string">"林家"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"family4"</span>:<span class="token punctuation">(</span><span class="token string">"王家"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"family5"</span>:<span class="token punctuation">(</span><span class="token string">"薛家"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"family6"</span>:<span class="token punctuation">(</span><span class="token string">"贾家宁国府"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"family7"</span>:<span class="token punctuation">(</span><span class="token string">"贾家荣国府"</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="231__175"></a>2.3.1 插入关系（边）</h4> 
<ul><li><code>INSERT EDGE</code>语句可以在 Nebula Graph 实例的指定图空间中插入一条或多条边。<strong>边是有方向的，从起始点（src_vid）到目的点（dst_vid）</strong>。</li><li><code>INSERT EDGE</code>的执行方式为覆盖式插入。如果已有 Edge type、起点、终点、rank 都相同的边，则覆盖原边。</li></ul> 
<p>语法：</p> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> EDGE <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>edge_type<span class="token operator">&gt;</span> <span class="token punctuation">(</span> <span class="token operator">&lt;</span>prop_name_list<span class="token operator">&gt;</span> <span class="token punctuation">)</span> {<!-- --><span class="token keyword">VALUES</span> <span class="token operator">|</span> <span class="token keyword">VALUE</span>}
<span class="token operator">&lt;</span>src_vid<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>dst_vid<span class="token operator">&gt;</span><span class="token punctuation">[</span>@<span class="token operator">&lt;</span>rank<span class="token operator">&gt;</span><span class="token punctuation">]</span> : <span class="token punctuation">(</span> <span class="token operator">&lt;</span>prop_value_list<span class="token operator">&gt;</span> <span class="token punctuation">)</span>
<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>src_vid<span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token operator">&lt;</span>dst_vid<span class="token operator">&gt;</span><span class="token punctuation">[</span>@<span class="token operator">&lt;</span>rank<span class="token operator">&gt;</span><span class="token punctuation">]</span> : <span class="token punctuation">(</span> <span class="token operator">&lt;</span>prop_value_list<span class="token operator">&gt;</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">&lt;</span>prop_name_list<span class="token operator">&gt;</span> ::<span class="token operator">=</span>
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>prop_name<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>prop_name<span class="token operator">&gt;</span> <span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>

<span class="token operator">&lt;</span>prop_value_list<span class="token operator">&gt;</span> ::<span class="token operator">=</span>
  <span class="token punctuation">[</span> <span class="token operator">&lt;</span>prop_value<span class="token operator">&gt;</span> <span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>prop_value<span class="token operator">&gt;</span> <span class="token punctuation">]</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span>
</code></pre> 
<p>例如：创建人物和人物之间的亲属关系类型的边。</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> edge <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> BelongToFamily <span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token string">"role13"</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">"role18"</span>:<span class="token punctuation">(</span><span class="token string">"父子"</span><span class="token punctuation">)</span>
<span class="token comment"># 类似的，如果想一次插入两条边</span>
<span class="token keyword">insert</span> edge <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> BelongToFamily <span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token string">"role13"</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">"role18"</span>:<span class="token punctuation">(</span><span class="token string">"父子"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string">"role1"</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token string">"role8"</span>:<span class="token punctuation">(</span><span class="token string">"母女"</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="24__198"></a>2.4 经验</h3> 
<ul><li>nebula有点奇葩。。。neo4j的VID是插入时自动生成的，对用户不可见。但是这个nebula是对用户可见的，需要用户自己管理。</li><li>所以从这个角度来说，创建space时VID类型使用string类型更好一些，这样就可以 实体类型+序号，起码不用自己记序号。。。无语。</li></ul> 
<h2><a id="3_Nebula_Studio_202"></a>3. Nebula Studio的图探索使用</h2> 
<p>这里其实需要掌握一些nSQL语句，因为这个图探索仅仅是可视化检索后结果的内容。</p> 
<h3><a id="31__204"></a>3.1 建立索引</h3> 
<p>参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/7.general-query-statements/2.match/#pattern" rel="nofollow">match-使用模式（pattern</a></p> 
<blockquote> 
 <p><code>MATCH</code>语句使用原生索引查找起始点或边，起始点或边可以在模式的任何位置。<br> 即一个有效的<code>MATCH</code>语句，必须有一个属性、Tag 或 Edge type 已经创建索引，或者在<code>WHERE</code>子句中用 id() 函数指定了特定点的 VID。</p> 
</blockquote> 
<p>所以VID是检索时直接定位的，但是想要检索更广泛的内容还是必须要建立索引。（这不是很垃圾？？？？耍流氓？？？？）</p> 
<p>所以我需要对上面两种节点类型，以及两种边类型都建立索引。</p> 
<p>创建原生索引的语法，参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/14.native-index-statements/1.create-native-index/" rel="nofollow">CREATE INDEX</a></p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> {TAG <span class="token operator">|</span> EDGE} <span class="token keyword">INDEX</span> <span class="token punctuation">[</span><span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span>index_name<span class="token operator">&gt;</span> <span class="token keyword">ON</span> {<!-- --><span class="token operator">&lt;</span>tag_name<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token operator">&lt;</span>edge_name<span class="token operator">&gt;</span>} 
<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token operator">&lt;</span>prop_name_list<span class="token operator">&gt;</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'&lt;comment&gt;'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果要创建<code>tag索引</code>(这里其实就是对VID建立了索引)，例如对role类型的节点</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> tag <span class="token keyword">index</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> role_index <span class="token keyword">on</span> role<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>如果要对<code>role.csv</code>中的人物姓名这一<code>属性</code>建立索引，可以</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> tag <span class="token keyword">index</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> name <span class="token keyword">on</span> role<span class="token punctuation">(</span>name<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<ul><li><strong>prop_name_list</strong>： 
  <ul><li>为变长字符串属性创建索引时，必须用<code>prop_name(length)</code>指定索引长度；</li><li>为 Tag 或 Edge type 本身创建索引时，忽略&lt;prop_name_list&gt;。</li></ul> </li><li>对Tag类型为role的所有节点创建属性name的索引，索引长度为 10。即只使用属性name的前 10 个字符来创建索引。</li></ul> 
<p>如果是创建<code>边</code>的索引，例如，对人物属于某家族的关系，可以</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> edge <span class="token keyword">index</span> BelongToFamily_index <span class="token keyword">on</span> BelongToFamily<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<p>所以整体建立了6个索引（2个节点类型索引，2个边索引，2个属性索引）</p> 
<pre><code class="prism language-sql"><span class="token comment"># 先建立索引</span>
<span class="token keyword">create</span> tag <span class="token keyword">index</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> role_index <span class="token keyword">on</span> role<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> tag <span class="token keyword">index</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> family_index <span class="token keyword">on</span> family<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> edge <span class="token keyword">index</span> BelongToFamily_index <span class="token keyword">on</span> BelongToFamily<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> edge <span class="token keyword">index</span> kinship_index <span class="token keyword">on</span> kinship<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 创建单属性索引</span>
<span class="token keyword">create</span> tag <span class="token keyword">index</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> role_name_index <span class="token keyword">on</span> role<span class="token punctuation">(</span>name<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">create</span> edge <span class="token keyword">index</span> <span class="token keyword">if</span> <span class="token operator">not</span> <span class="token keyword">exists</span> kinship_type_index <span class="token keyword">on</span> kinship<span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment"># 再重构索引</span>
REBUILD TAG <span class="token keyword">INDEX</span> role_index
<span class="token comment"># 会提示这是一个NEW JOB 可以使用SHOW JOB 121 查看任务进度</span>
REBUILD TAG <span class="token keyword">INDEX</span> family_index
REBUILD TAG <span class="token keyword">INDEX</span> role_name_index

REBUILD edge <span class="token keyword">INDEX</span> BelongToFamily_index
REBUILD edge <span class="token keyword">INDEX</span> kinship_index
REBUILD edge <span class="token keyword">INDEX</span> kinship_type_index
</code></pre> 
<p><img src="https://images2.imgbox.com/c6/97/2pBeW6Br_o.png" alt="在这里插入图片描述" width="600"></p> 
<p>也可以在构建之前先查看下有没有索引，或者构建完看看建立好了没</p> 
<pre><code class="prism language-sql"><span class="token comment"># 记得先切换到特定的图空间</span>
<span class="token keyword">use</span> SPACE

<span class="token comment"># 查看节点索引</span>
<span class="token keyword">SHOW</span> TAG INDEXES

<span class="token comment"># 查看边索引</span>
<span class="token keyword">SHOW</span> EDGE INDEXES
</code></pre> 
<p><img src="https://images2.imgbox.com/d3/e2/PiFuDtDa_o.png" alt="在这里插入图片描述" width="400"></p> 
<h3><a id="32__277"></a>3.2 查询</h3> 
<p><strong>返回所有节点和边</strong></p> 
<p>如果数据比较少的话，可以暴力一点，直接展示全部数据</p> 
<pre><code class="prism language-sql"><span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span>
<span class="token keyword">return</span> v 
</code></pre> 
<p><img src="https://images2.imgbox.com/e0/bc/nQZFCUDE_o.png" alt="在这里插入图片描述" width="300"></p> 
<h3><a id="33__286"></a>3.3 查看图探索</h3> 
<pre><code class="prism language-sql"><span class="token comment"># 查看关系</span>
<span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span>rel:kinship<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>o:role<span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">,</span>rel<span class="token punctuation">,</span>o

<span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span>rel:kinship{<!-- --><span class="token keyword">type</span>:<span class="token string">"奴才"</span>}<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>o:role<span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">,</span>rel<span class="token punctuation">,</span>o
<span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span>rel:BelongToFamily<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>o:family<span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">,</span>rel<span class="token punctuation">,</span>o
<span class="token comment"># 查看节点</span>
<span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span> <span class="token keyword">return</span> v
</code></pre> 
<p><img src="https://images2.imgbox.com/d5/04/qb5nL0JU_o.png" alt="在这里插入图片描述" width="600"><br> <img src="https://images2.imgbox.com/b6/28/nb90wcq2_o.png" alt="在这里插入图片描述" width="600"></p> 
<h2><a id="_305"></a>报错排查</h2> 
<h3><a id="1_Studio504_gateway_timeout_306"></a>1. Studio连接数据库504 gateway timeout</h3> 
<p>参考：</p> 
<ul><li><a href="https://discuss.nebula-graph.com.cn/t/topic/4063/22" rel="nofollow">Studio连接数据库504 gateway timeout</a></li><li><a href="https://discuss.nebula-graph.com.cn/t/topic/3731/14" rel="nofollow">Studio -v2查询报504</a></li></ul> 
<p>其实解决方案就是重启就行。。。</p> 
<pre><code class="prism language-bash"><span class="token function">kill</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">lsof</span> <span class="token parameter variable">-t</span> <span class="token parameter variable">-i</span> :8080<span class="token variable">)</span></span>
<span class="token builtin class-name">cd</span> nebula-graph-studio
<span class="token function">npm</span> run stop <span class="token comment"># stop nebula-graph-studio</span>

<span class="token builtin class-name">cd</span> nebula-http-gateway
<span class="token function">nohup</span> ./nebula-httpd <span class="token operator">&amp;</span>

<span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/nebula-graph-studio
<span class="token function">npm</span> run start
</code></pre> 
<h3><a id="2_SemanticError_Cant_solve_the_start_vids_from_the_sentence_MATCH_vrole_RETURN_v_324"></a>2. SemanticError: Can’t solve the start vids from the sentence: MATCH (v:role) RETURN v</h3> 
<ul><li>无法解析vid（也可以认为，是建立了索引查不出来数据）</li><li>参考：<a href="https://discuss.nebula-graph.com.cn/t/topic/3888/13" rel="nofollow">建立了索引查不出数据</a></li><li>参考：<a href="https://discuss.nebula-graph.com.cn/t/topic/4242/77" rel="nofollow">已针对tag属性创建索引，但match匹配不到数据</a></li></ul> 
<p>有一点需要注意的是：<strong>创建索引之前的数据需要rebuild一下才能查出来</strong><br> <img src="https://images2.imgbox.com/06/30/Dx8s3TKz_o.png" alt="在这里插入图片描述" width="400"><br> 可以看到，我这里是没有进行过rebuild。（如果rebuild过，但是删除了索引，那么也会报这个错误，此时还是需要重新rebuild）</p> 
<p>参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/14.native-index-statements/4.rebuild-native-index/" rel="nofollow">REBUILD INDEX</a></p> 
<blockquote> 
 <p><strong>索引功能不会自动对其创建之前已存在的存量数据生效————在索引重建完成之前，无法基于该索引使用LOOKUP和MATCH语句查询到存量数据。<br> 重建索引期间，所有查询都会跳过索引并执行顺序扫描，返回结果可能不一致。</strong></p> 
</blockquote> 
<hr> 
<p>参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/14.native-index-statements/1.create-native-index/" rel="nofollow">CREATE INDEX</a></p> 
<p><strong>索引配合LOOKUP和MATCH语句使用</strong></p> 
<ul><li>不要任意在生产环境中使用索引，除非很清楚使用索引对业务的影响。索引会导致写性能下降 90%甚至更多。</li><li>索引并不用于查询加速。只用于：根据属性定位到点或边，或者统计点边数量。</li><li>长索引会降低 Storage 服务的扫描性能，以及占用更多内存。建议将索引长度设置为和要被索引的最长字符串相同。索引长度最长为 255，超过部分会被截断。</li></ul> 
<hr> 
<p>鉴于上述文字，那就不使用lookup和match语句了，不建立索引了。使用其他的查询语句好了。<br> 但是看了一下，这东西不建立索引根本用不了，无语😒😒😒</p> 
<h3><a id="3__351"></a>3. 返回结果只有三个</h3> 
<p><strong>解决</strong></p> 
<p>一个很大的乌龙，因为没有点击<code>导入</code>按钮，所以每次查询的时候只有预览里的三个值。。。（无语）<br> <img src="https://images2.imgbox.com/b7/bb/pOn7N96J_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<p>查看存储数据日志，没看到什么有用的信息<br> <img src="https://images2.imgbox.com/86/03/9NcPJwAh_o.png" alt="在这里插入图片描述"><br> 尝试使用别的语句：</p> 
<pre><code class="prism language-sql"><span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span>rel:kinship<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>o:role<span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">,</span>rel<span class="token punctuation">,</span>o
<span class="token keyword">match</span> <span class="token punctuation">(</span>v:role<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">[</span>rel:BelongToFamily<span class="token punctuation">]</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>o:family<span class="token punctuation">)</span> <span class="token keyword">return</span> v<span class="token punctuation">,</span>rel<span class="token punctuation">,</span>o
</code></pre> 
<p>返回空（没有关系。。。无语）</p> 
<hr> 
<p>参考：</p> 
<ul><li> <p><a href="https://discuss.nebula-graph.com.cn/t/topic/2429" rel="nofollow">lookup结果</a></p> </li><li> <p><a href="https://discuss.nebula-graph.com.cn/t/topic/6376" rel="nofollow">rebuild index的问题</a></p> </li><li> <p>不靠谱，除了自己的论坛，别的地方基本没有博客写问题解决方案，太小众了，这东西没啥人用；</p> </li><li> <p>另外，版本更新似乎有些问题，待修复的bug不少，不稳定，很容易出错，广告打得挺多。</p> </li><li> <p>只有nebula自己在知乎，博客园，CSDN的官方账号最活跃，其他基本没见到什么文章，就算有，也基本就是官方文档的复现，没什么用。</p> </li></ul> 
<p>反正我的索引都建立好了，难不成是因为建立的少了？？？</p> 
<p>参考下图:<br> <img src="https://images2.imgbox.com/1c/8e/eGiOeyJe_o.png" alt="在这里插入图片描述" width="300"><br> <img src="https://images2.imgbox.com/9c/3a/AgyF6W5h_o.png" alt="在这里插入图片描述" width="300"><br> 那干脆试试重启一下好了。。。</p> 
<p>想起之前：<a href="https://docs.nebula-graph.com.cn/2.6.1/2.quick-start/4.nebula-graph-crud/#_1" rel="nofollow">异步实现创建和修改</a><br> <img src="https://images2.imgbox.com/c6/46/4RmLUzQZ_o.png" alt="在这里插入图片描述" width="600"><br> 不行就重启咯，关闭Nebula服务之后重启，依然无效。</p> 
<hr> 
<p>参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/3.ngql-guide/7.general-query-statements/2.match/#match_1" rel="nofollow">MATCH 工作流程</a><br> <img src="https://images2.imgbox.com/f9/30/pvoUC2nL_o.png" alt="在这里插入图片描述" width="600"><br> 所以重新建立一次索引好了？？？</p> 
<hr> 
<h2><a id="_407"></a>有些疑问的地方</h2> 
<p>关于nebula的API，似乎还不是非常完善，参考：<a href="https://docs.nebula-graph.com.cn/2.6.1/20.appendix/6.eco-tool-version/#apisdk" rel="nofollow">生态工具概览</a><br> <img src="https://images2.imgbox.com/de/2f/5sJ6JVd7_o.png" alt="在这里插入图片描述" width="300"><br> <a href="https://github.com/vesoft-inc/nebula-python/tree/v2.6.0">https://github.com/vesoft-inc/nebula-python/tree/v2.6.0</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd74ac9d263ff215fb72425e104cd98d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">关于Math（工具类）的介绍和其常用方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e650396b5013678ecfc6463ae343d8d6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Ceres学习】1. 安装</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>