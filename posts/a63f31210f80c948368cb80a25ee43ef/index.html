<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s集群之Pod镜像管理&#43;私有仓库harbor搭建 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s集群之Pod镜像管理&#43;私有仓库harbor搭建" />
<meta property="og:description" content="文章目录 一、pod的容器分类1.1、Pod 特点1.2、Pod的容器分类 二、镜像拉取策略 (image PullPolicy)2.1、尝试编辑一个pod并指定拉取策略 三、搭建 k8s 的私有仓库 一、pod的容器分类 1.1、Pod 特点 最小部署单元一组容器的集合一个Pod中的容器共享网络命名空间Pod是短暂的，有自己的生命周期。 1.2、Pod的容器分类 1、infrastructure container：基础容器
维护整个pod网络空间：可以在node节点操作查看容器的网络
[root@localhost ~]# cat /opt/kubernetes/cfg/kubelet 2、initcontainers：初始化容器
先于业务容器开始执行，原先pod中容器是并行开启，现在进行了改进 3、container：业务容器
业务容器就是我们创建的pod资源内的容器服务，业务容器也叫APP容器，并行启动 二、镜像拉取策略 (image PullPolicy) IfNotPresent：默认值，镜像在宿主机上不存在时才拉取。
Always：每次创建Pod都会重新拉取一次镜像，可以保证都是最新版本镜像。
Never：Pod 永远不会主动拉取这个镜像
查看镜像拉取策略（master节点查看）：
[root@master1 demo]# kubectl get pod NAME READY STATUS RESTARTS AGE nginx-deployment-d55b94fd-hbnkr 0/1 Pending 0 2m52s nginx-deployment-d55b94fd-qdj27 0/1 Pending 0 2m51s nginx-deployment-d55b94fd-x5zd7 0/1 Pending 0 2m52s [root@master1 demo]# kubectl edit deploy/nginx-deployment #编辑Pod资源查看策略 2.1、尝试编辑一个pod并指定拉取策略 [root@localhost ~]# cd demo/ [root@localhost demo]# vim pod1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a63f31210f80c948368cb80a25ee43ef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-13T11:30:53+08:00" />
<meta property="article:modified_time" content="2020-05-13T11:30:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s集群之Pod镜像管理&#43;私有仓库harbor搭建</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#pod_1" rel="nofollow">一、pod的容器分类</a></li><li><ul><li><a href="#11Pod__2" rel="nofollow">1.1、Pod 特点</a></li><li><a href="#12Pod_8" rel="nofollow">1.2、Pod的容器分类</a></li></ul> 
   </li><li><a href="#_image_PullPolicy_21" rel="nofollow">二、镜像拉取策略 (image PullPolicy)</a></li><li><ul><li><a href="#21pod_40" rel="nofollow">2.1、尝试编辑一个pod并指定拉取策略</a></li></ul> 
   </li><li><a href="#_k8s__85" rel="nofollow">三、搭建 k8s 的私有仓库</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="pod_1"></a>一、pod的容器分类</h3> 
<h4><a id="11Pod__2"></a>1.1、Pod 特点</h4> 
<ul><li>最小部署单元</li><li>一组容器的集合</li><li>一个Pod中的容器共享网络命名空间</li><li>Pod是短暂的，有自己的生命周期。</li></ul> 
<h4><a id="12Pod_8"></a>1.2、Pod的容器分类</h4> 
<p>1、infrastructure container：基础容器<br> 维护整个pod网络空间：可以在node节点操作查看容器的网络</p> 
<pre><code>[root@localhost ~]# cat /opt/kubernetes/cfg/kubelet
</code></pre> 
<p><img src="https://images2.imgbox.com/69/94/CIXgQq5s_o.png" alt="在这里插入图片描述"><br> 2、initcontainers：初始化容器</p> 
<ul><li>先于业务容器开始执行，原先pod中容器是并行开启，现在进行了改进</li></ul> 
<p>3、container：业务容器</p> 
<ul><li>业务容器就是我们创建的pod资源内的容器服务，业务容器也叫APP容器，并行启动</li></ul> 
<h3><a id="_image_PullPolicy_21"></a>二、镜像拉取策略 (image PullPolicy)</h3> 
<ul><li> <p><strong>IfNotPresent：默认值，镜像在宿主机上不存在时才拉取。</strong></p> </li><li> <p><strong>Always：每次创建Pod都会重新拉取一次镜像，可以保证都是最新版本镜像。</strong></p> </li><li> <p><strong>Never：Pod 永远不会主动拉取这个镜像</strong></p> </li></ul> 
<p>查看镜像拉取策略（master节点查看）：</p> 
<pre><code>[root@master1 demo]# kubectl get pod
NAME                              READY   STATUS    RESTARTS   AGE
nginx-deployment-d55b94fd-hbnkr   0/1     Pending   0          2m52s
nginx-deployment-d55b94fd-qdj27   0/1     Pending   0          2m51s
nginx-deployment-d55b94fd-x5zd7   0/1     Pending   0          2m52s

[root@master1 demo]# kubectl edit deploy/nginx-deployment     #编辑Pod资源查看策略
</code></pre> 
<p><img src="https://images2.imgbox.com/6f/57/w5VzqBdS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="21pod_40"></a>2.1、尝试编辑一个pod并指定拉取策略</h4> 
<pre><code>[root@localhost ~]# cd demo/
[root@localhost demo]# vim pod1.yaml
apiVersion: v1
kind: Pod
metadata:
  name: mypod
spec:
  containers:
    - name: nginx
      image: nginx:1.14
      imagePullPolicy: Always
</code></pre> 
<pre><code>[root@master1 demo]# kubectl create -f pod1.yaml
pod/mypod created

[root@master1 demo]# kubectl get pod
NAME    READY   STATUS    RESTARTS   AGE
mypod   1/1     Running   0          52s
</code></pre> 
<p>查看容器详细信息：kubectl describe pod 名称<br> <img src="https://images2.imgbox.com/bb/df/hA0lAsPI_o.png" alt="在这里插入图片描述"><br> //查看分配节点</p> 
<pre><code>[root@localhost demo]# kubectl get pods -o wide
NAME                READY  STATUS   RESTARTS  AGE   IP       NODE        NOMINATED NODE

mypod               1/1   Running  0      118s  172.17.31.6  192.168.195.150  &lt;none&gt;
</code></pre> 
<p>//在任意node节点使用 curl 查看头部信息</p> 
<pre><code>[root@node2 ~]# curl -I 172.17.57.3     
HTTP/1.1 200 OK
Server: nginx/1.14.2
Date: Wed, 13 May 2020 02:12:07 GMT
Content-Type: text/html
Content-Length: 612
Last-Modified: Tue, 04 Dec 2018 14:44:49 GMT
Connection: keep-alive
ETag: "5c0692e1-264"
Accept-Ranges: bytes
</code></pre> 
<h3><a id="_k8s__85"></a>三、搭建 k8s 的私有仓库</h3> 
<p>1、开局优化，修改主机名（harbor），关闭防火墙，上传docker-compose和harbor的软件包（操作不在赘述），私有仓库的IP地址为：192.168.100.134</p> 
<p>2、docker 和 docker-compose 安装，可以看我之前的博客。<br> 博客链接：<a href="https://blog.csdn.net/qq_28361541/article/details/105387355">Docker之入门初了解、部署与镜像加速、网络优化</a></p> 
<p>3、 安装harbor</p> 
<pre><code>[root@harbor ~]# tar zxf harbor-offline-installer-v1.2.2.tgz -C /usr/local/	
[root@harbor ~]# cd /usr/local/harbor/
[root@harbor harbor]# ls
</code></pre> 
<p><img src="https://images2.imgbox.com/de/c0/AjhgoHMq_o.png" alt="在这里插入图片描述"><br> 修改harbor的参数文件harbor.cfg</p> 
<pre><code>[root@harbor harbor]# vi harbor.cfg 
hostname = 192.168.100.134     ##修改为监听本地地址，不可以使用localhost或者127.0.0.1
[root@harbor harbor]# sh install.sh   
</code></pre> 
<p><img src="https://images2.imgbox.com/b0/ca/ePCzH2Le_o.png" alt="在这里插入图片描述"><br> 到这里，harbor安装已经完成</p> 
<p>4、登录harbor界面，在浏览器输入192.168.100.134，新建私有项目project<br> <img src="https://images2.imgbox.com/cc/45/X5xeVz17_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0c/3d/2TAV2xdA_o.png" alt="在这里插入图片描述"><br> 5、所有node节点都要修改daemon-json文件，指定harbor仓库地址，修改完文件后记得重启Docker</p> 
<pre><code>[root@node1 ~]# vim /etc/docker/daemon.json 
</code></pre> 
<p><img src="https://images2.imgbox.com/c9/e3/4U2FeZ4h_o.png" alt="在这里插入图片描述"></p> 
<pre><code>[root@node1 ~]# systemctl daemon-reload
[root@node1 ~]# systemctl restart docker
</code></pre> 
<p>注意：在使用harbor下载镜像创建资源时候，要保证node处于harbor登录状态<br> //其中一个node节点登录harbor私有仓库</p> 
<pre><code>[root@node1 ~]# docker login 192.168.100.134
Username: admin
Password: 
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
</code></pre> 
<pre><code>//下载Tomcat镜像进行推送
[root@node1 ~]# docker pull tomcat:8.0.52

//打标签
[root@node1 ~]# docker tag tomcat:8.0.52 192.168.100.134/project/tomcat
此处IP地址是harbor地址

//上传镜像到仓库
[root@node1 ~]# docker push 192.168.100.134/project/tomcat
</code></pre> 
<p>6、指定node节点从私有仓库下载</p> 
<ul><li>查看node节点登录harbor的凭据（所有node节点的凭据是一样的）</li></ul> 
<pre><code>[root@node1 ~]# cat .docker/config.json |base64 -w 0
ewoJImF1dGhzIjogewoJCSIxOTIuMTY4LjEwMC4xMzQiOiB7CgkJCSJhdXRoIjogIllXUnRhVzQ2U0dGeVltOXlNVEl6TkRVPSIKCQl9Cgl9LAoJIkh0dHBIZWFkZXJzIjogewoJCSJVc2VyLUFnZW50IjogIkRvY2tlci1DbGllbnQvMTkuMDMuOCAobGludXgpIgoJfQp9
</code></pre> 
<ul><li>在master节点创建secret资源</li></ul> 
<pre><code>[root@master1 demo]# vim registry-pull-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: registry-pull-secret
data:
  .dockerconfigjson: ewoJImF1dGhzIjogewoJCSIxOTIuMTY4LjEwMC4xMzQiOiB7CgkJCSJhdXRoIjogIllXUnRhVzQ2U0dGeVltOXlNVEl6TkRVPSIKCQl9Cgl9LAoJIkh0dHBIZWFkZXJzIjogewoJCSJVc2VyLUFnZW50IjogIkRvY2tlci1DbGllbnQvMTkuMDMuOCAobGludXgpIgoJfQp9
type: kubernetes.io/dockerconfigjson

//创建secret资源
[root@master test]# kubectl create -f registry-pull-secret.yaml 	   
secret/registry-pull-secret created

//查看secret资源
[root@master1 demo]# kubectl get secret
NAME                   TYPE                                  DATA   AGE
default-token-9qgnr    kubernetes.io/service-account-token   3      13d
registry-pull-secret   kubernetes.io/dockerconfigjson        1      50s
</code></pre> 
<p>在master节点上创建资源从harbor中下载镜像</p> 
<pre><code>[root@localhost demo]# vim tomcat-deployment.yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: my-tomcat
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: my-tomcat
    spec:
      imagePullSecrets:
      - name: registry-pull-secret
      containers:
      - name: my-tomcat
        image: 192.168.195.80/project/tomcat
        ports:
        - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: my-tomcat
spec:
  type: NodePort
  ports:
  - port: 8080
    targetPort: 8080
    nodePort: 31111
  selector:
    app: my-tomcat
</code></pre> 
<p>创建资源并查看</p> 
<pre><code>[root@master1 demo]# kubectl create -f tomcat-deployment.yaml 

[root@master1 demo]# kubectl get pod
NAME                         READY   STATUS    RESTARTS   AGE
my-tomcat-7d697d459b-5g6zw   1/1     Running   0          33s
my-tomcat-7d697d459b-9wgd2   1/1     Running   0          33s
mypod                        1/1     Running   1          92m
</code></pre> 
<p>此时查看harbor镜像仓库，发现镜像被下载了两次。<br> <img src="https://images2.imgbox.com/7f/ef/fZ8Ho2aY_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/20a98c96996ca344b63328ca680d97c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">An HTTP error occurred when trying to retrieve this URL.anaconda问题解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ce62e58e06c623e02a4f65e3f9081f16/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前后端API交互加密解密（js、Java）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>