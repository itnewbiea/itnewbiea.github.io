<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android11 DNS解析流程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android11 DNS解析流程" />
<meta property="og:description" content="Android11 DNS解析 1. DNS解析概念 ​ DNS的全称是domain name system，即域名系统。主要目的是将域名解析为IP地址，域名是方便用户记忆，但网络传输中源目地址使用IP地址来进行标识的，所以Android中的网络应用程序在发起http请求之前必然要经历DNS解析过程。
2. Android11的DNS解析过程 2.1 Inet6AddressImpl.lookupHostByName Android app不管用什么网络框架，dns解析都会走到Inet6AddressImpl.lookupHostByName方法，我们就以这个方法为入口开始看代码：
/** * Resolves a hostname to its IP addresses using a cache. * * @param host the hostname to resolve. * @param netId the network to perform resolution upon. * @return the IP addresses of the host. */ private static InetAddress[] lookupHostByName(String host, int netId) throws UnknownHostException { //参数host代表dns解析的域名，netId代表使用的网络，如wifi，数据网络等等都是可以自己选择的 BlockGuard.getThreadPolicy().onNetwork(); // 缓存中是否已经有了，这里的缓存只是应用进程的缓存（TTL为2s），并不是DNS的TTL缓存 ... try { StructAddrinfo hints = new StructAddrinfo(); //不指定协议族，返回包括 IPv4 和 IPv6 的所有地址 hints." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5e75c74dcb87f2e37c5aaff728eb2dcd/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-16T21:35:07+08:00" />
<meta property="article:modified_time" content="2023-06-16T21:35:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android11 DNS解析流程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Android11_DNS_0"></a>Android11 DNS解析</h2> 
<h3><a id="1_DNS_2"></a>1. DNS解析概念</h3> 
<p>​ DNS的全称是domain name system，即域名系统。主要目的是将域名解析为IP地址，域名是方便用户记忆，但网络传输中源目地址使用IP地址来进行标识的，所以Android中的网络应用程序在发起http请求之前必然要经历DNS解析过程。</p> 
<h3><a id="2_Android11DNS_6"></a>2. Android11的DNS解析过程</h3> 
<h4><a id="21_Inet6AddressImpllookupHostByName_8"></a>2.1 Inet6AddressImpl.lookupHostByName</h4> 
<p>Android app不管用什么网络框架，dns解析都会走到<code>Inet6AddressImpl.lookupHostByName</code>方法，我们就以这个方法为入口开始看代码：</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Resolves a hostname to its IP addresses using a cache.
 *
 * @param host the hostname to resolve.
 * @param netId the network to perform resolution upon.
 * @return the IP addresses of the host.
 */</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">lookupHostByName</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> netId<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">UnknownHostException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//参数host代表dns解析的域名，netId代表使用的网络，如wifi，数据网络等等都是可以自己选择的</span>
    <span class="token class-name">BlockGuard</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 缓存中是否已经有了，这里的缓存只是应用进程的缓存（TTL为2s），并不是DNS的TTL缓存</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">StructAddrinfo</span> hints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StructAddrinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//不指定协议族，返回包括 IPv4 和 IPv6 的所有地址</span>
        hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> AI_ADDRCONFIG<span class="token punctuation">;</span>
        hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> AF_UNSPEC<span class="token punctuation">;</span>
        <span class="token comment">//指定socket类型为TCP</span>
        hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> SOCK_STREAM<span class="token punctuation">;</span>
        <span class="token comment">//真正进行DNS解析的方法</span>
        <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> addresses <span class="token operator">=</span> <span class="token class-name">Libcore</span><span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> netId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> addresses<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">GaiException</span> gaiException<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 常见的无网报错</span>
        <span class="token class-name">String</span> detailMessage <span class="token operator">=</span> <span class="token string">"Unable to resolve host \""</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">"\": "</span> <span class="token operator">+</span> <span class="token class-name">Libcore</span><span class="token punctuation">.</span>os<span class="token punctuation">.</span><span class="token function">gai_strerror</span><span class="token punctuation">(</span>gaiException<span class="token punctuation">.</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addressCache<span class="token punctuation">.</span><span class="token function">putUnknownHost</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> netId<span class="token punctuation">,</span> detailMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">throw</span> gaiException<span class="token punctuation">.</span><span class="token function">rethrowAsUnknownHostException</span><span class="token punctuation">(</span>detailMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="22_BlockGuardOsandroid_getaddrinfo_48"></a>2.2 BlockGuardOs.android_getaddrinfo</h4> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> node<span class="token punctuation">,</span> <span class="token class-name">StructAddrinfo</span> hints<span class="token punctuation">,</span> <span class="token keyword">int</span> netId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GaiException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// With AI_NUMERICHOST flag set, the node must a numerical network address, therefore no</span>
    <span class="token comment">// host address lookups will be performed. In this case, it is fine to perform on main</span>
    <span class="token comment">// thread.</span>
    <span class="token keyword">boolean</span> isNumericHost <span class="token operator">=</span> <span class="token punctuation">(</span>hints<span class="token punctuation">.</span>ai_flags <span class="token operator">&amp;</span> AI_NUMERICHOST<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isNumericHost<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">BlockGuard</span><span class="token punctuation">.</span><span class="token function">getThreadPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onNetwork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> netId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="23_Linuxandroid_getaddrinfo_63"></a>2.3 Linux.android_getaddrinfo</h4> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">native</span> <span class="token class-name">InetAddress</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">android_getaddrinfo</span><span class="token punctuation">(</span><span class="token class-name">String</span> node<span class="token punctuation">,</span> <span class="token class-name">StructAddrinfo</span> hints<span class="token punctuation">,</span> <span class="token keyword">int</span> netId<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GaiException</span><span class="token punctuation">;</span>
</code></pre> 
<p>这里是一个native方法，对应的native层函数是<code>libcore_io_Linux.Linux_android_getaddrinfo</code></p> 
<h4><a id="24_libcore_io_LinuxLinux_android_getaddrinfo_71"></a>2.4 libcore_io_Linux.Linux_android_getaddrinfo</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> jobjectArray <span class="token function">Linux_android_getaddrinfo</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject<span class="token punctuation">,</span> jstring javaNode<span class="token punctuation">,</span>
          jobject javaHints<span class="token punctuation">,</span> jint netId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      ScopedUtfChars <span class="token function">node</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> javaNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  
      <span class="token keyword">static</span> jfieldID flagsFid <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetFieldID</span><span class="token punctuation">(</span><span class="token class-name">JniConstants</span><span class="token double-colon punctuation">::</span><span class="token function">GetStructAddrinfoClass</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ai_flags"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">static</span> jfieldID familyFid <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetFieldID</span><span class="token punctuation">(</span><span class="token class-name">JniConstants</span><span class="token double-colon punctuation">::</span><span class="token function">GetStructAddrinfoClass</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ai_family"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">static</span> jfieldID socktypeFid <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetFieldID</span><span class="token punctuation">(</span><span class="token class-name">JniConstants</span><span class="token double-colon punctuation">::</span><span class="token function">GetStructAddrinfoClass</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ai_socktype"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">static</span> jfieldID protocolFid <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetFieldID</span><span class="token punctuation">(</span><span class="token class-name">JniConstants</span><span class="token double-colon punctuation">::</span><span class="token function">GetStructAddrinfoClass</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"ai_protocol"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      addrinfo hints<span class="token punctuation">;</span>
      <span class="token function">memset</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>hints<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//使用java层传递的协议项，socket设置等构造addrinfo对象</span>
      hints<span class="token punctuation">.</span>ai_flags <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> flagsFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span>ai_family <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> familyFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> socktypeFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
      hints<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetIntField</span><span class="token punctuation">(</span>javaHints<span class="token punctuation">,</span> protocolFid<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
      addrinfo<span class="token operator">*</span> addressList <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">//addressList接收最终的DNS解析结果，这里传的server name是null</span>
      <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token function">android_getaddrinfofornet</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>hints<span class="token punctuation">,</span> netId<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>addressList<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//省略后续构造java层对象返回的代码</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><code>android_getaddrinfofornet</code>这个函数会调到getaddrinfo.c中：</p> 
<h4><a id="25_getaddrinfoandroid_getaddrinfofornet_106"></a>2.5 getaddrinfo.android_getaddrinfofornet</h4> 
<p>getaddrinfo.c中经过一系列内部调用，对数据转换，封装之后最终调到<code>android_getaddrinfo_proxy</code>这个函数：</p> 
<h4><a id="26_getaddrinfoandroid_getaddrinfo_proxy_110"></a>2.6 getaddrinfo.android_getaddrinfo_proxy</h4> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>__ANDROID__<span class="token punctuation">)</span></span></span>
<span class="token comment">// Returns 0 on success, else returns on error.</span>
<span class="token keyword">static</span> <span class="token keyword">int</span>
<span class="token function">android_getaddrinfo_proxy</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>servname<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span>hints<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span> <span class="token operator">*</span><span class="token operator">*</span>res<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> netid<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token keyword">int</span> success <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
   <span class="token comment">//省略一些判断</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token comment">//这是核心方法，这里会打开一个socket文件</span>
   FILE<span class="token operator">*</span> proxy <span class="token operator">=</span> <span class="token function">fdopen</span><span class="token punctuation">(</span>__netdClientDispatch<span class="token punctuation">.</span><span class="token function">dnsOpenProxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"r+"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>proxy <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> EAI_SYSTEM<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   netid <span class="token operator">=</span> __netdClientDispatch<span class="token punctuation">.</span><span class="token function">netIdForResolv</span><span class="token punctuation">(</span>netid<span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">//向socket发送请求，其实就是向socket对端写入字符串</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fprintf</span><span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> <span class="token string">"getaddrinfo %s %s %d %d %d %d %u"</span><span class="token punctuation">,</span>
          hostname <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"^"</span> <span class="token operator">:</span> hostname<span class="token punctuation">,</span>
          servname <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token string">"^"</span> <span class="token operator">:</span> servname<span class="token punctuation">,</span>
          hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-&gt;</span>ai_flags<span class="token punctuation">,</span>
          hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-&gt;</span>ai_family<span class="token punctuation">,</span>
          hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-&gt;</span>ai_socktype<span class="token punctuation">,</span>
          hints <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> hints<span class="token operator">-&gt;</span>ai_protocol<span class="token punctuation">,</span>
          netid<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
   <span class="token comment">// literal NULL byte at end, required by FrameworkListener</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fputc</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">EOF</span> <span class="token operator">||</span>
       <span class="token function">fflush</span><span class="token punctuation">(</span>proxy<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">char</span> buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token comment">// 将对端返回的消息放入buf</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">int</span> result_code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token function">strtol</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// verify the code itself</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>result_code <span class="token operator">!=</span> DnsProxyQueryResult<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">fread</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> proxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">goto</span> exit<span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token operator">*</span> ai <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
   <span class="token keyword">struct</span> <span class="token class-name">addrinfo</span><span class="token operator">*</span><span class="token operator">*</span> nextres <span class="token operator">=</span> res<span class="token punctuation">;</span>
   <span class="token comment">//填充addrinfo数据，这是返回的DNS解析数据，代码省略了，不是重点</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token keyword">return</span> EAI_NODATA<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<p>上述函数的，主要作用是打开一个socket描述符，然后向此socket写入一堆字符串，我们需要关注的是打开的是哪个socket？监听此socket的进程是哪个？对端如何处理写入的字符串？</p> 
<p>首先来看<code>__netdClientDispatch.dnsOpenProxy()</code>是什么东西？</p> 
<p>来看下面一段代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">FunctionType</span><span class="token operator">&gt;</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> handle<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> symbol<span class="token punctuation">,</span> FunctionType<span class="token operator">*</span> function<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">typedef</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>InitFunctionType<span class="token punctuation">)</span><span class="token punctuation">(</span>FunctionType<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    InitFunctionType initFunction <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>InitFunctionType<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function">dlsym</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> symbol<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>initFunction <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">initFunction</span><span class="token punctuation">(</span>function<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">netdClientInitImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Prevent netd from looping back fwmarkd connections to itself. It would work, but it's</span>
    <span class="token comment">// a deadlock hazard and unnecessary overhead for the resolver.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span><span class="token function">basename</span><span class="token punctuation">(</span><span class="token function">getprogname</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"netd"</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">async_safe_format_log</span><span class="token punctuation">(</span>ANDROID_LOG_INFO<span class="token punctuation">,</span> <span class="token string">"netdClient"</span><span class="token punctuation">,</span>
                              <span class="token string">"Skipping libnetd_client init since *we* are netd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span><span class="token operator">*</span> handle <span class="token operator">=</span> <span class="token function">dlopen</span><span class="token punctuation">(</span><span class="token string">"libnetd_client.so"</span><span class="token punctuation">,</span> RTLD_NOW<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>handle <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// If the library is not available, it's not an error. We'll just use</span>
        <span class="token comment">// default implementations of functions that it would've overridden.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitAccept4"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>accept4<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitConnect"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>connect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSendmmsg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>sendmmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSendmsg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>sendmsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSendto"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>sendto<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitSocket"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>socket<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitNetIdForResolv"</span><span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>netIdForResolv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">netdClientInitFunction</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"netdClientInitDnsOpenProxy"</span><span class="token punctuation">,</span>
                           <span class="token operator">&amp;</span>__netdClientDispatch<span class="token punctuation">.</span>dnsOpenProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码用到了<code>dlopen</code>和<code>dlsym</code>函数，<code>dlopen</code>打开的<code>libnetd_client.so</code>定义在netd进程中：</p> 
<p><img src="https://images2.imgbox.com/d3/1f/vnBCPBva_o.png" alt="在这里插入图片描述"></p> 
<p><code>dlsym</code>函数获取了<code>libnetd_client.so</code>中的<code>netdClientInitDnsOpenProxy</code>函数地址，其代码实现如下所示：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">void</span> <span class="token function">netdClientInitDnsOpenProxy</span><span class="token punctuation">(</span>DnsOpenProxyType<span class="token operator">*</span> function<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>function<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>function <span class="token operator">=</span> dns_open_proxy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>&amp;__netdClientDispatch.dnsOpenProxy</code>地址被传入上述函数，作为函数指针指向了<code>dns_open_proxy</code>函数，所以最终我们知道了前面的<code>fdopen</code>函数打开的socket的是在<code>dns_open_proxy</code>函数中返回的</p> 
<h4><a id="27_NetdClientdns_open_proxy_232"></a>2.7 NetdClient.dns_open_proxy</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">dns_open_proxy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">const</span> <span class="token keyword">auto</span> socketFunc <span class="token operator">=</span> libcSocket <span class="token operator">?</span> libcSocket <span class="token operator">:</span> socket<span class="token punctuation">;</span>
    <span class="token keyword">int</span> s <span class="token operator">=</span> <span class="token function">socketFunc</span><span class="token punctuation">(</span>AF_UNIX<span class="token punctuation">,</span> SOCK_STREAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> one <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token function">setsockopt</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_REUSEADDR<span class="token punctuation">,</span> <span class="token operator">&amp;</span>one<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>one<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr_un</span> proxy_addr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span>sun_family <span class="token operator">=</span> AF_UNIX<span class="token punctuation">,</span>
            <span class="token punctuation">.</span>sun_path <span class="token operator">=</span> <span class="token string">"/dev/socket/dnsproxyd"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token keyword">auto</span> connectFunc <span class="token operator">=</span> libcConnect <span class="token operator">?</span> libcConnect <span class="token operator">:</span> connect<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TEMP_FAILURE_RETRY</span><span class="token punctuation">(</span>
                <span class="token function">connectFunc</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">sockaddr</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>proxy_addr<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>proxy_addr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Store the errno for connect because we only care about why we can't connect to dnsproxyd</span>
        <span class="token keyword">int</span> storedErrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">close</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
        errno <span class="token operator">=</span> storedErrno<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码一目了然，作为客户端打开<code>/dev/socket/dnsproxyd</code>并连接，回到<code>getaddrinfo.android_getaddrinfo_proxy</code>函数中，socket连接上之后，发送**“getaddrinfo %s %s %d %d %d %d %u”**字符串，流程图如下：</p> 
<p><img src="https://images2.imgbox.com/e2/06/nDx5RdDG_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-MP8J1uYg-1686898811898)(C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20230616144316150.png)]"></p> 
<p>接着需要知道监听<code>/dev/socket/dnsproxyd</code>的服务端是哪个进程？如何处理客户端的字符串？</p> 
<p>这个socket的服务端在netd进程里面通过<code>SocketListener</code>监听的，所以DNS相关的请求字符串发给了netd：</p> 
<p><img src="https://images2.imgbox.com/d5/c3/PIt6atCf_o.png" alt="在这里插入图片描述"></p> 
<p>接着看字符串的处理，服务端对这些客户端发送的字符处理方式是通过<code>FrameworkListener</code>注册的命令来处理的，<code>getaddrinfo</code>对应的是<code>GetAddrInfoCmd</code>，直接上代码：</p> 
<h4><a id="28_DnsProxyListenerGetAddrInfoCmdrunCommand_278"></a>2.8 DnsProxyListener::GetAddrInfoCmd::runCommand</h4> 
<pre><code class="prism language-cpp">DnsProxyListener<span class="token double-colon punctuation">::</span><span class="token class-name">GetAddrInfoCmd</span><span class="token double-colon punctuation">::</span><span class="token function">GetAddrInfoCmd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">FrameworkCommand</span><span class="token punctuation">(</span><span class="token string">"getaddrinfo"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token keyword">int</span> DnsProxyListener<span class="token double-colon punctuation">::</span><span class="token class-name">GetAddrInfoCmd</span><span class="token double-colon punctuation">::</span><span class="token function">runCommand</span><span class="token punctuation">(</span>SocketClient <span class="token operator">*</span>cli<span class="token punctuation">,</span>
                                            <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//省略一些合法性判断</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    
    addrinfo<span class="token operator">*</span> hints <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_flags <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_family <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_socktype <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> ai_protocol <span class="token operator">=</span> <span class="token function">strtol</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> netId <span class="token operator">=</span> <span class="token function">strtoul</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> useLocalNameservers <span class="token operator">=</span> <span class="token function">checkAndClearUseLocalNameserversFlag</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>netId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> uid_t uid <span class="token operator">=</span> cli<span class="token operator">-&gt;</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> pid <span class="token operator">=</span> cli<span class="token operator">-&gt;</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    android_net_context netcontext<span class="token punctuation">;</span>
    <span class="token comment">//构造netcontext</span>
    gResNetdCallbacks<span class="token punctuation">.</span><span class="token function">get_network_context</span><span class="token punctuation">(</span>netId<span class="token punctuation">,</span> uid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>netcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai_flags <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ai_family <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span>
        ai_socktype <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">||</span> ai_protocol <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//构造addrinfo</span>
        hints <span class="token operator">=</span> <span class="token punctuation">(</span>addrinfo<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">calloc</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>addrinfo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        hints<span class="token operator">-&gt;</span>ai_flags <span class="token operator">=</span> ai_flags<span class="token punctuation">;</span>
        hints<span class="token operator">-&gt;</span>ai_family <span class="token operator">=</span> ai_family<span class="token punctuation">;</span>
        hints<span class="token operator">-&gt;</span>ai_socktype <span class="token operator">=</span> ai_socktype<span class="token punctuation">;</span>
        hints<span class="token operator">-&gt;</span>ai_protocol <span class="token operator">=</span> ai_protocol<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    DnsProxyListener<span class="token double-colon punctuation">::</span>GetAddrInfoHandler<span class="token operator">*</span> handler <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">DnsProxyListener</span><span class="token double-colon punctuation">::</span><span class="token function">GetAddrInfoHandler</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> name<span class="token punctuation">,</span> service<span class="token punctuation">,</span> hints<span class="token punctuation">,</span> netcontext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">tryThreadOrError</span><span class="token punctuation">(</span>cli<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="29_DnsProxyListenerGetAddrInfoHandlerrun_319"></a>2.9 DnsProxyListener::GetAddrInfoHandler::run</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> DnsProxyListener<span class="token double-colon punctuation">::</span><span class="token class-name">GetAddrInfoHandler</span><span class="token double-colon punctuation">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"GetAddrInfoHandler::run: {"</span> <span class="token operator">&lt;&lt;</span> mNetContext<span class="token punctuation">.</span>app_netid <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
               <span class="token operator">&lt;&lt;</span> mNetContext<span class="token punctuation">.</span>app_mark <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> mNetContext<span class="token punctuation">.</span>dns_netid <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span>
               <span class="token operator">&lt;&lt;</span> mNetContext<span class="token punctuation">.</span>dns_mark <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> mNetContext<span class="token punctuation">.</span>uid <span class="token operator">&lt;&lt;</span> <span class="token string">" "</span> <span class="token operator">&lt;&lt;</span> mNetContext<span class="token punctuation">.</span>flags <span class="token operator">&lt;&lt;</span> <span class="token string">"}"</span><span class="token punctuation">;</span>

     
    addrinfo<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    Stopwatch s<span class="token punctuation">;</span>
    <span class="token function">maybeFixupNetContext</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mNetContext<span class="token punctuation">,</span> mClient<span class="token operator">-&gt;</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> uid_t uid <span class="token operator">=</span> mClient<span class="token operator">-&gt;</span><span class="token function">getUid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int32_t</span> rv <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    NetworkDnsEventReported event<span class="token punctuation">;</span>
    <span class="token function">initDnsEvent</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>event<span class="token punctuation">,</span> mNetContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>queryLimiter<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">evaluate_domain_name</span><span class="token punctuation">(</span>mNetContext<span class="token punctuation">,</span> mHost<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//核心函数，result用于接收最后的结果</span>
            rv <span class="token operator">=</span> <span class="token function">resolv_getaddrinfo</span><span class="token punctuation">(</span>mHost<span class="token punctuation">,</span> mService<span class="token punctuation">,</span> mHints<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mNetContext<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">,</span>
                                    <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            rv <span class="token operator">=</span> EAI_SYSTEM<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        queryLimiter<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//IPv4，IPv6地址转换，当 DNS 查询请求中的查询类型为 AAAA（IPv6 地址查询）且查询结果为空时</span>
    <span class="token comment">//使用IPv4进行查询</span>
    <span class="token function">doDns64Synthesis</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rv<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">,</span> <span class="token operator">&amp;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int32_t</span> latencyUs <span class="token operator">=</span> <span class="token generic-function"><span class="token function">saturate_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">timeTakenUs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">set_latency_micros</span><span class="token punctuation">(</span>latencyUs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">set_event_type</span><span class="token punctuation">(</span>EVENT_GETADDRINFO<span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">set_hints_ai_flags</span><span class="token punctuation">(</span><span class="token punctuation">(</span>mHints <span class="token operator">?</span> mHints<span class="token operator">-&gt;</span>ai_flags <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">bool</span> success <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// getaddrinfo failed</span>
        success <span class="token operator">=</span> <span class="token operator">!</span>mClient<span class="token operator">-&gt;</span><span class="token function">sendBinaryMsg</span><span class="token punctuation">(</span>ResponseCode<span class="token double-colon punctuation">::</span>DnsProxyOperationFailed<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rv<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>rv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//DNS解析成功</span>
        success <span class="token operator">=</span> <span class="token operator">!</span>mClient<span class="token operator">-&gt;</span><span class="token function">sendCode</span><span class="token punctuation">(</span>ResponseCode<span class="token double-colon punctuation">::</span>DnsProxyQueryResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> result<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>ai <span class="token operator">&amp;&amp;</span> success<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//DNS解析数据返回给客户端</span>
            success <span class="token operator">=</span> <span class="token function">sendBE32</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">sendaddrinfo</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> ai<span class="token punctuation">)</span><span class="token punctuation">;</span>
            ai <span class="token operator">=</span> ai<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        success <span class="token operator">=</span> success <span class="token operator">&amp;&amp;</span> <span class="token function">sendBE32</span><span class="token punctuation">(</span>mClient<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>上面重点函数<code>resolv_getaddrinfo</code>，DNS解析核心函数：</p> 
<h4><a id="210_getaddrinforesolv_getaddrinfo_377"></a>2.10 getaddrinfo.resolv_getaddrinfo</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">resolv_getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> _Nonnull hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> servname<span class="token punctuation">,</span> <span class="token keyword">const</span> addrinfo<span class="token operator">*</span> hints<span class="token punctuation">,</span>
                       <span class="token keyword">const</span> android_net_context<span class="token operator">*</span> _Nonnull netcontext<span class="token punctuation">,</span> addrinfo<span class="token operator">*</span><span class="token operator">*</span> _Nonnull res<span class="token punctuation">,</span>
                       NetworkDnsEventReported<span class="token operator">*</span> _Nonnull event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//省略一些判断</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    addrinfo ai <span class="token operator">=</span> hints <span class="token operator">?</span> <span class="token operator">*</span>hints <span class="token operator">:</span> addrinfo<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    addrinfo sentinel <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    addrinfo<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token operator">&amp;</span>sentinel<span class="token punctuation">;</span>
    <span class="token comment">//explore_options里面定义了一些条件，必须匹配才能进行解析</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Explore<span class="token operator">&amp;</span> ex <span class="token operator">:</span> explore_options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">.</span>ai_family <span class="token operator">!=</span> ex<span class="token punctuation">.</span>e_af<span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MATCH</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>ai_socktype<span class="token punctuation">,</span> ex<span class="token punctuation">.</span>e_socktype<span class="token punctuation">,</span> <span class="token function">WILD_SOCKTYPE</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">MATCH</span><span class="token punctuation">(</span>ai<span class="token punctuation">.</span>ai_protocol<span class="token punctuation">,</span> ex<span class="token punctuation">.</span>e_protocol<span class="token punctuation">,</span> <span class="token function">WILD_PROTOCOL</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

        addrinfo tmp <span class="token operator">=</span> ai<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>ai_socktype <span class="token operator">==</span> ANY <span class="token operator">&amp;&amp;</span> ex<span class="token punctuation">.</span>e_socktype <span class="token operator">!=</span> ANY<span class="token punctuation">)</span> tmp<span class="token punctuation">.</span>ai_socktype <span class="token operator">=</span> ex<span class="token punctuation">.</span>e_socktype<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">.</span>ai_protocol <span class="token operator">==</span> ANY <span class="token operator">&amp;&amp;</span> ex<span class="token punctuation">.</span>e_protocol <span class="token operator">!=</span> ANY<span class="token punctuation">)</span> tmp<span class="token punctuation">.</span>ai_protocol <span class="token operator">=</span> ex<span class="token punctuation">.</span>e_protocol<span class="token punctuation">;</span>
        <span class="token comment">//核心函数</span>
        error <span class="token operator">=</span> <span class="token function">explore_fqdn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tmp<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cur<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">,</span> netcontext<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> cur <span class="token operator">=</span> cur<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Propagate the last error from explore_fqdn(), but only when *all* attempts failed.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>res <span class="token operator">=</span> sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO: consider removing freeaddrinfo.</span>
    <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>res <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>error <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> EAI_FAIL <span class="token operator">:</span> error<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="211_getaddrinfoexplore_fqdn_417"></a>2.11 getaddrinfo.explore_fqdn</h4> 
<pre><code class="prism language-cpp"><span class="token comment">// FQDN hostname, DNS lookup</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">explore_fqdn</span><span class="token punctuation">(</span><span class="token keyword">const</span> addrinfo<span class="token operator">*</span> pai<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> hostname<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> servname<span class="token punctuation">,</span>
                        addrinfo<span class="token operator">*</span><span class="token operator">*</span> res<span class="token punctuation">,</span> <span class="token keyword">const</span> android_net_context<span class="token operator">*</span> netcontext<span class="token punctuation">,</span>
                        NetworkDnsEventReported<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    

    addrinfo<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> error <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// If the servname does not match socktype/protocol, return error code.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>error <span class="token operator">=</span> <span class="token function">get_portmatch</span><span class="token punctuation">(</span>pai<span class="token punctuation">,</span> servname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">return</span> error<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">files_getaddrinfo</span><span class="token punctuation">(</span>netcontext<span class="token operator">-&gt;</span>dns_netid<span class="token punctuation">,</span> hostname<span class="token punctuation">,</span> pai<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"djtang....files_getaddrinfo == false."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        error <span class="token operator">=</span> <span class="token function">dns_getaddrinfo</span><span class="token punctuation">(</span>hostname<span class="token punctuation">,</span> pai<span class="token punctuation">,</span> netcontext<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>addrinfo<span class="token operator">*</span> cur <span class="token operator">=</span> result<span class="token punctuation">;</span> cur<span class="token punctuation">;</span> cur <span class="token operator">=</span> cur<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// canonname should be filled already</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>error <span class="token operator">=</span> <span class="token function">get_port</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> servname<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">freeaddrinfo</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> error<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token operator">*</span>res <span class="token operator">=</span> result<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码首先会去缓存文件<code>/system/etc/hosts</code>去查看是否已经有域名对应IP地址了，如果没有，再调<code>dns_getaddrinfo</code>函数获取，测试了一下dns解析成功之后也不会将解析结果写入<code>/system/etc/hosts</code>，关于<code>files_getaddrinfo</code>函数查缓存的细节就不展开了，不是重点，继续分析<code>dns_getaddrinfo</code>：</p> 
<h4><a id="212_getaddrinfodns_getaddrinfo_455"></a>2.12 getaddrinfo.dns_getaddrinfo</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">dns_getaddrinfo</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> addrinfo<span class="token operator">*</span> pai<span class="token punctuation">,</span>
                           <span class="token keyword">const</span> android_net_context<span class="token operator">*</span> netcontext<span class="token punctuation">,</span> addrinfo<span class="token operator">*</span><span class="token operator">*</span> rv<span class="token punctuation">,</span>
                           NetworkDnsEventReported<span class="token operator">*</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//IPv6，IPv4的解析结果</span>
    res_target q <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    res_target q2 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">//省略一堆ipv4，ipv6判断</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    ResState res<span class="token punctuation">;</span>
    <span class="token comment">//将netcontext的值赋给res</span>
    <span class="token function">res_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">,</span> netcontext<span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> he<span class="token punctuation">;</span>
    <span class="token comment">//进行dns解析</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">res_searchN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token punctuation">,</span> <span class="token operator">&amp;</span>res<span class="token punctuation">,</span> <span class="token operator">&amp;</span>he<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//dns解析失败</span>
        <span class="token keyword">return</span> <span class="token function">herrnoToAiErrno</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    addrinfo sentinel <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    addrinfo<span class="token operator">*</span> cur <span class="token operator">=</span> <span class="token operator">&amp;</span>sentinel<span class="token punctuation">;</span>
    <span class="token comment">//获取解析结果</span>
    addrinfo<span class="token operator">*</span> ai <span class="token operator">=</span> <span class="token function">getanswer</span><span class="token punctuation">(</span>q<span class="token punctuation">.</span>answer<span class="token punctuation">,</span> q<span class="token punctuation">.</span>n<span class="token punctuation">,</span> q<span class="token punctuation">.</span>name<span class="token punctuation">,</span> q<span class="token punctuation">.</span>qtype<span class="token punctuation">,</span> pai<span class="token punctuation">,</span> <span class="token operator">&amp;</span>he<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cur<span class="token operator">-&gt;</span>ai_next <span class="token operator">=</span> ai<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cur <span class="token operator">&amp;&amp;</span> cur<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">)</span> cur <span class="token operator">=</span> cur<span class="token operator">-&gt;</span>ai_next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>q<span class="token punctuation">.</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//获取解析结果</span>
        ai <span class="token operator">=</span> <span class="token function">getanswer</span><span class="token punctuation">(</span>q2<span class="token punctuation">.</span>answer<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>n<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>name<span class="token punctuation">,</span> q2<span class="token punctuation">.</span>qtype<span class="token punctuation">,</span> pai<span class="token punctuation">,</span> <span class="token operator">&amp;</span>he<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ai<span class="token punctuation">)</span> cur<span class="token operator">-&gt;</span>ai_next <span class="token operator">=</span> ai<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sentinel<span class="token punctuation">.</span>ai_next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Note that getanswer() doesn't set the pair NETDB_INTERNAL and errno.</span>
        <span class="token comment">// See also herrnoToAiErrno().</span>
        <span class="token keyword">return</span> <span class="token function">herrnoToAiErrno</span><span class="token punctuation">(</span>he<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">_rfc6724_sort</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sentinel<span class="token punctuation">,</span> netcontext<span class="token operator">-&gt;</span>app_mark<span class="token punctuation">,</span> netcontext<span class="token operator">-&gt;</span>uid<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">*</span>rv <span class="token operator">=</span> sentinel<span class="token punctuation">.</span>ai_next<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="213_getaddrinfores_searchN_504"></a>2.13 getaddrinfo.res_searchN</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">res_searchN</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> res_target<span class="token operator">*</span> target<span class="token punctuation">,</span> res_state res<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> herrno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> cp<span class="token punctuation">;</span>
    HEADER<span class="token operator">*</span> hp<span class="token punctuation">;</span>
    <span class="token comment">//定义"."的数量</span>
    <span class="token keyword">uint32_t</span> dots<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> saved_herrno<span class="token punctuation">;</span>
    <span class="token keyword">int</span> got_nodata <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> got_servfail <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> tried_as_is <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

 

    hp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>target<span class="token operator">-&gt;</span>answer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    errno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>herrno <span class="token operator">=</span> HOST_NOT_FOUND<span class="token punctuation">;</span> <span class="token comment">/* default, if we never query */</span>
    dots <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">//这段循环的意思是查看name域名中的"."的数量</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>cp <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token operator">*</span>cp<span class="token punctuation">;</span> cp<span class="token operator">++</span><span class="token punctuation">)</span> dots <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token operator">*</span>cp <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> trailing_dot <span class="token operator">=</span> <span class="token punctuation">(</span>cp <span class="token operator">&gt;</span> name <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token operator">--</span>cp <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    
    saved_herrno <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">//res-&gt;ndots在前面初始化为1，当dns请求的域名中的"."数量大于等于1时</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dots <span class="token operator">&gt;=</span> res<span class="token operator">-&gt;</span>ndots<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//dns解析</span>
        ret <span class="token operator">=</span> <span class="token function">res_querydomainN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">,</span> herrno<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        saved_herrno <span class="token operator">=</span> <span class="token operator">*</span>herrno<span class="token punctuation">;</span>
        tried_as_is<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>上面代码主要对DNS要解析的域名中的"."进行计算，目的是在处理 DNS 域名时解析域名中有多少个子域名，以方便后面进行分割和处理。</p> 
<h4><a id="214_getaddrinfores_querydomainN_542"></a>2.14 getaddrinfo.res_querydomainN</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">res_querydomainN</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> domain<span class="token punctuation">,</span> res_target<span class="token operator">*</span> target<span class="token punctuation">,</span> res_state res<span class="token punctuation">,</span>
                            <span class="token keyword">int</span><span class="token operator">*</span> herrno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span> nbuf<span class="token punctuation">[</span>MAXDNAME<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> longname <span class="token operator">=</span> nbuf<span class="token punctuation">;</span>
    size_t n<span class="token punctuation">,</span> d<span class="token punctuation">;</span>
    <span class="token function">assert</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>domain <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Check for trailing '.'; copy without '.' if present.</span>
        n <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>herrno <span class="token operator">=</span> NO_RECOVERY<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> name<span class="token punctuation">[</span><span class="token operator">--</span>n<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">strncpy</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">,</span> name<span class="token punctuation">,</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
            nbuf<span class="token punctuation">[</span>n<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span>
            longname <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        n <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        d <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span>domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> d <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&gt;</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>herrno <span class="token operator">=</span> NO_RECOVERY<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">snprintf</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>nbuf<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"%s.%s"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> domain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ALOGE</span><span class="token punctuation">(</span><span class="token string">"djtang...res_querydomainN...name:%s,domain:%s,longname:%s"</span><span class="token punctuation">,</span>name<span class="token punctuation">,</span>domain<span class="token punctuation">,</span>longname<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">res_queryN_wrapper</span><span class="token punctuation">(</span>longname<span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">,</span> herrno<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码会对传入的主机名（name）和域名（domain）进行处理，其中域名可以为 NULL，如果域名为 NULL，就直接使用主机名作为完整域名。如果域名不为 NULL，则将主机名和域名拼接成完整的域名。对于主机名，如果最后有一个点"."，则将其删除，以避免后续拼接出问题，然后使用 snprintf() 函数将主机名和域名拼接成完整域名，并将结果存储到 nbuf 缓冲区中，如下是日志打印结果，供参考：</p> 
<p><img src="https://images2.imgbox.com/79/7f/UyfWgPYS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="215_getaddrinfores_queryN_wrapper_582"></a>2.15 getaddrinfo.res_queryN_wrapper</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">res_queryN_wrapper</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> res_target<span class="token operator">*</span> target<span class="token punctuation">,</span> res_state res<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> herrno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">bool</span> parallel_lookup <span class="token operator">=</span>
            android<span class="token double-colon punctuation">::</span>net<span class="token double-colon punctuation">::</span><span class="token class-name">Experiments</span><span class="token double-colon punctuation">::</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token string">"parallel_lookup"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>parallel_lookup<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token function">res_queryN_parallel</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">,</span> herrno<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">res_queryN</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> target<span class="token punctuation">,</span> res<span class="token punctuation">,</span> herrno<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="216_getaddrinfores_queryN_594"></a>2.16 getaddrinfo.res_queryN</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">res_queryN</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> name<span class="token punctuation">,</span> res_target<span class="token operator">*</span> target<span class="token punctuation">,</span> res_state res<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> herrno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">uint8_t</span> buf<span class="token punctuation">[</span>MAXPACKET<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> n<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">res_target</span><span class="token operator">*</span> t<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rcode<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ancount<span class="token punctuation">;</span>

    <span class="token function">assert</span><span class="token punctuation">(</span>name <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* XXX: target may be NULL??? */</span>

    rcode <span class="token operator">=</span> NOERROR<span class="token punctuation">;</span>
    ancount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>t <span class="token operator">=</span> target<span class="token punctuation">;</span> t<span class="token punctuation">;</span> t <span class="token operator">=</span> t<span class="token operator">-&gt;</span>next<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        HEADER<span class="token operator">*</span> hp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>t<span class="token operator">-&gt;</span>answer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> retried <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    again<span class="token operator">:</span>
        hp<span class="token operator">-&gt;</span>rcode <span class="token operator">=</span> NOERROR<span class="token punctuation">;</span> <span class="token comment">/* default */</span>

        <span class="token comment">/* make it easier... */</span>
        <span class="token keyword">int</span> cl <span class="token operator">=</span> t<span class="token operator">-&gt;</span>qclass<span class="token punctuation">;</span>
        <span class="token keyword">int</span> type <span class="token operator">=</span> t<span class="token operator">-&gt;</span>qtype<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">int</span> anslen <span class="token operator">=</span> t<span class="token operator">-&gt;</span>answer<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": ("</span> <span class="token operator">&lt;&lt;</span> cl <span class="token operator">&lt;&lt;</span> <span class="token string">", "</span> <span class="token operator">&lt;&lt;</span> type <span class="token operator">&lt;&lt;</span> <span class="token string">")"</span><span class="token punctuation">;</span>
        <span class="token comment">//DNS 查询报文的组装函数,可以将指定类别和类型的 DNS 查询报文组装为二进制格式，并存储到指定缓冲区中,</span>
        <span class="token comment">//首先对 DNS 查询报文的头部进行初始化，包括设置报文 ID、报文类型、查询类型等字段。然后根据操作类型 op，</span>
        <span class="token comment">//分别组装并添加报文的查询部分、附加部分和回答部分</span>
        <span class="token comment">//此函数比较复杂，不必关注</span>
        n <span class="token operator">=</span> <span class="token function">res_nmkquery</span><span class="token punctuation">(</span>QUERY<span class="token punctuation">,</span> name<span class="token punctuation">,</span> cl<span class="token punctuation">,</span> type<span class="token punctuation">,</span> <span class="token comment">/*data=*/</span><span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token comment">/*datalen=*/</span><span class="token number">0</span><span class="token punctuation">,</span> buf<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span>
                         res<span class="token operator">-&gt;</span>netcontext_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
         
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">//发送请求</span>
        n <span class="token operator">=</span> <span class="token function">res_nsend</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> n<span class="token punctuation">,</span> t<span class="token operator">-&gt;</span>answer<span class="token punctuation">.</span><span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> anslen<span class="token punctuation">,</span> <span class="token operator">&amp;</span>rcode<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token punctuation">}</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> ancount<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面函数会对dns查询报文进行组装，然后通过<code>res_nsend</code>发送请求报文：</p> 
<h4><a id="217_res_sendres_nsend_643"></a>2.17 res_send.res_nsend</h4> 
<p>这个函数很长，很复杂，作用于 DNS 查询，此函数接收一个 DNS 查询请求并返回相应的 DNS 响应，优先通过查询缓存来优化查询速度，如果查询在缓存中找到，则会在不执行实际查询的情况下返回缓存中的响应。如果启用了 DNS-over-TLS，则使用 DNS-over-TLS 与 DNS 服务器进行通信。否则使用 UDP 或 TCP 协议与 DNS 服务器进行通信，如果在所有 DNS 服务器上都无法获得响应，则该函数将返回错误。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">res_nsend</span><span class="token punctuation">(</span>res_state statp<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buflen<span class="token punctuation">,</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> ans<span class="token punctuation">,</span> <span class="token keyword">int</span> anssiz<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> rcode<span class="token punctuation">,</span>
              <span class="token keyword">uint32_t</span> flags<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds sleepTimeMs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token comment">/*
    将dns请求打印出来，大概长这样：
    # Query packet
    ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 29827
    ;; flags: rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0
    ;; QUERY SECTION:
    ;;    www.google.com, type = A, class = IN
    */</span>
    <span class="token function">res_pquery</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> anslen <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    Stopwatch cacheStopwatch<span class="token punctuation">;</span>
    <span class="token comment">//查询缓存</span>
    ResolvCacheStatus cache_status <span class="token operator">=</span>
            <span class="token function">resolv_cache_lookup</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>anslen<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int32_t</span> cacheLatencyUs <span class="token operator">=</span> <span class="token generic-function"><span class="token function">saturate_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>cacheStopwatch<span class="token punctuation">.</span><span class="token function">timeTakenUs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">==</span> RESOLV_CACHE_FOUND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        HEADER<span class="token operator">*</span> hp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>ans<span class="token punctuation">;</span>
        <span class="token operator">*</span>rcode <span class="token operator">=</span> hp<span class="token operator">-&gt;</span>rcode<span class="token punctuation">;</span>
        DnsQueryEvent<span class="token operator">*</span> dnsQueryEvent <span class="token operator">=</span> <span class="token function">addDnsQueryEvent</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_latency_micros</span><span class="token punctuation">(</span>cacheLatencyUs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_cache_hit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CacheStatus<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>cache_status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_type</span><span class="token punctuation">(</span><span class="token function">getQueryType</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> anslen<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">!=</span> RESOLV_CACHE_UNSUPPORTED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token function">resolv_populate_res_for_net</span><span class="token punctuation">(</span>statp<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span><span class="token function">nameserverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token function">_resolv_cache_query_failed</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// TODO: Remove errno once callers stop using it</span>
        errno <span class="token operator">=</span> ESRCH<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ESRCH<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// If parallel_lookup is enabled, it might be required to wait some time to avoid</span>
    <span class="token comment">// gateways drop packets if queries are sent too close together</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>sleepTimeMs <span class="token operator">!=</span> <span class="token number">0</span>ms<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        std<span class="token double-colon punctuation">::</span>this_thread<span class="token double-colon punctuation">::</span><span class="token function">sleep_for</span><span class="token punctuation">(</span>sleepTimeMs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// DoT</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netcontext_flags <span class="token operator">&amp;</span> NET_CONTEXT_FLAG_USE_LOCAL_NAMESERVERS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">bool</span> fallback <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token comment">//DNS-over-TLS查询</span>
        <span class="token keyword">int</span> resplen <span class="token operator">=</span> <span class="token function">res_tls_send</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token function">Slice</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">const_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">uint8_t</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                   <span class="token function">Slice</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">)</span><span class="token punctuation">,</span> rcode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>resplen <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": got answer from DoT"</span><span class="token punctuation">;</span>
            <span class="token function">res_pquery</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">==</span> RESOLV_CACHE_NOTFOUND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">resolv_cache_add</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> resplen<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fallback<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">_resolv_cache_query_failed</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ETIMEDOUT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    res_stats stats<span class="token punctuation">[</span>MAXNS<span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    res_params params<span class="token punctuation">;</span>
    <span class="token keyword">int</span> revision_id <span class="token operator">=</span> <span class="token function">resolv_cache_get_resolver_stats</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> statp<span class="token operator">-&gt;</span>nsaddrs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>revision_id <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: Remove errno once callers stop using it</span>
        errno <span class="token operator">=</span> ESRCH<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ESRCH<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">bool</span> usable_servers<span class="token punctuation">[</span>MAXNS<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> usableServersCount <span class="token operator">=</span> <span class="token function">android_net_res_stats_get_usable_servers</span><span class="token punctuation">(</span>
            <span class="token operator">&amp;</span>params<span class="token punctuation">,</span> stats<span class="token punctuation">,</span> statp<span class="token operator">-&gt;</span><span class="token function">nameserverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> usable_servers<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ANDROID_RESOLV_NO_RETRY<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> usableServersCount <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> hp <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> HEADER<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Select a random server based on the query id</span>
        <span class="token keyword">int</span> selectedServer <span class="token operator">=</span> <span class="token punctuation">(</span>hp<span class="token operator">-&gt;</span>id <span class="token operator">%</span> usableServersCount<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token function">res_set_usable_server</span><span class="token punctuation">(</span>selectedServer<span class="token punctuation">,</span> statp<span class="token operator">-&gt;</span><span class="token function">nameserverCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> usable_servers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Send request, RETRY times, or until successful.</span>
    <span class="token keyword">int</span> retryTimes <span class="token operator">=</span> <span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> ANDROID_RESOLV_NO_RETRY<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> params<span class="token punctuation">.</span>retry_count<span class="token punctuation">;</span>
    <span class="token keyword">int</span> useTcp <span class="token operator">=</span> buflen <span class="token operator">&gt;</span> PACKETSZ<span class="token punctuation">;</span>
    <span class="token keyword">int</span> gotsomewhere <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// Use an impossible error code as default value</span>
    <span class="token keyword">int</span> terrno <span class="token operator">=</span> ETIME<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> attempt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> attempt <span class="token operator">&lt;</span> retryTimes<span class="token punctuation">;</span> <span class="token operator">++</span>attempt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t ns <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ns <span class="token operator">&lt;</span> statp<span class="token operator">-&gt;</span>nsaddrs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>ns<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>usable_servers<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token operator">*</span>rcode <span class="token operator">=</span> RCODE_INTERNAL_ERROR<span class="token punctuation">;</span>

            <span class="token comment">// Get server addr</span>
            <span class="token keyword">const</span> IPSockAddr<span class="token operator">&amp;</span> serverSockAddr <span class="token operator">=</span> statp<span class="token operator">-&gt;</span>nsaddrs<span class="token punctuation">[</span>ns<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": Querying server (# "</span> <span class="token operator">&lt;&lt;</span> ns <span class="token operator">+</span> <span class="token number">1</span>
                       <span class="token operator">&lt;&lt;</span> <span class="token string">") address = "</span> <span class="token operator">&lt;&lt;</span> serverSockAddr<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>net<span class="token double-colon punctuation">::</span>Protocol query_proto <span class="token operator">=</span> useTcp <span class="token operator">?</span> PROTO_TCP <span class="token operator">:</span> PROTO_UDP<span class="token punctuation">;</span>
            time_t query_time <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> delay <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">bool</span> fallbackTCP <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> <span class="token keyword">bool</span> shouldRecordStats <span class="token operator">=</span> <span class="token punctuation">(</span>attempt <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> resplen<span class="token punctuation">;</span>
            Stopwatch queryStopwatch<span class="token punctuation">;</span>
            <span class="token keyword">int</span> retry_count_for_event <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            size_t actualNs <span class="token operator">=</span> ns<span class="token punctuation">;</span>
            <span class="token comment">// Use an impossible error code as default value</span>
            terrno <span class="token operator">=</span> ETIME<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>useTcp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// TCP查询</span>
                attempt <span class="token operator">=</span> retryTimes<span class="token punctuation">;</span>
                resplen <span class="token operator">=</span> <span class="token function">send_vc</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>terrno<span class="token punctuation">,</span> ns<span class="token punctuation">,</span>
                                  <span class="token operator">&amp;</span>query_time<span class="token punctuation">,</span> rcode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>buflen <span class="token operator">&lt;=</span> PACKETSZ <span class="token operator">&amp;&amp;</span> resplen <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
                    statp<span class="token operator">-&gt;</span>tc_mode <span class="token operator">==</span> aidl<span class="token double-colon punctuation">::</span>android<span class="token double-colon punctuation">::</span>net<span class="token double-colon punctuation">::</span>IDnsResolver<span class="token double-colon punctuation">::</span>TC_MODE_UDP_TCP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// reset to UDP for next query on next DNS server if resolver is currently doing</span>
                    <span class="token comment">// TCP fallback retry and current server does not support TCP connectin</span>
                    useTcp <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": used send_vc "</span> <span class="token operator">&lt;&lt;</span> resplen <span class="token operator">&lt;&lt;</span> <span class="token string">" terrno: "</span> <span class="token operator">&lt;&lt;</span> terrno<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// UDP查询</span>
                resplen <span class="token operator">=</span> <span class="token function">send_dg</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>params<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>terrno<span class="token punctuation">,</span> <span class="token operator">&amp;</span>actualNs<span class="token punctuation">,</span>
                                  <span class="token operator">&amp;</span>useTcp<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gotsomewhere<span class="token punctuation">,</span> <span class="token operator">&amp;</span>query_time<span class="token punctuation">,</span> rcode<span class="token punctuation">,</span> <span class="token operator">&amp;</span>delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                fallbackTCP <span class="token operator">=</span> useTcp <span class="token operator">?</span> <span class="token boolean">true</span> <span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                retry_count_for_event <span class="token operator">=</span> attempt<span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": used send_dg "</span> <span class="token operator">&lt;&lt;</span> resplen <span class="token operator">&lt;&lt;</span> <span class="token string">" terrno: "</span> <span class="token operator">&lt;&lt;</span> terrno<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">const</span> IPSockAddr<span class="token operator">&amp;</span> receivedServerAddr <span class="token operator">=</span> statp<span class="token operator">-&gt;</span>nsaddrs<span class="token punctuation">[</span>actualNs<span class="token punctuation">]</span><span class="token punctuation">;</span>
            DnsQueryEvent<span class="token operator">*</span> dnsQueryEvent <span class="token operator">=</span> <span class="token function">addDnsQueryEvent</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_cache_hit</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>CacheStatus<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>cache_status<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// When |retryTimes| &gt; 1, we cannot actually know the correct latency value if we</span>
            <span class="token comment">// received the answer from the previous server. So temporarily set the latency as -1 if</span>
            <span class="token comment">// that condition happened.</span>
            <span class="token comment">// TODO: make the latency value accurate.</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_latency_micros</span><span class="token punctuation">(</span>
                    <span class="token punctuation">(</span>actualNs <span class="token operator">==</span> ns<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token generic-function"><span class="token function">saturate_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int32_t</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>queryStopwatch<span class="token punctuation">.</span><span class="token function">timeTakenUs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_dns_server_index</span><span class="token punctuation">(</span>actualNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_ip_version</span><span class="token punctuation">(</span><span class="token function">ipFamilyToIPVersion</span><span class="token punctuation">(</span>receivedServerAddr<span class="token punctuation">.</span><span class="token function">family</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_retry_times</span><span class="token punctuation">(</span>retry_count_for_event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_rcode</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>NsRcode<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">*</span>rcode<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_protocol</span><span class="token punctuation">(</span>query_proto<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_type</span><span class="token punctuation">(</span><span class="token function">getQueryType</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span> buflen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dnsQueryEvent<span class="token operator">-&gt;</span><span class="token function">set_linux_errno</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>LinuxErrno<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>terrno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Only record stats the first time we try a query. This ensures that</span>
            <span class="token comment">// queries that deterministically fail (e.g., a name that always returns</span>
            <span class="token comment">// SERVFAIL or times out) do not unduly affect the stats.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>shouldRecordStats<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// (b/151166599): This is a workaround to prevent that DnsResolver calculates the</span>
                <span class="token comment">// reliability of DNS servers from being broken when network restricted mode is</span>
                <span class="token comment">// enabled.</span>
                <span class="token comment">// TODO: Introduce the new server selection instead of skipping stats recording.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNetworkRestricted</span><span class="token punctuation">(</span>terrno<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    res_sample sample<span class="token punctuation">;</span>
                    <span class="token function">res_stats_set_sample</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sample<span class="token punctuation">,</span> query_time<span class="token punctuation">,</span> <span class="token operator">*</span>rcode<span class="token punctuation">,</span> delay<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// KeepListening UDP mechanism is incompatible with usable_servers of legacy</span>
                    <span class="token comment">// stats, so keep the old logic for now.</span>
                    <span class="token comment">// TODO: Replace usable_servers of legacy stats with new one.</span>
                    <span class="token function">resolv_cache_add_resolver_stats_sample</span><span class="token punctuation">(</span>
                            statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> revision_id<span class="token punctuation">,</span> serverSockAddr<span class="token punctuation">,</span> sample<span class="token punctuation">,</span> params<span class="token punctuation">.</span>max_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">resolv_stats_add</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> receivedServerAddr<span class="token punctuation">,</span> dnsQueryEvent<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>resplen <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>fallbackTCP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                ns<span class="token operator">--</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resplen <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">_resolv_cache_query_failed</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
                statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span>terrno<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token comment">/*
            将dns响应打印出来，大概长这样：
            # Response packet
            ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 29827
            ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0
            ;; QUERY SECTION:
            ;;    www.google.com, type = A, class = IN

            ;; ANSWER SECTION:
            ;; www.google.com.        2m19s IN A  172.217.160.100
            */</span>
            <span class="token function">res_pquery</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> <span class="token punctuation">(</span>resplen <span class="token operator">&gt;</span> anssiz<span class="token punctuation">)</span> <span class="token operator">?</span> anssiz <span class="token operator">:</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>cache_status <span class="token operator">==</span> RESOLV_CACHE_NOTFOUND<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">resolv_cache_add</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span>resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>  <span class="token comment">// for each ns</span>
    <span class="token punctuation">}</span>  <span class="token comment">// for each retry</span>
    statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    terrno <span class="token operator">=</span> useTcp <span class="token operator">?</span> terrno <span class="token operator">:</span> gotsomewhere <span class="token operator">?</span> ETIMEDOUT <span class="token operator">:</span> ECONNREFUSED<span class="token punctuation">;</span>
    <span class="token comment">// TODO: Remove errno once callers stop using it</span>
    errno <span class="token operator">=</span> useTcp <span class="token operator">?</span> terrno
                   <span class="token operator">:</span> gotsomewhere <span class="token operator">?</span> ETIMEDOUT <span class="token comment">/* no answer obtained */</span>
                                  <span class="token operator">:</span> ECONNREFUSED <span class="token comment">/* no nameservers found */</span><span class="token punctuation">;</span>

    <span class="token function">_resolv_cache_query_failed</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netid<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>terrno<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面代码大概分为三块，1. 查询缓存，2. 使用DNS-over-TLS查询，3. 使用TCP或者UDP查询，我们这儿只关注第三点，由于DNS解析走的UDP协议，只需关注<code>send_dg</code>函数：</p> 
<h4><a id="218_res_sendsend_dg_868"></a>2.18 res_send.send_dg</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">send_dg</span><span class="token punctuation">(</span>res_state statp<span class="token punctuation">,</span> res_params<span class="token operator">*</span> params<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">uint8_t</span><span class="token operator">*</span> buf<span class="token punctuation">,</span> <span class="token keyword">int</span> buflen<span class="token punctuation">,</span>
                   <span class="token keyword">uint8_t</span><span class="token operator">*</span> ans<span class="token punctuation">,</span> <span class="token keyword">int</span> anssiz<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> terrno<span class="token punctuation">,</span> size_t<span class="token operator">*</span> ns<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> v_circuit<span class="token punctuation">,</span>
                   <span class="token keyword">int</span><span class="token operator">*</span> gotsomewhere<span class="token punctuation">,</span> time_t<span class="token operator">*</span> at<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> rcode<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> delay<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  
   
   
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      
    <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建socket</span>
        statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token function">socket</span><span class="token punctuation">(</span>nsap<span class="token operator">-&gt;</span>sa_family<span class="token punctuation">,</span> SOCK_DGRAM <span class="token operator">|</span> SOCK_CLOEXEC<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
            <span class="token function">PLOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": socket(dg): "</span><span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>errno<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> EPROTONOSUPPORT<span class="token operator">:</span>
                <span class="token keyword">case</span> EPFNOSUPPORT<span class="token operator">:</span>
                <span class="token keyword">case</span> EAFNOSUPPORT<span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">const</span> uid_t uid <span class="token operator">=</span> statp<span class="token operator">-&gt;</span>enforce_dns_uid <span class="token operator">?</span> AID_DNS <span class="token operator">:</span> statp<span class="token operator">-&gt;</span>uid<span class="token punctuation">;</span>
        <span class="token function">resolv_tag_socket</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> uid<span class="token punctuation">,</span> statp<span class="token operator">-&gt;</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>_mark <span class="token operator">!=</span> MARK_UNSET<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">setsockopt</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> SOL_SOCKET<span class="token punctuation">,</span> SO_MARK<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>_mark<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token keyword">sizeof</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>_mark<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
                statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// Use a "connected" datagram socket to receive an ECONNREFUSED error</span>
        <span class="token comment">// on the next socket operation when the server responds with an</span>
        <span class="token comment">// ICMP port-unreachable error. This way we can detect the absence of</span>
        <span class="token comment">// a nameserver without timing out.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">random_bind</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> nsap<span class="token operator">-&gt;</span>sa_family<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
            <span class="token function">dump_error</span><span class="token punctuation">(</span><span class="token string">"bind(dg)"</span><span class="token punctuation">,</span> nsap<span class="token punctuation">,</span> nsaplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//连接到socket，ip地址和端口信息在nsap中，ip地址就是DNS服务器地址，对wifi来说是网关地址，对移动网络来说</span>
        <span class="token comment">//是网络创建时指定的地址</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">connect</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> nsap<span class="token punctuation">,</span> <span class="token punctuation">(</span>socklen_t<span class="token punctuation">)</span>nsaplen<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
            <span class="token function">dump_error</span><span class="token punctuation">(</span><span class="token string">"connect(dg)"</span><span class="token punctuation">,</span> nsap<span class="token punctuation">,</span> nsaplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
            statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": new DG socket"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//向DNS服务器发送查询报文</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">send</span><span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>nssocks<span class="token punctuation">[</span><span class="token operator">*</span>ns<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>buf<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>buflen<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> buflen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
        <span class="token function">PLOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": send: "</span><span class="token punctuation">;</span>
        statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//超时时间</span>
    timespec timeout <span class="token operator">=</span> <span class="token function">get_timeout</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token operator">*</span>ns<span class="token punctuation">)</span><span class="token punctuation">;</span>
    timespec start_time <span class="token operator">=</span> <span class="token function">evNowTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    timespec finish <span class="token operator">=</span> <span class="token function">evAddTime</span><span class="token punctuation">(</span>start_time<span class="token punctuation">,</span> timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 等待回复</span>
        <span class="token keyword">auto</span> result <span class="token operator">=</span> <span class="token function">udpRetryingPollWrapper</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> <span class="token operator">*</span>ns<span class="token punctuation">,</span> <span class="token operator">&amp;</span>finish<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span><span class="token function">has_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> <span class="token keyword">bool</span> isTimeout <span class="token operator">=</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">code</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> ETIMEDOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>rcode <span class="token operator">=</span> <span class="token punctuation">(</span>isTimeout<span class="token punctuation">)</span> <span class="token operator">?</span> RCODE_TIMEOUT <span class="token operator">:</span> <span class="token operator">*</span>rcode<span class="token punctuation">;</span>
            <span class="token operator">*</span>terrno <span class="token operator">=</span> <span class="token punctuation">(</span>isTimeout<span class="token punctuation">)</span> <span class="token operator">?</span> ETIMEDOUT <span class="token operator">:</span> errno<span class="token punctuation">;</span>
            <span class="token operator">*</span>gotsomewhere <span class="token operator">=</span> <span class="token punctuation">(</span>isTimeout<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> <span class="token operator">*</span>gotsomewhere<span class="token punctuation">;</span>
            <span class="token comment">// Leave the UDP sockets open on timeout so we can keep listening for</span>
            <span class="token comment">// a late response from this server while retrying on the next server.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isTimeout<span class="token punctuation">)</span> statp<span class="token operator">-&gt;</span><span class="token function">closeSockets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": "</span> <span class="token operator">&lt;&lt;</span> <span class="token punctuation">(</span>isTimeout<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">"timeout"</span> <span class="token operator">:</span> <span class="token string">"poll"</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//是否重试</span>
        <span class="token keyword">bool</span> needRetry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> fd <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            needRetry <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            sockaddr_storage from<span class="token punctuation">;</span>
            socklen_t fromlen <span class="token operator">=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>from<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//接收响应消息</span>
            <span class="token keyword">int</span> resplen <span class="token operator">=</span>
                    <span class="token function">recvfrom</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>ans<span class="token punctuation">,</span> <span class="token punctuation">(</span>size_t<span class="token punctuation">)</span>anssiz<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>sockaddr<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>from<span class="token punctuation">,</span> <span class="token operator">&amp;</span>fromlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
             
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resplen <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>terrno <span class="token operator">=</span> errno<span class="token punctuation">;</span>
                <span class="token function">PLOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": recvfrom: "</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token operator">*</span>gotsomewhere <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resplen <span class="token operator">&lt;</span> HFIXEDSZ<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// Undersized message.</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": undersized: "</span> <span class="token operator">&lt;&lt;</span> resplen<span class="token punctuation">;</span>
                <span class="token operator">*</span>terrno <span class="token operator">=</span> EMSGSIZE<span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">int</span> receivedFromNs <span class="token operator">=</span> <span class="token operator">*</span>ns<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>needRetry <span class="token operator">=</span>
                        <span class="token function">ignoreInvalidAnswer</span><span class="token punctuation">(</span>statp<span class="token punctuation">,</span> from<span class="token punctuation">,</span> buf<span class="token punctuation">,</span> buflen<span class="token punctuation">,</span> ans<span class="token punctuation">,</span> anssiz<span class="token punctuation">,</span> <span class="token operator">&amp;</span>receivedFromNs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                needRetry<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">res_pquery</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> <span class="token punctuation">(</span>resplen <span class="token operator">&gt;</span> anssiz<span class="token punctuation">)</span> <span class="token operator">?</span> anssiz <span class="token operator">:</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            HEADER<span class="token operator">*</span> anhp <span class="token operator">=</span> <span class="token punctuation">(</span>HEADER<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span>ans<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anhp<span class="token operator">-&gt;</span>rcode <span class="token operator">==</span> FORMERR <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>statp<span class="token operator">-&gt;</span>netcontext_flags <span class="token operator">&amp;</span> NET_CONTEXT_FLAG_USE_EDNS<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//  Do not retry if the server do not understand EDNS0.</span>
                <span class="token comment">//  The case has to be captured here, as FORMERR packet do not</span>
                <span class="token comment">//  carry query section, hence res_queriesmatch() returns 0.</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": server rejected query with EDNS0:"</span><span class="token punctuation">;</span>
                <span class="token function">res_pquery</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> <span class="token punctuation">(</span>resplen <span class="token operator">&gt;</span> anssiz<span class="token punctuation">)</span> <span class="token operator">?</span> anssiz <span class="token operator">:</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// record the error</span>
                statp<span class="token operator">-&gt;</span>_flags <span class="token operator">|=</span> RES_F_EDNS0ERR<span class="token punctuation">;</span>
                <span class="token operator">*</span>terrno <span class="token operator">=</span> EREMOTEIO<span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            timespec done <span class="token operator">=</span> <span class="token function">evNowTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>delay <span class="token operator">=</span> <span class="token function">res_stats_calculate_rtt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>done<span class="token punctuation">,</span> <span class="token operator">&amp;</span>start_time<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anhp<span class="token operator">-&gt;</span>rcode <span class="token operator">==</span> SERVFAIL <span class="token operator">||</span> anhp<span class="token operator">-&gt;</span>rcode <span class="token operator">==</span> NOTIMP <span class="token operator">||</span> anhp<span class="token operator">-&gt;</span>rcode <span class="token operator">==</span> REFUSED<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": server rejected query:"</span><span class="token punctuation">;</span>
                <span class="token function">res_pquery</span><span class="token punctuation">(</span>ans<span class="token punctuation">,</span> <span class="token punctuation">(</span>resplen <span class="token operator">&gt;</span> anssiz<span class="token punctuation">)</span> <span class="token operator">?</span> anssiz <span class="token operator">:</span> resplen<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>rcode <span class="token operator">=</span> anhp<span class="token operator">-&gt;</span>rcode<span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>anhp<span class="token operator">-&gt;</span>tc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// To get the rest of answer,</span>
                <span class="token comment">// use TCP with same server.</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">__func__</span> <span class="token operator">&lt;&lt;</span> <span class="token string">": truncated answer"</span><span class="token punctuation">;</span>
                <span class="token operator">*</span>terrno <span class="token operator">=</span> E2BIG<span class="token punctuation">;</span>
                <span class="token operator">*</span>v_circuit <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// All is well, or the error is fatal. Signal that the</span>
            <span class="token comment">// next nameserver ought not be tried.</span>

            <span class="token operator">*</span>rcode <span class="token operator">=</span> anhp<span class="token operator">-&gt;</span>rcode<span class="token punctuation">;</span>
            <span class="token operator">*</span>ns <span class="token operator">=</span> receivedFromNs<span class="token punctuation">;</span>
            <span class="token operator">*</span>terrno <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> resplen<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needRetry<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>DNS解析的大致流程到这儿就结束了，这儿我们只看了大致的函数调用流程，其中的大量细节都没具体看，例如缓存机制，网络选择机制等，大致流程图如下：</p> 
<p><img src="https://images2.imgbox.com/b4/8e/xAE2ncBI_o.png" alt="在这里插入图片描述"></p> 
<p>总结一下整个过程吧，整个流程分为如下几个步骤：</p> 
<ol><li>应用程序使用网络框架（如okhttp）发送网络请求时，首先会通过java提供的<code>Inet6AddressImpl.lookupHostByName</code>方法获取域名对应的IP地址。</li><li><code>Inet6AddressImpl.lookupHostByName</code>核心是向"/dev/socket/dnsproxyd"这个socket写入一段字符串"getaddrinfo %s %s %d %d %d %d %u",这段字符串包含方法名+参数。</li><li>netd进程的<code>DnsProxyListener</code>通过<code>FrameworkListener</code>监听了**“/dev/socket/dnsproxyd”**，接收到客户端发送的字符串调用对应函数<code>GetAddrInfoCmd::runCommand</code>。</li><li>接着就是一系列调用，各种合法判断条件，缓存机制最终其实是创建，连接socket，IP和端口就是DNS解析的地址，wifi一般是路由器地址，移动网络一般是自行配置的地址如114.114.114.114或者8.8.8.8等等。</li></ol> 
<p>请求和响应的报文经过解析长这样子：</p> 
<blockquote> 
 <p>37 # Query packet<br> 38 resolv : ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 29827<br> 39 resolv : ;; flags: rd; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 0<br> 40 resolv : ;; QUERY SECTION:<br> 41 resolv : ;; www.google.com, type = A, class = IN<br> 42 resolv :<br> 43 resolv : Hex dump:<br> 44 resolv : 7483010000010000000000000377777706676f6f676c6503636f6d0000010001<br> 45<br> 46 # Response packet<br> 47 resolv : ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 29827<br> 48 resolv : ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0<br> 49 resolv : ;; QUERY SECTION:<br> 50 resolv : ;; www.google.com, type = A, class = IN<br> 51 resolv :<br> 52 resolv : ;; ANSWER SECTION:<br> 53 resolv : ;; www.google.com. 2m19s IN A 172.217.160.100<br> 54 resolv :<br> 55 resolv : Hex dump:<br> 56 resolv : 7483818000010001000000000377777706676f6f676c6503636f6d0000010001<br> 57 resolv : c00c000100010000008b0004acd9a064</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8808d950099da13cad03ac466852642a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深度学习Q&amp;A之卷积神经网络</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/715f387f3150e4c32a79ba1bbdb4dd82/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Windows上pip缓存</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>