<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>OpenCascade源码分析之BRepMesh_IncrementalMesh(网格离散化操作) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="OpenCascade源码分析之BRepMesh_IncrementalMesh(网格离散化操作)" />
<meta property="og:description" content="OpenCascade源码分析之BRepMesh_IncrementalMesh(网格离散化操作) 一、引言 在使用opencascade读取连续曲面模型的时候，一般来说我们都会调用BRepMesh_IncrementalMesh对其进行离散化，然而可能对于离散过程的执行还是没有什么概念，接下来从源码出发来看看它进行了什么操作。
二、源码分析 在调用离散的时候，我们一般会用到下面的代码
TopoDS_Shape cur;	//需要离散的拓扑 IMeshTools_Parameters aMeshParams;	//离散化的参数 BRepMesh_IncrementalMesh::BRepMesh_IncrementalMesh(cur, this-&gt;aMeshParams); BRepMesh_IncrementalMesh.cpp 的代码为
//======================================================================= //function : Constructor //purpose : //======================================================================= BRepMesh_IncrementalMesh::BRepMesh_IncrementalMesh( const TopoDS_Shape&amp; theShape, const IMeshTools_Parameters&amp; theParameters, const Message_ProgressRange&amp; theRange) : myParameters(theParameters) { myShape = theShape; Perform(theRange); } //======================================================================= //function : Perform //purpose : //======================================================================= void BRepMesh_IncrementalMesh::Perform(const Message_ProgressRange&amp; theRange) { //新建一个上下文 //myParameters.MeshAlgo返回了参数中的IMeshTools_MeshAlgoType //如果没有设置IMeshTools_MeshAlgoType默认为Delaunay三角化Watson方法 //也可以设置为Delabella方法 Handle(BRepMesh_Context) aContext = new BRepMesh_Context (myParameters.MeshAlgo); //theRange消息进度条，没什么用 不用管 Perform (aContext, theRange); } //======================================================================= //function : Perform //purpose : //======================================================================= void BRepMesh_IncrementalMesh::Perform(const Handle(IMeshTools_Context)&amp; theContext, const Message_ProgressRange&amp; theRange) { //对于我们自己设置的离散参数进行判断，修改一些不合理的值 //例如当Deflection&lt;Precision::Confusion()时，提醒用户值无效 精度太低 initParameters(); //IMeshTools_Context继承至IMeshData_Shape //IMeshData_Shape中的SetShape()设置了成员变量TopoDS_Shape myShape theContext-&gt;SetShape(Shape()); //设置离散参数 theContext-&gt;ChangeParameters() = myParameters; // 算法结束时不清理临时的数据类型 theContext-&gt;ChangeParameters()." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/bef553e6cbff8bfcf0b38739ec461d1c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-15T16:07:11+08:00" />
<meta property="article:modified_time" content="2022-10-15T16:07:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">OpenCascade源码分析之BRepMesh_IncrementalMesh(网格离散化操作)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="OpenCascadeBRepMesh_IncrementalMesh_0"></a>OpenCascade源码分析之BRepMesh_IncrementalMesh(网格离散化操作)</h2> 
<h3><a id="_1"></a>一、引言</h3> 
<p>在使用opencascade读取连续曲面模型的时候，一般来说我们都会调用BRepMesh_IncrementalMesh对其进行离散化，然而可能对于离散过程的执行还是没有什么概念，接下来从源码出发来看看它进行了什么操作。</p> 
<h3><a id="_4"></a>二、源码分析</h3> 
<p>在调用离散的时候，我们一般会用到下面的代码</p> 
<pre><code class="prism language-cpp">TopoDS_Shape cur<span class="token punctuation">;</span>	<span class="token comment">//需要离散的拓扑</span>
IMeshTools_Parameters aMeshParams<span class="token punctuation">;</span>	<span class="token comment">//离散化的参数</span>
<span class="token class-name">BRepMesh_IncrementalMesh</span><span class="token double-colon punctuation">::</span><span class="token function">BRepMesh_IncrementalMesh</span><span class="token punctuation">(</span>cur<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>aMeshParams<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><em>BRepMesh_IncrementalMesh.cpp</em> 的代码为</p> 
<pre><code class="prism language-cpp"><span class="token comment">//=======================================================================</span>
<span class="token comment">//function : Constructor</span>
<span class="token comment">//purpose  : </span>
<span class="token comment">//=======================================================================</span>
<span class="token class-name">BRepMesh_IncrementalMesh</span><span class="token double-colon punctuation">::</span><span class="token function">BRepMesh_IncrementalMesh</span><span class="token punctuation">(</span>
  <span class="token keyword">const</span> TopoDS_Shape<span class="token operator">&amp;</span>          theShape<span class="token punctuation">,</span>
  <span class="token keyword">const</span> IMeshTools_Parameters<span class="token operator">&amp;</span> theParameters<span class="token punctuation">,</span>
  <span class="token keyword">const</span> Message_ProgressRange<span class="token operator">&amp;</span> theRange<span class="token punctuation">)</span>
  <span class="token operator">:</span> <span class="token function">myParameters</span><span class="token punctuation">(</span>theParameters<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  myShape <span class="token operator">=</span> theShape<span class="token punctuation">;</span>
  <span class="token function">Perform</span><span class="token punctuation">(</span>theRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//=======================================================================</span>
<span class="token comment">//function : Perform</span>
<span class="token comment">//purpose  : </span>
<span class="token comment">//=======================================================================</span>
<span class="token keyword">void</span> <span class="token class-name">BRepMesh_IncrementalMesh</span><span class="token double-colon punctuation">::</span><span class="token function">Perform</span><span class="token punctuation">(</span><span class="token keyword">const</span> Message_ProgressRange<span class="token operator">&amp;</span> theRange<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">//新建一个上下文</span>
  <span class="token comment">//myParameters.MeshAlgo返回了参数中的IMeshTools_MeshAlgoType</span>
  <span class="token comment">//如果没有设置IMeshTools_MeshAlgoType默认为Delaunay三角化Watson方法</span>
  <span class="token comment">//也可以设置为Delabella方法</span>
  <span class="token function">Handle</span><span class="token punctuation">(</span>BRepMesh_Context<span class="token punctuation">)</span> aContext <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BRepMesh_Context</span> <span class="token punctuation">(</span>myParameters<span class="token punctuation">.</span>MeshAlgo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//theRange消息进度条，没什么用 不用管</span>
  <span class="token function">Perform</span> <span class="token punctuation">(</span>aContext<span class="token punctuation">,</span> theRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//=======================================================================</span>
<span class="token comment">//function : Perform</span>
<span class="token comment">//purpose  : </span>
<span class="token comment">//=======================================================================</span>
<span class="token keyword">void</span> <span class="token class-name">BRepMesh_IncrementalMesh</span><span class="token double-colon punctuation">::</span><span class="token function">Perform</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token function">Handle</span><span class="token punctuation">(</span>IMeshTools_Context<span class="token punctuation">)</span><span class="token operator">&amp;</span> theContext<span class="token punctuation">,</span> <span class="token keyword">const</span> Message_ProgressRange<span class="token operator">&amp;</span> theRange<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">//对于我们自己设置的离散参数进行判断，修改一些不合理的值</span>
  <span class="token comment">//例如当Deflection&lt;Precision::Confusion()时，提醒用户值无效 精度太低</span>
  <span class="token function">initParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//IMeshTools_Context继承至IMeshData_Shape</span>
  <span class="token comment">//IMeshData_Shape中的SetShape()设置了成员变量TopoDS_Shape myShape</span>
  theContext<span class="token operator">-&gt;</span><span class="token function">SetShape</span><span class="token punctuation">(</span><span class="token function">Shape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//设置离散参数</span>
  theContext<span class="token operator">-&gt;</span><span class="token function">ChangeParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token operator">=</span> myParameters<span class="token punctuation">;</span>
  <span class="token comment">// 算法结束时不清理临时的数据类型</span>
  theContext<span class="token operator">-&gt;</span><span class="token function">ChangeParameters</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>CleanModel <span class="token operator">=</span> Standard_False<span class="token punctuation">;</span>

  <span class="token comment">//进度条的设置</span>
  Message_ProgressScope <span class="token function">aPS</span><span class="token punctuation">(</span>theRange<span class="token punctuation">,</span> <span class="token string">"Perform incmesh"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//创建一个IMeshTools_MeshBuilder对象，将上下文传入</span>
  IMeshTools_MeshBuilder <span class="token function">aIncMesh</span><span class="token punctuation">(</span>theContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//执行操作</span>
  <span class="token comment">//这边是核心部分！！将会放到后面单独讲解</span>
  <span class="token comment">//这边是核心部分！！将会放到后面单独讲解</span>
  <span class="token comment">//这边是核心部分！！将会放到后面单独讲解</span>
  aIncMesh<span class="token punctuation">.</span><span class="token function">Perform</span><span class="token punctuation">(</span>aPS<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aPS<span class="token punctuation">.</span><span class="token function">More</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    myStatus <span class="token operator">=</span> IMeshData_UserBreak<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  myStatus <span class="token operator">=</span> IMeshData_NoError<span class="token punctuation">;</span>

  <span class="token comment">//返回了上下文中的成员变量Handle (IMeshData_Model)  myModel;</span>
  <span class="token keyword">const</span> <span class="token function">Handle</span><span class="token punctuation">(</span>IMeshData_Model<span class="token punctuation">)</span><span class="token operator">&amp;</span> aModel <span class="token operator">=</span> theContext<span class="token operator">-&gt;</span><span class="token function">GetModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aModel<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//遍历所有的面</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Standard_Integer aFaceIt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> aFaceIt <span class="token operator">&lt;</span> aModel<span class="token operator">-&gt;</span><span class="token function">FacesNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>aFaceIt<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//IMeshData是一个namespace具体里面包含的东西在下面的链接中</span>
      <span class="token comment">//https://dev.opencascade.org/doc/refman/html/namespace_i_mesh_data.html</span>
      <span class="token keyword">const</span> IMeshData<span class="token double-colon punctuation">::</span>IFaceHandle<span class="token operator">&amp;</span> aDFace <span class="token operator">=</span> aModel<span class="token operator">-&gt;</span><span class="token function">GetFace</span><span class="token punctuation">(</span>aFaceIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
      myStatus <span class="token operator">|=</span> aDFace<span class="token operator">-&gt;</span><span class="token function">GetStatusMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span>Standard_Integer aWireIt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> aWireIt <span class="token operator">&lt;</span> aDFace<span class="token operator">-&gt;</span><span class="token function">WiresNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>aWireIt<span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> IMeshData<span class="token double-colon punctuation">::</span>IWireHandle<span class="token operator">&amp;</span> aDWire <span class="token operator">=</span> aDFace<span class="token operator">-&gt;</span><span class="token function">GetWire</span><span class="token punctuation">(</span>aWireIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
        myStatus <span class="token operator">|=</span> aDWire<span class="token operator">-&gt;</span><span class="token function">GetStatusMask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  aPS<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//设置已经完成标志</span>
  <span class="token function">setDone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总体流程就是如上啦，当然 其中的核心代码还没有讲，接下来讲核心代码</p> 
<pre><code>aIncMesh.Perform(aPS.Next(9));	//核心代码！！
</code></pre> 
<p>Perform中的内容如下</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token class-name">IMeshTools_MeshBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">Perform</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Message_ProgressRange<span class="token operator">&amp;</span> theRange<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">//清除状态位</span>
  <span class="token function">ClearStatus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//获得之前设置的上下文</span>
  <span class="token keyword">const</span> <span class="token function">Handle</span> <span class="token punctuation">(</span>IMeshTools_Context<span class="token punctuation">)</span><span class="token operator">&amp;</span> aContext <span class="token operator">=</span> <span class="token function">GetContext</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">SetStatus</span> <span class="token punctuation">(</span>Message_Fail1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  Message_ProgressScope <span class="token function">aPS</span><span class="token punctuation">(</span>theRange<span class="token punctuation">,</span> <span class="token string">"Mesh Perform"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//开始离散化的六个步骤 这边的if中每个都执行了相应的步骤，然后返回是否成功</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token operator">-&gt;</span><span class="token function">BuildModel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token operator">-&gt;</span><span class="token function">DiscretizeEdges</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token operator">-&gt;</span><span class="token function">HealModel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token operator">-&gt;</span><span class="token function">PreProcessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token operator">-&gt;</span><span class="token function">DiscretizeFaces</span><span class="token punctuation">(</span>aPS<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>aContext<span class="token operator">-&gt;</span><span class="token function">PostProcessModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token function">SetStatus</span><span class="token punctuation">(</span>Message_Done1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token function">SetStatus</span><span class="token punctuation">(</span>Message_Fail7<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">else</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aPS<span class="token punctuation">.</span><span class="token function">More</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token function">SetStatus</span><span class="token punctuation">(</span>Message_Fail8<span class="token punctuation">)</span><span class="token punctuation">;</span>
              aContext<span class="token operator">-&gt;</span><span class="token function">Clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">SetStatus</span><span class="token punctuation">(</span>Message_Fail6<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
          <span class="token function">SetStatus</span><span class="token punctuation">(</span>Message_Fail5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">else</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token function">SetStatus</span><span class="token punctuation">(</span>Message_Fail4<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">SetStatus</span> <span class="token punctuation">(</span>Message_Fail3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token function">Handle</span> <span class="token punctuation">(</span>IMeshTools_ModelBuilder<span class="token punctuation">)</span><span class="token operator">&amp;</span> aModelBuilder <span class="token operator">=</span>
      aContext<span class="token operator">-&gt;</span><span class="token function">GetModelBuilder</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>aModelBuilder<span class="token punctuation">.</span><span class="token function">IsNull</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">SetStatus</span> <span class="token punctuation">(</span>Message_Fail1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Is null shape or another problem?</span>
      <span class="token function">SetStatus</span> <span class="token punctuation">(</span>aModelBuilder<span class="token operator">-&gt;</span><span class="token function">GetStatus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">IsSet</span> <span class="token punctuation">(</span>Message_Fail1<span class="token punctuation">)</span> <span class="token operator">?</span>
        Message_Warn1 <span class="token operator">:</span> Message_Fail2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  aPS<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  aContext<span class="token operator">-&gt;</span><span class="token function">Clean</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_BRep_XXXXIMeshTools_ModelAlgovirtual_183"></a>注：下面的详细步骤 都在BRep_XXXX中实现，IMeshTools_ModelAlgo只是作为基类存在，其中的函数都是virtual的</h4> 
<h4><a id="1aContextBuildModel___184"></a>1、aContext-&gt;BuildModel () 创建一个需要离散化的模型</h4> 
<p>此阶段建立了一个模型</p> 
<pre><code class="prism language-cpp"><span class="token keyword">virtual</span> Standard_Boolean <span class="token function">BuildModel</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>myModelBuilder<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Standard_False<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">//创建一个需要离散化的模型的Handle</span>
    myModel <span class="token operator">=</span> myModelBuilder<span class="token operator">-&gt;</span><span class="token function">Perform</span><span class="token punctuation">(</span><span class="token function">GetShape</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> myParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token operator">!</span>myModel<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>Peform执行了下面的代码</p> 
<pre><code class="prism language-cpp"><span class="token comment">//! Exceptions protected method to create discrete model for the given shape.</span>
<span class="token comment">//! Returns nullptr in case of failure.</span>
<span class="token function">Handle</span> <span class="token punctuation">(</span>IMeshData_Model<span class="token punctuation">)</span> <span class="token function">Perform</span> <span class="token punctuation">(</span>
    <span class="token keyword">const</span> TopoDS_Shape<span class="token operator">&amp;</span>          theShape<span class="token punctuation">,</span>
    <span class="token keyword">const</span> IMeshTools_Parameters<span class="token operator">&amp;</span> theParameters<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">ClearStatus</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span>
    <span class="token punctuation">{<!-- --></span>
      OCC_CATCH_SIGNALS
	  <span class="token comment">//返回模型Handle (IMeshData_Model)</span>
      <span class="token keyword">return</span> <span class="token function">performInternal</span> <span class="token punctuation">(</span>theShape<span class="token punctuation">,</span> theParameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span> <span class="token punctuation">(</span>Standard_Failure <span class="token keyword">const</span><span class="token operator">&amp;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">SetStatus</span> <span class="token punctuation">(</span>Message_Fail2<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>performInternal</p> 
<pre><code class="prism language-cpp"><span class="token function">Handle</span> <span class="token punctuation">(</span>IMeshData_Model<span class="token punctuation">)</span> <span class="token class-name">BRepMesh_ModelBuilder</span><span class="token double-colon punctuation">::</span><span class="token function">performInternal</span> <span class="token punctuation">(</span>
  <span class="token keyword">const</span> TopoDS_Shape<span class="token operator">&amp;</span>          theShape<span class="token punctuation">,</span>
  <span class="token keyword">const</span> IMeshTools_Parameters<span class="token operator">&amp;</span> theParameters<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token function">Handle</span> <span class="token punctuation">(</span>BRepMeshData_Model<span class="token punctuation">)</span> aModel<span class="token punctuation">;</span>
  <span class="token comment">//包围盒</span>
  Bnd_Box aBox<span class="token punctuation">;</span>
  <span class="token comment">//给模型添加包围盒</span>
  <span class="token class-name">BRepBndLib</span><span class="token double-colon punctuation">::</span><span class="token function">Add</span> <span class="token punctuation">(</span>theShape<span class="token punctuation">,</span> aBox<span class="token punctuation">,</span> Standard_False<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aBox<span class="token punctuation">.</span><span class="token function">IsVoid</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Build data model for further processing.</span>
    aModel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">BRepMeshData_Model</span> <span class="token punctuation">(</span>theShape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">//Relative为是否启用相对计算的边缘公差</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>theParameters<span class="token punctuation">.</span>Relative<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      Standard_Real aMaxSize<span class="token punctuation">;</span>
      <span class="token comment">//获取给定包围盒的最大维度</span>
      <span class="token class-name">BRepMesh_ShapeTool</span><span class="token double-colon punctuation">::</span><span class="token function">BoxMaxDimension</span> <span class="token punctuation">(</span>aBox<span class="token punctuation">,</span> aMaxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
      aModel<span class="token operator">-&gt;</span><span class="token function">SetMaxSize</span><span class="token punctuation">(</span>aMaxSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//用于面的挠度将是其边缘和面中的最大挠度</span>
      aModel<span class="token operator">-&gt;</span><span class="token function">SetMaxSize</span><span class="token punctuation">(</span><span class="token function">Max</span><span class="token punctuation">(</span>theParameters<span class="token punctuation">.</span>Deflection<span class="token punctuation">,</span>
                             theParameters<span class="token punctuation">.</span>DeflectionInterior<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">//通过添加面孔和自由边缘来构建形状的离散模型。</span>
	<span class="token comment">//计算相应形状的挠度，并检查它是否适合现有的多边形表示形式。</span>
    <span class="token function">Handle</span> <span class="token punctuation">(</span>IMeshTools_ShapeVisitor<span class="token punctuation">)</span> aVisitor <span class="token operator">=</span>
      <span class="token keyword">new</span> <span class="token function">BRepMesh_ShapeVisitor</span> <span class="token punctuation">(</span>aModel<span class="token punctuation">)</span><span class="token punctuation">;</span>

    IMeshTools_ShapeExplorer <span class="token function">aExplorer</span> <span class="token punctuation">(</span>theShape<span class="token punctuation">)</span><span class="token punctuation">;</span>
    aExplorer<span class="token punctuation">.</span><span class="token function">Accept</span> <span class="token punctuation">(</span>aVisitor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">SetStatus</span> <span class="token punctuation">(</span>Message_Done1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token function">SetStatus</span> <span class="token punctuation">(</span>Message_Fail1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> aModel<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="2aContextDiscretizeEdges__271"></a>2、aContext-&gt;DiscretizeEdges ()对边进行离散</h4> 
<pre><code class="prism language-cpp">  <span class="token keyword">virtual</span> Standard_Boolean <span class="token function">DiscretizeEdges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>myModel<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> myEdgeDiscret<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Standard_False<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Discretize edges of a model.</span>
    <span class="token keyword">return</span> myEdgeDiscret<span class="token operator">-&gt;</span><span class="token function">Perform</span><span class="token punctuation">(</span>myModel<span class="token punctuation">,</span> myParameters<span class="token punctuation">,</span> <span class="token function">Message_ProgressRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>同样的Perform调用了BRepMesh_EdgeDiscret.cxx中的performInternal</p> 
<pre><code class="prism language-cpp">Standard_Boolean <span class="token class-name">BRepMesh_EdgeDiscret</span><span class="token double-colon punctuation">::</span><span class="token function">performInternal</span> <span class="token punctuation">(</span>
  <span class="token keyword">const</span> <span class="token function">Handle</span> <span class="token punctuation">(</span>IMeshData_Model<span class="token punctuation">)</span><span class="token operator">&amp;</span> theModel<span class="token punctuation">,</span>
  <span class="token keyword">const</span> IMeshTools_Parameters<span class="token operator">&amp;</span>    theParameters<span class="token punctuation">,</span>
  <span class="token keyword">const</span> Message_ProgressRange<span class="token operator">&amp;</span>    theRange<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">)</span>theRange<span class="token punctuation">;</span>
  myModel      <span class="token operator">=</span> theModel<span class="token punctuation">;</span>
  myParameters <span class="token operator">=</span> theParameters<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>myModel<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Standard_False<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//For中的格式为: begin,end,func,isParallel</span>
  <span class="token comment">//多线程或者单线程跑</span>
  <span class="token class-name">OSD_Parallel</span><span class="token double-colon punctuation">::</span><span class="token function">For</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> myModel<span class="token operator">-&gt;</span><span class="token function">EdgesNb</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">!</span>myParameters<span class="token punctuation">.</span>InParallel<span class="token punctuation">)</span><span class="token punctuation">;</span>

  myModel<span class="token punctuation">.</span><span class="token function">Nullify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Do not hold link to model.</span>
  <span class="token keyword">return</span> Standard_True<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>具体的代码太长了 感兴趣的话 阅读BRepMesh_EdgeDiscret.cxx吧</p> 
<h4><a id="3aContextHealModel___308"></a>3、aContext-&gt;HealModel () 修复模型</h4> 
<pre><code class="prism language-cpp"><span class="token keyword">virtual</span> Standard_Boolean <span class="token function">HealModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>myModel<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> Standard_False<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> myModelHealer<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span>
      Standard_True <span class="token operator">:</span>
      myModelHealer<span class="token operator">-&gt;</span><span class="token function">Perform</span> <span class="token punctuation">(</span>myModel<span class="token punctuation">,</span> myParameters<span class="token punctuation">,</span> <span class="token function">Message_ProgressRange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这块的具体实现在BRepMesh_ModelHealer.hxx和BRepMesh_ModelHealer.cxx中，感兴趣的可以自己进行阅读<br> 其中主要的功能有下：</p> 
<ul><li>connectClosestPoints 将非常近的点进行合并</li><li>fixFaceBoundaries 修复面的边界（边界可能会出现断连的情况）</li></ul> 
<h4><a id="4aContextPreProcessModel__328"></a>4、aContext-&gt;PreProcessModel() 前处理</h4> 
<p>和上面一样的Perform函数 然后调用了performInternal</p> 
<pre><code class="prism language-cpp">Standard_Boolean <span class="token class-name">BRepMesh_ModelPreProcessor</span><span class="token double-colon punctuation">::</span><span class="token function">performInternal</span><span class="token punctuation">(</span>
  <span class="token keyword">const</span> <span class="token function">Handle</span><span class="token punctuation">(</span>IMeshData_Model<span class="token punctuation">)</span><span class="token operator">&amp;</span> theModel<span class="token punctuation">,</span>
  <span class="token keyword">const</span> IMeshTools_Parameters<span class="token operator">&amp;</span>   theParameters<span class="token punctuation">,</span>
  <span class="token keyword">const</span> Message_ProgressRange<span class="token operator">&amp;</span>   theRange<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">)</span>theRange<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>theModel<span class="token punctuation">.</span><span class="token function">IsNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Standard_False<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> Standard_Integer aFacesNb    <span class="token operator">=</span> theModel<span class="token operator">-&gt;</span><span class="token function">FacesNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Standard_Boolean isOneThread <span class="token operator">=</span> <span class="token operator">!</span>theParameters<span class="token punctuation">.</span>InParallel<span class="token punctuation">;</span>
  <span class="token comment">//并行运行或者单线程运行</span>
  <span class="token comment">//对锥面进行分割 对所有3d的曲线以及参数曲线进行分割和缝合</span>
  <span class="token class-name">OSD_Parallel</span><span class="token double-colon punctuation">::</span><span class="token function">For</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> aFacesNb<span class="token punctuation">,</span> <span class="token function">SeamEdgeAmplifier</span>        <span class="token punctuation">(</span>theModel<span class="token punctuation">,</span> theParameters<span class="token punctuation">)</span><span class="token punctuation">,</span>                      isOneThread<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">//判断三角化的一致性 判断是否有过期的三角数据</span>
  <span class="token class-name">OSD_Parallel</span><span class="token double-colon punctuation">::</span><span class="token function">For</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> aFacesNb<span class="token punctuation">,</span> <span class="token function">TriangulationConsistency</span> <span class="token punctuation">(</span>theModel<span class="token punctuation">,</span> theParameters<span class="token punctuation">.</span>AllowQualityDecrease<span class="token punctuation">)</span><span class="token punctuation">,</span> isOneThread<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 从过时的多边形中清理边缘和面.</span>
  <span class="token function">Handle</span><span class="token punctuation">(</span>NCollection_IncAllocator<span class="token punctuation">)</span> <span class="token function">aTmpAlloc</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token function">NCollection_IncAllocator</span><span class="token punctuation">(</span>IMeshData<span class="token double-colon punctuation">::</span>MEMORY_BLOCK_SIZE_HUGE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  NCollection_Map<span class="token operator">&lt;</span>IMeshData_Face<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token function">aUsedFaces</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> aTmpAlloc<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>Standard_Integer aEdgeIt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> aEdgeIt <span class="token operator">&lt;</span> theModel<span class="token operator">-&gt;</span><span class="token function">EdgesNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>aEdgeIt<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> IMeshData<span class="token double-colon punctuation">::</span>IEdgeHandle<span class="token operator">&amp;</span> aDEdge <span class="token operator">=</span> theModel<span class="token operator">-&gt;</span><span class="token function">GetEdge</span><span class="token punctuation">(</span>aEdgeIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>aDEdge<span class="token operator">-&gt;</span><span class="token function">IsFree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>aDEdge<span class="token operator">-&gt;</span><span class="token function">IsSet</span><span class="token punctuation">(</span>IMeshData_Outdated<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        TopLoc_Location aLoc<span class="token punctuation">;</span>
        <span class="token class-name">BRep_Tool</span><span class="token double-colon punctuation">::</span><span class="token function">Polygon3D</span><span class="token punctuation">(</span>aDEdge<span class="token operator">-&gt;</span><span class="token function">GetEdge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BRepMesh_ShapeTool</span><span class="token double-colon punctuation">::</span><span class="token function">NullifyEdge</span><span class="token punctuation">(</span>aDEdge<span class="token operator">-&gt;</span><span class="token function">GetEdge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span>Standard_Integer aPCurveIt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> aPCurveIt <span class="token operator">&lt;</span> aDEdge<span class="token operator">-&gt;</span><span class="token function">PCurvesNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>aPCurveIt<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">// Find adjacent outdated face.</span>
      <span class="token keyword">const</span> IMeshData<span class="token double-colon punctuation">::</span>IFaceHandle aDFace <span class="token operator">=</span> aDEdge<span class="token operator">-&gt;</span><span class="token function">GetPCurve</span><span class="token punctuation">(</span>aPCurveIt<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">GetFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>aUsedFaces<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>aDFace<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        aUsedFaces<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>aDFace<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>aDFace<span class="token operator">-&gt;</span><span class="token function">IsSet</span><span class="token punctuation">(</span>IMeshData_Outdated<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
          TopLoc_Location aLoc<span class="token punctuation">;</span>
          <span class="token keyword">const</span> <span class="token function">Handle</span><span class="token punctuation">(</span>Poly_Triangulation<span class="token punctuation">)</span><span class="token operator">&amp;</span> aTriangulation <span class="token operator">=</span>
            <span class="token class-name">BRep_Tool</span><span class="token double-colon punctuation">::</span><span class="token function">Triangulation</span><span class="token punctuation">(</span>aDFace<span class="token operator">-&gt;</span><span class="token function">GetFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Clean all edges of oudated face.</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>Standard_Integer aWireIt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> aWireIt <span class="token operator">&lt;</span> aDFace<span class="token operator">-&gt;</span><span class="token function">WiresNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>aWireIt<span class="token punctuation">)</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> IMeshData<span class="token double-colon punctuation">::</span>IWireHandle<span class="token operator">&amp;</span> aDWire <span class="token operator">=</span> aDFace<span class="token operator">-&gt;</span><span class="token function">GetWire</span><span class="token punctuation">(</span>aWireIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Standard_Integer aWireEdgeIt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> aWireEdgeIt <span class="token operator">&lt;</span> aDWire<span class="token operator">-&gt;</span><span class="token function">EdgesNb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>aWireEdgeIt<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">const</span> IMeshData<span class="token double-colon punctuation">::</span>IEdgeHandle aTmpDEdge <span class="token operator">=</span> aDWire<span class="token operator">-&gt;</span><span class="token function">GetEdge</span><span class="token punctuation">(</span>aWireEdgeIt<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token class-name">BRepMesh_ShapeTool</span><span class="token double-colon punctuation">::</span><span class="token function">NullifyEdge</span><span class="token punctuation">(</span>aTmpDEdge<span class="token operator">-&gt;</span><span class="token function">GetEdge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> aTriangulation<span class="token punctuation">,</span> aLoc<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

          <span class="token class-name">BRepMesh_ShapeTool</span><span class="token double-colon punctuation">::</span><span class="token function">NullifyFace</span><span class="token punctuation">(</span>aDFace<span class="token operator">-&gt;</span><span class="token function">GetFace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> Standard_True<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>总结一下 前处理基本上是对一些过期的三角数据和边数据进行清理</p> 
<h4><a id="5aContextDiscretizeFacesaPSNext9__403"></a>5、aContext-&gt;DiscretizeFaces(aPS.Next(9)) 面的离散</h4> 
<p>这里的算法比较庞大，基本上是根据平面不同的类型来执行不同的算法</p> 
<pre><code class="prism language-cpp"><span class="token keyword">switch</span> <span class="token punctuation">(</span>theSurfaceType<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">case</span> GeomAbs_Plane<span class="token operator">:</span>
    <span class="token keyword">return</span> theParameters<span class="token punctuation">.</span>InternalVerticesMode <span class="token operator">?</span>
      <span class="token keyword">new</span> NodeInsertionMeshAlgo<span class="token operator">&lt;</span>BRepMesh_DefaultRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type <span class="token operator">:</span>
      <span class="token keyword">new</span> BaseMeshAlgo<span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> GeomAbs_Sphere<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> NodeInsertionMeshAlgo<span class="token operator">&lt;</span>BRepMesh_SphereRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> GeomAbs_Cylinder<span class="token operator">:</span>
    <span class="token keyword">return</span> theParameters<span class="token punctuation">.</span>InternalVerticesMode <span class="token operator">?</span>
      <span class="token keyword">new</span> NodeInsertionMeshAlgo<span class="token operator">&lt;</span>BRepMesh_CylinderRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type <span class="token operator">:</span>
      <span class="token keyword">new</span> BaseMeshAlgo<span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> GeomAbs_Cone<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> NodeInsertionMeshAlgo<span class="token operator">&lt;</span>BRepMesh_ConeRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> GeomAbs_Torus<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> NodeInsertionMeshAlgo<span class="token operator">&lt;</span>BRepMesh_TorusRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">case</span> GeomAbs_SurfaceOfRevolution<span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> DeflectionControlMeshAlgo<span class="token operator">&lt;</span>BRepMesh_BoundaryParamsRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>

  <span class="token keyword">default</span><span class="token operator">:</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> DeflectionControlMeshAlgo<span class="token operator">&lt;</span>BRepMesh_NURBSRangeSplitter<span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>Type<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>这里可以读一下这个大佬的文章，总结的还不错<br> https://blog.csdn.net/YongsenDY/article/details/115304488</p> 
<h4><a id="6aContextPostProcessModel__443"></a>6、aContext-&gt;PostProcessModel() 后处理</h4> 
<p>后处理将三角剖分中的多边形存储到TopoDS_Edge<br> 具体的源码在BRepMesh_ModelHealer.cxx中可以自行查看</p> 
<h3><a id="_447"></a>三、总结</h3> 
<p>离散的步骤主要如下：</p> 
<ol><li>设置离散的参数</li><li>执行IncrementalMesh算法开始离散</li><li>设置上下文的参数（包括用什么算法离散、以及初始化六个步骤用到的类的实例）</li><li>开始离散<br> 4.1. 创建离散化模型<br> 4.2. 对边进行离散<br> 4.3. 修复模型<br> 4.4. 前处理<br> 4.5. 对不同类型的面用不同的算法离散<br> 4.6. 后处理，将数据存储到TopoDS上</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/09956d212646a84e279677d9bb6026ee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Pytorch实现Warm up&#43;余弦退火，亲测有效</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d43adba3bfa41a085c4f91b5fefd97a1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">实验5继承和派生（二）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>