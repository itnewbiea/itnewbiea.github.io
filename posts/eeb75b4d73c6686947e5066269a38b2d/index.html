<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>php 微信公众号 41005,php 微信公众平台上传多媒体接口 41005错误 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="php 微信公众号 41005,php 微信公众平台上传多媒体接口 41005错误" />
<meta property="og:description" content="文链接: http://www.maoyupeng.com/wechart-upload-image-errorcode-41005.html
PHP的cURL支持通过给CURL_POSTFIELDS传递关联数组(而不是字符串)来生成multipart/form-data的POST请求。
传统上，PHP的cURL支持通过在数组数据中，使用“@&#43;文件全路径”的语法附加文件，供cURL读取上传。这与命令行直接调用cURL程序的语法是一致的：
curl_setopt(ch, CURLOPT_POSTFIELDS, array(
‘file‘ =&gt; [email protected](‘image.png‘),
));
equals
$ curl -F &#34;file=@/absolute/path/to/image.png&#34; 但PHP从5.5开始引入了新的CURLFile类用来指向文件。CURLFile类也可以详细定义MIME类型、文件名等可能出现在multipart/form-data数据中的附加信息。PHP推荐使用CURLFile替代旧的@语法：
curl_setopt(ch, CURLOPT_POSTFIELDS, [
‘file‘ =&gt; new CURLFile(realpath(‘image.png‘)),
]);
PHP 5.5另外引入了CURL_SAFE_UPLOAD选项，可以强制PHP的cURL模块拒绝旧的@语法，仅接受CURLFile式的文件。5.5的默认值为false，5.6的默认值为true。
微信公众号多媒体上传接口返回码出现41005的原因就是不能识别文件.
归根到底,可能开发者没有太在乎php版本之间的更新和差异,所以导致在低版本的php环境开发的,然后部署到高版本的环境中.
需要注意的是php5.4 php5.5 php5.6三个版本都有所不同.下面我贴出一段上传图片代码,供大家参考(能兼容三个版本):
$filepath = dirname ( __FILE__ ) . &#34;/a.jpg&#34;;
if (class_exists ( ‘\CURLFile‘ )) {//关键是判断curlfile,官网推荐php5.5或更高的版本使用curlfile来实例文件
$filedata = array (
‘fieldname‘ =&gt; new \CURLFile ( realpath ( $filepath ), ‘image/jpeg‘ )
);
} else {
$filedata = array (" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/eeb75b4d73c6686947e5066269a38b2d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-26T09:00:47+08:00" />
<meta property="article:modified_time" content="2021-03-26T09:00:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">php 微信公众号 41005,php 微信公众平台上传多媒体接口 41005错误</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>文链接: http://www.maoyupeng.com/wechart-upload-image-errorcode-41005.html</p> 
 <p>PHP的cURL支持通过给CURL_POSTFIELDS传递关联数组(而不是字符串)来生成multipart/form-data的POST请求。</p> 
 <p>传统上，PHP的cURL支持通过在数组数据中，使用“@+文件全路径”的语法附加文件，供cURL读取上传。这与命令行直接调用cURL程序的语法是一致的：</p> 
 <p>curl_setopt(ch, CURLOPT_POSTFIELDS, array(</p> 
 <p>‘file‘ =&gt; [email protected](‘image.png‘),</p> 
 <p>));</p> 
 <p>equals</p> 
 <p>$ curl -F "file=@/absolute/path/to/image.png" </p> 
 <p>但PHP从5.5开始引入了新的CURLFile类用来指向文件。CURLFile类也可以详细定义MIME类型、文件名等可能出现在multipart/form-data数据中的附加信息。PHP推荐使用CURLFile替代旧的@语法：</p> 
 <p>curl_setopt(ch, CURLOPT_POSTFIELDS, [</p> 
 <p>‘file‘ =&gt; new CURLFile(realpath(‘image.png‘)),</p> 
 <p>]);</p> 
 <p>PHP 5.5另外引入了CURL_SAFE_UPLOAD选项，可以强制PHP的cURL模块拒绝旧的@语法，仅接受CURLFile式的文件。5.5的默认值为false，5.6的默认值为true。</p> 
 <p>微信公众号多媒体上传接口返回码出现41005的原因就是不能识别文件.</p> 
 <p>归根到底,可能开发者没有太在乎php版本之间的更新和差异,所以导致在低版本的php环境开发的,然后部署到高版本的环境中.</p> 
 <p>需要注意的是php5.4 php5.5 php5.6三个版本都有所不同.下面我贴出一段上传图片代码,供大家参考(能兼容三个版本):</p> 
 <p>$filepath = dirname ( __FILE__ ) . "/a.jpg";</p> 
 <p>if (class_exists ( ‘\CURLFile‘ )) {//关键是判断curlfile,官网推荐php5.5或更高的版本使用curlfile来实例文件</p> 
 <p>$filedata = array (</p> 
 <p>‘fieldname‘ =&gt; new \CURLFile ( realpath ( $filepath ), ‘image/jpeg‘ )</p> 
 <p>);</p> 
 <p>} else {<!-- --></p> 
 <p>$filedata = array (</p> 
 <p>‘fieldname‘ =&gt; [email protected] . realpath ( $filepath )</p> 
 <p>);</p> 
 <p>}</p> 
 <p>$url = "http://file.api.weixin.qq.com/cgi-bin/media/upload?access_token=" . $access_token . "&amp;type=image";</p> 
 <p>$result = Http::upload ( $url, $filedata );//调用upload函数</p> 
 <p>if (isset ( $result )) {<!-- --></p> 
 <p>$data = json_decode ( $result );</p> 
 <p>if (isset ( $data-&gt;media_id )) {<!-- --></p> 
 <p>$this-&gt;responseText ( $data-&gt;media_id );//这是我自己封装的返回消息函数</p> 
 <p>} else {<!-- --></p> 
 <p>$this-&gt;responseImg ( "not set media_id" );//这是我自己封装的返回消息函数</p> 
 <p>}</p> 
 <p>} else {<!-- --></p> 
 <p>$this-&gt;responseText ( "no response" );//这是我自己封装的返回消息函数</p> 
 <p>}</p> 
 <p>public static function upload($url, $filedata) {<!-- --></p> 
 <p>$curl = curl_init ();</p> 
 <p>if (class_exists ( ‘/CURLFile‘ )) {//php5.5跟php5.6中的CURLOPT_SAFE_UPLOAD的默认值不同</p> 
 <p>curl_setopt ( $curl, CURLOPT_SAFE_UPLOAD, true );</p> 
 <p>} else {<!-- --></p> 
 <p>if (defined ( ‘CURLOPT_SAFE_UPLOAD‘ )) {<!-- --></p> 
 <p>curl_setopt ( $curl, CURLOPT_SAFE_UPLOAD, false );</p> 
 <p>}</p> 
 <p>}</p> 
 <p>curl_setopt ( $curl, CURLOPT_URL, $url );</p> 
 <p>curl_setopt ( $curl, CURLOPT_SSL_VERIFYPEER, FALSE );</p> 
 <p>curl_setopt ( $curl, CURLOPT_SSL_VERIFYHOST, FALSE );</p> 
 <p>if (! empty ( $filedata )) {<!-- --></p> 
 <p>curl_setopt ( $curl, CURLOPT_POST, 1 );</p> 
 <p>curl_setopt ( $curl, CURLOPT_POSTFIELDS, $filedata );</p> 
 <p>}</p> 
 <p>curl_setopt ( $curl, CURLOPT_RETURNTRANSFER, 1 );</p> 
 <p>$output = curl_exec ( $curl );</p> 
 <p>curl_close ( $curl );</p> 
 <p>return $output;</p> 
 <p>}</p> 
 <p>原文：http://www.cnblogs.com/whowhere/p/5845289.html</p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ae836ab5d0c7d90736bf626159d65968/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SpringSecurity 流程图</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d5f54870c50fb43ff1a91893a6fe13d2/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android加密之全盘加密(FDE)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>