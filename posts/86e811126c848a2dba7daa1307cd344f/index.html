<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>视觉SLAM十四讲 第八讲 视觉里程计2 8.5直接法BA法 代码解析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="视觉SLAM十四讲 第八讲 视觉里程计2 8.5直接法BA法 代码解析" />
<meta property="og:description" content="总体思路
提取特征点
构建图优化问题
边（误差项），在直接法中为光度误差
边的增量项
光度误差相对于李代数的雅可比矩阵：
图像坐标对李代数的雅可比矩阵
为 u 处的像素梯度
边的误差项
_error ( 0,0 ) = getPixelValue ( x,y ) - _measurement;
g2o优化库
增加顶点
增加边（每个特征点一条边）
优化迭代
代码
#include &lt;iostream&gt; #include &lt;fstream&gt; #include &lt;list&gt; #include &lt;vector&gt; #include &lt;chrono&gt; #include &lt;ctime&gt; #include &lt;climits&gt; #include &lt;opencv2/core/core.hpp&gt; #include &lt;opencv2/imgproc/imgproc.hpp&gt; #include &lt;opencv2/highgui/highgui.hpp&gt; #include &lt;opencv2/features2d/features2d.hpp&gt; #include &lt;g2o/core/base_unary_edge.h&gt; #include &lt;g2o/core/block_solver.h&gt; #include &lt;g2o/core/optimization_algorithm_levenberg.h&gt; #include &lt;g2o/solvers/dense/linear_solver_dense.h&gt; #include &lt;g2o/core/robust_kernel.h&gt; #include &lt;g2o/types/sba/types_six_dof_expmap.h&gt; using namespace std; using namespace g2o; /******************************************** * 本节演示了RGBD上的稀疏直接法 ********************************************/ // 一次测量的值，包括一个世界坐标系下三维点与一个灰度值 struct Measurement { Measurement ( Eigen::Vector3d p, float g ) : pos_world ( p ), grayscale ( g ) {} Eigen::Vector3d pos_world; float grayscale; }; inline Eigen::Vector3d project2Dto3D ( int x, int y, int d, float fx, float fy, float cx, float cy, float scale ) { float zz = float ( d ) /scale; float xx = zz* ( x-cx ) /fx; float yy = zz* ( y-cy ) /fy; return Eigen::Vector3d ( xx, yy, zz ); } inline Eigen::Vector2d project3Dto2D ( float x, float y, float z, float fx, float fy, float cx, float cy ) { float u = fx*x/z&#43;cx; float v = fy*y/z&#43;cy; return Eigen::Vector2d ( u,v ); } // 直接法估计位姿 // 输入：测量值（空间点的灰度），新的灰度图，相机内参； 输出：相机位姿 // 返回：true为成功，false失败 bool poseEstimationDirect ( const vector&lt;Measurement&gt;&amp; measurements, cv::Mat* gray, Eigen::Matrix3f&amp; intrinsics, Eigen::Isometry3d&amp; Tcw ); // project a 3d point into an image plane, the error is photometric error // an unary edge with one vertex SE3Expmap (the pose of camera) class EdgeSE3ProjectDirect: public BaseUnaryEdge&lt; 1, double, VertexSE3Expmap&gt; { public: EIGEN_MAKE_ALIGNED_OPERATOR_NEW EdgeSE3ProjectDirect() {} EdgeSE3ProjectDirect ( Eigen::Vector3d point, float fx, float fy, float cx, float cy, cv::Mat* image ) : x_world_ ( point ), fx_ ( fx ), fy_ ( fy ), cx_ ( cx ), cy_ ( cy ), image_ ( image ) {} virtual void computeError() { const VertexSE3Expmap* v =static_cast&lt;const VertexSE3Expmap*&gt; ( _vertices[0] ); Eigen::Vector3d x_local = v-&gt;estimate()." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/86e811126c848a2dba7daa1307cd344f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-24T21:37:47+08:00" />
<meta property="article:modified_time" content="2020-03-24T21:37:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">视觉SLAM十四讲 第八讲 视觉里程计2 8.5直接法BA法 代码解析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>总体思路<br> 提取特征点<br> 构建图优化问题<br> 边（误差项），在直接法中为光度误差<br> 边的增量项<br> 光度误差相对于李代数的雅可比矩阵：<br> 图像坐标对李代数的雅可比矩阵<br> 为 u 处的像素梯度<br> 边的误差项<br> _error ( 0,0 ) = getPixelValue ( x,y ) - _measurement;<br> g2o优化库<br> 增加顶点<br> 增加边（每个特征点一条边）<br> 优化迭代<br> 代码</p> 
<pre><code class="prism language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;list&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;climits&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/core/core.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/imgproc/imgproc.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/highgui/highgui.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/features2d/features2d.hpp&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;g2o/core/base_unary_edge.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;g2o/core/block_solver.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;g2o/core/optimization_algorithm_levenberg.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;g2o/solvers/dense/linear_solver_dense.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;g2o/core/robust_kernel.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;g2o/types/sba/types_six_dof_expmap.h&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> g2o<span class="token punctuation">;</span>

<span class="token comment">/********************************************
 * 本节演示了RGBD上的稀疏直接法 
 ********************************************/</span>

<span class="token comment">// 一次测量的值，包括一个世界坐标系下三维点与一个灰度值</span>
<span class="token keyword">struct</span> Measurement
<span class="token punctuation">{<!-- --></span>
    Measurement <span class="token punctuation">(</span> Eigen<span class="token operator">::</span>Vector3d p<span class="token punctuation">,</span> <span class="token keyword">float</span> g <span class="token punctuation">)</span> <span class="token operator">:</span> pos_world <span class="token punctuation">(</span> p <span class="token punctuation">)</span><span class="token punctuation">,</span> grayscale <span class="token punctuation">(</span> g <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    Eigen<span class="token operator">::</span>Vector3d pos_world<span class="token punctuation">;</span>
    <span class="token keyword">float</span> grayscale<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">inline</span> Eigen<span class="token operator">::</span>Vector3d project2Dto3D <span class="token punctuation">(</span> <span class="token keyword">int</span> x<span class="token punctuation">,</span> <span class="token keyword">int</span> y<span class="token punctuation">,</span> <span class="token keyword">int</span> d<span class="token punctuation">,</span> <span class="token keyword">float</span> fx<span class="token punctuation">,</span> <span class="token keyword">float</span> fy<span class="token punctuation">,</span> <span class="token keyword">float</span> cx<span class="token punctuation">,</span> <span class="token keyword">float</span> cy<span class="token punctuation">,</span> <span class="token keyword">float</span> scale <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> zz <span class="token operator">=</span> <span class="token keyword">float</span> <span class="token punctuation">(</span> d <span class="token punctuation">)</span> <span class="token operator">/</span>scale<span class="token punctuation">;</span>
    <span class="token keyword">float</span> xx <span class="token operator">=</span> zz<span class="token operator">*</span> <span class="token punctuation">(</span> x<span class="token operator">-</span>cx <span class="token punctuation">)</span> <span class="token operator">/</span>fx<span class="token punctuation">;</span>
    <span class="token keyword">float</span> yy <span class="token operator">=</span> zz<span class="token operator">*</span> <span class="token punctuation">(</span> y<span class="token operator">-</span>cy <span class="token punctuation">)</span> <span class="token operator">/</span>fy<span class="token punctuation">;</span>
    <span class="token keyword">return</span> Eigen<span class="token operator">::</span>Vector3d <span class="token punctuation">(</span> xx<span class="token punctuation">,</span> yy<span class="token punctuation">,</span> zz <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> Eigen<span class="token operator">::</span>Vector2d project3Dto2D <span class="token punctuation">(</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">float</span> z<span class="token punctuation">,</span> <span class="token keyword">float</span> fx<span class="token punctuation">,</span> <span class="token keyword">float</span> fy<span class="token punctuation">,</span> <span class="token keyword">float</span> cx<span class="token punctuation">,</span> <span class="token keyword">float</span> cy <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> u <span class="token operator">=</span> fx<span class="token operator">*</span>x<span class="token operator">/</span>z<span class="token operator">+</span>cx<span class="token punctuation">;</span>
    <span class="token keyword">float</span> v <span class="token operator">=</span> fy<span class="token operator">*</span>y<span class="token operator">/</span>z<span class="token operator">+</span>cy<span class="token punctuation">;</span>
    <span class="token keyword">return</span> Eigen<span class="token operator">::</span>Vector2d <span class="token punctuation">(</span> u<span class="token punctuation">,</span>v <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 直接法估计位姿</span>
<span class="token comment">// 输入：测量值（空间点的灰度），新的灰度图，相机内参； 输出：相机位姿</span>
<span class="token comment">// 返回：true为成功，false失败</span>
<span class="token keyword">bool</span> poseEstimationDirect <span class="token punctuation">(</span> <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>Measurement<span class="token operator">&gt;</span><span class="token operator">&amp;</span> measurements<span class="token punctuation">,</span> cv<span class="token operator">::</span>Mat<span class="token operator">*</span> gray<span class="token punctuation">,</span> Eigen<span class="token operator">::</span>Matrix3f<span class="token operator">&amp;</span> intrinsics<span class="token punctuation">,</span> Eigen<span class="token operator">::</span>Isometry3d<span class="token operator">&amp;</span> Tcw <span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// project a 3d point into an image plane, the error is photometric error</span>
<span class="token comment">// an unary edge with one vertex SE3Expmap (the pose of camera)</span>
<span class="token keyword">class</span> <span class="token class-name">EdgeSE3ProjectDirect</span><span class="token operator">:</span> <span class="token keyword">public</span> BaseUnaryEdge<span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">,</span> VertexSE3Expmap<span class="token operator">&gt;</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    EIGEN_MAKE_ALIGNED_OPERATOR_NEW

    <span class="token function">EdgeSE3ProjectDirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    EdgeSE3ProjectDirect <span class="token punctuation">(</span> Eigen<span class="token operator">::</span>Vector3d point<span class="token punctuation">,</span> <span class="token keyword">float</span> fx<span class="token punctuation">,</span> <span class="token keyword">float</span> fy<span class="token punctuation">,</span> <span class="token keyword">float</span> cx<span class="token punctuation">,</span> <span class="token keyword">float</span> cy<span class="token punctuation">,</span> cv<span class="token operator">::</span>Mat<span class="token operator">*</span> image <span class="token punctuation">)</span>
        <span class="token operator">:</span> x_world_ <span class="token punctuation">(</span> point <span class="token punctuation">)</span><span class="token punctuation">,</span> fx_ <span class="token punctuation">(</span> fx <span class="token punctuation">)</span><span class="token punctuation">,</span> fy_ <span class="token punctuation">(</span> fy <span class="token punctuation">)</span><span class="token punctuation">,</span> cx_ <span class="token punctuation">(</span> cx <span class="token punctuation">)</span><span class="token punctuation">,</span> cy_ <span class="token punctuation">(</span> cy <span class="token punctuation">)</span><span class="token punctuation">,</span> image_ <span class="token punctuation">(</span> image <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">computeError</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> VertexSE3Expmap<span class="token operator">*</span> v  <span class="token operator">=</span><span class="token keyword">static_cast</span><span class="token operator">&lt;</span><span class="token keyword">const</span> VertexSE3Expmap<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span> _vertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token operator">::</span>Vector3d x_local <span class="token operator">=</span> v<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">estimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token punctuation">(</span> x_world_ <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> x <span class="token operator">=</span> x_local<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">*</span>fx_<span class="token operator">/</span>x_local<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> cx_<span class="token punctuation">;</span>
        <span class="token keyword">float</span> y <span class="token operator">=</span> x_local<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">*</span>fy_<span class="token operator">/</span>x_local<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> cy_<span class="token punctuation">;</span>
        <span class="token comment">// check x,y is in the image</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> x<span class="token operator">-</span><span class="token number">4</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span> x<span class="token operator">+</span><span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span>image_<span class="token operator">-</span><span class="token operator">&gt;</span>cols <span class="token operator">||</span> <span class="token punctuation">(</span> y<span class="token operator">-</span><span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span> y<span class="token operator">+</span><span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span>image_<span class="token operator">-</span><span class="token operator">&gt;</span>rows <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _error <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token operator">-</span><span class="token operator">&gt;</span>setLevel <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{<!-- --></span>
            _error <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">=</span> getPixelValue <span class="token punctuation">(</span> x<span class="token punctuation">,</span>y <span class="token punctuation">)</span> <span class="token operator">-</span> _measurement<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// plus in manifold</span>
    <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">linearizeOplus</span><span class="token punctuation">(</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">level</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            _jacobianOplusXi <span class="token operator">=</span> Eigen<span class="token operator">::</span>Matrix<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        VertexSE3Expmap<span class="token operator">*</span> vtx <span class="token operator">=</span> <span class="token keyword">static_cast</span><span class="token operator">&lt;</span>VertexSE3Expmap<span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span> _vertices<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token operator">::</span>Vector3d xyz_trans <span class="token operator">=</span> vtx<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">estimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map <span class="token punctuation">(</span> x_world_ <span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// q in book</span>

        <span class="token keyword">double</span> x <span class="token operator">=</span> xyz_trans<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> y <span class="token operator">=</span> xyz_trans<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> invz <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span>xyz_trans<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> invz_2 <span class="token operator">=</span> invz<span class="token operator">*</span>invz<span class="token punctuation">;</span>

        <span class="token keyword">float</span> u <span class="token operator">=</span> x<span class="token operator">*</span>fx_<span class="token operator">*</span>invz <span class="token operator">+</span> cx_<span class="token punctuation">;</span>
        <span class="token keyword">float</span> v <span class="token operator">=</span> y<span class="token operator">*</span>fy_<span class="token operator">*</span>invz <span class="token operator">+</span> cy_<span class="token punctuation">;</span>

        <span class="token comment">// jacobian from se3 to u,v</span>
        <span class="token comment">// NOTE that in g2o the Lie algebra is (\omega, \epsilon), where \omega is so(3) and \epsilon the translation</span>
        Eigen<span class="token operator">::</span>Matrix<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token operator">&gt;</span> jacobian_uv_ksai<span class="token punctuation">;</span>

        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> x<span class="token operator">*</span>y<span class="token operator">*</span>invz_2 <span class="token operator">*</span>fx_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">+</span> <span class="token punctuation">(</span> x<span class="token operator">*</span>x<span class="token operator">*</span>invz_2 <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">*</span>fx_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> y<span class="token operator">*</span>invz <span class="token operator">*</span>fx_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">)</span> <span class="token operator">=</span> invz <span class="token operator">*</span>fx_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>x<span class="token operator">*</span>invz_2 <span class="token operator">*</span>fx_<span class="token punctuation">;</span>

        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span> <span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">+</span>y<span class="token operator">*</span>y<span class="token operator">*</span>invz_2 <span class="token punctuation">)</span> <span class="token operator">*</span>fy_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">=</span> x<span class="token operator">*</span>y<span class="token operator">*</span>invz_2 <span class="token operator">*</span>fy_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">)</span> <span class="token operator">=</span> x<span class="token operator">*</span>invz <span class="token operator">*</span>fy_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span> <span class="token punctuation">)</span> <span class="token operator">=</span> invz <span class="token operator">*</span>fy_<span class="token punctuation">;</span>
        jacobian_uv_ksai <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">5</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>y<span class="token operator">*</span>invz_2 <span class="token operator">*</span>fy_<span class="token punctuation">;</span>

        Eigen<span class="token operator">::</span>Matrix<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token operator">&gt;</span> jacobian_pixel_uv<span class="token punctuation">;</span>

        jacobian_pixel_uv <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span> getPixelValue <span class="token punctuation">(</span> u<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span>v <span class="token punctuation">)</span><span class="token operator">-</span>getPixelValue <span class="token punctuation">(</span> u<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>v <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>
        jacobian_pixel_uv <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span> getPixelValue <span class="token punctuation">(</span> u<span class="token punctuation">,</span>v<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token operator">-</span>getPixelValue <span class="token punctuation">(</span> u<span class="token punctuation">,</span>v<span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>

        _jacobianOplusXi <span class="token operator">=</span> jacobian_pixel_uv<span class="token operator">*</span>jacobian_uv_ksai<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// dummy read and write functions because we don't care...</span>
    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> read <span class="token punctuation">(</span> std<span class="token operator">::</span>istream<span class="token operator">&amp;</span> in <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">virtual</span> <span class="token keyword">bool</span> write <span class="token punctuation">(</span> std<span class="token operator">::</span>ostream<span class="token operator">&amp;</span> out <span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">protected</span><span class="token operator">:</span>
    <span class="token comment">// get a gray scale value from reference image (bilinear interpolated)</span>
    <span class="token keyword">inline</span> <span class="token keyword">float</span> getPixelValue <span class="token punctuation">(</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        uchar<span class="token operator">*</span> data <span class="token operator">=</span> <span class="token operator">&amp;</span> image_<span class="token operator">-</span><span class="token operator">&gt;</span>data<span class="token punctuation">[</span> <span class="token keyword">int</span> <span class="token punctuation">(</span> y <span class="token punctuation">)</span> <span class="token operator">*</span> image_<span class="token operator">-</span><span class="token operator">&gt;</span>step <span class="token operator">+</span> <span class="token keyword">int</span> <span class="token punctuation">(</span> x <span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> xx <span class="token operator">=</span> x <span class="token operator">-</span> floor <span class="token punctuation">(</span> x <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> yy <span class="token operator">=</span> y <span class="token operator">-</span> floor <span class="token punctuation">(</span> y <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">float</span> <span class="token punctuation">(</span>
                   <span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">-</span>xx <span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">-</span>yy <span class="token punctuation">)</span> <span class="token operator">*</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
                   xx<span class="token operator">*</span> <span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">-</span>yy <span class="token punctuation">)</span> <span class="token operator">*</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>
                   <span class="token punctuation">(</span> <span class="token number">1</span><span class="token operator">-</span>xx <span class="token punctuation">)</span> <span class="token operator">*</span>yy<span class="token operator">*</span>data<span class="token punctuation">[</span> image_<span class="token operator">-</span><span class="token operator">&gt;</span>step <span class="token punctuation">]</span> <span class="token operator">+</span>
                   xx<span class="token operator">*</span>yy<span class="token operator">*</span>data<span class="token punctuation">[</span>image_<span class="token operator">-</span><span class="token operator">&gt;</span>step<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span>
               <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token keyword">public</span><span class="token operator">:</span>
    Eigen<span class="token operator">::</span>Vector3d x_world_<span class="token punctuation">;</span>   <span class="token comment">// 3D point in world frame</span>
    <span class="token keyword">float</span> cx_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> cy_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> fx_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> fy_<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// Camera intrinsics</span>
    cv<span class="token operator">::</span>Mat<span class="token operator">*</span> image_<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>    <span class="token comment">// reference image</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> main <span class="token punctuation">(</span> <span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> argc <span class="token operator">!=</span> <span class="token number">2</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"usage: useLK path_to_dataset"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    srand <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token punctuation">)</span> time <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    string path_to_dataset <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    string associate_file <span class="token operator">=</span> path_to_dataset <span class="token operator">+</span> <span class="token string">"/associate.txt"</span><span class="token punctuation">;</span>

    ifstream fin <span class="token punctuation">(</span> associate_file <span class="token punctuation">)</span><span class="token punctuation">;</span>

    string rgb_file<span class="token punctuation">,</span> depth_file<span class="token punctuation">,</span> time_rgb<span class="token punctuation">,</span> time_depth<span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Mat color<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> gray<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Measurement<span class="token operator">&gt;</span> measurements<span class="token punctuation">;</span>
    <span class="token comment">// 相机内参</span>
    <span class="token keyword">float</span> cx <span class="token operator">=</span> <span class="token number">325.5</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> cy <span class="token operator">=</span> <span class="token number">253.5</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> fx <span class="token operator">=</span> <span class="token number">518.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> fy <span class="token operator">=</span> <span class="token number">519.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> depth_scale <span class="token operator">=</span> <span class="token number">1000.0</span><span class="token punctuation">;</span>
    Eigen<span class="token operator">::</span>Matrix3f K<span class="token punctuation">;</span>
    K<span class="token operator">&lt;&lt;</span>fx<span class="token punctuation">,</span><span class="token number">0.f</span><span class="token punctuation">,</span>cx<span class="token punctuation">,</span><span class="token number">0.f</span><span class="token punctuation">,</span>fy<span class="token punctuation">,</span>cy<span class="token punctuation">,</span><span class="token number">0.f</span><span class="token punctuation">,</span><span class="token number">0.f</span><span class="token punctuation">,</span><span class="token number">1.0f</span><span class="token punctuation">;</span>

    Eigen<span class="token operator">::</span>Isometry3d Tcw <span class="token operator">=</span> Eigen<span class="token operator">::</span>Isometry3d<span class="token operator">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cv<span class="token operator">::</span>Mat prev_color<span class="token punctuation">;</span>
    <span class="token comment">// 我们以第一个图像为参考，对后续图像和参考图像做直接法</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> index<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> index<span class="token operator">&lt;</span><span class="token number">10</span><span class="token punctuation">;</span> index<span class="token operator">++</span> <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"*********** loop "</span><span class="token operator">&lt;&lt;</span>index<span class="token operator">&lt;&lt;</span><span class="token string">" ************"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        fin<span class="token operator">&gt;&gt;</span>time_rgb<span class="token operator">&gt;&gt;</span>rgb_file<span class="token operator">&gt;&gt;</span>time_depth<span class="token operator">&gt;&gt;</span>depth_file<span class="token punctuation">;</span>
        color <span class="token operator">=</span> cv<span class="token operator">::</span>imread <span class="token punctuation">(</span> path_to_dataset<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>rgb_file <span class="token punctuation">)</span><span class="token punctuation">;</span>
        depth <span class="token operator">=</span> cv<span class="token operator">::</span>imread <span class="token punctuation">(</span> path_to_dataset<span class="token operator">+</span><span class="token string">"/"</span><span class="token operator">+</span>depth_file<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> color<span class="token punctuation">.</span>data<span class="token operator">==</span><span class="token keyword">nullptr</span> <span class="token operator">||</span> depth<span class="token punctuation">.</span>data<span class="token operator">==</span><span class="token keyword">nullptr</span> <span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span> 
        cv<span class="token operator">::</span>cvtColor <span class="token punctuation">(</span> color<span class="token punctuation">,</span> gray<span class="token punctuation">,</span> cv<span class="token operator">::</span>COLOR_BGR2GRAY <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> index <span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 对第一帧提取FAST特征点</span>
            vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>KeyPoint<span class="token operator">&gt;</span> keypoints<span class="token punctuation">;</span>
            cv<span class="token operator">::</span>Ptr<span class="token operator">&lt;</span>cv<span class="token operator">::</span>FastFeatureDetector<span class="token operator">&gt;</span> detector <span class="token operator">=</span> cv<span class="token operator">::</span>FastFeatureDetector<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            detector<span class="token operator">-</span><span class="token operator">&gt;</span>detect <span class="token punctuation">(</span> color<span class="token punctuation">,</span> keypoints <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span> <span class="token keyword">auto</span> kp<span class="token operator">:</span>keypoints <span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 去掉邻近边缘处的点</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token operator">||</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> <span class="token number">20</span> <span class="token operator">||</span> <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x<span class="token operator">+</span><span class="token number">20</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span>color<span class="token punctuation">.</span>cols <span class="token operator">||</span> <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y<span class="token operator">+</span><span class="token number">20</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span>color<span class="token punctuation">.</span>rows <span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                ushort d <span class="token operator">=</span> depth<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>ushort<span class="token operator">&gt;</span> <span class="token punctuation">(</span> cvRound <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">[</span> cvRound <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token punctuation">)</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span> d<span class="token operator">==</span><span class="token number">0</span> <span class="token punctuation">)</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                Eigen<span class="token operator">::</span>Vector3d p3d <span class="token operator">=</span> project2Dto3D <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y<span class="token punctuation">,</span> d<span class="token punctuation">,</span> fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> cx<span class="token punctuation">,</span> cy<span class="token punctuation">,</span> depth_scale <span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> grayscale <span class="token operator">=</span> <span class="token keyword">float</span> <span class="token punctuation">(</span> gray<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> <span class="token punctuation">(</span> cvRound <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">[</span> cvRound <span class="token punctuation">(</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token punctuation">)</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
                measurements<span class="token punctuation">.</span>push_back <span class="token punctuation">(</span> Measurement <span class="token punctuation">(</span> p3d<span class="token punctuation">,</span> grayscale <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            prev_color <span class="token operator">=</span> color<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 使用直接法计算相机运动</span>
        chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point t1 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        poseEstimationDirect <span class="token punctuation">(</span> measurements<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gray<span class="token punctuation">,</span> K<span class="token punctuation">,</span> Tcw <span class="token punctuation">)</span><span class="token punctuation">;</span>
        chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point t2 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        chrono<span class="token operator">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;</span> time_used <span class="token operator">=</span> chrono<span class="token operator">::</span>duration_cast<span class="token operator">&lt;</span>chrono<span class="token operator">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span> <span class="token punctuation">(</span> t2<span class="token operator">-</span>t1 <span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"direct method costs time: "</span><span class="token operator">&lt;&lt;</span>time_used<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span><span class="token string">" seconds."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"Tcw="</span><span class="token operator">&lt;&lt;</span>Tcw<span class="token punctuation">.</span><span class="token function">matrix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

        <span class="token comment">// plot the feature points</span>
        cv<span class="token operator">::</span>Mat img_show <span class="token punctuation">(</span> color<span class="token punctuation">.</span>rows<span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">,</span> color<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> CV_8UC3 <span class="token punctuation">)</span><span class="token punctuation">;</span>
        prev_color<span class="token punctuation">.</span>copyTo <span class="token punctuation">(</span> img_show <span class="token punctuation">(</span> cv<span class="token operator">::</span>Rect <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>color<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> color<span class="token punctuation">.</span>rows <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        color<span class="token punctuation">.</span>copyTo <span class="token punctuation">(</span> img_show <span class="token punctuation">(</span> cv<span class="token operator">::</span>Rect <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span>color<span class="token punctuation">.</span>rows<span class="token punctuation">,</span>color<span class="token punctuation">.</span>cols<span class="token punctuation">,</span> color<span class="token punctuation">.</span>rows <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span> Measurement m<span class="token operator">:</span>measurements <span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> RAND_MAX<span class="token operator">/</span><span class="token number">5</span> <span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            Eigen<span class="token operator">::</span>Vector3d p <span class="token operator">=</span> m<span class="token punctuation">.</span>pos_world<span class="token punctuation">;</span>
            Eigen<span class="token operator">::</span>Vector2d pixel_prev <span class="token operator">=</span> project3Dto2D <span class="token punctuation">(</span> p <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> p <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> p <span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> cx<span class="token punctuation">,</span> cy <span class="token punctuation">)</span><span class="token punctuation">;</span>
            Eigen<span class="token operator">::</span>Vector3d p2 <span class="token operator">=</span> Tcw<span class="token operator">*</span>m<span class="token punctuation">.</span>pos_world<span class="token punctuation">;</span>
            Eigen<span class="token operator">::</span>Vector2d pixel_now <span class="token operator">=</span> project3Dto2D <span class="token punctuation">(</span> p2 <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> p2 <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> p2 <span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> fx<span class="token punctuation">,</span> fy<span class="token punctuation">,</span> cx<span class="token punctuation">,</span> cy <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">pixel_now</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token function">pixel_now</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span>color<span class="token punctuation">.</span>cols <span class="token operator">||</span> <span class="token function">pixel_now</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token number">0</span> <span class="token operator">||</span> <span class="token function">pixel_now</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span>color<span class="token punctuation">.</span>rows <span class="token punctuation">)</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">*</span><span class="token keyword">float</span> <span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>
            <span class="token keyword">float</span> g <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">*</span><span class="token keyword">float</span> <span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>
            <span class="token keyword">float</span> r <span class="token operator">=</span> <span class="token number">255</span><span class="token operator">*</span><span class="token keyword">float</span> <span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">/</span>RAND_MAX<span class="token punctuation">;</span>
            cv<span class="token operator">::</span>circle <span class="token punctuation">(</span> img_show<span class="token punctuation">,</span> cv<span class="token operator">::</span>Point2d <span class="token punctuation">(</span> pixel_prev <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> pixel_prev <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>Scalar <span class="token punctuation">(</span> b<span class="token punctuation">,</span>g<span class="token punctuation">,</span>r <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span>circle <span class="token punctuation">(</span> img_show<span class="token punctuation">,</span> cv<span class="token operator">::</span>Point2d <span class="token punctuation">(</span> pixel_now <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> pixel_now <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">+</span>color<span class="token punctuation">.</span>rows <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>Scalar <span class="token punctuation">(</span> b<span class="token punctuation">,</span>g<span class="token punctuation">,</span>r <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span>line <span class="token punctuation">(</span> img_show<span class="token punctuation">,</span> cv<span class="token operator">::</span>Point2d <span class="token punctuation">(</span> pixel_prev <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> pixel_prev <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>Point2d <span class="token punctuation">(</span> pixel_now <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> pixel_now <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span> <span class="token operator">+</span>color<span class="token punctuation">.</span>rows <span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span>Scalar <span class="token punctuation">(</span> b<span class="token punctuation">,</span>g<span class="token punctuation">,</span>r <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cv<span class="token operator">::</span>imshow <span class="token punctuation">(</span> <span class="token string">"result"</span><span class="token punctuation">,</span> img_show <span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span>waitKey <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> poseEstimationDirect <span class="token punctuation">(</span> <span class="token keyword">const</span> vector<span class="token operator">&lt;</span> Measurement <span class="token operator">&gt;</span><span class="token operator">&amp;</span> measurements<span class="token punctuation">,</span> cv<span class="token operator">::</span>Mat<span class="token operator">*</span> gray<span class="token punctuation">,</span> Eigen<span class="token operator">::</span>Matrix3f<span class="token operator">&amp;</span> K<span class="token punctuation">,</span> Eigen<span class="token operator">::</span>Isometry3d<span class="token operator">&amp;</span> Tcw <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 初始化g2o</span>
    <span class="token keyword">typedef</span> g2o<span class="token operator">::</span>BlockSolver<span class="token operator">&lt;</span>g2o<span class="token operator">::</span>BlockSolverTraits<span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">&gt;&gt;</span> DirectBlock<span class="token punctuation">;</span>  <span class="token comment">// 求解的向量是6＊1的</span>
    DirectBlock<span class="token operator">::</span>LinearSolverType<span class="token operator">*</span> linearSolver <span class="token operator">=</span> <span class="token keyword">new</span> g2o<span class="token operator">::</span>LinearSolverDense<span class="token operator">&lt;</span> DirectBlock<span class="token operator">::</span>PoseMatrixType <span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    DirectBlock<span class="token operator">*</span> solver_ptr <span class="token operator">=</span> <span class="token keyword">new</span> DirectBlock <span class="token punctuation">(</span> linearSolver <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// g2o::OptimizationAlgorithmGaussNewton* solver = new g2o::OptimizationAlgorithmGaussNewton( solver_ptr ); // G-N</span>
    g2o<span class="token operator">::</span>OptimizationAlgorithmLevenberg<span class="token operator">*</span> solver <span class="token operator">=</span> <span class="token keyword">new</span> g2o<span class="token operator">::</span>OptimizationAlgorithmLevenberg <span class="token punctuation">(</span> solver_ptr <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// L-M</span>
    g2o<span class="token operator">::</span>SparseOptimizer optimizer<span class="token punctuation">;</span>
    optimizer<span class="token punctuation">.</span>setAlgorithm <span class="token punctuation">(</span> solver <span class="token punctuation">)</span><span class="token punctuation">;</span>
    optimizer<span class="token punctuation">.</span><span class="token function">setVerbose</span><span class="token punctuation">(</span> <span class="token boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    g2o<span class="token operator">::</span>VertexSE3Expmap<span class="token operator">*</span> pose <span class="token operator">=</span> <span class="token keyword">new</span> g2o<span class="token operator">::</span><span class="token function">VertexSE3Expmap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    pose<span class="token operator">-</span><span class="token operator">&gt;</span>setEstimate <span class="token punctuation">(</span> g2o<span class="token operator">::</span>SE3Quat <span class="token punctuation">(</span> Tcw<span class="token punctuation">.</span><span class="token function">rotation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Tcw<span class="token punctuation">.</span><span class="token function">translation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    pose<span class="token operator">-</span><span class="token operator">&gt;</span>setId <span class="token punctuation">(</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    optimizer<span class="token punctuation">.</span>addVertex <span class="token punctuation">(</span> pose <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加边</span>
    <span class="token keyword">int</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span> Measurement m<span class="token operator">:</span> measurements <span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        EdgeSE3ProjectDirect<span class="token operator">*</span> edge <span class="token operator">=</span> <span class="token keyword">new</span> EdgeSE3ProjectDirect <span class="token punctuation">(</span>
            m<span class="token punctuation">.</span>pos_world<span class="token punctuation">,</span>
            K <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> K <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> K <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> K <span class="token punctuation">(</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> gray
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        edge<span class="token operator">-</span><span class="token operator">&gt;</span>setVertex <span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> pose <span class="token punctuation">)</span><span class="token punctuation">;</span>
        edge<span class="token operator">-</span><span class="token operator">&gt;</span>setMeasurement <span class="token punctuation">(</span> m<span class="token punctuation">.</span>grayscale <span class="token punctuation">)</span><span class="token punctuation">;</span>
        edge<span class="token operator">-</span><span class="token operator">&gt;</span>setInformation <span class="token punctuation">(</span> Eigen<span class="token operator">::</span>Matrix<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token operator">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        edge<span class="token operator">-</span><span class="token operator">&gt;</span>setId <span class="token punctuation">(</span> id<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        optimizer<span class="token punctuation">.</span>addEdge <span class="token punctuation">(</span> edge <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cout<span class="token operator">&lt;&lt;</span><span class="token string">"edges in graph: "</span><span class="token operator">&lt;&lt;</span>optimizer<span class="token punctuation">.</span><span class="token function">edges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
    optimizer<span class="token punctuation">.</span><span class="token function">initializeOptimization</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    optimizer<span class="token punctuation">.</span>optimize <span class="token punctuation">(</span> <span class="token number">30</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    Tcw <span class="token operator">=</span> pose<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">estimate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>参考</p> 
<ol><li>高翔《视觉SLAM十四讲：从理论到实践》及代码</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/57d06ae1a37bab99435dbde67e2bc8d8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">视觉SLAM十四讲 第八讲 视觉里程计2 8.5直接法 代码解析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c74c7d25d555fb1d8fbc0a75d1aa0f15/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">maven 分模块项目 主子pom之间的引入依赖关系</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>