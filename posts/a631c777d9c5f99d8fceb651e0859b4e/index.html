<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>搭建 Redis 哨兵模式（一主二从三哨兵） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="搭建 Redis 哨兵模式（一主二从三哨兵）" />
<meta property="og:description" content="因服务器资源限制，只是在一台服务器上操作的。Redis版本：redis-6.2.6
安装一个Redis应用，通过三份配置文件，启动三个Redis实例的方式来搭建哨兵模式（一主二从三哨兵）。
因我是在华为云上操作，需要开通以下6个端口：
● 7000（主节点），27000（哨兵通信）
● 8000（从节点），28000（哨兵通信）
● 9000（从节点），29000（哨兵通信）
1、将redis安装到指定路径下 cd /usr/local/soft/ mkdir redis-sentinel # 安装后，redis-sentinel目录下只有bin文件夹 make PREFIX=/usr/local/soft/redis-sentinel/ install 2、复制 redis.conf 与sentinel.conf 到不同的节点目录下 创建三个文件夹：7000（主节点）、8000（从节点）、9000（从节点）；分别在三个文件夹下放置 redis.conf 与 sentinel.conf 配置文件。
cd /usr/local/soft/redis-sentinel mkdir 7000 mkdir 8000 mkdir 9000 # 复制配置文件redis.conf cd /usr/local/soft/redis-6.2.6 cp redis.conf /usr/local/soft/redis-sentinel/7000/ cp redis.conf /usr/local/soft/redis-sentinel/8000/ cp redis.conf /usr/local/soft/redis-sentinel/9000/ # 复制配置文件sentinel.conf cp sentinel.conf /usr/local/soft/redis-sentinel/7000/ cp sentinel.conf /usr/local/soft/redis-sentinel/8000/ cp sentinel.conf /usr/local/soft/redis-sentinel/9000/ 3、修改 redis.conf 文件 3.1、修改基础配置（主从节点通用） 主要有以下几点：
修改监听 ip地址；修改端口；修改密码（主从节点的密码要一致）；日志文件位置 logfile；rdb持久化文件的保存路径；其他路径相关…。 bind 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a631c777d9c5f99d8fceb651e0859b4e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-19T22:50:24+08:00" />
<meta property="article:modified_time" content="2023-07-19T22:50:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">搭建 Redis 哨兵模式（一主二从三哨兵）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>因服务器资源限制，只是在一台服务器上操作的。Redis版本：redis-6.2.6<br> 安装一个Redis应用，通过三份配置文件，启动三个Redis实例的方式来搭建哨兵模式（一主二从三哨兵）。<br> 因我是在华为云上操作，需要开通以下6个端口：<br> ● 7000（主节点），27000（哨兵通信）<br> ● 8000（从节点），28000（哨兵通信）<br> ● 9000（从节点），29000（哨兵通信）</p> 
<h4><a id="1redis_6"></a>1、将redis安装到指定路径下</h4> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /usr/local/soft/

<span class="token function">mkdir</span> redis-sentinel

<span class="token comment"># 安装后，redis-sentinel目录下只有bin文件夹</span>
<span class="token function">make</span> <span class="token assign-left variable">PREFIX</span><span class="token operator">=</span>/usr/local/soft/redis-sentinel/ <span class="token function">install</span>
</code></pre> 
<h4><a id="2_redisconf_sentinelconf__15"></a>2、复制 redis.conf 与sentinel.conf 到不同的节点目录下</h4> 
<p>创建三个文件夹：7000（主节点）、8000（从节点）、9000（从节点）；分别在三个文件夹下放置 redis.conf 与 sentinel.conf 配置文件。</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">cd</span> /usr/local/soft/redis-sentinel

<span class="token function">mkdir</span> <span class="token number">7000</span>
<span class="token function">mkdir</span> <span class="token number">8000</span>
<span class="token function">mkdir</span> <span class="token number">9000</span>

<span class="token comment"># 复制配置文件redis.conf</span>
<span class="token builtin class-name">cd</span> /usr/local/soft/redis-6.2.6
<span class="token function">cp</span> redis.conf /usr/local/soft/redis-sentinel/7000/
<span class="token function">cp</span> redis.conf /usr/local/soft/redis-sentinel/8000/
<span class="token function">cp</span> redis.conf /usr/local/soft/redis-sentinel/9000/

<span class="token comment"># 复制配置文件sentinel.conf</span>
<span class="token function">cp</span> sentinel.conf /usr/local/soft/redis-sentinel/7000/
<span class="token function">cp</span> sentinel.conf /usr/local/soft/redis-sentinel/8000/
<span class="token function">cp</span> sentinel.conf /usr/local/soft/redis-sentinel/9000/
</code></pre> 
<h4><a id="3_redisconf__35"></a>3、修改 redis.conf 文件</h4> 
<h5><a id="31_36"></a>3.1、修改基础配置（主从节点通用）</h5> 
<p>主要有以下几点：</p> 
<ol><li>修改监听 ip地址；</li><li>修改端口；</li><li>修改密码（主从节点的密码要一致）；</li><li>日志文件位置 logfile；</li><li>rdb持久化文件的保存路径；</li><li>其他路径相关…。</li></ol> 
<pre><code class="prism language-bash"><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
protected-mode <span class="token function">yes</span>
port <span class="token number">7000</span>
<span class="token comment"># 密码</span>
requirepass abc123
<span class="token comment"># 后台启动，会写一个pid文件到pidfile指定的目录下</span>
daemonize <span class="token function">yes</span>
pidfile /usr/local/soft/redis-sentinel/7000/redis.pid
<span class="token comment"># 日志打印级别，默认notice。有四大级别：debug\verbose\notice\warning</span>
loglevel notice
<span class="token comment"># # 日志文件位置</span>
logfile <span class="token string">"/usr/local/soft/redis-sentinel/7000/redis.log"</span>

<span class="token comment">######### rdb持久化（快照）的配置项 #########</span>
<span class="token comment"># 快照持久化的触发条件</span>
<span class="token comment"># 必须 3600 秒内如果至少有 1 个 key 的值变化才保存</span>
save <span class="token number">3600</span> <span class="token number">1</span>
<span class="token comment"># 必须 300 秒内如果至少有 100 个 key 的值变化才保存</span>
save <span class="token number">300</span> <span class="token number">100</span>
<span class="token comment"># 必须 60 秒内如果至少有 10000 个 key 的值变化才保存</span>
save <span class="token number">60</span> <span class="token number">10000</span>
<span class="token comment"># 默认为yes，表示因磁盘满等原因导致快照保存出错时，会禁止redis写入操作，生产建议为no-不禁止写入</span>
stop-writes-on-bgsave-error no
<span class="token comment"># 持久化到rdb文件时，是否压缩，yes为压缩，no则不压缩，默认为yes</span>
rdbcompression <span class="token function">yes</span>
rdbchecksum <span class="token function">yes</span>
<span class="token comment"># rdb持久化的快照文件名</span>
dbfilename dump.rdb
rdb-del-sync-files no
<span class="token comment"># dbfilename快照文件的保存路径</span>
<span class="token function">dir</span> /usr/local/soft/redis-sentinel/7000/
</code></pre> 
<h5><a id="327000_77"></a>3.2、修改主节点-7000的配置</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 主节点的密码</span>
masterauth abc123
</code></pre> 
<h5><a id="3380009000_82"></a>3.3、修改从节点-8000与9000的配置</h5> 
<pre><code class="prism language-bash"><span class="token comment">######### 主从哨兵模式的配置项 #########</span>

<span class="token comment"># 主节点的ip与端口</span>
replicaof <span class="token number">121.37</span>.1.255 <span class="token number">7000</span>

<span class="token comment"># 主节点的密码</span>
masterauth abc123

<span class="token comment"># slave在主节点故障后被选举为新的主节点的优先级，数字越小表示优先级越高，默认为100。设置为 0 时，表示该slave节点永远不会被选择。</span>
replica-priority <span class="token number">100</span>
</code></pre> 
<h4><a id="4_sentinelconf__95"></a>4、修改 sentinel.conf 文件</h4> 
<p>主要有以下几点：</p> 
<ol><li>修改监听 ip地址；</li><li>修改sentinel的端口；</li><li>修改监听的主节点的名称、IP、端口；</li><li>修改连接主节点的密码；</li><li>修改sentinel密码（sentinel的密码都要一致）；</li><li>日志文件位置 logfile；</li><li>rdb持久化文件的保存路径；</li><li>其他路径相关…。</li></ol> 
<pre><code class="prism language-bash">
<span class="token comment"># 哨兵监听的的ip，可以配置 0.0.0.0 表示任意ip都可以访问；或者多个ip空格隔开，允许指定ip访问</span>
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0

<span class="token comment"># 保护模式，如果protected-mode是yes的话，如果没有指定bind或者没有指定密码，那么只能本地访问。</span>
protected-mode <span class="token function">yes</span>

<span class="token comment"># 哨兵实例运行的端口，默认26379</span>
port <span class="token number">27000</span>

<span class="token comment"># 是否后台运行，会生成一个pid文件，pidfile指定文件名</span>
daemonize <span class="token function">yes</span>

<span class="token comment"># 哨兵实例后台运行生成的pid文件名称</span>
pidfile /usr/local/soft/redis-sentinel/7000/redis-sentinel.pid

<span class="token comment"># 哨兵生成的log文件名称</span>
logfile <span class="token string">"/usr/local/soft/redis-sentinel/7000/redis-sentinel.log"</span>

<span class="token comment"># 哨兵sentinel的工作目录</span>
<span class="token function">dir</span> /usr/local/soft/redis-sentinel/7000/

<span class="token comment"># 哨兵sentinel监控的redis主节点的 名称 ip port 多少个sentinel统一认为主节点失联，那么这时客观上认为主节点失联了。</span>
sentinel monitor mymaster <span class="token number">121.37</span>.1.255 <span class="token number">7000</span> <span class="token number">2</span>

<span class="token comment"># 如果在Redis实例中设置了 requirepass 登录密码，哨兵连接主节点时需要配置</span>
sentinel auth-pass mymaster abc123

<span class="token comment"># 指定多少毫秒之后，主节点没有应答哨兵，哨兵主观上认为主节点下线，默认30秒</span>
sentinel down-after-milliseconds mymaster <span class="token number">30000</span>


<span class="token comment"># 哨兵的连接密码</span>
requirepass abc123

<span class="token comment"># sentinel sentinel-user &lt;username&gt;</span>
<span class="token comment"># 连接哨兵的密码，与requirepass一致</span>
sentinel sentinel-pass abc123

<span class="token comment"># 指定在发生failover主从切换时最多可以有多少个slave同时对新的master进行同步，这个数字越小，完成主从切换所需的时间就越长；</span>
<span class="token comment"># 但是如果这个数字越大，就意味着越多的slave因为同步操作而不可用。</span>
<span class="token comment"># 可以通过将这个值设为 1 来保证每次只有一个slave 处于不能处理命令请求的状态。保证了可用性。</span>
sentinel parallel-syncs mymaster <span class="token number">1</span>

<span class="token comment"># 故障转移的超时时间，默认180秒。</span>
sentinel failover-timeout mymaster <span class="token number">180000</span>
</code></pre> 
<h4><a id="5_153"></a>5、启动与关闭</h4> 
<h5><a id="51_154"></a>5.1、启动</h5> 
<p>创建启动全部 redis服务端的脚本：start-all-sentinel.sh，内容如下：</p> 
<pre><code class="prism language-bash">./bin/redis-server ./7000/redis.conf

./bin/redis-server ./8000/redis.conf

./bin/redis-server ./9000/redis.conf
</code></pre> 
<p>创建启动全部 sentinel 哨兵的脚本：start-all-server.sh，内容如下：</p> 
<pre><code class="prism language-bash">./bin/redis-sentinel ./7000/sentinel.conf <span class="token parameter variable">--sentinel</span>

./bin/redis-sentinel ./8000/sentinel.conf <span class="token parameter variable">--sentinel</span>

./bin/redis-sentinel ./9000/sentinel.conf <span class="token parameter variable">--sentinel</span>
</code></pre> 
<h4><a id="52_171"></a>5.2、关闭</h4> 
<p>创建关闭全部 redis服务端的脚本：stop-all-sentinel.sh，内容如下：</p> 
<pre><code class="prism language-bash">./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">7000</span> <span class="token parameter variable">-a</span> abc123 <span class="token function">shutdown</span>

./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">8000</span> <span class="token parameter variable">-a</span> abc123 <span class="token function">shutdown</span>

./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">9000</span> <span class="token parameter variable">-a</span> abc123 <span class="token function">shutdown</span>
</code></pre> 
<p>创建关闭全部 sentinel 哨兵的脚本：stop-all-server.sh，内容如下：</p> 
<pre><code class="prism language-bash">./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">27000</span> <span class="token parameter variable">-a</span> abc123 <span class="token function">shutdown</span>

./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">28000</span> <span class="token parameter variable">-a</span> abc123 <span class="token function">shutdown</span>

./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-p</span> <span class="token number">29000</span> <span class="token parameter variable">-a</span> abc123 <span class="token function">shutdown</span>
</code></pre> 
<h4><a id="6_188"></a>6、测试</h4> 
<h5><a id="61_189"></a>6.1、查看各节点服务端的信息</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 连接服务端后，使用info命令，或者 info replication，显示当前节点的角色role等。</span>
./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-a</span> abc123 <span class="token parameter variable">-p</span> <span class="token number">7000</span>
</code></pre> 
<p>连接服务端后，使用 info 命令，主节点显示如下：<br> <img src="https://images2.imgbox.com/b8/8e/oecIX4zO_o.png" alt="在这里插入图片描述"><br> 连接服务端后，使用 info replication 命令，主节点显示如下：<br> <img src="https://images2.imgbox.com/51/57/O2TW8GWC_o.png" alt="在这里插入图片描述"><br> 连接服务端后，使用 info replication 命令，从节点显示如下：<img src="https://images2.imgbox.com/cb/65/RdikfrZE_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="62_199"></a>6.2、查看各哨兵的信息</h5> 
<pre><code class="prism language-bash"><span class="token comment"># 连接哨兵后，使用 Info Sentinel 命令，显示当前节点的角色role等。</span>
./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-a</span> abc123 <span class="token parameter variable">-p</span> <span class="token number">27000</span>
</code></pre> 
<p>连接哨兵后，使用 Info Sentinel 命令，显示如下：<br> <img src="https://images2.imgbox.com/11/a4/pU0m1GMo_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="7_206"></a>7、模拟故障转移</h4> 
<p>Redis Sentinel存在多个从节点时，如果想将指定的从节点晋升为主节点，可以将其他从节点的slavepriority配置为0，但是需要注意failover后，将slave-priority调回原值。</p> 
<pre><code class="prism language-bash">./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-a</span> abc123 <span class="token parameter variable">-p</span> <span class="token number">7000</span>
<span class="token comment"># 连接服务端后，查询当前节点的优先级，默认是100</span>
CONFIG GET slave-priority
<span class="token comment"># 连接服务端后，可以设置当前节点的优先级（数值越小，成为主节点的优势更强），0表示永远不竞争主节点</span>
CONFIG SET slave-priority <span class="token number">60</span>

./bin/redis-cli <span class="token parameter variable">-h</span> <span class="token number">127.0</span>.0.1 <span class="token parameter variable">-a</span> abc123 <span class="token parameter variable">-p</span> <span class="token number">27000</span>
<span class="token comment"># 连接哨兵后，可以主动切换主节点</span>
sentinel failover mymaster
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d17c9141c269a2a4a60f949df8fc4f49/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">记账小程序源码，可做毕设或期末作业</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7542309d15b848f2663204ed67bce3c7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker部署nacos2.2.0&#43;数据持久化配置&#43;效果实测图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>