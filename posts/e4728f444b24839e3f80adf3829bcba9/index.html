<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>postgresql - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="postgresql" />
<meta property="og:description" content="pg中提取字符串中字段 SELECT (regexp_matches(&#39;{&#34;newValue&#34;:&#34;字数为15个字的用例自定义状态&#34;,&#34;oldKey&#34;:&#34;0&#34;,&#34;fieldName&#34;:&#34;statusName&#34;,&#34;newKey&#34;:&#34;118&#34;,&#34;oldValue&#34;:&#34;新建&#34;}&#39;, &#39;&#34;oldKey&#34;:&#34;([^&#34;]*)&#34;&#39;))[1] AS old_key, (regexp_matches(&#39;{&#34;newValue&#34;:&#34;字数为15个字的用例自定义状态&#34;,&#34;oldKey&#34;:&#34;0&#34;,&#34;fieldName&#34;:&#34;statusName&#34;,&#34;newKey&#34;:&#34;118&#34;,&#34;oldValue&#34;:&#34;新建&#34;}&#39;, &#39;&#34;fieldName&#34;:&#34;([^&#34;]*)&#34;&#39;))[1] AS field_name, (regexp_matches(&#39;{&#34;newValue&#34;:&#34;字数为15个字的用例自定义状态&#34;,&#34;oldKey&#34;:&#34;0&#34;,&#34;fieldName&#34;:&#34;statusName&#34;,&#34;newKey&#34;:&#34;118&#34;,&#34;oldValue&#34;:&#34;新建&#34;}&#39;, &#39;&#34;oldValue&#34;:&#34;([^&#34;]*)&#34;&#39;))[1] AS old_value, (regexp_matches(&#39;{&#34;newValue&#34;:&#34;字数为15个字的用例自定义状态&#34;,&#34;oldKey&#34;:&#34;0&#34;,&#34;fieldName&#34;:&#34;statusName&#34;,&#34;newKey&#34;:&#34;118&#34;,&#34;oldValue&#34;:&#34;新建&#34;}&#39;, &#39;&#34;newKey&#34;:&#34;([^&#34;]*)&#34;&#39;))[1] AS newKey, (regexp_matches(&#39;{&#34;newValue&#34;:&#34;字数为15个字的用例自定义状态&#34;,&#34;oldKey&#34;:&#34;0&#34;,&#34;fieldName&#34;:&#34;statusName&#34;,&#34;newKey&#34;:&#34;118&#34;,&#34;oldValue&#34;:&#34;新建&#34;}&#39;, &#39;&#34;newValue&#34;:&#34;([^&#34;]*)&#34;&#39;))[1] AS newValue 查看进程 SELECT * FROM pg_stat_activity WHERE state = &#39;active&#39; ; 一行转一列，类似侧视图功能 select regexp_split_to_table( &#39;6992560,6992506,6992505,6992504,6992503,6992502,6992469,6992501,6992468,6992500,6992467,6992466,6992465,6992464,6992463,6992462,6992461,6992509,6992508,6992507,6992517,6992516,6992515,6992119,6992514,6992118,6992513,6992117,6992512,6992116,6992479,6992511,6992115,6992478,6992510,6992114,6992477,6992113,6992476,6992112,6992475,6992111,6992474,6992473,6992472,6992471,6992470,6992519,6992518,6992528,6992527,6992526,6992525,6992129,6992524,6992128,6992523,6992127,6992489,6992522,6992126,6992488,6992521,6992125,6992487,6992520,6992124,6992486,6992123,6992122,6992485,6992121,6992484,6992120,6992483,6992482,6992481,6992480,6992490,6992529,6992539,6992538,6992537,6992536,6992535,6992534,6992533,6992499,6992532,6992498,6992531,6992135,6992497,6992530,6992134,6992496,6992133,6992495,6992132,6992494,6992131,6992493,6992130,6992492,6992491,6992549,6992548,6992547,6992546,6992545,6992544,6992543,6992542,6992541,6992540,6992559,6992558,6992557,6992556,6992555,6992554,6992553,6992552,6992551,6992550&#39; , &#39;,&#39;) 一列转一行,需要分组(组内 一列转一行),不分组就是整列数据 类似hive中 select id,concat_ws(&#39;,&#39;,collect_list(name)) names from ts group by id; pg
WITH temp_table(id, num, name) AS ( VALUES (1, &#39;zs&#39;, &#39;合肥&#39;), (1, &#39;ls&#39;, &#39;南京&#39;), (1, &#39;ww&#39;, &#39;杭州&#39;), (1, &#39;zl&#39;, &#39;重庆&#39;), (1, &#39;sq&#39;, &#39;郑州&#39;), (2, &#39;wb&#39;, &#39;六安&#39;), (2, &#39;lq&#39;, &#39;青岛&#39;), (3, &#39;dd&#39;, &#39;三亚&#39;), (3, &#39;si&#39;, &#39;常州&#39;), (3, &#39;sh&#39;, &#39;武汉&#39;) ) SELECT id,string_agg(name,&#39;,&#39;) FROM temp_table group by id; filter函数 select count(*) filter ( where date &gt;= to_date(&#39;2019-01-01&#39;,&#39;yyyy-MM-dd&#39;) and date &lt; to_date(&#39;2020-01-01&#39;,&#39;yyyy-MM-dd&#39;) ) ,count(*) filter (where date &gt;= to_date(&#39;2020-01-01&#39;,&#39;yyyy-MM-dd&#39;) and date &lt; to_date(&#39;2021-01-01&#39;,&#39;yyyy-MM-dd&#39;) ) ,count(*) filter (where date &gt;= to_date(&#39;2021-01-01&#39;,&#39;yyyy-MM-dd&#39;) ) from modeltest." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e4728f444b24839e3f80adf3829bcba9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-02T15:05:15+08:00" />
<meta property="article:modified_time" content="2023-11-02T15:05:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">postgresql</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="pg_0"></a>pg中提取字符串中字段</h2> 
<pre><code>SELECT
    (regexp_matches('{"newValue":"字数为15个字的用例自定义状态","oldKey":"0","fieldName":"statusName","newKey":"118","oldValue":"新建"}', '"oldKey":"([^"]*)"'))[1] AS old_key,
    (regexp_matches('{"newValue":"字数为15个字的用例自定义状态","oldKey":"0","fieldName":"statusName","newKey":"118","oldValue":"新建"}', '"fieldName":"([^"]*)"'))[1] AS field_name,
    (regexp_matches('{"newValue":"字数为15个字的用例自定义状态","oldKey":"0","fieldName":"statusName","newKey":"118","oldValue":"新建"}', '"oldValue":"([^"]*)"'))[1] AS old_value,
    (regexp_matches('{"newValue":"字数为15个字的用例自定义状态","oldKey":"0","fieldName":"statusName","newKey":"118","oldValue":"新建"}', '"newKey":"([^"]*)"'))[1] AS newKey,
    (regexp_matches('{"newValue":"字数为15个字的用例自定义状态","oldKey":"0","fieldName":"statusName","newKey":"118","oldValue":"新建"}', '"newValue":"([^"]*)"'))[1] AS newValue

</code></pre> 
<p><img src="https://images2.imgbox.com/a6/44/AEEYiAHE_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_15"></a>查看进程</h2> 
<pre><code>SELECT *
FROM pg_stat_activity
WHERE state = 'active'
;
</code></pre> 
<h2><a id="_24"></a>一行转一列，类似侧视图功能</h2> 
<pre><code>select
            regexp_split_to_table(
               '6992560,6992506,6992505,6992504,6992503,6992502,6992469,6992501,6992468,6992500,6992467,6992466,6992465,6992464,6992463,6992462,6992461,6992509,6992508,6992507,6992517,6992516,6992515,6992119,6992514,6992118,6992513,6992117,6992512,6992116,6992479,6992511,6992115,6992478,6992510,6992114,6992477,6992113,6992476,6992112,6992475,6992111,6992474,6992473,6992472,6992471,6992470,6992519,6992518,6992528,6992527,6992526,6992525,6992129,6992524,6992128,6992523,6992127,6992489,6992522,6992126,6992488,6992521,6992125,6992487,6992520,6992124,6992486,6992123,6992122,6992485,6992121,6992484,6992120,6992483,6992482,6992481,6992480,6992490,6992529,6992539,6992538,6992537,6992536,6992535,6992534,6992533,6992499,6992532,6992498,6992531,6992135,6992497,6992530,6992134,6992496,6992133,6992495,6992132,6992494,6992131,6992493,6992130,6992492,6992491,6992549,6992548,6992547,6992546,6992545,6992544,6992543,6992542,6992541,6992540,6992559,6992558,6992557,6992556,6992555,6992554,6992553,6992552,6992551,6992550'
                , ',')
</code></pre> 
<p><img src="https://images2.imgbox.com/43/26/xeJOwGf2_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="__34"></a>一列转一行,需要分组(组内 一列转一行),不分组就是整列数据</h2> 
<pre><code>类似hive中
select id,concat_ws(',',collect_list(name)) names from ts group by id;
</code></pre> 
<p>pg</p> 
<pre><code>WITH temp_table(id, num, name) AS (
  VALUES
    (1, 'zs', '合肥'),
    (1, 'ls', '南京'),
    (1, 'ww', '杭州'),
    (1, 'zl', '重庆'),
    (1, 'sq', '郑州'),
    (2, 'wb', '六安'),
    (2, 'lq', '青岛'),
    (3, 'dd', '三亚'),
    (3, 'si', '常州'),
    (3, 'sh', '武汉')
)
SELECT id,string_agg(name,',')
FROM temp_table
group by id;
</code></pre> 
<p><img src="https://images2.imgbox.com/11/e3/hR0q83Yu_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="filter_60"></a>filter函数</h2> 
<pre><code>select
count(*) filter ( where date &gt;= to_date('2019-01-01','yyyy-MM-dd') and date &lt; to_date('2020-01-01','yyyy-MM-dd') )
,count(*) filter (where date &gt;= to_date('2020-01-01','yyyy-MM-dd') and date &lt; to_date('2021-01-01','yyyy-MM-dd') )
,count(*) filter (where date &gt;= to_date('2021-01-01','yyyy-MM-dd') )
from modeltest.order_info;

--同样效果
select
count(case when date &gt;= to_date('2019-01-01','yyyy-MM-dd') and date &lt; to_date('2020-01-01','yyyy-MM-dd') then 1 else null end)
,count(case when date &gt;= to_date('2020-01-01','yyyy-MM-dd') and date &lt; to_date('2021-01-01','yyyy-MM-dd') then 1 else null end)
,count(case when date &gt;= to_date('2021-01-01','yyyy-MM-dd') then 1 else null end)
from modeltest.order_info;
</code></pre> 
<h2><a id="row_to_json_77"></a>row_to_json</h2> 
<p><img src="https://images2.imgbox.com/89/76/Lm693yGM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/25/4e/bOGQadXJ_o.png" alt="在这里插入图片描述"><br> 将查询结果 temp_table 使用 row_to_json 函数转换为 JSON 格式的行对象，然后使用 array_agg 函数将 同组(group by)内的所有行对象聚合为一个数组，最后使用 array_to_json 函数将数组转换为 JSON 格式的数据<br> <img src="https://images2.imgbox.com/4c/4a/PM62LZHY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9a/fc/dXC6TGsS_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/294d3f822f40289ae427250d52a05763/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Rocky9 上安装 redis-dump 和redis-load 命令</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f488981326f841cfb53fd926bbf10ed/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">elementui el-upload 上传文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>