<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sift特征匹配以及ransac消除误差解析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Sift特征匹配以及ransac消除误差解析" />
<meta property="og:description" content="前言 本文不光展示SIFT算法的匹配效果，更重要的是记录下搜集信息以及处理信息的过程，方便以后按照这个行动思路去解决问题，以及优化行动思路
第一部分：了解到SIFT算法的存在 其实早在学习双目视觉的时候就了解过 特征匹配 算法，其中就使用过SIFT算法，以及众多SIFT算法的变种，这时只是知道名字，最近因为课题需要使用，所以开展从原理到实践的研究，首先了解一个算法，首先要直观的看到他的运行结果，不管是自己跑的还是别人跑的，第一个数据来源是opencv-python的中文文档
单张图片特征查找效果如下：
两张图片匹配效果如下：
看到这里就激起了我的兴趣，接下来就进行第二步
第二部分 学习算法原理 首先去找的是视频资源，当然是先去B站康康，没想到真的有！
视频详解
看完这些之后大概了解了SIFT的流程以及部分数学知识，但是具体的细节还需要文字资料配合食用：
SIFT的宏观描述（大体流程）
SIFT的微观描述（数学细节）
此时再回去看带你入门的视频，会发现首尾呼应，有些不懂的地方也明白了，但是这是一个不断反复多次理解的过程，没有人能一天把别人长时间的研究成果搞懂，所以不会以及困惑很正常，不要灰心，多找资料，反复看几遍就会懂了。
第三部分 算法实践 到这里相信你已经明白了SIFT是什么原理，匹配出来的效果大概是什么样的，所以你也想做出和示例中一样的效果，甚至做得更好，或者你想用SIFT帮助你的科研项目，这些都没有问题，以下是我的代码学习历程以及成果。 在最初阶段，我只想让代码运行起来，因为SIFT算法是受专利保护的，所以在opencv3.4之后被放到了一个单独的收费库里，只能自己在本地机器编译后才能运行，
windows编译方法1
windows编译方法2
当然这个过程会费时大概一天，只有真正的强者才能完成编译这个过程，你会遇上非常多的莫名其妙的问题，需要你自己一个一个去解决，但是只要肯用功，总会解决的
我在这补充一个编译之后在本地python使用的方法，网上没找到，是自己研究出来的，当你完成编译后会有下图这样的文件夹
找到其中的python_loader,然后打开anaconda prompt，如果你没有anaconda，那么你就打开cmd，并保证输入python后出现python的交互界面（把python放到环境变量的path里）接下来操作如下
1.首先卸载你的 opencv-python
pip uninstall opencv-python pip uninstall opencv-contrib-python 2.定位到你的setu.py的目录
切换目录方法
3.然后分别输入
python setup.py build python setup.py install 下面就是代码实践，我首先尝试了官网教程给出的算法例子
import numpy as np import cv2 as cv img = cv.imread(&#39;home.jpg&#39;) gray= cv.cvtColor(img,cv.COLOR_BGR2GRAY) &#39;&#39;&#39; 下面是创建sift，以及使用sift进行计算的方法 &#39;&#39;&#39; sift = cv.xfeatures2d.SIFT_create() kp = sift.detect(gray,None) &#39;&#39;&#39; 下面是绘图部分 &#39;&#39;&#39; img=cv." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/67dd1cc0fd94ad4b18ee11138b7cfafb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-05T23:56:53+08:00" />
<meta property="article:modified_time" content="2020-05-05T23:56:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Sift特征匹配以及ransac消除误差解析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>本文不光展示SIFT算法的匹配效果，更重要的是记录下搜集信息以及处理信息的过程，方便以后按照这个行动思路去解决问题，以及优化行动思路</p> 
<h3><a id="SIFT_3"></a>第一部分：了解到SIFT算法的存在</h3> 
<p>其实早在学习双目视觉的时候就了解过 特征匹配 算法，其中就使用过SIFT算法，以及众多SIFT算法的变种，这时只是知道名字，最近因为课题需要使用，所以开展从原理到实践的研究，首先了解一个算法，首先要直观的看到他的运行结果，不管是自己跑的还是别人跑的，第一个数据来源是<a href="http://www.woshicver.com/Sixth/5_9_%E7%89%B9%E5%BE%81%E5%8C%B9%E9%85%8D/" rel="nofollow">opencv-python的中文文档</a><br> 单张图片特征查找效果如下：<br> <img src="https://images2.imgbox.com/6f/ec/9lneoWlV_o.png" alt="在这里插入图片描述"><br> 两张图片匹配效果如下：<br> <img src="https://images2.imgbox.com/f3/04/Q3c0tGLg_o.png" alt="在这里插入图片描述"></p> 
<p>看到这里就激起了我的兴趣，接下来就进行第二步</p> 
<h3><a id="__15"></a>第二部分 学习算法原理</h3> 
<p>首先去找的是视频资源，当然是先去B站康康，没想到真的有！<br> <a href="https://www.bilibili.com/video/BV1Qb411W7cK?from=search&amp;seid=2232623930545040609" rel="nofollow">视频详解</a><br> 看完这些之后大概了解了SIFT的流程以及部分数学知识，但是具体的细节还需要文字资料配合食用：<br> <a href="https://cloud.tencent.com/developer/article/1419617" rel="nofollow">SIFT的宏观描述（大体流程）</a><br> <a href="https://blog.csdn.net/zddblog/article/details/7521424?utm_medium=distribute.pc_relevant_right.none-task-blog-BlogCommendFromBaidu-1&amp;depth_1-utm_source=distribute.pc_relevant_right.none-task-blog-BlogCommendFromBaidu-1">SIFT的微观描述（数学细节）</a><br> 此时再回去看带你入门的视频，会发现首尾呼应，有些不懂的地方也明白了，但是这是一个不断反复多次理解的过程，没有人能一天把别人长时间的研究成果搞懂，所以不会以及困惑很正常，不要灰心，多找资料，反复看几遍就会懂了。</p> 
<h3><a id="__23"></a>第三部分 算法实践</h3> 
<pre><code>到这里相信你已经明白了SIFT是什么原理，匹配出来的效果大概是什么样的，所以你也想做出和示例中一样的效果，甚至做得更好，或者你想用SIFT帮助你的科研项目，这些都没有问题，以下是我的代码学习历程以及成果。
</code></pre> 
<p>在最初阶段，我只想让代码运行起来，因为SIFT算法是受专利保护的，所以在opencv3.4之后被放到了一个单独的收费库里，只能自己在本地机器编译后才能运行，<br> <a href="https://blog.csdn.net/m0_37772174/article/details/104452744">windows编译方法1</a><br> <a href="https://blog.csdn.net/weixin_41943311/article/details/91866987">windows编译方法2</a><br> 当然这个过程会费时大概一天，只有真正的强者才能完成编译这个过程，你会遇上非常多的莫名其妙的问题，需要你自己一个一个去解决，但是只要肯用功，总会解决的<br> 我在这补充一个编译之后在本地python使用的方法，网上没找到，是自己研究出来的，当你完成编译后会有下图这样的文件夹<img src="https://images2.imgbox.com/53/d4/KSA9jYKG_o.png" alt="在这里插入图片描述"></p> 
<p>找到其中的python_loader,然后打开anaconda prompt，如果你没有anaconda，那么你就打开cmd，并保证输入python后出现python的交互界面（把python放到环境变量的path里）接下来操作如下<img src="https://images2.imgbox.com/a0/39/ECrgX9ms_o.png" alt="在这里插入图片描述"><br> 1.首先卸载你的 opencv-python</p> 
<pre><code>pip uninstall opencv-python
pip uninstall opencv-contrib-python
</code></pre> 
<p>2.定位到你的setu.py的目录</p> 
<p><a href="https://jingyan.baidu.com/article/5552ef473e2df6518ffbc916.html" rel="nofollow">切换目录方法</a></p> 
<p>3.然后分别输入</p> 
<pre><code>python setup.py build
python setup.py install
</code></pre> 
<p>下面就是代码实践，我首先尝试了官网教程给出的算法例子</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2 <span class="token keyword">as</span> cv
img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'home.jpg'</span><span class="token punctuation">)</span>
gray<span class="token operator">=</span> cv<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
下面是创建sift，以及使用sift进行计算的方法
'''</span>
sift <span class="token operator">=</span> cv<span class="token punctuation">.</span>xfeatures2d<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token punctuation">)</span>
kp <span class="token operator">=</span> sift<span class="token punctuation">.</span>detect<span class="token punctuation">(</span>gray<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
下面是绘图部分
'''</span>
img<span class="token operator">=</span>cv<span class="token punctuation">.</span>drawKeypoints<span class="token punctuation">(</span>gray<span class="token punctuation">,</span>kp<span class="token punctuation">,</span>img<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'sift-gray-ver1'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f8/10/rywkjHmd_o.png" alt="在这里插入图片描述"><br> 官网给出的版本特征点画得非常小，没有尺度和方向的描述，并且是个黑白的，影响视觉体验。经过一番资料的查询，找到了如何画彩色和清晰特征点的方法。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> cv2 <span class="token keyword">as</span> cv
img <span class="token operator">=</span> cv<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'home.jpg'</span><span class="token punctuation">)</span><span class="token number">73</span>
<span class="token triple-quoted-string string">'''
下面是创建sift，以及使用sift进行计算的方法
'''</span>
sift <span class="token operator">=</span> cv2<span class="token punctuation">.</span>xfeatures2d<span class="token punctuation">.</span>SIFT_create<span class="token punctuation">(</span><span class="token punctuation">)</span>
kp<span class="token punctuation">,</span>des <span class="token operator">=</span> sift<span class="token punctuation">.</span>detectAndCompute<span class="token punctuation">(</span>img1<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">)</span>

<span class="token triple-quoted-string string">'''
下面是绘图部分
'''</span>
img <span class="token operator">=</span> cv<span class="token punctuation">.</span>drawKeypoints<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>kp<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'sift-rgb-ver2'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/55/5b/Kkbkx8iY_o.png" alt="在这里插入图片描述"><br> 这下就看的很清楚了，那么除了SIFT对单个图像的特征挖掘，还要进行两个图片的特征连接，先上代码</p> 
<pre><code class="prism language-python"><span class="token triple-quoted-string string">'''
构造函数
'''</span>
<span class="token keyword">def</span> <span class="token function">my_match</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>des1<span class="token punctuation">,</span>des2<span class="token punctuation">,</span>mc_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    bf <span class="token operator">=</span> cv<span class="token punctuation">.</span>BFMatcher<span class="token punctuation">(</span><span class="token punctuation">)</span>
    matches <span class="token operator">=</span> bf<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>des1<span class="token punctuation">,</span>des2<span class="token punctuation">,</span>k<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">#此处的2就是每个匹配装两个对应的点位</span>
    good <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">#不难发现，m,n就是对应刚才的2</span>
    <span class="token keyword">for</span> m<span class="token punctuation">,</span>n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
        <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.70</span><span class="token operator">*</span>n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---end---'</span><span class="token punctuation">)</span>
            <span class="token comment"># print(n.imgIdx)</span>
            good<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span>
    img3 <span class="token operator">=</span> cv<span class="token punctuation">.</span>drawMatchesKnn<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>good<span class="token punctuation">,</span><span class="token boolean">None</span><span class="token punctuation">,</span>flags<span class="token operator">=</span>mc_type<span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'match'</span><span class="token punctuation">,</span>img3<span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token triple-quoted-string string">'''
调用函数
'''</span>
my_match<span class="token punctuation">(</span>img1<span class="token punctuation">,</span>
img2<span class="token punctuation">,</span>sift_kp_1<span class="token punctuation">,</span>sift_kp_2<span class="token punctuation">,</span>sift_des_1<span class="token punctuation">,</span>sift_des_2<span class="token punctuation">,</span>
cv<span class="token punctuation">.</span>DrawMatchesFlags_NOT_DRAW_SINGLE_POINTS<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/56/53/xeEAwSwh_o.png" alt="在这里插入图片描述"><br> 这个学生证是我朋友和我出去玩落在我车上的，正好在手边就拿来拍照了，可以看到匹配的效果不错，大部分博客也是到此为止了，但是我发现有些点依然对应的不是很好，所以下一部分是模型内的参数调优以及算法优化。</p> 
<h3><a id="_Ransac_127"></a>第四部分 模型内的参数调优以及Ransac优化匹配</h3> 
<p>首先是加入Ransac算法部分，Ransac算法接收的是由SIFT特征经过BF匹配后生成的 [左图特征点] 和[右图特征点] ， 然后对这些匹配后的特征点进行选择，删掉误匹配点，只取正确匹配点，实际代码如下。</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">my_match</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span>img2<span class="token punctuation">,</span>kp1<span class="token punctuation">,</span>kp2<span class="token punctuation">,</span>des1<span class="token punctuation">,</span>des2<span class="token punctuation">,</span>mc_type<span class="token punctuation">)</span><span class="token punctuation">:</span>
    FLANN_INDEX_KDTREE <span class="token operator">=</span> <span class="token number">0</span>
    index_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>algorithm <span class="token operator">=</span> FLANN_INDEX_KDTREE<span class="token punctuation">,</span> trees <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">)</span>
    search_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>checks <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">)</span>
    flann <span class="token operator">=</span> cv2<span class="token punctuation">.</span>FlannBasedMatcher<span class="token punctuation">(</span>index_params<span class="token punctuation">,</span>search_params<span class="token punctuation">)</span>
    matches <span class="token operator">=</span> flann<span class="token punctuation">.</span>knnMatch<span class="token punctuation">(</span>des1<span class="token punctuation">,</span> des2<span class="token punctuation">,</span> k <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    good <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token comment">#不难发现，m,n就是对应刚才的2</span>
    <span class="token keyword">for</span> m<span class="token punctuation">,</span>n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
        <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.95</span> <span class="token operator">*</span>n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>queryIdx<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---end---'</span><span class="token punctuation">)</span>
            <span class="token comment"># print(n.imgIdx)</span>
            good<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>good<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        src_pts <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>sift_kp_1<span class="token punctuation">[</span>i<span class="token punctuation">.</span>queryIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt <span class="token keyword">for</span> i <span class="token keyword">in</span> good<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#.\reshape(-1, 1, 2)</span>
        dst_pts <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span>sift_kp_2<span class="token punctuation">[</span>i<span class="token punctuation">.</span>trainIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>pt <span class="token keyword">for</span> i <span class="token keyword">in</span> good<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#.reshape(-1, 1, 2)</span>
        <span class="token comment"># print(src_pts.shape)</span>
        <span class="token comment"># print(dst_pts.shape)</span>
        ransacReprojThreshold <span class="token operator">=</span> <span class="token number">10.0</span>
        M<span class="token punctuation">,</span> mask <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findHomography<span class="token punctuation">(</span>src_pts<span class="token punctuation">,</span> dst_pts<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RANSAC<span class="token punctuation">,</span> ransacReprojThreshold<span class="token punctuation">)</span>
        matchesMask <span class="token operator">=</span> mask<span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span>
        h<span class="token punctuation">,</span> w<span class="token punctuation">,</span> mode <span class="token operator">=</span> img1<span class="token punctuation">.</span>shape
        pts <span class="token operator">=</span> np<span class="token punctuation">.</span>float32<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> h <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> h <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>w <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token comment">#透视变换函数cv2.perspectiveTransform: 输入的参数是两种数组，并返回dst矩阵——扭转矩阵</span>
        dst <span class="token operator">=</span> cv2<span class="token punctuation">.</span>perspectiveTransform<span class="token punctuation">(</span>pts<span class="token punctuation">,</span> M<span class="token punctuation">)</span>
        
        img2 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>polylines<span class="token punctuation">(</span>img2<span class="token punctuation">,</span> <span class="token punctuation">[</span>np<span class="token punctuation">.</span>int32<span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">127</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>LINE_AA<span class="token punctuation">)</span>
    draw_params <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>singlePointColor <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
                   matchesMask <span class="token operator">=</span> mask<span class="token punctuation">,</span>
                   flags <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dst_pts<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dst_pts<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"ro"</span><span class="token punctuation">)</span>
    dots<span class="token operator">=</span>dst_pts<span class="token punctuation">[</span>mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dots<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dots<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"bo"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>src_pts<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>src_pts<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"go"</span><span class="token punctuation">)</span>
    dots<span class="token operator">=</span>src_pts<span class="token punctuation">[</span>mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>dots<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>dots<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">"bo"</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># print(dst_pts[mask,0])</span>
    
    img3 <span class="token operator">=</span> cv2<span class="token punctuation">.</span>drawMatches<span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> kp2<span class="token punctuation">,</span> good<span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">,</span> <span class="token operator">**</span>draw_params<span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'match'</span><span class="token punctuation">,</span>img3<span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">10000000</span><span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>
    cv<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a2/23/7wTzRxvl_o.png" alt="在这里插入图片描述"></p> 
<p>上图是图一，描述了在左图所有的特征点中，rasac选择的正确匹配特征点<br> <img src="https://images2.imgbox.com/25/c9/LGCo9vfl_o.png" alt="在这里插入图片描述"><br> 上图是图二，描述了在右图所有的特征点中，ransac选择的正确匹配特征点<br> <img src="https://images2.imgbox.com/cf/c3/0GBO7fDo_o.png" alt="在这里插入图片描述"><br> 上图是图三，最终生成的结果</p> 
<p>在最后的代码中，知识点主要有以下几个</p> 
<ol><li>这种写法是输出dst_pts中mask中值为一的位置，算是一种一维数据掩膜方法</li></ol> 
<pre><code class="prism language-python">dots<span class="token operator">=</span>dst_pts<span class="token punctuation">[</span>mask<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> 
<ol start="2"><li>match中有两组对应的匹配点，在下图中分别是m和n，代码的含义是如果m匹配对的误差低于n匹配对的误差，就把m加入优秀匹配对的列表中，也就是good</li></ol> 
<pre><code class="prism language-python">    <span class="token keyword">for</span> m<span class="token punctuation">,</span>n <span class="token keyword">in</span> matches<span class="token punctuation">:</span>
        <span class="token keyword">if</span> m<span class="token punctuation">.</span>distance <span class="token operator">&lt;</span> <span class="token number">0.95</span> <span class="token operator">*</span>n<span class="token punctuation">.</span>distance<span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>distance<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>m<span class="token punctuation">.</span>queryIdx<span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'---end---'</span><span class="token punctuation">)</span>
            <span class="token comment"># print(n.imgIdx)</span>
            good<span class="token punctuation">.</span>append<span class="token punctuation">(</span>m<span class="token punctuation">)</span>
</code></pre> 
<ol start="3"><li>ransac实际上接受的是两组二维数据点，然后计算出其中符合要求的数据点，所以这个函数的应用范围其实更广，或者说，有其他的方法可以应用在这里，然后会有更好的效果，或许下一个博客试一试用SVM或者深度学习，最近几天会制作出来的，如果大家有问题欢迎留言。</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6efa84e9f2058ad7cfd5da320b3ec800/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用JDK发布和调用webservice服务</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ac7a671072b6b370d25ed6b71484613a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Git Your branch is ahead of &#39;origin/master&#39; by 1 2 3 4 commits解决方法 Git冲突解决</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>