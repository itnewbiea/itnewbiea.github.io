<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MongoDB】日志文件过大/logRotate解决日志轮转的方案 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MongoDB】日志文件过大/logRotate解决日志轮转的方案" />
<meta property="og:description" content="由于mongodb不提供自动按天来输出日志文件的rotate配置。
如果日志文件清理不及时，会导致mongo越来越慢，甚至服务莫名down掉。
下面就我们在实践过程中使用logRotate的解决日志文件切割的方案叙述一下。
首先看一下官方文档对于logRotate的叙述：
一、定义（Definition） logRotate logRotate命令是一个管理命令，它可以轮转MongoDB日志，以防止单个日志文件占用过多的磁盘空间。
必须对admin database发出logRotate命令，方式如下：
{ logRotate: 1 } 注意：您的mongod实例需要使用--logpath [file]选项运行。
也可以通过将SIGUSR1信号发送到mongod进程来轮转日志。比如mongod的进程ID为2200，则在Linux上发送信号的方法如下：
kill -SIGUSR1 2200 二、行为（Behavior） systemLog.logRotate设置或--logRotate选项规定了logRotate的行为。
当systemLog.logRotate或--logRotate设置为rename时，logRotate通过将当前时间戳附加到文件名来重命名现有日志文件。附加的时间戳格式如下：
&lt;YYYY&gt;-&lt;mm&gt;-&lt;DD&gt; T &lt;HH&gt;-&lt;MM&gt;-&lt;SS&gt; 然后，logRotate创建一个新的日志文件，新文件名与最初由mongod或mongos的systemLog.path设置规定的日志文件名相同。
将systemLog.logRotate或--logRotate设置为reopen时，logRotate遵循典型的Linux / Unix行为，仅关闭日志文件，然后重新打开同名的日志文件。通过reopen，mongod期望在轮转之前，另一个进程会重命名该文件，并且创建新文件实现重新打开会。
原文链接：https://docs.mongodb.com/manual/reference/command/logRotate/
三、实践篇 1.打开mongo shell（由于在mongod实例的本地打开此命令，故--ip省略）。 D:\MongoDB\Server\3.4\bin&gt;mongo --port 你的端口 2.切换到admin数据库。 use admin 3.授权。 db.auth(&#34;你的管理账号&#34;, &#34;你的密码&#34;) 4.执行logRotate命令。 db.adminCommand({logRotate:1}) 1-4步执行过程如下图所示：
5.执行结果 四、制定计划任务，每天自动轮转 1.制定计划任务 在操作系统的“任务计划程序”中添加计划任务，填写时间、操作等信息，内容如下：
2.编写bat脚本 编写日志轮转的bat执行脚本文件，新建一个后缀名是.bat文件内容如下：
@call :output&gt;logRotate.log exit :output @ECHO OFF echo %date:~0,4%-%date:~5,2%-%date:~8,2% %time% log rotate begin...... D:\MongoDB\Server\3.4\bin\mongo --host 你的ip --port 你的端口 -u 你的管理账号 -p 你的密码 --authenticationDatabase admin --eval &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c1fe4be8cb0f15e94ff085158cd91169/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-27T08:34:54+08:00" />
<meta property="article:modified_time" content="2020-04-27T08:34:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MongoDB】日志文件过大/logRotate解决日志轮转的方案</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>由于mongodb不提供自动按天来输出日志文件的rotate配置。</p> 
<p>如果日志文件清理不及时，会导致mongo越来越慢，甚至服务莫名down掉。</p> 
<p>下面就我们在实践过程中使用logRotate的解决日志文件切割的方案叙述一下。</p> 
<p>首先看一下官方文档对于logRotate的叙述：</p> 
<p> </p> 
<h2><strong><strong><strong>一、</strong></strong><strong><strong>定义</strong></strong><strong><strong>（Definition）</strong></strong></strong></h2> 
<h3><strong><strong><strong>logRotate</strong></strong></strong></h3> 
<p style="margin-left:0pt;">logRotate命令是一个管理命令，它可以轮转MongoDB日志，以防止单个日志文件占用过多的磁盘空间。</p> 
<p style="margin-left:0pt;">必须对<a href="#term-admin-database" rel="nofollow"><u><span style="color:#0000ff;"><u>admin database</u></span></u></a>发出<a href="#dbcmd.logRotate" rel="nofollow"><u><span style="color:#0000ff;"><u>logRotate</u></span></u></a>命令，方式如下：</p> 
<pre><code>{ logRotate: 1 }</code></pre> 
<blockquote> 
 <p style="margin-left:0pt;">注意：您的mongod实例需要使用<a href="#cmdoption-mongod-logpath" rel="nofollow"><u><u>--logpath [file]</u></u></a>选项运行。</p> 
</blockquote> 
<p style="margin-left:0pt;">也可以通过将SIGUSR1信号发送到mongod进程来轮转日志。比如mongod的进程ID为2200，则在Linux上发送信号的方法如下：</p> 
<pre><code>kill -SIGUSR1 2200</code></pre> 
<p style="margin-left:0pt;"> </p> 
<h2><strong><strong><strong>二、</strong></strong><strong><strong>行为</strong></strong><strong><strong>（</strong></strong><strong><strong>Behavior</strong></strong><strong><strong>）</strong></strong></strong></h2> 
<p style="margin-left:0pt;"><a href="#systemLog.logRotate" rel="nofollow"><u><span style="color:#0000ff;"><u>systemLog.logRotate</u></span></u></a>设置或<a href="#cmdoption-mongod-logrotate" rel="nofollow"><u><span style="color:#0000ff;"><u>--logRotate</u></span></u></a>选项规定了logRotate的行为。</p> 
<p style="margin-left:0pt;">当systemLog.logRotate或--logRotate设置为rename时，logRotate通过将当前时间戳附加到文件名来重命名现有日志文件。附加的时间戳格式如下：</p> 
<pre><code>&lt;YYYY&gt;-&lt;mm&gt;-&lt;DD&gt; T &lt;HH&gt;-&lt;MM&gt;-&lt;SS&gt;</code></pre> 
<p style="margin-left:0pt;">然后，logRotate创建一个新的日志文件，新文件名与最初由mongod或mongos的systemLog.path设置规定的日志文件名相同。</p> 
<p style="margin-left:0pt;">将systemLog.logRotate或--logRotate设置为reopen时，logRotate遵循典型的Linux / Unix行为，仅关闭日志文件，然后重新打开同名的日志文件。通过reopen，mongod期望在轮转之前，另一个进程会重命名该文件，并且创建新文件实现重新打开会。</p> 
<p style="margin-left:0pt;"><u><span style="color:#0000ff;"><u>原文链接：<a href="https://docs.mongodb.com/manual/reference/command/logRotate/" rel="nofollow">https://docs.mongodb.com/manual/reference/command/logRotate/</a></u></span></u></p> 
<p style="margin-left:0pt;"> </p> 
<h2><strong><strong><strong>三、实践篇</strong></strong></strong></h2> 
<p> </p> 
<h3>1.打开mongo shell（由于在mongod实例的本地打开此命令，故--ip省略）。</h3> 
<pre><code>D:\MongoDB\Server\3.4\bin&gt;mongo --port  你的端口</code></pre> 
<h3>2.切换到admin数据库。</h3> 
<pre><code>use admin</code></pre> 
<h3>3.授权。</h3> 
<pre><code>db.auth("你的管理账号", "你的密码")</code></pre> 
<h3>4.执行logRotate命令。</h3> 
<pre><code>db.adminCommand({logRotate:1})</code></pre> 
<p style="margin-left:0pt;"><strong><span style="color:#00b050;"><strong>1-4步执行过程如下图所示：</strong></span></strong></p> 
<p style="margin-left:0pt;"><img alt="" src="https://images2.imgbox.com/41/e2/1NNM8dD4_o.jpg"></p> 
<h3 style="margin-left:0pt;">5.执行结果</h3> 
<p><img alt="" src="https://images2.imgbox.com/1f/d3/fnlmfQaj_o.jpg"></p> 
<h2 style="margin-left:0pt;">四、制定计划任务，每天自动轮转</h2> 
<h3 style="margin-left:0pt;">1.制定计划任务</h3> 
<p style="margin-left:0pt;">在操作系统的“任务计划程序”中添加计划任务，填写时间、操作等信息，内容如下：</p> 
<p style="margin-left:0pt;"><img alt="" src="https://images2.imgbox.com/9e/ac/vcMlbtY8_o.jpg"></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" src="https://images2.imgbox.com/b4/3f/eHgAm1Bt_o.jpg"></p> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"><img alt="" src="https://images2.imgbox.com/f9/b6/vDkfhDnl_o.jpg"></p> 
<p style="margin-left:0pt;"> </p> 
<h3 style="margin-left:0pt;">2.编写bat脚本</h3> 
<p style="margin-left:0pt;">编写日志轮转的bat执行脚本文件，新建一个后缀名是.bat文件内容如下：</p> 
<pre><code>@call :output&gt;logRotate.log

exit

:output

@ECHO OFF

echo %date:~0,4%-%date:~5,2%-%date:~8,2% %time%  log rotate begin......

D:\MongoDB\Server\3.4\bin\mongo --host 你的ip  --port 你的端口 -u 你的管理账号 -p 你的密码 --authenticationDatabase admin --eval "printjson(db.adminCommand({logRotate:1}))"

echo log rotate end......

end</code></pre> 
<p style="margin-left:0pt;"> </p> 
<p style="margin-left:0pt;"> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/644c3f58b04c8217d7750a1431ef7acd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nuxt引用组件报错：This relative module was not found:* ./xxx.vue</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6bff9b69a237c57b40c8faa7d3e91099/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">sqlite 中的类似top的用法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>