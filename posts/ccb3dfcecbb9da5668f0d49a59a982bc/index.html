<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zookeeper学习笔记(最全） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zookeeper学习笔记(最全）" />
<meta property="og:description" content="Zookeeper 文章目录 Zookeeper1 Zookeeper概述1.1 Zookeeper简介1.2 Zookeeper工作原理1.3 Zookeeper特点1.4 Zookeeper数据结构1.5 Zookeeper应用场景 2 Zookeeper本地模式安装2.1 Zookeeper下载2.2 虚拟机的克隆2.3 Zookeeper安装2.4 Zookeeper配置2.5 Zookeeper基本操作2.6 Zookeeper配置参数解析 3 Zookeeper内部原理3.1选举策略3.2 节点类型3.3 监听器原理3.4 写数据流程解析 4 Zookeeper集群搭建4.1 分布式环境安装部署4.2 Zookeeper集群搭建4.1.1 配置服务的id(编号)4.1.2 配置集群IP4.1.3 配置其他两台服务4.1.4 集群操作4.2.5 集群启动的问题 4.3 Zookeeper客户端命令4.3.1 客户端命令4.3.2 节点操作 5 Zookeeper实战5.1 Zookeeper的API应用5.1.1 项目环境搭建5.1.2 创建Zookeeper客户端5.1.3 创建节点5.1.4 查询节点的值5.1.5 修改节点的值5.1.6 删除节点5.1.7 判断节点是否存在5.1.8 获取子节点5.1.9 监听节点的变化 5.2 案例-模拟美团商家上下线5.2.1 分析需求5.2.2 项目环境搭建5.2.3 商家服务类5.2.4 客户端5.2.5 运行测试 5.3 案例-分布式锁商品秒杀5.3.1 分布式锁5.3.2 数据准备5.3.3 搭建工程5.3.4 搭建SSM环境5.3.5 功能的开发5.3.6 Zookeeper解决并发问题 6 Zookeeper总结重点问题： 学习内容： Zookeeper技术（概念、使用场景、特点…）Zookeeper本地安装（在本地搭建Zookeper环境、集群的方式进行搭建）Zookeeper内部原理（掌握Zookeeper工作机制）Zookeeper实战开发（Zookeeper的API使用、美团服务监控系统、分布式秒下系统场景的搭建） 1 Zookeeper概述 1.1 Zookeeper简介 Zookeeper是一个分布式的（多台机器同时干一件事情）、开源框架，分布式应用程序的协调服务。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ccb3dfcecbb9da5668f0d49a59a982bc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-03T11:10:15+08:00" />
<meta property="article:modified_time" content="2022-12-03T11:10:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zookeeper学习笔记(最全）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Zookeeper_0"></a>Zookeeper</h2> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Zookeeper_0" rel="nofollow">Zookeeper</a></li><li><ul><li><a href="#1_Zookeeper_10" rel="nofollow">1 Zookeeper概述</a></li><li><ul><li><a href="#11_Zookeeper_12" rel="nofollow">1.1 Zookeeper简介</a></li><li><a href="#12_Zookeeper_30" rel="nofollow">1.2 Zookeeper工作原理</a></li><li><ul><li><a href="#13_Zookeeper_50" rel="nofollow">1.3 Zookeeper特点</a></li><li><a href="#14_Zookeeper_78" rel="nofollow">1.4 Zookeeper数据结构</a></li><li><a href="#15_Zookeeper_89" rel="nofollow">1.5 Zookeeper应用场景</a></li></ul> 
   </li></ul> 
   </li><li><a href="#2_Zookeeper_140" rel="nofollow">2 Zookeeper本地模式安装</a></li><li><ul><li><a href="#21_Zookeeper_144" rel="nofollow">2.1 Zookeeper下载</a></li><li><a href="#22__153" rel="nofollow">2.2 虚拟机的克隆</a></li><li><a href="#23_Zookeeper_159" rel="nofollow">2.3 Zookeeper安装</a></li><li><a href="#24_Zookeeper_167" rel="nofollow">2.4 Zookeeper配置</a></li><li><a href="#25_Zookeeper_182" rel="nofollow">2.5 Zookeeper基本操作</a></li><li><a href="#26_Zookeeper_242" rel="nofollow">2.6 Zookeeper配置参数解析</a></li></ul> 
   </li><li><a href="#3_Zookeeper_261" rel="nofollow">3 Zookeeper内部原理</a></li><li><ul><li><a href="#31_263" rel="nofollow">3.1选举策略</a></li><li><a href="#32__280" rel="nofollow">3.2 节点类型</a></li><li><a href="#33__294" rel="nofollow">3.3 监听器原理</a></li><li><a href="#34__313" rel="nofollow">3.4 写数据流程解析</a></li></ul> 
   </li><li><a href="#4_Zookeeper_331" rel="nofollow">4 Zookeeper集群搭建</a></li><li><ul><li><a href="#41__333" rel="nofollow">4.1 分布式环境安装部署</a></li><li><a href="#42_Zookeeper_339" rel="nofollow">4.2 Zookeeper集群搭建</a></li><li><ul><li><a href="#411_id_341" rel="nofollow">4.1.1 配置服务的id(编号)</a></li><li><a href="#412_IP_352" rel="nofollow">4.1.2 配置集群IP</a></li><li><a href="#413__372" rel="nofollow">4.1.3 配置其他两台服务</a></li><li><a href="#414__380" rel="nofollow">4.1.4 集群操作</a></li><li><a href="#425__413" rel="nofollow">4.2.5 集群启动的问题</a></li></ul> 
    </li><li><a href="#43_Zookeeper_436" rel="nofollow">4.3 Zookeeper客户端命令</a></li><li><ul><li><a href="#431__438" rel="nofollow">4.3.1 客户端命令</a></li><li><a href="#432__493" rel="nofollow">4.3.2 节点操作</a></li></ul> 
   </li></ul> 
   </li><li><a href="#5_Zookeeper_593" rel="nofollow">5 Zookeeper实战</a></li><li><ul><li><a href="#51_ZookeeperAPI_597" rel="nofollow">5.1 Zookeeper的API应用</a></li><li><ul><li><a href="#511__601" rel="nofollow">5.1.1 项目环境搭建</a></li><li><a href="#512_Zookeeper_645" rel="nofollow">5.1.2 创建Zookeeper客户端</a></li><li><a href="#513__687" rel="nofollow">5.1.3 创建节点</a></li><li><a href="#514__749" rel="nofollow">5.1.4 查询节点的值</a></li><li><a href="#515__769" rel="nofollow">5.1.5 修改节点的值</a></li><li><a href="#516__789" rel="nofollow">5.1.6 删除节点</a></li><li><a href="#517__806" rel="nofollow">5.1.7 判断节点是否存在</a></li><li><a href="#518__822" rel="nofollow">5.1.8 获取子节点</a></li><li><a href="#519__838" rel="nofollow">5.1.9 监听节点的变化</a></li></ul> 
    </li><li><a href="#52__859" rel="nofollow">5.2 案例-模拟美团商家上下线</a></li><li><ul><li><a href="#521__861" rel="nofollow">5.2.1 分析需求</a></li><li><a href="#522__871" rel="nofollow">5.2.2 项目环境搭建</a></li><li><a href="#523__900" rel="nofollow">5.2.3 商家服务类</a></li><li><a href="#524__974" rel="nofollow">5.2.4 客户端</a></li><li><a href="#525__1054" rel="nofollow">5.2.5 运行测试</a></li></ul> 
    </li><li><a href="#53__1060" rel="nofollow">5.3 案例-分布式锁商品秒杀</a></li><li><ul><li><a href="#531__1062" rel="nofollow">5.3.1 分布式锁</a></li><li><a href="#532__1094" rel="nofollow">5.3.2 数据准备</a></li><li><a href="#533__1117" rel="nofollow">5.3.3 搭建工程</a></li><li><a href="#534_SSM_1218" rel="nofollow">5.3.4 搭建SSM环境</a></li><li><a href="#535__1317" rel="nofollow">5.3.5 功能的开发</a></li><li><a href="#536_Zookeeper_1510" rel="nofollow">5.3.6 Zookeeper解决并发问题</a></li></ul> 
   </li></ul> 
   </li><li><a href="#6_Zookeeper_1585" rel="nofollow">6 Zookeeper总结</a></li><li><a href="#_1622" rel="nofollow">重点问题：</a></li></ul> 
 </li></ul> 
</div> 
<br> 学习内容： 
<p></p> 
<ul><li>Zookeeper技术（概念、使用场景、特点…）</li><li>Zookeeper本地安装（在本地搭建Zookeper环境、集群的方式进行搭建）</li><li>Zookeeper内部原理（掌握Zookeeper工作机制）</li><li>Zookeeper实战开发（Zookeeper的API使用、美团服务监控系统、分布式秒下系统场景的搭建）</li></ul> 
<h3><a id="1_Zookeeper_10"></a>1 Zookeeper概述</h3> 
<h4><a id="11_Zookeeper_12"></a>1.1 Zookeeper简介</h4> 
<p>Zookeeper是一个分布式的（多台机器同时干一件事情）、开源框架，分布式应用程序的<strong>协调服务</strong>。</p> 
<p>Google公司Chubby产品，他是Hadoop和HBase重要的组件。</p> 
<p>它是一个分布式应用程序提供一致性的服务的软件，提供功能包括：</p> 
<ul><li>配置维护</li><li>域名服务</li><li>分布式同步</li><li>组服务</li><li>…</li></ul> 
<p>Zookeeper目标封装了大量的复杂关键的技术（服务），将简单的接口（API）暴露、高效的使用Zookeeper，稳定性非常的高。</p> 
<p>在大数据生态圈，Zookeeper(动物管理员)是一个非常重要的基础技术，Hadoop（大象）、Hive（蜜蜂）、Pig（小猪）。</p> 
<h4><a id="12_Zookeeper_30"></a>1.2 Zookeeper工作原理</h4> 
<p>1.Zookeeper从设计模式的角度：是一个基于观察者设计模式（一个人干活，有人在盯着他干活）一个分布式的服务管理框架。</p> 
<p>2.它负责存储和管理数据。</p> 
<ul><li>接收观察者进行注册</li><li>Zookeeper就可以将负责注册好的服务通知给客户端</li><li>从服务器集群中进行主节点和从节点的管理模式（Master、Slave）。</li></ul> 
<p>3.Zookeeper = 文件系统 + 通知机制。</p> 
<ul><li>商家营业后需要入驻</li><li>获取到当前正在营业的所有饭店和餐馆列表</li><li>服务节点下线</li><li>服务节点下线的事件通知</li><li>重新去获取最新的服务列表<br> <img src="https://images2.imgbox.com/e6/01/gLJ567ao_o.png" alt="在这里插入图片描述"></li></ul> 
<h5><a id="13_Zookeeper_50"></a>1.3 Zookeeper特点</h5> 
<p>分布式和集群区别？</p> 
<ul><li> <p>无论分布式或者是集群，都是很多服务在一起工作。</p> </li><li> <p>开了一家餐馆，生意不错，我需要进行招聘：</p> <p>（1）分布式：招聘了个员工，1个是服务员、1个是厨师、1个收银员，3个员工服务的工作不一样，但是最终的目的是一致的。</p> <p>（2）集群：招聘了三个服务员，3个服务员做的事同一件事物。</p> </li></ul> 
<p>Zookeeper特点主要有下面几个：</p> 
<ul><li> <p>1.是一个leader和多个follower来组成的集群（例如：在狮群中，一头雄狮和N头母狮）。</p> </li><li> <p>2.集群中只要有半数以上的节点存活， Zookeeper就能正常工作（5台服务器挂掉2台，没问题； 4台服务器挂掉2台，就停止）。</p> </li><li> <p>3.全局数据一致性，每台服务器都保存一份相同的数据副本，无论Client连接哪台Server，数据都是一致的。</p> </li><li> <p>4.数据更新原子性，一次数据要么成功，要么失败（不成功便成仁）。</p> </li><li> <p>5.实时性，在一定时间范围内，Client能读取到最新数据。</p> </li><li> <p>6.更新的请求按照顺序执行，会按照发送过来的顺序，逐一执行（发来123 ，就执行123 ，而不是321或者别的）。</p> </li></ul> 
<p><img src="https://images2.imgbox.com/a6/da/u1ktFhAw_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="14_Zookeeper_78"></a>1.4 Zookeeper数据结构</h5> 
<p>1.Zookeeper数据模型类型与Linux操作系统的文件结构，整体上可以看作是一个倒挂着的树。每一个节点称之为是一个ZookeeperNode。</p> 
<p>2.每一个ZNode是用来保存数据，默认情况下每一个节点的保存数据大小为1MB（元数据）</p> 
<p>3.Zookeeper元数据：表示用来描述数据的数据。又称之为中介数据、中继数据，data about data。主要是用来描述数据的属性信息（这个数据文件的：大小、创建实现、存放位置、历史访问记录、文件记录等）。</p> 
<p><img src="https://images2.imgbox.com/43/63/4OXEHWZ2_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-7xWZcdDl-1669796110009)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/3.png)]"></p> 
<h5><a id="15_Zookeeper_89"></a>1.5 Zookeeper应用场景</h5> 
<p>提供服务服务：</p> 
<ul><li>统一命名服务（域名）</li><li>统一配置管理（监听完成同步更新）</li><li>统一集群管理</li><li>服务节点动态上下线</li><li>软负载均衡（请求被均匀的发布到集群中的每一台服务器上）</li></ul> 
<p><strong>1.统一命名服务</strong></p> 
<p>在分布式的环境下，通常可以对应用程序或者服务器通过一个统一的命名来识别进行访问。</p> 
<p>例如：服务器的IP地址基于非常的困难，可以通过指定一个域名的形式来进行访问，便于记忆。</p> 
<p><img src="https://images2.imgbox.com/a9/df/dTwVXgo3_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-loDIuu2D-1669796110010)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/4.png)]"></p> 
<p><strong>2.统一配置管理</strong></p> 
<p>在分布式的环境下，配置文件做同步更新操作，可以通过监听来完成。</p> 
<p>举例：1000台服务器，如果要去逐一修改这1000台服务器中的数据，运维人员可能会被逼疯，如果有一个节点专门用于维护全局的数据，然后让其他的节点来监听该节点，一旦该节点中的数据发生改变，同步到其他集群中的所有节点上。</p> 
<p><img src="https://images2.imgbox.com/cf/da/W4LT7442_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-sXPupba9-1669796110016)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/5.png)]"></p> 
<p>Zookeeper管理配置文件：</p> 
<ul><li>将配置文件写入到Zookeeper的某个节点上（需要有一台服务器来维护这个配置文件）</li><li>告知客户端去监听这一台服务器上的这个文件（/Config）</li><li>一旦该节点上的这个文件中的数据发生了改变，Zookeeper就可以通过通知来告诉所有的客户端，客户端即完成了同步（数据同步）</li></ul> 
<p><strong>3.服务节点动态上下线</strong></p> 
<p>客户端能够<strong>实时</strong>的获取服务器的状态，服务器上下线的状态。服务器实现的运行状态可以被Zookeeper获取（心跳机制）。</p> 
<p>例如：在美团的APP上实时看到最新的商家营业的情况，是否处于打烊的状态。</p> 
<p><img src="https://images2.imgbox.com/d6/18/tn8JptHv_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-xiN3RXGy-1669796110017)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/6.png)]"></p> 
<p><strong>4.软负载均衡</strong></p> 
<p>Zookeeper会记录每一台服务器访问的次数，让访问最少的服务器去处理最新的请求，请求被均匀分发到集群中每一台服务器是上（雨露均沾的效果）。</p> 
<p><img src="https://images2.imgbox.com/77/e4/1SZGQYNQ_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-7DkGmt1G-1669796110017)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/7.png)]"></p> 
<h3><a id="2_Zookeeper_140"></a>2 Zookeeper本地模式安装</h3> 
<p>Zookeeper是使用Java语言开发，Zookeeper看作是一个Java的应用程序。依赖于JDK的环境。前提条件是需要在Linux系统上安装JDK（&gt;=1.8）。</p> 
<h4><a id="21_Zookeeper_144"></a>2.1 Zookeeper下载</h4> 
<p>1.CentOS7安装Java的JDK。</p> 
<p>2.Zookeeper镜像库下载地址：http://archive.apache.org/dist/zookeeper。</p> 
<ul><li>包含bin：此安装包中包含了所有的Zookeeper相关的依赖jar，直接下载后解压就可以使用。</li><li>不含bin：必须在Linux系统上安装Maven工具，然后通过Maven去下载Zookeeper关联的依赖jar。</li></ul> 
<h4><a id="22__153"></a>2.2 虚拟机的克隆</h4> 
<p>1.必须要把目标的虚拟关闭状态，进行克隆。在虚拟机上右键【管理】-【克隆】-【完整克隆】。将可能的目录目标主机放在zk_vm/zk01文件中（一台Linux系统）。</p> 
<p>2.克隆完成后，启动这台虚拟机。</p> 
<h4><a id="23_Zookeeper_159"></a>2.3 Zookeeper安装</h4> 
<p>1.xft将zookeeper安装包上传到/opt目录下。</p> 
<p>2.执行解压操作（tar）。</p> 
<p>3.重命名mv指令。</p> 
<h4><a id="24_Zookeeper_167"></a>2.4 Zookeeper配置</h4> 
<p>1.配置Zookeeper数据存放的目录（zookeeper/zkData）。</p> 
<p>2.配置Zookeeper的日志存放目录（zookeeper/zkLog）。</p> 
<p>3.zookeeper/conf/zoo_sample.cfg，表示zookeeper的配置模板文件（zoo.cfg）。</p> 
<p>4.zoo.cfg文件中来配置。</p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">dataDir</span><span class="token operator">=</span>/opt/zookeeper/zkData
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/opt/zookeeper/zkLog
</code></pre> 
<h4><a id="25_Zookeeper_182"></a>2.5 Zookeeper基本操作</h4> 
<p>1.启动Zookeeper（bin目录下）。</p> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># ./zkServer.sh start</span>
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Starting zookeeper <span class="token punctuation">..</span>. STARTED
</code></pre> 
<p>2.查看是否启动：</p> 
<pre><code>[root@localhost bin]# jps
3581 Jps
3503 QuorumPeerMain
</code></pre> 
<blockquote> 
 <p>QuorumPeerMain：表示Zookeeper启动入口类，表示配置启动线程处于运行的状态。</p> 
</blockquote> 
<p>3.查看状态。</p> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>root@localhost bin<span class="token punctuation">]</span><span class="token comment"># ./zkServer.sh status</span>
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/bin/<span class="token punctuation">..</span>/conf/zoo.cfg
Client port found: <span class="token number">2181</span>. Client address: localhost. Client SSL: false.
Mode: standalone
</code></pre> 
<blockquote> 
 <p>说明：</p> 
 <p>1.Zookeeper默认访问端口2181。</p> 
 <p>2.localhost表示Zookeeper安装本台主机上。</p> 
 <p>3.standalone表示采用非集群的方式启动（表示孤独的意思）。</p> 
</blockquote> 
<p>4.启动Zookeeper的客户端。</p> 
<pre><code>./zkCli.sh
</code></pre> 
<p>5.退出Zookeeper客户端。</p> 
<pre><code>quit
</code></pre> 
<p>6.停止Zookeeper服务。</p> 
<pre><code>[root@localhost bin]# ./zkServer.sh stop
ZooKeeper JMX enabled by default
Using config: /opt/zookeeper/bin/../conf/zoo.cfg
Stopping zookeeper ... STOPPED
</code></pre> 
<h4><a id="26_Zookeeper_242"></a>2.6 Zookeeper配置参数解析</h4> 
<p>Zookeeper中的配置文件zoo.cfg中参数含义解读如下：</p> 
<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>tickTime=2000</td><td>通信心跳数， Zookeeper服务器与客户端心跳时间，单位毫秒。Zookeeper使用的基本时间，服务器之间或客户端与服务器之间维持心跳的时间间隔，也就是每个tickTime时间就会发送一个心跳，时间单位为毫秒。</td></tr><tr><td>initLimit=10</td><td>LF初始通信时限。集群中的Follower跟随者服务器与Leader领导者服务器之间，启动时能容忍的最多心跳数。10 * 2000（10个心跳时间）如果领导和跟随者没有发出心跳通信，就视为失效的连接，领导和跟随者彻底断开。</td></tr><tr><td>syncLimit=5</td><td>LF同步通信时限。集群启动后，Leader与Follower之间的最大响应时间单位，假如响应超过syncLimit*tickTime=10秒，Leader就认为Follwer已经死掉，会将Follwer从服务器列表中删除。</td></tr><tr><td>dataDir</td><td>数据文件目录 + 数据持久化路径。</td></tr><tr><td>dataLogDir</td><td>日志文件目录。</td></tr><tr><td>clientPort=2181</td><td>客户端连接端口。监听客户端连接的端口。</td></tr></tbody></table> 
<p>Zookeeper服务端口，默认是8080。修饰Zookeeper服务的默认端口的配置。</p> 
<pre><code class="prism language-sh"><span class="token assign-left variable">admin.serverPort</span><span class="token operator">=</span><span class="token number">8081</span>
</code></pre> 
<h3><a id="3_Zookeeper_261"></a>3 Zookeeper内部原理</h3> 
<h4><a id="31_263"></a>3.1选举策略</h4> 
<p>半数机制：在集群环境中半数以上的机器存活，这个集群就可用。所以在设计Zookeeper集群系统时，通常会选择奇数台服务器来搭建Zookeeper的集群。</p> 
<p>在配置文件中即便不去配置任何关于主节点和从节点的内容。Zookeeper集群启动成功后，仍然会选择出主节点和从节点，Zookeeper是有临时选举策略的。</p> 
<p><img src="https://images2.imgbox.com/ed/1b/gqnWxASH_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-eNhFszNf-1669796110018)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/10.png)]"></p> 
<p>1.Server1先投票，投给自己，自己为1票，没有超过半数，根本无法成为leader，顺水推舟将票数投给了id比自己大的Server2。</p> 
<p>2.Server2也把自己的票数投给了自己，再加上Server1给的票数，总票数为2票，没有超过半数，也无法成为leader，也学习Server1，顺水推舟，将自己所有的票数给了id比自己大的Server3。</p> 
<p>3.Server3得到了Server1和Server2的两票，再加上自己投给自己的一票。3票超过半数，顺利成为leader。</p> 
<p>4.Server4和Server5都投给自己，但是无法改变Server3的票数，只好听天由命，承认Server3是leader。</p> 
<h4><a id="32__280"></a>3.2 节点类型</h4> 
<p><strong>1.持久型</strong></p> 
<p>1.特点：客户端如果和Zookeeper断开了连接，对应的节点上数据依旧持久保存着。</p> 
<p>2.创建ZNode时按照顺序来进行标识节点，ZNode名称后面追加一个数字的值，例如：Znode001、Znode002、Znode003…顺序号是一个单调递增的数字来进行标记。</p> 
<p><strong>2.短暂型</strong></p> 
<p>1.特点：客户端和Zookeeper断开连接之后，该节点会被自动的回收（自动的删除）。</p> 
<p>2.创建ZNode节点的时候，ZNode名称会追加一个数字的值，顺序编号是一个单调递增的数字：例如：Znode001、Znode002、Znode003…</p> 
<h4><a id="33__294"></a>3.3 监听器原理</h4> 
<p>1.在main方法中创建Zookeeper客户端的同时就会创建两个线程，一个负责网络连接通信，一个负责监听。</p> 
<p>2.监听事件就会通过网络通信发送给Zookeeper。</p> 
<p>3.Zookeeper获得注册的监听事件后，立刻将监听事件添加到监听列表里。</p> 
<p>4.Zookeeper监听到数据变化或路径变化，就会将这个消息发送给监听线程。常见的监听：</p> 
<ul><li> <p>监听节点数据的变化：get path [watch]</p> </li><li> <p>监听子节点增减的变化：ls path [watch]</p> </li></ul> 
<p>5.监听线程就会在内部调用process()方法（需要开发者实现process()方法的内容）。</p> 
<p><img src="https://images2.imgbox.com/5e/0e/xw8aBZ90_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-H3umkzqs-1669796110018)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/11.png)]"></p> 
<h4><a id="34__313"></a>3.4 写数据流程解析</h4> 
<p>1.Client想向ZooKeeper的Server1上写数据，必须得先发送一个写的请求。</p> 
<p>2.如果Server1不是Leader，那么Server1会把接收到的请求进一步转发给Leader。</p> 
<p>3.这个Leader会将写请求广播给各个Server，各个Server写成功后就会通知Leader。</p> 
<p>4.当Leader收到半数以上的Server数据写成功了，那么就说明数据写成功了。</p> 
<p>5.随后，Leader会告诉Server1数据写成功了。</p> 
<p>6.Server1会反馈通知Client数据写成功了，整个流程结束。</p> 
<p><img src="https://images2.imgbox.com/6c/cc/0J0EUmYg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_Zookeeper_331"></a>4 Zookeeper集群搭建</h3> 
<h4><a id="41__333"></a>4.1 分布式环境安装部署</h4> 
<p>Zookeeper集群环境搭建：需要使用3台CentOS系统，分别在这三台系统安装Zookeeper，并配置Zookeeper的相关配置。这三台服务器就构成了一个集群的环境。</p> 
<p>虚拟时可以完整性克隆的。只需要搭建好一台Zookeeper服务，然后将这台Zookeeper服务器作为一个原始系统，进行克隆。</p> 
<h4><a id="42_Zookeeper_339"></a>4.2 Zookeeper集群搭建</h4> 
<h5><a id="411_id_341"></a>4.1.1 配置服务的id(编号)</h5> 
<p>IP每态操作系统都有一个IP(192.168.230.131、192.168.230.132、192.168.230.133)</p> 
<p>1.Zookeeper要求必须在dataDir=/opt/zookeeper/zkData属性所指向的目录下创建一个文件myid作为文件。这个文件中的数字就表示当前Zookeeper编号。zk02的编号：2；zk03的编号：3。</p> 
<pre><code>/opt/zookeeper/zkData/myid
1
</code></pre> 
<h5><a id="412_IP_352"></a>4.1.2 配置集群IP</h5> 
<p>1.zoo.cfg文件维护了Zookeeper的IP集群配置。</p> 
<pre><code class="prism language-sh"><span class="token comment"># server.A=B:C:D</span>
<span class="token assign-left variable">server.1</span><span class="token operator">=</span><span class="token number">192.168</span>.230.131:2888:3888
<span class="token assign-left variable">server.2</span><span class="token operator">=</span><span class="token number">192.168</span>.230.132:2888:3888
<span class="token assign-left variable">server.3</span><span class="token operator">=</span><span class="token number">192.168</span>.230.133:2888:3888
</code></pre> 
<p>2.配置参数解读server.A=B:C:D。</p> 
<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>A</td><td>一个数字，表示第几号服务器。集群模式下配置的/opt/zookeeper/zkData/myid文件里面的数据就是A的值</td></tr><tr><td>B</td><td>服务器的IP地址</td></tr><tr><td>C</td><td>与集群中Leader服务器交换信息的端口</td></tr><tr><td>D</td><td>选举时专用端口，万一集群中的Leader服务器挂了，需要一个端口来重新进行选举，选出一个新的Leader，而这个端口就是用来执行选举时服务器相互通信的端口</td></tr></tbody></table> 
<h5><a id="413__372"></a>4.1.3 配置其他两台服务</h5> 
<p>1.zk02配置IP，myid的值为2。</p> 
<p>2.zk03配置IP，myid的值为3。</p> 
<p>3.通过VM提供的克隆技术来完成以上两台主机的搭建。</p> 
<h5><a id="414__380"></a>4.1.4 集群操作</h5> 
<p>1.关闭集群中的每一个节点的防火墙。</p> 
<pre><code class="prism language-sh">systemctl stop firewalld.service <span class="token comment"># 停止防火墙，临时停止，如果服务器重启，则防火墙会自动开启</span>
systemctl disable firewalld <span class="token comment"># 禁止防火墙开机自启动</span>
</code></pre> 
<p>2.查看当前防火墙的状态：（active表示运行、dead表示关闭）。</p> 
<pre><code>systemctl status firewalld
</code></pre> 
<p>3.启动Zookeeper服务。</p> 
<pre><code>./zkServer.sh start
</code></pre> 
<p>4.查看Zookeeper状态。</p> 
<pre><code>./zkServer.sh status
</code></pre> 
<blockquote> 
 <p>说明：</p> 
 <p>Model: follower：表示该Zookeeper服务是一个从节点</p> 
 <p>Model: leader：表示该Zookeeper服务是一个主节点</p> 
</blockquote> 
<h5><a id="425__413"></a>4.2.5 集群启动的问题</h5> 
<p>1.物理内存不足。例如物理主机内容8G，默认每一台虚拟机分配的内存4G。关闭虚拟机，编辑虚拟机，将虚拟机的分配内存设置2G。</p> 
<p>2.提示：bash: ./zkServer.sh : Permission denied…表示没有权限访问和执行zkServer.sh。</p> 
<pre><code class="prism language-sh"><span class="token function">chmod</span> u+x zkServer.sh
</code></pre> 
<p>3.提示…not running。可能的原因：</p> 
<ul><li> <p>JDK安装的正确。比如检查JDK是否正常安装、检查JDK的环境变量的配置。</p> </li><li> <p>单台zk节点无法启动。zoo.cfg配置有误。dataDir、dataLogDir。</p> <pre><code class="prism language-sh"><span class="token comment">#dataDir=/opt/zookeeper/zkData</span>
<span class="token assign-left variable">dataLogDir</span><span class="token operator">=</span>/opt/zookeeper/zkLog
</code></pre> </li><li> <p>集群环境无法正常启动。集群的配置有问题，每台主机上的集群IP是否，myid文件(1、2、3)。</p> </li></ul> 
<h4><a id="43_Zookeeper_436"></a>4.3 Zookeeper客户端命令</h4> 
<h5><a id="431__438"></a>4.3.1 客户端命令</h5> 
<p>1.启动Zookeeper的客户端。bin目录下的zkCli.sh</p> 
<pre><code>./zkCli.sh
</code></pre> 
<p>2.查看Zookeeper提供的常见命令。</p> 
<pre><code>help
</code></pre> 
<p>3.查看当前节点下ZNode中包含的内容。默认有一个zookeeper的节点。</p> 
<pre><code>[zk: localhost:2181(CONNECTED) 1] ls /
[zookeeper]
</code></pre> 
<p>4.查看当前节点详情数据。</p> 
<pre><code>[zk: localhost:2181(CONNECTED) 2] ls -s /
[zookeeper]
cZxid = 0x0
ctime = Wed Dec 31 19:00:00 EST 1969
mZxid = 0x0
mtime = Wed Dec 31 19:00:00 EST 1969
pZxid = 0x0
cversion = -1
dataVersion = 0
aclVersion = 0
ephemeralOwner = 0x0
dataLength = 0 
numChildren = 1
</code></pre> 
<p>节点的参数信息：</p> 
<table><thead><tr><th>参数名</th><th>描述</th></tr></thead><tbody><tr><td>cZxid</td><td>创建节点的事务。每次修改ZooKeeper状态都会收到一个zxid形式的时间戳，也就是ZooKeeper事务ID。事务ID是ZooKeeper中所有修改总的次序。每个修改都有唯一的zxid，如果zxid1小于zxid2，那么zxid1在zxid2之前发生。</td></tr><tr><td>ctime</td><td>被创建的毫秒数（从1970年开始）</td></tr><tr><td>mZxid</td><td>最后更新的事务zxid</td></tr><tr><td>mtime</td><td>最后修改的毫秒数（从1970年开始）</td></tr><tr><td>pZxid</td><td>最后更新的子节点zxid</td></tr><tr><td>cversion</td><td>创建版本号，子节点修改次数</td></tr><tr><td>dataVersion</td><td>数据变化版本号</td></tr><tr><td>aclVersion</td><td>权限版本号</td></tr><tr><td>ephemeralOwner</td><td>如果是临时节点，这个是znode拥有者的session id。如果不是临时节点则是0</td></tr><tr><td>dataLength</td><td>数据长度</td></tr><tr><td>numChildren</td><td>子节点数</td></tr></tbody></table> 
<h5><a id="432__493"></a>4.3.2 节点操作</h5> 
<p>1.在根节点下创建(create)两个节点(/)。</p> 
<pre><code>create /cn
create /us
</code></pre> 
<p>2.在创建节点的时候，同时向节点中保存数据。</p> 
<pre><code>create /rus 'pujing'
</code></pre> 
<p>3.获取节点中的数据。</p> 
<pre><code>get /rus
</code></pre> 
<p>4.多级节点的创建。如果父节点节点不存在，则会提示错误信息。</p> 
<pre><code class="prism language-sh"><span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">8</span><span class="token punctuation">]</span> create /jp/Tokyo <span class="token string">'hot'</span>
Node does not exist: /jp/Tokyo <span class="token comment"># 父节点不存在，所以创建失败</span>
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">9</span><span class="token punctuation">]</span> create /jp
Created /jp
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">10</span><span class="token punctuation">]</span> create /jp/Tokyo <span class="token string">'hot'</span>
Created /jp/Tokyo
<span class="token punctuation">[</span>zk: localhost:2181<span class="token punctuation">(</span>CONNECTED<span class="token punctuation">)</span> <span class="token number">11</span><span class="token punctuation">]</span> get /jp/Tokyo
hot
</code></pre> 
<p>5.创建短暂节点。在客户端断开连接后，这个节点就会被回收。</p> 
<pre><code class="prism language-sh">create <span class="token parameter variable">-e</span> /uk <span class="token comment"># 参数-e表示标记当前的节点是一个临时节点（短暂节点）</span>
</code></pre> 
<p>6.创建带序号的节点。</p> 
<ul><li>在cn节点下，创建三个城市节点</li><li>如果创建的节点期望顺序编号，需要指定一个参数-s。</li><li>如果在指定节点下，已经存在了一个节点，所创建出来的新节点编号从1开始取值(默认值从0开始取值)</li></ul> 
<p>7.修改节点中的数据。</p> 
<pre><code class="prism language-sh"><span class="token builtin class-name">set</span> /jp/Tokyo <span class="token string">'too hot'</span>
</code></pre> 
<p>8.删除节点。</p> 
<pre><code>delete /jp/Tokyo
</code></pre> 
<p>9.通过递归的方式来删除指定节点及该节点下所有的子节点。</p> 
<pre><code>deleteall /cn
</code></pre> 
<p>10.监听指定节点的<strong>值改变</strong>或者<strong>子节点</strong>的变化（路径发生变化）。</p> 
<p>（1）在zk03节点上注册一个事件监听（通过节点的名称来确定要监听谁）。</p> 
<pre><code>addWatch /us
</code></pre> 
<p>（2）在zk01节点上修改了us节点的数据内容。</p> 
<pre><code>set /us 'meiguo'
</code></pre> 
<p>（3）在zk03节点上，提示监听到了us的事件，事件被触发了。</p> 
<pre><code>WATCHER::

WatchedEvent state:SyncConnected type:NodeDataChanged path:/us
</code></pre> 
<p>（4）在zk01节点上，给us节点添加了子节点。</p> 
<pre><code>create /us/NewYork
</code></pre> 
<p>（5）查看zk03节点，监听到了目标节点子节的改变。</p> 
<pre><code>WATCHER::

WatchedEvent state:SyncConnected type:NodeCreated path:/us/NewYork
</code></pre> 
<h3><a id="5_Zookeeper_593"></a>5 Zookeeper实战</h3> 
<p>建立在SSM框架的基础上来实现的（再度复习SSM框架开发和使用）。</p> 
<h4><a id="51_ZookeeperAPI_597"></a>5.1 Zookeeper的API应用</h4> 
<p>目的通过Zookeeper提供Java的API技术，来操作和访问Zookeeper集群。例如，向集群中插入节点，或者获取集群中某个节点的数据内容，例如删除集群中某个节点。</p> 
<h5><a id="511__601"></a>5.1.1 项目环境搭建</h5> 
<p>1.创建一个项目：test_zookeeper。项目类型Maven类型。</p> 
<p>2.添加依赖。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 单元测试 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.13.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 最新的zookeeper的jar版本是3.8.0。推荐项目zookeeper依赖和zookeeper安装包版本一致 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- log4g日志 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3.在resources目录下创建一个log4j.properties。</p> 
<pre><code class="prism language-properties">log4j.rootLogger=INFO, stdout
log4j.appender.stdout=org.apache.log4j.ConsoleAppender
log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
log4j.appender.stdout.layout.ConversionPattern=%d %p [%c] - %m%n

log4j.appender.logfile=org.apache.log4j.FileAppender
log4j.appender.logfile.File=target/zk.log
log4j.appender.logfile.layout=org.apache.log4j.PatternLayout
log4j.appender.logfile.layout.ConversionPattern=%d %p [%c] - %m%n
</code></pre> 
<h5><a id="512_Zookeeper_645"></a>5.1.2 创建Zookeeper客户端</h5> 
<p>在项目测试包下进行测试：ZookeeperTests测试类。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">WatchedEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">Watcher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">ZooKeeper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>junit<span class="token punctuation">.</span></span><span class="token class-name">Test</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Zookeeper客户端
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ZookeeperTests</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 集群的IP地址，集群的IP使用","分隔，同时需要指定客户端通过那一个端口连接集群（2181）</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> connectionStr <span class="token operator">=</span>
            <span class="token string">"192.168.230.131:2181,192.168.230.132:2181,192.168.230.133:2181"</span><span class="token punctuation">;</span>
    <span class="token comment">// 创建Zookeeper客户端对象，通过该对象来节点Zookeeper集群</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zooKeeperClient<span class="token punctuation">;</span>
    <span class="token comment">// 单位是毫秒</span>
    <span class="token comment">// sessionTimeout属性：在指定的时间内来尝试连接Zookeeper集群，如果超出该指定的时间，此群如果来没有连接上，不会再去尝试连接</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">// 如果超出了60秒还没有连接上集群，会报错</span>

    <span class="token comment">// 连接Zookeeper集群前的初始化工作准备</span>
    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// Zookeeper三台服务器是处于正常运行状态</span>
        <span class="token comment">// Zookeeper集群是可以创建监听器，主要监听节点数据变化或者子节点变化</span>
        <span class="token class-name">Watcher</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"监听事件执行...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">// 初始化Zookeeper对象</span>
        zooKeeperClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectionStr<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> watcher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="513__687"></a>5.1.3 创建节点</h5> 
<p><strong>1.ACL对象介绍</strong></p> 
<p>代码实现：</p> 
<pre><code class="prism language-java">zooKeeperClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                <span class="token string">"/yuanxin"</span><span class="token punctuation">,</span>
                <span class="token string">"袁老师"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span>
                <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>一个ACL对象就是一个Id和permission对。</p> 
<ul><li> <p>表示哪个/哪些范围的Id（Who）在通过了怎样的鉴权（How）之后，就允许进行那些操作（What）。即Who How What。</p> </li><li> <p>permission（What）就是一个int表示的位码，每一位代表一个对应操作的允许状态。</p> </li><li> <p>类似Linux的文件权限，不同的是共有5种操作：CREATE、READ、WRITE、DELETE、ADMIN（对应更改ACL的权限）。</p> </li></ul> 
<table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>OPEN_ACL_UNSAFE</td><td>创建开放节点，允许任意操作（用的最多，其余的权限用的很少）</td></tr><tr><td>READ_ACL_UNSAFE</td><td>创建只读节点</td></tr><tr><td>CREATOR_ALL_ACL</td><td>创建者才有全部权限</td></tr></tbody></table> 
<p><strong>2.创建节点实现</strong></p> 
<p>通过Zookeeper对象来创建节点。需要使用@Before去修饰init()方法。</p> 
<pre><code class="prism language-java"><span class="token comment">// 创建节点</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
         * create()方法：表示在指定的节点下创建一个新的节点。create()方法会将创建成功的节点名称作为方法的返回值
         *  - 参数1：表示创建的节点名称，需要指定完整的父节点
         *  - 参数2：表示在创建该节点的同时，初始化的节点数据
         *  - 参数3：节点权限
         *  - 参数4：节点的类型
         */</span>
  <span class="token class-name">String</span> nodeCreated <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
        <span class="token string">"/yuanxin"</span><span class="token punctuation">,</span>
        <span class="token string">"袁老师"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span>
        <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">PERSISTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"nodeCreated="</span> <span class="token operator">+</span> nodeCreated<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3.Session超时异常</strong></p> 
<p>在运行createNode()方法的时候抛出一个异常：ClientCnxn$SesssionTimeoutException异常。</p> 
<p>解决方案：</p> 
<ul><li>防火墙没有关闭：systemctl stop firewalled</li><li>检查客户端IP集群定义的字符串是否正确</li><li>增加sessionTimeout变量的取值(等待时间加大-50*1000)</li></ul> 
<h5><a id="514__749"></a>5.1.4 查询节点的值</h5> 
<p>getData()方法查询节点的数据。</p> 
<pre><code class="prism language-java"><span class="token comment">// 查询节点的数据</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
         * 参数1：表示被查询的节点名称（完整节点路径）
         * 参数2：是一个boolean类型的取值（false不需要）
         * 参数3：接收一个Stat类型的对象，直接new实例化一个Stat对象
         */</span>
  <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/yuanxin"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 把字节码数组转化成一个字符串</span>
  <span class="token class-name">String</span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"content="</span> <span class="token operator">+</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="515__769"></a>5.1.5 修改节点的值</h5> 
<p>setData()方法用来设置节点的数据内容。</p> 
<pre><code class="prism language-java"><span class="token comment">// 节点更新</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">/**
         * 参数1：表示被修改的节点名称（即对那一个节点的数据进行修改操作）
         * 参数2：被修改的新数据（需要转化成字节数组）
         * 参数3：dataVersion=0属性的取值为0，数据变化版本号（0-n）
         */</span>
  <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">"/yuanxin"</span><span class="token punctuation">,</span> <span class="token string">"新哥"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 表示是当前操作的节点元数据，输出的这个节点详情信息</span>
  <span class="token comment">// stat=12884901913,12884901921,1669694202793,1669702964097,1,0,0,0,6,0,12884901913</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"stat="</span> <span class="token operator">+</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="516__789"></a>5.1.6 删除节点</h5> 
<p>delete()方法用来删除指定节点。</p> 
<pre><code class="prism language-java"><span class="token comment">// 删除节点</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
  			<span class="token comment">/**
         * 参数1：表示根据节点名来删除指定的节点
         * 参数2：表示增删改的操作都需要指定一个版本号dataVersion=1
         */</span>
  zooKeeperClient<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"/yuanxin"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"删除成功！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="517__806"></a>5.1.7 判断节点是否存在</h5> 
<p>exists()方法用来判断指定的节点是否存在。</p> 
<pre><code class="prism language-java"><span class="token comment">// 判断节点是否存在</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">exist</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果stat返回值为null表示指定的节点不存在</span>
    <span class="token class-name">Stat</span> stat <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token string">"/yuanxin"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"stat="</span> <span class="token operator">+</span> stat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> flag <span class="token operator">=</span> stat <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token string">"该节点不存在"</span> <span class="token operator">:</span> <span class="token string">"该节点存在"</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"flag="</span> <span class="token operator">+</span> flag<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="518__822"></a>5.1.8 获取子节点</h5> 
<p>getChildren()方法用来获取指定节点的所有子节点。</p> 
<pre><code class="prism language-java"><span class="token comment">// 获取指定节点的所有子节点</span>
<span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getChildrenNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 根据指定的节点名称来获取该节点下所有的子节点</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> childNodes <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/cn"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> node <span class="token operator">:</span> childNodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="519__838"></a>5.1.9 监听节点的变化</h5> 
<p>watch是一个boolean类型的变量，表示是否开启对应的节点监听，true表示开启这个节点的监听。</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listenChildNodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/**
     * 参数1：表示指定要获取那一个节点下所有的子节点
     * 参数2：true表示注册监听器
     */</span>
    <span class="token comment">// List&lt;String&gt; getChildren(String path, boolean watch)</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> childNodes <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/"</span> <span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> node <span class="token operator">:</span> childNodes<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 让线程不停止，等待监听器的响应</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 线程在当前代码处处于等待的状态，不会在往后执行了</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="52__859"></a>5.2 案例-模拟美团商家上下线</h4> 
<h5><a id="521__861"></a>5.2.1 分析需求</h5> 
<p>1.模拟一个美团的服务平台，完成商家营业状态、打烊状态的通知和监控。</p> 
<p>2.创建一个/meituan节点。</p> 
<pre><code>create /meituan
</code></pre> 
<h5><a id="522__871"></a>5.2.2 项目环境搭建</h5> 
<p>1.创建一个Maven类型的项目，项目名称设置为：zk_meituan。</p> 
<p>2.添加依赖。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>zookeeper<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.8.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.13.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.logging.log4j<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>log4j-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.8.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3.在项目的resources目录下log4j.properties文件。</p> 
<h5><a id="523__900"></a>5.2.3 商家服务类</h5> 
<p>商家服务类名称：MerchantServer。定义业务功能（应该状态）。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>meituan</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MerchantServer</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// zk集群IP地址</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> connectionString <span class="token operator">=</span>
            <span class="token string">"192.168.230.131:2181,192.168.230.132:2181,192.168.230.133:2181"</span><span class="token punctuation">;</span>
    <span class="token comment">// zk连接等待时间</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token comment">// zk客户端对象</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zookeeperClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 封装一个方法，创建Zookeeper集群的客户端连接对象</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        zookeeperClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 监听器会被回调的方法</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 注册到集群(/meituan/新哥刀削面、/meituan/杨哥蛋炒饭)
     *
     * ox000000 - 新哥刀削面
     * ox000001 - 杨哥蛋炒饭
     *
     * create -s /cn/city --&gt; 连续执行了3遍
     * city0x000000000
     * city0x000000001
     * city0x000000002
     * city0x000000003
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">String</span> merchantName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 方法的参数接收一个商家的名字，即表示被注册的商家</span>
        <span class="token comment">// EPHEMERAL_SEQUENTIAL表示当前所创建的节点是一个短暂型节点，并且是是有序型的</span>
        <span class="token comment">// 返回的字符串名称就是被创建的商家节点名称（merchant0x000000001）</span>
        <span class="token class-name">String</span> create <span class="token operator">=</span> zookeeperClient<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
                        <span class="token string">"/meituan/merchant"</span><span class="token punctuation">,</span>
                        merchantName<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">ZooDefs<span class="token punctuation">.</span>Ids</span><span class="token punctuation">.</span><span class="token constant">OPEN_ACL_UNSAFE</span><span class="token punctuation">,</span>
                        <span class="token class-name">CreateMode</span><span class="token punctuation">.</span><span class="token constant">EPHEMERAL_SEQUENTIAL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>merchantName <span class="token operator">+</span> <span class="token string">"：开始营业！"</span> <span class="token operator">+</span> create<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 业务功能</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business</span><span class="token punctuation">(</span><span class="token class-name">String</span> merchantName<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>merchantName <span class="token operator">+</span> <span class="token string">"：正在营业中...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 耗时操作</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 生命周期main</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// KFC</span>
        <span class="token comment">// 1.创建商家服务对象</span>
        <span class="token class-name">MerchantServer</span> merchantServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MerchantServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.连接Zookeeper服务集群（和美团平台取得连接）</span>
        merchantServer<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.将商家入住美团（将服务器节点节点进行注册）</span>
        merchantServer<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.业务逻辑处理(做生意)</span>
        merchantServer<span class="token punctuation">.</span><span class="token function">business</span><span class="token punctuation">(</span>args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="524__974"></a>5.2.4 客户端</h5> 
<p>客户端类的名称：Customers类。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>meituan</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">KeeperException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">WatchedEvent</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">Watcher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span></span><span class="token class-name">ZooKeeper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>zookeeper<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">Stat</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">ArrayList</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 客户端类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Customers</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> connectionString
            <span class="token operator">=</span> <span class="token string">"192.168.230.131:2181,192.168.230.132:2181,192.168.230.133:2181"</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> sessionTimeout <span class="token operator">=</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">ZooKeeper</span> zooKeeperClient <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token comment">// 创建Zookeeper的客户端连接</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        zooKeeperClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZooKeeper</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">,</span> sessionTimeout<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 回调方法：当监听的节点发生改变的时候，此方法会被自动的回调</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">WatchedEvent</span> watchedEvent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 一旦/meituan节点下的子节点发生改变，需要将最新的节点在客户端进行重新请求获取最新的节点列表</span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 获取罪行的商家列表</span>
                    <span class="token function">getMerchantList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">KeeperException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 获取服务器商家列表信息(如果要获取某个节点下所有的子节点：getChildren()方法完成)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getMerchantList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.获取了商家的列表(处于运营状态的商家列表)</span>
        <span class="token comment">// true表示开启对/meituan监听(merchant0x0000001)</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> merchants <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">getChildren</span><span class="token punctuation">(</span><span class="token string">"/meituan"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.根据节点的名称来获取该节点对应的数据信息。可以声明一个字符串集合来存储所有节点的数据</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> merchantDataList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.通过遍历节点的名称来获取节点的数据，再把获取的数据保存到merchantDataList集合中</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> merchant <span class="token operator">:</span> merchants<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> zooKeeperClient<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token string">"/meituan/"</span> <span class="token operator">+</span> merchant<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Stat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            merchantDataList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 4.打印服务器商家最新的列表信息</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>merchantDataList<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 业务功能</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">business</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"客户正在浏览外卖商家的店...."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">,</span> <span class="token class-name">KeeperException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.创建Zookeeper连接(客户打开了美团APP)</span>
        <span class="token class-name">Customers</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Customers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.连接平台</span>
        client<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.获取/meituan节点下所有的子节点（从美团平台上获取商家的列表信息）</span>
        client<span class="token punctuation">.</span><span class="token function">getMerchantList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.业务进行调用（浏览外卖点，对比商家、点餐）</span>
        client<span class="token punctuation">.</span><span class="token function">business</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="525__1054"></a>5.2.5 运行测试</h5> 
<p>1.测试客户端类。</p> 
<p>2.测试服务端类。通过IDEA对main方法进行传参数。</p> 
<h4><a id="53__1060"></a>5.3 案例-分布式锁商品秒杀</h4> 
<h5><a id="531__1062"></a>5.3.1 分布式锁</h5> 
<p>锁：我们在多线程中接触过，作用就是让当前的资源不会被其他线程访问。</p> 
<ul><li> <p>我的日记本，不可以被别人看到。所以要锁在保险柜中。</p> </li><li> <p>当我打开锁，将日记本拿走了，别人才能使用这个保险柜。</p> </li></ul> 
<p>在Zookeeper中使用传统的锁会引发的“羊群效应”。1000个人创建节点，只有一个人能成功，999人需要等待。</p> 
<p>羊群是一种很散乱的组织，平时在一起也是盲目地左冲右撞，但一旦有一只头羊动起来，其他的羊也会不假思索地一哄而上，全然不顾旁边可能有的狼和不远处更好的草。羊群效应就是比喻人都有 一种从众心理，从众心理很容易导致盲从，而盲从往往会陷入骗局或遭到失败。</p> 
<p><img src="https://images2.imgbox.com/bf/c6/rkxpv3k7_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-vzqvReS4-1669796110020)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/14.png)]"></p> 
<p>为了避免“羊群效应”的产生，Zookeeper采用<strong>分布式锁</strong>来解决“羊群效应”的问题。</p> 
<p><img src="https://images2.imgbox.com/48/a7/ideUbHRK_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-OzyYVI6a-1669796110020)(https://gitee.com/luoty-taotieshaonv/typora-images/raw/master/15.png)]"></p> 
<p>1.所有请求进来，在/lock下创建临时顺序节点，Zookeeper会帮你编号排序。</p> 
<p>2.判断自己是不是/lock下最小的节点。</p> 
<ul><li> <p>是，获得锁（创建节点）</p> </li><li> <p>否，对前面小我一级的节点进行监听</p> </li></ul> 
<p>3.获得锁请求，处理完业务逻辑，释放锁（删除节点），后一个节点得到通知。</p> 
<p>4.重复上面的步骤二。</p> 
<h5><a id="532__1094"></a>5.3.2 数据准备</h5> 
<p>创建一个商品表，保存5件优惠商品。创建一个订单表。放在一个指定的库。</p> 
<pre><code class="prism language-sql"><span class="token comment">-- 商品表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>product<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  id <span class="token keyword">int</span> <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token keyword">auto_increment</span><span class="token punctuation">,</span> <span class="token comment">-- 商品编号</span>
  product_name <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token comment">-- 商品名称</span>
  stock <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token comment">-- 库存</span>
  version <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token comment">-- 版本</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> product <span class="token punctuation">(</span>product_name<span class="token punctuation">,</span> stock<span class="token punctuation">,</span> version<span class="token punctuation">)</span> <span class="token keyword">values</span> <span class="token punctuation">(</span><span class="token string">'锦鲤-清空购物车-大奖'</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 订单表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> <span class="token identifier"><span class="token punctuation">`</span>order<span class="token punctuation">`</span></span> <span class="token punctuation">(</span>
  id <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">primary</span> <span class="token keyword">key</span><span class="token punctuation">,</span> <span class="token comment">-- 订单编号</span>
  pid <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token comment">-- 商品编号</span>
  userid <span class="token keyword">int</span> <span class="token operator">not</span> <span class="token boolean">null</span> <span class="token comment">-- 用户编号</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="533__1117"></a>5.3.3 搭建工程</h5> 
<p>1.创建一个Maven类型的项目，项目的名称：zk_product。</p> 
<p>2.手动的创建webapp目录，自动生成WEB-INF/web.xml。</p> 
<p>3.使用SSM架构来搭建项目的后台（SSM框架整合）。</p> 
<p>4.引入项目的依赖（Zookeeper依赖、分布式锁依赖…）。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- Spring --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-context<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-beans<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-webmvc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- MyBatis --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.mybatis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-spring<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0.5<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 连接池 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>druid<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.1.10<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- 数据库 --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>8.0.20<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token comment">&lt;!-- junit --&gt;</span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>junit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 网友投票最牛逼版本 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>5.添加了项目的内嵌Tomcat插件，通过plugin标签进行的配置。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- Maven内嵌的Tomcat插件 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.tomcat.maven<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token comment">&lt;!-- 目前Apache只提供了Tomcat6和Tomcat7两个插件 --&gt;</span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tomcat7-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>8001<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>path</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>path</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
          <span class="token comment">&lt;!-- 打包完成后，运行服务 --&gt;</span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>run<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="534_SSM_1218"></a>5.3.4 搭建SSM环境</h5> 
<p>1.创建一个文件夹mybatis，在该文件夹下配置mybatis-config.xml。</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">configuration</span>
        <span class="token name">PUBLIC</span> <span class="token string">"-//mybatis.org//DTD Config 3.0//EN"</span>
        <span class="token string">"http://mybatis.org/dtd/mybatis-3-config.dtd"</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>settings</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 后台的日志输出：针对开发者。SQL操作的语句打印在控制 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>logImpl<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>STDOUT_LOGGING<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- 开启驼峰映射：user_name，userName --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mapUnderscoreToCamelCase<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- 开启二级缓存 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>setting</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cacheEnabled<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>settings</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>2.创建spring文件夹，Spring框架的核心配置文件spring.xml（配置Spring框架和SpringMVC框架）。</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>beans</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/beans<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>context</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/context<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xmlns:</span>tx</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.springframework.org/schema/tx<span class="token punctuation">"</span></span>
       <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/tx
       http://www.springframework.org/schema/tx/spring-tx.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token comment">&lt;!-- 1.扫描包的结构：com.cy.product --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">context:</span>component-scan</span> <span class="token attr-name">base-package</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.cy.product<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token comment">&lt;!-- 2.创建数据连接池对象 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.alibaba.druid.pool.DruidDataSource<span class="token punctuation">"</span></span> <span class="token attr-name">destroy-method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>close<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- &lt;property name="driverClassName" value="com.mysql.cj.jdbc.Driver" /&gt; --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>driverClassName<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.mysql.jdbc.Driver<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>url<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>jdbc:mysql://localhost:3306/zk_db?serverTimezone=GMT<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>username<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>root<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>password<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>123456<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>maxActive<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>10<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>minIdle<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 3.创建SqlSessionFactory对象，引入dataSource数据源对象 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sessionFactory<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.SqlSessionFactoryBean<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 指定数据源 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
        <span class="token comment">&lt;!-- 指定MyBatis核心配置文件的位置 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>configLocation<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>classpath:mybatis/mybatis-config.xml<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 4.告诉Spring容器，持久层操作的Mapper接口包结构位置，开始一个Mapper扫描 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.mybatis.spring.mapper.MapperScannerConfigurer<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>basePackage<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.cy.product.mapper<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 5.将数据源管理指定的事物管理器 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>bean</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>transactionManager<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>org.springframework.jdbc.datasource.DataSourceTransactionManager<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 将当前的事务管理器作用到指定的数据源对象上 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>property</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>dataSource<span class="token punctuation">"</span></span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>bean</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 6.开启事务 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span><span class="token namespace">tx:</span>annotation-driven</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>beans</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3.配置前端控制器：DispatcherServlet处理请求（spring核心配置文件的位置、编码）。</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>web-app</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd<span class="token punctuation">"</span></span>
         <span class="token attr-name">version</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>4.0<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>springMVC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-class</span><span class="token punctuation">&gt;</span></span>org.springframework.web.servlet.DispatcherServlet<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-class</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 在Servlet启动时，同时去加载Spring框架的核心配置文件 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>init-param</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-name</span><span class="token punctuation">&gt;</span></span>contextConfigLocation<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>param-value</span><span class="token punctuation">&gt;</span></span>classpath:spring/spring.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>param-value</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>init-param</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--配置一个启动的顺序，第一个被启动的Servlet组件 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>load-on-startup</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>async-supported</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>async-supported</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>servlet-name</span><span class="token punctuation">&gt;</span></span>springMVC<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-name</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 斜杠"/"当前前端控制器可以处理所有的请求 --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url-pattern</span><span class="token punctuation">&gt;</span></span>/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url-pattern</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>servlet-mapping</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>web-app</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h5><a id="535__1317"></a>5.3.5 功能的开发</h5> 
<p><strong>1.需求分析</strong></p> 
<p>1.模拟一个抢购功能。</p> 
<pre><code>update from product set stock = stock - 1 
</code></pre> 
<p>2.某个用户下单成功。</p> 
<pre><code>insert into `order` (id, pid, userid) values (?,?,?)
</code></pre> 
<p><strong>2.创建实体类</strong></p> 
<p>1.创建Product实体类。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 商品表的实体类
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> productName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> stock<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> version<span class="token punctuation">;</span>

    <span class="token comment">// toString、set、set、equals</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2.创建Order实体类。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 订单表实体类
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userid<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>3.Mapper层</strong></p> 
<p>1.创建ProductMapper接口。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Product</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Param</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Select</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Update</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Mapper</span> <span class="token comment">// 表示通过Mybatis提供的代理类，来实现该结构的</span>
<span class="token annotation punctuation">@Component</span> <span class="token comment">// 将该类对象交给Spring框架管理</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 1.查询查询该商品是否还有存库</span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from product where id=#{id}"</span><span class="token punctuation">)</span>
    <span class="token class-name">Product</span> <span class="token function">getProduct</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 2.减少商品存库数量的</span>
    <span class="token annotation punctuation">@Update</span><span class="token punctuation">(</span><span class="token string">"update product set stock = stock-1 where id=#{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token keyword">int</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2.创建OrderMapper接口。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>mapper</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Insert</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>ibatis<span class="token punctuation">.</span>annotations<span class="token punctuation">.</span></span><span class="token class-name">Mapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">OrderMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 生成订单</span>
    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into `order` (id, pid, userid) values (#{id}, #{pid}, #{userid})"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Order</span> order<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4.service层开发</strong></p> 
<p>1.创建一个ProductService接口。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ProductService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2.创建该接口的实现类ProductServiceImpl。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>service<span class="token punctuation">.</span>impl</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">OrderMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>mapper<span class="token punctuation">.</span></span><span class="token class-name">ProductMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Order</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Product</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ProductService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">UUID</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ProductService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductMapper</span> productMapper<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderMapper</span> orderMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.获取秒杀商品的信息（获取到了当前商品的库存数量）</span>
        <span class="token class-name">Product</span> product <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">getProduct</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// stock == 0</span>
        <span class="token comment">// 2.判断当前的商品是否库存数小于等于0</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>product<span class="token punctuation">.</span><span class="token function">getStock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 该商品已被抢光</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"该商品已被抢光！！！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 3.执行商品秒杀操作（商品库存数量-1）</span>
        <span class="token keyword">int</span> row <span class="token operator">=</span> productMapper<span class="token punctuation">.</span><span class="token function">reduceStock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>row <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 该用户抢到商品，商品的抢购信息新增订单表中</span>
            <span class="token class-name">Order</span> order <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Order</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token constant">UUID</span><span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setPid</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            order<span class="token punctuation">.</span><span class="token function">setUserid</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            orderMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"当前排队人数过多，请稍后重试！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>4.Controller层开发</strong></p> 
<p>创建一个类ProductController类，添加一个请求处理方法，根据商品的id执行商品秒杀抢购功能。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ProductService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span> <span class="token comment">// @Controller + @Response的组合注解</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductService</span> productService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/reduce"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        productService<span class="token punctuation">.</span><span class="token function">reduceStock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>5.功能测试</strong></p> 
<p>APIPost、Postmain等测试工具，来测试该接口的测试。</p> 
<p>1.将项目通过内嵌的Tomcat端口配置，来指定8001和8002端口，操作同一台数据，个时候就可能有请求的兵法问题。</p> 
<p>2.使用ApiPost测试工具，在指定的时间内容，发送多个请求，模拟出了请求并发。</p> 
<p>3.数据的商品库存数据被抢购到小于0的数字，这个是和业务的场景符，需要通过手动来解决该问题。</p> 
<h5><a id="536_Zookeeper_1510"></a>5.3.6 Zookeeper解决并发问题</h5> 
<p>Curator是基于Zookeeper原生的客户端类实现的一个中分布式并发问题的解决依赖。</p> 
<p>1.Curator引入该依赖。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.curator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>curator-recipes<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token comment">&lt;!-- 网友投票最牛逼版本 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<blockquote> 
 <p>在该依赖中包含有Zookeeper的相关技术。</p> 
</blockquote> 
<p>2.在控制层来控制分布式锁的使用。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>cy<span class="token punctuation">.</span>product<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">ProductService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span></span><span class="token class-name">RetryPolicy</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFramework</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span></span><span class="token class-name">CuratorFrameworkFactory</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessLock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>framework<span class="token punctuation">.</span>recipes<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">InterProcessMutex</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>curator<span class="token punctuation">.</span>retry<span class="token punctuation">.</span></span><span class="token class-name">ExponentialBackoffRetry</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span> <span class="token comment">// @Controller + @Response的组合注解</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProductController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductService</span> productService<span class="token punctuation">;</span>
    <span class="token comment">// 声明Zookeeper集群环境的IP</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span> connectionString <span class="token operator">=</span> <span class="token string">"192.168.230.131:2181,192.168.230.132:2181,192.168.230.133:2181"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/product/reduce"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">reduceStock</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 1.创建一个重试策略（重试3次，每次重试的时间间隔是1秒）</span>
        <span class="token comment">/**
         * 参数1：表示每一次重试的时间间隔
         * 参数2：表示重试多少次
         */</span>
        <span class="token class-name">RetryPolicy</span> retryPolicy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExponentialBackoffRetry</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.创建Curator对象（表示一个Zookeeper连接的工具对象）</span>
        <span class="token class-name">CuratorFramework</span> client <span class="token operator">=</span> <span class="token class-name">CuratorFrameworkFactory</span><span class="token punctuation">.</span><span class="token function">newClient</span><span class="token punctuation">(</span>connectionString<span class="token punctuation">,</span> retryPolicy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3.开启客户端：表示连接上集群</span>
        client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.根据client工具类创建一个"内部互斥锁"对象</span>
        <span class="token comment">/**
         * 参数1：表示目标客户端（client对象）
         * 参数2：表示这个锁在集群中的节点名称（要求唯一）
         */</span>
        <span class="token class-name">InterProcessMutex</span> lock <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">InterProcessMutex</span><span class="token punctuation">(</span>client<span class="token punctuation">,</span> <span class="token string">"/product_"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 5.开启锁（在目标方法指定之前开启锁）</span>
            lock<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            productService<span class="token punctuation">.</span><span class="token function">reduceStock</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 并发了调用该方法</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 6.释放锁（目标方法被调用，无论是否产生异常，理论上都应该将锁释放掉）</span>
            lock<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">"success"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3.测试：在指定的时间内容，通过ApiPost发送并发的请求，通过访问8001和8002端口，发现分布式锁的作用就生效。</p> 
<h3><a id="6_Zookeeper_1585"></a>6 Zookeeper总结</h3> 
<p>1.Zookeeper概念</p> 
<ul><li>Zookeeper原理</li><li>特点</li><li>数据结果</li><li>应用场景</li></ul> 
<p>2.Zookeeper的安装</p> 
<ul><li> <p>单台节点进行安装</p> </li><li> <p>myid - dataDir所指向的文件（zkData）</p> </li><li> <p>zoo.cfg：日志目录、数据目录、集群的IP环境</p> </li><li> <p>Zookeeper基本操作</p> </li></ul> 
<p>3.Zookeeper内部原理</p> 
<ul><li>选举策略：采用投票机制来进行，当半数以上的票如果投给了指定节点，这个节点就是主节点</li><li>节点类型：持久型、短暂型</li><li>监听器原理：如果被节点发生改变或者被监听的节点的子节点发生改变，回调process()。</li><li>写数据流程解析：子节点接收到请求后，将请求传递给主节点，主节点广播到所有的节点，所以的子节点执行写入数据操作。</li></ul> 
<p>4.Zookeeper集群搭建</p> 
<ul><li>zoo.cfg配置集群的IP群：server.1 = 192.168.230.131:2888:3888</li><li>myid给每一个节点分配一个编号（必须唯一）</li><li>克隆（修改IP地址）</li></ul> 
<p>5.Zookeeper实战</p> 
<ul><li>Zookeeper的API节点操作集群</li><li>模拟美团商家上下线的通知（商家服务端、点餐的客户端）</li><li>分布式商品秒杀：SSM框架搭建后台业务（库存-1）、Curator分布式锁API</li></ul> 
<h3><a id="_1622"></a>重点问题：</h3> 
<ol><li>zookeeper是什么？</li><li>zookeeper的选举机制是什么？</li><li>zookeeper的优点？（6个）</li><li>zookeeper的应用场景（5个）</li><li>zookeeper的监听原理？</li><li>zookeeper的写数据流程？</li><li>server.A=B:C:D; 中A？ B? C？ D?</li><li>zookeeper如何解决并发问题？</li><li>zookeeper实现分布式锁的原理？分布式锁的实现步骤？</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/30bbdcd244abe7ea8e7d3c7645e895c0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">解决PolyBase下dump文件夹不断增长占用大量C盘空间的问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/494ab6f2bd856044c55518ac19d1d7c8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">redis批量导入数据</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>