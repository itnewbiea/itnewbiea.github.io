<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PKCS12 证书的生成及验证 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PKCS12 证书的生成及验证" />
<meta property="og:description" content="本文首先感谢 Apple 开发者论坛的eskimo1，他是我见过的最热心肠的人，对任何人他都不吝于给予无私帮助。
服务器生成PKCS12证书库，并通过servlet导出为DER客户端证书（含一个密钥和一个证书）。iPhone从服务器下载证书后，如何进行验证？
一、 生成证书
假设密钥库为dlt.p12，库密码ipcc@95598，有效期1天，则命令为：
keytool -genkey -v -alias root -keyalg RSA -storetype PKCS12 -keystore dlt.p12 -dname &#34;CN=www.handtimes.com,OU=ipcc,O=云电同方,L=昆明,ST=云南,C=中国&#34; -storepass ipcc@95598 -keypass ipcc@95598
生成客户端用的证书：
keytool -genkey -v -alias p12client -keyalg RSA -storetype PKCS12 -keystore dlt.p12 -dname &#34;CN=www.handtimes.com,OU=ipcc,O=云电同方,L=昆明,ST=云南,C=中国&#34; -storepass ipcc@95598 -keypass 123456 -validity 1
要查看已生成的证书，用下面的命令：
keytool -list -v -alias p12client -keystore dlt.p12 -storepass ipcc@95598 -storetype PKCS12
或者：
keytool -list -v -keystore IPCCCA – dlt.p12 ipcc@95598 -storetype PKCS12
如果需要将p12证书导出为.cer格式，可以使用命令：
keytool -export -alias p12client -keystore dlt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/65b5ecf09520ad52819b7a3630a197cc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2014-04-08T17:11:38+08:00" />
<meta property="article:modified_time" content="2014-04-08T17:11:38+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PKCS12 证书的生成及验证</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="color:rgb(51,51,51)"><span style="color:rgb(255,0,0)">本文首先感谢 Apple 开发者论坛的eskimo1，他是我见过的最热心肠的人，对任何人他都不吝于给予无私帮助。</span></p> 
<p style="color:rgb(51,51,51)">服务器生成PKCS12证书库，并通过servlet导出为DER客户端证书（含一个密钥和一个证书）。iPhone从服务器下载证书后，如何进行验证？</p> 
<p style="color:rgb(51,51,51)">一、 生成证书</p> 
<p style="color:rgb(51,51,51)">假设密钥库为dlt.p12，库密码ipcc@95598，有效期1天，则命令为：</p> 
<p style="color:rgb(51,51,51)">keytool -genkey -v -alias root -keyalg RSA -storetype PKCS12 -keystore dlt.p12 -dname "CN=www.handtimes.com,OU=ipcc,O=云电同方,L=昆明,ST=云南,C=中国" -storepass ipcc@95598 -keypass ipcc@95598</p> 
<p style="color:rgb(51,51,51)">生成客户端用的证书：</p> 
<p style="color:rgb(51,51,51)">keytool -genkey -v -alias p12client -keyalg RSA -storetype PKCS12 -keystore dlt.p12 -dname "CN=www.handtimes.com,OU=ipcc,O=云电同方,L=昆明,ST=云南,C=中国" -storepass ipcc@95598 -keypass 123456 -validity 1</p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)">要查看已生成的证书，用下面的命令：</p> 
<p style="color:rgb(51,51,51)">keytool -list -v -alias p12client -keystore dlt.p12 -storepass ipcc@95598 -storetype PKCS12</p> 
<p style="color:rgb(51,51,51)">或者：</p> 
<p style="color:rgb(51,51,51)">keytool -list -v -keystore IPCCCA – dlt.p12 ipcc@95598 -storetype PKCS12</p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)">如果需要将p12证书导出为.cer格式，可以使用命令：</p> 
<p style="color:rgb(51,51,51)">keytool -export -alias p12client -keystore dlt.p12 -storetype PKCS12 -storepass ipcc@95598 -rfc -file p12.cer</p> 
<p style="color:rgb(51,51,51)">查看.cer文件：</p> 
<p style="color:rgb(51,51,51)">keytool -printcert -v -file /Users/kmyhy/Desktop/client.cer</p> 
<p style="color:rgb(51,51,51)">如果需要将keystore中的私钥导出为.p12格式：</p> 
<p style="color:rgb(51,51,51)">Keytool.exe -importkeystore -srckeystore IPCCCA -srcstoretype jks -srcstorepass ipcc@95598 -srcalias p12client  -destkeystore dltclient.p12 -deststoretype pkcs12 -deststorepass ipcc@95598 -destkeypass 123456 – validity 3</p> 
<p style="color:rgb(51,51,51)">注意，keytool用的是jdk1.6提供的版本。此时命令提示忽略用户输入的destkeypass密码：</p> 
<p style="color:rgb(51,51,51)"><img src="https://images2.imgbox.com/d0/f8/WwHjVgq9_o.gif" alt=""></p> 
<p style="color:rgb(51,51,51)">重新输入密码123456，回车，将在用户主目录下生成dltclient.p12文件。</p> 
<p style="color:rgb(51,51,51)"></p> 
<p style="color:rgb(51,51,51)">查看dltclient.p12内容：</p> 
<p style="color:rgb(51,51,51)">keytool.exe -list -keystore dltclient.p12 -storepass ipcc@95598 -storetype pkcs12</p> 
<p style="color:rgb(51,51,51)">可以看到如下输出：</p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)"><img src="https://images2.imgbox.com/e3/0c/RV9yOfyu_o.gif" alt=""></p> 
<p style="color:rgb(51,51,51)">可以看到其中包含了证书和私钥,并且其认证指纹是和IPCCCA中的一模一样的。</p> 
<p style="color:rgb(51,51,51)"></p> 
<p style="color:rgb(51,51,51)">一、 提供证书下载</p> 
<p style="color:rgb(51,51,51)">先把生成的p12证书库dlt.p12放到服务器目录下。</p> 
<p style="color:rgb(51,51,51)">新建一个Servlet：GetP12Cert。</p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">public</span> <span style="color:rgb(127,0,85)">class</span> </strong><span style="color:black">GetP12Cert </span><strong><span style="color:rgb(127,0,85)">extends</span> </strong><span style="color:black">HttpServlet {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">private</span> <span style="color:rgb(127,0,85)">static</span> <span style="color:rgb(127,0,85)">final</span> <span style="color:rgb(127,0,85)">long</span> </strong><em><span style="color:rgb(0,0,192)">serialVersionUID</span> </em><span style="color:black">= 1L;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">private</span> <span style="color:rgb(127,0,85)">static</span> <span style="color:rgb(127,0,85)">final</span> <span style="color:rgb(127,0,85)">int</span> </strong><em><span style="color:rgb(0,0,192)">max_days</span> </em><span style="color:black">=1;  </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(63,95,191)">/**</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">     * </span><strong><span style="color:rgb(127,159,191)">@see</span> </strong><span style="color:rgb(63,95,191)">HttpServlet#HttpServlet()</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">     */</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">GetP12Cert() {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><strong><span style="color:rgb(127,0,85)">super</span> </strong><span style="color:black">();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><span style="color:rgb(63,127,95)">// </span><strong><span style="color:rgb(127,159,191)">TODO</span> </strong><span style="color:rgb(63,127,95)">Auto-generated constructor stub</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    }</span></p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">/**</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">  * </span><strong><span style="color:rgb(127,159,191)">@see</span> </strong><span style="color:rgb(63,95,191)">HttpServlet#doGet(HttpServletRequest request, HttpServletResponse response)</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">  */</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">protected</span> <span style="color:rgb(127,0,85)">void</span> </strong><span style="color:black">doGet(HttpServletRequest request, HttpServletResponse response) </span><strong><span style="color:rgb(127,0,85)">throws</span></strong><span style="color:black">ServletException, IOException {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">String filename=</span> <span style="color:rgb(42,0,255)">"C://Documents and Settings//Administrator//dlt.cer"</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">String pass=</span> <span style="color:rgb(42,0,255)">"ipcc@95598"</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">Pkcs12Manager man=</span> <strong><span style="color:rgb(127,0,85)">null</span> </strong><span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">String alias=</span> <span style="color:rgb(42,0,255)">"p12client"</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">String keypass=</span> <span style="color:rgb(42,0,255)">"123456"</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">try</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">man=</span> <strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">Pkcs12Manager(</span> <strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">File(filename),pass);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">man.updateExpiration(alias, keypass,</span> <em><span style="color:rgb(0,0,192)">max_days</span> </em><span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">exportCert(man,alias,response);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// man.saveCert(alias, "123456");</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">//man.saveCert(alias, "123456");</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span> <strong><span style="color:rgb(127,0,85)">catch</span> </strong><span style="color:black">(Exception e){<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">e.printStackTrace();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">导出证书</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">private</span> <span style="color:rgb(127,0,85)">void</span> </strong><span style="color:black">exportCert(Pkcs12Manager man,String alias,HttpServletResponse response){<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">OutputStream out=</span> <strong><span style="color:rgb(127,0,85)">null</span> </strong><span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">try</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    Certificate cert = man.</span> <span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">.getCertificate(alias);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">得到证书内容（以编码过的格式）</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">byte</span> </strong><span style="color:black">[] buf = cert.getEncoded();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">写证书文件</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    response.setContentType(</span> <span style="color:rgb(42,0,255)">"application/x-download"</span> <span style="color:black">);  </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    response.addHeader(</span> <span style="color:rgb(42,0,255)">"Content-Disposition"</span> <span style="color:black">, </span><span style="color:rgb(42,0,255)">"attachment;filename="</span> <span style="color:black"> </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            + man.</span> <span style="color:rgb(0,0,192)">file</span> <span style="color:black">.getName());  </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    out= response.getOutputStream();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    out.write(buf);    </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">catch</span> </strong><span style="color:black">(Exception e){e.printStackTrace();}</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">finally</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">try</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">out.close();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span> <strong><span style="color:rgb(127,0,85)">catch</span> </strong><span style="color:black">(Exception e){<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">/**</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">  * </span><strong><span style="color:rgb(127,159,191)">@see</span> </strong><span style="color:rgb(63,95,191)">HttpServlet#doPost(HttpServletRequest request, HttpServletResponse response)</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,95,191)">  */</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">protected</span> <span style="color:rgb(127,0,85)">void</span> </strong><span style="color:black">doPost(HttpServletRequest request, HttpServletResponse response) </span><strong><span style="color:rgb(127,0,85)">throws</span></strong><span style="color:black">ServletException, IOException {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">doGet(request,response);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)">其中，Pkcs12Manager是一个javabean，提供了对PKCS12证书的读取、修改操作，代码如下：</p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">public</span> <span style="color:rgb(127,0,85)">class</span> </strong><span style="color:black">Pkcs12Manager {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">File </span><span style="color:rgb(0,0,192)">file</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">KeyStore </span><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">private</span> <span style="color:rgb(127,0,85)">char</span> </strong><span style="color:black">[] </span><span style="color:rgb(0,0,192)">storePass</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">Pkcs12Manager(File file, String pass) </span><strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">IOException, Exception {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><strong><span style="color:rgb(127,0,85)">this</span> </strong><span style="color:black">.</span> <span style="color:rgb(0,0,192)">file</span> <span style="color:black">= file;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><strong><span style="color:rgb(127,0,85)">this</span> </strong><span style="color:black">.</span> <span style="color:rgb(0,0,192)">storePass</span> <span style="color:black">=pass.toCharArray();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        getKeyStore();</span> <span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">加载</span> <span style="color:rgb(63,127,95)">KeyStore</span> <span style="color:rgb(63,127,95)">文件</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">加载</span> <span style="color:rgb(63,127,95)">KeyStore</span> <span style="color:rgb(63,127,95)">文件</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><strong><span style="color:rgb(127,0,85)">public</span> <span style="color:rgb(127,0,85)">synchronized</span> </strong><span style="color:black">KeyStore getKeyStore() </span><strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">IOException, Exception {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><strong><span style="color:rgb(127,0,85)">if</span> </strong><span style="color:black">(</span> <span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">== </span><strong><span style="color:rgb(127,0,85)">null</span> </strong><span style="color:black">) {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            FileInputStream fin = </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">FileInputStream(</span> <span style="color:rgb(0,0,192)">file</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            KeyStore store = KeyStore.<em>getInstance</em> (</span> <span style="color:rgb(42,0,255)">"PKCS12"</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            </span><strong><span style="color:rgb(127,0,85)">try</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">                store.load(fin,</span> <span style="color:rgb(0,0,192)">storePass</span> <span style="color:black">);               </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            </span><strong><span style="color:rgb(127,0,85)">finally</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">                </span><strong><span style="color:rgb(127,0,85)">try</span> </strong><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">                     fin.close();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">                } </span><strong><span style="color:rgb(127,0,85)">catch</span> </strong><span style="color:black">(IOException e) { }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">            </span><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">= store;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><strong><span style="color:rgb(127,0,85)">return</span> </strong><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">读取</span> <span style="color:rgb(63,127,95)">alias</span> <span style="color:rgb(63,127,95)">指定的证书内容</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">X509CertInfo getX509CertInfo(String alias)</span> <strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">Exception {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertImpl cimp=getX509CertImpl(alias);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">获取</span> <span style="color:rgb(63,127,95)">X509CertInfo</span> <span style="color:rgb(63,127,95)">对象</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">return</span> </strong><span style="color:black">(X509CertInfo) cimp.get(X509CertImpl.</span> <em><span style="color:rgb(0,0,192)">NAME</span></em></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">+ </span><span style="color:rgb(42,0,255)">"."</span> <span style="color:black">+ X509CertImpl.</span> <em><span style="color:rgb(0,0,192)">INFO</span> </em><span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">根据</span> <span style="color:rgb(63,127,95)">alias</span> <span style="color:rgb(63,127,95)">获取</span> <span style="color:rgb(63,127,95)">X509CertImpl</span> <span style="color:rgb(63,127,95)">对象</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">private</span> </strong><span style="color:black">X509CertImpl getX509CertImpl(String alias)</span> <strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">Exception{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">Certificate c = </span><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">.getCertificate(alias);</span> <span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">读取证书</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">从待签发的证书中提取证书信息　　</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">byte</span> </strong><span style="color:black">[] enc = c.getEncoded();</span> <span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">获取</span> <span style="color:rgb(63,127,95)">证书内容（经过编码的字节）</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertImpl cimp= </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">X509CertImpl(enc);</span> <span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">创建</span> <span style="color:rgb(63,127,95)">X509CertImpl</span> <span style="color:rgb(63,127,95)">象</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">return</span> </strong><span style="color:black">cimp;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">修改证书过期时间</span> <span style="color:rgb(63,127,95)">:</span> <span style="color:rgb(63,127,95)">过期时间顺延</span> <span style="color:rgb(63,127,95)">n</span> <span style="color:rgb(63,127,95)">天</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">public</span> <span style="color:rgb(127,0,85)">void</span> </strong><span style="color:black">updateExpiration(String alias,String keypass,</span> <strong><span style="color:rgb(127,0,85)">int</span> </strong><span style="color:black">n)</span> <strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">Exception{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">System.</span> <em><span style="color:rgb(0,0,192)">out</span> </em><span style="color:black">.println(getExpiration(alias));</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertInfo cinfo=getX509CertInfo(alias); </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">获取</span> <span style="color:rgb(63,127,95)">X509CertInfo</span> <span style="color:rgb(63,127,95)">对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertImpl cimp=getX509CertImpl(alias); </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">获取</span> <span style="color:rgb(63,127,95)">X509CertImpl</span> <span style="color:rgb(63,127,95)">对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">String sigAlgrithm=cimp.getSigAlgName(); </span><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">获取签名算法</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">CertificateValidity cv=(CertificateValidity)cinfo.get(X509CertInfo.</span> <em><span style="color:rgb(0,0,192)">VALIDITY</span> </em><span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">有效期为当前日期后延</span> <span style="color:rgb(63,127,95)">n</span> <span style="color:rgb(63,127,95)">天</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">Date d2 = </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">Date(</span> <strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">Date().getTime() + n * 24 * 60 * 60 * 1000L);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">System.</span> <em><span style="color:rgb(0,0,192)">out</span> </em><span style="color:black">.println(</span> <span style="color:rgb(42,0,255)">"new date:"</span> <span style="color:black">+d2.toString());</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">创建有效期对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">cv.set(CertificateValidity.</span> <em><span style="color:rgb(0,0,192)">NOT_AFTER</span> </em><span style="color:black">, d2);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">cinfo.set(X509CertInfo.</span> <em><span style="color:rgb(0,0,192)">VALIDITY</span> </em><span style="color:black">, cv);</span> <span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">设置有效期</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">saveCert(alias,keypass,cinfo,sigAlgrithm);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">System.</span> <em><span style="color:rgb(0,0,192)">out</span> </em><span style="color:black">.println(getExpiration(alias));</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">//  </span><span style="color:rgb(63,127,95)">读取证书过期时间</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">String getExpiration(String alias)</span> <strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">Exception{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertInfo cinfo=getX509CertInfo(alias);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">CertificateValidity cv=(CertificateValidity)cinfo.get(X509CertInfo.</span> <em><span style="color:rgb(0,0,192)">VALIDITY</span> </em><span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">创建有效期对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">Date d=(Date)cv.get(CertificateValidity.</span> <em><span style="color:rgb(0,0,192)">NOT_AFTER</span> </em><span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">return</span> </strong><span style="color:black">d.toString();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">//  </span><span style="color:rgb(63,127,95)">存储证书</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">private</span> <span style="color:rgb(127,0,85)">void</span> </strong><span style="color:black">saveCert(String alias,String keypass,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertInfo cinfo,String algrithm) </span><strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">Exception{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">从密钥库中读取</span> <span style="color:rgb(63,127,95)">CA</span> <span style="color:rgb(63,127,95)">的私钥</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">PrivateKey pKey = (PrivateKey) </span><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">.getKey(alias, keypass.toCharArray());</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertImpl cert = </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">X509CertImpl(cinfo);</span> <span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">新建证书</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">cert.sign(pKey, algrithm); </span><span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">使用</span> <span style="color:rgb(63,127,95)">CA</span> <span style="color:rgb(63,127,95)">私钥对其签名</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">获取别名对应条目的证书链</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">Certificate[] chain = </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">Certificate[] { cert };</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">向密钥库中添加条目</span> <span style="color:rgb(63,127,95)">,</span> <span style="color:rgb(63,127,95)">使用已存在别名将覆盖已存在条目</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">.setKeyEntry(alias, pKey, keypass.toCharArray(), chain);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">将</span> <span style="color:rgb(63,127,95)">keystore</span> <span style="color:rgb(63,127,95)">存储至文件</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">FileOutputStream fOut = </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">FileOutputStream(</span> <span style="color:rgb(0,0,192)">file</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">.store(fOut, </span><span style="color:rgb(0,0,192)">storePass</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">fOut.close();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">获取签名算法</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">public</span> </strong><span style="color:black">String getSigAlgName(String alias)</span> <strong><span style="color:rgb(127,0,85)">throws</span> </strong><span style="color:black">Exception{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">Certificate c = </span><span style="color:rgb(0,0,192)">keyStore</span> <span style="color:black">.getCertificate(alias);</span> <span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">读取证书</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// </span><span style="color:rgb(63,127,95)">获取</span> <span style="color:rgb(63,127,95)">证书内容（经过编码的字节）　　</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">byte</span> </strong><span style="color:black">[] enc = c.getEncoded();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">//</span> <span style="color:rgb(63,127,95)">创建</span> <span style="color:rgb(63,127,95)">X509CertImpl</span> <span style="color:rgb(63,127,95)">对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">X509CertImpl cimp2 = </span><strong><span style="color:rgb(127,0,85)">new</span> </strong><span style="color:black">X509CertImpl(enc);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">String sigAlgrithm=cimp2.getSigAlgName();</span></p> 
<p style="color:rgb(51,51,51)"><strong><span style="color:rgb(127,0,85)">return</span> </strong><span style="color:black">sigAlgrithm;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)">将上述Servlet 和javabean 部署到服务器中。这样，通过访问<a target="_blank" href="http://localhost/GetP12Cert" rel="nofollow noopener noreferrer" style="color:rgb(51,102,153)">http://localhost/GetP12Cert </a>就可以获得一个有效的证书dlt.cer。</p> 
<p style="color:rgb(51,51,51)">二、 证书的验证</p> 
<p style="color:rgb(51,51,51)">假设我们的客户端为iPhone客户端。则在iPhone中进行证书验证的代码为：</p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(92,38,153)">NSString</span> <span style="color:black">* path=[[</span> <span style="color:rgb(92,38,153)">NSBundle</span> <span style="color:rgb(46,13,110)">mainBundle</span> <span style="color:black">]</span> <span style="color:rgb(46,13,110)">pathForResource</span> <span style="color:black">:</span> <span style="color:rgb(196,26,22)">@"dlt.cer"</span> <span style="color:rgb(46,13,110)">ofType</span> <span style="color:black">:</span> <span style="color:rgb(170,13,145)">nil</span> <span style="color:black">];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,127,95)">// EfficientDate</span> <span style="color:rgb(63,127,95)">参数为任意一个有效的日期（在证书有效期之内）</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,110,116)">MyTrustService</span> <span style="color:black">* myTrust=[[</span> <span style="color:rgb(63,110,116)">MyTrustService</span> <span style="color:rgb(46,13,110)">alloc</span> <span style="color:black">]</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(38,71,75)">initWithFilename</span> <span style="color:black">:path </span><span style="color:rgb(38,71,75)">EfficientDate</span> <span style="color:black">:</span> <span style="color:rgb(196,26,22)">@"2011-05-10 0:0:0"</span> <span style="color:black">];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">ret=[myTrust </span><span style="color:rgb(38,71,75)">trustValuate</span> <span style="color:black">:[[</span> <span style="color:rgb(92,38,153)">NSDate</span> <span style="color:rgb(46,13,110)">alloc</span> <span style="color:black">]</span> <span style="color:rgb(46,13,110)">init</span> <span style="color:black">]];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">switch</span> <span style="color:black">(ret) {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">case</span> <span style="color:rgb(38,71,75)">ValuateResultOK</span> <span style="color:black">:</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(46,13,110)">NSLog</span> <span style="color:black">(</span> <span style="color:rgb(196,26,22)">@"</span> <span style="color:rgb(196,26,22)">证书有效</span> <span style="color:rgb(196,26,22)">"</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">break</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">case</span> <span style="color:rgb(38,71,75)">ValuateResultEXPIRED</span> <span style="color:black">:</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(46,13,110)">NSLog</span> <span style="color:black">(</span> <span style="color:rgb(196,26,22)">@"</span> <span style="color:rgb(196,26,22)">证书已过期</span> <span style="color:rgb(196,26,22)">"</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">break</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">default</span> <span style="color:black">:</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(46,13,110)">NSLog</span> <span style="color:black">(</span> <span style="color:rgb(196,26,22)">@"</span> <span style="color:rgb(196,26,22)">证书校验失败</span> <span style="color:rgb(196,26,22)">"</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">break</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">[myTrust </span><span style="color:rgb(46,13,110)">release</span> <span style="color:black">];</span></p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)">其中MyTrustService代码为（注意导入security.framework框架）：</p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(100,56,32)">#import </span><span style="color:rgb(196,26,22)">&lt;Foundation/Foundation.h&gt;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(100,56,32)">#import </span><span style="color:rgb(196,26,22)">&lt;Security/Security.h&gt;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">static</span> <span style="color:rgb(170,13,145)">const</span> <span style="color:rgb(170,13,145)">char</span> <span style="color:black">* </span><span style="color:rgb(63,110,116)">kTrustNames</span> <span style="color:black">[</span> <span style="color:rgb(28,0,207)">8</span> <span style="color:black">] = {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"Invalid"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"Proceed"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"Confirm"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"Deny"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"Unspecified"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"RecoverableTrustFailure"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"FatalTrustFailure"</span> <span style="color:black">,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(196,26,22)">"OtherError"</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">};</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">typedef</span> <span style="color:rgb(170,13,145)">enum</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(38,71,75)">ValuateResultINVALID</span> <span style="color:black">= </span><span style="color:rgb(28,0,207)">0</span> <span style="color:black">, </span><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">评估结果无效，表明评估出错或未经过评估</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(38,71,75)">ValuateResultFAILED</span> <span style="color:black">, </span><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">证书签名无效</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(38,71,75)">ValuateResultEXPIRED</span> <span style="color:black">, </span><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">证书过期</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(38,71,75)">ValuateResultOK</span> <span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">证书有效</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">} ValuateResult;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black"> </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">@interface</span> <span style="color:black">MyTrustService : NSObject {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(92,38,153)">NSString</span> <span style="color:black">*</span> <span style="color:rgb(63,110,116)">file</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(92,38,153)">NSDate</span> <span style="color:black">* </span><span style="color:rgb(63,110,116)">efficientDate</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(170,13,145)">id</span> <span style="color:black">)initWithFilename:(</span> <span style="color:rgb(92,38,153)">NSString</span> <span style="color:black">*)filename EfficientDate:(</span> <span style="color:rgb(92,38,153)">NSString</span> <span style="color:black">*)date;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">)trustValuate:(</span> <span style="color:rgb(92,38,153)">NSDate</span> <span style="color:black">*)date;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">)valuate:(</span> <span style="color:rgb(92,38,153)">SecCertificateRef</span> <span style="color:black">)cert Trust:(</span> <span style="color:rgb(92,38,153)">SecTrustRef</span> <span style="color:black">)trust Date:(</span> <span style="color:rgb(92,38,153)">NSDate</span><span style="color:black">*)date;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">@end</span></p> 
<p style="color:rgb(51,51,51)"> </p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(100,56,32)">#import </span><span style="color:rgb(196,26,22)">"MyTrustService.h"</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black"> </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black"> </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">@implementation</span> <span style="color:black">MyTrustService</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(170,13,145)">id</span> <span style="color:black">)initWithFilename:(</span> <span style="color:rgb(92,38,153)">NSString</span> <span style="color:black">*)filename EfficientDate:(</span> <span style="color:rgb(92,38,153)">NSString</span> <span style="color:black">*)date{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">if</span> <span style="color:black">(</span> <span style="color:rgb(170,13,145)">self</span> <span style="color:black">=[</span> <span style="color:rgb(170,13,145)">super</span> <span style="color:rgb(46,13,110)">init</span> <span style="color:black">]) {<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,110,116)">file</span> <span style="color:black">=filename;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">设置有效日期，注意，第</span> <span style="color:rgb(0,116,0)">2</span> <span style="color:rgb(0,116,0)">个参数是一个有效的证书日期，只要这个日期对证书而言是有效的就行</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,110,116)">efficientDate</span> <span style="color:black">=[[</span> <span style="color:rgb(92,38,153)">NSDate</span> <span style="color:rgb(46,13,110)">alloc</span> <span style="color:black">]</span> <span style="color:rgb(46,13,110)">initWithString</span> <span style="color:black">:date];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">return</span> <span style="color:rgb(170,13,145)">self</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">)trustValuate:(</span> <span style="color:rgb(92,38,153)">NSDate</span> <span style="color:black">*)date{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">ret;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(92,38,153)">OSStatus</span> <span style="color:black">            err;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(92,38,153)">NSData</span> <span style="color:black">*            certData;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(92,38,153)">SecCertificateRef</span> <span style="color:black">   cert;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(92,38,153)">SecPolicyRef</span> <span style="color:black">        policy;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(92,38,153)">SecTrustRef</span> <span style="color:black">         trust;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black"> </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(</span> <span style="color:rgb(63,110,116)">file</span> <span style="color:black">!= </span><span style="color:rgb(170,13,145)">nil</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(date != </span><span style="color:rgb(170,13,145)">nil</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">从文件获得</span> <span style="color:rgb(0,116,0)">DER </span><span style="color:rgb(0,116,0)">数据</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    certData = [</span> <span style="color:rgb(92,38,153)">NSData</span> <span style="color:rgb(46,13,110)">dataWithContentsOfFile</span> <span style="color:black">:</span> <span style="color:rgb(63,110,116)">file</span> <span style="color:black">];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(certData != </span><span style="color:rgb(170,13,145)">nil</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">从</span> <span style="color:rgb(0,116,0)">NSData </span><span style="color:rgb(0,116,0)">获得</span> <span style="color:rgb(0,116,0)">Certificate </span><span style="color:rgb(0,116,0)">对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    cert = </span><span style="color:rgb(46,13,110)">SecCertificateCreateWithData</span> <span style="color:black">(</span> <span style="color:rgb(170,13,145)">NULL</span> <span style="color:black">, (</span> <span style="color:rgb(92,38,153)">CFDataRef</span> <span style="color:black">) certData);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(cert != </span><span style="color:rgb(170,13,145)">NULL</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">获得</span> <span style="color:rgb(0,116,0)">x509 policy</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    policy = </span><span style="color:rgb(46,13,110)">SecPolicyCreateBasicX509</span> <span style="color:black">();</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(policy != </span><span style="color:rgb(170,13,145)">NULL</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">获得</span> <span style="color:rgb(0,116,0)">Trust </span><span style="color:rgb(0,116,0)">对象</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    err = </span><span style="color:rgb(46,13,110)">SecTrustCreateWithCertificates</span> <span style="color:black">(cert, policy, &amp;trust);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(err == </span><span style="color:rgb(46,13,110)">noErr</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">由于是自签名证书，需要将锚证书设置为要验证的证书自己。注意，这样将使所有除了参数指定的锚证书之外的所有锚证书无效</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    err = </span><span style="color:rgb(46,13,110)">SecTrustSetAnchorCertificates</span> <span style="color:black">(trust, (</span> <span style="color:rgb(92,38,153)">CFArrayRef</span> <span style="color:black">) [</span> <span style="color:rgb(92,38,153)">NSArray</span> <span style="color:rgb(46,13,110)">arrayWithObject</span> <span style="color:black">:(</span><span style="color:rgb(170,13,145)">id</span> <span style="color:black">) cert]);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(err == </span><span style="color:rgb(46,13,110)">noErr</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">调用</span> <span style="color:rgb(0,116,0)">valuate </span><span style="color:rgb(0,116,0)">方法进行评估</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">ret=[</span> <span style="color:rgb(170,13,145)">self</span> <span style="color:rgb(38,71,75)">valuate</span> <span style="color:black">:cert </span><span style="color:rgb(38,71,75)">Trust</span> <span style="color:black">:trust </span><span style="color:rgb(38,71,75)">Date</span> <span style="color:black">:date];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">评估结束，把</span> <span style="color:rgb(0,116,0)">SecTrustSetAnchorCertificates</span> <span style="color:rgb(0,116,0)">指定的锚证书失效，于是所有锚证书又可被信任了</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">   err=</span> <span style="color:rgb(46,13,110)">SecTrustSetAnchorCertificatesOnly</span> <span style="color:black">(trust,</span> <span style="color:rgb(170,13,145)">NO</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(46,13,110)">CFRelease</span> <span style="color:black">(trust);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(46,13,110)">CFRelease</span> <span style="color:black">(policy);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(46,13,110)">CFRelease</span> <span style="color:black">(cert);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">return</span> <span style="color:black">ret;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">)valuate:(</span> <span style="color:rgb(92,38,153)">SecCertificateRef</span> <span style="color:black">)cert Trust:(</span> <span style="color:rgb(92,38,153)">SecTrustRef</span> <span style="color:black">)trust Date:(</span> <span style="color:rgb(92,38,153)">NSDate</span><span style="color:black">*)date{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(63,110,116)">ValuateResult</span> <span style="color:black">ret;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(92,38,153)">OSStatus</span> <span style="color:black">            err;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(92,38,153)">SecTrustResultType</span> <span style="color:black">  result;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    err = </span><span style="color:rgb(46,13,110)">SecTrustSetVerifyDate</span> <span style="color:black">(trust, (</span> <span style="color:rgb(92,38,153)">CFDateRef</span> <span style="color:black">) date);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(err == </span><span style="color:rgb(46,13,110)">noErr</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(92,38,153)">CFAbsoluteTime</span> <span style="color:black">trustTime;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">trustTime = </span><span style="color:rgb(46,13,110)">SecTrustGetVerifyTime</span> <span style="color:black">(trust);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    err = </span><span style="color:rgb(46,13,110)">SecTrustEvaluate</span> <span style="color:black">(trust, &amp;result);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(err == </span><span style="color:rgb(46,13,110)">noErr</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    </span><span style="color:rgb(170,13,145)">if</span> <span style="color:black">(result &lt; (</span> <span style="color:rgb(170,13,145)">sizeof</span> <span style="color:black">(</span> <span style="color:rgb(63,110,116)">kTrustNames</span> <span style="color:black">) / </span><span style="color:rgb(170,13,145)">sizeof</span> <span style="color:black">(*</span> <span style="color:rgb(63,110,116)">kTrustNames</span> <span style="color:black">))) {<!-- --></span> <span style="color:rgb(0,116,0)">// if(result &lt; 8)</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><span style="color:rgb(170,13,145)">if</span> <span style="color:black">(result==</span> <span style="color:rgb(28,0,207)">5</span> <span style="color:black">) {<!-- --></span> <span style="color:rgb(0,116,0)">// if result=RecoverableTrustFailure</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">设了个有效的日期，进行再次评估</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">err=</span> <span style="color:rgb(46,13,110)">SecTrustSetVerifyDate</span> <span style="color:black">(trust, (</span> <span style="color:rgb(92,38,153)">CFDateRef</span> <span style="color:black">)</span> <span style="color:rgb(63,110,116)">efficientDate</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(err==</span> <span style="color:rgb(46,13,110)">noErr</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">err=</span> <span style="color:rgb(46,13,110)">SecTrustEvaluate</span> <span style="color:black">(trust, &amp;result);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(100,56,32)">assert</span> <span style="color:black">(err == </span><span style="color:rgb(46,13,110)">noErr</span> <span style="color:black">);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">if</span> <span style="color:black">(result==</span> <span style="color:rgb(28,0,207)">4</span> <span style="color:black">) {<!-- --></span> <span style="color:rgb(0,116,0)">// if result=Unspecified,</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">返回证书已过期，这里我们假设把证书尚未生效的情况也算作过期</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">ret= </span><span style="color:rgb(38,71,75)">ValuateResultEXPIRED</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span> <span style="color:rgb(170,13,145)">else</span> <span style="color:rgb(170,13,145)">if</span> <span style="color:black">(result==</span> <span style="color:rgb(28,0,207)">4</span> <span style="color:black">) {<!-- --></span> <span style="color:rgb(0,116,0)">// </span><span style="color:rgb(0,116,0)">如果第</span> <span style="color:rgb(0,116,0)">1</span> <span style="color:rgb(0,116,0)">次就通过评估，证书有效</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">ret=</span> <span style="color:rgb(38,71,75)">ValuateResultOK</span> <span style="color:black">;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span> <span style="color:rgb(170,13,145)">else</span> <span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">ret=</span> <span style="color:rgb(38,71,75)">ValuateResultFAILED</span> <span style="color:black">;</span> <span style="color:rgb(0,116,0)">//</span> <span style="color:rgb(0,116,0)">证书</span> <span style="color:rgb(0,116,0)">无效</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black"> </span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    } </span><span style="color:rgb(170,13,145)">else</span> <span style="color:black">{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">        </span><span style="color:rgb(46,13,110)">NSLog</span> <span style="color:black">(</span> <span style="color:rgb(196,26,22)">@"result = unknown (%zu)"</span> <span style="color:black">, (</span> <span style="color:rgb(92,38,153)">size_t</span> <span style="color:black">) result);</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">    }</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">return</span> <span style="color:black">ret;</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">-(</span> <span style="color:rgb(170,13,145)">void</span> <span style="color:black">)dealloc{<!-- --></span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">[</span> <span style="color:rgb(63,110,116)">efficientDate</span> <span style="color:rgb(46,13,110)">release</span> <span style="color:black">];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">[</span> <span style="color:rgb(170,13,145)">super</span> <span style="color:rgb(46,13,110)">dealloc</span> <span style="color:black">];</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:black">}</span></p> 
<p style="color:rgb(51,51,51)"><span style="color:rgb(170,13,145)">@end</span></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/44736eef681df6ea53794394b1551426/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[转]java变量,初始化快,构造函数的执行顺序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a5472388c2f35279e301524c90430452/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[转]Java模式(适配器模式)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>