<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手把手带你玩转k8s-健康检查之存活探针与就绪探针 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="手把手带你玩转k8s-健康检查之存活探针与就绪探针" />
<meta property="og:description" content="前言 经过前面的一系列文章，我们对k8s应该也算是简单的入门了。本文开始，会逐步开始讲解一些进阶的知识点。在前面的文章中，我们主要是围绕如何完整地发布一个可对外访问的服务。其中重点是以springboot&#43;vuejs前后端分离项目为主的。后续的文章也会是围绕springboot&#43;vuejs，不过会基于其扩展一些新的服务，如redis、rabbitmq、elk等。
关于健康检测 健康检查（Health Check）是让系统知道您的应用实例是否正常工作的简单方法。 如果您的应用实例不再工作，则其他服务不应访问该应用或向其发送请求。 相反，应该将请求发送到已准备好的应用程序实例，或稍后重试。 系统还应该能够使您的应用程序恢复健康状态。
默认情况下，当 Pod 中的所有容器启动时，Kubernetes 开始向 Pod 发送流量，并在崩溃时重新启动容器。如果Pod启动后就立即对外服务，其实是不太合理的。因为Pod启动成功并不代表容器里面部署的服务就能对外服务了，比如springboot项目，容器启动成功后，springboot启动需要一些初始化工作，真正要能对外访问，快则需要几秒，慢则需要十几、二十秒，甚至更久。 Kubernetes 在设计上已经考虑到了这点，它可以通过创建自定义运行状况检查来使部署更加健壮 。这里涉及到一个关键字：容器探针。
容器探针 探针是由 kubelet 对容器执行的定期诊断。要执行诊断，kubelet 调用由容器实现的 Handler。有三种类型的处理程序：
ExecAction：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。CPSocketAction：对指定端口上的容器的 IP 地址进行 TCP 检查。如果端口打开，则诊断被认为是成功的。HTTPGetAction：对指定的端口和路径上的容器的 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于200 且小于 400，则诊断被认为是成功的。 每次探测都将获得以下三种结果之一：
成功：容器通过了诊断。失败：容器未通过诊断。未知：诊断失败，因此不会采取任何行动。 Kubelet 可以选择是否执行在容器上运行的两种探针执行和做出反应：
livenessProbe(存活探针)：指示容器是否正在运行。如果存活探测失败，则 kubelet 会杀死容器，并且容器将受到其 重启策略的影响。如果容器不提供存活探针，则默认状态为 Success。readinessProbe(就绪探针)：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址。初始延迟之前的就绪状态默认为 Failure。如果容器不提供就绪探针，则默认状态为 Success。 高级 liveness 探针示例 探针的定义，也是k8s编排的重要内容。
apiVersion: apps/v1 kind: Deployment metadata: name: mldong-admin namespace: mldong-admin-test spec: selector: matchLabels: app: mldong-admin replicas: 1 template: metadata: labels: app: mldong-admin spec: containers: - name: mldong-admin env: - name: TZ value: Asia/Shanghai image: registry." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/634c7437209a32102d83054aa3ace4cb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-12T16:24:09+08:00" />
<meta property="article:modified_time" content="2021-05-12T16:24:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手把手带你玩转k8s-健康检查之存活探针与就绪探针</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>前言</h3> 
<p>经过前面的一系列文章，我们对k8s应该也算是简单的入门了。本文开始，会逐步开始讲解一些进阶的知识点。在前面的文章中，我们主要是围绕如何完整地发布一个可对外访问的服务。其中重点是以springboot+vuejs前后端分离项目为主的。后续的文章也会是围绕springboot+vuejs，不过会基于其扩展一些新的服务，如redis、rabbitmq、elk等。</p> 
<h3><a id="_4"></a>关于健康检测</h3> 
<blockquote> 
 <p>健康检查（Health Check）是让系统知道您的应用实例是否正常工作的简单方法。 如果您的应用实例不再工作，则其他服务不应访问该应用或向其发送请求。 相反，应该将请求发送到已准备好的应用程序实例，或稍后重试。 系统还应该能够使您的应用程序恢复健康状态。</p> 
</blockquote> 
<p>默认情况下，当 Pod 中的所有容器启动时，Kubernetes 开始向 Pod 发送流量，并在崩溃时重新启动容器。如果Pod启动后就立即对外服务，其实是不太合理的。因为Pod启动成功并不代表容器里面部署的服务就能对外服务了，比如springboot项目，容器启动成功后，springboot启动需要一些初始化工作，真正要能对外访问，快则需要几秒，慢则需要十几、二十秒，甚至更久。 Kubernetes 在设计上已经考虑到了这点，它可以通过创建自定义运行状况检查来使部署更加健壮 。这里涉及到一个关键字：<strong>容器探针</strong>。</p> 
<h4><a id="_10"></a>容器探针</h4> 
<p>探针是由 <code>kubelet</code> 对容器执行的定期诊断。要执行诊断，<code>kubelet</code> 调用由容器实现的 <code>Handler</code>。有三种类型的处理程序：</p> 
<ul><li><code>ExecAction</code>：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。</li><li><code>CPSocketAction</code>：对指定端口上的容器的 IP 地址进行 TCP 检查。如果端口打开，则诊断被认为是成功的。</li><li><code>HTTPGetAction</code>：对指定的端口和路径上的容器的 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于200 且小于 400，则诊断被认为是成功的。</li></ul> 
<p>每次探测都将获得以下三种结果之一：</p> 
<ul><li>成功：容器通过了诊断。</li><li>失败：容器未通过诊断。</li><li>未知：诊断失败，因此不会采取任何行动。</li></ul> 
<p>Kubelet 可以选择是否执行在容器上运行的两种探针执行和做出反应：</p> 
<ul><li><code>livenessProbe</code>(存活探针)：指示容器是否正在运行。如果存活探测失败，则 kubelet 会杀死容器，并且容器将受到其 重启策略的影响。如果容器不提供存活探针，则默认状态为 <code>Success</code>。</li><li><code>readinessProbe</code>(就绪探针)：指示容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与 Pod 匹配的所有 Service 的端点中删除该 Pod 的 IP 地址。初始延迟之前的就绪状态默认为 <code>Failure</code>。如果容器不提供就绪探针，则默认状态为 <code>Success</code>。</li></ul> 
<h4><a id="_liveness__29"></a>高级 liveness 探针示例</h4> 
<p>探针的定义，也是k8s编排的重要内容。</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>test
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>zhangjiakou.aliyuncs.com/mldong/java/mldong<span class="token punctuation">-</span>admin<span class="token punctuation">:</span>202007220017_c608761
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
              <span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
                <span class="token comment"># 当没有定义 "host" 时，使用 "PodIP"</span>
                <span class="token comment"># host: my-host</span>
                <span class="token comment"># 当没有定义 "scheme" 时，使用 "HTTP" scheme 只允许 "HTTP" 和 "HTTPS"</span>
                <span class="token comment"># scheme: HTTPS</span>
                <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz <span class="token comment"># 这要求服务得有这个接口地址</span>
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080     </span><span class="token comment"># 服务对应的端口</span>
                <span class="token key atrule">httpHeaders</span><span class="token punctuation">:</span>   <span class="token comment"># 可以携带请求头</span>
                <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> X<span class="token punctuation">-</span>Custom<span class="token punctuation">-</span>Header
                  <span class="token key atrule">value</span><span class="token punctuation">:</span> Awesome
              <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">30   </span><span class="token comment">#第一次健康检查的时间</span>
              <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5    </span><span class="token comment">#检查周期</span>
              <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5   </span><span class="token comment">#检查超时时间</span>
              <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#成功次数判定成功</span>
              <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#失败次数判定失败</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> port
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">]</span>
          <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"set -e &amp;&amp; java -jar app.jar --spring.profiles.active=test --server.port=8080"</span><span class="token punctuation">]</span>
</code></pre> 
<p>探针类型<code>livenessProbe</code>和<code>readinessProbe</code>，与容器定义的image同级，两者可同时存在，前者是定义存活探针， 健康状态检查，周期性检查服务是否存活，检查结果失败，将重启容器 。后者是定义就绪探针， 可用性检查，周期性检查服务是否可用，不可用将从service的endpoints中移除 。</p> 
<p>如上，定义了一个存活探针<code>livenessProbe</code>，其使用的<code>httpGet</code>的方式去检查的，请求路径为<code>/healthz</code>，端口为<code>8080</code>,请求头<code>httpHeaders</code>为<code>X-Custom-Header=Awesome</code>。第一次健康检查的时间<code>initialDelaySeconds</code>为pod启动后30s后进行检测；检查周期<code>periodSeconds</code>为5s；检查超时时间<code>timeoutSeconds</code>为5s；成功次数<code>successThreshold</code>为1判定成功；失败次数<code>failureThreshold</code>为1判定失败。</p> 
<p><strong>检查方式说明：</strong></p> 
<ul><li><code>httpGet</code> 检测某个 http 请求的返回状态码 2xx,3xx正常, 4xx,5xx错误</li></ul> 
<p>参数说明</p> 
<table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>host</td><td>当没有定义 “host” 时，使用 “PodIP”</td><td>请求域名</td></tr><tr><td>scheme</td><td>HTTP</td><td>只允许 “HTTP” 和 “HTTPS”</td></tr><tr><td>path</td><td>/</td><td>请求地址，这需要接口服务中有该请求地址</td></tr><tr><td>port</td><td>80</td><td>服务对应的端口</td></tr><tr><td>httpHeaders</td><td>无</td><td>请求头name/value</td></tr></tbody></table> 
<p>样例：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">httpGet</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /healthz
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">httpHeaders</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> X<span class="token punctuation">-</span>Custom<span class="token punctuation">-</span>Header
      <span class="token key atrule">value</span><span class="token punctuation">:</span> Awesome
</code></pre> 
<ul><li><code>exec</code> 执行一段命令 返回值为0, 非0</li></ul> 
<p>参数说明：</p> 
<table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>command</td><td></td><td>要执行的命令，数组</td></tr></tbody></table> 
<p>样例：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">exec</span><span class="token punctuation">:</span> <span class="token comment">#执行方式</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span>  <span class="token comment">#初始命令</span>
    <span class="token punctuation">-</span> cat
    <span class="token punctuation">-</span> /tmp/healthy
</code></pre> 
<ul><li><code>tcpSocket</code> 测试某个端口是否能够连接</li></ul> 
<p>参数说明：</p> 
<table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>port</td><td>80</td><td>端口</td></tr></tbody></table> 
<p>样例：</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
	<span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> 
<p><strong>检查规则说明</strong></p> 
<table><thead><tr><th>参数</th><th>默认值</th><th>说明</th></tr></thead><tbody><tr><td>initialDelaySeconds</td><td></td><td>第一次健康检查的时间，太小的话，可能会造成pod无限重启。</td></tr><tr><td>periodSeconds</td><td></td><td>检查周期</td></tr><tr><td>timeoutSeconds</td><td></td><td>检查超时时间</td></tr><tr><td>successThreshold</td><td>1</td><td>成功次数判断成功</td></tr><tr><td>failureThreshold</td><td>1</td><td>失败次数判断失败</td></tr></tbody></table> 
<h3><a id="_151"></a>实战演示</h3> 
<p>在实战前，先学习如下命令：</p> 
<p><code>for a in {1..10};do curl http://vueadmin.mldong.com/api/login;date +"%Y%m%d%H%M%S";sleep 2;done;</code></p> 
<p>每隔2秒钟进行一次接口访问，循环10次。</p> 
<p>效果图如下：</p> 
<p><img src="https://images2.imgbox.com/ac/42/XOqkYfzo_o.png" alt=""></p> 
<h4><a id="_163"></a>存活探针</h4> 
<ol><li>新建<code>v1.yaml</code></li></ol> 
<pre><code class="prism language-yaml">cat &lt;&lt; EOF <span class="token punctuation">&gt;</span> /mldong/k8s/mldong<span class="token punctuation">-</span>probe/v1.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>nodeport
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">-</span>vpc.cn<span class="token punctuation">-</span>zhangjiakou.aliyuncs.com/mldong/java/mldong<span class="token punctuation">-</span>admin<span class="token punctuation">:</span>202007220017_c608761
          <span class="token key atrule">livenessProbe</span><span class="token punctuation">:</span>
              <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080     </span><span class="token comment"># 服务对应的端口</span>
              <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15  </span><span class="token comment">#第一次健康检查的时间</span>
              <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5    </span><span class="token comment">#检查周期</span>
              <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5   </span><span class="token comment">#检查超时时间</span>
              <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#成功次数判定成功</span>
              <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#失败次数判定失败</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> port
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">]</span>
          <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"set -e &amp;&amp; java -jar app.jar --spring.profiles.active=test --server.port=8080"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> a.test.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
              <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
EOF
</code></pre> 
<p><img src="https://images2.imgbox.com/71/67/Eimyts8u_o.png" alt=""></p> 
<ol start="2"><li>另外开启一个终端，执行如下命令：</li></ol> 
<pre><code class="prism language-shell">kubectl get pods -A -w <span class="token operator">|</span> <span class="token function">grep</span> mldong-probe
</code></pre> 
<ol start="3"><li>旧终端执行如下命令：</li></ol> 
<pre><code class="prism language-shell">kubectl apply -f v1.yaml
</code></pre> 
<p>正常启动效果如下：</p> 
<p><img src="https://images2.imgbox.com/71/bd/d12wmi82_o.png" alt=""> 4. 删除重来</p> 
<pre><code class="prism language-shell">kubectl delete -f v1.yaml
</code></pre> 
<p>​ 修改成其他非服务端口</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8081</span>
</code></pre> 
<ol start="5"><li>重新运行</li></ol> 
<pre><code class="prism language-shell">kubectl apply -f v1.yaml
</code></pre> 
<p>效果如下：</p> 
<p><img src="https://images2.imgbox.com/79/51/pt1KnudC_o.png" alt=""></p> 
<p>其实就是监听的服务不存在，重启容器。</p> 
<p>最后清一下空间</p> 
<pre><code class="prism language-shell">kubectl delete -f v1.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/50/8d/iSuqNBhJ_o.png" alt=""></p> 
<h4><a id="_305"></a>就绪探针</h4> 
<ol><li> <p>新建<code>v2.yaml</code></p> <pre><code class="prism language-yaml">cat &lt;&lt; EOF <span class="token punctuation">&gt;</span> /mldong/k8s/mldong<span class="token punctuation">-</span>probe/v2.yaml
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Namespace
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>nodeport
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> NodePort
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Deployment
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">1</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
          <span class="token key atrule">env</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> TZ
              <span class="token key atrule">value</span><span class="token punctuation">:</span> Asia/Shanghai
          <span class="token key atrule">image</span><span class="token punctuation">:</span> registry<span class="token punctuation">-</span>vpc.cn<span class="token punctuation">-</span>zhangjiakou.aliyuncs.com/mldong/java/mldong<span class="token punctuation">-</span>admin<span class="token punctuation">:</span>202007220017_c608761
          <span class="token key atrule">readinessProbe</span><span class="token punctuation">:</span>
              <span class="token key atrule">tcpSocket</span><span class="token punctuation">:</span>
                <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080     </span><span class="token comment"># 服务对应的端口</span>
              <span class="token key atrule">initialDelaySeconds</span><span class="token punctuation">:</span> <span class="token number">15  </span><span class="token comment">#第一次健康检查的时间</span>
              <span class="token key atrule">periodSeconds</span><span class="token punctuation">:</span> <span class="token number">5    </span><span class="token comment">#检查周期</span>
              <span class="token key atrule">timeoutSeconds</span><span class="token punctuation">:</span> <span class="token number">5   </span><span class="token comment">#检查超时时间</span>
              <span class="token key atrule">successThreshold</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#成功次数判定成功</span>
              <span class="token key atrule">failureThreshold</span><span class="token punctuation">:</span> <span class="token number">1 </span><span class="token comment">#失败次数判定失败</span>
          <span class="token key atrule">imagePullPolicy</span><span class="token punctuation">:</span> IfNotPresent
          <span class="token key atrule">ports</span><span class="token punctuation">:</span>
            <span class="token punctuation">-</span> <span class="token key atrule">containerPort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
              <span class="token key atrule">name</span><span class="token punctuation">:</span> port
              <span class="token key atrule">protocol</span><span class="token punctuation">:</span> TCP
          <span class="token key atrule">command</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">]</span>
          <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"set -e &amp;&amp; java -jar app.jar --spring.profiles.active=test --server.port=8080"</span><span class="token punctuation">]</span>
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> extensions/v1beta1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Ingress
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">annotations</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin<span class="token punctuation">-</span>ingress
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>probe
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">host</span><span class="token punctuation">:</span> a.test.com
      <span class="token key atrule">http</span><span class="token punctuation">:</span>
        <span class="token key atrule">paths</span><span class="token punctuation">:</span>
          <span class="token punctuation">-</span> <span class="token key atrule">backend</span><span class="token punctuation">:</span>
              <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> mldong<span class="token punctuation">-</span>admin
              <span class="token key atrule">servicePort</span><span class="token punctuation">:</span> <span class="token number">8080</span>
            <span class="token key atrule">path</span><span class="token punctuation">:</span> /
EOF
</code></pre> </li><li> <p><code>/etc/hosts</code>新增一行，即1中配置的host</p> <p><img src="https://images2.imgbox.com/f6/c6/1UsTaozf_o.png" alt=""></p> </li><li> <p>另外开启一个终端，执行如下命令</p> <pre><code class="prism language-shell"><span class="token keyword">for</span> a <span class="token keyword">in</span> <span class="token punctuation">{<!-- --></span>1<span class="token punctuation">..</span>30<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token function">curl</span> http://a.test.com/api/login<span class="token punctuation">;</span><span class="token function">date</span> +<span class="token string">"%Y%m%d%H%M%S"</span><span class="token punctuation">;</span><span class="token function">sleep</span> 2<span class="token punctuation">;</span><span class="token keyword">done</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>旧终端执行如下命令</p> <pre><code class="prism language-shell">kubectl apply -f v2.yaml
</code></pre> <p>效果如下：</p> <p><img src="https://images2.imgbox.com/89/09/fR3hfPRB_o.png" alt=""></p> <p>开始服务不存在，访问的是nginx-ingress的默认服务。服务正常启动后，接口访问正常。这里只是演示单个服务启动的样例。其实在我们做系统版本升级的时候也是这样子的。比如现在服务版本1要升级到服务版本2，我们只需要修改一下镜像的版本，然后再执行<code>kubectl apply -f k8s.yaml</code>。这样新的服务版本就可以做到不停服更新了。</p> </li></ol> 
<p>最后清一下空间</p> 
<pre><code class="prism language-shell">kubectl delete -f v2.yaml
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/92/XCVJ5vmx_o.png" alt=""></p> 
<h3><a id="_429"></a>项目源码地址</h3> 
<ul><li>后端</li></ul> 
<p>https://gitee.com/mldong/mldong</p> 
<ul><li>前端</li></ul> 
<p>https://gitee.com/mldong/mldong-vue</p> 
<h3><a id="_439"></a>小结</h3> 
<p>本文简单介绍了k8s的健康检查-存活探针与就绪探针，并简单地做了一下案例演示。使用存活探针与就绪探针的目的都是为了让我们的服务更健壮。大家可以根据自身服务的情况去选择使用哪一种类型的探针和检查方式。据说Spring Boot 2.3提供K8s活性和就绪性探针，感兴趣的同学可以去了解一下。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b0f617aa04ebd474afdfeb42cf1b7cd3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux救援模式应用,Linux系统救援模式的简单介绍及应用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ec961316a5c0f7269535d2150b95da23/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">opencv——图像遍历以及像素操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>