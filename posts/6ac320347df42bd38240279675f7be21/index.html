<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C#动态生成带参数的小程序二维码 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C#动态生成带参数的小程序二维码" />
<meta property="og:description" content="应用场景 在微信小程序管理后台，我们可以生成下载标准的小程序二维码，提供主程序入口功能。在实际应用开发中，小程序二维码是可以携带参数的，可以动态进行生成，如如下场景：
1、不同参数决定的显示界面不同。
2、不同参数决定的功能不同。
3、由于小程序审核机制，我们将不同的应用集成在一个小程序里，通过不同的参数进行入口控制。
关键代码 操作界面 我们以一种验证、绑定手机的小程序功能为例，该小程序可以生成动态校验码，以实现实际业务应用的其它场景。界面中我们设计了提示信息Label，生成按钮 Button 和扫码图片 Image 等Asp.net控件。
示例界面如下，通过点击按钮，动态生成二维码图片，该参数将引导用户进入动态码生成功能：
​​ 示例UI代码如下：
&lt;div class=&#34;user-box&#34;&gt; &lt;span&gt;验证手机&lt;/span&gt;&lt;br&gt; &lt;br&gt; &lt;div class=&#34;query-box&#34;&gt; &lt;label&gt; 扫描二维码获取动态校验码&lt;/label&gt; &lt;br&gt; &lt;label&gt; 建议您PC注册,如果微信,可常按并选择前往图中包含的小程序打开(某些手机系统可能不支持此操作)&lt;/label&gt;&lt;/div&gt; &lt;br&gt; &lt;br&gt; &lt;asp:Button ID=&#34;createCode&#34; Text=&#34;新注册或换手机号点这里生成以获取动态校验码&#34; Visible=&#34;true&#34; CssClass=&#34;form-control&#34; runat=&#34;server&#34; OnClick=&#34;createCode_Click&#34;&gt;&lt;/asp:Button&gt; &lt;/div&gt; &lt;div class=&#34;user-box&#34; id=&#34;ecodepanel&#34; align=&#34;center&#34; visible=&#34;false&#34; runat=&#34;server&#34;&gt; &lt;br /&gt; &lt;asp:Image ID=&#34;ecode&#34; Width=&#34;200px&#34; Height=&#34;200px&#34; Visible=&#34;false&#34; runat=&#34;server&#34;&gt;&lt;/asp:Image&gt; &lt;br&gt; &lt;span style=&#39;color: silver&#39;&gt;&lt;/span&gt; &lt;br&gt; &lt;br&gt; &lt;/div&gt; 服务端点击事件 点击按钮，通过设置参数值，并访问腾讯API，生成小程序二维码，转换为图片BASE64编码，如果生成成功则显示在Image控件里，点击事件的，示例代码如下：
protected void createCode_Click(object sender, EventArgs e) { string paras = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6ac320347df42bd38240279675f7be21/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-16T10:26:02+08:00" />
<meta property="article:modified_time" content="2023-12-16T10:26:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C#动态生成带参数的小程序二维码</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong> </strong></p> 
<h3 id="%E9%9C%80%E6%B1%82">应用场景</h3> 
<p>在微信小程序管理后台，我们可以生成下载标准的小程序二维码，提供主程序入口功能。在实际应用开发中，小程序二维码是可以携带参数的，可以动态进行生成，如如下场景：</p> 
<p>1、不同参数决定的显示界面不同。</p> 
<p>2、不同参数决定的功能不同。</p> 
<p>3、由于小程序审核机制，我们将不同的应用集成在一个小程序里，通过不同的参数进行入口控制。</p> 
<p></p> 
<h3 id="%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81">关键代码</h3> 
<h4 id="%E7%95%8C%E9%9D%A2%E5%85%83%E7%B4%A0%E5%B8%83%E5%B1%80">操作界面</h4> 
<p>我们以一种验证、绑定手机的小程序功能为例，该小程序可以生成动态校验码，以实现实际业务应用的其它场景。界面中我们设计了提示信息Label，生成按钮 Button 和扫码图片 Image 等Asp.net控件。</p> 
<p>示例界面如下，通过点击按钮，动态生成二维码图片，该参数将引导用户进入动态码生成功能：</p> 
<h4 id="%E2%80%8B%E7%BC%96%E8%BE%91"><img alt="" height="939" src="https://images2.imgbox.com/67/ac/aoYEQpcA_o.png" width="1059">​​</h4> 
<p>示例UI代码如下：</p> 
<p></p> 
<pre><code class="language-cs">&lt;div class="user-box"&gt;
            &lt;span&gt;验证手机&lt;/span&gt;&lt;br&gt;
            &lt;br&gt;
            &lt;div class="query-box"&gt;
                &lt;label&gt;
                    扫描二维码获取动态校验码&lt;/label&gt;
                &lt;br&gt;
                &lt;label&gt;
                    建议您PC注册,如果微信,可常按并选择前往图中包含的小程序打开(某些手机系统可能不支持此操作)&lt;/label&gt;&lt;/div&gt;
            &lt;br&gt;
            &lt;br&gt;
            &lt;asp:Button ID="createCode" Text="新注册或换手机号点这里生成以获取动态校验码" Visible="true" CssClass="form-control"
                runat="server" OnClick="createCode_Click"&gt;&lt;/asp:Button&gt;
        &lt;/div&gt;
        &lt;div class="user-box" id="ecodepanel" align="center" visible="false" runat="server"&gt;
            &lt;br /&gt;
            &lt;asp:Image ID="ecode" Width="200px" Height="200px" Visible="false" runat="server"&gt;&lt;/asp:Image&gt;
            &lt;br&gt;
            &lt;span style='color: silver'&gt;&lt;/span&gt;
            &lt;br&gt;
            &lt;br&gt;
        &lt;/div&gt;</code></pre> 
<p></p> 
<h4 id="API%E5%AE%9E%E7%8E%B0">服务端点击事件</h4> 
<p>点击按钮，通过设置参数值，并访问腾讯API，生成小程序二维码，转换为图片BASE64编码，如果生成成功则显示在Image控件里，点击事件的，示例代码如下：</p> 
<pre><code class="language-cs">protected void createCode_Click(object sender, EventArgs e)
    {
        string paras = "reqvmobile";    //参数值设置
                //可以更改小程序二维码的色系
        int r = 4;
        int g = 128;
        int b = 188;
        ecode.ImageUrl = getBase64(255, r, g, b);   //将生成成功的BASE64编码赋值给Image控件
        ecode.Visible = true;
        ecodepanel.Visible = true;
    }
    //获取小程序二维码图片的 Base64值 
    string getBase64(string paras, int width, int linecolor_R, int linecolor_G, int linecolor_B)
    {
        string desimg = Request.PhysicalApplicationPath + "\\app_data\\" + System.Guid.NewGuid().ToString() + ".jpg";  //目标图片临时路径
                //生成二维码图片文件
        System.IO.File.WriteAllBytes(desimg, getMpBuffer(wxmp_accesstoken, paras, width, linecolor_R, linecolor_G, linecolor_B));
        string base64 = ImgToBase64String(desimg, true);
        System.IO.File.Delete(desimg);  //删除临时文件
        return base64;
    }

//图片转BASE64方法
public string ImgToBase64String(string Imagefilename,bool outFullString=false)
            {
                try
                {
                    System.Drawing.Bitmap bmp = new System.Drawing.Bitmap(Imagefilename);

                    MemoryStream ms = new MemoryStream();
                    //            bmp.Save(ms,ImageFormat.Jpeg)
                    System.Drawing.Imaging.ImageFormat iformat = System.Drawing.Imaging.ImageFormat.Jpeg;
                    string extension = System.IO.Path.GetExtension(Imagefilename).Replace(".", "").ToLower();
                    if (extension == "bmp")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Bmp;
                    }
                    else if (extension == "emf")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Emf;
                    }
                    else if (extension == "exif")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Exif;
                    }
                    else if (extension == "gif")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Gif;
                    }
                    else if (extension == "icon")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Icon;
                    }
                    else if (extension == "png")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Png;
                    }
                    else if (extension == "tiff")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Tiff;
                    }
                    else if (extension == "wmf")
                    {
                        iformat = System.Drawing.Imaging.ImageFormat.Wmf;
                    }

                    bmp.Save(ms, iformat);
                    byte[] arr = new byte[ms.Length];
                    ms.Position = 0;
                    ms.Read(arr, 0, (int)ms.Length);
                    ms.Close();
                    bmp.Dispose();
                    string rv=Convert.ToBase64String(arr);
                    if (outFullString == true)
                    {
                        rv = "data:image/" + extension + ";base64," + rv;
                    }
                    return rv;
                }
                catch (Exception ex)
                {
                    return null;
                }
            }</code></pre> 
<p> </p> 
<h4>生成小程序二维码</h4> 
<p>getMpBuffer(wxmp_accesstoken, paras, width, linecolor_R, linecolor_G, linecolor_B)方法返回byte[]类型，参数需要传递通过小程序Appid和AppSecret生成的合法令牌值；动态参数值；图像宽度；R/G/B的色系值。</p> 
<p>方法代码如下：</p> 
<div> 
 <pre><code class="language-cs">public byte[] getMpBuffer(string access_token, string scene, int width, int linecolor_R, int linecolor_G, int linecolor_B)
        {
            var url = string.Format("https://api.weixin.qq.com/wxa/getwxacodeunlimit?access_token={0}", access_token);
            var postData = "{\"scene\":\"" + scene + "\",\"width\":" + width.ToString() + ",\"line_color\":{\"r\":" + linecolor_R.ToString() + ",\"g\":" + linecolor_G.ToString() + ",\"b\":" + linecolor_B.ToString() + "}}";
            
            System.Net.HttpWebRequest request;
            request = (System.Net.HttpWebRequest)WebRequest.Create(url);
            request.Method = "POST";
            request.ContentType = "application/json;charset=UTF-8";
            byte[] payload;
            payload = System.Text.Encoding.UTF8.GetBytes(postData);
            request.ContentLength = payload.Length;
            Stream writer = request.GetRequestStream();
            writer.Write(payload, 0, payload.Length);
            writer.Close();
            System.Net.HttpWebResponse response;
            response = (System.Net.HttpWebResponse)request.GetResponse();
            System.IO.Stream stream;
            stream = response.GetResponseStream();
            List&lt;byte&gt; bytes = new List&lt;byte&gt;();
            int temp = stream.ReadByte();
            while (temp != -1)
            {
                bytes.Add((byte)temp);
                temp = stream.ReadByte();
            }
            byte[] result = bytes.ToArray();
            return result;
        }</code></pre> 
</div> 
<h4 id="%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%B8%8A%E4%BC%A0%E5%90%8E%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"></h4> 
<h3 id="%E5%B0%8F%E7%BB%93">小结</h3> 
<p>最初我们设计的目标是用小程序实现一对一视频面试的功能，对于查询出来的记录，为考生和考官生成不同带参数的小程序二维码，并进入不同的功能。后来由于集成了一些相关的功能应用，通过动态参数以决定不同的入口，以避免申请过多的小程序应用，达到降低费用成本、维护成本的目的。</p> 
<p></p> 
<p>以上就是自己的一些分享，时间仓促，不妥之处还请大家批评指正！</p> 
<h4></h4> 
<h4></h4> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc5f7ba07e7fa8589943bb9623a01f79/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SaaS行业分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bfd1e3492997bc375397313096a21227/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用ps修改图片大小不影响清晰度的方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>