<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hive中行列转换详解 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hive中行列转换详解" />
<meta property="og:description" content="Hive中行列转换详解 1 行转列 1.1 多行转多列 数据表 row2col col1 col2 col3 a c 1 a d 2 a e 3 b c 4 b d 5 b e 6 现在要将其转化为： col1 c d e a 1 2 3 b 4 5 6 此时需要使用到max(case … when … then … else 0 end)，仅限于转化的字段为数值类型且为正值的情况 创建表：
create table row2col(col1 string,col2 string,col3 int) row format delimited fields terminated by &#39;,&#39;; 加载数据：
load data local inpath &#39;/root/hivedata/row2col." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/90c619b3dbe372a813896e28bb559db7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-06-24T11:00:35+08:00" />
<meta property="article:modified_time" content="2020-06-24T11:00:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hive中行列转换详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="Hive_0"></a>Hive中行列转换详解</h2> 
<hr> 
<h3><a id="1__4"></a>1 行转列</h3> 
<h4><a id="11__6"></a><mark>1.1 多行转多列</mark></h4> 
<pre><code class="prism language-shell">数据表 row2col

col1   col2    col3
a      c       1
a      d       2
a      e       3  
b      c       4
b      d       5
b      e       6

现在要将其转化为：
col1   c      d      e
a      1      2      3
b      4      5      6

此时需要使用到max<span class="token punctuation">(</span>case … when … <span class="token keyword">then</span> … <span class="token keyword">else</span> 0 end<span class="token punctuation">)</span>，仅限于转化的字段为数值类型且为正值的情况
</code></pre> 
<p>创建表：</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> row2col<span class="token punctuation">(</span>col1 string<span class="token punctuation">,</span>col2 string<span class="token punctuation">,</span>col3 <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<p>加载数据：</p> 
<pre><code class="prism language-sql"><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">'/root/hivedata/row2col.txt'</span> <span class="token keyword">into</span> <span class="token keyword">table</span> row2col<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-shell">a,c,1
a,d,2
a,e,3
b,c,4
b,d,5
b,e,6
</code></pre> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> col1<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> col2 <span class="token keyword">when</span> <span class="token string">'c'</span> <span class="token keyword">then</span> col3 <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> c<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> col2 <span class="token keyword">when</span> <span class="token string">'d'</span> <span class="token keyword">then</span> col3 <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> d<span class="token punctuation">,</span>
<span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">case</span> col2 <span class="token keyword">when</span> <span class="token string">'e'</span> <span class="token keyword">then</span> col3 <span class="token keyword">else</span> <span class="token number">0</span> <span class="token keyword">end</span><span class="token punctuation">)</span> <span class="token keyword">as</span> e
<span class="token keyword">from</span> row2col
<span class="token keyword">group</span> <span class="token keyword">by</span> col1<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="12__59"></a>1.2 <mark>多行转单列</mark>(重要)</h4> 
<p>需求</p> 
<pre><code class="prism language-shell">数据表 row2col_1
col1    col2    col3
a       b       1
a       b       2
a       b       3
c       d       4
c       d       5
c       d       6

将其转化为:
col1    col2    col3
a       b       1-2-3
c       d       4-5-6
</code></pre> 
<p>此时需要两个内置的函数：</p> 
<table><thead><tr><th><mark>concat_ws(参数1，参数2)</mark></th><th>用于进行字符的拼接</th><th>参数1—指定分隔符 <br>参数2—拼接的内容</th></tr></thead><tbody><tr><td><mark>collect_set(col3)</mark></td><td>它的主要作用是将某字段的值进行去重汇总</td><td>产生array类型字段<br>如果不想去重可用<mark>collect_list()</mark></td></tr></tbody></table> 
<p>创建原始表：</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> row2col_1<span class="token punctuation">(</span>col1 string<span class="token punctuation">,</span>col2 string<span class="token punctuation">,</span>col3 <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>
</code></pre> 
<p>加载数据：</p> 
<pre><code class="prism language-shell">load data local inpath <span class="token string">'/root/hivedata/row2col_1.txt'</span> into table row2col_1<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-shell">a	b	1
a	b	2
a	b	3
c	d	4
c	d	5
c	d	6
</code></pre> 
<p>思路</p> 
<pre><code class="prism language-shell">--需要一个收集多行数据的这么一个函数
		collect_set<span class="token punctuation">(</span>col3<span class="token punctuation">)</span>，它的主要作用是将某字段的值进行去重汇总，产生 array 类
		型字段，如果不想去重可用 collect_list<span class="token punctuation">(</span><span class="token punctuation">)</span>。--set（去重）  list（重复）
	
--需要一个把收集的数据进行拼接函数
		concat<span class="token punctuation">(</span>字段<span class="token punctuation">..</span>.<span class="token punctuation">)</span>  栗子：select concat<span class="token punctuation">(</span><span class="token string">"wang"</span>,<span class="token string">"jie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		concat_ws<span class="token punctuation">(</span>参数 1，参数 2<span class="token punctuation">)</span>，用于进行字符的拼接
                参数 1—指定分隔符
                参数 2—拼接的内容 必须是String 或者是Array<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span>
</code></pre> 
<pre><code class="prism language-sql"><span class="token comment">--具体实现</span>
<span class="token keyword">select</span> collect_set<span class="token punctuation">(</span>col3<span class="token punctuation">)</span> <span class="token keyword">from</span> row2col_1<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------------+--+</span>
<span class="token operator">|</span>      _c0       <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+--+</span>
<span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------------+--+</span>

<span class="token comment">--先分组再收集</span>
<span class="token keyword">select</span> collect_set<span class="token punctuation">(</span>col3<span class="token punctuation">)</span> <span class="token keyword">from</span> row2col_1 <span class="token keyword">group</span> <span class="token keyword">by</span> col1<span class="token punctuation">,</span>col2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">----------+--+</span>
<span class="token operator">|</span>   _c0    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+--+</span>
<span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span>  <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">]</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">----------+--+</span>

<span class="token keyword">select</span> concat_ws<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>col3<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> row2col_1 <span class="token keyword">group</span> <span class="token keyword">by</span> col1<span class="token punctuation">,</span>col2<span class="token punctuation">;</span>
<span class="token comment">--执行报错</span>
 Argument <span class="token number">2</span> <span class="token keyword">of</span> <span class="token keyword">function</span> CONCAT_WS must be <span class="token string">"string or array&lt;string&gt;"</span><span class="token punctuation">,</span> but <span class="token string">"array&lt;int&gt;"</span> was found<span class="token punctuation">.</span>
 
<span class="token comment">--hive中如何实现类型转换呢？ hive内置了一个函数cast 专门用于类型转换</span>
<span class="token keyword">select</span> cast<span class="token punctuation">(</span><span class="token number">3</span> <span class="token keyword">as</span> <span class="token keyword">double</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">--最终sql如下</span>
<span class="token keyword">select</span> col1<span class="token punctuation">,</span>col2<span class="token punctuation">,</span>concat_ws<span class="token punctuation">(</span><span class="token string">"-"</span><span class="token punctuation">,</span>collect_set<span class="token punctuation">(</span>cast<span class="token punctuation">(</span>col3 <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> row2col_1 <span class="token keyword">group</span> <span class="token keyword">by</span> col1<span class="token punctuation">,</span>col2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-------+-------+--------+--+</span>
<span class="token operator">|</span> col1  <span class="token operator">|</span> col2  <span class="token operator">|</span>  _c2   <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------+--------+--+</span>
<span class="token operator">|</span> a     <span class="token operator">|</span> b     <span class="token operator">|</span> <span class="token number">1</span><span class="token operator">-</span><span class="token number">2</span><span class="token operator">-</span><span class="token number">3</span>  <span class="token operator">|</span>
<span class="token operator">|</span> c     <span class="token operator">|</span> d     <span class="token operator">|</span> <span class="token number">4</span><span class="token operator">-</span><span class="token number">5</span><span class="token operator">-</span><span class="token number">6</span>  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-------+-------+--------+--+</span>
</code></pre> 
<h3><a id="2__160"></a>2 列转行</h3> 
<h4><a id="21__162"></a>2.1 <mark>多列转多行</mark></h4> 
<p>数据表 col2row：</p> 
<pre><code>col1   c      d      e
a      1      2      3
b      4      5      6
</code></pre> 
<p>现要将其转化为：</p> 
<pre><code class="prism language-shell">  col1   col2    col3
  a      c       1
  a      d       2
  a      e       3
  b      c       4
  b      d       5
  b      e       6
</code></pre> 
<p>这里需要使用union进行拼接。<br> union 可以结合多个select语句 返回共同的结果集<br> 保证每个select语句返回的数据类型个数是一致的。</p> 
<p>创建表：</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> col2row<span class="token punctuation">(</span>col1 string<span class="token punctuation">,</span>c <span class="token keyword">int</span><span class="token punctuation">,</span>d <span class="token keyword">int</span><span class="token punctuation">,</span>e <span class="token keyword">int</span><span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">','</span><span class="token punctuation">;</span>
</code></pre> 
<p>加载数据：</p> 
<pre><code class="prism language-shell">load data local inpath <span class="token string">'/root/hivedata/col2row.txt'</span> into table col2row<span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-java">  a<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span>
  b<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span>
</code></pre> 
<pre><code class="prism language-java">select col1<span class="token punctuation">,</span> <span class="token string">'c'</span> as col2<span class="token punctuation">,</span> c as col3 from col2row
UNION
select col1<span class="token punctuation">,</span> <span class="token string">'d'</span> as col2<span class="token punctuation">,</span> d as col3 from col2row
UNION
select col1<span class="token punctuation">,</span> <span class="token string">'e'</span> as col2<span class="token punctuation">,</span> e as col3 from col2row
order by col1<span class="token punctuation">,</span> col2<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="22__215"></a>2.2 <mark>单列转多行（重要）</mark></h4> 
<p>需求</p> 
<pre><code>数据表 col2row_2
col1    col2    col3
a       b       1,2,3
c       d       4,5,6
</code></pre> 
<p>现要将其转化为：</p> 
<pre><code>  col1    col2    col3
  a       b       1
  a       b       2
  a       b       3
  c       d       4
  c       d       5
  c       d       6
</code></pre> 
<blockquote> 
 <p>这里需要使用UDTF（表生成函数）explode()，该函数接受array类型的参数，其作用恰好与collect_set相反，实现将array类型数据行转列。explode配合lateral view实现将某列数据拆分成多行。</p> 
</blockquote> 
<pre><code class="prism language-sql">数据表 col2row_2：
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-----------------+--+</span>
<span class="token operator">|</span> col2row_2<span class="token punctuation">.</span>col1  <span class="token operator">|</span> col2row_2<span class="token punctuation">.</span>col2  <span class="token operator">|</span> col2row_2<span class="token punctuation">.</span>col3  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-----------------+--+</span>
<span class="token operator">|</span> a               <span class="token operator">|</span> b               <span class="token operator">|</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span>           <span class="token operator">|</span>
<span class="token operator">|</span> c               <span class="token operator">|</span> d               <span class="token operator">|</span> <span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span>           <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+-----------------+--+</span>
现要将其转化为：
col1 col2 col3
a 		b 	<span class="token number">1</span>
a 		b 	<span class="token number">2</span>
a 		b 	<span class="token number">3</span>
c 		d	<span class="token number">4</span>
c 		d 	<span class="token number">5</span>
c 		d	<span class="token number">6</span>
<span class="token comment">----初始化动作</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> col2row_2<span class="token punctuation">(</span>col1 string<span class="token punctuation">,</span>col2 string<span class="token punctuation">,</span>col3 string<span class="token punctuation">)</span>
<span class="token keyword">row</span> format delimited
<span class="token keyword">fields</span> <span class="token keyword">terminated</span> <span class="token keyword">by</span> <span class="token string">'\t'</span><span class="token punctuation">;</span>

<span class="token comment">--执行过程</span>
<span class="token comment">--首先二话不说 我就想把第三个字段炸开。 注意explode接收的参数类型：arraty map</span>
<span class="token comment">--但是第三个字段是string类型 不符合explode的参数类型  如何把string 变成array</span>
<span class="token keyword">select</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>col3<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">from</span> col2row_2<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">------+--+</span>
<span class="token operator">|</span> col  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--+</span>
<span class="token operator">|</span> <span class="token number">1</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">2</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">3</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">4</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">5</span>    <span class="token operator">|</span>
<span class="token operator">|</span> <span class="token number">6</span>    <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">------+--+</span>

<span class="token operator">-</span>配合lateral <span class="token keyword">view</span>语法 把explode炸开之后的结果和原表进行关联
<span class="token keyword">select</span> col2row_2<span class="token punctuation">.</span>col1<span class="token punctuation">,</span>col2row_2<span class="token punctuation">.</span>col2<span class="token punctuation">,</span>tmp_table<span class="token punctuation">.</span><span class="token operator">*</span>  <span class="token keyword">from</span> col2row_2 lateral <span class="token keyword">view</span> explode<span class="token punctuation">(</span>split<span class="token punctuation">(</span>col3<span class="token punctuation">,</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tmp_table<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+----------------+--+</span>
<span class="token operator">|</span> col2row_2<span class="token punctuation">.</span>col1  <span class="token operator">|</span> col2row_2<span class="token punctuation">.</span>col2  <span class="token operator">|</span> tmp_table<span class="token punctuation">.</span>col  <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+----------------+--+</span>
<span class="token operator">|</span> a               <span class="token operator">|</span> b               <span class="token operator">|</span> <span class="token number">1</span>              <span class="token operator">|</span>
<span class="token operator">|</span> a               <span class="token operator">|</span> b               <span class="token operator">|</span> <span class="token number">2</span>              <span class="token operator">|</span>
<span class="token operator">|</span> a               <span class="token operator">|</span> b               <span class="token operator">|</span> <span class="token number">3</span>              <span class="token operator">|</span>
<span class="token operator">|</span> c               <span class="token operator">|</span> d               <span class="token operator">|</span> <span class="token number">4</span>              <span class="token operator">|</span>
<span class="token operator">|</span> c               <span class="token operator">|</span> d               <span class="token operator">|</span> <span class="token number">5</span>              <span class="token operator">|</span>
<span class="token operator">|</span> c               <span class="token operator">|</span> d               <span class="token operator">|</span> <span class="token number">6</span>              <span class="token operator">|</span>
<span class="token operator">+</span><span class="token comment">-----------------+-----------------+----------------+--+</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4b92583f7fb9d8dae46a25b5e6abd374/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用zkui 操作Zookeeper的web页面</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/861795afc58174edbb68b147076c6ceb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据就是由一个个表格内容组成的</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>