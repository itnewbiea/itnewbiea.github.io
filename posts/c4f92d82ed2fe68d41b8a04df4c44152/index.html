<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【五】AI Studio 项目详解【VisualDL工具、环境使用说明、脚本任务、图形化任务、(五)在线部署及预测】PARL - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【五】AI Studio 项目详解【VisualDL工具、环境使用说明、脚本任务、图形化任务、(五)在线部署及预测】PARL" />
<meta property="og:description" content="相关文章
【一】-环境配置&#43;python入门教学
【二】-Parl基础命令
【三】-Notebook、&amp;pdb、ipdb 调试
【四】-强化学习入门简介
【五】-Sarsa&amp;Qlearing详细讲解
【六】-DQN
【七】-Policy Gradient
【八】-DDPG
【九】-四轴飞行器仿真
飞桨PARL_2.0&amp;1.8.5（遇到bug调试修正）
一、AI Studio 项目详解【VisualDL工具】
二、AI Studio 项目详解【环境使用说明、脚本任务】
三、AI Studio 项目详解【分布式训练-单机多机】
四、AI Studio 项目详解【图形化任务】
五、AI Studio 项目详解【在线部署及预测】
【五】AI Studio 项目详解【在线部署及预测---生成沙盒】 在线部署与预测为开发者提供训练模型向应用化API转换的功能. 开发者在AI Studio平台通过NoteBook项目完成模型训练后, 在Notebook详情页通过创建一个在线服务, 应用模型生成在线API, 使用该API可以直接检验模型效果或实际应用到开发者的私有项目中.目前, 该功能暂时仅对Notebook项目开放。
通过训练任务生成模型文件 在训练任务过程中, 通过调用paddle.fluid.io.save_inference_model`实现模型的保存，保存后的目录需要可以被在线服务使用. 我们以房价预测的线性回归任务为例, 具体代码如下 import paddle import paddle.fluid as fluid import numpy import math import sys from __future__ import print_function BATCH_SIZE = 20 train_reader = paddle.batch( paddle.reader.shuffle( paddle.dataset.uci_housing.train(), buf_size=500), batch_size=BATCH_SIZE) test_reader = paddle." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c4f92d82ed2fe68d41b8a04df4c44152/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-01T20:25:39+08:00" />
<meta property="article:modified_time" content="2021-04-01T20:25:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【五】AI Studio 项目详解【VisualDL工具、环境使用说明、脚本任务、图形化任务、(五)在线部署及预测】PARL</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="PaddlePaddlle%E5%BC%BA%E5%8C%96%E5%AD%A6%E4%B9%A0%E5%8F%8APARL%E6%A1%86%E6%9E%B6%EF%BD%9B%E9%A3%9E%E6%A1%A8%EF%BD%9D">相关文章</p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114537725">【一】-环境配置+python入门教学</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114706326">【二】-Parl基础命令</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114870134">【三】-Notebook、&amp;pdb、ipdb 调试</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114928217">【四】-强化学习入门简介</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114974468">【五】-Sarsa&amp;Qlearing详细讲解</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114981878">【六】-DQN</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115046916">【七】-Policy Gradient</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115083305">【八】-DDPG</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115140134">【九】-四轴飞行器仿真</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/114847578">飞桨PARL_2.0&amp;1.8.5（遇到bug调试修正）</a></p> 
<hr> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115299022">一、AI Studio 项目详解【VisualDL工具】</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115375984">二、AI Studio 项目详解【环境使用说明、脚本任务】</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115383427">三、AI Studio 项目详解【分布式训练-单机多机】</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115383516">四、AI Studio 项目详解【图形化任务】</a></p> 
<p><a href="https://blog.csdn.net/sinat_39620217/article/details/115383485">五、AI Studio 项目详解【在线部署及预测】</a></p> 
<hr> 
<h2>【五】AI Studio 项目详解【在线部署及预测---生成沙盒】</h2> 
<p>在线部署与预测为开发者提供训练模型向应用化API转换的功能. 开发者在AI Studio平台通过NoteBook项目完成模型训练后, 在Notebook详情页通过创建一个在线服务, 应用模型生成在线API, 使用该API可以直接检验模型效果或实际应用到开发者的私有项目中.目前, 该功能暂时<strong>仅对Notebook项目</strong>开放。</p> 
<h3 id="通过训练任务生成模型文件">通过训练任务生成模型文件</h3> 
<ul><li>在训练任务过程中, 通过调用<a href="http://paddlepaddle.org/documentation/docs/zh/1.2/api_cn/io_cn.html#permalink-5-save_inference_model" rel="nofollow">paddle.fluid.io.save_inference_model</a>`<strong>实现模型的保存</strong>，保存后的目录需要可以被在线服务使用. 我们以房价预测的线性回归任务为例, 具体代码如下</li></ul> 
<pre><code class="language-python">import paddle
import paddle.fluid as fluid
import numpy
import math
import sys
from __future__ import print_function
BATCH_SIZE = 20
train_reader = paddle.batch(
    paddle.reader.shuffle(
        paddle.dataset.uci_housing.train(), buf_size=500),
        batch_size=BATCH_SIZE)
test_reader = paddle.batch(
    paddle.reader.shuffle(
        paddle.dataset.uci_housing.test(), buf_size=500),
        batch_size=BATCH_SIZE)
params_dirname = "model2"
x = fluid.layers.data(name='x', shape=[13], dtype='float32')
y = fluid.layers.data(name='y', shape=[1], dtype='float32')
y_predict = fluid.layers.fc(input=x, size=1, act=None)
main_program = fluid.default_main_program()
startup_program = fluid.default_startup_program()
cost = fluid.layers.square_error_cost(input=y_predict, label=y)
avg_loss = fluid.layers.mean(cost)
sgd_optimizer = fluid.optimizer.SGD(learning_rate=0.001)
sgd_optimizer.minimize(avg_loss)
#clone a test_program
test_program = main_program.clone(for_test=True)
use_cuda = False
place = fluid.CUDAPlace(0) if use_cuda else fluid.CPUPlace()
exe = fluid.Executor(place)
num_epochs = 100
# For training test cost
def train_test(executor, program, reader, feeder, fetch_list):
    accumulated = 1 * [0]
    count = 0
    for data_test in reader():
        outs = executor.run(program=program,
                            feed=feeder.feed(data_test),
                            fetch_list=fetch_list)
        accumulated = [x_c[0] + x_c[1][0] for x_c in zip(accumulated, outs)]
        count += 1
    return [x_d / count for x_d in accumulated]
params_dirname = "fit_a_line.inference.model"
feeder = fluid.DataFeeder(place=place, feed_list=[x, y])
naive_exe = fluid.Executor(place)
naive_exe.run(startup_program)
step = 0
exe_test = fluid.Executor(place)
# main train loop.
for pass_id in range(num_epochs):
    for data_train in train_reader():
        avg_loss_value, = exe.run(main_program,
                                  feed=feeder.feed(data_train),
                                  fetch_list=[avg_loss])
        if step % 10 == 0:  # record a train cost every 10 batches
            print (step, avg_loss_value[0])
        if step % 100 == 0:  # record a test cost every 100 batches
            test_metics = train_test(executor=exe_test,
                                     program=test_program,
                                     reader=test_reader,
                                     fetch_list=[avg_loss.name],
                                     feeder=feeder)
            print (step, test_metics[0])
            # If the accuracy is good enough, we can stop the training.
            if test_metics[0] &lt; 10.0:
                break
        step += 1
        if math.isnan(float(avg_loss_value[0])):
            sys.exit("got NaN loss, training failed.")
    if params_dirname is not None:
        # We can save the trained parameters for the inferences later
        fluid.io.save_inference_model(params_dirname, ['x'],
                                      [y_predict], exe)</code></pre> 
<ul><li>使用已有模型, 可以通过<code>!wget</code>在Notebook中传输模型文件到环境目录。以房价预测的线性回归模型为例, 通过<code>!wget https://ai.baidu.com/file/4E1D1FCC670E4A5E8441634201658107 -O fit_a_line.inference.model</code>传输文件, 解压后直接被在线服务使用.</li></ul> 
<blockquote> 
 <p style="text-indent:33px;"><img alt="" height="255" src="https://images2.imgbox.com/65/c5/Vv9N0SZ0_o.png" width="891"></p> 
 <p>在进行解压unzip</p> 
 <p id="创建一个在线服务"><strong>创建一个在线服务</strong></p> 
 <p>完成模型训练后, 在Notebook项目页面点击【创建预测服务】</p> 
 <p style="text-indent:33px;"><img alt="" height="236" src="https://images2.imgbox.com/6c/ef/yQEfJjwU_o.png" width="590"></p> 
 <h4 id="第一步-选择模型文件">第一步 选择模型文件</h4> 
 <ul><li>勾选模型文件</li></ul> 
 <p style="text-indent:33px;"><img alt="" height="383" src="https://images2.imgbox.com/d4/80/CafgK39l_o.png" width="647"></p> 
 <p style="text-indent:33px;"><img alt="" height="397" src="https://images2.imgbox.com/bf/88/LaNaT1ji_o.png" width="636"></p> 
 <ul><li>设置主程序, 主程序为<code>paddle.fluid.io.save_inference_model</code>中参数<code>main_program</code>配置的程序, 在房价预测的示例中，我们使用默认参数调用<code>save_inference_model</code>, 因此将<span style="color:#f33b45;"><code>__model__</code>文件设置为主程序.</span></li></ul> 
 <p style="text-indent:33px;"><img alt="" height="473" src="https://images2.imgbox.com/1b/2b/3QWW7yZS_o.png" width="706"></p> 
 <h4 id="第二步-确认输入输出">第二步 确认输入输出</h4> 
 <p>填写模型的输入输出参数. 以房价预测的线性回归模型为例(<a href="http://paddlepaddle.org/documentation/docs/zh/1.2/beginners_guide/quick_start/fit_a_line/README.cn.html" rel="nofollow">参数参考</a>), 添加参数如下图所示.</p> 
 <p style="text-indent:33px;"><img alt="" height="407" src="https://images2.imgbox.com/b8/2d/XfRrk05D_o.png" width="698"></p> 
 <p style="text-indent:33px;"><img alt="" height="388" src="https://images2.imgbox.com/79/97/bDEOm77h_o.png" width="694"></p> 
 <h4 id="第三步-制作参数转换器">第三步 制作参数转换器</h4> 
 <p>参数转换器帮助用户转化合法输入并完成数据预处理.</p> 
 <ul><li>方式一:自定义转换器(Python2.7)(推荐).</li></ul> 
 <p>输入参数转换器方法</p> 
 <pre><code class="language-python">def reader_infer(data_args):
  	"""
  	reader_infer 输入参数转换器方法
  	:param data_args: 接口传入的数据，以k-v形式
  	:return [[]], feeder
  	"""
  	#构造内容
  	pass</code></pre> 
 <p>输出参数转换器方法</p> 
 <pre><code class="language-python">def output(results, data_args):
  	"""
  	output 输出参数转换器方法
  	:param results 模型预测结果
  	:param data_args: 接口传入的数据，以k-v形式
 	 	:return array 需要能被json_encode的数据格式
 	 	"""
  	#构造内容
  	pass</code></pre> 
 <p style="text-indent:33px;"><img alt="" height="475" src="https://images2.imgbox.com/35/18/y0mKFDpG_o.png" width="726"></p> 
 <p>转换器代码示例, 以房价预测为例.</p> 
 <p>输入参数转换器:</p> 
 <pre><code class="language-python">import os
import sys
sys.path.append("..")
from PIL import Image
import numpy as np
import paddle.fluid as fluid
from home.utility import base64_to_image
def reader_infer(data_args):
   """
   reader_infer 输入参数转换器方法
   :param data_args: 接口传入的数据，以k-v形式
   :return [[]], feeder
   """
   def reader():
       """
       reader
       :return:
       """
       x = fluid.layers.data(name='x', shape=[13], dtype='float32')
       # y = fluid.layers.data(name='y', shape=[1], dtype='float32')
       feeder = fluid.DataFeeder(place=fluid.CPUPlace(), feed_list=[x])
       CRIM = float(data_args["CRIM"])
       ZN = float(data_args["ZN"])
       INDUS =  float(data_args["INDUS"])
       CHAS = float(data_args["CHAS"])
       NOX = float(data_args["NOX"])
       RM = float(data_args["RM"])
       AGE = float(data_args["AGE"])
       DIS = float(data_args["DIS"])
       RAD =  float(data_args["RAD"])
       TAX = float(data_args["TAX"])
       PTRATIO = float(data_args["PTRATIO"])
       B =  float(data_args["B"])
       LSTAT = float(data_args["LSTAT"])
       return [[[CRIM, ZN, INDUS, CHAS, NOX, RM, AGE, DIS, RAD, TAX, PTRATIO, B, LSTAT]]], feeder
   return reader</code></pre> 
 <p>输出参数转换器:</p> 
 <pre><code class="language-python">def output(results, data_args):
	 """
    output 输出参数转换器方法
    :param results 模型预测结果
    :param data_args: 接口传入的数据，以k-v形式
	 :return array 需要能被json_encode的数据格式
	 """
   lines = []
   for dt in results:
       y = dt.tolist()
       lines.append({"predict": y})
   return lines</code></pre> 
</blockquote> 
<p>方式二: 默认参数, 不设置转换器.</p> 
<p>用户的API参数直接传递给模型.</p> 
<p style="text-indent:33px;"><img alt="" height="390" src="https://images2.imgbox.com/70/40/ClM6TdM6_o.png" width="707"></p> 
<h4 id="第四步-沙盒部署">第四步 沙盒部署</h4> 
<p>用户可以同时部署至多五个沙盒服务, 用来对比模型优化结果.</p> 
<p>录入名称点击【生成沙盒】或者点击【暂存】将沙盒保存到草稿箱.</p> 
<p style="text-indent:33px;"><img alt="" height="282" src="https://images2.imgbox.com/72/65/DRnbsmyt_o.png" width="640"></p> 
<h3 id="测试沙盒服务">测试沙盒服务</h3> 
<p>对沙盒列表中的沙盒服务进行测试，验证是否配置正确。</p> 
<h4 id="第一步-点击【测试】打开测试页面">第一步 点击【测试】打开测试页面</h4> 
<p><img alt="" height="434" src="https://images2.imgbox.com/6b/1b/HNDYrqxH_o.png" width="723"></p> 
<h4 id="第二步-填写json格式请求参数">第二步 填写json格式请求参数</h4> 
<p style="text-indent:33px;"><img alt="" height="311" src="https://images2.imgbox.com/be/b6/zmevxjdA_o.png" width="695"></p> 
<h4 id="第三步-点击【发送】检验返回结果">第三步 点击【发送】检验返回结果</h4> 
<p style="text-indent:33px;"><img alt="" height="673" src="https://images2.imgbox.com/db/77/ssb1N97v_o.png" width="684"></p> 
<p style="text-indent:33px;"> </p> 
<h3 id="部署在线服务">部署在线服务</h3> 
<p>点击【正式部署】部署线上API.</p> 
<ul><li>一个项目可以创建<strong>至多五个</strong>沙盒服务, 并选择其中<strong>一个</strong>沙盒服务部署为线上服务.</li><li>沙盒服务如果连续超过<strong>24小时</strong>无调用将自动调整为暂停状态.</li><li>线上服务如果连续超过<strong>14天</strong>无调用将自动调整为暂停状态.</li></ul> 
<p style="text-indent:33px;"><img alt="" height="421" src="https://images2.imgbox.com/c8/2d/didFV3fX_o.png" width="701"></p> 
<h3 id="调用在线服务">调用在线服务</h3> 
<p>依据API key、服务地址和用户自定义参数, 实现对服务的调用.</p> 
<h4 id="请求方式">请求方式</h4> 
<ul><li>HTTP请求URL: [服务地址] [?] [apiKey=xxx]</li><li>HTTP请求方法: POST</li><li>HTTP Body: 用户自定义参数</li></ul> 
<p style="text-indent:33px;"><img alt="" height="123" src="https://images2.imgbox.com/80/9e/Wp1OzI03_o.png" width="689"></p> 
<p>以房价预测项目为例.</p> 
<ul><li>CURL</li></ul> 
<pre><code>curl -H "Content-Type: application/json" -X POST -d '{"CRIM":0.01887747, "ZN":-0.11363636, "INDUS":0.25525005, "CHAS":-0.06916996,  "NOX":0.29898136, "RM": -0.04476612, "AGE": 0.14340987, "DIS":-0.14797285,  "RAD":0.62828665, "TAX":0.49191383, "PTRATIO":0.18558153, "B":0.05473289, "LSTAT":0.16851371}' "https://aistudio.baidu.com/serving/online/xxx?apiKey=xxxxxxxxxx"</code></pre> 
<p style="text-indent:33px;"><img alt="" src="https://images2.imgbox.com/00/af/nQAl6bTh_o.png"></p> 
<ul><li>Python</li></ul> 
<pre><code class="language-python">import json
import traceback
import urllib
import urllib2

formdata = {
    "CRIM":0.01887747, 
    "ZN":-0.11363636, 
    "INDUS":0.25525005, 
    "CHAS":-0.06916996,  
    "NOX":0.29898136, 
    "RM": -0.04476612, 
    "AGE": 0.14340987, 
    "DIS":-0.14797285,  
    "RAD":0.62828665, 
    "TAX":0.49191383, 
    "PTRATIO":0.18558153, 
    "B":0.05473289, 
    "LSTAT":0.16851371
}
header = {"Content-Type": "application/json; charset=utf-8"}
url = "https://aistudio.baidu.com/serving/online/xxx?apiKey=a280cf48-6d0c-4baf-bd39xxxxxxcxxxxx"
data = json.dumps(formdata)
try:
    request = urllib2.Request(url, data, header)
    response = urllib2.urlopen(request)
    response_str = response.read()
    response.close()
    print(response_str)
except urllib2.HTTPError as e:
    print("The server couldn't fulfill the request")
    print(e.code)
    print(e.read())
except urllib2.URLError as e:
    print("Failed to reach the server")
    print(e.reason)
except:
    traceback.print_exc()</code></pre> 
<p style="text-indent:33px;"><img alt="" height="593" src="https://images2.imgbox.com/22/65/YPDM7vPu_o.png" width="587"></p> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e10b76ed8295e1255c55cb38563a5025/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">创建自定义ingress报错：Internal error occurred: failed calling webhook “validate.nginx.ingress.kubernetes.io</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/188e7115ca1c29a96db3b2007a48cdef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">通过 git 实现微前端公共资源共享方案（subtree）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>