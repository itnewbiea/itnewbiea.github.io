<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>carla学习笔记(十) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="carla学习笔记(十)" />
<meta property="og:description" content="实验室同学需要做仿真数据的采集实验，为记录以下整个采集过程。方便未来进行类似数据采集时减少写代码的时间。
采集数据要求：
控制一辆车，从a点到b点。然后在路侧架设一个lidar，采集车辆通过激光lidar区域时的数据。
一、首先确定a点和b点。 地图选取的是carla的town03。
具体区域是这里：
首先确定选择的a点：start_point；b点：end_point。
这里使用draw_string函数，将确定的点在地图中显示出来，方便之后的路径确定：
源码如下：
import carla def show_point(world, point_location): world.debug.draw_string(point_location, &#39;X&#39;, draw_shadow=False, color=carla.Color(r=0, g=255, b=0), life_time=50, persistent_lines=True) def main(): client = carla.Client(&#39;localhost&#39;, 2000) client.set_timeout(2.0) world = client.get_world() start_point = carla.Location(229, 116, 2) end_point = carla.Location(20,194,2) show_point(world, start_point) show_point(world, end_point) main() 地图显示：
图中两个绿色的x就是分别确定的start_point和end_point。
这里有几个点需要注意：
1.注意区分carla.Location和carla.Transform之间的关系。
2.注意在使用系统提供的函数的时候，它的参数的格式要求，尤其是spawn_vehicle函数。
怎么才好知道点的坐标呢？
可以使用这个函数测试。首先确定原点，然后确定x轴正向，再确定y轴正向。就可以将地图的坐标系确定出来。好久没有使用carla了，当时在这一步卡了好久，主要原因就是对于相关的函数的数据格式不熟悉了，解决报错问题花了快一个小时。。。
下面是源码：
import carla def show_point(world, point_location): world.debug.draw_string(point_location, &#39;P&#39;, draw_shadow=False, color=carla.Color(r=0, g=255, b=0), life_time=50, persistent_lines=True) def show_x_point(world, point_location): world." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/59bd1447b9c0e601857a59c6912fd802/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-03T15:10:07+08:00" />
<meta property="article:modified_time" content="2022-12-03T15:10:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">carla学习笔记(十)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>实验室同学需要做仿真数据的采集实验，为记录以下整个采集过程。方便未来进行类似数据采集时减少写代码的时间。</p> 
<p>采集数据要求：</p> 
<p><strong><span style="color:#fe2c24;">控制一辆车，从a点到b点。然后在路侧架设一个lidar，采集车辆通过激光lidar区域时的数据。</span></strong></p> 
<h2>一、首先确定a点和b点。</h2> 
<p>地图选取的是carla的town03。</p> 
<p>具体区域是这里：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/eb/84/kactSowH_o.png"></p> 
<p> 首先确定选择的a点：start_point；b点：end_point。</p> 
<p>这里使用draw_string函数，将确定的点在地图中显示出来，方便之后的路径确定：</p> 
<p>源码如下：</p> 
<pre><code class="language-python">import carla

def show_point(world, point_location):
    world.debug.draw_string(point_location, 'X', draw_shadow=False,
                                        color=carla.Color(r=0, g=255, b=0), life_time=50,
                                        persistent_lines=True)

def main():
        client = carla.Client('localhost', 2000)
        client.set_timeout(2.0)
        world = client.get_world()

        start_point = carla.Location(229, 116, 2)
        end_point = carla.Location(20,194,2)
        show_point(world, start_point)
        show_point(world, end_point)

main()</code></pre> 
<p>地图显示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/d6/dc/mpuZ0pME_o.png"></p> 
<p> 图中两个绿色的x就是分别确定的start_point和end_point。</p> 
<p>这里有几个点需要注意：</p> 
<p><strong>1.注意区分carla.Location和carla.Transform之间的关系。</strong></p> 
<p><strong>2.注意在使用系统提供的函数的时候，它的参数的格式要求，尤其是spawn_vehicle函数。</strong></p> 
<p>怎么才好知道点的坐标呢？</p> 
<p>可以使用这个函数测试。首先确定原点，然后确定x轴正向，再确定y轴正向。就可以将地图的坐标系确定出来。好久没有使用carla了，当时在这一步卡了好久，主要原因就是对于相关的函数的数据格式不熟悉了，解决报错问题花了快一个小时。。。</p> 
<p>下面是源码：</p> 
<pre><code class="language-python">import carla

def show_point(world, point_location):
    world.debug.draw_string(point_location, 'P', draw_shadow=False,
                                        color=carla.Color(r=0, g=255, b=0), life_time=50,
                                        persistent_lines=True)

def show_x_point(world, point_location):
    world.debug.draw_string(point_location, 'X', draw_shadow=False,
                                        color=carla.Color(r=0, g=255, b=0), life_time=50,
                                        persistent_lines=True)

def show_y_point(world, point_location):
    world.debug.draw_string(point_location, 'Y', draw_shadow=False,
                                        color=carla.Color(r=0, g=255, b=0), life_time=50,
                                        persistent_lines=True)

def show_O_point(world, point_location):
    world.debug.draw_string(point_location, 'O', draw_shadow=False,
                                        color=carla.Color(r=0, g=255, b=0), life_time=50,
                                        persistent_lines=True)

def main():
        client = carla.Client('localhost', 2000)
        client.set_timeout(2.0)
        world = client.get_world()
        
        start_point = carla.Location(229, 116, 2)
        end_point = carla.Location(20,194,2)
        origin_point = carla.Location(0,0,0)
        x_axis = carla.Location(10, 0, 0)
        y_axis = carla.Location(0, 10, 0)
        show_point(world, start_point)
        show_point(world, end_point)
        show_O_point(world, origin_point)
        show_x_point(world, x_axis)
        show_y_point(world, y_axis)

main()
</code></pre> 
<p>地图显示：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/f3/c1/MH1CAfLH_o.png"></p> 
<h2> 二、选择lidar点</h2> 
<p>和第一步类似，使用draw函数来找点。</p> 
<p>源码就将上面的简单修改就可以了。</p> 
<p>地图显示如下：</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/ff/ef/ALqwSmvZ_o.png"></p> 
<p> O为架设lidar的坐标。</p> 
<h2>三、实现vehilce从a点到b点</h2> 
<p>主要调用的是agent里面的set_destination函数。</p> 
<p>参考小飞大佬的源码，自己改了一下：</p> 
<pre><code class="language-python"># -*- coding: utf-8 -*-


import os
import random
import sys

import carla

from agents.navigation.behavior_agent import BehaviorAgent


def main():
    try:
        client = carla.Client('localhost', 2000)
        client.set_timeout(2.0)

        world = client.get_world()

        origin_settings = world.get_settings()


        settings = world.get_settings()
        settings.synchronous_mode = True
        settings.fixed_delta_seconds = 0.05
        world.apply_settings(settings)

        blueprint_library = world.get_blueprint_library()

        # 确定起点和终点
        p1 = carla.Location(229, 116, 2)
        p2 = carla.Location(20, 194, 2)
        start_point = carla.Transform(p1, carla.Rotation(0,0,0))
        end_point = carla.Transform(p2, carla.Rotation(0, 0, 0))
        
        # 创建车辆
        ego_vehicle_bp = blueprint_library.find('vehicle.lincoln.mkz2017')
        ego_vehicle_bp.set_attribute('color', '0, 0, 0')
        vehicle = world.spawn_actor(ego_vehicle_bp, start_point)

        world.tick()

        # 设置车辆的驾驶模式
        agent = BehaviorAgent(vehicle, behavior='normal')
        # 核心函数
        agent.set_destination(agent.vehicle.get_location(), end_point.location, clean=True)

        while True:
            agent.update_information(vehicle)

            world.tick()
            
            if len(agent._local_planner.waypoints_queue)&lt;1:
                print('======== Success, Arrivied at Target Point!')
                break
                
            # 设置速度限制
            speed_limit = vehicle.get_speed_limit()
            agent.get_local_planner().set_speed(speed_limit)

            control = agent.run_step(debug=True)
            vehicle.apply_control(control)

    finally:
        world.apply_settings(origin_settings)
        vehicle.destroy()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print(' - Exited by user.')
</code></pre> 
<p>比较简单，看注释就好。</p> 
<h2>四、生成lidar并采集数据</h2> 
<p>将生成lidar的部分加入到第三章里面的源码中。</p> 
<pre><code class="language-python"># -*- coding: utf-8 -*-


import os
import carla

from agents.navigation.behavior_agent import BehaviorAgent


def main():
    try:
        client = carla.Client('localhost', 2000)
        client.set_timeout(2.0)

        world = client.get_world()

        origin_settings = world.get_settings()


        settings = world.get_settings()
        settings.synchronous_mode = True
        settings.fixed_delta_seconds = 0.05
        world.apply_settings(settings)

        blueprint_library = world.get_blueprint_library()
        # 设置储存位置
        output_path = 'lidar_data'

        # 确定起点和终点
        p1 = carla.Location(229, 116, 2)
        p2 = carla.Location(20, 194, 2)
        start_point = carla.Transform(p1, carla.Rotation(0,0,0))
        end_point = carla.Transform(p2, carla.Rotation(0, 0, 0))
        
        # 创建车辆
        ego_vehicle_bp = blueprint_library.find('vehicle.lincoln.mkz2017')
        ego_vehicle_bp.set_attribute('color', '0, 0, 0')
        vehicle = world.spawn_actor(ego_vehicle_bp, start_point)

        # 创建lidar，设置lidar的参数
        lidar_bp = blueprint_library.find('sensor.lidar.ray_cast')
        lidar_bp.set_attribute('channels', str(32))
        lidar_bp.set_attribute('points_per_second', str(90000))
        lidar_bp.set_attribute('rotation_frequency', str(40))
        lidar_bp.set_attribute('range', str(20))
        # 设置lidar架设的点
        lidar_location = carla.Location(100, 190, 2)
        lidar_rotation = carla.Rotation(0, 0, 0)
        lidar_transform = carla.Transform(lidar_location, lidar_rotation)        
        # 生成lidar并采集数据
        lidar = world.spawn_actor(lidar_bp, lidar_transform)
        lidar.listen(
            lambda point_cloud: point_cloud.save_to_disk(os.path.join(output_path, '%06d.ply' % point_cloud.frame)))       

         
        
        world.tick()

        # 设置车辆的驾驶模式
        agent = BehaviorAgent(vehicle, behavior='normal')
        # 核心函数
        agent.set_destination(agent.vehicle.get_location(), end_point.location, clean=True)

        while True:
            agent.update_information(vehicle)

            world.tick()
            
            if len(agent._local_planner.waypoints_queue)&lt;1:
                print('======== Success, Arrivied at Target Point!')
                break
                
            # 设置速度限制
            speed_limit = vehicle.get_speed_limit()
            agent.get_local_planner().set_speed(speed_limit)

            control = agent.run_step(debug=True)
            vehicle.apply_control(control)

    finally:
        world.apply_settings(origin_settings)
        vehicle.destroy()


if __name__ == '__main__':
    try:
        main()
    except KeyboardInterrupt:
        print(' - Exited by user.')
</code></pre> 
<p>比较简单，整个实验采集都比较简单。在这里记录一下，方便未来做类似工作是可以直接代码服用。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/494ab6f2bd856044c55518ac19d1d7c8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">redis批量导入数据</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6efabb7abc0eb207fbd60d43e4a699f5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JS基础知识汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>