<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于APNS的语音播报实践 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于APNS的语音播报实践" />
<meta property="og:description" content="前言 由于项目需求，对基于APNs的语音播报做一个预研探究。如场景：收到转账消息，实时收到推送并播放语音。
历史方案总结, 经过多方尝试验证，以下方式都已过时 以下方案均为调研过程中无法成功的方案一览；
方案一： App收到推送，通过sound指定播放固定音频（“收到一笔转账”）。前提：mp3\caf\m4a音频文件需要内置在bundle中，推送下发时指定文件名称。缺点：无法根据具体金额播报。
方案二： App在前台收到推送时，通过AVAudioSession 或者 AVSpeechSynthesisVoice播报。缺点：1 App在前台播报时，可以通过音量键调整音量。正常的推送抵达时，音量键或者关机键会即刻中断播放推送声音，所以本方案不是真正的推送音。2 App杀死情况下无法播报。
方案三： 通过通知扩展（Notification Service）播放音频。App通知扩展收到推送时，调用AVAudioSession 或者 AVSpeechSynthesisVoice 播报。可能在通知扩展刚推出的时是允许这种做法的。但现在苹果已经不支持在通知扩展中播放音频，即使调用相关函数也不会生效。
方案四： 通过通知扩展（Notification Service）发送本地通知播报。App通知扩展收到推送时，顺序创建多个本地通知，每个通知都播放内置音频，从而组成一句完整的播报音频。缺点：1 苹果已不支持在通知扩展发送本地通知。2 播放推送音频时，音量键或者关机键 会中断当前本地通知的音频播放。
方案五：基于VOIP的语音播报，iOS13之后苹果对VOIP做了很大的限制，必须配合CallKit使用，否则收到VOIP推送后直接中断crash，没有机会再做更多事情了。
现有方案 基于通知扩展（Notification Service）来处理推送，可以保证 App被杀死 或者 App在前后台时 都能够处理推送并实时播报。
也可以通过发送静默通知，来实时播报。收到静默通知时，App会被系统拉活然后然后执行application(_ application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable : Any]),可以在内部播放音频播报。但是由于苹果官方文档有说明，静默通知是有限制的：（所以该方式我们放弃了）
APNs若检测到较高频率的静默通知发送请求，可能会终止其发送静默通知唤醒后台App，最多有30秒的时间处理系统回调静默推送的优先级低，系统不能保证推送必达，大量的静默推送通知可能被系统将限制。苹果官方建议一个小时不超过2-3条静默推送静默通知官方文档 准备工作：
需要在Bundle中内置音频文件，如（0-9，元，点）等基础音频。设置AppGroup 当接收通知时：
读取aps中的播报数据，读取Bundle中音频文件进行合并音频（如&#34;您收到.mp3&#34;&#43;“1.mp3”&#43;“元.mp3”），输出到指定目录。修改本次推送声音标识sound，指定合并后的音频文件播报。最后达到语音播报目的。 注意点：
需设置AppGroup，通过共享目录创建音频目录和文件。若有指定sound:“abc.mp3”，系统会逐级查找是否有可用的abc.mp3文件： 查找AppGroup共享目录查找App NSHomeDirectory()&#43;&#34;/Library/Sounds/&#34;查找bundle中是否有可用的abc.mp3查找系统音频库 GitHub Demo GitHub Demo ApnsDemo
资源文件如有侵权 请联系删除。
Test Payload 建议使用SmartPush来测试推送
{ &#34;aps&#34;: { &#34;alert&#34;: { &#34;title&#34;: &#34;title&#34;, &#34;body&#34;: &#34;body&#34; }, &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5807e109b7ed565577fb5e7a9a576389/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-02T20:49:19+08:00" />
<meta property="article:modified_time" content="2020-07-02T20:49:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于APNS的语音播报实践</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<hr> 
<p>由于项目需求，对基于APNs的语音播报做一个预研探究。如场景：收到转账消息，实时收到推送并播放语音。</p> 
<h2><a id="__6"></a>历史方案总结, 经过多方尝试验证，以下方式都已过时</h2> 
<p>以下方案均为调研过程中无法成功的方案一览；</p> 
<ul><li> <p>方案一： App收到推送，通过sound指定播放固定音频（“收到一笔转账”）。前提：mp3\caf\m4a音频文件需要内置在bundle中，推送下发时指定文件名称。缺点：无法根据具体金额播报。</p> </li><li> <p>方案二： App在前台收到推送时，通过AVAudioSession 或者 AVSpeechSynthesisVoice播报。缺点：1 App在前台播报时，可以通过音量键调整音量。正常的推送抵达时，音量键或者关机键会即刻<code>中断播放</code>推送声音，所以本方案不是真正的推送音。2 App杀死情况下无法播报。</p> </li><li> <p>方案三： 通过通知扩展（Notification Service）播放音频。App通知扩展收到推送时，调用<code>AVAudioSession</code> 或者 <code>AVSpeechSynthesisVoice</code> 播报。可能在通知扩展刚推出的时是允许这种做法的。但现在苹果已经<code>不支持</code>在通知扩展中播放音频，即使调用相关函数也不会生效。</p> </li><li> <p>方案四： 通过通知扩展（Notification Service）发送本地通知播报。App通知扩展收到推送时，顺序创建多个本地通知，每个通知都播放内置音频，从而组成一句完整的播报音频。缺点：1 苹果已<code>不支持在通知扩展发送本地通知</code>。2 播放推送音频时，音量键或者关机键 会中断当前本地通知的音频播放。</p> </li><li> <p>方案五：基于VOIP的语音播报，iOS13之后苹果对VOIP做了很大的限制，必须配合CallKit使用，否则收到VOIP推送后直接中断crash，没有机会再做更多事情了。</p> </li></ul> 
<h2><a id="_25"></a>现有方案</h2> 
<hr> 
<p>基于通知扩展（Notification Service）来处理推送，可以保证 <code>App被杀死</code> 或者 <code>App在前后台时</code> 都能够处理推送并实时播报。</p> 
<p>也可以通过发送<code>静默通知</code>，来实时播报。收到静默通知时，App会被系统拉活然后然后执行<code>application(_ application: UIApplication, didReceiveRemoteNotification userInfo: [AnyHashable : Any])</code>,可以在内部播放音频播报。但是由于苹果官方文档有说明，静默通知是有限制的：（所以该方式我们放弃了）</p> 
<ul><li>APNs若检测到较高频率的静默通知发送请求，可能会终止其发送</li><li>静默通知唤醒后台App，最多有30秒的时间处理系统回调</li><li>静默推送的优先级低，系统不能保证推送必达，大量的静默推送通知可能被系统将限制。苹果官方建议一个小时不超过2-3条静默推送</li><li><a href="https://developer.apple.com/documentation/usernotifications/setting_up_a_remote_notification_server/pushing_background_updates_to_your_app?language=objc" rel="nofollow">静默通知官方文档</a></li></ul> 
<p>准备工作：</p> 
<ul><li>需要在Bundle中内置音频文件，如（0-9，元，点）等基础音频。</li><li>设置AppGroup</li></ul> 
<p>当接收通知时：</p> 
<ul><li>读取aps中的播报数据，读取Bundle中音频文件进行合并音频（如"您收到.mp3"+“1.mp3”+“元.mp3”），输出到指定目录。</li><li>修改本次推送声音标识<code>sound</code>，指定合并后的音频文件播报。最后达到语音播报目的。</li></ul> 
<p>注意点：</p> 
<ul><li>需设置AppGroup，通过共享目录创建音频目录和文件。</li><li>若有指定sound:“abc.mp3”，系统会逐级查找是否有可用的abc.mp3文件：</li></ul> 
<ol><li>查找AppGroup共享目录</li><li>查找App NSHomeDirectory()+"/Library/Sounds/"</li><li>查找bundle中是否有可用的abc.mp3</li><li>查找系统音频库</li></ol> 
<h3><a id="GitHub_Demo_62"></a>GitHub Demo</h3> 
<p><a href="https://github.com/aklee/ApnsDemo">GitHub Demo ApnsDemo</a><br> 资源文件如有侵权 请联系删除。</p> 
<h2><a id="Test_Payload_68"></a>Test Payload</h2> 
<p>建议使用<a href="https://github.com/shaojiankui/SmartPush">SmartPush</a>来测试推送</p> 
<pre><code>{
    "aps": {
        "alert": {
            "title": "title",
            "body": "body"
        },
    "transfer":"123",
     "mutable-content":1
    }
}
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/86/gp1ZyUeW_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e3551d150636f8fd6d5800f368edda2f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python小白学习笔记    如何将一个正整数分解为质因数相乘</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/86a2ce57336bb5d6be4b2b0d96afddd6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">合并多个文件夹中的文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>