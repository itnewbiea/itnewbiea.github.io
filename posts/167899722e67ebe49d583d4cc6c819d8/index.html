<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【Docker】笔记小结 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【Docker】笔记小结" />
<meta property="og:description" content="目录 一、快速入门1. 安装2.配置镜像加速 二、常用命令0. 预备1.镜像命令1.1 查看所有本地主机的镜像1.2 搜索镜像1.3 下载镜像1.4 删除镜像 2.容器命令2.1 启动容器：2.2 查看容器：2.3 删除容器：2.4 启动和停止容器： 3.其他命令3.1 后台启动：3.2 查看日志：3.3 查看容器中的进程信息：3.4 查看镜像的元数据：3.5 进入当前正在运行的容器3.6 从容器内拷贝文件到主机上 4.练习4.1 部署Nginx4.2 部署Tomcat4.3 部署 es &#43; kibana 三、可视化工具1. portainer2. Rancher（CI/CD） 四、Docker镜像1. 镜像是什么？2. Docker镜像加载原理2.1 UnionFs （联合文件系统）2.2 Docker镜像加载原理 3.分层理解4. commit镜像 五、容器数据卷1. 什么是容器数据卷？2. 使用容器数据卷3. 实战：安装MySQL4. 具名和匿名挂载4.1 匿名挂载4.2 具名挂载（推荐） 5. 初识Dockerfile6. 数据卷容器7. Dockerfile7.1 构建步骤7.2 Dockerfile构建过程7.2.1 基础知识：7.2.2 Dockerfile的指令7.2.3 实战测试7.2.4 CMD 和 ENTRYPOINT7.2.5 实战-Tomcat镜像7.2.6 发布自己的镜像7.2.7 发布到阿里云镜像服务上 8. Docker小结： 六、Docker网络1、理解Docker02、- - Link3、自定义网络4、部署Redis集群 七、SpringBoot微服务打包Docker镜像八、DockerCompose1、简介2、安装3、体验4、yaml规则5、实战开源项目6、实战 九、DockerSwarm1、集群2、Raft协议3、体会4、概念总结 十、Docker Stack十一、Docker Secret十二、Docker Config 一、快速入门 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/167899722e67ebe49d583d4cc6c819d8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-08T20:37:10+08:00" />
<meta property="article:modified_time" content="2022-09-08T20:37:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【Docker】笔记小结</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、快速入门</a></li><li><ul><li><a href="#1__2" rel="nofollow">1. 安装</a></li><li><a href="#2_106" rel="nofollow">2.配置镜像加速</a></li></ul> 
  </li><li><a href="#_123" rel="nofollow">二、常用命令</a></li><li><ul><li><a href="#0__124" rel="nofollow">0. 预备</a></li><li><a href="#1_134" rel="nofollow">1.镜像命令</a></li><li><ul><li><a href="#11__135" rel="nofollow">1.1 查看所有本地主机的镜像</a></li><li><a href="#12__156" rel="nofollow">1.2 搜索镜像</a></li><li><a href="#13__184" rel="nofollow">1.3 下载镜像</a></li><li><a href="#14__210" rel="nofollow">1.4 删除镜像</a></li></ul> 
   </li><li><a href="#2_217" rel="nofollow">2.容器命令</a></li><li><ul><li><a href="#21__237" rel="nofollow">2.1 启动容器：</a></li><li><a href="#22__252" rel="nofollow">2.2 查看容器：</a></li><li><a href="#23__273" rel="nofollow">2.3 删除容器：</a></li><li><a href="#24__280" rel="nofollow">2.4 启动和停止容器：</a></li></ul> 
   </li><li><a href="#3_287" rel="nofollow">3.其他命令</a></li><li><ul><li><a href="#31__288" rel="nofollow">3.1 后台启动：</a></li><li><a href="#32__301" rel="nofollow">3.2 查看日志：</a></li><li><a href="#33__320" rel="nofollow">3.3 查看容器中的进程信息：</a></li><li><a href="#34__329" rel="nofollow">3.4 查看镜像的元数据：</a></li><li><a href="#35__542" rel="nofollow">3.5 进入当前正在运行的容器</a></li><li><a href="#36__569" rel="nofollow">3.6 从容器内拷贝文件到主机上</a></li></ul> 
   </li><li><a href="#4_640" rel="nofollow">4.练习</a></li><li><ul><li><a href="#41_Nginx_641" rel="nofollow">4.1 部署Nginx</a></li><li><a href="#42_Tomcat_654" rel="nofollow">4.2 部署Tomcat</a></li><li><a href="#43__es__kibana_676" rel="nofollow">4.3 部署 es + kibana</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_711" rel="nofollow">三、可视化工具</a></li><li><ul><li><a href="#1_portainer_713" rel="nofollow">1. portainer</a></li><li><a href="#2_RancherCICD_729" rel="nofollow">2. Rancher（CI/CD）</a></li></ul> 
  </li><li><a href="#Docker_731" rel="nofollow">四、Docker镜像</a></li><li><ul><li><a href="#1__732" rel="nofollow">1. 镜像是什么？</a></li><li><a href="#2_Docker_744" rel="nofollow">2. Docker镜像加载原理</a></li><li><ul><li><a href="#21_UnionFs__746" rel="nofollow">2.1 UnionFs （联合文件系统）</a></li><li><a href="#22_Docker_752" rel="nofollow">2.2 Docker镜像加载原理</a></li></ul> 
   </li><li><a href="#3_765" rel="nofollow">3.分层理解</a></li><li><a href="#4_commit_935" rel="nofollow">4. commit镜像</a></li></ul> 
  </li><li><a href="#_983" rel="nofollow">五、容器数据卷</a></li><li><ul><li><a href="#1__984" rel="nofollow">1. 什么是容器数据卷？</a></li><li><a href="#2__1000" rel="nofollow">2. 使用容器数据卷</a></li><li><a href="#3_MySQL_1042" rel="nofollow">3. 实战：安装MySQL</a></li><li><a href="#4__1057" rel="nofollow">4. 具名和匿名挂载</a></li><li><ul><li><a href="#41__1058" rel="nofollow">4.1 匿名挂载</a></li><li><a href="#42__1076" rel="nofollow">4.2 具名挂载（推荐）</a></li></ul> 
   </li><li><a href="#5_Dockerfile_1127" rel="nofollow">5. 初识Dockerfile</a></li><li><a href="#6__1272" rel="nofollow">6. 数据卷容器</a></li><li><a href="#7_Dockerfile_1339" rel="nofollow">7. Dockerfile</a></li><li><ul><li><a href="#71__1342" rel="nofollow">7.1 构建步骤</a></li><li><a href="#72_Dockerfile_1356" rel="nofollow">7.2 Dockerfile构建过程</a></li><li><ul><li><a href="#721__1357" rel="nofollow">7.2.1 基础知识：</a></li><li><a href="#722_Dockerfile_1377" rel="nofollow">7.2.2 Dockerfile的指令</a></li><li><a href="#723__1395" rel="nofollow">7.2.3 实战测试</a></li><li><a href="#724_CMD__ENTRYPOINT_1464" rel="nofollow">7.2.4 CMD 和 ENTRYPOINT</a></li><li><a href="#725_Tomcat_1569" rel="nofollow">7.2.5 实战-Tomcat镜像</a></li><li><a href="#726__1635" rel="nofollow">7.2.6 发布自己的镜像</a></li><li><a href="#727__1670" rel="nofollow">7.2.7 发布到阿里云镜像服务上</a></li></ul> 
    </li><li><a href="#8_Docker_1681" rel="nofollow">8. Docker小结：</a></li></ul> 
  </li></ul> 
  </li><li><a href="#Docker_1683" rel="nofollow">六、Docker网络</a></li><li><ul><li><a href="#1Docker0_1684" rel="nofollow">1、理解Docker0</a></li><li><a href="#2__Link_1799" rel="nofollow">2、- - Link</a></li><li><a href="#3_1838" rel="nofollow">3、自定义网络</a></li><li><a href="#4Redis_1972" rel="nofollow">4、部署Redis集群</a></li></ul> 
  </li><li><a href="#SpringBootDocker_2132" rel="nofollow">七、SpringBoot微服务打包Docker镜像</a></li><li><a href="#DockerCompose_2215" rel="nofollow">八、DockerCompose</a></li><li><ul><li><a href="#1_2216" rel="nofollow">1、简介</a></li><li><a href="#2_2276" rel="nofollow">2、安装</a></li><li><a href="#3_2288" rel="nofollow">3、体验</a></li><li><a href="#4yaml_2373" rel="nofollow">4、yaml规则</a></li><li><a href="#5_2398" rel="nofollow">5、实战开源项目</a></li><li><a href="#6_2408" rel="nofollow">6、实战</a></li></ul> 
  </li><li><a href="#DockerSwarm_2530" rel="nofollow">九、DockerSwarm</a></li><li><ul><li><a href="#1_2532" rel="nofollow">1、集群</a></li><li><a href="#2Raft_2559" rel="nofollow">2、Raft协议</a></li><li><a href="#3_2562" rel="nofollow">3、体会</a></li><li><a href="#4_2574" rel="nofollow">4、概念总结</a></li></ul> 
  </li><li><a href="#Docker_Stack_2594" rel="nofollow">十、Docker Stack</a></li><li><a href="#Docker_Secret_2596" rel="nofollow">十一、Docker Secret</a></li><li><a href="#Docker_Config_2597" rel="nofollow">十二、Docker Config</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、快速入门</h2> 
<h3><a id="1__2"></a>1. 安装</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 1.查看系统内核（3.10以上才可以）</span>
<span class="token function">uname</span> -r

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># uname -r</span>
<span class="token number">3.10</span>.0-1160.45.1.el7.x86_64

<span class="token comment"># 2.查看系统环境</span>
<span class="token function">cat</span> /etc/os-release

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># cat /etc/os-release </span>
<span class="token assign-left variable">NAME</span><span class="token operator">=</span><span class="token string">"CentOS Linux"</span>
<span class="token assign-left variable">VERSION</span><span class="token operator">=</span><span class="token string">"7 (Core)"</span>
<span class="token assign-left variable">ID</span><span class="token operator">=</span><span class="token string">"centos"</span>
<span class="token assign-left variable">ID_LIKE</span><span class="token operator">=</span><span class="token string">"rhel fedora"</span>
<span class="token assign-left variable">VERSION_ID</span><span class="token operator">=</span><span class="token string">"7"</span>
<span class="token assign-left variable">PRETTY_NAME</span><span class="token operator">=</span><span class="token string">"CentOS Linux 7 (Core)"</span>
<span class="token assign-left variable">ANSI_COLOR</span><span class="token operator">=</span><span class="token string">"0;31"</span>
<span class="token assign-left variable">CPE_NAME</span><span class="token operator">=</span><span class="token string">"cpe:/o:centos:centos:7"</span>
<span class="token assign-left variable">HOME_URL</span><span class="token operator">=</span><span class="token string">"https://www.centos.org/"</span>
<span class="token assign-left variable">BUG_REPORT_URL</span><span class="token operator">=</span><span class="token string">"https://bugs.centos.org/"</span>

<span class="token assign-left variable">CENTOS_MANTISBT_PROJECT</span><span class="token operator">=</span><span class="token string">"CentOS-7"</span>
<span class="token assign-left variable">CENTOS_MANTISBT_PROJECT_VERSION</span><span class="token operator">=</span><span class="token string">"7"</span>
<span class="token assign-left variable">REDHAT_SUPPORT_PRODUCT</span><span class="token operator">=</span><span class="token string">"centos"</span>
<span class="token assign-left variable">REDHAT_SUPPORT_PRODUCT_VERSION</span><span class="token operator">=</span><span class="token string">"7"</span>

<span class="token comment"># 3.卸载本机docker</span>
yum remove <span class="token function">docker</span> <span class="token punctuation">\</span>
                  docker-client <span class="token punctuation">\</span>
                  docker-client-latest <span class="token punctuation">\</span>
                  docker-common <span class="token punctuation">\</span>
                  docker-latest <span class="token punctuation">\</span>
                  docker-latest-logrotate <span class="token punctuation">\</span>
                  docker-logrotate <span class="token punctuation">\</span>
                  docker-engine

<span class="token comment"># 4.设置仓库</span>
yum <span class="token function">install</span> -y yum-utils
<span class="token comment">## 设置国内阿里云仓库，速度快</span>
 yum-config-manager <span class="token punctuation">\</span>
    --add-repo <span class="token punctuation">\</span>
    http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

<span class="token comment"># 5.更新yum包索引</span>
yum makecache fast

<span class="token comment"># 5.安装docker（ce 社区版  ee 企业版）</span>
yum <span class="token function">install</span> docker-ce docker-ce-cli containerd.io

<span class="token comment"># 6.启动docker</span>
systemctl start <span class="token function">docker</span>

<span class="token comment"># 7.检查docker版本</span>
<span class="token function">docker</span> version

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker version</span>
Client: Docker Engine - Community
 Version:           <span class="token number">20.10</span>.14
 API version:       <span class="token number">1.41</span>
 Go version:        go1.16.15
 Git commit:        a224086
 Built:             Thu Mar <span class="token number">24</span> 01:49:57 <span class="token number">2022</span>
 OS/Arch:           linux/amd64
 Context:           default
 Experimental:      <span class="token boolean">true</span>

Server: Docker Engine - Community
 Engine:
  Version:          <span class="token number">20.10</span>.14
  API version:      <span class="token number">1.41</span> <span class="token punctuation">(</span>minimum version <span class="token number">1.12</span><span class="token punctuation">)</span>
  Go version:       go1.16.15
  Git commit:       87a90dc
  Built:            Thu Mar <span class="token number">24</span> 01:48:24 <span class="token number">2022</span>
  OS/Arch:          linux/amd64
  Experimental:     <span class="token boolean">false</span>
 containerd:
  Version:          <span class="token number">1.5</span>.11
  GitCommit:        3df54a852345ae127d1fa3092b95168e4a88e2f8
 runc:
  Version:          <span class="token number">1.0</span>.3
  GitCommit:        v1.0.3-0-gf46b6ba
 docker-init:
  Version:          <span class="token number">0.19</span>.0
  GitCommit:        de40ad0

<span class="token comment"># 8.测试docker</span>
<span class="token function">docker</span> run hello-world

<span class="token comment"># 9.查看docker镜像</span>
<span class="token function">docker</span> images

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY    TAG       IMAGE ID       CREATED        SIZE
hello-world   latest    feb5d9fea6a5   <span class="token number">6</span> months ago   <span class="token number">13</span>.3kB

<span class="token comment"># 10.卸载docker</span>
<span class="token comment">## 10.1 卸载依赖</span>
yum remove docker-ce docker-ce-cli containerd.io
<span class="token comment">##10.2 删除资源</span>
<span class="token function">rm</span> -rf /var/lib/docker   （docker默认工作路径）
<span class="token function">rm</span> -rf /var/lib/containerd
</code></pre> 
<h3><a id="2_106"></a>2.配置镜像加速</h3> 
<p>以阿里云镜像为例：</p> 
<ol><li>阿里云容器镜像服务-镜像加速器<br> <img src="https://images2.imgbox.com/87/7a/Mxd4Nnoz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/63/46/8p3VA0Fw_o.png" alt="在这里插入图片描述"></li><li>配置</li></ol> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> <span class="token function">mkdir</span> -p /etc/docker
<span class="token function">sudo</span> <span class="token function">tee</span> /etc/docker/daemon.json <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
{
  "registry-mirrors": ["xxxxx"]
}
EOF</span>
<span class="token function">sudo</span> systemctl daemon-reload
<span class="token function">sudo</span> systemctl restart <span class="token function">docker</span>
</code></pre> 
<h2><a id="_123"></a>二、常用命令</h2> 
<h3><a id="0__124"></a>0. 预备</h3> 
<pre><code class="prism language-shell"><span class="token function">docker</span> version  <span class="token comment"># 显示docker版本信息</span>
<span class="token function">docker</span> info     <span class="token comment"># 显示docker的系统信息，包括镜像和容器数量</span>
<span class="token function">docker</span> 命令 --help   <span class="token comment"># 帮助命令</span>
</code></pre> 
<p>帮助文档地址：https://docs.docker.com/reference/</p> 
<p><img src="https://images2.imgbox.com/25/25/opm1guYM_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1_134"></a>1.镜像命令</h3> 
<h4><a id="11__135"></a>1.1 查看所有本地主机的镜像</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 查看所有本地主机的镜像</span>
<span class="token function">docker</span> images  

REPOSITORY    TAG       IMAGE ID       CREATED        SIZE
hello-world   latest    feb5d9fea6a5   <span class="token number">6</span> months ago   <span class="token number">13</span>.3kB

<span class="token comment"># 解释：</span>
REPOSITORY	镜像的仓库源
TAG       	镜像的标签
IMAGE ID	镜像的标签
CREATED		镜像的创建时间
SIZE		镜像的大小

<span class="token comment"># 可选项</span>
Options:
  -a, --all         Show all images <span class="token punctuation">(</span>default hides intermediate images<span class="token punctuation">)</span> <span class="token comment">#列出所有镜像</span>
  -q, --quiet       Only show numeric IDs <span class="token comment"># 只显示镜像的id</span>
</code></pre> 
<hr> 
<h4><a id="12__156"></a>1.2 搜索镜像</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 搜索镜像</span>
<span class="token function">docker</span> search

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker search mysql</span>
NAME                             DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
mysql                            MySQL is a widely used, open-source relation…   <span class="token number">12413</span>     <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>       
mariadb                          MariaDB Server is a high performing <span class="token function">open</span> sou…   <span class="token number">4782</span>      <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>       
mysql/mysql-server               Optimized MySQL Server Docker images. Create…   <span class="token number">918</span>                  <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>
percona                          Percona Server is a fork of the MySQL relati…   <span class="token number">575</span>       <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>       


<span class="token comment">## 可选项：</span>
Options:
  -f, --filter filter   Filter output based on conditions provided
      --format string   Pretty-print search using a Go template
      --limit int       Max number of search results <span class="token punctuation">(</span>default <span class="token number">25</span><span class="token punctuation">)</span>
      --no-trunc        Don't truncate output

<span class="token comment"># --filter=STARS=3000 #过滤，搜索出来的镜像收藏STARS数量大于3000的</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker search mysql --filter=STARS=3000</span>
NAME      DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED
mysql     MySQL is a widely used, open-source relation…   <span class="token number">12413</span>     <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>       
mariadb   MariaDB Server is a high performing <span class="token function">open</span> sou…   <span class="token number">4782</span>      <span class="token punctuation">[</span>OK<span class="token punctuation">]</span>       
</code></pre> 
<p>搜索镜像【也可以在docker hub上找下载，比较麻烦，没有命令用起来舒服】</p> 
<hr> 
<h4><a id="13__184"></a>1.3 下载镜像</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 下载镜像</span>
<span class="token function">docker</span> pull 镜像名<span class="token punctuation">[</span>:tag<span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker pull tomcat:8</span>
<span class="token number">8</span>: Pulling from library/tomcat <span class="token comment">#如果不写tag，默认就是latest</span>
90fe46dd8199: Already exists   <span class="token comment">#分层下载： docker image 的核心 联合文件系统（之前下载过的会，不用下载，共用）</span>
35a4f1977689: Already exists 
bbc37f14aded: Already exists 
74e27dc593d4: Already exists 
93a01fbfad7f: Already exists 
1478df405869: Pull complete 
64f0dd11682b: Pull complete 
68ff4e050d11: Pull complete 
f576086003cf: Pull complete 
3b72593ce10e: Pull complete 
Digest: sha256:0c6234e7ec9d10ab32c06423ab829b32e3183ba5bf2620ee66de866df <span class="token comment"># 签名防伪</span>
Status: Downloaded newer image <span class="token keyword">for</span> tomcat:8
docker.io/library/tomcat:8 <span class="token comment">#真实地址</span>

<span class="token comment">#等价于</span>
<span class="token function">docker</span> pull tomcat:8
<span class="token function">docker</span> pull docker.io/library/tomcat:8
</code></pre> 
<hr> 
<h4><a id="14__210"></a>1.4 删除镜像</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 删除镜像</span>
<span class="token function">docker</span> rmi -f 镜像id <span class="token comment">#删除指定id的镜像</span>
<span class="token function">docker</span> rmi -f 容器id 容器id <span class="token punctuation">..</span>. <span class="token comment"># 删除多个容器</span>
<span class="token function">docker</span> rmi -f <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> images -aq<span class="token variable">)</span></span> <span class="token comment"># 删除全部的容器</span>
</code></pre> 
<h3><a id="2_217"></a>2.容器命令</h3> 
<p>说明：有了镜像才可以创建容器</p> 
<p>以centos镜像为例：</p> 
<pre><code class="prism language-shell"><span class="token comment">#docker中下载centos</span>
<span class="token function">docker</span> pull centos
<span class="token comment">#查看镜像</span>
<span class="token function">docker</span> images
<span class="token comment">#测试启动，bash启动</span>
<span class="token function">docker</span> run -it centos /bin/bash

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -it centos /bin/bash</span>
<span class="token punctuation">[</span>root@0687c291327c /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var

<span class="token comment"># 退回主机</span>
<span class="token builtin class-name">exit</span>   <span class="token comment"># 直接容器停止并推出</span>
Ctrl + P + Q <span class="token comment"># 容器不停止退出</span>
</code></pre> 
<h4><a id="21__237"></a>2.1 启动容器：</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run <span class="token punctuation">[</span>可选参数<span class="token punctuation">]</span> image <span class="token operator">|</span> <span class="token function">docker</span> container run <span class="token punctuation">[</span>可选参数<span class="token punctuation">]</span> image 
<span class="token comment">#参书说明</span>
--name<span class="token operator">=</span><span class="token string">"Name"</span>		<span class="token comment">#容器名字 tomcat01 tomcat02 用来区分容器</span>
-d					<span class="token comment">#后台方式运行</span>
-it 				<span class="token comment">#使用交互方式运行，进入容器查看内容</span>
-p					<span class="token comment">#指定容器的端口 -p 8080(宿主机):8080(容器)</span>
		-p ip:主机端口:容器端口
		-p 主机端口:容器端口<span class="token punctuation">(</span>常用<span class="token punctuation">)</span>
		-p 容器端口
		容器端口
-P<span class="token punctuation">(</span>大写<span class="token punctuation">)</span> 		    <span class="token comment"># 随机指定端口</span>
</code></pre> 
<hr> 
<h4><a id="22__252"></a>2.2 查看容器：</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> <span class="token function">ps</span>    <span class="token comment"># 列出所有的运行的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> -a <span class="token comment"># 列出所有的运行的容器 + 最近运行过的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> -a -n<span class="token operator">=</span>?  <span class="token comment"># 列出所有的运行的容器 + 最近运行过的容器 ？个</span>
<span class="token function">docker</span> <span class="token function">ps</span> -q <span class="token comment"># 只显示容器的编号</span>
<span class="token function">docker</span> <span class="token function">ps</span> -aq <span class="token comment"># 只显示容器的编号</span>


<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps -a</span>
CONTAINER ID   IMAGE         COMMAND       CREATED          STATUS                      PORTS     NAMES
0687c291327c   centos        <span class="token string">"/bin/bash"</span>   <span class="token number">4</span> minutes ago    Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">3</span> minutes ago              peaceful_stonebraker
6f0823b20328   hello-world   <span class="token string">"/hello"</span>      <span class="token number">57</span> minutes ago   Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">57</span> minutes ago             inspiring_engelbart

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps -a -n=1</span>
CONTAINER ID   IMAGE     COMMAND       CREATED         STATUS                     PORTS     NAMES
0687c291327c   centos    <span class="token string">"/bin/bash"</span>   <span class="token number">4</span> minutes ago   Exited <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token number">3</span> minutes ago             peaceful_stonebraker
</code></pre> 
<h4><a id="23__273"></a>2.3 删除容器：</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> <span class="token function">rm</span> 容器id   <span class="token comment"># 删除指定的容器，不能删除正在运行的容器，如果要强制删 rm -f</span>
<span class="token function">docker</span> <span class="token function">rm</span> -f <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> -aq<span class="token variable">)</span></span> <span class="token comment"># 删除所有的容器</span>
<span class="token function">docker</span> <span class="token function">ps</span> -a -q<span class="token operator">|</span>xarg <span class="token function">docker</span> <span class="token function">rm</span> <span class="token comment"># 删除所有的容器</span>
</code></pre> 
<hr> 
<h4><a id="24__280"></a>2.4 启动和停止容器：</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> start 容器id    		<span class="token comment"># 启动容器</span>
<span class="token function">docker</span> restart 容器id		<span class="token comment"># 重启容器</span>
<span class="token function">docker</span> stop 容器id			<span class="token comment"># 停止当前正在运行的容器</span>
<span class="token function">docker</span> <span class="token function">kill</span> 容器id			<span class="token comment"># 强制停止当前容器</span>
</code></pre> 
<h3><a id="3_287"></a>3.其他命令</h3> 
<h4><a id="31__288"></a>3.1 后台启动：</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 命令 docker run -d 镜像名</span>

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -d centos</span>
a8f922c255859622ac45ce3a535b7a0e8253329be4756ed6e32265d2dd2fac6c

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps    </span>
CONTAINER ID      IMAGE       COMMAND    CREATED     STATUS   PORTS    NAMES
<span class="token comment"># 问题docker ps. 发现centos 停止了</span>
<span class="token comment"># 常见的坑，docker容器使用后台运行，就必须要有要一个前台进程，docker发现没有应用，就会自动停止</span>
<span class="token comment"># nginx，容器启动后，发现自己没有提供服务，就会立刻停止，就是没有程序了</span>
</code></pre> 
<h4><a id="32__301"></a>3.2 查看日志：</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> logs --help
Options:
      --details        Show extra details provided to logs 
*  -f, --follow         Follow log output
      --since string   Show logs since timestamp <span class="token punctuation">(</span>e.g. <span class="token number">2013</span>-01-02T13:23:37<span class="token punctuation">)</span> or relative <span class="token punctuation">(</span>e.g. 42m <span class="token keyword">for</span> <span class="token number">42</span> minutes<span class="token punctuation">)</span>
*      --tail string    Number of lines to show from the end of the logs <span class="token punctuation">(</span>default <span class="token string">"all"</span><span class="token punctuation">)</span>
*  -t, --timestamps     Show timestamps
      --until string   Show logs before a timestamp <span class="token punctuation">(</span>e.g. <span class="token number">2013</span>-01-02T13:23:37<span class="token punctuation">)</span> or relative <span class="token punctuation">(</span>e.g. 42m <span class="token keyword">for</span> <span class="token number">42</span> minutes<span class="token punctuation">)</span>


<span class="token function">docker</span> run -d centos /bin/sh -c <span class="token string">"while true;do echo 666;sleep 1;done"</span> <span class="token comment">#模拟日志      </span>
<span class="token comment">#显示日志</span>
-tf		<span class="token comment">#显示日志信息（一直更新）</span>
--tail number <span class="token comment">#需要显示日志条数</span>
<span class="token function">docker</span> logs -t --tail n 容器id <span class="token comment">#查看n行日志</span>
<span class="token function">docker</span> logs -ft 容器id <span class="token comment">#跟着日志</span>
</code></pre> 
<h4><a id="33__320"></a>3.3 查看容器中的进程信息：</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 命令 docker top 容器id</span>

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker top 9865999fe479</span>
<span class="token environment constant">UID</span>                 PID                 <span class="token environment constant">PPID</span>                C                   STIME               TTY                 TIME                CMD
root                <span class="token number">12852</span>               <span class="token number">12833</span>               <span class="token number">0</span>                   <span class="token number">22</span>:46               ?                   00:00:00            /bin/sh -c <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token number">666</span><span class="token punctuation">;</span><span class="token function">sleep</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">done</span>
root                <span class="token number">17867</span>               <span class="token number">12852</span>               <span class="token number">0</span>                   <span class="token number">22</span>:49               ?                   00:00:00            /usr/bin/coreutils --coreutils-prog-shebang<span class="token operator">=</span>sleep /usr/bin/sleep <span class="token number">1</span>
</code></pre> 
<h4><a id="34__329"></a>3.4 查看镜像的元数据：</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> inspect 容器id

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker inspect 9865999fe479</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token string">"9865999fe4792a12af884bd8e6bc4ad008ae47b962ba5e310fdf5477d06e1f4e"</span>,
        <span class="token string">"Created"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-15T14:46:44.445308293Z"</span>,
        <span class="token string">"Path"</span><span class="token builtin class-name">:</span> <span class="token string">"/bin/sh"</span>,
        <span class="token string">"Args"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"-c"</span>,
            <span class="token string">"while true;do echo 666;sleep 1;done"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"State"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Status"</span><span class="token builtin class-name">:</span> <span class="token string">"running"</span>,
            <span class="token string">"Running"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"Paused"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Restarting"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"OOMKilled"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Dead"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Pid"</span><span class="token builtin class-name">:</span> <span class="token number">12852</span>,
            <span class="token string">"ExitCode"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"Error"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"StartedAt"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-15T14:46:44.722755109Z"</span>,
            <span class="token string">"FinishedAt"</span><span class="token builtin class-name">:</span> <span class="token string">"0001-01-01T00:00:00Z"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Image"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:5d0da3dc976460b72c77d94c8a1ad043720b0416bfc16c52c45d4847e53fadb6"</span>,
        <span class="token string">"ResolvConfPath"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/containers/9865999fe4792a12af884bd8e6bc4ad008ae47b962ba5e310fdf5477d06e1f4e/resolv.conf"</span>,
        <span class="token string">"HostnamePath"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/containers/9865999fe4792a12af884bd8e6bc4ad008ae47b962ba5e310fdf5477d06e1f4e/hostname"</span>,
        <span class="token string">"HostsPath"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/containers/9865999fe4792a12af884bd8e6bc4ad008ae47b962ba5e310fdf5477d06e1f4e/hosts"</span>,
        <span class="token string">"LogPath"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/containers/9865999fe4792a12af884bd8e6bc4ad008ae47b962ba5e310fdf5477d06e1f4e/9865999fe4792a12af884bd8e6bc4ad008ae47b962ba5e310fdf5477d06e1f4e-json.log"</span>,
        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"/zen_taussig"</span>,
        <span class="token string">"RestartCount"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"overlay2"</span>,
        <span class="token string">"Platform"</span><span class="token builtin class-name">:</span> <span class="token string">"linux"</span>,
        <span class="token string">"MountLabel"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"ProcessLabel"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"AppArmorProfile"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"ExecIDs"</span><span class="token builtin class-name">:</span> null,
        <span class="token string">"HostConfig"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Binds"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"ContainerIDFile"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"LogConfig"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"json-file"</span>,
                <span class="token string">"Config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"NetworkMode"</span><span class="token builtin class-name">:</span> <span class="token string">"default"</span>,
            <span class="token string">"PortBindings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
            <span class="token string">"RestartPolicy"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"no"</span>,
                <span class="token string">"MaximumRetryCount"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"AutoRemove"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"VolumeDriver"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"VolumesFrom"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"CapAdd"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"CapDrop"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"CgroupnsMode"</span><span class="token builtin class-name">:</span> <span class="token string">"host"</span>,
            <span class="token string">"Dns"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"DnsOptions"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"DnsSearch"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"ExtraHosts"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"GroupAdd"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"IpcMode"</span><span class="token builtin class-name">:</span> <span class="token string">"private"</span>,
            <span class="token string">"Cgroup"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Links"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"OomScoreAdj"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"PidMode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Privileged"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"PublishAllPorts"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"ReadonlyRootfs"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"SecurityOpt"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"UTSMode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"UsernsMode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"ShmSize"</span><span class="token builtin class-name">:</span> <span class="token number">67108864</span>,
            <span class="token string">"Runtime"</span><span class="token builtin class-name">:</span> <span class="token string">"runc"</span>,
            <span class="token string">"ConsoleSize"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token number">0</span>,
                <span class="token number">0</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Isolation"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"CpuShares"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"Memory"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"NanoCpus"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"CgroupParent"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"BlkioWeight"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"BlkioWeightDevice"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"BlkioDeviceReadBps"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"BlkioDeviceWriteBps"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"BlkioDeviceReadIOps"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"BlkioDeviceWriteIOps"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"CpuPeriod"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"CpuQuota"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"CpuRealtimePeriod"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"CpuRealtimeRuntime"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"CpusetCpus"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"CpusetMems"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Devices"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
            <span class="token string">"DeviceCgroupRules"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"DeviceRequests"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"KernelMemory"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"KernelMemoryTCP"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"MemoryReservation"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"MemorySwap"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"MemorySwappiness"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"OomKillDisable"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"PidsLimit"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"Ulimits"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"CpuCount"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"CpuPercent"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"IOMaximumIOps"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"IOMaximumBandwidth"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"MaskedPaths"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/proc/asound"</span>,
                <span class="token string">"/proc/acpi"</span>,
                <span class="token string">"/proc/kcore"</span>,
                <span class="token string">"/proc/keys"</span>,
                <span class="token string">"/proc/latency_stats"</span>,
                <span class="token string">"/proc/timer_list"</span>,
                <span class="token string">"/proc/timer_stats"</span>,
                <span class="token string">"/proc/sched_debug"</span>,
                <span class="token string">"/proc/scsi"</span>,
                <span class="token string">"/sys/firmware"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"ReadonlyPaths"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/proc/bus"</span>,
                <span class="token string">"/proc/fs"</span>,
                <span class="token string">"/proc/irq"</span>,
                <span class="token string">"/proc/sys"</span>,
                <span class="token string">"/proc/sysrq-trigger"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"GraphDriver"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Data"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"LowerDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/a576bc4c3377d3992efc6b80ba3a93d2690562265e311a152885e0ed025b2088-init/diff:/var/lib/docker/overlay2/9123fd3ce2d692e8f29431878cfad8dc26c3b37973ab99176f479f3f9fe3f15a/diff"</span>,
                <span class="token string">"MergedDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/a576bc4c3377d3992efc6b80ba3a93d2690562265e311a152885e0ed025b2088/merged"</span>,
                <span class="token string">"UpperDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/a576bc4c3377d3992efc6b80ba3a93d2690562265e311a152885e0ed025b2088/diff"</span>,
                <span class="token string">"WorkDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/a576bc4c3377d3992efc6b80ba3a93d2690562265e311a152885e0ed025b2088/work"</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"overlay2"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Mounts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>,
        <span class="token string">"Config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Hostname"</span><span class="token builtin class-name">:</span> <span class="token string">"9865999fe479"</span>,
            <span class="token string">"Domainname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"User"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"AttachStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStdout"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStderr"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Tty"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"OpenStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"StdinOnce"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Cmd"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/bin/sh"</span>,
                <span class="token string">"-c"</span>,
                <span class="token string">"while true;do echo 666;sleep 1;done"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Image"</span><span class="token builtin class-name">:</span> <span class="token string">"centos"</span>,
            <span class="token string">"Volumes"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"org.label-schema.build-date"</span><span class="token builtin class-name">:</span> <span class="token string">"20210915"</span>,
                <span class="token string">"org.label-schema.license"</span><span class="token builtin class-name">:</span> <span class="token string">"GPLv2"</span>,
                <span class="token string">"org.label-schema.name"</span><span class="token builtin class-name">:</span> <span class="token string">"CentOS Base Image"</span>,
                <span class="token string">"org.label-schema.schema-version"</span><span class="token builtin class-name">:</span> <span class="token string">"1.0"</span>,
                <span class="token string">"org.label-schema.vendor"</span><span class="token builtin class-name">:</span> <span class="token string">"CentOS"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"NetworkSettings"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Bridge"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"SandboxID"</span><span class="token builtin class-name">:</span> <span class="token string">"4c98fe4130129a2c6f7eb38578c8a2032a9756328060dd026c37fce231bf51e8"</span>,
            <span class="token string">"HairpinMode"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"LinkLocalIPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"LinkLocalIPv6PrefixLen"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"Ports"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
            <span class="token string">"SandboxKey"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/run/docker/netns/4c98fe413012"</span>,
            <span class="token string">"SecondaryIPAddresses"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"SecondaryIPv6Addresses"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"EndpointID"</span><span class="token builtin class-name">:</span> <span class="token string">"aa0e4a6dab7e4b283423df17e1bbb65e54458447959a3c0e13acbbb6abb47446"</span>,
            <span class="token string">"Gateway"</span><span class="token builtin class-name">:</span> <span class="token string">"172.17.0.1"</span>,
            <span class="token string">"GlobalIPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"GlobalIPv6PrefixLen"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
            <span class="token string">"IPAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"172.17.0.2"</span>,
            <span class="token string">"IPPrefixLen"</span><span class="token builtin class-name">:</span> <span class="token number">16</span>,
            <span class="token string">"IPv6Gateway"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"02:42:ac:11:00:02"</span>,
            <span class="token string">"Networks"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"bridge"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"IPAMConfig"</span><span class="token builtin class-name">:</span> null,
                    <span class="token string">"Links"</span><span class="token builtin class-name">:</span> null,
                    <span class="token string">"Aliases"</span><span class="token builtin class-name">:</span> null,
                    <span class="token string">"NetworkID"</span><span class="token builtin class-name">:</span> <span class="token string">"e4fba822dc97104a9a319b745f7b00e87a04eaccd49cae3d366aa4cb47a553de"</span>,
                    <span class="token string">"EndpointID"</span><span class="token builtin class-name">:</span> <span class="token string">"aa0e4a6dab7e4b283423df17e1bbb65e54458447959a3c0e13acbbb6abb47446"</span>,
                    <span class="token string">"Gateway"</span><span class="token builtin class-name">:</span> <span class="token string">"172.17.0.1"</span>,
                    <span class="token string">"IPAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"172.17.0.2"</span>,
                    <span class="token string">"IPPrefixLen"</span><span class="token builtin class-name">:</span> <span class="token number">16</span>,
                    <span class="token string">"IPv6Gateway"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                    <span class="token string">"GlobalIPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                    <span class="token string">"GlobalIPv6PrefixLen"</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                    <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"02:42:ac:11:00:02"</span>,
                    <span class="token string">"DriverOpts"</span><span class="token builtin class-name">:</span> null
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<h4><a id="35__542"></a>3.5 进入当前正在运行的容器</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 方式一：</span>

<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it 容器id bashShell

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE     COMMAND                  CREATED          STATUS          PORTS     NAMES
9865999fe479   centos    <span class="token string">"/bin/sh -c 'while t…"</span>   <span class="token number">14</span> minutes ago   Up <span class="token number">14</span> minutes             zen_taussig
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it 9865999fe479 /bin/bash</span>
<span class="token punctuation">[</span>root@9865999fe479 /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
<span class="token punctuation">[</span>root@9865999fe479 /<span class="token punctuation">]</span><span class="token comment"># ps -ef</span>
<span class="token environment constant">UID</span>        PID  <span class="token environment constant">PPID</span>  C STIME TTY          TIME CMD
root         <span class="token number">1</span>     <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">14</span>:46 ?        00:00:00 /bin/sh -c <span class="token keyword">while</span> <span class="token boolean">true</span><span class="token punctuation">;</span><span class="token keyword">do</span> <span class="token builtin class-name">echo</span> <span class="token number">666</span><span class="token punctuation">;</span><span class="token function">sleep</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">done</span>
root       <span class="token number">901</span>     <span class="token number">0</span>  <span class="token number">0</span> <span class="token number">15</span>:01 pts/0    00:00:00 /bin/bash
root       <span class="token number">925</span>     <span class="token number">1</span>  <span class="token number">0</span> <span class="token number">15</span>:01 ?        00:00:00 /usr/bin/coreutils --coreutils-prog-shebang<span class="token operator">=</span>sleep /usr/bin/sleep <span class="token number">1</span>
root       <span class="token number">926</span>   <span class="token number">901</span>  <span class="token number">0</span> <span class="token number">15</span>:01 pts/0    00:00:00 <span class="token function">ps</span> -ef

<span class="token comment"># 方式二：</span>
<span class="token function">docker</span> attach 容器id
正在执行的代码<span class="token punctuation">..</span><span class="token punctuation">..</span>.

<span class="token comment"># 比较：</span>
<span class="token comment"># docker exec  		# 进入容器后开启一个新的终端，可以在里面操作（常用）</span>
<span class="token comment"># docker attach 	# 进入容器正在执行的终端，不会启动新的进程！</span>
</code></pre> 
<h4><a id="36__569"></a>3.6 从容器内拷贝文件到主机上</h4> 
<pre><code class="prism language-shell"><span class="token function">docker</span> <span class="token function">cp</span> 容器id:容器内路径 目的的主机路径

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY    TAG       IMAGE ID       CREATED        SIZE
mysql         <span class="token number">5.7</span>       c20987f18b13   <span class="token number">3</span> months ago   448MB
hello-world   latest    feb5d9fea6a5   <span class="token number">6</span> months ago   <span class="token number">13</span>.3kB
centos        latest    5d0da3dc9764   <span class="token number">7</span> months ago   231MB
<span class="token comment">## 进入docker容器内</span>
<span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># docker attach a0aa07d62a3e</span>
<span class="token punctuation">[</span>root@a0aa07d62a3e /<span class="token punctuation">]</span><span class="token comment"># cd /home</span>
<span class="token punctuation">[</span>root@a0aa07d62a3e home<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token comment">## 在容器内新建一个test.java文件</span>
<span class="token punctuation">[</span>root@a0aa07d62a3e home<span class="token punctuation">]</span><span class="token comment"># touch test.java</span>
<span class="token punctuation">[</span>root@a0aa07d62a3e home<span class="token punctuation">]</span><span class="token comment"># exit</span>
<span class="token builtin class-name">exit</span>
<span class="token comment">## 将这个文件拷贝到主机上</span>
<span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># docker cp a0aa07d62a3e:/home/test.java /home</span>
<span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># ls</span>
lighthouse  test.java  www
</code></pre> 
<p>小结：</p> 
<p><img src="https://images2.imgbox.com/e9/24/eGw62rcE_o.png" alt="在这里插入图片描述"></p> 
<p>命令大全：</p> 
<pre><code class="prism language-shell">  attach      Attach <span class="token builtin class-name">local</span> standard input, output, and error streams to a running container
  <span class="token comment">#当前shell下 attach连接指定运行的镜像</span>
  build       Build an image from a Dockerfile <span class="token comment"># 通过Dockerfile定制镜像</span>
  commit      Create a new image from a container<span class="token string">'s changes #提交当前容器为新的镜像
  cp          Copy files/folders between a container and the local filesystem #拷贝文件
  create      Create a new container #创建一个新的容器
  diff        Inspect changes to files or directories on a container'</span>s filesystem <span class="token comment">#查看docker容器的变化</span>
  events      Get real <span class="token function">time</span> events from the server <span class="token comment"># 从服务获取容器实时时间</span>
  <span class="token builtin class-name">exec</span>        Run a <span class="token builtin class-name">command</span> <span class="token keyword">in</span> a running container <span class="token comment"># 在运行中的容器上运行命令</span>
  <span class="token builtin class-name">export</span>      Export a container's filesystem as a <span class="token function">tar</span> archive <span class="token comment">#导出容器文件系统作为一个tar归档文件[对应import]</span>
  <span class="token function">history</span>     Show the <span class="token function">history</span> of an image <span class="token comment"># 展示一个镜像形成历史</span>
  images      List images <span class="token comment">#列出系统当前的镜像</span>
  <span class="token function">import</span>      Import the contents from a tarball to create a filesystem image <span class="token comment">#从tar包中导入内容创建一个文件系统镜像</span>
  info        Display system-wide information <span class="token comment"># 显示全系统信息</span>
  inspect     Return low-level information on Docker objects <span class="token comment">#查看容器详细信息</span>
  <span class="token function">kill</span>        Kill one or <span class="token function">more</span> running containers <span class="token comment"># kill指定docker容器</span>
  load        Load an image from a <span class="token function">tar</span> archive or STDIN <span class="token comment">#从一个tar包或标准输入中加载一个镜像[对应save]</span>
  login       Log <span class="token keyword">in</span> to a Docker registry <span class="token comment">#</span>
  <span class="token builtin class-name">logout</span>      Log out from a Docker registry
  logs        Fetch the logs of a container
  pause       Pause all processes within one or <span class="token function">more</span> containers
  port        List port mappings or a specific mapping <span class="token keyword">for</span> the container
  <span class="token function">ps</span>          List containers
  pull        Pull an image or a repository from a registry
  push        Push an image or a repository to a registry
  <span class="token function">rename</span>      Rename a container
  restart     Restart one or <span class="token function">more</span> containers
  <span class="token function">rm</span>          Remove one or <span class="token function">more</span> containers
  rmi         Remove one or <span class="token function">more</span> images
  run         Run a <span class="token builtin class-name">command</span> <span class="token keyword">in</span> a new container
  save        Save one or <span class="token function">more</span> images to a <span class="token function">tar</span> archive <span class="token punctuation">(</span>streamed to STDOUT by default<span class="token punctuation">)</span>
  search      Search the Docker Hub <span class="token keyword">for</span> images
  start       Start one or <span class="token function">more</span> stopped containers
  stats       Display a live stream of container<span class="token punctuation">(</span>s<span class="token punctuation">)</span> resource usage statistics
  stop        Stop one or <span class="token function">more</span> running containers
  tag         Create a tag TARGET_IMAGE that refers to SOURCE_IMAGE
  <span class="token function">top</span>         Display the running processes of a container
  unpause     Unpause all processes within one or <span class="token function">more</span> containers
  update      Update configuration of one or <span class="token function">more</span> containers
  version     Show the Docker version information
  <span class="token function">wait</span>        Block <span class="token keyword">until</span> one or <span class="token function">more</span> containers stop, <span class="token keyword">then</span> print their <span class="token builtin class-name">exit</span> codes
</code></pre> 
<h3><a id="4_640"></a>4.练习</h3> 
<h4><a id="41_Nginx_641"></a>4.1 部署Nginx</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 1.搜索镜像，建议去dockerhub上搜索，可以看到帮助文档</span>
<span class="token function">docker</span> search nginx
<span class="token comment"># 2.下载镜像</span>
<span class="token function">docker</span> pull nginx
<span class="token comment"># 3.启动</span>
<span class="token function">docker</span> run -d --name nginx01 -p <span class="token number">6666</span>:80 nginx
<span class="token comment"># 4.查看运行状态</span>
<span class="token function">docker</span> <span class="token function">ps</span>
<span class="token comment"># 5.测试</span>
<span class="token function">curl</span> localhost:6666
</code></pre> 
<h4><a id="42_Tomcat_654"></a>4.2 部署Tomcat</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 官方的使用（用完即删，一般用来做测试）</span>
<span class="token function">docker</span> run -it --rm tomcat:9.0
<span class="token comment"># 1.下载镜像</span>
<span class="token function">docker</span> pull tomcat:9.0
<span class="token comment"># 2.启动运行</span>
<span class="token function">docker</span> run -d -p <span class="token number">6667</span>:8080 --name tomcat01 tomcat:9.0
<span class="token comment">#测试访问有没有问题</span>
<span class="token function">curl</span> localhost:6667

<span class="token comment"># 发现问题：1、linux命令少了。 2.webapps目录为空 </span>
<span class="token comment"># 原因：阿里云镜像的原因，阿里云默认是最小的镜像，所以不必要的都剔除掉</span>
<span class="token comment"># 保证最小可运行的环境！</span>
<span class="token comment"># 解决方案：</span>
<span class="token comment"># 将webapps.dist下的文件都拷贝到webapps下即可</span>

<span class="token comment"># 进入容器</span>
<span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it tomcat01 /bin/bash
<span class="token comment"># 拷贝webapps.dist 内容给webapps</span>
<span class="token function">cp</span> -r webapps.dist/* webapps 
</code></pre> 
<h4><a id="43__es__kibana_676"></a>4.3 部署 es + kibana</h4> 
<pre><code class="prism language-shell"><span class="token comment"># es 暴露的端口很多</span>
<span class="token comment"># es 十分的耗内存</span>
<span class="token comment"># es 的数据一般需要放置的安全目录 ！ 挂载</span>
<span class="token comment"># 1.启动</span>
<span class="token function">docker</span> run -d --name elasticsearch -p <span class="token number">9200</span>:9200 -p <span class="token number">9300</span>:9300 -e <span class="token string">"discovery.type=single-node"</span> elasticsearch:7.6.2
<span class="token comment"># 2.测试</span>
<span class="token function">curl</span> localhost:9200
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"name"</span> <span class="token builtin class-name">:</span> <span class="token string">"d73ad2f22dd3"</span>,
  <span class="token string">"cluster_name"</span> <span class="token builtin class-name">:</span> <span class="token string">"docker-cluster"</span>,
  <span class="token string">"cluster_uuid"</span> <span class="token builtin class-name">:</span> <span class="token string">"atFKgANxS8CzgIyCB8PGxA"</span>,
  <span class="token string">"version"</span> <span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"number"</span> <span class="token builtin class-name">:</span> <span class="token string">"7.6.2"</span>,
    <span class="token string">"build_flavor"</span> <span class="token builtin class-name">:</span> <span class="token string">"default"</span>,
    <span class="token string">"build_type"</span> <span class="token builtin class-name">:</span> <span class="token string">"docker"</span>,
    <span class="token string">"build_hash"</span> <span class="token builtin class-name">:</span> <span class="token string">"ef48eb35cf30adf4db14086e8aabd07ef6fb113f"</span>,
    <span class="token string">"build_date"</span> <span class="token builtin class-name">:</span> <span class="token string">"2020-03-26T06:34:37.794943Z"</span>,
    <span class="token string">"build_snapshot"</span> <span class="token builtin class-name">:</span> false,
    <span class="token string">"lucene_version"</span> <span class="token builtin class-name">:</span> <span class="token string">"8.4.0"</span>,
    <span class="token string">"minimum_wire_compatibility_version"</span> <span class="token builtin class-name">:</span> <span class="token string">"6.8.0"</span>,
    <span class="token string">"minimum_index_compatibility_version"</span> <span class="token builtin class-name">:</span> <span class="token string">"6.0.0-beta1"</span>
  <span class="token punctuation">}</span>,
  <span class="token string">"tagline"</span> <span class="token builtin class-name">:</span> <span class="token string">"You Know, for Search"</span>
<span class="token punctuation">}</span>
<span class="token comment"># 2.查看内存消耗</span>
<span class="token function">docker</span> stats
<span class="token comment"># 3.停止</span>

<span class="token comment"># 1.增加内存限制启动</span>
<span class="token function">docker</span> run -d --name elasticsearch -p <span class="token number">9200</span>:9200 -p <span class="token number">9300</span>:9300 -e <span class="token string">"discovery.type=single-node"</span> -e <span class="token assign-left variable">ES_JAVA_OPTS</span><span class="token operator">=</span><span class="token string">"-Xms64m -Xmx512m"</span> elasticsearch:7.6.2
<span class="token comment"># 2.查看内存消耗</span>
<span class="token function">docker</span> stats 容器id
</code></pre> 
<h2><a id="_711"></a>三、可视化工具</h2> 
<p>Docker图形化界面管理工具！提供一个后台面板供我们操作！</p> 
<h3><a id="1_portainer_713"></a>1. portainer</h3> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run -d -p <span class="token number">8088</span>:9000 <span class="token punctuation">\</span>
<span class="token operator">&gt;</span> --restart<span class="token operator">=</span>always -v /var/run/docker.sock:/var/run/docker.sock --privileged<span class="token operator">=</span>true portainer/portainer

内网测试
<span class="token function">curl</span> localhost:8088
</code></pre> 
<p>外网测试<br> <img src="https://images2.imgbox.com/bb/1e/1LN7rGQ8_o.png" alt="在这里插入图片描述"><br> 可能遇到的错误：<br> <img src="https://images2.imgbox.com/b7/de/wmKTpGAy_o.png" alt="在这里插入图片描述"><br> 在portainer容器启动五分钟后，还没有创建管理员账号，portainer容器就会自动关闭。重新启动就好了。</p> 
<p><img src="https://images2.imgbox.com/ac/b6/nIihj6dj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/75/43/minjfujI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_RancherCICD_729"></a>2. Rancher（CI/CD）</h3> 
<h2><a id="Docker_731"></a>四、Docker镜像</h2> 
<h3><a id="1__732"></a>1. 镜像是什么？</h3> 
<p>镜像是一种轻量级、可执行的独立软件包，用来打包软件运行环境和基于运行环境开发的软件，它包含运行某个软件所需的所有内容，包括代码、运行时库、环境变量和配置文件。</p> 
<p>所有应用，直接打包docker镜像，就可以直接跑起来！</p> 
<p>如何得到镜像</p> 
<ul><li>从远程仓库下载</li><li>别人拷贝给你</li><li>自己制作一个镜像 DockerFile</li></ul> 
<hr> 
<h3><a id="2_Docker_744"></a>2. Docker镜像加载原理</h3> 
<h4><a id="21_UnionFs__746"></a>2.1 UnionFs （联合文件系统）</h4> 
<p>UnionFs（联合文件系统）：Union文件系统（UnionFs）是一种<code>分层、轻量级并且高性能的文件系统</code>，他支持对文件系统的修改作为<code>一次提交来一层层的叠加</code>，同时可以将不同目录挂载到同一个虚拟文件系统下（ unite several directories into a single virtual filesystem)。Union文件系统是 Docker镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</p> 
<p>特性：一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录。</p> 
<h4><a id="22_Docker_752"></a>2.2 Docker镜像加载原理</h4> 
<p>Docker的镜像实际上由一层一层的文件系统组成，这种层级的文件系统UnionFS。<br> boots(boot file system）主要包含 bootloader和 Kernel, bootloader主要是引导加 kernel, Linux刚启动时会加bootfs文件系统，在 Docker镜像的最底层是 boots。这一层与我们典型的Linux/Unix系统是一样的，包含boot加載器和内核。当boot加载完成之后整个内核就都在内存中了，此时内存的使用权已由 bootfs转交给内核，此时系统也会卸载bootfs。<br> rootfs（root file system),在 bootfs之上。包含的就是典型 Linux系统中的/dev,/proc,/bin,/etc等标准目录和文件。 rootfs就是各种不同的操作系统发行版，比如 Ubuntu, Centos等等。<br> <img src="https://images2.imgbox.com/ef/b5/f25vtWOd_o.png" alt="在这里插入图片描述"><br> 平时我们安装进虚拟机的CentOS都是好几个G，为什么Docker这里才200M？</p> 
<p><img src="https://images2.imgbox.com/ad/b3/Z4BHrLP5_o.png" alt="在这里插入图片描述"><br> 对于个精简的OS,rootfs可以很小，只需要包合最基本的命令，工具和程序库就可以了，因为底层直接用Host的kernel，自己只需要提供rootfs就可以了。由此可见对于不同的Linux发行版， boots基本是一致的， rootfs会有差別，因此不同的发行版可以公用bootfs.</p> 
<p><code>虚拟机是分钟级别，容器是秒级！</code></p> 
<h3><a id="3_765"></a>3.分层理解</h3> 
<blockquote> 
 <p>分层的镜像</p> 
</blockquote> 
<p>我们可以去下载一个镜像，注意观察下载的日志输出，可以看到是一层层的在下载</p> 
<p><img src="https://images2.imgbox.com/d7/f9/zcFfeYvf_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>思考：为什么Docker镜像要采用这种分层的结构呢？</p> 
</blockquote> 
<p>最大的好处，我觉得莫过于<mark>资源共享</mark>了！比如有多个镜像都从相同的Base镜像构建而来，那么宿主机只需在磁盘上保留一份base镜像，同时内存中也只需要加载一份base镜像，这样就可以为所有的容器服务了，而且镜像的每一层都可以被共享。</p> 
<p>查看镜像分层的方式可以通过docker image inspect 命令</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> image inspect redis          

<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:f9b9909726890b00d2098081642edf32e5211b7ab53563929a47f250bcdc1d7c"</span>,
        <span class="token string">"RepoTags"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"redis:latest"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"RepoDigests"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token string">"redis@sha256:399a9b17b8522e24fbe2fd3b42474d4bb668d3994153c4b5d38c3dafd5903e32"</span>
        <span class="token punctuation">]</span>,
        <span class="token string">"Parent"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"Comment"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"Created"</span><span class="token builtin class-name">:</span> <span class="token string">"2020-05-02T01:40:19.112130797Z"</span>,
        <span class="token string">"Container"</span><span class="token builtin class-name">:</span> <span class="token string">"d30c0bcea88561bc5139821227d2199bb027eeba9083f90c701891b4affce3bc"</span>,
        <span class="token string">"ContainerConfig"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Hostname"</span><span class="token builtin class-name">:</span> <span class="token string">"d30c0bcea885"</span>,
            <span class="token string">"Domainname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"User"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"AttachStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStdout"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStderr"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"ExposedPorts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"6379/tcp"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"Tty"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"OpenStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"StdinOnce"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,
                <span class="token string">"GOSU_VERSION=1.12"</span>,
                <span class="token string">"REDIS_VERSION=6.0.1"</span>,
                <span class="token string">"REDIS_DOWNLOAD_URL=http://download.redis.io/releases/redis-6.0.1.tar.gz"</span>,
                <span class="token string">"REDIS_DOWNLOAD_SHA=b8756e430479edc162ba9c44dc89ac394316cd482f2dc6b91bcd5fe12593f273"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Cmd"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"/bin/sh"</span>,
                <span class="token string">"-c"</span>,
                <span class="token string">"#(nop) "</span>,
                <span class="token string">"CMD [<span class="token entity" title='\"'>\"</span>redis-server<span class="token entity" title='\"'>\"</span>]"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"ArgsEscaped"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"Image"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:704c602fa36f41a6d2d08e49bd2319ccd6915418f545c838416318b3c29811e0"</span>,
            <span class="token string">"Volumes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"/data"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/data"</span>,
            <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"docker-entrypoint.sh"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"DockerVersion"</span><span class="token builtin class-name">:</span> <span class="token string">"18.09.7"</span>,
        <span class="token string">"Author"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
        <span class="token string">"Config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Hostname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"Domainname"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"User"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
            <span class="token string">"AttachStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStdout"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"AttachStderr"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"ExposedPorts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"6379/tcp"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"Tty"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"OpenStdin"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"StdinOnce"</span><span class="token builtin class-name">:</span> false,
            <span class="token string">"Env"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span>,
                <span class="token string">"GOSU_VERSION=1.12"</span>,
                <span class="token string">"REDIS_VERSION=6.0.1"</span>,
                <span class="token string">"REDIS_DOWNLOAD_URL=http://download.redis.io/releases/redis-6.0.1.tar.gz"</span>,
                <span class="token string">"REDIS_DOWNLOAD_SHA=b8756e430479edc162ba9c44dc89ac394316cd482f2dc6b91bcd5fe12593f273"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"Cmd"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"redis-server"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"ArgsEscaped"</span><span class="token builtin class-name">:</span> true,
            <span class="token string">"Image"</span><span class="token builtin class-name">:</span> <span class="token string">"sha256:704c602fa36f41a6d2d08e49bd2319ccd6915418f545c838416318b3c29811e0"</span>,
            <span class="token string">"Volumes"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"/data"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"WorkingDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/data"</span>,
            <span class="token string">"Entrypoint"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"docker-entrypoint.sh"</span>
            <span class="token punctuation">]</span>,
            <span class="token string">"OnBuild"</span><span class="token builtin class-name">:</span> null,
            <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> null
        <span class="token punctuation">}</span>,
        <span class="token string">"Architecture"</span><span class="token builtin class-name">:</span> <span class="token string">"amd64"</span>,
        <span class="token string">"Os"</span><span class="token builtin class-name">:</span> <span class="token string">"linux"</span>,
        <span class="token string">"Size"</span><span class="token builtin class-name">:</span> <span class="token number">104101893</span>,
        <span class="token string">"VirtualSize"</span><span class="token builtin class-name">:</span> <span class="token number">104101893</span>,
        <span class="token string">"GraphDriver"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Data"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"LowerDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/adea96bbe6518657dc2d4c6331a807eea70567144abda686588ef6c3bb0d778a/diff:/var/lib/docker/overlay2/66abd822d34dc6446e6bebe73721dfd1dc497c2c8063c43ffb8cf8140e2caeb6/diff:/var/lib/docker/overlay2/d19d24fb6a24801c5fa639c1d979d19f3f17196b3c6dde96d3b69cd2ad07ba8a/diff:/var/lib/docker/overlay2/a1e95aae5e09ca6df4f71b542c86c677b884f5280c1d3e3a1111b13644b221f9/diff:/var/lib/docker/overlay2/cd90f7a9cd0227c1db29ea992e889e4e6af057d9ab2835dd18a67a019c18bab4/diff"</span>,
                <span class="token string">"MergedDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/afa1de233453b60686a3847854624ef191d7bc317fb01e015b4f06671139fb11/merged"</span>,
                <span class="token string">"UpperDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/afa1de233453b60686a3847854624ef191d7bc317fb01e015b4f06671139fb11/diff"</span>,
                <span class="token string">"WorkDir"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/overlay2/afa1de233453b60686a3847854624ef191d7bc317fb01e015b4f06671139fb11/work"</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"overlay2"</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"RootFS"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"layers"</span>,
            <span class="token string">"Layers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token string">"sha256:c2adabaecedbda0af72b153c6499a0555f3a769d52370469d8f6bd6328af9b13"</span>,
                <span class="token string">"sha256:744315296a49be711c312dfa1b3a80516116f78c437367ff0bc678da1123e990"</span>,
                <span class="token string">"sha256:379ef5d5cb402a5538413d7285b21aa58a560882d15f1f553f7868dc4b66afa8"</span>,
                <span class="token string">"sha256:d00fd460effb7b066760f97447c071492d471c5176d05b8af1751806a1f905f8"</span>,
                <span class="token string">"sha256:4d0c196331523cfed7bf5bafd616ecb3855256838d850b6f3d5fba911f6c4123"</span>,
                <span class="token string">"sha256:98b4a6242af2536383425ba2d6de033a510e049d9ca07ff501b95052da76e894"</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Metadata"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"LastTagTime"</span><span class="token builtin class-name">:</span> <span class="token string">"0001-01-01T00:00:00Z"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
</code></pre> 
<p>理解：</p> 
<p>所有的 Docker镜像都起始于一个基础镜像层，当进行修改或培加新的内容时，就会在当前镜像层之上，创建新的镜像层。</p> 
<p>举一个简单的例子，假如基于 Ubuntu Linux16.04创建一个新的镜像，这就是新镜像的第一层；如果在该镜像中添加 Python包，就会在基础镜像层之上创建第二个镜像层；如果继续添加一个安全补丁，就会创健第三个镜像层该像当前已经包含3个镜像层，如下图所示（这只是一个用于演示的很简单的例子）。</p> 
<p>在添加额外的镜像层的同时，镜像始终保持是当前所有镜像的组合，理解这一点.</p> 
<p><img src="https://images2.imgbox.com/cd/ae/NHRt0FDY_o.png" alt="在这里插入图片描述"></p> 
<p>在添加额外的镜像层的同时，镜像始终保持是当前所有镜像的组合，理解这一点非常重要。下图中举了一个简单的例子，每个镜像层包含3个文件，而镜像包含了来自两个镜像层的6个文件。</p> 
<p><img src="https://images2.imgbox.com/c3/80/USoxWt0Y_o.png" alt="在这里插入图片描述"><br> 上图中的镜像层跟之前图中的略有区別，主要目的是便于展示文件<br> 下图中展示了一个稍微复杂的三层镜像，在外部看来整个镜像只有6个文件，这是因为最上层中的文件7是文件5的一个更新版。</p> 
<p><img src="https://images2.imgbox.com/f7/16/XJCV1uyK_o.png" alt="在这里插入图片描述"></p> 
<p>这种情況下，上层镜像层中的文件覆盖了底层镜像层中的文件。这样就使得文件的更新版本作为一个新镜像层添加到镜像当中</p> 
<p>Docker通过存储引擎（新版本采用快照机制）的方式来实现镜像层堆栈，并保证多镜像层对外展示为统一的文件系统</p> 
<p>Linux上可用的存储引撃有AUFS、 Overlay2、 Device Mapper、Btrfs以及ZFS。顾名思义，每种存储引擎都基于 Linux中对应的文件系统或者块设备技术，井且每种存储引擎都有其独有的性能特点。</p> 
<p>Docker在 Windows上仅支持 windowsfilter 一种存储引擎，该引擎基于NTFS文件系统之上实现了分层和CoW [1]。</p> 
<p>下图展示了与系统显示相同的三层镜像。所有镜像层堆并合井，对外提供统一的视图。</p> 
<p><img src="https://images2.imgbox.com/d8/4c/p43aTrnG_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>特点</p> 
</blockquote> 
<p>Docker 镜像都是只读的，当容器启动时，一个新的可写层加载到镜像的顶部！</p> 
<p>这一层就是我们通常说的容器层，容器之下的都叫镜像层！</p> 
<p><img src="https://images2.imgbox.com/9a/bb/ozwUOzOX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4_commit_935"></a>4. commit镜像</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 提交容器成为一个新的副本</span>
<span class="token function">docker</span> commit 

<span class="token comment"># 命令和git原理类似</span>
<span class="token function">docker</span> commit -m<span class="token operator">=</span><span class="token string">"描述信息"</span> -a<span class="token operator">=</span><span class="token string">"作者"</span> 容器id 目标镜像名:<span class="token punctuation">[</span>TAG<span class="token punctuation">]</span>
</code></pre> 
<p>实战测试：</p> 
<ol><li>启动一个默认tomcat</li><li>默认tomcat没有webapps应用</li><li>自己拷贝了基本的文件</li></ol> 
<pre><code class="prism language-shell"><span class="token comment"># 1、启动一个默认的tomcat</span>
<span class="token punctuation">[</span>root@iz2zeak7sgj6i7hrb2g862z ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -p 8080:8080 tomcat</span>
de57d0ace5716d27d0e3a7341503d07ed4695ffc266aef78e0a855b270c4064e

<span class="token comment"># 2、发现这个默认的tomcat 是没有webapps应用，官方的镜像默认webapps下面是没有文件的！</span>
<span class="token comment">#docker exec -it 容器id /bin/bash</span>
<span class="token punctuation">[</span>root@iz2zeak7sgj6i7hrb2g862z ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it de57d0ace571 /bin/bash</span>
root@de57d0ace571:/usr/local/tomcat<span class="token comment"># </span>

<span class="token comment"># 3、从webapps.dist拷贝文件进去webapp</span>
root@de57d0ace571:/usr/local/tomcat<span class="token comment"># cp -r webapps.dist/* webapps</span>
root@de57d0ace571:/usr/local/tomcat<span class="token comment"># cd webapps</span>
root@de57d0ace571:/usr/local/tomcat/webapps<span class="token comment"># ls</span>
ROOT  docs  examples  host-manager  manager

<span class="token comment"># 4、将操作过的容器通过commit调教为一个镜像！我们以后就使用我们修改过的镜像即可，而不需要每次都重新拷贝webapps.dist下的文件到webapps了，这就是我们自己的一个修改的镜像。</span>
<span class="token function">docker</span> commit -m<span class="token operator">=</span><span class="token string">"描述信息"</span> -a<span class="token operator">=</span><span class="token string">"作者"</span> 容器id 目标镜像名:<span class="token punctuation">[</span>TAG<span class="token punctuation">]</span>
<span class="token function">docker</span> commit -a<span class="token operator">=</span><span class="token string">"xiaohang"</span> -m<span class="token operator">=</span><span class="token string">"add webapps app"</span> 容器id tomcat02:1.0

<span class="token punctuation">[</span>root@iz2zeak7sgj6i7hrb2g862z ~<span class="token punctuation">]</span><span class="token comment"># docker commit -a="csp提交的" -m="add webapps app" de57d0ace571 tomcat02.1.0</span>
sha256:d5f28a0bb0d0b6522fdcb56f100d11298377b2b7c51b9a9e621379b01cf1487e

<span class="token punctuation">[</span>root@iz2zeak7sgj6i7hrb2g862z ~<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
tomcat02.1.0          latest              d5f28a0bb0d0        <span class="token number">14</span> seconds ago      652MB
tomcat                latest              1b6b1fe7261e        <span class="token number">5</span> days ago          647MB
nginx                 latest              9beeba249f3e        <span class="token number">5</span> days ago          127MB
mysql                 <span class="token number">5.7</span>                 b84d68d0a7db        <span class="token number">5</span> days ago          448MB
elasticsearch         <span class="token number">7.6</span>.2               f29a1ee41030        <span class="token number">8</span> weeks ago         791MB
portainer/portainer   latest              2869fc110bf7        <span class="token number">2</span> months ago        <span class="token number">78</span>.6MB
centos                latest              470671670cac        <span class="token number">4</span> months ago        237MB
hello-world           latest              bf756fb1ae65        <span class="token number">4</span> months ago        <span class="token number">13</span>.3kB
</code></pre> 
<h2><a id="_983"></a>五、容器数据卷</h2> 
<h3><a id="1__984"></a>1. 什么是容器数据卷？</h3> 
<p>将应用和环境打包成一个镜像！</p> 
<p>数据？如果数据都在容器中，那么我们容器删除，数据就会丢失！</p> 
<p>需求：<mark>数据可以持久化</mark></p> 
<p>MySQL，容器删除了，删库跑路！需求：MySQL数据可以存储在本地！</p> 
<p>容器之间可以有一个<mark>数据共享</mark>的技术！Docker容器中产生的数据，<mark>同步</mark>到本地！</p> 
<p>这就是卷技术！目录的挂载，将我们容器内的目录，挂载到Linux上面！</p> 
<p>总结一句话：<mark>容器的持久化和同步操作！容器间也是可以数据共享的！</mark></p> 
<h3><a id="2__1000"></a>2. 使用容器数据卷</h3> 
<p>1.方式一：直接使用命令来挂载 -v</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run -it -v 主机目录:容器内目录

测试：
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -it -v /home/ceshi:/home centos /bin/bash</span>
<span class="token punctuation">[</span>root@756b8fb5faa6 /<span class="token punctuation">]</span><span class="token comment"># [root@VM-24-12-centos ~]# docker ps</span>
CONTAINER ID   IMAGE                 COMMAND             CREATED          STATUS          PORTS                                       NAMES
756b8fb5faa6   centos                <span class="token string">"/bin/bash"</span>         <span class="token number">29</span> seconds ago   Up <span class="token number">28</span> seconds                                               modest_elbakyan
7cf1763a18b1   portainer/portainer   <span class="token string">"/portainer"</span>        <span class="token number">26</span> hours ago     Up <span class="token number">26</span> hours     <span class="token number">0.0</span>.0.0:8088-<span class="token operator">&gt;</span><span class="token number">9000</span>/tcp, :::8088-<span class="token operator">&gt;</span><span class="token number">9000</span>/tcp   adoring_knuth
797b64907651   tomcat:9.0            <span class="token string">"catalina.sh run"</span>   <span class="token number">2</span> days ago       Up <span class="token number">42</span> minutes   <span class="token number">0.0</span>.0.0:80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp, :::80-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp       tomcat03
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker inspect 756b8fb5faa6</span>
<span class="token string">"Mounts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"bind"</span>,
                <span class="token string">"Source"</span><span class="token builtin class-name">:</span> <span class="token string">"/home/ceshi"</span>,    <span class="token comment"># 主机内地址</span>
                <span class="token string">"Destination"</span><span class="token builtin class-name">:</span> <span class="token string">"/home"</span>,     <span class="token comment"># docker容器内地址</span>
                <span class="token string">"Mode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                <span class="token string">"RW"</span><span class="token builtin class-name">:</span> true,
                <span class="token string">"Propagation"</span><span class="token builtin class-name">:</span> <span class="token string">"rprivate"</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>,
</code></pre> 
<p>测试文件的同步</p> 
<p><img src="https://images2.imgbox.com/eb/af/26e1BHmP_o.png" alt="在这里插入图片描述"></p> 
<p>再来测试！</p> 
<p>1、停止容器</p> 
<p>2、宿主机修改文件</p> 
<p>3、启动容器</p> 
<p>4、容器内的数据依旧是同步的</p> 
<p><img src="https://images2.imgbox.com/cf/26/iogc07Cf_o.png" alt="在这里插入图片描述"></p> 
<p>好处：我们以后修改只需要在本地修改即可，容器内会自动同步！</p> 
<h3><a id="3_MySQL_1042"></a>3. 实战：安装MySQL</h3> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker pull mysql:5.7</span>

-d 后台运行
-p 端口映射
-v 卷挂载
-e 环境配置
--name 容器名字
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=root --name mysql03 mysql:5.7</span>

测试连接（别忘了开放安全组）
</code></pre> 
<p>假设我们将包含mysql的容器删除时，发现，我们挂载到本地的数据卷依旧没有丢失，这就实现了容器数据持久化功能。</p> 
<h3><a id="4__1057"></a>4. 具名和匿名挂载</h3> 
<h4><a id="41__1058"></a>4.1 匿名挂载</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 匿名挂载</span>
-v 容器内路径
<span class="token function">docker</span> run -d -P --name nginx01 -v /etc/nginx nginx

<span class="token comment"># 查看所有的volume的情况</span>
<span class="token function">docker</span> volume <span class="token function">ls</span>


<span class="token punctuation">[</span>root@VM-24-12-centos data<span class="token punctuation">]</span><span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME
<span class="token builtin class-name">local</span>     5e138dd9c45a0042eda0968e4c1392eeff7ff95b9045a2ddcd84a9bf034113f4
<span class="token builtin class-name">local</span>     e157c4fe4cf611bc35ea7f71025d0bc1c59b11d09887a2a6c30e5d90d5c43922


<span class="token comment"># 这里发现，我们在 -v 只写的容器内的路径，没有写容器外的路径！那么究竟挂载到哪个地方呢？</span>
</code></pre> 
<h4><a id="42__1076"></a>4.2 具名挂载（推荐）</h4> 
<pre><code class="prism language-shell"><span class="token comment"># 具名挂载</span>
<span class="token function">docker</span> run -d -P --name nginx02 -v juming-nginx:/etc/nginx nginx

<span class="token punctuation">[</span>root@VM-24-12-centos data<span class="token punctuation">]</span><span class="token comment"># docker volume ls</span>
DRIVER    VOLUME NAME
<span class="token builtin class-name">local</span>     juming-nginx

通过 -v 卷名:容器内路径


查看一下，挂载的地方：
<span class="token punctuation">[</span>root@VM-24-12-centos data<span class="token punctuation">]</span><span class="token comment"># docker volume inspect juming-nginx</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"CreatedAt"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-21T09:20:48+08:00"</span>,
        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,
        <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> null,
        <span class="token string">"Mountpoint"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/volumes/juming-nginx/_data"</span>,
        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"juming-nginx"</span>,
        <span class="token string">"Options"</span><span class="token builtin class-name">:</span> null,
        <span class="token string">"Scope"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
得出结论
所有的docker容器内的卷，没有指定目录的情况下都是在 
/var/lib/docker/volumes/xxx/_data

我们进入对应的目录：
<span class="token punctuation">[</span>root@VM-24-12-centos data<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/docker/volumes/</span>
<span class="token punctuation">[</span>root@VM-24-12-centos volumes<span class="token punctuation">]</span><span class="token comment"># ls</span>
5e138dd9c45a0042eda0968e4c1392eeff7ff95b9045a2ddcd84a9bf034113f4  backingFsBlockDev  e157c4fe4cf611bc35ea7f71025d0bc1c59b11d09887a2a6c30e5d90d5c43922  juming-nginx  metadata.db

<span class="token operator">=</span><span class="token operator">&gt;</span> 我们通过具名挂载可以方便的找到我们的一个卷，大多数情况推荐使用：具名挂载
</code></pre> 
<hr> 
<pre><code class="prism language-shell"><span class="token comment"># 如何确定是具名挂载、匿名挂载、指定路径挂载！</span>
-v 容器内路径   				<span class="token comment"># 匿名挂载</span>
-v 卷名:容器内路径				<span class="token comment"># 具名挂载</span>
-v /宿主机路径:容器内路径		<span class="token comment"># 指定路径挂载</span>
</code></pre> 
<p>拓展：</p> 
<pre><code class="prism language-shell">通过 -v 容器内路径:ro/rw  改变读写权限
ro <span class="token builtin class-name">read</span> only 	<span class="token comment"># 只读(只有宿主机可操作)</span>
rw readwrite 	<span class="token comment"># 可读可写</span>

<span class="token function">docker</span> run -d -P --name nginx03 -v juming-nginx:/etc/nginx:ro nginx
</code></pre> 
<h3><a id="5_Dockerfile_1127"></a>5. 初识Dockerfile</h3> 
<p>Dockerfile 就是用来构建docker镜像的构建文件！命令脚本！<br> 通过这个脚本可以生成镜像，镜像是一层一层的，脚本是一个个的命令，每个命令都是一层！</p> 
<pre><code class="prism language-shell"><span class="token comment"># 新建测试目录</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># cd /home</span>
<span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># mkdir /home/docker-test-volume</span>
<span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># cd docker-test-volume/</span>
<span class="token punctuation">[</span>root@VM-24-12-centos docker-test-volume<span class="token punctuation">]</span><span class="token comment"># pwd</span>
/home/docker-test-volume
<span class="token comment">## 创建一个dockerfile文件，名字可以随机</span>
<span class="token punctuation">[</span>root@VM-24-12-centos docker-test-volume<span class="token punctuation">]</span><span class="token comment"># vim dockerfile1</span>

<span class="token comment">## 文件中的内容</span>
	FROM centos 					<span class="token comment"># 当前这个镜像是以centos为基础的</span>

    VOLUME <span class="token punctuation">[</span><span class="token string">"volume01"</span>,<span class="token string">"volume02"</span><span class="token punctuation">]</span> 	<span class="token comment"># 挂载卷的卷目录列表(多个目录)</span>

    CMD <span class="token builtin class-name">echo</span> <span class="token string">"-----end-----"</span>		<span class="token comment"># 输出一下用于测试</span>
    CMD /bin/bash					<span class="token comment"># 默认走bash控制台</span>
<span class="token comment">##</span>
<span class="token comment"># 这里的每个命令，就是镜像的一层！</span>


<span class="token comment"># 构建出这个镜像 </span>
-f dockerfile1 			<span class="token comment"># f代表file，指这个当前文件的地址(这里是当前目录下的dockerfile1)</span>
-t xiaohang/centos 	<span class="token comment"># t就代表target，指目标目录(注意xiaohang镜像名前不能加斜杠‘/’)</span>
<span class="token builtin class-name">.</span> 						<span class="token comment"># 表示生成在当前目录下</span>
<span class="token function">docker</span> build -f dockerfile1 -t xiaohang/centos <span class="token builtin class-name">.</span>

<span class="token comment"># 生成自己的镜像</span>
<span class="token punctuation">[</span>root@VM-24-12-centos docker-test-volume<span class="token punctuation">]</span><span class="token comment"># docker build -f dockerfile1 -t xiaohang/centos .</span>
Sending build context to Docker daemon  <span class="token number">2</span>.048kB
Step <span class="token number">1</span>/4 <span class="token builtin class-name">:</span> FROM centos
 ---<span class="token operator">&gt;</span> 5d0da3dc9764
Step <span class="token number">2</span>/4 <span class="token builtin class-name">:</span> VOLUME <span class="token punctuation">[</span><span class="token string">"volume01"</span>,<span class="token string">"volume02"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 5e1b9b47c35a
Removing intermediate container 5e1b9b47c35a
 ---<span class="token operator">&gt;</span> 8f41c19d3c3f
Step <span class="token number">3</span>/4 <span class="token builtin class-name">:</span> CMD <span class="token builtin class-name">echo</span> <span class="token string">"----end-----"</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> f6e32a9e0fbe
Removing intermediate container f6e32a9e0fbe
 ---<span class="token operator">&gt;</span> 06d3158c96d5
Step <span class="token number">4</span>/4 <span class="token builtin class-name">:</span> CMD /bin/bash
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 6909b1600a15
Removing intermediate container 6909b1600a15
 ---<span class="token operator">&gt;</span> f36fc725be93
Successfully built f36fc725be93
Successfully tagged xiaohang/centos:latest

<span class="token comment">## 查看自己生成的镜像</span>
<span class="token punctuation">[</span>root@VM-24-12-centos docker-test-volume<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY            TAG       IMAGE ID       CREATED          SIZE
xiaohang/centos       latest    f36fc725be93   <span class="token number">52</span> seconds ago   231MB

<span class="token comment">## 启动自己写的镜像</span>
<span class="token punctuation">[</span>root@VM-24-12-centos docker-test-volume<span class="token punctuation">]</span><span class="token comment"># docker run -it f36fc725be93 /bin/bash</span>
<span class="token punctuation">[</span>root@66ad7f7b420b /<span class="token punctuation">]</span><span class="token comment"># ll    （注意ll没有）</span>
bash: ll: <span class="token builtin class-name">command</span> not found
<span class="token punctuation">[</span>root@66ad7f7b420b /<span class="token punctuation">]</span><span class="token comment"># ls -l</span>
total <span class="token number">56</span>
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">7</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> bin -<span class="token operator">&gt;</span> usr/bin
drwxr-xr-x   <span class="token number">5</span> root root  <span class="token number">360</span> Apr <span class="token number">21</span> 07:13 dev
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">21</span> 07:13 etc
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> home
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">7</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> lib -<span class="token operator">&gt;</span> usr/lib
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">9</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> lib64 -<span class="token operator">&gt;</span> usr/lib64
drwx------   <span class="token number">2</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> lost+found
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> media
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> mnt
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> opt
dr-xr-xr-x <span class="token number">139</span> root root    <span class="token number">0</span> Apr <span class="token number">21</span> 07:13 proc
dr-xr-x---   <span class="token number">2</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> root
drwxr-xr-x  <span class="token number">11</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> run
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">8</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> sbin -<span class="token operator">&gt;</span> usr/sbin
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> srv
dr-xr-xr-x  <span class="token number">13</span> root root    <span class="token number">0</span> Apr <span class="token number">21</span> 07:13 sys
drwxrwxrwt   <span class="token number">7</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> tmp
drwxr-xr-x  <span class="token number">12</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> usr
drwxr-xr-x  <span class="token number">20</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> var
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Apr <span class="token number">21</span> 07:13 volume01
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Apr <span class="token number">21</span> 07:13 volume02
<span class="token comment">## 最后这两个目录就是我们生成镜像的时候自动挂载的，数据卷目录</span>
</code></pre> 
<p>思考： 这个卷和外部一定有一个同步的目录！！！</p> 
<pre><code class="prism language-shell">匿名挂载：

<span class="token comment">## 文件中的内容</span>
	<span class="token punctuation">..</span>.
    VOLUME <span class="token punctuation">[</span><span class="token string">"volume01"</span>,<span class="token string">"volume02"</span><span class="token punctuation">]</span> 	<span class="token comment"># 挂载卷的卷目录列表(多个目录)</span>
    <span class="token punctuation">..</span>.
<span class="token comment">##</span>

<span class="token comment">## 查看一下卷挂载的路径：</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                 COMMAND                  CREATED          STATUS         PORTS                                                  NAMES
fb03c0ac928e   f36fc725be93          <span class="token string">"/bin/bash"</span>              <span class="token number">10</span> seconds ago   Up <span class="token number">9</span> seconds                                                          agitated_napier
48094937fd09   mysql:5.7             <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">15</span> hours ago     Up <span class="token number">15</span> hours    <span class="token number">33060</span>/tcp, <span class="token number">0.0</span>.0.0:3310-<span class="token operator">&gt;</span><span class="token number">3306</span>/tcp, :::3310-<span class="token operator">&gt;</span><span class="token number">3306</span>/tcp   mysql03
7cf1763a18b1   portainer/portainer   <span class="token string">"/portainer"</span>             <span class="token number">3</span> days ago       Up <span class="token number">3</span> days      <span class="token number">0.0</span>.0.0:8088-<span class="token operator">&gt;</span><span class="token number">9000</span>/tcp, :::8088-<span class="token operator">&gt;</span><span class="token number">9000</span>/tcp              adoring_knuth
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker inspect fb03c0ac928e</span>


<span class="token string">"Mounts"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"volume"</span>,
                <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"9fe1401672d9c3e97cdf28147fa6164da59bcf08a762de24a323180ced0de948"</span>,
                <span class="token string">"Source"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/volumes/9fe1401672d9c3e97cdf28147fa6164da59bcf08a762de24a323180ced0de948/_data"</span>,
                <span class="token string">"Destination"</span><span class="token builtin class-name">:</span> <span class="token string">"volume01"</span>,
                <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,
                <span class="token string">"Mode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                <span class="token string">"RW"</span><span class="token builtin class-name">:</span> true,
                <span class="token string">"Propagation"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
            <span class="token punctuation">}</span>,
            <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Type"</span><span class="token builtin class-name">:</span> <span class="token string">"volume"</span>,
                <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"7c33e40060a3b2ae4e02f9748c46d011d5454ce7d6d109b47edc997b89069e94"</span>,
                <span class="token string">"Source"</span><span class="token builtin class-name">:</span> <span class="token string">"/var/lib/docker/volumes/7c33e40060a3b2ae4e02f9748c46d011d5454ce7d6d109b47edc997b89069e94/_data"</span>,
                <span class="token string">"Destination"</span><span class="token builtin class-name">:</span> <span class="token string">"volume02"</span>,
                <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,
                <span class="token string">"Mode"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>,
                <span class="token string">"RW"</span><span class="token builtin class-name">:</span> true,
                <span class="token string">"Propagation"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>,

<span class="token comment">## 不难得出：这是匿名挂载</span>

<span class="token comment">## 最后，我们测试一下刚才的文件是否同步出去：</span>

<span class="token comment">### 容器内：</span>
<span class="token punctuation">[</span>root@fb03c0ac928e /<span class="token punctuation">]</span><span class="token comment"># cd /</span>
.dockerenv  dev/        home/       lib64/      media/      opt/        root/       sbin/       sys/        usr/        volume01/   
bin/        etc/        lib/        lost+found/ mnt/        proc/       run/        srv/        tmp/        var/        volume02/ 
<span class="token punctuation">[</span>root@fb03c0ac928e /<span class="token punctuation">]</span><span class="token comment"># cd /volume01</span>
<span class="token punctuation">[</span>root@fb03c0ac928e volume01<span class="token punctuation">]</span><span class="token comment"># touch container.txt</span>

<span class="token comment">### 容器外：</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># cd /var/lib/docker/volumes/9fe1401672d9c3e97cdf28147fa6164da59bcf08a762de24a323180ced0de948/_data</span>
<span class="token punctuation">[</span>root@VM-24-12-centos _data<span class="token punctuation">]</span><span class="token comment"># ls</span>
container.txt

<span class="token comment">## 同步成功！</span>
</code></pre> 
<h3><a id="6__1272"></a>6. 数据卷容器</h3> 
<p><img src="https://images2.imgbox.com/80/b8/GtBSHbZ6_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell"><span class="token comment"># 启动三个容器测试</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY            TAG       IMAGE ID       CREATED         SIZE
xiaohang/centos       latest    f36fc725be93   <span class="token number">20</span> hours ago    231MB

<span class="token comment"># 启动第一个容器：</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -it --name docker01 xiaohang/centos</span>
<span class="token punctuation">[</span>root@fe47b170c766 /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volume01  volume02

Ctrl + P + Q（退出不结束）
<span class="token punctuation">[</span>root@fe47b170c766 /<span class="token punctuation">]</span><span class="token comment"># [root@VM-24-12-centos ~]# docker ps</span>
CONTAINER ID   IMAGE             COMMAND                  CREATED              STATUS              PORTS     NAMES
fe47b170c766   xiaohang/centos   <span class="token string">"/bin/sh -c /bin/bash"</span>   About a minute ago   Up About a minute             docker01

<span class="token comment"># 启动第二个容器</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment">#  docker run -it --name docker02 --volumes-from docker01 xiaohang/centos</span>
<span class="token punctuation">[</span>root@280b39ca806f /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volume01  volume02

<span class="token comment"># 启动第二个容器</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment">#  docker run -it --name docker03 --volumes-from docker01 xiaohang/centos</span>
<span class="token punctuation">[</span>root@280b39ca806f /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volume01  volume02


<span class="token comment"># 进入容器一，创建docker01.txt</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE             COMMAND                  CREATED          STATUS          PORTS     NAMES
280b39ca806f   xiaohang/centos   <span class="token string">"/bin/sh -c /bin/bash"</span>   <span class="token number">11</span> minutes ago   Up <span class="token number">11</span> minutes             docker02
fe47b170c766   xiaohang/centos   <span class="token string">"/bin/sh -c /bin/bash"</span>   <span class="token number">15</span> minutes ago   Up <span class="token number">15</span> minutes             docker01
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it fe47b170c766 /bin/bash</span>
<span class="token punctuation">[</span>root@fe47b170c766 /<span class="token punctuation">]</span><span class="token comment"># ls</span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volume01  volume02
<span class="token punctuation">[</span>root@fe47b170c766 /<span class="token punctuation">]</span><span class="token comment"># cd volume01</span>
<span class="token punctuation">[</span>root@fe47b170c766 volume01<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token punctuation">[</span>root@fe47b170c766 volume01<span class="token punctuation">]</span><span class="token comment"># touch docker01.txt</span>
<span class="token punctuation">[</span>root@fe47b170c766 volume01<span class="token punctuation">]</span><span class="token comment"># ls</span>
docker01.txt

<span class="token comment"># 进入容器二，查看是否有docker02.txt</span>
<span class="token punctuation">[</span>root@280b39ca806f /<span class="token punctuation">]</span><span class="token comment"># ls     </span>
bin  dev  etc  home  lib  lib64  lost+found  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var  volume01  volume02
<span class="token punctuation">[</span>root@280b39ca806f /<span class="token punctuation">]</span><span class="token comment"># cd volume01</span>
<span class="token punctuation">[</span>root@280b39ca806f volume01<span class="token punctuation">]</span><span class="token comment"># ls</span>
docker01.txt

<span class="token comment">## 测试删除docker01，docker02，docker03还可以继续访问。</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1d/46/FNzb77cL_o.png" alt="在这里插入图片描述"><br> 多个MySQL实现数据共享：</p> 
<pre><code class="prism language-shell">$ <span class="token function">docker</span> run -d -p <span class="token number">3306</span>:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> --name mysql01 mysql:5.7

$ <span class="token function">docker</span> run -d -p <span class="token number">3310</span>:3306 -e <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123456</span> --name mysql02 --volumes-from mysql01  mysql:5.7

<span class="token comment"># 这个时候，可以实现两个容器数据同步！</span>
</code></pre> 
<p><strong>结论：</strong></p> 
<ul><li> <p>容器之间的配置信息的传递，数据卷容器的生命周期一直持续到没有容器使用为止。</p> </li><li> <p>但是一旦你持久化到了本地，这个时候，本地的数据是不会删除的！</p> </li></ul> 
<h3><a id="7_Dockerfile_1339"></a>7. Dockerfile</h3> 
<p>Dockerfile是用来构建docker镜像的文件！（命令参数脚本）</p> 
<h4><a id="71__1342"></a>7.1 构建步骤</h4> 
<ol><li>编写一个dockerfile文件</li><li>docker build 构建成为一个镜像</li><li>docker run 运行镜像</li><li>docker push 发布镜像（DockerHub、阿里云仓库）</li></ol> 
<p><img src="https://images2.imgbox.com/bd/ac/MDtEZG2N_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a6/cc/gAPsxldd_o.png" alt="在这里插入图片描述"></p> 
<p>很多官方镜像都是基础包，很多功能没有，我们通常会自己搭建自己的镜像！</p> 
<p>官方既然可以制作镜像，那我们也可以！</p> 
<h4><a id="72_Dockerfile_1356"></a>7.2 Dockerfile构建过程</h4> 
<h5><a id="721__1357"></a>7.2.1 基础知识：</h5> 
<p>1、每个保留关键字(指令）都是必须是大写字母</p> 
<p>2、执行从上到下顺序</p> 
<p>3、#表示注释</p> 
<p>4、每一个指令都会创建提交一个新的镜像曾，并提交！</p> 
<p><img src="https://images2.imgbox.com/ea/e3/0l5GUODy_o.png" alt="在这里插入图片描述"><br> Dockerfile是面向开发的，我们以后要发布项目，做镜像，就需要编写dockerfile文件，这个文件十分简单！</p> 
<p>Docker镜像逐渐成企业交付的标准，必须要掌握！</p> 
<p>DockerFile：构建文件，定义了一切的步骤，源代码</p> 
<p>DockerImages：通过DockerFile构建生成的镜像，最终发布和运行产品。</p> 
<p>Docker容器：容器就是镜像运行起来提供服务。</p> 
<h5><a id="722_Dockerfile_1377"></a>7.2.2 Dockerfile的指令</h5> 
<pre><code class="prism language-shell">FROM				<span class="token comment"># from:基础镜像，一切从这里开始构建</span>
MAINTAINER			<span class="token comment"># maintainer:镜像是谁写的， 姓名+邮箱</span>
RUN					<span class="token comment"># run:镜像构建的时候需要运行的命令</span>
ADD					<span class="token comment"># add:步骤，tomcat镜像，这个tomcat压缩包！添加内容 添加同目录</span>
WORKDIR				<span class="token comment"># workdir:镜像的工作目录</span>
VOLUME				<span class="token comment"># volume:挂载的目录</span>
EXPOSE				<span class="token comment"># expose:保留端口配置</span>
CMD					<span class="token comment"># cmd:指定这个容器启动的时候要运行的命令，只有最后一个会生效，可被替代</span>
ENTRYPOINT			<span class="token comment"># entrypoint:指定这个容器启动的时候要运行的命令，可以追加命令</span>
ONBUILD				<span class="token comment"># onbuild:当构建一个被继承DockerFile这个时候就会运行onbuild的指令，触发指令</span>
COPY				<span class="token comment"># copy:类似ADD，将我们文件拷贝到镜像中</span>
ENV					<span class="token comment"># env:构建的时候设置环境变量！</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/8a/7d/SRTwleQy_o.png" alt="在这里插入图片描述"><br> 以前的话我们就是使用别人的，现在我们知道了这些指令后，我们来练习自己写一个镜像！</p> 
<h5><a id="723__1395"></a>7.2.3 实战测试</h5> 
<blockquote> 
 <p>创建自己的一个centos</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 1./home下新建dockerfile目录</span>
$ <span class="token function">mkdir</span> dockerfile

<span class="token comment"># 2. dockerfile目录下新建mydockerfile-centos文件</span>
$ <span class="token function">vim</span> mydockerfile-centos

<span class="token comment"># 3.编写Dockerfile配置文件</span>
FROM centos							<span class="token comment"># 基础镜像是官方原生的centos</span>
MAINTAINER xiaohang<span class="token operator">&lt;</span><span class="token number">1531137510</span>@qq.com<span class="token operator">&gt;</span> 	<span class="token comment"># 作者</span>

ENV MYPATH /usr/local				<span class="token comment"># 配置环境变量的目录 </span>
WORKDIR <span class="token variable">$MYPATH</span>						<span class="token comment"># 将工作目录设置为 MYPATH</span>

RUN yum -y <span class="token function">install</span> <span class="token function">vim</span>				<span class="token comment"># 给官方原生的centos 增加 vim指令</span>
RUN yum -y <span class="token function">install</span> net-tools		<span class="token comment"># 给官方原生的centos 增加 ifconfig命令</span>

EXPOSE <span class="token number">80</span>							<span class="token comment"># 暴露端口号为80</span>

CMD <span class="token builtin class-name">echo</span> <span class="token variable">$MYPATH</span>					<span class="token comment"># 输出下 MYPATH 路径</span>
CMD <span class="token builtin class-name">echo</span> <span class="token string">"-----end----"</span>				
CMD /bin/bash						<span class="token comment"># 启动后进入 /bin/bash</span>

<span class="token comment"># 4.通过这个文件构建镜像</span>
<span class="token comment"># 命令： docker build -f 文件路径 -t 镜像名:[tag] .</span>
$ <span class="token function">docker</span> build -f mydockerfile-centos -t mycentos:0.1 <span class="token builtin class-name">.</span>

<span class="token comment"># 5.出现下图后则构建成功</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/27/PyfeLff4_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell">$ <span class="token function">docker</span> images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
mycentos            <span class="token number">0.1</span>                 cbf5110a646d        <span class="token number">2</span> minutes ago       311MB

<span class="token comment"># 6.测试运行</span>
$ <span class="token function">docker</span> run -it mycentos:0.1 		<span class="token comment"># 注意带上版本号，否则每次都回去找最新版latest</span>

$ <span class="token builtin class-name">pwd</span>	
/usr/local							<span class="token comment"># 与Dockerfile文件中 WORKDIR 设置的 MYPATH 一致</span>
$ <span class="token function">vim</span>								<span class="token comment"># vim 指令可以使用</span>
$ <span class="token function">ifconfig</span>     						<span class="token comment"># ifconfig 指令可以使用</span>

<span class="token comment"># docker history 镜像id 查看镜像构建历史步骤</span>
$ <span class="token function">docker</span> <span class="token function">history</span> 镜像id

<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker history 605c77e624dd</span>
IMAGE          CREATED        CREATED BY                                      SIZE      COMMENT
605c77e624dd   <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  CMD ["nginx" "-g" "daemon…   0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  STOPSIGNAL SIGQUIT           0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  EXPOSE 80                    0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  ENTRYPOINT ["/docker-entr…   0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop) COPY file:09a214a3e07c919a…   4.61kB    </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop) COPY file:0fd5fca330dcd6a7…   1.04kB    </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop) COPY file:0b866ff3fc1ef5b0…   1.96kB    </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop) COPY file:65504f71f5855ca0…   1.2kB     </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token builtin class-name">set</span> -x     <span class="token operator">&amp;&amp;</span> addgroup --system -…   <span class="token number">61</span>.1MB    
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  ENV PKG_RELEASE=1~bullseye   0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  ENV NJS_VERSION=0.7.1        0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">3</span> months ago   /bin/sh -c <span class="token comment">#(nop)  ENV NGINX_VERSION=1.21.5     0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> months ago   /bin/sh -c <span class="token comment">#(nop)  LABEL maintainer=NGINX Do…   0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> months ago   /bin/sh -c <span class="token comment">#(nop)  CMD ["bash"]                 0B        </span>
<span class="token operator">&lt;</span>missing<span class="token operator">&gt;</span>      <span class="token number">4</span> months ago   /bin/sh -c <span class="token comment">#(nop) ADD file:09675d11695f65c55…   80.4MB </span>


我们平时拿到一个镜像，可以用 “docker <span class="token function">history</span> 镜像id” 研究一下是什么做的
</code></pre> 
<h5><a id="724_CMD__ENTRYPOINT_1464"></a>7.2.4 CMD 和 ENTRYPOINT</h5> 
<pre><code class="prism language-shell">CMD  		<span class="token comment"># 指定这个容器启动的时候要运行的命令，只有最后一个生效，可被替代</span>
ENTRYPOINT 	<span class="token comment"># 指定这个容器启动的时候要运行的命令，可以追加命令</span>
</code></pre> 
<p>测试CMD：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># vim dockerfile-cmd-test</span>

FROM centos
CMD <span class="token punctuation">[</span><span class="token string">"ls"</span>,<span class="token string">"-a"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker build -f dockerfile-cmd-test -t cmdtest:0.1 .</span>
Sending build context to Docker daemon  <span class="token number">3</span>.072kB
Step <span class="token number">1</span>/2 <span class="token builtin class-name">:</span> FROM centos
 ---<span class="token operator">&gt;</span> 5d0da3dc9764
Step <span class="token number">2</span>/2 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"ls"</span>,<span class="token string">"-a"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 064c77f9e8b2
Removing intermediate container 064c77f9e8b2
 ---<span class="token operator">&gt;</span> 3594071968fc
Successfully built 3594071968fc
Successfully tagged cmdtest:0.1

<span class="token comment"># 运行镜像</span>
$ <span class="token function">docker</span> run cmd-test:0.1		<span class="token comment"># 由结果可得，运行后就执行了 ls -a 命令</span>
<span class="token builtin class-name">.</span>
<span class="token punctuation">..</span>
.dockerenv
bin
dev
etc
home

<span class="token comment">## 想追加一个命令 -l    执行ls -al命令</span>
<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker run 279bb7d5f91f -l</span>
docker: Error response from daemon: failed to create shim: OCI runtime create failed: container_linux.go:380: starting container process caused: exec: <span class="token string">"-l"</span><span class="token builtin class-name">:</span> executable <span class="token function">file</span> not found <span class="token keyword">in</span> <span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span> unknown.
ERRO<span class="token punctuation">[</span>0000<span class="token punctuation">]</span> error waiting <span class="token keyword">for</span> container: context canceled 

<span class="token comment">## cmd情况下， -l 替换了CMD["ls","-a"]命令，-l不是命令，所以报错！</span>

<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker run 279bb7d5f91f ls -al</span>
total <span class="token number">56</span>
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">23</span> 06:18 <span class="token builtin class-name">.</span>
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">23</span> 06:18 <span class="token punctuation">..</span>
-rwxr-xr-x   <span class="token number">1</span> root root    <span class="token number">0</span> Apr <span class="token number">23</span> 06:18 .dockerenv
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">7</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> bin -<span class="token operator">&gt;</span> usr/bin
drwxr-xr-x   <span class="token number">5</span> root root  <span class="token number">340</span> Apr <span class="token number">23</span> 06:18 dev
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">23</span> 06:18 etc
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> home
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">7</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> lib -<span class="token operator">&gt;</span> usr/lib
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">9</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> lib64 -<span class="token operator">&gt;</span> usr/lib64
drwx------   <span class="token number">2</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> lost+found
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> media
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> mnt
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> opt
dr-xr-xr-x <span class="token number">136</span> root root    <span class="token number">0</span> Apr <span class="token number">23</span> 06:18 proc
dr-xr-x---   <span class="token number">2</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> root
drwxr-xr-x  <span class="token number">11</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> run
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">8</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> sbin -<span class="token operator">&gt;</span> usr/sbin
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> srv
dr-xr-xr-x  <span class="token number">13</span> root root    <span class="token number">0</span> Apr <span class="token number">21</span> 07:13 sys
drwxrwxrwt   <span class="token number">7</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> tmp
drwxr-xr-x  <span class="token number">12</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> usr
drwxr-xr-x  <span class="token number">20</span> root root <span class="token number">4096</span> Sep <span class="token number">15</span>  <span class="token number">2021</span> var
</code></pre> 
<p>测试Entrypoint：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># vim dockerfile-entrypoint-test</span>

FROM centos
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"ls"</span>,<span class="token string">"-a"</span><span class="token punctuation">]</span>

<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker build -f dockerfile-entrypoint-test -t entrypoint-test .</span>
Sending build context to Docker daemon  <span class="token number">4</span>.096kB
Step <span class="token number">1</span>/2 <span class="token builtin class-name">:</span> FROM centos
 ---<span class="token operator">&gt;</span> 5d0da3dc9764
Step <span class="token number">2</span>/2 <span class="token builtin class-name">:</span> ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"ls"</span>,<span class="token string">"-a"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> b4677105ef8d
Removing intermediate container b4677105ef8d
 ---<span class="token operator">&gt;</span> f8b8ec376712
Successfully built f8b8ec376712
Successfully tagged entrypoint-test:latest
<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker run f8b8ec376712</span>
<span class="token builtin class-name">.</span>
<span class="token punctuation">..</span>
.dockerenv
bin
dev
etc
home
lib
<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>root@VM-24-12-centos dockerfile<span class="token punctuation">]</span><span class="token comment"># docker run f8b8ec376712 -l</span>
total <span class="token number">56</span>
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">23</span> 06:28 <span class="token builtin class-name">.</span>
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">23</span> 06:28 <span class="token punctuation">..</span>
-rwxr-xr-x   <span class="token number">1</span> root root    <span class="token number">0</span> Apr <span class="token number">23</span> 06:28 .dockerenv
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">7</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> bin -<span class="token operator">&gt;</span> usr/bin
drwxr-xr-x   <span class="token number">5</span> root root  <span class="token number">340</span> Apr <span class="token number">23</span> 06:28 dev
drwxr-xr-x   <span class="token number">1</span> root root <span class="token number">4096</span> Apr <span class="token number">23</span> 06:28 etc
drwxr-xr-x   <span class="token number">2</span> root root <span class="token number">4096</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> home
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">7</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> lib -<span class="token operator">&gt;</span> usr/lib
lrwxrwxrwx   <span class="token number">1</span> root root    <span class="token number">9</span> Nov  <span class="token number">3</span>  <span class="token number">2020</span> lib64 -<span class="token operator">&gt;</span> usr/lib64
<span class="token punctuation">..</span>.
</code></pre> 
<h5><a id="725_Tomcat_1569"></a>7.2.5 实战-Tomcat镜像</h5> 
<p>1、准备镜像文件 tomcat压缩包，jdk的压缩包！</p> 
<p><img src="https://images2.imgbox.com/2a/76/pWxqaNxF_o.png" alt="在这里插入图片描述"><br> 2、编写dockerfile文件，官方命名<code>Dockerfile</code>，build会自动寻找这个文件，就不需要-f指定了！</p> 
<pre><code class="prism language-shell">FROM centos:7      <span class="token comment"># 基础镜像centos:7</span>
MAINTAINER xiaohang<span class="token operator">&lt;</span><span class="token number">1531137510</span>@qq.com<span class="token operator">&gt;</span>   <span class="token comment"># 作者信息</span>

COPY readme.txt /usr/local/readme.txt   

ADD jdk-8u271-linux-x64.tar.gz /usr/local/	<span class="token comment"># 添加JDK，ADD会自动解压</span>
ADD apache-tomcat-9.0.62.tar.gz /usr/local/  <span class="token comment"># 添加Tomcat</span>

RUN yum -y <span class="token function">install</span> <span class="token function">vim</span>   <span class="token comment"># 安装VIM命令</span>

ENV MYPATH /usr/local    <span class="token comment"># 环境变量设置 工作目录</span>
WORKDIR <span class="token variable">$MYPATH</span>

ENV JAVA_HOME /usr/local/jdk1.8.0_271   <span class="token comment"># JAVA_HOME 环境变量</span>
ENV CLASSPATH <span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar

ENV CATALINA_HOME /usr/local/apache-tomcat-9.0.62  <span class="token comment"># Tomcat 环境变量</span>
ENV CATALINA_BASH /usr/local/apache-tomcat-9.0.62

<span class="token comment"># 设置环境变量，分隔符为：</span>
ENV <span class="token environment constant">PATH</span> <span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$CATALINA_HOME</span>/lib:CATALINA_HOME/bin

EXPOSE <span class="token number">8080</span>  <span class="token comment"># 设置暴露的端口</span>

CMD /usr/local/apache-tomcat-9.0.62/bin/startup.sh <span class="token operator">&amp;&amp;</span> <span class="token function">tail</span> -F /usr/local/apache-tomcat-9.0.62/bin/logs/catalina.out
</code></pre> 
<p>可能会遇到的错：</p> 
<pre><code>CentOS Linux 8 - AppStream                      1.6  B/s |  38  B     00:24    
Error: Failed to download metadata for repo 'appstream': Cannot prepare internal mirrorlist: No URLs in mirrorlist
The command '/bin/sh -c yum -y install vim' returned a non-zero code: 1


请指定Centos版本7
</code></pre> 
<p>3、构建镜像</p> 
<pre><code class="prism language-shell"><span class="token comment"># 因为dockerfile命名使用默认命名 因此不用使用-f 指定文件</span>
<span class="token function">docker</span> build -t diytomcat <span class="token builtin class-name">.</span>
</code></pre> 
<p>4、启动镜像</p> 
<pre><code class="prism language-shell"><span class="token comment"># -d:后台运行 -p:暴露端口 --name:别名 -v:绑定路径 </span>
<span class="token function">docker</span> run -d -p <span class="token number">8080</span>:8080 --name tomcat01 
-v /home/tomcat/test:/usr/local/apache-tomcat-9.0.62/webapps/test 
-v /home/tomcat/tomcatlogs/:/usr/local/apache-tomcat-9.0.62/logs mytomcat:0.1
</code></pre> 
<p>5、访问测试</p> 
<pre><code class="prism language-shell">$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it 自定义容器的id /bin/bash

$ cul localhost:8080
</code></pre> 
<p>6、发布项目（由于做了卷挂载，我们直接在本地编写项目就可以发布了）</p> 
<p>发现：项目部署成功，可以直接访问！</p> 
<p>我们以后开发的步骤：需要掌握Dockerfile的编写！我们之后的一切都是使用docker镜像来发布运行！</p> 
<h5><a id="726__1635"></a>7.2.6 发布自己的镜像</h5> 
<blockquote> 
 <p>DockerHub</p> 
</blockquote> 
<p>1、地址 https://hub.docker.com/</p> 
<p>2、确定这个账号可以登录</p> 
<p>3、登录</p> 
<pre><code class="prism language-shell">$ <span class="token function">docker</span> login --help
Usage:  <span class="token function">docker</span> login <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>SERVER<span class="token punctuation">]</span>

Log <span class="token keyword">in</span> to a Docker registry.
If no server is specified, the default is defined by the daemon.

Options:
  -p, --password string   Password
      --password-stdin    Take the password from stdin
  -u, --username string   Username

$ <span class="token function">docker</span> login -u 你的用户名 -p 你的密码
</code></pre> 
<p>4、提交 push镜像</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> push mytomcat

<span class="token comment"># 会发现push不上去，因为如果没有前缀的话默认是push到 官方的library</span>
<span class="token comment"># 解决方法：</span>
<span class="token comment"># 第一种 build的时候添加你的dockerhub用户名，然后在push就可以放到自己的仓库了</span>
$ <span class="token function">docker</span> build -t xiaohang/mytomcat:0.1 <span class="token builtin class-name">.</span>

<span class="token comment"># 第二种 使用docker tag #然后再次push</span>
$ <span class="token function">docker</span> tag 容器id xiaohang/mytomcat:1.0 <span class="token comment">#然后再次push</span>
$ <span class="token function">docker</span> push xiaohang/mytomcat:1.0
</code></pre> 
<h5><a id="727__1670"></a>7.2.7 发布到阿里云镜像服务上</h5> 
<ol><li>登录阿里云，找到容器镜像服务（https://cr.console.aliyun.com/cn-hangzhou/instance/repositories）</li><li>找到命名空间<br> <img src="https://images2.imgbox.com/ce/c4/pd7fW89K_o.png" alt="在这里插入图片描述"></li><li>创建镜像仓库<br> <img src="https://images2.imgbox.com/59/be/85F3Js8c_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/18/7b/ibL5rQIa_o.png" alt="在这里插入图片描述"><br> 4.看文档</li></ol> 
<pre><code class="prism language-shell"><span class="token function">docker</span> <span class="token builtin class-name">logout</span>  退出当前登录的账号
</code></pre> 
<h4><a id="8_Docker_1681"></a>8. Docker小结：</h4> 
<p><img src="https://images2.imgbox.com/bd/f1/Ao9Wr0fW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Docker_1683"></a>六、Docker网络</h2> 
<h3><a id="1Docker0_1684"></a>1、理解Docker0</h3> 
<pre><code class="prism language-shell">清空所有容器
<span class="token function">docker</span> <span class="token function">rm</span> -f <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> <span class="token function">ps</span> -aq<span class="token variable">)</span></span>
清空所有镜像
<span class="token function">docker</span> rmi -f <span class="token variable"><span class="token variable">$(</span><span class="token function">docker</span> images -aq<span class="token variable">)</span></span>
</code></pre> 
<p>测试：</p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># ip addr</span>
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1000</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope <span class="token function">host</span> 
       valid_lft forever preferred_lft forever
<span class="token number">2</span>: eth0: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc mq state UP group default qlen <span class="token number">1000</span>
    link/ether <span class="token number">52</span>:54:00:49:d1:3b brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">10.0</span>.24.12/22 brd <span class="token number">10.0</span>.27.255 scope global eth0
       valid_lft forever preferred_lft forever
    inet6 fe80::5054:ff:fe49:d13b/64 scope <span class="token function">link</span> 
       valid_lft forever preferred_lft forever
<span class="token number">3</span>: docker0: <span class="token operator">&lt;</span>NO-CARRIER,BROADCAST,MULTICAST,UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state DOWN group default 
    link/ether 02:42:0e:e5:eb:26 brd ff:ff:ff:ff:ff:ff
    inet <span class="token number">172.17</span>.0.1/16 brd <span class="token number">172.17</span>.255.255 scope global docker0
       valid_lft forever preferred_lft forever
    inet6 fe80::42:eff:fee5:eb26/64 scope <span class="token function">link</span> 
       valid_lft forever preferred_lft forever

</code></pre> 
<p><img src="https://images2.imgbox.com/a1/7a/jhq07Hjt_o.png" alt="在这里插入图片描述"><br> 三个网络：</p> 
<blockquote> 
 <p>问题：Docker是如何处理容器网络访问的？<br> <img src="https://images2.imgbox.com/05/8b/lAKKhCfC_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 测试  运行一个tomcat</span>
$ <span class="token function">docker</span> run -d -P --name tomcat01 tomcat

<span class="token comment"># 查看容器内部网络地址</span>
$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it 容器id <span class="token function">ip</span> addr

<span class="token comment"># 发现容器启动的时候会得到一个 eth0@if91 ip地址，docker分配！</span>
$ <span class="token function">ip</span> addr
<span class="token number">1</span>: lo: <span class="token operator">&lt;</span>LOOPBACK,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">65536</span> qdisc noqueue state UNKNOWN group default qlen <span class="token number">1</span>
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet <span class="token number">127.0</span>.0.1/8 scope <span class="token function">host</span> lo
       valid_lft forever preferred_lft forever
<span class="token number">261</span>: eth0@if91: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default 
    link/ether 02:42:ac:12:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet <span class="token number">172.18</span>.0.2/16 brd <span class="token number">172.18</span>.255.255 scope global eth0
       valid_lft forever preferred_lft forever

       
<span class="token comment"># 思考？ linux能不能ping通容器内部！ 可以 容器内部可以ping通外界吗？ 可以！</span>
$ <span class="token function">ping</span> <span class="token number">172.18</span>.0.2
PING <span class="token number">172.18</span>.0.2 <span class="token punctuation">(</span><span class="token number">172.18</span>.0.2<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">172.18</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.069</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.18</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.074</span> ms
</code></pre> 
<blockquote> 
 <p>原理</p> 
</blockquote> 
<p>1、我们每启动一个docker容器，docker就会给docker容器分配一个ip，我们只要按照了docker，就会有一个docker0桥接模式，使用的技术是<code>veth-pair</code>技术！</p> 
<p><a href="https://www.cnblogs.com/bakari/p/10613710.html" rel="nofollow">关于veth-pair的介绍，你需要了解这些！</a></p> 
<p>再次测试 ip addr</p> 
<p><img src="https://images2.imgbox.com/ab/94/A2FVNfVH_o.png" alt="在这里插入图片描述"><br> 2 、再启动一个容器测试，发现又多了一对网络</p> 
<p><img src="https://images2.imgbox.com/39/30/pdEoWAqY_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell"><span class="token comment"># 我们发现这个容器带来网卡，都是一对对的</span>
<span class="token comment"># veth-pair 就是一对的虚拟设备接口，他们都是成对出现的，一端连着协议，一端彼此相连</span>
<span class="token comment"># 正因为有这个特性 veth-pair 充当一个桥梁，连接各种虚拟网络设备的</span>
<span class="token comment"># OpenStac,Docker容器之间的连接，OVS的连接，都是使用evth-pair技术</span>
</code></pre> 
<p>3、我们来测试下tomcat01和tomcat02是否可以ping通</p> 
<pre><code class="prism language-shell"><span class="token comment"># 获取tomcat01的ip 172.17.0.2</span>
$ docker-tomcat <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it tomcat01 <span class="token function">ip</span> addr  
<span class="token number">550</span>: eth0@if551: <span class="token operator">&lt;</span>BROADCAST,MULTICAST,UP,LOWER_UP<span class="token operator">&gt;</span> mtu <span class="token number">1500</span> qdisc noqueue state UP group default 
    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid <span class="token number">0</span>
    inet <span class="token number">172.17</span>.0.2/16 brd <span class="token number">172.17</span>.255.255 scope global eth0
       valid_lft forever preferred_lft forever
       
<span class="token comment"># 让tomcat02 ping tomcat01       </span>
$ docker-tomcat <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it tomcat02 <span class="token function">ping</span> <span class="token number">172.17</span>.0.2
PING <span class="token number">172.17</span>.0.2 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.2<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.098</span> ms
<span class="token number">64</span> bytes from <span class="token number">172.17</span>.0.2: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.071</span> ms

<span class="token comment"># 结论：容器和容器之间是可以互相ping通</span>
</code></pre> 
<blockquote> 
 <p>网络模型图</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/4b/44/8qhfuABO_o.png" alt="在这里插入图片描述"><br> 结论：tomcat01和tomcat02公用一个路由器，docker0。</p> 
<p>所有的容器不指定网络的情况下，都是docker0路由的，docker会给我们的容器分配一个默认的可用ip。</p> 
<blockquote> 
 <p>小结</p> 
</blockquote> 
<p>Docker使用的是Linux的桥接，宿主机是一个Docker容器的网桥 docker0<br> <img src="https://images2.imgbox.com/48/85/IXH0j79Z_o.png" alt="在这里插入图片描述"><br> Docker中所有网络接口都是虚拟的，虚拟的转发效率高（内网传递文件）</p> 
<p>只要容器删除，对应的网桥一对就没了！</p> 
<p>思考一个场景：我们编写了一个微服务，database url=ip: 项目不重启，数据ip换了，我们希望可以处理这个问题，可以通过名字来进行访问容器？</p> 
<h3><a id="2__Link_1799"></a>2、- - Link</h3> 
<blockquote> 
 <p>思考一个场景：我们编写了一个微服务，database url=ip: 项目不重启，数据ip换了，我们希望可以处理这个问题，可以通过名字来进行访问容器？</p> 
</blockquote> 
<pre><code class="prism language-shell">$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it tomcat02 <span class="token function">ping</span> tomca01   <span class="token comment"># ping不通</span>
ping: tomca01: Name or <span class="token function">service</span> not known

<span class="token comment"># 运行一个tomcat03 --link tomcat02 </span>
$ <span class="token function">docker</span> run -d -P --name tomcat03 --link tomcat02 tomcat
5f9331566980a9e92bc54681caaac14e9fc993f14ad13d98534026c08c0a9aef

<span class="token comment"># 3连接2</span>
<span class="token comment"># 用tomcat03 ping tomcat02 可以ping通</span>
$ <span class="token function">docker</span> <span class="token builtin class-name">exec</span> -it tomcat03 <span class="token function">ping</span> tomcat02
PING tomcat02 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.3<span class="token punctuation">)</span> <span class="token number">56</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span> bytes of data.
<span class="token number">64</span> bytes from tomcat02 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.3<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.115</span> ms
<span class="token number">64</span> bytes from tomcat02 <span class="token punctuation">(</span><span class="token number">172.17</span>.0.3<span class="token punctuation">)</span>: <span class="token assign-left variable">icmp_seq</span><span class="token operator">=</span><span class="token number">2</span> <span class="token assign-left variable">ttl</span><span class="token operator">=</span><span class="token number">64</span> <span class="token assign-left variable">time</span><span class="token operator">=</span><span class="token number">0.080</span> ms

<span class="token comment"># 2连接3</span>
<span class="token comment"># 用tomcat02 ping tomcat03 ping不通</span>
</code></pre> 
<p>探究：</p> 
<p>docker network inspect 网络id 网段相同<br> <img src="https://images2.imgbox.com/50/f5/7iHSUPVq_o.png" alt="在这里插入图片描述"><br> docker inspect tomcat03<br> <img src="https://images2.imgbox.com/f6/15/DVkD6V1v_o.png" alt="在这里插入图片描述"></p> 
<p>查看tomcat03里面的/etc/hosts发现有tomcat02的配置</p> 
<p><img src="https://images2.imgbox.com/d3/be/xM81XvYj_o.png" alt="在这里插入图片描述"><br> –link 本质就是在hosts配置中添加映射</p> 
<p>现在使用Docker已经不建议使用–link了！</p> 
<p>自定义网络，不适用docker0！</p> 
<p>docker0问题：不支持容器名连接访问！</p> 
<h3><a id="3_1838"></a>3、自定义网络</h3> 
<pre><code class="prism language-shell">查看所有的docker网络

<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker network ls</span>
NETWORK ID     NAME      DRIVER    SCOPE
000f0b7bb122   bridge    bridge    <span class="token builtin class-name">local</span>
46dc3c551551   <span class="token function">host</span>      <span class="token function">host</span>      <span class="token builtin class-name">local</span>
2dea6558d00c   none      null      <span class="token builtin class-name">local</span>
</code></pre> 
<p><strong>网络模式：</strong></p> 
<ul><li>bridge：桥接docker（默认，自己创建也使用这个）</li><li>none：不配置网络</li><li>host：和宿主机共享网络</li><li>container：容器网络连通！（用的少！）</li></ul> 
<pre><code class="prism language-shell"><span class="token comment">## 我们直接启动的命令 --net bridge，而这个就是我们的docker0</span>
<span class="token function">docker</span> run -d -P --name tomcat01 tomcat
<span class="token function">docker</span> run -d -P --name tomcat01 -net bridge tomcat

<span class="token comment">## docker0特点：默认，域名不能访问，--link可以打通连接！</span>

<span class="token comment">## 我们可以自定义一个网络：（想想自己家里的路由器）</span>
<span class="token comment">## --driver bridge</span>
<span class="token comment">## --subnet 192.168.0.0/16</span>
<span class="token comment">## --gateway 192.168.0.1</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span>
00496e0f79c1a09cd4f632e010d1d572a3c5eb77400e6e14c6dc671824337287
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker network ls</span>
NETWORK ID     NAME      DRIVER    SCOPE
000f0b7bb122   bridge    bridge    <span class="token builtin class-name">local</span>
46dc3c551551   <span class="token function">host</span>      <span class="token function">host</span>      <span class="token builtin class-name">local</span>
00496e0f79c1   mynet     bridge    <span class="token builtin class-name">local</span>

<span class="token comment">## 查看自己定义的网络</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker network inspect mynet</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"mynet"</span>,
        <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token string">"00496e0f79c1a09cd4f632e010d1d572a3c5eb77400e6e14c6dc671824337287"</span>,
        <span class="token string">"Created"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-27T20:58:09.144161755+08:00"</span>,
        <span class="token string">"Scope"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,
        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"bridge"</span>,
        <span class="token string">"EnableIPv6"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"IPAM"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"default"</span>,
            <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
            <span class="token string">"Config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"Subnet"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.0/16"</span>,
                    <span class="token string">"Gateway"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.1"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Internal"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"Attachable"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"Ingress"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"ConfigFrom"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Network"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"ConfigOnly"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"Containers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
        <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
        <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token comment">## 用自己的网络启动</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -P --name tomcat-net-01 --net mynet tomcat</span>
39a25939ca7d17005c6a3a840fc20f671ae73138d6899617dd08b7b6fba354b8
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker run -d -P --name tomcat-net-02 --net mynet tomcat</span>
b9a6da9e634209752e9dee02b3bd9a83beda040ffc420a23f7e02b401fd633be

<span class="token comment">## 再次查看自定义网络</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker network inspect mynet</span>
<span class="token punctuation">[</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"mynet"</span>,
        <span class="token string">"Id"</span><span class="token builtin class-name">:</span> <span class="token string">"00496e0f79c1a09cd4f632e010d1d572a3c5eb77400e6e14c6dc671824337287"</span>,
        <span class="token string">"Created"</span><span class="token builtin class-name">:</span> <span class="token string">"2022-04-27T20:58:09.144161755+08:00"</span>,
        <span class="token string">"Scope"</span><span class="token builtin class-name">:</span> <span class="token string">"local"</span>,
        <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"bridge"</span>,
        <span class="token string">"EnableIPv6"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"IPAM"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Driver"</span><span class="token builtin class-name">:</span> <span class="token string">"default"</span>,
            <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
            <span class="token string">"Config"</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"Subnet"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.0/16"</span>,
                    <span class="token string">"Gateway"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.1"</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Internal"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"Attachable"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"Ingress"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"ConfigFrom"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"Network"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"ConfigOnly"</span><span class="token builtin class-name">:</span> false,
        <span class="token string">"Containers"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"39a25939ca7d17005c6a3a840fc20f671ae73138d6899617dd08b7b6fba354b8"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"tomcat-net-01"</span>,
                <span class="token string">"EndpointID"</span><span class="token builtin class-name">:</span> <span class="token string">"4b6d064f9b6b0f56bc0224c4c9d71ec53864e1c66ca88e7f31af04535c9aae78"</span>,
                <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"02:42:c0:a8:00:02"</span>,
                <span class="token string">"IPv4Address"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.2/16"</span>,
                <span class="token string">"IPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
            <span class="token punctuation">}</span>,
            <span class="token string">"b9a6da9e634209752e9dee02b3bd9a83beda040ffc420a23f7e02b401fd633be"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"Name"</span><span class="token builtin class-name">:</span> <span class="token string">"tomcat-net-02"</span>,
                <span class="token string">"EndpointID"</span><span class="token builtin class-name">:</span> <span class="token string">"b3b0ecb8e8b143f2160bd044ac9d362f4dfccef517dac727bf02021f74cdc449"</span>,
                <span class="token string">"MacAddress"</span><span class="token builtin class-name">:</span> <span class="token string">"02:42:c0:a8:00:03"</span>,
                <span class="token string">"IPv4Address"</span><span class="token builtin class-name">:</span> <span class="token string">"192.168.0.3/16"</span>,
                <span class="token string">"IPv6Address"</span><span class="token builtin class-name">:</span> <span class="token string">""</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>,
        <span class="token string">"Options"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,
        <span class="token string">"Labels"</span><span class="token builtin class-name">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">]</span>
在自定义的网络下，服务可以互相ping通，不用使用–link
</code></pre> 
<p><img src="https://images2.imgbox.com/2e/72/5Qygh0g4_o.png" alt="在这里插入图片描述"></p> 
<p><strong>好处：</strong></p> 
<ul><li> <p>redis -不同的集群使用不同的网络，保证集群是安全和健康的</p> </li><li> <p>mysql-不同的集群使用不同的网络，保证集群是安全和健康的</p> </li></ul> 
<p><img src="https://images2.imgbox.com/1e/bd/GrW1tUOj_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4Redis_1972"></a>4、部署Redis集群</h3> 
<p><img src="https://images2.imgbox.com/a6/cb/4RowVFLw_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell"><span class="token comment"># 创建网卡</span>
<span class="token function">docker</span> network create redis --subnet <span class="token number">172.38</span>.0.0/16
<span class="token comment"># 通过脚本创建六个redis配置</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">port</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">$(</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">6</span><span class="token variable">)</span></span><span class="token punctuation">;</span><span class="token punctuation">\</span>
<span class="token keyword">do</span> <span class="token punctuation">\</span>
<span class="token function">mkdir</span> -p /mydata/redis/node-<span class="token variable">${port}</span>/conf
<span class="token function">touch</span> /mydata/redis/node-<span class="token variable">${port}</span>/conf/redis.conf
<span class="token function">cat</span> <span class="token operator">&lt;&lt;</span> <span class="token string">EOF<span class="token bash punctuation"> <span class="token operator">&gt;&gt;</span> /mydata/redis/node-<span class="token variable">${port}</span>/conf/redis.conf</span>
port 6379
bind 0.0.0.0
cluster-enabled yes
cluster-config-file nodes.conf
cluster-node-timeout 5000
cluster-announce-ip 172.38.0.1<span class="token variable">${port}</span>
cluster-announce-port 6379
cluster-announce-bus-port 16379
appendonly yes
EOF</span>
<span class="token keyword">done</span>

<span class="token comment"># 创建结点1</span>
<span class="token function">docker</span> run -p <span class="token number">6371</span>:6379 -p <span class="token number">16371</span>:16379 --name redis-1 <span class="token punctuation">\</span>
-v /mydata/redis/node-1/data:/data <span class="token punctuation">\</span>
-v /mydata/redis/node-1/conf/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
-d --net redis --ip <span class="token number">172.38</span>.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
 
<span class="token comment">#创建结点2</span>
<span class="token function">docker</span> run -p <span class="token number">6372</span>:6379 -p <span class="token number">16372</span>:16379 --name redis-2 <span class="token punctuation">\</span>
-v /mydata/redis/node-2/data:/data <span class="token punctuation">\</span>
-v /mydata/redis/node-2/conf/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
-d --net redis --ip <span class="token number">172.38</span>.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
<span class="token comment">#创建结点3</span>
<span class="token function">docker</span> run -p <span class="token number">6373</span>:6379 -p <span class="token number">16373</span>:16379 --name redis-3 <span class="token punctuation">\</span>
-v /mydata/redis/node-3/data:/data <span class="token punctuation">\</span>
-v /mydata/redis/node-3/conf/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
-d --net redis --ip <span class="token number">172.38</span>.0.13 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
<span class="token comment">#创建结点4</span>
<span class="token function">docker</span> run -p <span class="token number">6374</span>:6379 -p <span class="token number">16374</span>:16379 --name redis-4 <span class="token punctuation">\</span>
-v /mydata/redis/node-4/data:/data <span class="token punctuation">\</span>
-v /mydata/redis/node-4/conf/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
-d --net redis --ip <span class="token number">172.38</span>.0.14 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
<span class="token comment">#创建结点5</span>
<span class="token function">docker</span> run -p <span class="token number">6375</span>:6379 -p <span class="token number">16375</span>:16379 --name redis-5 <span class="token punctuation">\</span>
-v /mydata/redis/node-5/data:/data <span class="token punctuation">\</span>
-v /mydata/redis/node-5/conf/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
-d --net redis --ip <span class="token number">172.38</span>.0.15 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf
<span class="token comment">#创建结点6</span>
<span class="token function">docker</span> run -p <span class="token number">6376</span>:6379 -p <span class="token number">16376</span>:16379 --name redis-6 <span class="token punctuation">\</span>
-v /mydata/redis/node-6/data:/data <span class="token punctuation">\</span>
-v /mydata/redis/node-6/conf/redis.conf:/etc/redis/redis.conf <span class="token punctuation">\</span>
-d --net redis --ip <span class="token number">172.38</span>.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf

<span class="token comment"># 查看镜像</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                    COMMAND                  CREATED          STATUS          PORTS                                                                                      NAMES
869a6ce9f6b0   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">2</span> seconds ago    Up <span class="token number">1</span> second     <span class="token number">0.0</span>.0.0:6376-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6376-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16376-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16376-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-6
2ead11d175ce   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">9</span> seconds ago    Up <span class="token number">9</span> seconds    <span class="token number">0.0</span>.0.0:6375-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6375-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16375-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16375-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-5
349c9d30b905   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">16</span> seconds ago   Up <span class="token number">16</span> seconds   <span class="token number">0.0</span>.0.0:6374-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6374-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16374-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16374-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-4
e534ebf30369   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">23</span> seconds ago   Up <span class="token number">23</span> seconds   <span class="token number">0.0</span>.0.0:6373-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6373-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16373-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16373-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-3
847746759c29   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">31</span> seconds ago   Up <span class="token number">30</span> seconds   <span class="token number">0.0</span>.0.0:6372-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6372-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16372-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16372-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-2
b08ea8b5184e   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">48</span> seconds ago   Up <span class="token number">48</span> seconds   <span class="token number">0.0</span>.0.0:6371-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6371-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16371-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16371-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-1

<span class="token comment">#创建集群</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker exec -it redis-1 /bin/sh</span>
/data <span class="token comment"># ls</span>
appendonly.aof  nodes.conf
/data <span class="token comment"># redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Performing <span class="token builtin class-name">hash</span> slots allocation on <span class="token number">6</span> nodes<span class="token punctuation">..</span>.
Master<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> -<span class="token operator">&gt;</span> Slots <span class="token number">0</span> - <span class="token number">5460</span>
Master<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> -<span class="token operator">&gt;</span> Slots <span class="token number">5461</span> - <span class="token number">10922</span>
Master<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> -<span class="token operator">&gt;</span> Slots <span class="token number">10923</span> - <span class="token number">16383</span>
Adding replica <span class="token number">172.38</span>.0.15:6379 to <span class="token number">172.38</span>.0.11:6379
Adding replica <span class="token number">172.38</span>.0.16:6379 to <span class="token number">172.38</span>.0.12:6379
Adding replica <span class="token number">172.38</span>.0.14:6379 to <span class="token number">172.38</span>.0.13:6379
M: 7b7f474f5deb841ed789af0d2cd3a7294c1bac98 <span class="token number">172.38</span>.0.11:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
M: 4dbe130bd240fb1d4ca9023b3e32d22e2b379c40 <span class="token number">172.38</span>.0.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
M: 8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7 <span class="token number">172.38</span>.0.13:6379
   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
S: 32b72ace218af7196f8a1761a3676efc5642a03b <span class="token number">172.38</span>.0.14:6379
   replicates 8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7
S: f8337c9e18eafbc183b60738ea3410de5f0c55fd <span class="token number">172.38</span>.0.15:6379
   replicates 7b7f474f5deb841ed789af0d2cd3a7294c1bac98
S: 4f108a64c4db7b5d274a5de1d9b6292dac9a371c <span class="token number">172.38</span>.0.16:6379
   replicates 4dbe130bd240fb1d4ca9023b3e32d22e2b379c40
Can I <span class="token builtin class-name">set</span> the above configuration? <span class="token punctuation">(</span>type <span class="token string">'yes'</span> to accept<span class="token punctuation">)</span>: <span class="token function">yes</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Nodes configuration updated
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Assign a different config epoch to each <span class="token function">node</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Sending CLUSTER MEET messages to <span class="token function">join</span> the cluster
Waiting <span class="token keyword">for</span> the cluster to <span class="token function">join</span>
<span class="token punctuation">..</span>.
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Performing Cluster Check <span class="token punctuation">(</span>using <span class="token function">node</span> <span class="token number">172.38</span>.0.11:6379<span class="token punctuation">)</span>
M: 7b7f474f5deb841ed789af0d2cd3a7294c1bac98 <span class="token number">172.38</span>.0.11:6379
   slots:<span class="token punctuation">[</span><span class="token number">0</span>-5460<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: 4dbe130bd240fb1d4ca9023b3e32d22e2b379c40 <span class="token number">172.38</span>.0.12:6379
   slots:<span class="token punctuation">[</span><span class="token number">5461</span>-10922<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5462</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
M: 8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7 <span class="token number">172.38</span>.0.13:6379
   slots:<span class="token punctuation">[</span><span class="token number">10923</span>-16383<span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token number">5461</span> slots<span class="token punctuation">)</span> master
   <span class="token number">1</span> additional replica<span class="token punctuation">(</span>s<span class="token punctuation">)</span>
S: f8337c9e18eafbc183b60738ea3410de5f0c55fd <span class="token number">172.38</span>.0.15:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 7b7f474f5deb841ed789af0d2cd3a7294c1bac98
S: 32b72ace218af7196f8a1761a3676efc5642a03b <span class="token number">172.38</span>.0.14:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7
S: 4f108a64c4db7b5d274a5de1d9b6292dac9a371c <span class="token number">172.38</span>.0.16:6379
   slots: <span class="token punctuation">(</span><span class="token number">0</span> slots<span class="token punctuation">)</span> slave
   replicates 4dbe130bd240fb1d4ca9023b3e32d22e2b379c40
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All nodes agree about slots configuration.
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Check <span class="token keyword">for</span> <span class="token function">open</span> slots<span class="token punctuation">..</span>.
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> Check slots coverage<span class="token punctuation">..</span>.
<span class="token punctuation">[</span>OK<span class="token punctuation">]</span> All <span class="token number">16384</span> slots covered.

<span class="token comment"># docker 搭建redis集群完成</span>
/data <span class="token comment"># redis-cli -c</span>
<span class="token number">172.38</span>.0.13:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> <span class="token builtin class-name">set</span> a b
OK
<span class="token number">172.38</span>.0.13:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get a
<span class="token string">"b"</span>
<span class="token number">172.38</span>.0.13:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster nodes
32b72ace218af7196f8a1761a3676efc5642a03b <span class="token number">172.38</span>.0.14:6379@16379 slave 8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7 <span class="token number">0</span> <span class="token number">1651130873827</span> <span class="token number">4</span> connected
4dbe130bd240fb1d4ca9023b3e32d22e2b379c40 <span class="token number">172.38</span>.0.12:6379@16379 master - <span class="token number">0</span> <span class="token number">1651130875530</span> <span class="token number">2</span> connected <span class="token number">5461</span>-10922
f8337c9e18eafbc183b60738ea3410de5f0c55fd <span class="token number">172.38</span>.0.15:6379@16379 slave 7b7f474f5deb841ed789af0d2cd3a7294c1bac98 <span class="token number">0</span> <span class="token number">1651130875530</span> <span class="token number">5</span> connected
8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7 <span class="token number">172.38</span>.0.13:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1651130874000</span> <span class="token number">3</span> connected <span class="token number">10923</span>-16383
4f108a64c4db7b5d274a5de1d9b6292dac9a371c <span class="token number">172.38</span>.0.16:6379@16379 slave 4dbe130bd240fb1d4ca9023b3e32d22e2b379c40 <span class="token number">0</span> <span class="token number">1651130875830</span> <span class="token number">6</span> connected
7b7f474f5deb841ed789af0d2cd3a7294c1bac98 <span class="token number">172.38</span>.0.11:6379@16379 master - <span class="token number">0</span> <span class="token number">1651130874528</span> <span class="token number">1</span> connected <span class="token number">0</span>-5460

<span class="token comment"># 现在我们模拟宕机，挂掉当前的master</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                    COMMAND                  CREATED         STATUS         PORTS                                                                                      NAMES
869a6ce9f6b0   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">8</span> minutes ago   Up <span class="token number">8</span> minutes   <span class="token number">0.0</span>.0.0:6376-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6376-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16376-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16376-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-6
2ead11d175ce   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">9</span> minutes ago   Up <span class="token number">9</span> minutes   <span class="token number">0.0</span>.0.0:6375-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6375-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16375-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16375-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-5
349c9d30b905   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">9</span> minutes ago   Up <span class="token number">9</span> minutes   <span class="token number">0.0</span>.0.0:6374-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6374-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16374-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16374-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-4
e534ebf30369   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">9</span> minutes ago   Up <span class="token number">9</span> minutes   <span class="token number">0.0</span>.0.0:6373-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6373-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16373-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16373-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-3
847746759c29   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">9</span> minutes ago   Up <span class="token number">9</span> minutes   <span class="token number">0.0</span>.0.0:6372-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6372-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16372-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16372-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-2
b08ea8b5184e   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   <span class="token number">9</span> minutes ago   Up <span class="token number">9</span> minutes   <span class="token number">0.0</span>.0.0:6371-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6371-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16371-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16371-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-1
<span class="token punctuation">[</span>root@VM-24-12-centos ~<span class="token punctuation">]</span><span class="token comment"># docker stop redis-3</span>
redis-3
<span class="token comment"># 当前容器成功挂掉</span>
<span class="token number">172.38</span>.0.13:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get a
^C
<span class="token comment"># 重新获取 get a</span>
/data <span class="token comment"># redis-cli -c</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> get a
-<span class="token operator">&gt;</span> Redirected to slot <span class="token punctuation">[</span><span class="token number">15495</span><span class="token punctuation">]</span> located at <span class="token number">172.38</span>.0.14:6379
<span class="token string">"b"</span>
<span class="token number">172.38</span>.0.14:637<span class="token operator"><span class="token file-descriptor important">9</span>&gt;</span> cluster nodes
8c1aa2186c3cd0e4122766a77b13f7cc7c91aaf7 <span class="token number">172.38</span>.0.13:6379@16379 master,fail - <span class="token number">1651131226581</span> <span class="token number">1651131225780</span> <span class="token number">3</span> connected
32b72ace218af7196f8a1761a3676efc5642a03b <span class="token number">172.38</span>.0.14:6379@16379 myself,master - <span class="token number">0</span> <span class="token number">1651131291000</span> <span class="token number">7</span> connected <span class="token number">10923</span>-16383
4f108a64c4db7b5d274a5de1d9b6292dac9a371c <span class="token number">172.38</span>.0.16:6379@16379 slave 4dbe130bd240fb1d4ca9023b3e32d22e2b379c40 <span class="token number">0</span> <span class="token number">1651131291892</span> <span class="token number">6</span> connected
f8337c9e18eafbc183b60738ea3410de5f0c55fd <span class="token number">172.38</span>.0.15:6379@16379 slave 7b7f474f5deb841ed789af0d2cd3a7294c1bac98 <span class="token number">0</span> <span class="token number">1651131290590</span> <span class="token number">5</span> connected
4dbe130bd240fb1d4ca9023b3e32d22e2b379c40 <span class="token number">172.38</span>.0.12:6379@16379 master - <span class="token number">0</span> <span class="token number">1651131291592</span> <span class="token number">2</span> connected <span class="token number">5461</span>-10922
7b7f474f5deb841ed789af0d2cd3a7294c1bac98 <span class="token number">172.38</span>.0.11:6379@16379 master - <span class="token number">0</span> <span class="token number">1651131291000</span> <span class="token number">1</span> connected <span class="token number">0</span>-5460
</code></pre> 
<h2><a id="SpringBootDocker_2132"></a>七、SpringBoot微服务打包Docker镜像</h2> 
<ol><li> <p>构建SpringBoot项目<br> <img src="https://images2.imgbox.com/18/c1/P3MSWH4e_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/21/82/fzU9ZNCM_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e7/8e/hxyRN4qV_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1f/8f/3ZQp4yHz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3f/2e/ddBztQPj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b7/22/Q5WvKDoL_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4a/5b/hVGGBY1E_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8a/52/epepS4Ko_o.png" alt="在这里插入图片描述"></p> </li><li> <p>编写Dockerfile</p> </li></ol> 
<pre><code class="prism language-shell">FROM java:8
 
COPY *.jar /app.jar
 
CMD <span class="token punctuation">[</span><span class="token string">"--server.port=8080"</span><span class="token punctuation">]</span>
 
EXPOSE <span class="token number">8080</span>
 
ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>, <span class="token string">"-jar"</span>, <span class="token string">"/app.jar"</span><span class="token punctuation">]</span>
</code></pre> 
<ol start="3"><li>构建镜像</li></ol> 
<pre><code class="prism language-shell"><span class="token comment"># 把打好的jar包和Dockerfile上传到linux</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ceshi<span class="token punctuation">]</span><span class="token comment"># ll</span>
总用量 <span class="token number">17136</span>
-rw-r--r-- <span class="token number">1</span> root root <span class="token number">17542922</span> <span class="token number">4</span>月  <span class="token number">28</span> <span class="token number">16</span>:39 demo-0.0.1-SNAPSHOT.jar
-rw-r--r-- <span class="token number">1</span> root root      <span class="token number">124</span> <span class="token number">4</span>月  <span class="token number">28</span> <span class="token number">16</span>:38 Dockerfile

<span class="token comment"># 构建镜像，不要忘了最后有一个点</span>
<span class="token punctuation">[</span>root@VM-24-12-centos ceshi<span class="token punctuation">]</span><span class="token comment"># docker build -t xiaohang .</span>
Sending build context to Docker daemon  <span class="token number">17</span>.55MB
Step <span class="token number">1</span>/5 <span class="token builtin class-name">:</span> FROM java:8
<span class="token number">8</span>: Pulling from library/java
5040bd298390: Pull complete 
fce5728aad85: Pull complete 
76610ec20bf5: Pull complete 
60170fec2151: Pull complete 
e98f73de8f0d: Pull complete 
11f7af24ed9c: Pull complete 
49e2d6393f32: Pull complete 
bb9cdec9c7f3: Pull complete 
Digest: sha256:c1ff613e8ba25833d2e1940da0940c3824f03f802c449f3d1815a66b7f8c0e9d
Status: Downloaded newer image <span class="token keyword">for</span> java:8
 ---<span class="token operator">&gt;</span> d23bdf5b1b1b
Step <span class="token number">2</span>/5 <span class="token builtin class-name">:</span> COPY *.jar /app.jar
 ---<span class="token operator">&gt;</span> 18cfc3f88a7f
Step <span class="token number">3</span>/5 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"--server.port=8080"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 429a00e60898
Removing intermediate container 429a00e60898
 ---<span class="token operator">&gt;</span> ccd6f998893a
Step <span class="token number">4</span>/5 <span class="token builtin class-name">:</span> EXPOSE <span class="token number">8080</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 9f6841a10f25
Removing intermediate container 9f6841a10f25
 ---<span class="token operator">&gt;</span> 3050a62735ad
Step <span class="token number">5</span>/5 <span class="token builtin class-name">:</span> ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>, <span class="token string">"-jar"</span>, <span class="token string">"/app.jar"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 5b4c19329c96
Removing intermediate container 5b4c19329c96
 ---<span class="token operator">&gt;</span> e3f233220c0c
Successfully built e3f233220c0c
Successfully tagged xiaohang:latest
<span class="token punctuation">[</span>root@VM-24-12-centos ceshi<span class="token punctuation">]</span><span class="token comment"># docker images</span>
REPOSITORY   TAG                IMAGE ID       CREATED          SIZE
xiaohang     latest             e3f233220c0c   <span class="token number">43</span> seconds ago   661MB
redis        <span class="token number">5.0</span>.9-alpine3.11   3661c84ee9d0   <span class="token number">2</span> years ago      <span class="token number">29</span>.8MB
java         <span class="token number">8</span>                  d23bdf5b1b1b   <span class="token number">5</span> years ago      643MB
<span class="token punctuation">[</span>root@VM-24-12-centos ceshi<span class="token punctuation">]</span><span class="token comment"># docker run -d -P --name xiaohang-web xiaohang</span>
9d433ae3ba3290438bac32065071b6360e3db9d58af5df0187dd9c07cedd8832
<span class="token punctuation">[</span>root@VM-24-12-centos ceshi<span class="token punctuation">]</span><span class="token comment"># docker ps</span>
CONTAINER ID   IMAGE                    COMMAND                  CREATED             STATUS             PORTS                                                                                      NAMES
9d433ae3ba32   xiaohang                 <span class="token string">"java -jar /app.jar …"</span>   <span class="token number">5</span> seconds ago       Up <span class="token number">4</span> seconds       <span class="token number">0.0</span>.0.0:49157-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp, :::49157-<span class="token operator">&gt;</span><span class="token number">8080</span>/tcp                                                xiaohang-web
869a6ce9f6b0   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   About an hour ago   Up About an hour   <span class="token number">0.0</span>.0.0:6376-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6376-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16376-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16376-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-6
2ead11d175ce   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   About an hour ago   Up About an hour   <span class="token number">0.0</span>.0.0:6375-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6375-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16375-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16375-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-5
349c9d30b905   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   About an hour ago   Up About an hour   <span class="token number">0.0</span>.0.0:6374-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6374-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16374-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16374-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-4
847746759c29   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   About an hour ago   Up About an hour   <span class="token number">0.0</span>.0.0:6372-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6372-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16372-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16372-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-2
b08ea8b5184e   redis:5.0.9-alpine3.11   <span class="token string">"docker-entrypoint.s…"</span>   About an hour ago   Up About an hour   <span class="token number">0.0</span>.0.0:6371-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, :::6371-<span class="token operator">&gt;</span><span class="token number">6379</span>/tcp, <span class="token number">0.0</span>.0.0:16371-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp, :::16371-<span class="token operator">&gt;</span><span class="token number">16379</span>/tcp   redis-1
<span class="token punctuation">[</span>root@VM-24-12-centos ceshi<span class="token punctuation">]</span><span class="token comment"># curl localhost:8080</span>
hello xiaohang<span class="token operator">!</span>
</code></pre> 
<ol start="4"><li>发布运行</li></ol> 
<h2><a id="DockerCompose_2215"></a>八、DockerCompose</h2> 
<h3><a id="1_2216"></a>1、简介</h3> 
<p>之前我们是：DockerFile -&gt; build -&gt; run 手动操作，单个容器！</p> 
<p>现在我们有很多微服务，使用Docker Compose来轻松高效的管理容器，定义多个容器。</p> 
<blockquote> 
 <p>官方介绍</p> 
</blockquote> 
<ul><li>定义、运行多个容器。</li><li>YAML file 配置文件</li><li>single command 命令有哪些？</li></ul> 
<p>Compose is a tool for defining and running multi-container Docker applications. With Compose, you use a YAML file to configure your application’s services. Then, with a single command, you create and start all the services from your configuration. To learn more about all the features of Compose, see <a href="https://docs.docker.com/compose/#features" rel="nofollow">the list of features</a>.</p> 
<ul><li>所有环境都可以使用 Compose。</li></ul> 
<p>Compose works in all environments: production, staging, development, testing, as well as CI workflows. You can learn more about each case in <a href="https://docs.docker.com/compose/#common-use-cases" rel="nofollow">Common Use Cases</a>.</p> 
<ul><li>三步骤：</li></ul> 
<p>Using Compose is basically a three-step process:</p> 
<ol><li>Define your app’s environment with a <code>Dockerfile</code> so it can be reproduced anywhere.</li></ol> 
<ul><li>Dockerfile保证我们的项目在任何地方运行</li></ul> 
<ol start="2"><li>Define the services that make up your app in <code>docker-compose.yml</code> so they can be run together in an isolated environment.</li></ol> 
<ul><li>services 什么服务。</li><li>docker-compose.yml 这个文件怎么写？</li></ul> 
<ol start="3"><li>Run <code>docker compose up</code> and the <a href="https://docs.docker.com/compose/#compose-v2-and-the-new-docker-compose-command" rel="nofollow">Docker compose command</a> starts and runs your entire app. You can alternatively run <code>docker-compose up</code> using the docker-compose binary.</li></ol> 
<ul><li>启动项目</li></ul> 
<p>作用：批量容器编排</p> 
<blockquote> 
 <p>个人理解</p> 
</blockquote> 
<p>Compose是Docker官方开源的项目，需要安装！<br> Compose：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.9"</span>  <span class="token comment"># optional since v1.27.0</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8000:5000"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code
      <span class="token punctuation">-</span> logvolume01<span class="token punctuation">:</span>/var/log
    <span class="token key atrule">links</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> redis
<span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token key atrule">logvolume01</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<p>重要的概念：</p> 
<ul><li>服务：Services</li><li>项目：project 一组关联的容器</li></ul> 
<h3><a id="2_2276"></a>2、安装</h3> 
<pre><code class="prism language-shell"><span class="token comment"># 1、下载</span>
<span class="token comment"># 国内地址</span>
<span class="token function">curl</span> -L https://get.daocloud.io/docker/compose/releases/download/1.25.5/docker-compose-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -s<span class="token variable">`</span></span>-<span class="token variable"><span class="token variable">`</span><span class="token function">uname</span> -m<span class="token variable">`</span></span> <span class="token operator">&gt;</span> /usr/local/bin/docker-compose
 
<span class="token comment"># 2、授权</span>
<span class="token function">sudo</span> <span class="token function">chmod</span> +x /usr/local/bin/docker-compose
 
<span class="token comment"># 3、检查是否安装成功</span>
<span class="token function">docker-compose</span> version
</code></pre> 
<h3><a id="3_2288"></a>3、体验</h3> 
<p><a href="https://docs.docker.com/compose/gettingstarted/" rel="nofollow">官网示例</a></p> 
<p>补充：（官网的例子无法通过测试）</p> 
<hr> 
<p>app.py</p> 
<pre><code class="prism language-py"><span class="token keyword">import</span> time

<span class="token keyword">import</span> redis
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
cache <span class="token operator">=</span> redis<span class="token punctuation">.</span>Redis<span class="token punctuation">(</span>host<span class="token operator">=</span><span class="token string">'redis'</span><span class="token punctuation">,</span> port<span class="token operator">=</span><span class="token number">6379</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">get_hit_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    retries <span class="token operator">=</span> <span class="token number">5</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> cache<span class="token punctuation">.</span>incr<span class="token punctuation">(</span><span class="token string">'hits'</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span> redis<span class="token punctuation">.</span>exceptions<span class="token punctuation">.</span>ConnectionError <span class="token keyword">as</span> exc<span class="token punctuation">:</span>
            <span class="token keyword">if</span> retries <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                <span class="token keyword">raise</span> exc
            retries <span class="token operator">-=</span> <span class="token number">1</span>
            time<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">)</span>

<span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">hello</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    count <span class="token operator">=</span> get_hit_count<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token string">'Hello World! I have been seen {} times.\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span>
</code></pre> 
<hr> 
<p>requirements.txt</p> 
<pre><code>flask
redis
</code></pre> 
<hr> 
<p>Dockerfile</p> 
<pre><code>FROM python:3.6-alpine
ADD . /code
WORKDIR /code
RUN pip install -r requirements.txt
CMD ["python", "app.py"]
 
# 官网的用来flask框架，我们这里不用它
# 这告诉Docker
# 从python3.7开始构建镜像
# 将当前目录添加到/code印像中的路径中
# 将工作目录设置为/code
# 安装Python依赖项
# 将容器的默认命令设置为python app.py
</code></pre> 
<hr> 
<p>docker-compose.yml</p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">web</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"5000:5000"</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .<span class="token punctuation">:</span>/code
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"redis:alpine"</span>
</code></pre> 
<hr> 
<p>启动：</p> 
<pre><code>docker-compose up
</code></pre> 
<p>流程：</p> 
<ol><li>创建网络</li><li>执行Docker-compose.yaml</li><li>启动服务</li></ol> 
<p>Docker小结：</p> 
<ol><li>Docker镜像。 run =&gt; 容器</li><li>DockerFile 构建镜像（服务打包）</li><li>docker-compose 启动项目（编排、多个微服务/环境）</li><li>Docker网络</li></ol> 
<h3><a id="4yaml_2373"></a>4、yaml规则</h3> 
<p>docker-compose.yaml 核心！</p> 
<p><a href="https://docs.docker.com/compose/compose-file/compose-file-v3/" rel="nofollow">官方文档</a></p> 
<pre><code class="prism language-yml"><span class="token comment"># 3层</span>
<span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">''</span> <span class="token comment"># 版本</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span> <span class="token comment"># 服务</span>
	<span class="token key atrule">服务1</span><span class="token punctuation">:</span> web
		<span class="token comment"># 服务配置</span>
		images
		build
		network
		<span class="token punctuation">...</span><span class="token punctuation">...</span>
	<span class="token key atrule">服务2</span><span class="token punctuation">:</span> redis
		<span class="token punctuation">...</span>..
	<span class="token key atrule">服务3</span><span class="token punctuation">:</span> mysql
		<span class="token punctuation">...</span>..
<span class="token comment"># 其他配置 网络/卷 全局规则</span>
volumes：
networks：
configs
</code></pre> 
<p><img src="https://images2.imgbox.com/9a/34/HpLhNzZY_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5_2398"></a>5、实战开源项目</h3> 
<p>一键搭建WordPress博客</p> 
<p><a href="https://docs.docker.com/samples/wordpress/" rel="nofollow">官方示例</a></p> 
<pre><code>docker-compose up  启动
docker-compose down  停止
</code></pre> 
<h3><a id="6_2408"></a>6、实战</h3> 
<p>1.初始化SpringBoot项目<br> <img src="https://images2.imgbox.com/e8/5c/yGTa3bHl_o.png" alt="在这里插入图片描述"><br> 配置文件：</p> 
<p><img src="https://images2.imgbox.com/f6/8d/BPF8YlPt_o.png" alt="在这里插入图片描述"><br> 2.编写Dockerfile文件构建镜像</p> 
<p><img src="https://images2.imgbox.com/3a/ae/6QM3YEtg_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-Dockerfile">FROM java:8

COPY *.jar /app.jar

CMD ["--server.port=8080"]

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "/app.jar"]
</code></pre> 
<p>3.docker-compose.yml编排项目</p> 
<p><img src="https://images2.imgbox.com/77/c9/40Nh8ocH_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-yml"><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.8'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">demoapp</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">image</span><span class="token punctuation">:</span> demoapp
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> redis
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">"8080:8080"</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">"library/redis:alpine"</span>
</code></pre> 
<p>4.丢到服务器，docker-compose up 编排启动</p> 
<p>打包jar包<br> <img src="https://images2.imgbox.com/64/9d/yGZw5hFc_o.png" alt="在这里插入图片描述"><br> 一定要检查一下jar包是否打包正确，4KB的那种，是因为maven没有配置插件，没把依赖打包进来。</p> 
<p>紧接着，我们上传到服务器中：<br> <img src="https://images2.imgbox.com/6f/64/eTHdVI3M_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-shell"><span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># mkdir demoDcoker</span>
<span class="token punctuation">[</span>root@VM-24-12-centos home<span class="token punctuation">]</span><span class="token comment"># cd demoDcoker/</span>
<span class="token punctuation">[</span>root@VM-24-12-centos demoDcoker<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token punctuation">[</span>root@VM-24-12-centos demoDcoker<span class="token punctuation">]</span><span class="token comment"># ls</span>
demo-0.0.1-SNAPSHOT.jar  docker-compose.yml  Dockerfile
<span class="token punctuation">[</span>root@VM-24-12-centos demoDcoker<span class="token punctuation">]</span><span class="token comment"># docker-compose up</span>
Creating network <span class="token string">"demodcoker_default"</span> with the default driver
Building demoapp
Step <span class="token number">1</span>/5 <span class="token builtin class-name">:</span> FROM java:8
 ---<span class="token operator">&gt;</span> d23bdf5b1b1b
Step <span class="token number">2</span>/5 <span class="token builtin class-name">:</span> COPY *.jar /app.jar
 ---<span class="token operator">&gt;</span> 9642ca5cf204
Step <span class="token number">3</span>/5 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span><span class="token string">"--server.port=8080"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> d5c3d7311cb4
Removing intermediate container d5c3d7311cb4
 ---<span class="token operator">&gt;</span> c9e8a80cc852
Step <span class="token number">4</span>/5 <span class="token builtin class-name">:</span> EXPOSE <span class="token number">8080</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> 7cd3844db211
Removing intermediate container 7cd3844db211
 ---<span class="token operator">&gt;</span> 8fadaa095ba1
Step <span class="token number">5</span>/5 <span class="token builtin class-name">:</span> ENTRYPOINT <span class="token punctuation">[</span><span class="token string">"java"</span>, <span class="token string">"-jar"</span>, <span class="token string">"/app.jar"</span><span class="token punctuation">]</span>
 ---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> ca5f1648bc5a
Removing intermediate container ca5f1648bc5a
 ---<span class="token operator">&gt;</span> d3d778d2f33f

Successfully built d3d778d2f33f
Successfully tagged demoapp:latest
WARNING: Image <span class="token keyword">for</span> <span class="token function">service</span> demoapp was built because it did not already exist. To rebuild this image you must use <span class="token variable"><span class="token variable">`</span><span class="token function">docker-compose</span> build<span class="token variable">`</span></span> or <span class="token variable"><span class="token variable">`</span><span class="token function">docker-compose</span> up --build<span class="token variable">`</span></span><span class="token builtin class-name">.</span>
Creating demodcoker_redis_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Creating demodcoker_demoapp_1 <span class="token punctuation">..</span>. <span class="token keyword">done</span>
Attaching to demodcoker_redis_1, demodcoker_demoapp_1
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:C <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.790 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:C <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.790 <span class="token comment"># Redis version=6.2.6, bits=64, commit=00000000, modified=0, pid=1, just started</span>
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:C <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.790 <span class="token comment"># Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf</span>
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.791 * monotonic clock: POSIX clock_gettime
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.791 * Running <span class="token assign-left variable">mode</span><span class="token operator">=</span>standalone, <span class="token assign-left variable">port</span><span class="token operator">=</span><span class="token number">6379</span>.
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.791 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.791 <span class="token comment"># Server initialized</span>
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.791 <span class="token comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span>
redis_1    <span class="token operator">|</span> <span class="token number">1</span>:M <span class="token number">21</span> Jun <span class="token number">2022</span> 03:35:13.791 * Ready to accept connections
demoapp_1  <span class="token operator">|</span> 
demoapp_1  <span class="token operator">|</span>   <span class="token builtin class-name">.</span>   ____          _            __ _ _
demoapp_1  <span class="token operator">|</span>  /<span class="token punctuation">\</span><span class="token punctuation">\</span> / ___<span class="token string">'_ __ _ _(_)_ __  __ _ \ \ \ \
demoapp_1  | ( ( )\___ | '</span>_ <span class="token operator">|</span> <span class="token string">'_| | '</span>_ <span class="token punctuation">\</span>/ _` <span class="token operator">|</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span> <span class="token punctuation">\</span>
demoapp_1  <span class="token operator">|</span>  <span class="token punctuation">\</span><span class="token punctuation">\</span>/  ___<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span>_<span class="token punctuation">)</span><span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">|</span> <span class="token operator">||</span> <span class="token punctuation">(</span>_<span class="token operator">|</span> <span class="token operator">|</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
demoapp_1  <span class="token operator">|</span>   <span class="token string">'  |____| .__|_| |_|_| |_\__, | / / / /
demoapp_1  |  =========|_|==============|___/=/_/_/_/
demoapp_1  |  :: Spring Boot ::                (v2.4.1)
demoapp_1  | 
demoapp_1  | 2022-06-21 03:35:17.486  INFO 1 --- [           main] com.dockerdemo.DemoApplication           : Starting DemoApplication using Java 1.8.0_111 on da5653278dec with PID 1 (/app.jar started by root in /)
demoapp_1  | 2022-06-21 03:35:17.489  INFO 1 --- [           main] com.dockerdemo.DemoApplication           : No active profile set, falling back to default profiles: default
demoapp_1  | 2022-06-21 03:35:18.556  INFO 1 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Multiple Spring Data modules found, entering strict repository configuration mode!
demoapp_1  | 2022-06-21 03:35:18.558  INFO 1 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Bootstrapping Spring Data Redis repositories in DEFAULT mode.
demoapp_1  | 2022-06-21 03:35:18.577  INFO 1 --- [           main] .s.d.r.c.RepositoryConfigurationDelegate : Finished Spring Data repository scanning in 4 ms. Found 0 Redis repository interfaces.
demoapp_1  | 2022-06-21 03:35:19.188  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat initialized with port(s): 8080 (http)
demoapp_1  | 2022-06-21 03:35:19.225  INFO 1 --- [           main] o.apache.catalina.core.StandardService   : Starting service [Tomcat]
demoapp_1  | 2022-06-21 03:35:19.225  INFO 1 --- [           main] org.apache.catalina.core.StandardEngine  : Starting Servlet engine: [Apache Tomcat/9.0.41]
demoapp_1  | 2022-06-21 03:35:19.291  INFO 1 --- [           main] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring embedded WebApplicationContext
demoapp_1  | 2022-06-21 03:35:19.291  INFO 1 --- [           main] w.s.c.ServletWebServerApplicationContext : Root WebApplicationContext: initialization completed in 1666 ms
demoapp_1  | 2022-06-21 03:35:20.278  INFO 1 --- [           main] o.s.s.concurrent.ThreadPoolTaskExecutor  : Initializing ExecutorService '</span>applicationTaskExecutor<span class="token string">'
demoapp_1  | 2022-06-21 03:35:20.638  INFO 1 --- [           main] o.s.b.w.embedded.tomcat.TomcatWebServer  : Tomcat started on port(s): 8080 (http) with context path '</span>'
demoapp_1  <span class="token operator">|</span> <span class="token number">2022</span>-06-21 03:35:20.651  INFO <span class="token number">1</span> --- <span class="token punctuation">[</span>           main<span class="token punctuation">]</span> com.dockerdemo.DemoApplication           <span class="token builtin class-name">:</span> Started DemoApplication <span class="token keyword">in</span> <span class="token number">4.093</span> seconds <span class="token punctuation">(</span>JVM running <span class="token keyword">for</span> <span class="token number">6.056</span><span class="token punctuation">)</span>
</code></pre> 
<p>测试：<br> <img src="https://images2.imgbox.com/f6/35/dWnYmQ6Z_o.png" alt="在这里插入图片描述"><br> 重新构建项目：</p> 
<pre><code>docker-compose up --build   # 重新部署！
</code></pre> 
<p>总结：</p> 
<ul><li>工程</li><li>服务</li><li>容器</li></ul> 
<h2><a id="DockerSwarm_2530"></a>九、DockerSwarm</h2> 
<h3><a id="1_2532"></a>1、集群</h3> 
<blockquote> 
 <p>购买服务器(四台) =&gt; 搭建双主双从</p> 
</blockquote> 
<p>工作机制：<br> <img src="https://images2.imgbox.com/ca/98/JQRT6211_o.png" alt="在这里插入图片描述"><br> <a href="https://docs.docker.com/engine/swarm/how-swarm-mode-works/nodes/" rel="nofollow">官网直达</a></p> 
<pre><code>docker swarm init --help
 
ip addr # 获取自己的ip（用内网的不要流量）
 
[root@iZ2ze58v8acnlxsnjoulk5Z ~]# docker swarm init --advertise-addr 172.16.250.97
Swarm initialized: current node (otdyxbk2ffbogdqq1kigysj1d) is now a manager.
To add a worker to this swarm, run the following command:
    docker swarm join --token SWMTKN-1-3vovnwb5pkkno2i3u2a42yrxc1dk51zxvto5hrm4asgn37syfn-0xkrprkuyyhrx7cidg381pdir 172.16.250.97:2377
To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
</code></pre> 
<p>初始化结点docker swarm init<br> docker swarm join 加入一个结点！</p> 
<pre><code class="prism language-shell"><span class="token comment"># 获取令牌</span>
<span class="token function">docker</span> swarm join-token manager
<span class="token function">docker</span> swarm join-token worker
</code></pre> 
<h3><a id="2Raft_2559"></a>2、Raft协议</h3> 
<p>保证大多数节点存活才可以用。 至少要保证三个主节点</p> 
<h3><a id="3_2562"></a>3、体会</h3> 
<p>弹性、扩缩容</p> 
<p>容器 =&gt; 服务</p> 
<p>灰度发布：金丝雀发布！</p> 
<pre><code>docker run  容器启动！ 不具有扩缩容器
docker service  服务！ 具有扩缩容器，滚动更新！
</code></pre> 
<h3><a id="4_2574"></a>4、概念总结</h3> 
<p><strong>1.swarm</strong><br> 集群的管理和编号，docker可以初始化一个swarm集群，其他节点可以加入。（身份：管理员、工作者）</p> 
<p><strong>2.Node</strong><br> 就是一个docker节点，多个节点组成了网络集群。</p> 
<p><strong>3.Service</strong><br> 任务，可以在管理节点或者工作节点来运行核心。</p> 
<p><strong>4.Task</strong><br> 容器内的命令，细节任务！</p> 
<p><img src="https://images2.imgbox.com/9a/2b/TBEX7R6v_o.png" alt="在这里插入图片描述"></p> 
<p><strong>逻辑是不变的！</strong></p> 
<p>命令 -&gt; 管理 -&gt; API -&gt; 调度 -&gt; 工作节点（创建Task容器维护创建）</p> 
<h2><a id="Docker_Stack_2594"></a>十、Docker Stack</h2> 
<h2><a id="Docker_Secret_2596"></a>十一、Docker Secret</h2> 
<h2><a id="Docker_Config_2597"></a>十二、Docker Config</h2>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f9d59eba414bcb2efd20230468936251/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">三分钟带你了解什么是RBAC模型</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/39f2f2fd623d2f9fdb18948e56c0f365/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OPENGL环境配置-vs2022（win系统）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>