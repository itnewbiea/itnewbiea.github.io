<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android RecyclerView 动画处理 流程 原理（源码分析第二篇） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android RecyclerView 动画处理 流程 原理（源码分析第二篇）" />
<meta property="og:description" content="零、本文主题 本文要解决的问题：
1. Recyclerview 动画的实现原理是什么？
2. 处理的主要流程大概是怎样的？
一、核心原理 我们抛开代码，想一下，RecyclerView中的view动画有几种？
添加一个view：添加的View 显示出来，它下面的所有view向下移动一格距离
删除一个view：删除的View 渐隐掉，它下面的所有view向上移动一格距离
上下滑动：所有子view上下滑动
移动：…
归纳起来，最终实现动画的时候，无外乎会执行几个操作：
添加或删除View的 透明度动画 0-&gt;1 或 1-&gt;0
子view的y轴坐标，由动画前的位置，滑动到 动画后的位置（我们暂时只讨论常见的竖向布局）
所以，看似复杂的RecyclerView动画处理，经过分解后，其实就是一个view的简单动画，没有任何新奇的玩意或算法。
所有需要做的就是，记录下动画执行前view的状态（透明度，y坐标），以及计算出动画的目的地（透明度，y坐标），然后执行动画，仅此而已，这就是RecyclerView动画实现的核心原理。
二、源码分析 - 主流程 经过上面的分析，其实我们的重点变成了，view数据的组织与记录（动画前），view的数据的计算（动画后），心里要有这个数。
然后，我们大概看一下，整个流程：
2.1 最终执行动画的 核心接口：RecyclerView.ItemAnimator
核心实现类：DefaultItemAnimator
核心实现方法：DefaultItemAnimator.runPendingAnimations()
调用栈如下：
DefaultItemAnimator.runPendingAnimations() — 核心方法
|
RecyclerView.mItemAnimatorRunner
|
RecyclerView.postAnimationRunner()
|
ViewInfoStore.ProcessCallback
|
ViewInfoStore.process(ProcessCallback callback)
|
RecyclerView.dispatchLayoutStep3() 触发动画的根
=== RecyclerView.java private void dispatchLayoutStep3() { ...... // Step 4: Process view info lists and trigger animations mViewInfoStore.process(mViewInfoProcessCallback); } 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4cc3df2543d4ba5a7b910b8c1c341540/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-13T17:38:08+08:00" />
<meta property="article:modified_time" content="2023-12-13T17:38:08+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android RecyclerView 动画处理 流程 原理（源码分析第二篇）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>零、本文主题</h2> 
<blockquote> 
 <p>本文要解决的问题：<br> <strong>1. Recyclerview 动画的实现原理是什么？</strong><br> <strong>2. 处理的主要流程大概是怎样的？</strong></p> 
</blockquote> 
<h2><a id="_5"></a>一、核心原理</h2> 
<p>我们抛开代码，想一下，RecyclerView中的view动画有几种？<br> 添加一个view：添加的View 显示出来，它下面的所有view向下移动一格距离<br> 删除一个view：删除的View 渐隐掉，它下面的所有view向上移动一格距离<br> 上下滑动：所有子view上下滑动<br> 移动：…</p> 
<p>归纳起来，最终实现动画的时候，无外乎会执行几个操作：<br> 添加或删除View的 透明度动画 0-&gt;1 或 1-&gt;0<br> 子view的y轴坐标，由动画前的位置，滑动到 动画后的位置（我们暂时只讨论常见的竖向布局）</p> 
<blockquote> 
 <p><strong>所以，看似复杂的RecyclerView动画处理，经过分解后，其实就是一个view的简单动画，没有任何新奇的玩意或算法。</strong></p> 
</blockquote> 
<blockquote> 
 <p><strong>所有需要做的就是，记录下动画执行前view的状态（透明度，y坐标），以及计算出动画的目的地（透明度，y坐标），然后执行动画，仅此而已，这就是RecyclerView动画实现的核心原理。</strong></p> 
</blockquote> 
<h2><a id="___20"></a>二、源码分析 - 主流程</h2> 
<p>经过上面的分析，其实我们的重点变成了，view数据的组织与记录（动画前），view的数据的计算（动画后），心里要有这个数。<br> 然后，我们大概看一下，整个流程：</p> 
<h3><a id="21__23"></a>2.1 最终执行动画的</h3> 
<p>核心接口：<code>RecyclerView.ItemAnimator</code><br> 核心实现类：<code>DefaultItemAnimator</code><br> 核心实现方法：<code>DefaultItemAnimator.runPendingAnimations()</code></p> 
<p>调用栈如下：<br> DefaultItemAnimator.runPendingAnimations() — 核心方法<br> |<br> RecyclerView.mItemAnimatorRunner<br> |<br> RecyclerView.postAnimationRunner()<br> |<br> ViewInfoStore.ProcessCallback<br> |<br> ViewInfoStore.process(ProcessCallback callback)<br> |<br> RecyclerView.dispatchLayoutStep3() 触发动画的根</p> 
<pre><code class="prism language-java"><span class="token operator">==</span><span class="token operator">=</span> <span class="token class-name">RecyclerView</span><span class="token punctuation">.</span>java
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchLayoutStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 	<span class="token comment">// Step 4: Process view info lists and trigger animations</span>
    mViewInfoStore<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>mViewInfoProcessCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22__49"></a>2.2 动画信息存储</h3> 
<p>核心类：ViewInfoStore<br> 核心数据结构：mLayoutHolderMap</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">SimpleArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>ViewHolder</span><span class="token punctuation">,</span> <span class="token class-name">InfoRecord</span><span class="token punctuation">&gt;</span></span> mLayoutHolderMap <span class="token operator">=</span>
            <span class="token keyword">new</span> <span class="token class-name">SimpleArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>ViewInfoStore这个类，抽象了所有的子View的（为了运行动画的）跟踪信息。<br> 看下mLayoutHolderMap，ViewHolder就是子view，映射了一个InfoRecord</p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">InfoRecord</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Nullable</span>
        <span class="token class-name">RecyclerView<span class="token punctuation">.</span>ItemAnimator<span class="token punctuation">.</span>ItemHolderInfo</span> preInfo<span class="token punctuation">;</span>
        <span class="token annotation punctuation">@Nullable</span>
        <span class="token class-name">RecyclerView<span class="token punctuation">.</span>ItemAnimator<span class="token punctuation">.</span>ItemHolderInfo</span> postInfo<span class="token punctuation">;</span>
</code></pre> 
<p>一目了然，preInfo是动画执行前的信息，postInfo是动画执行后的信息。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ItemHolderInfo</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> left<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> top<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> right<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> bottom<span class="token punctuation">;</span>
            <span class="token keyword">public</span> <span class="token keyword">int</span> changeFlags<span class="token punctuation">;</span>
</code></pre> 
<p>ItemHolderInfo 记录了View的坐标与flag。<br> <strong>推断逻辑：<br> 也就是说在2.1最终执行动画前，ViewInfoStore中的数据应该是已经准备好的。</strong></p> 
<h3><a id="23_view_78"></a>2.3 动画执行前，view信息保存</h3> 
<p>核心类：ViewInfoStore<br> 核心方法：addToPreLayout()<br> 入口：RecyclerView.dispatchLayoutStep1()</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">ItemHolderInfo</span> animationInfo <span class="token operator">=</span> mItemAnimator
                        <span class="token punctuation">.</span><span class="token function">recordPreLayoutInformation</span><span class="token punctuation">(</span>mState<span class="token punctuation">,</span> holder<span class="token punctuation">,</span>
                                <span class="token class-name">ItemAnimator</span><span class="token punctuation">.</span><span class="token function">buildAdapterChangeFlagsForAnimations</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                holder<span class="token punctuation">.</span><span class="token function">getUnmodifiedPayloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                mViewInfoStore<span class="token punctuation">.</span><span class="token function">addToPreLayout</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> animationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="24_View_89"></a>2.4 计算“动画执行后，View应该要处于的状态”的信息</h3> 
<p>核心类：ViewInfoStore<br> 核心方法：addToPostLayout()<br> 入口：RecyclerView.dispatchLayoutStep3()</p> 
<pre><code class="prism language-java"><span class="token keyword">final</span> <span class="token class-name">ItemHolderInfo</span> animationInfo <span class="token operator">=</span> mItemAnimator
                        <span class="token punctuation">.</span><span class="token function">recordPostLayoutInformation</span><span class="token punctuation">(</span>mState<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
mViewInfoStore<span class="token punctuation">.</span><span class="token function">addToPostLayout</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> animationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<hr> 
<p><strong>以上，就是本篇的主要内容了。</strong></p> 
<hr> 
<p>以后有时间的话，补一下细节流程，再更新吧。<br> <em>/// 三、源码分析 - 细节流程分析</em></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2ef1f6a5b6dd3dc8806e1a77936346d8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">el_table的this.$refs.MainTable.toggleRowSelection(row, true)；事件会触发selection-change</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f39e8826e016b1551d6de213736f2ad4/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">六款常用 SSH 远程连接工具</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>