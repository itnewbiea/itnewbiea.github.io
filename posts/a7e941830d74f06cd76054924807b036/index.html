<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Cilium Host Routing Mode - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Cilium Host Routing Mode" />
<meta property="og:description" content="Cilium ConfigMap cilium configmap 是配置cilium的地方：
root@node1:~# kubectl get cm -n kube-system | grep cilium cilium-config 34 7d21h root@node1:~# kubectl edit cm -n kube-system cilium-config # Please edit the object below. Lines beginning with a &#39;#&#39; will be ignored, # and an empty file will abort the edit. If an error occurs while saving this file will be # reopened with the relevant failures. # apiVersion: v1 data: agent-health-port: &#34;9879&#34; auto-direct-node-routes: &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a7e941830d74f06cd76054924807b036/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-26T11:39:25+08:00" />
<meta property="article:modified_time" content="2023-07-26T11:39:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Cilium Host Routing Mode</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Cilium_ConfigMap_1"></a>Cilium ConfigMap</h3> 
<p>cilium configmap 是配置cilium的地方：</p> 
<pre><code class="prism language-shell">root@node1:~<span class="token comment"># kubectl get cm -n kube-system | grep cilium</span>
cilium-config                        <span class="token number">34</span>     7d21h
root@node1:~<span class="token comment"># kubectl edit cm -n kube-system cilium-config</span>
<span class="token comment"># Please edit the object below. Lines beginning with a '#' will be ignored,</span>
<span class="token comment"># and an empty file will abort the edit. If an error occurs while saving this file will be</span>
<span class="token comment"># reopened with the relevant failures.</span>
<span class="token comment">#</span>
apiVersion: v1
data:
  agent-health-port: <span class="token string">"9879"</span>
  auto-direct-node-routes: <span class="token string">"False"</span>
  bpf-ct-global-any-max: <span class="token string">"262144"</span>
  bpf-ct-global-tcp-max: <span class="token string">"524288"</span>
  bpf-map-dynamic-size-ratio: <span class="token string">"0.0025"</span>
  cgroup-root: /run/cilium/cgroupv2
  clean-cilium-bpf-state: <span class="token string">"false"</span>
  clean-cilium-state: <span class="token string">"false"</span>
  cluster-name: default
  custom-cni-conf: <span class="token string">"false"</span>
  debug: <span class="token string">"True"</span>
  disable-cnp-status-updates: <span class="token string">"True"</span>
  enable-bpf-clock-probe: <span class="token string">"True"</span>
  enable-bpf-masquerade: <span class="token string">"True"</span>
  enable-host-legacy-routing: <span class="token string">"False"</span>
  enable-ip-masq-agent: <span class="token string">"False"</span>
  enable-ipv4: <span class="token string">"True"</span>
  enable-ipv4-masquerade: <span class="token string">"True"</span>
  enable-ipv6: <span class="token string">"False"</span>
  enable-ipv6-masquerade: <span class="token string">"True"</span>
  enable-remote-node-identity: <span class="token string">"True"</span>
  enable-well-known-identities: <span class="token string">"False"</span>
  etcd-config: <span class="token operator">|</span>-
    ---
    endpoints:
      - https://192.168.64.8:2379
      - https://192.168.64.9:2379
      - https://192.168.64.10:2379

    <span class="token comment"># In case you want to use TLS in etcd, uncomment the 'ca-file' line</span>
    <span class="token comment"># and create a kubernetes secret by following the tutorial in</span>
    <span class="token comment"># https://cilium.link/etcd-config</span>
    ca-file: <span class="token string">"/etc/cilium/certs/ca_cert.crt"</span>

    <span class="token comment"># In case you want client to server authentication, uncomment the following</span>
    <span class="token comment"># lines and create a kubernetes secret by following the tutorial in</span>
    <span class="token comment"># https://cilium.link/etcd-config</span>
    key-file: <span class="token string">"/etc/cilium/certs/key.pem"</span>
    cert-file: <span class="token string">"/etc/cilium/certs/cert.crt"</span>
  identity-allocation-mode: kvstore
  ipam: kubernetes
  kube-proxy-replacement: probe
  kvstore: etcd
  kvstore-opt: <span class="token string">'{"etcd.config": "/var/lib/etcd-config/etcd.config"}'</span>
  monitor-aggregation: medium
  monitor-aggregation-flags: all
  operator-api-serve-addr: <span class="token number">127.0</span>.0.1:9234
  preallocate-bpf-maps: <span class="token string">"False"</span>
  sidecar-istio-proxy-image: cilium/istio_proxy
  tunnel: vxlan
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: <span class="token operator">|</span>
      <span class="token punctuation">{<!-- --></span><span class="token string">"apiVersion"</span><span class="token builtin class-name">:</span><span class="token string">"v1"</span>,<span class="token string">"data"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"agent-health-port"</span><span class="token builtin class-name">:</span><span class="token string">"9879"</span>,<span class="token string">"auto-direct-node-routes"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"bpf-ct-global-any-max"</span><span class="token builtin class-name">:</span><span class="token string">"262144"</span>,<span class="token string">"bpf-ct-global-tcp-max"</span><span class="token builtin class-name">:</span><span class="token string">"524288"</span>,<span class="token string">"bpf-map-dynamic-size-ratio"</span><span class="token builtin class-name">:</span><span class="token string">"0.0025"</span>,<span class="token string">"cgroup-root"</span><span class="token builtin class-name">:</span><span class="token string">"/run/cilium/cgroupv2"</span>,<span class="token string">"clean-cilium-bpf-state"</span><span class="token builtin class-name">:</span><span class="token string">"false"</span>,<span class="token string">"clean-cilium-state"</span><span class="token builtin class-name">:</span><span class="token string">"false"</span>,<span class="token string">"cluster-name"</span><span class="token builtin class-name">:</span><span class="token string">"default"</span>,<span class="token string">"custom-cni-conf"</span><span class="token builtin class-name">:</span><span class="token string">"false"</span>,<span class="token string">"debug"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"disable-cnp-status-updates"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-bpf-clock-probe"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-bpf-masquerade"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"enable-host-legacy-routing"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-ip-masq-agent"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"enable-ipv4"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-ipv4-masquerade"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-ipv6"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"enable-ipv6-masquerade"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-remote-node-identity"</span><span class="token builtin class-name">:</span><span class="token string">"True"</span>,<span class="token string">"enable-well-known-identities"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"etcd-config"</span><span class="token builtin class-name">:</span><span class="token string">"---<span class="token entity" title="\n">\n</span>endpoints:<span class="token entity" title="\n">\n</span>  - https://192.168.64.8:2379<span class="token entity" title="\n">\n</span>  - https://192.168.64.9:2379<span class="token entity" title="\n">\n</span>  - https://192.168.64.10:2379<span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span># In case you want to use TLS in etcd, uncomment the 'ca-file' line<span class="token entity" title="\n">\n</span># and create a kubernetes secret by following the tutorial in<span class="token entity" title="\n">\n</span># https://cilium.link/etcd-config<span class="token entity" title="\n">\n</span>ca-file: <span class="token entity" title='\"'>\"</span>/etc/cilium/certs/ca_cert.crt<span class="token entity" title='\"'>\"</span><span class="token entity" title="\n">\n</span><span class="token entity" title="\n">\n</span># In case you want client to server authentication, uncomment the following<span class="token entity" title="\n">\n</span># lines and create a kubernetes secret by following the tutorial in<span class="token entity" title="\n">\n</span># https://cilium.link/etcd-config<span class="token entity" title="\n">\n</span>key-file: <span class="token entity" title='\"'>\"</span>/etc/cilium/certs/key.pem<span class="token entity" title='\"'>\"</span><span class="token entity" title="\n">\n</span>cert-file: <span class="token entity" title='\"'>\"</span>/etc/cilium/certs/cert.crt<span class="token entity" title='\"'>\"</span>"</span>,<span class="token string">"identity-allocation-mode"</span><span class="token builtin class-name">:</span><span class="token string">"kvstore"</span>,<span class="token string">"ipam"</span><span class="token builtin class-name">:</span><span class="token string">"kubernetes"</span>,<span class="token string">"kube-proxy-replacement"</span><span class="token builtin class-name">:</span><span class="token string">"probe"</span>,<span class="token string">"kvstore"</span><span class="token builtin class-name">:</span><span class="token string">"etcd"</span>,<span class="token string">"kvstore-opt"</span><span class="token builtin class-name">:</span><span class="token string">"{<!-- --><span class="token entity" title='\"'>\"</span>etcd.config<span class="token entity" title='\"'>\"</span>: <span class="token entity" title='\"'>\"</span>/var/lib/etcd-config/etcd.config<span class="token entity" title='\"'>\"</span>}"</span>,<span class="token string">"monitor-aggregation"</span><span class="token builtin class-name">:</span><span class="token string">"medium"</span>,<span class="token string">"monitor-aggregation-flags"</span><span class="token builtin class-name">:</span><span class="token string">"all"</span>,<span class="token string">"operator-api-serve-addr"</span><span class="token builtin class-name">:</span><span class="token string">"127.0.0.1:9234"</span>,<span class="token string">"preallocate-bpf-maps"</span><span class="token builtin class-name">:</span><span class="token string">"False"</span>,<span class="token string">"sidecar-istio-proxy-image"</span><span class="token builtin class-name">:</span><span class="token string">"cilium/istio_proxy"</span>,<span class="token string">"tunnel"</span><span class="token builtin class-name">:</span><span class="token string">"vxlan"</span><span class="token punctuation">}</span>,<span class="token string">"kind"</span><span class="token builtin class-name">:</span><span class="token string">"ConfigMap"</span>,<span class="token string">"metadata"</span>:<span class="token punctuation">{<!-- --></span><span class="token string">"annotations"</span>:<span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>,<span class="token string">"name"</span><span class="token builtin class-name">:</span><span class="token string">"cilium-config"</span>,<span class="token string">"namespace"</span><span class="token builtin class-name">:</span><span class="token string">"kube-system"</span><span class="token punctuation">}</span><span class="token punctuation">}</span>
  creationTimestamp: <span class="token string">"2023-07-08T12:42:52Z"</span>
  name: cilium-config
  namespace: kube-system
  resourceVersion: <span class="token string">"168401"</span>
  uid: 0fbe4759-a8c4-457b-a06f-5fc6231272b9
</code></pre> 
<p>具体每个字段的意思可参考：<a href="https://huweicai.com/cilium-config/" rel="nofollow">Cilium 配置详解</a></p> 
<p>如果有需要修改的修改保存退出后需要重启cilium-agent生效：</p> 
<pre><code class="prism language-shell">root@node1:~<span class="token comment"># kubectl rollout restart ds/cilium -n kube-system</span>
</code></pre> 
<p>重启后进入任意一个cilium-agent容器中：</p> 
<pre><code class="prism language-shell">root@node1:/home/cilium<span class="token comment"># cilium status</span>
KVStore:                 Ok   etcd: <span class="token number">3</span>/3 connected, lease-ID<span class="token operator">=</span>797e89450e0683a2, lock lease-ID<span class="token operator">=</span>797e89450e0b2b6a, has-quorum<span class="token operator">=</span>true: https://192.168.64.10:2379 - <span class="token number">3.5</span>.4<span class="token punctuation">;</span> https://192.168.64.8:2379 - <span class="token number">3.5</span>.4 <span class="token punctuation">(</span>Leader<span class="token punctuation">)</span><span class="token punctuation">;</span> https://192.168.64.9:2379 - <span class="token number">3.5</span>.4
Kubernetes:              Ok   <span class="token number">1.24</span> <span class="token punctuation">(</span>v1.24.6<span class="token punctuation">)</span> <span class="token punctuation">[</span>linux/amd64<span class="token punctuation">]</span>
Kubernetes APIs:         <span class="token punctuation">[</span><span class="token string">"cilium/v2::CiliumClusterwideNetworkPolicy"</span>, <span class="token string">"cilium/v2::CiliumNetworkPolicy"</span>, <span class="token string">"core/v1::Namespace"</span>, <span class="token string">"core/v1::Node"</span>, <span class="token string">"core/v1::Pods"</span>, <span class="token string">"core/v1::Service"</span>, <span class="token string">"discovery/v1::EndpointSlice"</span>, <span class="token string">"networking.k8s.io/v1::NetworkPolicy"</span><span class="token punctuation">]</span>
KubeProxyReplacement:    Probe   <span class="token punctuation">[</span>enp0s2 <span class="token number">192.168</span>.64.8<span class="token punctuation">]</span>
Host firewall:           Disabled
CNI Chaining:            none
Cilium:                  Ok   <span class="token number">1.12</span>.1 <span class="token punctuation">(</span>v1.12.1-4c9a630<span class="token punctuation">)</span>
NodeMonitor:             Disabled
Cilium health daemon:    Ok   
IPAM:                    IPv4: <span class="token number">5</span>/254 allocated from <span class="token number">10.233</span>.64.0/24, 
BandwidthManager:        Disabled
Host Routing:            BPF <span class="token comment"># 注意这里</span>
Masquerading:            BPF   <span class="token punctuation">[</span>enp0s2<span class="token punctuation">]</span>   <span class="token number">10.233</span>.64.0/24 <span class="token punctuation">[</span>IPv4: Enabled, IPv6: Disabled<span class="token punctuation">]</span> <span class="token comment"># 表明只是在enp0s2接口上进行NAT的接口。[两种模式，一种是BPF。一种是在Legacy Mode下使用IPtables]</span>
Controller Status:       <span class="token number">43</span>/43 healthy
Proxy Status:            OK, <span class="token function">ip</span> <span class="token number">10.233</span>.64.93, <span class="token number">0</span> redirects active on ports <span class="token number">10000</span>-20000
Global Identity Range:   min <span class="token number">256</span>, max <span class="token number">65535</span>
Hubble:                  Disabled
Encryption:              Disabled
Cluster health:          <span class="token number">3</span>/3 reachable   <span class="token punctuation">(</span><span class="token number">2023</span>-07-16T10:01:41Z<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="Host_Routing_106"></a>Host Routing</h3> 
<p>即使 Cilium 使用 eBPF 执行网络路由，默认情况下网络数据包仍会遍历节点的常规网络堆栈的某些部分。 这样可以确保所有数据包仍然遍历所有 iptables hooks，以防你依赖它们。然而，这样会增加大量开销。<br> 在 Cilium 1.9 中引入了基于 eBPF 的​​ ​host-routing​​，来完全绕过 iptables 和上层主机堆栈，与常规 veth 设备操作相比，实现了更快的网络命名空间切换。 如果您的内核支持，此选项会自动启用。<br> <img src="https://images2.imgbox.com/62/1e/te2v2IWV_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="eBPF_hostRouting_Legacy_110"></a>eBPF host-Routing Legacy</h4> 
<p>Legacy是传统的eBPF host-Routing 模式，左侧是标准的网络流向过程，可以发现iptables 会对包进行处理。</p> 
<h4><a id="eBPF_hostRouting_BPF_112"></a>eBPF host-Routing BPF</h4> 
<p>右侧是启用ebpf host-routing, 直接跨过iptables，必要条件：</p> 
<pre><code> Kernel &gt;= 5.10
 Direct-routing or tunneling
 eBPF-based 替换kube-proxy
 eBPF-based masquerading
</code></pre> 
<p>此模式由于引入了两个helper()函数加持了eBPF host-Routing，那么在DataPath上就会有不同的地方：</p> 
<ul><li><strong>bpf_redirect_peer()</strong><br> 简单描述：<br> 同节点的Pod通信时候，Pod-A从自己的veth pair 的lxc出来以后直接送到Pod-B的veth pair的eth0网卡，而绕过Pod-B的veth pair的lxc网卡。</li></ul> 
<p><img src="https://images2.imgbox.com/1d/5b/EjBk5I9w_o.png" alt="在这里插入图片描述"></p> 
<ul><li><strong>bpf_redirect_neigh()</strong><br> 简单描述：<br> 不同节点Pod通信的时候，Pod-A从自己的veth pair的lxc出来以后被自己的ingress方向上的from-container处理（vxlan封装或是native routing）然后tail call到vxlan处理然后再走bpf_redirect_neigh()到物理网卡，然后到对端Pod-B所在的Node节点，此时再进行反向处理即可。这里有一点注意：就是from-container —&gt; vxlan 封装 —&gt; bpf_redirect_neigh () 处理。</li></ul> 
<p><img src="https://images2.imgbox.com/fe/db/NmqbBAau_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dcf795af98da6034d84258c4f5b1dc1a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">el-table表格自动滚动</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e8127aa9c7e3994d24e77be7f7b504ca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">（分子优化BenchMark）Sample Efficiency Matters: A Benchmark for Practical Molecular Optimization（PMO）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>