<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>å¤§æ•°æ®æ¯•è®¾åˆ†äº« flinkå¤§æ•°æ®æ·˜å®ç”¨æˆ·è¡Œä¸ºæ•°æ®å®æ—¶åˆ†æä¸å¯è§†åŒ– - ITå­¦ä¹ è€…åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="å¤§æ•°æ®æ¯•è®¾åˆ†äº« flinkå¤§æ•°æ®æ·˜å®ç”¨æˆ·è¡Œä¸ºæ•°æ®å®æ—¶åˆ†æä¸å¯è§†åŒ–" />
<meta property="og:description" content="æ–‡ç« ç›®å½• 0 å‰è¨€1ã€ç¯å¢ƒå‡†å¤‡1.1 flink ä¸‹è½½ç›¸å…³ jar åŒ…1.2 ç”Ÿæˆ kafka æ•°æ®1.3 å¼€å‘å‰çš„ä¸‰ä¸ªå° tip 2ã€flink-sql å®¢æˆ·ç«¯ç¼–å†™è¿è¡Œ sql2.1 åˆ›å»º kafka æ•°æ®æºè¡¨2.2 æŒ‡æ ‡ç»Ÿè®¡ï¼šæ¯å°æ—¶æˆäº¤é‡2.2.1 åˆ›å»º es ç»“æœè¡¨ï¼Œ å­˜æ”¾æ¯å°æ—¶çš„æˆäº¤é‡2.2.2 æ‰§è¡Œ sql ï¼Œç»Ÿè®¡æ¯å°æ—¶çš„æˆäº¤é‡ 2.3 æŒ‡æ ‡ç»Ÿè®¡ï¼šæ¯10åˆ†é’Ÿç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°2.3.1 åˆ›å»º es ç»“æœè¡¨ï¼Œå­˜æ”¾æ¯10åˆ†é’Ÿç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°2.3.2 åˆ›å»ºè§†å›¾2.3.3 æ‰§è¡Œ sql ï¼Œç»Ÿè®¡æ¯10åˆ†é’Ÿçš„ç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•° 2.4 æŒ‡æ ‡ç»Ÿè®¡ï¼šå•†å“ç±»ç›®é”€é‡æ’è¡Œ2.4.1 åˆ›å»ºå•†å“ç±»ç›®ç»´è¡¨2.4.1 åˆ›å»º es ç»“æœè¡¨ï¼Œå­˜æ”¾å•†å“ç±»ç›®æ’è¡Œè¡¨2.4.2 åˆ›å»ºè§†å›¾2.4.3 æ‰§è¡Œ sql , ç»Ÿè®¡å•†å“ç±»ç›®é”€é‡æ’è¡Œ 3ã€æœ€ç»ˆæ•ˆæœä¸ä½“éªŒå¿ƒå¾—3.1 æœ€ç»ˆæ•ˆæœ3.2 ä½“éªŒå¿ƒå¾—3.2.1 æ‰§è¡Œ3.2.2 å­˜å‚¨ 4 æœ€å 0 å‰è¨€ ğŸ”¥ è¿™ä¸¤å¹´å¼€å§‹æ¯•ä¸šè®¾è®¡å’Œæ¯•ä¸šç­”è¾©çš„è¦æ±‚å’Œéš¾åº¦ä¸æ–­æå‡ï¼Œä¼ ç»Ÿçš„æ¯•è®¾é¢˜ç›®ç¼ºå°‘åˆ›æ–°å’Œäº®ç‚¹ï¼Œå¾€å¾€è¾¾ä¸åˆ°æ¯•ä¸šç­”è¾©çš„è¦æ±‚ï¼Œè¿™ä¸¤å¹´ä¸æ–­æœ‰å­¦å¼Ÿå­¦å¦¹å‘Šè¯‰å­¦é•¿è‡ªå·±åšçš„é¡¹ç›®ç³»ç»Ÿè¾¾ä¸åˆ°è€å¸ˆçš„è¦æ±‚ã€‚
ä¸ºäº†å¤§å®¶èƒ½å¤Ÿé¡ºåˆ©ä»¥åŠæœ€å°‘çš„ç²¾åŠ›é€šè¿‡æ¯•è®¾ï¼Œå­¦é•¿åˆ†äº«ä¼˜è´¨æ¯•ä¸šè®¾è®¡é¡¹ç›®ï¼Œä»Šå¤©è¦åˆ†äº«çš„æ˜¯
ğŸš© flinkå¤§æ•°æ®æ·˜å®ç”¨æˆ·è¡Œä¸ºæ•°æ®å®æ—¶åˆ†æä¸å¯è§†åŒ–
ğŸ¥‡å­¦é•¿è¿™é‡Œç»™ä¸€ä¸ªé¢˜ç›®ç»¼åˆè¯„åˆ†(æ¯é¡¹æ»¡åˆ†5åˆ†)
éš¾åº¦ç³»æ•°ï¼š3åˆ†å·¥ä½œé‡ï¼š3åˆ†åˆ›æ–°ç‚¹ï¼š4åˆ† 1ã€ç¯å¢ƒå‡†å¤‡ 1.1 flink ä¸‹è½½ç›¸å…³ jar åŒ… flink-sql è¿æ¥å¤–éƒ¨ç³»ç»Ÿæ—¶ï¼Œéœ€è¦ä¾èµ–ç‰¹å®šçš„ jar åŒ…ï¼Œæ‰€ä»¥éœ€è¦äº‹å…ˆæŠŠè¿™äº› jar åŒ…å‡†å¤‡å¥½ã€‚è¯´æ˜ä¸ä¸‹è½½å…¥å£" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/66b13fd5a5d2753ecb7d0225e14498d0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T13:16:29+08:00" />
<meta property="article:modified_time" content="2024-01-04T13:16:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ITå­¦ä¹ è€…åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ITå­¦ä¹ è€…åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">å¤§æ•°æ®æ¯•è®¾åˆ†äº« flinkå¤§æ•°æ®æ·˜å®ç”¨æˆ·è¡Œä¸ºæ•°æ®å®æ—¶åˆ†æä¸å¯è§†åŒ–</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>æ–‡ç« ç›®å½•</h4> 
 <ul><li><a href="#0__4" rel="nofollow">0 å‰è¨€</a></li><li><a href="#1_23" rel="nofollow">1ã€ç¯å¢ƒå‡†å¤‡</a></li><li><ul><li><a href="#11_flink__jar__25" rel="nofollow">1.1 flink ä¸‹è½½ç›¸å…³ jar åŒ…</a></li><li><a href="#12__kafka__40" rel="nofollow">1.2 ç”Ÿæˆ kafka æ•°æ®</a></li><li><a href="#13___tip_60" rel="nofollow">1.3 å¼€å‘å‰çš„ä¸‰ä¸ªå° tip</a></li></ul> 
  </li><li><a href="#2flinksql__sql_72" rel="nofollow">2ã€flink-sql å®¢æˆ·ç«¯ç¼–å†™è¿è¡Œ sql</a></li><li><ul><li><a href="#21__kafka__79" rel="nofollow">2.1 åˆ›å»º kafka æ•°æ®æºè¡¨</a></li><li><a href="#22__103" rel="nofollow">2.2 æŒ‡æ ‡ç»Ÿè®¡ï¼šæ¯å°æ—¶æˆäº¤é‡</a></li><li><ul><li><a href="#221__es___105" rel="nofollow">2.2.1 åˆ›å»º es ç»“æœè¡¨ï¼Œ å­˜æ”¾æ¯å°æ—¶çš„æˆäº¤é‡</a></li><li><a href="#222__sql__123" rel="nofollow">2.2.2 æ‰§è¡Œ sql ï¼Œç»Ÿè®¡æ¯å°æ—¶çš„æˆäº¤é‡</a></li></ul> 
   </li><li><a href="#23_10_133" rel="nofollow">2.3 æŒ‡æ ‡ç»Ÿè®¡ï¼šæ¯10åˆ†é’Ÿç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°</a></li><li><ul><li><a href="#231__es_10_135" rel="nofollow">2.3.1 åˆ›å»º es ç»“æœè¡¨ï¼Œå­˜æ”¾æ¯10åˆ†é’Ÿç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°</a></li><li><a href="#232__152" rel="nofollow">2.3.2 åˆ›å»ºè§†å›¾</a></li><li><a href="#233__sql_10_163" rel="nofollow">2.3.3 æ‰§è¡Œ sql ï¼Œç»Ÿè®¡æ¯10åˆ†é’Ÿçš„ç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°</a></li></ul> 
   </li><li><a href="#24__172" rel="nofollow">2.4 æŒ‡æ ‡ç»Ÿè®¡ï¼šå•†å“ç±»ç›®é”€é‡æ’è¡Œ</a></li><li><ul><li><a href="#241__174" rel="nofollow">2.4.1 åˆ›å»ºå•†å“ç±»ç›®ç»´è¡¨</a></li><li><a href="#241__es__194" rel="nofollow">2.4.1 åˆ›å»º es ç»“æœè¡¨ï¼Œå­˜æ”¾å•†å“ç±»ç›®æ’è¡Œè¡¨</a></li><li><a href="#242___211" rel="nofollow">2.4.2 åˆ›å»ºè§†å›¾</a></li><li><a href="#243__sql___220" rel="nofollow">2.4.3 æ‰§è¡Œ sql , ç»Ÿè®¡å•†å“ç±»ç›®é”€é‡æ’è¡Œ</a></li></ul> 
  </li></ul> 
  </li><li><a href="#3_230" rel="nofollow">3ã€æœ€ç»ˆæ•ˆæœä¸ä½“éªŒå¿ƒå¾—</a></li><li><ul><li><a href="#31__232" rel="nofollow">3.1 æœ€ç»ˆæ•ˆæœ</a></li><li><a href="#32__238" rel="nofollow">3.2 ä½“éªŒå¿ƒå¾—</a></li><li><ul><li><a href="#321__240" rel="nofollow">3.2.1 æ‰§è¡Œ</a></li><li><a href="#322__251" rel="nofollow">3.2.2 å­˜å‚¨</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4__257" rel="nofollow">4 æœ€å</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="0__4"></a>0 å‰è¨€</h2> 
<p>ğŸ”¥ è¿™ä¸¤å¹´å¼€å§‹æ¯•ä¸šè®¾è®¡å’Œæ¯•ä¸šç­”è¾©çš„è¦æ±‚å’Œéš¾åº¦ä¸æ–­æå‡ï¼Œä¼ ç»Ÿçš„æ¯•è®¾é¢˜ç›®ç¼ºå°‘åˆ›æ–°å’Œäº®ç‚¹ï¼Œå¾€å¾€è¾¾ä¸åˆ°æ¯•ä¸šç­”è¾©çš„è¦æ±‚ï¼Œè¿™ä¸¤å¹´ä¸æ–­æœ‰å­¦å¼Ÿå­¦å¦¹å‘Šè¯‰å­¦é•¿è‡ªå·±åšçš„é¡¹ç›®ç³»ç»Ÿè¾¾ä¸åˆ°è€å¸ˆçš„è¦æ±‚ã€‚</p> 
<p>ä¸ºäº†å¤§å®¶èƒ½å¤Ÿé¡ºåˆ©ä»¥åŠæœ€å°‘çš„ç²¾åŠ›é€šè¿‡æ¯•è®¾ï¼Œå­¦é•¿åˆ†äº«ä¼˜è´¨æ¯•ä¸šè®¾è®¡é¡¹ç›®ï¼Œä»Šå¤©è¦åˆ†äº«çš„æ˜¯</p> 
<p>ğŸš© <strong>flinkå¤§æ•°æ®æ·˜å®ç”¨æˆ·è¡Œä¸ºæ•°æ®å®æ—¶åˆ†æä¸å¯è§†åŒ–</strong></p> 
<p>ğŸ¥‡å­¦é•¿è¿™é‡Œç»™ä¸€ä¸ªé¢˜ç›®ç»¼åˆè¯„åˆ†(æ¯é¡¹æ»¡åˆ†5åˆ†)</p> 
<ul><li>éš¾åº¦ç³»æ•°ï¼š3åˆ†</li><li>å·¥ä½œé‡ï¼š3åˆ†</li><li>åˆ›æ–°ç‚¹ï¼š4åˆ†</li></ul> 
<h2><a id="1_23"></a>1ã€ç¯å¢ƒå‡†å¤‡</h2> 
<h3><a id="11_flink__jar__25"></a>1.1 flink ä¸‹è½½ç›¸å…³ jar åŒ…</h3> 
<p>flink-sql è¿æ¥å¤–éƒ¨ç³»ç»Ÿæ—¶ï¼Œéœ€è¦ä¾èµ–ç‰¹å®šçš„ jar åŒ…ï¼Œæ‰€ä»¥éœ€è¦äº‹å…ˆæŠŠè¿™äº› jar åŒ…å‡†å¤‡å¥½ã€‚<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.10/dev/table/connect.html" rel="nofollow">è¯´æ˜ä¸ä¸‹è½½å…¥å£</a></p> 
<p>æœ¬é¡¹ç›®ä½¿ç”¨åˆ°äº†ä»¥ä¸‹çš„ jar åŒ… ï¼Œä¸‹è½½åç›´æ¥æ”¾åœ¨äº† flink/lib é‡Œé¢ã€‚</p> 
<blockquote> 
 <p>éœ€è¦æ³¨æ„çš„æ˜¯ flink-sql æ‰§è¡Œæ—¶ï¼Œæ˜¯è½¬åŒ–ä¸º flink-job æäº¤åˆ°é›†ç¾¤æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ flink é›†ç¾¤çš„æ¯ä¸€å°æœºå™¨éƒ½è¦æ·»åŠ ä»¥ä¸‹çš„ jar åŒ…ã€‚</p> 
</blockquote> 
<table><thead><tr><th>å¤–éƒ¨</th><th>ç‰ˆæœ¬</th><th>jar</th></tr></thead><tbody><tr><td>kafka</td><td>4.1</td><td>flink-sql-connector-kafka_2.11-1.10.2.jar <br>flink-json-1.10.2-sql-jar.jar</td></tr><tr><td>elasticsearch</td><td>7.6</td><td>flink-sql-connector-elasticsearch7_2.11-1.10.2.jar</td></tr><tr><td>mysql</td><td>5.7</td><td>flink-jdbc_2.11-1.10.2.jar <br>mysql-connector-java-8.0.11.jar</td></tr></tbody></table> 
<h3><a id="12__kafka__40"></a>1.2 ç”Ÿæˆ kafka æ•°æ®</h3> 
<p>ç”¨æˆ·è¡Œä¸ºæ•°æ®æ¥æºï¼š <a href="https://tianchi.aliyun.com/dataset/dataDetail?dataId=649" rel="nofollow">é˜¿é‡Œäº‘å¤©æ± å…¬å¼€æ•°æ®é›†</a></p> 
<blockquote> 
 <p>ç½‘ç›˜ï¼šhttps://pan.baidu.com/s/1wDVQpRV7giIlLJJgRZAInQ æå–ç ï¼šgja5</p> 
</blockquote> 
<p>å•†å“ç±»ç›®çº¬åº¦æ•°æ®æ¥æº: <a href="https://github.com/TurboWay/pybigdata/blob/master/flink-sql/category.sql">category.sql</a></p> 
<p>æ•°æ®ç”Ÿæˆå™¨ï¼š<a href="https://github.com/TurboWay/pybigdata/blob/master/flink-sql/datagen.py">datagen.py</a></p> 
<blockquote> 
 <p>æœ‰äº†æ•°æ®æ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ python è¯»å–æ–‡ä»¶æ•°æ®ï¼Œç„¶åå¹¶å‘å†™å…¥åˆ° kafkaã€‚</p> 
</blockquote> 
<blockquote> 
 <p>ä¿®æ”¹ç”Ÿæˆå™¨ä¸­çš„ kafka åœ°å€é…ç½®ï¼Œç„¶åè¿è¡Œ ä»¥ä¸‹å‘½ä»¤ï¼Œå¼€å§‹ä¸æ–­å¾€ kafka å†™æ•°æ®</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token comment"># 5000 å¹¶å‘</span>
<span class="token function">nohup</span> python3 datagen.py <span class="token number">5000</span> <span class="token operator">&amp;</span>                  
</code></pre> 
<h3><a id="13___tip_60"></a>1.3 å¼€å‘å‰çš„ä¸‰ä¸ªå° tip</h3> 
<ul><li> <p>ç”Ÿæˆå™¨å¾€ kafka å†™æ•°æ®ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºä¸»é¢˜ï¼Œæ— éœ€äº‹å…ˆåˆ›å»º</p> </li><li> <p>flink å¾€ elasticsearch å†™æ•°æ®ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºç´¢å¼•ï¼Œæ— éœ€äº‹å…ˆåˆ›å»º</p> </li><li> <p>Kibana ä½¿ç”¨ç´¢å¼•æ¨¡å¼ä» Elasticsearch ç´¢å¼•ä¸­æ£€ç´¢æ•°æ®ï¼Œä»¥å®ç°è¯¸å¦‚å¯è§†åŒ–ç­‰åŠŸèƒ½ã€‚</p> </li></ul> 
<blockquote> 
 <p>ä½¿ç”¨çš„é€»è¾‘ä¸ºï¼šåˆ›å»ºç´¢å¼•æ¨¡å¼ ã€‹Discover (å‘ç°) æŸ¥çœ‹ç´¢å¼•æ•°æ® ã€‹visualizeï¼ˆå¯è§†åŒ–ï¼‰åˆ›å»ºå¯è§†åŒ–å›¾è¡¨ã€‹dashboardsï¼ˆä»ªè¡¨æ¿ï¼‰åˆ›å»ºå¤§å±ï¼Œå³æ±‡æ€»å¤šä¸ªå¯è§†åŒ–çš„å›¾è¡¨</p> 
</blockquote> 
<h2><a id="2flinksql__sql_72"></a>2ã€flink-sql å®¢æˆ·ç«¯ç¼–å†™è¿è¡Œ sql</h2> 
<pre><code class="prism language-shell"><span class="token comment"># è¿›å…¥ flink-sql å®¢æˆ·ç«¯, éœ€è¦æŒ‡å®šåˆšåˆšä¸‹è½½çš„ jar åŒ…ç›®å½•</span>
./bin/sql-client.sh embedded <span class="token parameter variable">-l</span> lib
</code></pre> 
<h3><a id="21__kafka__79"></a>2.1 åˆ›å»º kafka æ•°æ®æºè¡¨</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- åˆ›å»º kafka è¡¨, è¯»å– kafka æ•°æ®</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> user_behavior <span class="token punctuation">(</span>
    user_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    item_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    category_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    behavior STRING<span class="token punctuation">,</span>
    ts <span class="token keyword">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    proctime <span class="token keyword">as</span> PROCTIME<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    WATERMARK <span class="token keyword">FOR</span> ts <span class="token keyword">as</span> ts <span class="token operator">-</span> <span class="token keyword">INTERVAL</span> <span class="token string">'5'</span> <span class="token keyword">SECOND</span>  
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector.type'</span> <span class="token operator">=</span> <span class="token string">'kafka'</span><span class="token punctuation">,</span> 
    <span class="token string">'connector.version'</span> <span class="token operator">=</span> <span class="token string">'universal'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.topic'</span> <span class="token operator">=</span> <span class="token string">'user_behavior'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.startup-mode'</span> <span class="token operator">=</span> <span class="token string">'earliest-offset'</span><span class="token punctuation">,</span> 
    <span class="token string">'connector.properties.zookeeper.connect'</span> <span class="token operator">=</span> <span class="token string">'172.16.122.24:2181'</span><span class="token punctuation">,</span> 
    <span class="token string">'connector.properties.bootstrap.servers'</span> <span class="token operator">=</span> <span class="token string">'172.16.122.17:9092'</span><span class="token punctuation">,</span> 
    <span class="token string">'format.type'</span> <span class="token operator">=</span> <span class="token string">'json'</span>  
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> user_behavior<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="22__103"></a>2.2 æŒ‡æ ‡ç»Ÿè®¡ï¼šæ¯å°æ—¶æˆäº¤é‡</h3> 
<h4><a id="221__es___105"></a>2.2.1 åˆ›å»º es ç»“æœè¡¨ï¼Œ å­˜æ”¾æ¯å°æ—¶çš„æˆäº¤é‡</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> buy_cnt_per_hour <span class="token punctuation">(</span>
    hour_of_day <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    buy_cnt <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector.type'</span> <span class="token operator">=</span> <span class="token string">'elasticsearch'</span><span class="token punctuation">,</span> 
    <span class="token string">'connector.version'</span> <span class="token operator">=</span> <span class="token string">'7'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.hosts'</span> <span class="token operator">=</span> <span class="token string">'http://172.16.122.13:9200'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.index'</span> <span class="token operator">=</span> <span class="token string">'buy_cnt_per_hour'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.document-type'</span> <span class="token operator">=</span> <span class="token string">'user_behavior'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.bulk-flush.max-actions'</span> <span class="token operator">=</span> <span class="token string">'1'</span><span class="token punctuation">,</span>
    <span class="token string">'update-mode'</span> <span class="token operator">=</span> <span class="token string">'append'</span><span class="token punctuation">,</span>
    <span class="token string">'format.type'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="222__sql__123"></a>2.2.2 æ‰§è¡Œ sql ï¼Œç»Ÿè®¡æ¯å°æ—¶çš„æˆäº¤é‡</h4> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> buy_cnt_per_hour
<span class="token keyword">SELECT</span> <span class="token keyword">HOUR</span><span class="token punctuation">(</span>TUMBLE_START<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>
<span class="token keyword">FROM</span> user_behavior
<span class="token keyword">WHERE</span> behavior <span class="token operator">=</span> <span class="token string">'buy'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> TUMBLE<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token keyword">INTERVAL</span> <span class="token string">'1'</span> <span class="token keyword">HOUR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="23_10_133"></a>2.3 æŒ‡æ ‡ç»Ÿè®¡ï¼šæ¯10åˆ†é’Ÿç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°</h3> 
<h4><a id="231__es_10_135"></a>2.3.1 åˆ›å»º es ç»“æœè¡¨ï¼Œå­˜æ”¾æ¯10åˆ†é’Ÿç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> cumulative_uv <span class="token punctuation">(</span>
    time_str STRING<span class="token punctuation">,</span>
    uv <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector.type'</span> <span class="token operator">=</span> <span class="token string">'elasticsearch'</span><span class="token punctuation">,</span> 
    <span class="token string">'connector.version'</span> <span class="token operator">=</span> <span class="token string">'7'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.hosts'</span> <span class="token operator">=</span> <span class="token string">'http://172.16.122.13:9200'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.index'</span> <span class="token operator">=</span> <span class="token string">'cumulative_uv'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.document-type'</span> <span class="token operator">=</span> <span class="token string">'user_behavior'</span><span class="token punctuation">,</span>    
    <span class="token string">'update-mode'</span> <span class="token operator">=</span> <span class="token string">'upsert'</span><span class="token punctuation">,</span>
    <span class="token string">'format.type'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="232__152"></a>2.3.2 åˆ›å»ºè§†å›¾</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> uv_per_10min <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span>
  <span class="token function">MAX</span><span class="token punctuation">(</span>SUBSTR<span class="token punctuation">(</span>DATE_FORMAT<span class="token punctuation">(</span>ts<span class="token punctuation">,</span> <span class="token string">'HH:mm'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'0'</span><span class="token punctuation">)</span> <span class="token keyword">OVER</span> w <span class="token keyword">AS</span> time_str<span class="token punctuation">,</span>
  <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token keyword">DISTINCT</span> user_id<span class="token punctuation">)</span> <span class="token keyword">OVER</span> w <span class="token keyword">AS</span> uv
<span class="token keyword">FROM</span> user_behavior
WINDOW w <span class="token keyword">AS</span> <span class="token punctuation">(</span><span class="token keyword">ORDER</span> <span class="token keyword">BY</span> proctime <span class="token keyword">ROWS</span> <span class="token operator">BETWEEN</span> <span class="token keyword">UNBOUNDED</span> <span class="token keyword">PRECEDING</span> <span class="token operator">AND</span> <span class="token keyword">CURRENT</span> <span class="token keyword">ROW</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="233__sql_10_163"></a>2.3.3 æ‰§è¡Œ sql ï¼Œç»Ÿè®¡æ¯10åˆ†é’Ÿçš„ç´¯è®¡ç‹¬ç«‹ç”¨æˆ·æ•°</h4> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> cumulative_uv
<span class="token keyword">SELECT</span> time_str<span class="token punctuation">,</span> <span class="token function">MAX</span><span class="token punctuation">(</span>uv<span class="token punctuation">)</span>
<span class="token keyword">FROM</span> uv_per_10min
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> time_str<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="24__172"></a>2.4 æŒ‡æ ‡ç»Ÿè®¡ï¼šå•†å“ç±»ç›®é”€é‡æ’è¡Œ</h3> 
<h4><a id="241__174"></a>2.4.1 åˆ›å»ºå•†å“ç±»ç›®ç»´è¡¨</h4> 
<p>å…ˆåœ¨ mysql åˆ›å»ºä¸€å¼ å•†å“ç±»ç›®çš„ç»´è¡¨ï¼Œç„¶åé…ç½® flink è¯»å– mysqlã€‚</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> category_dim <span class="token punctuation">(</span>
    sub_category_id <span class="token keyword">BIGINT</span><span class="token punctuation">,</span>
    parent_category_name STRING
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector.type'</span> <span class="token operator">=</span> <span class="token string">'jdbc'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.url'</span> <span class="token operator">=</span> <span class="token string">'jdbc:mysql://172.16.122.25:3306/flink'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.table'</span> <span class="token operator">=</span> <span class="token string">'category'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.driver'</span> <span class="token operator">=</span> <span class="token string">'com.mysql.jdbc.Driver'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.username'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.password'</span> <span class="token operator">=</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.lookup.cache.max-rows'</span> <span class="token operator">=</span> <span class="token string">'5000'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.lookup.cache.ttl'</span> <span class="token operator">=</span> <span class="token string">'10min'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="241__es__194"></a>2.4.1 åˆ›å»º es ç»“æœè¡¨ï¼Œå­˜æ”¾å•†å“ç±»ç›®æ’è¡Œè¡¨</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> top_category  <span class="token punctuation">(</span>
    category_name  STRING<span class="token punctuation">,</span>
    buy_cnt  <span class="token keyword">BIGINT</span>
<span class="token punctuation">)</span> <span class="token keyword">WITH</span> <span class="token punctuation">(</span>
    <span class="token string">'connector.type'</span> <span class="token operator">=</span> <span class="token string">'elasticsearch'</span><span class="token punctuation">,</span> 
    <span class="token string">'connector.version'</span> <span class="token operator">=</span> <span class="token string">'7'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.hosts'</span> <span class="token operator">=</span> <span class="token string">'http://172.16.122.13:9200'</span><span class="token punctuation">,</span>  
    <span class="token string">'connector.index'</span> <span class="token operator">=</span> <span class="token string">'top_category'</span><span class="token punctuation">,</span>
    <span class="token string">'connector.document-type'</span> <span class="token operator">=</span> <span class="token string">'user_behavior'</span><span class="token punctuation">,</span>
    <span class="token string">'update-mode'</span> <span class="token operator">=</span> <span class="token string">'upsert'</span><span class="token punctuation">,</span>
    <span class="token string">'format.type'</span> <span class="token operator">=</span> <span class="token string">'json'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="242___211"></a>2.4.2 åˆ›å»ºè§†å›¾</h4> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">VIEW</span> rich_user_behavior <span class="token keyword">AS</span>
<span class="token keyword">SELECT</span> U<span class="token punctuation">.</span>user_id<span class="token punctuation">,</span> U<span class="token punctuation">.</span>item_id<span class="token punctuation">,</span> U<span class="token punctuation">.</span>behavior<span class="token punctuation">,</span> C<span class="token punctuation">.</span>parent_category_name <span class="token keyword">as</span> category_name
<span class="token keyword">FROM</span> user_behavior <span class="token keyword">AS</span> U <span class="token keyword">LEFT</span> <span class="token keyword">JOIN</span> category_dim <span class="token keyword">FOR</span> SYSTEM_TIME <span class="token keyword">AS</span> <span class="token keyword">OF</span> U<span class="token punctuation">.</span>proctime <span class="token keyword">AS</span> C
<span class="token keyword">ON</span> U<span class="token punctuation">.</span>category_id <span class="token operator">=</span> C<span class="token punctuation">.</span>sub_category_id<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="243__sql___220"></a>2.4.3 æ‰§è¡Œ sql , ç»Ÿè®¡å•†å“ç±»ç›®é”€é‡æ’è¡Œ</h4> 
<pre><code class="prism language-sql"><span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> top_category
<span class="token keyword">SELECT</span> category_name<span class="token punctuation">,</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> buy_cnt
<span class="token keyword">FROM</span> rich_user_behavior
<span class="token keyword">WHERE</span> behavior <span class="token operator">=</span> <span class="token string">'buy'</span>
<span class="token keyword">GROUP</span> <span class="token keyword">BY</span> category_name<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="3_230"></a>3ã€æœ€ç»ˆæ•ˆæœä¸ä½“éªŒå¿ƒå¾—</h2> 
<h3><a id="31__232"></a>3.1 æœ€ç»ˆæ•ˆæœ</h3> 
<p>æ•´ä¸ªå¼€å‘è¿‡ç¨‹ï¼Œåªç”¨åˆ°äº† flink-sql ï¼Œæ— éœ€å†™ java æˆ–è€…å…¶å®ƒä»£ç ï¼Œå°±å®Œæˆäº†è¿™æ ·ä¸€ä¸ªå®æ—¶æŠ¥è¡¨ã€‚</p> 
<p><img src="https://images2.imgbox.com/2c/df/vTkSEQvm_o.png" alt="image-20201201175438743"></p> 
<h3><a id="32__238"></a>3.2 ä½“éªŒå¿ƒå¾—</h3> 
<h4><a id="321__240"></a>3.2.1 æ‰§è¡Œ</h4> 
<ul><li> <p>flink-sql çš„ ddl è¯­å¥ä¸ä¼šè§¦å‘ flink-job , åŒæ—¶åˆ›å»ºçš„è¡¨ã€è§†å›¾ä»…åœ¨ä¼šè¯çº§åˆ«æœ‰æ•ˆã€‚</p> </li><li> <p>å¯¹äºè¿æ¥è¡¨çš„ insertã€select ç­‰æ“ä½œï¼Œåˆ™ä¼šè§¦å‘ç›¸åº”çš„æµ jobï¼Œ å¹¶è‡ªåŠ¨æäº¤åˆ° flink é›†ç¾¤ï¼Œæ— é™åœ°è¿è¡Œä¸‹å»ï¼Œç›´åˆ°ä¸»åŠ¨å–æ¶ˆæˆ–è€… job æŠ¥é”™ã€‚</p> </li><li> <p>flink-sql å®¢æˆ·ç«¯å…³é—­åï¼Œå¯¹äºå·²ç»æäº¤åˆ° flink é›†ç¾¤çš„ job ä¸ä¼šæœ‰ä»»ä½•å½±å“ã€‚</p> </li></ul> 
<blockquote> 
 <p>æœ¬æ¬¡å¼€å‘ï¼Œæ‰§è¡Œäº† 3 ä¸ª insert , å› æ­¤æ‰“å¼€ flink é›†ç¾¤é¢æ¿ï¼Œå¯ä»¥çœ‹åˆ°æœ‰ 3 ä¸ªæ— é™çš„æµ job ã€‚å³ä½¿ kafka æ•°æ®å…¨éƒ¨å†™å…¥å®Œæ¯•ï¼Œå…³é—­ flink-sql å®¢æˆ·ç«¯ï¼Œè¿™ä¸ª 3 ä¸ª job éƒ½ä¸ä¼šåœæ­¢ã€‚<br> <img src="https://images2.imgbox.com/ae/ef/IRZnXmY6_o.png" alt="image-20201201175523916"></p> 
</blockquote> 
<h4><a id="322__251"></a>3.2.2 å­˜å‚¨</h4> 
<ul><li> <p>flnik æœ¬èº«ä¸å­˜å‚¨ä¸šåŠ¡æ•°æ®ï¼Œåªä½œä¸ºæµæ‰¹ä¸€ä½“çš„å¼•æ“å­˜åœ¨ï¼Œæ‰€ä»¥ä¸»è¦çš„ç”¨æ³•ä¸ºè¯»å–å¤–éƒ¨ç³»ç»Ÿçš„æ•°æ®ï¼Œå¤„ç†åï¼Œå†å†™åˆ°å¤–éƒ¨ç³»ç»Ÿã€‚</p> </li><li> <p>flink æœ¬èº«çš„å…ƒæ•°æ®ï¼ŒåŒ…æ‹¬è¡¨ã€å‡½æ•°ç­‰ï¼Œé»˜è®¤æƒ…å†µä¸‹åªæ˜¯å­˜æ”¾åœ¨å†…å­˜é‡Œé¢ï¼Œæ‰€ä»¥ä»…ä¼šè¯çº§åˆ«æœ‰æ•ˆã€‚ä½†æ˜¯ï¼Œä¼¼ä¹å¯ä»¥å­˜å‚¨åˆ° Hive Metastore ä¸­ï¼Œå…³äºè¿™ä¸€ç‚¹å°±ç•™åˆ°ä»¥åå†å®è·µã€‚</p> </li></ul> 
<h2><a id="4__257"></a>4 æœ€å</h2>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e5809721a152b044dd97496ba12b647d/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">ã€è®¾è®¡æ¨¡å¼ã€‘è§‚å¯Ÿè€…æ¨¡å¼</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80063a7ff7d3f6b82f0f7ce51f704599/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">Keraså¸¸ç”¨çš„æ¿€æ´»å‡½æ•°è¯¦ç»†ä»‹ç»</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ITå­¦ä¹ è€…åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>