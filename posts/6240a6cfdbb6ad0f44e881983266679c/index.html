<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>QGIS3.18.3&#43;QT 5.11.2&#43;VS2019二次开发（4）图层管理器右键和可移动部件 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="QGIS3.18.3&#43;QT 5.11.2&#43;VS2019二次开发（4）图层管理器右键和可移动部件" />
<meta property="og:description" content="QGIS3.18.3&#43;QT 5.11.2&#43;VS2019二次开发（4）图层管理器右键和可移动部件 文章目录 QGIS3.18.3&#43;QT 5.11.2&#43;VS2019二次开发（4）图层管理器右键和可移动部件前言一、和上节相比添加的新东西二、项目代码1.MyQGIS01.h2.MyQGIS01.cpp3.MyQGIS01LayerTreeViewMenuProvider.h4.MyQGIS01LayerTreeViewMenuProvider.cpp5.mian.cpp 总结 前言 上文讲解了窗口布局和图层管理器的实现，说明了图层管理器右键菜单实现方法，这节讲解具体实现；同时图层管理器和上节QGIS中的3（Layers）仍有不同，为实现基本一致，这节将提出几个新概念-QDockWidget、QToolButton、QHBoxLayout。
提示：以下是本篇文章正文内容，下面案例可供参考
一、和上节相比添加的新东西 图层管理器右键所需 继承自qgslayertreeviewmenuprovider这个类的MyQGIS01Layertreeviewmenuprovider类(MyQGIS01layertreeviewmenuprovider.h、MyQGIS01layertreeviewmenuprovider.cpp)
QDockWidget、QToolButton、QHBoxLayout 二、项目代码 1.MyQGIS01.h 代码如下（示例）：
#include &lt;QtWidgets/QMainWindow&gt; #include &#34;ui_MyQGIS01.h&#34; //自己引入的库 #include &lt;qmenu.h&gt; //QT菜单类 #include &lt;qaction.h&gt; //QT行为类 #include &#34;qgsrasterlayer.h&#34; //QGIS栅格图层 #include &#34;qgsvectorlayer.h&#34; //QGIS矢量图层 #include &#34;qgsmaplayer.h&#34; //QGIS图层 #include &#34;qgsmapcanvas.h&#34; //QGIS画布 #include &#34;qgslayertreeview.h&#34; //QGIS图层管理器 #include &#34;qgslayertreemapcanvasbridge.h&#34; //连接画布和图层管理器 class MyQGIS01 : public QMainWindow { Q_OBJECT public: MyQGIS01(QWidget *parent = Q_NULLPTR); //构造函数 Ui::MyQGIS01Class ui; //定义ui界面 //! 保持单一实例 static MyQGIS01* instance() { return sm_instance; } private: //单一实例 static MyQGIS01* sm_instance; //菜单栏 QMenu* fileMenu; //定义文件菜单（一级菜单） QAction* openRasterFileAction; //定义打开栅格文件菜单行为（二级菜单） QAction* openVectorFileAction; //定义打开矢量文件菜单行为（二级菜单） QAction* removeFileAction; //定义移除文件菜单行为（二级菜单） //地图画布 QgsMapCanvas* mapCanvas; QList&lt;QgsMapLayer*&gt; layers; //存储加载的图层 //图层管理器 QgsLayerTreeView* layerTreeView; QgsLayerTreeMapCanvasBridge* layerTreeCanvasBridge; public slots: //槽函数 void on_openRasterFileAction_triggered(); void on_openVectorFileAction_triggered(); void on_removeFileAction_triggered(); void slot_autoSelectAddedLayer(QList&lt;QgsMapLayer*&gt; layers); public: void initLayerTreeView(); //初始化图层管理器函数 void addDockWidget(Qt::DockWidgetArea area, QDockWidget* dockwidget); //添加可悬浮窗口初始位置 }; 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6240a6cfdbb6ad0f44e881983266679c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-06-19T11:30:52+08:00" />
<meta property="article:modified_time" content="2021-06-19T11:30:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">QGIS3.18.3&#43;QT 5.11.2&#43;VS2019二次开发（4）图层管理器右键和可移动部件</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="QGIS3183QT_5112VS20194_0"></a>QGIS3.18.3+QT 5.11.2+VS2019二次开发（4）图层管理器右键和可移动部件</h2> 
<hr color="#000000" size='1"'> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#QGIS3183QT_5112VS20194_0" rel="nofollow">QGIS3.18.3+QT 5.11.2+VS2019二次开发（4）图层管理器右键和可移动部件</a></li><li><a href="#_11" rel="nofollow">前言</a></li><li><a href="#_19" rel="nofollow">一、和上节相比添加的新东西</a></li><li><a href="#_31" rel="nofollow">二、项目代码</a></li><li><ul><li><a href="#1MyQGIS01h_32" rel="nofollow">1.MyQGIS01.h</a></li><li><a href="#2MyQGIS01cpp_100" rel="nofollow">2.MyQGIS01.cpp</a></li><li><a href="#3MyQGIS01LayerTreeViewMenuProviderh_377" rel="nofollow">3.MyQGIS01LayerTreeViewMenuProvider.h</a></li><li><a href="#4MyQGIS01LayerTreeViewMenuProvidercpp_440" rel="nofollow">4.MyQGIS01LayerTreeViewMenuProvider.cpp</a></li><li><a href="#5miancpp_586" rel="nofollow">5.mian.cpp</a></li></ul> 
  </li><li><a href="#_607" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_11"></a>前言</h2> 
<p><font color="#999AAA">上文讲解了窗口布局和图层管理器的实现，说明了图层管理器右键菜单实现方法，这节讲解具体实现；同时图层管理器和上节QGIS中的3（Layers）仍有不同，为实现基本一致，这节将提出几个新概念-QDockWidget、QToolButton、QHBoxLayout。</font></p> 
<hr color="#000000" size='1"'> 
<p><font color="#999AAA">提示：以下是本篇文章正文内容，下面案例可供参考</font></p> 
<h2><a id="_19"></a>一、和上节相比添加的新东西</h2> 
<ul><li>图层管理器右键所需</li></ul> 
<p>继承自qgslayertreeviewmenuprovider这个类的MyQGIS01Layertreeviewmenuprovider类(MyQGIS01layertreeviewmenuprovider.h、MyQGIS01layertreeviewmenuprovider.cpp)</p> 
<ul><li><a href="https://blog.csdn.net/chenlong12580/article/details/9051847">QDockWidget</a>、<a href="https://blog.csdn.net/wangxiaobei2017/article/details/77824938">QToolButton</a>、<a href="https://blog.csdn.net/weixin_42837024/article/details/82114258">QHBoxLayout</a></li></ul> 
<h2><a id="_31"></a>二、项目代码</h2> 
<h3><a id="1MyQGIS01h_32"></a>1.MyQGIS01.h</h3> 
<p><font color="#999AAA">代码如下（示例）：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QtWidgets/QMainWindow&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"ui_MyQGIS01.h"</span></span>

<span class="token comment">//自己引入的库</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qmenu.h&gt;</span>                  </span><span class="token comment">//QT菜单类</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qaction.h&gt;</span>                </span><span class="token comment">//QT行为类</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgsrasterlayer.h"</span>         </span><span class="token comment">//QGIS栅格图层</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgsvectorlayer.h"</span>         </span><span class="token comment">//QGIS矢量图层</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgsmaplayer.h"</span>            </span><span class="token comment">//QGIS图层</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgsmapcanvas.h"</span>           </span><span class="token comment">//QGIS画布</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgslayertreeview.h"</span>              </span><span class="token comment">//QGIS图层管理器</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgslayertreemapcanvasbridge.h"</span>   </span><span class="token comment">//连接画布和图层管理器</span>


class MyQGIS01 <span class="token punctuation">:</span> public QMainWindow
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT

public<span class="token punctuation">:</span>
    <span class="token function">MyQGIS01</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent <span class="token operator">=</span> Q_NULLPTR<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">//构造函数</span>
    Ui<span class="token punctuation">:</span><span class="token punctuation">:</span>MyQGIS01Class ui<span class="token punctuation">;</span>                       <span class="token comment">//定义ui界面</span>

    <span class="token comment">//! 保持单一实例</span>
    <span class="token keyword">static</span> MyQGIS01<span class="token operator">*</span> <span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> sm_instance<span class="token punctuation">;</span> <span class="token punctuation">}</span>

private<span class="token punctuation">:</span>
    <span class="token comment">//单一实例</span>
    <span class="token keyword">static</span> MyQGIS01<span class="token operator">*</span> sm_instance<span class="token punctuation">;</span>

    <span class="token comment">//菜单栏</span>
    QMenu<span class="token operator">*</span> fileMenu<span class="token punctuation">;</span>                         <span class="token comment">//定义文件菜单（一级菜单）</span>
    QAction<span class="token operator">*</span> openRasterFileAction<span class="token punctuation">;</span>           <span class="token comment">//定义打开栅格文件菜单行为（二级菜单）</span>
    QAction<span class="token operator">*</span> openVectorFileAction<span class="token punctuation">;</span>           <span class="token comment">//定义打开矢量文件菜单行为（二级菜单）</span>
    QAction<span class="token operator">*</span> removeFileAction<span class="token punctuation">;</span>               <span class="token comment">//定义移除文件菜单行为（二级菜单）</span>

    <span class="token comment">//地图画布</span>
    QgsMapCanvas<span class="token operator">*</span> mapCanvas<span class="token punctuation">;</span>
    QList<span class="token operator">&lt;</span>QgsMapLayer<span class="token operator">*</span><span class="token operator">&gt;</span> layers<span class="token punctuation">;</span>              <span class="token comment">//存储加载的图层</span>

    <span class="token comment">//图层管理器</span>
    QgsLayerTreeView<span class="token operator">*</span> layerTreeView<span class="token punctuation">;</span>
    QgsLayerTreeMapCanvasBridge<span class="token operator">*</span> layerTreeCanvasBridge<span class="token punctuation">;</span>

public slots<span class="token punctuation">:</span>                                <span class="token comment">//槽函数</span>
    <span class="token keyword">void</span> <span class="token function">on_openRasterFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">void</span> <span class="token function">on_openVectorFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">on_removeFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">slot_autoSelectAddedLayer</span><span class="token punctuation">(</span>QList<span class="token operator">&lt;</span>QgsMapLayer<span class="token operator">*</span><span class="token operator">&gt;</span> layers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    

public<span class="token punctuation">:</span>
    <span class="token keyword">void</span> <span class="token function">initLayerTreeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//初始化图层管理器函数</span>
    <span class="token keyword">void</span> <span class="token function">addDockWidget</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>DockWidgetArea area<span class="token punctuation">,</span> QDockWidget<span class="token operator">*</span> dockwidget<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加可悬浮窗口初始位置</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<h3><a id="2MyQGIS01cpp_100"></a>2.MyQGIS01.cpp</h3> 
<p><font color="#999AAA">代码如下（示例）：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MyQGIS01.h"</span></span>

<span class="token comment">//自己引入的库</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qmenubar.h&gt;</span>                      </span><span class="token comment">//QT菜单栏库，用来存放菜单</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qfiledialog.h&gt;</span>                   </span><span class="token comment">//QT文件目录库，用来打开文件选择窗口</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qmessagebox.h"</span>                   </span><span class="token comment">//QT信息盒子，用来显示操作提示</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgslayertreemodel.h"</span>            </span><span class="token comment">//使用给定层树构建新的树模型,一般与QgsLayerTreeView 一起使用</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgridlayout.h"</span>                  </span><span class="token comment">//栅格布局管理器</span>
 
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qtoolbutton.h"</span>                  </span><span class="token comment">//工具按钮,和普通工具相比可以带图标</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qdockwidget.h"</span>                  </span><span class="token comment">//可悬浮窗口</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MyQGIS01Layertreeviewmenuprovider.h"</span> </span><span class="token comment">//图层管理器右键菜单类</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qgslayertreeregistrybridge.h"</span>        </span><span class="token comment">//创建与层树根同步给定项目的实例,收听地图层注册表中的更新，并在层树中进行更改。</span>

MyQGIS01<span class="token operator">*</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span>sm_instance <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>  <span class="token comment">//初始化实例</span>

<span class="token comment">//构造函数</span>
MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">MyQGIS01</span><span class="token punctuation">(</span>QWidget <span class="token operator">*</span>parent<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token function">QMainWindow</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    ui<span class="token punctuation">.</span><span class="token function">setupUi</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">//不定义ui界面，栅格布局后会出现问题</span>

    this<span class="token operator">-&gt;</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">,</span> <span class="token number">800</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//设置MyQGIS01类窗口大小</span>

    <span class="token comment">// 菜单栏初始化</span>
    fileMenu <span class="token operator">=</span>this<span class="token operator">-&gt;</span><span class="token function">menuBar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addMenu</span><span class="token punctuation">(</span><span class="token string">"File"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//菜单栏添加文件菜单</span>

    openRasterFileAction <span class="token operator">=</span> new <span class="token function">QAction</span><span class="token punctuation">(</span><span class="token string">"Open raster"</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//设置文件菜单栏下二级菜单Open菜单</span>
    this<span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span>openRasterFileAction<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">triggered</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">on_openRasterFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//关联Open和槽函数（点击产生结果）</span>
    fileMenu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>openRasterFileAction<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">//一级菜单文件添加二级菜单Open</span>

    openVectorFileAction <span class="token operator">=</span> new <span class="token function">QAction</span><span class="token punctuation">(</span><span class="token string">"Open vector"</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    this<span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span>openVectorFileAction<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">triggered</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">on_openVectorFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    fileMenu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>openVectorFileAction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    removeFileAction <span class="token operator">=</span> new <span class="token function">QAction</span><span class="token punctuation">(</span><span class="token string">"Remove file"</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    this<span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span>removeFileAction<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">triggered</span><span class="token punctuation">(</span>bool<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">on_removeFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
    fileMenu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>removeFileAction<span class="token punctuation">)</span><span class="token punctuation">;</span>            

    <span class="token comment">//----------------------</span>
    
    <span class="token comment">//初始化地图画布</span>
    mapCanvas <span class="token operator">=</span> new <span class="token function">QgsMapCanvas</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//this-&gt;setCentralWidget(mapCanvas);                  //将地图画布放置我们创建的主窗口中心</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setCanvasColor</span><span class="token punctuation">(</span><span class="token function">QColor</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//设置地图画布为白色</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setVisible</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">enableAntiAliasing</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//----------------------</span>

    <span class="token comment">//初始化图层管理器</span>
    layerTreeView <span class="token operator">=</span> new <span class="token function">QgsLayerTreeView</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">initLayerTreeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//----------------------</span>

    <span class="token comment">//栅格布局</span>
    QWidget<span class="token operator">*</span> centralWidget <span class="token operator">=</span> this<span class="token operator">-&gt;</span><span class="token function">centralWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QGridLayout<span class="token operator">*</span> centralLayout <span class="token operator">=</span> new <span class="token function">QGridLayout</span><span class="token punctuation">(</span>centralWidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//centralLayout-&gt;addWidget(layerTreeView, 0, 0, 2, 1);                 //图层管理器位置,添加可悬浮窗口后需要注释此句</span>
    centralLayout<span class="token operator">-&gt;</span><span class="token function">addWidget</span><span class="token punctuation">(</span>mapCanvas<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">//画布位置 后面四个参数：初始行列 占位行类</span>
    
    
<span class="token punctuation">}</span>


<span class="token comment">//-------------------------------------------------------------------------------------------------------------------------------</span>

<span class="token comment">//槽函数：打开并显示栅格数据</span>
<span class="token keyword">void</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">on_openRasterFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//步骤1：打开文件选择对话框</span>
    QString fileName <span class="token operator">=</span> QFileDialog<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getOpenFileName</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Open raster file"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"remote sensing image(*.tif *.tiff);;image(*.jpg *.jpeg *.png *.bmp)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//如果文件未选择则返回</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    QStringList temp <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QString basename <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取栅格数据名称</span>

    <span class="token comment">//步骤2：创建QgsRasterLayer类</span>
    QgsRasterLayer<span class="token operator">*</span> rasterLayer <span class="token operator">=</span> new <span class="token function">QgsRasterLayer</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> basename<span class="token punctuation">,</span> <span class="token string">"gdal"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//如果不是geotiff文件，则提示错误</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rasterLayer<span class="token operator">-&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QMessageBox<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">critical</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"layer is invalid: \n"</span><span class="token punctuation">)</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//步骤3：添加栅格数据</span>
    QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addMapLayer</span><span class="token punctuation">(</span>rasterLayer<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//注册</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setExtent</span><span class="token punctuation">(</span>rasterLayer<span class="token operator">-&gt;</span><span class="token function">extent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//将画布范围设置为栅格图层范围</span>
    layers<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>rasterLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>                      <span class="token comment">//将栅格图层追加到链表中</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setLayers</span><span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token comment">//将图层画到画布上</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setVisible</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">freeze</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//更新画布</span>
<span class="token punctuation">}</span>

<span class="token comment">//-------------------------------------------------------------------------------------------------------------------------------</span>

<span class="token comment">//槽函数：打开并显示矢量数据</span>
<span class="token keyword">void</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">on_openVectorFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QString fileName <span class="token operator">=</span> QFileDialog<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getOpenFileName</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Open shape file"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">,</span> <span class="token string">"*.shp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>fileName<span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//如果文件未选择则返回</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    QStringList temp <span class="token operator">=</span> fileName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QString basename <span class="token operator">=</span> temp<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>temp<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QgsVectorLayer<span class="token operator">*</span> vecLayer <span class="token operator">=</span> new <span class="token function">QgsVectorLayer</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> basename<span class="token punctuation">,</span> <span class="token string">"ogr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vecLayer<span class="token operator">-&gt;</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QMessageBox<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">critical</span><span class="token punctuation">(</span>this<span class="token punctuation">,</span> <span class="token string">"error"</span><span class="token punctuation">,</span> <span class="token function">QString</span><span class="token punctuation">(</span><span class="token string">"layer is invalid: \n"</span><span class="token punctuation">)</span> <span class="token operator">+</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//QGIS 3注册方式</span>
    QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">addMapLayer</span><span class="token punctuation">(</span>vecLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setExtent</span><span class="token punctuation">(</span>vecLayer<span class="token operator">-&gt;</span><span class="token function">extent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    layers<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>vecLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setLayers</span><span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setVisible</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">freeze</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//-------------------------------------------------------------------------------------------------------------------------------</span>

<span class="token comment">//槽函数：移除图层</span>
<span class="token keyword">void</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">on_removeFileAction_triggered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    layers<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                 <span class="token comment">//从链表中清除所有图层</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setLayers</span><span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">//将图层画到画布上</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">setVisible</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">freeze</span><span class="token punctuation">(</span>false<span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">//更新画布</span>
    
    layerTreeView<span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                         <span class="token comment">//这里直接关闭图层管理器 ，需优化               </span>
<span class="token punctuation">}</span>

<span class="token comment">//-------------------------------------------------------------------------------------------------------------------------------</span>

<span class="token comment">//初始化图层管理器</span>
<span class="token keyword">void</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initLayerTreeView</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QgsLayerTreeModel<span class="token operator">*</span> model <span class="token operator">=</span> new <span class="token function">QgsLayerTreeModel</span><span class="token punctuation">(</span>QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">layerTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>QgsLayerTreeModel<span class="token punctuation">:</span><span class="token punctuation">:</span>AllowNodeRename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>QgsLayerTreeModel<span class="token punctuation">:</span><span class="token punctuation">:</span>AllowNodeReorder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>QgsLayerTreeModel<span class="token punctuation">:</span><span class="token punctuation">:</span>AllowNodeChangeVisibility<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setFlag</span><span class="token punctuation">(</span>QgsLayerTreeModel<span class="token punctuation">:</span><span class="token punctuation">:</span>ShowLegendAsTree<span class="token punctuation">)</span><span class="token punctuation">;</span>
    model<span class="token operator">-&gt;</span><span class="token function">setAutoCollapseLegendNodes</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    layerTreeView<span class="token operator">-&gt;</span><span class="token function">setModel</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
    layerTreeView<span class="token operator">-&gt;</span><span class="token function">setFixedWidth</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//------------------------------------------------</span>
    <span class="token comment">// 新增</span>
    
    <span class="token comment">//右键菜单</span>
    layerTreeView<span class="token operator">-&gt;</span><span class="token function">setMenuProvider</span><span class="token punctuation">(</span>new <span class="token function">MyQGIS01LayerTreeViewMenuProvider</span><span class="token punctuation">(</span>layerTreeView<span class="token punctuation">,</span> mapCanvas<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//connect(QgsProject::instance()-&gt;layerTreeRegistryBridge(), SIGNAL(addedLayersToLayerTree(const QList&lt;QgsMapLayer*&gt;)), this, </span>
    <span class="token comment">//    SLOT(slot_autoSelectAddedLayer(const QList&lt;QgsMapLayer*&gt;)));</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">layerTreeRegistryBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>QgsLayerTreeRegistryBridge<span class="token punctuation">:</span><span class="token punctuation">:</span>addedLayersToLayerTree<span class="token punctuation">,</span> this<span class="token punctuation">,</span>
        <span class="token operator">&amp;</span>MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span>slot_autoSelectAddedLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置这个路径是为了获取图标文件</span>
    QString iconDir <span class="token operator">=</span> <span class="token string">"E:\\GIS development\\QGIS\\gisTest2\\image\\"</span><span class="token punctuation">;</span> <span class="token comment">//注意包含中文路径图标会不显示，这里的图标可以去原QGIS软件中去找</span>

    <span class="token comment">// add group tool button</span>
    QToolButton<span class="token operator">*</span> btnAddGroup <span class="token operator">=</span> new <span class="token function">QToolButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setAutoRaise</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"layer-group-add.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setFixedSize</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setToolTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Add Group"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>btnAddGroup<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerTreeView<span class="token operator">-&gt;</span><span class="token function">defaultActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">addGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// expand / collapse tool buttons</span>
    QToolButton<span class="token operator">*</span> btnExpandAll <span class="token operator">=</span> new <span class="token function">QToolButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnExpandAll<span class="token operator">-&gt;</span><span class="token function">setAutoRaise</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnExpandAll<span class="token operator">-&gt;</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"mActionExpandTree.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setFixedSize</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnExpandAll<span class="token operator">-&gt;</span><span class="token function">setToolTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Expand All"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>btnExpandAll<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerTreeView<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">expandAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QToolButton<span class="token operator">*</span> btnCollapseAll <span class="token operator">=</span> new <span class="token function">QToolButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnCollapseAll<span class="token operator">-&gt;</span><span class="token function">setAutoRaise</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnCollapseAll<span class="token operator">-&gt;</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"mActionCollapseTree.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setFixedSize</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnCollapseAll<span class="token operator">-&gt;</span><span class="token function">setToolTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Collapse All"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>btnCollapseAll<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerTreeView<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">collapseAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// remove item button</span>
    QToolButton<span class="token operator">*</span> btnRemoveItem <span class="token operator">=</span> new <span class="token function">QToolButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// btnRemoveItem-&gt;setDefaultAction( this-&gt;m_actionRemoveLayer );</span>
    btnRemoveItem<span class="token operator">-&gt;</span><span class="token function">setAutoRaise</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnRemoveItem<span class="token operator">-&gt;</span><span class="token function">setIcon</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"layer-remove.png"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnAddGroup<span class="token operator">-&gt;</span><span class="token function">setFixedSize</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    btnRemoveItem<span class="token operator">-&gt;</span><span class="token function">setToolTip</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Remove"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>btnRemoveItem<span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">clicked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> layerTreeView<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 按钮布局</span>
    QHBoxLayout<span class="token operator">*</span> toolbarLayout <span class="token operator">=</span> new <span class="token function">QHBoxLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolbarLayout<span class="token operator">-&gt;</span><span class="token function">setContentsMargins</span><span class="token punctuation">(</span><span class="token function">QMargins</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolbarLayout<span class="token operator">-&gt;</span><span class="token function">addWidget</span><span class="token punctuation">(</span>btnAddGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolbarLayout<span class="token operator">-&gt;</span><span class="token function">addWidget</span><span class="token punctuation">(</span>btnCollapseAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolbarLayout<span class="token operator">-&gt;</span><span class="token function">addWidget</span><span class="token punctuation">(</span>btnExpandAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolbarLayout<span class="token operator">-&gt;</span><span class="token function">addWidget</span><span class="token punctuation">(</span>btnRemoveItem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    toolbarLayout<span class="token operator">-&gt;</span><span class="token function">addStretch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    QVBoxLayout<span class="token operator">*</span> vboxLayout <span class="token operator">=</span> new <span class="token function">QVBoxLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vboxLayout<span class="token operator">-&gt;</span><span class="token function">setMargin</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vboxLayout<span class="token operator">-&gt;</span><span class="token function">addLayout</span><span class="token punctuation">(</span>toolbarLayout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vboxLayout<span class="token operator">-&gt;</span><span class="token function">addWidget</span><span class="token punctuation">(</span>layerTreeView<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 装进dock widget中</span>
    QDockWidget<span class="token operator">*</span> m_layerTreeDock <span class="token operator">=</span> new <span class="token function">QDockWidget</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"Layers"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_layerTreeDock<span class="token operator">-&gt;</span><span class="token function">setObjectName</span><span class="token punctuation">(</span><span class="token string">"Layers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_layerTreeDock<span class="token operator">-&gt;</span><span class="token function">setAllowedAreas</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>LeftDockWidgetArea <span class="token operator">|</span> Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>RightDockWidgetArea<span class="token punctuation">)</span><span class="token punctuation">;</span>

    QWidget<span class="token operator">*</span> w <span class="token operator">=</span> new <span class="token function">QWidget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    w<span class="token operator">-&gt;</span><span class="token function">setLayout</span><span class="token punctuation">(</span>vboxLayout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    m_layerTreeDock<span class="token operator">-&gt;</span><span class="token function">setWidget</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addDockWidget</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>LeftDockWidgetArea<span class="token punctuation">,</span> m_layerTreeDock<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//初始位置</span>

    <span class="token comment">// 新增</span>
    <span class="token comment">//------------------------------------------------</span>
   
    <span class="token comment">// 连接地图画布和图层管理器</span>
    layerTreeCanvasBridge <span class="token operator">=</span> new <span class="token function">QgsLayerTreeMapCanvasBridge</span><span class="token punctuation">(</span>QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">layerTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mapCanvas<span class="token punctuation">,</span> this<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">writeProject</span><span class="token punctuation">(</span>QDomDocument<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        layerTreeCanvasBridge<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">writeProject</span><span class="token punctuation">(</span>QDomDocument<span class="token operator">&amp;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">connect</span><span class="token punctuation">(</span>QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SIGNAL</span><span class="token punctuation">(</span><span class="token function">readProject</span><span class="token punctuation">(</span>QDomDocument<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        layerTreeCanvasBridge<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">readProject</span><span class="token punctuation">(</span>QDomDocument<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//*新增</span>
<span class="token keyword">void</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">slot_autoSelectAddedLayer</span><span class="token punctuation">(</span><span class="token keyword">const</span> QList<span class="token operator">&lt;</span>QgsMapLayer<span class="token operator">*</span><span class="token operator">&gt;</span> layers<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>layers<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        QgsLayerTreeLayer<span class="token operator">*</span> nodeLayer <span class="token operator">=</span> QgsProject<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">layerTreeRoot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">findLayer</span><span class="token punctuation">(</span>layers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">-&gt;</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>nodeLayer<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>

        QModelIndex index <span class="token operator">=</span> layerTreeView<span class="token operator">-&gt;</span><span class="token function">layerTreeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">node2index</span><span class="token punctuation">(</span>nodeLayer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        layerTreeView<span class="token operator">-&gt;</span><span class="token function">setCurrentIndex</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addDockWidget</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>DockWidgetArea area<span class="token punctuation">,</span> QDockWidget<span class="token operator">*</span> dockwidget<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QMainWindow<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addDockWidget</span><span class="token punctuation">(</span>area<span class="token punctuation">,</span> dockwidget<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCorner</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>TopLeftCorner<span class="token punctuation">,</span> Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>LeftDockWidgetArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCorner</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>BottomLeftCorner<span class="token punctuation">,</span> Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>LeftDockWidgetArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCorner</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>TopRightCorner<span class="token punctuation">,</span> Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>RightDockWidgetArea<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setCorner</span><span class="token punctuation">(</span>Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>BottomRightCorner<span class="token punctuation">,</span> Qt<span class="token punctuation">:</span><span class="token punctuation">:</span>RightDockWidgetArea<span class="token punctuation">)</span><span class="token punctuation">;</span>

    dockwidget<span class="token operator">-&gt;</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mapCanvas<span class="token operator">-&gt;</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//*新增</span>

<span class="token comment">//-------------------------------------------------------------------------------------------------------------------------------</span>
</code></pre> 
<h3><a id="3MyQGIS01LayerTreeViewMenuProviderh_377"></a>3.MyQGIS01LayerTreeViewMenuProvider.h</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> MYQGIS01LAYERTREEVIEWMENUPROVIDER_H</span>
<span class="token macro property">#<span class="token directive keyword">define</span> MYQGIS01LAYERTREEVIEWMENUPROVIDER_H</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QObject&gt;</span>                         </span><span class="token comment">//QT对象</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertreeview.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgsmaplayer.h&gt;</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgsmapcanvas.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qdockwidget.h&gt;</span>                   </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertree.h&gt;</span>                  </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertreeviewdefaultactions.h&gt;</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qtoolbutton.h&gt;</span>                   </span>

class QAction<span class="token punctuation">;</span>
class QgsMapCanvas<span class="token punctuation">;</span>

<span class="token keyword">struct</span> LegendLayerAction
<span class="token punctuation">{<!-- --></span>
    <span class="token function">LegendLayerAction</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> a<span class="token punctuation">,</span> QString m<span class="token punctuation">,</span> QString i<span class="token punctuation">,</span> bool all<span class="token punctuation">)</span>
        <span class="token punctuation">:</span> <span class="token function">action</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">menu</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">id</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">allLayers</span><span class="token punctuation">(</span>all<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    QAction<span class="token operator">*</span> action <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>
    QString menu<span class="token punctuation">;</span>
    QString id<span class="token punctuation">;</span>
    bool allLayers<span class="token punctuation">;</span>
    QList<span class="token operator">&lt;</span>QgsMapLayer<span class="token operator">*</span><span class="token operator">&gt;</span> layers<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//图层管理器右键菜单类</span>
class MyQGIS01LayerTreeViewMenuProvider <span class="token punctuation">:</span> public QObject<span class="token punctuation">,</span> public QgsLayerTreeViewMenuProvider
<span class="token punctuation">{<!-- --></span>
    Q_OBJECT
public<span class="token punctuation">:</span>
    <span class="token function">MyQGIS01LayerTreeViewMenuProvider</span><span class="token punctuation">(</span>QgsLayerTreeView<span class="token operator">*</span> view<span class="token punctuation">,</span> QgsMapCanvas<span class="token operator">*</span> canvas<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构造函数这样定义，直接获得图层管理器和地图画布控件，以便对它们建立联系</span>
    <span class="token operator">~</span><span class="token function">MyQGIS01LayerTreeViewMenuProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//! 重写这个方法来获取右键菜单</span>
    QMenu<span class="token operator">*</span> <span class="token function">createContextMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> override<span class="token punctuation">;</span>

    <span class="token comment">//</span>
    <span class="token keyword">void</span> <span class="token function">addLegendLayerAction</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> action<span class="token punctuation">,</span> <span class="token keyword">const</span> QString<span class="token operator">&amp;</span> menu<span class="token punctuation">,</span> QString id<span class="token punctuation">,</span>
        QgsMapLayerType type<span class="token punctuation">,</span> bool allLayers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    bool <span class="token function">removeLegendLayerAction</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> action<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">addLegendLayerActionForLayer</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> action<span class="token punctuation">,</span> QgsMapLayer<span class="token operator">*</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">removeLegendLayerActionsForLayer</span><span class="token punctuation">(</span>QgsMapLayer<span class="token operator">*</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    QList<span class="token operator">&lt;</span> LegendLayerAction <span class="token operator">&gt;</span> <span class="token function">legendLayerActions</span><span class="token punctuation">(</span>QgsMapLayerType type<span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>

protected<span class="token punctuation">:</span>

    <span class="token keyword">void</span> <span class="token function">addCustomLayerActions</span><span class="token punctuation">(</span>QMenu<span class="token operator">*</span> menu<span class="token punctuation">,</span> QgsMapLayer<span class="token operator">*</span> layer<span class="token punctuation">)</span><span class="token punctuation">;</span>

    QgsLayerTreeView<span class="token operator">*</span> m_layerTreeView <span class="token operator">=</span> nullptr<span class="token punctuation">;</span><span class="token punctuation">;</span>
    QgsMapCanvas<span class="token operator">*</span> m_mapCanvas <span class="token operator">=</span> nullptr<span class="token punctuation">;</span>

    QMap<span class="token operator">&lt;</span>QgsMapLayerType<span class="token punctuation">,</span> QList<span class="token operator">&lt;</span> LegendLayerAction<span class="token operator">&gt;&gt;</span> mLegendLayerActionMap<span class="token punctuation">;</span>


<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span> </span><span class="token comment">// MYQGIS01LAYERTREEVIEWMENUPROVIDER_H</span>
</code></pre> 
<h3><a id="4MyQGIS01LayerTreeViewMenuProvidercpp_440"></a>4.MyQGIS01LayerTreeViewMenuProvider.cpp</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MyQGIS01.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MyQGIS01Layertreeviewmenuprovider.h"</span></span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QMenu&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QModelIndex&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;QIcon&gt;</span></span>

<span class="token comment">// QGis include</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertreeviewdefaultactions.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertreenode.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertreemodel.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgslayertree.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgsrasterlayer.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgsvectorlayer.h&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"qmainwindow.h"</span></span>



<span class="token comment">// 构造函数</span>
MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">MyQGIS01LayerTreeViewMenuProvider</span><span class="token punctuation">(</span>QgsLayerTreeView<span class="token operator">*</span> view<span class="token punctuation">,</span> QgsMapCanvas<span class="token operator">*</span> canvas<span class="token punctuation">)</span>
    <span class="token punctuation">:</span> <span class="token function">m_layerTreeView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span>
    <span class="token punctuation">,</span> <span class="token function">m_mapCanvas</span><span class="token punctuation">(</span>canvas<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token comment">//析构</span>
MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">~</span><span class="token function">MyQGIS01LayerTreeViewMenuProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token comment">//重写方法获取右键菜单</span>
QMenu<span class="token operator">*</span> MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">createContextMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 设置这个路径是为了获取图标文件</span>
    QString iconDir <span class="token operator">=</span> <span class="token string">"E:\\GIS development\\QGIS\\gisTest2\\image\\"</span><span class="token punctuation">;</span>

    QMenu<span class="token operator">*</span> menu <span class="token operator">=</span> new QMenu<span class="token punctuation">;</span>
    QgsLayerTreeViewDefaultActions<span class="token operator">*</span> actions <span class="token operator">=</span> m_layerTreeView<span class="token operator">-&gt;</span><span class="token function">defaultActions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    QModelIndex idx <span class="token operator">=</span> m_layerTreeView<span class="token operator">-&gt;</span><span class="token function">currentIndex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// global menu</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>idx<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionAddGroup</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"mActionExpandTree.png"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"&amp;Expand All"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_layerTreeView<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">expandAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"mActionCollapseTree.png"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"&amp;Collapse All"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> m_layerTreeView<span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">collapseAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        menu<span class="token operator">-&gt;</span><span class="token function">addSeparator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>QgsLayerTreeNode<span class="token operator">*</span> node <span class="token operator">=</span> m_layerTreeView<span class="token operator">-&gt;</span><span class="token function">layerTreeModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">index2node</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// layer or group selected</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>QgsLayerTree<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">isGroup</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionZoomToGroup</span><span class="token punctuation">(</span>m_mapCanvas<span class="token punctuation">,</span> menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token function">QIcon</span><span class="token punctuation">(</span>iconDir <span class="token operator">+</span> <span class="token string">"layer-remove.png"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"&amp;Remove"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">removeLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionRenameGroupOrLayer</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionRenameGroupOrLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>m_layerTreeView<span class="token operator">-&gt;</span><span class="token function">selectedNodes</span><span class="token punctuation">(</span>true<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">2</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionGroupSelected</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionAddGroup</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>QgsLayerTree<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">isLayer</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            QgsMapLayer<span class="token operator">*</span> layer <span class="token operator">=</span> QgsLayerTree<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">toLayer</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">layer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionZoomToLayer</span><span class="token punctuation">(</span>m_mapCanvas<span class="token punctuation">,</span> menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//menu-&gt;addAction(actions-&gt;actionShowInOverview(menu));</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span>actions<span class="token operator">-&gt;</span><span class="token function">actionRemoveGroupOrLayer</span><span class="token punctuation">(</span>menu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"&amp;Label"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">slot_labelShowAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 如果选择的是矢量图层</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>layer<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QgsMapLayerType<span class="token punctuation">:</span><span class="token punctuation">:</span>VectorLayer<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//点矢量图层增加点样式设置菜单</span>
                QgsVectorLayer<span class="token operator">*</span> veclayer <span class="token operator">=</span> qobject_cast<span class="token operator">&lt;</span>QgsVectorLayer<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>layer<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>veclayer<span class="token operator">-&gt;</span><span class="token function">geometryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QgsWkbTypes<span class="token punctuation">:</span><span class="token punctuation">:</span>PointGeometry<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"PointStyle"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">slot_pointstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>veclayer<span class="token operator">-&gt;</span><span class="token function">geometryType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QgsWkbTypes<span class="token punctuation">:</span><span class="token punctuation">:</span>PolygonGeometry<span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    menu<span class="token operator">-&gt;</span><span class="token function">addAction</span><span class="token punctuation">(</span><span class="token function">tr</span><span class="token punctuation">(</span><span class="token string">"PolygonStyle"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MyQGIS01<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">instance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">SLOT</span><span class="token punctuation">(</span><span class="token function">slot_polygonstyle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 如果选择的是栅格图层</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>layer <span class="token operator">&amp;&amp;</span> layer<span class="token operator">-&gt;</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> QgsMapLayerType<span class="token punctuation">:</span><span class="token punctuation">:</span>RasterLayer<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// TO DO:</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> menu<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">void</span> MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addLegendLayerAction</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> action<span class="token punctuation">,</span> <span class="token keyword">const</span> QString<span class="token operator">&amp;</span> menu<span class="token punctuation">,</span> QString id<span class="token punctuation">,</span> QgsMapLayerType type<span class="token punctuation">,</span> bool allLayers<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addLegendLayerActionForLayer</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> action<span class="token punctuation">,</span> QgsMapLayer<span class="token operator">*</span> layer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">removeLegendLayerActionsForLayer</span><span class="token punctuation">(</span>QgsMapLayer<span class="token operator">*</span> layer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>

QList<span class="token operator">&lt;</span> LegendLayerAction <span class="token operator">&gt;</span> MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">legendLayerActions</span><span class="token punctuation">(</span>QgsMapLayerType type<span class="token punctuation">)</span> <span class="token keyword">const</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> mLegendLayerActionMap<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">?</span> mLegendLayerActionMap<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">:</span> QList<span class="token operator">&lt;</span>LegendLayerAction<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

bool MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">removeLegendLayerAction</span><span class="token punctuation">(</span>QAction<span class="token operator">*</span> action<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QMap<span class="token operator">&lt;</span> QgsMapLayerType<span class="token punctuation">,</span> QList<span class="token operator">&lt;</span> LegendLayerAction <span class="token operator">&gt;</span> <span class="token operator">&gt;</span><span class="token punctuation">:</span><span class="token punctuation">:</span>iterator it<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>it <span class="token operator">=</span> mLegendLayerActionMap<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        it <span class="token operator">!=</span> mLegendLayerActionMap<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>it<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> it<span class="token operator">-&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>action <span class="token operator">==</span> action<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">removeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> true<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> false<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> MyQGIS01LayerTreeViewMenuProvider<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">addCustomLayerActions</span><span class="token punctuation">(</span>QMenu<span class="token operator">*</span> menu<span class="token punctuation">,</span> QgsMapLayer<span class="token operator">*</span> layer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5miancpp_586"></a>5.mian.cpp</h3> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"MyQGIS01.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;qgsapplication.h&gt;</span>  </span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    QgsApplication <span class="token function">a</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建一个QGIS应用</span>
    <span class="token comment">//设置qgis应用的路径</span>
    QgsApplication<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">setPrefixPath</span><span class="token punctuation">(</span><span class="token string">"D:\QGIS-3.18.3\apps\qgis"</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
    QgsApplication<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">initQgis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//初始化QGIS应用</span>
    MyQGIS01 w<span class="token punctuation">;</span>
    w<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> a<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr color="#000000" size='1"'> 
<h2><a id="_607"></a>总结</h2> 
<p><font color="#999AAA">以上就是今天要讲的内容，结果如下图，本文介绍了图层管理器右键菜单的创建，但仍存在小问题：当对图层管理器里具体图层或者group右键会出现帧不在模块中的提示。如果有同学发现解决此问题方法望不吝赐教。下节讲解ui文件和工具栏的创建。<br> <img src="https://images2.imgbox.com/75/48/vqU6AKsU_o.png" alt="在这里插入图片描述"></font></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0237e21bdc568857a24e98e55ad194ee/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MySQL数据库死锁的产生原因及解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/11a626e683bbf947a586e48950d3c577/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">信用评分卡模型</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>