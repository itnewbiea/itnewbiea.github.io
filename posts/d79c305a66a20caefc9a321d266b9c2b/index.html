<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【学习记录】镭神32线激光雷达ROS下运行fromRosMsg()报错 Failed to find match for field “intensity“ 问题 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【学习记录】镭神32线激光雷达ROS下运行fromRosMsg()报错 Failed to find match for field “intensity“ 问题" />
<meta property="og:description" content="今日采用ROS的fromRosMsg()将ros下的点云数据转成PCL时，报错 “Failed to find match for field ‘intensity’”。调试半天，确定问题并解决。
1. RVIZ查看发布数据是否包含Intensity 首先采用rviz看了下镭神的ros下驱动发布的数据是否包含了intensity数据。
虽然是显然应该包括的，但调试了半天一直收不到数据我都怀疑它没有发出来。
打开rviz订阅点云数据，然后将颜色显示按照intensity进行显示，如果按照intensity字段能够显示出不同的的颜色，那么就是本身包含了intensity数据的。
2. 查看发布的 RosMsg 数据 网上一般解释，这个报错往往发生在自定义的点云数据类型。但我这里转化的是将 PointCloud2 转成标准的 pcl::PointXYZI，所以一开始完全没有往数据格式上考虑。
不会真的是数据格式不正确吧？于是我输出了此时的点云：
rostopic echo /lslidar_points_cloud 部分输出如下：
header: xxx height: 32 width: 2244 fields: - name: &#34;x&#34; offset: 0 datatype: 7 count: 1 - name: &#34;intensity&#34; offset: 16 datatype: 2 count: 1 is_bigendian: False point_step: 32 row_step: 71808 data: [0, 0, 0, 0, 0, 0, 0, ...] is_dense: False 由于这个信息是编码后的，所以无法直接从data中读取出来是否含有intensity。但注意到intensity下的datatype是2，这个含义是啥呢？进一步输出PointCloud2的message：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d79c305a66a20caefc9a321d266b9c2b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-28T14:23:20+08:00" />
<meta property="article:modified_time" content="2023-03-28T14:23:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【学习记录】镭神32线激光雷达ROS下运行fromRosMsg()报错 Failed to find match for field “intensity“ 问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>今日采用ROS的<code>fromRosMsg()</code>将ros下的点云数据转成PCL时，报错 “Failed to find match for field ‘intensity’”。调试半天，确定问题并解决。</p> 
<h3><a id="1_RVIZIntensity_4"></a>1. RVIZ查看发布数据是否包含Intensity</h3> 
<p>首先采用rviz看了下镭神的ros下驱动发布的数据是否包含了intensity数据。<br> 虽然是显然应该包括的，但调试了半天一直收不到数据我都怀疑它没有发出来。<br> 打开rviz订阅点云数据，然后将颜色显示按照intensity进行显示，如果按照intensity字段能够显示出不同的的颜色，那么就是本身包含了intensity数据的。</p> 
<h3><a id="2__RosMsg__9"></a>2. 查看发布的 RosMsg 数据</h3> 
<p>网上一般解释，这个报错往往发生在自定义的点云数据类型。但我这里转化的是将 PointCloud2 转成标准的 <code>pcl::PointXYZI</code>，所以一开始完全没有往数据格式上考虑。<br> 不会真的是数据格式不正确吧？于是我输出了此时的点云：</p> 
<pre><code class="prism language-bash">rostopic <span class="token builtin class-name">echo</span> /lslidar_points_cloud
</code></pre> 
<p>部分输出如下：</p> 
<pre><code class="prism language-txt">header: xxx
height: 32
width: 2244
fields: 
  - 
    name: "x"
    offset: 0
    datatype: 7
    count: 1
  - 
    name: "intensity"
    offset: 16
    datatype: 2
    count: 1
is_bigendian: False
point_step: 32
row_step: 71808
data: [0, 0, 0, 0, 0, 0, 0, ...]
is_dense: False
</code></pre> 
<p>由于这个信息是编码后的，所以无法直接从data中读取出来是否含有intensity。但注意到<code>intensity</code>下的<code>datatype</code>是2，这个含义是啥呢？进一步输出<code>PointCloud2</code>的message：</p> 
<pre><code class="prism language-bash">rosmsg info sensor_msgs/PointCloud2
</code></pre> 
<p>输出内容如下：</p> 
<pre><code class="prism language-txt">[sensor_msgs/PointCloud2]:
std_msgs/Header header
  uint32 seq
  time stamp
  string frame_id
uint32 height
uint32 width
sensor_msgs/PointField[] fields
  uint8 INT8=1
  uint8 UINT8=2
  uint8 INT16=3
  uint8 UINT16=4
  uint8 INT32=5
  uint8 UINT32=6
  uint8 FLOAT32=7
  uint8 FLOAT64=8
  string name
  uint32 offset
  uint8 datatype
  uint32 count
bool is_bigendian
uint32 point_step
uint32 row_step
uint8[] data
bool is_dense
</code></pre> 
<p>可以发现，2 表示的是uint8，也就是说，此时镭神雷达发出的点云中的intensity是一个uint8类型，而非常见的float类型。是否是这个原因导致无法match呢？</p> 
<h3><a id="3__72"></a>3. 自定义点云格式</h3> 
<p>推测默认的<code>pcl::PointXYZI</code>是float类型接收的intensity，因此需要重新定义一种点云类型。定义方式如下：</p> 
<pre><code class="prism language-cpp"><span class="token comment">// header.h</span>
<span class="token keyword">struct</span> <span class="token class-name">lslidarPointXYZI</span><span class="token punctuation">{<!-- --></span>
	PCL_ADD_POINT4D<span class="token punctuation">;</span>
	<span class="token keyword">double</span> timestamp<span class="token punctuation">;</span>
	<span class="token keyword">uint8_t</span> intensity<span class="token punctuation">;</span>		<span class="token comment">// lslidar's intensity is a `uint8_type` (type=2)</span>
	<span class="token keyword">float</span> range<span class="token punctuation">;</span>EIGEN_MAKE_ALIGNED_OPERATOR_NEW
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">POINT_CLOUD_REGISTER_POINT_STRUCT</span><span class="token punctuation">(</span>lslidarPointXYZI<span class="token punctuation">,</span>
					<span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span> y<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">,</span> z<span class="token punctuation">,</span> z<span class="token punctuation">)</span>
					<span class="token punctuation">(</span><span class="token keyword">uint8_t</span><span class="token punctuation">,</span> intensity<span class="token punctuation">,</span> intensity<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> timestamp<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">typedef</span> pcl<span class="token double-colon punctuation">::</span>PointCloud<span class="token operator">&lt;</span>lslidarPointXYZI<span class="token operator">&gt;</span> lslidarPointCloud<span class="token punctuation">;</span>
</code></pre> 
<p>其中在<code>struct</code>字段中，将intensity定义为uint8_t，并且需要在下面加一行点云类型的宏注册。关于这行没有详细查找含义，但推测是把上面struct中定义的字段和实际pcl中默认的xyz/intensity等进行对应。</p> 
<p>之后再代码测试：</p> 
<pre><code class="prism language-cpp">pcl<span class="token double-colon punctuation">::</span>PointCloud<span class="token operator">&lt;</span>lslidarPointXYZI<span class="token operator">&gt;</span> point_cloud_ls<span class="token punctuation">;</span>
<span class="token function">fromROSMsg</span><span class="token punctuation">(</span><span class="token operator">*</span>msg_pc<span class="token punctuation">,</span> point_cloud_ls<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这次可以成功转化，没有报错。<br> 只不过此时的intensity是0~255，如果按照通用的情况，我们需要将其转为float类型再进行后续运算。</p> 
<h4><a id="_98"></a>总结</h4> 
<p>真是一个坑爹的设定。</p> 
<h3><a id="_20230219_101"></a>后记 2023.02.19</h3> 
<p><strong>后面自己写了一个新的代码，接收原始点云后处理重新发布了带有Intensity和ring字段的代码。<br> 请查看：<a href="https://blog.csdn.net/tfb760/article/details/129108936">将镭神C32激光雷达的PointXYZ数据转化为PointXYZIR格式 </a></strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f523ed6bb8c2f628d0cfd78e3bfdb37/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">完了，CPU100%了，教你如何快速定位CPU100%问题</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c7bd9a25e51dd2652f8422e1bef5e46f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">[MySQL]如何选择合适的分布式主键方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>