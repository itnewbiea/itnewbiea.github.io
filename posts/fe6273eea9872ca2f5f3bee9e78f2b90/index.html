<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>log4js日志管理（分级、格式化、切割等）使用详解 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="log4js日志管理（分级、格式化、切割等）使用详解" />
<meta property="og:description" content="文章目录 log4js使用详解技术选型log4js基本使用方法1. 安装2. 基本功能日志级别：日志类型：1. 日志分类过滤2. 定义日志Logger的不同类型来源 日志落盘：日志过滤：日志格式（Layout）： log4js使用详解 技术选型 在node服务端的日志收集工具中，比较火热的有winston、log4js、bunyan、npmlog等，对于日志收集的基本要求例如分布式集中收集、多渠道输出、日志格式化等上述npm库均可满足。现在分析下上述工具库的特点：
winston：非常全面的日志管理库，但比较重一些log4js：定制灵活、比较全面的日志管理库，允许api配置也允许json方式配置，相对轻便、灵活bunyan：日志记录方式为JSON，相对来说形式比较单一npmlog：基础的日志记录器，不具备更多的高级功能、定制化功能。 对于本项目来说，并不需要复杂的winston来支持，log4js在兼顾功能的情况下也可以兼顾性能，因此使用log4js
但是对于express框架的后端，我们可以考虑使用express默认中间组件morgan
log4js基本使用方法 1. 安装 使用npm下载即可
npm install log4js 2. 基本功能 在log4js中使用日志记录器，主要的功能如下：
日志级别： 日志分级可以将不同级别的日志在控制台中采用不同的颜色，也可以帮助在生产时有选择地生成不同级别的日志。
这一点理解上可以对应console api的调用，我们可以console.log、console.info、console.err，这是类似的。log4js默认的日志分级有9级，并且不像winston可以自定义配置日志级别，这是不可修改的：
Level.addLevels({ ALL: { value: Number.MIN_VALUE, colour: &#39;grey&#39; }, TRACE: { value: 5000, colour: &#39;blue&#39; }, DEBUG: { value: 10000, colour: &#39;cyan&#39; }, INFO: { value: 20000, colour: &#39;green&#39; }, WARN: { value: 30000, colour: &#39;yellow&#39; }, ERROR: { value: 40000, colour: &#39;red&#39; }, FATAL: { value: 50000, colour: &#39;magenta&#39; }, MARK: { value: 9007199254740992, colour: &#39;grey&#39; }, // 2^53 OFF: { value: Number." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/fe6273eea9872ca2f5f3bee9e78f2b90/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-16T12:21:33+08:00" />
<meta property="article:modified_time" content="2023-11-16T12:21:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">log4js日志管理（分级、格式化、切割等）使用详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#log4js_2" rel="nofollow">log4js使用详解</a></li><li><ul><li><a href="#_3" rel="nofollow">技术选型</a></li><li><a href="#log4js_14" rel="nofollow">log4js基本使用方法</a></li><li><ul><li><a href="#1__15" rel="nofollow">1. 安装</a></li><li><a href="#2__21" rel="nofollow">2. 基本功能</a></li><li><ul><li><a href="#_24" rel="nofollow">日志级别：</a></li><li><a href="#_47" rel="nofollow">日志类型：</a></li><li><ul><li><a href="#1__48" rel="nofollow">1. 日志分类过滤</a></li><li><a href="#2_Logger_141" rel="nofollow">2. 定义日志Logger的不同类型来源</a></li></ul> 
      </li><li><a href="#_156" rel="nofollow">日志落盘：</a></li><li><a href="#_241" rel="nofollow">日志过滤：</a></li><li><a href="#Layout_272" rel="nofollow">日志格式（Layout）：</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="log4js_2"></a>log4js使用详解</h3> 
<h4><a id="_3"></a>技术选型</h4> 
<p>在node服务端的日志收集工具中，比较火热的有winston、log4js、bunyan、npmlog等，对于日志收集的基本要求例如分布式集中收集、多渠道输出、日志格式化等上述npm库均可满足。现在分析下上述工具库的特点：</p> 
<ul><li>winston：非常全面的日志管理库，但比较重一些</li><li>log4js：定制灵活、比较全面的日志管理库，允许api配置也允许json方式配置，相对轻便、灵活</li><li>bunyan：日志记录方式为JSON，相对来说形式比较单一</li><li>npmlog：基础的日志记录器，不具备更多的高级功能、定制化功能。</li></ul> 
<p>对于本项目来说，并不需要复杂的winston来支持，log4js在兼顾功能的情况下也可以兼顾性能，因此使用log4js</p> 
<p>但是对于express框架的后端，我们可以考虑使用express默认中间组件morgan</p> 
<h4><a id="log4js_14"></a>log4js基本使用方法</h4> 
<h5><a id="1__15"></a>1. 安装</h5> 
<p>使用npm下载即可</p> 
<pre><code>npm install log4js
</code></pre> 
<h5><a id="2__21"></a>2. 基本功能</h5> 
<p>在log4js中使用日志记录器，主要的功能如下：</p> 
<ul><li> <h6><a id="_24"></a>日志级别：</h6> <p>日志分级可以将不同级别的日志在控制台中采用不同的颜色，也可以帮助在生产时有选择地生成不同级别的日志。</p> <p>这一点理解上可以对应console api的调用，我们可以console.log、console.info、console.err，这是类似的。log4js默认的日志分级有9级，并且不像winston可以自定义配置日志级别，这是不可修改的：</p> <pre><code class="prism language-javascript">Level<span class="token punctuation">.</span><span class="token function">addLevels</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token constant">ALL</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> Number<span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'grey'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">TRACE</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">5000</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'blue'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">DEBUG</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">10000</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'cyan'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">INFO</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">20000</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'green'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">WARN</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'yellow'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">ERROR</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">40000</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'red'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">FATAL</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">50000</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'magenta'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token constant">MARK</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token number">9007199254740992</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'grey'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 2^53</span>
  <span class="token constant">OFF</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">value</span><span class="token operator">:</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">,</span> <span class="token literal-property property">colour</span><span class="token operator">:</span> <span class="token string">'grey'</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li></ul> 
<p>其优先级依次递增，有个更清晰的图示：</p> 
<p><img src="https://images2.imgbox.com/c1/e4/94rsxs5Y_o.png" alt="在这里插入图片描述"></p> 
<p>ALL OFF 这两个等级并不会直接在业务代码中使用。剩下的七个即分别对应 Logger 实例的七个方法，.trace .debug .info …。也就是说，你在调用这些方法的时候，就相当于为这些日志定了级。</p> 
<ul><li> <h6><a id="_47"></a>日志类型：</h6> </li></ul> 
<h6><a id="1__48"></a>1. 日志分类过滤</h6> 
<p>对于创建的同一个logger记录器实例，我们可能会遇到需要在记录日志的时候区分info 、 debug 、error等不同级别的日志，并将其放在不同的file文件中，例如分别放在xxx-info.log、xxx-debug.log、xxx-error.log三种文件中</p> 
<p>这个时候我们需要用到类型为logLevelFilter的过滤器，该过滤器可以对不同级别的日志、指定不同的追加器</p> 
<p>同时我们在category类别中，定义以不同的key，使用不同的filter / appender组，让日志根据对应级别匹配其类别下可输出的日志Appender。<strong>注意：category配置时，default是必须要有的，代表其他的category没有匹配到时，默认进入default；</strong> <font color="red">category通过getLogger函数传参设置，不同类别下的logger,使用不同类别key对应的filter / appender </font></p> 
<p>以下是实现上述需求的一个封装类：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">let</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'log4js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> _fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Logger</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_logger <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>logPathName <span class="token operator">=</span> <span class="token string">'logs'</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>config <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'dateFile'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">filename</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logPathName <span class="token operator">+</span> <span class="token string">'/info.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'utf-8'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">layout</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pattern'</span><span class="token punctuation">,</span>
                <span class="token literal-property property">pattern</span><span class="token operator">:</span> <span class="token string">'%d %p %h %m'</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token comment">//split by day</span>
            <span class="token literal-property property">pattern</span><span class="token operator">:</span> <span class="token string">'yyyy-MM-dd'</span><span class="token punctuation">,</span>
            <span class="token comment">// ends as '.log' </span>
            <span class="token literal-property property">keepFileExt</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token comment">//insert the date at the tail of name</span>
            <span class="token literal-property property">alwaysIncludePattern</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//define and configure logger</span>
        log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
            <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">,</span>
                <span class="token comment">//debug appender</span>
                <span class="token literal-property property">debugAppender</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">,</span>
                    <span class="token literal-property property">filename</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logPathName <span class="token operator">+</span> <span class="token string">'/debug.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">//debug filter</span>
                <span class="token literal-property property">debugFilter</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'logLevelFilter'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">appender</span><span class="token operator">:</span> <span class="token string">'debugAppender'</span><span class="token punctuation">,</span> <span class="token comment">// assign a specific appender</span>
                    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> <span class="token comment">// lowest log level to catch</span>
                    <span class="token literal-property property">maxLevel</span><span class="token operator">:</span> <span class="token string">'debug'</span><span class="token punctuation">,</span> <span class="token comment">//highest log level to catch</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">//info filter</span>
                <span class="token literal-property property">infoFilter</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'logLevelFilter'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">appender</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">maxLevel</span><span class="token operator">:</span> <span class="token string">'info'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">//warn filter</span>
                <span class="token literal-property property">warnFilter</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'logLevelFilter'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">appender</span><span class="token operator">:</span> <span class="token string">'default'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'warn'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">maxLevel</span><span class="token operator">:</span> <span class="token string">'warn'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token literal-property property">errorAppender</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>config<span class="token punctuation">,</span>
                    <span class="token literal-property property">filename</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>logPathName <span class="token operator">+</span> <span class="token string">'/error.log'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">//error filter</span>
                <span class="token literal-property property">errorFilter</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'logLevelFilter'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">appender</span><span class="token operator">:</span> <span class="token string">'errorAppender'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'error'</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">maxLevel</span><span class="token operator">:</span> <span class="token string">'fatal'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>

          <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">//default is a must</span>
                    <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'infoFilter'</span><span class="token punctuation">,</span> <span class="token string">'warnFilter'</span><span class="token punctuation">,</span> <span class="token string">'errorFilter'</span><span class="token punctuation">,</span><span class="token string">'debugFilter'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'debuug'</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

        <span class="token comment">//get logger，无category传参，进入default配置中</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_logger<span class="token punctuation">.</span>level <span class="token operator">=</span> <span class="token string">"debug"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="2_Logger_141"></a>2. 定义日志Logger的不同类型来源</h6> 
<p>当获取Logger实例时，唯一可以传的参数就是日志类型loggerCategory，这个是非常灵活的、自定义字符串的参数，用于从另一个维度将日志分类。<br> 比如：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// file: set-catetory.js</span>
<span class="token keyword">var</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'log4js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'set-catetory.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Time:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>打印的日志信息如下：</p> 
<pre><code> [2016-08-21 01:24:07.332] [DEBUG] set-catetory.js - Time: 2016-08-20T17:24:07.331Z 
</code></pre> 
<p>可以从这条日志信息看出这条日志来自于 set-catetory.js 文件。又或者针对不同的 node package 使用不同的 category，这样可以区分日志来源于哪个模块。</p> 
<ul><li> <h6><a id="_156"></a>日志落盘：</h6> </li></ul> 
<p>日志落盘通俗来说就是日志在哪里生成，也可以理解为日志输出的渠道。在log4js中日志的出口通过Appender来定义。<br> log4js提供的Appender有</p> 
<blockquote> 
 <ul><li><strong>console</strong>：输出到控制台</li><li><strong>file</strong>：输出到指定目录文件中</li><li><strong>dataFile</strong>：将日志输出到文件，可以按照特定日期滚动生成，例如今天输出到 default-2023-08-21.log，明天输出到 default-2023-08-22.log</li><li><strong>multiFile</strong>：动态配置不同category下或者不同变量控制下，落盘到不同文件</li><li><strong>smtp</strong>：将日志输出到邮件</li></ul> 
</blockquote> 
<p><strong>默认Appender</strong><br> 下面是 log4js 内部默认的 appender 设置：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// log4js.js</span>
defaultConfig <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"console"</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>设置自己的Appender</strong><br> 我们可以通过log4js.configure来设置我们想要的 appender。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// file: custom-appender.js</span>
<span class="token keyword">var</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'log4js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'default.log'</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'custom-appender'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Time:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在上例中，我们将日志输出到了文件中，运行代码，log4js 在当前目录创建了一个名为default.log 文件，[2016-08-21 08:43:21.272] [DEBUG] custom-appender - Time: 2016-08-21T00:43:21.272Z 输出到了该文件中。</p> 
<p>上述Appenders也可以见出，Appenders是一个数组，可以接受多个type的输出渠道~</p> 
<p><strong>值得一提的multiFile</strong><br> 1、根据category来动态落盘</p> 
<pre><code class="prism language-javascript">log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">multi</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"multiFile"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token string">"logs/"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token string">"categoryName"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">extension</span><span class="token operator">:</span> <span class="token string">".log"</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"multi"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">"debug"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"I will be logged in logs/default.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> otherLogger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"cheese"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
otherLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Cheese is cheddar - this will be logged in logs/cheese.log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>2、根据变量来动态落盘（<font color="red">使用addContext设置变量</font>）【下述例子展现了如何例如addContext来使日志进行滚动，<strong>下例中根据userId滚动，也可以同理替换为new Date使其根据日期滚动</strong>】</p> 
<pre><code class="prism language-javascript">log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">everything</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">"multiFile"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">base</span><span class="token operator">:</span> <span class="token string">"logs/"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">property</span><span class="token operator">:</span> <span class="token string">"userID"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">extension</span><span class="token operator">:</span> <span class="token string">".log"</span><span class="token punctuation">,</span>
      <span class="token literal-property property">maxLogSize</span><span class="token operator">:</span> <span class="token number">10485760</span><span class="token punctuation">,</span>
      <span class="token literal-property property">backups</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
      <span class="token literal-property property">compress</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token literal-property property">categories</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"everything"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">"debug"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> userLogger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userLogger<span class="token punctuation">.</span><span class="token function">addContext</span><span class="token punctuation">(</span><span class="token string">"userID"</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
userLogger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"this user just logged in"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<ul><li> <h6><a id="_241"></a>日志过滤：</h6> </li></ul> 
<p>我们可以调整 appender 的配置，对日志的级别和类别进行过滤：</p> 
<pre><code class="prism language-javascript"><span class="token comment">// file: level-and-category.js</span>
<span class="token keyword">var</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'log4js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'logLevelFilter'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">level</span><span class="token operator">:</span> <span class="token string">'DEBUG'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">category</span><span class="token operator">:</span> <span class="token string">'category1'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">appender</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'file'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">'default.log'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> logger1 <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'category1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> logger2 <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'category2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger1<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Time:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger1<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Time:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger2<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Time:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行，在 default.log 中增加了一条日志：</p> 
<blockquote> 
 <p>[2016-08-21 10:08:21.630] [DEBUG] category1 - Time: 2016-08-21T02:08:21.629Z</p> 
</blockquote> 
<p>为什么会出现如上的结果呢？主要是是从日志级别和category分类对应日志：</p> 
<ul><li> <p>使用 logLevelFilter 和 level 来对日志的级别进行过滤，所有权重大于或者等于DEBUG的日志将会输出。这也是之前提到的日志级别权重的意义；</p> </li><li> <p>通过 category 来选择要输出日志的类别，category2 下面的日志被过滤掉了，该配置也接受一个数组，例如 [‘category1’, ‘category2’]，这样配置两个类别的日志都将输出到文件中。</p> </li><li> <h6><a id="Layout_272"></a>日志格式（Layout）：</h6> </li></ul> 
<p>日志格式layout在每个Appender中的layout属性中配置，有几个默认的显示类型：</p> 
<ul><li>messagePassThrough：仅仅输出日志的内容；</li><li>basic：在日志的内容前面会加上时间、日志的级别和类别，通常日志的默认 layout；</li><li>colored/coloured：在 basic 的基础上给日志加上颜色，appender Console 默认使用的就是这个 layout；</li><li>pattern：这是一种特殊类型，可以通过它来定义任何你想要的格式。<br> 一个 pattern 的例子：</li></ul> 
<pre><code class="prism language-javascript"><span class="token comment">// file: layout-pattern.js</span>
<span class="token keyword">var</span> log4js <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'log4js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
log4js<span class="token punctuation">.</span><span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">appenders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'console'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">layout</span><span class="token operator">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'pattern'</span><span class="token punctuation">,</span>
      <span class="token literal-property property">pattern</span><span class="token operator">:</span> <span class="token string">'[%r] [%[%5.5p%]] - %m%n'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> logger <span class="token operator">=</span> log4js<span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">'layout-pattern'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Time:"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>对于pattern中指定的格式标识符，可以参考官网给出的表格：<br> <img src="https://images2.imgbox.com/23/76/FhXnCJmc_o.png" alt="在这里插入图片描述"><br> log4js的官方文档和源码地址在下方，有需要可以自己查阅:</p> 
<blockquote> 
 <p>官方文档：https://log4js-node.github.io/log4js-node/<br> 源码：https://github.com/log4js-node/log4js-node</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7862dffb5fba47705c0558f3470780e7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">磁盘扩容时遇到的一个问题，看到一个腾讯大佬的回答，瞬间顿悟了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b4ae0d2c9bddcf124a6547b11cf6e1fb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;常用格式化输出转换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>