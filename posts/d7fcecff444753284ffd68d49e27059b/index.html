<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>tiny扩充语言的语法分析_编程语言的实现，从AST（抽象语法树）开始 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="tiny扩充语言的语法分析_编程语言的实现，从AST（抽象语法树）开始" />
<meta property="og:description" content="前言 一直想聊一聊抽象语法树，但一直不知道如何下手。最近随意google的时候，突然发现一篇相当不错的文章。一个国外哥们写的。
原文出自《AST for JavaScript developers》
本着“学习”精神变把他的文章拜读一番，然后翻译了一下。希望这个外国小哥哥不要打我，哈哈。
正文 为什么要谈AST(抽象语法树)?
如果你查看目前任何主流的项目中的devDependencies，会发现前些年的不计其数的插件诞生。我们归纳一下有：javascript转译、代码压缩、css预处理器、elint、pretiier，等。有很多js模块我们不会在生产环境用到，但是它们在我们的开发过程中充当着重要的角色。所有的上述工具，不管怎样，都建立在了AST这个巨人的肩膀上。
所有的上述工具，不管怎样，都建立在了AST这个巨人的肩膀上
我们定一个小目标，从解释什么是AST开始，然后到怎么从一般代码开始去构建它。我们将简单地接触在AST处理基础上，一些最流行的使用例子和工具。并且，我计划谈下我的js2flowchart项目，它是一个不错的利用AST的demo。OK，让我们开始吧。
什么是AST(抽象语法树)？
It is a hierarchical program representation that presents source code structure according to the grammar of a programming language, each AST node corresponds to an item of a source code.
估计很多同学会和图中的喵一样，看完这段官方的定义一脸懵逼。OK，我们来看例子：
这很简化
实际上，正真AST每个节点会有更多的信息。但是，这是大体思想。从纯文纯中，我们将得到树形结构的数据。每个条目和树中的节点一一对应。
那怎么从纯文本中得到AST呢？哇哦，我们知道当下的编译器都做了这件事前。那我们就看看一般的编译器怎么做的就可以了。
想做一款编译器是个比较消耗发量的事情，但幸运的是，我们无需贯穿编译器的所有知识点，最后将高级语言转译为二进制代码。我们只需要关注词法分析和语法分析。这两步是从代码中生成AST的关键所在。
第一步，词法分析，也叫做扫描scanner。它读取我们的代码，然后把它们按照预定的规则合并成一个个的标识tokens。同时，它会移除空白符，注释，等。最后，整个代码将被分割进一个tokens列表(或者说一维数组)。
当词法分析源代码的时候，它会一个一个字母地读取代码，所以很形象地称之为扫描-scans；当它遇到空格，操作符，或者特殊符号的时候，它会认为一个话已经完成了。
第二步，语法分析，也解析器。它会将词法分析出来的数组转化成树形的表达形式。同时，验证语法，语法如果有错的话，抛出语法错误。
当生成树的时候，解析器会删除一些没必要的标识tokens(比如不完整的括号)，因此AST不是100%与源码匹配的，但是已经能让我们知道如何处理了。说个题外话，解析器100%覆盖所有代码结构生成树叫做CST(具体语法树)
我们最终得到的
想要学习更多关于编译器的知识？ the-super-tiny-compiler，一个贼好的项目。大概200来行代码，几乎每行都有注释。
想要自己创建门编程语言？ LangSandbox，一个更好的项目。它演示了如何创造一门编程语言。当然，设计编程语言这样的书市面上也一坨坨。所以，这项目更加深入，与the-super-tiny-compiler的项目将Lisp转为C语言不同，这个项目你可以写一个你自己的语言，并且将它编译成C语言或者机器语言，最后运行它。
我能直接用三方库来生成AST吗？ 当然可以！有一坨坨的三方库可以用。你可以访问astexplorer，然后挑你喜欢的库。astexplorer是一个很棒的网站，你可以在线玩转AST，而且除了js，还有很多其它语言的AST库。
我不得不强调一款我觉得很棒的三方库，叫做babylon。
它被用在大名鼎鼎的babel中，也许这也是它之所以这么火的原因。因为有babel项目的支持，我们可以意料到它将与时俱进，一直支持最新的JS特性，我们可以放心大胆地用，不怕以后JS又出新版导致代码的大规模重构。另外，它的API也非常的简单，容易使用。
Ok，现在你知道怎么将代码生成AST了，让我们继续，来看看现实中的用例。
第一个用例，我想谈谈代码转化，没错，就是那个货，babel。
Babel is not a ‘tool for having ES6 support’." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d7fcecff444753284ffd68d49e27059b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-03T21:49:50+08:00" />
<meta property="article:modified_time" content="2020-12-03T21:49:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">tiny扩充语言的语法分析_编程语言的实现，从AST（抽象语法树）开始</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <h2>前言</h2> 
 <p>一直想聊一聊抽象语法树，但一直不知道如何下手。最近随意google的时候，突然发现一篇相当不错的文章。一个国外哥们写的。</p> 
 <blockquote> 
  <p>原文出自《AST for JavaScript developers》</p> 
 </blockquote> 
 <p>本着“学习”精神变把他的文章拜读一番，然后翻译了一下。希望这个外国小哥哥不要打我，哈哈。</p> 
 <h2>正文</h2> 
 <p>为什么要谈AST(抽象语法树)?</p> 
 <p>如果你查看目前任何主流的项目中的devDependencies，会发现前些年的不计其数的插件诞生。我们归纳一下有：javascript转译、代码压缩、css预处理器、elint、pretiier，等。有很多js模块我们不会在生产环境用到，但是它们在我们的开发过程中充当着重要的角色。所有的上述工具，不管怎样，都建立在了AST这个巨人的肩膀上。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/12/74/CkK827SR_o.png" alt="ba7c5dea3f7833f55a8ef3a896be64ca.png"> 
 </div> 
 <p class="ql-align-center">所有的上述工具，不管怎样，都建立在了AST这个巨人的肩膀上</p> 
 <p>我们定一个小目标，从解释什么是AST开始，然后到怎么从一般代码开始去构建它。我们将简单地接触在AST处理基础上，一些最流行的使用例子和工具。并且，我计划谈下我的js2flowchart项目，它是一个不错的利用AST的demo。OK，让我们开始吧。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/3b/6d/yXnJkaAS_o.png" alt="a2810e0c136faf0669066caf296391a8.png"> 
 </div> 
 <p>什么是AST(抽象语法树)？</p> 
 <blockquote> 
  <p>It is a hierarchical program representation that presents source code structure according to the grammar of a programming language, each AST node corresponds to an item of a source code.</p> 
 </blockquote> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/e9/dc/HtGFR7wC_o.png" alt="19d38a10c8a30a3e3c636cf2c1832e08.png"> 
 </div> 
 <p>估计很多同学会和图中的喵一样，看完这段官方的定义一脸懵逼。OK，我们来看例子：</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/00/9b/bFQLaGhC_o.png" alt="256405ad5f8c9c7029293bf14e7a8f0b.png"> 
 </div> 
 <p class="ql-align-center">这很简化</p> 
 <p>实际上，正真AST每个节点会有更多的信息。但是，这是大体思想。从纯文纯中，我们将得到树形结构的数据。每个条目和树中的节点一一对应。</p> 
 <p>那怎么从纯文本中得到AST呢？哇哦，我们知道当下的编译器都做了这件事前。那我们就看看一般的编译器怎么做的就可以了。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/40/b0/MEX9mORY_o.png" alt="d91a8ee72342ad71833e21bd849cfb0f.png"> 
 </div> 
 <p>想做一款编译器是个比较消耗发量的事情，但幸运的是，我们无需贯穿编译器的所有知识点，最后将高级语言转译为二进制代码。我们只需要关注词法分析和语法分析。这两步是从代码中生成AST的关键所在。</p> 
 <p>第一步，词法分析，也叫做扫描scanner。它读取我们的代码，然后把它们按照预定的规则合并成一个个的标识tokens。同时，它会移除空白符，注释，等。最后，整个代码将被分割进一个tokens列表(或者说一维数组)。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/22/e8/Ixvqpwhb_o.png" alt="321cb8dcccde5f02b9d12654002d6ab8.png"> 
 </div> 
 <p>当词法分析源代码的时候，它会一个一个字母地读取代码，所以很形象地称之为扫描-scans；当它遇到空格，操作符，或者特殊符号的时候，它会认为一个话已经完成了。</p> 
 <p>第二步，语法分析，也解析器。它会将词法分析出来的数组转化成树形的表达形式。同时，验证语法，语法如果有错的话，抛出语法错误。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/29/52/YDd8ZXDU_o.png" alt="c54ab09bb9c05e93fe39c9c48488ef88.png"> 
 </div> 
 <p>当生成树的时候，解析器会删除一些没必要的标识tokens(比如不完整的括号)，因此AST不是100%与源码匹配的，但是已经能让我们知道如何处理了。说个题外话，解析器100%覆盖所有代码结构生成树叫做CST(具体语法树)</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/2b/57/mlxn7KVN_o.png" alt="3ce13617b3b502b65641103ae63783f5.png"> 
 </div> 
 <p class="ql-align-center">我们最终得到的</p> 
 <p>想要学习更多关于编译器的知识？ the-super-tiny-compiler，一个贼好的项目。大概200来行代码，几乎每行都有注释。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/eb/40/EJmFtheT_o.png" alt="7e9929a6fcc201ed7ab3fea9668a3133.png"> 
 </div> 
 <p>想要自己创建门编程语言？ LangSandbox，一个更好的项目。它演示了如何创造一门编程语言。当然，设计编程语言这样的书市面上也一坨坨。所以，这项目更加深入，与the-super-tiny-compiler的项目将Lisp转为C语言不同，这个项目你可以写一个你自己的语言，并且将它编译成C语言或者机器语言，最后运行它。</p> 
 <p>我能直接用三方库来生成AST吗？ 当然可以！有一坨坨的三方库可以用。你可以访问astexplorer，然后挑你喜欢的库。astexplorer是一个很棒的网站，你可以在线玩转AST，而且除了js，还有很多其它语言的AST库。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/db/93/Wcx3YxSS_o.png" alt="f55996c37c6d8c89ed1b67b56e2063aa.png"> 
 </div> 
 <p>我不得不强调一款我觉得很棒的三方库，叫做babylon。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/f0/cc/gT7TXoHl_o.png" alt="e075c16824d237e3905da6ec6c41f88d.png"> 
 </div> 
 <p>它被用在大名鼎鼎的babel中，也许这也是它之所以这么火的原因。因为有babel项目的支持，我们可以意料到它将与时俱进，一直支持最新的JS特性，我们可以放心大胆地用，不怕以后JS又出新版导致代码的大规模重构。另外，它的API也非常的简单，容易使用。</p> 
 <p>Ok，现在你知道怎么将代码生成AST了，让我们继续，来看看现实中的用例。</p> 
 <p>第一个用例，我想谈谈代码转化，没错，就是那个货，babel。</p> 
 <blockquote> 
  <p>Babel is not a ‘tool for having ES6 support’. Well, it is, but it is far not only what it is about.</p> 
 </blockquote> 
 <p>经常把beble和支持es6/7/8联系起来，实际上，这也是我们经常用它的原因。但是，它仅仅是一组插件中的一个。我们也可以使用它来压缩代码，react相关语法转译(如jsx)，flow插件等。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/99/73/sy1Q9ZqU_o.png" alt="450c1c3efc309992fff6d361ebe88ac6.png"> 
 </div> 
 <p>babel是一个javascript编译器。宏观来说，它分3个阶段运行代码：解析(parsing)，转译(transforming)，生成(generation)。我们可以给babel 一些javascript代码，它修改代码然后生成新的代码返回。那它是怎样修改代码的呢？没错！它创建了AST，遍历树，修改tokens，最后从AST中生成新的代码。</p> 
 <p>我们来从下面的demo中看下这个过程：</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/77/6a/Yhpyln5R_o.png" alt="fa524d81fd0c4a65cc3151ef7a2f9e74.png"> 
 </div> 
 <p>像我之前提到的，babel使用babylon，所以，首先，我们解析代码成AST，然后遍历AST，再反转所有的变量名，最后生成代码。完成！正如我们看到的，第一步(解析)和第三步(生成)看起来非常常规，我们每次都会做这两步。所以，babel接管处理了它俩。最后，我们最为关心的，那就是AST转译这一步了。</p> 
 <p>当我们开发babel-plugin的时候，我们只需要描述转化你AST的节点“visitors”就可以了。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/3a/6e/fGOtd7O5_o.png" alt="a65f6604e544076e074a2a7f91bb9092.png"> 
 </div> 
 <p class="ql-align-center">将它加入你的babel插件列表中，设置你webpack的babel-loader配置或者.babelrc中的plugins即可。</p> 
 <p class="ql-align-center">如果你想要学习怎么创建你的第一个babel-plugin，可以查看Babel-handbook</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/22/66/3h3l1QTq_o.png" alt="19c18f73359c67637b7451d576ba8601.png"> 
 </div> 
 <p>让我们继续，下一个用例，我想提到的是自动代码重构工具，以及神器JSCodeshift。</p> 
 <p>比如说你想要替换掉所有的老掉牙的匿名函数，把他们变成Lambda表达式(箭头函数)。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/3b/df/ApHOjMuv_o.png" alt="ac7a3dae471c86c83753c632583eb930.png"> 
 </div> 
 <p>你的代码编辑器很可能没法这么做，因为这并不是简单地查找替换操作。这时候jscodeshift就登场了。</p> 
 <p>如果你听过jscodeshift，你很可能也听过codemods，一开始挺这两个词可能很困惑，不过没关系，接下来就解释。jscodeshift是一个跑codemods的工具。codemod是一段描述AST要转化成什么样的代码，这思想和babel的插件如出一辙。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/43/50/H4S6X7Iu_o.png" alt="90d831d85794e4a0a93b691d2ee013ad.png"> 
 </div> 
 <p>所以，如果你想创建自动把你的代码从旧的框架迁移到新的框架，这就是一种很乃思的方式。举个例子，react 16的prop-types重构。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/0b/81/mW2fCltF_o.png" alt="e3f8004e4137f855235d16a7b7fae74a.png"> 
 </div> 
 <p>有很多不同的codemodes已经创建了，你可以保存你需要的，以免手动的修改一坨坨代码，GitHub就在这，搞起来： github.com/facebook/js… github.com/reactjs/rea…</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/cd/7c/51mv7DO3_o.png" alt="2927c2acede1d52e17143119e71001b8.png"> 
 </div> 
 <p>最后一个用例，我想要提到Prettier，因为可能每个码农都在日常工作中用到它。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/48/09/sfpTFUgX_o.png" alt="2f7cb3bbff8f383a20be79c04a2fd5ef.png"> 
 </div> 
 <p>Prettier 格式化我们的代码。它调整长句，整理空格，括号等。所以它将代码作为输入，修改后的代码作为输出。听起来很熟悉是吗？当然！</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/19/2b/N6hGsHin_o.png" alt="e66bb9d1e1f282a22318c9d29605ba96.png"> 
 </div> 
 <p>思路还是一样。首先，将代码生成AST。之后依然是处理AST，最后生成代码。但是，中间过程其实并不像它看起来那么简单。</p> 
 <p>同样，如果你想学习更多在美化打印背后理论，这里有一本你可以深入的书 《A prettier printer》。</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/df/3a/LhhF5NbW_o.png" alt="25028416ada863d7152495de2825483b.png"> 
 </div> 
 <p>文章迎来尾声，我们继续，今天最后一件事，我想提及的就是我的库，叫做js2flowchart(4.5 k stars 在 Github)。</p> 
 <blockquote> 
  <p>这个小哥很有意思，没有贴链接~大家感兴趣的话，可以GitHub搜索一下</p> 
 </blockquote> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/86/5b/BtPE0hQx_o.png" alt="59ee82ac65a1a442b059af4d42194daa.png"> 
 </div> 
 <p class="ql-align-center">顾名思义，它将js代码转化生成svg流程图</p> 
 <p>这是一个很好的例子，因为它向你展现了你，当你拥有AST时，可以做任何你想要做的事。把AST转回成字符串代码并不是必要的，你可以通过它画一个流程图，或者其它你想要的东西。</p> 
 <p>js2flowchart使用场景是什么呢？通过流程图，你可以解释你的代码，或者给你代码写文档；通过可视化的解释学习其他人的代码；通过简单的js语法，为每个处理过程简单的描述创建流程图。</p> 
 <p>马上用最简单的方式尝试一下吧，去线上编辑看看 js-code-to-svg-flowchart</p> 
 <p>你也可以在代码中使用它，或者通过CLI，你只需要指向你想生成SVG的文件就行。而且，还有VS Code插件(链接在项目readme中)</p> 
 <p>那么，它还能做什么呢？哇哦，我这里就不废话了，大家有兴趣直接看这个项目的文档吧。</p> 
 <p>OK，那它是如何工作的呢？</p> 
 <div class="pgc-img"> 
  <img src="https://images2.imgbox.com/e4/eb/Tfrji9aY_o.png" alt="822a2b7ccc967b9794dab31d24189e16.png"> 
 </div> 
 <p>首先，解析代码成AST，然后，我们遍历AST并且生成另一颗树，我称之为工作流树。它删除很多不重要的额tokens，但是将关键块放在一起，如函数、循环、条件等。再之后，我们遍历工作流树并且创建形状树。每个形状树的节点包含可视化类型、位置、在树中的连接等信息。最后一步，我们遍历所有的形状，生成对应的SVG，合并所有的SVG到一个文件中。</p> 
 <h2>结尾</h2> 
 <p>最后，再次感谢这个国外的小哥哥！一篇相当高质量，且很系统的文章~~</p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a6fb540854bc5d214891b1b8f8184036/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python注释的两种类型_Python中注释、基本数据类型的使用、与用户的交互</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/730902102b634c911937d6e0393789bb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python写入csv文件的中文乱码问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>