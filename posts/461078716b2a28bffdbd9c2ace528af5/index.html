<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringBoot整合SpringSecurity（通俗易懂） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringBoot整合SpringSecurity（通俗易懂）" />
<meta property="og:description" content="注重版权，转载请注明原作者和原文链接
作者：码农BookSea
原文链接： https://blog.csdn.net/bookssea/article/details/109262109 先看后赞，养成习惯。
点赞收藏，人生辉煌。
基于数据库的身份认证 一、创建项目
创建一个 SpringBoot 模块项目，选择相关依赖：
先搭建项目正常访问，在pom.xml中，先把Spring Security依赖注释
&lt;!--&lt;dependency&gt;--&gt; &lt;!--&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;--&gt; &lt;!--&lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;--&gt; &lt;!--&lt;/dependency&gt;--&gt; 在MySQL数据库中创建一张用户表，id主键自增，并添加两个用户如下：
代码：
创建entity实体
@Data public class UserInfo { private int id; private String username; private String password; private String role; } 创建mapper接口
@Mapper @Repository public interface UserInfoMapper { @Select(&#34;select * from user where username = #{username}&#34;) UserInfo getUserInfoByUsername(String username); } 创建UserInfoService.java文件 @Service public class UserInfoService { @Autowired private UserInfoMapper userInfoMapper; public UserInfo getUserInfo(String username){ return userInfoMapper." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/461078716b2a28bffdbd9c2ace528af5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-10-24T17:04:57+08:00" />
<meta property="article:modified_time" content="2020-10-24T17:04:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringBoot整合SpringSecurity（通俗易懂）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <ul><li>注重版权，转载请注明原作者和原文链接<br> 作者：码农BookSea<br> 原文链接： https://blog.csdn.net/bookssea/article/details/109262109</li></ul> 
<blockquote> 
 <p>先看后赞，养成习惯。<br> 点赞收藏，人生辉煌。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/d5/3f/fNqQVzQ4_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="_9"></a>基于数据库的身份认证</h3> 
<p><strong>一、创建项目</strong><br> 创建一个 SpringBoot 模块项目，选择相关依赖：</p> 
<p><img src="https://images2.imgbox.com/24/10/EsRdMpeD_o.png" alt="图片"></p> 
<p>先搭建项目正常访问，在pom.xml中，先把Spring Security依赖注释</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>security<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> 
<p>在MySQL数据库中创建一张用户表，id主键自增，并添加两个用户如下：</p> 
<p><img src="https://images2.imgbox.com/b0/38/shAF2BfW_o.png" alt="图片"></p> 
<p><mark>代码：</mark><br> <strong>创建entity实体</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String role<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建<mark>mapper</mark>接口</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserInfoMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">"select * from user where username = #{username}"</span><span class="token punctuation">)</span>
    UserInfo <span class="token function">getUserInfoByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
创建UserInfoService<span class="token punctuation">.</span>java文件

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserInfoMapper userInfoMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> UserInfo <span class="token function">getUserInfo</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">getUserInfoByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><mark>创建HelloController.java文件</mark></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserInfoService userInfoService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> UserInfo <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userInfoService<span class="token punctuation">.</span><span class="token function">getUserInfoByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>配置文件application.yml中设置MySQL连接配置和MyBatis配置</strong></p> 
<pre><code class="prism language-java">spring<span class="token operator">:</span>
  datasource<span class="token operator">:</span>
    url<span class="token operator">:</span> jdbc<span class="token operator">:</span>mysql<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">3306</span><span class="token operator">/</span>security<span class="token operator">?</span>useSSL<span class="token operator">=</span>FALSE<span class="token operator">&amp;</span>serverTimezone<span class="token operator">=</span>UTC
    username<span class="token operator">:</span> root
    password<span class="token operator">:</span> root
    driver<span class="token operator">-</span><span class="token keyword">class</span><span class="token operator">-</span>name<span class="token operator">:</span> com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>Driver
logging<span class="token operator">:</span>
  level<span class="token operator">:</span>
    com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>bdatabaserole<span class="token punctuation">.</span>mapper<span class="token operator">:</span> debug  # 打印sql语句
</code></pre> 
<p>以上配置好后，启动项目，访问<mark>localhost:8080/get-user?username=user</mark>，正常获取到用户信息：</p> 
<p><img src="https://images2.imgbox.com/c8/6a/I3ZFxFLh_o.png" alt="图片"></p> 
<p><strong>下面开始使用Spring Security安全验证：</strong></p> 
<h3><a id="Spring_Security_102"></a>二、Spring Security基于数据库认证</h3> 
<p>把pom.xml中的Spring Security依赖注释去掉：</p> 
<pre><code class="prism language-java"><span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>security<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>要从数据库读取用户信息进行身份认证，需要新建类实现UserDetailService接口重写loadUserByUsername方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserInfoService userInfoService<span class="token punctuation">;</span>
    
    <span class="token comment">/**
     * 需新建配置类注册一个指定的加密方式Bean，或在下一步Security配置类中注册指定
     */</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> PasswordEncoder passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UserDetails <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token keyword">throws</span> UsernameNotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 通过用户名从数据库获取用户信息</span>
        UserInfo userInfo <span class="token operator">=</span> userInfoService<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userInfo <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 得到用户角色</span>
        String role <span class="token operator">=</span> userInfo<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 角色集合</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>GrantedAuthority<span class="token punctuation">&gt;</span></span> authorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 角色必须以`ROLE_`开头，数据库中没有，则在这里加</span>
        authorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_"</span> <span class="token operator">+</span> role<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>
                userInfo<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token comment">// 因为数据库是明文，所以这里需加密密码</span>
                passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                authorities
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建Security的配置类WebSecurityConfig继承WebSecurityConfigurerAdapter，并重写configure(auth)方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> MyUserDatailService userDatailService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 指定加密方式
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> PasswordEncoder <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 使用BCrypt加密密码</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
         auth
                 <span class="token comment">// 从数据库读取的用户进行身份认证</span>
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDatailService<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面设置完后，重新启动，在登录页面就可以输入数据库中的用户名/密码了。</p> 
<h3><a id="_182"></a>三、角色访问控制</h3> 
<p>上面设置后，可以使用数据库中的用户名/密码登录，还获取到了用户的角色。通过用户的角色，可以限制用户的请求访问：</p> 
<p>开启方法的访问权限，需要在WebSecurityConfig添加</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableGlobalMethodSecurity</span>注解

<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">// 开启方法级安全验证</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改UserController.java类，增加方法的访问权限</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserInfoService userInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> UserInfo <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userInfoService<span class="token punctuation">.</span><span class="token function">getUserInfo</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAnyRole('user')"</span><span class="token punctuation">)</span> <span class="token comment">// 只能user角色才能访问该方法</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">user</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"user角色访问"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">"hasAnyRole('admin')"</span><span class="token punctuation">)</span> <span class="token comment">// 只能admin角色才能访问该方法</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/admin"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> String <span class="token function">admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token string">"admin角色访问"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置完后，重新启动程序，在登录页面中：</p> 
<p>输入user/user123登录，该用户角色为user，可以访问<mark>localhost:8080/user</mark>，不能访问<mark>localhost:8080/admin</mark>；<br> 再重启程序输入admin/admin123登录，角色为admin，能访问localhost:8080/admin，不能访问localhost:8080/user。</p> 
<h3><a id="_230"></a>四、密码加密保存</h3> 
<p>前面的用户密码都是手动添加的，所以数据库中是明文显示，在实际开发中，都是需要加密保存的。</p> 
<p>下面模拟简单注册用户，加密保存密码：</p> 
<p>UserInfoMapper.java类中添加插入用户</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">// 插入用户</span>
    <span class="token annotation punctuation">@Insert</span><span class="token punctuation">(</span><span class="token string">"insert into user(username, password, role) value(#{username}, #{password}, #{role})"</span><span class="token punctuation">)</span>
    <span class="token keyword">int</span> <span class="token function">insertUserInfo</span><span class="token punctuation">(</span>UserInfo userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>UserInfoService.java类中添加插入方法，注意要加密密码</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> PasswordEncoder passwordEncoder<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">insertUser</span><span class="token punctuation">(</span>UserInfo userInfo<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 加密密码</span>
        userInfo<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">insertUserInfo</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>}<br> 修改HelloController.java，增加添加用户接口</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">"/add-user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">addUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> UserInfo userInfo<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userInfoService<span class="token punctuation">.</span><span class="token function">insertUser</span><span class="token punctuation">(</span>userInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置完后，启动服务，使用Postman发送POST请求来添加用户：</p> 
<p><img src="https://images2.imgbox.com/0a/f2/RY1lUIcq_o.png" alt="图片"></p> 
<p>点击Send按钮后，添加失败，不会返回成功1，看到红框的状态码显示401 Unauthorized，说明无权限，需要登录，但注册用户是不用登录的，所以就需要注册用户的请求无需身份验证：</p> 
<p>修改WebSecurityConfig配置类，重写configure(HttpSecurity http)方法，配置允许注册用户的请求访问：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>HttpSecurity http<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        http
                <span class="token punctuation">.</span><span class="token function">authorizeRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span>POST<span class="token punctuation">,</span> <span class="token string">"/add-user"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 允许post请求/add-user，而无需认证</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 所有请求都需要验证</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">formLogin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 使用默认的登录页面</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// post请求要关闭csrf验证,不然访问报错；实际开发中开启，需要前端配合传递其他参数</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>配置允许POST请求/add-user访问后，再在Postman发送请求就可以成功了：</p> 
<p>图片<br> 查看数据库数据，添加的用户密码已加密：</p> 
<p><img src="https://images2.imgbox.com/1e/52/yUYxL5hJ_o.png" alt="图片"></p> 
<p>使用加密密码登录，需要修改CustomUserDetailsService类，之前从数据库拿到明文密码后需要加密，现在数据库里面的密码已经加密了，就不用加密了：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDatailService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//@Autowired</span>
    <span class="token comment">//private PasswordEncoder passwordEncoder;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UserDetails <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token keyword">throws</span> UsernameNotFoundException <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>
                user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token comment">// 数据库密码已加密，不用再加密</span>
                user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                authorities
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>浏览器访问localhost:8080/user，输入zeng/zeng123登录即可。</p> 
<h3><a id="_340"></a>五、密码修改</h3> 
<p>UserInfoMapper.java类中添加更新用户密码操作：</p> 
<pre><code class="prism language-javascript">@Mapper
@Repository
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span>
 <span class="token operator">...</span>
 @<span class="token function">Update</span><span class="token punctuation">(</span><span class="token string">"update user set password = #{newPwd} where username = #{username}"</span><span class="token punctuation">)</span>
    int <span class="token function">updatePwd</span><span class="token punctuation">(</span>String username<span class="token punctuation">,</span> String newPwd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
UserInfoService<span class="token punctuation">.</span>java类中添加更新密码的操作方法：

@Service
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfoService</span> <span class="token punctuation">{<!-- --></span> 
    <span class="token operator">...</span>
    <span class="token keyword">public</span> int <span class="token function">updatePwd</span><span class="token punctuation">(</span>String oldPwd<span class="token punctuation">,</span> String newPwd<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取当前登录用户信息(注意：没有密码的)</span>
        UserDetails principal <span class="token operator">=</span> <span class="token punctuation">(</span>UserDetails<span class="token punctuation">)</span> SecurityContextHolder<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPrincipal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String username <span class="token operator">=</span> principal<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 通过用户名获取到用户信息（获取密码）</span>
        UserInfo userInfo <span class="token operator">=</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">getUserInfoByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 判断输入的旧密码是正确</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span>oldPwd<span class="token punctuation">,</span> userInfo<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 不要忘记加密新密码</span>
            <span class="token keyword">return</span> userInfoMapper<span class="token punctuation">.</span><span class="token function">updatePwd</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>newPwd<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>HelloController.java类增加修改用户密码接口:</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HelloController</span> <span class="token punctuation">{<!-- --></span>    
    <span class="token annotation punctuation">@PutMapping</span><span class="token punctuation">(</span><span class="token string">"/updatePwd"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">updatePwd</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userInfoService<span class="token punctuation">.</span><span class="token function">updatePwd</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"oldPwd"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"newPwd"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>启动程序，因为需要登录，且修改密码请求方式为PUT请求，所以无法使用Postman发起请求，可以使用谷歌浏览器的插件Restlet Client：</p> 
<p>先浏览器输入http://localhost:8080/login登录用户zeng/zeng123:</p> 
<p><img src="https://images2.imgbox.com/7a/c1/MHq8agag_o.png" alt="图片"></p> 
<p>在Restlet Client中进行PUT更新请求：</p> 
<p><img src="https://images2.imgbox.com/a4/2e/YoquujVS_o.png" alt="图片"></p> 
<p>这里更新后，需要重启后就可以使用新密码登录了。</p> 
<p>5.用户角色多对多关系<br> 上面的设置后，能基本实现了身份认证和角色授权了，但还是有一点不足：</p> 
<p>我们前面用户表中，用户和角色是绑定一起，用户就只有一个角色了，但实际上，用户可能拥有多个角色，角色拥有多个用户，是多对多的关系，所以需要重新设置用户表和角色表。<br> 创建普通项目运行<br> IDEA创建一个 Spring Initializr模块项目，名为b-database-manytomany-role，选择Spring Security和web依赖，其他按需选择Lombok、MySQL、JDBC和MyBatis。</p> 
<p>先按照普通项目创建起来正常访问，在pom.xml中，先把Spring Security依赖注释</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>security<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span><span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span><span class="token operator">--</span><span class="token operator">&gt;</span>
</code></pre> 
<p>新建表，主键id全部都是自增。</p> 
<p>用户user2表</p> 
<blockquote> 
 <p>CREATE TABLE <code>user2</code> ( <code>uid</code> int(11) NOT NULL AUTO_INCREMENT,<br> <code>username</code> varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci<br> NULL DEFAULT NULL, <code>password</code> varchar(255) CHARACTER SET utf8<br> COLLATE utf8_general_ci NULL DEFAULT NULL, PRIMARY KEY (<code>uid</code>) USING<br> BTREE ) ENGINE = InnoDB AUTO_INCREMENT = 11 CHARACTER SET = utf8<br> COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;</p> 
</blockquote> 
<p>角色role2表，指定了2个角色</p> 
<blockquote> 
 <p>CREATE TABLE <code>role2</code> ( <code>rid</code> int(11) NOT NULL AUTO_INCREMENT,<br> <code>role</code> varchar(255) CHARACTER SET utf8 COLLATE utf8_general_ci NULL<br> DEFAULT NULL, PRIMARY KEY (<code>rid</code>) USING BTREE ) ENGINE = InnoDB<br> AUTO_INCREMENT = 3 CHARACTER SET = utf8 COLLATE = utf8_general_ci<br> ROW_FORMAT = Dynamic;</p> 
</blockquote> 
<p>用户角色关系user2_role2表</p> 
<blockquote> 
 <p>CREATE TABLE <code>user2_role2</code> ( <code>id</code> int(11) NOT NULL AUTO_INCREMENT,<br> <code>uid</code> int(11) NULL DEFAULT NULL, <code>rid</code> int(11) NULL DEFAULT NULL,<br> PRIMARY KEY (<code>id</code>) USING BTREE ) ENGINE = InnoDB AUTO_INCREMENT = 10<br> CHARACTER SET = utf8 COLLATE = utf8_general_ci ROW_FORMAT = Dynamic;</p> 
</blockquote> 
<p>初始化数据：</p> 
<blockquote> 
 <p>– 添加1个用户 INSERT INTO <code>user2</code> VALUES (1, ‘user’, ‘user123’);</p> 
 <p>– 添加2个角色 INSERT INTO <code>role2</code> VALUES (1, ‘user’); INSERT INTO <code>role2</code> VALUES (2, ‘admin’);</p> 
 <p>– 1个用户,拥有2个角色 INSERT INTO <code>user2_role2</code> VALUES (1, 1, 1); INSERT INTO <code>user2_role2</code> VALUES (2, 1, 2);</p> 
</blockquote> 
<p>使用Navicat可视化表的数据结构为：</p> 
<p><img src="https://images2.imgbox.com/5a/13/XYmlDXKW_o.png" alt="v"></p> 
<p>创建entity实体类</p> 
<p>User类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Integer uid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String username<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String password<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>Role类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Role</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Integer rid<span class="token punctuation">;</span>
    <span class="token keyword">private</span> String role<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建DTO类</p> 
<p>因为用户和角色是多对多关系，需要在用户中含有角色的对象，角色中含有用户的对象，创建DTO类而不再entity类中添加，是因为entity类属性是和表字段一一对应的，一般不推荐在entity类中添加与表字段无关的属性。</p> 
<p>新建dto包，在包下创建如下类：</p> 
<p>UserDTO类</p> 
<p>// 注意，多对多不要用@Data，因为ToString会相互调用，导致死循环</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserDTO</span> <span class="token keyword">extends</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>Role<span class="token punctuation">&gt;</span></span> roles<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>RoleDTO类（目前用不到，可不建）</p> 
<p>// 注意，多对多不要用@Data，因为ToString会相互调用，导致死循环</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Setter</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RoleDTO</span> <span class="token keyword">extends</span> <span class="token class-name">Role</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> Set<span class="token generics function"><span class="token punctuation">&lt;</span>User<span class="token punctuation">&gt;</span></span> users<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加UserMapper.java类</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Mapper</span>
<span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">UserMapper</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 查询用户</span>
    UserDTO <span class="token function">selectUserByUsername</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> String username<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>UserMapper.xml。因为需要关联查询，所有使用xml方式</p> 
<pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">?</span>xml version<span class="token operator">=</span><span class="token string">"1.0"</span> encoding<span class="token operator">=</span><span class="token string">"UTF-8"</span> <span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE mapper PUBLIC <span class="token string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="token string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span> <span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>mapper namespace<span class="token operator">=</span><span class="token string">"com.example.bdatabasemanytomanyrole.mapper.UserMapper"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>resultMap id<span class="token operator">=</span><span class="token string">"userRoleMap"</span> type<span class="token operator">=</span><span class="token string">"com.example.bdatabasemanytomanyrole.dto.UserDTO"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>id property<span class="token operator">=</span><span class="token string">"uid"</span> column<span class="token operator">=</span><span class="token string">"uid"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">"username"</span> column<span class="token operator">=</span><span class="token string">"username"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">"password"</span> column<span class="token operator">=</span><span class="token string">"password"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>collection property<span class="token operator">=</span><span class="token string">"roles"</span> ofType<span class="token operator">=</span><span class="token string">"com.example.bdatabasemanytomanyrole.dto.RoleDTO"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>id property<span class="token operator">=</span><span class="token string">"rid"</span> column<span class="token operator">=</span><span class="token string">"rid"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>result property<span class="token operator">=</span><span class="token string">"role"</span> column<span class="token operator">=</span><span class="token string">"role"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>result<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>collection<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>resultMap<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>select id<span class="token operator">=</span><span class="token string">"selectUserByUsername"</span> resultMap<span class="token operator">=</span><span class="token string">"userRoleMap"</span><span class="token operator">&gt;</span>
        select user2<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> user2<span class="token punctuation">.</span>username<span class="token punctuation">,</span> user2<span class="token punctuation">.</span>password<span class="token punctuation">,</span> role2<span class="token punctuation">.</span>rid<span class="token punctuation">,</span> role2<span class="token punctuation">.</span>role
        from user2<span class="token punctuation">,</span> user2_role2<span class="token punctuation">,</span> role2
        where user2<span class="token punctuation">.</span>username<span class="token operator">=</span>#<span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span> 
        and user2<span class="token punctuation">.</span>uid <span class="token operator">=</span> user2_role2<span class="token punctuation">.</span>uid 
        and user2_role2<span class="token punctuation">.</span>rid <span class="token operator">=</span> role2<span class="token punctuation">.</span>rid
    <span class="token operator">&lt;</span><span class="token operator">/</span>select<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>mapper<span class="token operator">&gt;</span>
</code></pre> 
<p>UserService.java</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserMapper userMapper<span class="token punctuation">;</span>

    <span class="token keyword">public</span> UserDTO <span class="token function">getUser</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userMapper<span class="token punctuation">.</span><span class="token function">selectUserByUsername</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>UserController.java</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> UserDTO <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>上面完成后，启动项目，访问localhost:8080/get-user?username=user，查询到的用户信息为：</p> 
<p><img src="https://images2.imgbox.com/a3/c9/ZeGtxDhs_o.png" alt="图片"></p> 
<p>引入Spring Security安全验证<br> 把pom.xml中的Spring Security依赖注释去掉：</p> 
<pre><code class="prism language-java"><span class="token generics function"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics function"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>boot<span class="token operator">-</span>starter<span class="token operator">-</span>security<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre> 
<p>此时，再重新启动程序，访问localhost:8080/get-user?username=user时，会跳转到登录页面。此时默认的登录用户名为user，密码在启动时打印在控制台。</p> 
<p>从数据库中获取用户、密码进行登录：</p> 
<p>添加MyUserDetailsService.java，实现UserDetailsService，重写loadUserByUsername方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyUserDetailsService</span> <span class="token keyword">implements</span> <span class="token class-name">UserDetailsService</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> UserDetails <span class="token function">loadUserByUsername</span><span class="token punctuation">(</span>String username<span class="token punctuation">)</span> <span class="token keyword">throws</span> UsernameNotFoundException <span class="token punctuation">{<!-- --></span>
        UserDTO user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token string">"用户不存在"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 添加用户拥有的多个角色</span>
        List<span class="token generics function"><span class="token punctuation">&lt;</span>GrantedAuthority<span class="token punctuation">&gt;</span></span> grantedAuthorities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token operator">&lt;</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Set<span class="token generics function"><span class="token punctuation">&lt;</span>Role<span class="token punctuation">&gt;</span></span> roles <span class="token operator">=</span> user<span class="token punctuation">.</span><span class="token function">getRoles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Role role <span class="token operator">:</span> roles<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            grantedAuthorities<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SimpleGrantedAuthority</span><span class="token punctuation">(</span><span class="token string">"ROLE_"</span> <span class="token operator">+</span> role<span class="token punctuation">.</span><span class="token function">getRole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span>
                user<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             <span class="token comment">// 数据库中密码没加密，需加密</span>
                <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                grantedAuthorities
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>添加WebSecurityConfig.java，继承WebSecurityConfigurerAdapter，重写configure(AuthenticationManagerBuilder auth)方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfig</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> MyUserDetailsService userDetailsService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> PasswordEncoder <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>        
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span>AuthenticationManagerBuilder auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> Exception <span class="token punctuation">{<!-- --></span>
        auth
                <span class="token punctuation">.</span><span class="token function">userDetailsService</span><span class="token punctuation">(</span>userDatailService<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重新启动，可以使用user/user123登录了。</p> 
<p>查看登录用户信息<br> 要查看登录用户信息，我们可以在UserController中添加方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserController</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> UserService userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-user"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> UserDTO <span class="token function">getUser</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> String username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> userService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span>username<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 查看登录用户信息
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/get-auth"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> Authentication <span class="token function">getAuth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> SecurityContextHolder<span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>重新启动登录后，访问localhost:8080/get-auth，返回：<br> <img src="https://images2.imgbox.com/ec/05/MOG1Rf0h_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>以上就是本篇文章的有关内容</p> 
</blockquote> 
<p>骚等别划走，恰饭时间~<br> <img src="https://images2.imgbox.com/f2/8a/nE6OV0br_o.png" alt="在这里插入图片描述"></p> 
<p><font color="red">给大家放波福利，博主最近在搞阿里云推广，</font></p> 
<p><font color="red">活动折扣价：全网最低价87元/年，261元/3年，比学生9.9每月还便宜（舒服的一匹）<br> 新用户可以入手试试，有一台属于自己的服务器，前期用来部署和学习都很方便</font></p> 
<p>阿里云 【<a href="https://www.aliyun.com/minisite/goods?userCode=d8tcn0bz" rel="nofollow">点击购买</a>】<br> <img src="https://images2.imgbox.com/f3/b7/FQM8n4Al_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8e8fb10290c199aa4410eb5916baae32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">hex、bin增加CRC32校验</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9928269a43fa4e386528c5b7280dbf30/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">UML模型图</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>