<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mysql高可用管理-MySQL 部署PXC集群 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mysql高可用管理-MySQL 部署PXC集群" />
<meta property="og:description" content="MySQL 部署PXC集群 PXC集群概述 PXC介绍 Percona XtraDB Cluster（简称PXC）
—— 是基于Galera的MySQL高可用集群解决方案
—— Galera Cluster是Codership公司开发的一套免费开源的高可用方案
—— PXC集群主要由两部分组成：Percona Server with XtraDB（数据存储插件）和 Write Set Replication patches（同步、多主复制插件）
—— 官网：http://galeracluster.com
PXC特点 具体如下
—— 数据强一致性，无同步延迟（写入主服务器的数据，所有从服务器必须马上也得有）
—— 没有主从切换操作，无需使用虚拟IP（无需一主多从的结构，无需vip地址）
—— 支持InnoDB存储引擎
—— 多线程复制（多线程同步工作）
—— 部署使用简单
—— 支持节点自动加入，无需手动拷贝数据（服务器会自动同步宕机期间的数据，无需手动配置）
————————————————
相应端口 服务端口
端口
说明
3306
数据库服务端口
4444
SST 端口
4567
集群通信端口
4568
IST 端口
SST
State Snapshot Transfer 全量同步
IST
Incremental State Transfer 增量同步
注：集群通信端口是指集群中各服务器之间通信的端口；数据库服务端口3306和集群通信端口4567是每时每刻都开放的；
SST 端口4444和IST 端口4568只有在做数据同步的时候才会开放
主机角色 三台服务器
主机名" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/9e9175c297949329f4b1a21c6f1146eb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-27T11:22:21+08:00" />
<meta property="article:modified_time" content="2023-04-27T11:22:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mysql高可用管理-MySQL 部署PXC集群</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>MySQL 部署PXC集群</h2> 
<h3 id="PXC%E9%9B%86%E7%BE%A4%E6%A6%82%E8%BF%B0">PXC集群概述</h3> 
<h4 id="PXC%E4%BB%8B%E7%BB%8D">PXC介绍</h4> 
<p>Percona XtraDB Cluster（简称PXC）</p> 
<p>—— 是基于Galera的MySQL高可用集群解决方案</p> 
<p>—— Galera Cluster是Codership公司开发的一套免费开源的高可用方案</p> 
<p>—— PXC集群主要由两部分组成：Percona Server with XtraDB（数据存储插件）和 Write Set Replication patches（同步、多主复制插件）</p> 
<p>—— 官网：http://galeracluster.com</p> 
<h4>PXC特点</h4> 
<p><br> 具体如下</p> 
<p>—— 数据强一致性，无同步延迟（写入主服务器的数据，所有从服务器必须马上也得有）</p> 
<p>—— 没有主从切换操作，无需使用虚拟IP（无需一主多从的结构，无需vip地址）</p> 
<p>—— 支持InnoDB存储引擎</p> 
<p>—— 多线程复制（多线程同步工作）</p> 
<p>—— 部署使用简单</p> 
<p>—— 支持节点自动加入，无需手动拷贝数据（服务器会自动同步宕机期间的数据，无需手动配置）<br> ————————————————</p> 
<h4 id="%E7%9B%B8%E5%BA%94%E7%AB%AF%E5%8F%A3">相应端口</h4> 
<ul><li> <p>服务端口</p> 
  <table><tbody><tr><td> <p>端口</p> </td><td> <p>说明</p> </td></tr><tr><td> <p>3306</p> </td><td> <p>数据库服务端口</p> </td></tr><tr><td> <p>4444</p> </td><td> <p><a href="https://so.csdn.net/so/search?q=SST&amp;spm=1001.2101.3001.7020" title="SST">SST</a> 端口</p> </td></tr><tr><td> <p>4567</p> </td><td> <p>集群通信端口</p> </td></tr><tr><td> <p>4568</p> </td><td> <p>IST 端口</p> </td></tr><tr><td> <p>SST</p> </td><td> <p>State Snapshot Transfer 全量同步</p> </td></tr><tr><td> <p>IST</p> </td><td> <p>Incremental State Transfer 增量同步</p> </td></tr></tbody></table></li><li> <p>注：集群通信端口是指集群中各服务器之间通信的端口；数据库服务端口3306和集群通信端口4567是每时每刻都开放的；</p> <p>SST 端口4444和IST 端口4568只有在做数据同步的时候才会开放</p> </li></ul> 
<h4 id="%E4%B8%BB%E6%9C%BA%E8%A7%92%E8%89%B2">主机角色</h4> 
<ul><li> <p>三台服务器</p> </li><li> 
  <table><tbody><tr><td> <p>主机名</p> </td><td> <p>IP地址</p> </td><td> <p>角色</p> </td></tr><tr><td> <p>pxcnode71</p> </td><td> <p>192.168.233.71</p> </td><td> <p>数据库服务器</p> </td></tr><tr><td> <p>pxcnode72</p> </td><td> <p>192.168.233.72</p> </td><td> <p>数据库服务器</p> </td></tr><tr><td> <p>pxcnode73</p> </td><td> <p>192.168.233.73</p> </td><td> <p>数据库服务器</p> </td></tr></tbody></table></li></ul> 
<h4>配置防火墙与selinux</h4> 
<blockquote> 
 <p><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT</code></p> 
 <p><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 4444 -j ACCEPT</code></p> 
 <p><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 4567 -j ACCEPT</code></p> 
 <p><code>-A INPUT -p tcp -m state --state NEW -m tcp --dport 4568 -j ACCEPT</code></p> 
 <p><code>关闭selunix</code></p> 
</blockquote> 
<h4 id="%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E5%90%8D%E5%8F%8A%E6%98%A0%E5%B0%84%E5%85%B3%E7%B3%BB">配置主机名及映射关系</h4> 
<ul><li> <p>PXC集群各主机之间是通过主机名进行通信连接的。</p> </li></ul> 
<p>1、修改主机名</p> 
<p>主机192.168.233.71：</p> 
<blockquote> 
 <p>[root@host71 ~]# echo pxcnode71 &gt; /etc/hostname</p> 
 <p>[root@host71 ~]# hostname pxcnode71</p> 
 <p>[root@host71 ~]# exit</p> 
</blockquote> 
<p>主机192.168.233.72：</p> 
<blockquote> 
 <p>[root@host72 ~]# echo pxcnode72 &gt; /etc/hostname</p> 
 <p>[root@host72 ~]# hostname pxcnode72</p> 
 <p>[root@host72 ~]# exit</p> 
</blockquote> 
<p>主机192.168.233.73：</p> 
<blockquote> 
 <p>[root@host73 ~]# echo pxcnode73 &gt; /etc/hostname</p> 
 <p>[root@host73 ~]# hostname pxcnode73</p> 
 <p>[root@host73 ~]# exit</p> 
</blockquote> 
<p>2、做主机名与IP地址的映射关系</p> 
<p>主机192.168.233.71：</p> 
<blockquote> 
 <p>[root@pxcnode71 ~]# vim /etc/hosts</p> 
 <p>192.168.233.71 pxcnode1</p> 
 <p>192.168.233.72 pxcnode2</p> 
 <p>192.168.233.73 pxcnode3</p> 
</blockquote> 
<p>主机192.168.233.72：</p> 
<blockquote> 
 <p>[root@pxcnode72 ~]# vim /etc/hosts</p> 
 <p>192.168.233.71 pxcnode1</p> 
 <p>192.168.233.72 pxcnode2</p> 
 <p>192.168.233.73 pxcnode3</p> 
</blockquote> 
<p>主机192.168.233.73：</p> 
<blockquote> 
 <p>[root@pxcnode73 ~]# vim /etc/hosts</p> 
 <p>192.168.233.71 pxcnode1</p> 
 <p>192.168.233.72 pxcnode2</p> 
 <p>192.168.233.73 pxcnode3</p> 
</blockquote> 
<p>3、验证映射关系</p> 
<p>主机192.168.233.71：</p> 
<p>[root@pxcnode71 ~]# ping -c 2 pxcnode2</p> 
<p><img alt="" height="127" src="https://images2.imgbox.com/13/7c/qSX9XmzT_o.png" width="653"></p> 
<p>[root@pxcnode71 ~]# ping -c 2 pxcnode3</p> 
<p><img alt="" height="126" src="https://images2.imgbox.com/60/57/sv00T5bG_o.png" width="658"></p> 
<p></p> 
<p>//如图所示：能通过主机名ping通，说明主机名与IP地址的映射关系配置cheng'g</p> 
<p>主机192.168.233.72：</p> 
<blockquote> 
 <p>[root@pxcnode72 ~]# ping -c 2 pxcnode1</p> 
 <p>[root@pxcnode72 ~]# ping -c 2 pxcnode3</p> 
 <p>主机192.168.233.73：</p> 
 <p>[root@pxcnode73 ~]# ping -c 2 pxcnode1</p> 
 <p>[root@pxcnode73 ~]# ping -c 2 pxcnode2</p> 
</blockquote> 
<h3 id="%E9%83%A8%E7%BD%B2PXC">部署PXC</h3> 
<h4 id="%E5%AE%89%E8%A3%85%E8%BD%AF%E4%BB%B6"><a name="t8"></a>安装软件</h4> 
<p>软件介绍</p> 
<ol><li><code>compat-readline5-5.2-17.4.x86_64.rpm</code></li><li><code>libev4-4.15-7.1.x86_64.rpm</code></li><li><code>numactl-2.0.9-2.el6.x86_64.rpm</code></li><li><code>percona-xtrabackup-24-2.4.12-1.el6.x86_64.rpm</code></li><li><code>Percona-XtraDB-Cluster-57-5.7.23-31.31.2.el6.x86_64.rpm</code></li><li><code>Percona-XtraDB-Cluster-client-57-5.7.23-31.31.2.el6.x86_64.rpm</code></li><li><code>Percona-XtraDB-Cluster-devel-57-5.7.23-31.31.2.el6.x86_64.rpm</code></li><li><code>Percona-XtraDB-Cluster-server-57-5.7.23-31.31.2.el6.x86_64.rpm</code></li><li><code>Percona-XtraDB-Cluster-shared-57-5.7.23-31.31.2.el6.x86_64.rpm</code></li><li><code>qpress-11-1.el6.x86_64.rpm</code></li><li><code>socat-1.7.2.4-1.el6.rf.x86_64.rpm</code></li></ol> 
<p>软件作用</p> 
<blockquote> 
 <p>percona-xtrabackup-24-2.4.13-1.el7.x86_64.rpm</p> 
</blockquote> 
<p>在线热备程序</p> 
<blockquote> 
 <p>qpress.1.1-14.11.x86_64.rpm</p> 
</blockquote> 
<p>递归压缩程序</p> 
<blockquote> 
 <p>Percona-XtraDB-Cluster-5.7.25-31.35-r463-el7-x86_64-bundle.tar</p> 
</blockquote> 
<p>集群服务程序</p> 
<p>软件下载</p> 
<p>—— percona-xtrabackup-24-2.4.13-1.el7.x86_64.rpm 下载地址</p> 
<p>https://www.percona.com/downloads/Percona-XtraBackup-2.4/LATEST/</p> 
<p>—— qpress.1.1-14.11.x86_64.rpm 下载地址</p> 
<p>RPM Search qpress</p> 
<p>—— Percona-XtraDB-Cluster-5.7.25-31.35-r463-el7-x86_64-bundle.tar 下载地址</p> 
<p>https://www.percona.com/downloads/Percona-XtraDB-Cluster-57/LATEST/</p> 
<p>安装软件</p> 
<p>—— 三台服务器分别安装</p> 
<p>—— 这三个软件包有依赖关系，安装时注意安装顺序</p> 
<p>将下载好的软件包上传到Linux操作系统上<br> 主机192.168.233.71：</p> 
<p><img alt="" height="232" src="https://images2.imgbox.com/2e/d1/wXfWlZfg_o.png" width="563"></p> 
<blockquote> 
 <p>[root@pxcnode71 ~]# yum -y install libev      //安装依赖</p> 
 <p>[root@pxcnode71 ~]# yum -y install percona-xtrabackup-24-2.4.13-1.el7.x86_64.rpm</p> 
</blockquote> 
<p>[root@pxcnode71 ~]# wget ftp://ftp.pbone.net/mirror/ftp5.gwdg.de/pub/opensuse/repositories/home%3A/AndreasStieger%3A/branches%3A/Archiving/RedHat_RHEL-6/x86_64/qpress-1.1-14.11.x86_64.rpm  </p> 
<blockquote> 
 <p>[root@pxcnode71 ~]# rpm -ivh qpress-1.1-14.11.x86_64.rpm      //安装依赖</p> 
</blockquote> 
<p>[root@pxcnode71 ~]# tar -xvf Percona-XtraDB-Cluster-5.7.25-31.35-r463-el7-x86_64-bundle.tar</p> 
<p><img alt="" height="181" src="https://images2.imgbox.com/d4/58/J4BKRwss_o.png" width="630"></p> 
<p>//注：主机71、72、73并没有安装数据库服务软件mysql，数据服务存储的软件是由就集群里面的软件Percona-XtraDB-Cluster-server-57-5.7.25-31.35.1.el7.x86_64.rpm提供的。</p> 
<blockquote> 
 <p>[root@pxcnode71 ~]# yum -y install Percona-XtraDB-Cluster-*.rpm</p> 
</blockquote> 
<p>注：主机192.168.233.72 和 主机192.168.233.73 都需要安装以上软件，步骤如上所示。</p> 
<h4>配置服务</h4> 
<p></p> 
<p>标准配置文件配置如下：方案1：</p> 
<blockquote> 
 <p><code>vim /etc/my.cnf</code></p> 
 <p><code>[client]</code></p> 
 <p><code>port=3306</code></p> 
 <p><code>socket = /tmp/mysql.sock</code></p> 
 <p></p> 
 <p><code>[mysqld]</code></p> 
 <p><code>server-id=1</code></p> 
 <p><code>port=3306</code></p> 
 <p><code>datadir=/data/database/mysql</code></p> 
 <p><code>socket=/tmp/mysql.sock</code></p> 
 <p><code>log-error=/var/run/mysqld/mysqld.log</code></p> 
 <p><code>pid-file=/var/run/mysqld/mysqld.pid</code></p> 
 <p><code>user=mysql</code></p> 
 <p></p> 
 <p><code># General</code></p> 
 <p><code>back_log=2000</code></p> 
 <p><code>connect_timeout=15</code></p> 
 <p><code>skip_name_resolve=ON</code></p> 
 <p><code>max_connections=5000</code></p> 
 <p><code>table_definition_cache=2000</code></p> 
 <p><code>table_open_cache=10000</code></p> 
 <p><code>metadata_locks_hash_instances=256</code></p> 
 <p><code>ssl=0</code></p> 
 <p><code>core_file</code></p> 
 <p></p> 
 <p><code># Innodb</code></p> 
 <p><code>innodb_buffer_pool_size = 10240M</code></p> 
 <p><code>innodb_buffer_pool_instances=8</code></p> 
 <p><code>innodb_log_file_size = 1024M</code></p> 
 <p><code>innodb_log_buffer_size = 16M</code></p> 
 <p><code>innodb_lock_wait_timeout = 20</code></p> 
 <p><code>innodb_autoinc_lock_mode=2</code></p> 
 <p><code>innodb_read_io_threads = 5</code></p> 
 <p><code>innodb_write_io_threads = 5</code></p> 
 <p><code>innodb_thread_concurrency = 8</code></p> 
 <p><code>innodb_doublewrite=1</code></p> 
 <p><code>innodb_flush_log_at_trx_commit = 2</code></p> 
 <p><code>innodb_flush_method = 'O_DIRECT'</code></p> 
 <p><code>innodb-page-cleaners=8</code></p> 
 <p><code>innodb_purge_threads=4</code></p> 
 <p><code>innodb_lru_scan_depth=2048</code></p> 
 <p><code>innodb_io_capacity=8000</code></p> 
 <p><code>innodb_io_capacity_max=16000</code></p> 
 <p><code>innodb_adaptive_hash_index=OFF</code></p> 
 <p><code>innodb-change-buffering=none</code></p> 
 <p><code>innodb_flush_neighbors=0</code></p> 
 <p><code>innodb_max_dirty_pages_pct = 90</code></p> 
 <p><code>innodb_max_dirty_pages_pct_lwm = 10</code></p> 
 <p></p> 
 <p><code># Binlog</code></p> 
 <p><code>relay-log=relay-1</code></p> 
 <p><code>binlog_format=ROW</code></p> 
 <p><code>enforce-gtid-consistency</code></p> 
 <p><code>gtid-mode=on</code></p> 
 <p><code>master-info-repository=TABLE</code></p> 
 <p><code>relay-log-info-repository=TABLE</code></p> 
 <p><code>binlog-checksum=NONE</code></p> 
 <p><code>log-bin</code></p> 
 <p><code>log_slave_updates</code></p> 
 <p><code>expire_logs_days=3</code></p> 
 <p><code>sync_binlog=1</code></p> 
 <p></p> 
 <p><code># Monitoring</code></p> 
 <p><code>innodb_monitor_enable='%'</code></p> 
 <p><code>performance_schema=ON</code></p> 
 <p><code>performance_schema_instrument='%synch%=on'</code></p> 
 <p></p> 
 <p><code># Galera</code></p> 
 <p><code>symbolic-links=0</code></p> 
 <p><code>explicit_defaults_for_timestamp=true</code></p> 
 <p><code>wsrep_provider=/usr/lib64/galera3/libgalera_smm.so</code></p> 
 <p><code>wsrep_cluster_address=gcomm://30.0.0.196,30.0.0.198,30.0.0.199</code></p> 
 <p><code>default_storage_engine=InnoDB</code></p> 
 <p><code>wsrep_slave_threads= 20</code></p> 
 <p><code>wsrep_log_conflicts</code></p> 
 <p><code>wsrep_cluster_name=pxc-cluster</code></p> 
 <p><code>wsrep_node_name=pxc3</code></p> 
 <p><code>wsrep_node_address=30.0.0.196</code></p> 
 <p><code>pxc_strict_mode=ENFORCING</code></p> 
 <p><code>wsrep_sst_method=xtrabackup-v2</code></p> 
 <p><code>wsrep_sst_auth="sstuser:s3cret"</code></p> 
</blockquote> 
<p></p> 
<p>差异化配置：</p> 
<blockquote> 
 <ol><li><code># 需要根据相应的节点配置</code></li><li><code>server-id=1</code></li><li><code>wsrep_node_name=pxc3</code></li><li><code>wsrep_node_address=30.0.0.196</code></li></ol> 
</blockquote> 
<p>配置数据目录：</p> 
<pre></pre> 
<ol><li><code>mkdir -p /data/database/mysql</code></li><li><code>chown mysql:mysql -R /data/database/mysql</code></li></ol> 
<p></p> 
<p></p> 
<p><br> 相关配置文件</p> 
<p>—— /etc/percona-xtradb-cluster.conf.d        //所在目录</p> 
<p>配置文件说明</p> 
<p>—— mysqld.cnf                //数据库服务运行参数配置文件</p> 
<p>—— mysqld_safe.cnf        //Percona Server 5.7配置文件</p> 
<p>—— wsrep.cnf                  //PXC集群配置文件</p> 
<p>[root@pxcnode71 ~]# cd /etc/percona-xtradb-cluster.conf.d/</p> 
<p>[root@pxcnode71 percona-xtradb-cluster.conf.d]# ls</p> 
<p>mysqld.cnf  mysqld_safe.cnf  wsrep.cnf</p> 
<p>修改数据库服务运行参数配置文件</p> 
<p>—— mysqld.cnf（3台数据库服务器都要配置）</p> 
<p>—— 重要配置项说明</p> 
<p>重要配置项说明</p> 
<p>[mysqld]</p> 
<p>server-id=1                                                 #server-id 不允许重复        </p> 
<p>datadir=/var/lib/mysql                               #数据库目录的路径</p> 
<p>socket=/var/lib/mysql/mysql.sock             #socker文件的路径</p> 
<p>log-error=/var/log/mysqld.log                  #日志文件的路径</p> 
<p>pid-file=/var/run/mysqld/mysqld.pid       #pid文件的路径</p> 
<p>log-bin                                                       #默认启用binlog日志</p> 
<p>log_slave_updates                                     #启用链式复制</p> 
<p>expire_logs_days=7                                   #日志文件保留天数，默认日志文件保留7天</p> 
<p>修改配置文件</p> 
<p>[root@pxcnode71 percona-xtradb-cluster.conf.d]# vim mysqld.cnf</p> 
<p>server-id=71       //修改配置文件第7行server-id</p> 
<p><img alt="" height="307" src="https://images2.imgbox.com/b4/13/5HyvvUKF_o.png" width="728"></p> 
<p>//如图所示，图中红圈圈起来的地方是要修改的内容</p> 
<p>[root@pxcnode72 percona-xtradb-cluster.conf.d]# vim mysqld.cnff</p> 
<p>server-id=72       //修改配置文件第7行server-id</p> 
<p>[root@pxcnode73 percona-xtradb-cluster.conf.d]# vim mysqld.cnf</p> 
<p>server-id=73       //修改配置文件第7行server-id</p> 
<p>修改 Percona Server 5.7 配置文件</p> 
<p>—— mysqld_safe.cnf</p> 
<p>—— 重要配置项说明</p> 
<p>—— 3台数据库服务器，使用默认配置即可</p> 
<p>重要配置项说明</p> 
<p>[mysqld_safe]</p> 
<p>pid-file = /var/run/mysqld/mysqld.pid      #pid文件位置及名称</p> 
<p>socket   = /var/lib/mysql/mysql.sock         #socket文件位置及名称</p> 
<p>修改PXC集群配置文件</p> 
<p>—— wsrep.cnf（3台数据库服务器都配置）</p> 
<p>—— 重要配置项说明</p> 
<p>重要配置项说明</p> 
<p>wsrep_cluster_address=gcomm://             #集群成员列表，3台必须相同</p> 
<p>wsrep_node_address=192.168.70.63         #本机IP地址</p> 
<p>wsrep_cluster_name=pxc-cluster              #集群名称，可自定义，3台必须相同</p> 
<p>wsrep_node_name=pxc-cluster-node       #本机主机名</p> 
<p>wsrep_sst_auth="sstuser:s3cretPass"         #SST数据同步用户授权，3台必须相同</p> 
<p>修改配置文件</p> 
<p>主机192.168.233.71：</p> 
<blockquote> 
 <p>[root@pxcnode71 percona-xtradb-cluster.conf.d]# vim wsrep.cnf</p> 
 <p>wsrep_cluster_address=gcomm://192.168.233.71,192.168.233.72,192.168.233.73</p> 
 <p>wsrep_node_address=192.168.233.71</p> 
 <p>wsrep_cluster_name=pxccluster</p> 
 <p>wsrep_node_name=pxcnode71</p> 
 <p>wsrep_sst_auth="sstuser:123qqq...A"</p> 
</blockquote> 
<p><img alt="" height="723" src="https://images2.imgbox.com/b2/5f/YYQEgkRQ_o.png" width="731"></p> 
<p>//如图所示，图中红圈圈起来的地方是要修改的内容</p> 
<p>主机192.168.233.72：</p> 
<blockquote> 
 <p>[root@pxcnode72 percona-xtradb-cluster.conf.d]# vim wsrep.cnf</p> 
 <p> wsrep_cluster_address=gcomm://192.168.233.71,192.168.233.72,192.168.233.73</p> 
 <p>wsrep_node_address=192.168.233.72</p> 
 <p>wsrep_cluster_name=pxccluster</p> 
 <p>wsrep_node_name=pxcnode72</p> 
 <p>wsrep_sst_auth="sstuser:123qqq...A"</p> 
</blockquote> 
<p>主机192.168.233.73：</p> 
<blockquote> 
 <p>[root@pxcnode73 percona-xtradb-cluster.conf.d]# vim wsrep.cnf</p> 
 <p> wsrep_cluster_address=gcomm://192.168.233.71,192.168.233.72,192.168.233.73</p> 
 <p>wsrep_node_address=192.168.233.73</p> 
 <p>wsrep_cluster_name=pxccluster</p> 
 <p>wsrep_node_name=pxcnode73</p> 
 <p>wsrep_sst_auth="sstuser:123qqq...A"</p> 
</blockquote> 
<h4>启动服务</h4> 
<p>启动初始化方案1：<br> 在1台服务器上执行即可（192.168.233.71）</p> 
<p>—— 启动集群服务</p> 
<p>—— 添加授权用户</p> 
<blockquote> 
 <p>[root@pxcnode71 ~]# systemctl start mysql@bootstrap.service     //启动集群服务</p> 
</blockquote> 
<p>[root@pxcnode71 ~]# ls /var/lib/mysql       //启动服务后数据初始化结束，数据库目录就有数据了</p> 
<p><img alt="" height="126" src="https://images2.imgbox.com/4f/ec/lSg0sUtC_o.png" width="682"></p> 
<p>启动初始化方案2 ：</p> 
<blockquote> 
 <p>启动第一个节点</p> 
 <ol><li><code>/etc/init.d/mysql bootstrap-pxc</code></li></ol> 
 <p>或者这样：</p> 
 <pre></pre> 
 <ol><li><code># 初始化</code></li><li><code>/usr/sbin/mysqld --defaults-file=/etc/my.cnf --initialize --datadir=/data/database/mysql --user=mysql</code></li><li><code># 启动</code></li><li><code>/usr/bin/mysqld_safe --defaults-file=/etc/my.cnf --wsrep-new-cluster &amp;</code></li></ol> 
</blockquote> 
<p>[root@pxcnode71 ~]# grep pass /var/log/mysqld.log       //查看数据库初始密码</p> 
<p>2022-01-15T07:53:29.086066Z 1 [Note] A temporary password is generated for root@localhost: g3C6sjr-hAw;</p> 
<p>[root@pxcnode71 ~]# mysql -uroot -p'g3C6sjr-hAw;'      //使用初始密码登录</p> 
<blockquote> 
 <p>mysql&gt; alter user root@"localhost" identified by "123456";        //修改登录密码，数据会自动同步到主机72和73上</p> 
</blockquote> 
<p>mysql&gt; grant reload,lock tables,replication client,process on *.* to sstuser@"localhost" identified by "123qqq...A";   </p> 
<p>//添加授权用户，数据会自动同步到主机72和73上。reload装载数据的权限；lock tables锁表的权限；replication client查看服务状态的权限；process管理服务的权限（查看进程信息）；授权用户和密码必须是配置文件中指定的。</p> 
<p>在其他2台服务器上执行</p> 
<p>—— 启动数据库服务</p> 
<p>—— 会自动同步71主机的授权用户及管理员root密码</p> 
<blockquote> 
 <p>[root@pxcnode72 ~]# systemctl start mysql       //启动数据库服务</p> 
 <p>[root@pxcnode73 ~]# systemctl start mysql       //启动数据库服务</p> 
</blockquote> 
<p>服务端口</p> 
<p>—— 在所有服务器上查看</p> 
<blockquote> 
 <p>—— ]# netstat -lntup | grep 3306</p> 
 <p>—— ]# netstat -lntup | grep 4567</p> 
</blockquote> 
<p>主机192.168.233.71：</p> 
<p>[root@pxcnode71 ~]# netstat -lntup | grep 3306</p> 
<p>tcp6       0      0 :::3306                 :::*                    LISTEN      8919/mysqld        </p> 
<p>[root@pxcnode71 ~]# netstat -lntup | grep 4567</p> 
<p>tcp        0      0 0.0.0.0:4567            0.0.0.0:*               LISTEN      8919/mysqld</p> 
<p>主机192.168.233.72：</p> 
<p>[root@pxcnode72 ~]# netstat -lntup | grep 3306</p> 
<p>tcp6       0      0 :::3306                 :::*                    LISTEN      59729/mysqld       </p> 
<p>[root@pxcnode72 ~]# netstat -lntup | grep 4567</p> 
<p>tcp        0      0 0.0.0.0:4567            0.0.0.0:*               LISTEN      59729/mysqld</p> 
<p>主机192.168.233.73：</p> 
<p>[root@pxcnode73 ~]# netstat -lntup | grep 3306</p> 
<p>tcp6       0      0 :::3306                 :::*                    LISTEN      58840/mysqld       </p> 
<p>[root@pxcnode73 ~]# netstat -lntup | grep 4567</p> 
<p>tcp        0      0 0.0.0.0:4567            0.0.0.0:*               LISTEN      58840/mysqld</p> 
<h4>测试配置</h4> 
<p>查看集群信息（可在任意一台数据库服务器执行）</p> 
<p>—— 执行SQL命令</p> 
<blockquote> 
 <p>show status like "%wsrep%";</p> 
</blockquote> 
<p>—— 相关参数</p> 
<p>[root@pxcnode71 ~]# mysql -uroot -p123456</p> 
<blockquote> 
 <p>mysql&gt; show status like "%wsrep%";         //输出所有与集群有关的状态</p> 
 <p>查看节点数：</p> 
 <ol><li><code>show global status like 'wsrep_cluster_size';</code></li></ol> 
 <p>查看集群状态：</p> 
 <ol><li><code>show global status like 'wsrep%';</code></li></ol> 
 <p>查看当前节点状态：</p> 
 <ol><li><code>show global status like 'wsrep_cluster_status';</code></li></ol> 
</blockquote> 
<p></p> 
<p><img alt="" height="317" src="https://images2.imgbox.com/fb/b8/PZWwoB2U_o.png" width="689"></p> 
<blockquote> 
 <p>wsrep_incoming_addresses         192.168.233.72:3306,192.168.233.73:3306,192.168.233.71:3306     //成员列表</p> 
 <p>wsrep_cluster_size                       3                     //集群服务器台数                                  </p> 
 <p>wsrep_cluster_status                    Primary          //集群状态                                           </p> 
 <p>wsrep_connected                         ON                 //连接状态                                        </p> 
 <p>wsrep_ready                                 ON                 //服务状态 </p> 
</blockquote> 
<ul><li> <p>测试集群功能</p> </li></ul> 
<p>—— 在任意一台服务器上添加访问数据的授权用户</p> 
<p>—— 在客户端使用授权用户连接任意数据库服务器都可以存储数据，且可以查看到同样的数据</p> 
<p>—— 建表时，必须有主键字段</p> 
<p></p> 
<p>1、在任意一台服务器上添加访问数据的授权用户</p> 
<p>主机192.168.233.71：</p> 
<p>mysql&gt; grant all on db10.* to njw@"%" identified by "123456";       //授权用户会自动添加到主机72和73</p> 
<p>验证主机192.168.233.72授权用户是否同步：</p> 
<blockquote> 
 <p>mysql&gt; show grants for njw@"%";</p> 
 <p><img alt="" height="121" src="https://images2.imgbox.com/2c/fd/5yE7YQwY_o.png" width="444"></p> 
 <p></p> 
 <p></p> 
 <p></p> 
</blockquote> 
<p></p> 
<p>验证主机192.168.233.73授权用户是否同步：</p> 
<p>mysql&gt; show grants for njw@"%";</p> 
<p><img alt="" height="121" src="https://images2.imgbox.com/99/f3/8ZN0bgnE_o.png" width="444"></p> 
<p>2、在客户端使用授权用户连接任意数据库服务器都可以存储数据，且可以查看到同样的数据</p> 
<p>客户端192.168.233.50连接主机192.168.233.71插入数据：</p> 
<p>[root@client50 ~]# mysql -h192.168.233.71 -unjw -p123456</p> 
<p>mysql&gt; create database db10;</p> 
<p>mysql&gt; create table db10.a(id int);</p> 
<p>mysql&gt; insert into db10.a values(71);       //插入数据时报错</p> 
<p>ERROR 1105 (HY000): Percona-XtraDB-Cluster prohibits use of DML command on a table (db10.a) without an explicit primary key with pxc_strict_mode = ENFORCING or MASTER        //报错原因：PXC集群建表时必须创建主键字段，但不一定要为自增长</p> 
<p>mysql&gt; create table db10.b(id int primary key auto_increment,name char(10));      //创建表b设置id字段为主键且自增长</p> 
<p>mysql&gt; insert into db10.b(name) values("bob");</p> 
<p>mysql&gt; insert into db10.b(name) values("tom");</p> 
<p>mysql&gt; insert into db10.b(name) values("lucy");</p> 
<p>mysql&gt; select * from db10.b;  </p> 
<p>//如图所示，发现id字段自增长的步长为3，因为有三台数据库服务器所以步长为3</p> 
<p>mysql&gt; exit</p> 
<p>客户端192.168.233.50连接主机192.168.233.72查询数据同步：</p> 
<p>[root@client50 ~]# mysql -h192.168.233.72 -unjw -p123456</p> 
<p>mysql&gt; insert into db10.b(name) values("jack");      //插入新数据</p> 
<p>mysql&gt; select * from db10.b;        //可以看见主机71上插入的数据</p> 
<p><img alt="" height="161" src="https://images2.imgbox.com/48/50/DaDOFrwp_o.png" width="218"></p> 
<p>//由于是在主机72上插入的数据，可以看出步长的变化。</p> 
<p>mysql&gt; exit</p> 
<p>客户端192.168.233.50连接主机192.168.233.73查询数据同步：</p> 
<p>[root@client50 ~]# mysql -h192.168.233.73 -unjw -p123456</p> 
<p>mysql&gt; select * from db10.b;<br><img alt="" height="160" src="https://images2.imgbox.com/b3/9a/Q3mCb73X_o.png" width="219"></p> 
<p>综上所述，可以在任意一台数据库服务器上插入数据，数据会同步到每一台数据库服务器上。</p> 
<p></p> 
<h4 id="%E6%B5%8B%E8%AF%95%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8">测试集群高可用</h4> 
<ul><li> <p>测试故障自动恢复</p> </li></ul> 
<blockquote> 
 <p>—— 任何一台数据库服务器宕机都不影响用户存取数据</p> 
 <p>—— 服务器运行后自动同步宕机期间的数据</p> 
</blockquote> 
<p>1、模拟数据库服务器192.168.233.73宕机</p> 
<p>[root@pxcnode73~]# netstat -lntup | grep 3306</p> 
<p>tcp6       0      0 :::3306                 :::*                    LISTEN      8919/mysqld</p> 
<p>[root@pxcnode73 ~]# systemctl stop mysql</p> 
<p>[root@pxcnode73 ~]# netstat -lntup | grep 3306       //没有输出结果，表示服务已经关闭</p> 
<p>2、客户端50连接192.168.233.73</p> 
<p>[root@client50 ~]# mysql -h192.168.233.73 -unjw -p123456     //主机73的服务已经关闭，所以无法连接</p> 
<p>mysql: [Warning] Using a password on the command line interface can be insecure.</p> 
<p>ERROR 2003 (HY000): Can't connect to MySQL server on '192.168.233.73' (111)</p> 
<p>3、客户端连接数据库服务器72查看集群状态</p> 
<p>主机192.168.233.50：</p> 
<p>[root@client50 ~]# mysql -h192.168.233.72 -unjw -p123456</p> 
<p>mysql&gt; show status like "%wsrep%";<br><img alt="" height="318" src="https://images2.imgbox.com/0a/9b/2O2P5Obi_o.png" width="548"></p> 
<p> //如图所示：集群数量服务器数量变为2台，正在运行只有192.168.233.71和192.168.233.72</p> 
<p>4、在数据库服务器72上插入数据</p> 
<p>mysql&gt; insert into db10.b(name) values("macka");</p> 
<p>mysql&gt; insert into db10.b(name) values("mackb");</p> 
<p>mysql&gt; insert into db10.b(name) values("mackc");</p> 
<p>mysql&gt; select *from db10.b;<br><img alt="" height="216" src="https://images2.imgbox.com/4f/f1/PFglkMMk_o.png" width="219"></p> 
<p>//如图所示，红圈圈起来的数据为服务器73宕机期间新插入的数据，由于服务器73宕机，只剩下两台服务器，步长与服务器的数量有关，所以新插入的数据自增长的步长为2。</p> 
<p>5、恢复数据库服务器73，并查看集群状态</p> 
<p>[root@pxcnode73 ~]# systemctl start mysql</p> 
<p>[root@pxcnode73 ~]# netstat -lntup | grep 3306</p> 
<p>tcp6 0 0 :::3306 :::* LISTEN 67004/mysqld</p> 
<p>mysql&gt; show status like "%wsrep%";<br><img alt="" height="319" src="https://images2.imgbox.com/a0/ff/ToWsYL0H_o.png" width="689"></p> 
<p></p> 
<p>//如图所示，数据库服务器73也正常运行，集群现在有三台数据库服务器</p> 
<p>6、客户端访问数据库服务器73进行验证</p> 
<p>[root@client50 ~]# mysql -h192.168.233.73 -unjw -p123456</p> 
<p>mysql&gt; select * from db10.b;<br> //如图所示，数据库服务器73已恢复正常，且数据库服务器73在宕机期间新插入的数据，也已经自动同步。</p> 
<p></p> 
<h4>常见错误</h4> 
<p><br> 查看日志信息排查错误</p> 
<p>]# vim /var/log/mysqld.log</p> 
<p>.<img alt="" height="105" src="https://images2.imgbox.com/3b/09/CDONU7IJ_o.png" width="941"></p> 
<p></p> 
<p>failed to open gcomm backend connection: 110</p> 
<p>//如图所示，错误是无法连接</p> 
<p>错误思路</p> 
<p>—— 查看各主机的主机名与ip地址的映射关系</p> 
<p>—— 查看各主机之间 wsrep.cnf 配置文件中集群名称是否一致<br> ————————————————<br> 版权声明：本文为CSDN博主「机佬在线搞机」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。<br> 原文链接：https://blog.csdn.net/N_jw107/article/details/122515433</p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b6bc86d449354225b5d4772f2c2ba5b0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">设置el-table超出高度出现滚动条</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/07966afc3eb0e98860c9d1be94587d74/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端周总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>