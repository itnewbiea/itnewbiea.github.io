<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>FFmpeg 音频重采样 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="FFmpeg 音频重采样" />
<meta property="og:description" content="1.音频重采样 1.1 什么是重采样 所谓的重采样，就是改变⾳频的采样率、sample format、声道数等参数，使之按照我们期望的参数输 出。
1.2 为什么要重采样 原有的⾳频参数不满⾜我们的需求，⽐如在FFmpeg解码⾳频的时候，不同的⾳ 源有不同的格式，采样率等，在解码后的数据中的这些参数也会不⼀致(最新FFmpeg 解码⾳频后，⾳频格 式为AV_SAMPLE_FMT_FLTP，这个参数应该是⼀致的)，如果我们接下来需要使⽤解码后的⾳频数据做 其他操作，⽽这些参数的不⼀致导致会有很多额外⼯作，此时直接对其进⾏重采样，获取我们制定的⾳频 参数，这样就会⽅便很多。
再⽐如在将⾳频进⾏SDL播放时候，因为当前的SDL2.0不⽀持planar格式，也不⽀持浮点型的，⽽最新的 FFMPEG 16年会将⾳频解码为AV_SAMPLE_FMT_FLTP格式，因此此时就需要我们对其重采样，使之可以在SDL2.0上进⾏播放。
1.3 可调节的参数 通过重采样，我们可以对：
sample rate(采样率)sample format(采样格式)channel layout(通道布局，可以通过此参数获取声道数 2.音频重采样参数解析 2.1. 采样率 采样设备每秒抽取样本的次数 nb_samples
2.2. 采样格式(位宽) 每种⾳频格式有不同的量化精度（位宽），位数越多，表示值就越精确，声⾳表现自然就越精准。 FFMpeg中⾳频格式有以下⼏种，每种格式有其占⽤的字节数信息（libavutil/samplefmt.h）：
enum AVSampleFormat { AV_SAMPLE_FMT_NONE = -1, AV_SAMPLE_FMT_U8, ///&lt; unsigned 8 bits AV_SAMPLE_FMT_S16, ///&lt; signed 16 bits AV_SAMPLE_FMT_S32, ///&lt; signed 32 bits AV_SAMPLE_FMT_FLT, ///&lt; float AV_SAMPLE_FMT_DBL, ///&lt; double AV_SAMPLE_FMT_U8P, ///&lt; unsigned 8 bits, planar AV_SAMPLE_FMT_S16P, ///&lt; signed 16 bits, planar AV_SAMPLE_FMT_S32P, ///&lt; signed 32 bits, planar AV_SAMPLE_FMT_FLTP, ///&lt; float, planar AV_SAMPLE_FMT_DBLP, ///&lt; double, planar AV_SAMPLE_FMT_S64, ///&lt; signed 64 bits AV_SAMPLE_FMT_S64P, ///&lt; signed 64 bits, planar AV_SAMPLE_FMT_NB ///&lt; Number of sample formats." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/645b4ccef8f4ef1f52e9e68c9d194423/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-01T23:51:51+08:00" />
<meta property="article:modified_time" content="2023-02-01T23:51:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">FFmpeg 音频重采样</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="1_0"></a>1.音频重采样</h5> 
<h6><a id="11__2"></a>1.1 什么是重采样</h6> 
<p>所谓的重采样，就是改变⾳频的<strong>采样率、sample format、声道数</strong>等参数，使之按照我们期望的参数输 出。</p> 
<h6><a id="12__6"></a>1.2 为什么要重采样</h6> 
<p>原有的⾳频参数不满⾜我们的需求，⽐如在FFmpeg解码⾳频的时候，不同的⾳ 源有不同的格式，采样率等，在解码后的数据中的这些参数也会不⼀致(最新FFmpeg 解码⾳频后，⾳频格 式为AV_SAMPLE_FMT_FLTP，这个参数应该是⼀致的)，如果我们接下来需要使⽤解码后的⾳频数据做 其他操作，⽽<strong>这些参数的不⼀致导致会有很多额外⼯作，此时直接对其进⾏重采样，获取我们制定的⾳频 参数，这样就会⽅便很多。</strong></p> 
<p>再⽐如在将⾳频进⾏SDL播放时候，<strong>因为当前的SDL2.0不⽀持planar格式，也不⽀持浮点型的</strong>，⽽最新的 FFMPEG 16年会将⾳频解码为AV_SAMPLE_FMT_FLTP格式，因此此时就需要我们对其重采样，使之可以在SDL2.0上进⾏播放。</p> 
<h6><a id="13__12"></a>1.3 可调节的参数</h6> 
<p>通过重采样，我们可以对：</p> 
<ul><li>sample rate(采样率)</li><li>sample format(采样格式)</li><li>channel layout(通道布局，可以通过此参数获取声道数</li></ul> 
<h5><a id="2_20"></a>2.音频重采样参数解析</h5> 
<h6><a id="21__22"></a>2.1. 采样率</h6> 
<p>采样设备每秒抽取样本的次数 nb_samples</p> 
<h6><a id="22__26"></a>2.2. 采样格式(位宽)</h6> 
<p>每种⾳频格式有不同的量化精度（位宽），位数越多，表示值就越精确，声⾳表现自然就越精准。 FFMpeg中⾳频格式有以下⼏种，每种格式有其占⽤的字节数信息（libavutil/samplefmt.h）：</p> 
<pre><code class="prism language-c"><span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> <span class="token punctuation">{<!-- --></span>
    AV_SAMPLE_FMT_NONE <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
    AV_SAMPLE_FMT_U8<span class="token punctuation">,</span>          <span class="token comment">///&lt; unsigned 8 bits</span>
    AV_SAMPLE_FMT_S16<span class="token punctuation">,</span>         <span class="token comment">///&lt; signed 16 bits</span>
    AV_SAMPLE_FMT_S32<span class="token punctuation">,</span>         <span class="token comment">///&lt; signed 32 bits</span>
    AV_SAMPLE_FMT_FLT<span class="token punctuation">,</span>         <span class="token comment">///&lt; float</span>
    AV_SAMPLE_FMT_DBL<span class="token punctuation">,</span>         <span class="token comment">///&lt; double</span>

    AV_SAMPLE_FMT_U8P<span class="token punctuation">,</span>         <span class="token comment">///&lt; unsigned 8 bits, planar</span>
    AV_SAMPLE_FMT_S16P<span class="token punctuation">,</span>        <span class="token comment">///&lt; signed 16 bits, planar</span>
    AV_SAMPLE_FMT_S32P<span class="token punctuation">,</span>        <span class="token comment">///&lt; signed 32 bits, planar</span>
    AV_SAMPLE_FMT_FLTP<span class="token punctuation">,</span>        <span class="token comment">///&lt; float, planar</span>
    AV_SAMPLE_FMT_DBLP<span class="token punctuation">,</span>        <span class="token comment">///&lt; double, planar</span>
    AV_SAMPLE_FMT_S64<span class="token punctuation">,</span>         <span class="token comment">///&lt; signed 64 bits</span>
    AV_SAMPLE_FMT_S64P<span class="token punctuation">,</span>        <span class="token comment">///&lt; signed 64 bits, planar</span>

    AV_SAMPLE_FMT_NB           <span class="token comment">///&lt; Number of sample formats. DO NOT USE if linking dynamically</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>P结尾的是平面格式，否则是交错格式。</p> 
<h6><a id="23_planepacked_55"></a>2.3 分片（plane）和打包（packed）</h6> 
<p>以双声道为例，带P（plane）的数据格式在存储时，<strong>其左声道和右声道的数据是分开存储的</strong>，左声道的数据存储在data[0]，右声道的数据存储在data[1]，每个声道的所占⽤的字节数为linesize[0]和 linesize[1]；</p> 
<p>不带P（packed）的⾳频数据在存储时，是按照LRLRLR…的格式**交替存储在data[0]**中，linesize[0] 表示总的数据量。</p> 
<h6><a id="24_channel_layout_61"></a>2.4 声道分布（channel_layout)</h6> 
<p>声道分布在FFmpeg\libavutil\channel_layout.h中有定义，⼀般来说⽤的⽐较多的是 AV_CH_LAYOUT_STEREO（双声道）和AV_CH_LAYOUT_SURROUND（三声道）定义如下：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_MONO</span>              <span class="token expression"><span class="token punctuation">(</span>AV_CH_FRONT_CENTER<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_STEREO</span>            <span class="token expression"><span class="token punctuation">(</span>AV_CH_FRONT_LEFT<span class="token operator">|</span>AV_CH_FRONT_RIGHT<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_2POINT1</span>           <span class="token expression"><span class="token punctuation">(</span>AV_CH_LAYOUT_STEREO<span class="token operator">|</span>AV_CH_LOW_FREQUENCY<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_2_1</span>               <span class="token expression"><span class="token punctuation">(</span>AV_CH_LAYOUT_STEREO<span class="token operator">|</span>AV_CH_BACK_CENTER<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_SURROUND</span>          <span class="token expression"><span class="token punctuation">(</span>AV_CH_LAYOUT_STEREO<span class="token operator">|</span>AV_CH_FRONT_CENTER<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_3POINT1</span>           <span class="token expression"><span class="token punctuation">(</span>AV_CH_LAYOUT_SURROUND<span class="token operator">|</span>AV_CH_LOW_FREQUENCY<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_4POINT0</span>           <span class="token expression"><span class="token punctuation">(</span>AV_CH_LAYOUT_SURROUND<span class="token operator">|</span>AV_CH_BACK_CENTER<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">AV_CH_LAYOUT_4POINT1</span>           <span class="token expression"><span class="token punctuation">(</span>AV_CH_LAYOUT_4POINT0<span class="token operator">|</span>AV_CH_LOW_FREQUENCY<span class="token punctuation">)</span></span></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<h6><a id="25__77"></a>2.5 ⾳频帧的数据量计算</h6> 
<p>⼀帧⾳频的数据量（字节）=channel数 * nb_samples样本数 * 每个样本占⽤的字节数</p> 
<p>如果该⾳频帧是FLTP格式的PCM数据，包含1024个样本，双声道，那么该⾳频帧包含的⾳频数据量是 2x1024x4=8192字节。</p> 
<p>如果该⾳频帧是AV_SAMPLE_FMT_DBL 格式的PCM数据： 2x1024x8 = 16384 字节。</p> 
<h6><a id="26__87"></a>2.6 音频播放时间计算</h6> 
<p>计算公式：⼀帧播放时间（毫秒） = nb_samples样本数 *1000/采样率</p> 
<p>以采样率44100Hz来计算，每秒44100个sample，而正常⼀帧为1024个sample，可知每帧播放时间/1024=1000ms/44100，得到每帧播放时间=1024*1000/44100=23.2ms （精确值是 23.21995464852608）。</p> 
<p>如果采样率是48000Hz 1024*1000/48000=21.33333333333333ms</p> 
<p>注意：1024*1000/44100=23.21995464852608ms -&gt;约等于 23.2ms，<strong>精度损失了 0.011995464852608ms</strong>，如果累计10万帧，误差&gt;1199毫秒，如果有视频⼀起的就会有音视频同步的问题。 <strong>如果按着23.2去计算pts（0 23.2 46.4 ）就会有累积误差</strong></p> 
<h5><a id="3FFmpegAPI_99"></a>3.FFmpeg重采样相关的API</h5> 
<ul><li> <p>分配音频重采样的上下⽂：struct SwrContext *swr_alloc(void);</p> </li><li> <p>当设置好相关的参数后，使⽤此函数来初始化SwrContext结构体 ：int swr_init(struct SwrContext *s);</p> </li><li> <p>分配SwrContext并设置/重置常⽤的参数。</p> </li></ul> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">SwrContext</span> <span class="token operator">*</span><span class="token function">swr_alloc_set_opts</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">SwrContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token comment">// ⾳频重采样上下⽂ </span>
                                      <span class="token class-name">int64_t</span> out_ch_layout<span class="token punctuation">,</span> <span class="token comment">// 输出的layout, 如：5.1声道 </span>
                                      <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> out_sample_fmt<span class="token punctuation">,</span> <span class="token comment">// 输出的采样格式。Float, S16,⼀般 选⽤是s16 绝⼤部分声卡⽀持 </span>
                                      <span class="token keyword">int</span> out_sample_rate<span class="token punctuation">,</span> <span class="token comment">//输出采样率 </span>
                                      <span class="token class-name">int64_t</span> in_ch_layout<span class="token punctuation">,</span> <span class="token comment">// 输⼊的layout </span>
                                      <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> in_sample_fmt<span class="token punctuation">,</span> <span class="token comment">// 输⼊的采样格式 </span>
                                      <span class="token keyword">int</span> in_sample_rate<span class="token punctuation">,</span> <span class="token comment">// 输⼊的采样率 </span>
                                      <span class="token keyword">int</span> log_offset<span class="token punctuation">,</span> <span class="token comment">// ⽇志相关，不⽤管先，直接为0 </span>
                                      <span class="token keyword">void</span> <span class="token operator">*</span>log_ctx <span class="token comment">// ⽇志相关，不⽤管先，直接为NULL );</span>
</code></pre> 
<ul><li>将输⼊的⾳频按照定义的参数进⾏转换并输出</li></ul> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">swr_convert</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">SwrContext</span> <span class="token operator">*</span>s<span class="token punctuation">,</span> <span class="token comment">//⾳频重采样的上下⽂ </span>
                <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span>out<span class="token punctuation">,</span> <span class="token comment">//输出的指针。传递的输出的数组 </span>
                <span class="token keyword">int</span> out_count<span class="token punctuation">,</span> <span class="token comment">//输出的样本数量，不是字节数。单通道的样本数量。 </span>
                <span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span>in <span class="token punctuation">,</span> <span class="token comment">//输⼊的数组，AVFrame解码出来的DATA </span>
                <span class="token keyword">int</span> in_count <span class="token comment">//输⼊的单通道的样本数量。 );</span>
 <span class="token comment">//in和in_count可以设置为0，以最后刷新最后⼏个样本。</span>
</code></pre> 
<ul><li>释放掉SwrContext结构体并将此结构体置为NULL：void swr_free(struct SwrContext **s);</li></ul> 
<p>为了使⽤lswr，你需要做的第⼀件事就是分配SwrContext。 这可以使⽤swr_alloc（）或 swr_alloc_set_opts（）来完成。</p> 
<p><strong>使⽤swr_alloc（）则必须通过AVOptions API设置选项</strong></p> 
<p><strong>使⽤swr_alloc_set_opts（）提供了相同的功能，但它允许您在同⼀语句中设置⼀些常⽤选项</strong></p> 
<p>例如，以下代码将设置从平⾯浮动样本格式到交织的带符号16位整数的转换，从48kHz到44.1kHz的下采 样，以及从5.1声道到⽴体声的下混合（使⽤默认混合矩阵）。</p> 
<p>使⽤swr_alloc（）函数：</p> 
<pre><code class="prism language-c">SwrContext <span class="token operator">*</span>swr <span class="token operator">=</span> <span class="token function">swr_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">av_opt_set_channel_layout</span><span class="token punctuation">(</span>swr<span class="token punctuation">,</span> <span class="token string">"in_channel_layout"</span><span class="token punctuation">,</span> AV_CH_LAYOUT_ <span class="token number">5</span>POINT1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">av_opt_set_channel_layout</span><span class="token punctuation">(</span>swr<span class="token punctuation">,</span> <span class="token string">"out_channel_layout"</span><span class="token punctuation">,</span> AV_CH_LAYOUT_ STEREO<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>swr<span class="token punctuation">,</span> <span class="token string">"in_sample_rate"</span><span class="token punctuation">,</span> <span class="token number">48000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
<span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>swr<span class="token punctuation">,</span> <span class="token string">"out_sample_rate"</span><span class="token punctuation">,</span> <span class="token number">44100</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">;</span> 
<span class="token function">av_opt_set_sample_fmt</span><span class="token punctuation">(</span>swr<span class="token punctuation">,</span> <span class="token string">"in_sample_fmt"</span><span class="token punctuation">,</span> AV_SAMPLE_FMT_FLTP<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token function">av_opt_set_sample_fmt</span><span class="token punctuation">(</span>swr<span class="token punctuation">,</span> <span class="token string">"out_sample_fmt"</span><span class="token punctuation">,</span> AV_SAMPLE_FMT_S16<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>同样的⼯作也可以使⽤swr_alloc_set_opts（）：</p> 
<pre><code class="prism language-c">SwrContext <span class="token operator">*</span>swr <span class="token operator">=</span> <span class="token function">swr_alloc_set_opts</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token comment">// we're allocating a new context </span>
                                        AV_CH_LAYOUT_STEREO<span class="token punctuation">,</span> <span class="token comment">// out_ch_layout </span>
                                       AV_SAMPLE_FMT_S16<span class="token punctuation">,</span> <span class="token comment">// out_sample_fmt </span>
                                       <span class="token number">44100</span><span class="token punctuation">,</span> <span class="token comment">// out_sample_rate </span>
                                       AV_CH_LAYOUT_5POINT1<span class="token punctuation">,</span> <span class="token comment">// in_ch_layout </span>
                                       AV_SAMPLE_FMT_FLTP<span class="token punctuation">,</span> <span class="token comment">// in_sample_fmt</span>
                                       <span class="token number">48000</span><span class="token punctuation">,</span> <span class="token comment">// in_sample_rate </span>
                                       <span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">// log_offset </span>
                                       <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// log_ctx</span>
</code></pre> 
<p>⼀旦设置了所有值，它必须⽤swr_init（）初始化。 如果需要更改转换参数，可以使⽤ AVOptions来更改参数,转换本身通过重复调⽤swr_convert（）来完成。</p> 
<p>注意：如果提供的输出空间不足或采样率转换完成后，样本可能会在swr中缓冲，这需要“未来”样本。 可以随时通过使⽤swr_convert（in_count可以 设置为0）来检索不需要将来输⼊的样本。 在转换结束时，可以通过调⽤具有NULL in和in incount的 swr_convert（）来刷新重采样缓冲区。</p> 
<h5><a id="4_169"></a>4.⾳频重采样⼯程</h5> 
<p>FFMpeg⾃带的resample例⼦：FFmpeg\doc\examples\resampling_audio.c，在⼯程中使⽤时，注意设置的各种参数，给定的输⼊数据都必须准确：</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libswresample/swresample.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/samplefmt.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/channel_layout.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"libavutil/opt.h"</span></span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">get_format_from_sample_fmt</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>fmt<span class="token punctuation">,</span>
                                      <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> sample_fmt<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">sample_fmt_entry</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> sample_fmt<span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt_be<span class="token punctuation">,</span> <span class="token operator">*</span>fmt_le<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> sample_fmt_entries<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">{<!-- --></span>AV_SAMPLE_FMT_U8<span class="token punctuation">,</span> <span class="token string">"u8"</span><span class="token punctuation">,</span> <span class="token string">"u8"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>AV_SAMPLE_FMT_S16<span class="token punctuation">,</span> <span class="token string">"s16be"</span><span class="token punctuation">,</span> <span class="token string">"s16le"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>AV_SAMPLE_FMT_S32<span class="token punctuation">,</span> <span class="token string">"s32be"</span><span class="token punctuation">,</span> <span class="token string">"s32le"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>AV_SAMPLE_FMT_FLT<span class="token punctuation">,</span> <span class="token string">"f32be"</span><span class="token punctuation">,</span> <span class="token string">"f32le"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span>AV_SAMPLE_FMT_DBL<span class="token punctuation">,</span> <span class="token string">"f64be"</span><span class="token punctuation">,</span> <span class="token string">"f64le"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>fmt <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">FF_ARRAY_ELEMS</span><span class="token punctuation">(</span>sample_fmt_entries<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">sample_fmt_entry</span> <span class="token operator">*</span>entry <span class="token operator">=</span> <span class="token operator">&amp;</span>sample_fmt_entries<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sample_fmt <span class="token operator">==</span> entry<span class="token operator">-&gt;</span>sample_fmt<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>fmt <span class="token operator">=</span> <span class="token function">AV_NE</span><span class="token punctuation">(</span>entry<span class="token operator">-&gt;</span>fmt_be<span class="token punctuation">,</span> entry<span class="token operator">-&gt;</span>fmt_le<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Sample format %s not supported as output format\n"</span><span class="token punctuation">,</span>
            <span class="token function">av_get_sample_fmt_name</span><span class="token punctuation">(</span>sample_fmt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * Fill dst buffer with nb_samples, generated starting from t. 交错模式的
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">fill_samples</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>dst<span class="token punctuation">,</span> <span class="token keyword">int</span> nb_samples<span class="token punctuation">,</span> <span class="token keyword">int</span> nb_channels<span class="token punctuation">,</span>
                         <span class="token keyword">int</span> sample_rate<span class="token punctuation">,</span> <span class="token keyword">double</span> <span class="token operator">*</span>t<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> j<span class="token punctuation">;</span>
    <span class="token keyword">double</span> tincr <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> sample_rate<span class="token punctuation">,</span> <span class="token operator">*</span>dstp <span class="token operator">=</span> dst<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">double</span> c <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> M_PI <span class="token operator">*</span> <span class="token number">440.0</span><span class="token punctuation">;</span>

    <span class="token comment">/* generate sin tone with 440Hz frequency and duplicated channels */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nb_samples<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">*</span>dstp <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>c <span class="token operator">*</span> <span class="token operator">*</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> nb_channels<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> dstp<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> dstp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        dstp <span class="token operator">+=</span> nb_channels<span class="token punctuation">;</span>
        <span class="token operator">*</span>t <span class="token operator">+=</span> tincr<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 输入参数</span>
    <span class="token class-name">int64_t</span> src_ch_layout <span class="token operator">=</span> AV_CH_LAYOUT_STEREO<span class="token punctuation">;</span>
    <span class="token keyword">int</span> src_rate <span class="token operator">=</span> <span class="token number">48000</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> src_sample_fmt <span class="token operator">=</span> AV_SAMPLE_FMT_DBL<span class="token punctuation">;</span>
    <span class="token keyword">int</span> src_nb_channels <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span>src_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// 二级指针</span>
    <span class="token keyword">int</span> src_linesize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> src_nb_samples <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>

    <span class="token comment">// 输出参数</span>
    <span class="token class-name">int64_t</span> dst_ch_layout <span class="token operator">=</span> AV_CH_LAYOUT_STEREO<span class="token punctuation">;</span>
    <span class="token keyword">int</span> dst_rate <span class="token operator">=</span> <span class="token number">44100</span><span class="token punctuation">;</span>
    <span class="token keyword">enum</span> <span class="token class-name">AVSampleFormat</span> dst_sample_fmt <span class="token operator">=</span> AV_SAMPLE_FMT_S16<span class="token punctuation">;</span>
    <span class="token keyword">int</span> dst_nb_channels <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span>dst_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">//二级指针</span>
    <span class="token keyword">int</span> dst_linesize<span class="token punctuation">;</span>
    <span class="token keyword">int</span> dst_nb_samples<span class="token punctuation">;</span>
    <span class="token keyword">int</span> max_dst_nb_samples<span class="token punctuation">;</span>

    <span class="token comment">// 输出文件</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>dst_filename <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  <span class="token comment">// 保存输出的pcm到本地，然后播放验证</span>
    FILE <span class="token operator">*</span>dst_file<span class="token punctuation">;</span>

    <span class="token keyword">int</span> dst_bufsize<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>fmt<span class="token punctuation">;</span>

    <span class="token comment">// 重采样实例</span>
    <span class="token keyword">struct</span> <span class="token class-name">SwrContext</span> <span class="token operator">*</span>swr_ctx<span class="token punctuation">;</span>

    <span class="token keyword">double</span> t<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
                <span class="token string">"Usage: %s output_file\n"</span>
                <span class="token string">"API example program to show how to resample an audio stream "</span>
                <span class="token string">"with libswresample.\n"</span>
                <span class="token string">"This program generates a series of audio frames, resamples "</span>
                <span class="token string">"them to a specified "</span>
                <span class="token string">"output format and rate and saves them to an output file named "</span>
                <span class="token string">"output_file.\n"</span><span class="token punctuation">,</span>
                argv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dst_filename <span class="token operator">=</span> argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    dst_file <span class="token operator">=</span> <span class="token function">fopen</span><span class="token punctuation">(</span>dst_filename<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dst_file<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not open destination file %s\n"</span><span class="token punctuation">,</span> dst_filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 创建重采样器</span>
    <span class="token comment">/* create resampler context */</span>
    swr_ctx <span class="token operator">=</span> <span class="token function">swr_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>swr_ctx<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate resampler context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">AVERROR</span><span class="token punctuation">(</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 设置重采样参数</span>
    <span class="token comment">/* set options */</span>
    <span class="token comment">// 输入参数</span>
    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> <span class="token string">"in_channel_layout"</span><span class="token punctuation">,</span> src_ch_layout<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> <span class="token string">"in_sample_rate"</span><span class="token punctuation">,</span> src_rate<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_opt_set_sample_fmt</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> <span class="token string">"in_sample_fmt"</span><span class="token punctuation">,</span> src_sample_fmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 输出参数</span>
    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> <span class="token string">"out_channel_layout"</span><span class="token punctuation">,</span> dst_ch_layout<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_opt_set_int</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> <span class="token string">"out_sample_rate"</span><span class="token punctuation">,</span> dst_rate<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_opt_set_sample_fmt</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> <span class="token string">"out_sample_fmt"</span><span class="token punctuation">,</span> dst_sample_fmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 初始化重采样</span>
    <span class="token comment">/* initialize the resampling context */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">swr_init</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to initialize the resampling context\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* allocate source and destination samples buffers */</span>
    <span class="token comment">// 计算出输入源的通道数量</span>
    src_nb_channels <span class="token operator">=</span> <span class="token function">av_get_channel_layout_nb_channels</span><span class="token punctuation">(</span>src_ch_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 给输入源分配内存空间</span>
    ret <span class="token operator">=</span> <span class="token function">av_samples_alloc_array_and_samples</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>src_linesize<span class="token punctuation">,</span>
                                             src_nb_channels<span class="token punctuation">,</span> src_nb_samples<span class="token punctuation">,</span>
                                             src_sample_fmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate source samples\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* compute the number of converted samples: buffering is avoided
     * ensuring that the output buffer will contain at least all the
     * converted input samples */</span>
    <span class="token comment">// 计算输出采样数量</span>
    max_dst_nb_samples <span class="token operator">=</span> dst_nb_samples <span class="token operator">=</span>
        <span class="token function">av_rescale_rnd</span><span class="token punctuation">(</span>src_nb_samples<span class="token punctuation">,</span> dst_rate<span class="token punctuation">,</span> src_rate<span class="token punctuation">,</span> AV_ROUND_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* buffer is going to be directly written to a rawaudio file, no alignment
     */</span>
    dst_nb_channels <span class="token operator">=</span> <span class="token function">av_get_channel_layout_nb_channels</span><span class="token punctuation">(</span>dst_ch_layout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 分配输出缓存内存</span>
    ret <span class="token operator">=</span> <span class="token function">av_samples_alloc_array_and_samples</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dst_linesize<span class="token punctuation">,</span>
                                             dst_nb_channels<span class="token punctuation">,</span> dst_nb_samples<span class="token punctuation">,</span>
                                             dst_sample_fmt<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not allocate destination samples\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    t <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* generate synthetic audio */</span>
        <span class="token comment">// 生成输入源</span>
        <span class="token function">fill_samples</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span><span class="token punctuation">)</span>src_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> src_nb_samples<span class="token punctuation">,</span> src_nb_channels<span class="token punctuation">,</span>
                     src_rate<span class="token punctuation">,</span> <span class="token operator">&amp;</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/* compute destination number of samples */</span>
        <span class="token class-name">int64_t</span> delay <span class="token operator">=</span> <span class="token function">swr_get_delay</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> src_rate<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dst_nb_samples <span class="token operator">=</span> <span class="token function">av_rescale_rnd</span><span class="token punctuation">(</span>delay <span class="token operator">+</span> src_nb_samples<span class="token punctuation">,</span> dst_rate<span class="token punctuation">,</span>
                                        src_rate<span class="token punctuation">,</span> AV_ROUND_UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_nb_samples <span class="token operator">&gt;</span> max_dst_nb_samples<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            ret <span class="token operator">=</span> <span class="token function">av_samples_alloc</span><span class="token punctuation">(</span>dst_data<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dst_linesize<span class="token punctuation">,</span> dst_nb_channels<span class="token punctuation">,</span>
                                   dst_nb_samples<span class="token punctuation">,</span> dst_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
            max_dst_nb_samples <span class="token operator">=</span> dst_nb_samples<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//        int fifo_size = swr_get_out_samples(swr_ctx,src_nb_samples);</span>
        <span class="token comment">//        printf("fifo_size:%d\n", fifo_size);</span>
        <span class="token comment">//        if(fifo_size &lt; 1024)</span>
        <span class="token comment">//            continue;</span>

        <span class="token comment">/* convert to destination format */</span>
        <span class="token comment">//        ret = swr_convert(swr_ctx, dst_data, dst_nb_samples, (const</span>
        <span class="token comment">//        uint8_t **)src_data, src_nb_samples);</span>
        ret <span class="token operator">=</span> <span class="token function">swr_convert</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> dst_data<span class="token punctuation">,</span> dst_nb_samples<span class="token punctuation">,</span>
                          <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token class-name">uint8_t</span> <span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span>src_data<span class="token punctuation">,</span> src_nb_samples<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error while converting\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        dst_bufsize <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_linesize<span class="token punctuation">,</span> dst_nb_channels<span class="token punctuation">,</span>
                                                 ret<span class="token punctuation">,</span> dst_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_bufsize <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not get sample buffer size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"t:%f in:%d out:%d\n"</span><span class="token punctuation">,</span> t<span class="token punctuation">,</span> src_nb_samples<span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">fwrite</span><span class="token punctuation">(</span>dst_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> dst_bufsize<span class="token punctuation">,</span> dst_file<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>t <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">swr_convert</span><span class="token punctuation">(</span>swr_ctx<span class="token punctuation">,</span> dst_data<span class="token punctuation">,</span> dst_nb_samples<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Error while converting\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    dst_bufsize <span class="token operator">=</span> <span class="token function">av_samples_get_buffer_size</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_linesize<span class="token punctuation">,</span> dst_nb_channels<span class="token punctuation">,</span>
                                             ret<span class="token punctuation">,</span> dst_sample_fmt<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_bufsize <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Could not get sample buffer size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"flush in:%d out:%d\n"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">fwrite</span><span class="token punctuation">(</span>dst_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> dst_bufsize<span class="token punctuation">,</span> dst_file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ret <span class="token operator">=</span> <span class="token function">get_format_from_sample_fmt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fmt<span class="token punctuation">,</span> dst_sample_fmt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">goto</span> end<span class="token punctuation">;</span>
    <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span>
            <span class="token string">"Resampling succeeded. Play the output file with the command:\n"</span>
            <span class="token string">"ffplay -f %s -channel_layout %"</span> PRId64 <span class="token string">" -channels %d -ar %d %s\n"</span><span class="token punctuation">,</span>
            fmt<span class="token punctuation">,</span> dst_ch_layout<span class="token punctuation">,</span> dst_nb_channels<span class="token punctuation">,</span> dst_rate<span class="token punctuation">,</span> dst_filename<span class="token punctuation">)</span><span class="token punctuation">;</span>

end<span class="token operator">:</span>
    <span class="token function">fclose</span><span class="token punctuation">(</span>dst_file<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>src_data<span class="token punctuation">)</span> <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>src_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dst_data<span class="token punctuation">)</span> <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">av_freep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dst_data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">swr_free</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>swr_ctx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e05b5fc7fc9edcf9dc165d2123b0410a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">TemplateInputException: An error happened during template parsing</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/0eb52c75373bb884563250ada0adc544/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">el-table @selection-change实现多选框的效果以及可以进行批量删除的操作</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>