<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>oracle计算占比和环比增长率案例 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="oracle计算占比和环比增长率案例" />
<meta property="og:description" content="前言 在数据库做统计分析的时候，我们可能需要结合不同的需求计算数据的汇总、平均、占比、环比、同步等等，那么在通过sql硬编码前我们是否应该考虑数据的各种问题，以及在编写代码时，我们是否应该通过各种函数进行数据预处理，避免最终预览数据时出现各种错误呢？
需求： 根据科室、时间维度分组， 对不同科室人数、科室总金额进行统计汇总，以及计算科室不同药品的使用情况 如：各药品的占比、环比增长率等等？
1)对科室、时间维度进行分组，对人数进行count,对总金额进行sum
注：使用group by &#43;聚合函数即可（sum、count、…）等
2)对药品的使用情况 进行占比分析、环比增长率
注：药品占比分析 某类型药费用总额/费用总额 * 100
需考虑情况：某类型药费用总额 或 费用总额 为 0的情况
解读环比增长率：环比增长率=（本期数-上期数）÷上期数×100%
药品环比增长率 （本月费用总额-上月费用总额）上月费用总额*100
需考虑3种情况：
1) 本月费用总额、上月费用总额 同时为 0 如 （0-0）/0 则提示ORA-01476
2) 本月费用总额、上月费用总额 不为0但是数据相等 （1000-1000）/1000=0
3) 本月费用总额不为0、上月费用总额为0 （1000-0）/0 则提示ORA-01476
所以需要针对该3种情况进行处理，可通过case when 函数 案例基础数据准备 建表使用中文命名字段是为了方便大家阅读，实际工作情况下 不推荐此骚操作。
CREATE TABLE MY_TABLE_TEST ( &#34;结算时间&#34; VARCHAR2(255), &#34;科室代码&#34; VARCHAR2(255), &#34;科室名称&#34; VARCHAR2(255), &#34;人次&#34; NUMBER, &#34;次均费用&#34; NUMBER, &#34;费用明细&#34; NUMBER, &#34;中药&#34; NUMBER, &#34;中成药费&#34; NUMBER, &#34;西药&#34; NUMBER, &#34;耗材&#34; NUMBER ); INSERT INTO MY_TABLE_TEST(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4e37bab6d3c49dc123eead9bb7617ba5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-12T18:40:41+08:00" />
<meta property="article:modified_time" content="2022-05-12T18:40:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">oracle计算占比和环比增长率案例</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_1"></a>前言</h3> 
<p>        在数据库做统计分析的时候，我们可能需要结合不同的需求计算数据的汇总、平均、占比、环比、同步等等，那么在通过sql硬编码前我们是否应该考虑数据的各种问题，以及在编写代码时，我们是否应该通过各种函数进行数据预处理，避免最终预览数据时出现各种错误呢？</p> 
<h3><a id="_7"></a>需求：</h3> 
<p>        <code>根据科室、时间维度分组， 对不同科室人数、科室总金额进行统计汇总，以及计算科室不同药品的使用情况 如：各药品的占比、环比增长率等等？</code></p> 
<p>1)对科室、时间维度进行分组，对人数进行count,对总金额进行sum<br> 注：使用<code>group by</code> +聚合函数即可（<code>sum</code>、<code>count</code>、…）等<br> 2)对药品的使用情况 进行占比分析、环比增长率<br> 注：药品占比分析 某类型药费用总额/费用总额 * 100<br> 需考虑情况：某类型药费用总额 或 费用总额 为 0的情况</p> 
<p><strong>解读环比增长率：环比增长率=（本期数-上期数）÷上期数×100%</strong><br> 药品环比增长率 （本月费用总额-上月费用总额）上月费用总额*100</p> 
<p><strong>需考虑3种情况：</strong><br> </p> 
<p> 1) 本月费用总额、上月费用总额 同时为 0 如 （0-0）/0 则提示ORA-01476<br> 2) 本月费用总额、上月费用总额 不为0但是数据相等 （1000-1000）/1000=0<br> 3) 本月费用总额不为0、上月费用总额为0 （1000-0）/0 则提示ORA-01476<br> 所以需要针对该3种情况进行处理，可通过<code>case when</code> 函数 <br></p> 
<br> 
<br> 
<h3><a id="_25"></a>案例基础数据准备</h3> 
<p>建表使用中文命名字段是为了方便大家阅读，<em><strong>实际工作情况下 不推荐此骚操作。</strong></em></p> 
<pre><code class="prism language-c">CREATE TABLE <span class="token function">MY_TABLE_TEST</span> <span class="token punctuation">(</span>
  <span class="token string">"结算时间"</span> <span class="token function">VARCHAR2</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"科室代码"</span> <span class="token function">VARCHAR2</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"科室名称"</span> <span class="token function">VARCHAR2</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token string">"人次"</span> NUMBER<span class="token punctuation">,</span>
  <span class="token string">"次均费用"</span> NUMBER<span class="token punctuation">,</span>
  <span class="token string">"费用明细"</span> NUMBER<span class="token punctuation">,</span>
  <span class="token string">"中药"</span> NUMBER<span class="token punctuation">,</span>
  <span class="token string">"中成药费"</span> NUMBER<span class="token punctuation">,</span>
  <span class="token string">"西药"</span> NUMBER<span class="token punctuation">,</span>
  <span class="token string">"耗材"</span> NUMBER <span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2021-12'</span><span class="token punctuation">,</span> <span class="token char">'101'</span><span class="token punctuation">,</span> <span class="token char">'AAA'</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">269.65</span><span class="token punctuation">,</span> <span class="token number">2157.19</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">259.19</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-01'</span><span class="token punctuation">,</span> <span class="token char">'101'</span><span class="token punctuation">,</span> <span class="token char">'AAA'</span><span class="token punctuation">,</span> <span class="token number">72</span><span class="token punctuation">,</span> <span class="token number">3081.32</span><span class="token punctuation">,</span> <span class="token number">221854.81</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">80.85</span><span class="token punctuation">,</span> <span class="token number">34520.06</span><span class="token punctuation">,</span> <span class="token number">8400.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-02'</span><span class="token punctuation">,</span> <span class="token char">'101'</span><span class="token punctuation">,</span> <span class="token char">'AAA'</span><span class="token punctuation">,</span> <span class="token number">58</span><span class="token punctuation">,</span> <span class="token number">4621.79</span><span class="token punctuation">,</span> <span class="token number">268063.98</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">181.44</span><span class="token punctuation">,</span> <span class="token number">33361.24</span><span class="token punctuation">,</span> <span class="token number">53853.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-03'</span><span class="token punctuation">,</span> <span class="token char">'101'</span><span class="token punctuation">,</span> <span class="token char">'AAA'</span><span class="token punctuation">,</span> <span class="token number">84</span><span class="token punctuation">,</span> <span class="token number">2970.27</span><span class="token punctuation">,</span> <span class="token number">249502.28</span><span class="token punctuation">,</span> <span class="token number">413.64</span><span class="token punctuation">,</span> <span class="token number">421.76</span><span class="token punctuation">,</span> <span class="token number">40433.68</span><span class="token punctuation">,</span> <span class="token number">11174.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-04'</span><span class="token punctuation">,</span> <span class="token char">'101'</span><span class="token punctuation">,</span> <span class="token char">'AAA'</span><span class="token punctuation">,</span> <span class="token number">65</span><span class="token punctuation">,</span> <span class="token number">2762.42</span><span class="token punctuation">,</span> <span class="token number">179557.49</span><span class="token punctuation">,</span> <span class="token number">571.45</span><span class="token punctuation">,</span> <span class="token number">432.8</span><span class="token punctuation">,</span> <span class="token number">30034.14</span><span class="token punctuation">,</span> <span class="token number">5624.8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-05'</span><span class="token punctuation">,</span> <span class="token char">'101'</span><span class="token punctuation">,</span> <span class="token char">'AAA'</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">,</span> <span class="token number">2362.88</span><span class="token punctuation">,</span> <span class="token number">73249.27</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">205.2</span><span class="token punctuation">,</span> <span class="token number">11180.97</span><span class="token punctuation">,</span> <span class="token number">2207.7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-01'</span><span class="token punctuation">,</span> <span class="token char">'202'</span><span class="token punctuation">,</span> <span class="token char">'BBB'</span><span class="token punctuation">,</span> <span class="token number">91</span><span class="token punctuation">,</span> <span class="token number">4636.3</span><span class="token punctuation">,</span> <span class="token number">421903.67</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2850.69</span><span class="token punctuation">,</span> <span class="token number">51995.28</span><span class="token punctuation">,</span> <span class="token number">15754.6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-02'</span><span class="token punctuation">,</span> <span class="token char">'202'</span><span class="token punctuation">,</span> <span class="token char">'BBB'</span><span class="token punctuation">,</span> <span class="token number">89</span><span class="token punctuation">,</span> <span class="token number">5299.69</span><span class="token punctuation">,</span> <span class="token number">471672</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3606.04</span><span class="token punctuation">,</span> <span class="token number">63211.36</span><span class="token punctuation">,</span> <span class="token number">18940.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-03'</span><span class="token punctuation">,</span> <span class="token char">'202'</span><span class="token punctuation">,</span> <span class="token char">'BBB'</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">,</span> <span class="token number">5277.78</span><span class="token punctuation">,</span> <span class="token number">686111.03</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5606.76</span><span class="token punctuation">,</span> <span class="token number">86714.17</span><span class="token punctuation">,</span> <span class="token number">25642.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-04'</span><span class="token punctuation">,</span> <span class="token char">'202'</span><span class="token punctuation">,</span> <span class="token char">'BBB'</span><span class="token punctuation">,</span> <span class="token number">117</span><span class="token punctuation">,</span> <span class="token number">4797.85</span><span class="token punctuation">,</span> <span class="token number">561347.96</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4996.95</span><span class="token punctuation">,</span> <span class="token number">74157.71</span><span class="token punctuation">,</span> <span class="token number">22723.1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
INSERT INTO <span class="token function">MY_TABLE_TEST</span><span class="token punctuation">(</span><span class="token string">"结算时间"</span><span class="token punctuation">,</span> <span class="token string">"科室代码"</span><span class="token punctuation">,</span> <span class="token string">"科室名称"</span><span class="token punctuation">,</span> <span class="token string">"人次"</span><span class="token punctuation">,</span> <span class="token string">"次均费用"</span><span class="token punctuation">,</span> <span class="token string">"费用明细"</span><span class="token punctuation">,</span> <span class="token string">"中药"</span><span class="token punctuation">,</span> <span class="token string">"中成药费"</span><span class="token punctuation">,</span> <span class="token string">"西药"</span><span class="token punctuation">,</span> <span class="token string">"耗材"</span><span class="token punctuation">)</span> <span class="token function">VALUES</span> <span class="token punctuation">(</span><span class="token char">'2022-05'</span><span class="token punctuation">,</span> <span class="token char">'202'</span><span class="token punctuation">,</span> <span class="token char">'BBB'</span><span class="token punctuation">,</span> <span class="token number">45</span><span class="token punctuation">,</span> <span class="token number">5563.04</span><span class="token punctuation">,</span> <span class="token number">250336.67</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1773.8</span><span class="token punctuation">,</span> <span class="token number">32920.17</span><span class="token punctuation">,</span> <span class="token number">10349.9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<br> 
<h3><a id="sql_56"></a>sql统计示例</h3> 
<p>（复制可使用，注释的地方主要为了减少可阅读性）</p> 
<pre><code class="prism language-c">select 结算时间<span class="token punctuation">,</span>科室代码<span class="token punctuation">,</span>
       科室名称<span class="token punctuation">,</span>
       <span class="token function">count</span><span class="token punctuation">(</span>科室名称<span class="token punctuation">)</span> as 人次<span class="token punctuation">,</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>费用明细<span class="token punctuation">)</span><span class="token operator">/</span><span class="token function">count</span><span class="token punctuation">(</span>科室名称<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span> as 次均费用<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>费用明细<span class="token punctuation">)</span> AS 费用明细<span class="token punctuation">,</span>
       <span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span> aS 中药<span class="token punctuation">,</span>
       <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">to_char</span><span class="token punctuation">(</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token operator">/</span> <span class="token function">sum</span><span class="token punctuation">(</span>费用明细<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">100.00</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token char">'fm999990.9999'</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token char">'%'</span><span class="token punctuation">,</span><span class="token char">'0.%'</span><span class="token punctuation">,</span><span class="token char">'0%'</span><span class="token punctuation">)</span>  AS 中药占比<span class="token punctuation">,</span>  <span class="token operator">--</span>将相除的数据转成字符串<span class="token punctuation">,</span>并将可能出现字符进行替换
       <span class="token function">replace</span><span class="token punctuation">(</span>  <span class="token function">replace</span><span class="token punctuation">(</span> <span class="token function">replace</span><span class="token punctuation">(</span><span class="token function">to_char</span><span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token keyword">case</span>
            when <span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY 结算时间<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span> then <span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY 结算时间<span class="token punctuation">)</span> <span class="token operator">--</span>判断（<span class="token number">0</span><span class="token operator">-</span><span class="token number">0</span><span class="token operator">=</span><span class="token number">0</span>）本月<span class="token operator">-</span>减上月<span class="token operator">=</span><span class="token number">0</span> 的情况。不判断可能会出现 ORA<span class="token operator">-</span><span class="token number">01476</span><span class="token operator">:</span> 除数为<span class="token number">0</span>
            when <span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY 结算时间<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span> then <span class="token number">0</span>   <span class="token operator">--</span>判断 （<span class="token number">5000</span><span class="token operator">-</span><span class="token number">500</span><span class="token operator">=</span><span class="token number">0</span>）判断本月和上月数据一样相减等于<span class="token number">0</span> 的情况。不判断可能会出现 ORA<span class="token operator">-</span><span class="token number">01476</span><span class="token operator">:</span> 除数为<span class="token number">0</span>
            <span class="token keyword">else</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY 结算时间<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span>
                       <span class="token function">decode</span><span class="token punctuation">(</span><span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY 结算时间<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span>
                              <span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY 结算时间<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                       <span class="token number">4</span><span class="token punctuation">)</span>     <span class="token operator">--</span>判断（本月<span class="token operator">-</span>上月 ）<span class="token operator">/</span>上月 不等于<span class="token number">0</span> 的情况
                     <span class="token operator">*</span><span class="token number">100</span> end<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token char">'fm999990.9999'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token char">'%'</span><span class="token punctuation">,</span> <span class="token char">'0.%'</span><span class="token punctuation">,</span>   <span class="token char">'0%'</span><span class="token punctuation">)</span> <span class="token punctuation">,</span><span class="token char">'-1.%'</span><span class="token punctuation">,</span><span class="token char">'-100%'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token char">'1.%'</span><span class="token punctuation">,</span><span class="token char">'100%'</span><span class="token punctuation">)</span>   as 中药环比增长<span class="token punctuation">,</span>  <span class="token operator">--</span>将最后数据转字符串，拼接 <span class="token operator">%</span> ，并将可能出现字符进行替换
      <span class="token function">LAG</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span>中药<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token function">OVER</span> <span class="token punctuation">(</span>PARTITION BY 科室名称 ORDER BY <span class="token function">to_date</span><span class="token punctuation">(</span>结算时间<span class="token punctuation">,</span><span class="token char">'yyyy-mm'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> as 环比<span class="token operator">--</span> 同比分析，与上个年度相同月份进行比较
     <span class="token comment">/*   sum(中成药费) as 中成药费,

       replace(to_char(round((sum(中成药费)/ sum(费用明细)*100.00),2),'fm999990.9999')||'%','0.%','0%') AS  中成药占比,
       replace( replace(replace(to_char((case
            when sum(中成药费) - LAG(sum(中成药费), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = 0 then LAG(sum(中成药费), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)
            when sum(中成药费) - LAG(sum(中成药费), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = sum(中成药费) then 0
            else round((sum(中成药费) - LAG(sum(中成药费), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)) /
                       decode(LAG(sum(中成药费), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间), 0, 1,
                              LAG(sum(中成药费), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)),
                       4)*100 end) , 'fm999990.9999') || '%', '0.%',   '0%'),'-1.%','-100%'),'1.%','100%')    as 中成药费环比增长,
      sum(西药) as 西药 ,
      replace(to_char(round((sum(西药)/sum(费用明细)*100.00),2),'fm999990.9999')||'%','0.%','0%') AS 西药占比,
      replace(  replace( replace(to_char((case
            when sum(西药) - LAG(sum(西药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = 0 then LAG(sum(西药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)
            when sum(西药) - LAG(sum(西药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = sum(西药) then 0
            else round((sum(西药) - LAG(sum(西药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)) /
                       decode(LAG(sum(西药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间), 0, 1,
                              LAG(sum(西药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)),
                       4)*100 end) , 'fm999990.9999') || '%', '0.%',   '0%'),'-1.%','-100%'),'1.%','100%')     as 西药环比增长,
       sum(耗材) as  耗材,
      replace(to_char(round((sum(耗材)/sum(费用明细)*100.00),2),'fm999990.9999')||'%','0.%','0%')  AS 耗材占比 ,
      replace(  replace( replace(to_char((case
            when sum(耗材) - LAG(sum(耗材), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = 0 then  LAG(sum(耗材), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)
            when sum(耗材) - LAG(sum(耗材), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = sum(耗材) then 0
            else round((sum(耗材) - LAG(sum(耗材), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)) /
                       decode(LAG(sum(耗材), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间), 0, 1,
                              LAG(sum(耗材), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)),
                       4)*100 end) , 'fm999990.9999') || '%', '0.%',   '0%') ,'-1.%','-100%')  ,'1.%','100%')       as 耗材环比增长*/</span>
from  MY_TABLE_TEST  where  科室名称 <span class="token function">in</span> <span class="token punctuation">(</span><span class="token char">'AAA'</span><span class="token punctuation">,</span><span class="token char">'BBB'</span><span class="token punctuation">)</span>
  group by 科室代码 <span class="token punctuation">,</span>  科室名称<span class="token punctuation">,</span>结算时间
order  by 科室名称  desc<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="sql_107"></a>sql示例分析环比增长率</h3> 
<pre><code>replace(  replace( replace(to_char( (case
        when sum(中药) - LAG(sum(中药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = 0 then LAG(sum(中药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) --判断（0-0=0）本月-减上月=0 的情况。不判断可能会出现 ORA-01476: 除数为0
        when sum(中药) - LAG(sum(中药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间) = sum(中药) then 0   --判断 （5000-500=0）判断本月和上月数据一样相减等于0 的情况。不判断可能会出现 ORA-01476: 除数为0
        else round((sum(中药) - LAG(sum(中药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)) /
                   decode(LAG(sum(中药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间), 0, 1,
                          LAG(sum(中药), 1, 0) OVER (PARTITION BY 科室名称 ORDER BY 结算时间)),
                   4)     --判断（本月-上月 ）/上月 不等于0 的情况
                 *100 end) , 'fm999990.9999') || '%', '0.%',   '0%') ,'-1.%','-100%'),'1.%','100%')   as 中药环比增长
</code></pre> 
<p><img src="https://images2.imgbox.com/89/c4/gI0es5Bb_o.png" alt="在这里插入图片描述"><br> 1、通过<code>case when</code> 判断数据的三种情况 ，防止出现整除为0 。<br> 2、通过<code>to_char(xxx,'fm999990.9999') </code>格式化数据转为字符串<br> 3、通过<code>||</code>拼接符 拼接 %<br> 4、将可能出现的数据 进行替换。</p> 
<h3><a id="_126"></a>结尾</h3> 
<p>通过步骤拆解，所需要的功能基本实现，虽然该实现可能不是最优的，但希望能给部分所需要的同学带来一定的参考，所以当大家碰到此类问题基本不要慌，一步步去分析，一步步去尝试，最后，希望大家的技术越学越强。<br> <br><br>                                                                                                  – 知识的价值不在占有，而在于分享和使用</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ee7dfb97ceb7240da89dc98890cd7a48/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">（八）k8s安全</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d33693f39944a7d08cb68948d437440a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">我的maven导入模块</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>