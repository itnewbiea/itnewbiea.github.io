<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux内核：设备树 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux内核：设备树" />
<meta property="og:description" content="1. 设备树API函数：利用of_函数读取设备树结点/属性信息 ​ 设备树描述了设备的详细信息，这些信息包括数字类型的、字符串类型的、数组类型的，我们在编写驱动的时候需要获取到这些信息。
​ Linux 内核给我们提供了一系列的函数来获取设备树中的节点或者属性信息，这一系列的函数都有一个统一的前缀“of_”，所以在很多资料里面也被叫做 OF 。这些 OF原型都定义在include/linux/of.h 文件中。
判断根节点兼容性OF函数 在Linux内核中，常常使用如下OF函数来判断根节点的兼容性：
int of_machine_is_compatible(const char *compat); DT设备的.dt_compat可能包含多个电路板，通过该函数可以判断根节点compatible的属性，当该函数的compat参数与根据点的compatible匹配时，返回一个正整数。
用法，例如：
of_machine_is_compatible(&#34;samsung,exynos4&#34;); 查找节点的 OF ​ 设备都是以节点的形式“挂”到设备树上的，因此要想获取这个设备的其他属性信息，必须先获取到这个设备的节点。 Linux 内核使用 device_node 结构体来描述一个节点，此结构体定义在文件 include/linux/of.h 中，代码如下：
struct device_node { const char *name; /*节点的名字*/ const char *type; /*设备类型，来自节点中的device_type属性, 如果没有该属性, 则设为&#34;NULL&#34;*/ phandle phandle; const char *full_name; /*节点的全名，node-name[@unit-address]*/ struct fwnode_handle fwnode; struct	property *properties; /*节点的属性*/ struct	property *deadprops;	/* removed properties */ struct	device_node *parent; /*父节点*/ struct	device_node *child; /*子节点*/ struct	device_node *sibling; /*节点的兄弟，即同级节点*/ #if defined(CONFIG_OF_KOBJ) struct	kobject kobj; #endif unsigned long _flags; void	*data; #if defined(CONFIG_SPARC) const char *path_component_name; unsigned int unique_id; struct of_irq_controller *irq_trans; #endif }; 与查找节点相关的，有如下函数。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a74e3d925bdaf5669959ede9bbe9aa06/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-10T09:23:31+08:00" />
<meta property="article:modified_time" content="2022-08-10T09:23:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux内核：设备树</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_APIof__2"></a>1. 设备树API函数：利用of_函数读取设备树结点/属性信息</h3> 
<p>​ 设备树描述了设备的详细信息，这些信息包括数字类型的、字符串类型的、数组类型的，我们在编写驱动的时候需要获取到这些信息。</p> 
<p>​ Linux 内核给我们提供了一系列的函数来获取设备树中的节点或者属性信息，这一系列的函数都有一个统一的前缀“of_”，所以在很多资料里面也被叫做 OF 。这些 OF原型都定义在<code>include/linux/of.h</code> 文件中。</p> 
<h4><a id="OF_8"></a>判断根节点兼容性OF函数</h4> 
<p>在Linux内核中，常常使用如下OF函数来判断根节点的兼容性：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_machine_is_compatible</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>compat<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>DT设备的<code>.dt_compat</code>可能包含多个电路板，通过该函数可以判断根节点<code>compatible</code>的属性，当该函数的<code>compat</code>参数与根据点的<code>compatible</code>匹配时，返回一个正整数。<br> 用法，例如：</p> 
<pre><code class="prism language-c"><span class="token function">of_machine_is_compatible</span><span class="token punctuation">(</span><span class="token string">"samsung,exynos4"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_OF_23"></a>查找节点的 OF</h4> 
<p>​ 设备都是以节点的形式“挂”到设备树上的，因此要想获取这个设备的其他属性信息，必须先获取到这个设备的节点。 Linux 内核使用 device_node 结构体来描述一个节点，此结构体定义在文件 <code>include/linux/of.h</code> 中，代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>  <span class="token comment">/*节点的名字*/</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span>  <span class="token comment">/*设备类型，来自节点中的device_type属性, 如果没有该属性, 则设为"NULL"*/</span>
	phandle phandle<span class="token punctuation">;</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>full_name<span class="token punctuation">;</span>  <span class="token comment">/*节点的全名，node-name[@unit-address]*/</span>
	<span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> fwnode<span class="token punctuation">;</span>

	<span class="token keyword">struct</span>	<span class="token class-name">property</span> <span class="token operator">*</span>properties<span class="token punctuation">;</span>  <span class="token comment">/*节点的属性*/</span>
	<span class="token keyword">struct</span>	<span class="token class-name">property</span> <span class="token operator">*</span>deadprops<span class="token punctuation">;</span>	<span class="token comment">/* removed properties */</span>
	<span class="token keyword">struct</span>	<span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>   <span class="token comment">/*父节点*/</span>
	<span class="token keyword">struct</span>	<span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>    <span class="token comment">/*子节点*/</span>
	<span class="token keyword">struct</span>	<span class="token class-name">device_node</span> <span class="token operator">*</span>sibling<span class="token punctuation">;</span>  <span class="token comment">/*节点的兄弟，即同级节点*/</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_OF_KOBJ<span class="token punctuation">)</span></span></span>
	<span class="token keyword">struct</span>	<span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span>
	<span class="token keyword">void</span>	<span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_SPARC<span class="token punctuation">)</span></span></span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path_component_name<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">of_irq_controller</span> <span class="token operator">*</span>irq_trans<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>与查找节点相关的，有如下函数。</p> 
<h4><a id="of_find_node_by_name_55"></a>of_find_node_by_name</h4> 
<p><code>of_find_node_by_name</code>通过节点名字查找指定的节点，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
										<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> <code>from：</code> 开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。<br> <code>name：</code> 要查找的节点名字。</p> 
<h4><a id="of_find_node_by_type_68"></a>of_find_node_by_type</h4> 
<p><code>of_find_node_by_type</code>通过 device_type 属性<code>(过时了，建议不用)</code>查找指定的节点，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_type</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
										<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<p><code>from：</code> 开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。</p> 
<p><code>type：</code> 要查找的节点对应的 type 字符串，也就是 device_type 属性值。</p> 
<p><code>返回值：</code> 找到的节点，如果为 NULL 表示查找失败。</p> 
<h4><a id="of_find_compatible_node_85"></a>of_find_compatible_node</h4> 
<p><code>of_find_compatible_node</code>根据 device_type 和 compatible 这两个属性查找指定的节点，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_compatible_node</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>from<span class="token punctuation">,</span>
											<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">,</span>
											<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>compatible<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> <code>from：</code> 开始查找的节点，如果为 NULL 表示从根节点开始查找整个设备树。<br> <code>type：</code> 要查找的节点对应的 type 字符串，也就是 device_type 属性值，可以为 NULL，表示忽略掉 device_type 属性。<br> <code>compatible：</code> 要查找的节点所对应的 compatible 属性列表。<br> <code>返回值：</code> 找到的节点，如果为 NULL 表示查找失败</p> 
<h4><a id="of_find_node_by_path_101"></a>of_find_node_by_path</h4> 
<p><code>of_find_node_by_path</code>通过路径来查找指定的节点，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>path：</code> 带有全路径的节点名，可以使用节点的别名，比如“/backlight”就是 backlight 这个节点的全路径。</li><li><code>返回值：</code> 找到的节点，如果为 NULL 表示查找失败</li></ul> 
<h4><a id="_OF_114"></a>查找父/子节点的 OF</h4> 
<h4><a id="of_get_parent_116"></a>of_get_parent</h4> 
<p><code>of_get_parent</code>用于获取指定节点的父节点，原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_get_parent</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>node：</code> 需要查找父节点的子节点；</li><li><code>返回值：</code> 返回父节点；</li></ul> 
<h4><a id="of_get_next_child_129"></a>of_get_next_child</h4> 
<p><code>of_get_next_child</code>用迭代的查找子节点，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token function">of_get_next_child</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">,</span>
									<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>prev<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>node：</code> 父节点；</li><li><code>prev：</code> 前一个子节点，也就是从哪一个子节点开始迭代的查找下一个子节点。可以设置为NULL，表示从第一个子节点开始。</li><li><code>返回值：</code> 找到的下一个子节点。</li></ul> 
<h4><a id="of_get_next_child_144"></a>of_get_next_child</h4> 
<p>节点的属性信息里面保存了驱动所需要的内容，因此对于属性值的提取非常重要， Linux 内核中使用结构体 property 表示属性，此结构体同样定义在文件 <code>include/linux/of.h</code> 中，内容如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span> <span class="token comment">/* 属性名字 */</span>
	<span class="token keyword">int</span> length<span class="token punctuation">;</span> <span class="token comment">/* 属性长度 */</span>
	<span class="token keyword">void</span> <span class="token operator">*</span>value<span class="token punctuation">;</span> <span class="token comment">/* 属性值 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>next<span class="token punctuation">;</span> <span class="token comment">/* 下一个属性 */</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> unique_id<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">bin_attribute</span> attr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_160"></a>提取属性值</h4> 
<p>Linux 内核也提供了提取属性值的 OF。</p> 
<h4><a id="of_find_property_164"></a>of_find_property</h4> 
<p><code>of_find_property</code>用于查找指定的属性，函数原型如下：</p> 
<pre><code class="prism language-c">property <span class="token operator">*</span><span class="token function">of_find_property</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
							<span class="token keyword">int</span> <span class="token operator">*</span>lenp<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点；</li><li><code>name：</code> 属性名字；</li><li><code>lenp：</code> 属性值的字节数；</li></ul> 
<p><code>返回值：</code> 找到的属性。</p> 
<h4><a id="of_property_count_elems_of_size_182"></a>of_property_count_elems_of_size</h4> 
<p>of_property_count_elems_of_size用于获取属性中元素的数量，比如 reg 属性值是一个数组，那么使用此函数可以获取到这个数组的大小，此函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
									<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
									<span class="token keyword">int</span> elem_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点。</li><li><code>proname：</code> 需要统计元素数量的属性名字。</li><li><code>elem_size：</code> 元素长度。</li></ul> 
<p><code>返回值：</code> 得到的属性元素数量。</p> 
<h4><a id="of_property_read_u32_index_200"></a>of_property_read_u32_index</h4> 
<p><code>of_property_read_u32_index</code>用于从属性中获取指定标号的 u32 类型数据值(无符号 32位)，比如某个属性有多个 u32 类型的值，那么就可以使用此函数来获取指定标号的数据值，此函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_u32_index</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
								<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
								u32 index<span class="token punctuation">,</span>
								u32 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点；</li><li><code>proname：</code> 要读取的属性名字；</li><li><code>index：</code> 要读取的值标号；</li><li><code>out_value：</code> 读取到的值；</li></ul> 
<p><code>返回值：</code> 0 读取成功，负值，读取失败， -EINVAL 表示属性不存在， -ENODATA 表示没有要读取的数据， -EOVERFLOW 表示属性值列表太小。</p> 
<h4><a id="of_property_read_u8_array_220"></a>of_property_read_u8_array</h4> 
<h4><a id="of_property_read_u16_array_222"></a>of_property_read_u16_array</h4> 
<h4><a id="of_property_read_u32_array_224"></a>of_property_read_u32_array</h4> 
<h4><a id="of_property_read_u64_array_226"></a>of_property_read_u64_array</h4> 
<p>这 4 个函数分别是读取属性中 u8、 u16、 u32 和 u64 类型的数组数据，比如大多数的 reg 属性都是数组数据，可以使用这 4 个函数一次读取出 reg 属性中的所有数据。这四个函数的原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_u8_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
							u8 <span class="token operator">*</span>out_values<span class="token punctuation">,</span>
							<span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u16_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
							u16 <span class="token operator">*</span>out_values<span class="token punctuation">,</span>
							<span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u32_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
							u32 <span class="token operator">*</span>out_values<span class="token punctuation">,</span>
							<span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u64_array</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
							u64 <span class="token operator">*</span>out_values
							<span class="token class-name">size_t</span> sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点；</li><li><code>proname：</code> 要读取的属性名字；</li><li><code>out_value：</code> 读取到的数组值，分别为 u8、 u16、 u32 和 u64。</li><li><code>sz：</code> 要读取的数组元素数量。</li></ul> 
<p><code>返回值：</code> 0，读取成功，负值，读取失败， -EINVAL 表示属性不存在， -ENODATA 表示没有要读取的数据， -EOVERFLOW 表示属性值列表太小。</p> 
<h4><a id="of_property_read_u8_258"></a>of_property_read_u8</h4> 
<h4><a id="of_property_read_u16_260"></a>of_property_read_u16</h4> 
<h4><a id="of_property_read_u32_262"></a>of_property_read_u32</h4> 
<h4><a id="of_property_read_u64_264"></a>of_property_read_u64</h4> 
<p>有些属性只有一个整形值，这四个函数就是用于读取这种只有一个整形值的属性，分别用<br> 于读取 u8、 u16、 u32 和 u64 类型属性值，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_u8</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
						<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
						u8 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u16</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
						<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
						u16 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
						<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
						u32 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">of_property_read_u64</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
						<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
						u64 <span class="token operator">*</span>out_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点。</li><li><code>proname：</code> 要读取的属性名字。</li><li><code>out_value：</code> 读取到的数组值。</li></ul> 
<p><code>返回值：</code> 0，读取成功，负值，读取失败， -EINVAL 表示属性不存在， -ENODATA 表示没有要读取的数据， -EOVERFLOW 表示属性值列表太小。</p> 
<h4><a id="of_property_read_string_292"></a>of_property_read_string</h4> 
<p><code>of_property_read_string</code>用于读取属性中字符串值，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>propname<span class="token punctuation">,</span>
							<span class="token keyword">const</span> <span class="token keyword">char</span> `out_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点。</li><li><code>proname：</code> 要读取的属性名字。</li><li><code>out_string：</code> 读取到的字符串值。</li></ul> 
<p><code>返回值：</code> 0，读取成功，负值，读取失败。</p> 
<h4><a id="of_n_addr_cells_310"></a>of_n_addr_cells</h4> 
<p>of_n_addr_cells用于获取 <code>#address-cells</code> 属性值，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_n_addr_cells</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点。</li><li><code>返回值：</code> 获取到的#address-cells 属性值。</li></ul> 
<h4><a id="of_n_size_cells_323"></a>of_n_size_cells</h4> 
<p><code>of_size_cells</code>用于获取 <code>#size-cells</code> 属性值，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_n_size_cells</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点。</li></ul> 
<p><code>返回值：</code> 获取到的#size-cells 属性值。</p> 
<h4><a id="_OF_337"></a>其他常用的 OF</h4> 
<h4><a id="of_get_address_339"></a>of_get_address</h4> 
<p>of_get_address用于获取地址相关属性，主要是“reg”或者“assigned-addresses”属性<br> 值，函数属性如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> __be32 <span class="token operator">*</span><span class="token function">of_get_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
							<span class="token keyword">int</span> index<span class="token punctuation">,</span>
							u64 <span class="token operator">*</span>size<span class="token punctuation">,</span>
							<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>dev：</code> 设备节点。</li><li><code>index：</code> 要读取的地址标号。</li><li><code>size：</code> 地址长度。</li><li><code>flags：</code> 参数，比如 IORESOURCE_IO、 IORESOURCE_MEM 等</li></ul> 
<p><code>返回值：</code> 读取到的地址数据首地址，为 NULL 的话表示读取失败。</p> 
<h4><a id="of_translate_address_360"></a>of_translate_address</h4> 
<p>of_translate_address负责将从设备树读取到的地址转换为物理地址，函数原型如下：</p> 
<pre><code class="prism language-c">u64 <span class="token function">of_translate_address</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
						<span class="token keyword">const</span> __be32 <span class="token operator">*</span>in_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>dev：</code> 设备节点。</li><li><code>in_addr：</code> 要转换的地址。</li></ul> 
<p><code>返回值：</code> 得到的物理地址，如果为 OF_BAD_ADDR 的话表示转换失败。</p> 
<h4><a id="of_address_to_resource_376"></a>of_address_to_resource</h4> 
<p>resource结构体描述的都是设备资源信息， resource 结构体定义在文件include/linux/ioport.h 中，定义如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">resource_size_t</span> start<span class="token punctuation">;</span> <span class="token comment">/*起始地址，对于32位soc，resource_size_t 的数据类型是u32*/</span>
	<span class="token class-name">resource_size_t</span> end<span class="token punctuation">;</span> <span class="token comment">/*结束地址*/</span>
	<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>  <span class="token comment">/*资源的名字*/</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span> <span class="token comment">/*资源标志位，一般表示资源类型,可选的资源标志定义在文件 include/linux/ioport.h,如IORESOURCE_BITS、IORESOURCE_MEM、IORESOURCE_IRQ等 */</span>
	<span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> <span class="token operator">*</span>sibling<span class="token punctuation">,</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>of_address_to_resource是从设备树里面提取资源值，但是本质上就是将 reg 属性值，然后将其转换为 resource 结构体类型，函数原型如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_address_to_resource</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
							<span class="token keyword">int</span> index<span class="token punctuation">,</span>
							<span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>dev：</code> 设备节点。</li><li><code>index：</code> 地址资源标号。</li><li><code>r：</code> 得到的 resource 类型的资源值。</li></ul> 
<p><code>返回值：</code> 0，成功；负值，失败。</p> 
<h4><a id="of_iomap_406"></a>of_iomap</h4> 
<p><code>of_iomap</code>用于直接内存映射，以前我们会通过 <code>ioremap</code>来完成物理地址到虚拟地址的映射，采用设备树以后就可以直接通过 <code>of_iomap</code>来获取内存地址所对应的虚拟地址，不需要使用 ioremap了。该函数的原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> __iomem <span class="token operator">*</span><span class="token function">of_iomap</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
						<span class="token keyword">int</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：</p> 
<ul><li><code>np：</code> 设备节点。</li><li><code>index：</code> reg 属性中要完成内存映射的段，如果 reg 属性只有一段的话 index 就设置为 0。</li></ul> 
<p><code>返回值：</code> 经过内存映射后的虚拟内存首地址，如果为 NULL 的话表示内存映射失败。</p> 
<h4><a id="_422"></a>例子</h4> 
<p>目的：期望通过<code>linux/of.h</code>中相关函数，在驱动中读取设备树相关结点信息和属性信息</p> 
<p>要求：</p> 
<ul><li>①读取设备树<code>/backlight</code>结点下的属性，以及属性信息，合理处理返回值和错误信息</li><li>②设计一个能够读取<code>u32</code>类型属性的通用函数，并在<code>init</code>函数中输出信息</li></ul> 
<h4><a id="_431"></a>设备树</h4> 
<pre><code class="prism language-c"><span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    backlight <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"pwm-backlight"</span><span class="token punctuation">;</span>
        pwms <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pwm1 <span class="token number">0</span> <span class="token number">5000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        brightness<span class="token operator">-</span>levels <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">4</span> <span class="token number">8</span> <span class="token number">16</span> <span class="token number">32</span> <span class="token number">64</span> <span class="token number">128</span> <span class="token number">255</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">-</span>brightness<span class="token operator">-</span>level <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">6</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
        wp<span class="token operator">-</span>inverted <span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_446"></a>驱动程序</h4> 
<pre><code class="prism language-c"><span class="token comment">/* 此文件为linux 内核 of函数测试文件
 *  实验目的：在init函数中使用of函数读取设备树中的 根节点下xxx设备节点信息
 *  其路径为： 
 */</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/types.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/kernel.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/delay.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/init.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/module.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/fs.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/uaccess.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/io.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/cdev.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_platform.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/of_device.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;linux/slab.h&gt;</span></span>

<span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token operator">*</span> ofdts_node<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">property</span><span class="token operator">*</span>    blprop<span class="token punctuation">;</span>
<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> out_string<span class="token punctuation">;</span>
<span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mem_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
u32<span class="token operator">*</span> out_values<span class="token punctuation">;</span>
<span class="token keyword">static</span> u32 <span class="token function">show_members</span><span class="token punctuation">(</span><span class="token keyword">int</span> mem_count<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> prop_name<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 i<span class="token punctuation">;</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>mem_count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fail_property_count_elems_of_size!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mem_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>   
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s中有%d个元素\n"</span><span class="token punctuation">,</span>prop_name<span class="token punctuation">,</span> mem_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>mem_count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s中有%d个元素\n"</span><span class="token punctuation">,</span>prop_name<span class="token punctuation">,</span> mem_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out_values <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span> <span class="token operator">*</span> mem_count<span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>out_values<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fail_mem\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        ret <span class="token operator">=</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>ofdts_node<span class="token punctuation">,</span> prop_name<span class="token punctuation">,</span> out_values<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fail_read_u32!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">kfree</span><span class="token punctuation">(</span>out_values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s中的元素为：%d\n"</span><span class="token punctuation">,</span>prop_name<span class="token punctuation">,</span> <span class="token operator">*</span>out_values<span class="token punctuation">)</span><span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s中有%d个元素\n"</span><span class="token punctuation">,</span>prop_name<span class="token punctuation">,</span> mem_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        out_values <span class="token operator">=</span> <span class="token function">kmalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span> <span class="token operator">*</span> mem_count<span class="token punctuation">,</span>GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token function">of_property_read_u32_array</span><span class="token punctuation">(</span>ofdts_node<span class="token punctuation">,</span> prop_name<span class="token punctuation">,</span> out_values<span class="token punctuation">,</span>mem_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fail_read_u32_array!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">kfree</span><span class="token punctuation">(</span>out_values<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%s中有元素为:"</span><span class="token punctuation">,</span>prop_name<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mem_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"%d\t"</span><span class="token punctuation">,</span>out_values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">ofdts_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"\nofdts_initing.........\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* 0. 提取 backlight 节点*/</span>
    ofdts_node <span class="token operator">=</span> <span class="token function">of_find_node_by_name</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"backlight"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ofdts_node<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> fail_node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"0. 获取节点：%s 成功~\n"</span><span class="token punctuation">,</span> ofdts_node<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 1. 获取compatible = "pwm-backlight"  和 status = "okay"这俩都是字符串类型的，使用两个不同的函数分别测试*/</span>
    <span class="token comment">// 1 compatible</span>
    ret <span class="token operator">=</span> <span class="token function">of_property_read_string</span><span class="token punctuation">(</span>ofdts_node<span class="token punctuation">,</span> <span class="token string">"compatible"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> fail_property_read_string<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"1.0 获取compatible成功：%s\n"</span><span class="token punctuation">,</span> out_string<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 2 status</span>
    blprop <span class="token operator">=</span> <span class="token function">of_find_property</span><span class="token punctuation">(</span>ofdts_node<span class="token punctuation">,</span> <span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>blprop<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">goto</span> fail_find_property<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"1.1 获取status成功：%s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>blprop<span class="token operator">-&gt;</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* 2. 获取default-brightness-level = &lt;6&gt;; */</span>
    mem_count <span class="token operator">=</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span>ofdts_node<span class="token punctuation">,</span> <span class="token string">"default-brightness-level"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">show_members</span><span class="token punctuation">(</span>mem_count<span class="token punctuation">,</span> <span class="token string">"default-brightness-level"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>result <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/* 3. brightness-levels = &lt;0 4 8 16 32 64 128 255&gt;; */</span>
    mem_count <span class="token operator">=</span> <span class="token function">of_property_count_elems_of_size</span><span class="token punctuation">(</span>ofdts_node<span class="token punctuation">,</span> <span class="token string">"brightness-levels"</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>u32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> <span class="token function">show_members</span><span class="token punctuation">(</span>mem_count<span class="token punctuation">,</span> <span class="token string">"brightness-levels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ofdts_init.........OK!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>

    fail_find_property<span class="token operator">:</span>
    fail_property_read_string<span class="token operator">:</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fail_property_read_string!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
    fail_node<span class="token operator">:</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"fail_find_node_byname!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token keyword">static</span> <span class="token keyword">void</span> __exit <span class="token function">ofdts_exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">kfree</span><span class="token punctuation">(</span>out_values<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">printk</span><span class="token punctuation">(</span><span class="token string">"ofdts_exit.........OK!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* 注册函数 */</span>
<span class="token function">module_init</span><span class="token punctuation">(</span>ofdts_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">module_exit</span><span class="token punctuation">(</span>ofdts_exit<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* license和作者*/</span>
<span class="token function">MODULE_LICENSE</span><span class="token punctuation">(</span><span class="token string">"GPL"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">MODULE_AUTHOR</span><span class="token punctuation">(</span><span class="token string">"QJY"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意：程序能够测试通过，可能返回值处理以及错误处理有不合理之处，作者并未排查，本程序仅作为练习测试使用；</p> 
<p>测试结果：</p> 
<pre><code class="prism language-makefile">lib/modules/4.1.15 #modprobe ofdts
ofdts_initing. . . .. . . . .
0．获取节点: backlight成功~
1.0获取compatible成功:pwm-backlight
1.1 获取status成功:okay
default-brightness-level中有1个元素
default-brightness-level中的元素为:6
brightness-levels中有8个元素
brightness-levels中有元素为:0 4 8 16 32 64 128 255
ofdts_init....OK!!
</code></pre> 
<h3><a id="2_dtb_601"></a>2. dtb格式</h3> 
<p>​ dtb作为二进制文件被加载到内存中，然后由内核读取并进行解析，如果对dtb文件的格式不了解，那么在看设备树解析相关的内核代码时将会寸步难行，而阅读源代码才是了解设备树最好的方式。所以，如果需要更透彻的了解设备树解析的细节，第一步就是需要了解设备树的格式。</p> 
<h4><a id="dtb_605"></a>dtb的由来</h4> 
<p>​ 设备树的一般操作方式是：开发人员根据开发需求编写dts文件，然后使用dtc将dts编译成dtb文件。dts文件是文本格式的文件，而dtb是二进制文件，在linux启动时被加载到内存中，接下来我们需要来分析设备树dtb文件的格式。</p> 
<h4><a id="dtb_609"></a>dtb格式总览</h4> 
<p>dtb的格式是这样的：</p> 
<table><thead><tr><th>start</th><th>struct boot_param_header</th></tr></thead><tbody><tr><td></td><td>(alignment gap)</td></tr><tr><td></td><td>memory reserve map</td></tr><tr><td></td><td>(alignment gap)</td></tr><tr><td></td><td>device-tree structure</td></tr><tr><td></td><td>(alignment gap)</td></tr><tr><td>end</td><td>device-tree strings</td></tr></tbody></table> 
<h4><a id="dtb_header_622"></a>dtb header</h4> 
<p>​ 但凡涉及到数据的记录，就一定会有一个总的描述部分，就像磁盘的超级块，书的目录，dtb当然也不例外，这个描述头部就是dtb的header部分，通过这个header部分，用户可以快速地了解到整个dtb的大致信息。</p> 
<p>header可以用这么一个结构体来描述：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">fdt_header</span> <span class="token punctuation">{<!-- --></span>
	<span class="token class-name">fdt32_t</span> magic<span class="token punctuation">;</span>			 <span class="token comment">/* magic word FDT_MAGIC */</span>
	<span class="token class-name">fdt32_t</span> totalsize<span class="token punctuation">;</span>		 <span class="token comment">/* total size of DT block */</span>
	<span class="token class-name">fdt32_t</span> off_dt_struct<span class="token punctuation">;</span>		 <span class="token comment">/* offset to structure */</span>
	<span class="token class-name">fdt32_t</span> off_dt_strings<span class="token punctuation">;</span>		 <span class="token comment">/* offset to strings */</span>
	<span class="token class-name">fdt32_t</span> off_mem_rsvmap<span class="token punctuation">;</span>		 <span class="token comment">/* offset to memory reserve map */</span>
	<span class="token class-name">fdt32_t</span> version<span class="token punctuation">;</span>		 <span class="token comment">/* format version */</span>
	<span class="token class-name">fdt32_t</span> last_comp_version<span class="token punctuation">;</span>	 <span class="token comment">/* last compatible version */</span>

	<span class="token comment">/* version 2 fields below */</span>
	<span class="token class-name">fdt32_t</span> boot_cpuid_phys<span class="token punctuation">;</span>	 <span class="token comment">/* Which physical CPU id we're
						booting on */</span>
	<span class="token comment">/* version 3 fields below */</span>
	<span class="token class-name">fdt32_t</span> size_dt_strings<span class="token punctuation">;</span>	 <span class="token comment">/* size of the strings block */</span>

	<span class="token comment">/* version 17 fields below */</span>
	<span class="token class-name">fdt32_t</span> size_dt_struct<span class="token punctuation">;</span>		 <span class="token comment">/* size of the structure block */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="magic_649"></a><code>.magic</code></h5> 
<p>设备树的魔数，魔数其实就是一个用于识别的数字，表示设备树的开始，linux dtb的魔数为 <code>0xd00dfeed</code></p> 
<h5><a id="totalsize_653"></a><code>.totalsize</code></h5> 
<p>这个设备树的size，也可以理解为所占用的实际内存空间。</p> 
<h5><a id="off_dt_struct_657"></a><code>.off_dt_struct</code></h5> 
<p>offset to dt_struct，表示整个dtb中structure部分所在内存相对头部的偏移地址</p> 
<h5><a id="off_dt_strings_661"></a><code>.off_dt_strings</code></h5> 
<p>offset to dt_string，表示整个dtb中string部分所在内存相对头部的偏移地址</p> 
<h5><a id="off_mem_rsvmap_665"></a><code>.off_mem_rsvmap</code></h5> 
<p>offset to memory reserve map，dtb中memory reserve map所在内存相对头部的偏移地址</p> 
<h5><a id="version_669"></a><code>.version</code></h5> 
<p>设备树的版本，截至目前的最新版本为17.</p> 
<h5><a id="last_comp_version_673"></a><code>.last_comp_version</code></h5> 
<p>最新的兼容版本</p> 
<h5><a id="boot_cpuid_phys_677"></a><code>.boot_cpuid_phys</code></h5> 
<p>这部分仅在版本2中存在，后续版本不再使用。</p> 
<h5><a id="size_dt_strings_681"></a><code>.size_dt_strings</code></h5> 
<p>表示整个dtb中string部分的大小</p> 
<h5><a id="size_dt_struct_685"></a><code>.size_dt_struct</code></h5> 
<p>表示整个dtb中struct部分的大小</p> 
<h5><a id="alignment_gap_689"></a><code>.alignment gap</code></h5> 
<p>中间的alignment gap部分表示对齐间隙，它并非是必须的，它是否被提供以及大小由具体的平台对数据对齐和的要求以及数据是否已经对齐来决定。</p> 
<h5><a id="memory_reserve_map_693"></a><code>.memory reserve map</code></h5> 
<p>memory reserve map：描述保留的内存部分，这个map的数据结构是这样的：</p> 
<pre><code class="prism language-c"><span class="token punctuation">{<!-- --></span>
	<span class="token class-name">uint64_t</span> physical_address<span class="token punctuation">;</span>
	<span class="token class-name">uint64_t</span> size<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 这部分存储了此结构的列表，整个部分的结尾由一个数据为0的结构来表示(即physical_address和size都为0，总共16字节)。</p> 
<p>​ 这一部分的数据并非是节点中的memory子节点，而是在设备开始之前(也就是第一个花括号之前)定义的,例如：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span>
<span class="token operator">/</span>memreserve<span class="token operator">/</span> <span class="token number">0x10000000</span>  <span class="token number">0x100000</span>
<span class="token comment">/* 在结构提中的表示为 physical_address=0x10000000, size=0x100000 */</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 这一部分的作用是告诉内核哪一些内存空间需要被保留而不应该被系统覆盖使用，因为在内核启动时常常需要动态申请大量的内存空间，只有提前进行注册，用户需要使用的内存才不会被系统征用而造成数据覆盖。</p> 
<p>​ 值得一提的是，对于设备树而言，即使不指定保留内存，系统也会默认为设备树保留相应的内存空间。同时，这一部分需要64位(8字节)对齐。</p> 
<h4><a id="devicetree_structure_721"></a>device-tree structure</h4> 
<p>device-tree structure：每个节点都会被描述为一个struct，节点之间可以嵌套，因此也会有嵌套的struct。</p> 
<ul><li> <p>一个node开始信号，OF_DT_BEGIN_NODE, 内容为：0x00000001</p> </li><li> <p>对于版本1-3而言，这一部分是节点的全路径，以/开头，而对于版本16及以上，这部分只是unit name(root 除外，它没有unit name)，unit name是以0结尾的字符串</p> </li><li> <p>可选的对齐字节</p> </li><li> <p>对于每个属性字段：</p> 
  <ul><li>由OF_DT_PROP标识，数据为<code>0x00000003</code></li><li>32位的数据，表示属性的size</li><li>32位的数据，表示属性名在string block中的偏移地址</li><li>属性中的value data.</li></ul> </li><li> <p>如果有子节点，递归地对子节点进行描述。</p> </li><li> <p>节点结束信号，OF_DT_END_NODE ，数据为<code>0x00000002</code>.<br> 每个节点的信息都按照上述结构被描述，需要注意的是，所有用于描述一个特定节点的属性都必须在任何子节点之前定义，虽然设备树的层次结构不会因此产生二义性，但是linux kernel的解析程序要求这么做。</p> </li></ul> 
<h4><a id="devicetree_strings_738"></a>device-tree strings</h4> 
<p>​ device-tree strings：在dtb中有大量的重复字符串，比如"model","compatile"等等，为了节省空间，将这些字符串统一放在某个地址，需要使用的时候直接使用索引来查看。</p> 
<p>​ 需要注意的是，属性部分格式为key = value，key部分被放置在strings部分，而value部分的字符串并不会放在这一部分，而是直接放在structure中。</p> 
<h4><a id="dtb_744"></a>dtb文件解析示例</h4> 
<p>光说不练假把式，下面我就使用一个简单的示例来剖析dtb的文件格式。</p> 
<p>下述示例仅仅是一个演示demo，不针对任何平台，为了演示方便，编写了一个非常简单的dts文件。</p> 
<pre><code class="prism language-c"><span class="token operator">/</span>dts<span class="token operator">-</span>v1<span class="token operator">/</span><span class="token punctuation">;</span>
<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    compatible <span class="token operator">=</span> <span class="token string">"hd,test_dts"</span><span class="token punctuation">,</span> <span class="token string">"hd,test_xxx"</span><span class="token punctuation">;</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    model <span class="token operator">=</span> <span class="token string">"HD test dts"</span><span class="token punctuation">;</span>

    chosen <span class="token punctuation">{<!-- --></span>
        <span class="token constant">stdout</span><span class="token operator">-</span>path <span class="token operator">=</span> <span class="token string">"/ocp/serial@ffff"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    memory@<span class="token number">80000000</span> <span class="token punctuation">{<!-- --></span>
        device_type <span class="token operator">=</span> <span class="token string">"memory"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x80000000</span> <span class="token number">0x10000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    led1<span class="token operator">:</span>led@<span class="token number">2000000</span> <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"test_led"</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x200</span> <span class="token number">0x4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>​ 编译当前dts文件，获取对应的dtb文件。</p> 
<p>鉴于dtb文件为二进制文件，普通编辑器打开显示乱码，我们使用ultraEdit查看，它将数据以16进制形式显示：</p> 
<p><img src="https://images2.imgbox.com/fd/c6/VdFb6yUA_o.png" alt="在这里插入图片描述"></p> 
<p>整个dtb文件还是比较简单的，图中的红色框出的部分为header部分的数据，可以看到：</p> 
<pre><code class="prism language-x86asm">第1个四字节对应magic，数据为 D00DFEED.
第2四字节对应totalsize，数据为 000001BC，可以由整张图片看出，这个dtb文件的大小由0x0~0x1bb,大小刚好是0x1bc
第3个四字节对应off_dt_struct，数据为00000038。
第4个四字节对应off_dt_strings，数据为00000174，可以由整张图片看到，从0x174开始刚好是字符串开始的地方
第5个四字节对应off_mem_rsvmap，数据为00000028
第6个四字节对应version，数据为00000011，十进制为17
第7个四字节对应last_comp_version，数据为00000010，十进制为16，表示兼容版本16
第8个四字节对应boot_cpuid_phys，数据为00000000，仅在版本2中使用，这里为0
第9个四字节对应size_dt_strings，数据为00000048，表示字符串总长。
第10个四字节对应size_dt_struct，数据为0000013c，表示struct部分总长度。
</code></pre> 
<p>​ 整个头部为40字节，16进制为0x28，从头部信息中off_mem_rsvmap部分可以得到，reserve memory起始地址为0x28，上文中提到，这一部分使用一个16字节的struct来描述，以一个全为0的struct结尾。</p> 
<p>后16字节全为0，可以看出，这里并没有设置reserve memory。</p> 
<h3><a id="structure__800"></a>structure 部分</h3> 
<p>上文回顾：每一个属性都是以 key = value的形式来描述，value部分可选。</p> 
<p>偏移地址来到0x00000038(0x28+0x10),接下来8个字节为00000003，根据上述structure中的描述，这是OF_DT_PROP，即标示属性的开始。</p> 
<p>接下来4字节为00000018，表明该属性的value部分size为24字节。</p> 
<p>接下来4字节是当前属性的key在string 部分的偏移地址，这里是00000000，由头部信息中off_dt_strings可以得到，string部分的开始为00000174，偏移地址为0，所以对应字符串为"compatible".</p> 
<p>之后就是value部分，这部分的数据是字符串，可以直接从图片右侧栏看出，总共24字节的字符串"hd,test_dts", “hd,test_xxx”,因为字符串之间以0结尾，所以程序可以识别出这是两个字符串。</p> 
<p>可以看出，到这里，compatible = “hd,test_dts”, “hd,test_xxx”;这个属性就被描述完了，对于属性的描述还是非常简单的。</p> 
<p>按照固有的规律，接下来就是对#address-cells = &lt;0x1&gt;的解析，然后是#size-cells = &lt;0x1&gt;…</p> 
<p>然后就是递归的子节点chosen，memory@80000000等等都是按照上文中提到的structure解析规则来进行解析，最后以00000002结尾。</p> 
<p>与根节点不同的是，子节点有一个unit name，即chosen，memory@80000000这些名称，并非节点中的.name属性。</p> 
<p>而整个结构的结束由00000009来描述。</p> 
<p>一般而言，在32位系统中，dtc在编译dts文件时会自动考虑对齐问题，所以对于设备树的对齐字节，我们只需要有所了解即可，并不会常接触到。</p> 
<h3><a id="3_dtbdevice_824"></a>3. dtb转换成device</h3> 
<p>​ 前面我们了解到dtb的内存分布以后（<a href="https://www.cnblogs.com/schips/p/linux_driver_dts_the_format_of_dtb.html" rel="nofollow">dtb格式</a>），接下来就来看看内核是如何把设备树解析成所需的<code>device_node</code>。</p> 
<h4><a id="setup_arch_828"></a>设备树的执行入口setup_arch</h4> 
<p>linux最底层的初始化部分在HEAD.s中，这是汇编代码，我们暂且不作过多讨论。</p> 
<p>在head.s完成部分初始化之后，就开始调用C语言函数，而被调用的第一个C语言函数就是<code>start_kernel</code>：</p> 
<pre><code class="prism language-c">asmlinkage __visible <span class="token keyword">void</span> __init <span class="token function">start_kernel</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//...</span>
    <span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>而对于设备树的处理，基本上就在<code>setup_arch()</code>这个函数中。</p> 
<p>可以看到，在<code>start_kernel()</code>中调用了<code>setup_arch(&amp;command_line);</code></p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> __init <span class="token function">setup_arch</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>cmdline_p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span>mdesc<span class="token punctuation">;</span>
    
    <span class="token comment">/* 根据传入的设备树dtb的首地址完成一些初始化操作 */</span>
    mdesc <span class="token operator">=</span> <span class="token function">setup_machine_fdt</span><span class="token punctuation">(</span>__atags_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* ... */</span>
    
    <span class="token comment">/* 保证设备树dtb本身存在于内存中而不被覆盖 */</span>
    <span class="token function">arm_memblock_init</span><span class="token punctuation">(</span>mdesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">/* ... */</span>
    <span class="token comment">/* 对设备树具体的解析 */</span>
    <span class="token function">unflatten_device_tree</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* ... */</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这三个被调用的函数就是主要的设备树处理函数：</p> 
<ul><li><code>setup_machine_fdt()</code>：根据传入的设备树dtb的首地址完成一些初始化操作。</li><li><code>arm_memblock_init()</code>：主要是内存相关函数，为设备树保留相应的内存空间，保证设备树dtb本身存在于内存中而不被覆盖。用户可以在设备树中设置保留内存，这一部分同时作了保留指定内存的工作。</li><li><code>unflatten_device_tree()</code>：对设备树具体的解析，事实上在这个函数中所做的工作就是将设备树各节点转换成相应的<code>struct device_node</code>结构体。</li></ul> 
<p>下面我们再来通过代码跟踪仔细分析。</p> 
<h3><a id="setup_machine_fdt_875"></a>setup_machine_fdt</h3> 
<pre><code class="prism language-c">    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span>mdesc<span class="token punctuation">;</span>
    
    <span class="token comment">// 根据传入的设备树dtb的首地址完成一些初始化操作</span>
    mdesc <span class="token operator">=</span> <span class="token function">setup_machine_fdt</span><span class="token punctuation">(</span>__atags_pointer<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>__atags_pointer</code>这个全局变量存储的就是r2的寄存器值，是设备树在内存中的起始地址,将设备树起始地址传递给<code>setup_machine_fdt</code>，对设备树进行解析。</p> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span> __init <span class="token function">setup_machine_fdt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> dt_phys<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span>mdesc<span class="token punctuation">,</span> <span class="token operator">*</span>mdesc_best <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token comment">// 内存地址检查</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dt_phys <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">early_init_dt_verify</span><span class="token punctuation">(</span><span class="token function">phys_to_virt</span><span class="token punctuation">(</span>dt_phys<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">// 读取 compatible 属性</span>
    mdesc <span class="token operator">=</span> <span class="token function">of_flat_dt_match_machine</span><span class="token punctuation">(</span>mdesc_best<span class="token punctuation">,</span> arch_get_next_mach<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 扫描各个子节点</span>
    <span class="token function">early_init_dt_scan_nodes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>setup_machine_fdt</code>主要是获取了一些设备树提供的总览信息。</p> 
<h4><a id="_905"></a>内存地址检查</h4> 
<p>先将设备树在内存中的物理地址转换为虚拟地址</p> 
<p>然后再检查该地址上是否有设备树的魔数(magic)，魔数就是一串用于识别的字节码：</p> 
<ul><li>如果没有或者魔数不匹配，表明该地址没有设备树文件，函数返回失败</li><li>否则验证成功，将设备树地址赋值给全局变量<code>initial_boot_params</code>。</li></ul> 
<h4><a id="compatible_914"></a>读取compatible属性</h4> 
<p>逐一读取设备树根目录下的<code>compatible</code>属性。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * of_flat_dt_match_machine - Iterate match tables to find matching machine.
 *
 * @default_match: A machine specific ptr to return in case of no match.
 * @get_next_compat: callback function to return next compatible match table.
 *
 * Iterate through machine match tables to find the best match for the machine
 * compatible string in the FDT.
 */</span>
<span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> __init <span class="token function">of_flat_dt_match_machine</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>default_match<span class="token punctuation">,</span>
        <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_next_compat<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span> <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>best_data <span class="token operator">=</span> default_match<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token keyword">const</span> <span class="token operator">*</span>compat<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> dt_root<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> best_score <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">1</span><span class="token punctuation">,</span> score <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 获取首地址</span>
    dt_root <span class="token operator">=</span> <span class="token function">of_get_flat_dt_root</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>data <span class="token operator">=</span> <span class="token function">get_next_compat</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>compat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将compatible中的属性一一与内核中支持的硬件单板相对比，</span>
        <span class="token comment">// 匹配成功后返回相应的machine_desc结构体指针。</span>
        score <span class="token operator">=</span> <span class="token function">of_flat_dt_match</span><span class="token punctuation">(</span>dt_root<span class="token punctuation">,</span> compat<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>score <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> score <span class="token operator">&lt;</span> best_score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            best_data <span class="token operator">=</span> data<span class="token punctuation">;</span>
            best_score <span class="token operator">=</span> score<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>

    <span class="token function">pr_info</span><span class="token punctuation">(</span><span class="token string">"Machine model: %s\n"</span><span class="token punctuation">,</span> <span class="token function">of_flat_dt_get_machine_name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> best_data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>machine_desc</code>结构体中描述了单板相关的一些硬件信息，这里不过多描述。</p> 
<p>主要的的行为就是根据这个<code>compatible</code>属性选取相应的硬件单板描述信息；一般<code>compatible</code>属性名就是"厂商，芯片型号"。</p> 
<h4><a id="_962"></a>扫描各子节点</h4> 
<p>第三部分就是扫描设备树中的各节点，主要分析这部分代码。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> __init <span class="token function">early_init_dt_scan_nodes</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_chosen<span class="token punctuation">,</span> boot_command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_root<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_memory<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>出人意料的是，这个函数中只有一个函数的三个调用，每次调用时，参数不一样。</p> 
<h5><a id="of_scan_flat_dt_977"></a>of_scan_flat_dt</h5> 
<p>首先<code>of_scan_flat_dt()</code>这个函数接收两个参数，一个是函数指针it，一个为相当于函数it执行时的参数。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * of_scan_flat_dt - scan flattened tree blob and call callback on each.
 * @it: callback function
 * @data: context data pointer
 *
 * This function is used to scan the flattened device-tree, it is
 * used to extract the memory information at boot before we can
 * unflatten the tree
 */</span>
<span class="token keyword">int</span> __init <span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>it<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> node<span class="token punctuation">,</span>
                                     <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uname<span class="token punctuation">,</span> <span class="token keyword">int</span> depth<span class="token punctuation">,</span>
                                     <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">,</span>
                           <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>initial_boot_params<span class="token punctuation">)</span> <span class="token operator">+</span>
        <span class="token function">be32_to_cpu</span><span class="token punctuation">(</span>initial_boot_params<span class="token operator">-&gt;</span>off_dt_struct<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> depth <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
        u32 tag <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__be32 <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>pathp<span class="token punctuation">;</span>

        p <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> OF_DT_END_NODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            depth<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> OF_DT_NOP<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> OF_DT_END<span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">==</span> OF_DT_PROP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            u32 sz <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span><span class="token punctuation">(</span>__be32 <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
            p <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">be32_to_cpu</span><span class="token punctuation">(</span>initial_boot_params<span class="token operator">-&gt;</span>version<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0x10</span><span class="token punctuation">)</span>
                p <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> sz <span class="token operator">&gt;=</span> <span class="token number">8</span> <span class="token operator">?</span> <span class="token number">8</span> <span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            p <span class="token operator">+=</span> sz<span class="token punctuation">;</span>
            p <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tag <span class="token operator">!=</span> OF_DT_BEGIN_NODE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">pr_err</span><span class="token punctuation">(</span><span class="token string">"Invalid tag %x in flat device tree!\n"</span><span class="token punctuation">,</span> tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        depth<span class="token operator">++</span><span class="token punctuation">;</span>
        pathp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>p<span class="token punctuation">;</span>
        p <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span>p <span class="token operator">+</span> <span class="token function">strlen</span><span class="token punctuation">(</span>pathp<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pathp <span class="token operator">==</span> <span class="token char">'/'</span><span class="token punctuation">)</span>
            pathp <span class="token operator">=</span> <span class="token function">kbasename</span><span class="token punctuation">(</span>pathp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        rc <span class="token operator">=</span> <span class="token function">it</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> pathp<span class="token punctuation">,</span> depth<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结论：<code>of_scan_flat_dt()</code>函数的作用就是扫描设备树中的节点，然后对各节点分别调用传入的回调函数。</p> 
<p>那么重点关注函数指针，在上述代码中，传入的参数分别为</p> 
<ul><li><code>early_init_dt_scan_chosen</code></li><li><code>early_init_dt_scan_root</code></li><li><code>early_init_dt_scan_memory</code></li></ul> 
<p>从名称可以猜测，这三个函数分别是处理chosen节点、root节点中除子节点外的属性信息、memory节点。</p> 
<h5><a id="early_init_dt_scan_chosen_1051"></a>early_init_dt_scan_chosen</h5> 
<pre><code class="prism language-c"><span class="token function">of_scan_flat_dt</span><span class="token punctuation">(</span>early_init_dt_scan_chosen<span class="token punctuation">,</span> boot_command_line<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>boot_command_line</code>，<code>boot_command_line</code>是一个静态数组，存放着启动参数，</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __init <span class="token function">early_init_dt_scan_chosen</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> node<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uname<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    p <span class="token operator">=</span> <span class="token function">of_get_flat_dt_prop</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"bootargs"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> l <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token function">strlcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>l<span class="token punctuation">,</span> COMMAND_LINE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> __init <span class="token function">early_init_dt_scan_chosen</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> node<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uname<span class="token punctuation">,</span>
                     <span class="token keyword">int</span> depth<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> l<span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>p<span class="token punctuation">;</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"search \"chosen\", depth: %d, uname: %s\n"</span><span class="token punctuation">,</span> depth<span class="token punctuation">,</span> uname<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>depth <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">!</span>data <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>uname<span class="token punctuation">,</span> <span class="token string">"chosen"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>uname<span class="token punctuation">,</span> <span class="token string">"chosen@0"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">early_init_dt_check_for_initrd</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Retrieve command line */</span>
    <span class="token comment">// 找到设备树中的的chosen节点中的bootargs，并作为cmd_line</span>
    p <span class="token operator">=</span> <span class="token function">of_get_flat_dt_prop</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"bootargs"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> l <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token function">strlcpy</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>l<span class="token punctuation">,</span> COMMAND_LINE_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token comment">// ...</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"Command line is: %s\n"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* break now */</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>经过代码分析，<code>early_init_dt_scan_chosen</code>的作用是获取从<code>chosen节点</code>中获取<code>bootargs</code>，然后将<code>bootargs</code>放入<code>boot_command_line</code>中，作为启动参数。</p> 
<blockquote> 
 <p>而非字面意思的处理整个<code>chosen</code>。</p> 
</blockquote> 
<p>以我之前调过的zynq平台为例：</p> 
<pre><code class="prism language-c"><span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    model <span class="token operator">=</span> <span class="token string">"ZynqMP ZCU104 RevA"</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"xlnx,zynqmp-zcu104-revA"</span><span class="token punctuation">,</span> <span class="token string">"xlnx,zynqmp-zcu104"</span><span class="token punctuation">,</span> <span class="token string">"xlnx,zynqmp"</span><span class="token punctuation">;</span>

    aliases <span class="token punctuation">{<!-- --></span>
        ethernet0 <span class="token operator">=</span> <span class="token operator">&amp;</span>gem3<span class="token punctuation">;</span>
        gpio0 <span class="token operator">=</span> <span class="token operator">&amp;</span>gpio<span class="token punctuation">;</span>
        i2c0 <span class="token operator">=</span> <span class="token operator">&amp;</span>i2c1<span class="token punctuation">;</span>
        mmc0 <span class="token operator">=</span> <span class="token operator">&amp;</span>sdhci1<span class="token punctuation">;</span>
        rtc0 <span class="token operator">=</span> <span class="token operator">&amp;</span>rtc<span class="token punctuation">;</span>
        serial0 <span class="token operator">=</span> <span class="token operator">&amp;</span>uart0<span class="token punctuation">;</span>
        serial1 <span class="token operator">=</span> <span class="token operator">&amp;</span>uart1<span class="token punctuation">;</span>
        serial2 <span class="token operator">=</span> <span class="token operator">&amp;</span>dcc<span class="token punctuation">;</span>
        spi0 <span class="token operator">=</span> <span class="token operator">&amp;</span>qspi<span class="token punctuation">;</span>
        usb0 <span class="token operator">=</span> <span class="token operator">&amp;</span>usb0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    chosen <span class="token punctuation">{<!-- --></span>
        bootargs <span class="token operator">=</span> <span class="token string">"earlycon"</span><span class="token punctuation">;</span>
        <span class="token constant">stdout</span><span class="token operator">-</span>path <span class="token operator">=</span> <span class="token string">"serial0:115200n8"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    memory@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        device_type <span class="token operator">=</span> <span class="token string">"memory"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x0</span> <span class="token number">0x0</span> <span class="token number">0x80000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>在支持设备树的嵌入式系统中，实际上：</p> 
<ul><li>uboot基本上可以不通过显式的<code>bootargs=xxx</code>来传递给内核，而是在<code>env</code>拿出，并存放进设备树中的<code>chosen</code>节点中</li><li>Linux也开始在设备树中的<code>chosen</code>节点中获取出来，</li></ul> 
<p>这样子就可以做到针对uboot与Linux在<code>bootargs</code>传递上的统一。</p> 
<h5><a id="early_init_dt_scan_root_1140"></a>early_init_dt_scan_root</h5> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __init <span class="token function">early_init_dt_scan_root</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> node<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uname<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    dt_root_size_cells <span class="token operator">=</span> OF_ROOT_NODE_SIZE_CELLS_DEFAULT<span class="token punctuation">;</span>
    dt_root_addr_cells <span class="token operator">=</span> OF_ROOT_NODE_ADDR_CELLS_DEFAULT<span class="token punctuation">;</span>

    prop <span class="token operator">=</span> <span class="token function">of_get_flat_dt_prop</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"#size-cells"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">)</span>
        dt_root_size_cells <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    prop <span class="token operator">=</span> <span class="token function">of_get_flat_dt_prop</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"#address-cells"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prop<span class="token punctuation">)</span>
        dt_root_addr_cells <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>prop<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过进一步代码分析，<code>early_init_dt_scan_root</code>为了将root节点中的<code>#size-cells</code>和<code>#address-cells</code>属性提取出来，并非获取root节点中所有的属性，放到全局变量<code>dt_root_size_cells</code>和<code>dt_root_addr_cells</code>中。</p> 
<p>size-cells和address-cells表示对一个属性(通常是reg属性)的地址需要多少个四字节描述，而地址的长度需要多少个四字节描述，数据长度基本单位为4。</p> 
<pre><code class="prism language-c"><span class="token comment">// 表示数据大小为一个4字节描述，32位</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token number">1</span></span></span>

<span class="token comment">// 表示地址由一个四字节描述</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token number">1</span></span></span>

<span class="token comment">// 而reg属性由四个四字节组成，所以存在两组地址描述，</span>
<span class="token comment">// 第一组是起始地址为0x12345678，长度为0x100，</span>
<span class="token comment">// 第二组起始地址为0x22，长度为0x4, </span>
<span class="token comment">// 因为在&lt;&gt;中，所有数据都是默认为32位。</span>
reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x12345678</span> <span class="token number">0x100</span> <span class="token number">0x22</span> <span class="token number">0x4</span><span class="token operator">&gt;</span>  
</code></pre> 
<h5><a id="early_init_dt_scan_memory_1176"></a>early_init_dt_scan_memory</h5> 
<pre><code class="prism language-c"><span class="token keyword">int</span> __init <span class="token function">early_init_dt_scan_memory</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> node<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>uname<span class="token punctuation">,</span><span class="token keyword">int</span> depth<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_PPC32<span class="token punctuation">)</span> <span class="token operator">||</span> depth <span class="token operator">!=</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token function">strcmp</span><span class="token punctuation">(</span>uname<span class="token punctuation">,</span> <span class="token string">"memory@0"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    reg <span class="token operator">=</span> <span class="token function">of_get_flat_dt_prop</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    endp <span class="token operator">=</span> reg <span class="token operator">+</span> <span class="token punctuation">(</span>l <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>__be32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>endp <span class="token operator">-</span> reg<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span>dt_root_addr_cells <span class="token operator">+</span> dt_root_size_cells<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        base <span class="token operator">=</span> <span class="token function">dt_mem_next_cell</span><span class="token punctuation">(</span>dt_root_addr_cells<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    size <span class="token operator">=</span> <span class="token function">dt_mem_next_cell</span><span class="token punctuation">(</span>dt_root_size_cells<span class="token punctuation">,</span> <span class="token operator">&amp;</span>reg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">early_init_dt_add_memory_arch</span><span class="token punctuation">(</span>base<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>函数先判断节点的unit name是memory@0,如果不是，则返回。然后将所有memory相关的reg属性取出来，根据address-cell和size-cell的值进行解析，然后调用<code>early_init_dt_add_memory_arch()</code>来申请相应的内存空间。</p> 
<pre><code class="prism language-c">    memory@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        device_type <span class="token operator">=</span> <span class="token string">"memory"</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span> <span class="token number">0x0</span> <span class="token number">0x0</span> <span class="token number">0x80000000</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token number">0x8</span> <span class="token number">0x00000000</span> <span class="token number">0x0</span> <span class="token number">0x80000000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>到这里，setup_machine_fdt()函数对于设备树的第一次扫描解析就完成了，主要是获取了一些设备树提供的总览信息。</p> 
<h3><a id="arm_memblock_init_1205"></a>arm_memblock_init</h3> 
<pre><code class="prism language-c"><span class="token comment">// arch/arm/mm/init.c</span>
<span class="token keyword">void</span> __init <span class="token function">arm_memblock_init</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">machine_desc</span> <span class="token operator">*</span>mdesc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token function">early_init_fdt_reserve_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">early_init_fdt_scan_reserved_mem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于设备树的初始化而言，主要做了两件事：</p> 
<ul><li>调用<code>early_init_fdt_reserve_self</code>，根据设备树的大小为设备树分配空间，设备树的totalsize在dtb头部中有指明，因此当系统启动之后，设备树就一直存在在系统中。</li><li>扫描设备树节点中的"<code>reserved-memory</code>"节点，为其分配保留空间。</li></ul> 
<p><code>memblock_init</code>对于设备树的部分解析就完成了，主要是为设备树指定保留内存空间。</p> 
<h3><a id="unflatten_device_tree_1225"></a>unflatten_device_tree</h3> 
<p>这一部分就进入了设备树的解析部分：</p> 
<p>注意<code>of_root</code>这个对象，我们后续文章中会提到它。实际上，解析以后的数据都是放在了这个对象里面。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> __init <span class="token function">unflatten_device_tree</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 展开设备树</span>
    <span class="token function">__unflatten_device_tree</span><span class="token punctuation">(</span>initial_boot_params<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>of_root<span class="token punctuation">,</span>early_init_dt_alloc_memory_arch<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 扫描设备树</span>
    <span class="token function">of_alias_scan</span><span class="token punctuation">(</span>early_init_dt_alloc_memory_arch<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="_1243"></a>展开设备树</h4> 
<h5><a id="property_1245"></a>property原型</h5> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">char</span>	<span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">int</span>	length<span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token operator">*</span>value<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">property</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>在设备树中，对于属性的描述是<code>key = value</code>，这个结构体中的name和value分别对应key和value，而length表示value的长度；</p> 
<p>next指针指向下一个struct property结构体（用于构成单链表）。</p> 
<h5><a id="__unflatten_device_tree_1261"></a>__unflatten_device_tree</h5> 
<pre><code class="prism language-c"><span class="token function">__unflatten_device_tree</span><span class="token punctuation">(</span>initial_boot_params<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>of_root<span class="token punctuation">,</span>early_init_dt_alloc_memory_arch<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们再来看最主要的设备树解析函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token operator">*</span><span class="token function">__unflatten_device_tree</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dad<span class="token punctuation">,</span>
                              <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>mynodes<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span>dt_alloc<span class="token punctuation">)</span><span class="token punctuation">(</span>u64 size<span class="token punctuation">,</span> u64 align<span class="token punctuation">)</span><span class="token punctuation">,</span>bool detached<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> size<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    size <span class="token operator">=</span> <span class="token function">unflatten_dt_nodes</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> dad<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    mem <span class="token operator">=</span> <span class="token function">dt_alloc</span><span class="token punctuation">(</span>size <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token function">__alignof__</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token function">unflatten_dt_nodes</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> dad<span class="token punctuation">,</span> mynodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>主要的解析函数为<code>unflatten_dt_nodes()</code>，在<code>__unflatten_device_tree()</code>函数中，<code>unflatten_dt_nodes()</code>被调用两次：</p> 
<ul><li>第一次是扫描得出设备树转换成device node需要的空间，然后系统申请内存空间；</li><li>第二次就进行真正的解析工作，我们继续看unflatten_dt_nodes()函数：</li></ul> 
<p>值得注意的是，在第二次调用unflatten_dt_nodes()时传入的参数为unflatten_dt_nodes(blob, mem, dad, mynodes);</p> 
<h6><a id="unflatten_dt_nodes_1290"></a>unflatten_dt_nodes</h6> 
<p>第一个参数是设备树存放首地址，第二个参数是申请的内存空间，第三个参数为父节点，初始值为NULL，第四个参数为mynodes，初始值为of_node.</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">unflatten_dt_nodes</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dad<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>nodepp<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>offset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>offset <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> depth <span class="token operator">&gt;=</span> initial_depth<span class="token punctuation">;</span>offset <span class="token operator">=</span> <span class="token function">fdt_next_node</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>depth<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">populate_node</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mem<span class="token punctuation">,</span>nps<span class="token punctuation">[</span>depth<span class="token punctuation">]</span><span class="token punctuation">,</span>fpsizes<span class="token punctuation">[</span>depth<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token operator">&amp;</span>nps<span class="token punctuation">[</span>depth<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> dryrun<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数中主要的作用就是从根节点开始，对子节点依次调用<code>populate_node()</code>，从函数命名上来看，这个函数就是填充节点，为节点分配内存。</p> 
<h6><a id="device_node_1307"></a>device_node原型</h6> 
<pre><code class="prism language-c"><span class="token comment">// include/linux/of.h</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>type<span class="token punctuation">;</span>
    phandle phandle<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>full_name<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">struct</span>	<span class="token class-name">property</span> <span class="token operator">*</span>properties<span class="token punctuation">;</span>
    <span class="token keyword">struct</span>	<span class="token class-name">property</span> <span class="token operator">*</span>deadprops<span class="token punctuation">;</span>	<span class="token comment">/* removed properties */</span>
    <span class="token keyword">struct</span>	<span class="token class-name">device_node</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
    <span class="token keyword">struct</span>	<span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">struct</span>	<span class="token class-name">device_node</span> <span class="token operator">*</span>sibling<span class="token punctuation">;</span>
    <span class="token keyword">struct</span>	<span class="token class-name">kobject</span> kobj<span class="token punctuation">;</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _flags<span class="token punctuation">;</span>
    <span class="token keyword">void</span>	<span class="token operator">*</span>data<span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li><code>name</code>：设备节点中的<code>name</code>属性转换而来。</li><li><code>type</code>：由设备节点中的<code>device_type</code>转换而来。</li><li><code>phandle</code>：有设备节点中的"<code>phandle</code>"和"<code>linux,phandle</code>"属性转换而来，特殊的还可能由"<code>ibm,phandle</code>"属性转换而来。</li><li><code>full_name</code>：这个指针指向整个结构体的结尾位置，在结尾位置存储着这个结构体对应设备树节点的<code>unit_name</code>，意味着一个<code>struct device_node</code>结构体占内存空间为<code>sizeof(struct device_node)+strlen(unit_name)+字节对齐</code>。</li><li><code>properties</code>：这是一个设备树节点的属性链表，属性可能有很多种，比如：“interrupts”,“timer”，"hwmods"等等。</li><li><code>parent</code>,<code>child</code>,<code>sibling</code>：与当前属性链表节点相关节点，所以相关链表节点构成整个device_node的属性节点。</li><li><code>kobj</code>：用于在/sys目录下生成相应用户文件。</li></ul> 
<h6><a id="populate_node_1337"></a>populate_node</h6> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">populate_node</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>mem<span class="token punctuation">,</span>
			  <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>dad<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> fpsize<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span><span class="token operator">*</span>pnp<span class="token punctuation">,</span>bool dryrun<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">;</span>
    <span class="token comment">// 申请内存</span>
    <span class="token comment">// 注，allocl是节点的unit_name长度(类似于chosen、memory这类子节点描述开头时的名字，并非.name成员)</span>
    np <span class="token operator">=</span> <span class="token function">unflatten_dt_alloc</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token punctuation">)</span> <span class="token operator">+</span> allocl<span class="token punctuation">,</span><span class="token function">__alignof__</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 初始化node（设置kobj，接着设置node的fwnode.ops。）</span>
    <span class="token function">of_node_init</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 将device_node的full_name指向结构体结尾处，</span>
    <span class="token comment">// 即，将一个节点的unit name放置在一个struct device_node的结尾处。</span>
    np<span class="token operator">-&gt;</span>full_name <span class="token operator">=</span> fn <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>np<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 设置其 父节点 和 兄弟节点（如果有父节点）</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dad <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		np<span class="token operator">-&gt;</span>parent <span class="token operator">=</span> dad<span class="token punctuation">;</span>
		np<span class="token operator">-&gt;</span>sibling <span class="token operator">=</span> dad<span class="token operator">-&gt;</span>child<span class="token punctuation">;</span>
		dad<span class="token operator">-&gt;</span>child <span class="token operator">=</span> np<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    
    <span class="token comment">// 为节点的各个属性分配空间</span>
    <span class="token function">populate_properties</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> mem<span class="token punctuation">,</span> np<span class="token punctuation">,</span> pathp<span class="token punctuation">,</span> dryrun<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 获取，并设置device_node节点的name和type属性</span>
    np<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token function">of_get_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	np<span class="token operator">-&gt;</span>type <span class="token operator">=</span> <span class="token function">of_get_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"device_type"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span>
		np<span class="token operator">-&gt;</span>name <span class="token operator">=</span> <span class="token string">"&lt;NULL&gt;"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token operator">-&gt;</span>type<span class="token punctuation">)</span>
		np<span class="token operator">-&gt;</span>type <span class="token operator">=</span> <span class="token string">"&lt;NULL&gt;"</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>  
</code></pre> 
<p>一个设备树中节点转换成一个<code>struct device_node</code>结构的过程渐渐就清晰起来，现在我们接着看看<code>populate_properties()</code>这个函数，看看属性是怎么解析的，</p> 
<h6><a id="populate_properties_1377"></a>populate_properties</h6> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">populate_properties</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>blob<span class="token punctuation">,</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>mem<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>nodename<span class="token punctuation">,</span>bool dryrun<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>cur <span class="token operator">=</span> <span class="token function">fdt_first_property_offset</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
         cur <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>
         cur <span class="token operator">=</span> <span class="token function">fdt_next_property_offset</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> cur<span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">fdt_getprop_by_offset</span><span class="token punctuation">(</span>blob<span class="token punctuation">,</span> cur<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pname<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unflatten_dt_alloc</span><span class="token punctuation">(</span>mem<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">property</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">__alignof__</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">property</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>pname<span class="token punctuation">,</span> <span class="token string">"phandle"</span><span class="token punctuation">)</span> <span class="token operator">||</span>  <span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>pname<span class="token punctuation">,</span> <span class="token string">"linux,phandle"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>np<span class="token operator">-&gt;</span>phandle<span class="token punctuation">)</span>
                np<span class="token operator">-&gt;</span>phandle <span class="token operator">=</span> <span class="token function">be32_to_cpup</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">;</span>

            pp<span class="token operator">-&gt;</span>name   <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>pname<span class="token punctuation">;</span>
            pp<span class="token operator">-&gt;</span>length <span class="token operator">=</span> sz<span class="token punctuation">;</span>
            pp<span class="token operator">-&gt;</span>value  <span class="token operator">=</span> <span class="token punctuation">(</span>__be32 <span class="token operator">*</span><span class="token punctuation">)</span>val<span class="token punctuation">;</span>
            <span class="token operator">*</span>pprev     <span class="token operator">=</span> pp<span class="token punctuation">;</span>
            pprev      <span class="token operator">=</span> <span class="token operator">&amp;</span>pp<span class="token operator">-&gt;</span>next<span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从属性转换部分的程序可以看出，对于大部分的属性，都是直接填充一个<code>struct property</code>属性；</p> 
<p>而对于<code>"phandle"</code>属性和<code>"linux,phandle"</code>属性，直接填充<code>struct device_node </code>的<code>phandle</code>字段，不放在属性链表中。</p> 
<h4><a id="of_alias_scan_1407"></a>扫描节点：of_alias_scan</h4> 
<p>从名字来看，这个函数的作用是解析根目录下的<code>alias</code></p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>of_chosen<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>of_aliases<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">of_alias_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">*</span>dt_alloc<span class="token punctuation">)</span><span class="token punctuation">(</span>u64 size<span class="token punctuation">,</span> u64 align<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    of_aliases <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/aliases"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    of_chosen <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/chosen"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>of_chosen<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_property_read_string</span><span class="token punctuation">(</span>of_chosen<span class="token punctuation">,</span> <span class="token string">"stdout-path"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">of_property_read_string</span><span class="token punctuation">(</span>of_chosen<span class="token punctuation">,</span> <span class="token string">"linux,stdout-path"</span><span class="token punctuation">,</span>
                                    <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_PPC<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>name<span class="token punctuation">)</span>
            <span class="token function">of_property_read_string</span><span class="token punctuation">(</span>of_aliases<span class="token punctuation">,</span> <span class="token string">"stdout"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">)</span>
            of_stdout <span class="token operator">=</span> <span class="token function">of_find_node_opts_by_path</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token operator">&amp;</span>of_stdout_options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">for_each_property_of_node</span><span class="token punctuation">(</span>of_aliases<span class="token punctuation">,</span> pp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// ...</span>
        ap <span class="token operator">=</span> <span class="token function">dt_alloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ap<span class="token punctuation">)</span> <span class="token operator">+</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">__alignof__</span><span class="token punctuation">(</span><span class="token operator">*</span>ap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ap<span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token function">memset</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>ap<span class="token punctuation">)</span> <span class="token operator">+</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        ap<span class="token operator">-&gt;</span>alias <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token function">of_alias_add</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span> np<span class="token punctuation">,</span> id<span class="token punctuation">,</span> start<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>of_alias_scan()</code>函数先是处理设备树chosen节点中的"stdout-path"或者"stdout"属性(两者最多存在其一)，然后将stdout指定的path赋值给全局变量<code>of_stdout_options</code>，并将返回的全局<code>struct device_node</code>类型数据赋值给<code>of_stdout</code>，指定系统启动时的log输出。</p> 
<p>接下来为aliases节点申请内存空间，如果一个节点中同时没有<code>name</code>/<code>phandle</code>/<code>linux,phandle</code>，则被定义为特殊节点，对于这些特殊节点将不会申请内存空间。</p> 
<p>然后，使用<code>of_alias_add()</code>函数将所有的aliases内容放置在<code>aliases_lookup</code>链表中。</p> 
<h4><a id="_1446"></a>转换过程总结</h4> 
<p><img src="https://images2.imgbox.com/0d/7d/Wo8Obl5o_o.png" alt="img"><br> <img src="https://images2.imgbox.com/2e/e6/ipTS42SW_o.png" alt="在这里插入图片描述"></p> 
<p>此后，内核就可以根据<code>device_node</code>来创建设备。</p> 
<h3><a id="4_device_nodeplatfrom_device_1454"></a>4. 把device_node转换成platfrom_device</h3> 
<p>​ 在上一节中讲到设备树dtb文件中的各个节点转换成<code>device_node</code>的过程，每个设备树子节点都将转换成一个对应的device_node节点。</p> 
<p>​ 设备树dts文件最终在linux内核中会转化成platform_device：<code>dts </code>-&gt;<code> dtb</code> -&gt;<code>device_node</code>-&gt;<code> platform_device</code>那么，接下来，我们就来看看linux内核如何把device_node转换成platfrom_device。</p> 
<h4><a id="_1460"></a>设备树对于驱动</h4> 
<p>​ 设备树的产生就是为了替代driver中过多的platform_device部分的静态定义，将硬件资源抽象出来，由系统统一解析，这样就可以避免各驱动中对硬件资源大量的重复定义。</p> 
<p>​ 这样一来，几乎可以肯定的是，设备树中的节点最终目标是转换成platform device结构，在驱动开发时就只需要添加相应的platform driver部分进行匹配即可。</p> 
<h4><a id="device_nodeplatform_device_1466"></a>device_node转换为platform_device是有条件的</h4> 
<p>首先，对于所有的device_node，如果要转换成platform_device，除了节点中必须有<code>compatible</code>属性以外，必须满足以下条件：</p> 
<ul><li>一般情况下，只对设备树中根的第1级节点（<code>/xx</code>）注册成<code>platform device</code>，也就是对它们的子节点（<code>/xx/*</code>）并不处理。</li><li>如果一个结点的<code>compatile</code>属性含有这些特殊的值(“simple-bus”,“simple-mfd”,“isa”,“arm,amba-bus”)之一，并且自己成功注册成了platform_device，那么它的子结点(需含compatile属性)也可以转换为<code>platform_device</code>（当成总线看待）。</li><li>根节点（<code>/</code>）是例外的，生成platfrom_device时，即使有<code>compatible</code>属性也不会处理</li></ul> 
<h4><a id="_1474"></a>设备树结点的什么属性会被转换？</h4> 
<p>如果是device_node转换成platform device，这个转换过程又是怎么样的呢？</p> 
<p>在老版本的内核中，platform_device部分是静态定义的，其实最主要的部分就是resources部分，这一部分描述了当前驱动需要的硬件资源，一般是IO，中断等资源。</p> 
<p>在设备树中，这一类资源通常通过reg属性来描述，中断则通过interrupts来描述；</p> 
<p>所以，设备树中的reg和interrupts资源将会被转换成platform_device内的struct resources资源。</p> 
<p>那么，设备树中其他属性是怎么转换的呢？</p> 
<p>答案是：不需要转换，在platform_device中有一个成员struct device dev，这个dev中又有一个指针成员struct device_node *of_node。</p> 
<blockquote> 
 <p>linux的做法就是将这个of_node指针直接指向由设备树转换而来的device_node结构；留给驱动开发者自行处理。</p> 
 <p>例如，有这么一个struct platform_device* of_test.我们可以直接通过of_test-&gt;dev.of_node来访问设备树中的信息。</p> 
</blockquote> 
<h3><a id="platform_device_1493"></a>platform_device转换的开始</h3> 
<h4><a id="of_platform_default_populate_init_1495"></a>of_platform_default_populate_init</h4> 
<p>函数的执行入口是，在系统启动的早期进行的<code>of_platform_default_populate_init</code>：</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/of/platform.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">of_platform_default_populate_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">of_have_populated_dt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>

    <span class="token comment">/*
     * Handle ramoops explicitly, since it is inside /reserved-memory,
     * which lacks a "compatible" property.
     */</span>
    node <span class="token operator">=</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/reserved-memory"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        node <span class="token operator">=</span> <span class="token function">of_find_compatible_node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"ramoops"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span>
            <span class="token function">of_platform_device_create</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Populate everything else. */</span>
    <span class="token function">of_platform_default_populate</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">arch_initcall_sync</span><span class="token punctuation">(</span>of_platform_default_populate_init<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在函数<code>of_platform_default_populate_init()</code>中，调用了<code>of_platform_default_populate(NULL, NULL, NULL);</code>，传入三个空指针：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_platform_default_populate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>root<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>lookup<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">of_platform_populate</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> of_default_bus_match_table<span class="token punctuation">,</span> lookup<span class="token punctuation">,</span>
                    parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>of_platform_default_populate()调用了of_platform_populate()，我们注意下<code>of_default_bus_match_table</code></p> 
<h5><a id="of_default_bus_match_table_1539"></a>of_default_bus_match_table</h5> 
<pre><code class="prism language-c"><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_default_bus_match_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"simple-mfd"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"isa"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">CONFIG_ARM_AMBA</span></span>
        <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"arm,amba-bus"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">/* CONFIG_ARM_AMBA */</span></span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment">/* Empty terminated list */</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>如果节点的属性值为 “simple-bus”,“simple-mfd”,“isa”,"arm,amba-bus "之一的话，那么它子节点就可以转化成platform_device。</p> 
<h4><a id="of_platform_populate_1555"></a>of_platform_populate</h4> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_platform_populate</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>root<span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span>
            <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>lookup<span class="token punctuation">,</span>
            <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// 从设备树中获取根节点的device_node结构体</span>
    root <span class="token operator">=</span> root <span class="token operator">?</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">of_find_node_by_path</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>root<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>

    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"%s()\n"</span><span class="token punctuation">,</span> <span class="token constant">__func__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">" starting at: %pOF\n"</span><span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//遍历所有的子节点</span>
    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 然后对每个根目录下的一级子节点 创建 bus</span>
        <span class="token comment">// 例如， /r1 , /r2，而不是 /r1/s1</span>
        rc <span class="token operator">=</span> <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> lookup<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">of_node_set_flag</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> OF_POPULATED_BUS<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">of_node_put</span><span class="token punctuation">(</span>root<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>of_platform_populate<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在调用<code>of_platform_populate()</code>时传入了的<code>matches</code>参数是<code>of_default_bus_match_table[]</code>；</p> 
<p>这个table是一个静态数组，这个静态数组中定义了一系列的compatible属性：<code>"simple-bus"</code>、<code>"simple-mfd"</code>、<code>"isa"</code>、<code>"arm,amba-bus"</code>。</p> 
<p>按照我们上文中的描述，当某个根节点下的一级子节点的compatible属性为这些属性其中之一时，它的一级子节点也将由device_node转换成platform_device.</p> 
<p>到底是不是这样呢？接着往下看。</p> 
<h4><a id="of_platform_bus_create_1600"></a>of_platform_bus_create</h4> 
<pre><code class="prism language-c"><span class="token comment">/**
 * of_platform_bus_create() - Create a device for a node and its children.
 * @bus: device node of the bus to instantiate
 * @matches: match table for bus nodes
 * @lookup: auxdata table for matching id and platform_data with device nodes
 * @parent: parent for new device, or NULL for top level.
 * @strict: require compatible property
 *
 * Creates a platform_device for the provided device_node, and optionally
 * recursively create devices for all the child nodes.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span>
                  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>matches<span class="token punctuation">,</span>
                  <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>lookup<span class="token punctuation">,</span>
                  <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span> bool strict<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_dev_auxdata</span> <span class="token operator">*</span>auxdata<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>platform_data <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> rc <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// 创建of_platform_device、赋予私有数据</span>
    dev <span class="token operator">=</span> <span class="token function">of_platform_device_create_pdata</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> bus_id<span class="token punctuation">,</span> platform_data<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// 判断当前节点的compatible属性是否包含上文中compatible静态数组中的元素</span>
    <span class="token comment">// 如果不包含，函数返回0，即，不处理子节点。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">of_match_node</span><span class="token punctuation">(</span>matches<span class="token punctuation">,</span> bus<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">for_each_child_of_node</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"   create child: %pOF\n"</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 of_platform_bus</span>
        <span class="token comment">/* 
         * 如果当前compatible属性中包含静态数组中的元素，
         * 即当前节点的compatible属性有"simple-bus"、"simple-mfd"、"isa"、"arm,amba-bus"其中一项，
         * 把子节点当作对应的总线来对待，递归地对当前节点调用`of_platform_bus_create()`
         * 即，将符合条件的子节点转换为platform_device结构。
         */</span>
        rc <span class="token operator">=</span> <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> matches<span class="token punctuation">,</span> lookup<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> strict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">of_node_set_flag</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> OF_POPULATED_BUS<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="of_platform_device_create_pdata_1656"></a>of_platform_device_create_pdata</h5> 
<p>这个函数实现了：创建of_platform_device、赋予私有数据</p> 
<p>此时的参数platform_data为NULL。</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * of_platform_device_create_pdata - Alloc, initialize and register an of_device
 * @np: pointer to node to create device for
 * @bus_id: name to assign device
 * @platform_data: pointer to populate platform_data pointer with
 * @parent: Linux device model parent device.
 *
 * Returns pointer to created platform device, or NULL if a device was not
 * registered.  Unavailable devices will not get registered.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span><span class="token function">of_platform_device_create_pdata</span><span class="token punctuation">(</span>
                    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span>
                    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id<span class="token punctuation">,</span>
                    <span class="token keyword">void</span> <span class="token operator">*</span>platform_data<span class="token punctuation">,</span>
                    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 终于看到了平台设备</span>
    <span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>

    <span class="token comment">// ...</span>

    <span class="token comment">// 创建实例，将传入的device_node链接到成员：dev.of_node中</span>
    dev <span class="token operator">=</span> <span class="token function">of_device_alloc</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> bus_id<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dev<span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_clear_flag<span class="token punctuation">;</span>

    <span class="token comment">// 登记到 platform 中</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>platform_bus_type<span class="token punctuation">;</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>platform_data <span class="token operator">=</span> platform_data<span class="token punctuation">;</span>
    <span class="token function">of_msi_configure</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加当前生成的platform_device。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_device_add</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">platform_device_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_clear_flag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> dev<span class="token punctuation">;</span>

err_clear_flag<span class="token operator">:</span>
    <span class="token function">of_node_clear_flag</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="of_device_alloc_1708"></a>of_device_alloc</h6> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span><span class="token function">of_device_alloc</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>bus_id<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">//统计reg属性的数量</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">of_address_to_resource</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> num_reg<span class="token punctuation">,</span> <span class="token operator">&amp;</span>temp_res<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
	    num_reg<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token comment">//统计中断irq属性的数量</span>
    num_irq <span class="token operator">=</span> <span class="token function">of_irq_count</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//根据num_irq和num_reg的数量申请相应的struct resource内存空间。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>num_irq <span class="token operator">||</span> num_reg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        res <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>res<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>num_irq <span class="token operator">+</span> num_reg<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">platform_device_put</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//设置platform_device中的num_resources成员</span>
        dev<span class="token operator">-&gt;</span>num_resources <span class="token operator">=</span> num_reg <span class="token operator">+</span> num_irq<span class="token punctuation">;</span>
        <span class="token comment">//设置platform_device中的resource成员</span>
        dev<span class="token operator">-&gt;</span>resource <span class="token operator">=</span> res<span class="token punctuation">;</span>

        <span class="token comment">//将device_node中的reg属性转换成platform_device中的struct resource成员。  </span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num_reg<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">,</span> res<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            rc <span class="token operator">=</span> <span class="token function">of_address_to_resource</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> i<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">WARN_ON</span><span class="token punctuation">(</span>rc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将device_node中的irq属性转换成platform_device中的struct resource成员。 </span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_irq_to_resource_table</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> res<span class="token punctuation">,</span> num_irq<span class="token punctuation">)</span> <span class="token operator">!=</span> num_irq<span class="token punctuation">)</span>
            <span class="token function">pr_debug</span><span class="token punctuation">(</span><span class="token string">"not all legacy IRQ resources mapped for %s\n"</span><span class="token punctuation">,</span>
                np<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">//将platform_device的dev.of_node成员指针指向device_node。  </span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//将platform_device的dev.fwnode成员指针指向device_node的fwnode成员。</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>fwnode <span class="token operator">=</span> <span class="token operator">&amp;</span>np<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">;</span>
    <span class="token comment">//设备parent为platform_bus</span>
    dev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent <span class="token operator">=</span> parent <span class="token operator">?</span> <span class="token operator">:</span> <span class="token operator">&amp;</span>platform_bus<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先，函数先统计设备树中reg属性和中断irq属性的个数，然后分别为它们申请内存空间，链入到platform_device中的struct resources成员中。</p> 
<p>除了设备树中"reg"和"interrupt"属性之外，还有可选的"reg-names"和"interrupt-names"这些io中断资源相关的设备树节点属性也在这里被转换。</p> 
<p>将相应的设备树节点生成的device_node节点链入到platform_device的dev.of_node中。</p> 
<blockquote> 
 <p>最终，我们能够通过在自己的驱动中，使用<code>struct device_node *node = pdev-&gt;dev.of_node;</code>获取到设备树节点中的数据。</p> 
</blockquote> 
<h6><a id="of_device_add_1757"></a>of_device_add</h6> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">of_device_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>ofdev<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token function">device_add</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ofdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>将当前<code>platform_device</code>中的struct device成员注册到系统device中，并为其在用户空间创建相应的访问节点。</p> 
<p>这一步会调用<code>platform_match</code>，因此最终也会执行设备树的match，以及probe。</p> 
<h3><a id="_1770"></a>总结</h3> 
<p>总的来说，将device_node转换为platform_device的过程还是比较简单的。</p> 
<p>整个转换过程的函数调用关系是这样的：</p> 
<pre><code class="prism language-c">                            <span class="token function">of_platform_default_populate_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token operator">|</span>
                            <span class="token function">of_platform_default_populate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token operator">|</span>
                            <span class="token function">of_platform_populate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                        <span class="token operator">|</span>
                            <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                _____________________<span class="token operator">|</span>_________________
                <span class="token operator">|</span>                                      <span class="token operator">|</span>
        <span class="token function">of_platform_device_create_pdata</span><span class="token punctuation">(</span><span class="token punctuation">)</span>       <span class="token function">of_platform_bus_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        _________________<span class="token operator">|</span>____________________
       <span class="token operator">|</span>                                      <span class="token operator">|</span>
 <span class="token function">of_device_alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                        <span class="token function">of_device_add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         
</code></pre> 
<h3><a id="5__1792"></a>5. 设备树中各个节点是谁转换的</h3> 
<p>​ 之前，在第4节《把device_node转换成platfrom_device》中提到在设备树的device_node到platform_device转换中，必须满足以下条件：</p> 
<ul><li>一般情况下，只对设备树中根的一级子节点进行转换，也就是多级子节点(子节点的子节点)并不处理。但是存在一种特殊情况，就是当某个根子节点的compatible属性为"simple-bus"、“simple-mfd”、“isa”、"arm,amba-bus"时，当前节点中的一级子节点将会被转换成platform_device节点。</li><li>节点中必须有compatible属性。</li></ul> 
<p>​ 那么，设备树中的一级节点的处理已经完成了，但是现在，我们还有一些子节点的读取不太了解。实际上，没有被处理称为<code>platform_device</code>的设备树节点，都被各个<code>platform_device</code>作为子节点进行处理了。</p> 
<p>我们通过解析一棵比较经典的设备树，展示设备树中<code>i2c</code>子系统以及<code>gpio-leds</code>中是如何使用的。</p> 
<h4><a id="_1803"></a>典型的设备树</h4> 
<p>事实上，在设备树中，通常会存在<code>描述设备驱动的设备树节点</code>被放置在多级子节点的情况：</p> 
<pre><code class="prism language-c"><span class="token comment">// arch/arm/boot/dts/zynq-7000.dts</span>
<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 无效属性</span>
    compatible <span class="token operator">=</span> <span class="token string">"xx"</span><span class="token punctuation">;</span> 
    
    <span class="token comment">// /amba 节点, 会被转换为`platform_device`，因为它兼容"simple-bus",</span>
    <span class="token comment">// 同时，在内核中有对应的platform_driver来完成probe</span>
    amba <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>

        <span class="token comment">/*  /amba/i2c@e0004000 也会被转换为platform_device
         *  因为 父节点 /amba 具备 simple-bus；
         *  而 自己 /amba/i2c@e0004000 也有 compatible 属性
         */</span>
        i2c@e0004000 <span class="token punctuation">{<!-- --></span>
            compatible <span class="token operator">=</span> <span class="token string">"cdns,i2c-r1p10"</span><span class="token punctuation">;</span>
            status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// ...</span>
    <span class="token comment">// 类似的也有 /usb_phy0 节点, 它一般也是用来表示USB控制器, 它会被转换为platform_device, </span>
    <span class="token comment">// 同时，在内核中有对应的platform_driver 来完成probe</span>
    usb_phy@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"ulpi-phy"</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">phy</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    
    aliases <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// i2c0 代表了 /amba/i2c@e0004000</span>
        i2c0 <span class="token operator">=</span> <span class="token string">"/amba/i2c@e0004000"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    soc<span class="token operator">:</span> soc <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
#######################################################################
<span class="token comment">// arch/arm/boot/dts/zynq-zc702.dts</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"zynq-7000.dtsi"</span></span>
<span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    model <span class="token operator">=</span> <span class="token string">"Zynq ZC702 Development Board"</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"xlnx,zynq-zc702"</span><span class="token punctuation">,</span> <span class="token string">"xlnx,zynq-7000"</span><span class="token punctuation">;</span>

    aliases <span class="token punctuation">{<!-- --></span>
        ethernet0 <span class="token operator">=</span> <span class="token operator">&amp;</span>gem0<span class="token punctuation">;</span>
        i2c0 <span class="token operator">=</span> <span class="token operator">&amp;</span>i2c0<span class="token punctuation">;</span>
        serial0 <span class="token operator">=</span> <span class="token operator">&amp;</span>uart1<span class="token punctuation">;</span>
        spi0 <span class="token operator">=</span> <span class="token operator">&amp;</span>qspi<span class="token punctuation">;</span>
        mmc0 <span class="token operator">=</span> <span class="token operator">&amp;</span>sdhci0<span class="token punctuation">;</span>
        usb0 <span class="token operator">=</span> <span class="token operator">&amp;</span>usb0<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>usb0 <span class="token punctuation">{<!-- --></span>
    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    dr_mode <span class="token operator">=</span> <span class="token string">"host"</span><span class="token punctuation">;</span>
    usb<span class="token operator">-</span>phy <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>usb_phy0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_usb0_default<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>i2c0 <span class="token punctuation">{<!-- --></span>
    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">400000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">,</span> <span class="token string">"gpio"</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_i2c0_default<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    pinctrl<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_i2c0_gpio<span class="token operator">&gt;</span><span class="token punctuation">;</span>
    scl<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">50</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    sda<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio0 <span class="token number">51</span> <span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>

    <span class="token comment">/* 
     *  /i2c@0/si570 节点不会被转换为platform_device, 
     *  si570被如何处理完全由父节点的platform_driver决定, 
     *  在这里，si570会被创建为 i2c_device。
     */</span>
    si570<span class="token operator">:</span> clock<span class="token operator">-</span>generator@<span class="token number">5</span>d <span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        compatible <span class="token operator">=</span> <span class="token string">"silabs,si570"</span><span class="token punctuation">;</span>
        temperature<span class="token operator">-</span>stability <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">50</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x5d</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        factory<span class="token operator">-</span>fout <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">156250000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">148500000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">&amp;</span>soc <span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0xffffffff</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
    
    mygpio<span class="token operator">-</span>leds <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"gpio-leds"</span><span class="token punctuation">;</span>

        led<span class="token operator">-</span>blue<span class="token punctuation">{<!-- --></span>
            label <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">-</span>state <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">;</span>
            <span class="token comment">//gpios = &lt;&amp;msm_gpio 17 0x00&gt;;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        led<span class="token operator">-</span>green<span class="token punctuation">{<!-- --></span>
            label <span class="token operator">=</span> <span class="token string">"green"</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">-</span>state <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">;</span>
            <span class="token comment">//gpios = &lt;&amp;msm_gpio 34 0x00&gt;;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>显然，i2c@e0004000会被转换成platform_device,而<code>si570</code>则不会，至少在设备树初始化阶段不会被转换，仍旧以device_node的形式存在在内存中。</p> 
<p>显而易见，这些设备并非是无意义的设备，接下来我们来看看，驱动中是如何处理的。</p> 
<h3><a id="usb_1924"></a>/usb</h3> 
<p>​ 类似的也有 <code>/usb_phy0</code> 节点, 它一般也是用来表示USB控制器, 它会被转换为<code>platform_device</code>, 同时，在内核中有对应的platform_driver 来完成probe</p> 
<pre><code class="prism language-c"><span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    usb_phy@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"ulpi-phy"</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">phy</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0xe0002000</span> <span class="token number">0x1000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        view<span class="token operator">-</span>port <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x170</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        drv<span class="token operator">-</span>vbus<span class="token punctuation">;</span>
        linux<span class="token punctuation">,</span>phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x7</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        phandle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x7</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>由 内核解析的时候，将<code>usb_phy@0</code>转换为<code>platform_device</code>。</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/usb/phy/phy-ulpi.c</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> ulpi_phy_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"ulpi-phy"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> ulpi_phy_table<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> ulpi_phy_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> ulpi_phy_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove     <span class="token operator">=</span> ulpi_phy_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver     <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"ulpi-phy"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> ulpi_phy_table<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">module_platform_driver</span><span class="token punctuation">(</span>ulpi_phy_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="ulpi_phy_probe_1964"></a>ulpi_phy_probe</h4> 
<p>​ 加载这个驱动（<code>ulpi_phy_driver</code>）以后，因为设备树中有上述的<code>platform_device</code>，所以会执行对应的probe。</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">ulpi_phy_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>res<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">ulpi_phy</span> <span class="token operator">*</span>uphy<span class="token punctuation">;</span>
    bool flag<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    
    <span class="token comment">/* 申请struct ulpi_phy 结构体类型内存 */</span>
    uphy <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>uphy<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uphy<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
    
    <span class="token comment">/* 从platform_device节点获取资源 */</span>
    res <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    uphy<span class="token operator">-&gt;</span>regs <span class="token operator">=</span> <span class="token function">devm_ioremap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> res<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> <span class="token function">resource_size</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>uphy<span class="token operator">-&gt;</span>regs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>uphy<span class="token operator">-&gt;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"view-port"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>uphy<span class="token operator">-&gt;</span>vp_offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>uphy<span class="token operator">-&gt;</span>regs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"view-port register not specified\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>uphy<span class="token operator">-&gt;</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    flag <span class="token operator">=</span> <span class="token function">of_property_read_bool</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"drv-vbus"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
        uphy<span class="token operator">-&gt;</span>flags <span class="token operator">|=</span> ULPI_OTG_DRVVBUS <span class="token operator">|</span> ULPI_OTG_DRVVBUS_EXT<span class="token punctuation">;</span>
   
    <span class="token comment">/* 根据.flags创建otg可见接口设备 */</span>
    uphy<span class="token operator">-&gt;</span>usb_phy <span class="token operator">=</span> <span class="token function">otg_ulpi_create</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ulpi_viewport_access_ops<span class="token punctuation">,</span> uphy<span class="token operator">-&gt;</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

    uphy<span class="token operator">-&gt;</span>usb_phy<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>

    uphy<span class="token operator">-&gt;</span>usb_phy<span class="token operator">-&gt;</span>io_priv <span class="token operator">=</span> uphy<span class="token operator">-&gt;</span>regs <span class="token operator">+</span> uphy<span class="token operator">-&gt;</span>vp_offset<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">usb_add_phy_dev</span><span class="token punctuation">(</span>uphy<span class="token operator">-&gt;</span>usb_phy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="amba_2013"></a>/amba</h3> 
<p>​ 还记得我们之前说的，因为 <code>/amba</code>节点的<code>compatible</code>属性符合<code>"simple-bus"</code>规则，所以，把<code>/amba/</code>中的所有子节点当作对应的总线来对待。</p> 
<p>即，将符合条件的子节点转换为<code>platform_device</code>结构。</p> 
<p>​ 事实上，<code>/amba/i2c@e0004000</code>对应一个i2c硬件控制器，控制器的起始地址是0x44e04000，这个节点的作用就是生成一个i2c硬件控制器的platform_device,与同样被加载到内存中的platform_driver相匹配。此后，在内存中构建一个i2c硬件控制器的描述节点，负责对应i2c控制器的数据收发。</p> 
<pre><code class="prism language-c"><span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// /amba 节点, 会被转换为`platform_device`，因为它兼容"simple-bus",</span>
    <span class="token comment">// amba 作为 一个soc总线，同时，在内核中有对应的platform_driver;</span>
    amba <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        <span class="token comment">// ...</span>

        <span class="token comment">// 子节点/amba/i2c@e0004000 也会被转换为platform_device, 因为其父节点/amba具有simple-bus属性</span>
        i2c@e0004000 <span class="token punctuation">{<!-- --></span>
            compatible <span class="token operator">=</span> <span class="token string">"cdns,i2c-r1p10"</span><span class="token punctuation">;</span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>因此，<code>i2c@e0004000</code>会被注册成为<code>platform_device</code>，那么我们来看看对应的<code>platform_driver</code></p> 
<h3><a id="ambai2ce0004000_2041"></a>/amba/i2c@e0004000</h3> 
<blockquote> 
 <p>基本上，只有原厂商以及比较老旧的平台需要自行开发总线控制器。但是我们作为一种学习了解也是不错的。</p> 
</blockquote> 
<p>​ 根据platform driver驱动的规则，需要填充一个struct platform_driver结构体，然后注册到platform总线中，这样才能完成platfrom bus的匹配，因此，我们也可以在同文件下找到相应的初始化部分：</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/busses/i2c-cadence.c</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> cdns_i2c_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"cdns,i2c-r1p10"</span><span class="token punctuation">,</span> <span class="token comment">// ... },</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"cdns,i2c-r1p14"</span><span class="token punctuation">,</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token comment">/* end of table */</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> cdns_i2c_of_match<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> cdns_i2c_drv <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name  <span class="token operator">=</span> DRIVER_NAME<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> cdns_i2c_of_match<span class="token punctuation">,</span>
        <span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token operator">&amp;</span>cdns_i2c_dev_pm_ops<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe  <span class="token operator">=</span> cdns_i2c_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove <span class="token operator">=</span> cdns_i2c_remove<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">module_platform_driver</span><span class="token punctuation">(</span>cdns_i2c_drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="cdns_i2c_probe_2069"></a>cdns_i2c_probe</h4> 
<p>​ 既然platform总线的driver和device匹配上，就会调用相应的probe函数，根据<code>.probe = cdns_i2c_probe,</code>，我们再查看cdns_i2c_probe函数：</p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * cdns_i2c_probe - Platform registration call
 * @pdev:   Handle to the platform device structure
 *
 * This function does all the memory allocation and registration for the i2c
 * device. User can modify the address mode to 10 bit address mode using the
 * ioctl call with option I2C_TENBIT.
 *
 * Return: 0 on success, negative error otherwise
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">cdns_i2c_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r_mem<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">cdns_i2c</span> <span class="token operator">*</span>id<span class="token punctuation">;</span>
    <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>match<span class="token punctuation">;</span>

    id <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token operator">*</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>id<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

    id<span class="token operator">-&gt;</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    match <span class="token operator">=</span> <span class="token function">of_match_node</span><span class="token punctuation">(</span>cdns_i2c_of_match<span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">&amp;&amp;</span> match<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cdns_platform_data</span> <span class="token operator">*</span>data <span class="token operator">=</span> match<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
        id<span class="token operator">-&gt;</span>quirks <span class="token operator">=</span> data<span class="token operator">-&gt;</span>quirks<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    id<span class="token operator">-&gt;</span>pinctrl <span class="token operator">=</span> <span class="token function">devm_pinctrl_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>pinctrl<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ret <span class="token operator">=</span> <span class="token function">cdns_i2c_init_recovery_info</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    r_mem <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>membase <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> r_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>membase<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>membase<span class="token punctuation">)</span><span class="token punctuation">;</span>

    id<span class="token operator">-&gt;</span>irq <span class="token operator">=</span> <span class="token function">platform_get_irq</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 设置 adapter 一些属性</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>of_node <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>algo <span class="token operator">=</span> <span class="token operator">&amp;</span>cdns_i2c_algo<span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>timeout <span class="token operator">=</span> CDNS_I2C_TIMEOUT<span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>retries <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>       <span class="token comment">/* Default retry value. */</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>algo_data <span class="token operator">=</span> id<span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>dev<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token function">init_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token operator">-&gt;</span>xfer_done<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">snprintf</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>adap<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span>
         <span class="token string">"Cadence I2C at %08lx"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>r_mem<span class="token operator">-&gt;</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>

    id<span class="token operator">-&gt;</span>clk <span class="token operator">=</span> <span class="token function">devm_clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"input clock not found.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    ret <span class="token operator">=</span> <span class="token function">clk_prepare_enable</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"Unable to enable clock.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">pm_runtime_set_autosuspend_delay</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> CNDS_I2C_PM_TIMEOUT<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pm_runtime_use_autosuspend</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pm_runtime_set_active</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pm_runtime_enable</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>

    id<span class="token operator">-&gt;</span>clk_rate_change_nb<span class="token punctuation">.</span>notifier_call <span class="token operator">=</span> cdns_i2c_clk_notifier_cb<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">clk_notifier_register</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>clk<span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token operator">-&gt;</span>clk_rate_change_nb<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">dev_warn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"Unable to register clock notifier.\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>input_clk <span class="token operator">=</span> <span class="token function">clk_get_rate</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token string">"clock-frequency"</span><span class="token punctuation">,</span>
            <span class="token operator">&amp;</span>id<span class="token operator">-&gt;</span>i2c_clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">||</span> <span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>i2c_clk <span class="token operator">&gt;</span> CDNS_I2C_SPEED_MAX<span class="token punctuation">)</span><span class="token punctuation">)</span>
        id<span class="token operator">-&gt;</span>i2c_clk <span class="token operator">=</span> CDNS_I2C_SPEED_DEFAULT<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_I2C_SLAVE<span class="token punctuation">)</span></span></span>
    <span class="token comment">/* Set initial mode to master */</span>
    id<span class="token operator">-&gt;</span>dev_mode <span class="token operator">=</span> CDNS_I2C_MODE_MASTER<span class="token punctuation">;</span>
    id<span class="token operator">-&gt;</span>slave_state <span class="token operator">=</span> CDNS_I2C_SLAVE_STATE_IDLE<span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    id<span class="token operator">-&gt;</span>ctrl_reg <span class="token operator">=</span> CDNS_I2C_CR_ACK_EN <span class="token operator">|</span> CDNS_I2C_CR_NEA <span class="token operator">|</span> CDNS_I2C_CR_MS<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">cdns_i2c_setclk</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>input_clk<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"invalid SCL clock: %u Hz\n"</span><span class="token punctuation">,</span> id<span class="token operator">-&gt;</span>i2c_clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ret <span class="token operator">=</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_clk_dis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ret <span class="token operator">=</span> <span class="token function">devm_request_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> id<span class="token operator">-&gt;</span>irq<span class="token punctuation">,</span> cdns_i2c_isr<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span>
                 DRIVER_NAME<span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"cannot get irq %d\n"</span><span class="token punctuation">,</span> id<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">goto</span> err_clk_dis<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">cdns_i2c_init</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 添加成为 adapter</span>
    ret <span class="token operator">=</span> <span class="token function">i2c_add_adapter</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token operator">-&gt;</span>adap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">goto</span> err_clk_dis<span class="token punctuation">;</span>

    <span class="token function">dev_info</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"%u kHz mmio %08lx irq %d\n"</span><span class="token punctuation">,</span>
         id<span class="token operator">-&gt;</span>i2c_clk <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span><span class="token punctuation">)</span>r_mem<span class="token operator">-&gt;</span>start<span class="token punctuation">,</span> id<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

err_clk_dis<span class="token operator">:</span>
    <span class="token function">clk_disable_unprepare</span><span class="token punctuation">(</span>id<span class="token operator">-&gt;</span>clk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pm_runtime_disable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">pm_runtime_set_suspended</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="i2c_add_adapter_2195"></a>i2c_add_adapter</h5> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/i2c-core-base.c</span>
<span class="token comment">/**
 * i2c_add_adapter - declare i2c adapter, use dynamic bus number
 * @adapter: the adapter to add
 * Context: can sleep
 *
 * This routine is used to declare an I2C adapter when its bus number
 * doesn't matter or when its bus number is specified by an dt alias.
 * Examples of bases when the bus number doesn't matter: I2C adapters
 * dynamically added by USB links or PCI plugin cards.
 *
 * When this returns zero, a new bus number was allocated and stored
 * in adap-&gt;nr, and the specified adapter became available for clients.
 * Otherwise, a negative errno value is returned.
 */</span>
<span class="token keyword">int</span> <span class="token function">i2c_add_adapter</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adapter<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>adapter<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取 i2c 设备树节点</span>
        id <span class="token operator">=</span> <span class="token function">of_alias_get_id</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>of_node<span class="token punctuation">,</span> <span class="token string">"i2c"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            adapter<span class="token operator">-&gt;</span>nr <span class="token operator">=</span> id<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">__i2c_add_numbered_adapter</span><span class="token punctuation">(</span>adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL</span><span class="token punctuation">(</span>i2c_add_adapter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="of_alias_get_id_2232"></a>of_alias_get_id</h6> 
<pre><code class="prism language-c"><span class="token comment">// drivers/of/base.c</span>
<span class="token comment">/**
 * of_alias_get_id - Get alias id for the given device_node
 * @np:     Pointer to the given device_node
 * @stem:   Alias stem of the given device_node
 *
 * The function travels the lookup table to get alias id for the given
 * device_node and alias stem.  It returns the alias id if find it.
 */</span>
<span class="token keyword">int</span> <span class="token function">of_alias_get_id</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>stem<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">alias_prop</span> <span class="token operator">*</span>app<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token operator">-</span>ENODEV<span class="token punctuation">;</span>

    <span class="token function">mutex_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>of_aliases_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">list_for_each_entry</span><span class="token punctuation">(</span>app<span class="token punctuation">,</span> <span class="token operator">&amp;</span>aliases_lookup<span class="token punctuation">,</span> link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">strcmp</span><span class="token punctuation">(</span>app<span class="token operator">-&gt;</span>stem<span class="token punctuation">,</span> stem<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>np <span class="token operator">==</span> app<span class="token operator">-&gt;</span>np<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            id <span class="token operator">=</span> app<span class="token operator">-&gt;</span>id<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">mutex_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>of_aliases_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> id<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">EXPORT_SYMBOL_GPL</span><span class="token punctuation">(</span>of_alias_get_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>之前解析过的<code>aliases</code>节点都会加入到<code>aliases_lookup</code>中。</p> 
<p>因此，现在根据名字，获取到对应的<code>i2c</code>节点的id。</p> 
<h6><a id="alias_prop_2270"></a>alias_prop原型</h6> 
<p>id实际上就是一个索引，有了id就可以找到这个项目。</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/of/of_private.h</span>
<span class="token comment">/**
 * struct alias_prop - Alias property in 'aliases' node
 * @link:   List node to link the structure in aliases_lookup list
 * @alias:  Alias property name
 * @np:     Pointer to device_node that the alias stands for
 * @id:     Index value from end of alias name
 * @stem:   Alias string without the index
 *
 * The structure represents one alias property of 'aliases' node as
 * an entry in aliases_lookup list.
 */</span>
<span class="token keyword">struct</span> <span class="token class-name">alias_prop</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">list_head</span> link<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>alias<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id<span class="token punctuation">;</span>
    <span class="token keyword">char</span> stem<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="__i2c_add_numbered_adapter_2296"></a>__i2c_add_numbered_adapter</h6> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/i2c-core-base.c</span>
<span class="token comment">/**
 * __i2c_add_numbered_adapter - i2c_add_numbered_adapter where nr is never -1
 * @adap: the adapter to register (with adap-&gt;nr initialized)
 * Context: can sleep
 *
 * See i2c_add_numbered_adapter() for details.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">__i2c_add_numbered_adapter</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adap<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> <span class="token function">i2c_register_adapter</span><span class="token punctuation">(</span>adap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="i2c_register_adapter_2314"></a>i2c_register_adapter</h6> 
<p>​ 根据这个名称可以看出这是根据设备树描述的硬件i2c控制器而生成的一个i2c_adapter，并注册到系统中，这个i2c_adapter负责i2c底层数据收发。</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/i2c-core-base.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">i2c_register_adapter</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adap<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
	<span class="token function">of_i2c_register_devices</span><span class="token punctuation">(</span>adap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 注意到一个of前缀的函数，看到of就能想到这肯定是设备树相关的函数。</p> 
<blockquote> 
 <p>of代表<code>open framework</code>，设备树就是从of来的。</p> 
</blockquote> 
<h6><a id="of_i2c_register_devices_2332"></a>of_i2c_register_devices</h6> 
<p>为每一个i2c下的节点注册对应为对应的i2c device（即，<code>i2c_client</code>）</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/i2c-core-of.c</span>
<span class="token keyword">void</span> <span class="token function">of_i2c_register_devices</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adap<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
    
    <span class="token comment">// 轮询每个子节点</span>
	<span class="token function">for_each_available_child_of_node</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_node_test_and_set_flag</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		client <span class="token operator">=</span> <span class="token function">of_i2c_register_device</span><span class="token punctuation">(</span>adap<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">dev_warn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adap<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
					<span class="token string">"Failed to create I2C device for %pOF\n"</span><span class="token punctuation">,</span>
					node<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">of_node_clear_flag</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> OF_POPULATED<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 所以可以看出，<code>of_i2c_register_device()</code>这个函数的作用就是解析设备树中当前i2c中的子节点，并将其转换成相应的<code>i2c_client</code>描述结构。</p> 
<h6><a id="of_i2c_register_device_2361"></a>of_i2c_register_device</h6> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/i2c-core-of.c</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span><span class="token function">of_i2c_register_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adap<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>node<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
	<span class="token keyword">struct</span> <span class="token class-name">i2c_board_info</span> info <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">of_modalias_node</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> info<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>info<span class="token punctuation">.</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">of_get_property</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"reg"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>addr <span class="token operator">=</span> addr<span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>of_node <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	info<span class="token punctuation">.</span>archdata <span class="token operator">=</span> <span class="token operator">&amp;</span>dev_ad<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_property_read_bool</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"host-notify"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> I2C_CLIENT_HOST_NOTIFY<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_get_property</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> <span class="token string">"wakeup-source"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		info<span class="token punctuation">.</span>flags <span class="token operator">|=</span> I2C_CLIENT_WAKE<span class="token punctuation">;</span>

	result <span class="token operator">=</span> <span class="token function">i2c_new_device</span><span class="token punctuation">(</span>adap<span class="token punctuation">,</span> <span class="token operator">&amp;</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="i2c_new_device_2387"></a>i2c_new_device</h5> 
<pre><code class="prism language-c"><span class="token comment">// drivers/i2c/i2c-core-of.c</span>
<span class="token keyword">struct</span> <span class="token class-name">i2c_client</span> <span class="token operator">*</span> <span class="token function">i2c_new_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">i2c_adapter</span> <span class="token operator">*</span>adap<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_board_info</span> <span class="token keyword">const</span> <span class="token operator">*</span>info<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">// ...</span>
	<span class="token keyword">struct</span> <span class="token class-name">i2c_client</span>	<span class="token operator">*</span>client<span class="token punctuation">;</span>
	client <span class="token operator">=</span> <span class="token function">kzalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span> <span class="token operator">*</span>client<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>adapter <span class="token operator">=</span> adap<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>platform_data <span class="token operator">=</span> info<span class="token operator">-&gt;</span>platform_data<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>archdata<span class="token punctuation">)</span>
		client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>archdata <span class="token operator">=</span> <span class="token operator">*</span>info<span class="token operator">-&gt;</span>archdata<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> info<span class="token operator">-&gt;</span>flags<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>addr <span class="token operator">=</span> info<span class="token operator">-&gt;</span>addr<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>irq <span class="token operator">=</span> info<span class="token operator">-&gt;</span>irq<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent <span class="token operator">=</span> <span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>adapter<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>bus <span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_bus_type<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token operator">&amp;</span>i2c_client_type<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node <span class="token operator">=</span> info<span class="token operator">-&gt;</span>of_node<span class="token punctuation">;</span>
	client<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>fwnode <span class="token operator">=</span> info<span class="token operator">-&gt;</span>fwnode<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>properties<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		status <span class="token operator">=</span> <span class="token function">device_add_properties</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>adap<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
				<span class="token string">"Failed to add properties to client %s: %d\n"</span><span class="token punctuation">,</span>
				client<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">goto</span> out_err<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token function">device_register</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>client<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> client<span class="token punctuation">;</span>
	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>确实如此，从device_node到i2c_client的转换主要是在这两个函数中了：</p> 
<ul><li>在<code>of_i2c_register_device()</code>函数中，从device_node节点中获取各种属性的值记录在info结构体中</li><li>然后将info传递给i2c_new_device()，生成一个对应的i2c_client结构并返回。</li></ul> 
<h4><a id="ambai2ce0004000si570_2430"></a>/amba/i2c@e0004000/si570</h4> 
<pre><code class="prism language-c"><span class="token operator">&amp;</span>i2c0 <span class="token punctuation">{<!-- --></span>
    status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
    clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">400000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>

    <span class="token comment">/* 
     *  /i2c@0/si570 节点不会被转换为platform_device, 
     *  si570被如何处理完全由父节点的platform_driver决定, 
     *  在这里，si570会被创建为 i2c_client(device)。
     */</span>
    si570<span class="token operator">:</span> clock<span class="token operator">-</span>generator@<span class="token number">5</span>d <span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">clock</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
        compatible <span class="token operator">=</span> <span class="token string">"silabs,si570"</span><span class="token punctuation">;</span>
        temperature<span class="token operator">-</span>stability <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">50</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x5d</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        factory<span class="token operator">-</span>fout <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">156250000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
        clock<span class="token operator">-</span>frequency <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">148500000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>根据刚刚的分析，父节点已经在probe的时候，就帮所有的子节点注册为<code>i2c_client</code>。</p> 
<blockquote> 
 <p>在i2c子系统中，<code>device</code>称为<code>client</code>。</p> 
</blockquote> 
<p>我们看看对应驱动的写法；注意到，这里是 <code>i2c_driver</code> 类型的驱动：</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/clk/clk-si570.c</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> clk_si570_of_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"silabs,si570"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"silabs,si571"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"silabs,si598"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"silabs,si599"</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> clk_si570_of_match<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注意到，这里是 `i2c_driver` 类型的驱动</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">i2c_driver</span> si570_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"si570"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> clk_si570_of_match<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> si570_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>remove     <span class="token operator">=</span> si570_remove<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>id_table   <span class="token operator">=</span> si570_id<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">module_i2c_driver</span><span class="token punctuation">(</span>si570_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>因此，就会在<code>si570_driver</code>中的probe匹配对应的<code>devrice_driver</code>，我们具体就不再细看了。</p> 
<h3><a id="socmygpioleds_2486"></a>/soc/mygpio-leds</h3> 
<p><code>/soc</code>同样具备<code>compatible = "simple-bus";</code>，就不再解释了。</p> 
<pre><code class="prism language-c"><span class="token operator">&amp;</span>soc <span class="token punctuation">{<!-- --></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
    ranges <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span> <span class="token number">0</span> <span class="token number">0</span> <span class="token number">0xffffffff</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
    compatible <span class="token operator">=</span> <span class="token string">"simple-bus"</span><span class="token punctuation">;</span>
    
    <span class="token comment">// /soc/mygpio-leds 会称为 platform device</span>
    mygpio<span class="token operator">-</span>leds <span class="token punctuation">{<!-- --></span>
        compatible <span class="token operator">=</span> <span class="token string">"gpio-leds"</span><span class="token punctuation">;</span>

        led<span class="token operator">-</span>blue<span class="token punctuation">{<!-- --></span>
            label <span class="token operator">=</span> <span class="token string">"blue"</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">-</span>state <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">;</span>
            <span class="token comment">//gpios = &lt;&amp;msm_gpio 17 0x00&gt;;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        led<span class="token operator">-</span>green<span class="token punctuation">{<!-- --></span>
            label <span class="token operator">=</span> <span class="token string">"green"</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">-</span>state <span class="token operator">=</span> <span class="token string">"off"</span><span class="token punctuation">;</span>
            <span class="token comment">//gpios = &lt;&amp;msm_gpio 34 0x00&gt;;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们看看下面的<code>/soc/mygpio-leds</code>节点，以及下面的子节点<code>/soc/mygpio-leds/{led-blue,led-green}</code>。</p> 
<pre><code class="prism language-c"><span class="token comment">// drievers/leds/leds-gpio.c</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> of_gpio_leds_match<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"gpio-leds"</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">MODULE_DEVICE_TABLE</span><span class="token punctuation">(</span>of<span class="token punctuation">,</span> of_gpio_leds_match<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> gpio_led_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>probe      <span class="token operator">=</span> gpio_led_probe<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>shutdown   <span class="token operator">=</span> gpio_led_shutdown<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>driver     <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span>name   <span class="token operator">=</span> <span class="token string">"leds-gpio"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> of_gpio_leds_match<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">module_platform_driver</span><span class="token punctuation">(</span>gpio_led_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="gpio_led_probe_2536"></a>gpio_led_probe</h4> 
<p>实际上，类似刚刚提到的i2c，<code>/soc/mygpio-leds</code>下的子节点会被<code>gpio_led_driver</code>处理，实际上就是在<code>gpio_led_probe</code>中进行的。</p> 
<pre><code class="prism language-c"><span class="token comment">// drivers/leds/leds-gpio.c</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">gpio_led_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_led_platform_data</span> <span class="token operator">*</span>pdata <span class="token operator">=</span> <span class="token function">dev_get_platdata</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_leds_priv</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> i<span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pdata <span class="token operator">&amp;&amp;</span> pdata<span class="token operator">-&gt;</span>num_leds<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        priv <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
                <span class="token function">sizeof_gpio_leds_priv</span><span class="token punctuation">(</span>pdata<span class="token operator">-&gt;</span>num_leds<span class="token punctuation">)</span><span class="token punctuation">,</span>
                    GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>

        priv<span class="token operator">-&gt;</span>num_leds <span class="token operator">=</span> pdata<span class="token operator">-&gt;</span>num_leds<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> priv<span class="token operator">-&gt;</span>num_leds<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 填充 为 gpio led 对应的属性</span>
            ret <span class="token operator">=</span> <span class="token function">create_gpio_led</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdata<span class="token operator">-&gt;</span>leds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>leds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>
                          <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
                          pdata<span class="token operator">-&gt;</span>gpio_blink_set<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 寻找子节点，并解析，创建设备</span>
        priv <span class="token operator">=</span> <span class="token function">gpio_leds_create</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>priv<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>priv<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> priv<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="led_2577"></a>创建led</h5> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">create_gpio_led</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">gpio_led</span> <span class="token operator">*</span>template<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_led_data</span> <span class="token operator">*</span>led_dat<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">,</span>
    <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">,</span> <span class="token class-name">gpio_blink_set_t</span> blink_set<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> ret<span class="token punctuation">,</span> state<span class="token punctuation">;</span>

    led_dat<span class="token operator">-&gt;</span>gpiod <span class="token operator">=</span> template<span class="token operator">-&gt;</span>gpiod<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>led_dat<span class="token operator">-&gt;</span>gpiod<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/*
         * This is the legacy code path for platform code that
         * still uses GPIO numbers. Ultimately we would like to get
         * rid of this block completely.
         */</span>
        <span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags <span class="token operator">=</span> GPIOF_OUT_INIT_LOW<span class="token punctuation">;</span>

        <span class="token comment">/* skip leds that aren't available */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">gpio_is_valid</span><span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>gpio<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">dev_info</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> <span class="token string">"Skipping unavailable LED gpio %d (%s)\n"</span><span class="token punctuation">,</span>
                    template<span class="token operator">-&gt;</span>gpio<span class="token punctuation">,</span> template<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>active_low<span class="token punctuation">)</span>
            flags <span class="token operator">|=</span> GPIOF_ACTIVE_LOW<span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">devm_gpio_request_one</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> template<span class="token operator">-&gt;</span>gpio<span class="token punctuation">,</span> flags<span class="token punctuation">,</span>
                        template<span class="token operator">-&gt;</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

        led_dat<span class="token operator">-&gt;</span>gpiod <span class="token operator">=</span> <span class="token function">gpio_to_desc</span><span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>gpio<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>led_dat<span class="token operator">-&gt;</span>gpiod<span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>EINVAL<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>name <span class="token operator">=</span> template<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
    led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>default_trigger <span class="token operator">=</span> template<span class="token operator">-&gt;</span>default_trigger<span class="token punctuation">;</span>
    led_dat<span class="token operator">-&gt;</span>can_sleep <span class="token operator">=</span> <span class="token function">gpiod_cansleep</span><span class="token punctuation">(</span>led_dat<span class="token operator">-&gt;</span>gpiod<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>led_dat<span class="token operator">-&gt;</span>can_sleep<span class="token punctuation">)</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>brightness_set <span class="token operator">=</span> gpio_led_set<span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>brightness_set_blocking <span class="token operator">=</span> gpio_led_set_blocking<span class="token punctuation">;</span>
    led_dat<span class="token operator">-&gt;</span>blinking <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blink_set<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        led_dat<span class="token operator">-&gt;</span>platform_gpio_blink_set <span class="token operator">=</span> blink_set<span class="token punctuation">;</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>blink_set <span class="token operator">=</span> gpio_blink_set<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>default_state <span class="token operator">==</span> LEDS_GPIO_DEFSTATE_KEEP<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        state <span class="token operator">=</span> <span class="token function">gpiod_get_value_cansleep</span><span class="token punctuation">(</span>led_dat<span class="token operator">-&gt;</span>gpiod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>state <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> state<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        state <span class="token operator">=</span> <span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>default_state <span class="token operator">==</span> LEDS_GPIO_DEFSTATE_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>brightness <span class="token operator">=</span> state <span class="token operator">?</span> LED_FULL <span class="token operator">:</span> LED_OFF<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>template<span class="token operator">-&gt;</span>retain_state_suspended<span class="token punctuation">)</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>flags <span class="token operator">|=</span> LED_CORE_SUSPENDRESUME<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>panic_indicator<span class="token punctuation">)</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>flags <span class="token operator">|=</span> LED_PANIC_INDICATOR<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>template<span class="token operator">-&gt;</span>retain_state_shutdown<span class="token punctuation">)</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>flags <span class="token operator">|=</span> LED_RETAIN_AT_SHUTDOWN<span class="token punctuation">;</span>

    ret <span class="token operator">=</span> <span class="token function">gpiod_direction_output</span><span class="token punctuation">(</span>led_dat<span class="token operator">-&gt;</span>gpiod<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">devm_of_led_classdev_register</span><span class="token punctuation">(</span>parent<span class="token punctuation">,</span> np<span class="token punctuation">,</span> <span class="token operator">&amp;</span>led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_2650"></a>根据子节点创建的</h5> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">gpio_leds_priv</span> <span class="token operator">*</span><span class="token function">gpio_leds_create</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">fwnode_handle</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">gpio_leds_priv</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
    <span class="token keyword">int</span> count<span class="token punctuation">,</span> ret<span class="token punctuation">;</span>

    count <span class="token operator">=</span> <span class="token function">device_get_child_node_count</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>count<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENODEV<span class="token punctuation">)</span><span class="token punctuation">;</span>

    priv <span class="token operator">=</span> <span class="token function">devm_kzalloc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token function">sizeof_gpio_leds_priv</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>priv<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>ENOMEM<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">device_for_each_child_node</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">struct</span> <span class="token class-name">gpio_led_data</span> <span class="token operator">*</span>led_dat <span class="token operator">=</span> <span class="token operator">&amp;</span>priv<span class="token operator">-&gt;</span>leds<span class="token punctuation">[</span>priv<span class="token operator">-&gt;</span>num_leds<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">gpio_led</span> led <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>state <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
        <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> <span class="token function">to_of_node</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">fwnode_property_read_string</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string">"label"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>led<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&amp;&amp;</span> <span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_OF<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> np<span class="token punctuation">)</span>
            led<span class="token punctuation">.</span>name <span class="token operator">=</span> np<span class="token operator">-&gt;</span>name<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>led<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fwnode_handle_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span><span class="token operator">-</span>EINVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        led<span class="token punctuation">.</span>gpiod <span class="token operator">=</span> <span class="token function">devm_fwnode_get_gpiod_from_child</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> child<span class="token punctuation">,</span>
                                 GPIOD_ASIS<span class="token punctuation">,</span>
                                 led<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>gpiod<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fwnode_handle_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ERR_CAST</span><span class="token punctuation">(</span>led<span class="token punctuation">.</span>gpiod<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">fwnode_property_read_string</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string">"linux,default-trigger"</span><span class="token punctuation">,</span>
                        <span class="token operator">&amp;</span>led<span class="token punctuation">.</span>default_trigger<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">fwnode_property_read_string</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string">"default-state"</span><span class="token punctuation">,</span>
                         <span class="token operator">&amp;</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">"keep"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                led<span class="token punctuation">.</span>default_state <span class="token operator">=</span> LEDS_GPIO_DEFSTATE_KEEP<span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">strcmp</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token string">"on"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                led<span class="token punctuation">.</span>default_state <span class="token operator">=</span> LEDS_GPIO_DEFSTATE_ON<span class="token punctuation">;</span>
            <span class="token keyword">else</span>
                led<span class="token punctuation">.</span>default_state <span class="token operator">=</span> LEDS_GPIO_DEFSTATE_OFF<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fwnode_property_present</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string">"retain-state-suspended"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            led<span class="token punctuation">.</span>retain_state_suspended <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fwnode_property_present</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string">"retain-state-shutdown"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            led<span class="token punctuation">.</span>retain_state_shutdown <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">fwnode_property_present</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token string">"panic-indicator"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            led<span class="token punctuation">.</span>panic_indicator <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

        ret <span class="token operator">=</span> <span class="token function">create_gpio_led</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>led<span class="token punctuation">,</span> led_dat<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> np<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">fwnode_handle_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        led_dat<span class="token operator">-&gt;</span>cdev<span class="token punctuation">.</span>dev<span class="token operator">-&gt;</span>of_node <span class="token operator">=</span> np<span class="token punctuation">;</span>
        priv<span class="token operator">-&gt;</span>num_leds<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> priv<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>就这样子，用上了。</p> 
<h4><a id="_2725"></a>总结</h4> 
<p>可以看到，i2c下面的子节点并没有被处理为<code>platform_device</code></p> 
<p>为什么在内核初始化时只将一级子目录节点(compatible属性中含有"simple-bus"、“simple-mfd”、“isa”、"arm,amba-bus"的向下递归一级)转换成platform_device？</p> 
<p>对于bus而言，有不同的总线处理方式和不同的<code>driver</code>、<code>device</code>的命名，自然不能将所有节点全部转换成<code>platform_device</code>。</p> 
<p>在linux中，将一级子节点视为bus，而多级子节点则由具体的bus去处理。这样子其实也是从另外的角度体现出整个驱动框架的分层思想。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d1818f04951ece3877d7c6b61a2fed0e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">(十二) findContours函数的hierarchy详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/07fa5e03017c59cb1c6dcc33ba17553a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">jsp中使用JDBC连接mysql的方法与实例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>