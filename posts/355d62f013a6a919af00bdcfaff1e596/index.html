<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ClickHouse学习 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ClickHouse学习" />
<meta property="og:description" content="ClickHouse 一.概述1.特点2.安装2.1 安装前准备2.2 正式安装 3.数据类型4.引擎1.TinyLog2.Memory3.MergeTree4.ReplacingMergeTree5.SummingMergeTree 二.SQL操作1.insert2.update 和 delete3.select 三.副本1.配置步骤2.副本测试四.Java API 一.概述 1.特点 ClickHouse 是俄罗斯的 Yandex 于 2016 年开源的列式存储数据库（DBMS），使用
C&#43;&#43;语言编写，主要用于在线分析处理查询（OLAP），能够使用 SQL 查询实时生成分析
数据报告
OLAP适合一次写入，多次读取
OLTP可以增删改查，因为有事务支持
1.列式存储
2.DBMS 的功能
几乎覆盖了标准 SQL 的大部分语法，包括 DDL 和 DML，以及配套的各种函数，用户管理及权限管理，数据的备份与恢复
3.多样化引擎
ClickHouse 和 MySQL 类似，把表级的存储引擎插件化，根据表的不同需求可以设定不同的存储引擎。目前包括合并树、日志、接口和其他四大类 20 多种引擎
4.高吞吐写入能力
ClickHouse 采用类 LSM Tree 的结构，数据写入后定期在后台 Compaction。通过类LSM tree 的结构，ClickHouse 在数据导入时全部是顺序 append 写，写入后数据段不可更改，在后台 compaction 时也是多个段 merge sort 后顺序写回磁盘。顺序写的特性，充分利用了磁盘的吞吐能力，即便在 HDD 上也有着优异的写入性能。官方公开 benchmark 测试显示能够达到 50MB-200MB/s 的写入吞吐能力，按照每行 100Byte 估算，大约相当于 50W-200W 条/s 的写入速度
5.数据分区与线程级并行" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/355d62f013a6a919af00bdcfaff1e596/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-28T17:51:07+08:00" />
<meta property="article:modified_time" content="2023-06-28T17:51:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ClickHouse学习</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ClickHouse</h4> 
 <ul><li><ul><li><ul><li><a href="#_1" rel="nofollow">一.概述</a></li><li><ul><li><a href="#1_3" rel="nofollow">1.特点</a></li><li><a href="#2_31" rel="nofollow">2.安装</a></li><li><ul><li><a href="#21__32" rel="nofollow">2.1 安装前准备</a></li><li><a href="#22__85" rel="nofollow">2.2 正式安装</a></li></ul> 
     </li><li><a href="#3_150" rel="nofollow">3.数据类型</a></li><li><a href="#4_240" rel="nofollow">4.引擎</a></li><li><ul><li><a href="#1TinyLog_253" rel="nofollow">1.TinyLog</a></li><li><a href="#2Memory_263" rel="nofollow">2.Memory</a></li><li><a href="#3MergeTree_268" rel="nofollow">3.MergeTree</a></li><li><a href="#4ReplacingMergeTree_398" rel="nofollow">4.ReplacingMergeTree</a></li><li><a href="#5SummingMergeTree_432" rel="nofollow">5.SummingMergeTree</a></li></ul> 
    </li></ul> 
    </li><li><a href="#SQL_481" rel="nofollow">二.SQL操作</a></li><li><ul><li><a href="#1insert_482" rel="nofollow">1.insert</a></li><li><a href="#2update__delete_496" rel="nofollow">2.update 和 delete</a></li><li><a href="#3select_527" rel="nofollow">3.select</a></li></ul> 
    </li><li><a href="#_567" rel="nofollow">三.副本</a></li><li><ul><li><a href="#1_572" rel="nofollow">1.配置步骤</a></li><li><a href="#2_607" rel="nofollow">2.副本测试</a></li><li><a href="#Java_API_652" rel="nofollow">四.Java API</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="_1"></a>一.概述</h4> 
<h5><a id="1_3"></a>1.特点</h5> 
<p>ClickHouse 是俄罗斯的 Yandex 于 2016 年开源的列式存储数据库（DBMS），使用<br> C++语言编写，主要用于在线分析处理查询（OLAP），能够使用 SQL 查询实时生成分析<br> 数据报告</p> 
<p>OLAP适合一次写入，多次读取<br> OLTP可以增删改查，因为有事务支持</p> 
<p><strong>1.列式存储</strong></p> 
<p><strong>2.DBMS 的功能</strong></p> 
<p>几乎覆盖了标准 SQL 的大部分语法，包括 DDL 和 DML，以及配套的各种函数，用户管理及权限管理，数据的备份与恢复</p> 
<p><strong>3.多样化引擎</strong></p> 
<p>ClickHouse 和 MySQL 类似，把表级的存储引擎插件化，根据表的不同需求可以设定不同的存储引擎。目前包括合并树、日志、接口和其他四大类 20 多种引擎</p> 
<p><strong>4.高吞吐写入能力</strong></p> 
<p>ClickHouse 采用类 LSM Tree 的结构，数据写入后定期在后台 Compaction。通过类LSM tree 的结构，ClickHouse 在数据导入时全部是顺序 append 写，写入后数据段不可更改，在后台 compaction 时也是多个段 merge sort 后顺序写回磁盘。顺序写的特性，充分利用了磁盘的吞吐能力，即便在 HDD 上也有着优异的写入性能。官方公开 benchmark 测试显示能够达到 50MB-200MB/s 的写入吞吐能力，按照每行 100Byte 估算，大约相当于 50W-200W 条/s 的写入速度</p> 
<p><strong>5.数据分区与线程级并行</strong></p> 
<p>ClickHouse 将数据划分为多个 partition，每个 partition 再进一步划分为多个 index granularity(索引粒度)，然后通过多个 CPU 核心分别处理其中的一部分来实现并行数据处理。在这种设计下，单条 Query 就能利用整机所有 CPU。极致的并行处理能力，极大的降低了查询延时</p> 
<p>所以，ClickHouse 即使对于大量数据的查询也能够化整为零平行处理。但是有一个弊端就是对于单条查询使用多 cpu，就不利于同时并发多条查询。所以对于高 qps 的查询业务，ClickHouse 并不是强项</p> 
<h5><a id="2_31"></a>2.安装</h5> 
<h6><a id="21__32"></a>2.1 安装前准备</h6> 
<p><strong>（1）确定防火墙处于关闭状态</strong></p> 
<p><strong>（2）CentOS 取消打开文件数限制</strong></p> 
<p>在 hadoop102 的 /etc/security/limits.conf 文件的末尾加入以下内容</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/security/limits.conf
</code></pre> 
<pre><code class="prism language-bash">* soft nofile <span class="token number">65536</span>
* hard nofile <span class="token number">65536</span>
* soft nproc <span class="token number">131072</span>
* hard nproc <span class="token number">131072</span>
</code></pre> 
<p>在 hadoop102 的/etc/security/limits.d/20-nproc.conf 文件的末尾加入以下内容</p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/security/limits.d/20-nproc.conf
</code></pre> 
<pre><code class="prism language-bash">* soft nofile <span class="token number">65536</span>
* hard nofile <span class="token number">65536</span>
* soft nproc <span class="token number">131072</span>
* hard nproc <span class="token number">131072</span>
</code></pre> 
<p><strong>分发到另外两天机器</strong></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> /home/gzhu/bin/xsync /etc/security/limits.conf
<span class="token function">sudo</span> /home/gzhu/bin/xsync /etc/security/limits.d/20-nproc.conf
</code></pre> 
<p><strong>（3）三台机器安装依赖</strong></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> -y libtool
</code></pre> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> yum <span class="token function">install</span> -y *unixODBC*
</code></pre> 
<p><strong>（4）CentOS 取消 SELINUX（三台机器都要）</strong></p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">SELINUX</span><span class="token operator">=</span>disabled
</code></pre> 
<p><strong>（5）重启三台服务器</strong></p> 
<h6><a id="22__85"></a>2.2 正式安装</h6> 
<p><strong>安装资料</strong><br> <img src="https://images2.imgbox.com/02/b9/kzfpBRvI_o.png" alt="在这里插入图片描述"><br> 链接：https://pan.baidu.com/s/10UxBTen44ALCLo0kOKIiZA<br> 提取码：sgo0</p> 
<p><strong>上传到hadoop102</strong></p> 
<p><img src="https://images2.imgbox.com/0b/99/DaUwf0nM_o.png" alt="在这里插入图片描述"><br> <strong>分发</strong></p> 
<pre><code class="prism language-bash">xsync /opt/software/clickhouse
</code></pre> 
<p><strong>分别在三台机子上安装这 4 个 rpm 文件</strong></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>gzhu@hadoop102 clickhouse<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh *.rpm
<span class="token punctuation">[</span>gzhu@hadoop103 clickhouse<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh *.rpm
<span class="token punctuation">[</span>gzhu@hadoop104 clickhouse<span class="token punctuation">]</span>$ <span class="token function">sudo</span> <span class="token function">rpm</span> -ivh *.rpm
</code></pre> 
<p><img src="https://images2.imgbox.com/10/fb/9XgLTz2W_o.png" alt="在这里插入图片描述"></p> 
<p><strong>修改配置文件并分发</strong></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/clickhouse-server/config.xml
</code></pre> 
<p>把 &lt;listen_host&gt;::&lt;/listen_host&gt; 的注释打开，这样的话才能让 ClickHouse 被除本机以外的服务器访问</p> 
<p><img src="https://images2.imgbox.com/9c/3b/1tQwSRvb_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-bash"><span class="token function">sudo</span> /home/gzhu/bin/xsync /etc/clickhouse-server/config.xml
</code></pre> 
<p><mark>在这个文件中，有 ClickHouse 的一些默认路径配置，比较重要的<br> 数据文件路径： 
  <path>
    /var/lib/clickhouse/ 
  </path><br> 日志文件路径：/var/log/clickhouse-server/clickhouse-server.log</mark></p> 
<p><strong>启动 Server</strong></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>gzhu@hadoop102 clickhouse<span class="token punctuation">]</span>$ <span class="token function">sudo</span> systemctl start clickhouse-server
</code></pre> 
<p><strong>查看状态</strong><br> <img src="https://images2.imgbox.com/08/35/drMyKBXm_o.png" alt="在这里插入图片描述"><br> <strong>三台机器上关闭开机自启</strong></p> 
<pre><code class="prism language-bash"><span class="token punctuation">[</span>gzhu@hadoop102 clickhouse<span class="token punctuation">]</span><span class="token variable">$sudo</span> systemctl disable clickhouse-server
</code></pre> 
<p><strong>使用 client 连接 server</strong></p> 
<pre><code class="prism language-bash">clickhouse-client -m
</code></pre> 
<p>-m :可以在命令窗口输入多行命令</p> 
<p><img src="https://images2.imgbox.com/7a/26/h8RtScnP_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="3_150"></a>3.数据类型</h5> 
<p><strong>整型</strong></p> 
<p>固定长度的整型，包括有符号整型或无符号整型<br> 整型范围（-2n-1~2n-1-1）：</p> 
<p>Int8 - [-128 : 127]<br> Int16 - [-32768 : 32767]<br> Int32 - [-2147483648 : 2147483647]<br> Int64 - [-9223372036854775808 : 9223372036854775807]<br> 无符号整型范围（0~2n-1）：</p> 
<p>UInt8 - [0 : 255]<br> UInt16 - [0 : 65535]<br> UInt32 - [0 : 4294967295]<br> UInt64 - [0 : 18446744073709551615]</p> 
<p><code>使用场景： 个数、数量、也可以存储型 id</code></p> 
<p><strong>浮点型</strong></p> 
<p>Float32 - float<br> Float64 – double</p> 
<p>建议尽可能以整数形式存储数据。例如，将固定精度的数字转换为整数值，如时间用毫秒为单位表示，因为浮点型进行计算时可能引起四舍五入的误差</p> 
<p><img src="https://images2.imgbox.com/1a/d1/ZiiColK3_o.png" alt="在这里插入图片描述"><br> <strong>布尔型</strong></p> 
<p>没有单独的类型来存储布尔值。可以使用 UInt8 类型，取值限制为 0 或 1</p> 
<p><strong>Decimal 型</strong></p> 
<p>有符号的浮点数，可在加、减和乘法运算过程中保持精度。对于除法，最低有效数字会被丢弃（不舍入）<br> 有三种声明：<br> ➢ Decimal32(s)，相当于 Decimal(9-s,s)，有效位数为 1~9<br> ➢ Decimal64(s)，相当于 Decimal(18-s,s)，有效位数为 1~18<br> ➢ Decimal128(s)，相当于 Decimal(38-s,s)，有效位数为 1~38</p> 
<p><code>使用场景： 一般金额字段、汇率、利率等字段为了保证小数点精度，都使用 Decimal 进行 存储</code></p> 
<p><strong>字符串</strong></p> 
<p>➢ String<br> 字符串可以任意长度的。它可以包含任意的字节集，包含空字节</p> 
<p>➢ FixedString(N)</p> 
<p>固定长度 N 的字符串，N 必须是严格的正自然数。当服务端读取长度小于 N 的字符串时候，通过在字符串末尾添加空字节来达到 N 字节长度。 当服务端读取长度大于 N 的字符串时候，将返回错误消息</p> 
<p>使用场景：名称、文字描述、字符型编码。 固定长度的可以保存一些定长的内容，比如一些编码，性别等但是考虑到一定的变化风险，带来收益不够明显，所以定长字符串使用意义有限</p> 
<p><strong>枚举类型</strong></p> 
<p>包括 Enum8 和 Enum16 类型。Enum 保存 ‘string’= integer 的对应关系</p> 
<p>Enum8 用 ‘String’= Int8 对描述<br> Enum16 用 ‘String’= Int16 对描述</p> 
<p>➢ 用法演示<br> 创建一个带有一个枚举 Enum8(‘hello’ = 1, ‘world’ = 2) 类型的列</p> 
<pre><code class="prism language-bash">CREATE TABLE t_enum
<span class="token punctuation">(</span>
 x Enum8<span class="token punctuation">(</span><span class="token string">'hello'</span> <span class="token operator">=</span> <span class="token number">1</span>, <span class="token string">'world'</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
ENGINE <span class="token operator">=</span> TinyLog<span class="token punctuation">;</span> 
</code></pre> 
<p>➢ 这个 x 列只能存储类型定义中列出的值：‘hello’或’world’</p> 
<p>只能插入hello和world</p> 
<p>如果需要看到对应行的数值，则必须将 Enum 值转换为整数类型</p> 
<pre><code class="prism language-bash">hadoop102 <span class="token builtin class-name">:</span><span class="token punctuation">)</span> SELECT CAST<span class="token punctuation">(</span>x, <span class="token string">'Int8'</span><span class="token punctuation">)</span> FROM t_enum<span class="token punctuation">;</span>
</code></pre> 
<p><strong>时间类型</strong></p> 
<p>目前 ClickHouse 有三种时间类型</p> 
<p>➢ Date 接受年-月-日的字符串比如 ‘2019-12-16’<br> ➢ Datetime 接受年-月-日 时:分:秒的字符串比如 ‘2019-12-16 20:50:10’<br> ➢ Datetime64 接 受 年 - 月 - 日 时 : 分 : 秒 . 亚 秒 的 字 符 串 比 如 ‘ 2019-12-16 20:50:10.66’</p> 
<h5><a id="4_240"></a>4.引擎</h5> 
<p>表引擎是 ClickHouse 的一大特色。可以说， 表引擎决定了如何存储表的数据。包括：<br> ➢ 数据的存储方式和位置，写到哪里以及从哪里读取数据<br> ➢ 支持哪些查询以及如何支持<br> ➢ 并发数据访问<br> ➢ 索引的使用（如果存在）<br> ➢ 是否可以执行多线程请求<br> ➢ 数据复制参数</p> 
<p>表引擎的使用方式就是必须显式在创建表时定义该表使用的引擎，以及引擎使用的相关参数</p> 
<p><mark>特别注意：引擎的名称大小写敏感</mark></p> 
<h6><a id="1TinyLog_253"></a>1.TinyLog</h6> 
<p>以列文件的形式保存在磁盘上，不支持索引，没有并发控制。一般保存少量数据的小表，生产环境上作用有限。可以用于平时练习测试用</p> 
<p>如：</p> 
<pre><code class="prism language-bash">create table t_tinylog <span class="token punctuation">(</span> <span class="token function">id</span> String, name String<span class="token punctuation">)</span> <span class="token assign-left variable">engine</span><span class="token operator">=</span>TinyLog<span class="token punctuation">;</span>
</code></pre> 
<h6><a id="2Memory_263"></a>2.Memory</h6> 
<p>内存引擎，数据以未压缩的原始形式直接保存在内存当中，服务器重启数据就会消失。读写操作不会相互阻塞，不支持索引。简单查询下有非常非常高的性能表现（超过 10G/s）。一般用到它的地方不多，除了用来测试，就是在需要非常高的性能，同时数据量又不太大（上限大概 1 亿行）的场景</p> 
<h6><a id="3MergeTree_268"></a>3.MergeTree</h6> 
<p>ClickHouse 中最强大的表引擎当属 MergeTree（合并树）引擎及该系列（MergeTree）中的其他引擎，支持索引和分区，地位可以相当于 innodb 之于 Mysql。 而且基于MergeTree，还衍生除了很多小弟，也是非常有特色的引擎</p> 
<p>➢ 建表语句</p> 
<pre><code class="prism language-bash">create table t_order_mt<span class="token punctuation">(</span>
 <span class="token function">id</span> UInt32,
 sku_id String,
 total_amount Decimal<span class="token punctuation">(</span><span class="token number">16,2</span><span class="token punctuation">)</span>,
 create_time Datetime
<span class="token punctuation">)</span> engine <span class="token operator">=</span>MergeTree
partition by toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 order by <span class="token punctuation">(</span>id,sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们根据时间分区，toYYYYMMDD是函数，按照年月日分区。按照order by排序（分区内生效），<mark>特别，clickhouse主键是不唯一的，主键的设定主要依据是查询语句中的 where 条件。根据条件通过对主键进行某种形式的二分查找，能够定位到对应的 index granularity，避免了全表扫描</mark></p> 
<p>➢ 插入数据</p> 
<pre><code class="prism language-bash">insert into t_order_mt values
<span class="token punctuation">(</span><span class="token number">101</span>,<span class="token string">'sku_001'</span>,1000.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span> ,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 11:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_004'</span>,2500.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,12000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,600.00,<span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/c1/5c/UJR71Tc5_o.png" alt="在这里插入图片描述"></p> 
<p>MergeTree 其实还有很多参数(绝大多数用默认值即可)，但是三个参数是更加重要的，也涉及了关于 MergeTree 的很多概念</p> 
<p><strong>partition by 分区(可选)</strong></p> 
<p>➢ 作用</p> 
<p>分区的目的主要是降低扫描的范围，优化查询速度</p> 
<p>➢ 分区目录<br> MergeTree 是以列文件+索引文件+表定义文件组成的，但是如果设定了分区那么这些文件就会保存到不同的分区目录中</p> 
<p>➢ 并行</p> 
<p><code>分区后，面对涉及跨分区的查询统计，ClickHouse 会以分区为单位并行处理</code>，我们看到，不同分区实际上是不同的文件</p> 
<p><img src="https://images2.imgbox.com/69/71/wVJzxJ9a_o.png" alt="在这里插入图片描述"></p> 
<p>➢ 数据写入与分区合并</p> 
<p>任何一个批次的数据写入都会产生一个临时分区，不会纳入任何一个已有的分区。写入后的某个时刻（大概 10-15 分钟后），ClickHouse 会自动执行合并操作（等不及也可以手动通过 optimize 执行），把临时分区的数据，合并到已有分区中</p> 
<p>再插入一批数据</p> 
<pre><code class="prism language-bash">insert into t_order_mt values
<span class="token punctuation">(</span><span class="token number">101</span>,<span class="token string">'sku_001'</span>,1000.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span> ,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 11:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_004'</span>,2500.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,12000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,600.00,<span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看到，并没有进行分区合并<br> <img src="https://images2.imgbox.com/6b/ef/pNaYp0ci_o.png" alt="在这里插入图片描述"></p> 
<p>手动合并</p> 
<pre><code class="prism language-bash">optimize table t_order_mt final<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/04/b1/BRl2Ikp9_o.png" alt="在这里插入图片描述"><br> <strong>primary key 主键(可选)</strong></p> 
<p>ClickHouse 中的主键，和其他数据库不太一样，它只提供了数据的一级索引，但是却不是唯一约束。这就意味着是可以存在相同 primary key 的数据的。主键的设定主要依据是查询语句中的 where 条件</p> 
<p>根据条件通过对主键进行某种形式的二分查找，能够定位到对应的 index granularity,避免了全表扫描</p> 
<p>index granularity： 直接翻译的话就是索引粒度，指在稀疏索引中两个相邻索引对应数据的间隔。ClickHouse 中的 MergeTree 默认是 8192。官方不建议修改这个值，除非该列存在大量重复值，比如在一个分区中几万行才有一个不同数据</p> 
<p><img src="https://images2.imgbox.com/10/05/mwTBSZgv_o.png" alt="在这里插入图片描述"></p> 
<p>稀疏索引的好处就是可以用很少的索引数据，定位更多的数据，代价就是只能定位到索引粒度的第一行，然后再进行进行一点扫描</p> 
<p><strong>order by(必选)</strong></p> 
<p>order by 设定了分区内的数据按照哪些字段顺序进行有序保存</p> 
<p>order by 是 MergeTree 中唯一一个必填项，甚至比 primary key 还重要，因为当用户不设置主键的情况，很多处理会依照 order by 的字段进行处理（比如后面会讲的去重和汇总）</p> 
<p><code>要求：主键必须是 order by 字段的前缀字段</code></p> 
<p>比如 order by 字段是 (id,sku_id) 那么主键必须是 id 或者(id,sku_id)，<mark>主键的作用是建立索引，必须有序，对于id和sku_id而言，id一定是有序的，而sku_id受id的影响，不一定是有序的，所以我们不能跳过id选择sku_id建立索引</mark></p> 
<p><strong>数据 TTL</strong></p> 
<p>TTL create_time+interval 10 SECOND，10秒后过期，<code>要根据实际时间做测试</code></p> 
<pre><code class="prism language-bash">create table t_order_mt2<span class="token punctuation">(</span>
 <span class="token function">id</span> UInt32,
 sku_id String,
 total_amount Decimal<span class="token punctuation">(</span><span class="token number">16,2</span><span class="token punctuation">)</span> TTL create_time+interval <span class="token number">10</span> SECOND,
 create_time Datetime 
<span class="token punctuation">)</span> engine <span class="token operator">=</span>MergeTree
partition by toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 order by <span class="token punctuation">(</span>id, sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash">insert into t_order_mt2 values
<span class="token punctuation">(</span><span class="token number">106</span>,<span class="token string">'sku_001'</span>,1000.00,<span class="token string">'2022-08-01 15:55:30'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">107</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2022-08-01 15:55:30'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">110</span>,<span class="token string">'sku_003'</span>,600.00,<span class="token string">'2022-08-01 15:55:30'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/8b/7b7dYbPp_o.png" alt="在这里插入图片描述"><br> 手动合并，可以看到，<code>数据变成了对应类型的默认值，但列并没有删除</code></p> 
<pre><code class="prism language-bash">optimize table t_order_mt2 final<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/f2/0e/mBZgfh6g_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="4ReplacingMergeTree_398"></a>4.ReplacingMergeTree</h6> 
<p>ReplacingMergeTree 是 MergeTree 的一个变种，它存储特性完全继承 MergeTree，只是多了一个去重的功能。 尽管 MergeTree 可以设置主键，但是 primary key 其实没有唯一约束的功能。如果你想处理掉重复的数据，可以借助这个 ReplacingMergeTree，<mark>注意，是根据order_by的字段去重</mark></p> 
<pre><code class="prism language-bash">create table t_order_rmt<span class="token punctuation">(</span>
 <span class="token function">id</span> UInt32,
 sku_id String,
 total_amount Decimal<span class="token punctuation">(</span><span class="token number">16,2</span><span class="token punctuation">)</span> ,
 create_time Datetime
<span class="token punctuation">)</span> engine <span class="token operator">=</span> ReplacingMergeTree<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 partition by toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 order by <span class="token punctuation">(</span>id, sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>上面的建表语句引擎用了ReplacingMergeTree，去重根据order by的字段id和sku_id，也就是不允许存在两个id和sku_id相同的行，那有相同的保留哪个呢？<mark>ReplacingMergeTree(arg) 填入的参数为版本字段，重复数据保留版本字段值最大的。如果不填版本字段，默认按照插入顺序保留最后一条，如果order_by字段相同，并且参数也相同，则保留最后插入的数据</mark></p> 
<pre><code class="prism language-bash">insert into t_order_rmt values
<span class="token punctuation">(</span><span class="token number">101</span>,<span class="token string">'sku_001'</span>,1000.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span> ,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 11:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_004'</span>,2500.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,12000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,600.00,<span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/08/47/X4oOSYvH_o.png" alt="在这里插入图片描述"></p> 
<p>手动合并</p> 
<pre><code class="prism language-bash">OPTIMIZE TABLE t_order_rmt FINAL<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e8/0a/hhrJvcnI_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="5SummingMergeTree_432"></a>5.SummingMergeTree</h6> 
<p>对于不查询明细，只关心以维度进行汇总聚合结果的场景。如果只使用普通的MergeTree 的话，无论是存储空间的开销，还是查询时临时聚合的开销都比较大。ClickHouse 为了这种场景，提供了一种能够“预聚合”的引擎 SummingMergeTree</p> 
<pre><code class="prism language-bash">create table t_order_smt<span class="token punctuation">(</span>
 <span class="token function">id</span> UInt32,
 sku_id String,
 total_amount Decimal<span class="token punctuation">(</span><span class="token number">16,2</span><span class="token punctuation">)</span> ,
 create_time Datetime<span class="token punctuation">)</span> engine <span class="token operator">=</span>SummingMergeTree<span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span>
 partition by toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 primary key <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 order by <span class="token punctuation">(</span>id,sku_id <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-bash">insert into t_order_smt values
<span class="token punctuation">(</span><span class="token number">101</span>,<span class="token string">'sku_001'</span>,1000.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 11:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_004'</span>,2500.00,<span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,2000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,12000.00,<span class="token string">'2020-06-01 13:00:00'</span><span class="token punctuation">)</span>,
<span class="token punctuation">(</span><span class="token number">102</span>,<span class="token string">'sku_002'</span>,600.00,<span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ff/e2/ws2aeaJP_o.png" alt="在这里插入图片描述"><br> 手动合并</p> 
<pre><code class="prism language-bash">OPTIMIZE TABLE t_order_smt FINAL<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1f/e4/tMm6fUP3_o.png" alt="在这里插入图片描述"><br> ➢ 通过结果可以得到以下结论<br> ◼ 以 SummingMergeTree（）中指定的列作为汇总数据列<br> ◼ 可以填写多列必须数字列，如果不填，以所有非维度列且为数字列的字段为汇总数据列<br> ◼ 以 order by 的列为准，作为维度列<br> ◼ 其他的列按插入顺序保留第一行<br> ◼ 不在一个分区的数据不会被聚合</p> 
<p><strong>一个问题</strong></p> 
<p>能不能直接执行以下 SQL 得到汇总值</p> 
<p>select total_amount from XXX where province_name=’’ and create_date=’xxx’</p> 
<p><code>不行，可能会包含一些还没来得及聚合的临时明细</code></p> 
<p>如果要是获取汇总值，还是需要使用 sum 进行聚合，这样效率会有一定的提高，但本身ClickHouse 是列式存储的，效率提升有限，不会特别明显</p> 
<p>select sum(total_amount) from province_name=’’ and create_date=‘xxx’</p> 
<h4><a id="SQL_481"></a>二.SQL操作</h4> 
<h5><a id="1insert_482"></a>1.insert</h5> 
<p>➢ 标准</p> 
<pre><code class="prism language-bash">insert into <span class="token punctuation">[</span>table_name<span class="token punctuation">]</span> values<span class="token punctuation">(</span>…<span class="token punctuation">)</span>,<span class="token punctuation">(</span>….<span class="token punctuation">)</span> 
</code></pre> 
<p>➢ 从表到表的插入</p> 
<pre><code class="prism language-bash">insert into <span class="token punctuation">[</span>table_name<span class="token punctuation">]</span> <span class="token keyword">select</span> a,b,c from <span class="token punctuation">[</span>table_name_2<span class="token punctuation">]</span>
</code></pre> 
<h5><a id="2update__delete_496"></a>2.update 和 delete</h5> 
<p>➢ 删除操作</p> 
<pre><code class="prism language-bash">alter table t_order_smt delete where sku_id <span class="token operator">=</span><span class="token string">'sku_001'</span><span class="token punctuation">;</span>
</code></pre> 
<p>➢ 修改操作</p> 
<pre><code class="prism language-bash">alter table t_order_smt update <span class="token assign-left variable">total_amount</span><span class="token operator">=</span>toDecimal32<span class="token punctuation">(</span><span class="token number">2000.00</span>,2<span class="token punctuation">)</span> where <span class="token function">id</span> <span class="token operator">=</span><span class="token number">102</span><span class="token punctuation">;</span>
</code></pre> 
<p>➢ 新增字段</p> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tableName <span class="token keyword">add</span> <span class="token keyword">column</span> newcolname String <span class="token keyword">after</span> col1<span class="token punctuation">;</span> 
</code></pre> 
<p>➢ 修改字段类型</p> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tableName <span class="token keyword">modify</span> <span class="token keyword">column</span> newcolname String<span class="token punctuation">;</span> 
</code></pre> 
<p>➢ 删除字段</p> 
<pre><code class="prism language-sql"><span class="token keyword">alter</span> <span class="token keyword">table</span> tableName <span class="token keyword">drop</span> <span class="token keyword">column</span> newcolname<span class="token punctuation">;</span>
</code></pre> 
<h5><a id="3select_527"></a>3.select</h5> 
<p>➢ 支持子查询<br> ➢ 支持 CTE(Common Table Expression 公用表表达式 with 子句)<br> ➢ 支持各种 JOIN， 但是 JOIN 操作无法使用缓存，所以即使是两次相同的 JOIN 语句，ClickHouse 也会视为两条新 SQL<br> ➢ 窗口函数(官方正在测试中…)<br> ➢ 不支持自定义函数<br> ➢ GROUP BY 操作增加了 with rollup\with cube\with total 用来计算小计和总计</p> 
<p><strong>with rollup：从右至左去掉维度进行小计</strong></p> 
<p>如图，由下表，我们group by id和sku_id，所以id和sku_id是维度</p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/2a/f4/tFxv0ADp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id <span class="token keyword">with rollup</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以看到，结果分为了三部分，第一部分是全维度，也就是根据id和sku_id进行求和，第二部分就只剩了id维度，根据id求和，第三部分就没有维度了，全体求和<br> <img src="https://images2.imgbox.com/77/e7/hRZtOpla_o.png" alt="在这里插入图片描述"><br> <strong>with cube : 从右至左去掉维度进行小计，再从左至右去掉维度进行小计，也就是所有维度组合都来一遍</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id <span class="token punctuation">,</span> sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id <span class="token keyword">with</span> cube<span class="token punctuation">;</span>
</code></pre> 
<p>2个维度，共4种组合<br> <img src="https://images2.imgbox.com/be/0d/KK4U3xbo_o.png" alt="在这里插入图片描述"><br> <strong>with totals: 只计算合计</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> id<span class="token punctuation">,</span>sku_id<span class="token punctuation">,</span><span class="token function">sum</span><span class="token punctuation">(</span>total_amount<span class="token punctuation">)</span> <span class="token keyword">from</span> t_order_mt <span class="token keyword">group</span> <span class="token keyword">by</span> id<span class="token punctuation">,</span>sku_id <span class="token keyword">with</span> totals<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e2/c1/lLobPJ2n_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_567"></a>三.副本</h4> 
<p>副本的目的主要是保障数据的高可用性，即使一台 ClickHouse 节点宕机，那么也可以从其他服务器获得相同的数据</p> 
<p><img src="https://images2.imgbox.com/a8/bc/GEErusWn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="1_572"></a>1.配置步骤</h5> 
<p>➢ 启动 zookeeper 集群<br> ➢ 在hadoop102的/etc/clickhouse-server/config.d目录下创建一个名为metrika.xml的配置文件,内容如下：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>yandex</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>hadoop102<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>hadoop103<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>node</span> <span class="token attr-name">index</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>host</span><span class="token punctuation">&gt;</span></span>hadoop104<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>host</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>port</span><span class="token punctuation">&gt;</span></span>2181<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>port</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>node</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>zookeeper-servers</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>yandex</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>同步到另外两台机器</strong></p> 
<p>在 hadoop102 的/etc/clickhouse-server/config.xml 中增加</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>include_from</span><span class="token punctuation">&gt;</span></span>/etc/clickhouse-server/config.d/metrika.xml<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>include_from</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><strong>同步到另外两台机器</strong></p> 
<p><strong>重启clickhouse服务，起码两台服务器</strong></p> 
<h5><a id="2_607"></a>2.副本测试</h5> 
<p><code>注意，副本只能同步数据，但是表结构不可以同步，想要副本的话必须要在服务器手动创建表</code></p> 
<p>hadoop102</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_test <span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>ReplicatedMergeTree<span class="token punctuation">(</span><span class="token string">'/clickhouse/table/01/t_order_test'</span><span class="token punctuation">,</span><span class="token string">'rep_102'</span><span class="token punctuation">)</span>
 <span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>hadoop103</p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> t_order_test<span class="token punctuation">(</span>
 id UInt32<span class="token punctuation">,</span>
 sku_id String<span class="token punctuation">,</span>
 total_amount <span class="token keyword">Decimal</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 create_time <span class="token keyword">Datetime</span>
<span class="token punctuation">)</span> <span class="token keyword">engine</span> <span class="token operator">=</span>ReplicatedMergeTree<span class="token punctuation">(</span><span class="token string">'/clickhouse/table/01/t_order_test'</span><span class="token punctuation">,</span><span class="token string">'rep_103'</span><span class="token punctuation">)</span>
 <span class="token keyword">partition</span> <span class="token keyword">by</span> toYYYYMMDD<span class="token punctuation">(</span>create_time<span class="token punctuation">)</span>
 <span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
 <span class="token keyword">order</span> <span class="token keyword">by</span> <span class="token punctuation">(</span>id<span class="token punctuation">,</span>sku_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们使用副本引擎 —— ReplicatedMergeTree ，第一个参数是分片的 zk_path 一般按照： /clickhouse/table/{shard}/{table_name} 的格式写，如果只有一个分片就写 01 即可。第二个参数是副本名称，<strong>相同的分片副本名称不能相同</strong></p> 
<p>在 hadoop102 上执行 insert 语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">insert</span> <span class="token keyword">into</span> t_order_test <span class="token keyword">values</span>
<span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span><span class="token string">'sku_001'</span><span class="token punctuation">,</span><span class="token number">1000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">102</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">103</span><span class="token punctuation">,</span><span class="token string">'sku_004'</span><span class="token punctuation">,</span><span class="token number">2500.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">104</span><span class="token punctuation">,</span><span class="token string">'sku_002'</span><span class="token punctuation">,</span><span class="token number">2000.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-01 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token number">105</span><span class="token punctuation">,</span><span class="token string">'sku_003'</span><span class="token punctuation">,</span><span class="token number">600.00</span><span class="token punctuation">,</span><span class="token string">'2020-06-02 12:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以在103查到数据<br> <img src="https://images2.imgbox.com/1f/5b/E7n2tXcr_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="Java_API_652"></a>四.Java API</h5> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>ru.yandex.clickhouse<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>clickhouse-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.2.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
		<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-databind<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.fasterxml.jackson.core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
				<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>jackson-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
			<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7411c4a5478c091269e8ef346d8bea6a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flink（九）CEP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5cab22679eda61ee81832ced1fddc54c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js 实现图片压缩</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>