<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nginx获取cookie - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nginx获取cookie" />
<meta property="og:description" content="#安装nginx
wget https://centos.pkgs.org/7/nginx-x86_64/nginx-1.16.1-1.el7.ngx.x86_64.rpm.html
yum -ivh nginx-1.16.0-1.el7.ngx.x86_64.rpm
#修改配置文件
[root@hqvpt00166sa02 nginx]# vi /etc/nginx/nginx.conf
#user nginx;
worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;
events {
use epoll;
worker_connections 65535;
multi_accept on;
}
http {
include /etc/nginx/mime.types;
default_type application/octet-stream;
log_format main &#39;{&#34;@timestamp&#34;:&#34;$time_iso8601&#34;,&#39;
&#39;&#34;host&#34;:&#34;$server_addr&#34;,&#39;
&#39;&#34;clientip&#34;:&#34;$remote_addr&#34;,&#39;
&#39;&#34;size&#34;:$body_bytes_sent,&#39;
&#39;&#34;responsetime&#34;:$request_time,&#39;
&#39;&#34;upstreamtime&#34;:&#34;$upstream_response_time&#34;,&#39;
&#39;&#34;upstreamhost&#34;:&#34;$upstream_addr&#34;,&#39;
&#39;&#34;http_host&#34;:&#34;$host&#34;,&#39;
&#39;&#34;url&#34;:&#34;$uri&#34;,&#39;
&#39;&#34;xff&#34;:&#34;$http_x_forwarded_for&#34;,&#39;
&#39;&#34;referer&#34;:&#34;$http_referer&#34;,&#39;
&#39;&#34;agent&#34;:&#34;$http_user_agent&#34;,&#39;
&#39;&#34;status&#34;:&#34;$status&#34;,&#39;
&#39;&#34;request_uri&#34;:&#34;$request_uri&#34;,&#39;
&#39;&#34;cookie&#34;:&#34;$cookie_isInstall&#34;}&#39;;
sendfile on;
tcp_nopush on;
keepalive_timeout 65;
client_header_timeout 15s;
client_body_timeout 15s;
send_timeout 60s;
client_max_body_size 1024m;
client_body_buffer_size 512k;
large_client_header_buffers 4 256k;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/842c2e2c9e17ce48e93f4fe00a05a4f5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-06T10:55:41+08:00" />
<meta property="article:modified_time" content="2021-08-06T10:55:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nginx获取cookie</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>#安装nginx<br> wget https://centos.pkgs.org/7/nginx-x86_64/nginx-1.16.1-1.el7.ngx.x86_64.rpm.html<br> yum -ivh  nginx-1.16.0-1.el7.ngx.x86_64.rpm</p> 
<p>#修改配置文件<br> [root@hqvpt00166sa02 nginx]# vi  /etc/nginx/nginx.conf<br> #user  nginx;<br> worker_processes  auto;</p> 
<p>error_log  /var/log/nginx/error.log warn;<br> pid        /var/run/nginx.pid;</p> 
<p><br> events {<!-- --><br>     use epoll;<br>     worker_connections  65535;<br>     multi_accept on;<br> }</p> 
<p><br> http {<!-- --><br>     include       /etc/nginx/mime.types;<br>     default_type  application/octet-stream;</p> 
<p>    log_format main '{"@timestamp":"$time_iso8601",'<br>         '"host":"$server_addr",'<br>         '"clientip":"$remote_addr",'<br>         '"size":$body_bytes_sent,'<br>         '"responsetime":$request_time,'<br>         '"upstreamtime":"$upstream_response_time",'<br>         '"upstreamhost":"$upstream_addr",'<br>         '"http_host":"$host",'<br>         '"url":"$uri",'<br>         '"xff":"$http_x_forwarded_for",'<br>         '"referer":"$http_referer",'<br>         '"agent":"$http_user_agent",'<br>         '"status":"$status",'<br>         '"request_uri":"$request_uri",'<br>         '"cookie":"$cookie_isInstall"}';</p> 
<p><br>     sendfile        on;<br>     tcp_nopush     on;</p> 
<p><br>     keepalive_timeout  65;<br>     client_header_timeout 15s;<br>     client_body_timeout 15s;<br>     send_timeout 60s;</p> 
<p>    client_max_body_size 1024m;<br>     client_body_buffer_size 512k;<br>     large_client_header_buffers 4 256k;</p> 
<p>    proxy_cache_path /data/nginx-cache levels=1:2 keys_zone=nginx-cache:200m max_size=50g inactive=600m;<br>     open_file_cache max=65535 inactive=60s;</p> 
<p>    open_file_cache_min_uses 1;</p> 
<p>    open_file_cache_valid 80s;</p> 
<p>    proxy_connect_timeout 30s;<br>     proxy_send_timeout 30s;<br>     proxy_read_timeout 60s;<br>     proxy_buffer_size 512k;<br>     proxy_buffers 4 256k;<br>     proxy_busy_buffers_size 512k;<br>     proxy_temp_file_write_size 128m;</p> 
<p>    gzip on;<br>     gzip_min_length 1k;<br>     gzip_buffers 4 16k;<br>     gzip_http_version 1.1;<br>     gzip_comp_level 4;</p> 
<p>    gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</p> 
<p>    gzip_vary on;</p> 
<p>    include /etc/nginx/conf.d/*.conf;<br> }</p> 
<p>#添加业务站点<br> [root@hqvpt00166sa02 conf.d]# cat test.hqcookie.conf<br> upstream backendioa {<!-- --><br>    server 10.222.44.2:443;                                    #业务部署ip跟port<br> }<br> server {<!-- --><br>         listen 80;<br>         server_name  ioa.bgy.com.cn;<br>         rewrite ^(.*)$  https://$host$1 permanent;            #直接跳转到https<br> }<br> server {<!-- --><br>         listen   443 ssl;<br>         server_name  ioa.bgy.com.cn;                          #业务系统域名<br>         ssl_certificate /etc/nginx/cert/bgy.com.cn.crt;       #业务系统域名证书公钥<br>         ssl_certificate_key /etc/nginx/cert/bgy.com.cn.key;   #业务系统域名证书私钥<br>         ssl_session_cache shared:SSL:1m;<br>         ssl_session_timeout 5m;<br>         ssl_ciphers HIGH:!aNULL:!MD5;<br>         ssl_prefer_server_ciphers on;</p> 
<p>        location = /spread/report/yes {<!-- --><br>                 add_header Set-Cookie "isInstall=installed;path=/;Max-Age=28800;";    #添加cookie<br>                 return 200;<br>         }<br>         location = /spread/redirect {<!-- --><br>                 return 302 https://10.10.177.37:8443/d?redirect_uri=https%3A%2F%2Fioa.bgy.com.cn;    #重定向下载页面<br>         }<br>         location / {<!-- --><br>             root         /usr/share/nginx/html;<br>             index index.html index.htm;<br>             access_log  /var/log/nginx/access_test_hqcookie.log  main;<br>             set $flag 0;<br>             if ($cookie_isInstall = "installed") {                                    <br>               set $flag backendioa;<br>             }<br>             if ($cookie_isInstall != "installed") {<!-- --><br>               set $flag notinstall;<br>             }<br>             if ($flag = "backendioa") {                       #通过cookie判断转发业务系统<br>                 proxy_pass https://$flag;<br>                 break;<br>             }<br>             if ($flag = "notinstall") {                       #通过cookie判断跳转下载页面<br>                 #rewrite ^ /index.html break;<br>                 add_header Cache-Control no-cache;<br>                 expires 0;<br>                 rewrite ^ /spreadioa.html break;<br>             }<br>         }<br>         error_page 405 =200 $uri;<br>         error_page 404 /404.html;<br>             location = /40x.html {<!-- --><br>         }<br>         error_page 500 502 503 504 /50x.html;<br>             location = /50x.html {<!-- --><br>         }<br> }</p> 
<p>#检测配置是否正确<br> [root@hqvpt00166sa02 src]# nginx -t<br> nginx: the configuration file /etc/nginx/nginx.conf syntax is ok<br> nginx: configuration file /etc/nginx/nginx.conf test is successful</p> 
<p>#启动nginx<br> [root@hqvpt00166sa02 src]# nginx<br> [root@hqvpt00166sa02 src]# nginx -s reload</p> 
<p>一、正则表达式匹配<br> ~ 为区分大小写匹配  <br> ~* 为不区分大小写匹配 <br> !~ 和 !~* 分别为区分大小写不匹配及不区分大小写不匹配<br> 二、文件及目录匹配<br> -f 和 !-f 用来判断是否存在文件<br> -d 和 !-d 用来判断是否存在目录<br> -e 和 !-e 用来判断是否存在文件或目录<br> -x 和 !-x 用来判断文件是否可执行<br> 三．rewrite指令的最后一项参数为flag标记，flag标记有<br> last 相当于 apache 里面的L标记，表示 rewrite。<br> break 本条规则匹配完成后，终止匹配，不再匹配后面的规则。<br> redirect 返回302临时重定向，浏览器地址会显示跳转后的URL地址。<br> permanent  返回301永久重定向，浏览器地址会显示跳转后的URL地址。<br> 使用 last 和 break 实现URI重写，浏览器地址栏不变。</p> 
<p>而且两者有细微差别，使用alias指令必须用 last标记；使用proxy_pass指令时，需要使用break标记。Last标记在本条rewrite规则执行完毕后，会对其所在server{......}标签重新发起请求，而break标记则在本条规则匹配完成后，终止匹配。</p> 
<p>例如：如果我们将类似URL/photo/123456 重定向到 /path/to/photo/12/1234/123456.png</p> 
<p>rewrite "/photo/([0-9]{2})([0-9]{2})([0-9]{2})" </p> 
<p>rewrite "/path/to/photo/$1/$1$2/$1$2$3.png" ;<br> 四、NginxRewrite 规则相关指令<br> 1、break指令</p> 
<p>使用环境：server、location、if</p> 
<p>该指令的作用是完成当前的规则集，不再处理rewrite指令。</p> 
<p>2、if 指令</p> 
<p>使用环境：server、location</p> 
<p>该指令用于检查一个条件是否符合，如果条件符合，则执行大括号内的语句。If指令不支持嵌套，不支持多个条件&amp;&amp;和||处理。</p> 
<p>3、return指令</p> 
<p>语法：returncode </p> 
<p>使用环境：server、location、if</p> 
<p>该指令用于结束规则的执行并返回状态码给客户端。</p> 
<p>示例：如果访问的URL以".sh"或".bash"结尾，则返回403状态码</p> 
<p>location ~ .*\.(sh|bash)?$<br> {<!-- --><br>    return 403;<br> }<br> 4、rewrite 指令</p> 
<p>语法：rewriteregex replacement flag</p> 
<p>使用环境：server、location、if</p> 
<p>该指令根据表达式来重定向URI，或者修改字符串。指令根据配置文件中的顺序来执行。注意重写表达式只对相对路径有效。如果你想配对主机名，你应该使用if语句，示例如下：</p> 
<p>if( $host ~* www\.(.*) )<br> {<!-- --><br>    set $host_without_www $1;<br>    rewrite ^(.*)$  http://$host_without_www$1 permanent;<br> }<br> 5、Set指令</p> 
<p>语法：setvariable value ;</p> 
<p>默认值：none</p> 
<p>使用环境：server、location、if</p> 
<p>该指令用于定义一个变量，并给变量赋值。变量的值可以为文本、变量以及文本变量的联合。</p> 
<p>   set$varname "hello world";<br> 6、Uninitialized_variable_warn指令</p> 
<p>语法：uninitialized_variable_warnon|off</p> 
<p>使用环境：http、server、location、if</p> 
<p>该指令用于开启和关闭未初始化变量的警告信息，默认值为开启。</p> 
<p>五．Nginx的Rewrite规则编写实例<br> 1、当访问的文件和目录不存在时，重定向到某个html文件</p> 
<p>if( !-e $request_filename )<br> {<!-- --><br>     rewrite ^/(.*)$ index.html last;<br> }</p> 
<p><br> 2、目录对换 /123456/xxxx  ====&gt;  /xxxx?id=123456</p> 
<p>    rewrite ^/(\d+)/(.+)/  /$2?id=$1 last;</p> 
<p><br> 3、如果客户端使用的是IE浏览器，则重定向到/ie目录下</p> 
<p>if( $http_user_agent  ~ MSIE)<br> {<!-- --><br>     rewrite ^(.*)$ /ie/$1 break;<br> }</p> 
<p><br> 4、禁止访问多个目录</p> 
<p>location ~ ^/(cron|templates)/<br> {<!-- --><br>     deny all;<br>     break;<br> }</p> 
<p><br> 5、禁止访问以/data开头的文件</p> 
<p>location ~ ^/data<br> {<!-- --><br>     deny all;<br> }</p> 
<p><br> 6、禁止访问以.sh,.flv,.mp3为文件后缀名的文件</p> 
<p>location ~ .*\.(sh|flv|mp3)$<br> {<!-- --><br>     return 403;<br> }</p> 
<p><br> 7、设置某些类型文件的浏览器缓存时间</p> 
<p>location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$<br> {<!-- --><br>     expires 30d;<br> }<br> location ~ .*\.(js|css)$<br> {<!-- --><br>     expires 1h;<br> }</p> 
<p><br> 8、给favicon.ico和robots.txt设置过期时间</p> 
<p>这里为favicon.ico为99天,robots.txt为7天并不记录404错误日志</p> 
<p>location ~(favicon.ico) {<!-- --><br>    log_not_found off;<br>    expires 99d;<br>    break;<br> }<br> location ~(robots.txt) {<!-- --><br>    log_not_found off;<br>    expires 7d;<br>    break;<br> }</p> 
<p><br> 9、设定某个文件的过期时间;这里为600秒，并不记录访问日志</p> 
<p>location ^~ /html/scripts/loadhead_1.js {<!-- --><br>     access_log  off;<br>     root /opt/lampp/htdocs/web;<br>     expires 600;<br>     break;<br> }<br> 10、文件反盗链并设置过期时间</p> 
<p>这里的return412 为自定义的http状态码，默认为403，方便找出正确的盗链的请求</p> 
<p>rewrite ^/ http: //img.linuxidc.net/leech.gif;//显示一张防盗链图片<br> access_log off; //不记录访问日志，减轻压力<br> expires 3d //所有文件3天的浏览器缓存</p> 
<p>location ~*^.+\.(jpg|jpeg|gif|png|swf|rar|zip|css|js)$ {<!-- --><br>   valid_referers none blocked *.linuxidc.com*.linuxidc.net localhost 208.97.167.194;<br> if ($invalid_referer) {<!-- --><br>      rewrite ^/ http://img.linuxidc.net/leech.gif;<br>      return 412;<br>      break;<br> }<br> access_log  off;<br> root /opt/lampp/htdocs/web;<br> expires 3d;<br> break;<br> }</p> 
<p><br> 11、只允许固定ip访问网站，并加上密码</p> 
<p>root /opt/htdocs/www;<br> allow  208.97.167.194; <br> allow  222.33.1.2; <br> allow  231.152.49.4;<br> deny  all;<br> auth_basic “C1G_ADMIN”;<br> auth_basic_user_file htpasswd;</p> 
<p><br> 12、将多级目录下的文件转成一个文件，增强seo效果</p> 
<p>/job-123-456-789.html 指向/job/123/456/789.html</p> 
<p>rewrite^/job-([0-9]+)-([0-9]+)-([0-9]+)\.html$   /job/$1/$2/jobshow_$3.html last;<br> 13、文件和目录不存在的时候重定向：</p> 
<p>if (! -e $request_filename) {<!-- --><br>     proxy_pass http://127.0.0.1;<br> }</p> 
<p><br> 14、将根目录下某个文件夹指向2级目录</p> 
<p>如/shanghaijob/ 指向 /area/shanghai/<br> 如果你将last改成permanent，那么浏览器地址栏显是/location/shanghai/<br> rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2last;<br> 上面例子有个问题是访问/shanghai时将不会匹配<br> rewrite ^/([0-9a-z]+)job$ /area/$1/ last;<br> rewrite ^/([0-9a-z]+)job/(.*)$ /area/$1/$2last;<br> 这样/shanghai 也可以访问了，但页面中的相对链接无法使用，<br> 如./list_1.html真实地址是/area/shanghia/list_1.html会变成/list_1.html,导至无法访问。<br> 那我加上自动跳转也是不行咯<br> (-d $request_filename)它有个条件是必需为真实目录，而我的rewrite不是的，所以没有效果<br> if (-d $request_filename){<!-- --><br> rewrite ^/(.*)([^/])$ http://$host/$1$2/permanent;<br> }<br> 知道原因后就好办了，让我手动跳转吧<br> rewrite   ^/([0-9a-z]+)job$     /$1job/    permanent;<br> rewrite   ^/([0-9a-z]+)job/(.*)$   /area/$1/$2   last;</p> 
<p><br> 15、域名跳转</p> 
<p>server{<!-- --></p> 
<p>  listen      80;<br>   server_name  jump.linuxidc.com;<br>   index index.html index.htm index.php;<br>   root  /opt/lampp/htdocs/www;<br>   rewrite ^/ http://www.linuxidc.com/;<br>   access_log  off;<br> }<br> 16、多域名转向</p> 
<p>server_name  www.linuxidc.comwww.linuxidc.net;<br> index index.html index.htm index.php;<br> root  /opt/lampp/htdocs;<br> if ($host ~ "linuxidc\.net") {<!-- --><br>     rewrite ^(.*) http://www.linuxidc.com$1permanent;<br> }<br> 六、nginx全局变量<br> arg_PARAMETER        #这个变量包含GET请求中，如果有变量PARAMETER时的值。<br> args                 #这个变量等于请求行中(GET请求)的参数，如：foo=123&amp;bar=blahblah;<br> binary_remote_addr   #二进制的客户地址。<br> body_bytes_sent      #响应时送出的body字节数数量。即使连接中断，这个数据也是精确的。<br> content_length       #请求头中的Content-length字段。<br> content_type         #请求头中的Content-Type字段。<br> cookie_COOKIE        #cookie COOKIE变量的值<br> document_root        #当前请求在root指令中指定的值。<br> document_uri         #与uri相同。<br> host                 #请求主机头字段，否则为服务器名称。<br> hostname             #Set to themachine’s hostname as returned by gethostname<br> http_HEADER<br> is_args              #如果有args参数，这个变量等于”?”，否则等于”"，空值。<br> http_user_agent      #客户端agent信息<br> http_cookie          #客户端cookie信息<br> limit_rate           #这个变量可以限制连接速率。<br> query_string         #与args相同。<br> request_body_file    #客户端请求主体信息的临时文件名。<br> request_method       #客户端请求的动作，通常为GET或POST。<br> remote_addr          #客户端的IP地址。<br> remote_port          #客户端的端口。<br> remote_user          #已经经过Auth Basic Module验证的用户名。<br> request_completion   #如果请求结束，设置为OK. 当请求未结束或如果该请求不是请求链串的最后一个时，为空(Empty)。<br> request_method       #GET或POST<br> request_filename     #当前请求的文件路径，由root或alias指令与URI请求生成。<br> request_uri          #包含请求参数的原始URI，不包含主机名，如：”/foo/bar.php?arg=baz”。不能修改。<br> scheme               #HTTP方法（如http，https）。<br> server_protocol      #请求使用的协议，通常是HTTP/1.0或HTTP/1.1。<br> server_addr          #服务器地址，在完成一次系统调用后可以确定这个值。<br> server_name          #服务器名称。<br> server_port          #请求到达服务器的端口号。</p> 
<p>七、Apache和Nginx规则的对应关系</p> 
<p>Apache的RewriteCond对应Nginx的if<br> Apache的RewriteRule对应Nginx的rewrite<br> Apache的[R]对应Nginx的redirect<br> Apache的[P]对应Nginx的last<br> Apache的[R,L]对应Nginx的redirect<br> Apache的[P,L]对应Nginx的last<br> Apache的[PT,L]对应Nginx的last<br> 例如：允许指定的域名访问本站，其他的域名一律转向www.linuxidc.net</p> 
<p>Apache:<br> RewriteCond %{HTTP_HOST} !^(.*?)\.aaa\.com$[NC]<br> RewriteCond %{HTTP_HOST} !^localhost$ <br> RewriteCond %{HTTP_HOST}!^192\.168\.0\.(.*?)$<br> RewriteRule ^/(.*)$ http://www.linuxidc.net[R,L]</p> 
<p><br> Nginx过滤示例:</p> 
<p>if( $host ~* ^(.*)\.aaa\.com$ )<br> {<!-- --><br>    set $allowHost ‘1’;<br> }<br> if( $host ~* ^localhost )<br> {<!-- --><br>    set $allowHost ‘1’;<br> }<br> if( $host ~* ^192\.168\.1\.(.*?)$ )<br> {<!-- --><br>    set $allowHost ‘1’;<br> }<br> if( $allowHost !~ ‘1’ )<br> {<!-- --><br>    rewrite ^/(.*)$ http://www.linuxidc.netredirect ;<br> }<br>  </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/368a2032b2f61366db2e6b530db1ac71/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ajax的翻页,jquery&#43;ajax无刷新翻页</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/13bfa195e81d3c36abed139eba06f9f7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">无线打印机服务器怎样设置密码,打印机如何设置云服务器设置密码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>