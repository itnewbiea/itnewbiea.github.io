<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【高性能计算】TVM使用TE手动优化矩阵乘法算法解析与代码解读 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【高性能计算】TVM使用TE手动优化矩阵乘法算法解析与代码解读" />
<meta property="og:description" content="引言 注：本文主要介绍、解释TVM的矩阵优化思想、代码，需要配合代码注释一起阅读。
矩阵乘法是计算密集型运算。为了获得良好的 CPU 性能，有两个重要的优化措施：
提高内存访问的高速缓存命中率。复杂的数值计算和热点内存（hot-spot memory）访问都可以通过高缓存命中率（high cache hit rate）来加速。这就要求我们将原内存（origin ）访问模式转化为符合高速缓存策略的模式。
SIMD（单指令多数据），也被称为矢量处理单元。在每个周期中，SIMD 可以处理一小批数据，而不是处理一个单一的值。这就要求我们将循环体中的数据访问模式转化为统一模式，以便编译器后端可以将其降低到 SIMD。
1- 基于TVM和Numpy的基线实现 这是numpy 实现矩阵乘法的实现代码，作为实现比较的基础benchmark，他的速度并不会很慢，这是因为其本身就采用了加速矩阵数学计算的算法实现。
import tvm import tvm.testing from tvm import te import numpy # The size of the matrix # (M, K) x (K, N) # You are free to try out different shapes, sometimes TVM optimization outperforms numpy with MKL. M = 1024 K = 1024 N = 1024 # The default tensor data type in tvm dtype = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5a6d269957548326e83225f5de9fda9c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-27T20:40:31+08:00" />
<meta property="article:modified_time" content="2023-02-27T20:40:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【高性能计算】TVM使用TE手动优化矩阵乘法算法解析与代码解读</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>引言</h3> 
<p><strong>注：本文主要介绍、解释TVM的矩阵优化思想、代码，需要配合代码注释一起阅读。</strong></p> 
<p>矩阵乘法是计算密集型运算。为了获得良好的 CPU 性能，有两个重要的优化措施：</p> 
<ul><li> <p>提高内存访问的高速缓存命中率。复杂的数值计算和热点内存（hot-spot memory）访问都可以通过高缓存命中率（high cache hit rate）来加速。这就要求我们将原内存（origin ）访问模式转化为符合高速缓存策略的模式。</p> </li><li> <p>SIMD（单指令多数据），也被称为矢量处理单元。在每个周期中，SIMD 可以处理一小批数据，而不是处理一个单一的值。这就要求我们将循环体中的数据访问模式转化为统一模式，以便编译器后端可以将其降低到 SIMD。</p> </li></ul> 
<h3><a id="1_TVMNumpy_9"></a>1- 基于TVM和Numpy的基线实现</h3> 
<p>这是numpy 实现矩阵乘法的实现代码，作为实现比较的基础benchmark，他的速度并不会很慢，这是因为其本身就采用了加速矩阵数学计算的算法实现。</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> tvm
<span class="token keyword">import</span> tvm<span class="token punctuation">.</span>testing
<span class="token keyword">from</span> tvm <span class="token keyword">import</span> te
<span class="token keyword">import</span> numpy

<span class="token comment"># The size of the matrix</span>
<span class="token comment"># (M, K) x (K, N)</span>
<span class="token comment"># You are free to try out different shapes, sometimes TVM optimization outperforms numpy with MKL.</span>
M <span class="token operator">=</span> <span class="token number">1024</span>
K <span class="token operator">=</span> <span class="token number">1024</span>
N <span class="token operator">=</span> <span class="token number">1024</span>

<span class="token comment"># The default tensor data type in tvm</span>
dtype <span class="token operator">=</span> <span class="token string">"float32"</span>

<span class="token comment"># You will want to adjust the target to match any CPU vector extensions you</span>
<span class="token comment"># might have. For example, if you're using using Intel AVX2 (Advanced Vector</span>
<span class="token comment"># Extensions) ISA for SIMD, you can get the best performance by changing the</span>
<span class="token comment"># following line to ``llvm -mcpu=core-avx2``, or specific type of CPU you use.</span>
<span class="token comment"># Recall that you're using llvm, you can get this information from the command</span>
<span class="token comment"># ``llc --version`` to get the CPU type, and you can check ``/proc/cpuinfo``</span>
<span class="token comment"># for additional extensions that your processor might support.</span>

target <span class="token operator">=</span> tvm<span class="token punctuation">.</span>target<span class="token punctuation">.</span>Target<span class="token punctuation">(</span>target<span class="token operator">=</span><span class="token string">"llvm"</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"llvm"</span><span class="token punctuation">)</span>
dev <span class="token operator">=</span> tvm<span class="token punctuation">.</span>device<span class="token punctuation">(</span>target<span class="token punctuation">.</span>kind<span class="token punctuation">.</span>name<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment"># Random generated tensor for testing</span>
a <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
b <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>random<span class="token punctuation">.</span>rand<span class="token punctuation">(</span>K<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>

<span class="token comment"># Repeatedly perform a matrix multiplication to get a performance baseline</span>
<span class="token comment"># for the default numpy implementation</span>
np_repeat <span class="token operator">=</span> <span class="token number">100</span>
np_running_time <span class="token operator">=</span> timeit<span class="token punctuation">.</span>timeit<span class="token punctuation">(</span>  <span class="token operator">//</span> 统计numpy<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>计算耗时
    setup<span class="token operator">=</span><span class="token string">"import numpy\n"</span>
    <span class="token string">"M = "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    <span class="token string">"K = "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>K<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    <span class="token string">"N = "</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\n"</span>
    <span class="token string">'dtype = "float32"\n'</span>
    <span class="token string">"a = numpy.random.rand(M, K).astype(dtype)\n"</span>
    <span class="token string">"b = numpy.random.rand(K, N).astype(dtype)\n"</span><span class="token punctuation">,</span>
    stmt<span class="token operator">=</span><span class="token string">"answer = numpy.dot(a, b)"</span><span class="token punctuation">,</span>
    number<span class="token operator">=</span>np_repeat<span class="token punctuation">,</span>
<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Numpy running time: %f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>np_running_time <span class="token operator">/</span> np_repeat<span class="token punctuation">)</span><span class="token punctuation">)</span>

answer <span class="token operator">=</span> numpy<span class="token punctuation">.</span>dot<span class="token punctuation">(</span>a<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>现在用 TVM TE 编写基本的矩阵乘法，并验证它产生的结果与 numpy 的实现相同。我们还写了一个函数，它将帮助衡量调度优化的性能。</p> 
<pre><code class="prism language-python"><span class="token comment"># TVM Matrix Multiplication using TE</span>
k <span class="token operator">=</span> te<span class="token punctuation">.</span>reduce_axis<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"k"</span><span class="token punctuation">)</span>  <span class="token operator">//</span> 可以理解为约分轴，M<span class="token operator">*</span>K <span class="token operator">*</span> K<span class="token operator">*</span>N <span class="token operator">=</span> M<span class="token operator">*</span>N，K轴维度消失啦
A <span class="token operator">=</span> te<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> K<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"A"</span><span class="token punctuation">)</span>  <span class="token operator">//</span> 一种tensor，通常用于计算图的Input节点使用，没有前序节点
B <span class="token operator">=</span> te<span class="token punctuation">.</span>placeholder<span class="token punctuation">(</span><span class="token punctuation">(</span>K<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"B"</span><span class="token punctuation">)</span>
C <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> te<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> B<span class="token punctuation">[</span>k<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"C"</span><span class="token punctuation">)</span>  <span class="token operator">//</span> 定义输出结果。第一个参数<span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span>表示输出矩阵的shape，<span class="token keyword">lambda</span> i<span class="token punctuation">:</span>则可以理解为 <span class="token keyword">for</span> i<span class="token punctuation">:</span> <span class="token number">0</span><span class="token operator">-</span><span class="token operator">&gt;</span>n<span class="token operator">-</span><span class="token number">1</span>

<span class="token comment"># Default schedule</span>
s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>  <span class="token operator">//</span> 从一个或多个 Tensor 的 Operation 进行创建
func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">)</span>

c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e-5</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">evaluate_operation</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token builtin">vars</span><span class="token punctuation">,</span> target<span class="token punctuation">,</span> name<span class="token punctuation">,</span> optimization<span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">:</span>
    func <span class="token operator">=</span> tvm<span class="token punctuation">.</span>build<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">)</span>
    <span class="token keyword">assert</span> func

    c <span class="token operator">=</span> tvm<span class="token punctuation">.</span>nd<span class="token punctuation">.</span>array<span class="token punctuation">(</span>numpy<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>dtype<span class="token punctuation">)</span><span class="token punctuation">,</span> dev<span class="token punctuation">)</span>
    func<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
    tvm<span class="token punctuation">.</span>testing<span class="token punctuation">.</span>assert_allclose<span class="token punctuation">(</span>c<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">,</span> rtol<span class="token operator">=</span><span class="token number">1e-5</span><span class="token punctuation">)</span>

    evaluator <span class="token operator">=</span> func<span class="token punctuation">.</span>time_evaluator<span class="token punctuation">(</span>func<span class="token punctuation">.</span>entry_name<span class="token punctuation">,</span> dev<span class="token punctuation">,</span> number<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">)</span>
    mean_time <span class="token operator">=</span> evaluator<span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span><span class="token punctuation">.</span>mean
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"%s: %f"</span> <span class="token operator">%</span> <span class="token punctuation">(</span>optimization<span class="token punctuation">,</span> mean_time<span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">(</span>optimization<span class="token punctuation">,</span> mean_time<span class="token punctuation">)</span><span class="token punctuation">)</span>


log <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

evaluate_operation<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"none"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log<span class="token punctuation">)</span>
</code></pre> 
<p>让我们来看看上述使用 TVM 低级函数的运算器和默认调度的中间表示。请注意这个实现基本上是矩阵乘法的原始实现，在 A 和 B 矩阵的索引上使用三个嵌套循环。</p> 
<p>先来看看原始的矩阵乘法实现，他基本没有考虑cache连续的问题：</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">int</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> M<span class="token punctuation">;</span> x<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">int</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> y <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> y<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token builtin">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> K<span class="token punctuation">;</span> k<span class="token operator">+</span><span class="token operator">+</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			C<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span> <span class="token operator">+=</span> A<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">*</span> B<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>TVM的计算其实是将二维矩阵平铺为了一维数组进行计算，由于边界定义为了1024，这里的offset也是1024</p> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> 主要看这里，对应关系为 x<span class="token operator">-</span><span class="token operator">&gt;</span>M y<span class="token operator">-</span><span class="token operator">&gt;</span>N k<span class="token operator">-</span><span class="token operator">&gt;</span>K
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0f32
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span>
        let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> y<span class="token punctuation">)</span>
        C<span class="token punctuation">[</span>cse_var_1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span>cse_var_1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> k<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2TVMtilecache_132"></a>2-使用TVM调度原语tile分块优化cache阻塞</h3> 
<p>提高缓冲区命中率的一个重要技巧是阻塞，在这个过程中，你的内存访问结构是在一个块的内部有一个小的邻域，具有很高的内存定位性。在本教程中，我们选择一个 32 的块因子。这将导致一个块充满 32 * 32 * sizeof(float) 的内存区域。这相当于一个 4KB 的缓存大小，而 L1 缓存的参考缓存大小为 32KB。</p> 
<p>对矩阵计算进行分块，以加速。分块可以进一步的提升B、C矩阵的空间局部性， 我们把C分成多个title，然后针对每一个title，A和B中对应的行tile和列tile也会切成相应大小的tile进行多个小矩阵乘法，最后加和到C的tile中，当我们把tile的大小限定到合适的范围内时，就可以把整个tile填充到cache内，分块的好处就体现在一个block内的计算小到可以被cache容纳，以充分利用cache快速的读写速度。</p> 
<p>我们首先为 C 矩阵计算操作创建一个默认的调度，然后用指定的块因子对其应用一个 tile 调度原语，调度原语返回所产生的循环顺序，从最外层到最内层，作为一个向量 [x_outer, y_outer, x_inner, y_inner]。然后我们得到操作输出的还原轴，并使用 4 的因子对其进行分割操作。这个因子并不直接影响我们现在正在进行的阻塞优化，但在以后我们应用矢量化时将会很有用。</p> 
<p>现在操作已经被阻塞了，我们可以重新调度计算的顺序，把较少操作放到计算的最外层循环中，帮助保证被阻止的数据仍然在缓存中。这样就完成了调度，我们可以建立并测试与原生的调度相比的性能。</p> 
<pre><code class="prism language-python">bn <span class="token operator">=</span> <span class="token number">32</span>

<span class="token comment"># Blocking by loop tiling</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>  <span class="token operator">//</span> 分割

<span class="token comment"># Hoist reduction domain outside the blocking loop</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>

evaluate_operation<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"blocking"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log<span class="token punctuation">)</span>
</code></pre> 
<p>通过重新安排计算顺序以利用缓存，你应该看到计算的性能有了明显的改善。现在，打印内部表示，并将其与原始表示进行比较。</p> 
<pre><code class="prism language-python"><span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> 外部<span class="token number">32</span>个分块
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> 内部<span class="token number">32</span><span class="token operator">*</span><span class="token number">32</span>个浮点数
        <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0f32  <span class="token operator">//</span> <span class="token number">32768</span>为<span class="token number">32</span><span class="token operator">*</span><span class="token number">32</span><span class="token operator">*</span><span class="token number">32</span>，初始化该块内的数为<span class="token number">0</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> k轴分为<span class="token number">4</span>份，<span class="token number">1024</span><span class="token operator">/</span><span class="token number">4</span><span class="token operator">=</span><span class="token number">256</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> 这里的<span class="token number">4</span>主要用于后面的SIMD的使用
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              let cse_var_3<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span>
              let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> cse_var_3<span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span>
              C<span class="token punctuation">[</span>cse_var_1<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span>cse_var_1<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token operator">*</span>B<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_3<span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
               <span class="token operator">//</span> 其实这里B依然是cache不友好读取，即跳行读取，但可能是考虑到在一个定义的分块cache内
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3SIMD_193"></a>3-利用SIMD矢量化计算</h3> 
<p>另一个重要的优化技巧是矢量化。当内存访问模式是统一的，编译器可以检测到这种模式并将连续的内存传递给 SIMD 矢量处理器。在 TVM 中，我们可以使用 vectorize 接口来提示编译器这种模式，利用这一硬件特性。</p> 
<ul><li>SIMD 的全称是 Single Instruction Multiple Data，中文名“单指令多数据”。顾名思义，一条指令处理多个数据。</li></ul> 
<p>在本教程中，我们选择对内循环的行数据进行矢量化，因为在我们之前的优化中，它已经是缓存友好的。</p> 
<pre><code class="prism language-python"><span class="token comment"># Apply the vectorization optimization</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>  <span class="token operator">//</span> 对子块内的每一行进行SIMD计算

evaluate_operation<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"vectorization"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log<span class="token punctuation">)</span>

<span class="token comment"># The generalized IR after vectorization</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">vectorization<span class="token punctuation">:</span> <span class="token number">0.257297</span>
<span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span>0f32<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> 对于y<span class="token punctuation">.</span>inner的每一行，使用<span class="token number">128</span>位SIMD计算，<span class="token number">32</span><span class="token operator">*</span><span class="token number">4</span>，一次计算<span class="token number">4</span>位
            let cse_var_3<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span>
            let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> cse_var_3<span class="token punctuation">)</span>
            C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>B<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_238"></a>4-使用循环优化</h3> 
<p>如果我们看一下上面的 IR，我们可以看到内循环的行数据被矢量化，B 被转化为 分块B（这从内循环的 (float32x32*)B2 部分可以看出）。现在 B的分块 的遍历是顺序的。所以我们要看一下 A 的访问模式。在当前的计划中，A 是被逐列访问的，每次访问A的128位，这对缓冲区不友好。如果我们改变 ki 和内轴 xi 的嵌套循环顺序，A 矩阵的访问模式将对缓存更友好。<br> <img src="https://images2.imgbox.com/d4/cf/Y7upzRQI_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>
xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

<span class="token comment"># re-ordering</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>  <span class="token operator">//</span> 改变循环顺序
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>

evaluate_operation<span class="token punctuation">(</span>
    s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"loop permutation"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log
<span class="token punctuation">)</span>

<span class="token comment"># Again, print the new generalized IR</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">loop permutation<span class="token punctuation">:</span> <span class="token number">0.130006</span>
<span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span>0f32<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>  <span class="token operator">//</span> 调换了这里的顺序
            let cse_var_3<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span>
            let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> cse_var_3<span class="token punctuation">)</span>
            C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>B<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_3<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="5_288"></a>5-使用数组打包</h3> 
<p>另一个重要的技巧是数组打包。这个技巧是对数组的存储维度进行重新排序，将某些维度上的连续访问模式转换为扁平化后的顺序模式。</p> 
<p><img src="https://images2.imgbox.com/fd/2e/OyhbUTUm_o.png" alt="在这里插入图片描述"></p> 
<p>正如上图所示，在阻塞计算后，我们可以观察到 B 的数组访问模式（扁平化后），它是有规律的，但是不连续的。我们期望经过一些转换后，我们可以得到一个连续的访问模式。通过将 [16][16] 数组重新排序为 [16/4][16][4] 数组，当从打包的数组中抓取相应的值时，B 的访问模式将是连续的。</p> 
<p>为了实现这一目标，将不得不从新的默认调度开始，考虑到 B 的新包装，值得花点时间来评论一下。TE 是编写优化运算符的强大而富有表现力的语言，但它往往需要对你所编写的底层算法、数据结构和硬件目标有一些了解。在本教程的后面，我们将讨论一些让 TVM 承担这一负担的选项。无论如何，让我们继续编写新的优化调度。</p> 
<p>这里的本质相当于改变了B的按列读取，改为按行读取，即cache友好。</p> 
<pre><code class="prism language-python"><span class="token operator">//</span> 必须重写算法。对计算方式进行重新定义。
packedB <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span><span class="token punctuation">(</span>N <span class="token operator">/</span> bn<span class="token punctuation">,</span> K<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z<span class="token punctuation">:</span> B<span class="token punctuation">[</span>y<span class="token punctuation">,</span> x <span class="token operator">*</span> bn <span class="token operator">+</span> z<span class="token punctuation">]</span><span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"packedB"</span><span class="token punctuation">)</span>
C <span class="token operator">=</span> te<span class="token punctuation">.</span>compute<span class="token punctuation">(</span>
    <span class="token punctuation">(</span>M<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">lambda</span> x<span class="token punctuation">,</span> y<span class="token punctuation">:</span> te<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>x<span class="token punctuation">,</span> k<span class="token punctuation">]</span> <span class="token operator">*</span> packedB<span class="token punctuation">[</span>y <span class="token operator">//</span> bn<span class="token punctuation">,</span> k<span class="token punctuation">,</span> tvm<span class="token punctuation">.</span>tir<span class="token punctuation">.</span>indexmod<span class="token punctuation">(</span>y<span class="token punctuation">,</span> bn<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token operator">//</span> TIR 的全称是 Tensor IR<span class="token punctuation">,</span> tvm<span class="token punctuation">.</span>tir<span class="token punctuation">.</span>indexmod 为计算y<span class="token operator">/</span>bn的余数
    name<span class="token operator">=</span><span class="token string">"C"</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span>

s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>
<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> ko<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yi<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yi<span class="token punctuation">)</span>

x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>z<span class="token punctuation">)</span>  <span class="token operator">//</span> 执行向量操作的指令。vectorize 是并发思路在CPU里的最细粒度实现。
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

evaluate_operation<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"array packing"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log<span class="token punctuation">)</span>

<span class="token comment"># Here is the generated IR after array packing.</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">array packing<span class="token punctuation">:</span> <span class="token number">0.140257</span>
<span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  allocate<span class="token punctuation">(</span>packedB<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32x32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token string">"parallel"</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        packedB_1<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>packedB<span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span>0f32<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              let cse_var_3<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
              let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>cse_var_3 <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_1<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>cse_var_3 <span class="token operator">+</span> cse_var_2<span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_2<span class="token punctuation">)</span> <span class="token operator">+</span> k<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="6_363"></a>6-通过缓存优化块的写入</h3> 
<p>到目前为止，我们所有的优化都集中在有效地访问和计算 A 和 B 矩阵的数据以计算 C 矩阵上。在阻塞优化之后，运算器将逐块地将结果写入 C，而且访问模式不是顺序的。我们可以通过使用一个顺序缓存数组来解决这个问题，使用 cache_write、compute_at 和 unroll 的组合来保存块结果，并在所有块结果准备好后写入 C。</p> 
<p>cache_write和cache_read对应，是先在shared memory中存放计算结果，最后将结果写回到global memory。当然在真实的场景中，我们往往是会将结果先放着register中，最后写回。</p> 
<pre><code class="prism language-python">s <span class="token operator">=</span> te<span class="token punctuation">.</span>create_schedule<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">)</span>

<span class="token comment"># Allocate write cache</span>
CC <span class="token operator">=</span> s<span class="token punctuation">.</span>cache_write<span class="token punctuation">(</span>C<span class="token punctuation">,</span> <span class="token string">"global"</span><span class="token punctuation">)</span>

xo<span class="token punctuation">,</span> yo<span class="token punctuation">,</span> xi<span class="token punctuation">,</span> yi <span class="token operator">=</span> s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>tile<span class="token punctuation">(</span>C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> C<span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> bn<span class="token punctuation">,</span> bn<span class="token punctuation">)</span>

<span class="token comment"># Write cache is computed at yo</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>compute_at<span class="token punctuation">(</span>s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">,</span> yo<span class="token punctuation">)</span>  <span class="token operator">//</span> 默认情况下，TVM将在函数的最外层或根计算张量。compute_at指定应在另一个运算符的第一个计算轴上计算一个张量。应该是为了方便后续的在xo维度上进行并行计算。

<span class="token comment"># New inner axes</span>
xc<span class="token punctuation">,</span> yc <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis

<span class="token punctuation">(</span>k<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>reduce_axis
ko<span class="token punctuation">,</span> ki <span class="token operator">=</span> s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>split<span class="token punctuation">(</span>k<span class="token punctuation">,</span> factor<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>reorder<span class="token punctuation">(</span>ko<span class="token punctuation">,</span> xc<span class="token punctuation">,</span> ki<span class="token punctuation">,</span> yc<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>unroll<span class="token punctuation">(</span>ki<span class="token punctuation">)</span>  <span class="token operator">//</span> 循环展开
s<span class="token punctuation">[</span>CC<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>yc<span class="token punctuation">)</span>

x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

evaluate_operation<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"block caching"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log<span class="token punctuation">)</span>

<span class="token comment"># Here is the generated IR after write cache blocking.</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  allocate<span class="token punctuation">(</span>packedB<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32x32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span><span class="token punctuation">;</span>
  allocate<span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token keyword">global</span><span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token string">"parallel"</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        packedB_1<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>packedB<span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">.</span>global_1<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token keyword">global</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span>0f32<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            let cse_var_4<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
            let cse_var_3<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span>
            let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_4<span class="token punctuation">)</span>
            let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_4<span class="token punctuation">)</span>
             <span class="token punctuation">{<!-- --></span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span>cse_var_1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span>cse_var_2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_1 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="7_442"></a>7-并行化</h3> 
<p>到目前为止，我们的计算只被设计为使用单核。几乎所有的现代处理器都有多个内核，计算可以从并行运行的计算中获益。最后的优化是利用线程级并行化的优势。</p> 
<pre><code class="prism language-python"><span class="token comment"># parallel</span>
s<span class="token punctuation">[</span>C<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>xo<span class="token punctuation">)</span>

x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> z <span class="token operator">=</span> s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>op<span class="token punctuation">.</span>axis
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>vectorize<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
s<span class="token punctuation">[</span>packedB<span class="token punctuation">]</span><span class="token punctuation">.</span>parallel<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

evaluate_operation<span class="token punctuation">(</span>
    s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> target<span class="token operator">=</span>target<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">"mmult"</span><span class="token punctuation">,</span> optimization<span class="token operator">=</span><span class="token string">"parallelization"</span><span class="token punctuation">,</span> log<span class="token operator">=</span>log
<span class="token punctuation">)</span>

<span class="token comment"># Here is the generated IR after parallelization.</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>tvm<span class="token punctuation">.</span>lower<span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token punctuation">[</span>A<span class="token punctuation">,</span> B<span class="token punctuation">,</span> C<span class="token punctuation">]</span><span class="token punctuation">,</span> simple_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">parallelization<span class="token punctuation">:</span> <span class="token number">0.026403</span>
<span class="token decorator annotation punctuation">@main</span> <span class="token operator">=</span> primfn<span class="token punctuation">(</span>A_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> handle<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> handle<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">)</span>
  attr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"from_legacy_te_schedule"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"global_symbol"</span><span class="token punctuation">:</span> <span class="token string">"main"</span><span class="token punctuation">,</span> <span class="token string">"tir.noalias"</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
  buffers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             B<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
             C<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span>float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1048576</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
  buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A<span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B<span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C<span class="token punctuation">}</span>
  preflattened_buffer_map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>A_1<span class="token punctuation">:</span> A_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>A_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> B_1<span class="token punctuation">:</span> B_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>B_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> C_1<span class="token punctuation">:</span> C_3<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C_2<span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span> <span class="token punctuation">{<!-- --></span>
  allocate<span class="token punctuation">(</span>packedB<span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32x32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token string">"parallel"</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        packedB_1<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>packedB<span class="token punctuation">,</span> float32x32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">32768</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token string">"parallel"</span> <span class="token punctuation">{<!-- --></span>
      allocate<span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token keyword">global</span><span class="token punctuation">:</span> Pointer<span class="token punctuation">(</span><span class="token keyword">global</span> float32<span class="token punctuation">)</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> storage_scope <span class="token operator">=</span> <span class="token keyword">global</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          C<span class="token punctuation">.</span>global_1<span class="token punctuation">:</span> Buffer<span class="token punctuation">(</span>C<span class="token punctuation">.</span><span class="token keyword">global</span><span class="token punctuation">,</span> float32<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>ramp<span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">.</span>init<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> broadcast<span class="token punctuation">(</span>0f32<span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            let cse_var_4<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>k<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">4</span><span class="token punctuation">)</span>
            let cse_var_3<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span>
            let cse_var_2<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_4<span class="token punctuation">)</span>
            let cse_var_1<span class="token punctuation">:</span> int32 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>c<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> cse_var_4<span class="token punctuation">)</span>
             <span class="token punctuation">{<!-- --></span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span>cse_var_1<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span>cse_var_2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_1 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span>ramp<span class="token punctuation">(</span>cse_var_3<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span>broadcast<span class="token punctuation">(</span>A<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_1 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token operator">*</span>packedB_1<span class="token punctuation">[</span><span class="token punctuation">(</span>cse_var_2 <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>inner<span class="token punctuation">:</span> int32<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            C<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32768</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>y<span class="token punctuation">.</span>outer<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> C<span class="token punctuation">.</span>global_1<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>inner<span class="token operator">*</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token operator">+</span> y<span class="token punctuation">.</span>inner<span class="token punctuation">)</span><span class="token punctuation">]</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="_506"></a>总结</h3> 
<p>如前所述，如何使用 TE 和调度原语进行优化，可能需要对底层架构和算法有一些了解。然而，TE 的设计是作为更复杂的算法的基础，可以搜索潜在的优化。</p> 
<p>本教程提供了一个 TVM 张量表达（TE）工作流程的演练，使用了一个矢量添加和一个矩阵乘法的例子。一般的工作流程是：</p> 
<ul><li>通过一系列的操作来描述你的计算。</li><li>描述我们要如何计算使用调度原语。</li><li>编译到我们想要的目标函数。</li><li>可以选择保存该函数以便以后加载。</li></ul> 
<h4><a id="_516"></a>参考资料</h4> 
<ul><li>TVM官方教程：https://daobook.github.io/tvm/docs/tutorial/tensor_expr_get_started.html</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/05f20dc75f65574f829476d495af82ea/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">今天终于知道了，阿里巴巴 P8、P9 及以上到底是什么水平？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c3c7da2aeffffb956ae8fa63903f186f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java中的线程礼让</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>