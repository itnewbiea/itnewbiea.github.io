<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Doris-1.2.0升级到Doris-1.2.4 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Doris-1.2.0升级到Doris-1.2.4" />
<meta property="og:description" content="0 背景 在使用doris-1.2.0版本时发现BE节点无故宕机，自己尝试解决无果后再官网寻找解决方案，发现在doris-1.2.0版本中存在这样的隐患bug导致BE节点宕机。
而在咨询社区之后建议对doris进行升级，升级版本doris-1.2.4。该版本是解决1.2.x问题的修复版本
1 准备升级 1.1 下载1.2.4安装包 https://dist.apache.org/repos/dist/dev/doris/1.2.4-rc01/
注意：① 除下载BE和FE的安装包外，还需要下载1.2.4版本udf对应的依赖jar包
② 需要将下载好的udf的jar包(java-udf-jar-with-dependencies.jar)拷贝到be节点的lib目录下
1.2 备份FE节点元数据 fe元数据默认在fe/doris-meta目录下，压缩文件
tar -zcvf doris-meta.tar.gz dors-meta 1.3 备份BE节点数据 be元数据默认在be/storage目录下，压缩文件
tar -zcvf storage.tar.gz storage 1.4 准备工作 关闭集群副本修复和均衡功能，升级过程中会有节点重启，所以可能会触发不必要的集群均衡和副本修复逻辑。可以先通过以下命令关闭：
# 关闭副本均衡逻辑。关闭后，不会再触发普通表副本的均衡操作。 $ mysql-client &gt; admin set frontend config(&#34;disable_balance&#34; = &#34;true&#34;); # 关闭 colocation 表的副本均衡逻辑。关闭后，不会再触发 colocation 表的副本重分布操作。 $ mysql-client &gt; admin set frontend config(&#34;disable_colocate_balance&#34; = &#34;true&#34;); # 关闭副本调度逻辑。关闭后，所有已产生的副本修复和均衡任务不会再被调度。 $ mysql-client &gt; admin set frontend config(&#34;disable_tablet_scheduler&#34; = &#34;true&#34;); 注意：升级完成后需要用同样的方法还原设置的值
2 测试BE升级正确性 ① 任意选择一个 BE 节点，部署最新的 doris_be 二进制文件" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f6c9b2812e940a972b36ea3c552ba8b3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-21T09:03:10+08:00" />
<meta property="article:modified_time" content="2023-04-21T09:03:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Doris-1.2.0升级到Doris-1.2.4</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="0__0"></a>0 背景</h2> 
<p>在使用doris-1.2.0版本时发现BE节点无故宕机，自己尝试解决无果后再官网寻找解决方案，发现在doris-1.2.0版本中存在这样的隐患bug导致BE节点宕机。<br> <img src="https://images2.imgbox.com/37/a4/BWBkP6Yv_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/b5/HWyF8M2Q_o.png" alt="在这里插入图片描述"><br> 而在咨询社区之后建议对doris进行升级，升级版本doris-1.2.4。该版本是解决1.2.x问题的修复版本<br> <img src="https://images2.imgbox.com/58/cf/AsTqGKaP_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="1__6"></a>1 准备升级</h2> 
<h3><a id="11_124_7"></a>1.1 下载1.2.4安装包</h3> 
<p>https://dist.apache.org/repos/dist/dev/doris/1.2.4-rc01/<br> 注意：① 除下载BE和FE的安装包外，还需要下载1.2.4版本udf对应的依赖jar包<br> ② 需要将下载好的udf的jar包(java-udf-jar-with-dependencies.jar)拷贝到be节点的lib目录下<br> <img src="https://images2.imgbox.com/3b/99/2sXqnQgz_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12_FE_12"></a>1.2 备份FE节点元数据</h3> 
<p>fe元数据默认在fe/doris-meta目录下，压缩文件</p> 
<pre><code class="prism language-bash"><span class="token function">tar</span> -zcvf doris-meta.tar.gz dors-meta
</code></pre> 
<h3><a id="13_BE_17"></a>1.3 备份BE节点数据</h3> 
<p>be元数据默认在be/storage目录下，压缩文件</p> 
<pre><code class="prism language-bash"><span class="token function">tar</span> -zcvf storage.tar.gz storage
</code></pre> 
<h3><a id="14__23"></a>1.4 准备工作</h3> 
<p>关闭集群副本修复和均衡功能，升级过程中会有节点重启，所以可能会触发不必要的集群均衡和副本修复逻辑。可以先通过以下命令关闭：</p> 
<pre><code class="prism language-bash"><span class="token comment"># 关闭副本均衡逻辑。关闭后，不会再触发普通表副本的均衡操作。</span>
$ mysql-client <span class="token operator">&gt;</span> admin <span class="token builtin class-name">set</span> frontend config<span class="token punctuation">(</span><span class="token string">"disable_balance"</span> <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 关闭 colocation 表的副本均衡逻辑。关闭后，不会再触发 colocation 表的副本重分布操作。</span>
$ mysql-client <span class="token operator">&gt;</span> admin <span class="token builtin class-name">set</span> frontend config<span class="token punctuation">(</span><span class="token string">"disable_colocate_balance"</span> <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 关闭副本调度逻辑。关闭后，所有已产生的副本修复和均衡任务不会再被调度。</span>
$ mysql-client <span class="token operator">&gt;</span> admin <span class="token builtin class-name">set</span> frontend config<span class="token punctuation">(</span><span class="token string">"disable_tablet_scheduler"</span> <span class="token operator">=</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注意：升级完成后需要用同样的方法还原设置的值<br> <img src="https://images2.imgbox.com/3a/79/dCZ4fuT9_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2_BE_38"></a>2 测试BE升级正确性</h2> 
<p>① 任意选择一个 BE 节点，部署最新的 doris_be 二进制文件<br> ② 重启 BE 节点，通过 BE 日志 be.INFO，查看是否启动成功</p> 
<pre><code class="prism language-bash"><span class="token comment">#先使用1.2.0版本的BE关闭该节点</span>
/root/soft/doris/apache-doris-be-1.2.0-bin-x86_64-noavx2/bin/stop_be.sh
<span class="token comment">#注：1.2.4版本替换BE的lib目录以及bin目录，和除conf目录、数据目录BE的storage、log 目录外的其他目录。</span>
<span class="token comment">#再使用1.2.4版本的BE启动该节点</span>
/root/soft/doris-1.2.4/apache/apache-doris-be-1.2.4-bin-x86_64-noavx2/bin/start_be.sh
</code></pre> 
<p>重新启动后发现BE成功加入集群<br> <img src="https://images2.imgbox.com/32/fe/1Vr4p8Ik_o.png" alt="在这里插入图片描述"></p> 
<p>③ 如果启动失败，可以先排查原因。如果错误不可恢复，可以直接通过 DROP BACKEND 删除该 BE、清理数据后，使用上一个版本的 doris_be 重新启动 BE。然后重新 ADD BACKEND。（该方法会导致丢失一个数据副本，请务必确保3副本完整的情况下，执行这个操作！！！）</p> 
<h2><a id="3_FE_54"></a>3 测试FE元数据兼容性</h2> 
<p>注意：重要！!元数据兼容性异常很可能导致数据无法恢复！！<br> ① 单独使用新版本部署一个测试用的 FE 进程（建议在自己本地的开发机，或者BE节点。如果在Follower或者Observer节点上，需要停止启动的进程,但是不建议在Follower或者Observer节点上测试）。<br> ② 修改测试用的 FE 的配置文件 fe.conf，将所有端口设置为与线上不同且priority_networks该为当前节点绑定的ip<br> ③ 在 fe.conf 添加配置：cluster_id=123456<br> ④ 在 fe.conf 添加配置：metadata_failure_recovery=true<br> ⑤ 拷贝之前环境 Master FE 的元数据目录 doris-meta 到测试环境<br> <img src="https://images2.imgbox.com/bd/34/x493vVkP_o.png" alt="在这里插入图片描述"><br> ⑥ 将拷贝到测试环境中的 doris-meta/image/VERSION 文件中的 cluster_id 修改为 123456（即与第3步中相同）<br> <img src="https://images2.imgbox.com/2e/75/wBUgyljQ_o.png" alt="在这里插入图片描述"><br> ⑦ 在测试环境中，运行 sh bin/start_fe.sh 启动 FE<br> ⑧ 通过 FE 日志 fe.log 观察是否启动成功<br> ⑨ 如果启动成功，运行 sh bin/stop_fe.sh 停止测试环境的 FE 进程<br> <img src="https://images2.imgbox.com/03/1a/0zQVkLEv_o.png" alt="在这里插入图片描述"><br> 使用Nvicate测试连接，发现新起的FE节点可以连接，且paloFe进程存在<br> <img src="https://images2.imgbox.com/38/af/sLa1xExT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b7/06/B0tQwYgq_o.png" alt="在这里插入图片描述"><br> 关闭FE进程</p> 
<h2><a id="4__72"></a>4 升级</h2> 
<p>经过以上测试说明元数据在升级后的Doris-1.2.4版本中可用。<br> ① 在完成数据正确性验证后，将 BE 和 FE 新版本的二进制文件分发到各自目录下<br> ② 停止当前节点所有FE/BE进程<br> ③ 版本升级需要替换 FE 和 BE 的 lib 目录以及 bin 目录，和除 conf 目录、数据目录（FE 的 doris-meta，BE 的 storage）、log 目录外的其他目录<br> ④ 重新启动FE/BE</p> 
<p>升级前doris版本<br> <img src="https://images2.imgbox.com/28/e0/kFPS37lT_o.png" alt="在这里插入图片描述"><br> 升级前数据库<br> <img src="https://images2.imgbox.com/46/b8/Bz0QiWod_o.png" alt="在这里插入图片描述"><br> 升级后doris版本<br> <img src="https://images2.imgbox.com/f2/fe/ni3zHSLx_o.png" alt="在这里插入图片描述"><br> 升级后的数据<br> <img src="https://images2.imgbox.com/03/21/ssWgVzVC_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5__87"></a>5 还原之前配置</h2> 
<p>新启动的Doris集群还原为之前的默认配置</p> 
<pre><code class="prism language-bash"><span class="token comment"># 开启副本均衡逻辑。</span>
$ mysql-client <span class="token operator">&gt;</span> admin <span class="token builtin class-name">set</span> frontend config<span class="token punctuation">(</span><span class="token string">"disable_balance"</span> <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 开启 colocation 表的副本均衡逻辑。</span>
$ mysql-client <span class="token operator">&gt;</span> admin <span class="token builtin class-name">set</span> frontend config<span class="token punctuation">(</span><span class="token string">"disable_colocate_balance"</span> <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># 开启副本调度逻辑。</span>
$ mysql-client <span class="token operator">&gt;</span> admin <span class="token builtin class-name">set</span> frontend config<span class="token punctuation">(</span><span class="token string">"disable_tablet_scheduler"</span> <span class="token operator">=</span> <span class="token string">"false"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a3/e4/OIPRiOPz_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5f06c9c94b961be07469f51507c991c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">代理与反射</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cfde3856c9c62877c7e0c4e29037fc1f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">OpenGL 简介</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>