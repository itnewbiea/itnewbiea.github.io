<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>海康工业相机连续存图、录像功能介绍 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="海康工业相机连续存图、录像功能介绍" />
<meta property="og:description" content="海康工业相机连续存图功能介绍 1.MVS连续存图功能基本使用方法2.抓图测试与实际问题分析总结 3. SDK代码开发关键接口介绍 在使用工业相机做日常的数据采集，分析过程中，存图、录像功能必不可少，但是在使用该功能中，会出现丢帧、少图等现象，本文简单介绍下存图、录像使用过程中的技术瓶颈与解决方法，本文以介绍连续抓图为主，录像功能原理基本一致； 1.MVS连续存图功能基本使用方法 i. MVS通用设置中，设置图像路径、存图格式
图1：MVS中设置存储路径
图2：MVS中设置图片格式 ii. MVS开启连续抓图功能后，开始取流存图
图3：MVS中设置图片格式 图4：MVS中设置图片格式 2.抓图测试与实际问题分析 a) 相机参数
MV-CA050-20UM相机，图像分辨率为2048*2048，黑白mono8图像，存图格式为bmp
采集帧率90fps，使用触发模式，单次触发，采集1023张图片
b) 测试结果：
图4：MVS抓图结果
图5：本地存图结果 预计采集1023张图片，实际抓图398张图片，丢帧帧数625帧，采集图像数1023张
c) 原因分析
在抓图过程中，缓存使用率会上升，那么，先增加缓存大小，在通用设置里面，设置缓存大小
图6：存图缓存节点设置 存图缓存节点设置到100后，再次测试
图7： MVS抓图结果 预计采集1023张图片，实际抓图475张图片，丢帧帧数546帧，采集图像数1021张
继续增大缓存节点，对比不同缓存节点，对抓图数量的影响，如下表
取流缓存节点 录像缓存节点 采集图像数 存图图像数 丢帧图像数
取流缓存节点录像缓存节点采集图像数存图图像数丢帧图像数2210233986252100102147554625121008889119280010221022030800102310230 从结果来看，将缓存节点设置的足够大，能够满足一定时刻的抓图需求
但是也存在两个问题：
1.当缓存节点继续加大时，计算机内存占用很大（3.28G上升到6.5G）MVS会提示报错，由此可见，缓存不可无限加大
图8：存图缓存节点设置报错 2.图像在缓存里面，采集、存储耗时长，采集1024张图片，只需要11s左右，而完成存储需要30s以上
d) 验证不同硬盘写入速度对图片保存的影响
取流缓存节点录像缓存节点采集图像数存图图像数丢帧图像数22102339862521001021475546 当设置录像缓存节点为100时，存图数量比节点1时，增加了76张
那么当缓存节点小时，因素是什么?
我们使用CrystalDiskMark8，来测试硬盘读写速度，结果如下：
图9：机械硬盘读写速度 硬盘写入速度为93.53M，而一张图像2048*2048，黑白mono8的bmp图像大小为4MB
93.53M的写入速度，支持101.71/4=23.38，23.38张图片同时写入，而相机采集帧率为90fps，
当写入速度，低于采集速度时，就会产生大量的丢帧
那么换用ssd固态硬盘，来提高硬盘写入速度
图10：固态硬盘读写速度 数据来看，这块SSD有点拉跨 那么重复测试结果如下：
取流缓存节点录像缓存节点采集图像数存图图像数丢帧图像数2210235684552100101652249425121014794220305121023910113 从结果来看，
提高硬盘读写速度，能够保存到更多的图片，但是还是会存在丢帧，需要配合缓存节点使用，才能保证不丢帧
SSD写速度达到了123.10M，理论上能够存储30.75张图片，但是相较于相机90fps的帧率，还是远远不够的
注意：这里有个误区，正常的SSD速度，一般在300、500MB/s,而本文中使用的ssd仅有123MB/s,原因在于工具中的参数，测试文件大小为16MB，而硬盘的读写速度与文件大小息息相关，而工业相机的图像大小通常在几百k~20M不等，因此，硬盘读写速度，一般都是低于理论值的；
图11：CrystalDiskMark工具参数介绍 如果要继续提升硬盘读写速度，那么就要考虑更高速的硬盘方案
PCIe 5.0 SSD 读取速度可达 10GB / sRAID方案（RAID磁盘阵列（Redundant Array of Independent Disks）通过同时使用多个磁盘，提高了传输速率。RAID通过在多个磁盘上同时存储和读取数据来大幅提高存储系统的数据吞吐量，理论上读写速度是单片硬盘的N倍） e) 验证不同图片格式对图片保存的影响" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/13fc892867ff338d61d6f30347a4c364/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-29T19:10:03+08:00" />
<meta property="article:modified_time" content="2022-08-29T19:10:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">海康工业相机连续存图、录像功能介绍</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>海康工业相机连续存图功能介绍</h4> 
 <ul><li><ul><li><a href="#1MVS_4" rel="nofollow">1.MVS连续存图功能基本使用方法</a></li><li><a href="#2_18" rel="nofollow">2.抓图测试与实际问题分析</a></li><li><ul><li><a href="#_125" rel="nofollow">总结</a></li></ul> 
   </li><li><a href="#3_SDK_132" rel="nofollow">3. SDK代码开发关键接口介绍</a></li></ul> 
 </li></ul> 
</div> 
<br> 在使用工业相机做日常的数据采集，分析过程中，存图、录像功能必不可少，但是在使用该功能中，会出现丢帧、少图等现象，本文简单介绍下存图、录像使用过程中的技术瓶颈与解决方法，本文以介绍连续抓图为主，录像功能原理基本一致； 
<p></p> 
<h3><a id="1MVS_4"></a>1.MVS连续存图功能基本使用方法</h3> 
<p>i. MVS通用设置中，设置图像路径、存图格式<br> <img src="https://images2.imgbox.com/25/7d/7fR56eQJ_o.png" alt="在这里插入图片描述"><br> 图1：MVS中设置存储路径<br> <img src="https://images2.imgbox.com/1d/60/lSncDRJa_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图2：MVS中设置图片格式
</code></pre> 
<p>ii. MVS开启连续抓图功能后，开始取流存图<br> <img src="https://images2.imgbox.com/b2/4d/oVG8biXw_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图3：MVS中设置图片格式
</code></pre> 
<p><img src="https://images2.imgbox.com/e4/42/aPqAjNu7_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图4：MVS中设置图片格式
</code></pre> 
<h3><a id="2_18"></a>2.抓图测试与实际问题分析</h3> 
<p>a) 相机参数<br> MV-CA050-20UM相机，图像分辨率为2048*2048，黑白mono8图像，存图格式为bmp<br> 采集帧率90fps，使用触发模式，单次触发，采集1023张图片<br> b) 测试结果：<br> <img src="https://images2.imgbox.com/da/76/yl5HZu0d_o.png" alt="在这里插入图片描述"><br> 图4：MVS抓图结果<br> <img src="https://images2.imgbox.com/06/60/xUwIMibk_o.png" alt="在这里插入图片描述"></p> 
<pre><code>	图5：本地存图结果
</code></pre> 
<p>预计采集1023张图片，实际抓图398张图片，丢帧帧数625帧，采集图像数1023张<br> c) 原因分析<br> 在抓图过程中，缓存使用率会上升，那么，先增加缓存大小，在通用设置里面，设置缓存大小<br> <img src="https://images2.imgbox.com/22/e3/e60Q62MN_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图6：存图缓存节点设置
</code></pre> 
<p>存图缓存节点设置到100后，再次测试<br> <img src="https://images2.imgbox.com/b9/06/VsiOEJKH_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图7： MVS抓图结果
</code></pre> 
<p>预计采集1023张图片，实际抓图475张图片，丢帧帧数546帧，采集图像数1021张<br> 继续增大缓存节点，对比不同缓存节点，对抓图数量的影响，如下表<br> 取流缓存节点 录像缓存节点 采集图像数 存图图像数 丢帧图像数</p> 
<table><thead><tr><th>取流缓存节点</th><th>录像缓存节点</th><th>采集图像数</th><th>存图图像数</th><th>丢帧图像数</th></tr></thead><tbody><tr><td>2</td><td>2</td><td>1023</td><td>398</td><td>625</td></tr><tr><td>2</td><td>100</td><td>1021</td><td>475</td><td>546</td></tr><tr><td>2</td><td>512</td><td>1008</td><td>889</td><td>119</td></tr><tr><td>2</td><td>800</td><td>1022</td><td>1022</td><td>0</td></tr><tr><td>30</td><td>800</td><td>1023</td><td>1023</td><td>0</td></tr></tbody></table> 
<p>从结果来看，将缓存节点设置的足够大，能够满足一定时刻的抓图需求<br> 但是也存在两个问题：<br> 1.当缓存节点继续加大时，计算机内存占用很大（3.28G上升到6.5G）MVS会提示报错，由此可见，缓存不可无限加大<br> <img src="https://images2.imgbox.com/03/fd/stBLl8yS_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图8：存图缓存节点设置报错
</code></pre> 
<p>2.图像在缓存里面，采集、存储耗时长，采集1024张图片，只需要11s左右，而完成存储需要30s以上</p> 
<p>d) 验证不同硬盘写入速度对图片保存的影响</p> 
<table><thead><tr><th>取流缓存节点</th><th>录像缓存节点</th><th>采集图像数</th><th>存图图像数</th><th>丢帧图像数</th></tr></thead><tbody><tr><td>2</td><td>2</td><td>1023</td><td>398</td><td>625</td></tr><tr><td>2</td><td>100</td><td>1021</td><td>475</td><td>546</td></tr></tbody></table> 
<p>当设置录像缓存节点为100时，存图数量比节点1时，增加了76张<br> 那么当缓存节点小时，因素是什么?<br> 我们使用CrystalDiskMark8，来测试硬盘读写速度，结果如下：<br> <img src="https://images2.imgbox.com/64/07/HnDZ3zml_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图9：机械硬盘读写速度
</code></pre> 
<p>硬盘写入速度为93.53M，而一张图像2048*2048，黑白mono8的bmp图像大小为4MB<br> 93.53M的写入速度，支持101.71/4=23.38，23.38张图片同时写入，而相机采集帧率为90fps，<br> 当写入速度，低于采集速度时，就会产生大量的丢帧</p> 
<p>那么换用ssd固态硬盘，来提高硬盘写入速度<br> <img src="https://images2.imgbox.com/b9/09/roaIgZLk_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图10：固态硬盘读写速度
数据来看，这块SSD有点拉跨
</code></pre> 
<p>那么重复测试结果如下：</p> 
<table><thead><tr><th>取流缓存节点</th><th>录像缓存节点</th><th>采集图像数</th><th>存图图像数</th><th>丢帧图像数</th></tr></thead><tbody><tr><td>2</td><td>2</td><td>1023</td><td>568</td><td>455</td></tr><tr><td>2</td><td>100</td><td>1016</td><td>522</td><td>494</td></tr><tr><td>2</td><td>512</td><td>1014</td><td>794</td><td>220</td></tr><tr><td>30</td><td>512</td><td>1023</td><td>910</td><td>113</td></tr></tbody></table> 
<p>从结果来看，<br> 提高硬盘读写速度，能够保存到更多的图片，但是还是会存在丢帧，需要配合缓存节点使用，才能保证不丢帧<br> SSD写速度达到了123.10M，理论上能够存储30.75张图片，但是相较于相机90fps的帧率，还是远远不够的<br> 注意：这里有个误区，正常的SSD速度，一般在300、500MB/s,而本文中使用的ssd仅有123MB/s,原因在于工具中的参数，测试文件大小为16MB，而硬盘的读写速度与文件大小息息相关，而工业相机的图像大小通常在几百k~20M不等，因此，硬盘读写速度，一般都是低于理论值的；<br> <img src="https://images2.imgbox.com/a3/6b/xgRVjUzU_o.png" alt="在这里插入图片描述"></p> 
<pre><code>图11：CrystalDiskMark工具参数介绍
</code></pre> 
<p>如果要继续提升硬盘读写速度，那么就要考虑更高速的硬盘方案</p> 
<ul><li>PCIe 5.0 SSD 读取速度可达 10GB / s</li><li>RAID方案（RAID磁盘阵列（Redundant Array of Independent Disks）通过同时使用多个磁盘，提高了传输速率。RAID通过在多个磁盘上同时存储和读取数据来大幅提高存储系统的数据吞吐量，理论上读写速度是单片硬盘的N倍）</li></ul> 
<p>e) 验证不同图片格式对图片保存的影响<br> 在MVS通用设置中，可以设置不同的图像保存格式<br> <img src="https://images2.imgbox.com/e1/66/JUhQzulC_o.png" alt="在这里插入图片描述"></p> 
<pre><code> 图12：MVS不同存图格式设置 
</code></pre> 
<p>选择不同的图像格式，测试结果如下</p> 
<table><thead><tr><th>硬盘类型</th><th>保存格式</th><th>取流缓存节</th><th>录像缓存节点</th><th>采集图像数</th><th>存图图像数</th><th>丢帧图像数</th></tr></thead><tbody><tr><td>SSD</td><td>Bmp</td><td>2</td><td>2</td><td>1023</td><td>568</td><td>455</td></tr><tr><td>SSD</td><td>JPEG</td><td>2</td><td>2</td><td>1023</td><td>600</td><td>423</td></tr><tr><td>SSD</td><td>Bmp</td><td>30</td><td>200</td><td>1023</td><td>629</td><td>394</td></tr><tr><td>SSD</td><td>JPEG</td><td>30</td><td>200</td><td>1023</td><td>776</td><td>247</td></tr><tr><td>SSD</td><td>BMP</td><td>2</td><td>512</td><td>1014</td><td>794</td><td>220</td></tr><tr><td>SSD</td><td>JPEG</td><td>2</td><td>512</td><td>1023</td><td>1023</td><td>0</td></tr><tr><td>SSD</td><td>PNG</td><td>2</td><td>512</td><td>1022</td><td>575</td><td>447</td></tr><tr><td>SSD</td><td>TIFF</td><td>2</td><td>512</td><td>1014</td><td>920</td><td>94</td></tr><tr><td>SSD</td><td>RAW</td><td>2</td><td>512</td><td>1013</td><td>917</td><td>96</td></tr></tbody></table> 
<p>不同的图像存储格式，对图片保存数量也是有影响的，如图所示，jpeg搭配高缓存节点可以完全保存下来，但是这里的结论并不充分，原因受篇幅限制，不详细展开</p> 
<h4><a id="_125"></a>总结</h4> 
<ul><li>取流速度：相机帧率90fps，那么每一帧的处理时间，只有小于1000/90=11ms，才能不丢帧的情况下，保存完所有图像</li><li>Jpeg、PNG，都是压缩图像数据的方法，把几MB大小的图片，压缩成几百kb的小文件，此时，硬盘读写速度不再是瓶颈，而压缩时间变成了新的瓶颈，缩短压缩数据的时间，只能提高cpu的性能，使用更快更强的CPU</li><li>只有当(图像处理（压缩时间）+硬盘写入时间)&lt;取流速度时，才能不丢帧</li><li>当(图像处理（压缩时间）+硬盘写入时间)&gt;取流速度时,就需要缓存节点，将待处理的图片，保存至内存中，待CPU空闲后，慢慢写入硬盘</li><li>当(图像处理（压缩时间）+硬盘写入时间)&gt;取流速度时，且图像数据源源不断，缓存溢出后，丢帧现象将不可避免</li></ul> 
<h3><a id="3_SDK_132"></a>3. SDK代码开发关键接口介绍</h3> 
<p>相机参数设置：</p> 
<table><thead><tr><th>参数名称</th><th>节点名称</th><th>值</th><th>备注</th></tr></thead><tbody><tr><td>图像宽</td><td>Width</td><td>2048</td><td></td></tr><tr><td>图像高</td><td>Height</td><td>2048</td><td></td></tr><tr><td>图像格式</td><td>PixelFormat</td><td>Mono8</td><td></td></tr><tr><td>触发出图数</td><td>AcquisitionBurstFrameCount</td><td>1023</td><td>收到一个软触发信号，参考当前相机帧率，最大帧率采集</td></tr><tr><td>帧率设置</td><td>AcquisitionFrameRate</td><td>90</td><td></td></tr><tr><td>帧率设置使能</td><td>AcquisitionFrameRateEnable</td><td>True</td><td></td></tr><tr><td>触发模式</td><td>TriggerMode</td><td>On</td><td></td></tr><tr><td>触发源</td><td>TriggerSource</td><td>Software</td><td></td></tr></tbody></table> 
<p>从上到下，伪代码如下：</p> 
<pre><code class="prism language-c">nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetIntValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"Width"</span><span class="token punctuation">,</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetIntValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"Height"</span><span class="token punctuation">,</span><span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetEnumValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"PixelFormat"</span><span class="token punctuation">,</span> PixelType_Gvsp_Mono8<span class="token punctuation">)</span><span class="token punctuation">;</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetIntValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"AcquisitionBurstFrameCount"</span><span class="token punctuation">,</span><span class="token number">1023</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//相机仅支持0-1023</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetFloatValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"AcquisitionFrameRate"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetBoolValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"AcquisitionFrameRateEnable"</span><span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetEnumValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span> <span class="token string">"TriggerMode"</span><span class="token punctuation">,</span> MV_TRIGGER_MODE_ON<span class="token punctuation">)</span><span class="token punctuation">;</span>
nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetEnumValue</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token string">"TriggerSource"</span><span class="token punctuation">,</span>MV_TRIGGER_SOURCE_SOFTWARE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>图像缓存节点设置</p> 
<pre><code class="prism language-c">nRet <span class="token operator">=</span> <span class="token function">MV_CC_SetImageNodeNum</span><span class="token punctuation">(</span>handle<span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注：SDK是没有录像缓存节点的，仅有取流缓存节点，两者效果一致）<br> 存图接口：<br> <img src="https://images2.imgbox.com/c3/17/tCMQeA6i_o.png" alt="在这里插入图片描述"><br> 参考例程下载：<br> https://one.hikvision.com/#/link/qj3vswclAd3RjjdIuUoW 提取密码：xw9o</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/53d5cb62268309156a8a5d9735df56ff/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">.NET/C# 生成二维码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/917267672af61e8f73d1c7b31f33cc44/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">cks--最小化IAM角色</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>