<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>kubeadm部署ingress-controller - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="kubeadm部署ingress-controller" />
<meta property="og:description" content="九：kubeadm集群裸机部署：nginx-ingress-controller:0.30.0
以daemonset &#43; hostnetwork &#43; nodeselector为例
集群环境：
1.查看开启是ipvs
[root@master01 ~]# kubectl get pods -n kube-system |grep kube-proxy
kube-proxy-5pl4d 1/1 Running 0 3h17m
kube-proxy-lmfmm 1/1 Running 0 179m
kube-proxy-tfq9c 1/1 Running 0 175m
#如果开启ipvs，会有输出，需要查看三个kube-proxy的pod。
[root@master01 ~]# kubectl logs -f kube-proxy-5pl4d -n kube-system |grep ipvs
I1215 04:08:14.351482 1 server_others.go:259] Using ipvs Proxier.
2.如果没有开启，可以修改配置文件，指定kube-proxy调度为ipvs
[root@master01 ~]# kubectl get cm -n kube-system|grep kube-proxy
kube-proxy 2 3h21m
[root@master01 ~]# kubectl edit cm kube-proxy -n kube-system" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/30cf0317a4f623446c2aa72a0bf3ec52/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-27T21:45:50+08:00" />
<meta property="article:modified_time" content="2022-03-27T21:45:50+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">kubeadm部署ingress-controller</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>九：kubeadm集群裸机部署：nginx-ingress-controller:0.30.0<br> 以daemonset + hostnetwork + nodeselector为例<br> 集群环境：<br> 1.查看开启是ipvs<br> [root@master01 ~]# kubectl get pods -n kube-system |grep kube-proxy<br> kube-proxy-5pl4d                   1/1     Running   0          3h17m<br> kube-proxy-lmfmm                   1/1     Running   0          179m<br> kube-proxy-tfq9c                   1/1     Running   0          175m</p> 
<p>#如果开启ipvs，会有输出，<span style="color:#fe2c24;">需要查看三个kube-proxy的pod。</span><br> [root@master01 ~]# kubectl logs -f kube-proxy-5pl4d -n kube-system |grep ipvs<br> I1215 04:08:14.351482       1 server_others.go:259] Using ipvs Proxier.</p> 
<p>2.如果没有开启，可以修改配置文件，<span style="color:#fe2c24;">指定kube-proxy调度为ipvs</span><br> [root@master01 ~]# kubectl get cm -n kube-system|grep kube-proxy<br> kube-proxy                           2      3h21m</p> 
<p>[root@master01 ~]# kubectl edit cm  kube-proxy -n kube-system<br> 。。。。。。。。。。。。。<br>     ipvs:<br>       excludeCIDRs: null<br>       minSyncPeriod: 0s<br>       scheduler: ""      <span style="color:#fe2c24;">#这里默认调度算法是rr，</span><br>       strictARP: false<br>       syncPeriod: 0s<br>       tcpFinTimeout: 0s<br>       tcpTimeout: 0s<br>       udpTimeout: 0s<br>     kind: KubeProxyConfiguration<br>     metricsBindAddress: ""<br>     mode: ipvs           <span style="color:#fe2c24;">#指定kube-proxy调度规则为ipvs</span><br>     nodePortAddresses: null<br>     oomScoreAdj: null<br>     portRange: ""<br>     showHiddenMetricsForVersion: ""<br>     udpIdleTimeout: 0s<br>     winkernel:<br>     <br> #保存后，需要删除kube-proxy的pod，<span style="color:#fe2c24;">重新拉去kube-proxy的配置文件</span>，才可以生效<br> [root@master01 ~]# kubectl get pod -n kube-system | grep kube-proxy | awk '{system("kubectl delete pod "$1" -n kube-system")}'</p> 
<p>#查看新的kube-proxy的pod。<span style="color:#fe2c24;">是否生效开启ipvs</span><br> [root@master01 ~]# kubectl logs -f kube-proxy-5pldd -n kube-system |grep ipvs<br> I1215 04:08:14.351482       1 server_others.go:259] <span style="color:#fe2c24;">Using ipvs Proxier</span>.</p> 
<p>[root@master01 ~]# ipvsadm -Ln<br> IP Virtual Server version 1.2.1 (size=4096)<br> Prot LocalAddress:Port Scheduler Flags<br>   -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br> TCP  10.96.0.1:443 rr<br>   -&gt; 192.128.232.11:6443               Masq    1      3          0         <br>   -&gt; 192.128.232.12:6443               Masq    1      0          0         <br> TCP  10.96.0.10:53 rr<br>   -&gt; 10.244.0.2:53                Masq    1      0          0         <br>   -&gt; 10.244.0.3:53                Masq    1      0          0        <br> TCP  10.96.0.10:9153 rr<br>   -&gt; 10.244.0.2:9153              Masq    1      0          0         <br>   -&gt; 10.244.0.3:9153              Masq    1      0          0         <br> UDP  10.96.0.10:53 rr<br>   -&gt; 10.244.0.2:53                Masq    1      0          0         <br>   -&gt; 10.244.0.3:53                Masq    1      0          0        <br>   <br> 3.部署ingress-nginx<br> #<span style="color:#fe2c24;"> 以daemonset + hostnetwork + nodeselector为例</span><br> 下载地址：https://github.com/kubernetes/ingress-nginx/<br> [root@master01 ~]# mkdir ingress/<br> [root@master01 ingress]# unzip nginx-0.30.0.zip<br> [root@master01 ingress]# cd ingress-nginx-nginx-0.30.0/deploy/static/<br> [root@master01 static]# ll<br> total 28<br> -rw-rw-r-- 1 root root  580 Feb 24  2020 configmap.yaml<br> -rw-r--r-- 1 root root  240 Dec 15 13:39 kube-backend.yaml<br> -rw-rw-r-- 1 root root 6649 Dec 15 11:10 mandatory.yaml<br> -rw-rw-r-- 1 root root  166 Feb 24  2020 namespace.yaml<br> drwxrwxr-x 4 root root   60 Feb 24  2020 provider<br> -rw-rw-r-- 1 root root 2922 Feb 24  2020 rbac.yaml<br> -rw-rw-r-- 1 root root 2643 Feb 24  2020 with-rbac.yaml</p> 
<p>#修改mandatory.yaml的rbac的apiversion<br> [root@master01 static]# sed -i "s#rbac.authorization.k8s.io/v1beta1#rbac.authorization.k8s.io/v1#g" mandatory.yaml</p> 
<p>#修改images地址<br> [root@master01 static]# cat mandatory.yaml | grep image<br> image: harbor.od.com/kubeadm/nginx-ingress-controller:0.30.0</p> 
<p>#修改mandatory.yaml文件(215行左右)使用宿主机网络:<span style="color:#fe2c24;">hostNetwork: true</span>、</p> 
<p>#文件中的kind 类型由Deployent改为<span style="color:#fe2c24;">DaemonSet</span>，然后去掉<span style="color:#fe2c24;">replicas</span><br> [root@master01 static]# vi mandatory.yaml <br> ......................................................<br> ---<br> apiVersion: apps/v1<br> kind: DaemonSet    <span style="color:#fe2c24;">#把Deployent改为DaemonSet</span><br> metadata:<br>   name: nginx-ingress-controller<br>   namespace: ingress-nginx<br>   labels:<br>     app.kubernetes.io/name: ingress-nginx<br>     app.kubernetes.io/part-of: ingress-nginx<br> spec:<br>  # replicas: 1  <span style="color:#fe2c24;"> #注释掉</span><br>   selector:<br>     matchLabels:<br>       app.kubernetes.io/name: ingress-nginx<br>       app.kubernetes.io/part-of: ingress-nginx<br>   template:<br>     metadata:<br>       labels:<br>         app.kubernetes.io/name: ingress-nginx<br>         app.kubernetes.io/part-of: ingress-nginx<br>       annotations:<br>         prometheus.io/port: "10254"<br>         prometheus.io/scrape: "true"<br>     spec:<br>       hostNetwork: true <span style="color:#fe2c24;"> #主机网络</span><br>       # wait up to five minutes for the drain of connections<br>       terminationGracePeriodSeconds: 300<br>       serviceAccountName: nginx-ingress-serviceaccount<br>       nodeSelector:        <span style="color:#fe2c24;">#部署ingress-nginx选择节点的选择器</span><br>         node: ingress-controller   <span style="color:#fe2c24;">#标签选择</span></p> 
<p><span style="color:#0d0016;">      tolerations:     </span><span style="color:#fe2c24;">#容忍master的taint污点，表示master也可以部署ingress</span><br><span style="color:#0d0016;">      - key: node-role.kubernetes.io/master<br>         effect: NoSchedule</span><br>       containers:<br>         - name: nginx-ingress-controller<br>           image: harbor.od.com/kubeadm/nginx-ingress-controller:0.30.0<br>           args:<br>             - /nginx-ingress-controller<br>             - --configmap=$(POD_NAMESPACE)/nginx-configuration<br>             - --tcp-services-configmap=$(POD_NAMESPACE)/tcp-services</p> 
<p>#<span style="color:#fe2c24;">给节点打标签，好指定ingress-controller的pod部署指定节点上，指定两台，建议是master节点打上标签，</span></p> 
<p>[root@master01 ~]# kubectl label node master01 node=ingress-controller</p> 
<p>[root@master01 ~]# kubectl label node master02 node=ingress-controller</p> 
<p>[root@master01 ~]# kubectl label node master03 node=ingress-controller</p> 
<p>[root@master01 ~]# kubectl get nodes --show-labels |grep node=ingress-controller</p> 
<p><br> [root@master01 static]# kubectl apply -f mandatory.yaml <br> namespace/ingress-nginx created<br> configmap/nginx-configuration created<br> configmap/tcp-services created<br> configmap/udp-services created<br> serviceaccount/nginx-ingress-serviceaccount created<br> clusterrole.rbac.authorization.k8s.io/nginx-ingress-clusterrole created<br> role.rbac.authorization.k8s.io/nginx-ingress-role created<br> rolebinding.rbac.authorization.k8s.io/nginx-ingress-role-nisa-binding created<br> clusterrolebinding.rbac.authorization.k8s.io/nginx-ingress-clusterrole-nisa-binding created<br> daemonset.apps/nginx-ingress-controller created<br> limitrange/ingress-nginx created</p> 
<p>#查看nginx-ingress-controller的pod<br> [root@master01 static]# kubectl get pod -n ingress-nginx<br> NAME                             READY   STATUS    RESTARTS   AGE<br> nginx-ingress-controller-nqgpb   1/1     Running   0          3h38m</p> 
<p><span style="color:#fe2c24;">#查看ingress-controller的pod描述</span></p> 
<p>[root@master01 static]# kubectl describe pod nginx-ingress-controller-nqgpb -n ingress-nginx<br><br> #ingress-controller部署在master01，master02，master03节点上，使用hostnetwork网络。三台主机上都 <span style="color:#0d0016;">监听 </span><span style="color:#fe2c24;">80,8181,443 </span><span style="color:#0d0016;"><strong>端口。</strong></span><br> [root@node01 ~]# netstat -lntup|grep nginx<br> tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      8426/nginx: master  <br> tcp        0      0 0.0.0.0:8181            0.0.0.0:*               LISTEN      8426/nginx: master  <br> tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      8426/nginx: master  <br> tcp        0      0 127.0.0.1:10245         0.0.0.0:*               LISTEN      8350/nginx-ingress- <br> tcp        0      0 127.0.0.1:10246         0.0.0.0:*               LISTEN      8426/nginx: master  <br> tcp        0      0 127.0.0.1:10247         0.0.0.0:*               LISTEN      8426/nginx: master  <br> tcp6       0      0 :::10254                :::*                    LISTEN      8350/nginx-ingress- <br> tcp6       0      0 :::80                   :::*                    LISTEN      8426/nginx: master  <br> tcp6       0      0 :::8181                 :::*                    LISTEN      8426/nginx: master  <br> tcp6       0      0 :::443                  :::*                    LISTEN      8426/nginx: master  </p> 
<p>5.发布服务测试<br> [root@master01 ~]# cat nginx-service-deployment.yaml <br> apiVersion: apps/v1<br> kind: Deployment<br> metadata:<br>   name: nginx-deployment<br>   labels:<br>     app: nginx<br> spec:<br>   replicas: 2<br>   selector:<br>     matchLabels:<br>       app: nginx<br>   template:<br>     metadata:<br>       labels:<br>         app: nginx<br>     spec:<br>       containers:<br>       - name: nginx<br>         image: harbor.od.com/kubeadm/myapp:v1<br>         imagePullPolicy: IfNotPresent<br>         ports:<br>         - containerPort: 80<br> ---<br> apiVersion: v1<br> kind: Service<br> metadata:<br>   name: nginx-service  <span style="color:#fe2c24;"> #被后面ingress调度</span><br> spec:<br>   type: ClusterIP<br>   selector:<br>     app: nginx<br>   ports:<br>   - protocol: TCP<br>     port: 80<br>     targetPort: 80</p> 
<p>    <br> [root@master01 ~]# kubectl apply -f nginx-service-deployment.yaml </p> 
<p>[root@master01 ~]# kubectl get pod -n default<br> NAME                                READY   STATUS    RESTARTS   AGE<br> nginx-deployment-77db97fb47-2p8f7   1/1     Running   0          3h54m<br> nginx-deployment-77db97fb47-ql98t   1/1     Running   0          3h54m</p> 
<p>[root@master01 ~]# kubectl get svc -n default<br> NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE<br> kubernetes      ClusterIP   10.96.0.1      &lt;none&gt;        443/TCP   4h33m<br> nginx-service   ClusterIP   10.97.95.213   &lt;none&gt;        80/TCP    3h55m</p> 
<p>#访问，<span style="color:#fe2c24;">kube-proxy是ipvs指定的rr（轮询访问）</span><br> [root@master01 ~]# curl 10.97.95.213<br> Hello MyApp | Version: v1 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</p> 
<p>[root@master01 ~]# curl 10.97.95.213/hostname.html<br> nginx-deployment-77db97fb47-2p8f7</p> 
<p>[root@master01 ~]# curl 10.97.95.213/hostname.html<br> nginx-deployment-77db97fb47-ql98t</p> 
<p>#配置nginx-service的ingress<br> [root@master01 ~]# cat nginx-ingress.yaml <br> apiVersion: extensions/v1beta1<br> kind: Ingress<br> metadata:<br>   name: test-service-ingress<br>   namespace: default<br>   annotations:<br>     kubernets.io/ingress.class: "nginx"    <span style="color:#fe2c24;">#ingress的注解，一定要标识</span><br> spec:<br>   rules:<br>   - host: demo.od.com   <span style="color:#fe2c24;">#配置service服务的域名</span><br>     http:<br>       paths:<br>       - path:  /<br>         backend:<br>           serviceName: nginx-service    <span style="color:#fe2c24;">#指定后端service的名字</span><br>           servicePort: 80               <span style="color:#fe2c24;">#指定后端service的端口</span></p> 
<p>[root@master01 ~]# kubectl apply -f nginx-ingress.yaml </p> 
<p>[root@master01 ~]# kubectl get ingress<br> NAME                   CLASS    HOSTS         ADDRESS        PORTS   AGE<br> test-service-ingress   &lt;none&gt;   demo.od.com   10.108.95.79   80      4h37m</p> 
<p></p> 
<p>#查看ingress时，发现报错了，<span style="color:#fe2c24;">(&lt;error: endpoints “default-http-backend” not found&gt;)，</span><br> 因为缺少了一个后端服务叫 “”<span style="color:#fe2c24;">default-http-backend</span>“”，所以后面创建这个service</p> 
<p>[root@master01 ~]# kubectl describe ingress test-service-ingress<br> Name:             test-service-ingress<br> Namespace:        default<br> Address:          10.108.95.79<br> Default backend: default-http-backend:80 (&lt;error: endpoints “default-http-backend” not found&gt;)<br> Rules:<br>   Host         Path  Backends<br>   ----         ----  --------<br>   demo.od.com  <br>                   nginx-service:80 (10.244.2.2:80,10.244.2.3:80)<br> Annotations:   kubernets.io/ingress.class: nginx<br> Events:        &lt;none&gt;</p> 
<p><br> 5.<span style="color:#fe2c24;">先查看default-back-end服务是否存在，在kube-system名称空间，跟kube-dns同一个名称空间里</span><br> [root@master01 ~]# kubectl get svc -n kube-system<br> NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE<br> kube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4h43m</p> 
<p>6.使用下面的 yaml 文件创建 default-back-end 服务：<br> [root@master01 static]# cat kube-backend.yaml <br> apiVersion: v1<br> kind: Service<br> metadata:<br>   name: default-http-backend   <span style="color:#fe2c24;">#不能随便改，ingress服务缺少这个名字"</span>default-http-backend<span style="color:#fe2c24;">"的服务。</span><br>   namespace: kube-system      <br> spec:<br>   selector:<br>     #app: ingress-nginx-controller<br>     app: ingress-controller  <span style="color:#fe2c24;"> #名字随便定义</span><br>   ports:<br>     - protocol: TCP<br>       port: 80<br>       targetPort: 80</p> 
<p>[root@master01 static]# kubectl apply -f kube-backend.yaml </p> 
<p>[root@master01 static]# kubectl get svc -n kube-system<br> NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                  AGE<br> default-http-backend   ClusterIP   10.102.127.253   &lt;none&gt;        80/TCP                   27m<br> kube-dns               ClusterIP   10.96.0.10       &lt;none&gt;        53/UDP,53/TCP,9153/TCP   4h47m</p> 
<p>#查看ingress时，已经正常了<br> [root@master01 static]# kubectl get ingress <br> NAME                   CLASS    HOSTS         ADDRESS        PORTS   AGE<br> test-service-ingress   &lt;none&gt;   demo.od.com   10.108.95.79   80      4h5m</p> 
<p>[root@master01 static]# kubectl describe ingress test-service-ingress<br> Name:             test-service-ingress<br> Namespace:        default<br> Address:          10.108.95.79<br> Default backend:  default-http-backend:80 (&lt;none&gt;)   <span style="color:#fe2c24;"> #正常了</span><br> Rules:<br>   Host         Path  Backends<br>   ----         ----  --------<br>   demo.od.com  <br>                   nginx-service:80 (10.244.2.2:80,10.244.2.3:80)<br> Annotations:   kubernets.io/ingress.class: nginx<br> Events:        &lt;none&gt;</p> 
<p>#demo.od.com解析到vip上面，<br> [root@master01 ~]# cat /var/named/od.com.zone <br> demo               A   10.4.7.48</p> 
<p>[root@master01 ~]# systemctl restart named</p> 
<p>[root@master01 ~]# curl ingresstest.od.com<br> Hello MyApp | Version: v1 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</p> 
<p>6.<span style="color:#fe2c24;">配置所有http的域名转发到</span></p> 
<p>#两台nginx机器，做反代：都<span style="color:#fe2c24;">是ingress-controller指定部署ingress的节点，上面 </span>mandatory.yaml w 文件通过nodeselector指定标有" <span style="color:#fe2c24;">node=ingress-controller </span>" 三台master节点ip跟nodeport，</p> 
<p>#demo.od.com解析到vip上面，<br> [root@master01 ~]# cat /var/named/od.com.zone <br> demo               A   10.4.7.48</p> 
<p><span style="color:#fe2c24;">下面只是http服务的配置，https的配置，需要单独配置每个conf文件</span><br> [root@nginx01 ~]# vi /etc/nginx/conf.d/od.com.conf<br> upstream default_backend_ingress {<!-- --><br>     server 192.128.232.16:80    max_fails=3 fail_timeout=10s;<br>     server 192.128.232.17:80    max_fails=3 fail_timeout=10s;</p> 
<p>    server 192.128.232.19:80    max_fails=3 fail_timeout=10s;<br> }<br> server {<!-- --><br>     server_name *.od.com;<br>   <br>     location / {<!-- --><br>         proxy_pass http://default_backend_ingress;<br>         proxy_set_header Host       $http_host;<br>         proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;<br>     }<br> }</p> 
<p>[root@nginx01 ~]# nginx -t<br> [root@nginx01 ~]# nginx -s reload</p> 
<p><br> 7.再发布一个服务到k8s，使用ingress<br> [root@master01 ~]# cat nginx-clusterIP02-service.yaml <br> apiVersion: apps/v1<br> kind: Deployment<br> metadata:<br>   name: nginx-deployment2<br>   labels:<br>     app: nginx2<br> spec:<br>   replicas: 2<br>   selector:<br>     matchLabels:<br>       app: nginx2<br>   template:<br>     metadata:<br>       labels:<br>         app: nginx2<br>     spec:<br>       containers:<br>       - name: nginx2<br>         image: harbor.od.com/kubeadm/myapp:v2<br>         imagePullPolicy: IfNotPresent<br>         ports:<br>         - containerPort: 80<br> ---<br> apiVersion: v1<br> kind: Service<br> metadata:<br>   name: nginx-service2<br> spec:<br>   type: ClusterIP<br>   selector:<br>     app: nginx2<br>   ports:<br>   - protocol: TCP<br>     port: 80<br>     targetPort: 80</p> 
<p>[root@master01 ~]# kubectl apply -f nginx-clusterIP02-service.yaml <br>     <br> [root@master01 ~]# cat nginx-clusterIP02-ingress.yaml <br> apiVersion: extensions/v1beta1<br> kind: Ingress<br> metadata:<br>   name: test02-service-ingress<br>   namespace: default<br>   annotations:<br>     kubernets.io/ingress.class: "nginx"<br> spec:<br>   rules:<br>   - host: ingresstest02.od.com<br>     http:<br>       paths:<br>       - path:<br>         backend:<br>           serviceName: nginx-service2<br>           servicePort: 80</p> 
<p>[root@master01 ~]# kubectl apply -f nginx-clusterIP02-ingress.yaml<br>           <br> [root@master01 ~]# kubectl describe ingress test02-service-ingress<br> Name:             test02-service-ingress<br> Namespace:        default<br> Address:          10.99.155.170<br> Default backend:  default-http-backend:80 (&lt;none&gt;)<br> Rules:<br>   Host                  Path  Backends<br>   ----                  ----  --------<br>   ingresstest02.od.com  <br>                            nginx-service2:80 (10.244.2.4:80,10.244.2.5:80)<br> Annotations:            kubernets.io/ingress.class: nginx02<br> Events:<br>   Type    Reason  Age                From                      Message<br>   ----    ------  ----               ----                      -------<br>   Normal  CREATE  52m                nginx-ingress-controller  Ingress default/test02-service-ingress<br>   Normal  UPDATE  78s (x2 over 52m)  nginx-ingress-controller  Ingress default/test02-service-ingress<br>           </p> 
<p>[root@master01 ~]# vi /var/named/od.com.zone <br> ingresstest02      A   10.4.7.48</p> 
<p>[root@master01 ~]# systemctl restart named</p> 
<p>[root@master01 ~]# curl ingresstest02.od.com<br> Hello MyApp | Version: v2 | &lt;a href="hostname.html"&gt;Pod Name&lt;/a&gt;</p> 
<p>[root@master01 ingress]# kubectl get pod -n ingress-nginx<br> NAME                             READY   STATUS    RESTARTS   AGE<br> nginx-ingress-controller-jv79q   1/1     Running   0          46m</p> 
<p>#进<span style="color:#fe2c24;">入容器，可以查看配置文件</span><br> [root@master01 ingress]# kubectl exec -it nginx-ingress-controller-jv79q -n ingress-nginx -- /bin/bash<br> bash-5.0$ vi nginx.conf   </p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/06/d6/7U8uM4Le_o.png"></p> 
<p> </p> 
<p>8.自签证书，创建私钥<br> [root@master01 tls]# openssl genrsa -out tls.key 2048<br> Generating RSA private key, 2048 bit long modulus<br> ....................................................................................................................+++<br> ......+++<br> e is 65537 (0x10001)</p> 
<p>#通过私钥生成证书，我指定<span style="color:#fe2c24;">有效期设置10年</span>。<br> [root@master01 ssl]# openssl req -new -x509 -days 3650 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/O=DevOps/CN=tomcat.od.com<br> [root@master01 ssl]# ll<br> total 8<br> -rw-r--r-- 1 root root 1237 Dec 16 13:26 tls.crt<br> -rw-r--r-- 1 root root 1675 Dec 16 12:26 tls.key</p> 
<p>#<span style="color:#fe2c24;">查看证书有效期</span><br> [root@master01 ssl]# openssl x509 -noout -text -in tls.crt <br> Certificate:<br>     Data:<br>         Version: 3 (0x2)<br>         Serial Number:<br>             ac:97:46:33:e0:d1:6c:46<br>     Signature Algorithm: sha256WithRSAEncryption<br>         Issuer: C=CN, ST=Beijing, O=DevOps, CN=tomcat.od.com<br>         Validity<br>             Not Before: Dec 16 05:26:22 2021 GMT<br>             Not After : Dec 14 05:26:22 2031 GMT   <br>         Subject: C=CN, ST=Beijing, O=DevOps, CN=tomcat.od.com<br>         Subject Public Key Info:<br>             Public Key Algorithm: rsaEncryption<br>                 Public-Key: (2048 bit)<br>                 Modulus:</p> 
<p><br> #创建secret对象，<span style="color:#fe2c24;">把这些证书添加到ingress对象里，默认是default名称空间</span>。<span style="color:#fe2c24;">可以指定名称空间</span><br> [root@master01 tls]# kubectl create secret tls tomcat-ingress-secret --cert=tls.crt --key=tls.key <br> secret/tomcat-ingress-secret created</p> 
<p>[root@master01 tls]# kubectl get secret<br> NAME                    TYPE                                  DATA   AGE<br> default-token-fcmwb     kubernetes.io/service-account-token   3      23h<br> tomcat-ingress-secret   kubernetes.io/tls                     2      111s</p> 
<p>[root@master01 tls]# kubectl describe secret tomcat-ingress-secret<br> Name:         tomcat-ingress-secret<br> Namespace:    default    <span style="color:#fe2c24;">#默认是default名称空间。</span><br> Labels:       &lt;none&gt;<br> Annotations:  &lt;none&gt;</p> 
<p>Type:  kubernetes.io/tls</p> 
<p>Data<br> ====<br> tls.key:  1675 bytes<br> tls.crt:  1237 bytes</p> 
<p>#部署tomcat服务到k8s里<br> [root@master01 yaml]# cat tomcat-clusterIP-service.yaml <br> apiVersion: apps/v1<br> kind: Deployment<br> metadata:<br>   name: tomcat-deployment<br>   labels:<br>     app: tomcat<br> spec:<br>   replicas: 2<br>   selector:<br>     matchLabels:<br>       app: tomcat<br>   template:<br>     metadata:<br>       labels:<br>         app: tomcat<br>     spec:<br>       containers:<br>       - name: tomcat<br>         image: harbor.od.com/kubeadm/tomcat:8.5.15-jre8-alpine   #<span style="color:#fe2c24;">tomcat镜像，测试下载alpine</span><br>         imagePullPolicy: IfNotPresent<br>         ports:<br>         - containerPort: 8080    #<span style="color:#fe2c24;">容器tomcat服务端口</span><br> ---<br> apiVersion: v1<br> kind: Service<br> metadata:<br>   name: tomcat-service    #<span style="color:#fe2c24;">定义tomcat服务的名字，ingress通过这个名字调用，使外部访问。</span><br> spec:<br>   type: ClusterIP<br>   selector:<br>     app: tomcat<br>   ports:<br>   - protocol: TCP<br>     port: 8080<br>     targetPort: 8080</p> 
<p>#<span style="color:#fe2c24;">配置tomcat的ingress，使用tls证书</span><br> [root@master01 yaml]# cat tomcat-clusterIP-ingress.yaml <br> apiVersion: extensions/v1beta1<br> kind: Ingress<br> metadata:<br>   name: tomcat-tls-ingress   #<span style="color:#fe2c24;">定义创建tomcat的ingress名字</span><br>   namespace: default<br>   annotations:<br>     kubernets.io/ingress.class: "tomcat"    <span style="color:#fe2c24;">#注解一定要有，否则不生效</span><br> spec:<br>   tls:        <span style="color:#fe2c24;">#开启tls</span><br>   - hosts:<br>     - tomcat.od.com     <span style="color:#fe2c24;">#配置外部访问的域名，可以配置多个域名使用同一个secret</span><br>     secretName: tomcat-ingress-secret    <span style="color:#fe2c24;">#配置使用创建的secret的名字</span><br>   rules:<br>   - host: tomcat.od.com<br>     http:<br>       paths:<br>       - path: /<br>         backend:<br>           serviceName: tomcat-service     #<span style="color:#fe2c24;">调用tomcat的service名字</span><br>           servicePort: 8080</p> 
<p>#<span style="color:#fe2c24;">创建tomcat的ingress的pod</span><br> [root@master01 tls]# kubectl apply -f tomcat-clusterIP-ingress.yaml</p> 
<p>[root@master01 yaml]# kubectl describe ingress tomcat-tls-ingress<br> Name:             tomcat-tls-ingress<br> Namespace:        default<br> Address:          10.99.155.170<br> Default backend:  default-http-backend:80 (&lt;none&gt;)<br> TLS:<br>   tomcat-ingress-secret terminates tomcat.od.com<br> Rules:<br>   Host           Path  Backends<br>   ----           ----  --------<br>   tomcat.od.com  <br>                  /   tomcat-service:8080 (10.244.2.8:8080,10.244.2.9:8080)<br> Annotations:     kubernets.io/ingress.class: tomcat<br> Events:<br>   Type    Reason  Age    From                      Message<br>   ----    ------  ----   ----                      -------<br>   Normal  CREATE  4m27s  nginx-ingress-controller  Ingress default/tomcat-tls-ingress<br>   Normal  UPDATE  4m15s  nginx-ingress-controller  Ingress default/tomcat-tls-ingress</p> 
<p>#解析t<span style="color:#fe2c24;">omcat.od.com到部署节点，跟http不一样，</span><br> [root@master01 ssl]# cat /var/named/od.com.zone <br> tomcat             A   10.4.7.51</p> 
<p>[root@master01 ssl]# systemctl restart named</p> 
<p>#<span style="color:#fe2c24;">浏览器测试或者命令行</span></p> 
<p>[root@master01 yaml]# curl -k https://tomcat.od.com</p> 
<p></p> 
<p>#############################################################################</p> 
<p>第二种：<span style="color:#fe2c24;">配置外部https在外部nginx服务</span><br> 配置t<span style="color:#fe2c24;">omcat02.od.com域名为https，一个service可以被多个ingress调用，那这里就直接调用tomcat-service，</span></p> 
<p>[root@master01 yaml]# cat tomcat02-clusterIP-ingress.yaml <br> apiVersion: extensions/v1beta1<br> kind: Ingress<br> metadata:<br>   name: tomcat02-ingress    <span style="color:#fe2c24;">#同一个名称空间的名字一定要不一样。</span><br>   namespace: default<br>   annotations:<br>     kubernets.io/ingress.class: "tomcat"<br> spec:<br>   rules:<br>   - host: tomcat02.od.com<br>     http:<br>       paths:<br>       - path: /<br>         backend:<br>           serviceName: tomcat-service  <span style="color:#fe2c24;"> #调用前面创建的tomcat-service</span><br>           servicePort: 8080</p> 
<p>#创建tomcat02的ingress<br> [root@master01 yaml]# kubectl apply -f tomcat02-clusterIP-ingress.yaml</p> 
<p>[root@master01 yaml]# kubectl get ingress |grep tomcat02-ingress<br> NAME                     CLASS    HOSTS                  ADDRESS         PORTS     AGE<br> tomcat02-ingress         &lt;none&gt;   tomcat02.od.com        10.99.155.170   80        27m</p> 
<p><br> #############################################################################<br><span style="color:#fe2c24;">#在yunwei主机上操作</span><br> #nginx配置tomcat02.od.com域名的https，<br> [root@yunwei ~]# mkdir -p /opt/certs/CA &amp;&amp; cd /opt/certs/CA</p> 
<p>#创建域名自签CA证书，先创建域名私钥<br> [root@yunwei CA]# umask 077; openssl genrsa -out tomcat02.od.com.key 2048<br> Generating RSA private key, 2048 bit long modulus<br> ...+++<br> ..........................................................................................................................+++<br> e is 65537 (0x10001)</p> 
<p><br> #查看生成的CA签证私钥<br> [root@yunwei CA]# ll CA.key <br> -rw------- 1 root root 1675 Dec 17 15:06 tomcat02.od.com.key</p> 
<p><span style="color:#fe2c24;">#通过CA自签证书创建域名请求文件csr</span><br><span style="color:#0d0016;">[root@yunwei CA]# openssl req -new -key tomcat02.od.com.key -out tomcat02.od.com.csr -subj "/CN=tomcat02.od.com/C=CN/ST=BJ/L=Beijing/O=fengge123/OU=ops"</span></p> 
<p><span style="color:#fe2c24;">#查看是否生成成功</span><br><span style="color:#0d0016;">[root@yunwei CA]# ll tomcat02.od.com.*<br> -rw------- 1 root root 1005 Dec 17 15:01 tomcat02.od.com.csr<br> -rw------- 1 root root 1675 Dec 17 14:59 tomcat02.od.com.key</span></p> 
<p>#通过域名请求文件csr,这里的<span style="color:#fe2c24;">ca.crt, ca.key</span>都是k8s集群的<span style="color:#fe2c24;">ca一对证书</span>，运维主机没有，就需要拷贝过来。否则有问题<br><span style="color:#fe2c24;">#拷贝master节点k8s的ca证书到运维节点</span><br> [root@yunwei CA]# scp master01:/etc/kubernetes/pki/ca.* .<br> root@master01's password: <br> ca.crt                                                                                 100% 1029   631.4KB/s   00:00    <br> ca.key                                                                                 100% 1675   429.5KB/s   00:00    <br> ca.srl                                                                                 100%   17     7.3KB/s   00:00     </p> 
<p>#把k8s集群的证书也内嵌到域名证书里，<span style="color:#fe2c24;">指定有效期10年</span><br> [root@yunwei CA]# openssl x509 -req -in tomcat02.od.com.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out tomcat02.od.com.crt -days 3650<br> Signature ok<br> subject=/CN=tomcat02.od.com/C=CN/ST=BJ/L=Beijing/O=fengge123/OU=ops<br> Getting CA Private Key</p> 
<p>[root@yunwei CA]# ll tomcat02.od.com.*<br> -rw------- 1 root root 1090 Dec 17 15:17 tomcat02.od.com.crt<br> -rw------- 1 root root 1005 Dec 17 15:10 tomcat02.od.com.csr<br> -rw------- 1 root root 1679 Dec 17 15:09 tomcat02.od.com.key</p> 
<p><br> #<span style="color:#fe2c24;">上面tomcat02.od.com域名证书就自签成功了，需要拷贝到nginx节点反向代理，部署https</span><br> [root@nginx01 yaml]# mkdir -p /etc/nginx/ssl/<br> [root@nginx01 yaml]# cd /etc/nginx/ssl/</p> 
<p>#拷贝运维节点创建好的域名证书<br> [root@master01 ssl]# scp yunwei:/opt/certs/CA/tomcat02.od.com.crt .<br> [root@master01 ssl]# scp yunwei:/opt/certs/CA/tomcat02.od.com.key .</p> 
<p>#配置https反向代理，<span style="color:#fe2c24;">这里的节点可以是集群任何节点</span>，<br> [root@nginx01 ~]# cd /etc/nginx/conf.d/<br> [root@nginx01 conf.d]# cat tomcat02.do.com.conf <br> upstream tomcat02_ingress {<!-- --><br>     server 192.128.232.16:80    max_fails=3 fail_timeout=10s;<br>     server 192.128.232.17:80    max_fails=3 fail_timeout=10s;<br> }<br> server {<!-- --><br>     listen       80;<br>     server_name  tomcat02.od.com;<br>     rewrite ^(.*)$ https://${server_name}$1 permanent;<br> }<br> server {<!-- --><br>     listen       443 ssl;<br>     server_name  tomcat02.od.com;<br>     ssl_certificate "/etc/nginx/ssl/tomcat02.od.com.crt";<br>     ssl_certificate_key "/etc/nginx/ssl/tomcat02.od.com.key";<br>     ssl_session_cache shared:SSL:1m;<br>     ssl_session_timeout  10m;<br>     ssl_ciphers HIGH:!aNULL:!MD5;<br>     ssl_prefer_server_ciphers on;</p> 
<p>    location / {<!-- --><br>         proxy_pass http://tomcat02_ingress;<br>         proxy_set_header Host       $http_host;<br>         proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;<br>     }<br> }</p> 
<p>[root@nginx01 conf.d]# nginx -t<br> [root@nginx01 conf.d]# nginx -s reload</p> 
<p><br><span style="color:#fe2c24;">#解析域名到vip地址，在DNS服务器操作</span><br> [root@master01 ssl]# vi /var/named/od.com.zone <br> tomcat02           A   192.128.232.15</p> 
<p>[root@master01 ssl]# systemctl restart named</p> 
<p>#测试命令行访问或者浏览器访问<br> [root@yunwei ~]# curl -k https://tomcat02.od.com<br>  </p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2c4c776cf25243e387926bb289dbab59/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CTFshow web入门——文件上传</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8df4ebb21e1d0f7ff7f0bd7f84214058/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">救援模式（Rescue Mode）、单用户模式（Single-User Mode）、紧急模式（Emergency Mode）的区别与联系</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>