<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【动手学强化学习】DDPG&#43;HER - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【动手学强化学习】DDPG&#43;HER" />
<meta property="og:description" content="代码参考自动手学强化学习（jupyter notebook版本）：https://github.com/boyu-ai/Hands-on-RL
使用pycharm打开的请查看：https://github.com/zxs-000202/dsx-rl
理论部分 实践部分 1.定义一个简单地二维平面上的环境，在一个二维网格世界上，每个维度的位置范围时[0,5]，在每一个序列的初始，智能体都位于（0,0）的位置，环境将自动从3.5&lt;=x,y&lt;=4.5的矩形区域内生成一个目标。每个时刻智能体可以选择纵向和横向分别移动[-1,1]作为这一时刻的动作。当智能体距离目标足够近时，它将得到值为0的奖励并结束任务，否则奖励为-1。每一条轨迹的最大长度为50。
class WorldEnv: def __init__(self): self.distance_threshold = 0.15 self.action_bound = 1 def reset(self): # 重置环境 # 生成一个目标状态, 坐标范围是[3.5～4.5, 3.5～4.5] self.goal = np.array( [4 &#43; random.uniform(-0.5, 0.5), 4 &#43; random.uniform(-0.5, 0.5)]) self.state = np.array([0, 0]) # 初始状态 self.count = 0 return np.hstack((self.state, self.goal)) # 水平方向上拼接 def step(self, action): action = np.clip(action, -self.action_bound, self.action_bound) x = max(0, min(5, self.state[0] &#43; action[0])) y = max(0, min(5, self.state[1] &#43; action[1])) self." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ca9aa8e3d9d4cc6d850782612af236f2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-09T18:44:16+08:00" />
<meta property="article:modified_time" content="2022-07-09T18:44:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【动手学强化学习】DDPG&#43;HER</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>代码参考自动手学强化学习（jupyter notebook版本）：<a href="https://github.com/boyu-ai/Hands-on-RL">https://github.com/boyu-ai/Hands-on-RL</a></p> 
<p>使用pycharm打开的请查看：<a href="https://github.com/zxs-000202/dsx-rl">https://github.com/zxs-000202/dsx-rl</a></p> 
<h4><a id="_3"></a>理论部分</h4> 
<p><img src="https://images2.imgbox.com/fa/e7/czF2pkkJ_o.jpg" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/dd/8d/4820c6uU_o.jpg" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/eb/e4/2uthsm9R_o.jpg" alt="在这里插入图片描述"></p> 
<h4><a id="_13"></a>实践部分</h4> 
<p>1.定义一个简单地二维平面上的环境，在一个二维网格世界上，每个维度的位置范围时[0,5]，在每一个序列的初始，智能体都位于（0,0）的位置，环境将自动从3.5&lt;=x,y&lt;=4.5的矩形区域内生成一个目标。每个时刻智能体可以选择纵向和横向分别移动[-1,1]作为这一时刻的动作。当智能体距离目标足够近时，它将得到值为0的奖励并结束任务，否则奖励为-1。每一条轨迹的最大长度为50。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">WorldEnv</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>distance_threshold <span class="token operator">=</span> <span class="token number">0.15</span>
        self<span class="token punctuation">.</span>action_bound <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token keyword">def</span> <span class="token function">reset</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 重置环境</span>
        <span class="token comment"># 生成一个目标状态, 坐标范围是[3.5～4.5, 3.5～4.5]</span>
        self<span class="token punctuation">.</span>goal <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>
            <span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token operator">+</span> random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 初始状态</span>
        self<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token keyword">return</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">,</span> self<span class="token punctuation">.</span>goal<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 水平方向上拼接</span>

    <span class="token keyword">def</span> <span class="token function">step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">)</span><span class="token punctuation">:</span>
        action <span class="token operator">=</span> np<span class="token punctuation">.</span>clip<span class="token punctuation">(</span>action<span class="token punctuation">,</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>action_bound<span class="token punctuation">,</span> self<span class="token punctuation">.</span>action_bound<span class="token punctuation">)</span>
        x <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>state<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> action<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        y <span class="token operator">=</span> <span class="token builtin">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">min</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>state<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> action<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>state <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span>

        dis <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>self<span class="token punctuation">.</span>state <span class="token operator">-</span> self<span class="token punctuation">.</span>goal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        reward <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token keyword">if</span> dis <span class="token operator">&gt;</span> self<span class="token punctuation">.</span>distance_threshold <span class="token keyword">else</span> <span class="token number">0</span>
        <span class="token keyword">if</span> dis <span class="token operator">&lt;=</span> self<span class="token punctuation">.</span>distance_threshold <span class="token keyword">or</span> self<span class="token punctuation">.</span>count <span class="token operator">==</span> <span class="token number">50</span><span class="token punctuation">:</span>
            done <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            done <span class="token operator">=</span> <span class="token boolean">False</span>

        <span class="token keyword">return</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>state<span class="token punctuation">,</span> self<span class="token punctuation">.</span>goal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done


</code></pre> 
<p>2.首先通过以下代码产生一个episode的轨迹并保存在Trajectory类实例化的traj对象中，其中存储了这条轨迹的状态序列、动作序列、奖励序列、是否完成序列、轨迹长度值。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">Trajectory</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 用来记录一条完整轨迹 '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> init_state<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>states <span class="token operator">=</span> <span class="token punctuation">[</span>init_state<span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>actions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>rewards <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>dones <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">def</span> <span class="token function">store_step</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> action<span class="token punctuation">,</span> state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>actions<span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>states<span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>rewards<span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dones<span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>length <span class="token operator">+=</span> <span class="token number">1</span>
</code></pre> 
<pre><code class="prism language-python">episode_return <span class="token operator">=</span> <span class="token number">0</span>
state <span class="token operator">=</span> env<span class="token punctuation">.</span>reset<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># state为初始位置与目标位置的拼接</span>
traj <span class="token operator">=</span> Trajectory<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
done <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">while</span> <span class="token keyword">not</span> done<span class="token punctuation">:</span>
	action <span class="token operator">=</span> agent<span class="token punctuation">.</span>take_action<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
	state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done <span class="token operator">=</span> env<span class="token punctuation">.</span>step<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
	episode_return <span class="token operator">+=</span> reward
	traj<span class="token punctuation">.</span>store_step<span class="token punctuation">(</span>action<span class="token punctuation">,</span> state<span class="token punctuation">,</span> reward<span class="token punctuation">,</span> done<span class="token punctuation">)</span>
</code></pre> 
<p>生成一个轨迹之后的traj中存储的数据如下图所示：<br> <img src="https://images2.imgbox.com/44/30/eIdQuBXo_o.png" alt="在这里插入图片描述"><br> 3.之后将生成的轨迹存储到经验回放池中</p> 
<pre><code class="prism language-python">replay_buffer<span class="token punctuation">.</span>add_trajectory<span class="token punctuation">(</span>traj<span class="token punctuation">)</span>
return_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>episode_return<span class="token punctuation">)</span>
</code></pre> 
<p>和DDPG、DQN不同的是这里是存储的一条一条的trajectory，而那两个存储的是一个一个的transition。另外，这里的sample方法和前者有较大的差别。</p> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ReplayBuffer_Trajectory</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 存储轨迹的经验回放池 '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> collections<span class="token punctuation">.</span>deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>capacity<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add_trajectory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>trajectory<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> use_her<span class="token punctuation">,</span> dis_threshold<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> her_ratio<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>states<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     actions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     next_states<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     rewards<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     dones<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>
            traj <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            step_state <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>traj<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            state <span class="token operator">=</span> traj<span class="token punctuation">.</span>states<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span>
            next_state <span class="token operator">=</span> traj<span class="token punctuation">.</span>states<span class="token punctuation">[</span>step_state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
            action <span class="token operator">=</span> traj<span class="token punctuation">.</span>actions<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span>
            reward <span class="token operator">=</span> traj<span class="token punctuation">.</span>rewards<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span>
            done <span class="token operator">=</span> traj<span class="token punctuation">.</span>dones<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span>

            <span class="token keyword">if</span> use_her <span class="token keyword">and</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> her_ratio<span class="token punctuation">:</span>
                step_goal <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>step_state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> traj<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
                goal <span class="token operator">=</span> traj<span class="token punctuation">.</span>states<span class="token punctuation">[</span>step_goal<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>  <span class="token comment"># 使用HER算法的future方案设置目标</span>
                dis <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>next_state<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> goal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                reward <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token keyword">if</span> dis <span class="token operator">&gt;</span> dis_threshold <span class="token keyword">else</span> <span class="token number">0</span>
                done <span class="token operator">=</span> <span class="token boolean">False</span> <span class="token keyword">if</span> dis <span class="token operator">&gt;</span> dis_threshold <span class="token keyword">else</span> <span class="token boolean">True</span>
                state <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> goal<span class="token punctuation">)</span><span class="token punctuation">)</span>
                next_state <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>next_state<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> goal<span class="token punctuation">)</span><span class="token punctuation">)</span>

            batch<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>next_state<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'dones'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>

        batch<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        batch<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        batch<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> batch
</code></pre> 
<p><img src="https://images2.imgbox.com/62/c4/GuVUOb9Q_o.png" alt="在这里插入图片描述"><br> 4.当经验回放池中的轨迹数大于等于200开始进行更新<br> 首先，通过从replay_buffer中sample数据，具体而言就是：sample256条数据到batch中，其中每条是通过从replay_buffer中抽样一个trajectory，然后从trajectory中抽样一个transition；如果应用HER算法，那么在一定几率下，对transition中得数据做一些处理再添加到batch中。处理的操作就是：从该trajectory随机抽样一个该transition之后的transition，我们叫它step_goal吧，然后将这个transition的状态的前两个数（即该transition的初始位置）和原transition的状态的后两个数进行替换，即新的要存到batch中的transition的状态的前两个是原来的，然后目标是后面transition的初始位置。<br> <img src="https://images2.imgbox.com/4c/76/z3BH0Nzo_o.png" alt="在这里插入图片描述"><br> 就比如红色是原来的transition对应位置，黄色是终极目标，通过随机抽样整个轨迹中红色之后的一个transition，这里假设就是绿色的点的位置。我们原来的状态是红色，想要到达红色，很明显比较困难。此时，我们可以先假设我们的目标是绿色，通过这种方式，更换transition中state的信息。最终，可以更容易的训练实现物体到达目标位置。</p> 
<pre><code class="prism language-python"><span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>n_train<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># n_train=20     batch_size = 256</span>
	transition_dict <span class="token operator">=</span> replay_buffer<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>batch_size<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
	agent<span class="token punctuation">.</span>update<span class="token punctuation">(</span>transition_dict<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python"><span class="token keyword">class</span> <span class="token class-name">ReplayBuffer_Trajectory</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">''' 存储轨迹的经验回放池 '''</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> capacity<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span> <span class="token operator">=</span> collections<span class="token punctuation">.</span>deque<span class="token punctuation">(</span>maxlen<span class="token operator">=</span>capacity<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">add_trajectory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> trajectory<span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>trajectory<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">size</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">sample</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> batch_size<span class="token punctuation">,</span> use_her<span class="token punctuation">,</span> dis_threshold<span class="token operator">=</span><span class="token number">0.15</span><span class="token punctuation">,</span> her_ratio<span class="token operator">=</span><span class="token number">0.8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        batch <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>states<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     actions<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     next_states<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     rewards<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                     dones<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> _ <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batch_size<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># batch_size=256</span>
            traj <span class="token operator">=</span> random<span class="token punctuation">.</span>sample<span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token builtin">buffer</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>  
            <span class="token comment"># 从buffer中随机抽样一个轨迹</span>
            step_state <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>traj<span class="token punctuation">.</span>length<span class="token punctuation">)</span> 
            <span class="token comment"># 从抽样的轨迹中随机抽样出一个transition</span>
            state <span class="token operator">=</span> traj<span class="token punctuation">.</span>states<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span> 
             <span class="token comment"># 抽样出的transition的state</span>
            next_state <span class="token operator">=</span> traj<span class="token punctuation">.</span>states<span class="token punctuation">[</span>step_state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
             <span class="token comment"># 抽样出的transition的next_state</span>
            action <span class="token operator">=</span> traj<span class="token punctuation">.</span>actions<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span> 
             <span class="token comment"># 抽样出的transition的动作</span>
            reward <span class="token operator">=</span> traj<span class="token punctuation">.</span>rewards<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span> 
             <span class="token comment"># 抽样出的transition的奖励</span>
            done <span class="token operator">=</span> traj<span class="token punctuation">.</span>dones<span class="token punctuation">[</span>step_state<span class="token punctuation">]</span> 
             <span class="token comment"># 抽样出的transition是否done</span>

            <span class="token keyword">if</span> use_her <span class="token keyword">and</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>uniform<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> her_ratio<span class="token punctuation">:</span>
                step_goal <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>randint<span class="token punctuation">(</span>step_state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> traj<span class="token punctuation">.</span>length <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
               <span class="token comment"># 从上面transition之后的轨迹选择一个设置之后的goal</span>
                goal <span class="token operator">=</span> traj<span class="token punctuation">.</span>states<span class="token punctuation">[</span>step_goal<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> 
   <span class="token comment"># 使用HER算法的future方案设置目标，选择此transition的当前位置作为goal</span>
                dis <span class="token operator">=</span> np<span class="token punctuation">.</span>sqrt<span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span>square<span class="token punctuation">(</span>next_state<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">-</span> goal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                reward <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token keyword">if</span> dis <span class="token operator">&gt;</span> dis_threshold <span class="token keyword">else</span> <span class="token number">0</span>
                done <span class="token operator">=</span> <span class="token boolean">False</span> <span class="token keyword">if</span> dis <span class="token operator">&gt;</span> dis_threshold <span class="token keyword">else</span> <span class="token boolean">True</span>
                state <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>state<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> goal<span class="token punctuation">)</span><span class="token punctuation">)</span> 
                 <span class="token comment"># 将原来的初始位置和后来挑选的goal拼接</span>
                next_state <span class="token operator">=</span> np<span class="token punctuation">.</span>hstack<span class="token punctuation">(</span><span class="token punctuation">(</span>next_state<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> goal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment"># 将原来的下一个transition的初始位置和goal拼接</span>

            batch<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>state<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>next_state<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>action<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'rewards'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>reward<span class="token punctuation">)</span>
            batch<span class="token punctuation">[</span><span class="token string">'dones'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>done<span class="token punctuation">)</span>

        batch<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'states'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
         <span class="token comment"># 256*4</span>
        batch<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'next_states'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token comment"># 256*4</span>
        batch<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span> <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>batch<span class="token punctuation">[</span><span class="token string">'actions'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
         <span class="token comment"># 256*2</span>
        <span class="token keyword">return</span> batch
</code></pre> 
<p><img src="https://images2.imgbox.com/e9/c6/eTIJeXpJ_o.png" alt="在这里插入图片描述"><br> 5.实验过程和结果<br> <img src="https://images2.imgbox.com/57/ce/VveEknhl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d9/d5/x32GieFA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d3/68/YCjZ13fO_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3d1815dbb21b32b6961fd027ce179c4b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">生成与解析tensoflow2 tf_serving_warmup_requests</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d8736806d2292c4ae7ffca745584ced/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">全国大学生数学建模比赛介绍及其入门（国赛&#43;美赛）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>