<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Dockerfile 构建 Vue 镜像踩坑记 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Dockerfile 构建 Vue 镜像踩坑记" />
<meta property="og:description" content="▌背景
目前在公司维护的测试工具平台，有时候前端需要更新。改完前端 Vue 项目之后，还得在执行 npm run build 打包整个项目，再把打包好的整个项目拷贝过去后端项目中：这一步骤非常繁琐且不符合前后端分离的思想。为此考虑使用 Nginx 部署前端项目，后期可以配合 rancher 进行 CICD。
▌Dockerfile 详解
# 构建镜像基于onbuild_vue:v1镜像 FROM harbor.bluemoon.com.cn/lw/onbuild_vue:v1 AS builder #切换到/app工作目录下 WORKDIR /app # 复制package.json到app目录下 COPY package.json ./ # 执行npm命令 RUN npm config set registry https://registry.npm.taobao.org/ &amp;&amp; \ npm install # 复制当前目录下的所有文件到app目录下 COPY . ./ # 执行npm run build命令 RUN npm run build:prod # 构建镜像基于nginx:alpine镜像 FROM nginx:alpine # 声明端口80。仅声明作用，如果docker run -P 就会指定该端口 EXPOSE 80 # 从名为builder的阶段，复制打包好的文件到/usr/share/nginx/html/ COPY --from=builder /app/dist /usr/share/nginx/html/ # 删除原本的默认配置 RUN rm /etc/nginx/conf." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e0de13a7a934c51fcc6de86ef7d25024/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-31T13:57:32+08:00" />
<meta property="article:modified_time" content="2022-03-31T13:57:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Dockerfile 构建 Vue 镜像踩坑记</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><strong>▌</strong><strong>背景</strong></p> 
<p>目前在公司维护的测试工具平台，有时候前端需要更新。改完前端 Vue 项目之后，还得在执行 npm run build 打包整个项目，再把打包好的整个项目拷贝过去后端项目中：这一步骤非常繁琐且不符合<strong>前后端分离</strong>的思想。为此考虑使用 Nginx 部署前端项目，后期可以配合 rancher 进行 CICD。</p> 
<p><strong>▌</strong><strong>Dockerfile 详解</strong></p> 
<pre><code># 构建镜像基于onbuild_vue:v1镜像
FROM harbor.bluemoon.com.cn/lw/onbuild_vue:v1 AS builder
#切换到/app工作目录下
WORKDIR /app
# 复制package.json到app目录下
COPY package.json ./
# 执行npm命令
RUN npm config set registry https://registry.npm.taobao.org/ &amp;&amp; \
    npm install
# 复制当前目录下的所有文件到app目录下
COPY . ./
# 执行npm run build命令
RUN npm run build:prod

# 构建镜像基于nginx:alpine镜像
FROM nginx:alpine
# 声明端口80。仅声明作用，如果docker run -P 就会指定该端口
EXPOSE 80
# 从名为builder的阶段，复制打包好的文件到/usr/share/nginx/html/
COPY --from=builder /app/dist /usr/share/nginx/html/
# 删除原本的默认配置
RUN rm /etc/nginx/conf.d/default.conf
# 从名为builder的阶段，复制nginx配置文件到/etc/nginx/conf.d/
COPY --from=builder /app/nginx.conf /etc/nginx/conf.d/
</code></pre> 
<p><strong>▌</strong><strong>坑 一：npm run build 打包失败</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e5/43/9NQAxw7e_o.png"></p> 
<p><strong>出现报错：</strong></p> 
<p>ERROR ValidationError:Invalid confiquration obiect. Obiect has been initialized using a confiquration obiect that does not match the API schema.</p> 
<p><strong>排查过程：</strong></p> 
<ul><li> <p>先注释掉这下面的命令，再重新构建镜像，构建完之后，在里面执行 npm run build 命令，发现还是出现上面的报错，继续排查</p> </li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fe/12/KCsHZCIU_o.png"></p> 
<pre><code># 命令集合
docker build -t demo:v1 .
docker run -itd demo:v1 sh
docker ps 
docker exec -it 6ce3793827c3 sh
</code></pre> 
<ul><li> <p>直接进入到镜像内部，先执行 git clone 命令下载项目，再执行 npm install &amp; npm run build 相关的命令，发现打包编译成功</p> </li></ul> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/d2/bc/tiHhXuWz_o.png"></p> 
<pre><code># 命令集合
npm config set registry https://registry.npm.taobao.org/
npm install
npm run build:prod
</code></pre> 
<p><strong>猜测：</strong></p> 
<p>本地项目里的 node_module 影响了？先删除本地项目中的 node_module，试试；果然是删除大法好。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/20/66/jvQOXQgt_o.png"></p> 
<p><strong>结论：</strong></p> 
<p>因为在 Dockerfile 里的命令一开始就是已经 npm install，里面已经有了 node_module，但是 COPY 命令又把本地的 node_module 给复制过去，相当于覆盖了，所以导致编译一直不会成功。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/8d/6f/Aad9z0wN_o.png"></p> 
<p></p> 
<p><strong>▌</strong><strong>坑 二：打包好的镜像无法在 rancher 上跑</strong></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/c3/ba/LYaFzt3s_o.png"></p> 
<p><br><strong>出现报错：</strong></p> 
<p>standard_init_linux.go:211: exec user process caused "exec format error"</p> 
<p><strong>排查过程：</strong><br> 本地 run 可以，但是在服务器上不行。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/41/e1/dO9cCc1m_o.png"></p> 
<p>用某度某歌某 bing 搜索试试，果然找到了类似的帖子。<br><em>docker 运行容器报错 standard_init_linux.go:211: exec user process caused “exec format error“的可能解决办法</em></p> 
<ul><li> <p>硬件架构不兼容。在 amd 和 arm 架构下构建的镜像很有可能不能互通。</p> </li></ul> 
<p>解决办法：针对不同的硬件架构构建不同的镜像，或者构建跨架构（multi-arch）的镜像。</p> 
<ul><li> <p>shell 执行不兼容。脚本可能是基于 bash 写的，不同的 shell 解释器存在不兼容的情况，而有些 Linux 发行版可能没有 bash，或者默认的 shell 解释器不是 bash。</p> </li></ul> 
<p>解决办法：在 shell 脚本的开头指定需要使用的解释器，比如 #!/bin/bash，并且注意使用的语法。</p> 
<ul><li> <p>存在非 *NIX 环境的换行符。比如在 Windows 环境下编写的一些代码，移植到 Linux 环境下可能会出问题。</p> </li></ul> 
<p>解决办法：将 CRLF 替换为 LF</p> 
<p><strong>猜测：</strong></p> 
<p>打包的机器是 M1 芯片的，是 ARM 架构，那就是很大可能是硬件架构不兼容，导致无法 run？</p> 
<p>我在服务器（AMD 架构）打包了新的镜像，然后对比两个镜像信息，果然找到猫腻。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/af/29/yFaCbbVp_o.png"></p> 
<pre><code># 命令集合
docker run -itd -p 8080:80 demo:v2
docker ps
docker inspect image_id
</code></pre> 
<p><strong>结论：</strong></p> 
<p>M1 是 ARM 架构的，docker pull 或者 FROM 时默认下载 ARM 架构的镜像，基于 FROM 镜像构建出来的，肯定也是 AMD 架构的镜像。</p> 
<p><strong>解决方法：</strong></p> 
<pre><code># 使用下列命令来构建出符合运行要求的镜像版本
docker buildx build --platform=linux/amd64 . -t demo:v2
# buildx目前支持的平台架构
docker buildx ls
</code></pre> 
<p>打包后的镜像</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/cd/59/j3Dp1Zby_o.png"></p> 
<p>连踩 2 个大坑后，终于<strong>搞定</strong>了 Vue 镜像的部署！！</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/9e/ac/fo9iQKfQ_o.png"></p> 
<p><strong>▌</strong><strong>总结</strong></p> 
<p>遇到坑时不要怕，学会用搜索引擎找解决方法，还是无法解决，最好在一些交流群，找各路大神咨询一下。解决了坑之后，相应地也要把解决过程记录下来，好记性不如烂笔头~</p> 
<p><strong>最后感谢每一个认真阅读我文章的人，看着粉丝一路的上涨和关注，礼尚往来总是要有的，虽然不是什么很值钱的东西，如果你用得到的话可以直接拿走</strong></p> 
<hr> 
<p><img alt="" height="541" src="https://images2.imgbox.com/4f/06/8QYEpMgN_o.png" width="704"></p> 
<p>这些资料，对于做【软件测试】的朋友来说应该是最全面最完整的备战仓库，这个仓库也陪伴我走过了最艰难的路程，希望也能帮助到你！凡事要趁早，特别是技术行业，一定要提升技术功底。希望对大家有所帮助…<strong>..关注下方我的微信公众号【程序员小濠】免费获取~</strong></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/84e285f29782fcd896ac5a55570dd982/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">SPARK SHUFFLE中 ShuffleId BlockManagerId 以及 与ESS（External Shuffle Server）交互</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/02b21c60b29761ad2f4dc1f14ab3948a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">运动规划学习笔记5——ROS包_tf2</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>