<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>非Spring Boot Web项目 注册节点到Eureka Server并提供服务 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="非Spring Boot Web项目 注册节点到Eureka Server并提供服务" />
<meta property="og:description" content="相信有很多团队在老Web项目（zookeeper，dubbo，tomcat）想要过渡到新的Eureka注册管理的Spring Boot都会遇到这样一个问题，新项目想调用老项目提供的服务，或者不想采用Spring Boot 而是直接想使用Eureka 替换掉原有的zookeeper和dubbo，那怎么办0.0 能不能将老项目注册到Eureka Server？
1.项目jar依赖： gradle:
compile &#34;com.netflix.eureka:eureka-client:1.4.12&#34; maven:
&lt;dependency&gt; &lt;groupId&gt;com.netflix.eureka&lt;/groupId&gt; &lt;artifactId&gt;eureka-client&lt;/artifactId&gt; &lt;version&gt;1.4.12&lt;/version&gt; &lt;/dependency&gt; 此处主要依赖的是Netflix的eureka-client jar包（spring boot也是对它的一个简单封装）要注意这里的jar包版本要与Spring Boot项目依赖的eureka-client jar包版本一致 不然可能不兼容 下面是该jar包所有的依赖（有jar包冲突的要处理解决一下~） 2.添加Listener用于将节点注册到Eureka Server
package com.kowalski.web.eureka; import com.netflix.appinfo.ApplicationInfoManager; import com.netflix.appinfo.InstanceInfo; import com.netflix.config.DynamicPropertyFactory; import com.netflix.discovery.DefaultEurekaClientConfig; import com.netflix.discovery.DiscoveryManager; import lombok.extern.slf4j.Slf4j; import javax.servlet.ServletContextEvent; import javax.servlet.ServletContextListener; /** * Created by Kowalski on 2017/5/18 * Updated by Kowalski on 2017/5/18 */ @Slf4j public class EurekaInitAndRegisterListener implements ServletContextListener { private static final DynamicPropertyFactory configInstance = DynamicPropertyFactory ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e59aeedc401b207568a38fb7391d4024/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-05-19T20:16:53+08:00" />
<meta property="article:modified_time" content="2017-05-19T20:16:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">非Spring Boot Web项目 注册节点到Eureka Server并提供服务</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>相信有很多团队在老Web项目（zookeeper，dubbo，tomcat）想要过渡到新的Eureka注册管理的Spring Boot都会遇到这样一个问题，新项目想调用老项目提供的服务，或者不想采用Spring Boot 而是直接想使用Eureka 替换掉原有的zookeeper和dubbo，那怎么办0.0 能不能将老项目注册到Eureka Server？</p> 
<p><strong>1.项目jar依赖：</strong> <br> <em>gradle:</em></p> 
<pre class="prettyprint"><code class=" hljs css">    <span class="hljs-tag">compile</span> "<span class="hljs-tag">com</span><span class="hljs-class">.netflix</span><span class="hljs-class">.eureka</span><span class="hljs-pseudo">:eureka-client</span><span class="hljs-pseudo">:1</span><span class="hljs-class">.4</span><span class="hljs-class">.12</span>"</code></pre> 
<p><em>maven:</em></p> 
<pre class="prettyprint"><code class=" hljs xml"><span class="hljs-tag">&lt;<span class="hljs-title">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">groupId</span>&gt;</span>com.netflix.eureka<span class="hljs-tag">&lt;/<span class="hljs-title">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">artifactId</span>&gt;</span>eureka-client<span class="hljs-tag">&lt;/<span class="hljs-title">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">version</span>&gt;</span>1.4.12<span class="hljs-tag">&lt;/<span class="hljs-title">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">dependency</span>&gt;</span></code></pre> 
<p>此处主要依赖的是Netflix的eureka-client jar包（spring boot也是对它的一个简单封装）要注意这里的jar包版本要与Spring Boot项目依赖的eureka-client jar包版本一致 不然可能不兼容 <br> 下面是该jar包所有的依赖（有jar包冲突的要处理解决一下~） <br> <img src="https://images2.imgbox.com/ab/22/UH9JyPyB_o.png" alt="eureka-client" title=""></p> 
<p><strong>2.添加Listener用于将节点注册到Eureka Server</strong></p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> com.kowalski.web.eureka;

<span class="hljs-keyword">import</span> com.netflix.appinfo.ApplicationInfoManager;
<span class="hljs-keyword">import</span> com.netflix.appinfo.InstanceInfo;
<span class="hljs-keyword">import</span> com.netflix.config.DynamicPropertyFactory;
<span class="hljs-keyword">import</span> com.netflix.discovery.DefaultEurekaClientConfig;
<span class="hljs-keyword">import</span> com.netflix.discovery.DiscoveryManager;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;

<span class="hljs-keyword">import</span> javax.servlet.ServletContextEvent;
<span class="hljs-keyword">import</span> javax.servlet.ServletContextListener;

<span class="hljs-javadoc">/**
 * Created by Kowalski on 2017/5/18
 * Updated by Kowalski on 2017/5/18
 */</span>
<span class="hljs-annotation">@Slf</span>4j
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EurekaInitAndRegisterListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ServletContextListener</span> {<!-- --></span>

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> DynamicPropertyFactory configInstance = DynamicPropertyFactory
            .getInstance();

    <span class="hljs-javadoc">/**
     * * Notification that the web application initialization
     * * process is starting.
     * * All ServletContextListeners are notified of context
     * * initialization before any filter or servlet in the web
     * * application is initialized.
     *
     *<span class="hljs-javadoctag"> @param</span> sce
     */</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextInitialized</span>(ServletContextEvent sce) {
        <span class="hljs-javadoc">/**设置被读取配置文件名称  默认config.properties*/</span>
        Properties properties = <span class="hljs-keyword">new</span> Properties();
        properties.setProperty(<span class="hljs-string">"archaius.configurationSource.defaultFileName"</span>, <span class="hljs-string">"config.properties"</span>);
        System.setProperties(properties);
        <span class="hljs-javadoc">/**注册*/</span>
        registerWithEureka();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerWithEureka</span>() {
        <span class="hljs-javadoc">/**加载本地配置文件 根据配置初始化这台 Eureka Application Service 并且注册到 Eureka Server*/</span>
        DiscoveryManager.getInstance().initComponent(
                <span class="hljs-keyword">new</span> MyInstanceConfig(),
                <span class="hljs-keyword">new</span> DefaultEurekaClientConfig());

        <span class="hljs-javadoc">/**本台 Application Service 已启动，准备好侍服网络请求*/</span>
        ApplicationInfoManager.getInstance().setInstanceStatus(
                InstanceInfo.InstanceStatus.UP);

        log.info(<span class="hljs-string">"o2o eureka Application Service initing and registering"</span>);

        <span class="hljs-javadoc">/**Application Service 的 Eureka Server 初始化以及注册是异步的，需要一段时间 此处等待初始化及注册成功 可去除*/</span>
<span class="hljs-comment">//        String vipAddress = configInstance.getStringProperty(</span>
<span class="hljs-comment">//                "eureka.vipAddress", "o2o").get();</span>
<span class="hljs-comment">//        InstanceInfo nextServerInfo = null;</span>
<span class="hljs-comment">//        while (nextServerInfo == null) {<!-- --></span>
<span class="hljs-comment">//            try {<!-- --></span>
<span class="hljs-comment">//                nextServerInfo = DiscoveryManager.getInstance()</span>
<span class="hljs-comment">//                        .getDiscoveryClient()</span>
<span class="hljs-comment">//                        .getNextServerFromEureka(vipAddress, false);</span>
<span class="hljs-comment">//            } catch (Throwable e) {<!-- --></span>
<span class="hljs-comment">//                log.info("Waiting for service to register with eureka..");</span>
<span class="hljs-comment">//                try {<!-- --></span>
<span class="hljs-comment">//                    Thread.sleep(10000);</span>
<span class="hljs-comment">//                } catch (InterruptedException e1) {<!-- --></span>
<span class="hljs-comment">//                    e1.printStackTrace();</span>
<span class="hljs-comment">//                }</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">//            }</span>
<span class="hljs-comment">//        }</span>
<span class="hljs-comment">//        log.info("Service started and ready to process requests..");</span>
    }

    <span class="hljs-javadoc">/**
     * * Notification that the servlet context is about to be shut down.
     * * All servlets and filters have been destroy()ed before any
     * * ServletContextListeners are notified of context
     * * destruction.
     *
     *<span class="hljs-javadoctag"> @param</span> sce
     */</span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">contextDestroyed</span>(ServletContextEvent sce) {
        DiscoveryManager.getInstance().shutdownComponent();
    }
}</code></pre> 
<p>在web.xml中添加listener，项目在启动时进行注册到eureka Server（异步）</p> 
<p><strong>3.Eureka配置</strong></p> 
<p>在配置目录下添加config.properties文件（默认读取的文件名）添加配置：</p> 
<pre class="prettyprint"><code class=" hljs vala"><span class="hljs-preprocessor">###Eureka Client configuration for Sample Eureka Service</span>


<span class="hljs-preprocessor">#Properties based configuration for eureka client. The properties specified here is mostly what the users</span>
<span class="hljs-preprocessor">#need to change. All of these can be specified as a java system property with -D option (eg)-Deureka.region=us-east-1</span>
<span class="hljs-preprocessor">#For additional tuning options refer &lt;url to go here&gt;</span>

<span class="hljs-preprocessor">#部署应用程序的区域</span>
<span class="hljs-preprocessor"># - 对于AWS指定一个AWS区域</span>
<span class="hljs-preprocessor">#  - 对于其他数据中心，指定一个指示该区域的任意字符串。</span>
<span class="hljs-preprocessor"># 这里主要指定美国东部D</span>
eureka.region=<span class="hljs-keyword">default</span>

<span class="hljs-preprocessor">#服务指定应用名，这里指的是eureka服务本身（相当于boot中的app.name）</span>
eureka.name=o2oProject

<span class="hljs-preprocessor">#客户识别此服务的虚拟主机名，这里指的是eureka服务本身（相当于boot中的serviceId）</span>
eureka.vipAddress=o2o

<span class="hljs-preprocessor">#服务将被识别并将提供请求的端口（web服务部署的tomcat端口）</span>
eureka.port=<span class="hljs-number">8810</span>


<span class="hljs-preprocessor">#设置为false，因为该配置适用于eureka服务器本身的eureka客户端。</span>
<span class="hljs-preprocessor">#在eureka服务器中运行的eureka客户端需要连接到其他区域中的服务器。</span>
<span class="hljs-preprocessor">#对于其他应用程序，不应设置（默认为true），以实现更好的基于区域的负载平衡。</span>
eureka.preferSameZone=<span class="hljs-literal">true</span>

<span class="hljs-preprocessor">#如果要使用基于DNS的查找来确定其他eureka服务器（请参见下面的示例），请更改此选项</span>
eureka.shouldUseDns=<span class="hljs-literal">false</span>
eureka.us-east-<span class="hljs-number">1.</span>availabilityZones=<span class="hljs-keyword">default</span>
<span class="hljs-preprocessor">#由于shouldUseDns为false，因此我们使用以下属性来明确指定到eureka服务器的路由（eureka Server地址）</span>
eureka.serviceUrl.<span class="hljs-keyword">default</span>=http:<span class="hljs-comment">//localhost:7003/eureka/</span></code></pre> 
<p>以上是一些基本配置，想了解更多配置可以去看com.netflix.appinfo.EurekaInstanceConfig <br> 这里有时候会有个问题，项目会报找不到eureka Server的hostName的错，在boot中有个preferIpAdress的配置，配置后会默认使用ip访问而不是主机名hostName，在原生的eureka 中写preferIpAdress配置不会被解析读取，因此我们仿照boot的该配置做法：</p> 
<pre class="prettyprint"><code class=" hljs java"><span class="hljs-keyword">package</span> com.kowalski.web.eureka;

<span class="hljs-keyword">import</span> com.netflix.appinfo.MyDataCenterInstanceConfig;
<span class="hljs-keyword">import</span> java.net.InetAddress;
<span class="hljs-keyword">import</span> java.net.UnknownHostException;

<span class="hljs-javadoc">/**
 * Created by kowalski on 2017/5/25
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyInstanceConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">MyDataCenterInstanceConfig</span> {<!-- --></span>
    <span class="hljs-annotation">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title">getHostName</span>(<span class="hljs-keyword">boolean</span> refresh) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> InetAddress.getLocalHost().getHostAddress();
        } <span class="hljs-keyword">catch</span> (UnknownHostException e) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.getHostName(refresh);
        }
    }
}</code></pre> 
<p>到这里，在tomcat启动的时候，该节点就会注册到Eureka Server上并供其他项目正常调度，同样的，也不影响原来的zk，dubbo，调用走的都是Http请求，我们目前使用Spring web client中的Restemplate，便于对所有Http请求的统一管理（使用HttpClient连接池，统一的中文乱码处理等等），使用feignClient也可以。</p> 
<p><strong>4.简易客户端demo</strong> <br> 好久没更新了，这个还是以前用的了，很多细节也记不起来了，奉上刚写的demo供大家学习之用~ <br> <a href="https://pan.baidu.com/s/1clbu0pkdoNjgxKWDDogXFw" rel="nofollow">https://pan.baidu.com/s/1clbu0pkdoNjgxKWDDogXFw</a></p> 
<p>Email：995517265@qq.com</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/31a4ccd24e8d4447e608b6de33da557b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">找到一个适合的分布式文件系统之各种分布式文件系统优缺点对比</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a533262f0365333da0e1188ffdd331f5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">spring mvc（六）实现REST接口GET/POST/PUT/DELETE</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>