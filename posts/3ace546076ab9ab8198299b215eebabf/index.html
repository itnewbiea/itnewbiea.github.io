<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>unity urp 实现丝绸渲染 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="unity urp 实现丝绸渲染" />
<meta property="og:description" content="首先看一下实际上真实的效果
再来一张
这是专门去找的。
可以看到丝绸渲染使用了各向异性的GGX去实现，有点仿头发的感觉，接下来看一下怎么实现的。
首先，准备实现双向反射率分布函数（BRDF）的DVF项。
D项使用UE里面的各项异性GGX：
// [Burley 2012, &#34;Physically-Based Shading at Disney&#34;] float D_GGXaniso(float ax, float ay, float NoH, float XoH, float YoH) { float a2 = ax * ay; float3 V = float3(ay * XoH, ax * YoH, a2 * NoH); float S = dot(V, V); return(1.0f / PI) * a2 * Square(a2 / S); } V项使用配合D项的Vis_SmithJointAniso
// [Heitz 2014, &#34;Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs&#34;] float Vis_SmithJointAniso(float ax, float ay, float NoV, float NoL, float XoV, float XoL, float YoV, float YoL) { float Vis_SmithV = NoL * length(float3(ax * XoV, ay * YoV, NoV)); float Vis_SmithL = NoV * length(float3(ax * XoL, ay * YoL, NoL)); return 0." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3ace546076ab9ab8198299b215eebabf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-17T23:44:20+08:00" />
<meta property="article:modified_time" content="2022-10-17T23:44:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">unity urp 实现丝绸渲染</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>首先看一下实际上真实的效果<br> <img src="https://images2.imgbox.com/44/26/EFurk7wp_o.png" alt="在这里插入图片描述"><br> 再来一张<br> <img src="https://images2.imgbox.com/a4/2a/uYwrJkgT_o.png" alt="在这里插入图片描述"><br> 这是专门去找的。<br> 可以看到丝绸渲染使用了各向异性的GGX去实现，有点仿头发的感觉，接下来看一下怎么实现的。</p> 
<p>首先，准备实现双向反射率分布函数（BRDF）的DVF项。<br> D项使用UE里面的各项异性GGX：</p> 
<pre><code class="prism language-c"><span class="token comment">// [Burley 2012, "Physically-Based Shading at Disney"]</span>
<span class="token keyword">float</span> <span class="token function">D_GGXaniso</span><span class="token punctuation">(</span><span class="token keyword">float</span> ax<span class="token punctuation">,</span> <span class="token keyword">float</span> ay<span class="token punctuation">,</span> <span class="token keyword">float</span> NoH<span class="token punctuation">,</span> <span class="token keyword">float</span> XoH<span class="token punctuation">,</span> <span class="token keyword">float</span> YoH<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> a2 <span class="token operator">=</span> ax <span class="token operator">*</span> ay<span class="token punctuation">;</span>
	float3 V <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span>ay <span class="token operator">*</span> XoH<span class="token punctuation">,</span> ax <span class="token operator">*</span> YoH<span class="token punctuation">,</span> a2 <span class="token operator">*</span> NoH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> S <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>V<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span><span class="token punctuation">(</span><span class="token number">1.0f</span> <span class="token operator">/</span> PI<span class="token punctuation">)</span> <span class="token operator">*</span> a2 <span class="token operator">*</span> <span class="token function">Square</span><span class="token punctuation">(</span>a2 <span class="token operator">/</span> S<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>V项使用配合D项的Vis_SmithJointAniso</p> 
<pre><code class="prism language-c"><span class="token comment">// [Heitz 2014, "Understanding the Masking-Shadowing Function in Microfacet-Based BRDFs"]</span>
<span class="token keyword">float</span> <span class="token function">Vis_SmithJointAniso</span><span class="token punctuation">(</span><span class="token keyword">float</span> ax<span class="token punctuation">,</span> <span class="token keyword">float</span> ay<span class="token punctuation">,</span> <span class="token keyword">float</span> NoV<span class="token punctuation">,</span> <span class="token keyword">float</span> NoL<span class="token punctuation">,</span> <span class="token keyword">float</span> XoV<span class="token punctuation">,</span> <span class="token keyword">float</span> XoL<span class="token punctuation">,</span> <span class="token keyword">float</span> YoV<span class="token punctuation">,</span> <span class="token keyword">float</span> YoL<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> Vis_SmithV <span class="token operator">=</span> NoL <span class="token operator">*</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>ax <span class="token operator">*</span> XoV<span class="token punctuation">,</span> ay <span class="token operator">*</span> YoV<span class="token punctuation">,</span> NoV<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> Vis_SmithL <span class="token operator">=</span> NoV <span class="token operator">*</span> <span class="token function">length</span><span class="token punctuation">(</span><span class="token function">float3</span><span class="token punctuation">(</span>ax <span class="token operator">*</span> XoL<span class="token punctuation">,</span> ay <span class="token operator">*</span> YoL<span class="token punctuation">,</span> NoL<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token function">rcp</span><span class="token punctuation">(</span>Vis_SmithV <span class="token operator">+</span> Vis_SmithL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
这个函数里面的x就是tangent y就是bitangent 中间的o就是dot计算结果
</code></pre> 
<p>F项使用UE里面的F项：</p> 
<pre><code class="prism language-c"><span class="token comment">// [Schlick 1994, "An Inexpensive BRDF Model for Physically-Based Rendering"]</span>
float3 <span class="token function">F_Schlick_UE4</span><span class="token punctuation">(</span>float3 SpecularColor<span class="token punctuation">,</span> <span class="token keyword">float</span> VoH<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> Fc <span class="token operator">=</span> <span class="token function">Pow5</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> VoH<span class="token punctuation">)</span><span class="token punctuation">;</span>					<span class="token comment">// 1 sub, 3 mul</span>
	<span class="token comment">//return Fc + (1 - Fc) * SpecularColor;		// 1 add, 3 mad</span>
	
	<span class="token comment">// Anything less than 2% is physically impossible and is instead considered to be shadowing</span>
	<span class="token keyword">return</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token number">50.0</span> <span class="token operator">*</span> SpecularColor<span class="token punctuation">.</span>g<span class="token punctuation">)</span> <span class="token operator">*</span> Fc <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> Fc<span class="token punctuation">)</span> <span class="token operator">*</span> SpecularColor<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使用DVF项实现双向反射率分布函数：</p> 
<pre><code class="prism language-c">float3 <span class="token function">SlikBRDF</span><span class="token punctuation">(</span>float3 DiffuseColor<span class="token punctuation">,</span> float3 SpecularColor<span class="token punctuation">,</span> <span class="token keyword">float</span> Roughness<span class="token punctuation">,</span> <span class="token keyword">float</span> Anisotropy<span class="token punctuation">,</span>
float3 N<span class="token punctuation">,</span> float3 T<span class="token punctuation">,</span> float3 B<span class="token punctuation">,</span> float3 V<span class="token punctuation">,</span> float3 L<span class="token punctuation">,</span> float3 LightColor<span class="token punctuation">,</span> <span class="token keyword">float</span> Shadow<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> Alpha <span class="token operator">=</span> Roughness <span class="token operator">*</span> Roughness<span class="token punctuation">;</span>
	<span class="token keyword">float</span> a2 <span class="token operator">=</span> Alpha <span class="token operator">*</span> Alpha<span class="token punctuation">;</span>
	<span class="token comment">// Anisotropic parameters: ax and ay are the Roughness along the tangent and bitangent</span>
	<span class="token comment">// Kulla 2017, "Revisiting Physically Based Shading at Imageworks"</span>
	<span class="token keyword">float</span> ax <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>Alpha <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">+</span> Anisotropy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> ay <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>Alpha <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.0</span> <span class="token operator">-</span> Anisotropy<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 H <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>L <span class="token operator">+</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> NoH <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> NoV <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> NoL <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> VoH <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>V<span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">float</span> XoV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> XoL <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> XoH <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>T<span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> YoV <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> YoL <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> YoH <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>B<span class="token punctuation">,</span> H<span class="token punctuation">)</span><span class="token punctuation">;</span>

	float3 Radiance <span class="token operator">=</span> NoL <span class="token operator">*</span> LightColor <span class="token operator">*</span> Shadow <span class="token operator">*</span> PI<span class="token punctuation">;</span>
	
	<span class="token comment">//直接光漫反射</span>
	float3 DiffuseTerm <span class="token operator">=</span> <span class="token function">Diffuse_Lambert</span><span class="token punctuation">(</span>DiffuseColor<span class="token punctuation">)</span> <span class="token operator">*</span> Radiance<span class="token punctuation">;</span>

	<span class="token comment">//直接光镜面反射</span>
	<span class="token keyword">float</span> D <span class="token operator">=</span> <span class="token function">D_GGXaniso</span><span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> NoH<span class="token punctuation">,</span> XoH<span class="token punctuation">,</span> YoH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> Vis <span class="token operator">=</span> <span class="token function">Vis_SmithJointAniso</span><span class="token punctuation">(</span>ax<span class="token punctuation">,</span> ay<span class="token punctuation">,</span> NoV<span class="token punctuation">,</span> NoL<span class="token punctuation">,</span> XoV<span class="token punctuation">,</span> XoL<span class="token punctuation">,</span> YoV<span class="token punctuation">,</span> YoL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 F <span class="token operator">=</span> <span class="token function">F_Schlick_UE4</span><span class="token punctuation">(</span>SpecularColor<span class="token punctuation">,</span> VoH<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 SpecularTerm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>D <span class="token operator">*</span> Vis<span class="token punctuation">)</span> <span class="token operator">*</span> F<span class="token punctuation">)</span> <span class="token operator">*</span> Radiance<span class="token punctuation">;</span>

	<span class="token keyword">return</span> DiffuseTerm <span class="token operator">+</span> SpecularTerm<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其它代码，我们可以直接魔改unity的urp内置的lit函数，用于获取相关的参数，这里就不再聊了。<br> 那么，你会发现一个问题，因为GGXaniso 主要使用的是tangent和bitangent的朝向做高光的，我们平时做高光的时候都是使用法向的， 法向贴图不会影响这两个朝向啊，那么怎么办，这么办：</p> 
<pre><code class="prism language-c">    <span class="token comment">//设置T和B也受法线贴图的影响</span>
    half3 tangentTS <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>surfaceData<span class="token punctuation">.</span>normalTS<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token function">half3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _NormalAniso <span class="token operator">+</span> <span class="token function">half3</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    half3 T <span class="token operator">=</span> <span class="token function">TransformTangentToWorld</span><span class="token punctuation">(</span>tangentTS<span class="token punctuation">,</span> tangentToWorld<span class="token punctuation">)</span><span class="token punctuation">;</span>
    T <span class="token operator">=</span> <span class="token function">NormalizeNormalPerPixel</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>

    half3 bitangentTS <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>surfaceData<span class="token punctuation">.</span>normalTS<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token function">half3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> _NormalAniso <span class="token operator">+</span> <span class="token function">half3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    half3 B <span class="token operator">=</span> <span class="token function">TransformTangentToWorld</span><span class="token punctuation">(</span>bitangentTS<span class="token punctuation">,</span> tangentToWorld<span class="token punctuation">)</span><span class="token punctuation">;</span>
    B <span class="token operator">=</span> <span class="token function">NormalizeNormalPerPixel</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们用法向的x轴的量去影响切线空间下的切线的向量值，然后再将其转换到世界空间即可。<br> 直接光的函数运算如下：</p> 
<pre><code class="prism language-c">float3 <span class="token function">DirectLighting</span><span class="token punctuation">(</span>float3 DiffuseColor<span class="token punctuation">,</span> float3 SpecularColor<span class="token punctuation">,</span> <span class="token keyword">float</span> Roughness<span class="token punctuation">,</span> float3 WorldPos<span class="token punctuation">,</span> <span class="token keyword">float</span> Anisotropy<span class="token punctuation">,</span> 
	float3 N<span class="token punctuation">,</span> float3 T<span class="token punctuation">,</span> float3 B<span class="token punctuation">,</span> float3 V<span class="token punctuation">,</span> float4 shadowCoord<span class="token punctuation">,</span> float4 shadowMask<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//主光源</span>
	half3 DirectLighting_MainLight <span class="token operator">=</span> <span class="token function">half3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">{<!-- --></span>
		Light light <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span>shadowCoord<span class="token punctuation">,</span> WorldPos<span class="token punctuation">,</span> shadowMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		half3 L <span class="token operator">=</span> light<span class="token punctuation">.</span>direction<span class="token punctuation">;</span>
		half3 LightColor <span class="token operator">=</span> light<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
		half Shadow <span class="token operator">=</span> light<span class="token punctuation">.</span>shadowAttenuation<span class="token punctuation">;</span>
		DirectLighting_MainLight <span class="token operator">=</span> <span class="token function">SlikBRDF</span><span class="token punctuation">(</span>DiffuseColor<span class="token punctuation">,</span> SpecularColor<span class="token punctuation">,</span> Roughness<span class="token punctuation">,</span> Anisotropy<span class="token punctuation">,</span> N<span class="token punctuation">,</span> T<span class="token punctuation">,</span> B<span class="token punctuation">,</span> V<span class="token punctuation">,</span> L<span class="token punctuation">,</span> LightColor<span class="token punctuation">,</span> Shadow<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//附加光源</span>
	half3 DirectLighting_AddLight <span class="token operator">=</span> <span class="token function">half3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">_ADDITIONAL_LIGHTS</span></span>
		uint pixelLightCount <span class="token operator">=</span> <span class="token function">GetAdditionalLightsCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span>uint lightIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> lightIndex <span class="token operator">&lt;</span> pixelLightCount<span class="token punctuation">;</span> <span class="token operator">++</span>lightIndex<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			Light light <span class="token operator">=</span> <span class="token function">GetAdditionalLight</span><span class="token punctuation">(</span>lightIndex<span class="token punctuation">,</span> WorldPos<span class="token punctuation">,</span> shadowMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
			half3 L <span class="token operator">=</span> light<span class="token punctuation">.</span>direction<span class="token punctuation">;</span>
			half3 LightColor <span class="token operator">=</span> light<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
			half Shadow <span class="token operator">=</span> light<span class="token punctuation">.</span>shadowAttenuation <span class="token operator">*</span> light<span class="token punctuation">.</span>distanceAttenuation<span class="token punctuation">;</span>
			DirectLighting_AddLight <span class="token operator">+=</span> <span class="token function">SlikBRDF</span><span class="token punctuation">(</span>DiffuseColor<span class="token punctuation">,</span> SpecularColor<span class="token punctuation">,</span> Roughness<span class="token punctuation">,</span> Anisotropy<span class="token punctuation">,</span> N<span class="token punctuation">,</span> T<span class="token punctuation">,</span> B<span class="token punctuation">,</span> V<span class="token punctuation">,</span> L<span class="token punctuation">,</span> LightColor<span class="token punctuation">,</span> Shadow<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

	<span class="token keyword">return</span> DirectLighting_MainLight <span class="token operator">+</span> DirectLighting_AddLight<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>计算主光源和附加光源，即可实现直接光的漫反射和镜面反射。<br> <img src="https://images2.imgbox.com/eb/e7/wwCFgplD_o.png" alt="在这里插入图片描述"><br> 这是-0.9的Anisotropy的效果<br> <img src="https://images2.imgbox.com/bd/8a/TZzJku0Z_o.png" alt="在这里插入图片描述"><br> 这是Anisotropy的值为0.9的效果，当前的双向反射率分布函数，如果把Anisotropy设置为1或者-1，效果上表现会很差。</p> 
<p>环境光</p> 
<p>首先，如果在环境光镜面反射上面实现aniso的效果呢，这里有段代码：</p> 
<pre><code class="prism language-c">	<span class="token comment">//根据设置的各项异性的强度，对法向进行扭曲，实现各项异性的环境高光</span>
	float3 anisotropicDirection <span class="token operator">=</span> Anisotropy <span class="token operator">&gt;=</span> <span class="token number">0.0</span> <span class="token operator">?</span> B <span class="token operator">:</span> T<span class="token punctuation">;</span>
	float3 anisotropicTangent <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>anisotropicDirection<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 anisotropicNormal <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>anisotropicTangent<span class="token punctuation">,</span> anisotropicDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 bentNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">lerp</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> anisotropicNormal<span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span>Anisotropy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>用这个最终生成的bentNormal去替换之前的计算反射角度的N，就可以实现环境光镜面反射，效果是这样的：<br> <img src="https://images2.imgbox.com/4c/5c/cvphu3fM_o.png" alt="在这里插入图片描述"><br> 为了看效果，我故意把光滑度调高了。<br> 间接光的实现函数：</p> 
<pre><code class="prism language-c">float3 <span class="token function">IndirectLighting</span><span class="token punctuation">(</span>float3 DiffuseColor<span class="token punctuation">,</span> float3 SpecularColor<span class="token punctuation">,</span> <span class="token keyword">float</span> Roughness<span class="token punctuation">,</span> float3 WorldPos<span class="token punctuation">,</span> <span class="token keyword">float</span> Anisotropy<span class="token punctuation">,</span> 
float3 N<span class="token punctuation">,</span> float3 T<span class="token punctuation">,</span> float3 B<span class="token punctuation">,</span> float3 V<span class="token punctuation">,</span> <span class="token keyword">float</span> Occlusion<span class="token punctuation">,</span> <span class="token keyword">float</span> EnvRotation<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">float</span> NoV <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//SH</span>
	float3 DiffuseAO <span class="token operator">=</span> <span class="token function">AOMultiBounce</span><span class="token punctuation">(</span>DiffuseColor<span class="token punctuation">,</span> Occlusion<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 RadianceSH <span class="token operator">=</span> <span class="token function">SampleSH</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 IndirectDiffuse <span class="token operator">=</span> RadianceSH <span class="token operator">*</span> DiffuseColor <span class="token operator">*</span> DiffuseAO<span class="token punctuation">;</span>
	
	<span class="token comment">//根据设置的各项异性的强度，对法向进行扭曲，实现各项异性的环境高光</span>
	float3 anisotropicDirection <span class="token operator">=</span> Anisotropy <span class="token operator">&gt;=</span> <span class="token number">0.0</span> <span class="token operator">?</span> B <span class="token operator">:</span> T<span class="token punctuation">;</span>
	float3 anisotropicTangent <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>anisotropicDirection<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 anisotropicNormal <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>anisotropicTangent<span class="token punctuation">,</span> anisotropicDirection<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 bentNormal <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">lerp</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> anisotropicNormal<span class="token punctuation">,</span> <span class="token function">abs</span><span class="token punctuation">(</span>Anisotropy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//IBL</span>
	half3 R <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>V<span class="token punctuation">,</span> bentNormal<span class="token punctuation">)</span><span class="token punctuation">;</span>
	R <span class="token operator">=</span> <span class="token function">RotateDirection</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> EnvRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
	half3 SpeucularLD <span class="token operator">=</span> <span class="token function">GlossyEnvironmentReflection</span><span class="token punctuation">(</span>R<span class="token punctuation">,</span> WorldPos<span class="token punctuation">,</span> Roughness<span class="token punctuation">,</span> Occlusion<span class="token punctuation">)</span><span class="token punctuation">;</span>
	half3 SpecularDFG <span class="token operator">=</span> <span class="token function">EnvBRDFApprox</span><span class="token punctuation">(</span>SpecularColor<span class="token punctuation">,</span> Roughness<span class="token punctuation">,</span> NoV<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> SpecularOcclusion <span class="token operator">=</span> <span class="token function">GetSpecularOcclusion</span><span class="token punctuation">(</span>NoV<span class="token punctuation">,</span> <span class="token function">Pow2</span><span class="token punctuation">(</span>Roughness<span class="token punctuation">)</span><span class="token punctuation">,</span> Occlusion<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 SpecularAO <span class="token operator">=</span> <span class="token function">AOMultiBounce</span><span class="token punctuation">(</span>SpecularColor<span class="token punctuation">,</span> SpecularOcclusion<span class="token punctuation">)</span><span class="token punctuation">;</span>
	float3 IndirectSpecular <span class="token operator">=</span> SpeucularLD <span class="token operator">*</span> SpecularDFG <span class="token operator">*</span> SpecularAO<span class="token punctuation">;</span>

	<span class="token keyword">return</span> IndirectDiffuse <span class="token operator">+</span> IndirectSpecular<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>整体的效果：<br> <img src="https://images2.imgbox.com/b6/cb/mzLHMg8t_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/541306a596facb971f194c8a531df560/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">较YOLOv7精度提升1.9%，54.7mAP的PP-YOLOE&#43;强势登场！</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bad4e3ab6c5b69107838216668ffc5c8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mac下mysql修改密码</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>