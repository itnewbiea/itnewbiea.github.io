<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kubernetes(k8s)部署DolphinScheduler - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Kubernetes(k8s)部署DolphinScheduler" />
<meta property="og:description" content="1.环境准备 1.1 集群规划 本次安装环境为：3台k8s&#43;现有的mysql数据库&#43;nfs
1.2 下载及介绍 DolphinScheduler-3.2.0官网：https://dolphinscheduler.apache.org/zh-cn/download/3.2.0
官网安装文档：https://dolphinscheduler.apache.org/zh-cn/docs/3.2.0/guide/installation/kubernetes#appendix-configurationr
2.前置工作 默认k8s集群已经安装完成，本次已腾讯的TKE为例介绍
参考腾讯TKE官方文档：https://cloud.tencent.com/document/product/457/32731
2.1 Helm配置 下载 Helm 客户端 curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3 chmod 700 get_helm.sh ./get_helm.sh 如果curl无法下载可以直接网页点开后复制里面的内容，然后创建get_helm.sh文件继续操作即可
配置 Helm Chart 仓库（可选） # 执行以下命令，配置 kubernetes 官方仓库 helm repo add stable https://kubernetes-charts.storage.googleapis.com/ # 执行以下命令，配置腾讯云应用市场。 helm repo add tkemarket https://market-tke.tencentcloudcr.com/chartrepo/opensource-stable 连接集群 #执行以下命令，通过指定参数的形式访问目标集群。 helm install .... --kubeconfig [kubeconfig所在路径] # 如果警告如下：#WARNING: Kubernetes configuration file is group-readable. This is insecure. Location: /data/config，修改权限 chmod -R 600 ~/.kube/config helm常用命令举例 #helm 删除 官方仓库 helm repo remove stable #仓库管理)查看添加的chart仓库，可在这些chart仓库中拉取chart helm repo list #将chart包发布到k8s集群中安装部署 helm install releaseName chartName #列出所有已发布的版本 helm list helm list -n test helm list -A 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1789db6b914920fb3b04086663a92f8e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-26T18:37:41+08:00" />
<meta property="article:modified_time" content="2023-12-26T18:37:41+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Kubernetes(k8s)部署DolphinScheduler</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1_0"></a>1.环境准备</h2> 
<h3><a id="11__1"></a>1.1 集群规划</h3> 
<p>本次安装环境为：3台k8s+现有的mysql数据库+nfs</p> 
<h3><a id="12__3"></a>1.2 下载及介绍</h3> 
<p>DolphinScheduler-3.2.0官网：<a href="https://dolphinscheduler.apache.org/zh-cn/download/3.2.0" rel="nofollow">https://dolphinscheduler.apache.org/zh-cn/download/3.2.0</a><br> 官网安装文档：<a href="https://dolphinscheduler.apache.org/zh-cn/docs/3.2.0/guide/installation/kubernetes#appendix-configuration" rel="nofollow">https://dolphinscheduler.apache.org/zh-cn/docs/3.2.0/guide/installation/kubernetes#appendix-configurationr</a></p> 
<h2><a id="2_6"></a>2.前置工作</h2> 
<blockquote> 
 <p>默认k8s集群已经安装完成，本次已腾讯的TKE为例介绍<br> 参考腾讯TKE官方文档：<a href="https://cloud.tencent.com/document/product/457/32731" rel="nofollow">https://cloud.tencent.com/document/product/457/32731</a></p> 
</blockquote> 
<h3><a id="21_Helm_9"></a>2.1 Helm配置</h3> 
<ol><li>下载 Helm 客户端</li></ol> 
<pre><code class="prism language-bash"><span class="token function">curl</span> <span class="token parameter variable">-fsSL</span> <span class="token parameter variable">-o</span> get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
<span class="token function">chmod</span> <span class="token number">700</span> get_helm.sh
./get_helm.sh
</code></pre> 
<blockquote> 
 <p>如果curl无法下载可以直接网页点开后复制里面的内容，然后创建get_helm.sh文件继续操作即可</p> 
</blockquote> 
<ol start="2"><li>配置 Helm Chart 仓库（可选）</li></ol> 
<pre><code class="prism language-bash"><span class="token comment"># 执行以下命令，配置 kubernetes 官方仓库</span>
helm repo <span class="token function">add</span> stable https://kubernetes-charts.storage.googleapis.com/
<span class="token comment"># 执行以下命令，配置腾讯云应用市场。</span>
helm repo <span class="token function">add</span> tkemarket https://market-tke.tencentcloudcr.com/chartrepo/opensource-stable

</code></pre> 
<ol start="3"><li>连接集群</li></ol> 
<pre><code class="prism language-bash"><span class="token comment">#执行以下命令，通过指定参数的形式访问目标集群。</span>
helm  <span class="token function">install</span> <span class="token punctuation">..</span><span class="token punctuation">..</span>  <span class="token parameter variable">--kubeconfig</span> <span class="token punctuation">[</span>kubeconfig所在路径<span class="token punctuation">]</span>
<span class="token comment"># 如果警告如下：#WARNING: Kubernetes configuration file is group-readable. This is insecure. Location:  /data/config，修改权限</span>
<span class="token function">chmod</span> <span class="token parameter variable">-R</span> <span class="token number">600</span>   ~/.kube/config
</code></pre> 
<ol start="4"><li>helm常用命令举例</li></ol> 
<pre><code class="prism language-bash"><span class="token comment">#helm 删除 官方仓库</span>
helm repo remove  stable  
<span class="token comment">#仓库管理)查看添加的chart仓库，可在这些chart仓库中拉取chart</span>
helm repo list
 <span class="token comment">#将chart包发布到k8s集群中安装部署</span>
helm <span class="token function">install</span> releaseName chartName  
<span class="token comment">#列出所有已发布的版本</span>
helm list
helm list <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>
helm list <span class="token parameter variable">-A</span>
</code></pre> 
<h3><a id="22_PV_45"></a>2.2 配置PV</h3> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dol<span class="token punctuation">-</span>software
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">csi</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> com.tencent.cloud.csi.cfs
    <span class="token key atrule">volumeAttributes</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> xxx
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /software/dol_software
      <span class="token key atrule">vers</span><span class="token punctuation">:</span> <span class="token string">"4"</span>
    <span class="token comment">#   此处volumeHandle值要和下面的不同采用，否则不能同时挂载两个pv</span>
    <span class="token key atrule">volumeHandle</span><span class="token punctuation">:</span> cfs2
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> dol<span class="token punctuation">-</span>software
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> PersistentVolume
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> dol<span class="token punctuation">-</span>dolphinscheduler
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">accessModes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> ReadWriteMany
  <span class="token key atrule">capacity</span><span class="token punctuation">:</span>
    <span class="token key atrule">storage</span><span class="token punctuation">:</span> 5Gi
  <span class="token key atrule">csi</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver</span><span class="token punctuation">:</span> com.tencent.cloud.csi.cfs
    <span class="token key atrule">volumeAttributes</span><span class="token punctuation">:</span>
      <span class="token key atrule">host</span><span class="token punctuation">:</span> xxx
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /software/dolphinscheduler/data_dolphinscheduler
      <span class="token key atrule">vers</span><span class="token punctuation">:</span> <span class="token string">"4"</span>
    <span class="token key atrule">volumeHandle</span><span class="token punctuation">:</span> cfs3
  <span class="token key atrule">persistentVolumeReclaimPolicy</span><span class="token punctuation">:</span> Retain
  <span class="token key atrule">storageClassName</span><span class="token punctuation">:</span> dol<span class="token punctuation">-</span>dolphinscheduler
  <span class="token key atrule">volumeMode</span><span class="token punctuation">:</span> Filesystem
</code></pre> 
<h2><a id="3dolphinscheduler_88"></a>3.dolphinscheduler测试集群安装</h2> 
<blockquote> 
 <p>测试集群使用会单独启动一个psql以及zookeeper<br> 请下载源码包 apache-dolphinscheduler-3.2.0-src.tar.gz，<a href="https://dolphinscheduler.apache.org/zh-cn/download" rel="nofollow">下载</a><br> 发布一个名为 dolphinscheduler 的版本(release)，请执行以下命令：</p> 
</blockquote> 
<pre><code class="prism language-bash">$ <span class="token function">tar</span> <span class="token parameter variable">-zxvf</span> apache-dolphinscheduler-3.2.0-src.tar.gz
$ <span class="token builtin class-name">cd</span> apache-dolphinscheduler-3.2.0-src/deploy/kubernetes/dolphinscheduler
$ helm repo <span class="token function">add</span> bitnami https://charts.bitnami.com/bitnami
$ helm dependency update <span class="token builtin class-name">.</span>
$ helm <span class="token function">install</span> dolphinscheduler <span class="token builtin class-name">.</span> <span class="token parameter variable">--set</span> <span class="token assign-left variable">image.tag</span><span class="token operator">=</span><span class="token number">3.2</span>.0
</code></pre> 
<p>将名为 dolphinscheduler 的版本(release) 发布到 test 的命名空间中：</p> 
<pre><code class="prism language-bash">$ helm <span class="token function">install</span> dolphinscheduler <span class="token builtin class-name">.</span> <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>
</code></pre> 
<blockquote> 
 <p>提示: 如果名为 test 的命名空间被使用, 选项参数 -n test 需要添加到 helm 和 kubectl 命令中</p> 
</blockquote> 
<blockquote> 
 <p>提示: 列出所有已发布的版本，使用 helm list，PostgreSQL (用户 root, 密码 root, 数据库 dolphinscheduler) 和 ZooKeeper 服务将会默认启动</p> 
</blockquote> 
<h2><a id="4dolphinscheduler_106"></a>4.dolphinscheduler生产集群安装</h2> 
<blockquote> 
 <p>注：采用自有mysql存储元数据， ZooKeeper 服务将会默认启动</p> 
</blockquote> 
<h3><a id="41__108"></a>4.1 修改并重新构建各组件镜像</h3> 
<blockquote> 
 <p>从 3.0.0 版本起，dolphinscheduler 已经微服务化，更改元数据存储需要对把所有的服务都替换为 MySQL 驱动包，包括 dolphinscheduler-tools, dolphinscheduler-master, dolphinscheduler-worker, dolphinscheduler-api, dolphinscheduler-alert-server</p> 
</blockquote> 
<ol><li>准备工作</li></ol> 
<pre><code class="prism language-bash"><span class="token function">mkdir</span> /data
<span class="token function">cp</span> mysql-connector-java-8.0.16.jar /data
<span class="token function">tee</span>  /data/requirements.txt <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
flask
requests
EOF</span>
</code></pre> 
<ol start="2"><li>配置Dockerfile</li></ol> 
<blockquote> 
 <p>使用服务器构建</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">vim</span> docker_test.sh
<span class="token comment">#!/bin/bash</span>
<span class="token function">tee</span> /data/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-worker:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
COPY requirements.txt /tmp
RUN apt-get update &amp;&amp; \
    apt-get install -y --no-install-recommends python-pip &amp;&amp; \
    pip install --no-cache-dir -r /tmp/requirements.txt &amp;&amp; \
    pip install --no-cache-dir -U pip &amp;&amp; \
    rm -rf /var/lib/apt/lists/*
RUN apt-get update &amp;&amp; \
    apt-get install -y --no-install-recommends python3 &amp;&amp; \
    apt-get install -y --no-install-recommends python3-pip &amp;&amp; \
    rm -rf /var/lib/apt/lists/*
EOF</span>

<span class="token builtin class-name">cd</span> /data/other
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> apache/dolphinscheduler-master:mysql-driver <span class="token builtin class-name">.</span>

<span class="token function">tee</span> /data/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-master:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>

<span class="token builtin class-name">cd</span> /data/other
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> apache/dolphinscheduler-master:mysql-driver <span class="token builtin class-name">.</span>

<span class="token function">tee</span> /data/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-api:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>

<span class="token builtin class-name">cd</span> /da ta/other
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> apache/dolphinscheduler-api:mysql-driver <span class="token builtin class-name">.</span>

<span class="token function">tee</span> /data/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-alert-server:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>

<span class="token builtin class-name">cd</span> /data/other
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> apache/dolphinscheduler-alert-server:mysql-driver <span class="token builtin class-name">.</span>


<span class="token function">tee</span> /data/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-tools:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/tools/libs
EOF</span>

<span class="token builtin class-name">cd</span> /data/other
<span class="token function">docker</span> build <span class="token parameter variable">-t</span> apache/dolphinscheduler-tools:mysql-driver <span class="token builtin class-name">.</span>

</code></pre> 
<blockquote> 
 <p>使用mac本地编译（服务器太慢可以采用，需要在mac上安装docker并开启允许多架构操作）</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">vim</span> docker_test.sh
<span class="token comment">#!/bin/bash</span>
<span class="token function">tee</span> /Users/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM  dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-worker:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>
<span class="token builtin class-name">cd</span> /Users/other
<span class="token function">docker</span>  buildx  build <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64 <span class="token parameter variable">-t</span> apache/dolphinscheduler-worker:mysql-driver <span class="token builtin class-name">.</span>

<span class="token function">tee</span>  /Users/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM  dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-master:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>

<span class="token builtin class-name">cd</span> /Users/other
<span class="token function">docker</span>  buildx  build <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64  <span class="token parameter variable">-t</span> apache/dolphinscheduler-master:mysql-driver <span class="token builtin class-name">.</span>

<span class="token function">tee</span> /Users/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM   dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-api:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>

<span class="token builtin class-name">cd</span> /Users/other
<span class="token function">docker</span>  buildx  build <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64  <span class="token parameter variable">-t</span> apache/dolphinscheduler-api:mysql-driver <span class="token builtin class-name">.</span>

<span class="token function">tee</span> /Users/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM  dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-alert-server:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/libs
EOF</span>

<span class="token builtin class-name">cd</span> /Users/other
<span class="token function">docker</span>  buildx  build <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64 <span class="token parameter variable">-t</span> apache/dolphinscheduler-alert-server:mysql-driver <span class="token builtin class-name">.</span>


<span class="token function">tee</span> /Users/other/Dockerfile <span class="token operator">&lt;&lt;-</span><span class="token string">'EOF'
FROM - dolphinscheduler.docker.scarf.sh/apache/dolphinscheduler-tools:3.2.0
COPY mysql-connector-java-8.0.16.jar /opt/dolphinscheduler/tools/libs
EOF</span>

<span class="token builtin class-name">cd</span> /Users/other
<span class="token function">docker</span>  buildx  build <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64  <span class="token parameter variable">-t</span> apache/dolphinscheduler-tools:mysql-driver <span class="token builtin class-name">.</span>
</code></pre> 
<blockquote> 
 <p>运行脚本</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">nohup</span> <span class="token function">bash</span> /data/other/docker_test.sh <span class="token operator">&gt;</span> /data/other/log.txt <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
或者
<span class="token function">nohup</span> <span class="token function">bash</span> /Users/other/docker_test.sh <span class="token operator">&gt;</span> /Users/other/log.txt <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>
</code></pre> 
<ol start="3"><li>推送镜像到镜像库</li></ol> 
<blockquote> 
 <p>推送写脚本有点问题，不知道问什么,需要单独推送</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token function">docker</span> tag apache/dolphinscheduler-worker:mysql-driver storage/bigdata/dolphinscheduler-worker:mysql-driver
<span class="token function">docker</span> push storage/bigdata/dolphinscheduler-worker:mysql-driver

<span class="token function">docker</span> tag apache/dolphinscheduler-master:mysql-driver storage/bigdata/dolphinscheduler-master:mysql-driver
<span class="token function">docker</span> push storage/bigdata/dolphinscheduler-master:mysql-driver

<span class="token function">docker</span> tag apache/dolphinscheduler-api:mysql-driver storage/bigdata/dolphinscheduler-api:mysql-driver
<span class="token function">docker</span> push storage/bigdata/dolphinscheduler-api:mysql-driver

<span class="token function">docker</span> tag apache/dolphinscheduler-alert-server:mysql-driver storage/bigdata/dolphinscheduler-alert-server:mysql-driver
<span class="token function">docker</span> push storage/bigdata/dolphinscheduler-alert-server:mysql-driver

<span class="token function">docker</span> tag apache/dolphinscheduler-tools:mysql-driver storage/bigdata/dolphinscheduler-tools:mysql-driver
<span class="token function">docker</span> push storage/bigdata/dolphinscheduler-tools:mysql-driver
</code></pre> 
<h3><a id="42__247"></a>4.2 配置修改</h3> 
<h4><a id="421__248"></a>4.2.1 修改源码配置文件</h4> 
<pre><code class="prism language-bash"><span class="token function">vim</span> <span class="token punctuation">{<!-- --></span>源码地址<span class="token punctuation">}</span><span class="token punctuation">}</span>/dolphinscheduler/deploy/kubernetes
/dolphinscheduler/values.yaml

image:
  registry: <span class="token string">"storage/bigdata"</span>
  tag: <span class="token string">"mysql-driver"</span>
  pullPolicy: <span class="token string">"IfNotPresent"</span>
  pullSecret: <span class="token string">""</span>
  master: dolphinscheduler-master
  worker: dolphinscheduler-worker
  api: dolphinscheduler-api
  alert: dolphinscheduler-alert-server
  tools: dolphinscheduler-tools
<span class="token comment">#修改 values.yaml 文件中 postgresql 的 enabled 为 false</span>
postgresql:
  enabled: <span class="token boolean">false</span>
  postgresqlUsername: <span class="token string">"root"</span>
  postgresqlPassword: <span class="token string">"root"</span>
<span class="token comment">#修改 values.yaml 文件中的 externalDatabase 配置 (尤其修改 host, username 和 password)</span>
mysql:
  enabled: <span class="token boolean">false</span>
  driverClassName: <span class="token string">"com.mysql.cj.jdbc.Driver"</span>
  auth:
    username: <span class="token string">"xxx"</span>
    password: <span class="token string">"xxx"</span>
    database: <span class="token string">"dolphinscheduler"</span>
    params: <span class="token string">"characterEncoding=utf8"</span>
externalDatabase:
  enabled: <span class="token boolean">true</span>
  type: <span class="token string">"mysql"</span>
  host: <span class="token string">"xxx"</span>
  port: <span class="token string">"3306"</span>
  username: <span class="token string">"xxx"</span>
  password: <span class="token string">"xxx"</span>
  database: <span class="token string">"dolphinscheduler"</span>
  params: <span class="token string">"useUnicode=true&amp;characterEncoding=UTF-8"</span>
  driverClassName: <span class="token string">"com.mysql.cj.jdbc.Driver"</span>
<span class="token comment">#数据持久化保存，可根据需要配置master/worker等</span>
  sharedStoragePersistence:
    enabled: <span class="token boolean">true</span>
    mountPath: <span class="token string">"/opt/soft"</span>
    accessModes:
    - <span class="token string">"ReadWriteMany"</span>
    <span class="token comment">## storageClassName must support the access mode: ReadWriteMany</span>
    storageClassName: <span class="token string">"dol-software"</span>
    storage: <span class="token string">"5Gi"</span>
  <span class="token comment">## If RESOURCE_STORAGE_TYPE is HDFS and FS_DEFAULT_FS is file:///, fsFileResourcePersistence should be enabled for resource storage</span>
  fsFileResourcePersistence:
    enabled: <span class="token boolean">true</span>
    accessModes:
    - <span class="token string">"ReadWriteMany"</span>
    <span class="token comment">## storageClassName must support the access mode: ReadWriteMany</span>
    storageClassName: <span class="token string">"dol-dolphinscheduler"</span>
    storage: <span class="token string">"5Gi"</span>
<span class="token comment">#配置java最大和最小内存配置，如果dolphinscheduler启动后负载过高可以适当增大</span>
    JAVA_OPTS: <span class="token string">"-Xms1g -Xmx5g -Xmn512m"</span>

<span class="token comment">#配置说明</span>
<span class="token comment">#resource资源限制：namespace创建资源最大限制才可以配置，如不配置系统会给你的namespace配</span>

</code></pre> 
<h4><a id="422__311"></a>4.2.2 安装</h4> 
<pre><code class="prism language-bash">helm repo <span class="token function">add</span> bitnami https://charts.bitnami.com/bitnami
helm dependency update <span class="token builtin class-name">.</span>
<span class="token comment">#helm install dolphinscheduler . -f values.yaml --set image.tag=3.2.0</span>
helm <span class="token function">install</span> dolphinscheduler <span class="token builtin class-name">.</span> <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>
</code></pre> 
<h4><a id="423__318"></a>4.2.3 安装过程中问题及解决</h4> 
<blockquote> 
 <p>镜像问题</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token comment">#报错如下：</span>
<span class="token comment"># Error: INSTALLATION FAILED: An error occurred while checking for chart dependencies. You may need to run `helm dependency build` to fetch missing dependencies: found in Chart.yaml, but missing in charts/ directory: postgresql, zookeeper, mysql, minio</span>
$ helm repo <span class="token function">add</span> bitnami-full-index https://raw.githubusercontent.com/bitnami/charts/archive-full-index/bitnami
<span class="token comment">#原请求地址为：https://raw.githubusercontent.com/，国内可能连接不上，变更RAW资源加速地址：https://raw.gitmirror.com</span>
helm repo <span class="token function">add</span> bitnami-full-index  https://raw.gitmirror.com/bitnami/charts/archive-full-index/bitnami
<span class="token string">"bitnami-full-index"</span> has been added to your repositories
<span class="token comment">#重新安装</span>
helm <span class="token function">install</span> dolphinscheduler <span class="token builtin class-name">.</span> <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>

<span class="token comment">#列出所有已发布的版本</span>
helm list
helm list <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span>
helm list <span class="token parameter variable">-A</span>
</code></pre> 
<blockquote> 
 <p>其它问题</p> 
</blockquote> 
<pre><code class="prism language-bash"><span class="token comment">#问题1:dolphinscheduler Failed to obtain JDBC Connection; nested exception is com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure</span>
解决办法：配置文件加上<span class="token operator">&amp;</span><span class="token assign-left variable">useSSL</span><span class="token operator">=</span>fals
params: <span class="token string">"useSSL=false&amp;useUnicode=true&amp;characterEncoding=UTF-8&amp;allowPublicKeyRetrieval=false&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=GMT%2B8"</span>

<span class="token comment">#问题2:pod 一直CrashLoopBackOff 并且执行kubectl logs podname 报错；exec /__cacert_entrypoint.sh: exec format error</span>
<span class="token comment"># 容器镜像打包的有问题，不能在linux是使用，我用的mac，需要在mac上要开启 docker 的实验功能：</span>
experimental: <span class="token boolean">true</span>
<span class="token function">docker</span>  buildx  build <span class="token parameter variable">--platform</span><span class="token operator">=</span>linux/amd64 <span class="token parameter variable">-t</span> apache/dolphinscheduler-worker:mysql-driver <span class="token builtin class-name">.</span>

<span class="token comment">#问题3:创建租户错误 java.lang.NullPointerException: null</span>
需要将value.yaml中的配置修改为hdfs
common:
  <span class="token comment">## Configmap</span>
  configmap:
    RESOURCE_STORAGE_TYPE: <span class="token string">"HDFS"</span>
    FS_DEFAULT_FS: <span class="token string">"file:///"</span>
    DOLPHINSCHEDULER_OPTS: <span class="token string">""</span>
    DATA_BASEDIR_PATH: <span class="token string">"/tmp/dolphinscheduler"</span>
    RESOURCE_UPLOAD_PATH: <span class="token string">"/dolphinscheduler"</span>
<span class="token comment"># resource storage type: HDFS, S3, OSS, GCS, ABS, NONE</span>
    resource.storage.type: HDFS
</code></pre> 
<h4><a id="424UI_360"></a>4.2.4本地打开UI页面</h4> 
<pre><code class="prism language-bash"><span class="token comment">#当 api.service.type=ClusterIP 时，你需要执行 port-forward 端口转发命令：</span>
<span class="token comment"># kubectl port-forward --address 0.0.0.0 svc/dolphinscheduler-api 12345:12345</span>
<span class="token comment"># kubectl port-forward --address 0.0.0.0 -n test svc/dolphinscheduler-api 12345:12345</span>
<span class="token function">nohup</span> kubectl port-forward <span class="token parameter variable">--address</span> <span class="token number">0.0</span>.0.0 <span class="token parameter variable">-n</span> <span class="token builtin class-name">test</span> svc/dolphinscheduler-api <span class="token number">12345</span>:12345 <span class="token operator">&gt;</span>/dev/null  <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span><span class="token file-descriptor important">&amp;1</span> <span class="token operator">&amp;</span>

<span class="token comment"># 使用 test 命名空间</span>
<span class="token comment">#提示: 如果出现 unable to do port forwarding: socat not found 错误, 需要先安装 socat</span>
</code></pre> 
<h2><a id="5_371"></a>5.测试</h2> 
<p>访问前端页面: http://localhost:12345/dolphinscheduler/ui<br> 默认的用户是admin，默认的密码是dolphinscheduler123</p> 
<blockquote> 
 <p>localhost为配置 port-forward 端口的服务器</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/34c3aa6e11a869df4f3fda72144b636b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">tcp缓存引起的日志丢失</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bf96a9cbe5014faf7530d64e65297d25/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">直接插入排序和希尔排序</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>