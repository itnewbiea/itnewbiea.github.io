<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置" />
<meta property="og:description" content="1. Logstash介绍 Logstash是一个数据流引擎：
它是用于数据物流的开源流式ETL引擎,在几分钟内建立数据流管道,具有水平可扩展及韧性且具有自适应缓冲,不可知的数据源,具有200多个集成和处理器的插件生态系统,使用Elastic Stack监视和管理部署
Logstash包含3个主要部分： 输入(inputs)，过滤器(filters)和输出(outputs)。 inputs主要用来提供接收数据的规则，比如使用采集文件内容； filters主要是对传输的数据进行过滤，比如使用grok规则进行数据过滤； outputs主要是将接收的数据根据定义的输出模式来进行输出数据，比如输出到ElasticSearch中.
示例图:
2. Logstash安装使用 Logstash采用JRuby语言编写，运行在jvm中，因此安装Logstash前需要先安装JDK，Ruby。
Logstash需要以下版本之一：
Java 8Java 11Java 14 版本选择
https://www.elastic.co/downloads/past-releases#logstash
7.1.1版本下载地址
https://artifacts.elastic.co/downloads/logstash/logstash-7.1.1.tar.gz
2.1部署服务 $ tar xf logstash-7.1.1.tar.gz -C /usr/local/src/ ln -s /usr/local/src/logstash-7.1.1 /usr/local/logstash $ mkdir -p /data/logstash/{logs,data} 配置文件说明
logstash.yml
包含Logstash配置标志。您可以在此文件中设置标志，而不是在命令行中传递标志。您在命令行上设置的所有标志都将覆盖logstash.yml文件中的相应设置。有关更多信息，请参见logstash.yml。 pipelines.yml
包含用于在单个Logstash实例中运行多个管道的框架和说明。有关更多信息，请参见多管道。 jvm.options
包含JVM配置标志。使用此文件设置总堆空间的初始值和最大值。您也可以使用此文件设置Logstash的语言环境。在单独的行上指定每个标志。此文件中的所有其他设置都被视为专家设置。 log4j2.properties
包含log4j2库的默认设置。有关更多信息，请参见Log4j2配置。 startup.options （Linux）
包含使用的选项system-install在脚本中/usr/share/logstash/bin建立相应的启动脚本为您的系统。当您安装Logstash软件包时，该system-install脚本将在安装过程结束时执行，并使用中指定的设置startup.options来设置选项，例如用户，组，服务名称和服务描述。默认情况下，Logstash服务安装在用户下logstash。该startup.options文件使您可以更轻松地安装Logstash服务的多个实例。您可以复制文件并更改特定设置的值。请注意，startup.options启动时不会读取文件。如果要更改Logstash启动脚本（例如，要更改Logstash用户或从其他配置路径读取），则必须重新运行system-install 脚本（以root用户身份）以传入新设置。 修改logstash配置
vim /usr/local/logstash/config/logstash.yml
path.data: /data/logstash/data
path.logs: /data/logstash/logs 2.2测试服务 #进入目录
$ cd /usr/local/logstash
#启动测试
$ bin/logstash -e ‘input { stdin { } } output { stdout {} }’输入hello,显示hello安装成功 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0eab473e19026cffbfbc593b9f76ac91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-19T21:40:51+08:00" />
<meta property="article:modified_time" content="2023-09-19T21:40:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>1.   Logstash介绍</h3> 
<p>Logstash是一个数据流引擎：</p> 
<p>它是用于数据物流的开源流式ETL引擎,在几分钟内建立数据流管道,具有水平可扩展及韧性且具有自适应缓冲,不可知的数据源,具有200多个集成和处理器的插件生态系统,使用Elastic Stack监视和管理部署</p> 
<p>Logstash包含3个主要部分： 输入(inputs)，过滤器(filters)和输出(outputs)。 inputs主要用来提供接收数据的规则，比如使用采集文件内容； filters主要是对传输的数据进行过滤，比如使用grok规则进行数据过滤； outputs主要是将接收的数据根据定义的输出模式来进行输出数据，比如输出到ElasticSearch中.</p> 
<p>示例图:</p> 
<p></p> 
<p class="img-center"><img alt="Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置" height="232" src="https://images2.imgbox.com/ec/cf/QBsWnmf0_o.png" width="550"></p> 
<h3>2.   Logstash安装使用</h3> 
<p>Logstash采用JRuby语言编写，运行在jvm中，因此安装Logstash前需要先安装JDK，Ruby。</p> 
<p>Logstash需要以下版本之一：</p> 
<ul><li>Java 8</li><li>Java 11</li><li>Java 14</li></ul> 
<p>版本选择</p> 
<p><a href="https://www.elastic.co/downloads/past-releases#logstash" rel="nofollow" title="https://www.elastic.co/downloads/past-releases#logstash">https://www.elastic.co/downloads/past-releases#logstash</a></p> 
<p>7.1.1版本下载地址</p> 
<p><a href="https://artifacts.elastic.co/downloads/logstash/logstash-7.1.1.tar.gz" rel="nofollow" title="https://artifacts.elastic.co/downloads/logstash/logstash-7.1.1.tar.gz">https://artifacts.elastic.co/downloads/logstash/logstash-7.1.1.tar.gz</a></p> 
<h4>2.1部署服务</h4> 
<pre><code>$ tar xf logstash-7.1.1.tar.gz -C /usr/local/src/ ln -s /usr/local/src/logstash-7.1.1 /usr/local/logstash
$ mkdir -p /data/logstash/{logs,data}  </code></pre> 
<p><strong>配置文件说明</strong></p> 
<p><strong><code>logstash.yml</code></strong></p> 
<pre>包含Logstash配置标志。您可以在此文件中设置标志，而不是在命令行中传递标志。您在命令行上设置的所有标志都将覆盖<code>logstash.yml</code>文件中的相应设置。有关更多信息，请参见<a href="https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html" rel="nofollow" title="logstash.yml">logstash.yml</a>。</pre> 
<p><strong><code>pipelines.yml</code></strong></p> 
<pre>  包含用于在单个Logstash实例中运行多个管道的框架和说明。有关更多信息，请参见<a href="https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html" rel="nofollow" title="多管道">多管道</a>。</pre> 
<p><strong><code>jvm.options</code></strong></p> 
<pre>  包含JVM配置标志。使用此文件设置总堆空间的初始值和最大值。您也可以使用此文件设置Logstash的语言环境。在单独的行上指定每个标志。此文件中的所有其他设置都被视为专家设置。</pre> 
<p><strong><code>log4j2.properties</code></strong></p> 
<pre>包含<code>log4j2</code>库的默认设置。有关更多信息，请参见<a href="https://www.elastic.co/guide/en/logstash/current/logging.html#log4j2" rel="nofollow" title="Log4j2配置">Log4j2配置</a>。</pre> 
<p><strong><code>startup.options</code> （Linux）</strong></p> 
<pre>包含使用的选项<code>system-install</code>在脚本中<code>/usr/share/logstash/bin</code>建立相应的启动脚本为您的系统。当您安装Logstash软件包时，该<code>system-install</code>脚本将在安装过程结束时执行，并使用中指定的设置<code>startup.options</code>来设置选项，例如用户，组，服务名称和服务描述。默认情况下，Logstash服务安装在用户下<code>logstash</code>。该<code>startup.options</code>文件使您可以更轻松地安装Logstash服务的多个实例。您可以复制文件并更改特定设置的值。请注意，<code>startup.options</code>启动时不会读取文件。如果要更改Logstash启动脚本（例如，要更改Logstash用户或从其他配置路径读取），则必须重新运行<code>system-install</code> 脚本（以root用户身份）以传入新设置。</pre> 
<p><strong>修改logstash配置</strong></p> 
<p>vim /usr/local/logstash/config/logstash.yml</p> 
<table><tbody><tr><td>path.data: /data/logstash/data<br> path.logs: /data/logstash/logs  </td></tr></tbody></table> 
<h4>2.2测试服务</h4> 
<table><tbody><tr><td>#进入目录<br> $ cd /usr/local/logstash<br> #启动测试<br> $ bin/logstash -e ‘input { stdin { } } output { stdout {} }’</td></tr><tr><td>输入hello,显示hello安装成功</td></tr></tbody></table> 
<p></p> 
<p class="img-center"><img alt="Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置" height="160" src="https://images2.imgbox.com/ab/fe/1xGKfZAm_o.png" width="550"></p> 
<h4>2.3<strong>安装logstash-input-jdbc插件（建议最后安装，时间很久没有提示）</strong></h4> 
<pre>  安装logstash是一件比较蛋疼的事，因为这东西适用ruby开发的，我对ruby这东西是一点也不懂，所以比较不好弄。 如果没有gem命令的话，需要先安装一下子（root用户才可以）
  <strong>yum install gem</strong>
替换ruby镜像库为国内的库，因为国外的库，国内是访问不到的，然后国内有两个库，两个库都是可以用的： 
1、替换成ruby-china的库
  <strong>gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/</strong>
查看是否成功
  <strong>gem sources -l</strong>
2、国内还有一个库，是淘宝的：
 <strong> gem sources --add https://ruby.taobao.org/ --remove https://rubygems.org/</strong>
可以同样用gem sources -l查看是否替换成功。
替换完之后，进入logstash安装目录，修改Gemfile文件里面的数据源：
  <strong>vi Gemfile</strong>
修改成这个样子：
 <strong>source "https://gems.ruby-china.org"</strong>
如果用的用的是淘宝的库，就修改成这样
<strong> source "https://ruby.taobao.org" </strong></pre> 
<p>进入到logstash的bin下</p> 
<pre><code>cd /usr/local/logstash/
./plugin install logstash-input-jdbc</code></pre> 
<pre> 等待一整子，挺久的。</pre> 
<pre><code>Validating logstash-input-jdbc
Installing logstash-input-jdbc
Installation successful </code></pre> 
<p><strong>执行 bin/logstash-plugin list 查看情况。</strong></p> 
<p><strong>查看插件版本命令</strong></p> 
<p>bin/logstash-plugin list –verbose logstash-input-kafka</p> 
<p>同步过程中发现的坑爹问题：</p> 
<pre><strong>可以使用mysql8.0驱动包，但是驱动还是显示版本问题，正常使用就行，有些文章上面让更新插件版本，但是更新后问题依然没有解决，而且出现了更扯淡的问题，分页参数没有了，此时会出现若数据量太大数据查询不处理，日志和进程直接卡死，一直在等待查询。</strong>

提供我的jdbc插件版本。</pre> 
<p></p> 
<p class="img-center"><img alt="Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置" height="79" src="https://images2.imgbox.com/b9/a4/4XYzGqJ0_o.png" width="916"></p> 
<h4>2.4安装其他版本的jdbc插件</h4> 
<p>去github下载最新版（当前最新版本是4.3.19）zip包，下载后解压并在本地编译生成gem文件并安装。</p> 
<p>　　运行gem build logstash-input-jdbc.gemspec，生成.gem文件：</p> 
<p></p> 
<p class="img-center"><img alt="Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置" height="377" src="https://images2.imgbox.com/29/93/A8Zvi8Ty_o.png" width="657"></p> 
<p>　　运行logstash-plugin.bat install logstash-input-jdbc-4.3.19.gem，在本地安装最新版本：</p> 
<p></p> 
<p class="img-center"><img alt="Lostash同步Mysql数据到Elasticsearch（一）服务介绍及环境配置" height="199" src="https://images2.imgbox.com/b8/bb/aV9Pd9UN_o.png" width="817"></p> 
<h3>3. 环境配置及优化</h3> 
<h4>3.1查看cpu核心数修改pipeline.workers</h4> 
<table><tbody><tr><td>grep ‘core id’ /proc/cpuinfo | sort -u | wc -l vim /usr/local/logstash/config/ logstash.yml</td></tr></tbody></table> 
<h4>3.2根据资源情况调整任务执行环境参数</h4> 
<h6>设置JVM堆大小<a href="https://translate.baiducontent.com/transpage?cb=translateCallback&amp;ie=utf8&amp;source=url&amp;query=https%3A%2F%2Fgithub.com%2Felastic%2Flogstash%2Fedit%2F7.10%2Fdocs%2Fstatic%2Fconfig-details.asciidoc&amp;from=en&amp;to=zh&amp;token=&amp;monLang=zh" rel="nofollow" title="编辑">编辑</a></h6> 
<p>以下是调整JVM堆大小的一些提示：</p> 
<ul><li>建议的堆大小应不小于4GB，不超过8GB。</li><li>如果堆大小或太小，CPU利用率可能会不必要地增加，从而导致JVM不断地进行垃圾收集。您可以通过将堆大小加倍来检查此问题，以查看性能是否有所提高。</li><li>不要增加堆大小超过物理内存量。必须留下一些内存来运行操作系统和其他进程。作为大多数安装的一般指导原则，不要超过物理内存的50-75%。你有越多的内存，你可以使用的百分比就越高。</li><li>将最小（Xms）和最大（Xmx）堆分配大小设置为相同的值，以防止堆在运行时调整大小，这是一个非常昂贵的过程。</li><li>您可以使用<code>内存图</code>命令行实用程序通过Java或使用VisualVM分发。有关更多信息，请参见<a href="https://translate.baiducontent.com/transpage?cb=translateCallback&amp;ie=utf8&amp;source=url&amp;query=tuning-logstash.html%23profiling-the-heap&amp;from=en&amp;to=zh&amp;token=&amp;monLang=zh" rel="nofollow" title="分析堆">分析堆</a>.</li></ul> 
<h6>设置JVM堆栈大小<a href="https://translate.baiducontent.com/transpage?cb=translateCallback&amp;ie=utf8&amp;source=url&amp;query=https%3A%2F%2Fgithub.com%2Felastic%2Flogstash%2Fedit%2F7.10%2Fdocs%2Fstatic%2Fconfig-details.asciidoc&amp;from=en&amp;to=zh&amp;token=&amp;monLang=zh" rel="nofollow" title="编辑">编辑</a></h6> 
<p>大型配置可能需要额外的JVM堆栈内存。 如果看到堆栈溢出错误，请尝试增大JVM堆栈大小。 在<code>jvm.</code><code>选项</code> <a href="https://translate.baiducontent.com/transpage?cb=translateCallback&amp;ie=utf8&amp;source=url&amp;query=config-setting-files.html%23settings-files&amp;from=en&amp;to=zh&amp;token=&amp;monLang=zh" rel="nofollow" title="设置文件">设置文件</a>:</p> 
<pre>-Xss 4M  </pre> 
<p>请注意，默认堆栈大小因平台和操作系统风格而异。您可以通过运行以下命令找到默认值：</p> 
<pre>Java -XX:+PrintFlagsFinal-version | grep ThreadStackSize</pre> 
<p>根据默认堆栈大小，先乘以4x，然后乘以8x，再乘以16x，直到溢出错误得到解决。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4ebad9a47fe291c41da0360e5205ec6e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue项目中修改iframe嵌入的css样式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b32cd3cbd8826fcf6d64cdcd5eddda89/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Lostash同步Mysql数据到ElasticSearch（二）logstash脚本配置和常见坑点</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>