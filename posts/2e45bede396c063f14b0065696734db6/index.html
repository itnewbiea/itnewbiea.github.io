<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ansible_yaml剧本 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ansible_yaml剧本" />
<meta property="og:description" content="YAML语法 YAML最初是Yet Another Markup Language(另一种标记语言)的缩写，后来为了强调yaml是以数 据为中心重新命名为递归写法YAML Ain’t Markup Language(YAML 不是一种标记语言)。
散列表：(又叫哈希表)，有键值对组成。 示例： name: aaa age: 12 或者 {name: aaa, age: 12} 列表： 示例： - list1 - list2 - list3 或者 [list1, list2, list3] 散列表中是引用列表： 示例： name: - name1 - name2 列表中使用散列项： 示例： - name: aaa age: 18 或者 - {name: aaa, age: 18} 列表中使用列表项： 示例： - [name, age, ] 或者 - - name1 - name2 散列表中使用散列表： 示例： names1： name1: aaa name2: bbb name3: ccc names2: ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2e45bede396c063f14b0065696734db6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-11-30T09:50:24+08:00" />
<meta property="article:modified_time" content="2017-11-30T09:50:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ansible_yaml剧本</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>YAML语法 <br> YAML最初是Yet Another Markup Language(另一种标记语言)的缩写，后来为了强调yaml是以数 <br> 据为中心重新命名为递归写法YAML Ain’t <br> Markup Language(YAML 不是一种标记语言)。</p> 
<pre class="prettyprint"><code class=" hljs css">散列表：(又叫哈希表)，有键值对组成。
    示例：
        <span class="hljs-tag">name</span>: <span class="hljs-tag">aaa</span>
        <span class="hljs-tag">age</span>: 12
        或者
        <span class="hljs-rules">{<!-- --><span class="hljs-rule"><span class="hljs-attribute">name</span>:<span class="hljs-value"> aaa, age: <span class="hljs-number">12</span></span></span></span>}</code></pre> 
<pre class="prettyprint"><code class=" hljs haml">列表：
    示例：
        -<span class="ruby"> list1
</span>        -<span class="ruby"> list2
</span>        -<span class="ruby"> list3
</span>        或者
        [list1, list2, list3]</code></pre> 
<pre class="prettyprint"><code class=" hljs haml">散列表中是引用列表：
    示例：
        name:
            -<span class="ruby"> name1
</span>            -<span class="ruby"> name2</span></code></pre> 
<pre class="prettyprint"><code class=" hljs haml">列表中使用散列项：
    示例：
        -<span class="ruby"> <span class="hljs-symbol">name:</span> aaa
</span>          age: 18
        或者
        -<span class="ruby"> {<!-- --><span class="hljs-symbol">name:</span> aaa, <span class="hljs-symbol">age:</span> <span class="hljs-number">18</span>}</span></code></pre> 
<pre class="prettyprint"><code class=" hljs haml">列表中使用列表项：
    示例：
        -<span class="ruby"> [name, age, ]
</span>        或者
        -<span class="ruby">
</span>          -<span class="ruby"> name1
</span>          -<span class="ruby"> name2</span></code></pre> 
<pre class="prettyprint"><code class=" hljs lasso">散列表中使用散列表：
    示例：
        names1：
            name1: aaa
            name2: bbb
            name3: ccc
        names2:
            <span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>: <span class="hljs-built_in">..</span>
            <span class="hljs-attribute">...</span><span class="hljs-built_in">..</span>: <span class="hljs-built_in">..</span></code></pre> 
<pre class="prettyprint"><code class=" hljs mathematica">playbook组成结构：
        Inventory
        Modules
        Ad Hoc Command
        hosts
        Playbook
            Task：任务，即调用模块完成的某操作
            <span class="hljs-keyword">Variables</span>：变量
            Templates：模板
            Handlers：处理器，由某事件触发执行的操作
            Roles：角色</code></pre> 
<pre class="prettyprint"><code class=" hljs applescript">示例：
- hosts: webnodes   <span class="hljs-comment"># hosts用于指定要执行指定任务的主机，其可以是一个或多个由冒号分隔主机组</span>
  vars:
    http_port: <span class="hljs-number">80</span>
    max_clients: <span class="hljs-number">256</span>
  remote_user: root <span class="hljs-comment"># remote_user则用于指定远程主机上的执行任务的用户。remote_user也可用于各task中</span>
  tasks:    <span class="hljs-comment"># 任务列表task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成</span>
              第一个任务后再开始第二个如果中途发生错误，所有已执行任务都有可能将回滚
  - <span class="hljs-property">name</span>: ensure apache <span class="hljs-keyword">is</span> <span class="hljs-keyword">at</span> <span class="hljs-keyword">the</span> latest <span class="hljs-property">version</span>    <span class="hljs-comment"># 在众多模块中，只有command和shell模块仅需要给定</span>
  一个列表而无需使用“key=value
                                                      command: /sbin/setenforce <span class="hljs-number">0</span>
    yum: <span class="hljs-property">name</span>=httpd state=latest
  - <span class="hljs-property">name</span>: ensure apache <span class="hljs-keyword">is</span> <span class="hljs-property">running</span>
    service: <span class="hljs-property">name</span>=httpd state=started
  handlers:
    - <span class="hljs-property">name</span>: restart apache
      service: <span class="hljs-property">name</span>=httpd state=restarted

</code></pre> 
<pre class="prettyprint"><code class=" hljs lasso">运行playbook的方式：
    (<span class="hljs-number">1</span>) 测试
        ansible<span class="hljs-attribute">-playbook</span>  <span class="hljs-subst">--</span>check
            只检测可能会发生的改变，但不真正执行操作；
        ansible<span class="hljs-attribute">-playbook</span>  <span class="hljs-subst">--</span><span class="hljs-built_in">list</span><span class="hljs-attribute">-hosts</span>
            列出运行任务的主机；
        ansible<span class="hljs-attribute">-playbook</span>  <span class="hljs-subst">--</span><span class="hljs-built_in">list</span><span class="hljs-attribute">-tasks</span>
            列出要运行的任务列表
        ansible<span class="hljs-attribute">-playbook</span> <span class="hljs-subst">--</span>syntax<span class="hljs-attribute">-check</span> 
            语法检查</code></pre> 
<pre class="prettyprint"><code class=" hljs sql">handlers：
       任务，在特定条件下触发；
       接收到其它任务的通知时被触发；
           notify: <span class="hljs-operator"><span class="hljs-keyword">HANDLER</span> TASK NAME</span></code></pre> 
<p>条件式触发器</p> 
<pre class="prettyprint"><code class=" hljs applescript">- hosts: web
  remote_user: root
  tasks:
  - <span class="hljs-property">name</span>: install nginx package
    yum: <span class="hljs-property">name</span>=nginx state=latest
  - <span class="hljs-property">name</span>: start nginx service
    service: <span class="hljs-property">name</span>=nginx enabled=<span class="hljs-constant">true</span> state=started

- hosts: db
  remote_user: root
  tasks:
  - <span class="hljs-property">name</span>: install redis package
    yum: <span class="hljs-property">name</span>=redis state=latest
  - <span class="hljs-property">name</span>: install conf <span class="hljs-type">file</span>
    <span class="hljs-keyword">copy</span>: src=/root/redis.conf dest=/etc/redis.conf owner=redis group=root mode=<span class="hljs-number">644</span>
    notify: restart redis service   <span class="hljs-comment"># 引用触发器</span>
    tags: instconf
  - <span class="hljs-property">name</span>: start redis service
    service: <span class="hljs-property">name</span>=redis enabled=<span class="hljs-constant">true</span> state=started
    tags: startredis
  handlers: <span class="hljs-comment"># 定义触发器</span>
  - <span class="hljs-property">name</span>: restart redis service
    service: <span class="hljs-property">name</span>=redis state=restarted</code></pre> 
<pre class="prettyprint"><code class=" hljs applescript"><span class="hljs-comment"># 给play添加tags</span>
- hosts: web
  remote_user: root
  tags: nginx service   <span class="hljs-comment"># play添加标签</span>
  tasks:
  - <span class="hljs-property">name</span>: install nginx package
    yum: <span class="hljs-property">name</span>=nginx state=latest
  - <span class="hljs-property">name</span>: start nginx service
    service: <span class="hljs-property">name</span>=nginx enabled=<span class="hljs-constant">true</span> state=started

- hosts: db
  remote_user: root
  tags: redis service   <span class="hljs-comment"># play添加标签</span>
  tasks:
  - <span class="hljs-property">name</span>: install redis package
    yum: <span class="hljs-property">name</span>=redis state=latest
  - <span class="hljs-property">name</span>: install conf <span class="hljs-type">file</span>
    <span class="hljs-keyword">copy</span>: src=/root/redis.conf dest=/etc/redis.conf owner=redis group=root mode=<span class="hljs-number">644</span>
    notify: restart redis service
    tags: instconf
  - <span class="hljs-property">name</span>: start redis service
    service: <span class="hljs-property">name</span>=redis enabled=<span class="hljs-constant">true</span> state=started
    tags: startredis
  handlers:
  - <span class="hljs-property">name</span>: restart redis service
    service: <span class="hljs-property">name</span>=redis state=restarted


{default,<span class="hljs-type">file</span>,handlers,meta,tasks,templates,vars}</code></pre> 
<pre class="prettyprint"><code class=" hljs applescript">例子：在webserver上面安装nginx，在dbserver上面安装redis，并且redis每次修改配置
文件后，会触发重启redis服务。

打上标签后，可以只单独运行标签的那一部分
[ root@node1 ~ ]<span class="hljs-comment"># ansible-playbook -t install nginx.yaml </span>


- hosts: webserver
  remote_user: root
  tasks:                                <span class="hljs-comment">#任务</span>
  - <span class="hljs-property">name</span>: install nginx package
    yum: <span class="hljs-property">name</span>=nginx state=latest
  - <span class="hljs-property">name</span>: start nginx service
    service: <span class="hljs-property">name</span>=nginx enabled=<span class="hljs-constant">true</span> state=started

- hosts: dbserver
  remote_user: root
  tasks:                                
  - <span class="hljs-property">name</span>: install redis package
    yum: <span class="hljs-property">name</span>=redis state=latest
  - <span class="hljs-property">name</span>: install conf <span class="hljs-type">file</span>
    <span class="hljs-keyword">copy</span>: src=/root/redis.conf dest=/etc/redis.conf owner=redis group=root mode=<span class="hljs-number">644</span>
    tags: install
    notify: restart redis service       <span class="hljs-comment">#触发器，配置文件修改后会触发后面的handlers</span>
  - <span class="hljs-property">name</span>: start redis service
    service: <span class="hljs-property">name</span>=redis state=started
    tags: startredis                    <span class="hljs-comment">#使用标签</span>
  handlers:                             <span class="hljs-comment">#不主动使用，只能被前面触发.</span>
  - <span class="hljs-property">name</span>: restart redis service
    service: <span class="hljs-property">name</span>=redis state=restarted</code></pre> 
<p>变量 <br> (1) facts：可直接调用； <br> 注意：可使用setup模块直接获取目标主机的facters；</p> 
<p>(2) 用户自定义变量：</p> 
<pre class="prettyprint"><code class=" hljs livecodeserver">(<span class="hljs-operator">a</span>) ansible-playbook命令的命令行中的
    -e VARS, <span class="hljs-comment">--extra-vars=VARS</span>
    <span class="hljs-comment"># 示例：ansible-playbook test.yml --extra-vars "name=nginx user=root"  </span>
    Note：命令行的变量比playbook中的变量优先级高。</code></pre> 
<pre class="prettyprint"><code class=" hljs haml">(b) 在playbook中定义变量的方法：
    vars:
    -<span class="ruby"> <span class="hljs-symbol">var1:</span> value1
</span>    -<span class="ruby"> <span class="hljs-symbol">var2:</span> value2
</span>变量引用：{<!-- -->{ variable }}</code></pre> 
<p>例子：</p> 
<pre class="prettyprint"><code class=" hljs haml">[ root@node1 ~ ]# cat installpkc.yml 
-<span class="ruby"> <span class="hljs-symbol">hosts:</span> webserver
</span>  remote_user: root
  vars:
  -<span class="ruby"> <span class="hljs-symbol">pkgname:</span> tree
</span>  tasks:
  -<span class="ruby"> <span class="hljs-symbol">name:</span> install package {<!-- -->{ pkgname }}
</span>    yum: name={<!-- -->{ pkgname }} state=latest</code></pre> 
<pre class="prettyprint"><code class=" hljs markdown">[ root@node1 ~ ]# ansible-playbook -e "pkgname=memcached" -C installpkc.yml    #这里在命令行定义变量

PLAY [webserver] <span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-emphasis">***</span>

TASK [Gathering Facts] <span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>**
ok: [172.18.25.52]
ok: [172.18.25.51]

TASK [install package memcached] <span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span><span class="hljs-strong">*****</span>**
changed: [172.18.25.51]
changed: [172.18.25.52]</code></pre> 
<p>(3) 通过roles传递变量；</p> 
<p>(4) Host Inventory #主机清单 <br> Note：变量优先级低 <br> (a) 用户自定义变量</p> 
<pre class="prettyprint"><code class=" hljs fix"><span class="hljs-attribute">(i) 向不同的主机传递不同的变量；
                IP|HOSTNAME  varaiable</span>=<span class="hljs-string">value var2=value2</span></code></pre> 
<pre class="prettyprint"><code class=" hljs fix"><span class="hljs-attribute">例子：
[webserver]
172.18.25.51 pkgname</span>=<span class="hljs-string">redis
172.18.25.52 pkgname=memcached</span></code></pre> 
<p>(ii) 向组中的主机传递相同的变量； <br> [groupname:vars] <br> variable=value</p> 
<pre class="prettyprint"><code class=" hljs fix"><span class="hljs-attribute">例子：
    [webserver]
    172.18.25.51
    172.18.25.52

    [webserver:vars]
    pkgname</span>=<span class="hljs-string">redis
</span></code></pre> 
<p>(b) invertory参数 <br> 用于定义ansible远程连接目标主机时使用的参数，而非传递给playbook的变量；</p> 
<pre class="prettyprint"><code class=" hljs r">    ansible_ssh_host
    ansible_ssh_port
    ansible_ssh_user
    ansible_ssh_pass
    ansbile_sudo_pass
    <span class="hljs-keyword">...</span></code></pre> 
<p>例子：一种不基于密钥的连接方法，不推荐使用。</p> 
<pre class="prettyprint"><code class=" hljs fix"><span class="hljs-attribute">    [webserver]
    172.18.25.51 ansible_ssh_user</span>=<span class="hljs-string">root  ansible_ssh_pass=123
    172.18.25.52 ansible_ssh_user=root 
    ansible_ssh_pass=centos</span></code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a88370d8825fddc972b9374a7eab9754/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">elsticsearch curl 查看集群状态</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2b3612ff9d7bc46bdd009cb605e5c686/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">unity开发Android游戏环境配置、调试（真机）全过程详解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>