<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s_难产的ingress架构初体验（一） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s_难产的ingress架构初体验（一）" />
<meta property="og:description" content="在 https://editor.csdn.net/md/?articleId=106170316中跟着github中的说明进行了初体验。但是发现并不是每个模块都会用到.
github说明 后端service准备 两个version的myapp备用，并配好对应的service ame: myappsvc Namespace: default Labels: &lt;none&gt; Annotations: Selector: app=myapp Type: ClusterIP IP: 10.96.66.66 Port: &lt;unset&gt; 80/TCP TargetPort: 80/TCP Endpoints: 10.244.2.215:80,10.244.2.216:80,10.244.2.217:80 &#43; 2 more... Session Affinity: None Events: &lt;none&gt; Name: myappsvc2 Namespace: default Labels: &lt;none&gt; Annotations: Selector: app=myappsec Type: ClusterIP IP: 10.96.55.55 Port: &lt;unset&gt; 80/TCP TargetPort: 80/TCP Endpoints: 10.244.2.225:80,10.244.2.226:80,10.244.2.227:80 &#43; 2 more... Session Affinity: None 部署ingress.yaml ingress.yaml 配置
[root@test ~]# cat ingress.yaml apiVersion: extensions/v1beta1 kind: Ingress metadata: name: ingressmyapp namespace: ingress-nginx spec: rules: - host: pphqq." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f58393ec1eb4d3618cc6a88192d49908/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-05-26T23:08:21+08:00" />
<meta property="article:modified_time" content="2020-05-26T23:08:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s_难产的ingress架构初体验（一）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>在 <a href="https://editor.csdn.net/md/?articleId=106170316" rel="nofollow">https://editor.csdn.net/md/?articleId=106170316</a>中跟着github中的说明进行了初体验。但是发现并不是每个模块都会用到.</p> 
<table><thead><tr><th>github说明</th></tr></thead><tbody><tr><td><img src="https://images2.imgbox.com/34/41/VAPHookY_o.png" alt="在这里插入图片描述"></td></tr></tbody></table> 
<h2><a id="service_4"></a>后端service准备</h2> 
<ol><li>两个version的myapp备用，并配好对应的service</li></ol> 
<pre><code>ame:              myappsvc
Namespace:         default
Labels:            &lt;none&gt;
Annotations:       Selector:  app=myapp
Type:              ClusterIP
IP:                10.96.66.66
Port:              &lt;unset&gt;  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.2.215:80,10.244.2.216:80,10.244.2.217:80 + 2 more...
Session Affinity:  None
Events:            &lt;none&gt;


Name:              myappsvc2
Namespace:         default
Labels:            &lt;none&gt;
Annotations:       Selector:  app=myappsec
Type:              ClusterIP
IP:                10.96.55.55
Port:              &lt;unset&gt;  80/TCP
TargetPort:        80/TCP
Endpoints:         10.244.2.225:80,10.244.2.226:80,10.244.2.227:80 + 2 more...
Session Affinity:  None

</code></pre> 
<h2><a id="ingressyaml_32"></a>部署ingress.yaml</h2> 
<p>ingress.yaml 配置</p> 
<pre><code>[root@test ~]# cat ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingressmyapp
  namespace: ingress-nginx
spec:
  rules:
  - host: pphqq.vicp.net
    http:
     paths:
     - path: /v1
       backend:
        serviceName: myappsvc
        servicePort: 80
     - path: /v2
       backend:
        serviceName: mappsvc2
        servicePort: 80

</code></pre> 
<p>apply 以后发现有报错</p> 
<pre><code>[root@test ~]# kubectl apply -f ingress.yaml
Error from server (InternalError): error when creating "ingress.yaml": Internal error occurred: failed calling webhook "validate.nginx.ingress.kubernetes.io": Post https://ingress-nginx-controller-admission.ingress-nginx.svc:443/extensions/v1beta1/ingresses?timeout=30s: context deadline exceeded

</code></pre> 
<h3><a id="TS_1_httpsblog51ctocomjuestnow2493608httpsblog51ctocomjuestnow2493608_62"></a>TS 参考1 ：<a href="https://blog.51cto.com/juestnow/2493608" rel="nofollow">https://blog.51cto.com/juestnow/2493608</a></h3> 
<p>文中提到**# kubelet 参数node-ip 为ipv6 模式记得修改 service ipFamily: IPv6<br> 模式不然新版本webhook 会报错**</p> 
<ul><li> <p>没想到什么： 看到了 ipFamily: IPv6</p> </li><li> <p>https://github.com/kubernetes/ingress-nginx/blob/master/docs/deploy/index.md<br> <strong>提到</strong> !!! danger The admission webhook require conectivity between Kubernetes API server and the ingress controller.</p> </li><li> <p><strong>又是一个官方文档</strong> https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/<br> 文中提到**对于使用 admissionregistration.k8s.io/v1beta1 创建的 webhook 而言，其默认超时是 30 秒。**这个跟报错中timeout=30s比较像。<br> 自己跑的安装命令：<br> kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-0.32.0/deploy/static/provider/cloud/deploy.yaml<br> 修改这个文件， 在service下加了 ipFamily: IPv6 ，apply ingress.yaml 一样有报错。</p> </li></ul> 
<h3><a id="TS_2__httpsstackoverflowcomquestions61365202nginxingressserviceingressnginxcontrolleradmissionnotfoundhttpsstackoverflowcomquestions61365202nginxingressserviceingressnginxcontrolleradmissionnotfound_77"></a>TS 参考2 <a href="https://stackoverflow.com/questions/61365202/nginx-ingress-service-ingress-nginx-controller-admission-not-found" rel="nofollow">https://stackoverflow.com/questions/61365202/nginx-ingress-service-ingress-nginx-controller-admission-not-found</a></h3> 
<ul><li><strong>看起来还没解</strong></li></ul> 
<h3><a id="TS_3__httpsgithubcomkubernetesingressnginxissues5583httpsgithubcomkubernetesingressnginxissues5583_80"></a>TS 参考3 <a href="https://github.com/kubernetes/ingress-nginx/issues/5583">https://github.com/kubernetes/ingress-nginx/issues/5583</a></h3> 
<ul><li>Orz 这个老哥重装了k8s ，我还能说啥。那研究参考1吧。<br> 先看自己的log</li></ul> 
<pre><code>[root@test ~]# kubectl logs pod/ingress-nginx-controller-866488c6d4-2sz9s -n ingress-nginx
-------------------------------------------------------------------------------
NGINX Ingress controller
  Release:       0.32.0
  Build:         git-446845114
  Repository:    https://github.com/kubernetes/ingress-nginx
  nginx version: nginx/1.17.10

-------------------------------------------------------------------------------

I0519 14:42:23.085872       6 flags.go:204] Watching for Ingress class: nginx
W0519 14:42:23.086188       6 flags.go:249] SSL certificate chain completion is disabled (--enable-ssl-chain-completion=false)
W0519 14:42:23.086222       6 client_config.go:543] Neither --kubeconfig nor --master was specified.  Using the inClusterConfig.  This might not work.
I0519 14:42:23.086362       6 main.go:220] Creating API client for https://10.96.0.1:443
I0519 14:42:23.094174       6 main.go:264] Running in Kubernetes cluster version v1.18 (v1.18.2) - git (clean) commit 52c56ce7a8272c798dbc29846288d7cd9fbae032 - platform linux/amd64
I0519 14:42:23.210843       6 main.go:105] SSL fake certificate created /etc/ingress-controller/ssl/default-fake-certificate.pem
I0519 14:42:23.213364       6 main.go:113] Enabling new Ingress features available since Kubernetes v1.18
W0519 14:42:23.215404       6 main.go:125] No IngressClass resource with name nginx found. Only annotation will be used.
I0519 14:42:23.229793       6 ssl.go:528] loading tls certificate from certificate path /usr/local/certificates/cert and key path /usr/local/certificates/key
I0519 14:42:23.260220       6 nginx.go:263] Starting NGINX Ingress controller
I0519 14:42:23.276062       6 event.go:278] Event(v1.ObjectReference{Kind:"ConfigMap", Namespace:"ingress-nginx", Name:"ingress-nginx-controller", UID:"a0dec818-3429-4aec-a88a-97adba153201", APIVersion:"v1", ResourceVersion:"4033352", FieldPath:""}): type: 'Normal' reason: 'CREATE' ConfigMap ingress-nginx/ingress-nginx-controller
I0519 14:42:24.460640       6 nginx.go:307] Starting NGINX process
I0519 14:42:24.463065       6 nginx.go:327] Starting validation webhook on :8443 with keys /usr/local/certificates/cert /usr/local/certificates/key
I0519 14:42:24.463137       6 leaderelection.go:242] attempting to acquire leader lease  ingress-nginx/ingress-controller-leader-nginx...
I0519 14:42:24.463627       6 controller.go:139] Configuration changes detected, backend reload required.
I0519 14:42:24.485110       6 leaderelection.go:252] successfully acquired lease ingress-nginx/ingress-controller-leader-nginx
I0519 14:42:24.485316       6 status.go:86] new leader elected: ingress-nginx-controller-866488c6d4-2sz9s
I0519 14:42:24.537679       6 controller.go:155] Backend successfully reloaded.
I0519 14:42:24.537711       6 controller.go:164] Initial sync, sleeping for 1 second.
E0520 12:28:00.939762       6 leaderelection.go:320] error retrieving resource lock ingress-nginx/ingress-controller-leader-nginx: context deadline exceeded
I0520 12:28:00.939793       6 leaderelection.go:277] failed to renew lease ingress-nginx/ingress-controller-leader-nginx: timed out waiting for the condition
I0520 12:28:00.942992       6 leaderelection.go:242] attempting to acquire leader lease  ingress-nginx/ingress-controller-leader-nginx...
I0520 12:28:00.971606       6 leaderelection.go:252] successfully acquired lease ingress-nginx/ingress-controller-leader-nginx

</code></pre> 
<pre><code>[root@test ~]# kubectl describe svc ingress-nginx-controller-admission -n  ingress-nginx
Name:              ingress-nginx-controller-admission
Namespace:         ingress-nginx
Labels:            app.kubernetes.io/component=controller
                   app.kubernetes.io/instance=ingress-nginx
                   app.kubernetes.io/managed-by=Helm
                   app.kubernetes.io/name=ingress-nginx
                   app.kubernetes.io/version=0.32.0
                   helm.sh/chart=ingress-nginx-2.0.3
Annotations:       Selector:  app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx
Type:              ClusterIP
IP:                10.101.177.77
Port:              https-webhook  443/TCP
TargetPort:        webhook/TCP
Endpoints:         10.244.2.201:8443
Session Affinity:  None
Events:            &lt;none&gt;
</code></pre> 
<pre><code>[root@test ~]# curl https://ingress-nginx-controller-admission.ingress-nginx.svc:443
curl: (6) Could not resolve host: ingress-nginx-controller-admission.ingress-nginx.svc; Unknown error
</code></pre> 
<p><strong>无法解析？</strong><br> 检查 ingress-nginx-controller-admission.ingress-nginx.svc</p> 
<pre><code>[root@test ~]# kubectl get svc -n ingress-nginx
NAME                                 TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE
ingress-nginx-controller             LoadBalancer   10.107.164.64   &lt;pending&gt;     80:31145/TCP,443:30277/TCP   4d18h
ingress-nginx-controller-admission   ClusterIP      10.101.177.77   &lt;none&gt;        443/TCP                      4d18h

[root@test ~]# kubectl describe svc/ingress-nginx-controller-admission -n ingress-nginx
Name:              ingress-nginx-controller-admission
Namespace:         ingress-nginx
Labels:            app.kubernetes.io/component=controller
                   app.kubernetes.io/instance=ingress-nginx
                   app.kubernetes.io/managed-by=Helm
                   app.kubernetes.io/name=ingress-nginx
                   app.kubernetes.io/version=0.32.0
                   helm.sh/chart=ingress-nginx-2.0.3
Annotations:       Selector:  app.kubernetes.io/component=controller,app.kubernetes.io/instance=ingress-nginx,app.kubernetes.io/name=ingress-nginx
Type:              ClusterIP
IP:                10.101.177.77
Port:              https-webhook  443/TCP
TargetPort:        webhook/TCP
Endpoints:         10.244.2.201:8443
Session Affinity:  None
Events:            &lt;none&gt;
[root@test ~]#

</code></pre> 
<p>太艰难了 5/25，上班忙到炸。 ingress已经折磨我好久了，这篇已经磨了一礼拜。过生日前让我release这篇吧。TAT<br> dns有问题， 看一眼服务吧</p> 
<pre><code>[root@test ~]# kubectl get svc -n kube-system
NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
kube-dns   ClusterIP   10.96.0.10   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   26d
# 把dns改了
[root@test ~]# vim /etc/resolv.conf
[root@test ~]# nslookup baidu.com
Server:         10.96.0.10
Address:        10.96.0.10#53

Non-authoritative answer:
Name:   baidu.com
Address: 39.156.69.79
Name:   baidu.com
Address: 220.181.38.148

</code></pre> 
<p>还是没用<br> 又看到一篇：https://blog.csdn.net/u012986012/article/details/105453459<br> 还是提到了webhook的问题<br> 回到官网 https://kubernetes.io/zh/docs/reference/access-authn-authz/extensible-admission-controllers/<br> <strong>其中提到了失败策略</strong><br> failurePolicy 定义了如何处理 admission webhook 中无法识别的错误和超时错误。允许的值为 Ignore 或 Fail。</p> 
<p><strong>Ignore 表示调用 webhook 的错误将被忽略并且允许 API 请求继续。</strong><br> Fail 表示调用 webhook 的错误导致准入失败并且 API 请求被拒绝。</p> 
<h3><a id="ignorewebhook_200"></a>试试ignore吧或者关掉webhook?</h3> 
<p>在本片最顶上的一张图有两个关于webhook的资源<br> 一个是https_webhook, 另一个是validatingWebhookConfiguration</p> 
<p><em>即时配置 admission webhook<br> 您可以通过 ValidatingWebhookConfiguration 或者 MutatingWebhookConfiguration 动态配置哪些资源要被哪些 admission webhook 处理。</em></p> 
<p>好像找对路子了。<br> 0526 今天deadline<br> <strong>先关掉试试</strong><br> 用edit 删除这三行<br> - --validating-webhook=:8443<br> - --validating-webhook-certificate=/usr/local/certificates/cert<br> - --validating-webhook-key=/usr/local/certificates/key<br> 没啥用，<em><strong>不懂要怎么关，各位大神麻烦评论告诉我</strong></em><br> <strong>加ignore试试</strong><br> 也是用edit</p> 
<pre><code>[root@test ~]# kubectl get ValidatingWebhookConfiguration/ingress-nginx-admission -n ingress-nginx
NAME                      WEBHOOKS   AGE
ingress-nginx-admission   1          7d1h
[root@test ~]# kubectl edit ValidatingWebhookConfiguration/ingress-nginx-admission -n ingress-nginx
validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission edited
######下面是edit界面中的某一段
webhooks:
- admissionReviewVersions:
- v1beta1
clientConfig:
  caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUJPRENCM3FBREFnRUNBaEJOUUROWnBJcXR3TTJzaDg3YVVrSlpNQW9HQ0NxR1NNNDlCQU1DTUFBd0lCY04KTWpBd05URTVNVEl3TlRJMVdoZ1BNakV5TURBME1qVXhNakExTWpWYU1BQXdXVEFUQmdjcWhrak9QUUlCQmdncQpoa2pPUFFNQkJ3TkNBQVRDcWRWOWdVTm5yelY0Umg5NlIxYkl6R3lzQjE3UHJzc21CNDBGQjRPYU5MR28yMGwzCjJHYVpaTHNtN1dzblJva2FRcWpMOSs3NlBUQVBRSm9KS3BrYW96Z3dOakFPQmdOVkhROEJBZjhFQkFNQ0FnUXcKRXdZRFZSMGxCQXd3Q2dZSUt3WUJCUVVIQXdFd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBS0JnZ3Foa2pPUFFRRApBZ05KQURCR0FpRUE4K1A1WGlyOFgzREJEK1IvN2lIVWxzNXg3TW1UdjVMN1VzQzBJM3N2WmM4Q0lRQ2JSMUNpCkVOdEJ6N21CNU9KWG50RmdDblJLRkxjUVkxeWJ6bDVwTnlyZkZnPT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  service:
    name: ingress-nginx-controller-admission
    namespace: ingress-nginx
    path: /extensions/v1beta1/ingresses
    port: 443
failurePolicy: Fail             ##################改成Ignore
matchPolicy: Exact
name: validate.nginx.ingress.kubernetes.io
#########################然后重新部署ingress.yaml
[root@test ~]# kubectl apply -f ingress.yaml
ingress.extensions/ingressmyapp created   
[root@test ~]#

</code></pre> 
<p>TAT 谢天谢地。<br> <strong>但是照理说Fail不该动的，先欠着吧，这篇只是初体验。XD</strong></p> 
<h2><a id="_246"></a>验证篇</h2> 
<pre><code>[root@test ~]# kubectl get ingress -n ingress-nginx
NAME           CLASS    HOSTS            ADDRESS   PORTS   AGE
ingressmyapp   &lt;none&gt;   pphqq.vicp.net             80      11m
########在describe时发现了error ####################################
[root@test ~]# kubectl describe ingress/ingressmyapp -n ingress-nginx
Name:             ingressmyapp
Namespace:        ingress-nginx
Address:
Default backend:  default-http-backend:80 (&lt;error: endpoints "default-http-backend" not found&gt;)
###########################为什么会找不到？ 
Rules:
Host            Path  Backends
----            ----  --------
pphqq.vicp.net
                /v1   myappsvc:80 (&lt;error: endpoints "myappsvc" not found&gt;)   
                ##    **所以必须在一个ns里？ ** 改完一个以后这个变成   /v1   myappsvc:80 (&lt;none&gt;)
                /v2   mappsvc2:80 (&lt;error: endpoints "mappsvc2" not found&gt;)
                #    v2是写错服务名，重新改
Annotations:      Events:
Type            Reason  Age   From                      Message
----            ------  ----  ----                      -------
Normal          CREATE  12m   nginx-ingress-controller  Ingress ingress-nginx/ingressmyapp

</code></pre> 
<p>改完再看describe， 现在看起来都已经有了</p> 
<pre><code>[root@test ~]# kubectl describe ingress/ingressmyapp -n ingress-nginx
Name:             ingressmyapp
Namespace:        ingress-nginx
Address:
Default backend:  default-http-backend:80 (&lt;error: endpoints "default-http-backend" not found&gt;)
</code></pre> 
<p>###########################为什么会找不到？<br> #官网 Note: Depending on the Ingress controller you are using, you may need to create a default-http-backend Service.<br> Default Backend<br> An Ingress with no rules sends all traffic to a single default backend. The default backend is typically a configuration option of the Ingress controller and is not specified in your Ingress resources.</p> 
<p>If none of the hosts or paths match the HTTP request in the Ingress objects, the traffic is routed to your default backend.<br> 所以应该不影响。只有再不匹配路径是会转到默认。</p> 
<pre><code>Rules:
  Host            Path  Backends
  ----            ----  --------
  pphqq.vicp.net
                  /v1   myappsvc:80 (10.244.2.232:80,10.244.2.235:80,10.244.2.239:80 + 2 more...)
                  /v2   myappsvc2:80 (10.244.2.231:80,10.244.2.236:80,10.244.2.237:80 + 2 more...)
Annotations:      Events:
  Type            Reason  Age    From                      Message
  ----            ------  ----   ----                      -------
  Normal          CREATE  41m    nginx-ingress-controller  Ingress ingress-nginx/ingressmyapp
  Normal          CREATE  7m10s  nginx-ingress-controller  Ingress ingress-nginx/ingressmyapp
  Normal          UPDATE  77s    nginx-ingress-controller  Ingress ingress-nginx/ingressmyapp

</code></pre> 
<p>验证放在第二篇吧。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/289753cdf0453704d26271fb9b3cf21d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">网络信息安全实验 — 网络攻击技术实验（Kali系统，John、lc7、arpspoof、ettercap、SQL注入...）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/49056bb318946190f04c2cca3ab1c705/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">JDK1.8编译时提示程序包com.sun.image.codec.jpeg不存在解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>