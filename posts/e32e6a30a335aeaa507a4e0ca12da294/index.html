<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Winform入门(五) WEBAPI请求 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Winform入门(五) WEBAPI请求" />
<meta property="og:description" content="一. 需要引入: using System.Net; using System.IO; 二. 处理get请求 public static string HttpGet(string url, Dictionary&lt;string, string&gt; para) { Encoding encoding = Encoding.UTF8; WebClient webClient = new WebClient(); StringBuilder buffer = new StringBuilder(&#34;?&#34;);//这是要提交的数据 int i = 0; foreach (string key in para.Keys) { string pk = para[key].Replace(&#39;_&#39;, &#39;-&#39;); if (i &gt; 0) { buffer.AppendFormat(&#34;&amp;{0}={1}&#34;, key, pk); } else { buffer.AppendFormat(&#34;{0}={1}&#34;, key, pk); } i&#43;&#43;; } url = url &#43; buffer.ToString(); Stream stream = webClient." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e32e6a30a335aeaa507a4e0ca12da294/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-11T09:55:46+08:00" />
<meta property="article:modified_time" content="2020-08-11T09:55:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Winform入门(五) WEBAPI请求</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <article class="_2rhmJa" style="font-size: 16px;"> 
 <h2>一. 需要引入:</h2> 
 <pre class="has"><code>using System.Net;
using System.IO;</code></pre> 
 <h2>二. 处理get请求</h2> 
 <pre class="has"><code>public static string HttpGet(string url, Dictionary&lt;string, string&gt; para)
        {
            Encoding encoding = Encoding.UTF8;
            WebClient webClient = new WebClient();
            StringBuilder buffer = new StringBuilder("?");//这是要提交的数据
            int i = 0;
            foreach (string key in para.Keys)
            {
                string pk = para[key].Replace('_', '-');
                if (i &gt; 0)
                {
                    buffer.AppendFormat("&amp;{0}={1}", key, pk);
                }
                else
                {
                    buffer.AppendFormat("{0}={1}", key, pk);
                }
                i++;
            }
            url = url + buffer.ToString();

            Stream stream = webClient.OpenRead(url);
            StreamReader sr = new StreamReader(stream);
            string str = sr.ReadToEnd();
            return str;
        }</code></pre> 
 <h2>三. 处理非文件的POST请求</h2> 
 <pre class="has"><code>public static string HttpPostNoFile(string url, Dictionary&lt;string, string&gt; para)
        {
            Encoding encoding = Encoding.UTF8;
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);//webrequest请求api地址 
            request.Accept = "text/html,application/xhtml+xml,*/*";
            request.ContentType = "application/x-www-form-urlencoded; charset=UTF-8";
            request.Method = "POST";//get或者post 

            StringBuilder buffer = new StringBuilder();//这是要提交的数据
            int i = 0;
            //通过泛型集合转成要提交的参数和数据
            foreach (string key in para.Keys)
            {
                if (i &gt; 0)
                {
                    buffer.AppendFormat("&amp;{0}={1}", key, para[key]);
                }
                else
                {
                    buffer.AppendFormat("{0}={1}", key, para[key]);
                }
                i++;
            }

            byte[] bs = Encoding.UTF8.GetBytes(buffer.ToString());//UTF-8
            request.ContentLength = bs.Length;
            using (Stream reqStream = request.GetRequestStream())
            {
                reqStream.Write(bs, 0, bs.Length);
                reqStream.Close();
            }
            using (HttpWebResponse response = (HttpWebResponse)request.GetResponse())
            {
                using (StreamReader reader = new StreamReader(response.GetResponseStream(), encoding))
                {
                    return reader.ReadToEnd().ToString();
                }

            }
        }</code></pre> 
 <h2>四. 暂停一下先试一试</h2> 
 <p>这里我调用了如下API:<br> <code>[https://api.apiopen.top/getJoke?page=1&amp;count=2&amp;type=video](https://api.apiopen.top/getJoke?page=1&amp;count=2&amp;type=video)</code><br> 此API结果如下:</p> 
 <div class="image-package"> 
  <div class="image-container"> 
   <div class="image-container-fill"></div> 
   <div class="image-view" style="display:block;text-align:center;"> 
    <img src="https://images2.imgbox.com/8a/07/CkF8CgDE_o.png"> 
   </div> 
  </div> 
  <div class="image-caption"></div> 
 </div> 
 <p>程序中我得到如下结果</p> 
 <div class="image-package"> 
  <div class="image-container"> 
   <div class="image-container-fill"></div> 
   <div class="image-view" style="display:block;text-align:center;"> 
    <img src="https://images2.imgbox.com/77/60/HXkechdS_o.png"> 
   </div> 
  </div> 
  <div class="image-caption"></div> 
 </div> 
 <pre class="has"><code>Dictionary&lt;string, string&gt; getParm = new Dictionary&lt;string, string&gt; {<!-- -->{"page","1"},{"count","2"},{"type","video"}};
            string str1 = HttpGet("https://api.apiopen.top/getJoke", getParm);
            label1.Text = str1;</code></pre> 
 <p>看来是成功了!</p> 
 <h2>五. 如何把JSON字符串转为对象</h2> 
 <p>不同于JS那些亲近JSON的语言. C#转JSON要做的工作更多</p> 
 <ol><li>引入 using Newtonsoft.Json;</li><li>编写JS字符串到对象的函数</li></ol> 
 <pre class="has"><code>public static T Json2Obj&lt;T&gt;(string s)
        {
            try
            {
                return JsonConvert.DeserializeObject&lt;T&gt;(s);
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
                return default;
            }
        }</code></pre> 
 <ol start="3"><li>这里用到了泛型, 所以我们定义一个类, 调用时填充这个泛型</li></ol> 
 <p>我定义了一个<code>GET1RSP.cs</code>的类</p> 
 <pre class="has"><code>using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace autohome
{
    public class GET1RSP
    {
        public virtual string Code { get; set; }
        public virtual string Message { get; set; }
        public virtual List&lt;AMovie&gt; Result { get; set; }
    }
    public class AMovie
    {
        public string sid { get; set; }
        public string text { get; set; }
        public string type { get; set; }
        public string thumbnail { get; set; }
        public string video { get; set; }
        public string images { get; set; }
        public string up { get; set; }
        public string down { get; set; }
        public string forward { get; set; }
        public string comment { get; set; }
        public string uid { get; set; }
        public string name { get; set; }
        public string header { get; set; }
        public string top_comments_content { get; set; }
        public string top_comments_voiceuri { get; set; }
        public string top_comments_uid { get; set; }
        public string top_comments_name { get; set; }
        public string top_comments_header { get; set; }
        public string passtime { get; set; }
    }
}</code></pre> 
 <ol start="4"><li>当调用时:</li></ol> 
 <pre class="has"><code>GET1RSP test1;
test1 = Json2Obj&lt;GET1RSP&gt;(str1);</code></pre> 
 <h2>六. 对象如何转为JSON字符串??</h2> 
 <pre class="has"><code>public static string Obj2Json(object value)
        {
            return JsonConvert.SerializeObject(value);
        }</code></pre> 
 <h2>七. 你可能还会用到: 将对象转为数值</h2> 
 <pre class="has"><code>public static decimal ToDecimal(object obj, decimal defaultValue = 0)
        {
            string s = obj == null ? "" : obj.ToString();
            decimal result;
            if (!decimal.TryParse(s, out result))
            {
                result = defaultValue;
            }
            return result;
        }</code></pre> 
 <h2>八 . 下面是一个复杂一点的例子:</h2> 
 <p>这个例子中, 我们回读取一些网络小视频 然后把它列个清单, 同时还尝试把转化的对象转回JSON</p> 
 <div class="image-package"> 
  <div class="image-container"> 
   <div class="image-container-fill"></div> 
   <div class="image-view" style="display:block;text-align:center;"> 
    <img src="https://images2.imgbox.com/81/e0/GU6iGBI0_o.gif"> 
   </div> 
  </div> 
  <div class="image-caption"></div> 
 </div> 
 <p>主要代码: (创建对象的代码在第五节中)</p> 
 <pre class="has"><code>using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using System.Net;
using System.IO;
using Newtonsoft.Json;

namespace autohome
{
    public partial class Form1 : Form
    {
        GET1RSP test1;
        public static string HttpPostNoFile(string url, Dictionary&lt;string, string&gt; para)
        {
            Encoding encoding = Encoding.UTF8;
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(url);//webrequest请求api地址 
            request.Accept = "text/html,application/xhtml+xml,*/*";
            request.ContentType = "application/x-www-form-urlencoded; charset=UTF-8";
            request.Method = "POST";//get或者post 

            StringBuilder buffer = new StringBuilder();//这是要提交的数据
            int i = 0;
            //通过泛型集合转成要提交的参数和数据
            foreach (string key in para.Keys)
            {
                if (i &gt; 0)
                {
                    buffer.AppendFormat("&amp;{0}={1}", key, para[key]);
                }
                else
                {
                    buffer.AppendFormat("{0}={1}", key, para[key]);
                }
                i++;
            }

            byte[] bs = Encoding.UTF8.GetBytes(buffer.ToString());//UTF-8
            request.ContentLength = bs.Length;
            using (Stream reqStream = request.GetRequestStream())
            {
                reqStream.Write(bs, 0, bs.Length);
                reqStream.Close();
            }
            using (HttpWebResponse response = (HttpWebResponse)request.GetResponse())
            {
                using (StreamReader reader = new StreamReader(response.GetResponseStream(), encoding))
                {
                    return reader.ReadToEnd().ToString();
                }

            }
        }

        public static string HttpGet(string url, Dictionary&lt;string, string&gt; para)
        {
            Encoding encoding = Encoding.UTF8;
            WebClient webClient = new WebClient();
            StringBuilder buffer = new StringBuilder("?");//这是要提交的数据
            int i = 0;
            foreach (string key in para.Keys)
            {
                string pk = para[key].Replace('_', '-');
                if (i &gt; 0)
                {
                    buffer.AppendFormat("&amp;{0}={1}", key, pk);
                }
                else
                {
                    buffer.AppendFormat("{0}={1}", key, pk);
                }
                i++;
            }
            url = url + buffer.ToString();

            Stream stream = webClient.OpenRead(url);
            StreamReader sr = new StreamReader(stream);
            string str = sr.ReadToEnd();
            return str;
        }

        public static decimal ToDecimal(object obj, decimal defaultValue = 0)
        {
            string s = obj == null ? "" : obj.ToString();
            decimal result;
            if (!decimal.TryParse(s, out result))
            {
                result = defaultValue;
            }
            return result;
        }

        public static string Obj2Json(object value)
        {
            return JsonConvert.SerializeObject(value);
        }

        public static T Json2Obj&lt;T&gt;(string s)
        {
            try
            {
                return JsonConvert.DeserializeObject&lt;T&gt;(s);
            }
            catch (Exception ex)
            {
                Console.WriteLine(ex.Message);
                return default;
            }

        }
        public Form1()
        {
            InitializeComponent();
        }

        private void Form1_Load(object sender, EventArgs e)
        {
        }

        private void button1_Click(object sender, EventArgs e)
        {
            GetMovies();
        }

        private void button2_Click(object sender, EventArgs e)
        {
            textBox2.Text = Obj2Json(test1);
        }

        private void GetMovies()
        {

            Dictionary&lt;string, string&gt; getParm = new Dictionary&lt;string, string&gt; { { "page", numericUpDown1.Value.ToString() }, { "count", numericUpDown2.Value.ToString() }, { "type", "video" } };
            string str1 = HttpGet("https://api.apiopen.top/getJoke", getParm);
            textBox1.Text = str1;
            test1 = Json2Obj&lt;GET1RSP&gt;(str1);

            if (test1 != null)
            {
                Movie1_DES.Text = test1.Result[0].text;
                Image pic1 = Image.FromStream(WebRequest.Create(test1.Result[0].thumbnail).GetResponse().GetResponseStream());
                Movie1_PIC.Image = pic1;
                Movie2_DES.Text = test1.Result[1].text;
                Image pic2 = Image.FromStream(WebRequest.Create(test1.Result[1].thumbnail).GetResponse().GetResponseStream());
                Movie2_PIC.Image = pic2;
            }
            imageList1.Images.Clear();
            listView1.Items.Clear();
            foreach (var item in test1.Result)
            {
                Image img = Image.FromStream(WebRequest.Create(item.thumbnail).GetResponse().GetResponseStream());
                img.Tag = item.text;
             
                imageList1.Images.Add(img);
            }
            for (int i=0; i&lt;test1.Result.Count; i++) 
            {
                AMovie item = test1.Result[i];
                ListViewItem listViewItem1 = new ListViewItem();
                listViewItem1.ImageIndex = i;
                listViewItem1.SubItems.Add(item.sid);
                listViewItem1.SubItems.Add(item.text);
                listView1.Items.Add(listViewItem1);
            }
        }

        private void numericUpDown1_ValueChanged(object sender, EventArgs e)
        {
                GetMovies();
        }

        private void numericUpDown2_ValueChanged(object sender, EventArgs e)
        {
            GetMovies();
        }
    }
}</code></pre> 
</article>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2be90a1b2dc39412ffe46243a579cb30/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">判断数据类型的方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/78abbab3f3d2c440bbda028c2e46c631/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端JS正则校验密码之3种实现方式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>