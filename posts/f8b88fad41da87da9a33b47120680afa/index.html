<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>springboot集成socket服务 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="springboot集成socket服务" />
<meta property="og:description" content="1，先在配置文件中配置Socket监听的端口，由于JDK1.8中已经整合了Socket服务到java.net包中，因此不需要引入其他依赖了 在application.yml中配置下
#Socket配置 socket: port: 8503 2，配置Socket连接类，这一步类似配置一个控制器（Controller），主要用于接收客户端的连接请求，我这里将它写在了控制器类中 package com.linzhuo.app.controller; import com.linzhuo.app.service.IBusinessSocketService; import org.springframework.beans.factory.annotation.Value; import lombok.extern.slf4j.Slf4j; import org.springframework.stereotype.Component; import javax.annotation.PostConstruct; import javax.annotation.Resource; import java.io.BufferedReader; import java.io.InputStreamReader; import java.io.PrintWriter; import java.net.ServerSocket; import java.net.Socket; import java.util.concurrent.ExecutorService; import java.util.concurrent.Executors; /** * @author: jss * Date: 2023/7/25 上午10:58 */ @Slf4j @Component public class SocketServers { //注入被开放的端口 @Value(&#34;${socket.port}&#34;) private Integer port; //这个是业务处理的接口 @Resource private IBusinessSocketService socketService; @PostConstruct public void socketStart(){ //直接另起一个线程挂起Socket服务 new Thread(this::socketServer).start(); } private void socketServer() { ExecutorService executorService = Executors." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f8b88fad41da87da9a33b47120680afa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-25T14:05:27+08:00" />
<meta property="article:modified_time" content="2023-07-25T14:05:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">springboot集成socket服务</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="1SocketJDK18Socketjavanet_0"></a>1，先在配置文件中配置Socket监听的端口，由于JDK1.8中已经整合了Socket服务到java.net包中，因此不需要引入其他依赖了</h4> 
<p>在application.yml中配置下</p> 
<pre><code class="prism language-bash"><span class="token comment">#Socket配置</span>
socket:
  port: <span class="token number">8503</span>
</code></pre> 
<h4><a id="2SocketController_7"></a>2，配置Socket连接类，这一步类似配置一个控制器（Controller），主要用于接收客户端的连接请求，我这里将它写在了控制器类中</h4> 
<pre><code class="prism language-bash">package com.linzhuo.app.controller<span class="token punctuation">;</span>

<span class="token function">import</span> com.linzhuo.app.service.IBusinessSocketService<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.beans.factory.annotation.Value<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.extern.slf4j.Slf4j<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Component<span class="token punctuation">;</span>

<span class="token function">import</span> javax.annotation.PostConstruct<span class="token punctuation">;</span>
<span class="token function">import</span> javax.annotation.Resource<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.BufferedReader<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.InputStreamReader<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.PrintWriter<span class="token punctuation">;</span>
<span class="token function">import</span> java.net.ServerSocket<span class="token punctuation">;</span>
<span class="token function">import</span> java.net.Socket<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.concurrent.ExecutorService<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.concurrent.Executors<span class="token punctuation">;</span>

/**
 * @author: jss
 * Date: <span class="token number">2023</span>/7/25 上午10:58
 */
@Slf4j
@Component
public class SocketServers <span class="token punctuation">{<!-- --></span>

    //注入被开放的端口
    @Value<span class="token punctuation">(</span><span class="token string">"<span class="token variable">${socket.port}</span>"</span><span class="token punctuation">)</span>
    private Integer port<span class="token punctuation">;</span>

    //这个是业务处理的接口
    @Resource
    private IBusinessSocketService socketService<span class="token punctuation">;</span>

    @PostConstruct
    public void <span class="token function-name function">socketStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        //直接另起一个线程挂起Socket服务
        new Thread<span class="token punctuation">(</span>this::socketServer<span class="token punctuation">)</span>.start<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private void <span class="token function-name function">socketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ExecutorService executorService <span class="token operator">=</span> Executors.newFixedThreadPool<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        try <span class="token punctuation">(</span>ServerSocket serverSocket <span class="token operator">=</span> new ServerSocket<span class="token punctuation">(</span>port<span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
            log.info<span class="token punctuation">(</span><span class="token string">"socket端口在:{}中开启并持续监听=====&gt;"</span>, port<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>Boolean.TRUE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                Socket clientSocket <span class="token operator">=</span> serverSocket.accept<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                //设置流读取的超时时间,这里设置为10s。超时后自动断开连接
                clientSocket.setSoTimeout<span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                //是否与客户端保持持续连接,这行代码在本示例中,并没有作用,因为后面的逻辑处理完成后,会自动断开连接.
                clientSocket.setKeepAlive<span class="token punctuation">(</span>Boolean.TRUE<span class="token punctuation">)</span><span class="token punctuation">;</span>
                log.info<span class="token punctuation">(</span><span class="token string">"发现客户端连接Socket:{}:{}===========&gt;"</span>, clientSocket.getInetAddress<span class="token punctuation">(</span><span class="token punctuation">)</span>.getHostAddress<span class="token punctuation">(</span><span class="token punctuation">)</span>,
                        clientSocket.getPort<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
                //这里通过线程池启动ClientHandler方法中的run方法.
                executorService.execute<span class="token punctuation">(</span>new ClientHandler<span class="token punctuation">(</span>clientSocket, socketService<span class="token punctuation">))</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.error<span class="token punctuation">(</span><span class="token string">"Socket服务启动异常!"</span>, e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


    public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        requestInfoToSocketServer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private static void <span class="token function-name function">requestInfoToSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">(</span>Socket socket <span class="token operator">=</span> new Socket<span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span>, <span class="token number">8503</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             PrintWriter out <span class="token operator">=</span> new PrintWriter<span class="token punctuation">(</span>socket.getOutputStream<span class="token punctuation">(</span><span class="token punctuation">)</span>, <span class="token boolean">true</span><span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
//            Object phone <span class="token operator">=</span> <span class="token string">"15210161743"</span><span class="token punctuation">;</span>
            out.write<span class="token punctuation">(</span><span class="token string">"15210161743"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out.flush<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //记得调用shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span>方法,否则服务端的流读取会一直等待
            socket.shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //开始接收服务端的消息
            BufferedReader <span class="token keyword">in</span> <span class="token operator">=</span> new BufferedReader<span class="token punctuation">(</span>new InputStreamReader<span class="token punctuation">(</span>socket.getInputStream<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System.out.println<span class="token punctuation">(</span><span class="token string">"接收到服务端的回复:"</span> + in.readLine<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System.out.println<span class="token punctuation">(</span><span class="token string">"Socket传输数据异常!"</span> + e.getMessage<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="3_94"></a>3，配置自定义客户端类，这里也将写在了控制器类中，也可以自己去写在其他文件夹里</h4> 
<pre><code class="prism language-bash">package com.linzhuo.app.controller<span class="token punctuation">;</span>

<span class="token function">import</span> com.linzhuo.app.service.IBusinessSocketService<span class="token punctuation">;</span>
<span class="token function">import</span> com.linzhuo.app.util.SnowFlakeUtil<span class="token punctuation">;</span>
<span class="token function">import</span> com.linzhuo.app.util.StringUtil<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.SneakyThrows<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.extern.slf4j.Slf4j<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.util.StringUtils<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.IOException<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.PrintWriter<span class="token punctuation">;</span>
<span class="token function">import</span> java.net.Socket<span class="token punctuation">;</span>
<span class="token function">import</span> java.util.concurrent.TimeUnit<span class="token punctuation">;</span>

/**
 * @author: jss
 * Date: <span class="token number">2023</span>/7/25 上午11:06
 */
@Slf4j
public class ClientHandler implements Runnable <span class="token punctuation">{<!-- --></span>

    private final Socket clientSocket<span class="token punctuation">;</span>

    private final IBusinessSocketService socketService<span class="token punctuation">;</span>

    public ClientHandler<span class="token punctuation">(</span>Socket clientSocket, IBusinessSocketService socketService<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this.clientSocket <span class="token operator">=</span> clientSocket<span class="token punctuation">;</span>
        this.socketService <span class="token operator">=</span> socketService<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    @Override
    @SneakyThrows
    public void <span class="token function-name function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        //SnowFlakeUtil 雪花ID生成工具类,后面会统一给出
        String logId <span class="token operator">=</span> SnowFlakeUtil.getId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String hostIp <span class="token operator">=</span> clientSocket.getInetAddress<span class="token punctuation">(</span><span class="token punctuation">)</span>.getHostAddress<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String port <span class="token operator">=</span> String.valueOf<span class="token punctuation">(</span>clientSocket.getPort<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        try <span class="token punctuation">(</span>PrintWriter out <span class="token operator">=</span> new PrintWriter<span class="token punctuation">(</span>clientSocket.getOutputStream<span class="token punctuation">(</span><span class="token punctuation">)</span>, Boolean.TRUE<span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
            //这里的StringUtil是自己写的工具类,后面会统一给出
            String requestInfo <span class="token operator">=</span> StringUtil.readToStreamToString<span class="token punctuation">(</span>clientSocket.getInputStream<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestInfo <span class="token operator">!=</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                log.info<span class="token punctuation">(</span><span class="token string">"监听到客户端消息:{},监听日志ID为:{}"</span>, requestInfo, logId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                socketService.executeBusinessCode<span class="token punctuation">(</span>requestInfo, logId, out<span class="token punctuation">)</span><span class="token punctuation">;</span>
                clientSocket.shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                TimeUnit.<span class="token environment constant">SECONDS</span>.sleep<span class="token punctuation">(</span>1L<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>IOException e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.error<span class="token punctuation">(</span><span class="token string">"与客户端:[{}:{}]通信异常!错误信息:{}"</span>, hostIp, port, e.getMessage<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> finally <span class="token punctuation">{<!-- --></span>
            log.info<span class="token punctuation">(</span><span class="token string">"客户端:[{}:{}]Socket连接已关闭,日志ID为:{}========&gt;"</span>, hostIp, port, logId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="4service_152"></a>4，定义业务接口，service类</h4> 
<pre><code class="prism language-bash">package com.linzhuo.app.service<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.PrintWriter<span class="token punctuation">;</span>

/**
 * @author: jss
 * Date: <span class="token number">2023</span>/7/25 上午11:11
 */
public interface IBusinessSocketService <span class="token punctuation">{<!-- --></span>
    /**
     * 从Socket中接受消息并处理
     *
     * @param requestInfo 请求报文
     * @param logId       日志ID
     * @param writer      回写给客户端消息的回写类<span class="token punctuation">(</span>Socket自带<span class="token punctuation">)</span>
     */
    void executeBusinessCode<span class="token punctuation">(</span>String requestInfo, String logId, PrintWriter writer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="5serviceImpl_174"></a>5，定义业务实现类，serviceImpl</h4> 
<pre><code class="prism language-bash">package com.linzhuo.app.service.impl<span class="token punctuation">;</span>

<span class="token function">import</span> com.linzhuo.app.service.IBusinessSocketService<span class="token punctuation">;</span>
<span class="token function">import</span> lombok.extern.slf4j.Slf4j<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.stereotype.Service<span class="token punctuation">;</span>
<span class="token function">import</span> org.springframework.util.StringUtils<span class="token punctuation">;</span>

<span class="token function">import</span> javax.annotation.Resource<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.PrintWriter<span class="token punctuation">;</span>

/**
 * @author: jss
 * Date: <span class="token number">2023</span>/7/25 上午11:12
 */
@Slf4j
@Service
public class IBusinessSocketServiceImpl implements IBusinessSocketService <span class="token punctuation">{<!-- --></span>

    @Resource
    LzLoginServiceImpl loginService<span class="token punctuation">;</span>
    @Override
    public void executeBusinessCode<span class="token punctuation">(</span>String requestInfo, String logId, PrintWriter writer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Object responseMsg<span class="token punctuation">;</span>
        boolean isSuccess <span class="token operator">=</span> Boolean.TRUE<span class="token punctuation">;</span>
        try <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>StringUtils.isEmpty<span class="token punctuation">(</span>requestInfo<span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
                <span class="token builtin class-name">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            //执行你的业务操作
            log.info<span class="token punctuation">(</span><span class="token string">"接收到的手机为:{}"</span>, requestInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
//            responseMsg <span class="token operator">=</span> <span class="token string">"回填给客户端的信息,可以是任何格式的对象34"</span><span class="token punctuation">;</span>
//这里调用了自己的其他接口，接收客户端发送的手机号 ，进行发送验证码
            Object phoneCode <span class="token operator">=</span> loginService.getPhoneCode<span class="token punctuation">(</span>requestInfo, <span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseMsg <span class="token operator">=</span> phoneCode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            isSuccess <span class="token operator">=</span> Boolean.FALSE<span class="token punctuation">;</span>
            e.printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseMsg <span class="token operator">=</span> <span class="token string">"回填给客户端的信息(业务处理错误的情况下)"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        try <span class="token punctuation">{<!-- --></span>
            //将响应报文通过PrintWriter回写给客户端
            writer.println<span class="token punctuation">(</span>responseMsg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            log.error<span class="token punctuation">(</span><span class="token string">"Socket客户端数据返回异常!当前日志ID:[{}],异常信息:{}"</span>, logId, e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="6_226"></a>6，两个相关的工具类</h4> 
<p>第一个SnowFlakeUtil</p> 
<pre><code class="prism language-bash">package com.linzhuo.app.util<span class="token punctuation">;</span>

/**************************************************
 * copyright <span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token number">2022</span>
 * created by jss
 * date:       <span class="token number">2022</span>-9-18
 * description: 雪花算法工具类
 *
 **************************************************/
public class SnowFlakeUtil <span class="token punctuation">{<!-- --></span>

    private long workerId<span class="token punctuation">;</span>
    private long datacenterId<span class="token punctuation">;</span>
    private long sequence <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
    private long twepoch <span class="token operator">=</span> 1288834974657L<span class="token punctuation">;</span>                              //  Thu, 04 Nov <span class="token number">2010</span> 01:42:54 GMT 标记时间 用来计算偏移量，距离当前时间不同，得到的数据的位数也不同
    private long workerIdBits <span class="token operator">=</span> 5L<span class="token punctuation">;</span>                                     //  物理节点ID长度
    private long datacenterIdBits <span class="token operator">=</span> 5L<span class="token punctuation">;</span>                                 //  数据中心ID长度
    private long maxWorkerId <span class="token operator">=</span> <span class="token parameter variable">-1L</span> ^ <span class="token punctuation">(</span>-1L <span class="token operator">&lt;&lt;</span> workerIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>             //  最大支持机器节点数0~31，一共32个
    private long maxDatacenterId <span class="token operator">=</span> <span class="token parameter variable">-1L</span> ^ <span class="token punctuation">(</span>-1L <span class="token operator">&lt;&lt;</span> datacenterIdBits<span class="token punctuation">)</span><span class="token punctuation">;</span>     //  最大支持数据中心节点数0~31，一共32个
    private long sequenceBits <span class="token operator">=</span> 12L<span class="token punctuation">;</span>                                    //  序列号12位， <span class="token number">4095</span>，同毫秒内生成不同id的最大个数
    private long workerIdShift <span class="token operator">=</span> sequenceBits<span class="token punctuation">;</span>                          //  机器节点左移12位
    private long datacenterIdShift <span class="token operator">=</span> sequenceBits + workerIdBits<span class="token punctuation">;</span>       //  数据中心节点左移17位
    private long timestampLeftShift <span class="token operator">=</span> sequenceBits + workerIdBits + datacenterIdBits<span class="token punctuation">;</span> //  时间毫秒数左移22位
    private long sequenceMask <span class="token operator">=</span> <span class="token parameter variable">-1L</span> ^ <span class="token punctuation">(</span>-1L <span class="token operator">&lt;&lt;</span> sequenceBits<span class="token punctuation">)</span><span class="token punctuation">;</span>                          // 用于和当前时间戳做比较，以获取最新时间
    private long lastTimestamp <span class="token operator">=</span> -1L<span class="token punctuation">;</span>

    //成员类，SnowFlakeUtil的实例对象的保存域
    private static class IdGenHolder <span class="token punctuation">{<!-- --></span>
        private static final SnowFlakeUtil instance <span class="token operator">=</span> new SnowFlakeUtil<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    //外部调用获取SnowFlakeUtil的实例对象，确保不可变
    public static SnowFlakeUtil <span class="token function-name function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> IdGenHolder.instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    //初始化构造，无参构造有参函数，默认节点都是0
    public <span class="token function-name function">SnowFlakeUtil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        this<span class="token punctuation">(</span>0L, 0L<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    //设置机器节点和数据中心节点数，都是 <span class="token number">0</span>-31
    public SnowFlakeUtil<span class="token punctuation">(</span>long workerId, long datacenterId<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>workerId <span class="token operator">&gt;</span> maxWorkerId <span class="token operator">||</span> workerId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw new IllegalArgumentException<span class="token punctuation">(</span>String.format<span class="token punctuation">(</span><span class="token string">"worker Id can't be greater than %d or less than 0"</span>, maxWorkerId<span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">&gt;</span> maxDatacenterId <span class="token operator">||</span> datacenterId <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw new IllegalArgumentException<span class="token punctuation">(</span>String.format<span class="token punctuation">(</span><span class="token string">"datacenter Id can't be greater than %d or less than 0"</span>, maxDatacenterId<span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        this.workerId <span class="token operator">=</span> workerId<span class="token punctuation">;</span>
        this.datacenterId <span class="token operator">=</span> datacenterId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    //线程安全的id生成方法
    @SuppressWarnings<span class="token punctuation">(</span><span class="token string">"all"</span><span class="token punctuation">)</span>
    public synchronized long <span class="token function-name function">nextId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        //获取当前毫秒数
        long timestamp <span class="token operator">=</span> timeGen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        //如果服务器时间有问题<span class="token punctuation">(</span>时钟后退<span class="token punctuation">)</span> 报错。
        <span class="token keyword">if</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            throw new RuntimeException<span class="token punctuation">(</span>String.format<span class="token punctuation">(</span>
                    <span class="token string">"Clock moved backwards.  Refusing to generate id for %d milliseconds"</span>, lastTimestamp - timestamp<span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        //如果上次生成时间和当前时间相同,在同一毫秒内
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lastTimestamp <span class="token operator">==</span> timestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            //sequence自增，因为sequence只有12bit，所以和sequenceMask相与一下，去掉高位
            sequence <span class="token operator">=</span> <span class="token punctuation">(</span>sequence + <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> sequenceMask<span class="token punctuation">;</span>
            //判断是否溢出,也就是每毫秒内超过4095，当为4096时，与sequenceMask相与，sequence就等于0
            <span class="token keyword">if</span> <span class="token punctuation">(</span>sequence <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                //自旋等待到下一毫秒
                timestamp <span class="token operator">=</span> tilNextMillis<span class="token punctuation">(</span>lastTimestamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            //如果和上次生成时间不同,重置sequence，就是下一毫秒开始，sequence计数重新从0开始累加，每个毫秒时间内，都是从0开始计数，最大4095
            sequence <span class="token operator">=</span> 0L<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        lastTimestamp <span class="token operator">=</span> timestamp<span class="token punctuation">;</span>
        // 最后按照规则拼出ID <span class="token number">64</span>位
        // 000000000000000000000000000000000000000000  00000            00000       000000000000
        //1位固定整数   <span class="token function">time</span>                                       datacenterId   workerId    sequence
        <span class="token builtin class-name">return</span> <span class="token punctuation">((</span>timestamp - twepoch<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> timestampLeftShift<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>datacenterId <span class="token operator">&lt;&lt;</span> datacenterIdShift<span class="token punctuation">)</span>
                <span class="token operator">|</span> <span class="token punctuation">(</span>workerId <span class="token operator">&lt;&lt;</span> workerIdShift<span class="token punctuation">)</span> <span class="token operator">|</span> sequence<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    //比较当前时间和过去时间，防止时钟回退（机器问题），保证给的都是最新时间/最大时间
    protected long tilNextMillis<span class="token punctuation">(</span>long lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        long timestamp <span class="token operator">=</span> timeGen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>timestamp <span class="token operator">&lt;=</span> lastTimestamp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            timestamp <span class="token operator">=</span> timeGen<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> timestamp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    //获取当前的时间戳（毫秒）
    protected long <span class="token function-name function">timeGen</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token builtin class-name">return</span> System.currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    /**
     * 获取全局唯一编码
     */
    public static String <span class="token function-name function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        long <span class="token function">id</span> <span class="token operator">=</span> SnowFlakeUtil.get<span class="token punctuation">(</span><span class="token punctuation">)</span>.nextId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token builtin class-name">return</span> Long.toString<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

</code></pre> 
<p>第二个工具类为StringUtil</p> 
<pre><code class="prism language-bash">package com.linzhuo.app.util<span class="token punctuation">;</span>

<span class="token function">import</span> lombok.SneakyThrows<span class="token punctuation">;</span>

<span class="token function">import</span> java.io.ByteArrayOutputStream<span class="token punctuation">;</span>
<span class="token function">import</span> java.io.InputStream<span class="token punctuation">;</span>

/**
 * <span class="token operator">&lt;</span>Description<span class="token operator">&gt;</span> ******
 *
 * @author jss
 * @version <span class="token number">1.0</span>
 * @date <span class="token number">2022</span>/04/17
 */
public class StringUtil <span class="token punctuation">{<!-- --></span>

    @SneakyThrows
    public static String readToStreamToString<span class="token punctuation">(</span>InputStream is<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ByteArrayOutputStream bos <span class="token operator">=</span> new ByteArrayOutputStream<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        byte<span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> new byte<span class="token punctuation">[</span><span class="token number">2048</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        int bytesRead<span class="token punctuation">;</span>
        /*
        这一步可能会卡住,因为客户端如果传输完数据以后,
        如果没有调用socket.shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span>方法,会导致服务端不知道流是否已传输完毕,
        等待我们之前设置的10S流读取时间后,连接就会被自动关掉
        如果出现这种情况,服务端可以通过其它方式判断。例如换行符或者特殊字符等,只需要在
        while条件中加一个<span class="token operator">&amp;&amp;</span>判断即可.例如我这里的业务结束标记是字符: <span class="token string">"&gt;"</span>,那么判断逻辑如下
        若客户端调用了shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span>方法,则不需要这个判断
        */
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>bos.toString<span class="token punctuation">(</span><span class="token punctuation">)</span>.contains<span class="token punctuation">(</span><span class="token string">"&gt;"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>bytesRead <span class="token operator">=</span> is.read<span class="token punctuation">(</span>buffer<span class="token punctuation">))</span> <span class="token operator">!=</span> -1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            bos.write<span class="token punctuation">(</span>buffer, <span class="token number">0</span>, bytesRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token builtin class-name">return</span> bos.toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="7MainSpringboot_379"></a>7,最后测试一下，用Main方法或者另外一个Springboot项目</h4> 
<pre><code class="prism language-bash">public static void main<span class="token punctuation">(</span>String<span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> throws Exception <span class="token punctuation">{<!-- --></span>
        requestInfoToSocketServer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    private static void <span class="token function-name function">requestInfoToSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        try <span class="token punctuation">(</span>Socket socket <span class="token operator">=</span> new Socket<span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span>, <span class="token number">8503</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             PrintWriter out <span class="token operator">=</span> new PrintWriter<span class="token punctuation">(</span>socket.getOutputStream<span class="token punctuation">(</span><span class="token punctuation">)</span>, <span class="token boolean">true</span><span class="token punctuation">))</span> <span class="token punctuation">{<!-- --></span>
//            Object phone <span class="token operator">=</span> <span class="token string">"15210161743"</span><span class="token punctuation">;</span>
            out.write<span class="token punctuation">(</span><span class="token string">"15210161743"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out.flush<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //记得调用shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span>方法,否则服务端的流读取会一直等待
            socket.shutdownOutput<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            //开始接收服务端的消息
            BufferedReader <span class="token keyword">in</span> <span class="token operator">=</span> new BufferedReader<span class="token punctuation">(</span>new InputStreamReader<span class="token punctuation">(</span>socket.getInputStream<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            System.out.println<span class="token punctuation">(</span><span class="token string">"接收到服务端的回复:"</span> + in.readLine<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> catch <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            System.out.println<span class="token punctuation">(</span><span class="token string">"Socket传输数据异常!"</span> + e.getMessage<span class="token punctuation">(</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>out.flush();这里需要手动刷新下，才会发送到服务器端，自动刷新不生效 需要手动刷新<br> 自己测试了可以使用</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/31a3e177b16a5d023bce29a7f92ab96f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">pycocotools 使用方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fad5a16e923ac328dd21bb5e0ff9c78e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">“j-link “the connected j-link is defective”不一样的解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>