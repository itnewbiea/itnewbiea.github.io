<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【python】作用域与闭包 || global与nonlocal - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【python】作用域与闭包 || global与nonlocal" />
<meta property="og:description" content="python作用域 其他语言的作用域：块级、函数、类、模块、包等由小到大的级别但是python没有块级（if语句块、for语句块），所以if中定义的变量，相当于普通语句 &gt;&gt;&gt; if True: # if语句块没有作用域 x = 1 &gt;&gt;&gt; x 1 &gt;&gt;&gt; def func(): # 函数有作用域 a = 8 &gt;&gt;&gt; a Traceback (most recent call last): File &#34;&lt;pyshell#3&gt;&#34;, line 1, in &lt;module&gt; a NameError: name &#39;a&#39; is not defined 变量的作用域 查找循序： Python以L –&gt; E –&gt; G –&gt;B的规则查找变量，即：在局部找不到，便会去局部外的局部找（例如闭包），再找不到就会去全局找，最后去内建中找。如果这样还找不到，那就提示变量不存在的错误。
a = 1 def func(): print(a) #输出1，局部变量找不到，去全局变量找 global和nonlocal total = 0 # total是一个全局变量 def plus( arg1, arg2 ): total = arg1 &#43; arg2 # total在这里是局部变量." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3a0dfcefcf3081bad1cf367e8f70495b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-21T21:23:42+08:00" />
<meta property="article:modified_time" content="2023-12-21T21:23:42+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【python】作用域与闭包 || global与nonlocal</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="python_0"></a>python作用域</h4> 
<ul><li>其他语言的作用域：块级、函数、类、模块、包等由小到大的级别</li><li>但是python没有块级（if语句块、for语句块），<strong>所以if中定义的变量，相当于普通语句</strong></li></ul> 
<pre><code class="prism language-python">
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">if</span> <span class="token boolean">True</span><span class="token punctuation">:</span>            <span class="token comment"># if语句块没有作用域</span>
    x <span class="token operator">=</span> <span class="token number">1</span>   
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> x
<span class="token number">1</span>
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> <span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>         <span class="token comment"># 函数有作用域</span>
    a <span class="token operator">=</span> <span class="token number">8</span>   
<span class="token operator">&gt;&gt;</span><span class="token operator">&gt;</span> a
Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"&lt;pyshell#3&gt;"</span><span class="token punctuation">,</span> line <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    a
NameError<span class="token punctuation">:</span> name <span class="token string">'a'</span> <span class="token keyword">is</span> <span class="token keyword">not</span> defined
</code></pre> 
<h4><a id="_18"></a>变量的作用域</h4> 
<p><img src="https://images2.imgbox.com/75/9e/9nnBx96K_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_20"></a>查找循序：</h5> 
<blockquote> 
 <p>Python以L –&gt; E –&gt; G –&gt;B的规则查找变量，即：在局部找不到，便会去局部外的局部找（例如闭包），再找不到就会去全局找，最后去内建中找。如果这样还找不到，那就提示变量不存在的错误。</p> 
</blockquote> 
<pre><code class="prism language-python">a <span class="token operator">=</span> <span class="token number">1</span>

<span class="token keyword">def</span> <span class="token function">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment">#输出1，局部变量找不到，去全局变量找</span>
</code></pre> 
<h4><a id="globalnonlocal_29"></a>global和nonlocal</h4> 
<pre><code class="prism language-python">total <span class="token operator">=</span> <span class="token number">0</span>                        <span class="token comment"># total是一个全局变量</span>

<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span> arg1<span class="token punctuation">,</span> arg2 <span class="token punctuation">)</span><span class="token punctuation">:</span>
    total <span class="token operator">=</span> arg1 <span class="token operator">+</span> arg2          <span class="token comment"># total在这里是局部变量.</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数内局部变量total=  "</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数内的total的内存地址是: "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> total

plus<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数外部全局变量total= "</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数外的total的内存地址是: "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">函数内局部变量total<span class="token operator">=</span>   <span class="token number">30</span>
函数内的total的内存地址是<span class="token punctuation">:</span>  <span class="token number">94306286515584</span>
函数外部全局变量total<span class="token operator">=</span>  <span class="token number">0</span>
函数外的total的内存地址是<span class="token punctuation">:</span>  <span class="token number">94306286514624</span>
</code></pre> 
<ol><li>在函数内<strong>定义</strong>的total，被认为是一个新的被定义的变量</li><li>这时候函数内的total和全局变量total是两个不同的变量（储存地址不一样）</li></ol> 
<h5><a id="global_55"></a>global：指定当前变量使用外部的全局变量</h5> 
<pre><code class="prism language-python">total <span class="token operator">=</span> <span class="token number">0</span>                        <span class="token comment"># total是一个全局变量</span>

<span class="token keyword">def</span> <span class="token function">plus</span><span class="token punctuation">(</span> arg1<span class="token punctuation">,</span> arg2 <span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> total    <span class="token comment"># 使用global关键字申明此处的total引用外部的total</span>
    total <span class="token operator">=</span> arg1 <span class="token operator">+</span> arg2          
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数内局部变量total=  "</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数内的total的内存地址是: "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> total

plus<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数外部全局变量total= "</span><span class="token punctuation">,</span> total<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数外的total的内存地址是: "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>total<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">函数内局部变量total<span class="token operator">=</span>   <span class="token number">30</span>
函数内的total的内存地址是<span class="token punctuation">:</span>  <span class="token number">503494624</span>
函数外部全局变量total<span class="token operator">=</span>  <span class="token number">30</span>
函数外的total的内存地址是<span class="token punctuation">:</span>  <span class="token number">503494624</span>
</code></pre> 
<h5><a id="_79"></a>加大难度</h5> 
<pre><code class="prism language-python">a <span class="token operator">=</span> <span class="token number">1</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数outer调用之前全局变量a的内存地址： "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">outer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> <span class="token number">2</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数outer调用之时闭包外部的变量a的内存地址： "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">def</span> <span class="token function">inner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        a <span class="token operator">=</span> <span class="token number">3</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数inner调用之后闭包内部变量a的内存地址： "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
    inner<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数inner调用之后，闭包外部的变量a的内存地址： "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
outer<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"函数outer执行完毕，全局变量a的内存地址： "</span><span class="token punctuation">,</span> <span class="token builtin">id</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-python">函数outer调用之前全局变量a的内存地址：  <span class="token number">94419210220000</span>
函数outer调用之时闭包外部的变量a的内存地址：  <span class="token number">94419210220032</span>
函数inner调用之后闭包内部变量a的内存地址：  <span class="token number">94419210220064</span>
函数inner调用之后，闭包外部的变量a的内存地址：  <span class="token number">94419210220032</span>
函数outer执行完毕，全局变量a的内存地址：  <span class="token number">94419210220000</span>
</code></pre> 
<p><strong>问题：</strong><br> <strong>如果在inner函数中想调用outer函数的a而不是全局变量的a，该怎么做？</strong></p> 
<p><strong>ans：<br> 使用nonlocal</strong></p> 
<blockquote> 
 <p><strong>nonlocal是不是只能在大函数包含的小函数里使用？</strong></p> 
</blockquote> 
<blockquote> 
 <p>是的，nonlocal 关键字主要用于嵌套函数中，特别是在一个函数内部定义另一个函数（即内部函数）的情况下。这意味着它主要用于在外部函数（称为大函数）中的内部函数（称为小函数或嵌套函数）中使用。</p> 
</blockquote> 
<blockquote> 
 <p>nonlocal 的目的是告诉 Python 解释器，在当前作用域中，某个变量不是局部变量，也不是全局变量，而是在该变量的嵌套作用域中。这种情况下，它允许内部函数修改嵌套作用域中的变量，而不是创建一个同名的局部变量。</p> 
</blockquote> 
<h4><a id="_116"></a>面试题</h4> 
<hr> 
<p>第一题：</p> 
<pre><code class="prism language-python">a <span class="token operator">=</span> <span class="token number">10</span>
<span class="token keyword">def</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">+=</span> <span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
test<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span><span class="token punctuation">:</span>
  File <span class="token string">"script.py"</span><span class="token punctuation">,</span> line <span class="token number">5</span><span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    test<span class="token punctuation">(</span><span class="token punctuation">)</span>
  File <span class="token string">"script.py"</span><span class="token punctuation">,</span> line <span class="token number">3</span><span class="token punctuation">,</span> <span class="token keyword">in</span> test
    a <span class="token operator">+=</span> <span class="token number">1</span>
UnboundLocalError<span class="token punctuation">:</span> local variable <span class="token string">'a'</span> referenced before assignment

Exited <span class="token keyword">with</span> error status <span class="token number">1</span>
</code></pre> 
<p>原因：</p> 
<ul><li>a += 1相当于a = a + 1，按照赋值运算符的规则是先计算右边的a+1。</li><li>Python的规则是，如果在<strong>函数内部要修改一个变量</strong>，那么这个变量需要是<strong>内部变量</strong>，除非你用global声明了它是外部变量。</li></ul> 
<p>所以要这样修改：</p> 
<pre><code class="prism language-python">a<span class="token operator">=</span><span class="token number">10</span>
<span class="token keyword">def</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> a
    a<span class="token operator">+=</span><span class="token number">1</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>

add<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<hr> 
<hr> 
<p>第二题：</p> 
<pre><code class="prism language-python">name <span class="token operator">=</span><span class="token string">'jack'</span>

<span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'eric'</span>
    f1<span class="token punctuation">(</span><span class="token punctuation">)</span>

f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">jack
</code></pre> 
<p>分析：<br> <strong>Python函数的作用域取决于其函数代码块在整体代码中的位置，而不是调用时机的位置。</strong><br> 调用f1的时候，会去f1函数的定义体查找，对于f1函数，它的外部是name =‘jack’，而不是name = ‘eric’。</p> 
<hr> 
<hr> 
<p>第三题</p> 
<pre><code class="prism language-python">name <span class="token operator">=</span> <span class="token string">'jack'</span>

<span class="token keyword">def</span> <span class="token function">f2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'eric'</span>
    <span class="token keyword">return</span> f1

<span class="token keyword">def</span> <span class="token function">f1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span>

ret <span class="token operator">=</span> f2<span class="token punctuation">(</span><span class="token punctuation">)</span>
ret<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">jack
</code></pre> 
<p>跟第二题一样，这只是返回函数，一种很新的返回😂</p> 
<hr> 
<hr> 
<p>第四题：</p> 
<pre><code class="prism language-python">a<span class="token operator">=</span><span class="token number">10</span>
<span class="token keyword">def</span> <span class="token function">bigone</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> a
    <span class="token keyword">def</span> <span class="token function">smallone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">nonlocal</span> a
        a<span class="token operator">+=</span><span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    smallone<span class="token punctuation">(</span><span class="token punctuation">)</span>
bigone<span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
</code></pre> 
<p>输出：</p> 
<pre><code class="prism language-python">错误
</code></pre> 
<p>python会优先把传入的参数当成在global后面的变量，就会错误</p> 
<pre><code class="prism language-python">b<span class="token operator">=</span><span class="token number">10</span>
<span class="token keyword">def</span> <span class="token function">bigone</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> b
    <span class="token keyword">def</span> <span class="token function">smallone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">nonlocal</span> a
        a<span class="token operator">+=</span><span class="token number">1</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    smallone<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>这样就不会报错。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/43cb5a0b9571733828d54b91fce386cd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">若依前端引入外部icon</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ae13c2d41f31f06060c06c565effe7be/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C&#43;&#43;20形式的utf-8字符串转宽字符串，不依赖编译器编码形式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>