<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux 有线网络驱动实验(PHY芯片LAN8720) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux 有线网络驱动实验(PHY芯片LAN8720)" />
<meta property="og:description" content="目录 嵌入式网络简介嵌入式下的网络硬件接口MII/RMII 接口MDIO 接口RJ45 接口I.MX6ULL ENET 接口简介 PHY 芯片详解PHY 基础知识简介LAN8720A 详解SR8201F 详解 Linux 内核网络驱动框架net_device 结构体net_device_ops 结构体sk_buff 结构体网络 NAPI 处理机制(综合轮询和中断方式) I.MX6ULL 网络驱动简介I.MX6ULL 网络外设设备树I.MX6ULL 网络驱动源码简析fec_netdev_ops 操作集Linux 内核PHY 子系统与MDIO 总线简析 网络驱动实验测试LAN8720 PHY 驱动测试通用PHY 驱动测试DHCP 功能配置 单网卡使用只使用ENET2 网卡只使用ENET1 网卡 和自己工作的IOT项目类似。项目里使用AWS的框架，分为linux系统和freertos系统。Freetros里需使用AT指令驱动4g，不同的模组驱动有差异，需自己实现模组AT驱动然后注册到AWS框架里面。
嵌入式网络简介 网络驱动是linux 里面驱动三巨头之一，linux 下的网络功能非常强大，嵌入式linux 中也常常用到网络功能。前面我们已经讲过了字符设备驱动和块设备驱动，本章我们就来学习一下linux 里面的网络设备驱动。
嵌入式下的网络硬件接口 本章节讨论的都是有线网络！
注意！正点原子I.MX6U-ALPHA开发板V2.4版本以前的底板使用的网络PHY 为LAN8720，V2.4 及其以后的版本使用的网络PHY 为SR8201F，而且网络PHY 地址有改变，大家一定要看准自己所使用的底板版本号！原理基本一致，本章就以LAN8720 为例进行讲解。
以下摘自：yhttps://baike.c114.com.cn/view.asp?id=8730-169B7DF1
网卡芯片也有“软硬”之分，特别是对与主板板载(LOM)的网卡芯片来说更是如此，这是怎么回事呢?大家知道，以太网接口可分为协议层和物理层。
协议层是由一个叫MAC(Media Access Layer，媒体访问层)控制器的单一模块实现。
物理层由两部分组成，即PHY(Physical Layer，物理层)和传输器。
常见的网卡芯片都是把MAC和PHY集成在一个芯片中，但目前很多主板的南桥芯片已包含了以太网MAC控制功能，只是未提供物理层接口，因此，需外接PHY芯片以提供以太网的接入通道。这类PHY网络芯片就是俗称的“软网卡芯片”，常见的PHY功能的芯片有RTL8201BL、VT6103等等。
“软网卡”一般将网络控制芯片的运算部分交由处理器或南桥芯片处理，以简化线路设计，从而降低成本，但其多少会更多占用系统资源.
提起网络，我们一般想到的硬件就是“网卡”，“网卡”这个概念最早从电脑领域传出来，顾名思义就是能上网的卡。在电脑领域的“原始社会”，网卡是独立的硬件，如果电脑要上网就得买个网卡插上去，类似现在的显卡一样。但是大家现在观察自己的笔记本或者台式机主板会发现并没有类似显卡一样的网卡设备，原因是随着技术的不断发展，现在只需要一个芯片就可以实现有线网卡功能，因此网卡芯片都直接放到了主板上。所以大家在接触嵌入式的时候听到“网卡”这两个字，不要急着在开发板上找“卡”一样的东西。
既然现在网卡已经是通过一个芯片来完成了，那么是什么样的芯片呢？这个就要先了解一下嵌入式中的网络硬件方案。首先，嵌入式网络硬件分为两部分：MAC 和PHY，大家都是通过看数据手册来判断一款SOC 是否支持网络，如果一款芯片数据手册说自己支持网络，一般都是说的这款SOC 内置MAC，MAC 类似I2C 控制器、SPI 控制器一样的外设。但是光有MAC还不能直接驱动网络，还需要另外一个芯片：PHY，因此对于内置MAC 的SOC，其外部必须搭配一个PHY 芯片。但是有些SOC 内部没有MAC，那也就没法搭配PHY 芯片了，这些内部没有网络MAC 的芯片如何上网呢？这里就要牵扯出常见的两个嵌入式网络硬件方案了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f83c15e4ef2aec8186c3e0df83105cb4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-28T21:12:28+08:00" />
<meta property="article:modified_time" content="2023-11-28T21:12:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux 有线网络驱动实验(PHY芯片LAN8720)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_8" rel="nofollow">嵌入式网络简介</a></li><li><ul><li><a href="#_11" rel="nofollow">嵌入式下的网络硬件接口</a></li><li><a href="#MIIRMII__54" rel="nofollow">MII/RMII 接口</a></li><li><a href="#MDIO__82" rel="nofollow">MDIO 接口</a></li><li><a href="#RJ45__85" rel="nofollow">RJ45 接口</a></li><li><a href="#IMX6ULL_ENET__99" rel="nofollow">I.MX6ULL ENET 接口简介</a></li></ul> 
  </li><li><a href="#PHY__120" rel="nofollow">PHY 芯片详解</a></li><li><ul><li><a href="#PHY__121" rel="nofollow">PHY 基础知识简介</a></li><li><a href="#LAN8720A__128" rel="nofollow">LAN8720A 详解</a></li><li><a href="#SR8201F__195" rel="nofollow">SR8201F 详解</a></li></ul> 
  </li><li><a href="#Linux__240" rel="nofollow">Linux 内核网络驱动框架</a></li><li><ul><li><a href="#net_device__241" rel="nofollow">net_device 结构体</a></li><li><a href="#net_device_ops__516" rel="nofollow">net_device_ops 结构体</a></li><li><a href="#sk_buff__591" rel="nofollow">sk_buff 结构体</a></li><li><a href="#_NAPI__780" rel="nofollow">网络 NAPI 处理机制(综合轮询和中断方式)</a></li></ul> 
  </li><li><a href="#IMX6ULL__875" rel="nofollow">I.MX6ULL 网络驱动简介</a></li><li><ul><li><a href="#IMX6ULL__876" rel="nofollow">I.MX6ULL 网络外设设备树</a></li><li><a href="#IMX6ULL__1046" rel="nofollow">I.MX6ULL 网络驱动源码简析</a></li><li><a href="#fec_netdev_ops__1562" rel="nofollow">fec_netdev_ops 操作集</a></li><li><a href="#Linux_PHY_MDIO__1794" rel="nofollow">Linux 内核PHY 子系统与MDIO 总线简析</a></li></ul> 
  </li><li><a href="#_2154" rel="nofollow">网络驱动实验测试</a></li><li><ul><li><a href="#LAN8720_PHY__2155" rel="nofollow">LAN8720 PHY 驱动测试</a></li><li><a href="#PHY__2161" rel="nofollow">通用PHY 驱动测试</a></li><li><a href="#DHCP__2168" rel="nofollow">DHCP 功能配置</a></li></ul> 
  </li><li><a href="#_2190" rel="nofollow">单网卡使用</a></li><li><ul><li><a href="#ENET2__2192" rel="nofollow">只使用ENET2 网卡</a></li><li><a href="#ENET1__2221" rel="nofollow">只使用ENET1 网卡</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<blockquote> 
 <p>和自己工作的IOT项目类似。项目里使用AWS的框架，分为linux系统和freertos系统。Freetros里需使用AT指令驱动4g，不同的模组驱动有差异，需自己实现模组AT驱动然后注册到AWS框架里面。</p> 
</blockquote> 
<h2><a id="_8"></a>嵌入式网络简介</h2> 
<p>网络驱动是linux 里面驱动三巨头之一，linux 下的网络功能非常强大，嵌入式linux 中也常常用到网络功能。前面我们已经讲过了字符设备驱动和块设备驱动，本章我们就来学习一下linux 里面的网络设备驱动。</p> 
<h3><a id="_11"></a>嵌入式下的网络硬件接口</h3> 
<p>本章节讨论的都是有线网络！<br> 注意！正点原子I.MX6U-ALPHA开发板V2.4版本以前的底板使用的网络PHY 为LAN8720，V2.4 及其以后的版本使用的网络PHY 为SR8201F，而且网络PHY 地址有改变，大家一定要看准自己所使用的底板版本号！原理基本一致，本章就以LAN8720 为例进行讲解。</p> 
<blockquote> 
 <p>以下摘自：yhttps://baike.c114.com.cn/view.asp?id=8730-169B7DF1<br> 网卡芯片也有“软硬”之分，特别是对与主板板载(LOM)的网卡芯片来说更是如此，这是怎么回事呢?大家知道，以太网接口可分为协议层和物理层。</p> 
 <p>协议层是由一个叫MAC(Media Access Layer，媒体访问层)控制器的单一模块实现。</p> 
 <p>物理层由两部分组成，即PHY(Physical Layer，物理层)和传输器。</p> 
 <p>常见的网卡芯片都是把MAC和PHY集成在一个芯片中，但<mark>目前很多主板的南桥芯片已包含了以太网MAC控制功能</mark>，只是未提供物理层接口，因此，需<mark>外接PHY芯片以提供以太网的接入通道</mark>。这类PHY网络芯片就是俗称的“软网卡芯片”，常见的PHY功能的芯片有RTL8201BL、VT6103等等。</p> 
 <p>“软网卡”一般将网络控制芯片的运算部分交由处理器或南桥芯片处理，以简化线路设计，从而降低成本，但其多少会更多占用系统资源.</p> 
</blockquote> 
<p>提起网络，我们一般想到的硬件就是“网卡”，“网卡”这个概念最早从电脑领域传出来，顾名思义就是能上网的卡。在电脑领域的“原始社会”，网卡是独立的硬件，如果电脑要上网就得买个网卡插上去，类似现在的显卡一样。但是大家现在观察自己的笔记本或者台式机主板会发现并没有类似显卡一样的网卡设备，原因是随着技术的不断发展，现在只需要一个芯片就可以实现有线网卡功能，因此网卡芯片都直接放到了主板上。所以大家在接触嵌入式的时候听到“网卡”这两个字，不要急着在开发板上找“卡”一样的东西。<br> 既然现在网卡已经是通过一个芯片来完成了，那么是什么样的芯片呢？这个就要先了解一下嵌入式中的网络硬件方案。首先，嵌入式网络硬件分为两部分：MAC 和PHY，大家都是通过看数据手册来判断一款SOC 是否支持网络，如果一款芯片数据手册说自己支持网络，一般都是说的这款SOC 内置MAC，MAC 类似I2C 控制器、SPI 控制器一样的外设。但是光有MAC还不能直接驱动网络，还需要另外一个芯片：PHY，因此对于内置MAC 的SOC，其外部必须搭配一个PHY 芯片。但是有些SOC 内部没有MAC，那也就没法搭配PHY 芯片了，这些内部没有网络MAC 的芯片如何上网呢？这里就要牵扯出常见的两个嵌入式网络硬件方案了。<br> 1、SOC 内部没有网络MAC 外设<br> 我们一般说某个SOC 不支持网络，说的就是它没有网络MAC。那么这个芯片就不能上网了吗？显然不是的，既然没有内部MAC，那么可以找个外置的MAC 芯片啊，不过一般这种外置的网络芯片都是MAC+PHY 一体的。比如三星linux 开发板里面用的最多的DM9000，因为三星的芯片基本没有内部MAC(比如S3C2440、S5PV210，4412 等)，所以三星的开发板都是通过外置的DM9000 来完成有线网络功能的，DM9000 对SOC 提供了一个SRAM 接口，SOC 会以SRAM 的方式操作DM9000。</p> 
<p>有些外置的网络芯片更强大，内部甚至集成了硬件TCP/IP 协议栈，对外提供一个SPI 接口，比如W5500。这个一般用于单片机领域，单片机通过SPI 接口与W5500 进行通信，由于W5500 内置了硬件TCP/IP 协议栈，因此单片机就不需要移植软件协议栈，直接通过SPI 来操作W5500，简化了单片机联网方案。</p> 
<p>这种方案的优点就是让不支持网络的SOC 能够另辟蹊径，实现网络功能，但是<mark>缺点就是网络效率不高</mark>，因为一般芯片内置的MAC 会有网络加速引擎，比如网络专用DMA，网络处理效率会很高。而且此类芯片网速都不快，基本就是10/100M。另外，相比PHY 芯片而言，此类芯片的成本也比较高，可选择比较少。</p> 
<p>SOC 与外部MAC+PHY 芯片的连接如图69.1.1.1 所示：</p> 
<p><img src="https://images2.imgbox.com/0a/bf/IPFEGY6f_o.png" alt="在这里插入图片描述"><br> 图69.1.1.1 主控SOC 与外置MAC+PHY 芯片连接<br> 2、SOC 内部集成网络MAC 外设<br> 我们一般说某个SOC 支持网络，说的就是他内部集成网络MAC 外设，此时我们还需要外接一个网络PHY 芯片。此时就有朋友会有疑问，PHY 芯片不能也集成进SOC 吗？笔者目前还没见过将PHY 也集成到芯片里面的SOC。<br> 一般常见的通用SOC 都会集成网络MAC 外设，比如STM32F4/F7/H7 系列、NXP 的I.MX系列，内部集成网络MAC 的优点如下：<br> ①、内部MAC 外设会有专用的加速模块，比如专用的DMA，加速网速数据的处理。<br> ②、网速快，可以支持10/100/1000M 网速。<br> ③、外接PHY 可选择性多，成本低。<br> 内部的MAC 外设会通过MII 或者RMII 接口来连接外部的PHY 芯片，MII/RMII 接口用来传输网络数据。另外主控需要配置或读取PHY 芯片，也就是读写PHY 的内部寄存器，所以还需要一个控制接口，叫做MIDO，MDIO 很类似IIC，也是两根线，一根数据线叫做MDIO，一根时钟线叫做MDC。<br> SOC 内部MAC 外设与外部PHY 芯片的连接如图69.1.1.2 所示：<br> <img src="https://images2.imgbox.com/27/b3/5ny3pecO_o.png" alt="在这里插入图片描述"><br> 图69.1.1.2 内部MAC 与外部PHY 之间的连接<br> 大家在做项目的时候，如果要用到网络功能，强烈建议大家选择内部带有网络MAC 外设的主控SOC！I.MX6ULL 就有两个10M/100M 的网络MAC 外设，正点原子ALPHA 开发板板载了两颗PHY 芯片，型号为LAN8720 或SR8201F。因此，本章节只讲解SOC 内部MAC+外置PHY 芯片这种方案。</p> 
<h3><a id="MIIRMII__54"></a>MII/RMII 接口</h3> 
<p>前面我们说了，内部MAC 通过MII/RMII 接口来与外部的PHY 芯片连接，完成网络数据传输，本节我们就来学习一下什么是MII 和RMII 接口。<br> 1、MII 接口<br> MII 全称是Media Independent Interface，直译过来就是介质独立接口，它是IEEE-802.3 定义的以太网标准接口，MII 接口用于以太网MAC 连接PHY 芯片，连接示意图如图69.1.2.1 所示：<br> <img src="https://images2.imgbox.com/91/f0/eii3uRSq_o.png" alt="在这里插入图片描述"><br> 图69.1.2.1 MII 接口<br> MII 接口一共有16 根信号线，含义如下：<br> TX_CLK：发送时钟，如果网速为100M 的话时钟频率为25MHz，10M 网速的话时钟频率为2.5MHz，此时钟由PHY 产生并发送给MAC。<br> TX_EN：发送使能信号。<br> TX_ER：发送错误信号，高电平有效，表示TX_ER 有效期内传输的数据无效。10Mpbs 网速下TX_ER 不起作用。<br> TXD[3:0]：发送数据信号线，一共4 根。<br> RXD[3:0]：接收数据信号线，一共4 根。<br> RX_CLK：接收时钟信号，如果网速为100M 的话时钟频率为25MHz，10M 网速的话时钟频率为2.5MHz，RX_CLK 也是由PHY 产生的。<br> RX_ER：接收错误信号，高电平有效，表示RX_ER 有效期内传输的数据无效。10Mpbs 网速下RX_ER 不起作用。<br> RX_DV：接收数据有效，作用类似TX_EN。<br> CRS：载波侦听信号。<br> COL：冲突检测信号。<br> MII 接口的缺点就是所需信号线太多，这还没有算MDIO 和MDC 这两根管理接口的数据线，因此MII 接口使用已经越来越少了。<br> 2、RMII 接口<br> RMII 全称是Reduced Media Independent Interface，翻译过来就是精简的介质独立接口，也就是MII 接口的精简版本。RMII 接口只需要7 根数据线，相比MII 直接减少了9 根，极大的方便了板子布线，RMII 接口连接PHY 芯片的示意图如图69.1.2.2 所示：<br> <img src="https://images2.imgbox.com/20/b2/hHw6TewH_o.png" alt="在这里插入图片描述"><br> 图69.1.2.1 RMII 接口<br> TX_EN：发送使能信号。<br> TXD[1:0]：发送数据信号线，一共2 根。<br> RXD[1:0]：接收数据信号线，一共2 根。<br> CRS_DV：相当于MII 接口中的RX_DV 和CRS 这两个信号的混合。<br> REF_CLK：参考时钟，由外部时钟源提供，频率为50MHz。这里与MII 不同，MII 的接收和发送时钟是独立分开的，而且都是由PHY 芯片提供的。<br> 除了MII 和RMII 以外，还有其他接口，比如GMII、RGMII、SMII、SMII 等，关于其他接口基本都是大同小异的，这里就不做讲解了。正点原子ALPAH 开发板上的两个网口都是采用RMII 接口来连接MAC 与外部PHY 芯片。</p> 
<h3><a id="MDIO__82"></a>MDIO 接口</h3> 
<p>MDIO 全称是Management Data Input/Output，直译过来就是管理数据输入输出接口，是一个简单的两线串行接口，一根MDIO 数据线，一根MDC 时钟线。驱动程序可以通过MDIO 和MDC 这两根线访问PHY 芯片的任意一个寄存器。MDIO 接口支持多达32 个PHY。同一时刻内只能对一个PHY 进行操作，那么如何区分这32 个PHY 芯片呢？和IIC 一样，使用器件地址即可。同一MDIO 接口下的所有PHY 芯片，其器件地址不能冲突，必须保证唯一，具体器件地址值要查阅相应的PHY 数据手册。<br> 因此，MAC 和外部PHY 芯片进行连接的时候主要是MII/RMII 和MDIO 接口，另外可能还需要复位、中断等其他引脚。</p> 
<h3><a id="RJ45__85"></a>RJ45 接口</h3> 
<p>网络设备是通过网线连接起来的，插入网线的叫做RJ45 座，如图69.1.4.1 所示：<br> <img src="https://images2.imgbox.com/91/61/KwcH2pcW_o.png" alt="在这里插入图片描述"><br> 图69.1.4.1 RJ45 座子<br> RJ45 座要与PHY 芯片连接在一起，但是中间需要一个网络变压器，网络变压器用于隔离以及滤波等，网络变压器也是一个芯片，外形一般如图69.1.4.2 所示：<br> <img src="https://images2.imgbox.com/44/60/FoewFoNE_o.png" alt="在这里插入图片描述"></p> 
<p>图69.1.4.2 网络变压器<br> 但是现在很多RJ45 座子内部已经集成了网络变压器，比如正点原子ALPHA 开发板所使用的HR911105A 就是内置网络变压器的RJ45 座。内置网络变压器的RJ45 座和不内置的引脚一样，但是一般不内置的RJ45 座会短一点。因此，大家在画板的时候一定要考虑你所使用的RJ45座是否内置网络变压器，如果不内置的话就要自行添加网络变压器部分电路！！！同理，如果你所设计的硬件是需要内置网络变压器的RJ45 座，肯定不能随便焊接一个不内置变压器的RJ45座，否则网络工作不正常！<br> RJ45 座子上一般有两个灯，一个黄色(橙色)，一个绿色，绿色亮的话表示网络连接正常，黄色闪烁的话说明当前正在进行网络通信。这两个灯由PHY 芯片控制，PHY 芯片会有两个引脚来连接RJ45 座上的这两个灯。内部MAC+外部PHY+RJ45 座(内置网络变压器)就组成了一个完整的嵌入式网络接口硬件，如图69.1.4.2 所示：</p> 
<p><img src="https://images2.imgbox.com/f7/28/GNNe0iNn_o.png" alt="在这里插入图片描述"><br> 图69.1.4.2 嵌入式网络硬件接口示意图</p> 
<h3><a id="IMX6ULL_ENET__99"></a>I.MX6ULL ENET 接口简介</h3> 
<p>I.MX6ULL 有两个网络接口，也就是两个MAC 外设，一个MAC 连接一个PHY 芯片形成一个完整网络接口，本节我们简单了解一下I.MX6ULL 自带的ENET 接口。I.MX6ULL 内部自带的ENET 外设其实就是一个网络MAC，支持10/100M。实现了三层网络加速，用于加速那些通用的网络协议，比如IP、TCP、UDP 和ICMP 等，为客户端应用程序提供加速服务。<br> I.MX6ULL 内核集成了两个10/100Mbit/S 的网络MAC，符合IEEE802.3-2002 标准，MAC层支持双工、半双工局域网。MAC 可编程、可以作为NIC 卡或其他一些交换器件。根据IETF RFC 2819 协议，MAC 实现了RMON(Remote Network Monitoring)计数功能。MAC 内核拥有硬件加速处理单元来提高网络性能，硬件加速单元用于处理TCP/IP、UDP、ICMP 等协议。通过硬件来处理帧头等信息，效果要比用一大堆软件处理要好很多。ENET 外设有一个专用的DMA，此DMA 用于在ENET 外设和SOC 之间传输数据，并且支持可编程的增强型的缓冲描述符，用<br> 以支持IEEE 1588。<br> I.MX6ULL 内部ENET 外设主要特性如下：<br> 1)、实现了全功能的802.3 规范前导码/SFD 生成、帧填充、CRC 生成和检查。<br> 2)、支持零长的前导码。<br> 3)、支持10/100M 动态配置。<br> 4)、兼容AMD 远端节点电源管理的魔术帧中断检测。<br> 5)、可以通过如下接口无缝的连接PHY 芯片：<br> ·4bit 的MII 接口，频率为2.5/25MHz。<br> ·4bit 的MII-Lite 接口，也就是MII 接口取消掉CRS 和COL 这两根线，频率也是<br> 2.5/25MHz。<br> ·2bit 的RMII 接口，频率为50MHz。<br> 6)、MAC 地址可编程。<br> 7)、多播和单播地址过滤，降低更高层的处理负担。<br> 8)、MDIO 主接口，用于管理和配置PHY 设备。<br> ……<br> I.MX6ULL 的ENET 外设内容比较多，详细的介绍请查阅《I.MX6ULL 参考手册》的“Chapter 22 10/100-Mbps Ethernet MAC(ENET)”章节。我们在编写驱动的时候其实并不需要关注ENET外设的具体内容，因为这部分驱动是SOC 厂商编写的，我们重点关注的是更换PHY 芯片以后哪里需要调整。</p> 
<h2><a id="PHY__120"></a>PHY 芯片详解</h2> 
<h3><a id="PHY__121"></a>PHY 基础知识简介</h3> 
<p>PHY 是IEEE 802.3 规定的一个标准模块，前面说了，SOC 可以对PHY 进行配置或者读取PHY 相关状态，这个就需要PHY 内部寄存器去实现了。PHY 芯片寄存器地址空间为5 位，地址0 ~ 31 共32 个寄存器，IEEE 定义了0 ~ 15 这16 个寄存器的功能，16 ~ 31 这16 个寄存器由厂商自行实现。也就是说不管你用的哪个厂家的PHY 芯片，其中0~15 这16 个寄存器是一模一样的。仅靠这16 个寄存器是完全可以驱动起PHY 芯片的，至少能保证基本的网络数据通信，因此Linux 内核有通用PHY 驱动，按道理来讲，不管你使用的哪个厂家的PHY 芯片，都可以使用Linux 的这个通用PHY 驱动来验证网络工作是否正常。事实上在实际开发中可能会遇到一些其他的问题导致Linux 内核的通用PHY 驱动工作不正常，这个时候就需要驱动开发人员去调试了。但是，随着现在的PHY 芯片性能越来越强大，32 个寄存器可能满足不了厂商的需求，因此很多厂商采用分页技术来扩展寄存器地址空间，以求定义更多的寄存器。这些多出来的寄存器可以用于实现厂商特有的一些技术，因此Linux 内核的通用PHY 驱动就无法驱动这些特色功能了，这个时候就需要PHY 厂商提供相应的驱动源码了，所以大家也会在Linux 内核里面看到很多具体的PHY 芯片驱动源码。不管你的PHY 芯片有多少特色功能，按道理来讲，Linux 内核的通用PHY 驱动是绝对可以让你这PHY 芯片实现基本的网络通信，因此大家也不用担心更换PHY 芯片以后网络驱动编写是不是会很复杂。<br> IEEE802.3 协议英文原版已经放到了开发板光盘中，路径为4、参考资料-&gt;802.3 协议英文原版_2018 年.pdf，打开此文档，此文档有5600 页，按照SECTION 进行分类，一共8 个SECTION。<br> 选中“802.3-2018_SECTION2”，找到“22.2.4 Management functions”章节，此章节对PHY 的前16 个寄存器功能进行了规定，如图69.2.1.1 所示：<br> <img src="https://images2.imgbox.com/d0/dd/W3M2PfXn_o.png" alt="在这里插入图片描述"><br> 图69.2.1.1 IEEE 规定的前16 个寄存器<br> 关于这16 个寄存器的内容协议里面也进行了详细的讲解，这里就不分析了。我们后面会以ALPHA 开发板所使用的LAN8720A/SR8201F 这两个PHY 为例，详细的分析一下PHY 芯片的寄存器。</p> 
<h3><a id="LAN8720A__128"></a>LAN8720A 详解</h3> 
<p>V2.4 版本以前的底板PHY 芯片采用LAN8720A，因此请看本小节！<br> 虽然本教程讲解的是LAN8720A 这颗PHY，但是前面说了，IEEE 规定了PHY 的前16 个寄存器的功能，因此如果你所使用的板子用的其他厂家的PHY 芯片，也是可以看本小节的。<br> 1、LAN8720A 简介<br> LAN8720A 是低功耗的10/100M 单以太网PHY 层芯片，可应用于机顶盒、网络打印机、嵌入式通信设备、IP 电话等领域。I/O 引脚电压符合IEEE802.3-2005 标准。LAN8720A 支持通过RMII 接口与以太网MAC 层通信，内置10-BASE-T/100BASE-TX 全双工传输模块，支持10Mbps 和100Mbps。LAN8720A 可以通过自协商的方式选择与目的主机最佳的连接方式(速度和双工模式)。支持HP Auto-MDIX 自动翻转功能，无需更换网线即可将连接更改为直连或交叉连接。<br> LAN8720A 的主要特点如下：<br> · 高性能的10/100M 以太网传输模块<br> · 支持RMII 接口以减少引脚数<br> · 支持全双工和半双工模式<br> · 两个状态LED 输出<br> · 可以使用25M 晶振以降低成本<br> · 支持自协商模式<br> · 支持HP Auto-MDIX 自动翻转功能<br> · 支持SMI 串行管理接口<br> · 支持MAC 接口<br> LAN8720A 功能框图如图69.2.2.1 所示。<br> <img src="https://images2.imgbox.com/ac/7f/qSyeNm1g_o.png" alt="在这里插入图片描述"></p> 
<p>图69.2.2.1 LAN8720A 功能框图<br> 2、LAN8720A 中断管理<br> LAN8720A 的器件管理接口支持非IEEE 802.3 规范的中断功能。当一个中断事件发生并且相应事件的中断位使能，LAN8720A 就会在nINT(14 脚)产生一个低电平有效的中断信号。LAN8720A 的中断系统提供两种中断模式：主中断模式和复用中断模式。主中断模式是默认中断模式，LAN8720A 上电或复位后就工作在主中断模式，当模式控制/状态寄存器(十进制地址为17)的ALTINT 位为0 时LAN8720A 工作在主模式，当ALTINT 位为1 时工作在复用中断模式。正点原子的ALPHA 开发板虽然讲LAN8720A 的中断引脚连接到了I.MX6ULL 上，但是并没有使用中断功能，关于中断的具体用法可以参考LAN8720A 数据手册的29~30 页。<br> 3、PHY 地址设置<br> MAC 层通过MDIO/MDC 总线对PHY 进行读写操作，MDIO 最多可以控制32 个PHY 芯片，通过不同的PHY 芯片地址来对不同的PHY 操作。LAN8720A 通过设置RXER/PHYAD0<br> 引脚来设置其PHY 地址，默认情况下为0，其地址设置如表69.2.2.1 所示。</p> 
<p><img src="https://images2.imgbox.com/96/1f/DVnCbT6I_o.png" alt="在这里插入图片描述"></p> 
<p>表69.2.2.1 LAN8720A 地址设置<br> 正点原子ALPHA 开发板的ENET1 网络的LAN8720A 上的RXER/PHYAD0 引脚为默认状态(原理图上有个10K 下拉，但是没有焊接)，因此ENET1 上的LAN8720A 地址为0。ENET2网络上的LAN8720A 上的RXER/PHYAD0 引脚接了个10K 上拉电阻，因此ENET2 上的LAN8720A 地址为1。<br> 4、nINT/REFCLKO 配置<br> nINTSEL 引脚(2 号引脚)用于设置nINT/REFCLKO 引脚(14 号引脚)的功能。nINTSEL 配置<br> 如表69.2.2.2 所示。<br> <img src="https://images2.imgbox.com/1f/1a/0fg08D0Y_o.png" alt="在这里插入图片描述"><br> 表69.2.2.2 nINTSEL 配置<br> 对于正点原子的ALPHA 开发板的两个LAN8720A 而言，全都工作在默认的REF_CLK In 模式下。当LAN8720A 工作在REF_CLK In 模式时，50MHz 的外部时钟信号应接到LAN8720 的XTAL1/CKIN 引脚(5 号引脚)上，如图69.2.2.3 所示：<br> <img src="https://images2.imgbox.com/6f/13/odlV2aXs_o.png" alt="在这里插入图片描述"></p> 
<p>图69.2.2.3 REF_CLK 连接外部50MHz 时钟信号<br> 为了降低成本，LAN8720A 可以从外部的25MHz 的晶振中产生REF_CLK 时钟。使用此功能时应工作在REF_CLK Out 模式时。当工作在REF_CLO Out 模式时REF_CLK 的时钟源如图69.2.2.4 所示。<br> <img src="https://images2.imgbox.com/16/30/fwn4VHpn_o.png" alt="在这里插入图片描述"><br> 图69.2.2.4 REF_CLK Out 模式时的REF_CLK 时钟源前面说了，正点原子的ALPHA 开发板工作在REF_CLK In 模式下，因此需要外部50MHz时钟信号，I.MX6ULL 有专用的网络时钟引脚，因此ALPHA 开发板是通过I.MX6ULL 的<br> ENET1_REF_CLK 和ENET2_REF_CLK 这两个网络时钟引脚来为LAN8720A 提供50MHz 的时钟。<br> 5、LAN8720A 内部寄存器<br> LAN8720A 的前16 个寄存器满足IEEE 的要求，在这里我们只介绍几个常用的寄存器，首先是BCR(Basic Control Rgsister)寄存器，地址为0，BCR 寄存器各位如表69.2.2.3 所示。<br> <img src="https://images2.imgbox.com/48/34/SZXCmhM6_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fa/de/sNkkBwm8_o.png" alt="在这里插入图片描述"><br> 表69.2.2.3 BCR 寄存器<br> 我们说的配置PHY 芯片，重点就是配置BCR 寄存器，由于LAN8720A 是个10/100M 的PHY，因此表69.2.2.3 中没有体现出1000M 相关的配置。但是10/100M 相关的配置是和IEEE的规定完全相符的，大家可以选择一个其他的10/100M 的PHY 芯片对比看一下，比如NXP 官方EVK 开发板使用的KSZ8081。<br> 接下来看一下BSR(Basic Status Register)寄存器，地址为1。此寄存器为PHY 的状态寄存器，通过此寄存器可以获取到PHY 芯片的工作状态，BSR 寄存器各位如表69.2.2.4 所示：<br> <img src="https://images2.imgbox.com/0f/e2/Ttso2CGB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/09/5b/dpRUFkEA_o.png" alt="在这里插入图片描述"><br> 表69.2.2.4 BSR 寄存器<br> 从表69.2.2.4 可以看出，和IEEE 标准规定相比，LAN8720A 的BSR 寄存器少了几个位，这个没关系的，不管什么PHY 芯片，只要它实现了的位和IEEE 规定相符就行。通过读取BSR寄存器的值我们可以得到当前的连接速度、双工状态和连接状态等。<br> 接下来看一下LAN8720A 的PHY ID 寄存器1 和ID 寄存器2，地址为2 和3，后面就称为寄存器2 和寄存器3。这两个寄存器都是PHY 的ID 寄存器。IEEE 规定寄存器2 和寄存器3 为PHY 的ID 寄存器，这两个寄存器组成一个32 位的唯一ID 值。IEEE 规定了一叫做OUI 的ID组成方式，全称是Organizationally Unique Identifier，OUI 一共32 位，分为三部分：22 位的ID+6位厂商型号ID+4 位厂商版本ID，组成如图69.2.2.5 所示：<br> <img src="https://images2.imgbox.com/b1/06/r4ZX2kuo_o.png" alt="在这里插入图片描述"><br> 图69.2.2.5 OUI 组成方式<br> LAN8720A 的ID 寄存器2 如表69.2.2.5 所示：<br> <img src="https://images2.imgbox.com/43/0e/A37C4MdF_o.png" alt="在这里插入图片描述"><br> 表69.2.2.5 PHY ID 寄存器2<br> ID 寄存器3 如表69.2.2.6 所示：<br> <img src="https://images2.imgbox.com/68/3e/rr285Mg9_o.png" alt="在这里插入图片描述"><br> 表69.2.2.6 PHY ID 寄存器3<br> 最后来看一下LAN8720A 的特殊控制/状态寄存器，此寄存器地址为31，寄存器内容是LAN8720A 厂商自定义的，此寄存器的各个位如表69.2.2.7 所示:<br> <img src="https://images2.imgbox.com/53/f0/oExYP9xz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6c/71/DTY4YmBE_o.png" alt="在这里插入图片描述"><br> 表69.2.2.7 LAN8720A 特殊控制/状态寄存器<br> 特殊控制/状态寄存器中我们关心的是bit2~bit4 这三位，因为通过这3 位来确定连接的状态和速度，关于LAN8720A 这个PHY 就讲解到这里。</p> 
<h3><a id="SR8201F__195"></a>SR8201F 详解</h3> 
<p>V2.4 及以后版本的底板PHY 芯片采用SR8201F，因此请看本小节！<br> 1、SR8201F 简介<br> SR8201F 是单芯片/单端口的10/100Mbps 以太网PHY 收发器。芯片支持RMII (简化介质独立)接口，SR8201F 实现了所有10/100M 以太网物理层，包括：物理编码子层(PCS)，物理介质接入层(PMA)，双绞线物理介质相关子层(TP-PMD)，同时芯片支持端口自动翻转（Auto-MDIX）。<br> SR8201F 的主要特点如下：<br> · 支持IEEE 802.3az-2010（EEE）<br> · 兼容100Base-TX IEEE 802.3u<br> · 兼容10Base-T IEEE 802.3<br> · 支持RMII 模式<br> · 全/半双工工作<br> · 支持自协商模式<br> · 支持Auto-MDIX<br> · 支持中断功能<br> · SR8201F 提供两个网络状态的LED<br> ·支持25MHz 晶振或外部振荡输入<br> · RMII 模式支持50MHz 外部时钟输入<br> SR8201F 功能框图如图69.2.3.1 所示。<br> <img src="https://images2.imgbox.com/1f/b0/nfRF2Non_o.png" alt="在这里插入图片描述"><br> 图69.2.3.1 SR8201F 功能框图<br> 2、SR8201F 中断管理<br> SR8201F 检测到媒介端的状态改变，就会写入对应中断状态的寄存器（第0 页寄存器14），并且在中断管脚使能时，中断管脚会被置低表示发生一个中断事件。当MAC 检测到中断事件时，可以通过MDC/MDIO 端口访问到第0 页寄存器14 获取相应的中断状态。正点原子的ALPHA 开发板虽然将SR8201F 的中断引脚连接到了I.MX6ULL 上，但是并没有使用中断功能关于中断的具体用法可以参考SR8201F 数据手册。<br> 3、PHY 地址设置<br> MAC 层通过MDIO/MDC 总线对PHY 进行读写操作，MDIO 最多可以控制32 个PHY 芯片，通过不同的PHY 芯片地址来对不同的PHY 操作。SR8201F 通过设置LED0/PHYAD[0]和LED1/PHYAD[1]这两个引脚来设置其PHY 地址，其地址设置如表69.2.3.1 所示。<br> <img src="https://images2.imgbox.com/d6/79/1LlOwrOE_o.png" alt="在这里插入图片描述"><br> 表69.2.3.1 SR9201F 地址设置<br> 正点原子ALPHA 开发板ENET1 网络的SR8201F 上的LED1/PHYAD1 引脚上拉，<br> LED0/PHYDAD0 引脚下来下拉，因此ENET1 上的SR8201F 地址为0X02。ENET2 网络上的SR8201F 的LED1/PHYAD1 引脚下拉，LED0/PHYAD0 引脚上拉，因此ENET2 上的SR8201F地址为1。<br> 4、SR8021F 内部寄存器<br> SR8201F 的前16 个寄存器满足IEEE 的要求，在这里我们只介绍几个常用的寄存器，首先是BCR(Basic Control Rgsister)寄存器，地址为0，BCR 寄存器各位如表69.2.3.2 所示。<br> <img src="https://images2.imgbox.com/2f/d3/xamqKnKt_o.png" alt="在这里插入图片描述"><br> 表69.2.3.3 BCR 寄存器<br> 我们说的配置PHY 芯片，重点就是配置BCR 寄存器，由于SR8201F 是个10/100M 的PHY，因此表69.2.3.3 中没有体现出1000M 相关的配置。但是10/100M 相关的配置是和IEEE 的规定完全相符的，大家可以选择一个其他的10/100M 的PHY 芯片对比看一下，比如NXP 官方EVK开发板使用的KSZ8081。<br> 接下来看一下BSR(Basic Status Register)寄存器，地址为1。此寄存器为PHY 的状态寄存器，通过此寄存器可以获取到PHY 芯片的工作状态，BSR 寄存器各位如表69.2.3.4 所示：</p> 
<p><img src="https://images2.imgbox.com/42/70/lDudEvnm_o.png" alt="在这里插入图片描述"><br> 表69.2.3.4 BSR 寄存器<br> 从表69.2.3.4 可以看出，和IEEE 标准规定相比，SR8201F 的BSR 寄存器少了几个位，这个没关系的，不管什么PHY 芯片，只要它实现了的位和IEEE 规定相符就行。通过读取BSR 寄存器的值我们可以得到当前的连接速度、双工状态和连接状态等。<br> 接下来看一下SR8201F 的PHY ID 寄存器1 和ID 寄存器2，地址为2 和3，后面就称为寄存器2 和寄存器3。这两个寄存器都是PHY 的ID 寄存器。IEEE 规定寄存器2 和寄存器3 为PHY 的ID 寄存器，这两个寄存器组成一个32 位的唯一ID 值。<br> SR8201F 的ID 寄存器2 如表69.2.3.5 所示：<br> <img src="https://images2.imgbox.com/f6/cd/EfH04Fvz_o.png" alt="在这里插入图片描述"><br> 表69.2.2.5 PHY ID 寄存器2<br> ID 寄存器3 如表69.2.3.6 所示：<br> <img src="https://images2.imgbox.com/d5/8d/hZo8JTom_o.png" alt="在这里插入图片描述"><br> 表69.2.3.6 PHY ID 寄存器3<br> 关于SR8201F 的PHY 寄存器就简单讲这几个，其他的寄存器请自行查阅SR8201F 数据手册。</p> 
<h2><a id="Linux__240"></a>Linux 内核网络驱动框架</h2> 
<h3><a id="net_device__241"></a>net_device 结构体</h3> 
<p>Linux 内核使用net_device 结构体表示一个具体的网络设备，net_device 是整个网络驱动的灵魂。网络驱动的核心就是初始化net_device 结构体中的各个成员变量，然后将初始化完成以后的net_device 注册到Linux 内核中。net_device 结构体定义在include/linux/netdevice.h 中，<br> net_device 是一个庞大的结构体，内容如下(有缩减)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.1</span> net_device 结构体
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token keyword">char</span> name<span class="token punctuation">[</span>IFNAMSIZ<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">hlist_node</span> name_hlist<span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">char</span> <span class="token operator">*</span>ifalias<span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token comment">/*
6 * I/O specific fields
7 * FIXME: Merge these and struct ifmap into one
8 */</span>
<span class="token number">9</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> mem_end<span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> mem_start<span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> base_addr<span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token keyword">int</span> irq<span class="token punctuation">;</span>
<span class="token number">13</span>
<span class="token number">14</span> <span class="token class-name">atomic_t</span> carrier_changes<span class="token punctuation">;</span>
<span class="token number">15</span>
<span class="token number">16</span> <span class="token comment">/*
17 * Some hardware also needs these fields (state,dev_list,
18 * napi_list,unreg_list,close_list) but they are not
19 * part of the usual set specified in Space.c.
20 */</span>
<span class="token number">21</span>
<span class="token number">22</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> state<span class="token punctuation">;</span>
<span class="token number">23</span>
<span class="token number">24</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> dev_list<span class="token punctuation">;</span>
<span class="token number">25</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> napi_list<span class="token punctuation">;</span>
<span class="token number">26</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> unreg_list<span class="token punctuation">;</span>
<span class="token number">27</span> <span class="token keyword">struct</span> <span class="token class-name">list_head</span> close_list<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">60</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_device_ops</span> <span class="token operator">*</span>netdev_ops<span class="token punctuation">;</span>
<span class="token number">61</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">ethtool_ops</span> <span class="token operator">*</span>ethtool_ops<span class="token punctuation">;</span>
<span class="token number">62</span> #ifdef CONFIG_NET_SWITCHDEV
<span class="token number">63</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">swdev_ops</span> <span class="token operator">*</span>swdev_ops<span class="token punctuation">;</span>
<span class="token number">64</span> #endif
<span class="token number">65</span>
<span class="token number">66</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">header_ops</span> <span class="token operator">*</span>header_ops<span class="token punctuation">;</span>
<span class="token number">67</span>
<span class="token number">68</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">77</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> if_port<span class="token punctuation">;</span>
<span class="token number">78</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> dma<span class="token punctuation">;</span>
<span class="token number">79</span>
<span class="token number">80</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> mtu<span class="token punctuation">;</span>
<span class="token number">81</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> type<span class="token punctuation">;</span>
<span class="token number">82</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> hard_header_len<span class="token punctuation">;</span>
<span class="token number">83</span>
<span class="token number">84</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> needed_headroom<span class="token punctuation">;</span>
<span class="token number">85</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> needed_tailroom<span class="token punctuation">;</span>
<span class="token number">86</span>
<span class="token number">87</span> <span class="token comment">/* Interface address info. */</span>
<span class="token number">88</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> perm_addr<span class="token punctuation">[</span>MAX_ADDR_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">89</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> addr_assign_type<span class="token punctuation">;</span>
<span class="token number">90</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> addr_len<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">130</span> <span class="token comment">/*
131 * Cache lines mostly used on receive path (including eth_type_trans())
132 */</span>
<span class="token number">133</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> last_rx<span class="token punctuation">;</span>
<span class="token number">134</span>
<span class="token number">135</span> <span class="token comment">/* Interface address info used in eth_type_trans() */</span>
<span class="token number">136</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>dev_addr<span class="token punctuation">;</span>
<span class="token number">137</span>
<span class="token number">138</span>
<span class="token number">139</span> #ifdef CONFIG_SYSFS
<span class="token number">140</span> <span class="token keyword">struct</span> <span class="token class-name">netdev_rx_queue</span> <span class="token operator">*</span>_rx<span class="token punctuation">;</span>
<span class="token number">141</span>
<span class="token number">142</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_rx_queues<span class="token punctuation">;</span>
<span class="token number">143</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> real_num_rx_queues<span class="token punctuation">;</span>
<span class="token number">144</span>
<span class="token number">145</span> #endif
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">158</span> <span class="token comment">/*
159 * Cache lines mostly used on transmit path
160 */</span>
<span class="token number">161</span> <span class="token keyword">struct</span> <span class="token class-name">netdev_queue</span> <span class="token operator">*</span>_tx ____cacheline_aligned_in_smp<span class="token punctuation">;</span>
<span class="token number">162</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> num_tx_queues<span class="token punctuation">;</span>
<span class="token number">163</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> real_num_tx_queues<span class="token punctuation">;</span>
<span class="token number">164</span> <span class="token keyword">struct</span> <span class="token class-name">Qdisc</span> <span class="token operator">*</span>qdisc<span class="token punctuation">;</span>
<span class="token number">165</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> tx_queue_len<span class="token punctuation">;</span>
<span class="token number">166</span> <span class="token class-name">spinlock_t</span> tx_global_lock<span class="token punctuation">;</span>
<span class="token number">167</span> <span class="token keyword">int</span> watchdog_timeo<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">173</span> <span class="token comment">/* These may be needed for future network-power-down code. */</span>
<span class="token number">174</span>
<span class="token number">175</span> <span class="token comment">/*
176 * trans_start here is expensive for high speed devices on SMP,
177 * please use netdev_queue-&gt;trans_start instead.
178 */</span>
<span class="token number">179</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> trans_start<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">248</span> <span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">;</span>
<span class="token number">249</span> <span class="token keyword">struct</span> <span class="token class-name">lock_class_key</span> <span class="token operator">*</span>qdisc_tx_busylock<span class="token punctuation">;</span>
<span class="token number">250</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>下面介绍一些关键的成员变量，如下：<br> 第2 行：name 是网络设备的名字。<br> 第9 行：mem_end 是共享内存结束地址。<br> 第10 行：mem_start 是共享内存起始地址。<br> 第11 行：base_addr 是网络设备I/O 地址。<br> 第12 行：irq 是网络设备的中断号。<br> 第24 行：dev_list 是全局网络设备列表。<br> 第25 行：napi_list 是napi 网络设备的列表入口。<br> 第26 行：unreg_list 是注销(unregister)的网络设备列表入口。<br> 第27 行：close_list 是关闭的网络设备列表入口。<br> 第60 行：netdev_ops 是网络设备的操作集函数，包含了一系列的网络设备操作回调函数，<br> 类似字符设备中的file_operations，稍后会讲解netdev_ops 结构体。<br> 第61 行：ethtool_ops 是网络管理工具相关函数集，用户空间网络管理工具会调用此结构体中的相关函数获取网卡状态或者配置网卡。<br> 第66 行：header_ops 是头部的相关操作函数集，比如创建、解析、缓冲等。<br> 第68 行：flags 是网络接口标志，标志类型定义在include/uapi/linux/if.h 文件中，为一个枚举类型，内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.2</span> 网络标志类型
<span class="token number">1</span> <span class="token keyword">enum</span> <span class="token class-name">net_device_flags</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> IFF_UP <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">3</span> IFF_BROADCAST <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">4</span> IFF_DEBUG <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">5</span> IFF_LOOPBACK <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">6</span> IFF_POINTOPOINT <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">7</span> IFF_NOTRAILERS <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">8</span> IFF_RUNNING <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">9</span> IFF_NOARP <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">10</span> IFF_PROMISC <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">11</span> IFF_ALLMULTI <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">12</span> IFF_MASTER <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">13</span> IFF_SLAVE <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">14</span> IFF_MULTICAST <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">15</span> IFF_PORTSEL <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">16</span> IFF_AUTOMEDIA <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">17</span> IFF_DYNAMIC <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token comment">/* sysfs */</span>
<span class="token number">18</span> IFF_LOWER_UP <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">19</span> IFF_DORMANT <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">20</span> IFF_ECHO <span class="token operator">=</span> <span class="token number">1</span><span class="token operator">&lt;&lt;</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token comment">/* volatile */</span>
<span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>继续回到示例代码69.3.1.1 接着看net_device 结构体。<br> 第77 行：if_port 指定接口的端口类型，如果设备支持多端口的话就通过if_port 来指定所使用的端口类型。可选的端口类型定义在include/uapi/linux/netdevice.h 中，为一个枚举类型，如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.3</span> 端口类型
<span class="token number">1</span> <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> IF_PORT_UNKNOWN <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">3</span> IF_PORT_10BASE2<span class="token punctuation">,</span>
<span class="token number">4</span> IF_PORT_10BASET<span class="token punctuation">,</span>
<span class="token number">5</span> IF_PORT_AUI<span class="token punctuation">,</span>
<span class="token number">6</span> IF_PORT_100BASET<span class="token punctuation">,</span>
<span class="token number">7</span> IF_PORT_100BASETX<span class="token punctuation">,</span>
<span class="token number">8</span> IF_PORT_100BASEFX
<span class="token number">9</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>第78 行：dma 是网络设备所使用的DMA 通道，不是所有的设备都会用到DMA。<br> 第80 行：mtu 是网络最大传输单元，为1500。<br> 第81 行：type 用于指定ARP 模块的类型，以太网的ARP 接口为ARPHRD_ETHER，Linux<br> 内核所支持的ARP 协议定义在include/uapi/linux/if_arp.h 中，大家自行查阅。<br> 第88 行：perm_addr 是永久的硬件地址，如果某个网卡设备有永久的硬件地址，那么就会填充perm_addr。<br> 第90 行：addr_len 是硬件地址长度。<br> 第133 行：last_rx 是最后接收的数据包时间戳，记录的是jiffies。<br> 第136 行：dev_addr 也是硬件地址，是当前分配的MAC 地址，可以通过软件修改。<br> 第140 行：_rx 是接收队列。<br> 第142 行：num_rx_queues 是接收队列数量，在调用register_netdev 注册网络设备的时候会分配指定数量的接收队列。<br> 第143 行：real_num_rx_queues 是当前活动的队列数量。<br> 第161 行：_tx 是发送队列。<br> 第162 行：num_tx_queues 是发送队列数量，通过alloc_netdev_mq 函数分配指定数量的发送队列。<br> 第163 行：real_num_tx_queues 是当前有效的发送队列数量。<br> 第179 行：trans_start 是最后的数据包发送的时间戳，记录的是jiffies。<br> 第248 行：phydev 是对应的PHY 设备。<br> 1、申请net_device<br> 编写网络驱动的时候首先要申请net_device，使用alloc_netdev 函数来申请net_device，这是一个宏，宏定义如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.4</span> alloc_netdev
<span class="token number">1</span> #define <span class="token function">alloc_netdev</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">,</span> name<span class="token punctuation">,</span> name_assign_type<span class="token punctuation">,</span> setup<span class="token punctuation">)</span> \
<span class="token number">2</span> <span class="token function">alloc_netdev_mqs</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">,</span> name<span class="token punctuation">,</span> name_assign_type<span class="token punctuation">,</span> setup<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
</code></pre> 
<p>可以看出alloc_netdev 的本质是alloc_netdev_mqs 函数，此函数原型如下</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span> <span class="token function">alloc_netdev_mqs</span> <span class="token punctuation">(</span> <span class="token keyword">int</span> sizeof_priv<span class="token punctuation">,</span>
<span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">,</span>
<span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>setup<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> txqs<span class="token punctuation">,</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> rxqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> sizeof_priv：私有数据块大小。<br> name：设备名字。<br> setup：回调函数，初始化设备的设备后调用此函数。<br> txqs：分配的发送队列数量。<br> rxqs：分配的接收队列数量。<br> 返回值：如果申请成功的话就返回申请到的net_device 指针，失败的话就返回NULL。<br> 事实上网络设备有多种，大家不要以为就只有以太网一种。Linux 内核内核支持的网络接口有很多，比如光纤分布式数据接口(FDDI)、以太网设备(Ethernet)、红外数据接口(InDA)、高性能并行接口(HPPI)、CAN 网络等。内核针对不同的网络设备在alloc_netdev 的基础上提供了一层封装，比如我们本章讲解的以太网，针对以太网封装的net_device 申请函数是alloc_etherdev和，这也是一个宏，内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.5</span> alloc_etherdev 函数
<span class="token number">1</span> #define <span class="token function">alloc_etherdev</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">)</span> <span class="token function">alloc_etherdev_mq</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token number">2</span> #define <span class="token function">alloc_etherdev_mq</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">,</span> count<span class="token punctuation">)</span> <span class="token function">alloc_etherdev_mqs</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">,</span> count<span class="token punctuation">,</span> count<span class="token punctuation">)</span>
</code></pre> 
<p>可以看出，alloc_etherdev 最终依靠的是alloc_etherdev_mqs 函数，此函数就是对alloc_netdev_mqs 的简单封装，函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.6</span> alloc_etherdev_mqs 函数
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span><span class="token function">alloc_etherdev_mqs</span><span class="token punctuation">(</span><span class="token keyword">int</span> sizeof_priv<span class="token punctuation">,</span>
<span class="token number">2</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> txqs<span class="token punctuation">,</span>
<span class="token number">3</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> rxqs<span class="token punctuation">)</span>
<span class="token number">4</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">5</span> <span class="token keyword">return</span> <span class="token function">alloc_netdev_mqs</span><span class="token punctuation">(</span>sizeof_priv<span class="token punctuation">,</span> <span class="token string">"eth%d"</span><span class="token punctuation">,</span> NET_NAME_UNKNOWN<span class="token punctuation">,</span>
<span class="token number">6</span> ether_setup<span class="token punctuation">,</span> txqs<span class="token punctuation">,</span> rxqs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token punctuation">}</span>
</code></pre> 
<p>第5 行调用alloc_netdev_mqs 来申请net_device，注意这里设置网卡的名字为“eth%d”，这是格式化字符串，大家进入开发板的linux 系统以后看到的“eth0”、“eth1”这样的网卡名字就是从这里来的。同样的，这里设置了以太网的setup 函数为ether_setup，不同的网络设备其setup函数不同，比如CAN 网络里面setup 函数就是can_setup。<br> ether_setup 函数会对net_device 做初步的初始化，函数内容如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.1</span><span class="token number">.7</span> ether_setup 函数
<span class="token number">1</span> <span class="token keyword">void</span> <span class="token function">ether_setup</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> dev<span class="token operator">-&gt;</span>header_ops <span class="token operator">=</span> <span class="token operator">&amp;</span>eth_header_ops<span class="token punctuation">;</span>
<span class="token number">4</span> dev<span class="token operator">-&gt;</span>type <span class="token operator">=</span> ARPHRD_ETHER<span class="token punctuation">;</span>
<span class="token number">5</span> dev<span class="token operator">-&gt;</span>hard_header_len <span class="token operator">=</span> ETH_HLEN<span class="token punctuation">;</span>
<span class="token number">6</span> dev<span class="token operator">-&gt;</span>mtu <span class="token operator">=</span> ETH_DATA_LEN<span class="token punctuation">;</span>
<span class="token number">7</span> dev<span class="token operator">-&gt;</span>addr_len <span class="token operator">=</span> ETH_ALEN<span class="token punctuation">;</span>
<span class="token number">8</span> dev<span class="token operator">-&gt;</span>tx_queue_len <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span> <span class="token comment">/* Ethernet wants good queues */</span>
<span class="token number">9</span> dev<span class="token operator">-&gt;</span>flags <span class="token operator">=</span> IFF_BROADCAST<span class="token operator">|</span>IFF_MULTICAST<span class="token punctuation">;</span>
<span class="token number">10</span> dev<span class="token operator">-&gt;</span>priv_flags <span class="token operator">|=</span> IFF_TX_SKB_SHARING<span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token function">eth_broadcast_addr</span><span class="token punctuation">(</span>dev<span class="token operator">-&gt;</span>broadcast<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token punctuation">}</span>
</code></pre> 
<p>关于net_device 的申请就讲解到这里，对于网络设备而言，使用alloc_etherdev 或<br> alloc_etherdev_mqs 来申请net_device。NXP 官方编写的网络驱动就是采用alloc_etherdev_mqs<br> 来申请net_device。<br> 2、删除net_device<br> 当我们注销网络驱动的时候需要释放掉前面已经申请到的net_device，释放函数为free_netdev，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">free_netdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> dev：要释放掉的net_device 指针。<br> 返回值：无。<br> 3、注册net_device<br> net_device 申请并初始化完成以后就需要向内核注册net_device，要用到函数register_netdev，<br> 函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">register_netdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> dev：要注册的net_device 指针。<br> 返回值：0 注册成功，负值注册失败。<br> 4、注销net_device<br> 既然有注册，那么必然有注销，注销net_device 使用函数unregister_netdev，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">unregister_netdev</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> dev：要注销的net_device 指针。<br> 返回值：无。</p> 
<h3><a id="net_device_ops__516"></a>net_device_ops 结构体</h3> 
<p>net_device 有个非常重要的成员变量：netdev_ops，为net_device_ops 结构体指针类型，这就是网络设备的操作集。net_device_ops 结构体定义在include/linux/netdevice.h 文件中，net_device_ops 结构体里面都是一些以“ndo_”开头的函数，这些函数就需要网络驱动编写人员去实现，不需要全部都实现，根据实际驱动情况实现其中一部分即可。结构体内容如下所示(结构体比较大，这里有缩减)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.2</span><span class="token number">.1</span> net_device_ops 结构体
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">net_device_ops</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_init<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">3</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_uninit<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_open<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_stop<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token class-name">netdev_tx_t</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_start_xmit<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
<span class="token number">7</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span> <span class="token function">u16</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_select_queue<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">9</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
<span class="token number">10</span> <span class="token keyword">void</span> <span class="token operator">*</span>accel_priv<span class="token punctuation">,</span>
<span class="token number">11</span> <span class="token class-name">select_queue_fallback_t</span> fallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_change_rx_flags<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">13</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_set_rx_mode<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_set_mac_address<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">16</span> <span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">17</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_validate_addr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_do_ioctl<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">19</span> <span class="token keyword">struct</span> <span class="token class-name">ifreq</span> <span class="token operator">*</span>ifr<span class="token punctuation">,</span> <span class="token keyword">int</span> cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">20</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_set_config<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">21</span> <span class="token keyword">struct</span> <span class="token class-name">ifmap</span> <span class="token operator">*</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_change_mtu<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">23</span> <span class="token keyword">int</span> new_mtu<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">24</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_neigh_setup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">25</span> <span class="token keyword">struct</span> <span class="token class-name">neigh_parms</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">26</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_tx_timeout<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">36</span> #ifdef CONFIG_NET_POLL_CONTROLLER
<span class="token number">37</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_poll_controller<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">38</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_netpoll_setup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">39</span> <span class="token keyword">struct</span> <span class="token class-name">netpoll_info</span> <span class="token operator">*</span>info<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">40</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_netpoll_cleanup<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">41</span> #endif
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">104</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ndo_set_features<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">105</span> <span class="token class-name">netdev_features_t</span> features<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">166</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>第2 行：ndo_init 函数，当第一次注册网络设备的时候此函数会执行，设备可以在此函数中做一些需要推后初始化的内容，不过一般驱动中不使用此函数，虚拟网络设备可能会使用。<br> 第3 行：ndo_uninit 函数，卸载网络设备的时候此函数会执行。<br> 第4 行：ndo_open 函数，打开网络设备的时候此函数会执行，网络驱动程序需要实现此函数，非常重要！以NXP 的I.MX 系列SOC 网络驱动为例，会在此函数中做如下工作：<br> ·使能网络外设时钟。<br> ·申请网络所使用的环形缓冲区。<br> ·初始化MAC 外设。<br> ·绑定接口对应的PHY。<br> ·如果使用NAPI 的话要使能NAPI 模块，通过napi_enable 函数来使能。<br> ·开启PHY。<br> ·调用netif_tx_start_all_queues 来使能传输队列，也可能调用netif_start_queue 函数。<br> ·……<br> 第5 行：ndo_stop 函数，关闭网络设备的时候此函数会执行，网络驱动程序也需要实现此函数。以NXP 的I.MX 系列SOC 网络驱动为例，会在此函数中做如下工作：<br> ·停止PHY。<br> ·停止NAPI 功能。<br> ·停止发送功能。<br> ·关闭MAC。<br> ·断开PHY 连接。<br> ·关闭网络时钟。<br> ·释放数据缓冲区。<br> ·……<br> 第6 行：ndo_start_xmit 函数，当需要发送数据的时候此函数就会执行，此函数有一个参数为sk_buff 结构体指针，sk_buff 结构体在Linux 的网络驱动中非常重要，sk_buff 保存了上层传递给网络驱动层的数据。也就是说，要发送出去的数据都存在了sk_buff 中，关于sk_buff 稍后会做详细的讲解。如果发送成功的话此函数返回NETDEV_TX_OK，如果发送失败了就返回NETDEV_TX_BUSY，如果发送失败了我们就需要停止队列。<br> 第8 行：ndo_select_queue 函数，当设备支持多传输队列的时候选择使用哪个队列。<br> 第14 行：ndo_set_rx_mode 函数，此函数用于改变地址过滤列表，根据net_device 的flags成员变量来设置SOC 的网络外设寄存器。比如flags 可能为IFF_PROMISC、IFF_ALLMULTI 或IFF_MULTICAST，分别表示混杂模式、单播模式或多播模式。<br> 第15 行：ndo_set_mac_address 函数，此函数用于修改网卡的MAC 地址，设置net_device的dev_addr 成员变量，并且将MAC 地址写入到网络外设的硬件寄存器中。<br> 第17 行：ndo_validate_addr 函数，验证MAC 地址是否合法，也就是验证net_device 的dev_addr 中的MAC 地址是否合法，直接调用is_valid_ether_addr 函数。<br> 第18 行：ndo_do_ioctl 函数，用户程序调用ioctl 的时候此函数就会执行，比如PHY 芯片相关的命令操作，一般会直接调用phy_mii_ioctl 函数。<br> 第22 行：ndo_change_mtu 函数，更改MTU 大小。<br> 第26 行：ndo_tx_timeout 函数，当发送超时的时候函数会执行，一般都是网络出问题了导致发送超时。一般可能会重启MAC 和PHY，重新开始数据发送等。<br> 第37 行：ndo_poll_controller 函数，使用查询方式来处理网卡数据的收发。<br> 第104 行：ndo_set_features 函数，修改net_device 的features 属性，设置相应的硬件属性。</p> 
<h3><a id="sk_buff__591"></a>sk_buff 结构体</h3> 
<p>网络是分层的，对于应用层而言不用关心具体的底层是如何工作的，只需要按照协议将要发送或接收的数据打包好即可。打包好以后都通过dev_queue_xmit 函数将数据发送出去，接收数据的话使用netif_rx 函数即可，我们依次来看一下这两个函数。<br> 1、dev_queue_xmit 函数<br> 此函数用于将网络数据发送出去，函数定义在include/linux/netdevice.h 中，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">int</span> <span class="token function">dev_queue_xmit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：要发送的数据，这是一个sk_buff 结构体指针，sk_buff 是Linux 网络驱动中一个非常重要的结构体，网络数据就是以sk_buff 保存的，各个协议层在sk_buff 中添加自己的协议头，最终由底层驱动将sk_buff 中的数据发送出去。网络数据的接收过程恰好相反，网络底层驱动将接收到的原始数据打包成sk_buff，然后发送给上层协议，上层会取掉相应的头部，然后将最终的数据发送给用户。<br> 返回值：0 发送成功，负值发送失败。<br> dev_queue_xmit 函数太长，这里就不详细的分析了，dev_queue_xmit 函数最终是通过net_device_ops 操作集里面的ndo_start_xmit 函数来完成最终发送了，ndo_start_xmit 就是网络驱动编写人员去实现的，整个流程如图69.3.3.1 所示：</p> 
<p><img src="https://images2.imgbox.com/8d/e9/THHO3TkO_o.png" alt="在这里插入图片描述"><br> 图69.3.3.1 dev_queue_xmit 执行流程<br> 2、netif_rx 函数<br> 上层接收数据的话使用netif_rx 函数，但是最原始的网络数据一般是通过轮询、中断或NAPI的方式来接收。netif_rx 函数定义在net/core/dev.c 中，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">netif_rx</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：保存接收数据的sk_buff，。<br> 返回值：NET_RX_SUCCESS 成功，NET_RX_DROP 数据包丢弃。<br> 我们重点来看一下sk_buff 这个结构体，sk_buff 是Linux 网络重要的数据结构，用于管理接收或发送数据包，sk_buff 结构体定义在include/linux/skbuff.h 中，结构体内容如下(由于结构体比较大，为了缩小篇幅只列出部分重要的内容)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.3</span><span class="token number">.1</span> sk_buff 结构体
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">4</span> <span class="token comment">/* These two members must be first. */</span>
<span class="token number">5</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>next<span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>prev<span class="token punctuation">;</span>
<span class="token number">7</span>
<span class="token number">8</span> <span class="token keyword">union</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">9</span> <span class="token class-name">ktime_t</span> tstamp<span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token keyword">struct</span> <span class="token class-name">skb_mstamp</span> skb_mstamp<span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token keyword">struct</span> <span class="token class-name">rb_node</span> rbnode<span class="token punctuation">;</span> <span class="token comment">/* used in netem &amp; tcp stack */</span>
<span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token keyword">struct</span> <span class="token class-name">sock</span> <span class="token operator">*</span>sk<span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">;</span>
<span class="token number">17</span>
<span class="token number">18</span> <span class="token comment">/*
19 * This is the control buffer. It is free to use for every
20 * layer. Please put your private variables there. If you
21 * want to keep them across layers you have to do a skb_clone()
22 * first. This is owned by whoever has the skb queued ATM.
23 */</span>
<span class="token number">24</span> <span class="token keyword">char</span> cb<span class="token punctuation">[</span><span class="token number">48</span><span class="token punctuation">]</span> <span class="token function">__aligned</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">25</span>
<span class="token number">26</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> _skb_refdst<span class="token punctuation">;</span>
<span class="token number">27</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>destructor<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">37</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> data_len<span class="token punctuation">;</span>
<span class="token number">38</span> __u16 mac_len<span class="token punctuation">,</span> hdr_len<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">145</span> __be16 protocol<span class="token punctuation">;</span>
<span class="token number">146</span> __u16 transport_header<span class="token punctuation">;</span>
<span class="token number">147</span> __u16 network_header<span class="token punctuation">;</span>
<span class="token number">148</span> __u16 mac_header<span class="token punctuation">;</span>
<span class="token number">149</span>
<span class="token number">150</span> <span class="token comment">/* private: */</span>
<span class="token number">151</span> __u32 headers_end<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">152</span> <span class="token comment">/* public: */</span>
<span class="token number">153</span>
<span class="token number">154</span> <span class="token comment">/* These elements must be at the end, see alloc_skb() for details. */</span>
<span class="token number">155</span> <span class="token class-name">sk_buff_data_t</span> tail<span class="token punctuation">;</span>
<span class="token number">156</span> <span class="token class-name">sk_buff_data_t</span> end<span class="token punctuation">;</span>
<span class="token number">157</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>head<span class="token punctuation">,</span> <span class="token operator">*</span>data<span class="token punctuation">;</span>
<span class="token number">158</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> truesize<span class="token punctuation">;</span>
<span class="token number">159</span> <span class="token class-name">atomic_t</span> users<span class="token punctuation">;</span>
<span class="token number">160</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>第5~6 行：next 和prev 分别指向下一个和前一个sk_buff，构成一个双向链表。<br> 第9 行：tstamp 表示数据包接收时或准备发送时的时间戳。<br> 第15 行：sk 表示当前sk_buff 所属的Socket。<br> 第16 行：dev 表示当前sk_buff 从哪个设备接收到或者发出的。<br> 第24 行：cb 为控制缓冲区，不管哪个层都可以自由使用此缓冲区，用于放置私有数据。<br> 第27 行：destructor 函数，当释放缓冲区的时候可以在此函数里面完成某些动作。<br> 第37 行：len 为实际的数据长度，包括主缓冲区中数据长度和分片中的数据长度。data_len为数据长度，只计算分片中数据的长度。<br> 第38 行：mac_len 为连接层头部长度，也就是MAC 头的长度。<br> 第145 行：protocol 协议。<br> 第146 行：transport_header 为传输层头部。<br> 第147 行：network_header 为网络层头部<br> 第148 行：mac_header 为链接层头部。<br> 第155 行：tail 指向实际数据的尾部。<br> 第156 行：end 指向缓冲区的尾部。<br> 第157 行：head 指向缓冲区的头部，data 指向实际数据的头部。data 和tail 指向实际数据的头部和尾部，head 和end 指向缓冲区的头部和尾部。结构如图69.3.3.2 所示：<br> <img src="https://images2.imgbox.com/ac/b4/5fzPkFT4_o.png" alt="在这里插入图片描述"><br> 图69.3.3.2 sk_buff 数据区结构示意图<br> 针对sk_buff 内核提供了一系列的操作与管理函数，我们简单看一些常见的API 函数：<br> 1、分配sk_buff<br> 要使用sk_buff 必须先分配，首先来看一下alloc_skb 这个函数，此函数定义在<br> include/linux/skbuff.h 中，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token function">alloc_skb</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span>
<span class="token class-name">gfp_t</span> priority<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> size：要分配的大小，也就是skb 数据段大小。<br> priority：为GFP MASK 宏，比如GFP_KERNEL、GFP_ATOMIC 等。<br> 返回值：分配成功的话就返回申请到的sk_buff 首地址，失败的话就返回NULL。<br> 在网络设备驱动中常常使用netdev_alloc_skb 来为某个设备申请一个用于接收的skb_buff，此函数也定义在include/linux/skbuff.h 中，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span><span class="token function">netdev_alloc_skb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> length<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> dev：要给哪个设备分配sk_buff。<br> length：要分配的大小。<br> 返回值：分配成功的话就返回申请到的sk_buff 首地址，失败的话就返回NULL。<br> 2、释放sk_buff<br> 当使用完成以后就要释放掉sk_buff ，释放函数可以使用kfree_skb ，函数定义在<br> include/linux/skbuff.c 中，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">kfree_skb</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：要释放的sk_buff。<br> 返回值：无。<br> 对于网络设备而言最好使用如下所示释放函数：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">dev_kfree_skb</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">)</span>
</code></pre> 
<p>函数只要一个参数skb，就是要释放的sk_buff。<br> 3、skb_put、skb_push、sbk_pull 和skb_reserve<br> 这四个函数用于变更sk_buff，先来看一下skb_put 函数，此函数用于在尾部扩展skb_buff的数据区，也就将skb_buff 的tail 后移n 个字节，从而导致skb_buff 的len 增加n 个字节，原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">skb_put</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：要操作的sk_buff。<br> len：要增加多少个字节。<br> 返回值：扩展出来的那一段数据区首地址。<br> skb_put 操作之前和操作之后的数据区如图69.3.3.3 所示：<br> <img src="https://images2.imgbox.com/13/cb/vqVCBpaY_o.png" alt="在这里插入图片描述"><br> 图69.3.3.3 skb_put 函数操作前后对比<br> skb_push 函数用于在头部扩展skb_buff 的数据区，函数原型如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">skb_push</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：要操作的sk_buff。<br> len：要增加多少个字节。<br> 返回值：扩展完成以后新的数据区首地址。<br> skb_push 操作之前和操作之后的数据区如图69.3.3.4 所示：<br> <img src="https://images2.imgbox.com/ab/f3/P4EQib0P_o.png" alt="在这里插入图片描述"><br> 图69.3.3.4 skb_push 函数操作前后对比<br> sbk_pull 函数用于从sk_buff 的数据区起始位置删除数据，函数原型如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token function">skb_pull</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：要操作的sk_buff。<br> len：要删除的字节数。<br> 返回值：删除以后新的数据区首地址。<br> skb_pull 操作之前和操作之后的数据区如图69.3.3.5 所示：<br> <img src="https://images2.imgbox.com/32/60/3sGffnsx_o.png" alt="在这里插入图片描述"><br> 图69.3.3.5 skb_pull 函数操作前后对比<br> sbk_reserve 函数用于调整缓冲区的头部大小，方法很简单将skb_buff 的data 和tail 同时后移n 个字节即可，函数原型如下所示：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">skb_reserve</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> skb：要操作的sk_buff。<br> len：要增加的缓冲区头部大小。<br> 返回值：无。</p> 
<h3><a id="_NAPI__780"></a>网络 NAPI 处理机制(综合轮询和中断方式)</h3> 
<p>如果玩过单片机的话应该都知道，像IIC、SPI、网络等这些通信接口，接收数据有两种方法：轮询或中断。Linux 里面的网络数据接收也轮询和中断两种，中断的好处就是响应快，数据量小的时候处理及时，速度快，但是一旦当数据量大，而且都是短帧的时候会导致中断频繁发生，消耗大量的CPU 处理时间在中断自身处理上。轮询恰好相反，响应没有中断及时，但是在处理大量数据的时候不需要消耗过多的CPU 处理时间。Linux 在这两个处理方式的基础上提出了另外一种网络数据接收的处理方法：NAPI(New API)，NAPI 是一种高效的网络处理技术。<br> NAPI 的核心思想就是不全部采用中断来读取网络数据，而是采用中断来唤醒数据接收服务程序，在接收服务程序中采用POLL 的方法来轮询处理数据。这种方法的好处就是可以提高短数据包的接收效率，减少中断处理的时间。目前NAPI 已经在Linux 的网络驱动中得到了大量的应用，NXP 官方编写的网络驱动都是采用的NAPI 机制。<br> 关于NAPI 详细的处理过程本章节不讨论，本章节就简单讲解一下如何在驱动中使用NAPI，Linux 内核使用结构体napi_struct 表示NAPI，在使用NAPI 之前要先初始化一个napi_struct 实例。<br> 1、初始化NAPI<br> 首先要初始化一个napi_struct 实例，使用netif_napi_add 函数，此函数定义在net/core/dev.c中，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">netif_napi_add</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>napi<span class="token punctuation">,</span>
<span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>poll<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">int</span> weight<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> dev：每个NAPI 必须关联一个网络设备，此参数指定NAPI 要关联的网络设备。<br> napi：要初始化的NAPI 实例。<br> poll：NAPI 所使用的轮询函数，非常重要，一般在此轮询函数中完成网络数据接收的工作。<br> weight：NAPI 默认权重(weight)，一般为NAPI_POLL_WEIGHT。<br> 返回值：无。<br> 2、删除NAPI<br> 如果要删除NAPI，使用netif_napi_del 函数即可，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">netif_napi_del</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>napi<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> napi：要删除的NAPI。<br> 返回值：无。<br> 3、使能NAPI<br> 初始化完NAPI 以后，必须使能才能使用，使用函数napi_enable，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">napi_enable</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>n<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> n：要使能的NAPI。<br> 返回值：无。<br> 4、关闭NAPI<br> 关闭NAPI 使用napi_disable 函数即可，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">napi_disable</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>n<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> n：要关闭的NAPI。<br> 返回值：无。<br> 5、检查NAPI 是否可以进行调度<br> 使用napi_schedule_prep 函数检查NAPI 是否可以进行调度，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">inline</span> bool <span class="token function">napi_schedule_prep</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>n<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> n：要检查的NAPI。<br> 返回值：如果可以调度就返回真，如果不可调度就返回假。<br> 6、NAPI 调度<br> 如果可以调度的话就进行调度，使用__napi_schedule 函数完成NAPI 调度，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">__napi_schedule</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>n<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> n：要调度的NAPI。<br> 返回值：无。</p> 
<p>我们也可以使用napi_schedule 函数来一次完成napi_schedule_prep 和__napi_schedule 这两<br> 个函数的工作，napi_schedule 函数内容如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.3</span><span class="token number">.4</span><span class="token number">.1</span> napi_schedule 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">napi_schedule</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>n<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">napi_schedule_prep</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">4</span> <span class="token function">__napi_schedule</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token punctuation">}</span>
</code></pre> 
<p>从示例代码69.3.4.1 可以看出，napi_schedule 函数就是对napi_schedule_prep 和<br> __napi_schedule 的简单封装，一次完成判断和调度。<br> 7、NAPI 处理完成<br> NAPI 处理完成以后需要调用napi_complete 函数来标记NAPI 处理完成，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">napi_complete</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>n<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> n：处理完成的NAPI。<br> 返回值：无。</p> 
<h2><a id="IMX6ULL__875"></a>I.MX6ULL 网络驱动简介</h2> 
<h3><a id="IMX6ULL__876"></a>I.MX6ULL 网络外设设备树</h3> 
<p>上一小节我们对Linux 的网络驱动框架进行了一个简单的介绍，本节我们就来简单分析一下I.MX6ULL 的网络驱动源码。I.MX6ULL 有两个10/100M 的网络MAC 外设，因此I.MX6ULL网络驱动主要就是这两个网络MAC 外设的驱动。这两个外设的驱动都是一样的，我们分析其中一个就行了，首先肯定是设备树，NXP 的I.MX 系列SOC 网络绑定文档为Documentation/devicetree/bindings/net/fsl-fec.txt，此绑定文档描述了I.MX 系列SOC 网络设备树节点的要求。<br> ①、必要属性<br> compatible：这个肯定是必须的，一般是“fsl,-fec”，比如I.MX6ULL 的compatible 属性就是"fsl,imx6ul-fec",和"fsl,imx6q-fec"。<br> reg：SOC 网络外设寄存器地址范围。<br> interrupts：网络中断。<br> phy-mode：网络所使用的PHY 接口模式，是MII 还是RMII。<br> ②、可选属性<br> phy-reset-gpios：PHY 芯片的复位引脚。<br> phy-reset-duration：PHY 复位引脚复位持续时间，单位为毫秒。只有当设置了phy-reset-gpios 属性此属性才会有效，如果不设置此属性的话PHY 芯片复位引脚的复位持续时间默认为<br> 1 毫秒，数值不能大于1000 毫秒，大于1000 毫秒的话就会强制设置为1 毫秒。<br> phy-supply：PHY 芯片的电源调节。<br> phy-handle：连接到此网络设备的PHY 芯片句柄。<br> fsl,num-tx-queues：此属性指定发送队列的数量，如果不指定的话默认为1。<br> fsl,num-rx-queues：此属性指定接收队列的数量，如果不指定的话默认为2。<br> fsl,magic-packet：此属性不用设置具体的值，直接将此属性名字写到设备树里面即可，表示支持硬件魔术帧唤醒。<br> fsl,wakeup_irq：此属性设置唤醒中断索引。<br> stop-mode：如果此属性存在的话表明SOC 需要设置GPR 位来请求停止模式。<br> ③、可选子节点<br> mdio：可以设置名为“mdio”的子节点，此子节点用于指定网络外设所使用的MDIO 总线，主要作为PHY 节点的容器，也就是在mdio 子节点下指定PHY 相关的属性信息，具体信息可以参考PHY 的绑定文档Documentation/devicetree/bindings/net/phy.txt。<br> PHY 节点相关属性内容如下：<br> interrupts：中断属性，可以不需要。<br> interrupt-parent：中断控制器句柄，可以不需要。<br> reg：PHY 芯片地址，必须的！<br> compatible：兼容性列表，一般为“ethernet-phy-ieee802.3-c22”或“ethernet-phy-ieee802.3-c45”，分别对应IEEE802.3 的22 簇和45 簇，默认是22 簇。也可以设置为其他值，如果PHY的ID 不知道的话可以compatible 属性可以设置为“ethernet-phy-idAAAA.BBBB”，AAAA 和BBBB 的含义如下：<br> AAAA：PHY 的16 位ID 寄存器1 值，也就是OUI 的bit3~18，16 进制格式。<br> BBBB：PHY 的16 位ID 寄存器2 值，也就是OUI 的bit19~24，16 进制格式。<br> max-speed：PHY 支持的最高速度，比如10、100 或1000。<br> 打开imx6ull.dtsi，找到如下I.MX6ULL 的两个网络外设节点，如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.1</span><span class="token number">.1</span> 网络节点信息
<span class="token number">1</span> fec1<span class="token operator">:</span> ethernet@<span class="token number">02188000</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-fec"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx6q-fec"</span><span class="token punctuation">;</span>
<span class="token number">3</span> reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x02188000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">4</span> interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">118</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">5</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">119</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">6</span> clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">7</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET_AHB<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">8</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET_PTP<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">9</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET_REF<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">10</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET_REF<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">11</span> clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"ipg"</span><span class="token punctuation">,</span> <span class="token string">"ahb"</span><span class="token punctuation">,</span> <span class="token string">"ptp"</span><span class="token punctuation">,</span>
<span class="token number">12</span> <span class="token string">"enet_clk_ref"</span><span class="token punctuation">,</span> <span class="token string">"enet_out"</span><span class="token punctuation">;</span>
<span class="token number">13</span> stop<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpr <span class="token number">0x10</span> <span class="token number">3</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">14</span> fsl<span class="token punctuation">,</span>num<span class="token operator">-</span>tx<span class="token operator">-</span>queues<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">15</span> fsl<span class="token punctuation">,</span>num<span class="token operator">-</span>rx<span class="token operator">-</span>queues<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">16</span> fsl<span class="token punctuation">,</span>magic<span class="token operator">-</span>packet<span class="token punctuation">;</span>
<span class="token number">17</span> fsl<span class="token punctuation">,</span>wakeup_irq <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">18</span> status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">20</span>
<span class="token number">21</span> fec2<span class="token operator">:</span> ethernet@<span class="token number">020</span>b4000 <span class="token punctuation">{<!-- --></span>
<span class="token number">22</span> compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-fec"</span><span class="token punctuation">,</span> <span class="token string">"fsl,imx6q-fec"</span><span class="token punctuation">;</span>
<span class="token number">23</span> reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0x020b4000</span> <span class="token number">0x4000</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">24</span> interrupts <span class="token operator">=</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">120</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">25</span> <span class="token operator">&lt;</span>GIC_SPI <span class="token number">121</span> IRQ_TYPE_LEVEL_HIGH<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">26</span> clocks <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">27</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET_AHB<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">28</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET_PTP<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">29</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET2_REF_125M<span class="token operator">&gt;</span><span class="token punctuation">,</span>
<span class="token number">30</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>clks IMX6UL_CLK_ENET2_REF_125M<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">31</span> clock<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"ipg"</span><span class="token punctuation">,</span> <span class="token string">"ahb"</span><span class="token punctuation">,</span> <span class="token string">"ptp"</span><span class="token punctuation">,</span>
<span class="token number">32</span> <span class="token string">"enet_clk_ref"</span><span class="token punctuation">,</span> <span class="token string">"enet_out"</span><span class="token punctuation">;</span>
<span class="token number">33</span> stop<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpr <span class="token number">0x10</span> <span class="token number">4</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">34</span> fsl<span class="token punctuation">,</span>num<span class="token operator">-</span>tx<span class="token operator">-</span>queues<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">35</span> fsl<span class="token punctuation">,</span>num<span class="token operator">-</span>rx<span class="token operator">-</span>queues<span class="token operator">=</span><span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">36</span> fsl<span class="token punctuation">,</span>magic<span class="token operator">-</span>packet<span class="token punctuation">;</span>
<span class="token number">37</span> fsl<span class="token punctuation">,</span>wakeup_irq <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">38</span> status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
<span class="token number">39</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>fec1 和fec2 分别对应I.MX6ULL 的ENET1 和ENET2，至于节点的具体属性就不分析了，上面在讲解绑定文档的时候就已经详细的讲过了。示例代码69.4.1.1 是NXP 官方编写的，我们不需要去修改，但是示例代码69.4.1.1 是不能工作的，还需要根据实际情况添加或修改一些属性。打开imx6ull-alientek-emmc.dts，找到如下内容：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.1</span><span class="token number">.2</span> imx6ull<span class="token operator">-</span>alientek<span class="token operator">-</span>emmc<span class="token punctuation">.</span>dts 中的网络节点
<span class="token number">1</span> <span class="token operator">&amp;</span>fec1 <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
<span class="token number">3</span> pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_enet1
<span class="token number">4</span> <span class="token operator">&amp;</span>pinctrl_enet1_reset<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">5</span> phy<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token string">"rmii"</span><span class="token punctuation">;</span>
<span class="token number">6</span> phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethphy0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">7</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">7</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">8</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>duration <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">200</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">9</span> status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token operator">&amp;</span>fec2 <span class="token punctuation">{<!-- --></span>
<span class="token number">13</span> pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
<span class="token number">14</span> pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_enet2
<span class="token number">15</span> <span class="token operator">&amp;</span>pinctrl_enet2_reset<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">16</span> phy<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token string">"rmii"</span><span class="token punctuation">;</span>
<span class="token number">17</span> phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethphy1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">18</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">8</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">19</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>duration <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">200</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">20</span> status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token number">21</span>
<span class="token number">22</span> mdio <span class="token punctuation">{<!-- --></span>
<span class="token number">23</span> #address<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">24</span> #size<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">25</span>
<span class="token number">26</span> ethphy0<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">27</span> compatible <span class="token operator">=</span> <span class="token string">"ethernet-phy-ieee802.3-c22"</span><span class="token punctuation">;</span>
<span class="token number">28</span> reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">29</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">30</span>
<span class="token number">31</span> ethphy1<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">32</span> compatible <span class="token operator">=</span> <span class="token string">"ethernet-phy-ieee802.3-c22"</span><span class="token punctuation">;</span>
<span class="token number">33</span> reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">34</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">35</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">36</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>示例代码69.4.1.2 是作者在移植Linux 内核的时候已经根据ALPHA 开发板修改后的，并不是NXP 官方原版节点信息，所以会有一点出入，这个不要紧。<br> 第1~10 行：ENET1 网口的节点属性，第3、4 行设置ENET1 所使用的引脚pinctrl 节点信息，第5 行设置网络对应的PHY 芯片接口为RMII，这个要根据实际的硬件来设置。第6 行设置PHY 芯片的句柄为ethphy0，MDIO 节点会设置PHY 信息。其他的属性信息就很好理解了，<br> 基本已经在上面讲解绑定文档的时候说过了。<br> 第12 ~ 36 行：ENET2 网口的节点属性，基本和ENET1 网口一致，区别就是多了第22~35行的mdio 子节点，前面讲解绑定文档的时候说了，mido 子节点用于描述MIDO 总线，在此子节点内会包含PHY 节点信息。这里一共有两个PHY 子节点：ethphy0 和ethphy1，分别对应ENET1 和ENET2 的PHY 芯片。比如第26 行的“ethphy0: ethernet-phy@0”就是ENET1 的PHY节点名字，“@”后面的0 就是此PHY 芯片的芯片地址，reg 属性也是描述PHY 芯片地址的，这点和IIC 设备节点很像。其他地方就没什么好多的了，绑定文档已经讲解的很清楚了。<br> 最后就是设备树中网络相关引脚的描述，打开imx6ull-alientek-emmc.dts，找到如下所示内容：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.1</span><span class="token number">.2</span> 网络引脚pinctrl 信息
<span class="token number">1</span> pinctrl_enet1<span class="token operator">:</span> enet1grp <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
<span class="token number">3</span> MX6UL_PAD_ENET1_RX_EN__ENET1_RX_EN <span class="token number">0x1b0b0</span>
<span class="token number">4</span> MX6UL_PAD_ENET1_RX_ER__ENET1_RX_ER <span class="token number">0x1b0b0</span>
<span class="token number">5</span> MX6UL_PAD_ENET1_RX_DATA0__ENET1_RDATA00 <span class="token number">0x1b0b0</span>
<span class="token number">6</span> MX6UL_PAD_ENET1_RX_DATA1__ENET1_RDATA01 <span class="token number">0x1b0b0</span>
<span class="token number">7</span> MX6UL_PAD_ENET1_TX_EN__ENET1_TX_EN <span class="token number">0x1b0b0</span>
<span class="token number">8</span> MX6UL_PAD_ENET1_TX_DATA0__ENET1_TDATA00 <span class="token number">0x1b0b0</span>
<span class="token number">9</span> MX6UL_PAD_ENET1_TX_DATA1__ENET1_TDATA01 <span class="token number">0x1b0b0</span>
<span class="token number">10</span> MX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1 <span class="token number">0x4001b009</span>
<span class="token number">11</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">13</span>
<span class="token number">14</span> pinctrl_enet2<span class="token operator">:</span> enet2grp <span class="token punctuation">{<!-- --></span>
<span class="token number">15</span> fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
<span class="token number">16</span> MX6UL_PAD_GPIO1_IO07__ENET2_MDC <span class="token number">0x1b0b0</span>
<span class="token number">17</span> MX6UL_PAD_GPIO1_IO06__ENET2_MDIO <span class="token number">0x1b0b0</span>
<span class="token number">18</span> MX6UL_PAD_ENET2_RX_EN__ENET2_RX_EN <span class="token number">0x1b0b0</span>
<span class="token number">19</span> MX6UL_PAD_ENET2_RX_ER__ENET2_RX_ER <span class="token number">0x1b0b0</span>
<span class="token number">20</span> MX6UL_PAD_ENET2_RX_DATA0__ENET2_RDATA00 <span class="token number">0x1b0b0</span>
<span class="token number">21</span> MX6UL_PAD_ENET2_RX_DATA1__ENET2_RDATA01 <span class="token number">0x1b0b0</span>
<span class="token number">22</span> MX6UL_PAD_ENET2_TX_EN__ENET2_TX_EN <span class="token number">0x1b0b0</span>
<span class="token number">23</span> MX6UL_PAD_ENET2_TX_DATA0__ENET2_TDATA00 <span class="token number">0x1b0b0</span>
<span class="token number">24</span> MX6UL_PAD_ENET2_TX_DATA1__ENET2_TDATA01 <span class="token number">0x1b0b0</span>
<span class="token number">25</span> MX6UL_PAD_ENET2_TX_CLK__ENET2_REF_CLK2 <span class="token number">0x4001b009</span>
<span class="token number">26</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">27</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">28</span>
<span class="token number">29</span> <span class="token comment">/*enet1 reset zuozhongkai*/</span>
<span class="token number">30</span> pinctrl_enet1_reset<span class="token operator">:</span> enet1resetgrp <span class="token punctuation">{<!-- --></span>
<span class="token number">31</span> fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
<span class="token number">32</span> <span class="token comment">/* used for enet1 reset */</span>
<span class="token number">33</span> MX6ULL_PAD_SNVS_TAMPER7__GPIO5_IO07 <span class="token number">0x10B0</span>
<span class="token number">34</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">35</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">36</span>
<span class="token number">37</span> <span class="token comment">/*enet2 reset zuozhongkai*/</span>
<span class="token number">38</span> pinctrl_enet2_reset<span class="token operator">:</span> enet2resetgrp <span class="token punctuation">{<!-- --></span>
<span class="token number">39</span> fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
<span class="token number">40</span> <span class="token comment">/* used for enet2 reset */</span>
<span class="token number">41</span> MX6ULL_PAD_SNVS_TAMPER8__GPIO5_IO08 <span class="token number">0x10B0</span>
<span class="token number">42</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">43</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>pinctrl_enet1 和pinctrl_enet1_reset 是ENET1 所有的IO 引脚pinctrl 信息，之所以分两部分主要是因为ENET1 的复位引脚为GPIO5_IO07 ，而GPIO5_IO07 对应的引脚就是SNVS_TAMPER7，要放到iomuxc_snvs 节点下，所以就分成了两部分。<br> 注意第16、17 行，这两行设置GPIO1_IO07 和GPIO1_IO06 为ENET2 的MDC 和MDIO，大家可能会疑问，为什么不将其设置为ENET1 的MDC 和MDIO 呢？经过笔者实测，在开启两个网口的情况下，将GPIO1_IO07 和GPIO1_IO06 设置为ENET1 的MDC 和MDIO 会对导致网络工作不正常。前面说了，一个MDIO 接口可以管理32 个PHY，所以设置ENET2 的MDC 和MDIO 以后也是可以管理ENET1 上的PHY 芯片。</p> 
<h3><a id="IMX6ULL__1046"></a>I.MX6ULL 网络驱动源码简析</h3> 
<p>1、fec_probe 函数简析<br> 对于I.MX6ULL 而言网络驱动主要分两部分：I.MX6ULL 网络外设驱动以及PHY 芯片驱动，网络外设驱动是NXP 编写的，PHY 芯片有通用驱动文件，有些PHY 芯片厂商还会针对自己的芯片编写对应的PHY 驱动。总体来说，SOC 内置网络MAC+外置PHY 芯片这种方案我们是不需要编写什么驱动的，基本可以直接使用。但是为了学习，我们还是要简单分析一下具体的网络驱动编写过程。<br> 首先来看一下I.MX6ULL 的网络控制器部分驱动，从示例代码69.4.1.1 中可以看出，compatible 属性有两个值“fsl,imx6ul-fec”和“fsl,imx6q-fec”，通过在linux 内核源码中搜索这两个字符串即可找到对应的驱动文件，驱动文件为drivers/net/ethernet/freescale/fec_main.c，打开fec_main.c，找到如下所示内容：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.1</span> I<span class="token punctuation">.</span>MX 系列SOC 网络平台驱动匹配表
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> fec_dt_ids<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,imx25-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>IMX25_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">3</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,imx27-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>IMX27_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">4</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,imx28-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>IMX28_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">5</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6q-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>IMX6Q_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">6</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,mvf600-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>MVF600_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">7</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6sx-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>IMX6SX_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">8</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>compatible <span class="token operator">=</span> <span class="token string">"fsl,imx6ul-fec"</span><span class="token punctuation">,</span> <span class="token punctuation">.</span>data <span class="token operator">=</span>
<span class="token operator">&amp;</span>fec_devtype<span class="token punctuation">[</span>IMX6UL_FEC<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">9</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">/* sentinel */</span> <span class="token punctuation">}</span>
<span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">platform_driver</span> fec_driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">13</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">14</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> DRIVER_NAME<span class="token punctuation">,</span>
<span class="token number">15</span> <span class="token punctuation">.</span>pm <span class="token operator">=</span> <span class="token operator">&amp;</span>fec_pm_ops<span class="token punctuation">,</span>
<span class="token number">16</span> <span class="token punctuation">.</span>of_match_table <span class="token operator">=</span> fec_dt_ids<span class="token punctuation">,</span>
<span class="token number">17</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">18</span> <span class="token punctuation">.</span>id_table <span class="token operator">=</span> fec_devtype<span class="token punctuation">,</span>
<span class="token number">19</span> <span class="token punctuation">.</span>probe <span class="token operator">=</span> fec_probe<span class="token punctuation">,</span>
<span class="token number">20</span> <span class="token punctuation">.</span>remove <span class="token operator">=</span> fec_drv_remove<span class="token punctuation">,</span>
<span class="token number">21</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>第8 行，匹配表包含“fsl,imx6ul-fec”，因此设备树和驱动匹配上，当匹配成功以后第19 行的fec_probe 函数就会执行，我们简单分析一下fec_probe 函数，函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.1</span> fec_probe 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fec_probe</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep<span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">fec_platform_data</span> <span class="token operator">*</span>pdata<span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev<span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">int</span> i<span class="token punctuation">,</span> irq<span class="token punctuation">,</span> ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token keyword">struct</span> <span class="token class-name">resource</span> <span class="token operator">*</span>r<span class="token punctuation">;</span>
<span class="token number">8</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">of_device_id</span> <span class="token operator">*</span>of_id<span class="token punctuation">;</span>
<span class="token number">9</span> <span class="token keyword">static</span> <span class="token keyword">int</span> dev_id<span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token operator">*</span>phy_node<span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token keyword">int</span> num_tx_qs<span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token keyword">int</span> num_rx_qs<span class="token punctuation">;</span>
<span class="token number">13</span>
<span class="token number">14</span> <span class="token function">fec_enet_get_queue_num</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_tx_qs<span class="token punctuation">,</span> <span class="token operator">&amp;</span>num_rx_qs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span>
<span class="token number">16</span> <span class="token comment">/* Init network device */</span>
<span class="token number">17</span> ndev <span class="token operator">=</span> <span class="token function">alloc_etherdev_mqs</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">18</span> num_tx_qs<span class="token punctuation">,</span> num_rx_qs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ndev<span class="token punctuation">)</span>
<span class="token number">20</span> <span class="token keyword">return</span> <span class="token operator">-</span>ENOMEM<span class="token punctuation">;</span>
<span class="token number">21</span>
<span class="token number">22</span> <span class="token function">SET_NETDEV_DEV</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span>
<span class="token number">24</span> <span class="token comment">/* setup board info structure */</span>
<span class="token number">25</span> fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">26</span>
<span class="token number">27</span> of_id <span class="token operator">=</span> <span class="token function">of_match_device</span><span class="token punctuation">(</span>fec_dt_ids<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">28</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>of_id<span class="token punctuation">)</span>
<span class="token number">29</span> pdev<span class="token operator">-&gt;</span>id_entry <span class="token operator">=</span> of_id<span class="token operator">-&gt;</span>data<span class="token punctuation">;</span>
<span class="token number">30</span> fep<span class="token operator">-&gt;</span>quirks <span class="token operator">=</span> pdev<span class="token operator">-&gt;</span>id_entry<span class="token operator">-&gt;</span>driver_data<span class="token punctuation">;</span>
<span class="token number">31</span>
<span class="token number">32</span> fep<span class="token operator">-&gt;</span>netdev <span class="token operator">=</span> ndev<span class="token punctuation">;</span>
<span class="token number">33</span> fep<span class="token operator">-&gt;</span>num_rx_queues <span class="token operator">=</span> num_rx_qs<span class="token punctuation">;</span>
<span class="token number">34</span> fep<span class="token operator">-&gt;</span>num_tx_queues <span class="token operator">=</span> num_tx_qs<span class="token punctuation">;</span>
<span class="token number">35</span>
<span class="token number">36</span> #<span class="token keyword">if</span> <span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>CONFIG_M5272<span class="token punctuation">)</span>
<span class="token number">37</span> <span class="token comment">/* default enable pause frame auto negotiation */</span>
<span class="token number">38</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>quirks <span class="token operator">&amp;</span> FEC_QUIRK_HAS_GBIT<span class="token punctuation">)</span>
<span class="token number">39</span> fep<span class="token operator">-&gt;</span>pause_flag <span class="token operator">|=</span> FEC_PAUSE_FLAG_AUTONEG<span class="token punctuation">;</span>
<span class="token number">40</span> #endif
<span class="token number">41</span>
<span class="token number">42</span> <span class="token comment">/* Select default pin state */</span>
<span class="token number">43</span> <span class="token function">pinctrl_pm_select_default_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">44</span>
<span class="token number">45</span> r <span class="token operator">=</span> <span class="token function">platform_get_resource</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> IORESOURCE_MEM<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">46</span> fep<span class="token operator">-&gt;</span>hwp <span class="token operator">=</span> <span class="token function">devm_ioremap_resource</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">47</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>hwp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">48</span> ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>hwp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">49</span> <span class="token keyword">goto</span> failed_ioremap<span class="token punctuation">;</span>
<span class="token number">50</span> <span class="token punctuation">}</span>
<span class="token number">51</span>
<span class="token number">52</span> fep<span class="token operator">-&gt;</span>pdev <span class="token operator">=</span> pdev<span class="token punctuation">;</span>
<span class="token number">53</span> fep<span class="token operator">-&gt;</span>dev_id <span class="token operator">=</span> dev_id<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token number">54</span>
<span class="token number">55</span> <span class="token function">platform_set_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">56</span>
<span class="token number">57</span> <span class="token function">fec_enet_of_parse_stop_mode</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">58</span>
<span class="token number">59</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_get_property</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"fsl,magic-packet"</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">60</span> fep<span class="token operator">-&gt;</span>wol_flag <span class="token operator">|=</span> FEC_WOL_HAS_MAGIC_PACKET<span class="token punctuation">;</span>
<span class="token number">61</span>
<span class="token number">62</span> phy_node <span class="token operator">=</span> <span class="token function">of_parse_phandle</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"phy-handle"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">63</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>phy_node <span class="token operator">&amp;&amp;</span> <span class="token function">of_phy_is_fixed_link</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">64</span> ret <span class="token operator">=</span> <span class="token function">of_phy_register_fixed_link</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">65</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">66</span> <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
<span class="token number">67</span> <span class="token string">"broken fixed-link specification\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">68</span> <span class="token keyword">goto</span> failed_phy<span class="token punctuation">;</span>
<span class="token number">69</span> <span class="token punctuation">}</span>
<span class="token number">70</span> phy_node <span class="token operator">=</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>np<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">71</span> <span class="token punctuation">}</span>
<span class="token number">72</span> fep<span class="token operator">-&gt;</span>phy_node <span class="token operator">=</span> phy_node<span class="token punctuation">;</span>
<span class="token number">73</span>
<span class="token number">74</span> ret <span class="token operator">=</span> <span class="token function">of_get_phy_mode</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">75</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">76</span> pdata <span class="token operator">=</span> <span class="token function">dev_get_platdata</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">77</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pdata<span class="token punctuation">)</span>
<span class="token number">78</span> fep<span class="token operator">-&gt;</span>phy_interface <span class="token operator">=</span> pdata<span class="token operator">-&gt;</span>phy<span class="token punctuation">;</span>
<span class="token number">79</span> <span class="token keyword">else</span>
<span class="token number">80</span> fep<span class="token operator">-&gt;</span>phy_interface <span class="token operator">=</span> PHY_INTERFACE_MODE_MII<span class="token punctuation">;</span>
<span class="token number">81</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">82</span> fep<span class="token operator">-&gt;</span>phy_interface <span class="token operator">=</span> ret<span class="token punctuation">;</span>
<span class="token number">83</span> <span class="token punctuation">}</span>
<span class="token number">84</span>
<span class="token number">85</span> fep<span class="token operator">-&gt;</span>clk_ipg <span class="token operator">=</span> <span class="token function">devm_clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ipg"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">86</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ipg<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">87</span> ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ipg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">88</span> <span class="token keyword">goto</span> failed_clk<span class="token punctuation">;</span>
<span class="token number">89</span> <span class="token punctuation">}</span>
<span class="token number">90</span>
<span class="token number">91</span> fep<span class="token operator">-&gt;</span>clk_ahb <span class="token operator">=</span> <span class="token function">devm_clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ahb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">92</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ahb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">93</span> ret <span class="token operator">=</span> <span class="token function">PTR_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ahb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">94</span> <span class="token keyword">goto</span> failed_clk<span class="token punctuation">;</span>
<span class="token number">95</span> <span class="token punctuation">}</span>
<span class="token number">96</span>
<span class="token number">97</span> fep<span class="token operator">-&gt;</span>itr_clk_rate <span class="token operator">=</span> <span class="token function">clk_get_rate</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ahb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">98</span>
<span class="token number">99</span> <span class="token comment">/* enet_out is optional, depends on board */</span>
<span class="token number">100</span> fep<span class="token operator">-&gt;</span>clk_enet_out <span class="token operator">=</span> <span class="token function">devm_clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"enet_out"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">101</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_enet_out<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">102</span> fep<span class="token operator">-&gt;</span>clk_enet_out <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token number">103</span>
<span class="token number">104</span> fep<span class="token operator">-&gt;</span>ptp_clk_on <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">105</span> <span class="token function">mutex_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>ptp_clk_mutex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">106</span>
<span class="token number">107</span> <span class="token comment">/* clk_ref is optional, depends on board */</span>
<span class="token number">108</span> fep<span class="token operator">-&gt;</span>clk_ref <span class="token operator">=</span> <span class="token function">devm_clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"enet_clk_ref"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">109</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ref<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">110</span> fep<span class="token operator">-&gt;</span>clk_ref <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token number">111</span>
<span class="token number">112</span> fep<span class="token operator">-&gt;</span>bufdesc_ex <span class="token operator">=</span> fep<span class="token operator">-&gt;</span>quirks <span class="token operator">&amp;</span> FEC_QUIRK_HAS_BUFDESC_EX<span class="token punctuation">;</span>
<span class="token number">113</span> fep<span class="token operator">-&gt;</span>clk_ptp <span class="token operator">=</span> <span class="token function">devm_clk_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"ptp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">114</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>clk_ptp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">115</span> fep<span class="token operator">-&gt;</span>clk_ptp <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token number">116</span> fep<span class="token operator">-&gt;</span>bufdesc_ex <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">117</span> <span class="token punctuation">}</span>
<span class="token number">118</span>
<span class="token number">119</span> <span class="token function">pm_runtime_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">120</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_clk_enable</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">121</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">122</span> <span class="token keyword">goto</span> failed_clk<span class="token punctuation">;</span>
<span class="token number">123</span>
<span class="token number">124</span> fep<span class="token operator">-&gt;</span>reg_phy <span class="token operator">=</span> <span class="token function">devm_regulator_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"phy"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">125</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ERR</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>reg_phy<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">126</span> ret <span class="token operator">=</span> <span class="token function">regulator_enable</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>reg_phy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">127</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">128</span> <span class="token function">dev_err</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span>
<span class="token number">129</span> <span class="token string">"Failed to enable phy regulator: %d\n"</span><span class="token punctuation">,</span> ret<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">130</span> <span class="token keyword">goto</span> failed_regulator<span class="token punctuation">;</span>
<span class="token number">131</span> <span class="token punctuation">}</span>
<span class="token number">132</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">133</span> fep<span class="token operator">-&gt;</span>reg_phy <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token number">134</span> <span class="token punctuation">}</span>
<span class="token number">135</span>
<span class="token number">136</span> <span class="token function">fec_reset_phy</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">137</span>
<span class="token number">138</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>bufdesc_ex<span class="token punctuation">)</span>
<span class="token number">139</span> <span class="token function">fec_ptp_init</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">140</span>
<span class="token number">141</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_init</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">142</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">143</span> <span class="token keyword">goto</span> failed_init<span class="token punctuation">;</span>
<span class="token number">144</span>
<span class="token number">145</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> FEC_IRQ_NUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">146</span> irq <span class="token operator">=</span> <span class="token function">platform_get_irq</span><span class="token punctuation">(</span>pdev<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">147</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>irq <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">148</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span>
<span class="token number">149</span> <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token number">150</span> ret <span class="token operator">=</span> irq<span class="token punctuation">;</span>
<span class="token number">151</span> <span class="token keyword">goto</span> failed_irq<span class="token punctuation">;</span>
<span class="token number">152</span> <span class="token punctuation">}</span>
<span class="token number">153</span> ret <span class="token operator">=</span> <span class="token function">devm_request_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> irq<span class="token punctuation">,</span> fec_enet_interrupt<span class="token punctuation">,</span>
<span class="token number">154</span> <span class="token number">0</span><span class="token punctuation">,</span> pdev<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">155</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">156</span> <span class="token keyword">goto</span> failed_irq<span class="token punctuation">;</span>
<span class="token number">157</span>
<span class="token number">158</span> fep<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> irq<span class="token punctuation">;</span>
<span class="token number">159</span> <span class="token punctuation">}</span>
<span class="token number">160</span>
<span class="token number">161</span> ret <span class="token operator">=</span> <span class="token function">of_property_read_u32</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> <span class="token string">"fsl,wakeup_irq"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>irq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">162</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ret <span class="token operator">&amp;&amp;</span> irq <span class="token operator">&lt;</span> FEC_IRQ_NUM<span class="token punctuation">)</span>
<span class="token number">163</span> fep<span class="token operator">-&gt;</span>wake_irq <span class="token operator">=</span> fep<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span>irq<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">164</span> <span class="token keyword">else</span>
<span class="token number">165</span> fep<span class="token operator">-&gt;</span>wake_irq <span class="token operator">=</span> fep<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">166</span>
<span class="token number">167</span> <span class="token function">init_completion</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>mdio_done<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">168</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_mii_init</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">169</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">170</span> <span class="token keyword">goto</span> failed_mii_init<span class="token punctuation">;</span>
<span class="token number">171</span>
<span class="token number">172</span> <span class="token comment">/* Carrier starts down, phylib will bring it up */</span>
<span class="token number">173</span> <span class="token function">netif_carrier_off</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">174</span> <span class="token function">fec_enet_clk_enable</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">175</span> <span class="token function">pinctrl_pm_select_sleep_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">176</span>
<span class="token number">177</span> ret <span class="token operator">=</span> <span class="token function">register_netdev</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">178</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">179</span> <span class="token keyword">goto</span> failed_register<span class="token punctuation">;</span>
<span class="token number">180</span>
<span class="token number">181</span> <span class="token function">device_init_wakeup</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ndev<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> fep<span class="token operator">-&gt;</span>wol_flag <span class="token operator">&amp;</span>
<span class="token number">182</span> FEC_WOL_HAS_MAGIC_PACKET<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">183</span>
<span class="token number">184</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>bufdesc_ex <span class="token operator">&amp;&amp;</span> fep<span class="token operator">-&gt;</span>ptp_clock<span class="token punctuation">)</span>
<span class="token number">185</span> <span class="token function">netdev_info</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> <span class="token string">"registered PHC device %d\n"</span><span class="token punctuation">,</span> fep<span class="token operator">-&gt;</span>dev_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">186</span>
<span class="token number">187</span> fep<span class="token operator">-&gt;</span>rx_copybreak <span class="token operator">=</span> COPYBREAK_DEFAULT<span class="token punctuation">;</span>
<span class="token number">188</span> <span class="token function">INIT_WORK</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>tx_timeout_work<span class="token punctuation">,</span> fec_enet_timeout_work<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">189</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">206</span> <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token number">207</span> <span class="token punctuation">}</span>

</code></pre> 
<p>第14 行，使用fec_enet_get_queue_num 函数来获取设备树中的“fsl,num-tx-queues”和“fsl,num-rx-queues”这两个属性值，也就是发送队列和接收队列的大小，设备树中这两个属性都设置为1。<br> 第17 行，使用alloc_etherdev_mqs 函数申请net_device。<br> 第25 行，获取net_device 中私有数据内存首地址，net_device 中的私有数据用来存放I.MX6ULL 网络设备结构体，此结构体为fec_enet_private。<br> 第30 行，接下来所有以“fep-&gt;”开头的代码行就是初始化网络设备结构体各个成员变量，结构体类型为fec_enet_privatede，这个结构体是NXP 自己定义的。<br> 第45 行，获取设备树中I.MX6ULL 网络外设(ENET)相关寄存器起始地址，ENET1 的寄存器起始地址0X02188000，ENET2 的寄存器起始地址0X20B4000。<br> 第46 行，对第45 行获取到的地址做虚拟地址转换，转换后的ENET 虚拟寄存器起始地址保存在fep 的hwp 成员中。<br> 第57 行，使用fec_enet_of_parse_stop_mode 函数解析设备树中关于ENET 的停止模式属性值，属性名字为“stop-mode”，我们没有用到。<br> 第59 行，从设备树查找“fsl,magic-packet”属性是否存在，如果存在的话就说明有魔术包，有魔术包的话就将fep 的wol_flag 成员与FEC_WOL_HAS_MAGIC_PACKET 进行或运算，也就是在wol_flag 中做登记，登记支持魔术包。<br> 第62 行，获取“phy-handle”属性的值，phy-handle 属性指定了I.MX6ULL 网络外设所对应获取PHY 的设备节点。在设备树的fec1 和fec2 两个节点中phy-handle 属性值分别为：</p> 
<pre><code class="prism language-c">phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethphy0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethphy1<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre> 
<p>而ethphy0 和ethphy1 都定义在mdio 子节点下，内容如下所示：</p> 
<pre><code class="prism language-c">mdio <span class="token punctuation">{<!-- --></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">address</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">size</span><span class="token expression"><span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span></span></span>
ethphy0<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
compatible <span class="token operator">=</span> <span class="token string">"ethernet-phy-ieee802.3-c22"</span><span class="token punctuation">;</span>
reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
ethphy1<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">1</span> <span class="token punctuation">{<!-- --></span>
compatible <span class="token operator">=</span> <span class="token string">"ethernet-phy-ieee802.3-c22"</span><span class="token punctuation">;</span>
reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>可以看出ethphy0 和ethphy1 都是与MDIO 相关的，而MDIO 接口是配置PHY 芯片的，通过一个MDIO 接口可以配置多个PHY 芯片，不同的PHY 芯片通过不同的地址进行区别。正点原子ALPHA 开发板中ENET 的PHY 地址为0X00，ENET2 的PHY 地址为0X01。这两个PHY地址要通过设备树告诉Linux 系统，下面两行代码@后面的数值就是PHY 地址：</p> 
<pre><code class="prism language-c">ethphy0<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">2</span>
ethphy1<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">1</span>
</code></pre> 
<p>并且ethphy0 和ethphy1 节点中的reg 属性也是PHY 地址，如果我们要更换其他的网络PHY 芯片，第一步就是要修改设备树中的PHY 地址。<br> 第74 行，获取PHY 工作模式，函数of_get_phy_mode 会读取属性phy-mode 的值，”phy-mode”中保存了PHY 的工作方式，即PHY 是RMII 还是MII，IMX6ULL 中的PHY 工作在RMII 模式，设备树描述如下所示：<br> 第85、91、100、108 和113 行，分别获取时钟ipg、ahb、enet_out、enet_clk_ref 和ptp，对应结构体fec_enet_private 有如下成员函数</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>clk_ipg<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>clk_ahb<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>clk_ref<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>clk_enet_out<span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">clk</span> <span class="token operator">*</span>clk_ptp<span class="token punctuation">;</span>
</code></pre> 
<p>第120 行，使能时钟。<br> 第136 行，调用函数fec_reset_phy 复位PHY。<br> 第141 行，调用函数fec_enet_init()初始化enet，此函数会分配队列、申请dma、设置MAC地址，初始化net_device 的netdev_ops 和ethtool_ops 成员，如图69.4.2.1 所示：<br> <img src="https://images2.imgbox.com/32/42/Fc5amfXC_o.png" alt="在这里插入图片描述"></p> 
<p>图69.4.2.1 设置netdev_ops 和ethtool_ops<br> 从图69.4.2.1 可以看出，net_device 的netdev_ops 和ethtool_ops 成变量分别初始化成了fec_netdev_ops 和fec_enet_ethtool_ops。fec_enet_init 函数还会调用netif_napi_add 来设置poll 函数，说明NXP 官方编写的此网络驱动是NAPI 兼容驱动，如图69.4.2.2 所示：<br> <img src="https://images2.imgbox.com/19/b4/MaSKPi5h_o.png" alt="在这里插入图片描述"></p> 
<p>图69.4.2.2 netif_napi_add 函数</p> 
<p>从图69.4.2.2 可以看出，通过netif_napi_add 函数向网卡添加了一个napi 示例，使用NAPI驱动要提供一个poll 函数来轮询处理接收数据，此处的poll 函数为fec_enet_rx_napi，后面分析网络数据接收处理流程的时候详细讲解此函数。<br> 最后，fec_enet_init 函数会设置IMX6ULL 网络外设相关硬件寄存器。<br> 第146 行，从设备树中获取中断号。<br> 第153 行，申请中断，中断处理函数为fec_enet_interrupt，重点！后面会分析此函数。<br> 第161 行，从设备树中获取属性“fsl,wakeup_irq”的值，也就是唤醒中断，<br> 第167 行，初始化完成量completion，用于一个执行单元等待另一个执行单元执行完某事。<br> 第168 行，函数fec_enet_mii_init 完成MII/RMII 接口的初始化，此函数重点是图69.4.2.3中的两行代码：<br> <img src="https://images2.imgbox.com/3f/77/zwzYQae7_o.png" alt="在这里插入图片描述"></p> 
<p>图69.4.2.3 mdio 读写函数<br> mii_bus 下的read 和write 这两个成员变量分别是读/写PHY 寄存器的操作函数，这里设置为fec_enet_mdio_read 和fec_enet_mdio_write，这两个函数就是I.MX 系列SOC 读写PHY 内部寄存器的函数，读取或者配置PHY 寄存器都会通过这两个MDIO 总线函数完成。<br> fec_enet_mii_init 函数最终会向Linux 内核注册MIDO 总线，相关代码如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.2</span> fec_enet_mii_init 函数注册mdio 总线
<span class="token number">1</span> node <span class="token operator">=</span> <span class="token function">of_get_child_by_name</span><span class="token punctuation">(</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node<span class="token punctuation">,</span> <span class="token string">"mdio"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">2</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> err <span class="token operator">=</span> <span class="token function">of_mdiobus_register</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>mii_bus<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token function">of_node_put</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">6</span> err <span class="token operator">=</span> <span class="token function">mdiobus_register</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>mii_bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token punctuation">}</span>
</code></pre> 
<p>示例代码代码69.4.2.2 中第1 行就是从设备树中获取mdio 节点，如果节点存在的话就会通过of_mdiobus_register 或者mdiobus_register 来向内核注册MDIO 总线，如果采用设备树的话就使用of_mdiobus_register 来注册MDIO 总线，否则就使用mdiobus_register 函数。<br> 继续回到示例代码69.4.2.1，接着分析fec_probe 函数。<br> 第173 行，先调用函数netif_carrier_off 通知内核，先关闭链路，phylib 会打开。<br> 第174 行，调用函数fec_enet_clk_enable 使能网络相关时钟。<br> 第177 行，调用函数register_netdev 注册net_device！<br> 2、MDIO 总线注册<br> MDIO 我们讲了很多次了，就是用来管理PHY 芯片的，分为MDIO 和MDC 两根线，Linux内核专门为MDIO 准备一个总线，叫做MDIO 总线，采用mii_bus 结构体表示，定义在include/linux/phy.h 文件中，mii_bus 结构体如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.3</span> mii_bus 结构体
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token number">3</span> <span class="token keyword">char</span> id<span class="token punctuation">[</span>MII_BUS_ID_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">void</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">int</span> phy_id<span class="token punctuation">,</span> <span class="token keyword">int</span> regnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>write<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">int</span> phy_id<span class="token punctuation">,</span> <span class="token keyword">int</span> regnum<span class="token punctuation">,</span>
u16 val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>reset<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span>
<span class="token number">9</span> <span class="token comment">/*
10 * A lock to ensure that only one thing can read/write
11 * the MDIO bus at a time
12 */</span>
<span class="token number">13</span> <span class="token keyword">struct</span> <span class="token class-name">mutex</span> mdio_lock<span class="token punctuation">;</span>
<span class="token number">14</span>
<span class="token number">15</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>parent<span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">17</span> MDIOBUS_ALLOCATED <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token number">18</span> MDIOBUS_REGISTERED<span class="token punctuation">,</span>
<span class="token number">19</span> MDIOBUS_UNREGISTERED<span class="token punctuation">,</span>
<span class="token number">20</span> MDIOBUS_RELEASED<span class="token punctuation">,</span>
<span class="token number">21</span> <span class="token punctuation">}</span> state<span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> dev<span class="token punctuation">;</span>
<span class="token number">23</span>
<span class="token number">24</span> <span class="token comment">/* list of all PHYs on bus */</span>
<span class="token number">25</span> <span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phy_map<span class="token punctuation">[</span>PHY_MAX_ADDR<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">26</span>
<span class="token number">27</span> <span class="token comment">/* PHY addresses to be ignored when probing */</span>
<span class="token number">28</span> u32 phy_mask<span class="token punctuation">;</span>
<span class="token number">29</span>
<span class="token number">30</span> <span class="token comment">/*
31 * Pointer to an array of interrupts, each PHY's
32 * interrupt at the index matching its address
33 */</span>
<span class="token number">34</span> <span class="token keyword">int</span> <span class="token operator">*</span>irq<span class="token punctuation">;</span>
<span class="token number">35</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>重点是第5、6 两行的read 和write 函数，这两个函数就是读/些PHY 芯片的操作函数，不同的SOC 其MDIO 主控部分是不一样的，因此需要驱动编写人员去编写。我们前面在分析fec_probe 函数的时候已经讲过了，fec_probe 函数会调用fec_enet_mii_init 函数完成MII 接口的初始化，其中就包括初始化mii_bus 下的read 和write 这两个函数。最终通过of_mdiobus_register或者mdiobus_register 函数将初始化以后的mii_bus 注册到Linux 内核，of_mdiobus_register 函数其实最终也是调用的mdiobus_register 函数来完成mii_bus 注册的。of_mdiobus_register 函数内容如下(限于篇幅，有省略)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.4</span> of_mdiobus_register 函数
<span class="token number">1</span> <span class="token keyword">int</span> <span class="token function">of_mdiobus_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>mdio<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>np<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">const</span> __be32 <span class="token operator">*</span>paddr<span class="token punctuation">;</span>
<span class="token number">5</span> bool scanphys <span class="token operator">=</span> false<span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">int</span> addr<span class="token punctuation">,</span> rc<span class="token punctuation">,</span> i<span class="token punctuation">;</span>
<span class="token number">7</span>
<span class="token number">8</span> <span class="token comment">/* Mask out all PHYs from auto probing. Instead the PHYs listed
9 * in the device tree are populated after the bus has been
*registered */</span>
<span class="token number">10</span> mdio<span class="token operator">-&gt;</span>phy_mask <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token comment">/* Clear all the IRQ properties */</span>
<span class="token number">13</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mdio<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span>
<span class="token number">14</span> <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>PHY_MAX_ADDR<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token number">15</span> mdio<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> PHY_POLL<span class="token punctuation">;</span>
<span class="token number">16</span>
<span class="token number">17</span> mdio<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node <span class="token operator">=</span> np<span class="token punctuation">;</span>
<span class="token number">18</span>
<span class="token number">19</span> <span class="token comment">/* Register the MDIO bus */</span>
<span class="token number">20</span> rc <span class="token operator">=</span> <span class="token function">mdiobus_register</span><span class="token punctuation">(</span>mdio<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
<span class="token number">22</span> <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token number">23</span>
<span class="token number">24</span> <span class="token comment">/* Loop over the child nodes and register a phy_device for each
one */</span>
<span class="token number">25</span> <span class="token function">for_each_available_child_of_node</span><span class="token punctuation">(</span>np<span class="token punctuation">,</span> child<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">26</span> addr <span class="token operator">=</span> <span class="token function">of_mdio_parse_addr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mdio<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">27</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>addr <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">28</span> scanphys <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">29</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">30</span> <span class="token punctuation">}</span>
<span class="token number">31</span>
<span class="token number">32</span> rc <span class="token operator">=</span> <span class="token function">of_mdiobus_register_phy</span><span class="token punctuation">(</span>mdio<span class="token punctuation">,</span> child<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">33</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
<span class="token number">34</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token number">35</span> <span class="token punctuation">}</span>
<span class="token number">36</span>
<span class="token number">37</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>scanphys<span class="token punctuation">)</span>
<span class="token number">38</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">39</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">62</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">63</span> <span class="token punctuation">}</span>

</code></pre> 
<p>第20 行，调用mdiobus_register 函数来向Linux 内核注册mdio 总线！<br> 第25 行，轮询mdio 节点下的所有子节点，比如示例代码69.4.1.2 中的“ethphy0: ethernet-phy@0”和“ethphy1: ethernet-phy@1”这两个子节点，这两个子节点描述的是PHY 芯片信息。<br> 第26 行，提取设备树子节点中PHY 地址，也就是ethphy0: ethernet-phy@0”和“ethphy1: ethernet-phy@1”这两个子节点对应的PHY 芯片地址，分别为0 和1。<br> 第32 行，调用of_mdiobus_register_phy 函数向Linux 内核注册phy。<br> 简单总结一下，of_mdiobus_register 函数有两个主要的功能，一个是通过mdiobus_register函数向Linux 内核注册mdio 总线，另一个就是通过of_mdiobus_register_phy 函数向内核注册PHY。<br> 接下来简单分析一下of_mdiobus_register_phy 函数，看看是如何向Linux 内核注册PHY 设备的，of_mdiobus_register_phy 函数内容如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.5</span> of_mdiobus_register_phy 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">of_mdiobus_register_phy</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>mdio<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">device_node</span> <span class="token operator">*</span>child<span class="token punctuation">,</span>
<span class="token number">2</span> u32 addr<span class="token punctuation">)</span>
<span class="token number">3</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phy<span class="token punctuation">;</span>
<span class="token number">5</span> bool is_c45<span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">int</span> rc<span class="token punctuation">;</span>
<span class="token number">7</span> u32 phy_id<span class="token punctuation">;</span>
<span class="token number">8</span>
<span class="token number">9</span> is_c45 <span class="token operator">=</span> <span class="token function">of_device_is_compatible</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span>
<span class="token number">10</span> <span class="token string">"ethernet-phy-ieee802.3-c45"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>is_c45 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">of_get_phy_id</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token operator">&amp;</span>phy_id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">13</span> phy <span class="token operator">=</span> <span class="token function">phy_device_create</span><span class="token punctuation">(</span>mdio<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> phy_id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token keyword">else</span>
<span class="token number">15</span> phy <span class="token operator">=</span> <span class="token function">get_phy_device</span><span class="token punctuation">(</span>mdio<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> is_c45<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>phy <span class="token operator">||</span> <span class="token function">IS_ERR</span><span class="token punctuation">(</span>phy<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">17</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">18</span>
<span class="token number">19</span> rc <span class="token operator">=</span> <span class="token function">irq_of_parse_and_map</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">20</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">21</span> phy<span class="token operator">-&gt;</span>irq <span class="token operator">=</span> rc<span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mdio<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span>
<span class="token number">23</span> mdio<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span>addr<span class="token punctuation">]</span> <span class="token operator">=</span> rc<span class="token punctuation">;</span>
<span class="token number">24</span> <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">25</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mdio<span class="token operator">-&gt;</span>irq<span class="token punctuation">)</span>
<span class="token number">26</span> phy<span class="token operator">-&gt;</span>irq <span class="token operator">=</span> mdio<span class="token operator">-&gt;</span>irq<span class="token punctuation">[</span>addr<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">27</span> <span class="token punctuation">}</span>
<span class="token number">28</span>
<span class="token number">29</span> <span class="token comment">/* Associate the OF node with the device structure so it
30 * can be looked up later */</span>
<span class="token number">31</span> <span class="token function">of_node_get</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">32</span> phy<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>of_node <span class="token operator">=</span> child<span class="token punctuation">;</span>
<span class="token number">33</span>
<span class="token number">4</span> <span class="token comment">/* All data is now stored in the phy struct;
35 * register it */</span>
<span class="token number">36</span> rc <span class="token operator">=</span> <span class="token function">phy_device_register</span><span class="token punctuation">(</span>phy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">37</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">38</span> <span class="token function">phy_device_free</span><span class="token punctuation">(</span>phy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">39</span> <span class="token function">of_node_put</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">40</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">41</span> <span class="token punctuation">}</span>
<span class="token number">42</span>
<span class="token number">43</span> <span class="token function">dev_dbg</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mdio<span class="token operator">-&gt;</span>dev<span class="token punctuation">,</span> <span class="token string">"registered phy %s at address %i\n"</span><span class="token punctuation">,</span>
<span class="token number">44</span> child<span class="token operator">-&gt;</span>name<span class="token punctuation">,</span> addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">45</span>
<span class="token number">46</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">47</span> <span class="token punctuation">}</span>

</code></pre> 
<p>第9 行，使用函数of_device_is_compatible 检查PHY 节点的compatible 属性是否为“ethernet-phy-ieee802.3-c45”，如果是的话要做其他的处理，本章节我们设置的compatible 属性为“ethernet-phy-ieee802.3-c22”。<br> 第15 行，调用get_phy_device 函数获取PHY 设备，此函数里面会调用phy_device_create<br> 来创建一个phy_device 设备并返回。<br> 第19 行，获取PHY 芯片的中断信息，本章节并未用到。<br> 第36 行，调用phy_device_register 函数向Linux 内核注册PHY 设备。<br> 从上面的分析可以看出，向Linux 内核注册MDIO 总线的时候也会同时向Linux 内核注册PHY 设备，流程如图69.4.2.3 所示：<br> <img src="https://images2.imgbox.com/2c/9d/kZxV9tt9_o.png" alt="在这里插入图片描述"><br> 图69.4.2.3 MDIO 总线注册流程<br> 注册MIDO 总线的时候会从设备树中查找PHY 设备，然后通过phy_device_register 函数向内核注册PHY 设备，接下来我们就来学习一下PHY 子系统。<br> 3、fec_drv_remove 函数简析<br> 卸载I.MX6ULL 网络驱动的时候fec_drv_remove 函数就会执行，函数内容如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.2</span><span class="token number">.6</span> fec_drv_remove 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fec_drv_remove</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">platform_device</span> <span class="token operator">*</span>pdev<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev <span class="token operator">=</span> <span class="token function">platform_get_drvdata</span><span class="token punctuation">(</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span>
<span class="token number">6</span> <span class="token function">cancel_delayed_work_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>time_keep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token function">cancel_work_sync</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>tx_timeout_work<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span> <span class="token function">unregister_netdev</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span> <span class="token function">fec_enet_mii_remove</span><span class="token punctuation">(</span>fep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>reg_phy<span class="token punctuation">)</span>
<span class="token number">11</span> <span class="token function">regulator_disable</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>reg_phy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>ptp_clock<span class="token punctuation">)</span>
<span class="token number">13</span> <span class="token function">ptp_clock_unregister</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>ptp_clock<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token function">of_node_put</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>phy_node<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token function">free_netdev</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span>
<span class="token number">17</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token punctuation">}</span>

</code></pre> 
<p>第8 行，调用unregister_netdev 函数注销前面注册的net_device。<br> 第9 行，调用fec_enet_mii_remove 函数来移除掉MDIO 总线相关的内容，此函数会调用mdiobus_unregister 来注销掉mii_bus，并且通过函数mdiobus_free 释放掉mii_bus<br> 第15 行，调用free_netdev 函数释放掉前面申请的net_device。</p> 
<h3><a id="fec_netdev_ops__1562"></a>fec_netdev_ops 操作集</h3> 
<p>fec_probe 函数设置了网卡驱动的net_dev_ops 操作集为fec_netdev_ops，fec_netdev_ops 内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.1</span> fec_netdev_ops 操作集
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">net_device_ops</span> fec_netdev_ops <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token punctuation">.</span>ndo_open <span class="token operator">=</span> fec_enet_open<span class="token punctuation">,</span>
<span class="token number">3</span> <span class="token punctuation">.</span>ndo_stop <span class="token operator">=</span> fec_enet_close<span class="token punctuation">,</span>
<span class="token number">4</span> <span class="token punctuation">.</span>ndo_start_xmit <span class="token operator">=</span> fec_enet_start_xmit<span class="token punctuation">,</span>
<span class="token number">5</span> <span class="token punctuation">.</span>ndo_select_queue <span class="token operator">=</span> fec_enet_select_queue<span class="token punctuation">,</span>
<span class="token number">6</span> <span class="token punctuation">.</span>ndo_set_rx_mode <span class="token operator">=</span> set_multicast_list<span class="token punctuation">,</span>
<span class="token number">7</span> <span class="token punctuation">.</span>ndo_change_mtu <span class="token operator">=</span> eth_change_mtu<span class="token punctuation">,</span>
<span class="token number">8</span> <span class="token punctuation">.</span>ndo_validate_addr <span class="token operator">=</span> eth_validate_addr<span class="token punctuation">,</span>
<span class="token number">9</span> <span class="token punctuation">.</span>ndo_tx_timeout <span class="token operator">=</span> fec_timeout<span class="token punctuation">,</span>
<span class="token number">10</span> <span class="token punctuation">.</span>ndo_set_mac_address <span class="token operator">=</span> fec_set_mac_address<span class="token punctuation">,</span>
<span class="token number">11</span> <span class="token punctuation">.</span>ndo_do_ioctl <span class="token operator">=</span> fec_enet_ioctl<span class="token punctuation">,</span>
<span class="token number">12</span> #ifdef CONFIG_NET_POLL_CONTROLLER
<span class="token number">13</span> <span class="token punctuation">.</span>ndo_poll_controller <span class="token operator">=</span> fec_poll_controller<span class="token punctuation">,</span>
<span class="token number">14</span> #endif
<span class="token number">15</span> <span class="token punctuation">.</span>ndo_set_features <span class="token operator">=</span> fec_set_features<span class="token punctuation">,</span>
<span class="token number">16</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>1、fec_enet_open 函数简析<br> 打开一个网卡的时候fec_enet_open 函数就会执行，函数源码如下所示(限于篇幅原因，有省略)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.2</span> fec_enet_open 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fec_enet_open</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">platform_device_id</span> <span class="token operator">*</span>id_entry <span class="token operator">=</span>
<span class="token number">5</span> <span class="token function">platform_get_device_id</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>pdev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
<span class="token number">7</span>
<span class="token number">8</span> <span class="token function">pinctrl_pm_select_default_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_clk_enable</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">11</span> <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token number">12</span>
<span class="token number">13</span> <span class="token comment">/* I should reset the ring buffers here, but I don't yet know
14 * a simple way to do that.
15 */</span>
<span class="token number">16</span>
<span class="token number">17</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_alloc_buffers</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">19</span> <span class="token keyword">goto</span> err_enet_alloc<span class="token punctuation">;</span>
<span class="token number">20</span>
<span class="token number">21</span> <span class="token comment">/* Init MAC prior to mii bus probe */</span>
<span class="token number">22</span> <span class="token function">fec_restart</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span>
<span class="token number">24</span> <span class="token comment">/* Probe and connect to PHY when open the interface */</span>
<span class="token number">25</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_mii_probe</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">26</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">27</span> <span class="token keyword">goto</span> err_enet_mii_probe<span class="token punctuation">;</span>
<span class="token number">28</span>
<span class="token number">29</span> <span class="token function">napi_enable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>napi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">30</span> <span class="token function">phy_start</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>phy_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">31</span> <span class="token function">netif_tx_start_all_queues</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">32</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">47</span>
<span class="token number">48</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">49</span>
<span class="token number">50</span> err_enet_mii_probe<span class="token operator">:</span>
<span class="token number">51</span> <span class="token function">fec_enet_free_buffers</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">52</span> err_enet_alloc<span class="token operator">:</span>
<span class="token number">53</span> fep<span class="token operator">-&gt;</span>miibus_up_failed <span class="token operator">=</span> true<span class="token punctuation">;</span>
<span class="token number">54</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fep<span class="token operator">-&gt;</span>mii_bus_share<span class="token punctuation">)</span>
<span class="token number">55</span> <span class="token function">pinctrl_pm_select_sleep_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">56</span> <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token number">57</span> <span class="token punctuation">}</span>

</code></pre> 
<p>第9 行，调用fec_enet_clk_enable 函数使能enet 时钟。<br> 第17 行，调用fec_enet_alloc_buffers 函数申请环形缓冲区buffer，此函数里面会调用fec_enet_alloc_rxq_buffers 和fec_enet_alloc_txq_buffers 这两个函数分别实现发送队列和接收队列缓冲区的申请。<br> 第22 行，重启网络，一般连接状态改变、传输超时或者配置网络的时候都会调用fec_restart函数。<br> 第25 行，打开网卡的时候调用fec_enet_mii_probe 函数来探测并连接对应的PHY 设备。<br> 第29 行，调用napi_enable 函数使能NAPI 调度。<br> 第30 行，调用phy_start 函数开启PHY 设备。<br> 第31 行，调用netif_tx_start_all_queues 函数来激活发送队列。<br> 2、fec_enet_close 函数简析<br> 关闭网卡的时候fec_enet_close 函数就会执行，函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.3</span> fec_enet_close 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fec_enet_close</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span>
<span class="token number">5</span> <span class="token function">phy_stop</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>phy_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span>
<span class="token number">7</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">netif_device_present</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">8</span> <span class="token function">napi_disable</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>napi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span> <span class="token function">netif_tx_disable</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token function">fec_stop</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token punctuation">}</span>
<span class="token number">12</span>
<span class="token number">13</span> <span class="token function">phy_disconnect</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>phy_dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> fep<span class="token operator">-&gt;</span>phy_dev <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token number">15</span>
<span class="token number">16</span> <span class="token function">fec_enet_clk_enable</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">17</span> <span class="token function">pm_qos_remove_request</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>pm_qos_req<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token function">pinctrl_pm_select_sleep_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token function">pm_runtime_put_sync_suspend</span><span class="token punctuation">(</span>ndev<span class="token operator">-&gt;</span>dev<span class="token punctuation">.</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">20</span> <span class="token function">fec_enet_free_buffers</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span>
<span class="token number">22</span> <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">23</span> <span class="token punctuation">}</span>
</code></pre> 
<p>第5 行，调用phy_stop 函数停止PHY 设备。<br> 第8 行，调用napi_disable 函数关闭NAPI 调度。<br> 第9 行，调用netif_tx_disable 函数关闭NAPI 的发送队列。<br> 第10 行，调用fec_stop 函数关闭I.MX6ULL 的ENET 外设。<br> 第13 行，调用phy_disconnect 函数断开与PHY 设备的连接。<br> 第16 行，调用fec_enet_clk_enable 函数关闭ENET 外设时钟。<br> 第20 行，调用fec_enet_free_buffers 函数释放发送和接收的环形缓冲区内存。<br> 3、fec_enet_start_xmit 函数简析</p> 
<p>I.MX6ULL 的网络数据发送是通过fec_enet_start_xmit 函数来完成的，这个函数将上层传递过来的sk_buff 中的数据通过硬件发送出去，函数源码如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.4</span> fec_enet_start_xmit 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token class-name">netdev_tx_t</span> <span class="token function">fec_enet_start_xmit</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">int</span> entries_free<span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> queue<span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_priv_tx_q</span> <span class="token operator">*</span>txq<span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token keyword">struct</span> <span class="token class-name">netdev_queue</span> <span class="token operator">*</span>nq<span class="token punctuation">;</span>
<span class="token number">8</span> <span class="token keyword">int</span> ret<span class="token punctuation">;</span>
<span class="token number">9</span>
<span class="token number">10</span> queue <span class="token operator">=</span> <span class="token function">skb_get_queue_mapping</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span> txq <span class="token operator">=</span> fep<span class="token operator">-&gt;</span>tx_queue<span class="token punctuation">[</span>queue<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token number">12</span> nq <span class="token operator">=</span> <span class="token function">netdev_get_tx_queue</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> queue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>
<span class="token number">14</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skb_is_gso</span><span class="token punctuation">(</span>skb<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">15</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_txq_submit_tso</span><span class="token punctuation">(</span>txq<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token keyword">else</span>
<span class="token number">17</span> ret <span class="token operator">=</span> <span class="token function">fec_enet_txq_submit_skb</span><span class="token punctuation">(</span>txq<span class="token punctuation">,</span> skb<span class="token punctuation">,</span> ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
<span class="token number">19</span> <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token number">20</span>
<span class="token number">21</span> entries_free <span class="token operator">=</span> <span class="token function">fec_enet_get_free_txdesc_num</span><span class="token punctuation">(</span>fep<span class="token punctuation">,</span> txq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>entries_free <span class="token operator">&lt;=</span> txq<span class="token operator">-&gt;</span>tx_stop_threshold<span class="token punctuation">)</span>
<span class="token number">23</span> <span class="token function">netif_tx_stop_queue</span><span class="token punctuation">(</span>nq<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">24</span>
<span class="token number">25</span> <span class="token keyword">return</span> NETDEV_TX_OK<span class="token punctuation">;</span>
<span class="token number">26</span> <span class="token punctuation">}</span>
</code></pre> 
<p>此函数的参数第一个参数skb 就是上层应用传递下来的要发送的网络数据，第二个参数ndev 就是要发送数据的设备。<br> 第14 行，判断skb 是否为GSO(Generic Segmentation Offload)，如果是GSO 的话就通过fec_enet_txq_submit_tso 函数发送，如果不是的话就通过fec_enet_txq_submit_skb 发送。这里简单讲一下TSO 和GSO:<br> TSO：全称是TCP Segmentation Offload，利用网卡对大数据包进行自动分段处理，降低CPU负载。<br> GSO：全称是Generic Segmentation Offload，在发送数据之前先检查一下网卡是否支持TSO，如果支持的话就让网卡分段，不过不支持的话就由协议栈进行分段处理，分段处理完成以后再交给网卡去发送。<br> 第21 行，通过fec_enet_get_free_txdesc_num 函数获取剩余的发送描述符数量。<br> 第23 行，如果剩余的发送描述符的数量小于设置的阈值(tx_stop_threshold)的话就调用函数netif_tx_stop_queue 来暂停发送，通过暂停发送来通知应用层停止向网络发送skb，发送中断中会重新开启的。<br> 4、fec_enet_interrupt 中断服务函数简析<br> 前面说了I.MX6ULL 的网络数据接收采用NAPI 框架，所以肯定要用到中断。fec_probe 函数会初始化网络中断，中断服务函数为fec_enet_interrupt，函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.5</span> fec_enet_interrupt 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token class-name">irqreturn_t</span> <span class="token function">fec_enet_interrupt</span><span class="token punctuation">(</span><span class="token keyword">int</span> irq<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dev_id<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev <span class="token operator">=</span> dev_id<span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span> uint int_events<span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token class-name">irqreturn_t</span> ret <span class="token operator">=</span> IRQ_NONE<span class="token punctuation">;</span>
<span class="token number">7</span>
<span class="token number">8</span> int_events <span class="token operator">=</span> <span class="token function">readl</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>hwp <span class="token operator">+</span> FEC_IEVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">9</span> <span class="token function">writel</span><span class="token punctuation">(</span>int_events<span class="token punctuation">,</span> fep<span class="token operator">-&gt;</span>hwp <span class="token operator">+</span> FEC_IEVENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token function">fec_enet_collect_events</span><span class="token punctuation">(</span>fep<span class="token punctuation">,</span> int_events<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>work_tx <span class="token operator">||</span> fep<span class="token operator">-&gt;</span>work_rx<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> fep<span class="token operator">-&gt;</span>link<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">13</span> ret <span class="token operator">=</span> IRQ_HANDLED<span class="token punctuation">;</span>
<span class="token number">14</span>
<span class="token number">15</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">napi_schedule_prep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>napi<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">16</span> <span class="token comment">/* Disable the NAPI interrupts */</span>
<span class="token number">17</span> <span class="token function">writel</span><span class="token punctuation">(</span>FEC_ENET_MII<span class="token punctuation">,</span> fep<span class="token operator">-&gt;</span>hwp <span class="token operator">+</span> FEC_IMASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token function">__napi_schedule</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>napi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token punctuation">}</span>
<span class="token number">20</span> <span class="token punctuation">}</span>
<span class="token number">21</span>
<span class="token number">22</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>int_events <span class="token operator">&amp;</span> FEC_ENET_MII<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">23</span> ret <span class="token operator">=</span> IRQ_HANDLED<span class="token punctuation">;</span>
<span class="token number">24</span> <span class="token function">complete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fep<span class="token operator">-&gt;</span>mdio_done<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">25</span> <span class="token punctuation">}</span>
<span class="token number">26</span>
<span class="token number">27</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>fep<span class="token operator">-&gt;</span>ptp_clock<span class="token punctuation">)</span>
<span class="token number">28</span> <span class="token function">fec_ptp_check_pps_event</span><span class="token punctuation">(</span>fep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">29</span>
<span class="token number">30</span> <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token number">31</span> <span class="token punctuation">}</span>
</code></pre> 
<p>可以看出中断服务函数非常短！而且也没有见到有关数据接收的处理过程，那是因为I.MX6ULL 的网络驱动使用了NAPI，具体的网络数据收发是在NAPI 的poll 函数中完成的，中断里面只需要进行napi 调度即可，这个就是中断的上半部和下半部处理机制。<br> 第8 行，读取NENT 的中断状态寄存器EIR，获取中断状态，<br> 第9 行，将第8 行获取到的中断状态值又写入EIR 寄存器，用于清除中断状态寄存器。<br> 第10 行，调用fec_enet_collect_events 函数统计中断信息，也就是统计都发生了哪些中断。<br> fep 中成员变量work_tx 和work_rx 的bit0、bit1 和bit2 用来做不同的标记，work_rx 的bit2 表示接收到数据帧，work_tx 的bit2 表示发送完数据帧。<br> 第15 行，调用napi_schedule_prep 函数检查NAPI 是否可以进行调度。<br> 第17 行，如果使能了相关中断就要先关闭这些中断，向EIMR 寄存器的bit23 写1 即可关闭相关中断。<br> 第18 行，调用__napi_schedule 函数来启动NAPI 调度，这个时候napi 的poll 函数就会执行，在本网络驱动中就是fec_enet_rx_napi 函数。<br> 5、fec_enet_interrupt 中断服务函数简析<br> fec_enet_init 函数初始化网络的时候会调用netif_napi_add 来设置NAPI 的poll 函数为fec_enet_rx_napi，函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.6</span> fec_enet_rx_napi 轮询函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">fec_enet_rx_napi</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">napi_struct</span> <span class="token operator">*</span>napi<span class="token punctuation">,</span> <span class="token keyword">int</span> budget<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>ndev <span class="token operator">=</span> napi<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">fec_enet_private</span> <span class="token operator">*</span>fep <span class="token operator">=</span> <span class="token function">netdev_priv</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">int</span> pkts<span class="token punctuation">;</span>
<span class="token number">6</span>
<span class="token number">7</span> pkts <span class="token operator">=</span> <span class="token function">fec_enet_rx</span><span class="token punctuation">(</span>ndev<span class="token punctuation">,</span> budget<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span>
<span class="token number">9</span> <span class="token function">fec_enet_tx</span><span class="token punctuation">(</span>ndev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span>
<span class="token number">11</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pkts <span class="token operator">&lt;</span> budget<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">12</span> <span class="token function">napi_complete</span><span class="token punctuation">(</span>napi<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token function">writel</span><span class="token punctuation">(</span>FEC_DEFAULT_IMASK<span class="token punctuation">,</span> fep<span class="token operator">-&gt;</span>hwp <span class="token operator">+</span> FEC_IMASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token punctuation">}</span>
<span class="token number">15</span> <span class="token keyword">return</span> pkts<span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token punctuation">}</span>
</code></pre> 
<p>第7 行，调用fec_enet_rx 函数进行真正的数据接收。<br> 第9 行，调用fec_enet_tx 函数进行数据发送。<br> 第12 行，调用napi_complete 函数来宣布一次轮询结束，<br> 第13 行，设置ENET 的EIMR 寄存器，重新使能中断。</p> 
<h3><a id="Linux_PHY_MDIO__1794"></a>Linux 内核PHY 子系统与MDIO 总线简析</h3> 
<p>上一小节在讲解MDIO 总线的时候讲过，注册MDIO 总线的时候也会向内核注册PHY 设备，本节我们就来简单了解一下PHY 子系统。PHY 子系统就是用于PHY 设备相关内容的，分为PHY 设备和PHY 驱动，和platform 总线一样，PHY 子系统也是一个设备、总线和驱动模型。<br> 1、PHY 设备<br> 首先看一下PHY 设备，Linux 内核使用phy_device 结构体来表示PHY 设备，结构体定义在include/linux/phy.h，结构体内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.1</span> phy_device 结构体
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token comment">/* Information about the PHY type */</span>
<span class="token number">3</span> <span class="token comment">/* And management functions */</span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">;</span> <span class="token comment">/* PHY设备驱动*/</span>
<span class="token number">5</span> <span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">;</span> <span class="token comment">/* 对应的MII总线*/</span>
<span class="token number">6</span> <span class="token keyword">struct</span> <span class="token class-name">device</span> dev<span class="token punctuation">;</span> <span class="token comment">/* 设备文件*/</span>
<span class="token number">7</span> u32 phy_id<span class="token punctuation">;</span> <span class="token comment">/* PHY ID */</span>
<span class="token number">8</span>
<span class="token number">9</span> <span class="token keyword">struct</span> <span class="token class-name">phy_c45_device_ids</span> c45_ids<span class="token punctuation">;</span>
<span class="token number">10</span> bool is_c45<span class="token punctuation">;</span>
<span class="token number">11</span> bool is_internal<span class="token punctuation">;</span>
<span class="token number">12</span> bool has_fixups<span class="token punctuation">;</span>
<span class="token number">13</span> bool suspended<span class="token punctuation">;</span>
<span class="token number">14</span>
<span class="token number">15</span> <span class="token keyword">enum</span> <span class="token class-name">phy_state</span> state<span class="token punctuation">;</span> <span class="token comment">/* PHY状态*/</span>
<span class="token number">16</span> u32 dev_flags<span class="token punctuation">;</span>
<span class="token number">17</span> <span class="token class-name">phy_interface_t</span> interface<span class="token punctuation">;</span> <span class="token comment">/* PHY接口*/</span>
<span class="token number">18</span>
<span class="token number">19</span> <span class="token comment">/* Bus address of the PHY (0-31) */</span>
<span class="token number">20</span> <span class="token keyword">int</span> addr<span class="token punctuation">;</span> <span class="token comment">/* PHY地址(0~31) */</span>
<span class="token number">21</span>
<span class="token number">22</span> <span class="token comment">/*
23 * forced speed &amp; duplex (no autoneg)
24 * partner speed &amp; duplex &amp; pause (autoneg)
25 */</span>
<span class="token number">26</span> <span class="token keyword">int</span> speed<span class="token punctuation">;</span> <span class="token comment">/* 速度*/</span>
<span class="token number">27</span> <span class="token keyword">int</span> duplex<span class="token punctuation">;</span> <span class="token comment">/* 双共模式*/</span>
<span class="token number">28</span> <span class="token keyword">int</span> pause<span class="token punctuation">;</span>
<span class="token number">29</span> <span class="token keyword">int</span> asym_pause<span class="token punctuation">;</span>
<span class="token number">30</span>
<span class="token number">31</span> <span class="token comment">/* The most recently read link state */</span>
<span class="token number">32</span> <span class="token keyword">int</span> link<span class="token punctuation">;</span>
<span class="token number">33</span>
<span class="token number">34</span> <span class="token comment">/* Enabled Interrupts */</span>
<span class="token number">35</span> u32 interrupts<span class="token punctuation">;</span> <span class="token comment">/* 中断使能标志*/</span>
<span class="token number">36</span>
<span class="token number">37</span> <span class="token comment">/* Union of PHY and Attached devices' supported modes */</span>
<span class="token number">38</span> <span class="token comment">/* See mii.h for more info */</span>
<span class="token number">39</span> u32 supported<span class="token punctuation">;</span>
<span class="token number">40</span> u32 advertising<span class="token punctuation">;</span>
<span class="token number">41</span> u32 lp_advertising<span class="token punctuation">;</span>
<span class="token number">42</span> <span class="token keyword">int</span> autoneg<span class="token punctuation">;</span>
<span class="token number">43</span> <span class="token keyword">int</span> link_timeout<span class="token punctuation">;</span>
<span class="token number">44</span>
<span class="token number">45</span> <span class="token comment">/*
46 * Interrupt number for this PHY
47 * -1 means no interrupt
48 */</span>
<span class="token number">49</span> <span class="token keyword">int</span> irq<span class="token punctuation">;</span> <span class="token comment">/* 中断号*/</span>
<span class="token number">50</span>
<span class="token number">51</span> <span class="token comment">/* private data pointer */</span>
<span class="token number">52</span> <span class="token comment">/* For use by PHYs to maintain extra state */</span>
<span class="token number">53</span> <span class="token keyword">void</span> <span class="token operator">*</span>priv<span class="token punctuation">;</span> <span class="token comment">/* 私有数据*/</span>
<span class="token number">54</span>
<span class="token number">55</span> <span class="token comment">/* Interrupt and Polling infrastructure */</span>
<span class="token number">56</span> <span class="token keyword">struct</span> <span class="token class-name">work_struct</span> phy_queue<span class="token punctuation">;</span>
<span class="token number">57</span> <span class="token keyword">struct</span> <span class="token class-name">delayed_work</span> state_queue<span class="token punctuation">;</span>
<span class="token number">58</span> <span class="token class-name">atomic_t</span> irq_disable<span class="token punctuation">;</span>
<span class="token number">59</span> <span class="token keyword">struct</span> <span class="token class-name">mutex</span> lock<span class="token punctuation">;</span>
<span class="token number">60</span> <span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>attached_dev<span class="token punctuation">;</span> <span class="token comment">/* PHY芯片对应的网络设备*/</span>
<span class="token number">61</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>adjust_link<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">net_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">62</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>一个PHY 设备对应一个phy_device 实例，然后需要向Linux 内核注册这个实例。使用phy_device_register 函数完成PHY 设备的注册，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">phy_device_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phy<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> phy：需要注册的PHY 设备。<br> 返回值：0 成功，负值失败。<br> PHY 设备的注册过程一般是先调用get_phy_device 函数获取PHY 设备，此函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.2</span> get_phy_device 函数
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span><span class="token function">get_phy_device</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">mii_bus</span> <span class="token operator">*</span>bus<span class="token punctuation">,</span> <span class="token keyword">int</span> addr<span class="token punctuation">,</span>
bool is_c45<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">phy_c45_device_ids</span> c45_ids <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">4</span> u32 phy_id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token number">5</span> <span class="token keyword">int</span> r<span class="token punctuation">;</span>
<span class="token number">6</span>
<span class="token number">7</span> r <span class="token operator">=</span> <span class="token function">get_phy_id</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>phy_id<span class="token punctuation">,</span> is_c45<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c45_ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">8</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>r<span class="token punctuation">)</span>
<span class="token number">9</span> <span class="token keyword">return</span> <span class="token function">ERR_PTR</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span>
<span class="token number">11</span> <span class="token comment">/* If the phy_id is mostly Fs, there is no device there */</span>
<span class="token number">12</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>phy_id <span class="token operator">&amp;</span> <span class="token number">0x1fffffff</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x1fffffff</span><span class="token punctuation">)</span>
<span class="token number">13</span> <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token number">14</span>
<span class="token number">15</span> <span class="token keyword">return</span> <span class="token function">phy_device_create</span><span class="token punctuation">(</span>bus<span class="token punctuation">,</span> addr<span class="token punctuation">,</span> phy_id<span class="token punctuation">,</span> is_c45<span class="token punctuation">,</span> <span class="token operator">&amp;</span>c45_ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token punctuation">}</span>
</code></pre> 
<p>第7 行，调用get_phy_id 函数获取PHY ID，也就是读取PHY 芯片的那两个ID 寄存器，得到PHY 芯片ID 信息。<br> 第15 行，调用phy_device_create 函数创建phy_device，此函数先申请phy_device 内存，然后初始化phy_device 的各个结构体成员，最终返回创建好的phy_device。phy_device_register 函数注册的就是这个创建好的phy_device。<br> 2、PHY 驱动<br> PHY 驱动使用结构体phy_driver 表示，结构体也定义在include/linux/phy.h 文件中，结构体内容如下(为了缩小篇幅，省略了注释部分)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.3</span> phy_driver 结构体
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> u32 phy_id<span class="token punctuation">;</span> <span class="token comment">/* PHY ID */</span>
<span class="token number">3</span> <span class="token keyword">char</span> <span class="token operator">*</span>name<span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> phy_id_mask<span class="token punctuation">;</span> <span class="token comment">/* PHY ID掩码*/</span>
<span class="token number">5</span> u32 features<span class="token punctuation">;</span>
<span class="token number">6</span> u32 flags<span class="token punctuation">;</span>
<span class="token number">7</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>driver_data<span class="token punctuation">;</span>
<span class="token number">8</span>
<span class="token number">9</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>soft_reset<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>config_init<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>probe<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">12</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>suspend<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>resume<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>config_aneg<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>aneg_done<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">16</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_status<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">17</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ack_interrupt<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>config_intr<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>did_interrupt<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">20</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>remove<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">21</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>match_phy_device<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">22</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>ts_info<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">ethtool_ts_info</span> <span class="token operator">*</span>ti<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">23</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>hwtstamp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">ifreq</span> <span class="token operator">*</span>ifr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">24</span> <span class="token function">bool</span> <span class="token punctuation">(</span><span class="token operator">*</span>rxtstamp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
<span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">25</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>txtstamp<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">sk_buff</span> <span class="token operator">*</span>skb<span class="token punctuation">,</span>
<span class="token keyword">int</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">26</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>set_wol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">ethtool_wolinfo</span> <span class="token operator">*</span>wol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">27</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>get_wol<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">ethtool_wolinfo</span> <span class="token operator">*</span>wol<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">28</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>link_change_notify<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">29</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>read_mmd_indirect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> ptrad<span class="token punctuation">,</span>
<span class="token number">30</span> <span class="token keyword">int</span> devnum<span class="token punctuation">,</span> <span class="token keyword">int</span> regnum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">31</span> <span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>write_mmd_indirect<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span> <span class="token keyword">int</span> ptrad<span class="token punctuation">,</span>
<span class="token number">32</span> <span class="token keyword">int</span> devnum<span class="token punctuation">,</span> <span class="token keyword">int</span> regnum<span class="token punctuation">,</span> u32 val<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">33</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>module_info<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">34</span> <span class="token keyword">struct</span> <span class="token class-name">ethtool_modinfo</span> <span class="token operator">*</span>modinfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">35</span> <span class="token keyword">int</span> <span class="token punctuation">(</span><span class="token operator">*</span>module_eeprom<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token number">36</span> <span class="token keyword">struct</span> <span class="token class-name">ethtool_eeprom</span> <span class="token operator">*</span>ee<span class="token punctuation">,</span> u8 <span class="token operator">*</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">37</span>
<span class="token number">38</span> <span class="token keyword">struct</span> <span class="token class-name">device_driver</span> driver<span class="token punctuation">;</span>
<span class="token number">39</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>可以看出，phy_driver 重点是大量的函数，编写PHY 驱动的主要工作就是实现这些函数，但是不一定全部实现，稍后我们会简单分析一下Linux 内核通用PHY 驱动。<br> ①、注册PHY 驱动<br> phy_driver 结构体初始化完成以后，就需要向Linux 内核注册，PHY 驱动的注册使用phy_driver_register 函数，注册phy 驱动的时候会设置驱动的总线为mdio_bus_type，也就是MDIO总线，关于MDIO 总线稍后会讲解，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">phy_driver_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> <span class="token operator">*</span>new_driver<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> new_driver：需要注册的PHY 驱动。<br> 返回值：0 成功，负值失败。<br> ②、连续注册多个PHY 驱动<br> 一个厂家会生产多种PHY 芯片，这些PHY 芯片内部差别一般不大，如果一个个的去注册驱动将会导致一堆重复的驱动文件，因此Linux 内核提供了一个连续注册多个PHY 驱动的函数phy_drivers_register。首先准备一个phy_driver 数组，一个数组元素就表示一个PHY 芯片的驱动，然后调用phy_drivers_register 一次性注册整个数组中的所有驱动，函数原型如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">phy_drivers_register</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> <span class="token operator">*</span>new_driver<span class="token punctuation">,</span> <span class="token keyword">int</span> n<span class="token punctuation">)</span>
</code></pre> 
<p>函数参数和返回值含义如下：<br> new_driver：需要注册的多个PHY 驱动数组。<br> n：要注册的驱动数量。<br> 返回值：0 成功，负值失败。<br> ③、卸载PHY 驱动<br> 卸载PHY 驱动的话使用phy_driver_unregister 函数，函数原型如下：<br> void phy_driver_unregister(struct phy_driver *drv)<br> 函数参数和返回值含义如下：<br> new_driver：需要卸载的PHY 驱动。<br> 返回值：无。<br> 3、MDIO 总线<br> 前面说了，PHY 子系统也是遵循设备、总线、驱动模型的，设备和驱动就是phy_device 和phy_driver。总线就是MDIO 总线，因为PHY 芯片是通过MIDO 接口来管理的，MDIO 总线最主要的工作就是匹配PHY 设备和PHY 驱动。在文件drivers/net/phy/mdio_bus.c 中有如下定义：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.4</span> mdio 总线
<span class="token number">1</span> <span class="token keyword">struct</span> <span class="token class-name">bus_type</span> mdio_bus_type <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"mdio_bus"</span><span class="token punctuation">,</span>
<span class="token number">3</span> <span class="token punctuation">.</span>match <span class="token operator">=</span> mdio_bus_match<span class="token punctuation">,</span>
<span class="token number">4</span> <span class="token punctuation">.</span>pm <span class="token operator">=</span> MDIO_BUS_PM_OPS<span class="token punctuation">,</span>
<span class="token number">5</span> <span class="token punctuation">.</span>dev_groups <span class="token operator">=</span> mdio_dev_groups<span class="token punctuation">,</span>
<span class="token number">6</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>示例代码69.4.3.4 定义了一个名为“mdio_bus_type”的总线，这个就是MDIO 总线，总线的名字为“mdio_bus”，重点是总线的匹配函数为mdio_bus_match。此函数内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.5</span> mdio_bus_match 匹配函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mdio_bus_match</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev<span class="token punctuation">,</span>
<span class="token keyword">struct</span> <span class="token class-name">device_driver</span> <span class="token operator">*</span>drv<span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">struct</span> <span class="token class-name">phy_device</span> <span class="token operator">*</span>phydev <span class="token operator">=</span> <span class="token function">to_phy_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">4</span> <span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> <span class="token operator">*</span>phydrv <span class="token operator">=</span> <span class="token function">to_phy_driver</span><span class="token punctuation">(</span>drv<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">5</span>
<span class="token number">6</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">of_driver_match_device</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> drv<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token number">7</span> <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">8</span>
<span class="token number">9</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>phydrv<span class="token operator">-&gt;</span>match_phy_device<span class="token punctuation">)</span>
<span class="token number">10</span> <span class="token keyword">return</span> phydrv<span class="token operator">-&gt;</span><span class="token function">match_phy_device</span><span class="token punctuation">(</span>phydev<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span>
<span class="token number">12</span> <span class="token keyword">return</span> <span class="token punctuation">(</span>phydrv<span class="token operator">-&gt;</span>phy_id <span class="token operator">&amp;</span> phydrv<span class="token operator">-&gt;</span>phy_id_mask<span class="token punctuation">)</span> <span class="token operator">==</span>
<span class="token number">13</span> <span class="token punctuation">(</span>phydev<span class="token operator">-&gt;</span>phy_id <span class="token operator">&amp;</span> phydrv<span class="token operator">-&gt;</span>phy_id_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token punctuation">}</span>
</code></pre> 
<p>第6 行，采用设备树的话先尝试使用of_driver_match_device 来对设备和驱动进行匹配，也就是检查compatible 属性值与匹配表of_match_table 里面的内容是否一致。但是对于本章教程而言，并不是通过of_driver_match_device 来完成PHY 驱动和设备匹配的。<br> 第9、10 行，检查PHY 驱动有没有提供匹配函数match_phy_device，如果有的话就直接调用PHY 驱动提供的匹配函数完成与设备的匹配。<br> 第12、13 行，如果上面两个匹配方法都无效的话就使用最后一种，phy_driver 里面有两个成员变量phy_id 和phy_id_mask，表示此驱动所匹配的PHY 芯片ID 以及ID 掩码，PHY 驱动编写人员需要给这两个成员变量赋值。phy_device 也有一个phy_id 成员变量，表示此PHY 芯片的ID，phy_device 里面的phy_id 是在注册PHY 设备的时候调用get_phy_id 函数直接读取PHY 芯片内部ID 寄存器得到的！很明显PHY 驱动和PHY 设备中的ID 要一样，这样才能匹配起来。所以最后一种方法就是对比PHY 驱动和PHY 设备中的phy_id 是否一致，这里需要与<br> PHY 驱动里面的phy_id_mask 进行与运算，如果结果一致的话就说明驱动和设备匹配。<br> 如果PHY 设备和PHY 驱动匹配，那么就使用指定的PHY 驱动，如果不匹配的话就使用Linux 内核自带的通用PHY 驱动。<br> 4、通用PHY 驱动<br> 前面多次提到Linux 内核已经集成了通用PHY 驱动，通用PHY驱动名字为“Generic PHY”，打开drivers/net/phy/phy_device.c，找到phy_init 函数，内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.6</span> phy_init 函数
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">int</span> __init <span class="token function">phy_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token keyword">int</span> rc<span class="token punctuation">;</span>
<span class="token number">4</span>
<span class="token number">5</span> rc <span class="token operator">=</span> <span class="token function">mdio_bus_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">6</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
<span class="token number">7</span> <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token number">8</span>
<span class="token number">9</span> rc <span class="token operator">=</span> <span class="token function">phy_drivers_register</span><span class="token punctuation">(</span>genphy_driver<span class="token punctuation">,</span>
<span class="token number">10</span> <span class="token function">ARRAY_SIZE</span><span class="token punctuation">(</span>genphy_driver<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">11</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>rc<span class="token punctuation">)</span>
<span class="token number">12</span> <span class="token function">mdio_bus_exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token number">13</span>
<span class="token number">14</span> <span class="token keyword">return</span> rc<span class="token punctuation">;</span>
<span class="token number">15</span> <span class="token punctuation">}</span>

</code></pre> 
<p>phy_init 是整个PHY 子系统的入口函数，第9 行会调用phy_drivers_register 函数向内核直接注册一个通用PHY 驱动：genphy_driver，也就是通用PHY 驱动，也就是说Linux 系统启动以后默认就已经存在了通用PHY 驱动。<br> genphy_driver 是一个数组，有两个数组元素，表示有两个通用的PHY 驱动，一个是针对10/100/1000M 网络的，一个是针对10G 网络的。genphy_driver 定义在drivers/net/phy/phy_device.c里面，内容如下：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.7</span> 通用PHY 驱动
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> genphy_driver<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span>
<span class="token number">4</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span>
<span class="token number">5</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Generic PHY"</span><span class="token punctuation">,</span>
<span class="token number">6</span> <span class="token punctuation">.</span>soft_reset <span class="token operator">=</span> genphy_soft_reset<span class="token punctuation">,</span>
<span class="token number">7</span> <span class="token punctuation">.</span>config_init <span class="token operator">=</span> genphy_config_init<span class="token punctuation">,</span>
<span class="token number">8</span> <span class="token punctuation">.</span>features <span class="token operator">=</span> PHY_GBIT_FEATURES <span class="token operator">|</span> SUPPORTED_MII <span class="token operator">|</span>
<span class="token number">9</span> SUPPORTED_AUI <span class="token operator">|</span> SUPPORTED_FIBRE <span class="token operator">|</span>
<span class="token number">10</span> SUPPORTED_BNC<span class="token punctuation">,</span>
<span class="token number">11</span> <span class="token punctuation">.</span>config_aneg <span class="token operator">=</span> genphy_config_aneg<span class="token punctuation">,</span>
<span class="token number">12</span> <span class="token punctuation">.</span>aneg_done <span class="token operator">=</span> genphy_aneg_done<span class="token punctuation">,</span>
<span class="token number">13</span> <span class="token punctuation">.</span>read_status <span class="token operator">=</span> genphy_read_status<span class="token punctuation">,</span>
<span class="token number">14</span> <span class="token punctuation">.</span>suspend <span class="token operator">=</span> genphy_suspend<span class="token punctuation">,</span>
<span class="token number">15</span> <span class="token punctuation">.</span>resume <span class="token operator">=</span> genphy_resume<span class="token punctuation">,</span>
<span class="token number">16</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">17</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">18</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span>
<span class="token number">19</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xffffffff</span><span class="token punctuation">,</span>
<span class="token number">20</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Generic 10G PHY"</span><span class="token punctuation">,</span>
<span class="token number">21</span> <span class="token punctuation">.</span>soft_reset <span class="token operator">=</span> gen10g_soft_reset<span class="token punctuation">,</span>
<span class="token number">22</span> <span class="token punctuation">.</span>config_init <span class="token operator">=</span> gen10g_config_init<span class="token punctuation">,</span>
<span class="token number">23</span> <span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token number">24</span> <span class="token punctuation">.</span>config_aneg <span class="token operator">=</span> gen10g_config_aneg<span class="token punctuation">,</span>
<span class="token number">25</span> <span class="token punctuation">.</span>read_status <span class="token operator">=</span> gen10g_read_status<span class="token punctuation">,</span>
<span class="token number">26</span> <span class="token punctuation">.</span>suspend <span class="token operator">=</span> gen10g_suspend<span class="token punctuation">,</span>
<span class="token number">27</span> <span class="token punctuation">.</span>resume <span class="token operator">=</span> gen10g_resume<span class="token punctuation">,</span>
<span class="token number">28</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token number">29</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>genphy_driver 数组有两个元素，genphy_driver[0]为10/100/1000M 的PHY 驱动，名字为“Generic PHY”，genphy_driver[1]为10G 的PHY 驱动，名字为“Generic 10G PHY”。注意，很多另外编写的PHY 驱动也会用到通用PHY 驱动的一些函数，比如正点原子ALPHA 开发板所用的LAN8720A 是SMSC 公司的产品，此公司针对自家的所有PHY 芯片编写了一个驱动文件smsc.c，这驱动文件里面用到了大量的通用PHY 驱动相关函数。<br> 5、LAN8720A 驱动<br> 最后我们来看一下LAN8720A 的Linux 驱动，LAN8720A 的驱动文件为<br> drivers/net/phy/smsc.c，这个文件是SMSC 针对自家的一些PHY 芯片编写的驱动文件，其中就包含了LAN8720A 这个PHY 芯片。默认情况下，LAN8720A 这个驱动是没有打开的，我们需要配置linux 内核，打开此驱动选项，配置路径如下：</p> 
<pre><code class="prism language-c"><span class="token operator">-&gt;</span> Device Drivers
	<span class="token operator">-&gt;</span> Network device support
		<span class="token operator">-&gt;</span> PHY Device support and infrastructure
			<span class="token operator">-&gt;</span> Drivers <span class="token keyword">for</span> SMSC PHYs
</code></pre> 
<p>配置界面如图69.4.3.1 所示：<br> <img src="https://images2.imgbox.com/9c/b4/17e88OEN_o.png" alt="在这里插入图片描述"></p> 
<p>图69.4.3.1 使能LAN8720A 驱动<br> 选中图69.4.3.1 中的“Drivers for SMSC PHYs”，然后编译内核即可，这个在37.4.3 小节讲解linux 移植的时候都已经说过了。<br> 打开smsc.c，找到如下所示内容(限于篇幅，有删减)：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.4</span><span class="token number">.3</span><span class="token number">.8</span> 通用PHY 驱动
<span class="token number">1</span> <span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">phy_driver</span> smsc_phy_driver<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">3</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0x0007c0a0</span><span class="token punctuation">,</span> <span class="token comment">/* OUI=0x00800f, Model#=0x0a */</span>
<span class="token number">4</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xfffffff0</span><span class="token punctuation">,</span>
<span class="token number">5</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"SMSC LAN83C185"</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">24</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span>
<span class="token number">25</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">26</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0x0007c0b0</span><span class="token punctuation">,</span> <span class="token comment">/* OUI=0x00800f, Model#=0x0b */</span>
<span class="token number">27</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xfffffff0</span><span class="token punctuation">,</span>
<span class="token number">28</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"SMSC LAN8187"</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">47</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span>
<span class="token number">48</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">49</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0x0007c0c0</span><span class="token punctuation">,</span> <span class="token comment">/* OUI=0x00800f, Model#=0x0c */</span>
<span class="token number">50</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xfffffff0</span><span class="token punctuation">,</span>
<span class="token number">51</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"SMSC LAN8700"</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">70</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span>
<span class="token number">71</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">72</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0x0007c0d0</span><span class="token punctuation">,</span> <span class="token comment">/* OUI=0x00800f, Model#=0x0d */</span>
<span class="token number">73</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xfffffff0</span><span class="token punctuation">,</span>
<span class="token number">74</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"SMSC LAN911x Internal PHY"</span><span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token number">92</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span>
<span class="token number">93</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">94</span> <span class="token punctuation">.</span>phy_id <span class="token operator">=</span> <span class="token number">0x0007c0f0</span><span class="token punctuation">,</span> <span class="token comment">/* OUI=0x00800f, Model#=0x0f */</span>
<span class="token number">95</span> <span class="token punctuation">.</span>phy_id_mask <span class="token operator">=</span> <span class="token number">0xfffffff0</span><span class="token punctuation">,</span>
<span class="token number">96</span> <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"SMSC LAN8710/LAN8720"</span><span class="token punctuation">,</span>
<span class="token number">97</span>
<span class="token number">98</span> <span class="token punctuation">.</span>features <span class="token operator">=</span> <span class="token punctuation">(</span>PHY_BASIC_FEATURES <span class="token operator">|</span> SUPPORTED_Pause
<span class="token number">99</span> <span class="token operator">|</span> SUPPORTED_Asym_Pause<span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token number">100</span> <span class="token punctuation">.</span>flags <span class="token operator">=</span> PHY_HAS_INTERRUPT <span class="token operator">|</span> PHY_HAS_MAGICANEG<span class="token punctuation">,</span>
<span class="token number">101</span>
<span class="token number">102</span> <span class="token comment">/* basic functions */</span>
<span class="token number">103</span> <span class="token punctuation">.</span>config_aneg <span class="token operator">=</span> genphy_config_aneg<span class="token punctuation">,</span>
<span class="token number">104</span> <span class="token punctuation">.</span>read_status <span class="token operator">=</span> lan87xx_read_status<span class="token punctuation">,</span>
<span class="token number">105</span> <span class="token punctuation">.</span>config_init <span class="token operator">=</span> smsc_phy_config_init<span class="token punctuation">,</span>
<span class="token number">106</span> <span class="token punctuation">.</span>soft_reset <span class="token operator">=</span> smsc_phy_reset<span class="token punctuation">,</span>
<span class="token number">107</span>
<span class="token number">108</span> <span class="token comment">/* IRQ related */</span>
<span class="token number">109</span> <span class="token punctuation">.</span>ack_interrupt <span class="token operator">=</span> smsc_phy_ack_interrupt<span class="token punctuation">,</span>
<span class="token number">110</span> <span class="token punctuation">.</span>config_intr <span class="token operator">=</span> smsc_phy_config_intr<span class="token punctuation">,</span>
<span class="token number">111</span>
<span class="token number">112</span> <span class="token punctuation">.</span>suspend <span class="token operator">=</span> genphy_suspend<span class="token punctuation">,</span>
<span class="token number">113</span> <span class="token punctuation">.</span>resume <span class="token operator">=</span> genphy_resume<span class="token punctuation">,</span>
<span class="token number">114</span>
<span class="token number">115</span> <span class="token punctuation">.</span>driver <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span>owner <span class="token operator">=</span> THIS_MODULE<span class="token punctuation">,</span> <span class="token punctuation">}</span>
<span class="token number">116</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">117</span>
<span class="token number">118</span> <span class="token function">module_phy_driver</span><span class="token punctuation">(</span>smsc_phy_driver<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>从示例代码69.4.3.8 可以看出，smsc_phy_driver 还是支持了不少SMSC 家的PHY 芯片，比如LAN83C185、LAN8187、LAN8700 等等，当然了，肯定也包括了LAN8720 系列，第93~116行就是LAN8710/LAN8720 系列PHY 驱动。<br> 第94 行，PHY ID 为0X0007C0F0。<br> 第95 行，PHY 的ID 掩码为0XFFFFFFF0，也就是前28 位有效，在进行匹配的时候只需要比较前28 位，第4 位不用比较。<br> 第74 行，驱动名字为“SMSC LAN8710/LAN8720”，系统启动以后，打开网卡就会提示当前PHY 驱动名字为“SMSC LAN8710/LAN8720”。<br> 最后，第118 行使用module_phy_driver(本质是一个宏)来完成smsc_phy_driver 的注册。<br> 此驱动里面的成员函数有一些是SMSC 自己编写的，有一些是直接用的通用PHY 驱动的，比如第103 行的genphy_config_aneg、第112 行的genphy_suspend 等。</p> 
<h2><a id="_2154"></a>网络驱动实验测试</h2> 
<h3><a id="LAN8720_PHY__2155"></a>LAN8720 PHY 驱动测试</h3> 
<p>首先肯定是驱动修改，这个已经在37.4.3 小节做了详细的讲解，参考修改即可。系统启动以后就会打印出当前PHY 驱动名字为“SMSC LAN8710/LAN8720”，如图69.5.1.1 所示：<br> <img src="https://images2.imgbox.com/c8/30/Vsr8pSF7_o.png" alt="在这里插入图片描述"></p> 
<p>图69.5.1.1 网络PHY 驱动信息<br> 从图69.5.1.1 可以看出，此时PHY 驱动使用的是“SMSC LAN8710/8720”，当我们使用ifconfig 命令打开网卡的时候也会提示当前PHY 驱动名字。至于网络的测试就很简单了，大家可以ping 一下主机或者ubuntu 的地址，如果能ping 通就说明网络工作正常。</p> 
<h3><a id="PHY__2161"></a>通用PHY 驱动测试</h3> 
<p>前面我们说了，按道理来讲通用PHY 驱动肯定是可以驱动起任何的PHY 芯片的，但是有时候社会就是这样的不讲道理，笔者一开始就是使用通用PHY 驱动来驱动LAN8720，结果现实给年轻的笔者上了一课，失败了！经过搜索发现，在I.MX6ULL 下使用LAN8720 的话需要ENET1_TX_CLK 和ENET2_TX_CLK 这两个引脚的配置，也就是需要修改fec_main.c 文件中的fec_probe 函数，具体修改内容参看37.4.3 小节。修改完成以后就可以尝试使用通用PHY 驱动，不保证会成功！首先配置Linux 内核，关闭自带的LAN8720 驱动即可，然后重新编译linux 内<br> 核，使用新的linux 内核启动即可。<br> 系统启动以后就会使用通用PHY 驱动，会输出如图69.5.1.2 所示信息：<br> <img src="https://images2.imgbox.com/46/e6/Rp1DvhR6_o.png" alt="在这里插入图片描述"><br> 图69.5.2.1 通用PHY 驱动信息<br> 从图69.5.2.1 可以看出，此时网卡驱动名字为“Generic PHY”，说明使用的是通用PHY 驱动。</p> 
<h3><a id="DHCP__2168"></a>DHCP 功能配置</h3> 
<p>我们以前做实验的时候，开发板的IP 地址都是手动设置的，但是自己设置IP 地址很容易和网络中其他设备的IP 地址冲突，最好的办法就是让路由器自动分配IP 地址，通过路由器分配到的IP 地址肯定是在本网络中独一无二的。我们需要通过udhcpc 命令来实现从路由器动态申请IP 地址，udhcpc 命令已经集成到了busybox 中，所以不需要我们另外移植。<br> 另外，我们还需要一个文件，否则直接使用udhcpc 申请IP 地址会失败。在busybox 源码中找到examples/udhcp/simple.script，将其拷贝到开发板的/usr/share/udhcpc 目录下(如果没有的话请自行创建此目录)，拷贝完成以后将根文件系统下的simple.script 并且重命名为default.script，命令如下：</p> 
<pre><code class="prism language-c">cd busybox<span class="token operator">-</span><span class="token number">1.29</span><span class="token number">.0</span><span class="token operator">/</span>examples<span class="token operator">/</span>udhcp
cp simple<span class="token punctuation">.</span>script <span class="token operator">/</span>home<span class="token operator">/</span>zuozhongkai<span class="token operator">/</span>linux<span class="token operator">/</span>nfs<span class="token operator">/</span>rootfs<span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>udhcpc<span class="token operator">/</span><span class="token keyword">default</span><span class="token punctuation">.</span>script <span class="token comment">//拷贝并重</span>
命名
</code></pre> 
<p>完成以后就可以使用udhcpc 来给指定的网卡申请IP 地址了，通过“-i”参数来指定给哪个网卡申请IP 地址，“-i”参数后面紧跟要申请IP 地址的网卡名字。比如，这里我们以正点原子的ALPHA 开发板为例，给eth1 这个网卡申请IP 地址，命令如下：</p> 
<pre><code class="prism language-c">ifconfig eth1 up <span class="token comment">//打开eth1 网卡</span>
udhcpc <span class="token operator">-</span>i eth1 <span class="token comment">//为eth1 网卡申请IP 地址</span>
</code></pre> 
<p>申请过程如图69.5.3.1 所示：<br> <img src="https://images2.imgbox.com/24/d3/RS4jYUK1_o.png" alt="在这里插入图片描述"></p> 
<p>图69.5.3.1 udhcpc 申请IP 地址过程<br> 从图69.5.3.1 可以看出，eth1 申请到的IP 地址是192.168.1.156，并且也修改了/etc/resolv.conf文件中DNS 服务器地址。可以输入“ifconfig”命令来查看eth1 网卡的详细信息，这里就不演示了。</p> 
<h2><a id="_2190"></a>单网卡使用</h2> 
<p>有时候我们在实际的产品开发中由于I.MX6ULL 引脚数量的限制，用到的一些外设引脚和网卡冲突了，但是我们的产品又不需要两个网卡，有一个就够了。这个时候就需要修改linux 内核，实现一个网卡的使用，另外一个网卡的IO 用作其他的外设。</p> 
<h3><a id="ENET2__2192"></a>只使用ENET2 网卡</h3> 
<p>如果只使用ENET2 网卡的话修改起来比较简单，打开设备树imx6ull-alientek-emmc.dts，ENET1 网卡对应的节点名字为fec1，ENET2 网卡对应的节点名字为fec2。我们需要关闭ENET1网卡，首先找到fec1 节点，然后将其中的status 属性改为“disabled”即可，修改完成以后的fec1节点内容如下</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.6</span><span class="token number">.1</span><span class="token number">.1</span> fec1 节点信息
<span class="token number">1</span> <span class="token operator">&amp;</span>fec1 <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
<span class="token number">3</span> pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_enet1
<span class="token number">4</span> <span class="token operator">&amp;</span>pinctrl_enet1_reset<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">5</span> phy<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token string">"rmii"</span><span class="token punctuation">;</span>
<span class="token number">6</span> phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethphy0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">7</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">7</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">8</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>duration <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">200</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">9</span> status <span class="token operator">=</span> <span class="token string">"disabled"</span><span class="token punctuation">;</span>
<span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>第9 行，将status 改为“disabled”。<br> 修改完成以后重新编译设备树，使用新的设备树启动内核。内核启动以后输入如下命令查看当前系统中所有网卡：</p> 
<pre><code class="prism language-c">ifconfig <span class="token operator">-</span>a <span class="token comment">//查看所有网卡</span>
</code></pre> 
<p>结果如图69.6.1.1 所示：<br> <img src="https://images2.imgbox.com/5b/66/qebR0iSs_o.png" alt="在这里插入图片描述"></p> 
<p>图69.6.1.1 当前系统网卡信息<br> 从图69.6.1.1 可以看出，此时只要一个eth0 网卡，并没有eth1，说明fec1 被我们关闭了，接下来大家就可以将fec1 网卡对应的IO 复用为其他外设功能了。</p> 
<h3><a id="ENET1__2221"></a>只使用ENET1 网卡</h3> 
<p>如果只使用ENET1 网卡的话就稍微复杂一点了，不是简单的将fec2 节点下的status 改为“disabled”，按照如下步骤来修改设备树imx6ull-alientek-emmc.dts：<br> 1、屏蔽或删除掉fec2 节点内容<br> 首先，屏蔽或删除掉imx6ull-alientek-emmc.dts 文件中ENET2 网卡对应的fec2 节点内容，如图69.6.2.1 所示：<br> <img src="https://images2.imgbox.com/84/a3/x9zr5gqM_o.png" alt="在这里插入图片描述"></p> 
<p>图69.6.2.1 屏蔽掉fec2 节点内容<br> 2、修改ENET1 对应的fec1 节点信息。<br> 接下来需要fec1 节点进行修改，重点是在fec1 节点下添加mdio 子节点，修改后的fec1 节点内容如下所示：</p> 
<pre><code class="prism language-c">示例代码<span class="token number">69.6</span><span class="token number">.1</span><span class="token number">.2</span> 修改后的fec1 节点
<span class="token number">1</span> <span class="token operator">&amp;</span>fec1 <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> pinctrl<span class="token operator">-</span>names <span class="token operator">=</span> <span class="token string">"default"</span><span class="token punctuation">;</span>
<span class="token number">3</span> pinctrl<span class="token operator">-</span><span class="token number">0</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>pinctrl_enet1
<span class="token number">4</span> <span class="token operator">&amp;</span>pinctrl_enet1_reset<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">5</span> phy<span class="token operator">-</span>mode <span class="token operator">=</span> <span class="token string">"rmii"</span><span class="token punctuation">;</span>
<span class="token number">6</span> phy<span class="token operator">-</span>handle <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>ethphy0<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">7</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>gpios <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token operator">&amp;</span>gpio5 <span class="token number">7</span> GPIO_ACTIVE_LOW<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">8</span> phy<span class="token operator">-</span>reset<span class="token operator">-</span>duration <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">200</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">9</span> status <span class="token operator">=</span> <span class="token string">"okay"</span><span class="token punctuation">;</span>
<span class="token number">10</span>
<span class="token number">11</span> mdio <span class="token punctuation">{<!-- --></span>
<span class="token number">12</span> #address<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">13</span> #size<span class="token operator">-</span>cells <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">14</span>
<span class="token number">15</span> ethphy0<span class="token operator">:</span> ethernet<span class="token operator">-</span>phy@<span class="token number">0</span> <span class="token punctuation">{<!-- --></span>
<span class="token number">16</span> compatible <span class="token operator">=</span> <span class="token string">"ethernet-phy-ieee802.3-c22"</span><span class="token punctuation">;</span>
<span class="token number">17</span> reg <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">18</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">19</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token number">20</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>重点是在fec1 中添加第11~19 行的mdio 子节点，而且仅仅留下ENET1 对应的PHY 子节点。<br> 3、屏蔽或删除掉ENET2 对应的pinctrl 节点<br> 屏蔽后删除掉ENET2 对应的pinctrl_enet2，如图69.6.2.2 所示：<br> <img src="https://images2.imgbox.com/8a/39/xwd2mKzO_o.png" alt="在这里插入图片描述"></p> 
<p>图69.6.2.2 屏蔽掉pinctrl_enet2 节点<br> 4、在ENET1 网卡对应的pinctrl 节点中添加MDIO 和MDC 引脚配置<br> 默认情况下GPIO1_IO07 和GPIO1_IO06 复用为了ENET2 的MDC 和MDIO，因此这里我们需要重新将GPIO1_IO07 和GPIO1_IO06 这两个IO 复用为ENET1 的MDC 和DMIO，修改后的pinctrl_enet1 内容如下所示：</p> 
<pre><code class="prism language-c"><span class="token comment">//示例代码69.6.1.3 修改后的pinctrl_enet1节点</span>
<span class="token number">1</span> pinctrl_enet1<span class="token operator">:</span> enet1grp <span class="token punctuation">{<!-- --></span>
<span class="token number">2</span> fsl<span class="token punctuation">,</span>pins <span class="token operator">=</span> <span class="token operator">&lt;</span>
<span class="token number">3</span> MX6UL_PAD_GPIO1_IO07__ENET1_MDC <span class="token number">0x1b0b0</span>
<span class="token number">4</span> MX6UL_PAD_GPIO1_IO06__ENET1_MDIO <span class="token number">0x1b0b0</span>
<span class="token number">5</span> MX6UL_PAD_ENET1_RX_EN__ENET1_RX_EN <span class="token number">0x1b0b0</span>
<span class="token number">6</span> MX6UL_PAD_ENET1_RX_ER__ENET1_RX_ER <span class="token number">0x1b0b0</span>
<span class="token number">7</span> MX6UL_PAD_ENET1_RX_DATA0__ENET1_RDATA00 <span class="token number">0x1b0b0</span>
<span class="token number">8</span> MX6UL_PAD_ENET1_RX_DATA1__ENET1_RDATA01 <span class="token number">0x1b0b0</span>
<span class="token number">9</span> MX6UL_PAD_ENET1_TX_EN__ENET1_TX_EN <span class="token number">0x1b0b0</span>
<span class="token number">10</span> MX6UL_PAD_ENET1_TX_DATA0__ENET1_TDATA00 <span class="token number">0x1b0b0</span>
<span class="token number">11</span> MX6UL_PAD_ENET1_TX_DATA1__ENET1_TDATA01 <span class="token number">0x1b0b0</span>
<span class="token number">12</span> MX6UL_PAD_ENET1_TX_CLK__ENET1_REF_CLK1 <span class="token number">0x4001b009</span>
<span class="token number">13</span> <span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token number">14</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

</code></pre> 
<p>第3 行，将GPIO1_IO07 复用为ENET1_MDC 引脚。<br> 第4 行，将GPIO1_IO06 复用为ENET1_MDIO 引脚。<br> 至此，设备树修改完成，重新编译设备树，然后用新的设备树启动系统。启动以后输入如下命令查看开发板所有网卡信息：</p> 
<pre><code class="prism language-c">ifconfig <span class="token operator">-</span>a
</code></pre> 
<p>结果如图69.6.2.3 所示：<br> <img src="https://images2.imgbox.com/8b/6b/PyntIsv7_o.png" alt="在这里插入图片描述"></p> 
<p>图69.6.2.3 开发板网卡信息<br> 从图69.6.2.3 可以看出，此时整个系统只有一个eth0 网卡，注意！这里的eth0 网卡就是ENET1，不要和前面的混淆了，以为eth0 是ENET2 网卡名字。<br> 至此，关于Linux 的网络驱动就讲到这里，整体比较复杂，但是实际使用起来确实非常简单的，尤其是对这种内置MAC+外置PHY 的网络方案而言，几乎不需要我们修改驱动，因为内核已经继承了通用PHY 驱动了。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/20c10ce45b6cfcd517cd52152fc6d4cf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ubuntu开机自动执行某条命令、程序的实现方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1944ac526e80bd9810ab14af4b0991d3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python 重定向输出到控件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>