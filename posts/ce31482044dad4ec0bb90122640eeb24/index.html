<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Jetpack（二）—— ViewModel - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Jetpack（二）—— ViewModel" />
<meta property="og:description" content="1 ViewModel简介 Android平台上之所以会出现诸如MVP、MVVM之类的项目架构，就是因为在传统的开发模式下，Activity的任务实在是太重 了，既要负责逻辑处理，又要控制UI展示，甚至还得处理网络回调，等等。在一个小型项目中这样写或许没有什么问题，但是如果在大型项目中仍然使用这种写法的话，那么这个项目将会变得非常臃肿并且难以维护，因为没有任何架构上的划分。
以下是ViewModel的官网介绍：The ViewModel class is designed to store and manage UI-related data in a lifecycle conscious way. The ViewModel class allows data to survive configuration changes such as screen rotations.
ViewModel类旨在以注重生命周期的方式存储和管理界面相关的数据。ViewModel类让数据可在发生屏幕旋转等配置更改后继续留存。
**ViewModel的作用是存放和界面相关的数据，分担Activity/Fragment的一部分工作，同时维护自己独立的生命周期。**也就是说，只要是界面上能看得到的数据，它的相关变量都应该存放在ViewModel中，这样可以在一定程度上减少Activity中的逻辑。
**另外，Activity/Fragment经常需要处理一些异步调用，要管理这些调用，并确保在其销毁后清理这些调用以避免潜在的内存泄漏。**此项管理需要大量的维护工作，并且在为配置更改重新创建对象的情况下，会造成资源的浪费，因为对象可能需要重新发出已经发出过的调用。
**还有就是当系统配置发生变化（如切换语言）或者横竖屏切换时，导致Activity销毁重建，与界面相关的数据都会丢失。**对于简单的数据，Activity可以使用 onSaveInstanceState() 方法从 onCreate() 中的捆绑包恢复其数据，但此方法仅适合可以序列化再反序列化的少量数据，而不适合数量可能较大的数据，如用户列表或位图。这个时候就可以使用ViewModel来解决问题。
2 ViewModel的生命周期 下图说明了Activity经历屏幕旋转而后结束时所处的各种生命周期状态，该图还在关联的Activity生命周期的旁边显示了ViewModel的生命周期。此图说明了Activity的各种状态，这些基本状态同样适用于Fragment的生命周期。
ViewModel的生命周期方法只有一个onCleared()，在ViewModel实例被清除的时候回调。
ViewModel实例存在的时间范围是：获取ViewModel实例时传递给ViewModelProvider的Lifecycle。ViewModel将一直留在内存中，直到限定其存在时间范围的Lifecycle永久消失：对于activity，是在activity完成时；而对于fragment，是在fragment分离时。
ViewModelProvider(&lt;Activity或Fragment实例&gt;).get(&lt;定义的ViewModel&gt;::class.java) 通常在系统首次调用Activity对象的 onCreate() 方法时请求ViewModel。系统可能会在activity的整个生命周期内多次调用 onCreate()，如在旋转设备屏幕时。因此，这里没有使用new来创建ViewModel实例。
另外，当手机发生横竖屏旋转的时候， Activity会被重新创建，同时存放在Activity中的数据也会丢失。**而ViewModel和Activity不同， 它可以保证在手机屏幕发生旋转的时候不会被重新创建，只有当Activity退出的时候才会跟着Activity一起销毁。**因此，将与界面相关的变量存放在ViewModel当中， 这样即使旋转手机屏幕，界面上显示的数据也不会丢失。
3 ViewModel的基本用法 第一步：添加依赖 由于Jetpack中的组件通常是以AndroidX库的形式发布的，因此一些常用的Jetpack组件会在创建Android项目时自动被包含进去。 不过如果想要使用ViewModel组件，还需要在app/build.gradle文件中添加如下依赖：
dependencies { .... implementation &#34;androidx.lifecycle:lifecycle-extensions:2.2.0&#34; } 第二步：创建ViewModel 通常来讲，比较好的编程规范是给每一个Activity和Fragment都创建一个对应的ViewModel，因此这里为TimerActivity创建一个对应的TimerViewModel类，并让它继承自ViewModel，代码如下所示：
class TimerViewModel: ViewModel() { } 根据前面所学，所有与界面相关的数据都应该放在ViewModel中。要实现 一个计数器的功能，就可以在ViewModel中加入一个counter变量用于计数，如下所示：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ce31482044dad4ec0bb90122640eeb24/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-09T15:42:06+08:00" />
<meta property="article:modified_time" content="2022-09-09T15:42:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Jetpack（二）—— ViewModel</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="1_ViewModel_1"></a>1 <code>ViewModel</code>简介</h4> 
<p><code>Android</code>平台上之所以会出现诸如<code>MVP</code>、<code>MVVM</code>之类的项目架构，就是因为在传统的开发模式下，<code>Activity</code>的任务实在是太重 了，既要负责逻辑处理，又要控制<code>UI</code>展示，甚至还得处理网络回调，等等。在一个小型项目中这样写或许没有什么问题，但是如果在大型项目中仍然使用这种写法的话，那么这个项目将会变得非常臃肿并且难以维护，因为没有任何架构上的划分。</p> 
<p>以下是<code>ViewModel</code>的官网介绍：The ViewModel class is designed to store and manage UI-related data in a lifecycle conscious way. The ViewModel class allows data to survive configuration changes such as screen rotations.</p> 
<p><code>ViewModel</code>类旨在以注重生命周期的方式存储和管理界面相关的数据。<code>ViewModel</code>类让数据可在发生屏幕旋转等配置更改后继续留存。</p> 
<p>**<code>ViewModel</code>的作用是存放和界面相关的数据，分担<code>Activity/Fragment</code>的一部分工作，同时维护自己独立的生命周期。**也就是说，只要是界面上能看得到的数据，它的相关变量都应该存放在<code>ViewModel</code>中，这样可以在一定程度上减少<code>Activity</code>中的逻辑。</p> 
<p>**另外，<code>Activity/Fragment</code>经常需要处理一些异步调用，要管理这些调用，并确保在其销毁后清理这些调用以避免潜在的内存泄漏。**此项管理需要大量的维护工作，并且在为配置更改重新创建对象的情况下，会造成资源的浪费，因为对象可能需要重新发出已经发出过的调用。</p> 
<p>**还有就是当系统配置发生变化（如切换语言）或者横竖屏切换时，导致<code>Activity</code>销毁重建，与界面相关的数据都会丢失。**对于简单的数据，<code>Activity</code>可以使用 <code>onSaveInstanceState()</code> 方法从 <code>onCreate()</code> 中的捆绑包恢复其数据，但此方法仅适合可以序列化再反序列化的少量数据，而不适合数量可能较大的数据，如用户列表或位图。这个时候就可以使用<code>ViewModel</code>来解决问题。</p> 
<h4><a id="2_ViewModel_15"></a>2 <code>ViewModel</code>的生命周期</h4> 
<p>下图说明了<code>Activity</code>经历屏幕旋转而后结束时所处的各种生命周期状态，该图还在关联的<code>Activity</code>生命周期的旁边显示了<code>ViewModel</code>的生命周期。此图说明了<code>Activity</code>的各种状态，这些基本状态同样适用于<code>Fragment</code>的生命周期。</p> 
<p><img src="https://images2.imgbox.com/33/10/3ueKqKWf_o.png" alt="ViewModel" width="60%" height="60%"></p> 
<p><strong><code>ViewModel</code>的生命周期方法只有一个<code>onCleared()</code>，在<code>ViewModel</code>实例被清除的时候回调。</strong></p> 
<p><strong><code>ViewModel</code>实例存在的时间范围是：获取<code>ViewModel</code>实例时传递给<code>ViewModelProvider</code>的<code>Lifecycle</code>。</strong><code>ViewModel</code>将一直留在内存中，直到限定其存在时间范围的<code>Lifecycle</code>永久消失：对于<code>activity</code>，是在<code>activity</code>完成时；而对于<code>fragment</code>，是在<code>fragment</code>分离时。</p> 
<pre><code class="prism language-kotlin"><span class="token function">ViewModelProvider</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Activity或Fragment实例<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>定义的ViewModel<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</code></pre> 
<p><strong>通常在系统首次调用<code>Activity</code>对象的 <code>onCreate()</code> 方法时请求<code>ViewModel</code>。系统可能会在<code>activity</code>的整个生命周期内多次调用 <code>onCreate()</code>，如在旋转设备屏幕时。因此，这里没有使用<code>new</code>来创建<code>ViewModel</code>实例。</strong></p> 
<p>另外，当手机发生横竖屏旋转的时候， <code>Activity</code>会被重新创建，同时存放在<code>Activity</code>中的数据也会丢失。**而<code>ViewModel</code>和<code>Activity</code>不同， 它可以保证在手机屏幕发生旋转的时候不会被重新创建，只有当<code>Activity</code>退出的时候才会跟着<code>Activity</code>一起销毁。**因此，将与界面相关的变量存放在<code>ViewModel</code>当中， 这样即使旋转手机屏幕，界面上显示的数据也不会丢失。</p> 
<h4><a id="3_ViewModel_33"></a>3 <code>ViewModel</code>的基本用法</h4> 
<h5><a id="_35"></a>第一步：添加依赖</h5> 
<p>由于<code>Jetpack</code>中的组件通常是以<code>AndroidX</code>库的形式发布的，因此一些常用的<code>Jetpack</code>组件会在创建<code>Android</code>项目时自动被包含进去。 不过如果想要使用<code>ViewModel</code>组件，还需要在<code>app/build.gradle</code>文件中添加如下依赖：</p> 
<pre><code>dependencies {
	....
	implementation "androidx.lifecycle:lifecycle-extensions:2.2.0"
}
</code></pre> 
<h5><a id="ViewModel_46"></a>第二步：创建<code>ViewModel</code></h5> 
<p>通常来讲，比较好的编程规范是给每一个<code>Activity</code>和<code>Fragment</code>都创建一个对应的<code>ViewModel</code>，因此这里为<code>TimerActivity</code>创建一个对应的<code>TimerViewModel</code>类，并让它继承自<code>ViewModel</code>，代码如下所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> TimerViewModel<span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>
</code></pre> 
<p>根据前面所学，<strong>所有与界面相关的数据都应该放在<code>ViewModel</code>中</strong>。要实现 一个计数器的功能，就可以在<code>ViewModel</code>中加入一个<code>counter</code>变量用于计数，如下所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> TimerViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> counter <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="ViewModel_63"></a>第三步：获取<code>ViewModel</code></h5> 
<p>在界面上添加一个按钮，每点击一次按钮就让计数器加<code>1</code>，并且把最新的计数显示在界面上。布局文件非常简单，一个<code>TextView</code>用于显示当前的计数，一个<code>Button</code>用于对计数器加<code>1</code>。 接着开始实现计数器的逻辑，修改<code>TimerActivity</code>中的代码，如下所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> TimerActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">lateinit</span> <span class="token keyword">var</span> viewModel<span class="token operator">:</span> TimerViewModel

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
        <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_timer<span class="token punctuation">)</span>

        viewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TimerViewModel<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
        plusOneBtn<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
            viewModel<span class="token punctuation">.</span>counter<span class="token operator">++</span>
            <span class="token function">refreshCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">refreshCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">refreshCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        infoText<span class="token punctuation">.</span>text <span class="token operator">=</span> viewModel<span class="token punctuation">.</span>counter<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>这里最需要注意的是，不可以直接去创建<code>ViewModel</code>的实例，而是一定要通过<code>ViewModelProvider</code>来获取<code>ViewModel</code>的实例，</strong> 具体语法规则如下：</p> 
<pre><code class="prism language-kotlin"><span class="token function">ViewModelProvider</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>Activity或Fragment实例<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">&lt;</span>定义的ViewModel<span class="token operator">&gt;</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>
</code></pre> 
<p><strong>之所以要这么写，是因为<code>ViewModel</code>有其独立的生命周期，并且其生命周期要长于<code>Activity</code>。 如果在<code>onCreate()</code>方法中创建<code>ViewModel</code>的实例，那么每次<code>onCreate()</code>方法执行的时候，<code>ViewModel</code>都会创建一个新的实例，这样当手机屏幕发生旋转的时候，就无法保留其中的数据了。</strong></p> 
<p>除此之外的其他代码应该都是非常好理解的，<code>refreshCounter()</code>方法用来显示当前的计数，然后每次点击按钮的时候对计数器加<code>1</code>，并调用<code>refreshCounter()</code>方法刷新计数。</p> 
<p>如果尝试通过侧边工具栏旋转一下模拟器的屏幕，就会发现<code>Activity</code>虽然被重新创建了，但是计数器的数据却没有丢失。</p> 
<p><img src="https://images2.imgbox.com/61/b8/9km8A51r_o.gif" alt="ViewModel" width="40%" height="40%"></p> 
<h4><a id="4_ViewModel_105"></a>4 向<code>ViewModel</code>传递参数</h4> 
<p><strong>由于所有<code>ViewModel</code>的实例都是通过<code>ViewModelProvider</code>来获取的，因此没有任何地方可以向<code>ViewModel</code>的构造函数中传递参数。这个问题需要借助<code>ViewModelProvider.Factory</code>就可以实现了。</strong></p> 
<p>现在的计数器虽然在屏幕旋转的时候不会丢失数据，但是如果退出程序之后再重新打开，那么之前的计数就会被清零了。接下来就对这一功能进行升级，保证即使在退出程序后又重新打开的情况下，数据仍然不会丢失。</p> 
<p>实现这个功能需要在退出程序的时候对当前的计数进行保存，然后在重新打开程序的时候读取之前保存的计数，并传递<code>TimerViewModel</code>。因此，这里修改<code>TimerViewModel</code>中的代码，如下所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">TimerViewModel</span><span class="token punctuation">(</span>countReserved<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> counter <span class="token operator">=</span> countReserved
<span class="token punctuation">}</span>
</code></pre> 
<p>现在给<code>TimerViewModel</code>的构造函数添加了一个<code>countReserved</code>参数，这个参数用于记录之前保存的计数值，并在初始化的时候赋值给<code>counter</code>变量。</p> 
<p><strong>接下来就是借助<code>ViewModelProvider.Factory</code>向<code>TimerViewModel</code>的构造函数传递数据了。</strong></p> 
<p>新建一个<code>TimerViewModelFactory</code>类，并让它实现<code>ViewModelProvider.Factory</code>接口， 代码如下所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> <span class="token function">TimerViewModelFactory</span><span class="token punctuation">(</span><span class="token keyword">private</span> <span class="token keyword">val</span> countReserved<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">:</span> ViewModelProvider<span class="token punctuation">.</span><span class="token function">Factory</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T <span class="token operator">:</span> ViewModel<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token function">create</span><span class="token punctuation">(</span>modelClass<span class="token operator">:</span> Class<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> T <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">TimerViewModel</span><span class="token punctuation">(</span>countReserved<span class="token punctuation">)</span> <span class="token keyword">as</span> T
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，<code>MainViewModelFactory</code>的构造函数中也接收了一个<code>countReserved</code>参数。另外<code>ViewModelProvider.Factory</code>接口要求必须实现<code>create()</code>方法，因此这里在<code>create()</code>方法中创建了<code>MainViewModel</code>的实例，并将<code>countReserved</code>参数传了进去。 <strong>为什么这里就可以创建<code>MainViewModel</code>的实例了呢？因为<code>create()</code>方法的执行时机和<code>Activity</code>的生命周期无关，所以不会产生之前提到的问题。</strong></p> 
<p>另外，在界面上添加一个清零按钮，方便用户手动将计数器清零。修改<code>TimerActivity</code>中的代码，如下所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> TimerActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">lateinit</span> <span class="token keyword">var</span> viewModel<span class="token operator">:</span> TimerViewModel
  <span class="token keyword">lateinit</span> <span class="token keyword">var</span> sp<span class="token operator">:</span> SharedPreferences

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
    <span class="token function">setContentView</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>layout<span class="token punctuation">.</span>activity_timer<span class="token punctuation">)</span>

    sp <span class="token operator">=</span> <span class="token function">getPreferences</span><span class="token punctuation">(</span>Context<span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span>
    <span class="token keyword">val</span> countReserved <span class="token operator">=</span> sp<span class="token punctuation">.</span><span class="token function">getInt</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"count_reserved"</span></span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    viewModel <span class="token operator">=</span> <span class="token function">ViewModelProvider</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">,</span>
      <span class="token function">MainViewModelFactory</span><span class="token punctuation">(</span>countReserved<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>TimerViewModel<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">.</span>java<span class="token punctuation">)</span>


    clearBtn<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span>
      viewModel<span class="token punctuation">.</span>counter <span class="token operator">=</span> <span class="token number">0</span>
      <span class="token function">refreshCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    <span class="token operator">..</span><span class="token punctuation">.</span>
    
		<span class="token function">refreshCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onPause</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    sp<span class="token punctuation">.</span><span class="token function">edit</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">putInt</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"count_reserved"</span></span><span class="token punctuation">,</span> viewModel<span class="token punctuation">.</span>counter<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>onCreate()</code>方法中，首先获取了<code>SharedPreferences</code>的实例，然后读取之前保存的计数值，如果没有读到的话，就使用<code>0</code>作为默认值。接下来在<code>ViewModelProvider</code>中，额外传入了一个<code>TimerViewModelFactory</code>参数，这里将读取到的计数值传给了 <code>TimerViewModelFactory</code>的构造函数。注意，只有用这种写法才能将计数值最终传递给<code>TimerViewModel</code>的构造函数。</p> 
<p>剩下的代码就比较简单了，在<code>Clear</code>按钮的点击事件中对计数器进行清零，并且在<code>onPause()</code>方法中对当前的计数进行保存，这样可以保证不管程序是退出还是进入后台，计数都不会丢失。</p> 
<p>现在重新运行程序，点击数次<code>Plus One</code>按钮，然后退出程序并重新打开，会发现，计数器的值是不会丢失的。</p> 
<p><img src="https://images2.imgbox.com/f2/e2/pkyQUZr3_o.gif" alt="ViewModel" width="40%" height="40%"></p> 
<h4><a id="5__185"></a>5 源码分析</h4> 
<h5><a id="51_ViewModel_187"></a>5.1 <code>ViewModel</code></h5> 
<p>以下是<code>ViewModel</code>的相关源码，<code>ViewModel</code>是一个抽象类，其中有一个<code>onCleared()</code>方法，当与之相关的<code>Lifecycle</code>被销毁的时候，该方法会被系统调用，我们可以在这个方法中做一些释放资源的相关操作：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> mBagOfTags <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> mCleared <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">onCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@MainThread</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mCleared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mBagOfTags <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mBagOfTags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Iterator</span> var2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mBagOfTags<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">Object</span> value <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">closeWithRuntimeException</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>当系统配置或者切换横竖屏时，虽然<code>Activity</code>调用了<code>onDestroy()</code>方法，但是<code>ViewModel.onCleared()</code>方法并不会被调用，这是因为：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComponentActivity</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ComponentActivity</span> <span class="token keyword">implements</span>
  <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">ComponentActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LifecycleEventObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStateChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">LifecycleOwner</span> source<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Event</span><span class="token punctuation">.</span>ON_DESTROY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mContextAwareHelper<span class="token punctuation">.</span><span class="token function">clearAvailableContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isChangingConfigurations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 注释1</span>
              <span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 	 <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewModelStore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> mMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Iterator</span> var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">ViewModel</span> vm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          vm<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在注释<code>1</code>处有关于系统参数的一些判断，因此在满足<code>event == Event.ON_DESTROY</code>且参数没有改动的前提下才可以调用<code>ViewModelStore.clear() -&gt; ViewModel.clear() -&gt; ViewModel.onCleared()</code>方法。</p> 
<p>以下是<code>ComponentActivity.this.getViewModelStore()</code>的相关方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComponentActivity</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ComponentActivity</span> <span class="token keyword">implements</span>
  <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span> <span class="token punctuation">{<!-- --></span>
  
      <span class="token annotation punctuation">@NonNull</span>
      <span class="token keyword">public</span> <span class="token class-name">ViewModelStore</span> <span class="token function">getViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getApplication</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">"Your activity is not yet attached to the Application instance. You can't request ViewModel before onCreate call."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">ensureViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">void</span> <span class="token function">ensureViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ComponentActivity<span class="token punctuation">.</span>NonConfigurationInstances</span> nc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ComponentActivity<span class="token punctuation">.</span>NonConfigurationInstances</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLastNonConfigurationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 注释1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>nc <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore <span class="token operator">=</span> nc<span class="token punctuation">.</span>viewModelStore<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>

      <span class="token punctuation">}</span>
  	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>对于注释<code>1</code>处的<code>ComponentActivity.NonConfigurationInstances</code>和<code>Activity.getLastNonConfigurationInstance()</code>：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComponentActivity</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ComponentActivity</span> <span class="token keyword">implements</span>
  <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonConfigurationInstances</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> custom<span class="token punctuation">;</span>
        <span class="token class-name">ViewModelStore</span> viewModelStore<span class="token punctuation">;</span>

        <span class="token class-name">NonConfigurationInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Activity</span> <span class="token keyword">extends</span> <span class="token class-name">ContextThemeWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">LayoutInflater<span class="token punctuation">.</span>Factory2</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">NonConfigurationInstances</span> mLastNonConfigurationInstances<span class="token punctuation">;</span>
  
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">attach</span><span class="token punctuation">(</span><span class="token class-name">Context</span> context<span class="token punctuation">,</span> <span class="token class-name">ActivityThread</span> aThread<span class="token punctuation">,</span>
              <span class="token class-name">Instrumentation</span> instr<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> token<span class="token punctuation">,</span> <span class="token keyword">int</span> ident<span class="token punctuation">,</span>
              <span class="token class-name">Application</span> application<span class="token punctuation">,</span> <span class="token class-name">Intent</span> intent<span class="token punctuation">,</span> <span class="token class-name">ActivityInfo</span> info<span class="token punctuation">,</span>
              <span class="token class-name">CharSequence</span> title<span class="token punctuation">,</span> <span class="token class-name">Activity</span> parent<span class="token punctuation">,</span> <span class="token class-name">String</span> id<span class="token punctuation">,</span>
              <span class="token class-name">NonConfigurationInstances</span> lastNonConfigurationInstances<span class="token punctuation">,</span>
              <span class="token class-name">Configuration</span> config<span class="token punctuation">,</span> <span class="token class-name">String</span> referrer<span class="token punctuation">,</span> <span class="token class-name">IVoiceInteractor</span> voiceInteractor<span class="token punctuation">,</span>
              <span class="token class-name">Window</span> window<span class="token punctuation">,</span> <span class="token class-name">ActivityConfigCallback</span> activityConfigCallback<span class="token punctuation">,</span> <span class="token class-name">IBinder</span> assistToken<span class="token punctuation">,</span>
              <span class="token class-name">IBinder</span> shareableActivityToken<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				mLastNonConfigurationInstances <span class="token operator">=</span> lastNonConfigurationInstances<span class="token punctuation">;</span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">getLastNonConfigurationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token keyword">return</span> mLastNonConfigurationInstances <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mLastNonConfigurationInstances<span class="token punctuation">.</span>activity <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">NonConfigurationInstances</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> activity<span class="token punctuation">;</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> children<span class="token punctuation">;</span>
        <span class="token class-name">FragmentManagerNonConfig</span> fragments<span class="token punctuation">;</span>
        <span class="token class-name">ArrayMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LoaderManager</span><span class="token punctuation">&gt;</span></span> loaders<span class="token punctuation">;</span>
        <span class="token class-name">VoiceInteractor</span> voiceInteractor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>Activity</code>内部维护着一个<code>NonConfigurationInstances</code>类型的变量<code>mLastNonConfigurationInstances</code>，在<code>Activity.attach</code>方法中被赋值，其中的<code>lastNonConfigurationInstances</code>则是从前一个被销毁的<code>Activity</code>中传递过来的。而<code>getLastNonConfigurationInstance</code>的作用就是为了从先前的<code>Activity</code>实例获取维护的动态的状态。</p> 
<p>从上面的逻辑上可知，<code>androidx.activity.ComponentActivity.mViewModelStore</code>本质上对应着<code>android.app.Activity.mLastNonConfigurationInstances.activity.viewModelStore</code>。</p> 
<p><strong><code>ViewModel</code>实现的关键是<code>ViewModelStore</code>，其内部维护着一个<code>HashMap&lt;String, ViewModel&gt;</code>用来存储多个<code>ViewModel</code>，即本质上就是一个用来维护<code>ViewModel</code>的<code>map</code>容器：</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewModelStore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> mMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">ViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">ViewModel</span> viewModel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ViewModel</span> oldViewModel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> viewModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>oldViewModel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          oldViewModel<span class="token punctuation">.</span><span class="token function">onCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">final</span> <span class="token class-name">ViewModel</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Iterator</span> var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">ViewModel</span> vm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          vm<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>和<code>ViewModelStore</code>关系紧密的类是<code>ViewModelStoreOwner</code>接口：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ViewModelStoreOwner</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@NonNull</span>
    <span class="token class-name">ViewModelStore</span> <span class="token function">getViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><code>androidx.core.app.ComponentActivity</code>和<code>Fragment</code>都实现了<code>ViewModelStoreOwner</code>接口：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComponentActivity</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ComponentActivity</span> <span class="token keyword">implements</span>
  <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Fragment</span> <span class="token keyword">implements</span> <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">}</span>  
</code></pre> 
<p>当系统配置发生变更（如切换语言）或者横竖屏切换等导致<code>Activity</code>销毁重建时，此时会调用以下逻辑：</p> 
<p><img src="https://images2.imgbox.com/70/7a/90RUN7Oi_o.png" alt="Activity销毁重建" width="100%" height="100%"></p> 
<p>上述流程是在应用进程中进行的，主要分为两部分：旧的<code>Activity</code>销毁和新的<code>Activity</code>重建，主要逻辑集中在<code>Activity.handleRelaunchActivityInner</code>中：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ActivityThread</span> <span class="token keyword">extends</span> <span class="token class-name">ClientTransactionHandler</span> <span class="token keyword">implements</span> <span class="token class-name">ActivityThreadInternal</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleRelaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> tmp<span class="token punctuation">,</span>
                    <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">handleRelaunchActivityInner</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> configChanges<span class="token punctuation">,</span> tmp<span class="token punctuation">.</span>pendingResults<span class="token punctuation">,</span> tmp<span class="token punctuation">.</span>pendingIntents<span class="token punctuation">,</span>
             pendingActions<span class="token punctuation">,</span> tmp<span class="token punctuation">.</span>startsNotResumed<span class="token punctuation">,</span> tmp<span class="token punctuation">.</span>overrideConfig<span class="token punctuation">,</span> <span class="token string">"handleRelaunchActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleRelaunchActivityInner</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span>
              <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ResultInfo</span><span class="token punctuation">&gt;</span></span> pendingResults<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReferrerIntent</span><span class="token punctuation">&gt;</span></span> pendingIntents<span class="token punctuation">,</span>
              <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token keyword">boolean</span> startsNotResumed<span class="token punctuation">,</span>
               <span class="token class-name">Configuration</span> overrideConfig<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> configChanges<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// destory上一个activity，然后，launch目标activity</span>
     		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> pendingActions<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleDestroyActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span> <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span>
                           <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token function">performDestroyActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> finishing<span class="token punctuation">,</span> configChanges<span class="token punctuation">,</span> getNonConfigInstance<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">performDestroyActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token keyword">boolean</span> finishing<span class="token punctuation">,</span>
                   <span class="token keyword">int</span> configChanges<span class="token punctuation">,</span> <span class="token keyword">boolean</span> getNonConfigInstance<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        r<span class="token punctuation">.</span>lastNonConfigurationInstances <span class="token operator">=</span> r<span class="token punctuation">.</span>activity<span class="token punctuation">.</span><span class="token function">retainNonConfigurationInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>


  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token class-name">Activity</span> <span class="token function">handleLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span>
           <span class="token class-name">PendingTransactionActions</span> pendingActions<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token keyword">final</span> <span class="token class-name">Activity</span> a <span class="token operator">=</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> customIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">private</span> <span class="token class-name">Activity</span> <span class="token function">performLaunchActivity</span><span class="token punctuation">(</span><span class="token class-name">ActivityClientRecord</span> r<span class="token punctuation">,</span> <span class="token class-name">Intent</span> customIntent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token class-name">Activity</span> activity <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>ClassLoader</span> cl <span class="token operator">=</span> appContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        activity <span class="token operator">=</span> mInstrumentation<span class="token punctuation">.</span><span class="token function">newActivity</span><span class="token punctuation">(</span> cl<span class="token punctuation">,</span> component<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">}</span>

    	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>activity <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            activity<span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>appContext<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">getInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r<span class="token punctuation">.</span>token<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>ident<span class="token punctuation">,</span> app<span class="token punctuation">,</span> r<span class="token punctuation">.</span>intent<span class="token punctuation">,</span> r<span class="token punctuation">.</span>activityInfo<span class="token punctuation">,</span> title<span class="token punctuation">,</span> r<span class="token punctuation">.</span>parent<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>embeddedID<span class="token punctuation">,</span> r<span class="token punctuation">.</span>lastNonConfigurationInstances<span class="token punctuation">,</span> config<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>referrer<span class="token punctuation">,</span> r<span class="token punctuation">.</span>voiceInteractor<span class="token punctuation">,</span> window<span class="token punctuation">,</span> r<span class="token punctuation">.</span>configCallback<span class="token punctuation">,</span>
                            r<span class="token punctuation">.</span>assistToken<span class="token punctuation">,</span> r<span class="token punctuation">.</span>shareableActivityToken<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>customIntent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              activity<span class="token punctuation">.</span>mIntent <span class="token operator">=</span> customIntent<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            r<span class="token punctuation">.</span>lastNonConfigurationInstances <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SuperNotCalledException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> e<span class="token punctuation">;</span>

          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          <span class="token punctuation">}</span>

        <span class="token keyword">return</span> activity<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><code>performDestroyActivity</code>并不是单纯的处理<code>Activity.onDestory</code>的，而是为了<code>destory activity</code>处理一系列的逻辑。注释<code>1</code>处<code>r.activity</code>即需要被销毁的<code>Activity</code>实例，该处的逻辑是得到<code>android.app.Activity.NonConfigurationInstances</code>实例对象，而该对象会间接持有之前被销毁的<code>Activity</code>维护的一直被传递着的<code>ViewModelStore</code>实例，并将其赋值给<code>r.lastNonConfigurationInstances</code>。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Activity</span> <span class="token keyword">extends</span> <span class="token class-name">ContextThemeWrapper</span> <span class="token keyword">implements</span> <span class="token class-name">LayoutInflater<span class="token punctuation">.</span>Factory2</span> <span class="token punctuation">{<!-- --></span>

    <span class="token class-name">NonConfigurationInstances</span> <span class="token function">retainNonConfigurationInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> activity <span class="token operator">=</span> <span class="token function">onRetainNonConfigurationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">NonConfigurationInstances</span> nci <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NonConfigurationInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        nci<span class="token punctuation">.</span>activity <span class="token operator">=</span> activity<span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> nci<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComponentActivity</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ComponentActivity</span> <span class="token keyword">implements</span> <span class="token class-name">ContextAware</span><span class="token punctuation">,</span> <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span><span class="token punctuation">,</span> <span class="token class-name">HasDefaultViewModelProviderFactory</span><span class="token punctuation">,</span> <span class="token class-name">SavedStateRegistryOwner</span><span class="token punctuation">,</span> <span class="token class-name">OnBackPressedDispatcherOwner</span><span class="token punctuation">,</span> <span class="token class-name">ActivityResultRegistryOwner</span><span class="token punctuation">,</span> <span class="token class-name">ActivityResultCaller</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token annotation punctuation">@Nullable</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Object</span> <span class="token function">onRetainNonConfigurationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Object</span> custom <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onRetainCustomNonConfigurationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ViewModelStore</span> viewModelStore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore<span class="token punctuation">;</span>
        <span class="token class-name">ComponentActivity<span class="token punctuation">.</span>NonConfigurationInstances</span> nci<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewModelStore <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          nci <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ComponentActivity<span class="token punctuation">.</span>NonConfigurationInstances</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLastNonConfigurationInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>nci <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            viewModelStore <span class="token operator">=</span> nci<span class="token punctuation">.</span>viewModelStore<span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewModelStore <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> custom <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          nci <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ComponentActivity<span class="token punctuation">.</span>NonConfigurationInstances</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          nci<span class="token punctuation">.</span>custom <span class="token operator">=</span> custom<span class="token punctuation">;</span>
          nci<span class="token punctuation">.</span>viewModelStore <span class="token operator">=</span> viewModelStore<span class="token punctuation">;</span>
          <span class="token keyword">return</span> nci<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在<code>ComponentActivity.onRetainNonConfigurationInstance</code>方法中，主要是为了得到当前需要被销毁的<code>Activity</code>维护的<code>mViewModelStore</code>，如果为<code>null</code>，则进一步通过父类方法<code>android.app.Activity.getLastNonConfigurationInstance</code>去获取<code>android.app.Activity.mLastNonConfigurationInstances.activity</code>。</p> 
<p>而<code>android.app.Activity.mLastNonConfigurationInstances.activity</code>是从上一次被销毁的<code>Activity</code>传递过来的，而<code>mLastNonConfigurationInstances</code>即对应着上一次被销毁的<code>Activity</code>维护的<code>mViewModelStore</code>。</p> 
<p>因此<code>androidx.activity.ComponentActivity.onRetainNonConfigurationInstance</code>关于<code>ViewModel</code>实现的意义，简单的说就是拿到之前被销毁的<code>Activity</code>维护的且一直在传递的<code>ViewModelStore</code>实例，使其接着继续传递到下一个被重建的<code>Activity</code>中。</p> 
<p><code>ActivityThrad.handleDestroyActivity</code>的作用就是为了处理要被销毁掉的<code>Activity</code>，以及在销毁之前，获取到之前被销毁的<code>Activity</code>维护的一直传递着的<code>ViewModelStore</code>实例。</p> 
<p>对于<code>handleLaunchActivity</code>会进一步调用<code>performLaunchActivity</code>，关键参数是<code>r</code>，其是最开始是从<code>handleRelaunchActivityInner</code>中传递过来的，且在<code>handleLaunchActivity</code>之前，<code>r</code>被传入<code>performDestroyActivity</code>中，实现了<code>r.lastNonConfigurationInstances</code>持有要被传递到重建<code>Activity</code>中的<code>ViewModel</code>实例。</p> 
<p>接着是<code>performLaunchActivity</code>，内部处理关于重建<code>Activity</code>的逻辑，如创建新的<code>Activity</code>实例等，其中，关键的是，会调用新的<code>Activity</code>实例的<code>attach</code>方法，并传入<code>r.lastNonConfigurationInstances</code>，从而实现将之前的<code>ViewModelStore</code>实例传入到新的<code>Activity</code>中，与之前的<code>Activity.attach</code>相呼应。</p> 
<p><code>ActivityThread.handleLaunchActivity</code>的作用则是处理新的<code>Activity</code>的重建流程，并把之前维护的<code>ViewModelStore</code>实例传递到新的<code>Activity</code>中。</p> 
<h5><a id="52_ViewModelonCleared_548"></a>5.2 <code>ViewModel.onCleared()</code>的调用时机</h5> 
<h6><a id="521_ComponentActivity_550"></a>5.2.1 <code>ComponentActivity</code>正常销毁的时候</h6> 
<p><code>androidx.activity.ComponentActivity</code>正常<code>destroy</code>的时候（不是因为系统配置发生变化或者横竖屏切换）：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ComponentActivity</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">androidx<span class="token punctuation">.</span>core<span class="token punctuation">.</span>app<span class="token punctuation">.</span></span>ComponentActivity</span> <span class="token keyword">implements</span> <span class="token class-name">ContextAware</span><span class="token punctuation">,</span> <span class="token class-name">LifecycleOwner</span><span class="token punctuation">,</span> <span class="token class-name">ViewModelStoreOwner</span><span class="token punctuation">,</span> <span class="token class-name">HasDefaultViewModelProviderFactory</span><span class="token punctuation">,</span> <span class="token class-name">SavedStateRegistryOwner</span><span class="token punctuation">,</span> <span class="token class-name">OnBackPressedDispatcherOwner</span><span class="token punctuation">,</span> <span class="token class-name">ActivityResultRegistryOwner</span><span class="token punctuation">,</span> <span class="token class-name">ActivityResultCaller</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token class-name">ComponentActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token class-name">Lifecycle</span> lifecycle <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLifecycle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addObserver</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LifecycleEventObserver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onStateChanged</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">LifecycleOwner</span> source<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token class-name">Event</span><span class="token punctuation">.</span>ON_DESTROY<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>mContextAwareHelper<span class="token punctuation">.</span><span class="token function">clearAvailableContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isChangingConfigurations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 不是因为系统配置发生变化</span>
                <span class="token class-name">ComponentActivity</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewModelStore</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Iterator</span> var1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>var1<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">ViewModel</span> vm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span>var1<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          vm<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ViewModel</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@MainThread</span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mCleared <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mBagOfTags <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">synchronized</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mBagOfTags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Iterator</span> var2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mBagOfTags<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">while</span><span class="token punctuation">(</span>var2<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">Object</span> value <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token function">closeWithRuntimeException</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="522_ViewModel_609"></a>5.2.2 添加<code>ViewModel</code>被覆盖时</h6> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewModelProvider</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@NonNull</span>
    <span class="token annotation punctuation">@MainThread</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> modelClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> canonicalName <span class="token operator">=</span> modelClass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>canonicalName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Local and anonymous classes can not be ViewModels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"androidx.lifecycle.ViewModelProvider.DefaultKey:"</span> <span class="token operator">+</span> canonicalName<span class="token punctuation">,</span> modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@NonNull</span>
    <span class="token annotation punctuation">@MainThread</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> modelClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ViewModel</span> viewModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>modelClass<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 1</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory <span class="token keyword">instanceof</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>OnRequeryFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>OnRequeryFactory</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRequery</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">return</span> viewModel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>viewModel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">}</span>

          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory <span class="token keyword">instanceof</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>KeyedFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            viewModel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>KeyedFactory</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            viewModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> viewModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> viewModel<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>其中，方法参数<code>key</code>，其取值会有两种，第一种是用户自定义的，即直接调用<code>ViewModelProvider.get(key, modelClass)</code>，此时<code>key</code>完全由用户自己控制。还有一种是调用<code>ViewModelProvider.get(modelClass)</code>，此时<code>key</code>是默认的，是与<code>modelClass</code>的<code>class name</code>相关的关键字。</p> 
<p>从注释<code>1</code>中可以看出，首先判断与<code>key</code>值对应的<code>ViewModel</code>是否存在，如果不存在的话，就要创建一个新的<code>ViewModel</code>保存起来，在<code>this.mViewModelStore.put(key, viewModel);</code>方法中，会调用<code>ViewModel.onCleared()</code>方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewModelStore</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">ViewModel</span> viewModel<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">ViewModel</span> oldViewModel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ViewModel</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> viewModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>oldViewModel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        oldViewModel<span class="token punctuation">.</span><span class="token function">onCleared</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="53_ViewModelProviderget_667"></a>5.3 <code>ViewModelProvider.get</code>方法</h5> 
<p>以下是<code>ViewModelProvider.get</code>方法的相关源码：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ViewModelProvider</span> <span class="token punctuation">{<!-- --></span>
  
    <span class="token keyword">public</span> <span class="token class-name">ViewModelProvider</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewModelStoreOwner</span> owner<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ViewModelStore</span><span class="token punctuation">)</span>owner<span class="token punctuation">.</span><span class="token function">getViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>Factory</span><span class="token punctuation">)</span><span class="token punctuation">(</span>owner <span class="token keyword">instanceof</span> <span class="token class-name">HasDefaultViewModelProviderFactory</span> <span class="token operator">?</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HasDefaultViewModelProviderFactory</span><span class="token punctuation">)</span>owner<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDefaultViewModelProviderFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>NewInstanceFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ViewModelProvider</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewModelStoreOwner</span> owner<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token keyword">this</span><span class="token punctuation">(</span>owner<span class="token punctuation">.</span><span class="token function">getViewModelStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token class-name">ViewModelProvider</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewModelStore</span> store<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>Factory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mFactory <span class="token operator">=</span> factory<span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore <span class="token operator">=</span> store<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token annotation punctuation">@MainThread</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> modelClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">String</span> canonicalName <span class="token operator">=</span> modelClass<span class="token punctuation">.</span><span class="token function">getCanonicalName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>canonicalName <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"Local and anonymous classes can not be ViewModels"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"androidx.lifecycle.ViewModelProvider.DefaultKey:"</span> <span class="token operator">+</span> canonicalName<span class="token punctuation">,</span> modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@NonNull</span>
  <span class="token annotation punctuation">@MainThread</span>
  <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> modelClass<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">ViewModel</span> viewModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>modelClass<span class="token punctuation">.</span><span class="token function">isInstance</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory <span class="token keyword">instanceof</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>OnRequeryFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>OnRequeryFactory</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">onRequery</span><span class="token punctuation">(</span>viewModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> viewModel<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>viewModel <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory <span class="token keyword">instanceof</span> <span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>KeyedFactory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          viewModel <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ViewModelProvider<span class="token punctuation">.</span>KeyedFactory</span><span class="token punctuation">)</span><span class="token keyword">this</span><span class="token punctuation">.</span>mFactory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          viewModel <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>modelClass<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>mViewModelStore<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> viewModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> viewModel<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  <span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Factory</span> <span class="token punctuation">{<!-- --></span>
      <span class="token annotation punctuation">@NonNull</span>
      <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span> <span class="token keyword">extends</span> <span class="token class-name">ViewModel</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">T</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>注释<code>1</code>处判断<code>ViewModel</code>是否存在，如果存在的话，直接读取，如果不存在则创建，并添加到<code>ViewModelStore</code>中。</p> 
<h4><a id="6_Fragment_733"></a>6 在<code>Fragment</code>之间共享逻辑</h4> 
<p><strong>有这样一个场景：如果某个<code>Activity</code>中有多个<code>Fragment</code>，使用宿主<code>Activity</code>作为<code>ViewModelOwner</code>创建<code>ViewModel</code>， 那么这些<code>Fragment</code>使用的是同一个<code>ViewModel</code>。</strong></p> 
<p><strong><code>ViewModel</code>的另一特点就是同一个<code>Activity</code>和<code>Fragment</code>之间可以使用<code>ViewModel</code>实现共享数据。</strong></p> 
<p><code>Activity</code>中的两个或更多<code>Fragment</code>需要相互通信是一种很常见的现象。假设有一个<code>Fragment</code>，想象一下拆分视图 (<code>list-detail</code>) <code>Fragment</code>的常见情况，在该<code>Fragment</code>中，用户从列表中选择一项，还有另一个<code>Fragment</code>，用于显示选定项的内容。这种情况不太容易处理，因为这两个<code>Fragment</code>都需要定义某种接口描述，并且所有者<code>Activity</code>必须将两者绑定在一起。此外，这两个<code>Fragment</code>都必须处理另一个<code>Fragment</code>尚未创建或不可见的情况。</p> 
<p>可以使用<code>ViewModel</code>对象解决这一常见的难点。这两个<code>fragment</code>可以使用其<code>activity</code>范围共享<code>ViewModel</code>来处理此类通信，如以下示例代码所示：</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">class</span> SharedViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">val</span> selected <span class="token operator">=</span> MutableLiveData<span class="token operator">&lt;</span>Item<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">fun</span> <span class="token function">select</span><span class="token punctuation">(</span>item<span class="token operator">:</span> Item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        selected<span class="token punctuation">.</span>value <span class="token operator">=</span> item
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> ListFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">lateinit</span> <span class="token keyword">var</span> itemSelector<span class="token operator">:</span> Selector

    <span class="token comment">// Use the 'by activityViewModels()' Kotlin property delegate</span>
    <span class="token comment">// from the fragment-ktx artifact</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> model<span class="token operator">:</span> SharedViewModel <span class="token keyword">by</span> <span class="token function">activityViewModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
        itemSelector<span class="token punctuation">.</span><span class="token function">setOnClickListener</span> <span class="token punctuation">{<!-- --></span> item <span class="token operator">-&gt;</span>
            <span class="token comment">// Update the UI</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> DetailFragment <span class="token operator">:</span> <span class="token function">Fragment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// Use the 'by activityViewModels()' Kotlin property delegate</span>
    <span class="token comment">// from the fragment-ktx artifact</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> model<span class="token operator">:</span> SharedViewModel <span class="token keyword">by</span> <span class="token function">activityViewModels</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token operator">:</span> View<span class="token punctuation">,</span> savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onViewCreated</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> savedInstanceState<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>selected<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>viewLifecycleOwner<span class="token punctuation">,</span> Observer<span class="token operator">&lt;</span>Item<span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span> item <span class="token operator">-&gt;</span>
            <span class="token comment">// Update the UI</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>请注意，这两个<code>Fragment</code>都会检索包含它们的<code>Activity</code>。这样，当这两个<code>Fragment</code>各自获取<code>ViewModelProvider</code>时，它们会收到相同的 <code>SharedViewModel</code> 实例（其范围限定为该<code>Activity</code>）。</p> 
<p>此方法具有以下优势：</p> 
<ul><li><code>Activity</code>不需要执行任何操作，也不需要对此通信有任何了解；</li><li>除了 <code>SharedViewModel</code> 约定之外，<code>Fragment</code>不需要相互了解。如果其中一个<code>Fragment</code>消失，另一个<code>Fragment</code>将继续照常工作；</li><li>每个<code>Fragment</code>都有自己的生命周期，而不受另一个<code>Fragment</code>的生命周期的影响。如果一个<code>Fragment</code>替换另一个<code>Fragment</code>，界面将继续工作而没有任何问题；</li></ul> 
<h4><a id="_793"></a>参考</h4> 
<p>https://developer.android.google.cn/topic/libraries/architecture/viewmodel<br> <a href="https://blog.csdn.net/OneDeveloper/article/details/115049221">ViewModel 简析</a><br> <a href="https://blog.csdn.net/OneDeveloper/article/details/115049760?spm=1001.2014.3001.5501">ViewModel 在 Activity 中的实现原理</a><br> <a href="https://blog.csdn.net/weixin_44235109/article/details/120104557?spm=1001.2101.3001.6650.5&amp;utm_medium=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7ERate-5-120104557-blog-115049760.pc_relevant_multi_platform_whitelistv3&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-2%7Edefault%7EOPENSEARCH%7ERate-5-120104557-blog-115049760.pc_relevant_multi_platform_whitelistv3&amp;utm_relevant_index=10">Jetpack：ViewModel使用指南，实现原理详细解析！</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/39f2f2fd623d2f9fdb18948e56c0f365/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OPENGL环境配置-vs2022（win系统）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/65f055e442cff52414e2d53f6912f07a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">TCP-4次挥手小记</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>