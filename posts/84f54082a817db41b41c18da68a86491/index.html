<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>RabbitMQ的安装与基本使用（windows&#43;php版本） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="RabbitMQ的安装与基本使用（windows&#43;php版本）" />
<meta property="og:description" content="RabbitMQ的安装与基本使用 一、安装erlang RabbitMQ服务端代码是基于并发式语言Erlang编写的，安装Rabbit MQ的前提是安装Erlang。
1.1 下载 Erlang官网：http://www.erlang.org/downloads
1.2 配置环境变量 变量名：ES_HOME
变量值：erlang 的安装路径
1.3 配置 erlang 可执行命令 path 1.4 查看 erlang 是否安装成功 二、安装 RabbitMQ RabbitMQ 官网下载地址：http://www.rabbitmq.com/download.html
双击下载后的.exe文件，傻瓜式&#34;下一步&#34;即可。
RabbitMQ 安装好后接下来安装 RabbitMQ-Plugins：
打开命令行cd，输入RabbitMQ的sbin目录输入 rabbitmq-plugins enable rabbitmq_management 命令进行安装打开sbin目录，双击 rabbitmq-server.bat 访问可视化界面：http://localhost:15672
用户名和密码默认都是：guest
三、安装 php 的 amqp 扩展 3.1 查看 php 的 thread safty 状态 3.2 根据php版本及thread satety状态，下载稳定版的dll amqp 的扩展下载地址：http://pecl.php.net/package/amqp
注意：php版本，X86 和X64 根据自己情况 而定 ，NTS 和 TS 就是那个thread safty 的状态
3.3 将 php_amqp.dll 文件放到 php 目录的 ext 文件夹下 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/84f54082a817db41b41c18da68a86491/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-08T16:55:12+08:00" />
<meta property="article:modified_time" content="2023-02-08T16:55:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">RabbitMQ的安装与基本使用（windows&#43;php版本）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="RabbitMQ_0"></a>RabbitMQ的安装与基本使用</h3> 
<h4><a id="erlang_2"></a>一、安装erlang</h4> 
<blockquote> 
 <p>RabbitMQ服务端代码是基于并发式语言Erlang编写的，安装Rabbit MQ的前提是安装Erlang。</p> 
</blockquote> 
<h4><a id="11__5"></a>1.1 下载</h4> 
<p>Erlang官网：<a href="http://www.erlang.org/downloads" rel="nofollow">http://www.erlang.org/downloads</a></p> 
<h4><a id="12__8"></a>1.2 配置环境变量</h4> 
<p><img src="https://images2.imgbox.com/f6/cb/zSj4HeEW_o.png" alt="在这里插入图片描述"><br> 变量名：ES_HOME<br> 变量值：erlang 的安装路径</p> 
<h4><a id="13__erlang__path_13"></a>1.3 配置 erlang 可执行命令 path</h4> 
<p><img src="https://images2.imgbox.com/b0/6b/LBOg6Lt2_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="14__erlang__15"></a>1.4 查看 erlang 是否安装成功</h4> 
<p><img src="https://images2.imgbox.com/76/2a/qWmsjj7q_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_RabbitMQ_19"></a>二、安装 RabbitMQ</h4> 
<p>RabbitMQ 官网下载地址：<a href="http://www.rabbitmq.com/download.html" rel="nofollow">http://www.rabbitmq.com/download.html</a><br> <img src="https://images2.imgbox.com/06/7d/5PfP1v7Q_o.png" alt="在这里插入图片描述"><br> 双击下载后的.exe文件，傻瓜式"下一步"即可。</p> 
<p>RabbitMQ 安装好后接下来安装 RabbitMQ-Plugins：</p> 
<ul><li>打开命令行cd，输入RabbitMQ的sbin目录</li><li>输入 rabbitmq-plugins enable rabbitmq_management 命令进行安装</li><li>打开sbin目录，双击 rabbitmq-server.bat</li></ul> 
<p>访问可视化界面：http://localhost:15672<br> 用户名和密码默认都是：guest</p> 
<h4><a id="_php__amqp__32"></a>三、安装 php 的 amqp 扩展</h4> 
<h5><a id="31__php__thread_safty__33"></a>3.1 查看 php 的 thread safty 状态</h5> 
<p><img src="https://images2.imgbox.com/4d/3a/Io7fxnLS_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="32_phpthread_satetydll_36"></a>3.2 根据php版本及thread satety状态，下载稳定版的dll</h5> 
<p>amqp 的扩展下载地址：<a href="http://pecl.php.net/package/amqp" rel="nofollow">http://pecl.php.net/package/amqp</a><br> <img src="https://images2.imgbox.com/31/c1/RZvHj427_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/87/88/6stu6GDv_o.png" alt="在这里插入图片描述"></p> 
<p>注意：php版本，X86 和X64 根据自己情况 而定 ，NTS 和 TS 就是那个thread safty 的状态</p> 
<h5><a id="33__php_amqpdll__php__ext__44"></a>3.3 将 php_amqp.dll 文件放到 php 目录的 ext 文件夹下</h5> 
<p><img src="https://images2.imgbox.com/4e/91/WRFt0bCw_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="34__rabbitmq4dll__php__46"></a>3.4 将 rabbitmq.4.dll 文件放到 php 根目录</h5> 
<p><img src="https://images2.imgbox.com/20/8d/99tre0JJ_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="35__phpini__48"></a>3.5 编辑 php.ini 文件，新增内容：</h5> 
<pre><code class="prism language-shell"><span class="token assign-left variable">extension</span><span class="token operator">=</span>php_amqp.dll
</code></pre> 
<h5><a id="36__amqp_httpsimgblogcsdnimgcn8796a09b524f4a17a766f69c93453c46png_52"></a>3.6 重启服务器，查看 amqp 扩展是否安装成功<img src="https://images2.imgbox.com/bf/42/clTpym34_o.png" alt="在这里插入图片描述"></h5> 
<h4><a id="MQ_demo_54"></a>四、MQ 基本使用（自己看代码吧，demo比较简单）</h4> 
<h5><a id="41__55"></a>4.1 目录结构</h5> 
<p><img src="https://images2.imgbox.com/bb/7e/M0YeBOwV_o.png" alt="在这里插入图片描述"></p> 
<table><thead><tr><th>文件名</th><th>描述</th></tr></thead><tbody><tr><td>config.php</td><td>配置文件</td></tr><tr><td>BaseMQ.php</td><td>MQ基类</td></tr><tr><td>ProductMQ.php</td><td>生产者类</td></tr><tr><td>ConsumerMQ.php</td><td>消费者类</td></tr><tr><td>TestUserConsumer.php</td><td>User消费者测试实例</td></tr><tr><td>TestCompanyConsumer.php</td><td>Company消费者测试实例</td></tr></tbody></table> 
<h5><a id="42__66"></a>4.2 文件说明</h5> 
<p>config.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Created by PhpStorm
 * User: Jason
 * Date: 2023-02-06
 * Time: 11:23
 */</span>

<span class="token keyword">return</span> <span class="token punctuation">[</span>
    <span class="token comment">// 配置</span>
    <span class="token string single-quoted-string">'config'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'host'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'port'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'5672'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'vhost'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'/'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'login'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'guest'</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'password'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'guest'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token comment">// 交换机</span>
    <span class="token string single-quoted-string">'exchange'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'hello'</span><span class="token punctuation">,</span>
    <span class="token comment">// 路由key</span>
    <span class="token string single-quoted-string">'route_keys'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'company'</span><span class="token punctuation">]</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre> 
<p>BaseMQ.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
* Created by PhpStorm
* User: Jason
* Date: 2023-02-08
* Time: 14:50
*/</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">BaseMQ</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">/**
    * 连接对象
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$AMQPConnection</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 管道
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$AMQPChannel</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 交换机
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$AMQPExchange</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 队列
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$AMQPQueue</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 报文对象
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$AMQPEnvelope</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 配置
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$conf</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 交换机名称
    *
    * @var
    */</span>
   <span class="token keyword">protected</span> <span class="token variable">$exchangeName</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * BaseMQ constructor.
    * @param $conf
    * @param $exchangeName
    * @throws AMQPConnectionException
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$conf</span><span class="token punctuation">,</span> <span class="token variable">$exchangeName</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">conf</span> <span class="token operator">=</span> <span class="token variable">$conf</span><span class="token punctuation">;</span>

       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">exchangeName</span> <span class="token operator">=</span> <span class="token variable">$exchangeName</span><span class="token punctuation">;</span>

       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 连接
    *
    * @throws AMQPConnectionException
    */</span>
   <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPConnection</span> <span class="token operator">=</span> <span class="token keyword">New</span> <span class="token class-name">AMQPConnection</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">conf</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPConnection</span><span class="token operator">-&gt;</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>AMQPConnectionException</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Cannot connect to the broker!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 关闭连接
    */</span>
   <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPConnection</span><span class="token operator">-&gt;</span><span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 创建管道
    *
    * @return AMQPChannel
    * @throws AMQPConnectionException
    */</span>
   <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPChannel</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPChannel</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>AMQPChannel</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPConnection</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPChannel</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 创建交换机
    *
    * @return AMQPExchange
    * @throws AMQPConnectionException
    * @throws AMQPExchangeException
    */</span>
   <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function-definition function">createExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPExchange</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPExchange</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>AMQPExchange</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPExchange</span><span class="token operator">-&gt;</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">exchangeName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPExchange</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 创建队列
    *
    * @return AMQPQueue
    * @throws AMQPConnectionException
    * @throws AMQPQueueException
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">createQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPQueue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPQueue</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>AMQPQueue</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPQueue</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 报文对象
    *
    * @return AMQPEnvelope
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">envelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPEnvelope</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPEnvelope</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>AMQPEnvelope</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">AMQPEnvelope</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ProductMQ.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
* Created by PhpStorm
* User: Jason
* Date: 2023-02-08
* Time: 15:04
*/</span>

<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'BaseMQ.php'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ProductMQ</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMQ</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">/**
    * 路由key数组
    *
    * @var
    */</span>
   <span class="token keyword">private</span> <span class="token variable">$routeKeys</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * ProductMQ constructor.
    * @param $conf
    * @param $exchangeName
    * @param $routeKeys
    * @throws AMQPConnectionException
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$conf</span><span class="token punctuation">,</span> <span class="token variable">$exchangeName</span><span class="token punctuation">,</span> <span class="token variable">$routeKeys</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">routeKeys</span> <span class="token operator">=</span> <span class="token variable">$routeKeys</span><span class="token punctuation">;</span>

       <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$conf</span><span class="token punctuation">,</span> <span class="token variable">$exchangeName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 发布
    *
    * @param string $message
    * @throws AMQPChannelException
    * @throws AMQPConnectionException
    * @throws AMQPExchangeException
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token keyword type-hint">string</span> <span class="token variable">$message</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 创建管道</span>
       <span class="token variable">$ch</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">createChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 创建交换机</span>
       <span class="token variable">$ex</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">createExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 开启事务，推送多个路由key</span>
       <span class="token variable">$ch</span><span class="token operator">-&gt;</span><span class="token function">startTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
       <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">routeKeys</span> <span class="token keyword">as</span> <span class="token variable">$routeKey</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token comment">// 发布到多个路由key上</span>
           <span class="token variable">$sendEd</span> <span class="token operator">=</span> <span class="token variable">$ex</span><span class="token operator">-&gt;</span><span class="token function">publish</span><span class="token punctuation">(</span><span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token variable">$routeKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token variable">$sendEd</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$count</span><span class="token operator">++</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$count</span> <span class="token operator">!=</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">routeKeys</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token variable">$ch</span><span class="token operator">-&gt;</span><span class="token function">rollbackTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token variable">$ch</span><span class="token operator">-&gt;</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 关闭连接</span>
       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 测试</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
   <span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">require</span> <span class="token string single-quoted-string">'config.php'</span><span class="token punctuation">;</span>

   <span class="token variable">$sender</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProductMQ</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'config'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exchange'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'route_keys'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   <span class="token variable">$sender</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'hello'</span> <span class="token operator">.</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$exception</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">echo</span> <span class="token string single-quoted-string">'failed:'</span> <span class="token operator">.</span> <span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ConsumerMQ.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
* Created by PhpStorm
* User: Jason
* Date: 2023-02-08
* Time: 15:15
*/</span>

<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'BaseMQ.php'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">ConsumerMQ</span> <span class="token keyword">extends</span> <span class="token class-name">BaseMQ</span>
<span class="token punctuation">{<!-- --></span>
   <span class="token comment">/**
    * 路由key
    *
    * @var
    */</span>
   <span class="token keyword">private</span> <span class="token variable">$routeKey</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * 队列名
    *
    * @var
    */</span>
   <span class="token keyword">private</span> <span class="token variable">$queueName</span><span class="token punctuation">;</span>

   <span class="token comment">/**
    * $queueName
    *
    * ConsumerMQ constructor.
    * @param $conf
    * @param $exchangeName
    * @param $routerKey
    * @param $queueName
    * @throws AMQPConnectionException
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token variable">$conf</span><span class="token punctuation">,</span> <span class="token variable">$exchangeName</span><span class="token punctuation">,</span> <span class="token variable">$routerKey</span><span class="token punctuation">,</span> <span class="token variable">$queueName</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">routeKey</span> <span class="token operator">=</span> <span class="token variable">$routerKey</span><span class="token punctuation">;</span>

       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">queueName</span> <span class="token operator">=</span> <span class="token variable">$queueName</span><span class="token punctuation">;</span>

       <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$conf</span><span class="token punctuation">,</span> <span class="token variable">$exchangeName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">/**
    * 消费
    *
    * @throws AMQPChannelException
    * @throws AMQPConnectionException
    * @throws AMQPEnvelopeException
    * @throws AMQPExchangeException
    * @throws AMQPQueueException
    */</span>
   <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
   <span class="token punctuation">{<!-- --></span>
       <span class="token comment">// 创建交换机</span>
       <span class="token variable">$ex</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">createExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 设置交换机类型: direct</span>
       <span class="token variable">$ex</span><span class="token operator">-&gt;</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token constant">AMQP_EX_TYPE_DIRECT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 设置交换机持久化</span>
       <span class="token variable">$ex</span><span class="token operator">-&gt;</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token constant">AMQP_DURABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 声明</span>
       <span class="token variable">$exStatus</span> <span class="token operator">=</span> <span class="token variable">$ex</span><span class="token operator">-&gt;</span><span class="token function">declareExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Exchange Status:"</span> <span class="token operator">.</span> <span class="token variable">$exStatus</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>

       <span class="token comment">// 创建队列</span>
       <span class="token variable">$queue</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">createQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 设置队列名称</span>
       <span class="token variable">$queue</span><span class="token operator">-&gt;</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">queueName</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 设置队列持久化</span>
       <span class="token variable">$queue</span><span class="token operator">-&gt;</span><span class="token function">setFlags</span><span class="token punctuation">(</span><span class="token constant">AMQP_DURABLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">// 声明</span>
       <span class="token variable">$queueMessageCount</span> <span class="token operator">=</span> <span class="token variable">$queue</span><span class="token operator">-&gt;</span><span class="token function">declareQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Queue Message Count:"</span> <span class="token operator">.</span> <span class="token variable">$queueMessageCount</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>

       <span class="token comment">// 队列绑定到交换机路由key</span>
       <span class="token variable">$queue</span><span class="token operator">-&gt;</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">exchangeName</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">routeKey</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token comment">// 阻塞模式接收消息</span>
       <span class="token keyword">echo</span> <span class="token string double-quoted-string">"Message:\n"</span><span class="token punctuation">;</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token constant boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           <span class="token variable">$queue</span><span class="token operator">-&gt;</span><span class="token function">consume</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$envelope</span><span class="token punctuation">,</span> <span class="token variable">$queue</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
               <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token variable">$envelope</span><span class="token operator">-&gt;</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

               <span class="token comment">// todo:处理消息</span>
               <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">routeKey</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' receive message:'</span> <span class="token operator">.</span> <span class="token variable">$msg</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"\n"</span><span class="token punctuation">;</span>

               <span class="token comment">// 手动发送ACK应答</span>
               <span class="token variable">$queue</span><span class="token operator">-&gt;</span><span class="token function">ack</span><span class="token punctuation">(</span><span class="token variable">$envelope</span><span class="token operator">-&gt;</span><span class="token function">getDeliveryTag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>

       <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>TestUserConsumer.php</p> 
<pre><code>&lt;?php
/**
 * Created by PhpStorm
 * User: Jason
 * Date: 2023-02-08
 * Time: 15:59
 */

require_once 'ConsumerMQ.php';

// 测试: 监听user路由消息
$config = require 'config.php';
try {
    $routeKey = 'company';
    $queueName = 'hello_company';

    (new ConsumerMQ($config, $config['exchange'], $routeKey, $queueName))-&gt;run();
} catch (\Exception $exception) {
    echo $exception-&gt;getMessage();
}
</code></pre> 
<p>TestCompanyConsumer.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Created by PhpStorm
 * User: Jason
 * Date: 2023-02-08
 * Time: 15:59
 */</span>

<span class="token keyword">require_once</span> <span class="token string single-quoted-string">'ConsumerMQ.php'</span><span class="token punctuation">;</span>

<span class="token comment">// 测试: 监听user路由消息</span>
<span class="token variable">$config</span> <span class="token operator">=</span> <span class="token keyword">require</span> <span class="token string single-quoted-string">'config.php'</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$routeKey</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'user'</span><span class="token punctuation">;</span>
    <span class="token variable">$queueName</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'hello_user'</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ConsumerMQ</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">,</span> <span class="token variable">$config</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'exchange'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$routeKey</span><span class="token punctuation">,</span> <span class="token variable">$queueName</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Exception</span> <span class="token variable">$exception</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">echo</span> <span class="token variable">$exception</span><span class="token operator">-&gt;</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="43__477"></a>4.3 测试展示</h5> 
<p><img src="https://images2.imgbox.com/ce/25/CSJTPZR3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/37/30/4oko0JGd_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/da/12/YHqktBG8_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0a91ffac1f5f088009682719711f700e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">国家专精特新小巨人的认定标准及流程。</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8525ce2661736973b6f7c9ba9e9ef6ae/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Cortex-M0综述概览</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>