<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>网络视频播放卡顿原因分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="网络视频播放卡顿原因分析" />
<meta property="og:description" content="一、问题描述 某项目通过拉摄像机rtsp流转rtmp/http-flv/ws-flv的方案，使用户可以在网页中观看摄像机的视频画面。在 观看视频时偶发出现卡顿现象。 二、卡顿现象分析和解决 此问题涉及的原因较多，所以得考虑各环节的问题可能性，并根据现场实际情况进行处理。整个项目的视频链路为摄像机（rtsp服务器） -&gt; 推流端（将摄像机rtsp转rtmp） -&gt; 流媒体服务器（转协议，将rtmp转为http-flv/ws-flv） -&gt; 外网服务器（提供互联网访问连接的主机电脑，让用户可以在外网观看最终转出来的视频）。 可以看到链路比较多，当出现卡顿问题时需要从摄像机排查到推流端、流媒体服务器......外网再到播放器。我们可以一步步通过ffplay/vlc等播放器播放摄像机rtsp，内网播放http-flv/ws-flv，再到外网播放转出来的流来一步步排查是哪个链路出现问题。 (一)推流端 1.推流端硬件条件限制 使用推流工具（比如FFmpeg）推流（转码） “ 时，码率、帧率或编码档位设置得过高，但硬件条件存在限制（推流软件 所在电脑的 CPU 性能较差），导致编码速度变慢，无法达到流畅播放的帧率要求。 如果推流端所在电脑的整体 CPU 使用率超过80% ，那么视频的采集和编码都会受到影响，无法正常发挥作用；如果其 CPU 使用率达到 100%，那么推流端本身就已经很卡，观众端要有流畅的观看体验显然是不可能的。在Windows上可以使用任务管理器，Linux上使用top命令查看进程的CPU使用率。 解决方法： 尝试降低码率、帧率的设置，检查卡顿现象是否有好转。如果发生好转，可以考虑升级推流端所在电脑的硬件配置；或者不转码仅仅进行转封装 进行推流。 2.系统资源占用 检查推流端 所在电脑后台是否运行了大量的程序，建议删除和停止正在运行的程序，空出资源。 3.推流帧率过低 人眼识别为流畅的视频需要 FPS 每秒 15 帧以上。如果 FPS 低于 10 帧，画面就会出现较明显的卡顿。如无特殊情况，尽量将视频帧率设置在每秒15 帧之上，如果摄像机画面本身变化就很少，如静态画面或PPT 播放等场景，则不受该原因影响 。虽然视频的帧率越高画面流畅感越强，但是帧率超过每秒 30 帧 后，人眼就无法识别出画面的效果，帧率增加也会增加视频传输的带宽成本，建议合理设置该参数。 解决方法： 在推流指令中更改推流的帧率；或者更改摄像机自带配置网页中的设置，在里面更改帧率。 （二）流媒体服务器端 1.GOP缓存功能 为了保证视频的秒开以及降低视频的卡顿，一般的流媒体服务器默认会缓存数秒的数据，这一般叫 GOP缓存功能。比如缓存 180 秒的帧数据 , 任何终端播放的时候都是从 180 秒前进行播放 , 这样就至少保证 不会出现卡顿，但这样做延时会很大。部分流媒体服务器，比如开源的zlmediakit 并没有该功能。 2.自适应码率技术 自适应码率技术可以： 1. 让播放体验更加智能。例如，用户在一个不确定的网络环境下，不知道什么 清晰度最合适，选择高清晰度，卡了；选择低清晰度，画质体验又不好。自适应码率就是要解决这个选 择问题，智能匹配最合适的清晰度，避免用户自己反复去尝试；2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3316ed4602dde9d13b05aabfa2fe16c3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-26T09:40:49+08:00" />
<meta property="article:modified_time" content="2023-11-26T09:40:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">网络视频播放卡顿原因分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>一、问题描述</h2> 
<div> 
 <div> 
  <span style="color:#333333;">    某项目通过拉摄像机rtsp流转rtmp/http-flv/ws-flv的方案，使用户可以在网页中观看摄像机的视频画面。在</span> 
  <span style="color:#333333;">观看视频时偶发出现卡顿现象。</span> 
 </div> 
 <div></div> 
 <div></div> 
 <div></div> 
 <div></div> 
 <div></div> 
</div> 
<h2>二、<span style="color:#333333;">卡顿现象分析和解决</span></h2> 
<div> 
 <span style="color:#333333;">    此问题涉及的原因较多，所以得考虑各环节的问题可能性，并根据现场实际情况进行处理。</span>整个项目的视频链路为摄像机（rtsp服务器） -&gt; 推流端（将摄像机rtsp转rtmp） -&gt; 流媒体服务器（转协议，将rtmp转为http-flv/ws-flv） -&gt;  外网服务器（提供互联网访问连接的主机电脑，让用户可以在外网观看最终转出来的视频）。  
</div> 
<div>
      可以看到链路比较多，当出现卡顿问题时需要从摄像机排查到推流端、流媒体服务器......外网再到播放器。我们可以一步步通过ffplay/vlc等播放器播放摄像机rtsp，内网播放http-flv/ws-flv，再到外网播放转出来的流来一步步排查是哪个链路出现问题。 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h3>(一)推流端</h3> 
<h4>1.<span style="color:#333333;"><strong>推流端硬件条件限制</strong></span></h4> 
<div> 
 <span style="color:#333333;">    使用推流工具（比如FFmpeg）推流（转码）</span> 
 <span style="color:#333333;">“</span> 
 <span style="color:#333333;">时，码率、帧率或编码档位设置得过高，但硬件条件存在限制（推流软件</span> 
 <span style="color:#333333;">所在电脑的</span> 
 <span style="color:#333333;">CPU</span> 
 <span style="color:#333333;">性能较差），导致编码速度变慢，无法达到流畅播放的帧率要求。 如果推流端所在电脑的整体 CPU </span> 
 <span style="color:#333333;">使用率超过80%</span> 
 <span style="color:#333333;">，那么视频的采集和编码都会受到影响，无法正常发挥作用；如果其</span> 
 <span style="color:#333333;">CPU </span> 
 <span style="color:#333333;">使用率达到 100%，那么推流端本身就已经很卡，观众端要有流畅的观看体验显然是不可能的。在Windows上可以使用任务管理器，Linux上使用top命令查看进程的CPU使用率。</span> 
</div> 
<div></div> 
<div> 
 <span style="color:#333333;">解决方法： </span> 
</div> 
<div> 
 <span style="color:#333333;">    尝试降低码率、帧率的设置，检查卡顿现象是否有好转。如果发生好转，可以考虑升级推流端所在电脑的硬件配置；或者不转码仅仅进行转封装</span> 
 <span style="color:#333333;">进行推流。</span> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h4>2.系统资源占用</h4> 
<div> 
 <div> 
  <span style="color:#333333;">检查推流端</span> 
  <span style="color:#333333;">所在电脑后台是否运行了大量的程序，建议删除和停止正在运行的程序，空出资源。</span> 
 </div> 
 <div></div> 
 <div></div> 
 <div></div> 
 <h4>3.推流帧率过低</h4> 
 <div> 
  <span style="color:#333333;">    人眼识别为流畅的视频需要</span> 
  <span style="color:#333333;">FPS</span> 
  <span style="color:#333333;">每秒</span> 
  <span style="color:#333333;">15</span> 
  <span style="color:#333333;">帧以上。如果</span> 
  <span style="color:#333333;">FPS</span> 
  <span style="color:#333333;">低于</span> 
  <span style="color:#333333;">10</span> 
  <span style="color:#333333;">帧，画面就会出现较明显的卡顿。如无特殊情况，尽量将视频帧率设置在每秒15</span> 
  <span style="color:#333333;">帧之上，如果摄像机画面本身变化就很少，如静态画面或PPT 播放等场景，则不受该原因影响 。虽然视频的帧率越高画面流畅感越强，但是帧率超过每秒</span> 
  <span style="color:#333333;">30</span> 
  <span style="color:#333333;">帧 后，人眼就无法识别出画面的效果，帧率增加也会增加视频传输的带宽成本，建议合理设置该参数。 </span> 
 </div> 
 <div> 
  <span style="color:#333333;">解决方法： </span> 
 </div> 
 <div> 
  <span style="color:#333333;">    在推流指令中更改推流的帧率；或者更改摄像机自带配置网页中的设置，在里面更改帧率。</span> 
 </div> 
 <p></p> 
 <p></p> 
 <p></p> 
 <h3>（二）流媒体服务器端</h3> 
 <h4>1.GOP缓存功能</h4> 
 <div> 
  <div> 
   <span style="color:#333333;">    为了保证视频的秒开以及降低视频的卡顿，一般的流媒体服务器默认会缓存数秒的数据，这一般叫 GOP缓存功能。比如缓存</span> 
   <span style="color:#333333;">180</span> 
   <span style="color:#333333;">秒的帧数据</span> 
   <span style="color:#333333;">, </span> 
   <span style="color:#333333;">任何终端播放的时候都是从</span> 
   <span style="color:#333333;">180</span> 
   <span style="color:#333333;">秒前进行播放</span> 
   <span style="color:#333333;">, </span> 
   <span style="color:#333333;">这样就至少保证 不会出现卡顿，但这样做延时会很大。部分流媒体服务器，比如开源的zlmediakit</span> 
   <span style="color:#333333;">并没有该功能。</span> 
  </div> 
 </div> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h4>2.自适应码率技术</h4> 
<div> 
 <div> 
  <span style="color:#333333;">自适应码率技术可以：</span> 
  <span style="color:#333333;">1.</span> 
  <span style="color:#333333;">让播放体验更加智能。例如，用户在一个不确定的网络环境下，不知道什么 清晰度最合适，选择高清晰度，卡了；选择低清晰度，画质体验又不好。自适应码率就是要解决这个选 择问题，智能匹配最合适的清晰度，避免用户自己反复去尝试；2.</span> 
  <span style="color:#333333;">避免播放卡顿。高清视频，在网络限 速或者更常见的4G</span> 
  <span style="color:#333333;">下，网络波动大，自适应码率可以实时地调节清晰度，在保证用户观看更高清晰度的 情况下，避免播放卡顿。 </span> 
 </div> 
 <div></div> 
 <div> 
  <span style="color:#333333;">自适应码率技术原理： </span> 
 </div> 
 <div> 
  <span style="color:#333333;">第一步，原始的视频资源文件，它可能只有一个比较高的清晰度； </span> 
 </div> 
 <div> 
  <span style="color:#333333;">第二步，生产端对视频进行转码和切片，根据播放需要，转码成不同清晰度的码流。一般清晰度越高， </span> 
 </div> 
 <div> 
  <span style="color:#333333;">码率越高，文件越大。每个码流都切分成时间对齐的分片，一般是</span> 
  <span style="color:#333333;">10s</span> 
  <span style="color:#333333;">； </span> 
 </div> 
 <div> 
  <span style="color:#333333;">第三步，在转码和切片之后，经过</span> 
  <span style="color:#333333;"> CDN </span> 
  <span style="color:#333333;">节点在网络上进行分发； </span> 
 </div> 
 <div> 
  <span style="color:#333333;">第四步，各自适应码率的算法（基于带宽速率、 基于播放器</span> 
  <span style="color:#333333;">Buffer</span> 
  <span style="color:#333333;">的</span> 
  <span style="color:#333333;">BBA </span> 
  <span style="color:#333333;">算法 、</span> 
  <span style="color:#333333;">MPC</span> 
  <span style="color:#333333;">算法 、基于机器 </span> 
 </div> 
 <div> 
  <span style="color:#333333;">学习）按策略选择需要的清晰度； </span> 
 </div> 
 <div> 
  <span style="color:#333333;">第五步：客户端下载这个清晰度的分片文件，进行播放。 </span> 
 </div> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h4>3.抗丢包技术</h4> 
<div> 
 <span style="color:#333333;">    由于网络的不稳定，丢帧的情况时有发生，为了避免花屏，部分播放器会把丢失参考帧的视频丢掉， 其会无法渲染新的数据，这就会导致视频出现卡顿的问题。所以服务端一般会综合运用前向纠错、后向 补偿、丢包补偿技术使得在丢包率极高的环境下也能流畅直播。</span> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<div></div> 
<h3>（三）播放端</h3> 
<h4>1.播放端硬件条件限制</h4> 
<div>
      使用播放器播放音视频时，电脑的cpu或者gpu占用达到100%，意味着电脑正在全力运转，处理器已经没有剩余资源来处理其他任务了。这就可能会导致视频卡顿、画面不流畅等问题。 
</div> 
<div> 
 <img alt="" height="599" src="https://images2.imgbox.com/3f/ea/d35v4u59_o.jpg" width="1200"> 
</div> 
<div></div> 
<div></div> 
<div>
  解决方法：升级播放端电脑硬件，使用更高端的cpu和gpu；降低视频质量，降低视频的分辨率、码率、帧率等参数；关闭其它应用程序。 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h4>2.播放器缓冲区过小</h4> 
<div>
  一般的网络播放器都会有缓冲区抵抗网络抖动、抵抗解码抖动、避免被动丢帧导致花屏。缓冲区设置得过小，网络抖动时就可能会卡顿。但是缓冲器过大，则会导致内存占用高、播放延时大。 
</div> 
<div></div> 
<div> 
 <div> 
  <span style="color:#333333;">针对网络抖动：大部分播放器是接收缓存后才进行解码显示的，接收缓存的大小也会影响播放的流畅 度。所以可以通过调整接收缓存的大小，减少卡顿的影响。通过计算网络延迟来知道网络抖动的大小， 这样设置合适的缓冲区大小用来存储接收到的数据包。假设一开始网络抖动过大，这时播放器可以创建 一块buffer</span> 
  <span style="color:#333333;">用来接收数据，但不及时的送去给解码处理或者渲染处理，而是等待网络抖动大小设置的延 迟时间到了才把buffer</span> 
  <span style="color:#333333;">里的数据提供给解码或者渲染。这块</span> 
  <span style="color:#333333;">buffer</span> 
  <span style="color:#333333;">里含有多个视频帧数据，这样解码器 从buffer</span> 
  <span style="color:#333333;">里获得的数据就是时间连续的，这样就不会出现视频忽快忽慢的情况，而是看起来很平滑顺畅。但是使用jitter buffer，渲染的视频就会和源视频有较大的延迟，这是不可避免的。</span> 
 </div> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h4>3.部分播放器特性导致</h4> 
<div>
  部分开源播放器比如flv.js本身存在特性（bug），使用追帧策略时，跳帧会有明显卡顿，并且画面不连续。 
</div> 
<div>
  解决方法：更换更好的播放器，不要用flv.js。 
</div> 
<div></div> 
<div></div> 
<div></div> 
<div></div> 
<h3>(四）带宽不足</h3> 
<h4>1.上行带宽不足</h4> 
<div>
      上行是指从用户设备（如电脑、手机）发送数据到互联网或其他网络的过程。在宽带网络中，上行通常用于上传文件、发送电子邮件、进行视频通话等。 
 <span style="color:#333333;">上行带宽</span> 
 <span style="color:#333333;">不足或网络发生抖动，导致数据发送速率下降，无法达到流畅播放的帧率要求。 推流端在推流</span> 
 <span style="color:#333333;">时会源源不断地产生音视频数据，如果推流端的上传网速太小，那么产生的音视频数据都会被堆积在推</span> 
 <span style="color:#333333;">流端所在的电脑里传不出去，上传阻塞导致全部观众（全部播放端）的观看体验都很卡顿 。特别是推流</span> 
 <span style="color:#333333;">端所在电脑连接了</span> 
 <span style="color:#333333;">wifi</span> 
 <span style="color:#333333;">，</span> 
 <span style="color:#333333;">Wi-Fi </span> 
 <span style="color:#333333;">信号受建筑墙体的屏蔽干扰很严重，而一般的建筑很少在装修时考虑好</span> 
 <span style="color:#333333;">Wi-Fi </span> 
 <span style="color:#333333;">路由器和各个房间的信号衰减问题。可以使用网速测试工具</span> 
 <span style="color:#4183c4;">Speedtest</span> 
 <span style="color:#333333;">测试当前网络的上行带宽情</span> 
 <span style="color:#333333;">况。</span> 
</div> 
<div></div> 
<div></div> 
<div>
  例子： 
</div> 
<div></div> 
<div>
  如下图所示，用Speedtest测到流媒体服务器所在电脑的上传带宽是40.55Mbps 
</div> 
<div>
  · 
</div> 
<div> 
 <img alt="" height="340" src="https://images2.imgbox.com/dd/df/7cKyG1XV_o.png" width="745"> 
</div> 
<div></div> 
<div></div> 
<div>
  但是通过任务管理看到该电脑每秒发送62.2Mbps的数据到互联网上，62.2Mbps &gt; 40.55Mbps，所以就会出现观看视频卡顿现象。 
</div> 
<div></div> 
<div></div> 
<div> 
 <img alt="" height="531" src="https://images2.imgbox.com/e2/e6/6EiCicex_o.png" width="632"> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<div> 
 <div> 
  <span style="color:#333333;">解决方法： </span> 
 </div> 
 <div> 
  <span style="color:#333333;">针对上行带宽不足：</span> 
  <span style="color:#333333;">向运营商申请更多的带宽；</span> 
  <span style="color:#333333;">降低推流码率； 用摄像机的次码流作为输入（相同 环境下，次码流占用的带宽小，具体可进入摄像机配置网页的中调节）；</span> 
  <span style="color:#333333;">无人观看不取流处理，当没有对应客户端</span> 
  <span style="color:#333333;">/</span> 
  <span style="color:#333333;">前端播放视频时让推流端</span> 
  <span style="color:#333333;">停止对应的推流，从而节约带宽。</span> 
 </div> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<h4>2.下行带宽不足</h4> 
<div>
  下行是指从互联网或其他网络接收数据到用户设备的过程。在宽带网络中，下行通常用于下载文件、浏览网页、观看视频等。 
 <span style="color:#333333;">下行带宽不足，即观众的下载带宽跟不上或者网络波动较大，例如直播流的码率是2Mbps</span> 
 <span style="color:#333333;">的，也就是每秒钟有2M</span> 
 <span style="color:#333333;">比特的数据流要下载下来，但如果观众端的带宽不够，就会导致观众端播放体验非常卡顿。 下行不佳只会影响当前网络环境下的观众。解决方法与上行带宽不足的解决方法相同。</span> 
</div> 
<div></div> 
<div></div> 
<div></div> 
<div></div> 
<div></div> 
<h2>三、参考</h2> 
<div>
  《 
 <a class="link-info" href="https://zhuanlan.zhihu.com/p/444096391" rel="nofollow" title="【音视频技术】播放器缓冲区管理">【音视频技术】播放器缓冲区管理</a>》 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ec0e0c94abdf2d402315f472f45e79c0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">每日一题--删除链表的倒数第 N 个结点</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e31038d0887dbf533dc87dba99d02a92/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【IJCAI2022】Uncertainty-Guided Pixel Contrastive Learning for Semi-Supervised Medical Image Segmentat</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>