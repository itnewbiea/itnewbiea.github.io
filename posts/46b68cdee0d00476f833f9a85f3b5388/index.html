<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>个人笔记Openstack中的常用命令 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="个人笔记Openstack中的常用命令" />
<meta property="og:description" content="一、块存储（Cinder） 1.列出所有卷（ID、名称、状态、大小和挂载目录） openstack volume list 2.新建卷（size的单位为GB）
openstack volume create --size &lt;size&gt; &lt;name&gt; 3.删除卷
openstack volume delete &lt;id&gt; 4.将卷连接到instance
openstack server add volume &lt;instance_id&gt; &lt;volume_id&gt; 二、认证（Keystone）
1.列出所有用户 openstack user list 2.列出认证服务目录
openstack catalog list 三、镜像（Glance）
1.列出可以访问的镜像 openstack image list 2.删除指定镜像
openstack image delete &lt;image_id&gt; 3.查看指定镜像的详细信息
openstack image show &lt;image_id&gt; 4.更新镜像
openstack image set &lt;image_id&gt; 四、计算（nova）
1列出实例 openstack server list 2.创建规格
openstack flavor create --ram &lt;ram_size_MB&gt; --disk &lt;disk_size_GB&gt; --vcpus &lt;vcpu_num&gt; &lt;flavor_name&gt; 3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/46b68cdee0d00476f833f9a85f3b5388/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-14T13:52:57+08:00" />
<meta property="article:modified_time" content="2023-02-14T13:52:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">个人笔记Openstack中的常用命令</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>一、块存储（Cinder）</h4> 
<h4>1.列出所有卷（ID、名称、状态、大小和挂载目录）</h4> 
<pre><code class="language-python">openstack volume list</code></pre> 
<p>2.新建卷（size的单位为GB）</p> 
<pre><code class="language-python">openstack volume create --size &lt;size&gt; &lt;name&gt;</code></pre> 
<p>3.删除卷</p> 
<pre><code class="language-python">openstack volume delete &lt;id&gt;</code></pre> 
<p>4.将卷连接到instance</p> 
<pre><code class="language-python">openstack server add volume &lt;instance_id&gt; &lt;volume_id&gt;</code></pre> 
<h4><br> 二、认证（Keystone）<br> 1.列出所有用户</h4> 
<pre><code class="language-python">openstack user list</code></pre> 
<p><br> 2.列出认证服务目录</p> 
<pre><code class="language-python">openstack catalog list</code></pre> 
<h4><br><strong>三、镜像（Glance）</strong><br> 1.列出可以访问的镜像</h4> 
<pre><code class="language-python">openstack image list</code></pre> 
<p>2.删除指定镜像</p> 
<pre><code class="language-python">openstack image delete &lt;image_id&gt;</code></pre> 
<p>3.查看指定镜像的详细信息</p> 
<pre><code class="language-python">openstack image show &lt;image_id&gt;</code></pre> 
<p>4.更新镜像</p> 
<pre><code class="language-python">openstack image set &lt;image_id&gt;</code></pre> 
<h4><br> 四、计算（nova）<br> 1列出实例</h4> 
<pre><code class="language-python">openstack server list</code></pre> 
<p>2.创建规格</p> 
<pre><code class="language-python">openstack flavor create --ram &lt;ram_size_MB&gt; --disk &lt;disk_size_GB&gt; --vcpus &lt;vcpu_num&gt; &lt;flavor_name&gt;</code></pre> 
<p>3.列出所有规格</p> 
<pre><code class="language-python">openstack flavor list</code></pre> 
<p>4.创建并启动云主机</p> 
<pre><code class="language-python">openstack server create --image &lt;image_id&gt; --flavor &lt;flavor_id&gt; &lt;server_name&gt;</code></pre> 
<p>5.显示实例的详细信息</p> 
<pre><code class="language-python">openstack server show &lt;server_name&gt;</code></pre> 
<p>6.查看云主机的控制台日志</p> 
<pre><code class="language-python">openstack server show &lt;server_name&gt;</code></pre> 
<p>7.设置云主机的元数据</p> 
<pre><code class="language-python">nova meta &lt;server_id&gt; set &lt;meta_key&gt;=&lt;meta_value&gt;</code></pre> 
<p>8.创建云主机快照</p> 
<pre><code class="language-python">openstack image create &lt;server_id&gt; &lt;snapshot_name&gt;</code></pre> 
<p>9.查看云主机快照</p> 
<pre><code class="language-python">openstack image show &lt;snapshot_name&gt;</code></pre> 
<p>10.暂停云主机</p> 
<pre><code class="language-python">openstack server pause &lt;server_id&gt;</code></pre> 
<p>11.取消暂停</p> 
<pre><code class="language-python">openstack server unpause &lt;server_id&gt;</code></pre> 
<p>12.挂起云主机</p> 
<pre><code class="language-python">openstack server suspend &lt;server_id&gt;</code></pre> 
<p>13.取消挂起</p> 
<pre><code class="language-python">openstack server resume &lt;server_id&gt;</code></pre> 
<p>14.关闭云主机</p> 
<pre><code class="language-python">openstack server stop &lt;server_id&gt;</code></pre> 
<p>15.开启云主机</p> 
<pre><code class="language-python">openstack server start &lt;server_id&gt;</code></pre> 
<p>16.恢复云主机</p> 
<pre><code class="language-python">openstack server rescue &lt;server_id&gt; --rescue_image_ref &lt;rescue_image&gt;</code></pre> 
<p>17.调整云主机大小</p> 
<pre><code class="language-python">openstack server resize &lt;server_id&gt; &lt;flavor_name&gt;</code></pre> 
<p>18.重建云主机</p> 
<pre><code class="language-python">openstack server rebuild &lt;server_id&gt; &lt;image_id&gt;</code></pre> 
<p>19.重启云主机</p> 
<pre><code class="language-python">openstack server reboot &lt;server_id&gt;</code></pre> 
<p>20.将用户数据文件注入云主机</p> 
<pre><code class="language-python">openstack server create --user-data &lt;datafile_name&gt; --image &lt;iamge_id&gt; --flavor &lt;flavor_name&gt; &lt;server_name&gt;</code></pre> 
<h4><br> 五、网络（Neutron）<br> 1.创建网络</h4> 
<pre><code class="language-python">openstack network create &lt;network_name&gt;</code></pre> 
<p><br> 2.创建子网</p> 
<pre><code class="language-python">openstack network create --subnet-pool &lt;subnet&gt; --network &lt;network_name&gt; &lt;subnet_name&gt;</code></pre> 
<pre><code class="language-bash">Opnestack三大核心

1.计算服务（compute） 服务名 Nova #用于为用户管理虚拟机实例 提供虚拟服务 负责虚拟机创建 开机关机等操作 （计算资源分配资源 cpu，mem）

2.网络服务（networking） 服务名 Neutron #为云平台提供网络虚拟化 为用户提供网络接口 （cloud连接的网络） 服务名 Designate #DNS服务

3.存储（storage） 分为 1.文件存储 服务名 Manila 
                     2.块存储 Block Storage 服务名 Cinder #管理块设备，列入创建卷，删除卷等 
                       （系统盘） 
                     3.对象存储 Object Storage 服务名 Swift #允许使用进行文件粗出及检索

4.身份认证服务 （ldentity） 服务名 keystone #为openstack替他服务提供身份验证，服务注册等功能 （各组件互相通信的身份认证与协调）

5.镜像服务 （image service） 服务名 Glance #为云平台提供镜像服务器，上传镜像 ，删除镜像等 （镜像服务）

6.UI界面 （Dashboard） 服务名 Horizon #为openstack 提供管理门户，例如启动云主机，创建网络，访问控制等 （提供图形操作界面）

7.测量 （metering ） 服务名 Ceilometer #内部发生的资源进行统计，然后计费和监控提供数据支撑等

8.编排部署 （orchestration） 服务名 Heat # 为云平台提供软件运行环境自动化部署

9.数据库 （database server） 服务名Trove # 提供可扩展和可靠的关系型数据库或非关系型数据库引擎</code></pre> 
<h2 id="%E4%B8%80%E3%80%81Neutron%E6%9C%8D%E5%8A%A1%E8%BF%90%E7%BB%B4"><strong>一、Neutron服务运维</strong></h2> 
<h3 id="1.%E4%BB%80%E4%B9%88Neutron%EF%BC%9F"><a name="t2"></a><strong>1.什么Neutron？</strong></h3> 
<p>Neutron 是 <a href="https://so.csdn.net/so/search?q=Openstack&amp;spm=1001.2101.3001.7020" title="Openstack">Openstack</a> 的虚拟网络服务。</p> 
<p> Neutron 的设计目标是实现“网络即服务（Networking as a Service）”。为了达到这一目标，在设计上遵循了基于 <a href="https://so.csdn.net/so/search?q=SDN&amp;spm=1001.2101.3001.7020" title="SDN">SDN</a> 实现网络<a href="https://so.csdn.net/so/search?q=%E8%99%9A%E6%8B%9F%E5%8C%96&amp;spm=1001.2101.3001.7020" title="虚拟化">虚拟化</a>的原则，在实现上充分利用了 Linux 系统上的各种网络相关的技术。</p> 
<h3 id="2.Neutron%E5%8A%9F%E8%83%BD"><a name="t3"></a>2.Neutron功能</h3> 
<p> Neutron 为整个 <a href="https://so.csdn.net/so/search?q=OpenStack&amp;spm=1001.2101.3001.7020" title="OpenStack">OpenStack</a> 环境提供网络支持，包括二层交换，三层路由，负载均衡，防火墙等。Neutron 提供了一个灵活的框架，通过配置，无论是开源还是商业软件都可以被用来实现这些功能。</p> 
<h3 id="3.Neutron%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><a name="t4"></a>3.Neutron基本架构</h3> 
<p>与<a href="https://so.csdn.net/so/search?q=openstack&amp;spm=1001.2101.3001.7020" title="openstack">openstack</a>其他服务和组件的设计思路一样，Neutron也采用分布式架构，由多个组件（服务）共同对外提供网络服务，Neutron架构非常灵活，层次多，一方面是为了支持各种现有或者将来会出现的先进网络技术，另一方面支持分布式部署，获得足够的拓展性。示意图如下：</p> 
<p><img alt="" height="335" src="https://images2.imgbox.com/f1/97/9xTgkYMi_o.png" width="515"></p> 
<p> neutron server：对外提供 <a href="https://so.csdn.net/so/search?q=OpenStack&amp;spm=1001.2101.3001.7020" title="OpenStack">OpenStack</a> 网络API，接收请求，并调用Plugin处理请求。</p> 
<p>queue：Neutron Server，Plugin 和 Agent 之间通过 Messaging Queue 通信和调用。</p> 
<p>neutron plugin：处理 Neutron Server 发来的请求，维护 OpenStack 逻辑网络的状态， 并调用 Agent 处理请求。</p> 
<p>neutron agent：处理 Plugin请求，负责在 network provider 上真正实现各种网络功能。</p> 
<p>neutron provider：提供网络服务的虚拟或物理网络设备，例如 Linux Bridge，Open vSwitch或者其他支持 Neutron 的物理交换机。</p> 
<p>neutron database：存放 OpenStack 的网络状态信息，包括 Network, Subnet, Port, Router等。</p> 
<h3 id="4.Neutron%E8%BF%90%E7%BB%B4%E5%91%BD%E4%BB%A4"><a name="t5"></a>4.Neutron运维命令</h3> 
<h4 id="4.1%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE"><a name="t6"></a>4.1<a href="https://so.csdn.net/so/search?q=%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE&amp;spm=1001.2101.3001.7020" title="思维导图">思维导图</a></h4> 
<p><img alt="" height="291" src="https://images2.imgbox.com/6c/e4/rlv3dDD9_o.png" width="712"></p> 
<h4 id="%C2%A04.2%E6%A1%88%E4%BE%8B%E5%AE%9E%E6%96%BD"><a name="t7"></a> 4.2案例实施</h4> 
<p>1.使用Neutron相关命令查询网络服务列表中的“binary”一列</p> 
<ol><li> <p>[root@controller ~]# neutron agent-list -c binary</p> </li><li> <p>+---------------------------+</p> </li><li> <p>| binary |</p> </li><li> <p>+---------------------------+</p> </li><li> <p>| neutron-openvswitch-agent |</p> </li><li> <p>| neutron-dhcp-agent |</p> </li><li> <p>| neutron-l3-agent |</p> </li><li> <p>| neutron-metadata-agent |</p> </li><li> <p>| neutron-lbaas-agent |</p> </li><li> <p>+---------------------------+</p> </li></ol> 
<blockquote> 
 <p>//如果一开始查报错，建议重启一下服务<br> [root@controller ~]# systemctl restart neutron-server.service</p> 
</blockquote> 
<p>2.查询网络详细信息</p> 
<ol><li> <p>[root@xiandian ~]# neutron net-list //列出当前租户所有的网络</p> </li><li> <p>+--------------------------------------+------------+---------+</p> </li><li> <p>| id | name | subnets |</p> </li><li> <p>+--------------------------------------+------------+---------+</p> </li><li> <p>| bd923693-d9b1-4094-bd5b-22a038c44827 | sharednet1 | |</p> </li><li> <p>+--------------------------------------+------------+---------+</p> </li><li> <p>[root@xiandian ~]# neutron net-show bd923693-d9b1-4094-bd5b-22a038c44827</p> </li><li> <p>+---------------------------+--------------------------------------+</p> </li><li> <p>| Field | Value |</p> </li><li> <p>+---------------------------+--------------------------------------+</p> </li><li> <p>| admin_state_up | True |</p> </li><li> <p>| availability_zone_hints | |</p> </li><li> <p>| availability_zones | |</p> </li><li> <p>| created_at | 2017-02-23T04:58:17 |</p> </li><li> <p>| description | |</p> </li><li> <p>| id | bd923693-d9b1-4094-bd5b-22a038c44827 |</p> </li><li> <p>| ipv4_address_scope | |</p> </li><li> <p>| ipv6_address_scope | |</p> </li><li> <p>| mtu | 1500 |</p> </li><li> <p>| name | sharednet1 |</p> </li><li> <p>| port_security_enabled | True |</p> </li><li> <p>| provider:network_type | flat |</p> </li><li> <p>| provider:physical_network | physnet1 |</p> </li><li> <p>| provider:segmentation_id | |</p> </li><li> <p>| router:external | False |</p> </li><li> <p>| shared | True |</p> </li><li> <p>| status | ACTIVE |</p> </li><li> <p>| subnets | |</p> </li><li> <p>| tags | |</p> </li><li> <p>| tenant_id | 20b1ab08ea644670addb52f6d2f2ed61 |</p> </li><li> <p>| updated_at | 2017-02-23T04:58:17 |</p> </li><li> <p>+---------------------------+--------------------------------------+</p> </li></ol> 
<p> 3.查询Neutron相关命令查询网络服务DHCP agent的详细信息</p> 
<pre></pre> 
<ol><li> <p>[root@controller ~]# neutron agent-list</p> </li><li> <p>+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</p> </li><li> <p>| id | agent_type | host | availability_zone | alive | admin_state_up | binary |</p> </li><li> <p>+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</p> </li><li> <p>| 1ccc8d2d-b40a-4406-b15b-ab4b2b8e8398 | Open vSwitch agent | controller | | :-) | True | neutron-openvswitch-agent |</p> </li><li> <p>| 245ae2f9-6220-4c00-a36d-542a746a3f9e | DHCP agent | controller | nova | :-) | True | neutron-dhcp-agent |</p> </li><li> <p>| 26f38d05-3553-46f6-8740-847f97741f89 | L3 agent | controller | nova | :-) | True | neutron-l3-agent |</p> </li><li> <p>| 5bd0c9e2-a2ef-4890-a4ac-a4cb6bccf71b | Metadata agent | controller | | :-) | True | neutron-metadata-agent |</p> </li><li> <p>| f1d1fc34-6e9d-46b5-8370-0579f3b46b6f | Loadbalancer agent | controller | | :-) | True | neutron-lbaas-agent |</p> </li><li> <p>+--------------------------------------+--------------------+------------+-------------------+-------+----------------+---------------------------+</p> </li><li> <p>[root@controller ~]# neutron agent-show 245ae2f9-6220-4c00-a36d-542a746a3f9e</p> </li><li> <p>+---------------------+----------------------------------------------------------+</p> </li><li> <p>| Field | Value |</p> </li><li> <p>+---------------------+----------------------------------------------------------+</p> </li><li> <p>| admin_state_up | True |</p> </li><li> <p>| agent_type | DHCP agent |</p> </li><li> <p>| alive | True |</p> </li><li> <p>| availability_zone | nova |</p> </li><li> <p>| binary | neutron-dhcp-agent |</p> </li><li> <p>| configurations | { |</p> </li><li> <p>| | "subnets": 0, |</p> </li><li> <p>| | "dhcp_lease_duration": 86400, |</p> </li><li> <p>| | "dhcp_driver": "neutron.agent.linux.dhcp.Dnsmasq", |</p> </li><li> <p>| | "networks": 0, |</p> </li><li> <p>| | "log_agent_heartbeats": false, |</p> </li><li> <p>| | "ports": 0 |</p> </li><li> <p>| | } |</p> </li><li> <p>| created_at | 2019-12-03 17:43:37 |</p> </li><li> <p>| description | |</p> </li><li> <p>| heartbeat_timestamp | 2022-04-10 22:41:26 |</p> </li><li> <p>| host | controller |</p> </li><li> <p>| id | 245ae2f9-6220-4c00-a36d-542a746a3f9e |</p> </li><li> <p>| started_at | 2022-04-10 22:38:56 |</p> </li><li> <p>| topic | dhcp_agent |</p> </li><li> <p>+---------------------+----------------------------------------------------------+</p> </li></ol> 
<p></p> 
<hr> 
<h2 id="%E4%BA%8C%E3%80%81Cinder%E6%9C%8D%E5%8A%A1%E8%BF%90%E7%BB%B4"><a name="t8"></a><a id="_19"></a>二、Cinder服务运维</h2> 
<h3 id="1.%E4%BB%80%E4%B9%88%E6%98%AFCinder%EF%BC%9F"><a name="t9"></a><a id="1_20"></a>1.什么是Cinder？</h3> 
<p>cinder 是提供块存储的服务。存储的分配和消耗是由块存储驱动器或者多后端配置的驱动器决定的。还有很多驱动程序可以用：NAS/SAN、NFS、CEPH等。一般运行在openstack的控制节点上。其驱动可以运行在控制节点、计算节点或者单独的存储节点上。</p> 
<h3 id="2.Cinder%E7%9A%84%E4%BD%9C%E7%94%A8"><a name="t10"></a><a id="2_34"></a>2.Cinder的作用</h3> 
<p>cinder的核心功能是对卷的管理，允许对卷、卷的类型、卷的<a href="https://so.csdn.net/so/search?q=%E5%BF%AB%E7%85%A7&amp;spm=1001.2101.3001.7020" title="快照">快照</a>、卷备份进行处理。它为后端不同的存储设备提供了统一的接口，不同的块设备服务厂商在 cinder 中实现其驱动支持以与 OpenStack 进行整合。</p> 
<h3 id="3.Cinder%E5%9F%BA%E6%9C%AC%E6%9E%B6%E6%9E%84"><a name="t11"></a>3.Cinder基本架构</h3> 
<p><img alt="" height="673" src="https://images2.imgbox.com/7c/7b/4dJ5vi1s_o.png" width="1200"></p> 
<ul><li>Cinder-api用来接受api请求，并将其路由到cinder-volume执行</li><li>Cinder-Volume用来与块存储服务和 Cinder- Scheduler进程进行直接交互。它也可以与这些进程通过一个消息队列进行交互。 Cinder-Volume服务响应送到块存储服务的读写请求来维持状态，它也可以和多种存储提供者在驱动架构下进行交互。）</li><li>Cinder- Scheduler守护进程会选择最优存储节点来创建卷，其工作机制与Nova- Scheduler类似。当需要创建卷时，Cinder- Scheduler根据存储节点的资源使用情况选择一个最合适的节点来创建卷。</li><li>Cinder- Backup服务提供任何种类备份卷到一个备份存储提供者。就像 Cinder- Volume服务，它与多种存储提供者在驱动架构下进行交互。</li><li>消息队列</li><li>消息队列作用是在块存储的进程之间路由信息。 Cinder各个子服务通过消息队列实现进程间通信和相互协作。</li></ul> 
<h3 id="4.Cinder%E5%9F%BA%E7%A1%80%E5%91%BD%E4%BB%A4"><a name="t12"></a><a id="_45">4.Cinder基础命令</a></h3> 
<h4><a name="t13"></a>4.1思维导图</h4> 
<p><img alt="" height="544" src="https://images2.imgbox.com/22/83/6JOBTGC3_o.png" width="1200"></p> 
<h4><a name="t14"></a> 4.2案例实施</h4> 
<p>1.创建云硬盘</p> 
<p>创建一个2 GB的云硬盘extend-demo，并且查看云硬盘信息。</p> 
<ol><li> <p>[root@controller ~]# cinder create --name cinder-volume-demo 2</p> </li><li> <p>[root@controller ~]# cinder list</p> </li></ol> 
<p>2.创建云硬盘类型</p> 
<p>创建了一个名为“lvm”的卷类型。通过cinder命令查看现有的卷类型。</p> 
<ol><li> <p>[root@controller ~]# cinder type-create lvm</p> </li><li> <p>[root@controller ~]# cinder type-list</p> </li></ol> 
<p>3.创建带标识云硬盘</p> 
<p>创建一块带“lvm”标识名为type_test_demo的云硬盘，最后使用命令查看所创建的云硬盘。</p> 
<pre></pre> 
<ol><li> <p>[root@controller ~]# cinder create --name type_test_demo --volume-type lvm 1</p> </li><li> <p>[root@controller ~]# cinder show type_test_demo</p> </li></ol> 
<p>4.删除指定的Cinder卷</p> 
<p>[root@controller ~]# cinder delete cinder-volume-demo</p> 
<p></p> 
<h3><span style="color:#79c6cd;">三：glance项目</span><br> 1.1：glance是什么？有什么作用？<br> Glance（OpenStack Image Service）是一个提供发现，注册，和下载镜像的服务。Glance 提供了虚拟机镜像的集中存储。通过 Glance 的 RESTful API，可以查询镜像元数据、下载镜像。虚拟机的镜像可以很方便的存储在各种地方，从简单的文件系统到对象存储系统(比如 OpenStack Swift)。</h3> 
<p>在 Glance 里镜像被当做模板来存储，用于启动新实例。Glance 还可以从正在运行的实例建立快照用于备份虚拟机的状态。</p> 
<p>Glance 具体功能如下：</p> 
<p>提供 RESTful API 让用户能够查询和获取镜像的元数据和镜像本身；<br> 支持多种方式存储镜像，包括普通的文件系统、Swift、Ceph 等；<br> 对实例执行快照创建新的镜像。<br> Clance 在整个 OpenStack 架构中的位置如下图：</p> 
<p><span style="color:#79c6cd;">二：架构</span><br> 在 Newton 之前的版本中，Glance 支持两种 RESTful API V1和V2，两者区别为：<br> V1只提供了基本的镜像和用户操作功能：<br> 镜像创建、删除、下载、列表、详细信息查询、更新，以及镜像租户成员的创建、删除和列表。</p> 
<p>V2除了支持V1的所有功能外，主要是增加了如下功能</p> 
<p>镜像 location 的添加、删除和修改等操作；<br> metadata namespace 操作；<br> 镜像 tag 操作。<br> V1 和V2对镜像后端存储的支持是相同的。<br> V1版本的实现，具有 glance-api 和 glance-registry 两个 WSGI 服务，二者都提供 RESTful API，但需要强调的一点是，glance-registry 提供的 RESTful API 是给 glance-api 使用的，并不开放给外部用户。</p> 
<p><br> glance-api<br> glance-api 是系统后台运行的服务进程。 对外提供 RESTful API，响应镜像查询、获取和存储作用。glance-api 不会真正处理请求。 如果是与镜像 metadata（元数据）相关的操作，glance-api 会把请求转发给glance-registry；如果是与镜像自身存取相关的操作，glance-api 会把请求转发给该 image 的存储后端。</p> 
<p>glance-registry<br> Glance的DB模块存储的是镜像的元数据，可以选用Mysql、MariaDB、SQLite等数据库。元数据是指镜像相关的一些信息（如id，size， status，location，checksum，min_disk，min_ram，owner等）真正的镜像数据保存在实际所使用的后端存储里（如Swift，S3，Filesystem等）。默认绑定的端口是9191。镜像的元数据通过glance-registry存放在数据库中。镜像本身（chunk数据）是通过glance存储在驱动存放到各种存储后端中的。</p> 
<p>store adapter‘<br> 严格来说Image Store不属于Glance的组件，这里把它单独分出来只是为了方便理解，它只是一个接口层，提供镜像存储和查询的接口。具体的实现则需要外部存储（Swift，S3）的支持。<br> 存储后端Glance自身并不存储镜像，它将镜像存放在后端存储系统中。镜像本身的数据通glance_store存放在各种后端，并可从中获取。支持本地存储、对象存储、RBD块设备、Sheepdog分布式存储、Cinder块存储】VMware数据存储。</p> 
<p>2.1：glance有哪些常见的镜像格式</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td>格式</td><td>描述</td></tr><tr><td>RAW（常用）</td><td>出色的原始文件格式，方便转换成其他格式</td></tr><tr><td>QCOW2（常用）</td><td>占用的磁盘空间可以动态按需增长</td></tr><tr><td>VHD格式</td><td>微软公司的磁盘格式，如果在openstack上使用Hyper-V类型的虚拟化，就需要上传VHD格式的镜像文件</td></tr><tr><td>VMDK格式</td><td>VMware公司的磁盘格式（virtualbox和QEM也支持VMDK格式）</td></tr><tr><td>VDI格式</td><td>oracle公司的virtualbox虚拟软件使用的格式</td></tr><tr><td>ISO格式</td><td>一种存档数据文件在光盘上的格式</td></tr><tr><td>AKI,ARI,AMI格式</td><td>Amazon公司的AWS所使用的镜像格式</td></tr></tbody></table> 
<p><br> 2.2：glance的常用管理命令有哪些</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:600px;"><tbody><tr><td>命令</td><td>作用</td></tr><tr><td>openstack image list</td><td>查看已有镜像列表</td></tr><tr><td>openstack image show 镜像名</td><td>查看镜像的详细信息</td></tr><tr><td>openstack image create --file 镜像文件名 --disk-format qcow2 --container-format bare --public centos7 生产一个qcow2格式的镜像，名字为centos7</td><td>创建镜像</td></tr><tr><td>glance image-create --name “centos7” --file centos.img --disk-format raw --container-format bare --progress</td><td>创建镜像并查看百分比进度</td></tr><tr><td>openstack image delete 镜像名</td><td>删除镜像</td></tr><tr><td>openstack image create --file 镜像 --disk-format qcow2 --container-format bare --public 镜像名</td><td>修改镜像格式（例如raw修改为qcow2）</td></tr><tr><td>qemu-img convert -f raw -O qcow2 centos7.img centos7.qcow2</td><td>修改镜像格式（例如将裸格式镜像文件centos7.img转为qcow2格式）</td></tr></tbody></table> 
<p><br> 2.3：镜像访问权限</p> 
<table border="1" cellpadding="1" cellspacing="1"><tbody><tr><td>命令</td><td>作用</td></tr><tr><td>public公共的</td><td>可以被所有的项目使用</td></tr><tr><td>private私有的</td><td>只有被镜像所有者所在的项目使用</td></tr><tr><td>shared共享的</td><td>一个非共有的镜像，可以共享给其他项目，通过项目成员（member-*）操作来实现的</td></tr><tr><td>projected（受保护的）</td><td>这种镜像不能被删除</td></tr></tbody></table> 
<p><br> 2.4：glance的工作流程<br> glance是一个C/S架构，给外部提供服务，用户通过REST API获取glance所有服务。</p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/09/0d/ylffZnLH_o.png"></p> 
<p> </p> 
<p><span style="color:#79c6cd;">镜像上传服务</span></p> 
<ul><li>用户在命令行或horizon申请上传镜像，API收到请求，并通过调度器进行解析，获取版本信息。</li><li>Glance-registryAPI获取一个registry client，调用glance-registry的add_image函数。此时镜像状态为queued，标识该镜像ID被保留，但是镜像还未上传，Glance-registry服务执行client的add_image函数，像glance数据库插入一条记录</li><li>Glance-api调用glance-registry的update_image_metadata函数，更新数据库中的状态为saveing，表示镜像正在被上传，Glance-api端存储接口提供的add函数上传镜像文件。</li><li>Glance-api调用glance-registry的update_image_metadata函数，更新数据库中该镜像的状态为active并发通知。active标识镜像在Glance中完全可用</li></ul> 
<p><br><span style="color:#79c6cd;">调度器</span></p> 
<ul><li>首先是对客户端的安全认证流程：openstack的操作都需要经过keystone进行身份认证，并授权，glance也不例外，授权成功再去请求glance服务，glance服务接收到外部请求后，会去keystone进行认证，此请求是否已授权，认证通过后，才会将请求传到后端处理。</li><li>glance domain controller是API和后端功能模块的中间件，相当于调度器，作用是将外部服务分发到下面的各个功能层去处理。</li><li>在调度时，遵循调度算法，首先有一个预选，排除不符合要求的节点，再进行优选，通过打分机制，对都能够处理此功能的节点进行打分，考虑它们当前的负荷，处理能力和速度，选出最优的一个。</li><li>对于一些有污点的节点，调度器是直接跳过他们的，如果其余可用节点负担都太大，无法处理外部请求，会有一个容忍机制，由运维人员控制，让调度器接受污点，对污点再进行优选。</li></ul> 
<h4>2.5：glance服务部署<br> 创建数据库实例和数据库用户<br>  </h4> 
<pre><code class="hljs">[root@ct ~]# mysql -u root -p
MariaDB [(none)]&gt; CREATE DATABASE glance;
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'GLANCE_DBPASS';
MariaDB [(none)]&gt; GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'GLANCE_DBPASS';
MariaDB [(none)]&gt; flush privileges;
MariaDB [(none)]&gt; exit
</code></pre> 
<ul><li>创建用户、修改配置文件<br> 创建OpenStack的Glance用户<br> #创建用户前，需要首先执行管理员环境变量脚本（此处已经在~/.bashrc 中定义过了） <pre><code class="hljs">[root@ct ~]# openstack user create --domain default --password GLANCE_PASS glance			###创建glance用户
root@ct ~]# openstack role add --project service --user glance admin
#将glance用户添加到service项目中，并且针对这个项目拥有admin权限；注册glance的API，需要对service项目有admin权限

[root@ct ~]# openstack service create --name glance --description "OpenStack Image" image		
#创建一个service服务，service名称为glance，类型为image；创建完成后可以通过 openstack service list 查看
</code></pre> </li></ul> 
<p> </p> 
<ul><li>创建镜像服务 API 端点，OpenStack使用三种API端点代表三种服务：admin、internal、public</li></ul> 
<pre><code class="hljs">[root@ct ~]# openstack endpoint create --region RegionOne image public http://ct:9292
[root@ct ~]# openstack endpoint create --region RegionOne image internal http://ct:9292
[root@ct ~]# openstack endpoint create --region RegionOne image admin http://ct:9292
</code></pre> 
<ul><li>安装 openstack-glance 软件包。</li></ul> 
<pre><code class="hljs">[root@ct ~]# yum -y install openstack-glance 
</code></pre> 
<ul><li>修改glance配置文件，glance有两个配置文件：</li></ul> 
<pre><code class="hljs">/etc/glance/glance-api.conf 
/etc/glance/glance-registry.conf
</code></pre> 
<ul><li>修改glance-api.conf配置文件</li></ul> 
<pre><code class="hljs">[root@ct ~]# cp -a /etc/glance/glance-api.conf{,.bak}
[root@ct ~]# grep -Ev '^$|#' /etc/glance/glance-api.conf.bak &gt; /etc/glance/glance-api.conf

openstack-config --set /etc/glance/glance-api.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@ct/glance
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken www_authenticate_uri http://ct:5000
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://ct:5000
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers ct:11211
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_type password
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_name Default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_name Default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password GLANCE_PASS
openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone
openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http
openstack-config --set /etc/glance/glance-api.conf glance_store default_store file
openstack-config --set /etc/glance/glance-api.conf glance_store filesystem_store_datadir /var/lib/glance/images/
</code></pre> 
<ul><li>修改glance-registry.conf 配置文件</li></ul> 
<pre><code class="hljs">cp -a /etc/glance/glance-registry.conf{,.bak}
grep -Ev '^$|#' /etc/glance/glance-registry.conf.bak &gt; /etc/glance/glance-registry.conf

#修改配置文件参数
openstack-config --set /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:GLANCE_DBPASS@ct/glance
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken www_authenticate_uri http://ct:5000
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_url http://ct:5000
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken memcached_servers ct:11211
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken auth_type password
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_domain_name Default
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken user_domain_name Default
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken project_name service
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken username glance
openstack-config --set /etc/glance/glance-registry.conf keystone_authtoken password GLANCE_PASS
openstack-config --set /etc/glance/glance-registry.conf paste_deploy flavor keystone
openstack-config --set /etc/glance/glance-registry.conf glance_store stores file,http
openstack-config --set /etc/glance/glance-registry.conf glance_store default_store file
openstack-config --set /etc/glance/glance-registry.conf glance_store filesystem_store_datadir /var/lib/glance/images/
</code></pre> 
<ul><li>初始化glance数据库，生成相关表结构；（不管有多少个controler，只需要初始化一次即可）</li></ul> 
<pre><code class="hljs">su -s /bin/sh -c "glance-manage db_sync" glance
</code></pre> 
<ul><li>开启glance服务（此处开启之后会生成存放镜像的目录/var/lib/glance/image）</li></ul> 
<pre><code class="hljs">[root@ct ~]# systemctl enable openstack-glance-api.service
[root@ct ~]# systemctl start openstack-glance-api.service
</code></pre> 
<ul><li>查看端口（也可以使用lsof -i:9292 ）</li></ul> 
<pre><code class="hljs">[root@ct ~]# netstat -natp | grep 9292
tcp        0      0 0.0.0.0:9292            0.0.0.0:*               LISTEN      33846/python2       
</code></pre> 
<ul><li>赋予openstack-glance-api.service服务对存储设备的可写权限（-h：值对符号连接/软链接的文件修改) <pre><code class="hljs">[root@ct ~]# chown -hR glance:glance /var/lib/glance/
</code></pre> <p></p> </li><li>镜像导入<br> 先上传cirros镜像到控制节点的/root，然后导入glance，最后查看是否创建成功 <pre><code class="hljs">[root@ct ~]# openstack image create --file cirros-0.3.5-x86_64-disk.img --disk-format qcow2 --container-format bare --public cirros
</code></pre> <p></p> </li><li>查看镜像的两种方式 <pre><code class="hljs">[root@ct ~]# glance image-list
+--------------------------------------+--------+
| ID                                   | Name   |
+--------------------------------------+--------+
| 238703c7-8128-4284-aed8-65c1f683a700 | cirros |
+--------------------------------------+--------+
</code></pre> <pre><code class="hljs">[root@ct ~]# openstack image list
+--------------------------------------+--------+--------+
| ID                                   | Name   | Status |
+--------------------------------------+--------+--------+
| 238703c7-8128-4284-aed8-65c1f683a700 | cirros | active |
+--------------------------------------+--------+--------+
</code></pre> <p></p> </li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b0c72c192cc5f685e8ddd68f41c4d31b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何使视频video自动播放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fad56c273328571ae5d21d2a082ea477/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">图形系统之Wayland基础</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>