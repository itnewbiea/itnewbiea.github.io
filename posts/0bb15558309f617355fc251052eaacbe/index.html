<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>STM32的以太网外设&#43;PHY（LAN8720）使用详解（6）：以太网数据接收及发送 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="STM32的以太网外设&#43;PHY（LAN8720）使用详解（6）：以太网数据接收及发送" />
<meta property="og:description" content="0 工具准备 1.野火 stm32f407霸天虎开发板 2.LAN8720数据手册 3.STM32F4xx中文参考手册 1 以太网数据接收及发送 1.1 以太网数据接收（轮询） 1.1.1 检查是否接收到一帧完整报文 使用轮询的方式接收以太网数据是一种简单但是效率低下的方法，为了保证及时处理以太网数据我们需要在主循环内高频轮询是否接收到了以太网数据。轮询的函数为ETH_CheckFrameReceived，内容如下：
uint32_t ETH_CheckFrameReceived(void) { /* check if last segment */ if(((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_OWN) == (uint32_t)RESET) &amp;&amp; ((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_LS) != (uint32_t)RESET)) { DMA_RX_FRAME_infos-&gt;Seg_Count&#43;&#43;; if (DMA_RX_FRAME_infos-&gt;Seg_Count == 1) { DMA_RX_FRAME_infos-&gt;FS_Rx_Desc = DMARxDescToGet; } DMA_RX_FRAME_infos-&gt;LS_Rx_Desc = DMARxDescToGet; return 1; } /* check if first segment */ else if(((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_OWN) == (uint32_t)RESET) &amp;&amp; ((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_FS) != (uint32_t)RESET)&amp;&amp; ((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_LS) == (uint32_t)RESET)) { DMA_RX_FRAME_infos-&gt;FS_Rx_Desc = DMARxDescToGet; DMA_RX_FRAME_infos-&gt;LS_Rx_Desc = NULL; DMA_RX_FRAME_infos-&gt;Seg_Count = 1; DMARxDescToGet = (ETH_DMADESCTypeDef*) (DMARxDescToGet-&gt;Buffer2NextDescAddr); } /* check if intermediate segment */ else if(((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_OWN) == (uint32_t)RESET) &amp;&amp; ((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_FS) == (uint32_t)RESET)&amp;&amp; ((DMARxDescToGet-&gt;Status &amp; ETH_DMARxDesc_LS) == (uint32_t)RESET)) { (DMA_RX_FRAME_infos-&gt;Seg_Count) &#43;&#43;; DMARxDescToGet = (ETH_DMADESCTypeDef*) (DMARxDescToGet-&gt;Buffer2NextDescAddr); } return 0; } 当以太网帧大于我们设置的DMA描述符buffer大小时，以太网帧将会被分成若干段被存储在不同的DMA描述符中，DMA描述符使用接收描述符字0来表示当前DMA描述符是第一个描述符或最后一个描述符或中间描述符：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0bb15558309f617355fc251052eaacbe/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-22T20:08:56+08:00" />
<meta property="article:modified_time" content="2023-12-22T20:08:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">STM32的以太网外设&#43;PHY（LAN8720）使用详解（6）：以太网数据接收及发送</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="0__0"></a>0 工具准备</h2> 
<pre><code class="prism language-c"><span class="token number">1.</span>野火 stm32f407霸天虎开发板
<span class="token number">2.L</span>AN8720数据手册
<span class="token number">3.</span>STM32F4xx中文参考手册
</code></pre> 
<h2><a id="1__7"></a>1 以太网数据接收及发送</h2> 
<h3><a id="11__8"></a>1.1 以太网数据接收（轮询）</h3> 
<h4><a id="111__9"></a>1.1.1 检查是否接收到一帧完整报文</h4> 
<p>使用轮询的方式接收以太网数据是一种简单但是效率低下的方法，为了保证及时处理以太网数据我们需要在主循环内高频轮询是否接收到了以太网数据。轮询的函数为ETH_CheckFrameReceived，内容如下：</p> 
<pre><code class="prism language-c"><span class="token class-name">uint32_t</span> <span class="token function">ETH_CheckFrameReceived</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token comment">/* check if last segment */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_OWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
     <span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_LS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">{<!-- --></span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>FS_Rx_Desc <span class="token operator">=</span> DMARxDescToGet<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>LS_Rx_Desc <span class="token operator">=</span> DMARxDescToGet<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* check if first segment */</span>
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_OWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_FS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_LS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>FS_Rx_Desc <span class="token operator">=</span> DMARxDescToGet<span class="token punctuation">;</span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>LS_Rx_Desc <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>   
    DMARxDescToGet <span class="token operator">=</span> <span class="token punctuation">(</span>ETH_DMADESCTypeDef<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* check if intermediate segment */</span> 
  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_OWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
          <span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_FS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMARxDesc_LS<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">(</span>DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count<span class="token punctuation">)</span> <span class="token operator">++</span><span class="token punctuation">;</span>
    DMARxDescToGet <span class="token operator">=</span> <span class="token punctuation">(</span>ETH_DMADESCTypeDef<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>DMARxDescToGet<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> 
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当以太网帧大于我们设置的DMA描述符buffer大小时，以太网帧将会被分成若干段被存储在不同的DMA描述符中，DMA描述符使用接收描述符字0来表示当前DMA描述符是第一个描述符或最后一个描述符或中间描述符：<br> <img src="https://images2.imgbox.com/f8/9e/JQY7J5bt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a2/35/e8yokaMk_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2a/33/YyY4pT3O_o.png" alt="在这里插入图片描述"><br> 当DMA描述符是首个描述符时将段计数置为1，保存首个描述符到FS_Rx_Desc同时将Rx描述符指向下一个DMA描述符；当DMA描述符是中间描述符时将段计数+1，同时将Rx描述符指向下一个DMA描述符；当DMA描述符是最后一个描述符时将段计数+1，保存最后一个描述符到LS_Rx_Desc（如果段计数为1也就是一个完整的以太网帧被保存在一个DMA描述符内，保存最后一个描述符到FS_Rx_Desc）同时返回1表明接收到了一帧完整以太网数据。</p> 
<h4><a id="112__55"></a>1.1.2 读取一帧完整报文</h4> 
<p>在我们检查到接收了一帧完整报文后，就可以调用low_level_input函数读取该帧报文。</p> 
<pre><code class="prism language-c">FrameTypeDef <span class="token function">low_level_input</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> len<span class="token punctuation">;</span>
    FrameTypeDef frame<span class="token punctuation">;</span>
    u8 <span class="token operator">*</span>buffer<span class="token punctuation">;</span>
    __IO ETH_DMADESCTypeDef <span class="token operator">*</span>DMARxDesc<span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> bufferoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> payloadoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> byteslefttocopy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* get received frame 接收报文 */</span>
    frame <span class="token operator">=</span> <span class="token function">ETH_Get_Received_Frame</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Obtain the size of the packet and put it into the "len" variable. 获取数据包大小 */</span>
    len <span class="token operator">=</span> frame<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    buffer <span class="token operator">=</span> <span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>frame<span class="token punctuation">.</span>buffer<span class="token punctuation">;</span>

    <span class="token comment">/* Release descriptors to DMA 将描述符释放到DMA */</span>
    DMARxDesc <span class="token operator">=</span> frame<span class="token punctuation">.</span>descriptor<span class="token punctuation">;</span>

    <span class="token comment">/* Set Own bit in Rx descriptors: gives the buffers back to DMA */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        DMARxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">=</span> ETH_DMARxDesc_OWN<span class="token punctuation">;</span>
        DMARxDesc <span class="token operator">=</span> <span class="token punctuation">(</span>ETH_DMADESCTypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMARxDesc<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* Clear Segment_Count */</span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token comment">/* When Rx Buffer unavailable flag is set: clear it and resume reception */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">&amp;</span> ETH_DMASR_RBUS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Clear RBUS ETHERNET DMA flag */</span>
        ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">=</span> ETH_DMASR_RBUS<span class="token punctuation">;</span>
        <span class="token comment">/* Resume DMA reception 恢复DMA接收 */</span>
        ETH<span class="token operator">-&gt;</span>DMARPDR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> frame<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数操作流程如下:<br> （1）获取报文长度<br> 调用ETH_Get_Received_Frame函数会返回以太网帧最后一个描述符存储的报文长度和buffer地址。我们可以将DMA描述符buffer数据拷贝到协议栈buffer中。<br> （2）释放DMA控制权给DMA<br> 在我们拷贝完了DMA描述符的buffer数据后需要释放DMA控制权，相关语句如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        DMARxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">=</span> ETH_DMARxDesc_OWN<span class="token punctuation">;</span>
        DMARxDesc <span class="token operator">=</span> <span class="token punctuation">(</span>ETH_DMADESCTypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMARxDesc<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    DMA_RX_FRAME_infos<span class="token operator">-&gt;</span>Seg_Count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
</code></pre> 
<p>上述语句将首个DMA描述符到最后一个DMA描述符的控制权交给DMA，最后清空段计数。<br> （3）检查DMA状态寄存器<br> 涉及到寄存器如下：<br> <img src="https://images2.imgbox.com/bc/20/GIw9zvNS_o.png" alt="在这里插入图片描述"><br> 相关bit描述：<br> <img src="https://images2.imgbox.com/8f/25/PnspGPSC_o.png" alt="在这里插入图片描述"><br> 这里检查位7是否为1，如果为1则设置DMASR寄存器的值为0x00000080，然后恢复DMA接收。相关语句如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">&amp;</span> ETH_DMASR_RBUS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Clear RBUS ETHERNET DMA flag */</span>
        ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">=</span> ETH_DMASR_RBUS<span class="token punctuation">;</span>
        <span class="token comment">/* Resume DMA reception 恢复DMA接收 */</span>
        ETH<span class="token operator">-&gt;</span>DMARPDR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>DMARPDR寄存器描述如下：<br> <img src="https://images2.imgbox.com/77/6e/dXJM1ktq_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12__135"></a>1.2 以太网数据接收（中断）</h3> 
<p>在主循环或者线程内使用轮询的方式判断是否接收到以太网报文效率比较低下，而且容易出现未及时处理接收报文导致溢出的问题。因此，建议使能ETH接收中断，在中断内释放信号量然后处理以太网数据。<br> 打开ETH接收中断语句如下：</p> 
<pre><code class="prism language-c">NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannel <span class="token operator">=</span> ETH_IRQn<span class="token punctuation">;</span>  <span class="token comment">// 以太网中断</span>
NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelPreemptionPriority <span class="token operator">=</span> <span class="token number">0X00</span><span class="token punctuation">;</span> <span class="token comment">// 中断寄存器组2最高优先级</span>
NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelSubPriority <span class="token operator">=</span> <span class="token number">0X00</span><span class="token punctuation">;</span>
NVIC_InitStructure<span class="token punctuation">.</span>NVIC_IRQChannelCmd <span class="token operator">=</span> ENABLE<span class="token punctuation">;</span>
<span class="token function">NVIC_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>NVIC_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">ETH_DMAClearITPendingBit</span><span class="token punctuation">(</span>ETH_DMA_IT_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">ETH_DMAClearITPendingBit</span><span class="token punctuation">(</span>ETH_DMA_IT_NIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>EthStatus <span class="token operator">==</span> ETH_SUCCESS<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* 使能接收中断 */</span>
    <span class="token function">ETH_DMAITConfig</span><span class="token punctuation">(</span>ETH_DMA_IT_NIS <span class="token operator">|</span> ETH_DMA_IT_R<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>使能接收中断涉及的寄存器如下：</p> 
<p><img src="https://images2.imgbox.com/de/e6/oNuj7OLC_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ad/d4/8Orc6Dwt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0b/09/53mB9B3v_o.png" alt="在这里插入图片描述"><br> 接收中断服务函数如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">ETH_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i<span class="token punctuation">;</span>
    FrameTypeDef frame<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">ETH_CheckFrameReceived</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// 检测是否收到数据包</span>
    <span class="token punctuation">{<!-- --></span>
        frame <span class="token operator">=</span> <span class="token function">low_level_input</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Len : %d\r\n"</span><span class="token punctuation">,</span> frame<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> frame<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%02X "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span>frame<span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">ETH_DMAClearITPendingBit</span><span class="token punctuation">(</span>ETH_DMA_IT_R<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">ETH_DMAClearITPendingBit</span><span class="token punctuation">(</span>ETH_DMA_IT_NIS<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>（1）特别要注意我们这里使用的是while而不是if，因为每次触发接收中断可能接收到了多个报文，我们应该尽快将报文全部取出，避免DMA描述符占用标志一直是CPU。<br> （2）上面的中断服务函数只是用于演示，我们直接在中断内打印接收到的报文。正常操作是释放信号量或者将接收标志置位，通知RTOS的接收线程或者裸机下的主循环内的回调函数处理。</p> 
<h3><a id="13__184"></a>1.3 以太网数据发送</h3> 
<pre><code class="prism language-c"><span class="token class-name">uint8_t</span> <span class="token function">low_level_output</span><span class="token punctuation">(</span><span class="token class-name">uint8_t</span> <span class="token operator">*</span>sendBuffer<span class="token punctuation">,</span> <span class="token class-name">uint16_t</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token class-name">uint8_t</span> errval<span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">pbuf</span> <span class="token operator">*</span>q<span class="token punctuation">;</span>
    u8 <span class="token operator">*</span>buffer <span class="token operator">=</span> <span class="token punctuation">(</span>u8 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMATxDescToSet<span class="token operator">-&gt;</span>Buffer1Addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    __IO ETH_DMADESCTypeDef <span class="token operator">*</span>DmaTxDesc<span class="token punctuation">;</span>
    <span class="token class-name">uint16_t</span> framelength <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> bufferoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> byteslefttocopy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token class-name">uint32_t</span> payloadoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    DmaTxDesc <span class="token operator">=</span> DMATxDescToSet<span class="token punctuation">;</span>
    bufferoffset <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>buffer<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">u8_t</span> <span class="token operator">*</span><span class="token punctuation">)</span>sendBuffer<span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/* Prepare transmit descriptors to give to DMA 准备发送描述符给DMA使用 */</span>
    <span class="token function">ETH_Prepare_Transmit_Descriptors</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>

    errval <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

error<span class="token operator">:</span>
    errval <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token comment">/* When Transmit Underflow flag is set, clear it and issue a Transmit Poll Demand to resume transmission */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">&amp;</span> ETH_DMASR_TUS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span><span class="token class-name">uint32_t</span><span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Clear TUS ETHERNET DMA flag */</span>
        ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">=</span> ETH_DMASR_TUS<span class="token punctuation">;</span>

        <span class="token comment">/* Resume DMA transmission*/</span>
        ETH<span class="token operator">-&gt;</span>DMATPDR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> errval<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>相比起接收，以太网数据发送则显得比较简单，因为DMA描述符的主动操作方在CPU这一侧。上述函数的操作如下：<br> （1）将待发送数据拷贝到当前跟踪的发送DMA描述符<br> （2）将跟踪的发送DMA描述符控制权交给DMA，设置DMA描述符相关状态：</p> 
<pre><code class="prism language-c"><span class="token class-name">uint32_t</span> <span class="token function">ETH_Prepare_Transmit_Descriptors</span><span class="token punctuation">(</span>u16 FrameLength<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>   
  <span class="token class-name">uint32_t</span> buf_count <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> size<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  __IO ETH_DMADESCTypeDef <span class="token operator">*</span>DMATxDesc<span class="token punctuation">;</span>

  <span class="token comment">/* Check if the descriptor is owned by the ETHERNET DMA (when set) or CPU (when reset) */</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DMATxDescToSet<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;</span> ETH_DMATxDesc_OWN<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>  
    <span class="token comment">/* Return ERROR: OWN bit set */</span>
    <span class="token keyword">return</span> ETH_ERROR<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  DMATxDesc <span class="token operator">=</span> DMATxDescToSet<span class="token punctuation">;</span>
  
  <span class="token keyword">if</span> <span class="token punctuation">(</span>FrameLength <span class="token operator">&gt;</span> ETH_TX_BUF_SIZE<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    buf_count <span class="token operator">=</span> FrameLength<span class="token operator">/</span>ETH_TX_BUF_SIZE<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>FrameLength<span class="token operator">%</span>ETH_TX_BUF_SIZE<span class="token punctuation">)</span> buf_count<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span> buf_count <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>buf_count <span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/*set LAST and FIRST segment */</span>
    DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span>ETH_DMATxDesc_FS<span class="token operator">|</span>ETH_DMATxDesc_LS<span class="token punctuation">;</span>
    <span class="token comment">/* Set frame size */</span>
    DMATxDesc<span class="token operator">-&gt;</span>ControlBufferSize <span class="token operator">=</span> <span class="token punctuation">(</span>FrameLength <span class="token operator">&amp;</span> ETH_DMATxDesc_TBS1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/* Set Own bit of the Tx descriptor Status: gives the buffer back to ETHERNET DMA */</span>
    DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span> ETH_DMATxDesc_OWN<span class="token punctuation">;</span>
    DMATxDesc<span class="token operator">=</span> <span class="token punctuation">(</span>ETH_DMADESCTypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMATxDesc<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">else</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span> buf_count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">/* Clear FIRST and LAST segment bits */</span>
      DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">&amp;=</span> <span class="token operator">~</span><span class="token punctuation">(</span>ETH_DMATxDesc_FS <span class="token operator">|</span> ETH_DMATxDesc_LS<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
      <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Setting the first segment bit */</span>
        DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span> ETH_DMATxDesc_FS<span class="token punctuation">;</span>  
      <span class="token punctuation">}</span>

      <span class="token comment">/* Program size */</span>
      DMATxDesc<span class="token operator">-&gt;</span>ControlBufferSize <span class="token operator">=</span> <span class="token punctuation">(</span>ETH_TX_BUF_SIZE <span class="token operator">&amp;</span> ETH_DMATxDesc_TBS1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">==</span> <span class="token punctuation">(</span>buf_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Setting the last segment bit */</span>
        DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span> ETH_DMATxDesc_LS<span class="token punctuation">;</span>
        size <span class="token operator">=</span> FrameLength <span class="token operator">-</span> <span class="token punctuation">(</span>buf_count<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span>ETH_TX_BUF_SIZE<span class="token punctuation">;</span>
        DMATxDesc<span class="token operator">-&gt;</span>ControlBufferSize <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">&amp;</span> ETH_DMATxDesc_TBS1<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">/* Set Own bit of the Tx descriptor Status: gives the buffer back to ETHERNET DMA */</span>
      DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span> ETH_DMATxDesc_OWN<span class="token punctuation">;</span>

      DMATxDesc <span class="token operator">=</span> <span class="token punctuation">(</span>ETH_DMADESCTypeDef <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>DMATxDesc<span class="token operator">-&gt;</span>Buffer2NextDescAddr<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  DMATxDescToSet <span class="token operator">=</span> DMATxDesc<span class="token punctuation">;</span>

  <span class="token comment">/* When Tx Buffer unavailable flag is set: clear it and resume transmission */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">&amp;</span> ETH_DMASR_TBUS<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>u32<span class="token punctuation">)</span>RESET<span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token comment">/* Clear TBUS ETHERNET DMA flag */</span>
    ETH<span class="token operator">-&gt;</span>DMASR <span class="token operator">=</span> ETH_DMASR_TBUS<span class="token punctuation">;</span>
    <span class="token comment">/* Resume DMA transmission*/</span>
    ETH<span class="token operator">-&gt;</span>DMATPDR <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/* Return SUCCESS */</span>
  <span class="token keyword">return</span> ETH_SUCCESS<span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre> 
<p>这个函数篇幅有点长，这里举例说一下当我们发送的以太网报文可以被一个发送DMA描述符容纳时的操作：<br> （2.1）设置发送DMA描述符的LS和FS位为1，也就是一个发送DMA描述符对应一个以太网报文：</p> 
<pre><code class="prism language-c">DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span>ETH_DMATxDesc_FS<span class="token operator">|</span>ETH_DMATxDesc_LS<span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/ae/35/dsrD4BnS_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ca/f7/eDXe5Uq1_o.png" alt="在这里插入图片描述"><br> （2.2）设置报文长度：</p> 
<pre><code class="prism language-c">DMATxDesc<span class="token operator">-&gt;</span>ControlBufferSize <span class="token operator">=</span> <span class="token punctuation">(</span>FrameLength <span class="token operator">&amp;</span> ETH_DMATxDesc_TBS1<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3f/0c/UsSLDmol_o.png" alt="在这里插入图片描述"><br> （2.3）设置发送DMA描述符控制权为DMA</p> 
<pre><code class="prism language-c">DMATxDesc<span class="token operator">-&gt;</span>Status <span class="token operator">|=</span> ETH_DMATxDesc_OWN<span class="token punctuation">)</span>
</code></pre> 
<p>（2.4）将跟踪发送DMA描述符指向下一个发送DMA描述符<br> （3）当Tx Buffer不可用标志被设置时，清除该标志并恢复传输<br> <img src="https://images2.imgbox.com/74/89/SXxVBOjD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/83/55/alz41Gnn_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/2a/10/fiWeG0qT_o.png" alt="在这里插入图片描述"><br> 这里的DMA就相当于头指针，而CPU则相当于尾指针。</p> 
<h2><a id="2__332"></a>2 总结</h2> 
<p>（1）以太网数据接收可以使用轮询和中断2种方式，建议使用中断方式在中断内释放信号量通知以太网报文接收线程进行处理<br> （2）发送DMA描述符运作方式类似于环形buffer，CPU是尾指针，DMA是头指针；接收DMA描述符运作方式类似于环形buffer，CPU是头指针，DMA是尾指针<br> （3）在接收以太网数据时一定要及时取出DMA描述符中的数据，将控制权交还给DMA，避免报文阻塞<br> （4）在发送以太网数据时一定要及时清除Tx Buffer标志并恢复发送</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e1b1b352a8e23055b3cea79315072d17/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32的以太网外设&#43;PHY（LAN8720）使用详解（5）：MAC及DMA配置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5c40b243222e04e648b2d78ae4e01abe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Apollo定位之NDT定位实践</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>