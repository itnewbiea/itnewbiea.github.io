<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>直播与云聊天 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="直播与云聊天" />
<meta property="og:description" content="前端直播功能开发总结 最近公司要开发一个直播功能，自己也是研究了很久，这里总结一下：
这里直播还是用的第三方的集成：视频用的是七牛云的集成，聊天用的是融云。
一、直播功能(七牛云)
下面是直播的快速入门文档：
https://developer.qiniu.com/pili/manual/1221/the-console-quick-start
这里前端功能没什么可说的，文档中都写的很详细。
我这里用的前端播放器是videojs,引入相关的js和css，只需要简单的设置就可以：
var myPlayer = videojs(&#39;demo-video&#39;,{
bigPlayButton : true,
textTrackDisplay : true,
posterImage: true,
errorDisplay : true,
controlBar : true
},()=&gt;{
})
二、聊天室功能(融云)
融云这个就比较坑了，文档和demo对于web开发者很不友好，开发的时候很多接口还有问题。下面是心得：
聊天室对于pc端应当有两个界面，用户客户端观看界面和超级管理员的管理界面
客户端观看界面：
1 先引入相关文件
融云的服务器相关js：
&lt;script src=&#34;http://cdn.ronghub.com/RongIMLib-2.3.2.js&#34;&gt;&lt;/script&gt;
chatroom web相关js文件---下载地址：
http://downloads.rongcloud.cn/chatroom-1.0.0.zip
需要用到其中的 message-types.js 文件
2 链接融云服务器
这时候就需要后台的小伙伴协助，通过server 获取 token,详见 https://www.rongcloud.cn/docs/web.html#get_token
以及在融云上注册得到的 appkey，如下：
appInfo:{
appKey : &#34;8tnym1br624m7&#34;,
token : &#34;ZThhLI1Xa1BX5EMREAdArWSH6ouuI8NT/fNmMkzF&#43;4IOKIoFvbsi6JnH8QmnSltLkCcsK8vOgKl3IZgfbxFiWg==&#34;
},
通过此次进入的直播间的 房间号或者id 请求后台接口获得该融云聊天室的信息：
chatRoomInfo:{
&#34;chatRoomId&#34; : &#34;chartroom-008&#34;,
&#34;count&#34; : 0" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/86287d70ed5a5f731926bdd89cf0da1b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-11T14:18:24+08:00" />
<meta property="article:modified_time" content="2020-04-11T14:18:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">直播与云聊天</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2><a href="https://www.cnblogs.com/liuxin-673855200/p/9948100.html" rel="nofollow" id="cb_post_title_url">前端直播功能开发总结</a></h2> 
<p>最近公司要开发一个直播功能，自己也是研究了很久，这里总结一下：<br>  </p> 
<p>这里直播还是用的第三方的集成：视频用的是七牛云的集成，聊天用的是融云。</p> 
<p>一、直播功能(七牛云)</p> 
<p>下面是直播的快速入门文档：</p> 
<p>https://developer.qiniu.com/pili/manual/1221/the-console-quick-start</p> 
<p>这里前端功能没什么可说的，文档中都写的很详细。</p> 
<p>我这里用的前端播放器是videojs,引入相关的js和css，只需要简单的设置就可以：</p> 
<p>var myPlayer = videojs('demo-video',{<!-- --></p> 
<p>bigPlayButton : true,</p> 
<p>textTrackDisplay : true,</p> 
<p>posterImage: true,</p> 
<p>errorDisplay : true,</p> 
<p>controlBar : true</p> 
<p>},()=&gt;{<!-- --></p> 
<p> </p> 
<p>})</p> 
<p>二、聊天室功能(融云)</p> 
<p>融云这个就比较坑了，文档和demo对于web开发者很不友好，开发的时候很多接口还有问题。下面是心得：</p> 
<p>聊天室对于pc端应当有两个界面，用户客户端观看界面和超级管理员的管理界面</p> 
<p> </p> 
<p>客户端观看界面：</p> 
<p>1 先引入相关文件</p> 
<p>融云的服务器相关js：</p> 
<p>&lt;script src="http://cdn.ronghub.com/RongIMLib-2.3.2.js"&gt;&lt;/script&gt;</p> 
<p>chatroom  web相关js文件---下载地址：</p> 
<p>http://downloads.rongcloud.cn/chatroom-1.0.0.zip</p> 
<p>需要用到其中的  message-types.js 文件</p> 
<p>2 链接融云服务器</p> 
<p> </p> 
<p>这时候就需要后台的小伙伴协助，通过server 获取 <strong> token,</strong>详见 https://www.rongcloud.cn/docs/web.html#get_token</p> 
<p>以及在融云上注册得到的 <strong>appkey，</strong>如下：</p> 
<p>appInfo:{<!-- --></p> 
<p>appKey : "8tnym1br624m7",</p> 
<p>token : "ZThhLI1Xa1BX5EMREAdArWSH6ouuI8NT/fNmMkzF+4IOKIoFvbsi6JnH8QmnSltLkCcsK8vOgKl3IZgfbxFiWg=="</p> 
<p>},</p> 
<p>通过此次进入的直播间的 <strong>房间号或者id</strong>  请求后台接口获得该融云聊天室的信息：</p> 
<p>chatRoomInfo:{<!-- --></p> 
<p>"chatRoomId" : "chartroom-008",</p> 
<p>"count" : 0</p> 
<p>},</p> 
<p> </p> 
<p>然后开始链接融云服务器</p> 
<p>//首先需要初始化 init</p> 
<p>RongIMLib.RongIMClient.init(appInfo.appKey);</p> 
<p> </p> 
<p>//设置监听</p> 
<p>RongIMClient.setConnectionStatusListener({<!-- --></p> 
<p>onChanged: function (status) {<!-- --></p> 
<p>switch (status) {<!-- --></p> 
<p>case RongIMLib.ConnectionStatus.CONNECTED:</p> 
<p>console.log('链接成功');</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionStatus.CONNECTING:</p> 
<p>console.log('正在链接');</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionStatus.DISCONNECTED:</p> 
<p>console.log('断开连接');</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionStatus.KICKED_OFFLINE_BY_OTHER_CLIENT:</p> 
<p>console.log('其他设备登录');</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionStatus.DOMAIN_INCORRECT:</p> 
<p>console.log('域名不正确');</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionStatus.NETWORK_UNAVAILABLE:</p> 
<p>console.log('网络不可用');</p> 
<p>break;</p> 
<p>}</p> 
<p>}});</p> 
<p> </p> 
<p>// 消息监听器</p> 
<p>RongIMClient.setOnReceiveMessageListener({<!-- --></p> 
<p>// 接收到的消息</p> 
<p>onReceived: function (message) {<!-- --></p> 
<p>console.log(message)</p> 
<p>　　//这里可以根据接受到messageType。来判断展现方式或者进行相关处理　　</p> 
<p>}</p> 
<p>});</p> 
<p>//链接及重新链接服务器</p> 
<p>RongIMClient.connect(this.appInfo.token, {<!-- --></p> 
<p>onSuccess: function(userId) {<!-- --></p> 
<p>console.log("Connect successfully." + userId);</p> 
<p>},</p> 
<p>onTokenIncorrect: function() {<!-- --></p> 
<p>console.log('token无效');</p> 
<p>},</p> 
<p>onError:function(errorCode){<!-- --></p> 
<p>var info = '';</p> 
<p>switch (errorCode) {<!-- --></p> 
<p>case RongIMLib.ErrorCode.TIMEOUT:</p> 
<p>info = '超时';</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionState.UNACCEPTABLE_PAROTOCOL_VERSION:</p> 
<p>info = '不可接受的协议版本';</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionState.IDENTIFIER_REJECTED:</p> 
<p>info = 'appkey不正确';</p> 
<p>break;</p> 
<p>case RongIMLib.ConnectionState.SERVER_UNAVAILABLE:</p> 
<p>info = '服务器不可用';</p> 
<p>break;</p> 
<p>}</p> 
<p>console.log(errorCode);</p> 
<p>}</p> 
<p>});</p> 
<p> </p> 
<p>var callback = {<!-- --></p> 
<p>onSuccess: function(userId) {<!-- --></p> 
<p>console.log("Reconnect successfully." + userId);</p> 
<p>},</p> 
<p>onTokenIncorrect: function() {<!-- --></p> 
<p>console.log('token无效');</p> 
<p>},</p> 
<p>onError:function(errorCode){<!-- --></p> 
<p>console.log(errorcode);</p> 
<p>}</p> 
<p>};</p> 
<p>var config = {<!-- --></p> 
<p>// 默认 false, true 启用自动重连，启用则为必选参数</p> 
<p>auto: true,</p> 
<p>// 重试频率 [100, 1000, 3000, 6000, 10000, 18000] 单位为毫秒，可选</p> 
<p>url: 'cdn.ronghub.com/RongIMLib-2.2.6.min.js',</p> 
<p>// 网络嗅探地址 [http(s)://]cdn.ronghub.com/RongIMLib-2.2.6.min.js 可选</p> 
<p>rate: [100, 1000, 3000, 6000, 10000]</p> 
<p>};</p> 
<p>RongIMClient.reconnect(callback, config);</p> 
<p>3.消息处理</p> 
<p>通常在监听消息这步可以接受到message，就算成功了</p> 
<p>一般的message通常是以下格式</p> 
<p>{<!-- --></p> 
<p>content: </p> 
<p>　　{<!-- --></p> 
<p>　　messageName: "TextMessage", </p> 
<p>　　content: "123",</p> 
<p>　　extra: "",</p> 
<p>　　 user: {<!-- --></p> 
<p>　　　　"id" : “”</p> 
<p>　　　　"name" :“”</p> 
<p>　　　　"portrait" : “”</p> 
<p>　　}</p> 
<p>}</p> 
<p>conversationType: 4</p> 
<p>extra: undefined</p> 
<p>isLocalMessage: undefined</p> 
<p>messageDirection: 2</p> 
<p>messageId: "4_32560"</p> 
<p>messageType: "TextMessage"</p> 
<p>messageUId: "B70T-8S90-IN8G-01JT"</p> 
<p>objectName: "RC:TxtMsg"</p> 
<p>offLineMessage: false</p> 
<p>receiptResponse: undefined</p> 
<p>receivedStatus: 1</p> 
<p>receivedTime: 1542016057921</p> 
<p>senderUserId: "391"</p> 
<p>sentStatus: undefined</p> 
<p>sentTime: 1542016058498</p> 
<p>targetId: "41"</p> 
<p>}</p> 
<p>这里一般要用到content 和 messageType两个字段<br>  messagetype有种不同的分类，这里可以根据 结果的不同进行处理</p> 
<p> </p> 
<p><strong>超级管理员的控制界面</strong></p> 
<p>这里超级管理员的控制界面前面跟客户端基本一样，在操作这里多了开播通知，封禁，踢人等权限：</p> 
<p> </p> 
<p>融云的通知消息类型：</p> 
<p><img alt="" src="https://images2.imgbox.com/00/78/NzppxWvz_o.png"></p> 
<p> </p> 
<p>这里我们用 chatroomStart 作为例子：</p> 
<p>var time=1232132133   //时间戳，必填的字段，表示开播时间</p> 
<p>var chatroomMessages = RongMessageTypes.chatroom;</p> 
<p>var im = RongIMClient.getInstance();</p> 
<p>im.registerMessageTypes(chatroomMessages);</p> 
<p>var user= {<!-- --></p> 
<p>　　　　"id" : “”</p> 
<p>　　　　"name" :“”</p> 
<p>　　　　"portrait" : “”}</p> 
<p>var ChatroomStart = RongIMClient.RegisterMessage.ChatroomStart;//chartRoomStart可根据发送消息类型的不同更换，下面的实例化也是一样</p> 
<p>var msg = new ChatroomStart({<!-- --></p> 
<p>time:time,</p> 
<p>extra:JSON.stringify(user)//这里我们在extra中以字符串的形式储存了用户信息</p> 
<p>});</p> 
<p>var chatroomType = RongIMLib.ConversationType.CHATROOM;</p> 
<p>var chatroomId = chatRoomInfo.chatRoomId;</p> 
<p>im.sendMessage(chatroomType, chatroomId, msg, {<!-- --></p> 
<p>onSuccess: function(message) {<!-- --></p> 
<p>console.log(message);</p> 
<p>console.log("直播开始")</p> 
<p>//自定义处理</p> 
<p>},</p> 
<p>onError: function(error) {<!-- --></p> 
<p>console.log(error);</p> 
<p>}</p> 
<p>});</p> 
<p> 可以参考文档： https://www.rongcloud.cn/docs/messages/chatroom/messages.html</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/168a17960551d6e68fdbd4d2705a2b11/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">易语言写到文件，文件的编码是utf-8，一般默认是ansi</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5bf1a443ba86aa5ab2b572727aabd59c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">nginx ingress最后的倔强: admission webhook</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>