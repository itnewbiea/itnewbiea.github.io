<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>《Android外部存储》 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="《Android外部存储》" />
<meta property="og:description" content="| 导语 外部存储作为开发中经常接触的一个重要系统组成，在Android历代版本中，有过许许多多重要的变更。我也曾疑惑过，为什么一个简简单单外部存储，会存在存在这么多奇奇怪怪的路径：/sdcard、/mnt/sdacrd、/storage/extSdCard、/mnt/shell/emulated/0、/storage/emulated/0、/mnt/shell/runtime/default/emulated/0…其实，这背后代表了一项项技术的成熟与发布：模拟外部存储、多用户、运行时权限…
一、各版本外部存储特性 Android 4.0
支持模拟外部存储（通过FUSE实现）
出现了主外部存储，以及二级外部存储（没有接口对外暴露）
支持MTP（Media Transfer Protocol）、PTP协议（Picture Transfer Protocol）
Android 4.1
开发者选项出现”强制应用声明读权限才可以进行读操作”的开关
Android 4.2
支持多用户，每个用户拥有独立的外部存储
Android 4.4
读操作需要声明READ_EXTERNAL_STORAGE权限
应用读写在外部存储的应用目录（/sdcard/Android/
/）不需要声明权限
增加了Context.getExternalFilesDirs() 接口，可以获取应用在主外部存储和其他二级外部存储下的files路径
引入存储访问框架（SAF，Storage Access Framework）
Android 6.0
外部存储支持动态权限管理
Adoptable Storage特性
Android 7.0
引入作用域目录访问
补充一个点：如果应用的minSdkVersion和targetSdkVersion设置成&lt;=3，系统会默认授予READ_EXTERNAL_STORAGE权限
二、部分特性讲解 1. 模拟外部存储 a. 必要性
FAT32 属于微软专利，可能存在许可和法律问题（相关文章(https://www.howtogeek.com/183766/why-microsoft-makes-5-to-15-from-every-android-device-sold/)）；
可以定制Android自己的外部存储访问规则；
为多用户做铺垫；
b. 实现原理
系统/system/bin/sdcard守护进程，使用FUSE实现类FAT格式SD卡文件系统的模拟，也就是我们经常说的内置SD卡。（详细代码可以参考：/xref/system/core/sdcard/sdcard.c）
用户空间文件系统（Filesystem in Userspace，简称FUSE）是一个面向类Unix计算机操作系统的软件接口，它使无特权的用户能够无需编辑内核代码而创建自己的文件系统。目前Linux通过内核模块对此进行支持。
sdcard守护进程模拟外部存储大致流程（Android 4.0为例）：
首先，指定/data/media目录用于模拟外部存储。该路径的owner和group一般为media_rw，这样保证只有sdcard程序或root进程能够访问该目录。
# create virtual SD card at /mnt/sdcard, based on the /data/media directory # daemon will drop to user/group system/media_rw after initializing # underlying files in /data/media will be created with user and group media_rw (1023)service sdcard /system/bin/sdcard /data/media 1023 1023 class late_start" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/be7e224b15cc5dea1f9892b198d43ead/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-06-17T20:46:09+08:00" />
<meta property="article:modified_time" content="2018-06-17T20:46:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">《Android外部存储》</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote style="margin-top:1.2em;margin-bottom:1.2em;padding:0px 1em;max-width:100%;border-left:4px solid rgb(221,221,221);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);color:rgb(119,119,119);"> 
 <p style="max-width:100%;clear:both;min-height:1em;line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">| 导语 外部存储作为开发中经常接触的一个重要系统组成，在Android历代版本中，有过许许多多重要的变更。我也曾疑惑过，为什么一个简简单单外部存储，会存在存在这么多奇奇怪怪的路径：/sdcard、/mnt/sdacrd、/storage/extSdCard、/mnt/shell/emulated/0、/storage/emulated/0、/mnt/shell/runtime/default/emulated/0…其实，这背后代表了一项项技术的成熟与发布：模拟外部存储、多用户、运行时权限…</span></p> 
</blockquote> 
<h3 style="margin-top:1.3em;margin-bottom:10px;padding:0px;font-size:1.4em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;background-color:rgb(255,255,255);border-bottom:1px solid rgb(238,238,238);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;letter-spacing:1px;">一、各版本外部存储特性</span></h3> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">Android 4.0</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">支持模拟外部存储（通过FUSE实现）</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">出现了主外部存储，以及二级外部存储（没有接口对外暴露）</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">支持MTP（Media Transfer Protocol）、PTP协议（Picture Transfer Protocol）</span></p></li></ul> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">Android 4.1</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">开发者选项出现”强制应用声明读权限才可以进行读操作”的开关</span></p></li></ul> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">Android 4.2</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">支持多用户，每个用户拥有独立的外部存储</span></p></li></ul> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">Android 4.4</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">读操作需要声明READ_EXTERNAL_STORAGE权限</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">应用读写在外部存储的应用目录（/sdcard/Android/</span></p><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">/）不需要声明权限</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">增加了</span><code style="margin:0px .15em;padding:0px .3em;max-width:100%;font-size:.85em;white-space:pre-wrap;border-width:1px;border-style:solid;border-color:rgb(234,234,234);background-color:rgb(248,248,248);"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Context.getExternalFilesDirs()</span></code><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"> 接口，可以获取应用在主外部存储和其他二级外部存储下的files路径</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">引入存储访问框架（SAF，Storage Access Framework）</span></p></li></ul> 
<p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);text-align:center;line-height:1.75em;margin-bottom:1.2em;"><img src="https://images2.imgbox.com/8e/fb/DT63R2gT_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;"><br style="margin:0px;padding:0px;max-width:100%;"></span></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">Android 6.0</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">外部存储支持动态权限管理</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Adoptable Storage特性</span></p></li></ul> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">Android 7.0</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">引入作用域目录访问</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;text-align:center;margin-bottom:1.2em;"><img src="https://images2.imgbox.com/0b/43/UjCuWoNK_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
<blockquote style="margin-top:1.2em;margin-bottom:1.2em;padding:0px 1em;max-width:100%;border-left:4px solid rgb(221,221,221);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);color:rgb(119,119,119);"> 
 <p style="max-width:100%;clear:both;min-height:1em;line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">补充一个点：如果应用的minSdkVersion和targetSdkVersion设置成&lt;=3，系统会默认授予READ_EXTERNAL_STORAGE权限</span></p> 
</blockquote> 
<h3 style="margin-top:1.3em;margin-bottom:10px;padding:0px;font-size:1.4em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;background-color:rgb(255,255,255);border-bottom:1px solid rgb(238,238,238);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;letter-spacing:1px;">二、部分特性讲解</span></h3> 
<h4 style="margin-top:1.3em;margin-bottom:10px;padding:0px;font-size:1.3em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;letter-spacing:1px;">1. 模拟外部存储</span></h4> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">a. 必要性</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">FAT32 属于微软专利，可能存在许可和法律问题（相关文章(https://www.howtogeek.com/183766/why-microsoft-makes-5-to-15-from-every-android-device-sold/)）；</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">可以定制Android自己的外部存储访问规则；</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">为多用户做铺垫；</span></p></li></ul> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">b. 实现原理</span></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">系统/system/bin/sdcard守护进程，使用FUSE实现类FAT格式SD卡文件系统的模拟，也就是我们经常说的内置SD卡。（详细代码可以参考：/xref/system/core/sdcard/sdcard.c）</span></p> 
<blockquote style="margin-top:1.2em;margin-bottom:1.2em;padding:0px 1em;max-width:100%;border-left:4px solid rgb(221,221,221);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);color:rgb(119,119,119);"> 
 <p style="max-width:100%;clear:both;min-height:1em;line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">用户空间文件系统</span>（Filesystem in Userspace，简称FUSE）是一个面向类Unix计算机操作系统的软件接口，它使无特权的用户能够无需编辑内核代码而创建自己的文件系统。目前Linux通过内核模块对此进行支持。</span></p> 
 <p style="margin-bottom:0px;max-width:100%;clear:both;min-height:1em;text-align:center;"><img src="https://images2.imgbox.com/77/26/ubR4B3yT_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
 <p style="max-width:100%;clear:both;min-height:1em;margin-bottom:1.2em;"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
</blockquote> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">sdcard守护进程模拟外部存储大致流程（Android 4.0为例）：</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">首先，指定/data/media目录用于模拟外部存储。该路径的owner和group一般为media_rw，这样保证只有sdcard程序或root进程能够访问该目录。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"># create virtual SD card at /mnt/sdcard, based on the /data/media directory # daemon will drop to user/group system/media_rw after initializing # underlying files in /data/<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">media will be created with user and group <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">media_rw</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1023</span>)</span>service sdcard /system/bin/sdcard /data/media 1023 1023    class late_start</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">sdcard守护进程启动后，打开/dev/fuse设备。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">fd = open(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/dev/fuse"</span>, O_RDWR);<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (fd &lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {    ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"cannot open fuse device (%d)\n"</span>, errno);    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>; }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">在/mnt/sdcard目录挂载fuse文件系统。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">#define MOUNT_POINT <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/sdcard"</span>... sprintf(opts, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"fd=%i,rootmode=40000,default_permissions,allow_other,"</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"user_id=%d,group_id=%d"</span>, fd, uid, gid); res = mount(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/dev/fuse"</span>, MOUNT_POINT, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"fuse"</span>, MS_NOSUID | MS_NODEV, opts);<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (res &lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {  ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"cannot mount fuse filesystem (%d)\n"</span>, errno);  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>; }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">开线程，在线程中处理文件系统事件，并将结果写回。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">void</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">handle_fuse_requests</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(struct fuse *fuse)</span></span>{    unsigned <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> req[<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">256</span> * <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1024</span> + <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">128</span>];  <br style="margin:0px;padding:0px;max-width:100%;">    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">int</span> len;  <br style="margin:0px;padding:0px;max-width:100%;">    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">for</span> (;;) {        len = read(fuse-&gt;fd, req, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">8192</span>);   <br style="margin:0px;padding:0px;max-width:100%;">       <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (len &lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {         <br style="margin:0px;padding:0px;max-width:100%;">          <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (errno == EINTR)         <br style="margin:0px;padding:0px;max-width:100%;">              <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">continue</span>;            ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"handle_fuse_requests: errno=%d\n"</span>, errno);    <br style="margin:0px;padding:0px;max-width:100%;">               <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span>;        }        handle_fuse_request(fuse, (<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">void</span>*) req, (<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">void</span>*) (req + sizeof(struct fuse_in_header)), len);    } }</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">经过上面一系列步骤，sdcard进程在/mnt/sdcard路径上创建了一个FUSE文件系统，所有对/mnt/sdcard将转为事件由sdcard守护进程处理，并对应到/data/media目录。<br style="margin:0px;padding:0px;max-width:100%;">例如，应用创建/mnt/sdcard/a文件，实际是创建/data/media/a文件。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">c. 优点</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">模拟外部存储容量和/data分区是共享的，用户数据在内外存储的分配更加自由；</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">模拟外部存储本身不可卸载，不会因为卸载导致应用访问出现问题，也减少了外部因素导致被破坏的情况；</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">所有的访问都经过sdcard守护进程，Android可以定制访问规则；</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">d. 劣势</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">性能上存在一定损失</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">e. 影响</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Android 6.0以后，由于动态权限管理的需要，会存在多个fuse挂载点，这导致inotify/FileObserver对外部存储进行文件事件监控时，会丢失事件。</span></p></li></ul> 
<blockquote style="margin-top:1.2em;margin-bottom:1.2em;padding:0px 1em;max-width:100%;border-left:4px solid rgb(221,221,221);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);color:rgb(119,119,119);"> 
 <p style="max-width:100%;clear:both;min-height:1em;line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">inotify是Linux核心子系统之一，做为文件系统的附加功能，它可监控文件系统并将异动通知应用程序。 —— 维基百科(https://zh.wikipedia.org/wiki/Inotify)</span></p> 
</blockquote> 
<h4 style="margin-top:1.3em;margin-bottom:10px;padding:0px;font-size:1.3em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;letter-spacing:1px;">2. 多用户</span></h4> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">a. 支持版本</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Android 4.2开始支持多用户，但仅限平板；</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Android 5.0开始，设备制造商可以在编译时候开启多用户模块；</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">b. 背景知识</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">绑定挂载——mount —bind</span></p></li></ul> 
<blockquote style="margin-top:1.2em;margin-bottom:1.2em;padding:0px 1em;max-width:100%;border-left:4px solid rgb(221,221,221);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);color:rgb(119,119,119);"> 
 <p style="max-width:100%;clear:both;min-height:1em;line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">MS_BIND (Linux 2.4 onward)<br style="margin:0px;padding:0px;max-width:100%;">Perform a bind mount, making a file or a directory subtree visible at another point within a file system. Bind mounts may cross file system boundaries and span chroot(2) jails. The filesystemtype and dataarguments are ignored. Up until Linux 2.6.26, mountflags was also ignored (the bind mount has the same mount options as the underlying mount point). —— mount(2) - Linux man page(https://linux.die.net/man/2/mount)</span></p> 
</blockquote> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">图例（来自https://xionchen.github.io/2016/08/25/linux-bind-mount）：</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">1) 将/home目录树bind到/mnt/backup：</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;text-align:center;margin-bottom:1.2em;"><img src="https://images2.imgbox.com/7d/34/TJjby6MN_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">2) bind完成之后，对/mnt/backup的访问将等同于对/home的访问，原/mnt/backup变为不可见。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;text-align:center;margin-bottom:1.2em;"><img src="https://images2.imgbox.com/7b/be/sERJ6aNL_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">挂载命名空间</span></p></li></ul> 
<blockquote style="margin-top:1.2em;margin-bottom:1.2em;padding:0px 1em;max-width:100%;border-left:4px solid rgb(221,221,221);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);color:rgb(119,119,119);"> 
 <p style="max-width:100%;clear:both;min-height:1em;line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Mount namespaces provide isolation of the list of mount points seen by the processes in each namespace instance. Thus, the processes in each of the mount namespace instances will see distinct single-directory hierarchies. —— mount_namespaces(7) - Linux manual page - man7.org(http://man7.org/linux/man-pages/man7/mount_namespaces.7.html)</span></p> 
</blockquote> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">通俗的讲，挂载命名空间实现了挂载点的隔离，在不同挂载命名空间的进程，看到的目录层次不同。</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">挂载传播之共享挂载、从属挂载、私有挂载</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">挂载命名空间实现了完全的隔离，但对于有些情况并不适用。例如在Linux系统上，进程A在命名空间1挂载了一张CD-ROM，这时候命名空间2因为隔离无法看到这张CD-ROM。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">为了解决这个问题，引入了挂载传播（mount propagation）。传播挂载定义了挂载点的传播类型:</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">1.共享挂载:</span>此类型的挂载点会加入一个peer group，并会在group内传播和接收挂载事件；</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">2.从属挂载:</span>此类型的挂载点会加入一个peer group，并会接收group内的挂载事件，但不传播；</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">3.共享/从属挂载:</span>上面两种类型的共存体。可以从一个peer group（此时类型为从属挂载）接收挂载事件，再传播到另一个peer group；</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">4.私有挂载:</span>此类型的挂载点没有peer group，既不传播也不接收挂载事件；</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">5.不可绑定挂载:</span>不展开讲；</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">peer group的形成条件为，一个挂载点被设置成共享挂载，并满足以下任意一种情况：</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">1.挂载点在创建新的命名空间时被复制</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">2.从该挂载点创建了一个绑定挂载</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">另外再补充下传播类型的转换：</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;text-align:center;margin-bottom:1.2em;"><img src="https://images2.imgbox.com/03/ff/9vrMga6r_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">[1] 如果一个共享挂载是peer group中仅存的挂载点，那么对它应用从属挂载将会导致它变为私有挂载。<br style="margin:0px;padding:0px;max-width:100%;">[2] 对一个非共享挂载类型的挂载点，应用从属挂载是无效的。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">背景知识讲到这里，其中挂载点的传播类型比较不好理解，但很重要，可以参考上面mount namespace的Linux Programmer’s Manual里面的例子（搜索MS_XXX example）进行学习，链接在这里(http://man7.org/linux/man-pages/man7/mount_namespaces.7.html)。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">c. 实现原理</span></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">概括多用户的外部存储隔离实现：应用进程在创建时，创建了新的挂载命名空间，然后通过绑定挂载对应用暴露当前用户的外部存储空间。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">以Android 4.2代码为例【mountEmulatedStorage(dalvik_system_Zygote.cpp)】：</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">首先获取用户id。在多用户下，用户id为应用uid/100000。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">/* * Create a private mount namespace and bind mount appropriate emulated * storage for the given user. */</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">static</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">int</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">mountEmulatedStorage</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(uid_t uid, u4 mountMode)</span> </span>{   <br style="margin:0px;padding:0px;max-width:100%;"> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// See storage config details at http://source.android.com/tech/storage/</span>    userid_t userid = multiuser_get_user_id(uid);</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">通过unshare方法创建新的挂载命名空间。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Create a second private mount namespace for our process</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (unshare(CLONE_NEWNS) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {        SLOGE(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to unshare(): %s"</span>, strerror(errno));   <br style="margin:0px;padding:0px;max-width:100%;">       <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;    }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">获取外部存储相关的环境变量。EXTERNAL_STORAGE环境变量是从旧版本沿袭下来的环境变量，记录了外部存储的传统路径。EMULATED_STORAGE_SOURCE环境变量，记录绑定挂载的源路径，注意应用是没有权限进入这个目录的。EMULATED_STORAGE_TARGET记录绑定挂载的目标路径，应用获取的外部存储路径就在这个目录下。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Create bind mounts to expose external storage</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mountMode == MOUNT_EXTERNAL_MULTIUSER            || mountMode == MOUNT_EXTERNAL_MULTIUSER_ALL) {      <br style="margin:0px;padding:0px;max-width:100%;">  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// These paths must already be created by init.rc</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">const</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span>* source = getenv(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"EMULATED_STORAGE_SOURCE"</span>);  <br style="margin:0px;padding:0px;max-width:100%;">      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">const</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span>* target = getenv(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"EMULATED_STORAGE_TARGET"</span>);  <br style="margin:0px;padding:0px;max-width:100%;">      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">const</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span>* legacy = getenv(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"EXTERNAL_STORAGE"</span>);  <br style="margin:0px;padding:0px;max-width:100%;">      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (source == NULL || target == NULL || legacy == NULL) {            SLOGE(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Storage environment undefined; unable to provide external storage"</span>);     <br style="margin:0px;padding:0px;max-width:100%;">             <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;        }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">准备挂载路径并进行绑定挂载。这里看mountMode为MOUNT_EXTERNAL_MULTIUSER时的执行分支，/mnt/shell/emulated/0将被绑定到/storage/emulated/0。如果是第二个用户，则是/mnt/shell/emulated/1绑定到/storage/emulated/1，数字就是用户id。注意这里是新的挂载命名空间，所以只有该应用看得到/storage/emulated/0下的绑定挂载，从adb shell下是看到的只能是个空目录。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Prepare source paths</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> source_user[PATH_MAX];  <br style="margin:0px;padding:0px;max-width:100%;">      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> source_obb[PATH_MAX];   <br style="margin:0px;padding:0px;max-width:100%;">           <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> target_user[PATH_MAX]; <br style="margin:0px;padding:0px;max-width:100%;">                  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// /mnt/shell/emulated/0</span>        snprintf(source_user, PATH_MAX, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"%s/%d"</span>, source, userid);    <br style="margin:0px;padding:0px;max-width:100%;">               <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// /mnt/shell/emulated/obb</span>        snprintf(source_obb, PATH_MAX, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"%s/obb"</span>, source);    <br style="margin:0px;padding:0px;max-width:100%;">               <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// /storage/emulated/0</span>        snprintf(target_user, PATH_MAX, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"%s/%d"</span>, target, userid);  <br style="margin:0px;padding:0px;max-width:100%;">                 <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (fs_prepare_dir(source_user, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0000</span>, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>                || fs_prepare_dir(source_obb, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0000</span>, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>                || fs_prepare_dir(target_user, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0000</span>, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {    <br style="margin:0px;padding:0px;max-width:100%;">                         <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;        }      <br style="margin:0px;padding:0px;max-width:100%;">             <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mountMode == MOUNT_EXTERNAL_MULTIUSER_ALL) {          <br style="margin:0px;padding:0px;max-width:100%;">               <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Mount entire external storage tree for all users</span>            <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mount(source, target, NULL, MS_BIND, NULL) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {<!-- --><br style="margin:0px;padding:0px;max-width:100%;">                               SLOGE(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to mount %s to %s: %s"</span>, source, target, strerror(errno));         <br style="margin:0px;padding:0px;max-width:100%;">                                      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;            }        } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">else</span> {            <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Only mount user-specific external storage</span>            <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mount(source_user, target_user, NULL, MS_BIND, NULL) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {                SLOGE(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to mount %s to %s: %s"</span>, source_user, target_user, strerror(errno));          <br style="margin:0px;padding:0px;max-width:100%;">                                            <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;            }        }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">为了兼容以前的版本，将用户的外部存储路径绑定到EXTERNAL_STORAGE环境变量指定的路径。</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">     ...        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Finally, mount user-specific path into place for legacy users</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mount(target_user, legacy, NULL, MS_BIND | MS_REC, NULL) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {            SLOGE(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to mount %s to %s: %s"</span>, target_user, legacy, strerror(errno));  <br style="margin:0px;padding:0px;max-width:100%;">               <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;        }        ...</span></p> 
<h4 style="margin-top:1.3em;margin-bottom:10px;padding:0px;font-size:1.3em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;letter-spacing:1px;">3. 动态权限管理</span></h4> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">a.背景</span></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">Android 6.0引入了运行时权限，允许用户对危险权限进行动态授权，这部分权限包含外部存储访问权限。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">b.实现原理</span></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">外部存储访问权限的动态授权，是利用FUSE和挂载命名空间这两个技术配合实现。<br style="margin:0px;padding:0px;max-width:100%;">通过下面这个提交记录(https://android.googlesource.com/platform/system/core/+/f38f29c87d97cea45d04b783bddbd969234b1030%5E%21/#F1)，我们可以很清楚的了解整个实现。</span></p> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">    Let's reinvent storage, yet again! Now that we're treating storage as a runtime permission, we need to grant read/write access without killing the app.  This is really tricky, since we had been using GIDs for access control, and they're set in stone once Zygote drops privileges. The only thing left that can change dynamically is the filesystem itself, so let's do that.  This means changing the FUSE daemon to present itself as three different views: /mnt/runtime_default/foo - view for apps with no access /mnt/runtime_read/foo - view for apps with read access /mnt/runtime_write/foo - view for apps with write access There is still a single location for all the backing files, and filesystem permissions are derived the same way for each view, but the file modes are masked off differently for each mountpoint. During Zygote fork, it wires up the appropriate storage access into an isolated mount namespace based on the current app permissions.  When the app is granted permissions dynamically at runtime, the system asks vold to jump into the existing mount namespace and bind mount the newly granted access model into place. Bug: 21858077 Change-Id: I5a016f0958a92fd390c02b5ae159f8008bd4f4b7</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">为了达到不杀死进程，就能够赋予进程读/写外置存储的目的，Android利用FUSE对/data/media模拟了三种访问视图，分别是default、read、write。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><img src="https://images2.imgbox.com/62/1d/Fa3muvvE_o.jpg" style="padding:0px;height:auto;width:auto;" alt=""></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);margin-bottom:1.2em;"><br style="margin:0px;padding:0px;max-width:100%;"></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">当应用被授予读/写权限时，vold子进程会切换到应用的挂载命名空间，将对应的视图重新绑定到应用的外部存储路径上。</span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">切换进程的挂载命名空间，需要内核版本在3.8及以上，切换函数为setns，ndk貌似没有对开发者暴露，但可以在源码里找到arm的实现，有需要直接编入就可以了，也就一个sys call。</span></p> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">/* Generated by gensyscalls.py. Do not edit. */<br style="margin:0px;padding:0px;max-width:100%;"><br style="margin:0px;padding:0px;max-width:100%;"></span>#include &lt;<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">private</span>/bionic_asm.h&gt; ENTRY(setns)    mov     ip, r7    ldr     r7, =__NR_setns    swi     #<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>    mov     r7, ip    cmn     r0, #(MAX_ERRNO + <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>)    bxls    lr    neg     r0,<br style="margin:0px;padding:0px;max-width:100%;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">r0<span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">END</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(setns)</span></span></span></p> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;">c. 代码分析</span></span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">源码版本：Android 6.0.0_r1</span></p></li><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">首先从/xref/system/core/sdcard/sdcard.c开始分析，仅摘取部分代码，并加了些注释：</span></p></li></ul> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">static</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">void</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">run</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">const</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">char</span>* source_path, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">const</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">char</span>* label, uid_t uid,        gid_t gid, userid_t userid, bool multi_user, bool full_write)</span> </span>{      ...     <br style="margin:0px;padding:0px;max-width:100%;">  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// 分配三个视图路径，分别为default、read和write，label一般用来标示存储，例如模拟的外置存储，这里label为"emulated"</span>    snprintf(fuse_default.dest_path, PATH_MAX, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/default/%s"</span>, label);    snprintf(fuse_read.dest_path, PATH_MAX, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/read/%s"</span>, label);    snprintf(fuse_write.dest_path, PATH_MAX, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/write/%s"</span>, label);      ...    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// fuse_setup方法挂载fuse文件系统</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (multi_user) {        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">/* Multi-user storage is fully isolated per user, so "other"         * permissions are completely masked off. */</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (fuse_setup(&amp;fuse_default, AID_SDCARD_RW, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0006</span>)                || fuse_setup(&amp;fuse_read, AID_EVERYBODY, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0027</span>)                || fuse_setup(&amp;fuse_write, AID_EVERYBODY, full_write ? <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0007</span> : <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0027</span>)) {            ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"failed to fuse_setup\n"</span>);            exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>);        }    } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">else</span> {        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">/* Physical storage is readable by all users on device, but         * the Android directories are masked off to a single user         * deep inside attr_from_stat(). */</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (fuse_setup(&amp;fuse_default, AID_SDCARD_RW, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0006</span>)                || fuse_setup(&amp;fuse_read, AID_EVERYBODY, full_write ? <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0027</span> : <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0022</span>)                || fuse_setup(&amp;fuse_write, AID_EVERYBODY, full_write ? <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0007</span> : <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0022</span>)) {            ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"failed to fuse_setup\n"</span>);            exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>);        }    }      ...    <br style="margin:0px;padding:0px;max-width:100%;">    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// 从原本一个处理线程变为三个，分别处理三个视图的访问请求</span>      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (pthread_create(&amp;thread_default, NULL, start_handler, &amp;handler_default)            || pthread_create(&amp;thread_read, NULL, start_handler, &amp;handler_read)            || pthread_create(&amp;thread_write, NULL, start_handler, &amp;handler_write)) {        ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"failed to pthread_create\n"</span>);        exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>);    }      ... }</span></p> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// 挂载fuse文件系统<br style="margin:0px;padding:0px;max-width:100%;"><br style="margin:0px;padding:0px;max-width:100%;"></span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">static</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">int</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">fuse_setup</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(struct fuse* fuse, gid_t gid, mode_t mask)</span> </span>{ <br style="margin:0px;padding:0px;max-width:100%;">   <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> opts[<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">256</span>];    fuse-&gt;fd = open(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/dev/fuse"</span>, O_RDWR);  <br style="margin:0px;padding:0px;max-width:100%;">     <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (fuse-&gt;fd == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {        ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"failed to open fuse device: %s\n"</span>, strerror(errno));  <br style="margin:0px;padding:0px;max-width:100%;">         <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;    }    umount2(fuse-&gt;dest_path, MNT_DETACH);    snprintf(opts, sizeof(opts), <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"fd=%i,rootmode=40000,default_permissions,allow_other,user_id=%d,group_id=%d"</span>,            fuse-&gt;fd, fuse-&gt;global-&gt;uid, fuse-&gt;global-&gt;gid);  <br style="margin:0px;padding:0px;max-width:100%;">           <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mount(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/dev/fuse"</span>, fuse-&gt;dest_path, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"fuse"</span>, MS_NOSUID | MS_NODEV | MS_NOEXEC |            MS_NOATIME, opts) != <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {        ERROR(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"failed to mount fuse filesystem: %s\n"</span>, strerror(errno));   <br style="margin:0px;padding:0px;max-width:100%;">                <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;    }    fuse-&gt;gid = gid;    fuse-&gt;mask = mask;  <br style="margin:0px;padding:0px;max-width:100%;">  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>; }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">应用进程创建时，大致流程如下<br style="margin:0px;padding:0px;max-width:100%;">（/xref/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp）：</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">1.创建新的挂载命名空间；<br style="margin:0px;padding:0px;max-width:100%;">2.将之前的挂载命名空间在/storage下的挂载全部去除，排除影响；<br style="margin:0px;padding:0px;max-width:100%;">3.根据mount_mode，选择一个路径；<br style="margin:0px;padding:0px;max-width:100%;">4.将选择的路径绑定到/storage下。</span></p> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Create a private mount namespace and bind mount appropriate emulated// storage for the given user.<br style="margin:0px;padding:0px;max-width:100%;"><br style="margin:0px;padding:0px;max-width:100%;"></span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">static</span> bool <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">MountEmulatedStorage</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(uid_t uid, jint mount_mode,        bool force_mount_namespace)</span> </span>{ <br style="margin:0px;padding:0px;max-width:100%;">   <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// See storage config details at http://source.android.com/tech/storage/</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Create a second private mount namespace for our process</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (unshare(CLONE_NEWNS) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {        ALOGW(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to unshare(): %s"</span>, strerror(errno));      <br style="margin:0px;padding:0px;max-width:100%;">  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">false</span>;    }   <br style="margin:0px;padding:0px;max-width:100%;">   <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Unmount storage provided by root namespace and mount requested view</span>    UnmountTree(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/storage"</span>);    String8 storageSource; <br style="margin:0px;padding:0px;max-width:100%;">   <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mount_mode == MOUNT_EXTERNAL_DEFAULT) {        storageSource = <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/default"</span>;    } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">else</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">if</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(mount_mode == MOUNT_EXTERNAL_READ)</span> </span>{        storageSource = <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/read"</span>;    } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">else</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">if</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(mount_mode == MOUNT_EXTERNAL_WRITE)</span> </span>{        storageSource = <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/write"</span>;    } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">else</span> {    <br style="margin:0px;padding:0px;max-width:100%;">       <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Sane default of no storage visible</span>        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">true</span>;    }  <br style="margin:0px;padding:0px;max-width:100%;">     <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (TEMP_FAILURE_RETRY(mount(storageSource.string(), <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/storage"</span>,            NULL, MS_BIND | MS_REC | MS_SLAVE, NULL)) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {        ALOGW(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to mount %s to /storage: %s"</span>, storageSource.string(), strerror(errno));     <br style="margin:0px;padding:0px;max-width:100%;">      <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">false</span>;    }</span></p> 
<ul class="list-paddingleft-2" style="margin-bottom:0px;padding-left:2.2em;max-width:100%;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);"><li style="margin-top:0px;margin-left:0px;padding:0px;max-width:100%;"><p style="margin-bottom:10px;max-width:100%;clear:both;min-height:1em;line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">进程在运行时，当外部存储的访问许可发生改变（用户授权）时，基本流程如下（/xref/system/vold/VolumeManager.cpp）：</span></p></li></ul> 
<p style="max-width:100%;clear:both;min-height:1em;color:rgb(51,51,51);font-family:'-apple-system-font', BlinkMacSystemFont, 'Helvetica Neue', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei UI', 'Microsoft YaHei', Arial, sans-serif;font-size:17px;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.75em;margin-bottom:1.2em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;">获取init的挂载命名空间，为了对之后进程的挂载命名空间进行对比，如果一致，不重新绑定；<br style="margin:0px;padding:0px;max-width:100%;">遍历/proc下各个进程目录，根据uid进行筛选；<br style="margin:0px;padding:0px;max-width:100%;">找到对应的pid后，fork子进程进行重新挂载，这里用到setns进行挂载命名空间的切换；<br style="margin:0px;padding:0px;max-width:100%;">重新挂载部分的逻辑和应用进程创建时基本一致，不难理解。</span></p> 
<pre style="margin-top:1.2em;margin-bottom:1.2em;padding-right:0px;padding-left:0px;max-width:100%;color:rgb(51,51,51);font-size:1em;letter-spacing:.544px;background-color:rgb(255,255,255);line-height:1.2em;"></pre> 
<p style="margin-right:.15em;margin-bottom:10px;margin-left:.15em;padding:.5em;max-width:100%;clear:both;min-height:1em;font-size:.85em;border-width:1px;border-style:solid;border-color:rgb(204,204,204);background:rgb(35,36,31);color:rgb(248,248,242);line-height:1.75em;"><span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">int</span> VolumeManager::remountUid(uid_t uid, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">const</span> std::string&amp; mode) {    LOG(DEBUG) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Remounting "</span> &lt;&lt; uid &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">" as mode "</span> &lt;&lt; mode;    DIR* dir;    struct dirent* de;  <br style="margin:0px;padding:0px;max-width:100%;">  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> rootName[PATH_MAX];   <br style="margin:0px;padding:0px;max-width:100%;">   <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">char</span> pidName[PATH_MAX];  <br style="margin:0px;padding:0px;max-width:100%;">     <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">int</span> pidFd;  <br style="margin:0px;padding:0px;max-width:100%;">       <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">int</span> nsFd;    struct stat sb;    pid_t child;  <br style="margin:0px;padding:0px;max-width:100%;">         <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (!(dir = opendir(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/proc"</span>))) {        PLOG(ERROR) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to opendir"</span>;    <br style="margin:0px;padding:0px;max-width:100%;">             <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;    }    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Figure out root namespace to compare against below</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (sane_readlinkat(dirfd(dir), <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"1/ns/mnt"</span>, rootName, PATH_MAX) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {        PLOG(ERROR) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to readlink"</span>;        closedir(dir);    <br style="margin:0px;padding:0px;max-width:100%;">             <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;    }    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Poke through all running PIDs look for apps running as UID</span>    <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">while</span> ((de = readdir(dir))) {        pidFd = -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;        nsFd = -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>;        pidFd = openat(dirfd(dir), de-&gt;d_name, O_RDONLY | O_DIRECTORY | O_CLOEXEC);     <br style="margin:0px;padding:0px;max-width:100%;">                <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (pidFd &lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {            goto next;        }        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (fstat(pidFd, &amp;sb) != <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {            PLOG(WARNING) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to stat "</span> &lt;&lt; de-&gt;d_name;            goto next;        }        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (sb.st_uid != uid) {            goto next;        }        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Matches so far, but refuse to touch if in root namespace</span>        LOG(DEBUG) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Found matching PID "</span> &lt;&lt; de-&gt;d_name;     <br style="margin:0px;padding:0px;max-width:100%;">                   <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (sane_readlinkat(pidFd, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"ns/mnt"</span>, pidName, PATH_MAX) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {            PLOG(WARNING) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to read namespace for "</span> &lt;&lt; de-&gt;d_name;            goto next;        }        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (!strcmp(rootName, pidName)) {            LOG(WARNING) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Skipping due to root namespace"</span>;            goto next;        }        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// We purposefully leave the namespace open across the fork</span>        nsFd = openat(pidFd, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"ns/mnt"</span>, O_RDONLY);    <br style="margin:0px;padding:0px;max-width:100%;">                       <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (nsFd &lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {            PLOG(WARNING) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to open namespace for "</span> &lt;&lt; de-&gt;d_name;            goto next;        }     <br style="margin:0px;padding:0px;max-width:100%;">                <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (!(child = fork())) {     <br style="margin:0px;padding:0px;max-width:100%;">                       <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (setns(nsFd, CLONE_NEWNS) != <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>) {                PLOG(ERROR) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to setns for "</span> &lt;&lt; de-&gt;d_name;                _exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>);            }            unmount_tree(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/storage"</span>);            std::string storageSource;       <br style="margin:0px;padding:0px;max-width:100%;">                     <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (mode == <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"default"</span>) {                storageSource = <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/default"</span>;            } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">else</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">if</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(mode == <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"read"</span>)</span> </span>{                storageSource = <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/read"</span>;            } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);"><span style="margin:0px;padding:0px;max-width:100%;color:rgb(102,217,239);">else</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">if</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(mode == <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"write"</span>)</span> </span>{                storageSource = <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/runtime/write"</span>;            } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">else</span> {            <br style="margin:0px;padding:0px;max-width:100%;">                         <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Sane default of no storage visible</span>                _exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>);            }      <br style="margin:0px;padding:0px;max-width:100%;">            <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (TEMP_FAILURE_RETRY(mount(storageSource.c_str(), <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/storage"</span>,                    NULL, MS_BIND | MS_REC | MS_SLAVE, NULL)) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {                PLOG(ERROR) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to mount "</span> &lt;&lt; storageSource &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">" for "</span>                        &lt;&lt; de-&gt;d_name;                _exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>);            }            <span style="margin:0px;padding:0px;max-width:100%;color:rgb(117,113,94);">// Mount user-specific symlink helper into place</span>            userid_t user_id = multiuser_get_user_id(uid);            std::<span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">string <span style="margin:0px;padding:0px;max-width:100%;color:rgb(166,226,46);">userSource</span><span style="margin:0px;padding:0px;max-width:100%;color:rgb(248,248,242);">(StringPrintf(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/mnt/user/%d"</span>, user_id)</span>)</span>;       <br style="margin:0px;padding:0px;max-width:100%;">                  <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (TEMP_FAILURE_RETRY(mount(userSource.c_str(), <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"/storage/self"</span>,                    NULL, MS_BIND, NULL)) == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {                PLOG(ERROR) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to mount "</span> &lt;&lt; userSource &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">" for "</span>                        &lt;&lt; de-&gt;d_name;                _exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>);            }            _exit(<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>);        }        <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">if</span> (child == -<span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">1</span>) {            PLOG(ERROR) &lt;&lt; <span style="margin:0px;padding:0px;max-width:100%;color:rgb(230,219,116);">"Failed to fork"</span>;            goto next;        } <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">else</span> {            TEMP_FAILURE_RETRY(waitpid(child, nullptr, <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>));        } next:        close(nsFd);        close(pidFd);    }    closedir(dir);  <br style="margin:0px;padding:0px;max-width:100%;">               <span style="margin:0px;padding:0px;max-width:100%;color:rgb(249,38,114);">return</span> <span style="margin:0px;padding:0px;max-width:100%;color:rgb(174,129,255);">0</span>;  }                                                                                                                </span></p> 
<div> 
 <span style="margin:0px;padding:0px;max-width:100%;font-size:15px;letter-spacing:1px;"> </span> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6629f1bd74ec3496eea5669da19779c1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Linux Qt5 开发环境搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/953f54843aa04e7a4901d125aef9fa9f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">#ifndef    #define     #endif的用法总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>