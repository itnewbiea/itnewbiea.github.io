<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux网络安全技术与实现第2章之原理及实验 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux网络安全技术与实现第2章之原理及实验" />
<meta property="og:description" content="2.2 何谓netfilter netfilter的四个表是filter、nat、mangle及raw表。
filter:filter是Netfilter中最重要的机制，其任务是执行数据包的过滤操作，也就是起到防火墙的作用。nat:nat(Network Address Translation,NAT)也是防火墙上一个不可或缺的重要机制，比较通俗的方式来说，其功能就是IP分享器，只不过其所执行的功能，比一般市场上的IP分享器功能强大得多。mangle：mangle是一个很特殊的机制，我们可以通过mangle机制来修改经过防火墙内数据包内容。raw:负责加快数据包穿过防火墙机制的速度，由此提高防火墙的性能。 不同的表有属于独立的几个不同的链，而这个链的空间就是我们存放“规则”的地方。当然，不同的链其功能及用途也是不一样的。
使用filter机制来构建网关式防火墙
假设192.168.31.10是因特网上的一台主机，运行了smtp,pop3,http服务。
192.168.10.20只能访问外网192.168.31.10的smtp和pop3服务。内网主机192.168.10.0/24网段上的其它主机可以访问因特网上的DNS、SMTP、POP3，http,及sshd服务。因特网上的主机不得访问企业内的任何主机。 1 #/bin/bash 2 #===============&lt; Set Variable &gt;===================================== 3 IPT=/sbin/iptables 4 SRV=192.168.31.10 5 ACC_PC=192.168.10.20 6 #=======================&lt; Set Default Policy &gt;======================= 7 $IPT -t filter -P INPUT DROP 8 $IPT -t filter -P FORWARD DROP 9 #===============&lt; Clear Original Rule &gt;&gt; ============================= 10 $IPT -t filter -F 11 #==============&lt; Set-INPUt RULE&gt;&gt;====================================== 12 $IPT -A INPUT -p tcp -m state --state INVALID -j DROP 13 $IPT -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT 14 $IPT -t filter -A INPUT -p tcp -s 192." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/eabbd8d3f282d2cc80176b6721e97da1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-10-29T14:34:28+08:00" />
<meta property="article:modified_time" content="2018-10-29T14:34:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux网络安全技术与实现第2章之原理及实验</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>2.2 何谓netfilter</h2> 
<p> </p> 
<p>netfilter的四个表是filter、nat、mangle及raw表。</p> 
<ul><li>filter:filter是Netfilter中最重要的机制，其任务是执行数据包的过滤操作，也就是起到防火墙的作用。</li><li>nat:nat(Network Address Translation,NAT)也是防火墙上一个不可或缺的重要机制，比较通俗的方式来说，其功能就是IP分享器，只不过其所执行的功能，比一般市场上的IP分享器功能强大得多。</li><li>mangle：mangle是一个很特殊的机制，我们可以通过mangle机制来修改经过防火墙内数据包内容。</li><li>raw:负责加快数据包穿过防火墙机制的速度，由此提高防火墙的性能。</li></ul> 
<p>不同的表有属于独立的几个不同的链，而这个链的空间就是我们存放“规则”的地方。当然，不同的链其功能及用途也是不一样的。</p> 
<p><strong>使用filter机制来构建网关式防火墙</strong></p> 
<p>假设192.168.31.10是因特网上的一台主机，运行了smtp,pop3,http服务。</p> 
<ul><li>192.168.10.20只能访问外网192.168.31.10的smtp和pop3服务。</li><li>内网主机192.168.10.0/24网段上的其它主机可以访问因特网上的DNS、SMTP、POP3，http,及sshd服务。</li><li>因特网上的主机不得访问企业内的任何主机。</li></ul> 
<p><img alt="" class="has" src="https://images2.imgbox.com/79/ed/6iTyDIPp_o.jpg"></p> 
<p> </p> 
<pre class="has"><code class="language-bash">
      1 #/bin/bash
      2 #===============&lt; Set Variable &gt;=====================================
      3 IPT=/sbin/iptables
      4 SRV=192.168.31.10
      5 ACC_PC=192.168.10.20
      6 #=======================&lt; Set Default Policy &gt;=======================
      7 $IPT -t filter -P INPUT DROP
      8 $IPT -t filter -P FORWARD DROP
      9 #===============&lt;  Clear Original Rule &gt;&gt; =============================
     10 $IPT -t filter -F
     11 #==============&lt; Set-INPUt RULE&gt;&gt;======================================
     12 $IPT -A INPUT -p tcp -m state --state INVALID -j DROP
     13 $IPT -A INPUT -p tcp -m state --state ESTABLISHED,RELATED -j ACCEPT
     14 $IPT -t filter -A INPUT -p tcp -s 192.168.31.0/24 --dport 22 -j ACCEPT
     15 #==============&lt; Set FORWARD RULE&gt;&gt;====================================
     16 $IPT -A FORWARD -i ens33 -o ens37 -m state --state INVALID -j DROP
     17 $IPT -A FORWARD -i ens33 -o ens37 -m state --state ESTABLISHED,RELATED -j ACCEPT
     18 $IPT -A FORWARD -i ens37 -o ens33 -p tcp -s $ACC_PC -d $SRV --dport 25 -j ACCEPT
     19 $IPT -A FORWARD -i ens37 -o ens33 -p tcp -s $ACC_PC -d $SRV --dport 110 -j ACCEPT
     20 $IPT -A FORWARD -i ens37 -o ens33 -p  all -s $ACC_PC  -j DROP
     21 $IPT -A FORWARD -i ens37 -o ens33 -p tcp --dport 80 -j ACCEPT
     22 $IPT -A FORWARD -i ens37 -o ens33 -p udp --dport 53 -j ACCEPT
     23 $IPT -A FORWARD -i ens37 -o ens33 -p udp --dport 110 -j ACCEPT
     24 $IPT -A FORWARD -i ens37 -o ens33 -p tcp --dport 22 -j ACCEPT
~</code></pre> 
<p>第1行</p> 
<p>设置Shell解释器的路径。</p> 
<p>第2-5行</p> 
<p>将未来可能会变动的信息或太长的命令简化成“变量”</p> 
<p>第6-8行</p> 
<p>设置INPUT 及FORWARD链的默认策略为DROP，其目的分别如下:</p> 
<p>        设置INPUT链的默认策略为DROP的目的：虽然本示例的主要目的是使用网关式防火墙来保护及限制企业内的主机，但请千万别忽略了防火墙自身的安全，否则防火墙若被入侵了，整个企业的安全防护就形同虚设了。因此，我们拒绝了所有对防火墙的连接操作，但别忘了，因为我们有可能在防火墙主机执行如软件更新等需要对外产生连接的操作，所以在此并没有将OUTPUT链的默认策略设置为DROP。</p> 
<p>          设置FORWARD链的默认策略为DROP的目的：因为本示例是以严格的方式来控制企业对外的连接，以及因特网对企业内的连接，因此，笔者将fFORWARD链的默认策略设置为DROP,如此一来，企业内外就等于“断线”的状态。稍后，我们再从FORWARD链中逐一启用允许的对外连接通道阳即可。</p> 
<p>第10行</p> 
<p>清除原有的防火墙规则</p> 
<p>第11-14行，</p> 
<p>因为INPUT链的默认策略已设置为DROP，因此将导致对外建立连接时应答数据包无法正常穿过防火墙的问题，我们必须在INPUT链中设置ESTABLISHED 及RELATED状态的数据包，才可以正常地返回。</p> 
<p>第16行，</p> 
<p>针所有从因特网送到企业内部且状态是INVALID的数据包丢弃。</p> 
<p>第17行，允许所有企业内部对外建立连接时所产生的应答数据包正常返回企业内部。</p> 
<p>第18-20行</p> 
<p>设置192.168.10.20主机只能访问因特网上192.168.31.10这台主机的SMTP及POP3服务。</p> 
<p>第21行-24行</p> 
<p>在192.168.10.0/24网段中的主机只能访问因特网上的SMTP、POP3、HTTP及SSHD服务。</p> 
<p> </p> 
<p><strong>netfilter的NAT机制</strong></p> 
<p>SNAT</p> 
<pre class="has"><code> iptables -t nat -A POSTROUTING -o ens33 -s 192.168.10.0/24 -j SNAT --to 192.168.31.100</code></pre> 
<p> </p> 
<pre class="has"><code>iptables -t nat -A POSTROUTING -s 192.168.10.0/24 -j MASQUERADE
iptables -t nat -A  PREROUTING -d 192.168.1.196 -p tcp --dport 80 -j DNAT --to-destination 192.168.10.101</code></pre> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/56c3f46a3f4a129fcc527af44466ce3c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Knative 简介</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ccf0ac46c2d8d14bbff56e1592b41d1d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">使用element UI 快速制作一个列表页面</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>