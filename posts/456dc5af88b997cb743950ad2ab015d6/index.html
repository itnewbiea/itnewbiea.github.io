<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux驱动修炼之道-混杂设备 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux驱动修炼之道-混杂设备" />
<meta property="og:description" content="原文地址链接
在Linux驱动中把无法归类的五花八门的设备定义为混杂设备(用miscdevice结构体表述)。miscdevice共享一个主设备号MISC_MAJOR(即10)，但次设备号不同。 所有的miscdevice设备形成了一个链表，对设备访问时内核根据次设备号查找对应的miscdevice设备，然后调用其file_operations结构中注册的文件操作接口进行操作。 在内核中用struct miscdevice表示miscdevice设备，然后调用其file_operations结构中注册的文件操作接口进行操作。miscdevice的API实现在drivers/char/misc.c中。
下边是描述这个设备的结构体：
C-sharp代码 struct miscdevice { int minor; //次设备号 const char *name; //设备的名称 const struct file_operations *fops; //文件操作 struct list_head list; //misc_list的链表头 struct device *parent; //父设备(Linux设备模型中的东东了，哈哈) struct device *this_device; //当前设备，是device_create的返回值，下边会看到 }; 然后来看看misc子系统的初始化函数：
C-sharp代码 static int __init misc_init(void) { int err; #ifdef CONFIG_PROC_FS /*创建一个proc入口项*/ proc_create(&#34;misc&#34;, 0, NULL, &amp;misc_proc_fops); #endif /*在/sys/class/目录下创建一个名为misc的类*/ misc_class = class_create(THIS_MODULE, &#34;misc&#34;); err = PTR_ERR(misc_class); if (IS_ERR(misc_class)) goto fail_remove; err = -EIO; /*注册设备，其中设备的主设备号为MISC_MAJOR，为10。设备名为misc，misc_fops是操作函数的集合*/ if (register_chrdev(MISC_MAJOR,&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/456dc5af88b997cb743950ad2ab015d6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-05-21T19:58:57+08:00" />
<meta property="article:modified_time" content="2012-05-21T19:58:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux驱动修炼之道-混杂设备</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="font-size:16px"><span style="line-height:normal; border-collapse:separate"><span style="line-height:18px"><a href="http://tomhibolu.iteye.com/blog/1214940" rel="nofollow"><strong><span style="color:#cc0000">原文地址链接</span></strong></a></span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="font-size:16px"><span style="line-height:normal; border-collapse:separate"><span style="line-height:18px"><br> </span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; line-height:25px; text-align:left"> <span style="line-height:normal; border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px; font-family:Helvetica,Tahoma,Arial,sans-serif">      </span><span style="font-family:SimSun; font-size:18px">在Linux驱动中把无法归类的五花八门的设备定义为混杂设备(用miscdevice结构体表述)。</span></span></span><span style="font-family:SimSun; font-size:18px; line-height:normal; border-collapse:separate"><span style="line-height:18px">miscdevice共享一个主设备号MISC_MAJOR(即10)，但次设备号不同。 所有的miscdevice设</span></span><span style="font-family:SimSun; font-size:18px; line-height:normal; border-collapse:separate"><span style="line-height:18px">备形成了一个链表，对设备访问时内核根据次设备号查找对应的miscdevice设备，然后调用其file_operations结构中注册的文件操作接口进行操作。 在内核中用struct </span></span><span style="font-family:SimSun; font-size:18px; line-height:normal; border-collapse:separate"><span style="line-height:18px">miscdevice表示miscdevice设备，然后调用其file_operations结构中注册的文件操作接口进行操作。miscdevice的API实现在drivers/char/misc.c中。</span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px"><img src="https://images2.imgbox.com/a9/31/vseWdyCN_o.gif" alt="" style="border-top-width:0px; border-right-width:0px; border-bottom-width:0px; border-left-width:0px; border-style:initial; border-color:initial"><br> 下边是描述这个设备的结构体：</span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> miscdevice  {      </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> minor;                               <span class="comment" style="color:rgb(0,130,0)">//次设备号 </span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">const</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">char</span> *name;                        <span class="comment" style="color:rgb(0,130,0)">//设备的名称    </span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">const</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> file_operations *fops;     <span class="comment" style="color:rgb(0,130,0)">//文件操作  </span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> list_head list;                  <span class="comment" style="color:rgb(0,130,0)">//misc_list的链表头</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> device *parent;                  <span class="comment" style="color:rgb(0,130,0)">//父设备(Linux设备模型中的东东了，哈哈)    </span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> device *this_device;             <span class="comment" style="color:rgb(0,130,0)">//当前设备，是device_create的返回值，下边会看到</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">};  </span></li></ol> 
</div> 
<span style="font-size:16px"></span> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px">然后来看看misc子系统的初始化函数：</span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">static</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> __init misc_init(<span class="keyword" style="color:rgb(127,0,85); font-weight:bold">void</span>)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">{   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> err;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="preprocessor" style="color:gray"> </span> </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="preprocessor" style="color:gray">#ifdef CONFIG_PROC_FS </span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*创建一个proc入口项*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    proc_create(<span class="string" style="color:blue">"misc"</span>, 0, NULL, &amp;misc_proc_fops);                   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="preprocessor" style="color:gray">#endif </span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*在/sys/class/目录下创建一个名为misc的类*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    misc_class = class_create(THIS_MODULE, <span class="string" style="color:blue">"misc"</span>);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    err = PTR_ERR(misc_class);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (IS_ERR(misc_class))   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">goto</span> fail_remove;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    err = -EIO;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*注册设备，其中设备的主设备号为MISC_MAJOR，为10。设备名为misc，misc_fops是操作函数的集合*/</span>   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (register_chrdev(MISC_MAJOR,<span class="string" style="color:blue">"misc"</span>,&amp;misc_fops))   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">goto</span> fail_printk;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> 0;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">fail_printk:   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    printk(<span class="string" style="color:blue">"unable to get major %d for misc devices/n"</span>, MISC_MAJOR);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    class_destroy(misc_class);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">fail_remove:   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    remove_proc_entry(<span class="string" style="color:blue">"misc"</span>, NULL);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> err;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">}   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="comment" style="color:rgb(0,130,0)">/*misc作为一个子系统被注册到linux内核中*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">subsys_initcall(misc_init);   </span></li></ol> 
</div> 
<span style="font-size:16px"></span> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px">下边是register_chrdev函数的实现：</span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> register_chrdev(unsigned <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> major, <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">const</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">char</span> *name,  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">const</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> file_operations *fops)  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">{  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> char_device_struct *cd;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> cdev *cdev;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">char</span> *s;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> err = -ENOMEM;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*主设备号是10，次设备号为从0开始，分配256个设备*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    cd = __register_chrdev_region(major, 0, 256, name);  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (IS_ERR(cd))  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> PTR_ERR(cd);  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*分配字符设备*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    cdev = cdev_alloc();  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (!cdev)  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">goto</span> out2;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    cdev-&gt;owner = fops-&gt;owner;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    cdev-&gt;ops = fops;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*Linux设备模型中的,设置kobject的名字*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    kobject_set_name(&amp;cdev-&gt;kobj, <span class="string" style="color:blue">"%s"</span>, name);  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">for</span> (s = strchr(kobject_name(&amp;cdev-&gt;kobj),<span class="string" style="color:blue">'/'</span>); s; s = strchr(s, <span class="string" style="color:blue">'/'</span>))  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        *s = <span class="string" style="color:blue">'!'</span>;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*把这个字符设备注册到系统中*/</span>     </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    err = cdev_add(cdev, MKDEV(cd-&gt;major, 0), 256);  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (err)  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">goto</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">out</span>;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    cd-&gt;cdev = cdev;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> major ? 0 : cd-&gt;major;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">out</span>:  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    kobject_put(&amp;cdev-&gt;kobj);  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">out2:  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    kfree(__unregister_chrdev_region(cd-&gt;major, 0, 256));  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> err;  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">}  </span></li></ol> 
</div> 
<span style="font-size:16px"></span> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px">来看看这个设备的操作函数的集合：</span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">static</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">const</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> file_operations misc_fops = {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    .owner      = THIS_MODULE,   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    .open       = misc_open,   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">};   </span></li></ol> 
</div> 
<span style="font-size:16px"></span> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px">可以看到这里只有一个打开函数，用户打开miscdevice设备是通过主设备号对应的打开函数，在这个函数中找到次设备号对应的相应的具体设备的open函数。它的实现如下：</span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">static</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> misc_open(<span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> inode * inode, <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> file * file)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">{   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> minor = iminor(inode);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> miscdevice *c;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> err = -ENODEV;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">const</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> file_operations *old_fops, *new_fops = NULL;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">      </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    lock_kernel();   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    mutex_lock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*找到次设备号对应的操作函数集合，让new_fops指向这个具体设备的操作函数集合*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    list_for_each_entry(c, &amp;misc_list, list) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (c-&gt;minor == minor) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            new_fops = fops_get(c-&gt;fops);           </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">break</span>;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">           </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (!new_fops) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        mutex_unlock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="comment" style="color:rgb(0,130,0)">/*如果没有找到，则请求加载这个次设备号对应的模块*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        request_module(<span class="string" style="color:blue">"char-major-%d-%d"</span>, MISC_MAJOR, minor);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        mutex_lock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="comment" style="color:rgb(0,130,0)">/*重新遍历misc_list链表，如果没有找到就退出，否则让new_fops指向这个具体设备的操作函数集合*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        list_for_each_entry(c, &amp;misc_list, list) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (c-&gt;minor == minor) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">                new_fops = fops_get(c-&gt;fops);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">                <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">break</span>;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (!new_fops)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">goto</span> fail;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    err = 0;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*保存旧打开函数的地址*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    old_fops = file-&gt;f_op;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*让主设备号的操作函数集合指针指向具体设备的操作函数集合*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    file-&gt;f_op = new_fops;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (file-&gt;f_op-&gt;open) {  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="comment" style="color:rgb(0,130,0)">/*使用具体设备的打开函数打开设备*/</span>   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        err=file-&gt;f_op-&gt;open(inode,file);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (err) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            fops_put(file-&gt;f_op);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            file-&gt;f_op = fops_get(old_fops);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    fops_put(old_fops);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">fail:   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    mutex_unlock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    unlock_kernel();   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> err;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">}   </span></li></ol> 
</div> 
<br> 
<span style="font-size:16px">再来看看misc子系统对外提供的两个重要的API,misc_register,misc_deregister：</span> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> misc_register(<span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> miscdevice * misc)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">{   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> miscdevice *c;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    dev_t dev;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> err = 0;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*初始化misc_list链表*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    INIT_LIST_HEAD(&amp;misc-&gt;list);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    mutex_lock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*遍历misc_list链表，看这个次设备号以前有没有被用过，如果次设备号已被占有则退出*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    list_for_each_entry(c, &amp;misc_list, list) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (c-&gt;minor == misc-&gt;minor) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            mutex_unlock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> -EBUSY;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*看是否是需要动态分配次设备号*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (misc-&gt;minor == MISC_DYNAMIC_MINOR) {  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="comment" style="color:rgb(0,130,0)">/*</span> </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="comment" style="color:rgb(0,130,0)">         *#define DYNAMIC_MINORS 64 /* like dynamic majors */</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">         *<span class="keyword" style="color:rgb(127,0,85); font-weight:bold">static</span> unsigned <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">char</span> misc_minors[DYNAMIC_MINORS / 8];   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">         *这里存在一个次设备号的位图，一共64位。下边是遍历每一位，  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">         *如果这位为0，表示没有被占有，可以使用，为1表示被占用。         </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">         */  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> i = DYNAMIC_MINORS;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">while</span> (--i &gt;= 0)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> ( (misc_minors[i&gt;&gt;3] &amp; (1 &lt;&lt; (i&amp;7))) == 0)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">                <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">break</span>;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (i&lt;0) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            mutex_unlock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">            <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> -EBUSY;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="comment" style="color:rgb(0,130,0)">/*得到这个次设备号*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        misc-&gt;minor = i;                                           </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*设置位图中相应位为1*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (misc-&gt;minor &lt; DYNAMIC_MINORS)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        misc_minors[misc-&gt;minor &gt;&gt; 3] |= 1 &lt;&lt; (misc-&gt;minor &amp; 7);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*计算出设备号*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    dev = MKDEV(MISC_MAJOR, misc-&gt;minor);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*在/dev下创建设备节点，这就是有些驱动程序没有显式调用device_create，却出现了设备节点的原因*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    misc-&gt;this_device = device_create(misc_class, misc-&gt;parent, dev, NULL,   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">                      <span class="string" style="color:blue">"%s"</span>, misc-&gt;name);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (IS_ERR(misc-&gt;this_device)) {   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        err = PTR_ERR(misc-&gt;this_device);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">goto</span> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">out</span>;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/* </span> </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="comment" style="color:rgb(0,130,0)">     * Add it to the front, so that later devices can "override" </span> </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="comment" style="color:rgb(0,130,0)">     * earlier defaults </span> </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="comment" style="color:rgb(0,130,0)">     */</span>   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*将这个miscdevice添加到misc_list链表中*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    list_add(&amp;misc-&gt;list, &amp;misc_list);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"> <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">out</span>:   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    mutex_unlock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> err;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">}   </span></li></ol> 
</div> 
<span style="font-size:16px"></span> 
<p></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"><span style="line-height:18px"><span style="font-size:16px">这个是miscdevice的卸载函数：</span></span></span></p> 
<p style="margin-top:0px; margin-bottom:0px; padding-top:0px; padding-bottom:0px; font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:14px; line-height:25px; text-align:left"> <span style="border-collapse:separate"></span></p> 
<div class="dp-highlighter" style="background-color:transparent; width:679px; overflow-x:auto; overflow-y:auto; margin-left:9px; padding-top:1px; padding-right:1px; padding-bottom:1px; padding-left:1px; word-break:break-all; word-wrap:break-word"> 
 <div class="bar" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <div class="tools" style="padding-top:3px; padding-right:3px; padding-bottom:3px; padding-left:3px; text-align:left; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:0px; font-weight:bold">
    C-sharp代码  
  </div> 
 </div> 
 <ol start="1" class="dp-c" style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace; font-size:1em; line-height:1.4em; margin-top:0px; margin-right:0px; margin-bottom:1px; margin-left:0px; padding-top:2px; padding-right:0px; padding-bottom:2px; padding-left:0px; border-top-width:1px; border-right-width:1px; border-bottom-width:1px; border-left-width:1px; border-top-style:solid; border-right-style:solid; border-bottom-style:solid; border-left-style:solid; border-top-color:rgb(209,215,220); border-right-color:rgb(209,215,220); border-bottom-color:rgb(209,215,220); border-left-color:rgb(209,215,220); list-style-position:initial; color:rgb(43,145,175)"><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black"><span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> misc_deregister(<span class="keyword" style="color:rgb(127,0,85); font-weight:bold">struct</span> miscdevice *misc)   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">{   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">int</span> i = misc-&gt;minor;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (list_empty(&amp;misc-&gt;list))   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> -EINVAL;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    mutex_lock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*在misc_list链表中删除miscdevice设备*/</span>  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    list_del(&amp;misc-&gt;list);     </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="comment" style="color:rgb(0,130,0)">/*删除设备节点*/</span>                            </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    device_destroy(misc_class, MKDEV(MISC_MAJOR, misc-&gt;minor));             </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">if</span> (i &lt; DYNAMIC_MINORS &amp;&amp; i&gt;0) {  </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        <span class="comment" style="color:rgb(0,130,0)">/*释放位图相应位*/</span>   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">        misc_minors[i&gt;&gt;3] &amp;= ~(1 &lt;&lt; (misc-&gt;minor &amp; 7));   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    }   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    mutex_unlock(&amp;misc_mtx);   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">    <span class="keyword" style="color:rgb(127,0,85); font-weight:bold">return</span> 0;   </span></li><li style="font-size:1em; margin-top:0px; margin-right:0px; margin-bottom:0px; margin-left:38px; padding-top:0px; padding-right:0px; padding-bottom:0px; padding-left:10px; border-left-width:1px; border-left-style:solid; border-left-color:rgb(209,215,220); background-color:rgb(250,250,250); line-height:18px"> <span style="color:black">}   </span></li></ol> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="line-height:18px"><br> </span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="line-height:18px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif; line-height:18px; text-align:left; font-size:16px"><span style="color:#cc0000"><strong>总结一下miscdevice驱动的注册和卸载流程：</strong></span></span></span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:16px; line-height:18px; text-align:left; background-color:transparent"><br> </span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:16px; line-height:18px; text-align:left; background-color:transparent">misc_register:</span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="line-height:18px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif; font-size:16px">匹配次设备号-&gt;找到一个没有占用的次设备号(如果需要动态分配的话)-&gt;计算设号-&gt;创建设备文-</span></span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="line-height:18px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif; line-height:18px; text-align:left; font-size:16px">miscdevice结构体添加到misc_list链表中。</span></span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="line-height:18px"><br style="font-family:Helvetica,Tahoma,Arial,sans-serif; line-height:18px; text-align:left; font-size:16px"> <span style="font-family:Helvetica,Tahoma,Arial,sans-serif; line-height:18px; text-align:left; font-size:16px">misc_deregister:</span></span> 
 </div> 
 <div style="font-family:Monaco,'DejaVu Sans Mono','Bitstream Vera Sans Mono',Consolas,'Courier New',monospace"> 
  <span style="line-height:18px"><span style="font-family:Helvetica,Tahoma,Arial,sans-serif; line-height:18px; text-align:left; font-size:16px">从mist_list中删除miscdevice-&gt;删除设备文件-&gt;位图位清零。</span><br> </span> 
 </div> 
</div> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2974c7b236f5f384e67586b66a1716c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">程序员很少上《非诚勿扰》电视节目相亲之分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/948324b9418324a593d39b5466f7071c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">GDAL源码剖析（十一）之OGR投影说明</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>