<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>让lager的日志文件按日期滚动起来 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="让lager的日志文件按日期滚动起来" />
<meta property="og:description" content="lager是一个很强大得日志系统，但是在实际使用的时候发现lager貌似不能在运行后随意的更改错误日志的文件名称。
这是因为lager在为它自己添加event_handler的时候，是直接将日志输出文件名作为handler的名称的一部分输入进去得。
lager:status/0 代码如下
status() -&gt; Handlers = gen_event:which_handlers(lager_event), TraceCount = case length(element(2, lager_config:get(loglevel))) of 0 -&gt; 1; N -&gt; N end, Status = [&#34;Lager status:\n&#34;, [begin Level = get_loglevel(Handler), case Handler of {lager_file_backend, File} -&gt; io_lib:format(&#34;File ~s at level ~p\n&#34;, [File, Level]); lager_console_backend -&gt; io_lib:format(&#34;Console at level ~p\n&#34;, [Level]); _ -&gt; [] end end || Handler &lt;- Handlers], &#34;Active Traces:\n&#34;, [begin LevelName = case Level of {mask, Mask} -&gt; case lager_util:mask_to_levels(Mask) of [] -&gt; none; Levels -&gt; hd(Levels) end; Num -&gt; lager_util:num_to_level(Num) end, io_lib:format(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6d4b931d7b757fc978e51d7bbd025d0d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-02-08T19:37:30+08:00" />
<meta property="article:modified_time" content="2015-02-08T19:37:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">让lager的日志文件按日期滚动起来</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="font-size:12px">lager是一个很强大得日志系统，但是在实际使用的时候发现lager貌似不能在运行后随意的更改错误日志的文件名称。</span></p> 
<p><span style="font-size:12px">这是因为lager在为它自己添加event_handler的时候，是直接将日志输出文件名作为handler的名称的一部分输入进去得。</span></p> 
<p><span style="font-size:14px"><br> </span></p> 
<p><span style="font-size:12px"><span style="font-family:Courier New; color:#ff6600"><strong>lager:status/0 </strong></span>代码如下</span></p> 
<p></p> 
<pre style="font-family:'Courier New'; background-color:rgb(255,255,255)"></pre> 
<pre style="font-family:'Courier New'; background-color:rgb(255,255,255)"></pre> 
<pre style="font-family:'Courier New'; background-color:rgb(255,255,255)"><span style="font-size:12px"><span style="background-color:rgb(228,228,255)">status</span>() -&gt;
    <span style="color:rgb(220,0,52)">Handlers </span><span style="color:rgb(118,2,255)">= </span>gen_event:which_handlers(lager_event),
    <span style="color:rgb(220,0,52)">TraceCount </span><span style="color:rgb(118,2,255)">= </span><span style="color:rgb(0,0,128)"><strong>case </strong></span>length(element(<span style="color:rgb(0,0,255)">2</span>, lager_config:get(loglevel))) <span style="color:rgb(0,0,128)"><strong>of
</strong></span><span style="color:rgb(0,0,128)"><strong>        </strong></span><span style="color:rgb(0,0,255)">0 </span>-&gt; <span style="color:rgb(0,0,255)">1</span>;
        <span style="color:rgb(220,0,52)">N </span>-&gt; <span style="color:rgb(220,0,52)">N
</span><span style="color:rgb(220,0,52)">    </span><span style="color:rgb(0,0,128)"><strong>end</strong></span>,
    <span style="color:rgb(220,0,52)">Status </span><span style="color:rgb(118,2,255)">= </span>[<span style="color:rgb(0,128,0)"><strong>"Lager status:\n"</strong></span>,
        [<span style="color:rgb(0,0,128)"><strong>begin
</strong></span><span style="color:rgb(0,0,128)"><strong>                    </strong></span><span style="color:rgb(220,0,52)">Level </span><span style="color:rgb(118,2,255)">= </span>get_loglevel(<span style="color:rgb(220,0,52)">Handler</span>),
                    <span style="color:rgb(0,0,128)"><strong>case </strong></span><span style="color:rgb(220,0,52)">Handler </span><span style="color:rgb(0,0,128)"><strong>of
</strong></span><span style="color:rgb(0,0,128)"><strong>                        </strong></span>{lager_file_backend, <span style="color:rgb(220,0,52)">File</span>} -&gt;
                            io_lib:format(<span style="color:rgb(0,128,0)"><strong>"File ~s at level ~p\n"</strong></span>, [<span style="color:rgb(220,0,52)">File</span>, <span style="color:rgb(220,0,52)">Level</span>]);
                        lager_console_backend -&gt;
                            io_lib:format(<span style="color:rgb(0,128,0)"><strong>"Console at level ~p\n"</strong></span>, [<span style="color:rgb(220,0,52)">Level</span>]);
                        _ -&gt;
                            []
                    <span style="color:rgb(0,0,128)"><strong>end
</strong></span><span style="color:rgb(0,0,128)"><strong>            end || </strong></span><span style="color:rgb(220,0,52)">Handler </span>&lt;- <span style="color:rgb(220,0,52)">Handlers</span>],
        <span style="color:rgb(0,128,0)"><strong>"Active Traces:\n"</strong></span>,
        [<span style="color:rgb(0,0,128)"><strong>begin
</strong></span><span style="color:rgb(0,0,128)"><strong>                    </strong></span><span style="color:rgb(220,0,52)">LevelName </span><span style="color:rgb(118,2,255)">= </span><span style="color:rgb(0,0,128)"><strong>case </strong></span><span style="color:rgb(220,0,52)">Level </span><span style="color:rgb(0,0,128)"><strong>of
</strong></span><span style="color:rgb(0,0,128)"><strong>                        </strong></span>{mask, <span style="color:rgb(220,0,52)">Mask</span>} -&gt;
                            <span style="color:rgb(0,0,128)"><strong>case </strong></span>lager_util:mask_to_levels(<span style="color:rgb(220,0,52)">Mask</span>) <span style="color:rgb(0,0,128)"><strong>of
</strong></span><span style="color:rgb(0,0,128)"><strong>                                </strong></span>[] -&gt; none;
                                <span style="color:rgb(220,0,52)">Levels </span>-&gt; hd(<span style="color:rgb(220,0,52)">Levels</span>)
                            <span style="color:rgb(0,0,128)"><strong>end</strong></span>;
                        <span style="color:rgb(220,0,52)">Num </span>-&gt;
                            lager_util:num_to_level(<span style="color:rgb(220,0,52)">Num</span>)
                    <span style="color:rgb(0,0,128)"><strong>end</strong></span>,
                    io_lib:format(<span style="color:rgb(0,128,0)"><strong>"Tracing messages matching ~p at level ~p to ~p\n"</strong></span>,
                        [<span style="color:rgb(220,0,52)">Filter</span>, <span style="color:rgb(220,0,52)">LevelName</span>, <span style="color:rgb(220,0,52)">Destination</span>])
            <span style="color:rgb(0,0,128)"><strong>end || </strong></span>{<!-- --><span style="color:rgb(220,0,52)">Filter</span>, <span style="color:rgb(220,0,52)">Level</span>, <span style="color:rgb(220,0,52)">Destination</span>} &lt;- element(<span style="color:rgb(0,0,255)">2</span>, lager_config:get(loglevel))],
         [
         <span style="color:rgb(0,128,0)"><strong>"Tracing Reductions:\n"</strong></span>,
            <span style="color:rgb(0,0,128)"><strong>case </strong></span>?<span style="color:rgb(220,0,52)">DEFAULT_TRACER</span>:info('query') <span style="color:rgb(0,0,128)"><strong>of
</strong></span><span style="color:rgb(0,0,128)"><strong>                </strong></span>{null, false} -&gt; <span style="color:rgb(0,128,0)"><strong>""</strong></span>;
                <span style="color:rgb(220,0,52)">Query </span>-&gt; io_lib:format(<span style="color:rgb(0,128,0)"><strong>"~p~n"</strong></span>, [<span style="color:rgb(220,0,52)">Query</span>])
            <span style="color:rgb(0,0,128)"><strong>end
</strong></span><span style="color:rgb(0,0,128)"><strong>         </strong></span>],
         [
          <span style="color:rgb(0,128,0)"><strong>"Tracing Statistics:\n "</strong></span>,
              [ <span style="color:rgb(0,0,128)"><strong>begin 
</strong></span><span style="color:rgb(0,0,128)"><strong>                    </strong></span>[<span style="color:rgb(0,128,0)"><strong>" "</strong></span>, atom_to_list(<span style="color:rgb(220,0,52)">Table</span>), <span style="color:rgb(0,128,0)"><strong>": "</strong></span>,
                     integer_to_list(?<span style="color:rgb(220,0,52)">DEFAULT_TRACER</span>:info(<span style="color:rgb(220,0,52)">Table</span>) <span style="color:rgb(0,0,128)"><strong>div </strong></span><span style="color:rgb(220,0,52)">TraceCount</span>),
                     <span style="color:rgb(0,128,0)"><strong>"\n"</strong></span>]
                <span style="color:rgb(0,0,128)"><strong>end || </strong></span><span style="color:rgb(220,0,52)">Table </span>&lt;- [input, output, filter] ]
         ]],
    io:put_chars(<span style="color:rgb(220,0,52)">Status</span>)<span style="color:rgb(0,0,128)"><strong>.</strong></span></span></pre> 
<br> 
<p>我们看到handler的两个匹配</p> 
<p></p> 
<pre style="font-family:'Courier New'; background-color:rgb(255,255,255)">{lager_file_backend, <span style="color:rgb(220,0,52)">File</span>}, lager_console_backend</pre> 
<p></p> 
<p>再来看看另一段代码</p> 
<p><span style="font-family:'Courier New'"><strong><span style="color:rgb(255,102,0); font-family:'Courier New'"><strong>lager:clear_all_traces/0 </strong></span><span style="color:#333333">代码如下</span></strong></span></p> 
<p></p> 
<pre style="font-family:'Courier New'; background-color:rgb(255,255,255)"><span style="font-size:12px">clear_all_traces() -&gt;
    {<!-- --><span style="color:rgb(220,0,52)">Level</span>, <span style="color:rgb(220,0,52)">_Traces</span>} <span style="color:rgb(118,2,255)">= </span>lager_config:get(loglevel),
    _ <span style="color:rgb(118,2,255)">= </span>lager_util:trace_filter(none),
    lager_config:set(loglevel, {<!-- --><span style="color:rgb(220,0,52)">Level</span>, []}),
    lists:foreach(<span style="color:rgb(0,0,128)"><strong>fun</strong></span>(<span style="color:rgb(220,0,52)">Handler</span>) -&gt;
          <span style="color:rgb(0,0,128)"><strong>case </strong></span>get_loglevel(<span style="color:rgb(220,0,52)">Handler</span>) <span style="color:rgb(0,0,128)"><strong>of
</strong></span><span style="color:rgb(0,0,128)"><strong>            </strong></span>none -&gt;
              gen_event:delete_handler(lager_event, <span style="color:rgb(220,0,52)">Handler</span>, []);
            _ -&gt;
              ok
          <span style="color:rgb(0,0,128)"><strong>end
</strong></span><span style="color:rgb(0,0,128)"><strong>      end</strong></span>, gen_event:<span style="background-color:rgb(228,228,255)">which_handlers</span>(lager_event))<span style="color:rgb(0,0,128)"><strong>.</strong></span></span></pre> 我们看到这个地方，清除handler的时候是整个删掉了event_handler。所以我的做法是，更改文件名称的时候就直接删除掉之前定义个该级别的Handler. 
<p></p> 
<p><br> </p> 
<p>以下是我事先该功能的一小部分代码段,仅供大家参考,望高人指正.</p> 
<p></p> 
<pre style="font-family:'Courier New'; background-color:rgb(255,255,255)"><span style="font-size:12px"><span style="color:rgb(128,3,0)"><em>% 获取所有得Handler
</em></span><span style="color:rgb(220,0,52)">Handlers </span><span style="color:rgb(118,2,255)">= </span>gen_event:which_handlers(lager_event),
<span style="color:rgb(128,3,0)"><em>% 获取当前级别的日志Handler
</em></span>{ok, <span style="color:rgb(220,0,52)">TargetLevelHandlers</span>} <span style="color:rgb(118,2,255)">= </span>getLevelHandler(<span style="color:rgb(220,0,52)">Handlers</span>, <span style="color:#dc0034">LogLevel</span>),
<span style="color:rgb(128,3,0)"><em>% 增加新得Handler
</em></span>gen_event:add_handler(lager_event, {lager_file_backend, <span style="color:rgb(220,0,52)">LogFile</span>}, [{file, LogFileName}, {level, LogLevel}]</span><span style="font-size:12px">),</span><span style="font-size:12px">
<span style="color:rgb(128,3,0)"><em>% 删除旧的Handler
</em></span>[<span style="color:rgb(0,0,128)"><strong>begin
</strong></span><span style="color:rgb(128,3,0)"><em>     % 删除旧的handler
</em></span><span style="color:rgb(128,3,0)"><em>     </em></span>gen_event:delete_handler(lager_event, <span style="color:rgb(220,0,52)">Handler</span>, []),
     []
 <span style="color:rgb(0,0,128)"><strong>end||</strong></span><span style="color:rgb(220,0,52)">Handler</span>&lt;-</span><span style="color:rgb(220,0,52)">TargetLevelHandlers</span><span style="color:rgb(220,0,52); font-size:12px">],</span><span style="font-size:12px">
<span style="color:rgb(128,3,0)"><em>% 设定日志级别
</em></span>lager:set_loglevel({lager_file_backend, <span style="color:rgb(220,0,52)">LogFile</span>}, </span><span style="color:#dc0034">LogLevel</span><span style="font-size:12px">)</span></pre> 
<p></p> 
<p><br> </p> 
<p>好拉,就是这么简单.我只提供一个小思路,有不成熟的地方望大家多指点,具体代码就不贴了。</p> 
<p><br> </p> 
<p><br> </p> 
<p><br> </p> 
<p><br> </p> 
<p><br> </p> 
<p><br> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f0e09d958748b4e4fe09e98adddb7794/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[DBNETLIB][ConnectionOpen(Invalid Instance())] 无效的连接 的解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7104c6e4772648896c3cba49433a1883/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">数据库查询优化</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>