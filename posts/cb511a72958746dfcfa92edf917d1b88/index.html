<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mmdetection 代码库中的 anchor 设置原则 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mmdetection 代码库中的 anchor 设置原则" />
<meta property="og:description" content="本文主要介绍 CUHK 的 mmdetection 代码库 （https://github.com/open-mmlab/mmdetection）中关于 anchor 的设置的一些 tips。以下提到的所有 anchor 尺寸均为对应到输入图像上的bounding box 尺寸。 mmdetection 代码库总体框架还比较清晰，对于大部分经典的检测算法都有实现。大部分的接口参数都可以通过修改配置接口文件实现，配置文件在 ~/mmdetection/tree/master/configs/ 文件夹中。
一般来说，利用开源的检测代码库做自己的任务，一个肯定要考虑修改的地方便是 anchor 机制。因为自己检测任务中的目标的尺寸和高宽比和开源模型中的目标可能会不一致。
已 mmdetection 的 faster_rcnn_r50_fpn_1x.py 文件为例。本配置主要是算法是 Faster-RCNN &#43; RPN，目标任务是 COCO 物体检测。输入尺寸为 800 * 1333 左右，利用 FPN 在 5 个尺寸的 featuremap 上进行 anchor 设置。最小的 anchor 基准面积为 32 * 32，最大的基准面积为 512 * 512 （高宽比不同，面积相同）。
而如果自己准备输入的图像尺寸为 512 * 512，而且目标相对较小，比如面积在 16*16～32*32之间，那么anchor 设置就不能用默认的了。那么怎么在 mmdetection 代码库中根据自己的任务来设置 anchor 参数呢？
首先关注以下几个参数：
配置文件中的关键字段 其实，这里面有一个隐含参数没有显示出来就是：
anchor_base_sizes : 见～/mmdet/models/anchor_heads/anchor_head.py ；这个参数物理含义是base anchor 的高和宽。与 anchor_scales 共同决定了基准 anchor 的尺寸。为什么在这里没有显示呢？因为在代码中，anchor_base_sizes 被设置为与 anchor_strides 相同。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/cb511a72958746dfcfa92edf917d1b88/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-07T22:39:04+08:00" />
<meta property="article:modified_time" content="2020-04-07T22:39:04+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mmdetection 代码库中的 anchor 设置原则</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>本文主要介绍 CUHK 的 mmdetection 代码库 （<a href="https://github.com/open-mmlab/mmdetection">https://github.com/open-mmlab/mmdetection</a>）中关于 anchor 的设置的一些 tips。以下提到的所有 anchor 尺寸均为对应到输入图像上的bounding box 尺寸。 </p> 
<p>mmdetection 代码库总体框架还比较清晰，对于大部分经典的检测算法都有实现。大部分的接口参数都可以通过修改配置接口文件实现，配置文件在 ~/mmdetection/tree/master/configs/ 文件夹中。</p> 
<p>一般来说，利用开源的检测代码库做自己的任务，一个肯定要考虑修改的地方便是 anchor 机制。因为自己检测任务中的目标的尺寸和高宽比和开源模型中的目标可能会不一致。</p> 
<p>已 mmdetection 的 faster_rcnn_r50_fpn_1x.py 文件为例。本配置主要是算法是 Faster-RCNN + RPN，目标任务是 COCO 物体检测。输入尺寸为 800 * 1333 左右，利用 FPN 在 5 个尺寸的 featuremap 上进行 anchor 设置。最小的 anchor 基准面积为 32 * 32，最大的基准面积为 512 * 512 （高宽比不同，面积相同）。</p> 
<p>而如果自己准备输入的图像尺寸为 512 * 512，而且目标相对较小，比如面积在 16*16～32*32之间，那么anchor 设置就不能用默认的了。那么怎么在 mmdetection 代码库中根据自己的任务来设置 anchor 参数呢？</p> 
<p>首先关注以下几个参数：</p> 
<figure class="image"> 
 <img alt="配置文件中的关键字段" height="514" src="https://images2.imgbox.com/95/5d/swu1RWbj_o.png" width="1200"> 
 <figcaption>
   配置文件中的关键字段 
 </figcaption> 
</figure> 
<p>其实，这里面有一个隐含参数没有显示出来就是：</p> 
<p>anchor_base_sizes : 见～/<a href="https://github.com/open-mmlab/mmdetection/tree/master/mmdet">mmdet</a>/<a href="https://github.com/open-mmlab/mmdetection/tree/master/mmdet/models">models</a>/<a href="https://github.com/open-mmlab/mmdetection/tree/master/mmdet/models/anchor_heads">anchor_heads</a>/<strong>anchor_head.py</strong> ；这个参数物理含义是base anchor 的高和宽。与 anchor_scales 共同决定了基准 anchor 的尺寸。为什么在这里没有显示呢？因为在代码中，anchor_base_sizes 被设置为与 anchor_strides 相同。</p> 
<p>anchor_strides  -- 与 RPN 中选取的 feature map 尺寸有联动关系，这里 len(anchor_strides)==5，说明在 5 个feature map 上进行anchor 设置。一般原图到目标 feature map 缩小了多少倍，就设置为多少。anchor_strides 为 base anchor 族（一个基准  base size 的基准 anchor + 不同的高宽比的模版形成一个anchor 族）设置完成后平移的 stride，以保证设置的anchors 能覆盖原图所有区域。这里将 anchor_strides 设置为与 anchor_base_size 相同，目的是对于 FPN 的每一个 feature map 中anchor 生成的区域能刚好覆盖所有的原图区域。如果anchor_base_size 大于 anchor_stride 则会照成一些冗余，反之则会有一些区域覆盖不了（有兴趣自己可以画一下）。</p> 
<p>anchor_scales -- 默认为 [8, 16, 32]， 物理含义是base anchor 的倍数，与 anchor_base_sizes 共同决定anchor 的面积。比如在上图例子中，anchor_base_sizes == anchor_strides == [4, 8, 16, 32, 64]，anchor_scales == [8] 因此 anchor 最小面积为 (4*8)*(4*8) = 32 * 32, 最大面积为 (64*8)*(64*8) = 512 * 512。</p> 
<p></p> 
<p>anchor_ratio： 这个参数比较好理解，就是面积固定后，anchor 的高宽比。</p> 
<p>综上，如果我的任务中，目标面积为 16*16～32*32。那么我应该做如下参数设置：</p> 
<p>anchor_scales = [4]</p> 
<p>anchor_base_size = anchor_stride = [4, 8, 0, 0, 0]</p> 
<p>anchor_ratio 根据目标可能的高宽比来设置 （可以先做个统计，同样目标尺寸也可以先看以下统计分布）</p> 
<p> </p> 
<p>这样，其实anchor 就在浅层的 feature map 中获取，在深层不取anchor。（fpn中，浅层获取小目标anchor，深层获取大目标anchor）</p> 
<p><span style="color:#f33b45;">总结起来，如果要用 mmdetection 中的检测器适配自己的任务，那么在anchor 设置中，首先统计自己目标的尺寸和高宽比，然后按照上面的基本原理调整以上三个参数的配比即可。</span></p> 
<p>有问题，欢迎留言讨论。</p> 
<p>参考资料：</p> 
<p>1. Faster-RCNN 中的 anchor 与原图中 boundingbox 的对应关系 <a href="https://blog.csdn.net/yangyehuisw/article/details/105033932">https://blog.csdn.net/yangyehuisw/article/details/105033932</a></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fc090e823ed20e999f705a43df16d5ed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Qt中设置背景图，防止平铺</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6b6faa8c40bfdbb6dbc11826d7a09bfd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">js中paste粘贴事件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>