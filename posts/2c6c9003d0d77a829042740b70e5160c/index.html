<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>降维可视化（tSNE、UMAP、hypertools等）代码及效果对比 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="降维可视化（tSNE、UMAP、hypertools等）代码及效果对比" />
<meta property="og:description" content="在机器学习和深度学习领域，特征往往是高维度的，然而不幸的是，我们的电脑屏幕是二维的，我们的人眼也只能观察最多三维，所以必须对特征进行降维之后才能可视化。
一、准备工作：提取MNIST在LeNet5中的特征 方法很简单，我们在第一节的代码上修改，我们取出倒数第二个全连接层的输出特征，有84维。代码如下，多输出一个emb。
def forward(self, x): x = F.max_pool2d(F.relu(self.conv1(x)), (2, 2)) x = F.max_pool2d(F.relu(self.conv2(x)), (2, 2)) x = x.view(-1, self.num_flat_features(x)) x = F.relu(self.fc1(x)) emb = F.relu(self.fc2(x)) x = self.fc3(emb) return emb,x 然后用训练好的模型过一遍数据集，得到数据集所有样本的嵌入向量embs，同时也收集labels用于后面按类别画图：
model.eval() embs = [] labels = [] for data, target in test_loader: data, target = data.cuda(), target.cuda() emb,output = model(data) embs.append(emb.data.cpu().numpy()) labels.append(target.data.cpu().numpy()) embs = np.concatenate(embs) labels = np.concatenate(labels) 二、使用sklearn中的t-SNE可视化 使用tSNE可视化不用更改网络结构，直接对原网络得到的输出进行处理即可，sklearn中已经封装好此功能：
from sklearn.manifold import TSNE tsne = TSNE(n_components=2, learning_rate=200, metric=&#39;cosine&#39;,n_jobs=-1) tsne." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2c6c9003d0d77a829042740b70e5160c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-05T21:29:37+08:00" />
<meta property="article:modified_time" content="2021-03-05T21:29:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">降维可视化（tSNE、UMAP、hypertools等）代码及效果对比</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>  在机器学习和深度学习领域，特征往往是高维度的，然而不幸的是，我们的电脑屏幕是二维的，我们的人眼也只能观察最多三维，所以必须对特征进行降维之后才能可视化。</p> 
<h2><a id="MNISTLeNet5_2"></a>一、准备工作：提取MNIST在LeNet5中的特征</h2> 
<p>  方法很简单，我们在<a href="https://blog.csdn.net/Brikie/article/details/112253975">第一节</a>的代码上修改，我们取出倒数第二个全连接层的输出特征，有84维。代码如下，多输出一个emb。</p> 
<pre><code class="prism language-c">def <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token operator">:</span>
    x <span class="token operator">=</span> F<span class="token punctuation">.</span><span class="token function">max_pool2d</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">relu</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">conv1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> F<span class="token punctuation">.</span><span class="token function">max_pool2d</span><span class="token punctuation">(</span>F<span class="token punctuation">.</span><span class="token function">relu</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">conv2</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> x<span class="token punctuation">.</span><span class="token function">view</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span><span class="token function">num_flat_features</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> F<span class="token punctuation">.</span><span class="token function">relu</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">fc1</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    emb <span class="token operator">=</span> F<span class="token punctuation">.</span><span class="token function">relu</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span><span class="token function">fc2</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">fc3</span><span class="token punctuation">(</span>emb<span class="token punctuation">)</span>
    <span class="token keyword">return</span> emb<span class="token punctuation">,</span>x
</code></pre> 
<p>  然后用训练好的模型过一遍数据集，得到数据集所有样本的嵌入向量embs，同时也收集labels用于后面按类别画图：</p> 
<pre><code class="prism language-c">model<span class="token punctuation">.</span><span class="token function">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
embs <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> data<span class="token punctuation">,</span> target in test_loader<span class="token operator">:</span>
    data<span class="token punctuation">,</span> target <span class="token operator">=</span> data<span class="token punctuation">.</span><span class="token function">cuda</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> target<span class="token punctuation">.</span><span class="token function">cuda</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    emb<span class="token punctuation">,</span>output <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    embs<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>emb<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">numpy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    labels<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">cpu</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">numpy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
embs <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">concatenate</span><span class="token punctuation">(</span>embs<span class="token punctuation">)</span>
labels <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">concatenate</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="sklearntSNE_27"></a>二、使用sklearn中的t-SNE可视化</h2> 
<p>  使用tSNE可视化不用更改网络结构，直接对原网络得到的输出进行处理即可，sklearn中已经封装好此功能：</p> 
<pre><code class="prism language-c">from sklearn<span class="token punctuation">.</span>manifold import TSNE
tsne <span class="token operator">=</span> <span class="token function">TSNE</span><span class="token punctuation">(</span>n_components<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token number">200</span><span class="token punctuation">,</span> metric<span class="token operator">=</span><span class="token string">'cosine'</span><span class="token punctuation">,</span>n_jobs<span class="token operator">=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
tsne<span class="token punctuation">.</span><span class="token function">fit_transform</span><span class="token punctuation">(</span>embs<span class="token punctuation">)</span>
outs_2d <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span>tsne<span class="token punctuation">.</span>embedding_<span class="token punctuation">)</span>

import matplotlib<span class="token punctuation">.</span>pyplot as plt
import matplotlib<span class="token punctuation">.</span>colors as mcolors
css4 <span class="token operator">=</span> <span class="token function">list</span><span class="token punctuation">(</span>mcolors<span class="token punctuation">.</span>CSS4_COLORS<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
#我选择了一些较清楚的颜色，更多的类时也能画清晰
color_ind <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">9</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">16</span><span class="token punctuation">,</span><span class="token number">17</span><span class="token punctuation">,</span><span class="token number">19</span><span class="token punctuation">,</span><span class="token number">20</span><span class="token punctuation">,</span><span class="token number">21</span><span class="token punctuation">,</span><span class="token number">25</span><span class="token punctuation">,</span><span class="token number">28</span><span class="token punctuation">,</span><span class="token number">30</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">,</span><span class="token number">32</span><span class="token punctuation">,</span><span class="token number">37</span><span class="token punctuation">,</span><span class="token number">38</span><span class="token punctuation">,</span><span class="token number">40</span><span class="token punctuation">,</span><span class="token number">47</span><span class="token punctuation">,</span><span class="token number">51</span><span class="token punctuation">,</span>
         <span class="token number">55</span><span class="token punctuation">,</span><span class="token number">60</span><span class="token punctuation">,</span><span class="token number">65</span><span class="token punctuation">,</span><span class="token number">82</span><span class="token punctuation">,</span><span class="token number">85</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">,</span><span class="token number">106</span><span class="token punctuation">,</span><span class="token number">110</span><span class="token punctuation">,</span><span class="token number">115</span><span class="token punctuation">,</span><span class="token number">118</span><span class="token punctuation">,</span><span class="token number">120</span><span class="token punctuation">,</span><span class="token number">125</span><span class="token punctuation">,</span><span class="token number">131</span><span class="token punctuation">,</span><span class="token number">135</span><span class="token punctuation">,</span><span class="token number">139</span><span class="token punctuation">,</span><span class="token number">142</span><span class="token punctuation">,</span><span class="token number">146</span><span class="token punctuation">,</span><span class="token number">147</span><span class="token punctuation">]</span>
css4 <span class="token operator">=</span> <span class="token punctuation">[</span>css4<span class="token punctuation">[</span>v<span class="token punctuation">]</span> <span class="token keyword">for</span> v in color_ind<span class="token punctuation">]</span>
<span class="token keyword">for</span> lbi in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">:</span>
    temp <span class="token operator">=</span> outs_2d<span class="token punctuation">[</span>labels<span class="token operator">==</span>lbi<span class="token punctuation">]</span>
    plt<span class="token punctuation">.</span><span class="token function">plot</span><span class="token punctuation">(</span>temp<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>temp<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span>color<span class="token operator">=</span>css4<span class="token punctuation">[</span>lbi<span class="token punctuation">]</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'feats dimensionality reduction visualization by tSNE,test data'</span><span class="token punctuation">)</span>
</code></pre> 
<p>  注意在TSNE的参数中可以指定距离类型metric，默认是euclidean，我这里使用了cosine，还可以是correlation等其他距离。<br> <img src="https://images2.imgbox.com/d4/74/TqxfRpqw_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/93/f6/OG3GGYrt_o.png" alt="在这里插入图片描述"></p> 
<center> 
 <b><font size="1">图1. 用sklearn的tSNE法画出MNIST嵌入特征的分布，两次</font></b> 
</center> 
<p>  可以看出，由于随机种子的不同，每次画出来的结果不一样，每个类别的形态是大致一样的，但相对位置会有变化，这也说明tSNE在降维的时候能够保证较近的点的距离关系，但不能保证较远的点的距离关系，通常也就是类内和类间能够很好的体现，但类间的距离关系不能体现。比如黑色和红色的类在第一张图中很近，但在第二张图中很远。或者从另一个角度说，tSNE在降维的同时，也具备一定的分类能力。</p> 
<h2><a id="hypertools_56"></a>三、使用hypertools中的多种降维方法</h2> 
<p>  hypertools是Kaggle推出的一种降维工具包，集成了多种降维算法，如PCA、TSNE、Isomap、UMAP等。此外还有聚类算法和对齐算法等，用起来更加方便。可以用pip install hypertools安装。降维和画图的核心代码用一行搞定：</p> 
<pre><code class="prism language-c">import hypertools as hyp
import matplotlib<span class="token punctuation">.</span>pyplot as plt
hyp<span class="token punctuation">.</span><span class="token function">plot</span><span class="token punctuation">(</span>embs<span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span>reduce<span class="token operator">=</span><span class="token string">'TSNE'</span><span class="token punctuation">,</span>ndims<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>hue<span class="token operator">=</span>labels<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'TSNE'</span><span class="token punctuation">)</span>
</code></pre> 
<p>  注意，这个hyp.plot画的图内部也是调用matplotlib.pyplot，所以可以直接混合使用plt的命令实现更多的画图功能，如上面的plt.title()。下面给出各种降维方法的效果：<br> <img src="https://images2.imgbox.com/de/90/SZnt7iLa_o.png" alt="在这里插入图片描述"></p> 
<center> 
 <b><font size="1">图2. 用hypertools的各种降维方法画出MNIST嵌入特征的分布</font></b> 
</center> 
<p>  通常TSNE和UMAP两种方法可视化效果较好，其他的如PCA更多的保留了样本间距离信息的比例关系，反而看起来各类分的不是那么开，而UMAP则更极端一些，它把各类间区分的相当开。<br> 使用hypertools也可以实现聚类，带的聚类算法有K-Means, AgglomerativeClustering, Birch, FeatureAgglomeration, SpectralClustering这几种。如果没有labels信息，可以先聚类，用聚类结果代替labels画出各簇的图：</p> 
<pre><code class="prism language-c">clust <span class="token operator">=</span> hyp<span class="token punctuation">.</span><span class="token function">cluster</span><span class="token punctuation">(</span>embs<span class="token punctuation">,</span> cluster<span class="token operator">=</span><span class="token string">'KMeans'</span><span class="token punctuation">,</span>n_clusters <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span>
hyp<span class="token punctuation">.</span><span class="token function">plot</span><span class="token punctuation">(</span>embs<span class="token punctuation">,</span><span class="token string">'.'</span><span class="token punctuation">,</span>reduce<span class="token operator">=</span><span class="token string">'TSNE'</span><span class="token punctuation">,</span>ndims<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>hue<span class="token operator">=</span>clust<span class="token punctuation">)</span>
plt<span class="token punctuation">.</span><span class="token function">title</span><span class="token punctuation">(</span><span class="token string">'TSNE, clutering by KMeans'</span><span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/48/d4/PG63w20E_o.png" alt="在这里插入图片描述"></p> 
<center> 
 <b><font size="1">图3. 用hypertools的KMeans聚类后再用TSNE画出MNIST嵌入特征的分布</font></b> 
</center> 
<p>  最后说一个小细节，注意看图3的各簇中仍有一些其他簇的“噪点”，这些噪点应是TSNE分类和KMeans分类的误差造成的，这也说明图2中的噪点也不全是标注错误造成的。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/89384bbca660ea6054367dc0bbb27d9a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">flink动态表中的窗口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/39f52e3d65c6067e50a41e8715d6359c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker连不上宿主机mysql_Docker从宿主机挂载卷到Mysql镜像之坑</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>