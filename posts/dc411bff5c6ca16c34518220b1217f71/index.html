<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Hologres使用小记 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Hologres使用小记" />
<meta property="og:description" content="1、Hologres 0.8 创建数组类型外部表采坑
ODPS:CREATE TABLE `test_clue` ( `id_c` array&lt;bigint&gt;, `name` array&lt;string&gt; ) ;
Holo:
CREATE FOREIGN TABLE test_clue(
id int8[],
name text[])
SERVER odps_server
OPTIONS(project_name &#39;itsl_dev&#39;, table_name &#39;test_clue&#39;);
报错：
原因：odps文件类型不是orc
odps的文件类型有哪些：？？aliorc
hive的文件存储类型：
||SequenceFile
Hadoop用来存储二进制形式的[Key,Value]对而设计的一种平面文件(Flat File)。
||TextFile文本格式
||RCFile一种列存储格式
||ORC ★一种列存储格式 进阶版RCFile
||Parquet ★一种列存储格式AVRO
||JsonFile（json文件）
||InputFormat
解决办法：
odps建表前加：
set odps.sql.default.file.format=aliorc;
set odps.storage.force.aliorc=true;
CREATE TABLE `test_clue` ( `id_c` array&lt;bigint&gt;, `name` array&lt;string&gt; ) ;
2、Hologres 0.8 使用get_json_object函数
先用super账号设置开启hive函数支持：CREATE extension hive_compatible;
SELECT
get_json_object(message,&#39;$.profileData.advertisingID&#39;) AS advertisingID" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/dc411bff5c6ca16c34518220b1217f71/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-08T09:37:56+08:00" />
<meta property="article:modified_time" content="2023-03-08T09:37:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Hologres使用小记</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="background-color:#38d8f0;">1、Hologres 0.8 创建数组类型外部表采坑</span></p> 
<p></p> 
<p>ODPS:CREATE TABLE `test_clue` ( `id_c` array&lt;bigint&gt;, `name` array&lt;string&gt; ) ;</p> 
<p>Holo:</p> 
<p>CREATE FOREIGN TABLE test_clue(</p> 
<p>id int8[],</p> 
<p>name text[])</p> 
<p>SERVER odps_server</p> 
<p>OPTIONS(project_name 'itsl_dev', table_name 'test_clue');</p> 
<p>报错：<span style="background-color:#38d8f0;"><img alt="" height="595" src="https://images2.imgbox.com/ed/41/3rnNJg4k_o.png" width="1200"></span></p> 
<p> 原因：odps文件类型不是orc</p> 
<p>odps的文件类型有哪些：？？aliorc</p> 
<p>hive的文件存储类型：</p> 
<p>||SequenceFile<br> Hadoop用来存储二进制形式的[Key,Value]对而设计的一种平面文件(Flat File)。</p> 
<p>||TextFile文本格式</p> 
<p>||RCFile一种列存储格式</p> 
<p>||ORC ★一种列存储格式 进阶版RCFile</p> 
<p>||Parquet ★一种列存储格式AVRO</p> 
<p>||JsonFile（json文件）</p> 
<p>||InputFormat</p> 
<p>解决办法：</p> 
<p>odps建表前加：</p> 
<p>set odps.sql.default.file.format=aliorc;</p> 
<p>set odps.storage.force.aliorc=true;</p> 
<p>CREATE TABLE `test_clue` ( `id_c` array&lt;bigint&gt;, `name` array&lt;string&gt; ) ;</p> 
<p></p> 
<p><span style="background-color:#38d8f0;">2、Hologres 0.8 使用get_json_object函数</span></p> 
<p>先用super账号设置开启hive函数支持：CREATE extension hive_compatible;</p> 
<p>SELECT</p> 
<p>get_json_object(message,'$.profileData.advertisingID') AS advertisingID</p> 
<p>,get_json_object(message,'$.profileData.appKey') AS appkey</p> 
<p>,get_json_object(message,'$.profileData.identityId') AS identityId</p> 
<p>,get_json_object(message,'$.profileData.productid') AS productid</p> 
<p>,get_json_object(message,'$.profileData.properties._td_mobile') AS td_mobile</p> 
<p>,get_json_object(message,'$.profileData.properties._td_pixel') AS td_pixel</p> 
<p>,get_json_object(message,'$.profileData.properties._td_platform') AS td_platform</p> 
<p>,get_json_object(message,'$.profileData.properties._td_brand') AS td_brand</p> 
<p>,get_json_object(message,'$.profileData.properties.tenantid') AS tenantid</p> 
<p>,get_json_object(message,'$.profileData.properties._td_os') AS td_os</p> 
<p>,get_json_object(message,'$.type') AS TYPE</p> 
<p>,get_json_object(message,'$.version') AS version</p> 
<p>,get_json_object(message,'$.profileData.properties._td_sdk_source') AS td_sdk_source</p> 
<p>,get_json_object(message,'$.profileData.properties._td_browser') AS td_browser</p> 
<p>,get_json_object(message,'$.profileData.properties._td_channel') AS td_channel</p> 
<p>FROM ti_datahub_ae_collector_data_4h</p> 
<p>;</p> 
<p><span style="background-color:#38d8f0;">3、hologres 优化查询设置</span></p> 
<p>①analyze &lt;tablename&gt; ;分析元数据，优化查询方式</p> 
<p>②建表增加索引：</p> 
<p>分布式键distribution_key：</p> 
<p>call set_table_property('table1','distribution key','b');</p> 
<p>指定分布列，数据将按照指定列，将数据shuffle到各个shard，同样的数值肯定会在同样的shrad中。<br> 例：select count(1) from tmp1 join tmp2 on tmp1.a = tmp2.b<br> 注：对于有pk的表，其分布键默认就是pk，如果不想pk字段作为分布键，可以指定pk字段的子集，但是不能随意指定。可以通过shard_count来指定表的shard数，如果不指定的话每个数据库都有一个默认的shard数，一旦指定了一个表的shard数，其他的表如果想要和这个表做local join，就必须指定colcate with这个表。</p> 
<p>聚簇索引 Clustering key：对建立索引数据进行排序，建立聚簇索引能够加速用户在索引列上的range和filter查询；注：desc和asc表名构建索引时的排序方式，默认为asc。clustering key创建的时候数据类型不能为float/double，每个表最多只有一个clustering key：<br> 如：call set_table_property('table1','clustering_key','a'); or call set_table_property('tbl', 'clustering_key', 'a:desc,b:asc');</p> 
<p>比特编码列bitmap：指定比特编码列使Hologres会在这些列上构建比特编码，相当于把数据与对应的行号做一个映射；注：bitmap可以对segment内部的数据进行快速过滤，因此建议把filter条件的数据建成比特编码。目前Hologres会默认所有text列都会被隐藏式地设置到bitmap_columns中。但是只有列存表支持比特编码列</p> 
<p>分段键Segment Key：分段键帮助Hologres进行一些文件的快速筛选和跳过。指定分段键，当查询条件包含分段列时，查询可以通过segment key快速找到相应数据对应的存储位置。注：segment key要求按照数据输入自增，一般只有时间类型的字段（timestamptz）适合设置为segment key，其他场景基本不需要设置。只有列存表支持分段键设置。</p> 
<p>字典编码列设置：</p> 
<p>call set_table_property('table1','dictionary_encoding_columns','b');</p> 
<p>字典编码可以将字符串的比较转换成数字的比较，加速group by查询<br> 例：select sum(a) from table1 group by b;<br> 注：不建议将基数高的列建为字典编码列，会导致查询性能变差。目前Hologres会默认所有text列都会被隐藏式地设置到bitmap_columns中。但是只有列存表支持比特编码列</p> 
<p>③存储类型：call set_table_property('table1','orientation','[row|colume]');</p> 
<p>行存适用于高QPS的基于primary key的点查询，例如where pk=abc,其余场景都应该选用列存方式。</p> 
<p>例如：</p> 
<pre><code>drop TABLE tags_humanbeings;
BEGIN;
CREATE TABLE public.tags_humanbeings (
 "oneid" text,
 "ssoid" text,
 "uid" text,
 "phone" text,
 "name" text,
 "idcard" text,
 "action" int8,
 "date_created" timestamptz,
 "gender" int8,
 "age_group" int8,
 "constellation" int8,
 "generation" int8,
 "education" int8,
 "birthday" text,
 "marital_status" int8,
 "occupation" int8,
 "industry" int8,
 "native_province" int8,
 "native_city" int8,
 "native_city_level" int8,
 "material_cost" text,
 
 PRIMARY KEY (oneid)
);
--分布式键
call set_table_property('public.tags_humanbeings',	'distribution_key',	'oneid');	
--存储方式 列存 行存		
CALL SET_TABLE_PROPERTY('public.tags_humanbeings',	'orientation',	'column');			
CALL SET_TABLE_PROPERTY('public.tags_humanbeings',	'time_to_live_in_seconds',	'3153600000');	
--dictionary_encoding_columns
CALL SET_TABLE_PROPERTY('public.tags_humanbeings', 'dictionary_encoding_columns', 'oneid');
--CALL SET_TABLE_PROPERTY('public.tags_humanbeings', 'clustering_key','oneid'); 默认和主键一致
--bitmap_columns
CALL SET_TABLE_PROPERTY('', 'bitmap_columns', 'phone:on,name:on,birthday:off,material_cost:off');
call set_table_property('public.tags_humanbeings','segment key','date_created');
comment on table public.tags_humanbeings is '人标签表';
COMMIT ;</code></pre> 
<p></p> 
<p><span style="background-color:#38d8f0;">4、调优</span></p> 
<p>当表数据量较大时，可设置以下参数进行调优；</p> 
<p>set hg_experimental_query_batch_size = 4096; --默认8192</p> 
<p>set hg_experimental_foreign_table_executor_max_dop = 32; --默认64</p> 
<p></p> 
<p><span style="color:#0d0016;"><span style="background-color:#38d8f0;">5、BitmapRoaringRoaring</span></span><span style="color:#ffffff;"><span style="background-color:#38d8f0;"> </span></span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">1</span><span style="color:#000000;">、</span><span style="color:#000000;"><strong>CREATE</strong></span><span style="color:#000000;"> EXTENSION </span><span style="color:#000000;">roaringbitmap</span><span style="color:#000000;">;  </span></p> 
<p style="margin-left:0in;text-align:left;">      <span style="color:#000000;">Roaring Bitmap</span><span style="color:#000000;">函数在使用之前，需要执行以下语句开启</span><span style="color:#000000;">extension</span><span style="color:#000000;">才可以调用。</span><span style="color:#000000;">extension</span><span style="color:#000000;">是</span><span style="color:#000000;">DB</span><span style="color:#000000;">级别的函数，一个</span><span style="color:#000000;">DB</span><span style="color:#000000;">只需执行一次即可，新建</span><span style="color:#000000;">DB</span><span style="color:#000000;">需要重新执行</span><span style="color:#000000;">。</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">不支持将</span><span style="color:#000000;">Roaring Bitmap</span><span style="color:#000000;">设置为</span><span style="color:#000000;">Bitmap</span><span style="color:#000000;">或者</span><span style="color:#000000;">Dictionary</span><span style="color:#000000;">。</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">2</span><span style="color:#000000;">、 </span><span style="color:#000000;">建表</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">BEGIN</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">CREATE TABLE </span><span style="color:#000000;">public.user_tags</span><span style="color:#000000;"> (</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">"</span><span style="color:#000000;">tag_key</span><span style="color:#000000;">" text,</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">"</span><span style="color:#000000;">tag_value</span><span style="color:#000000;">" text,</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">"</span><span style="color:#000000;">userlist</span><span style="color:#000000;">" </span><span style="color:#000000;">roaringbitmap</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">) ;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">CALL SET_TABLE_PROPERTY('</span><span style="color:#000000;">public.user_tags</span><span style="color:#000000;">', 'orientation', 'column');</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">CALL SET_TABLE_PROPERTY('</span><span style="color:#000000;">public.user_tags</span><span style="color:#000000;">', '</span><span style="color:#000000;">bitmap_columns</span><span style="color:#000000;">', '</span><span style="color:#000000;">tag_key,tag_value</span><span style="color:#000000;">');</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">CALL SET_TABLE_PROPERTY('</span><span style="color:#000000;">public.user_tags</span><span style="color:#000000;">', '</span><span style="color:#000000;">dictionary_encoding_columns</span><span style="color:#000000;">', '</span><span style="color:#000000;">tag_key:auto,tag_value:auto</span><span style="color:#000000;">');</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">COMMIT</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">3</span><span style="color:#000000;">、写入</span><span style="color:#000000;">数据</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">①</span><span style="color:#000000;">MC</span><span style="color:#000000;">中</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">INSERT OVERWRITE TABLE </span><span style="color:#000000;">tm_tag_userprofile_attribute_all_d_roaringbitmap</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT *</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">,(</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT ROW_NUMBER() OVER(PARTITION BY 1 ORDER BY phone ASC) </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">FROM (SELECT DISTINCT phone FROM </span><span style="color:#000000;">tm_tag_userprofile_attribute_all_d</span><span style="color:#000000;"> WHERE </span><span style="color:#000000;">data_date</span><span style="color:#000000;">=20220316 ) t </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">WHERE </span><span style="color:#000000;">t.phone</span><span style="color:#000000;">=t1.phone</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">) as </span><span style="color:#000000;">rk</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">FROM </span><span style="color:#000000;">tm_tag_userprofile_attribute_all_d</span><span style="color:#000000;"> t1</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">WHERE </span><span style="color:#000000;">data_date</span><span style="color:#000000;"> = 20220316</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">由于是测试，所以用户</span><span style="color:#000000;">ID</span><span style="color:#000000;">通过</span><span style="color:#000000;">RK</span><span style="color:#000000;">来代替，如果实际使用，应该通过</span><span style="color:#000000;">oneid</span><span style="color:#000000;">表生成唯一的</span><span style="color:#000000;">ID</span><span style="color:#000000;">，生成</span><span style="color:#000000;">ID</span><span style="color:#000000;">的目的是为了配合</span><span style="color:#000000;">roaringbitmap</span><span style="color:#000000;">字段的使用，因为该字段只支持</span><span style="color:#000000;">INT</span><span style="color:#000000;">类型的数据。</span></p> 
<p style="margin-left:0in;text-align:left;"><strong><span style="color:#000000;"><span style="background-color:#38d8f0;">4</span></span><span style="color:#000000;"><span style="background-color:#38d8f0;">、写入数据</span></span></strong></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">①一些基础操作</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">创建表组：</span><span style="color:#000000;">CALL HG_CREATE_TABLE_GROUP ('</span><span style="color:#000000;">mdp</span><span style="color:#000000;">', 40);</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">修改表所属表组：</span><span style="color:#000000;">CALL HG_UPDATE_TABLE_SHARD_COUNT('user_tags','</span><span style="color:#000000;">mdp</span><span style="color:#000000;">');</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">创建</span><span style="color:#000000;">schema:create</span> <span style="color:#000000;">schema </span><span style="color:#000000;">mdp</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">切换</span><span style="color:#000000;">schema :set </span><span style="color:#000000;">search_path</span><span style="color:#000000;"> to </span><span style="color:#000000;">mdp</span><span style="color:#000000;">; --</span><span style="color:#000000;">切换至目标</span><span style="color:#000000;">Schema</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">②外表向内表写入数据</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SET </span><span style="color:#000000;">hg_experimental_query_batch_size</span><span style="color:#000000;"> = 4096</span><span style="color:#000000;">;</span><br><span style="color:#000000;">SET </span><span style="color:#000000;">hg_experimental_foreign_table_executor_max_dop</span><span style="color:#000000;"> = 32</span><span style="color:#000000;">;</span><br><span style="color:#000000;">INSERT INTO </span><span style="color:#000000;">mdp.user_tags</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT </span><span style="color:#000000;">tag_id</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">,</span><span style="color:#000000;">tag_value_code</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">,</span><span style="color:#000000;">rb_build</span><span style="color:#000000;">(</span><span style="color:#000000;">array_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">rk</span><span style="color:#000000;">::INT)) </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">FROM </span><span style="color:#000000;">(SELECT *FROM </span><span style="color:#000000;">public.tm_tag_userprofile_attribute_all_d_roaringbitmap</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">WHERE RK &gt; 40000000</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">) t</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">GROUP BY </span><span style="color:#000000;">tag_id</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">,</span><span style="color:#000000;">tag_value_code</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;"><span style="background-color:#fe2c24;">5</span></span><span style="color:#000000;"><span style="background-color:#fe2c24;">、瓶颈</span></span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">①</span><span style="color:#000000;">MC</span><span style="color:#000000;">窄表数据量</span><span style="color:#000000;">1827194847/ bitmap</span><span style="color:#000000;">表数据量：</span> <span style="color:#000000;">106010293 </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">测试环境</span><span style="color:#000000;">:CPU: 50core, </span><span style="color:#000000;">mem</span><span style="color:#000000;">: 200GB;shard=40 </span><span style="color:#000000;">，新建的</span><span style="color:#000000;">table_group</span><span style="color:#000000;">=</span><span style="color:#000000;">mdp</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">正式</span><span style="color:#000000;">环境</span><span style="color:#000000;">:CPU: 140core, </span><span style="color:#000000;">mem</span><span style="color:#000000;">: </span><span style="color:#000000;">560GB;shard=40</span><span style="color:#000000;">，新建</span><span style="color:#000000;">的</span><span style="color:#000000;">table_group</span><span style="color:#000000;">=</span><span style="color:#000000;">mdp</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">正式环境</span><span style="color:#000000;">:CPU: 140core, </span><span style="color:#000000;">mem</span><span style="color:#000000;">: 560GB;shard=80</span><span style="color:#000000;">，新建的</span><span style="color:#000000;">table_group</span><span style="color:#000000;">=</span><span style="color:#000000;">mdp</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">当前配置无法一次性写入数据，报错链接超时或内存溢出</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">测试</span><span style="color:#000000;">环境</span><span style="color:#000000;">shard=40</span><span style="color:#000000;">每</span><span style="color:#000000;">500W </span><span style="color:#000000;">写一次 会偶尔链接超时，多次尝试可以写入 </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">正式环境</span><span style="color:#000000;">shard=40</span><span style="color:#000000;">每 </span><span style="color:#000000;">2000W</span><span style="color:#000000;">写一次 写入</span><span style="color:#000000;">正常</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">正式环境</span><span style="color:#000000;">shard=80</span><span style="color:#000000;">每 </span><span style="color:#000000;">可以全量写入 写入时长</span><span style="color:#000000;">573898 </span><span style="color:#000000;">ms</span><span style="color:#000000;">：</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">②多次写入数据无法正常使用，因为位运算的原因</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">a)</span><span style="color:#000000;">单</span><span style="color:#000000;">次写入</span><span style="color:#000000;">RK&lt;20000000</span><span style="color:#000000;">计算</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT </span><span style="color:#000000;">Rb_cardinality</span><span style="color:#000000;">(</span><span style="color:#000000;">Rb_and</span><span style="color:#000000;">(t1.r, t2.r))</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">FROM </span><span style="color:#000000;">(</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  SELECT </span><span style="color:#000000;">Rb_and_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">userlist</span><span style="color:#000000;">) AS r</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  FROM </span><span style="color:#000000;">user_tags</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  WHERE </span><span style="color:#000000;">tag_key</span><span style="color:#000000;"> = '100001'</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  AND </span><span style="color:#000000;">tag_value</span><span style="color:#000000;"> = '</span><span style="color:#000000;">男</span><span style="color:#000000;">'</span> <span style="color:#000000;">)</span> <span style="color:#000000;">AS t1,</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  (</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  SELECT </span><span style="color:#000000;">rb_and_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">userlist</span><span style="color:#000000;">) AS r</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  FROM </span><span style="color:#000000;">user_tags</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  WHERE </span><span style="color:#000000;">tag_key</span><span style="color:#000000;"> = '100002'</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  AND </span><span style="color:#000000;">tag_value</span><span style="color:#000000;"> = '30-35</span><span style="color:#000000;">岁</span><span style="color:#000000;">'</span> <span style="color:#000000;">)</span> <span style="color:#000000;">AS t2</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"></p> 
<p style="margin-left:0in;text-align:left;"><strong><span style="color:#000000;"><span style="background-color:#38d8f0;">6</span></span><span style="color:#000000;"><span style="background-color:#38d8f0;">、圈选测试</span></span></strong></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">正式环境圈选测试：</span><span style="color:#000000;">shard=80</span><span style="color:#000000;"> 时间</span><span style="color:#000000;">20220323</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">①</span><span style="color:#000000;">宽表圈选 性别男</span><span style="color:#000000;">&amp;</span><span style="color:#000000;">年龄</span><span style="color:#000000;">30-35</span><span style="color:#000000;">岁</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT </span><span style="color:#000000;">count(DISTINCT </span><span style="color:#000000;">oneid</span><span style="color:#000000;">) FROM </span><span style="color:#000000;">tt_sl_tag_userprofile_attribute_all_mdp_holo_d</span><span style="color:#000000;"> WHERE gender=3 and </span><span style="color:#000000;">age_group</span><span style="color:#000000;">=7;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">耗时：</span> <span style="color:#000000;">867ms  </span><span style="color:#000000;">统计值： </span><span style="color:#000000;">1574459</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">②</span><span style="color:#000000;">Roaring Bitmap</span><span style="color:#000000;">圈选</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT </span><span style="color:#000000;">Rb_cardinality</span><span style="color:#000000;">(</span><span style="color:#000000;">Rb_and</span><span style="color:#000000;">(t1.r, t2.r</span><span style="color:#000000;">)) FROM (</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  SELECT </span><span style="color:#000000;">Rb_and_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">userlist</span><span style="color:#000000;">) AS r</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">  FROM user_tags1 WHERE </span><span style="color:#000000;">tag_key</span><span style="color:#000000;"> = ‘100001</span><span style="color:#000000;">’</span><span style="color:#000000;"> AND </span><span style="color:#000000;">tag_value</span><span style="color:#000000;"> = '</span><span style="color:#000000;">男</span><span style="color:#000000;">'</span> <span style="color:#000000;">)</span> <span style="color:#000000;">AS t1,</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">        (SELECT </span><span style="color:#000000;">rb_and_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">userlist</span><span style="color:#000000;">) AS </span><span style="color:#000000;">r FROM user_tags1 WHERE </span><span style="color:#000000;">tag_key</span><span style="color:#000000;"> = '100002'</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">          AND </span><span style="color:#000000;">tag_value</span><span style="color:#000000;"> = '30-35</span><span style="color:#000000;">岁</span><span style="color:#000000;">'</span> <span style="color:#000000;">)</span> <span style="color:#000000;">AS </span><span style="color:#000000;">t2;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">耗时：</span> <span style="color:#000000;">506ms </span><span style="color:#000000;">统计值： </span><span style="color:#000000;">1574459</span></p> 
<p style="margin-left:0in;text-align:left;"><strong><span style="color:#000000;"><span style="background-color:#38d8f0;">7</span></span><span style="color:#000000;"><span style="background-color:#38d8f0;">、圈选测试</span></span></strong></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">正式环境圈选测试：</span><span style="color:#000000;">shard=80</span><span style="color:#000000;"> 时间</span><span style="color:#000000;">20220323</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">①</span><span style="color:#000000;">宽表圈选 是否车主：是</span><span style="color:#000000;">&amp;</span><span style="color:#000000;">品牌：WWW</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT count(DISTINCT </span><span style="color:#000000;">a.oneid</span><span style="color:#000000;">) </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">FROM </span><span style="color:#000000;">tt_sl_tag_userprofile_attribute_all_mdp_holo_d</span><span style="color:#000000;"> a join </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">tt_sl_tag_userprofile_vehicle_rel_all_mdp_holo_d</span><span style="color:#000000;"> b </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">ON </span><span style="color:#000000;">a.oneid</span><span style="color:#000000;"> = </span><span style="color:#000000;">b.oneid</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">WHERE (owner=3795 and </span><span style="color:#000000;">car_brand</span><span style="color:#000000;">=111);</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">耗时：</span> <span style="color:#000000;">432</span><span style="color:#000000;">ms  </span><span style="color:#000000;">统计值： </span><span style="color:#000000;">412298</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">②</span><span style="color:#000000;">Roaring Bitmap</span><span style="color:#000000;">圈选</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT </span><span style="color:#000000;">Rb_cardinality</span><span style="color:#000000;">(</span><span style="color:#000000;">Rb_and</span><span style="color:#000000;">(t1.r, t2.r</span><span style="color:#000000;">)) FROM </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">(SELECT </span><span style="color:#000000;">Rb_and_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">userlist</span><span style="color:#000000;">) AS </span><span style="color:#000000;">r FROM user_tags1 WHERE </span><span style="color:#000000;">tag_key</span><span style="color:#000000;"> = '100270'</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">AND </span><span style="color:#000000;">tag_value</span><span style="color:#000000;"> = '</span><span style="color:#000000;">是</span><span style="color:#000000;">'</span> <span style="color:#000000;">)</span> <span style="color:#000000;">AS t1,</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">(SELECT </span><span style="color:#000000;">rb_and_agg</span><span style="color:#000000;">(</span><span style="color:#000000;">userlist</span><span style="color:#000000;">) AS </span><span style="color:#000000;">r FROM </span><span style="color:#000000;">vehicle_tagsWHERE</span> <span style="color:#000000;">tag_key</span><span style="color:#000000;"> = '100020'</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">AND </span><span style="color:#000000;">tag_value</span><span style="color:#000000;"> = 'WWW' ) AS t2</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">耗时：</span> <span style="color:#000000;">309</span><span style="color:#000000;">ms </span><span style="color:#000000;">统计值： </span><span style="color:#000000;">412234</span></p> 
<p style="margin-left:0in;text-align:left;"><strong><span style="background-color:#38d8f0;">8、</span><span style="color:#000000;"><span style="background-color:#38d8f0;">更新写入，必须有主键</span></span></strong></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">如表</span><span style="color:#000000;">tb1 </span><span style="color:#000000;">数据</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">BEGIN;CREATE </span><span style="color:#000000;">TABLE tbl_1 </span><span style="color:#000000;">(a </span><span style="color:#000000;">int</span><span style="color:#000000;"> NOT NULL PRIMARY </span><span style="color:#000000;">KEY,b</span> <span style="color:#000000;">int,c</span> <span style="color:#000000;">int</span><span style="color:#000000;">);</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">INSERT INTO </span><span style="color:#000000;">tbl_1 VALUES </span><span style="color:#000000;">(1, 1, 1), (2, 3, 4</span><span style="color:#000000;">);</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">1</span><span style="color:#000000;">、支持更新某个字段，如通过主键</span><span style="color:#000000;">a</span><span style="color:#000000;">更新字段</span><span style="color:#000000;">b</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">INSERT INTO tbl_1 (a, </span><span style="color:#000000;">b)SELECT </span><span style="color:#000000;">d,e</span><span style="color:#000000;"> FROM</span> <span style="color:#000000;">tbl_2</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">ON CONFLICT (</span><span style="color:#000000;">a) DO </span><span style="color:#000000;">UPDATE </span><span style="color:#000000;">SET b </span><span style="color:#000000;">= </span><span style="color:#000000;">excluded.b</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">SELECT * FROM tbl_1</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">2</span><span style="color:#000000;">、支持更新</span><span style="color:#000000;">整</span><span style="color:#000000;">行，如通过主键</span><span style="color:#000000;">a</span><span style="color:#000000;">更新所有列</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">INSERT INTO tbl_1 (a, b, </span><span style="color:#000000;">c) SELECT</span> <span style="color:#000000;">d,e,f</span> <span style="color:#000000;">FROM</span> <span style="color:#000000;">tbl_2</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">ON CONFLICT (</span><span style="color:#000000;">a) DO </span><span style="color:#000000;">UPDATE </span><span style="color:#000000;">SET (</span><span style="color:#000000;">a,b,c</span><span style="color:#000000;">) = ROW (excluded</span><span style="color:#000000;">.*)</span></p> 
<p style="margin-left:0in;text-align:left;"></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">3</span><span style="color:#000000;">、支持主键不存在追加</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">INSERT INTO </span><span style="color:#000000;">tbl_1 VALUES </span><span style="color:#000000;">(3, 2, 3)</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">ON CONFLICT (</span><span style="color:#000000;">a) DO </span><span style="color:#000000;">UPDATE SET</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">(a, b, c) = ROW (excluded.*);</span></p> 
<p style="margin-left:0in;text-align:left;"><strong><span style="background-color:#38d8f0;">9、</span><span style="color:#000000;"><span style="background-color:#38d8f0;">覆盖写入</span></span></strong></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">1</span><span style="color:#000000;">、刷新</span><span style="color:#000000;">外表的</span><span style="color:#000000;">Schema </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">IMPORT </span><span style="color:#000000;"><strong>FOREIGN</strong></span><span style="color:#000000;"> SCHEMA </span><span style="color:#000000;">holo_demo</span><span style="color:#000000;"> LIMIT </span><span style="color:#000000;"><strong>to</strong></span><span style="color:#000000;"> ( odps_region_10g ) </span><span style="color:#000000;"><strong>FROM</strong></span><span style="color:#000000;"> SERVER </span><span style="color:#000000;">odps_server</span> <span style="color:#000000;"><strong>INTO</strong></span><span style="color:#000000;"> public OPTIONS(</span><span style="color:#000000;">if_table_exist</span><span style="color:#000000;"> 'update',</span><span style="color:#000000;">if_unsupported_type</span><span style="color:#000000;"> 'error'); </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;"><strong>2</strong></span><span style="color:#000000;"><strong>、</strong></span><span style="color:#000000;">清理潜在的临时表 </span> </p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;"><strong>BEGIN</strong></span> <span style="color:#000000;">; </span><span style="color:#000000;"><strong>DROP</strong></span> <span style="color:#000000;"><strong>TABLE</strong></span><span style="color:#000000;"> IF </span><span style="color:#000000;"><strong>EXISTS</strong></span> <span style="color:#000000;">public.region_new</span><span style="color:#000000;">; </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">3</span><span style="color:#000000;">、创建</span><span style="color:#000000;">临时表 </span><span style="color:#000000;"><strong>SET</strong></span> <span style="color:#000000;">hg_experimental_enable_create_table_like_properties</span><span style="color:#000000;">=</span><span style="color:#000000;"><strong>on</strong></span><span style="color:#000000;">; </span><span style="color:#000000;"><strong>CALL</strong></span><span style="color:#000000;"> HG_CREATE_TABLE_LIKE ('</span><span style="color:#000000;">public.region_new</span><span style="color:#000000;">', 'select * from </span><span style="color:#000000;">public.region</span><span style="color:#000000;">'); </span><span style="color:#000000;"><strong>COMMIT</strong></span><span style="color:#000000;"> ; </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">4</span><span style="color:#000000;">、</span> <span style="color:#000000;">向临时表插入数据 </span><span style="color:#000000;"><strong>INSERT</strong></span> <span style="color:#000000;"><strong>INTO</strong></span> <span style="color:#000000;">public.region_new</span> <span style="color:#000000;"><strong>SELECT</strong></span><span style="color:#000000;"> * </span><span style="color:#000000;"><strong>FROM</strong></span><span style="color:#000000;"> public.odps_region_10g; ANALYZE </span><span style="color:#000000;">public.region_new</span><span style="color:#000000;">; </span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;"><strong>5</strong></span><span style="color:#000000;"><strong>、</strong></span> <span style="color:#000000;">删除</span><span style="color:#000000;">旧表 </span><span style="color:#000000;"><strong>BEGIN</strong></span> <span style="color:#000000;">；</span><span style="color:#000000;"><strong>DROP</strong></span> <span style="color:#000000;"><strong>TABLE</strong></span><span style="color:#000000;"> IF </span><span style="color:#000000;"><strong>EXISTS</strong></span> <span style="color:#000000;">public.region</span><span style="color:#000000;">;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">6</span><span style="color:#000000;">、临时</span><span style="color:#000000;">表改名 </span><span style="color:#000000;"><strong>ALTER</strong></span> <span style="color:#000000;"><strong>TABLE</strong></span><span style="color:#000000;"> IF </span><span style="color:#000000;"><strong>EXISTS</strong></span> <span style="color:#000000;">public.region_new</span><span style="color:#000000;"> RENAME </span><span style="color:#000000;"><strong>TO</strong></span><span style="color:#000000;"> region; </span><span style="color:#000000;"><strong>COMMIT</strong></span><span style="color:#000000;"> ;</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">7</span><span style="color:#000000;">、授权</span><span style="color:#000000;">（</span><span style="color:#000000;">MDP</span><span style="color:#000000;">有权限问题，需要重新授权</span><span style="color:#000000;">）</span></p> 
<p style="margin-left:0in;text-align:left;">  <span style="color:#000000;">①用户授权</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;">   GRANT </span><span style="color:#000000;">USAGE ON SCHEMA </span><span style="color:#000000;">schema_name</span><span style="color:#000000;"> TO "</span><span style="color:#000000;">云账号</span><span style="color:#000000;">/</span><span style="color:#000000;">云邮箱</span><span style="color:#000000;">";</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;"><strong>  GRANT</strong></span> <span style="color:#000000;"><strong>SELECT</strong></span> <span style="color:#000000;"><strong>ON</strong></span> <span style="color:#000000;"><strong>TABLE</strong></span><span style="color:#000000;"> &lt;</span><span style="color:#000000;">tablename</span><span style="color:#000000;">&gt; </span><span style="color:#000000;"><strong>TO</strong></span><span style="color:#000000;"> "</span><span style="color:#000000;">云账号</span><span style="color:#000000;">/</span><span style="color:#000000;">云邮箱</span><span style="color:#000000;">";</span></p> 
<p style="margin-left:0in;text-align:left;"><span style="color:#000000;"><strong>  GRANT</strong></span> <span style="color:#000000;"><strong>SELECT</strong></span> <span style="color:#000000;"><strong>ON</strong></span> <span style="color:#000000;"><strong>ALL</strong></span><span style="color:#000000;"> TABLES </span><span style="color:#000000;"><strong>IN</strong></span><span style="color:#000000;"> SCHEMA public </span><span style="color:#000000;"><strong>TO</strong></span><span style="color:#000000;"> "</span><span style="color:#000000;">云账号</span><span style="color:#000000;">/</span><span style="color:#000000;">云邮箱</span><span style="color:#000000;">";</span></p> 
<p style="margin-left:0in;text-align:left;">  <span style="color:#000000;">②角色授权</span></p> 
<p style="margin-left:0in;text-align:left;">  <span style="color:#000000;"><strong>CREATE</strong></span> <span style="color:#000000;"><strong>USER</strong></span><span style="color:#000000;"> "</span><span style="color:#000000;">云账号</span><span style="color:#000000;">ID/</span><span style="color:#000000;">云邮箱</span><span style="color:#000000;">"; </span></p> 
<p style="margin-left:0in;text-align:left;">  <span style="color:#000000;"><strong>CREATE</strong></span> <span style="color:#000000;">ROLE &lt;</span><span style="color:#000000;">rolename</span><span style="color:#000000;">&gt;; </span></p> 
<p style="margin-left:0in;text-align:left;">  <span style="color:#000000;"><strong>GRANT</strong></span> <span style="color:#000000;">&lt;</span><span style="color:#000000;">rolename</span><span style="color:#000000;">&gt; </span><span style="color:#000000;"><strong>TO</strong></span><span style="color:#000000;"> "</span><span style="color:#000000;">云账号</span><span style="color:#000000;">/</span><span style="color:#000000;">云邮箱</span><span style="color:#000000;">"; </span></p> 
<p style="margin-left:0in;text-align:left;">  <span style="color:#000000;"><strong>ALTER</strong></span> <span style="color:#000000;"><strong>TABLE</strong></span><span style="color:#000000;"> &lt;</span><span style="color:#000000;">tablename</span><span style="color:#000000;">&gt; OWNER </span><span style="color:#000000;"><strong>TO</strong></span><span style="color:#000000;"> &lt;</span><span style="color:#000000;">rolename</span><span style="color:#000000;">&gt;;</span></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d609fc4aebd1f368ddc45b42339a0915/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vs2019 C&#43;&#43;配置多线程pthread库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9eda56bdf1aa8dd2a808dc91c63bd170/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">element-ui 的 el-input-number的默认值设置为空</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>