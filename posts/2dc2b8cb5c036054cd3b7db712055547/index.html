<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>低代码平台之部署openfaas及基本操作 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="低代码平台之部署openfaas及基本操作" />
<meta property="og:description" content="简介 OpenFaaS是打包源代码、二进制文件或者容器作为Serverless函数编程的框架，可以在windows、linux等平台上运行。
使用它构建函数的流程如下：
通过模板new创建函数build函数为docker镜像push镜像到docker registrydeploy函数invoke函数 其实这些步骤对应的是faas-cli客户端的几个命令，下面会提到，同时，我也围绕这几个流程来扩展它的实际应用。
学习须知 本博客是基于linux、k8s、dockers、openfaas，使用的是root用户。k8s和docker的版本及安装参见前面的博客，openfaas直接使用的最新的版本。
本博客是使用js的express框架作为发布的函数，其实我们不需要关注这个express框架，只需要记住它帮我们启动了一个nodejs的web服务器。
基于k8s部署openfaas 官网提供了三种方式部署openfaas：arkade、helm3和静态yaml文件。
官网推荐使用arkade，但学习成本高。
helm3稍微麻烦点，但是可以修改配置文件实现细粒度的设置。
静态yaml好像没有过多的介绍，但是在openfaas的git上，看到了faas-netes仓库，通过一些介绍，我猜测是指这个。
现在，咱们就用faas-netes来搞吧，因为最简单，随后再研究helm3部署。
注：我们外网使用的是helm3进行部署的。
使用faas-netes部署 没有安装git的话，就先安装git吧，这里就不多介绍git安装了。
git clone https://github.com/openfaas/faas-netes cd faas-netes kubectl apply -f namespaces.yml kubectl -n openfaas create secret generic basic-auth \ --from-literal=basic-auth-user=admin \ --from-literal=basic-auth-password=admin kubectl apply -f ./yaml/ 上面一大串的代码，直接复制粘贴，其中
kubectl apply -f namespaces.yml
是创建openfaas相关的命名空间，分别为openfaas和openfaas-fn两个，以后发布的函数会被部署在openfaas-fn命名空间下。
kubectl -n openfaas create secret generic basic-auth --from-literal=basic-auth-user=admin --from-literal=basic-auth-password=admin
新建openfaas ui界面的账号密码
kubectl apply -f ./yaml/
执行这个命令后，会启动openfaas相关的pod，kubectl get pods -A查看pod的状态，这些pod可能启动起来会太耗时，我的耗时半小时才全部启动成功，和网速有关系
kubectl delete -f ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2dc2b8cb5c036054cd3b7db712055547/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-17T17:41:48+08:00" />
<meta property="article:modified_time" content="2023-02-17T17:41:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">低代码平台之部署openfaas及基本操作</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>简介</h3> 
<p><code>OpenFaaS</code>是打包源代码、二进制文件或者容器作为<code>Serverless</code>函数编程的框架，可以在<code>windows、linux</code>等平台上运行。<br> 使用它构建函数的流程如下：</p> 
<ol><li>通过模板<code>new</code>创建函数</li><li><code>build</code>函数为<code>docker</code>镜像</li><li><code>push</code>镜像到<code>docker registry</code></li><li><code>deploy</code>函数</li><li><code>invoke</code>函数</li></ol> 
<p>其实这些步骤对应的是<code>faas-cli</code>客户端的几个命令，下面会提到，同时，我也围绕这几个流程来扩展它的实际应用。</p> 
<h3><a id="_13"></a>学习须知</h3> 
<p>本博客是基于<code>linux、k8s、dockers、openfaas</code>，使用的是<code>root</code>用户。<code>k8s</code>和<code>docker</code>的版本及安装参见前面的博客，<code>openfaas</code>直接使用的最新的版本。</p> 
<p>本博客是使用<code>js</code>的<code>express</code>框架作为发布的函数，其实我们不需要关注这个<code>express</code>框架，只需要记住它帮我们启动了一个<code>nodejs</code>的<code>web</code>服务器。</p> 
<h3><a id="k8sopenfaas_18"></a>基于k8s部署openfaas</h3> 
<p>官网提供了三种方式部署<code>openfaas</code>：<code>arkade</code>、<code>helm3</code>和静态<code>yaml</code>文件。<br> 官网推荐使用<code>arkade</code>，但学习成本高。<br> <code>helm3</code>稍微麻烦点，但是可以修改配置文件实现细粒度的设置。<br> 静态<code>yaml</code>好像没有过多的介绍，但是在<code>openfaas</code>的<code>git</code>上，看到了<code>faas-netes</code>仓库，通过一些介绍，我猜测是指这个。</p> 
<p><img src="https://images2.imgbox.com/4d/60/sCgwQ9Im_o.png" alt="在这里插入图片描述"><br> 现在，咱们就用<code>faas-netes</code>来搞吧，因为最简单，随后再研究<code>helm3</code>部署。<br> 注：我们外网使用的是<code>helm3</code>进行部署的。</p> 
<h4><a id="faasnetes_28"></a>使用faas-netes部署</h4> 
<p>没有安装<code>git</code>的话，就先安装<code>git</code>吧，这里就不多介绍<code>git</code>安装了。</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> clone https://github.com/openfaas/faas-netes
<span class="token builtin class-name">cd</span> faas-netes
kubectl apply <span class="token parameter variable">-f</span> namespaces.yml
kubectl <span class="token parameter variable">-n</span> openfaas create secret generic basic-auth <span class="token punctuation">\</span>
    --from-literal<span class="token operator">=</span>basic-auth-user<span class="token operator">=</span>admin <span class="token punctuation">\</span>
    --from-literal<span class="token operator">=</span>basic-auth-password<span class="token operator">=</span>admin
kubectl apply <span class="token parameter variable">-f</span> ./yaml/
</code></pre> 
<p>上面一大串的代码，直接复制粘贴，其中</p> 
<ul><li> <p><code>kubectl apply -f namespaces.yml</code><br> 是创建<code>openfaas</code>相关的命名空间，分别为<code>openfaas</code>和<code>openfaas-fn</code>两个，以后发布的函数会被部署在<code>openfaas-fn</code>命名空间下。<br> <img src="https://images2.imgbox.com/1e/26/elBHUR6e_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>kubectl -n openfaas create secret generic basic-auth --from-literal=basic-auth-user=admin --from-literal=basic-auth-password=admin</code><br> 新建<code>openfaas ui</code>界面的账号密码</p> </li><li> <p><code>kubectl apply -f ./yaml/</code><br> 执行这个命令后，会启动<code>openfaas</code>相关的<code>pod</code>，<code>kubectl get pods -A</code>查看<code>pod</code>的状态，这些<code>pod</code>可能启动起来会太耗时，我的耗时半小时才全部启动成功，和网速有关系<br> <img src="https://images2.imgbox.com/87/06/gEYSZ7PF_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>kubectl delete -f ./yaml/</code><br> 这个是移除所有<code>pod</code>的命令</p> </li></ul> 
<h4><a id="openfaas_55"></a>查看openfaas界面</h4> 
<p><code>openfaas</code>所有的<code>pod</code>都启动成功后，<code>openfaas</code>默认端口为31112，使用<code>google</code>浏览器登录，360浏览器不兼容，打不开。</p> 
<p>登录的账号密码是上面命令中配置的。</p> 
<p><img src="https://images2.imgbox.com/17/a6/vg06O3jZ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="faascli_62"></a>安装faas-cli客户端</h3> 
<p><code>faas-cli</code>是<code>openfaas</code>官方的客户端，用来操作上面提到的<code>new、build、push、deploy</code>等命令的。<br> 官网有安装教程，包括<code>linux</code>和<code>windows</code>，这里直接来安装<code>linux</code>版本。</p> 
<pre><code class="prism language-java">curl <span class="token operator">-</span>sSL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cli<span class="token punctuation">.</span>openfaas<span class="token punctuation">.</span>com <span class="token operator">|</span> sudo sh
</code></pre> 
<p>如果上面的命令提示你去官网手动下载，那么你就去官网下一个faas-cli，按照提示去操作就可以了。</p> 
<pre><code class="prism language-java"><span class="token punctuation">[</span>root<span class="token annotation punctuation">@yanzhao</span> opt<span class="token punctuation">]</span># curl <span class="token operator">-</span>sSL https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>cli<span class="token punctuation">.</span>openfaas<span class="token punctuation">.</span>com <span class="token operator">|</span> sudo sh
<span class="token class-name">Finding</span> latest version from <span class="token class-name">GitHub</span>

<span class="token class-name">Failed</span> <span class="token keyword">while</span> attempting <span class="token keyword">to</span> <span class="token namespace">install</span> faas<span class="token operator">-</span><span class="token class-name"><span class="token namespace">cli<span class="token punctuation">.</span></span> Please</span> manually install<span class="token operator">:</span>

<span class="token number">1.</span> <span class="token class-name">Open</span> your web browser and go <span class="token keyword">to</span> <span class="token namespace">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>openfaas<span class="token operator">/</span>faas<span class="token operator">-</span>cli<span class="token operator">/</span>releases
<span class="token number">2.</span> <span class="token class-name">Download</span> the latest release <span class="token keyword">for</span> your <span class="token class-name"><span class="token namespace">platform<span class="token punctuation">.</span></span> Call</span> it 'faas<span class="token operator">-</span>cli'<span class="token punctuation">.</span>
<span class="token number">3.</span> chmod <span class="token operator">+</span>x <span class="token punctuation">.</span>/faas<span class="token operator">-</span>cli
<span class="token number">4.</span> mv <span class="token punctuation">.</span>/faas<span class="token operator">-</span>cli <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin
<span class="token number">5.</span> ln <span class="token operator">-</span>sf <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>faas<span class="token operator">-</span>cli <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>faas
</code></pre> 
<p>使用<code>faas-cli</code>登录<code>openfaas</code></p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">OPENFAAS_URL</span><span class="token operator">=</span><span class="token number">111.229</span>.208.187:31112
faas-cli login <span class="token parameter variable">-u</span> admin <span class="token parameter variable">-p</span> admin <span class="token parameter variable">--gateway</span> http://111.229.208.187:31112
</code></pre> 
<p>永久有效</p> 
<pre><code class="prism language-bash"><span class="token builtin class-name">echo</span> <span class="token builtin class-name">export</span> <span class="token assign-left variable">OPENFAAS_URL</span><span class="token operator">=</span><span class="token number">111.229</span>.208.187:31112 <span class="token operator">&gt;&gt;</span> ~/.bashrc
<span class="token builtin class-name">source</span> ~/.bashrc
</code></pre> 
<h3><a id="faascli_97"></a>faas-cli基本操作</h3> 
<p>这里介绍的是上面提到的<code>new、build、push、deploy</code>等命令，当然也会扩展一些其他内容。</p> 
<h4><a id="faascli_new_102"></a>faas-cli new</h4> 
<p>案例：</p> 
<pre><code class="prism language-java">faas<span class="token operator">-</span>cli <span class="token keyword">new</span> flow<span class="token operator">-</span><span class="token number">001</span> <span class="token operator">--</span>lang node12 
</code></pre> 
<p>使用模板创建函数，生成<code>flow-001</code>文件夹和<code>flow-001.yml</code>文件。<br> <img src="https://images2.imgbox.com/82/e0/J9YvHFgR_o.png" alt="在这里插入图片描述"></p> 
<ul><li> <p>flow-001文件夹<br> <code>flow-001</code>文件夹中包含<code>handler.js</code>和<code>package.json</code>两个文件，<code>handler.js</code>是一个简单的js文件，在函数部署后，<code>openfaas</code>会调用<code>handler.js</code>文件。说到这里，你需要记住的是，<code>handler.js</code>的内容可以自定义，但是要符合<code>openfaas</code>的模板的要求。<br> <img src="https://images2.imgbox.com/b1/9e/YkYI1IDG_o.png" alt="在这里插入图片描述"></p> </li><li> <p>flow-001.yml<br> <code>flow-001.yml</code>文件是<code>faas-cli</code>操作的文件，<code>build、push、deploy</code>等命令都要用到这个文件。文件的内容是<code>openfaas</code>识别的，不要和<code>k8s</code>的<code>yml</code>文件混肴。</p> </li></ul> 
<p>在实际应用中，我们会把自定义的文件放到<code>flow-001</code>文件夹中，通过修改<code>flow-001.yml</code>文件，定义函数<code>push、deploy</code>的镜像地址、镜像版本、拉取镜像策略，函数部署后请求读写的超时时间、最大最小<code>cpu</code>和<code>memory</code>等配置。</p> 
<p>注：</p> 
<ol><li><strong>flow-001.yml中的<code>gateway</code>要和<code>faas-cli login</code>登录的网关保存一致，否则<code>deploy</code>时会报错，返回401</strong></li><li><strong>如果<code>cpu</code>和<code>memory</code>大小分配不当，会导致函数部署不成功，或者函数在运行过程中导致内存溢出</strong></li></ol> 
<p>例如下面的截图，左侧是外网的配置（<code>helm3</code>部署的<code>openfaas</code>)，右侧是测试的例子<br> <img src="https://images2.imgbox.com/d8/30/7iHxl3bS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="faascli_build_127"></a>faas-cli build</h4> 
<p>在执行此命令前，需要做三件事：</p> 
<ol><li>下载<code>openfaas</code>的的模板文件，或者你安装了<code>git</code>，<code>openfaas</code>自动下载，否则执行会报错。因为这个命令会根据你使用的语言，拷贝相应的模板文件进行打包。<br> <img src="https://images2.imgbox.com/1d/62/wTxdBtrD_o.png" alt="在这里插入图片描述"></li><li>修改模板中的文件，例如使用<code>node12</code>，可以修改对应文件夹中的文件，我们关心最多的就是<code>Dockerfile</code>这个文件，可以自定义容器，其他文件不需要修改。另外<code>function</code>文件夹中的文件在执行<code>build</code>命令时，会被覆盖，下面再说。<br> <img src="https://images2.imgbox.com/a4/a8/7syTIBw5_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/6d/28/fzEpLi2H_o.png" alt="在这里插入图片描述"></li><li>将修改的模板保存起来，以后每次发布新函数，都用自己修改的模板发布。</li></ol> 
<p>案例：</p> 
<pre><code class="prism language-bash">faas-cli build <span class="token parameter variable">-f</span> flow-001.yml
</code></pre> 
<p>执行<code>build</code>命令，会生成<code>build</code>文件夹，目录结构如下，其中<code>Dockerfile、index.js、package.json、template.yml</code>都是从模板中拷贝的，<code>function</code>文件夹也是从模板拷贝的，但是<code>function</code>中的文件是拷贝<code>faas-cli new</code>生成的文件，也就是我们自定义的<code>handler.js</code>文件。<br> <img src="https://images2.imgbox.com/5b/fc/jVLo1IsX_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="faascli_push_145"></a>faas-cli push</h4> 
<p><code>push</code>命令会把镜像推送到<code>docker</code>仓库，推送的地址就是<code>flow-001.yml</code>中配置的<code>image</code>的地址。<br> <code>openfaas</code>默认的策略是每次部署都要从<code>docker</code>仓库拉取镜像，因此要先推送到<code>docker</code>仓库。当然这个策略可以修改，但是不建议修改，因为怕拉取不到已修改的镜像。<br> 我使用的<code>docker</code>仓库是<code>https://hub.docker.com/</code></p> 
<p>案例：</p> 
<pre><code class="prism language-bash"><span class="token function">docker</span> login <span class="token parameter variable">-u</span> username <span class="token parameter variable">-p</span> password
faas-cli push <span class="token parameter variable">-f</span> flow-001.yml
</code></pre> 
<h4><a id="faascli_deploy_157"></a>faas-cli deploy</h4> 
<p>在部署前，要先配置<code>docker</code>的登录信息，为了解决<code>k8s</code>拉取镜像时校验登录的问题。</p> 
<pre><code class="prism language-bash"><span class="token assign-left variable">dockerregistrykey</span><span class="token operator">=</span><span class="token variable"><span class="token variable">`</span>base64 <span class="token parameter variable">-w</span> <span class="token number">0</span> ~/.docker/config.json<span class="token variable">`</span></span>
<span class="token function">cat</span> <span class="token operator">&gt;</span> dockerregistrykey.yaml <span class="token operator">&lt;&lt;</span><span class="token string">EOF
apiVersion: v1
kind: Secret
metadata:
  name: dockerregistrykey
data:
  .dockerconfigjson: <span class="token variable">$dockerregistrykey</span>
type: kubernetes.io/dockerconfigjson
EOF</span>
kubectl delete secret dockerregistrykey <span class="token parameter variable">-n</span> openfaas-fn
kubectl create <span class="token parameter variable">-f</span> dockerregistrykey.yaml <span class="token parameter variable">-n</span> openfaas-fn
</code></pre> 
<p>上面又是一大串代码，直接拷贝执行，主要是把<code>docker</code>登录的信息（<code>faas-cli push</code>时已经登录了）生成<code>k8s</code>认识的<code>secret</code>密钥。</p> 
<p>案例：</p> 
<pre><code class="prism language-bash">faas-cli deploy <span class="token parameter variable">-f</span> flow-001.yml
</code></pre> 
<p><img src="https://images2.imgbox.com/b8/5c/VdCPKYqb_o.png" alt="在这里插入图片描述"><br> 执行完<code>deploy</code>后返回了<code>http://111.229.208.187:31112/function/flow-001.openfaas-fn</code>，我们可以直接在<code>google</code>中调用此地址。<br> <img src="https://images2.imgbox.com/e9/b4/mMFO5aaH_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="faascli_up_185"></a>faas-cli up</h4> 
<p><code>up</code>是集<code>build、push、deploy</code>为一体的命令。</p> 
<h3><a id="_189"></a>添加新的命名空间</h3> 
<p><code>https://github.com/openfaas/faas-netes</code> 的<code>Namespaces</code>下有提到</p> 
<pre><code class="prism language-bash">By default all OpenFaaS functions and services are deployed to the openfaas 
and openfaas-fn namespaces. To alter the namespace use the helm chart.
</code></pre> 
<p>默认情况下，所有<code>OpenFaaS</code>函数和服务都部署到<code>OpenFaaS</code>和<code>OpenFaaS fn</code>名称空间。要更改名称空间，请使用<code>helm</code>。</p> 
<h3><a id="_199"></a>拓展</h3> 
<ul><li>在使用<code>helm</code>部署<code>openfaas</code>后，可以更方便的拓展命名空间，这样可以根据命名空间做资源配额，资源隔离。</li><li>更好的利用<code>k8s</code>带来的便利</li><li>结合业务映射<code>openfaas</code>返回的<code>url</code></li><li>快速开发轻量级应用</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/77707d205114d0118cd86f1cc094a3ed/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">df.drop_duplicates()删除提取重复记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/effc0ec7365b7c5cd2ce40a4b234d253/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Topsis算法实践：比较LSTM算法与BP神经网络算法，以chickenpox_dataset为例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>