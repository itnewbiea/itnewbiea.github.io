<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android RecyclerView 动画处理 流程 原理（源码分析第三篇） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android RecyclerView 动画处理 流程 原理（源码分析第三篇）" />
<meta property="og:description" content="零、本文主题 上篇文章 Android RecyclerView 动画处理 流程 原理（源码分析第二篇）讲了Recyclerview 动画的实现原理与主要流程。
本文接着上篇文章，分析两个具体一点的流程：
1. Recyclerview 动画执行前的view信息是如何进行保存的，保存了哪些信息
2. 怎样计算“动画执行后，View应该要处于的状态”的信息的？
一、动画执行前的view信息是如何进行保存的，保存了哪些信息 入口：RecyclerView.dispatchLayoutStep1()
调用栈如下：
dispatchLayout()
|
dispatchLayoutStep1()
1.1 dispatchLayout() dispatchLayout()主要用处就是 给所有子View做布局，并处理由布局引起的动画改变。
RecyclerView中有 5 种动画：
动画类别布局前后变化1 PERSISTENTvisible -&gt; visible2 REMOVEDvisible -&gt; removed3 ADDEDnot-exist -&gt; added4 DISAPPEARING(data exist before&amp;after) visible-&gt; non-visible5 APPEARING(data exist before&amp;after) non-visible -&gt; visible 整体方法就是：梳理出布局前、布局后哪些items存在，并且推断出每个 item 的动画类别（上面的5种之一）然后设置相应的动画。
RecyclerView设置每个 Item 的动画，具体是通过 ItemAnimator 接口的 animateXXX() 系列方法。
1.2 ItemAnimator.animateXXX() 对应上面的五种动画，ItemAnimator接口中，定义了一组 abstract 方法(4个)：
animateXXX()方法对应的动画类别1. animateDisappearance()2 REMOVED 和 4 DISAPPEARING2. animateAppearance()3 ADDED 和 5 APPEARING3." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/78c6a45fe41305372329b46ef22e6fe9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-20T20:09:03+08:00" />
<meta property="article:modified_time" content="2023-12-20T20:09:03+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android RecyclerView 动画处理 流程 原理（源码分析第三篇）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>零、本文主题</h2> 
<p>上篇文章 <a href="https://blog.csdn.net/jx0260/article/details/134923367?spm=1001.2014.3001.5502">Android RecyclerView 动画处理 流程 原理（源码分析第二篇）</a>讲了Recyclerview 动画的实现原理与主要流程。</p> 
<p>本文接着上篇文章，分析两个具体一点的流程：</p> 
<blockquote> 
 <p><strong>1. Recyclerview 动画执行前的view信息是如何进行保存的，保存了哪些信息</strong><br> <strong>2. 怎样计算“动画执行后，View应该要处于的状态”的信息的？</strong></p> 
</blockquote> 
<h2><a id="view_6"></a>一、动画执行前的view信息是如何进行保存的，保存了哪些信息</h2> 
<p>入口：RecyclerView.dispatchLayoutStep1()<br> 调用栈如下：<br> dispatchLayout()<br> |<br> dispatchLayoutStep1()</p> 
<h3><a id="11_dispatchLayout_12"></a>1.1 dispatchLayout()</h3> 
<p><code>dispatchLayout()</code>主要用处就是 给所有子View做布局，并处理由布局引起的动画改变。<br> RecyclerView中有 5 种动画：</p> 
<table><thead><tr><th>动画类别</th><th>布局前后变化</th></tr></thead><tbody><tr><td>1 PERSISTENT</td><td>visible -&gt; visible</td></tr><tr><td>2 REMOVED</td><td>visible -&gt; removed</td></tr><tr><td>3 ADDED</td><td>not-exist -&gt; added</td></tr><tr><td>4 DISAPPEARING</td><td>(data exist before&amp;after) visible-&gt; non-visible</td></tr><tr><td>5 APPEARING</td><td>(data exist before&amp;after) non-visible -&gt; visible</td></tr></tbody></table> 
<p>整体方法就是：梳理出布局前、布局后哪些items存在，并且推断出每个 item 的动画类别（上面的5种之一）然后设置相应的动画。<br> RecyclerView设置每个 Item 的动画，具体是通过 ItemAnimator 接口的 animateXXX() 系列方法。</p> 
<h3><a id="12_ItemAnimatoranimateXXX_25"></a>1.2 ItemAnimator.animateXXX()</h3> 
<p>对应上面的五种动画，ItemAnimator接口中，定义了一组 abstract 方法(4个)：</p> 
<table><thead><tr><th>animateXXX()方法</th><th>对应的动画类别</th></tr></thead><tbody><tr><td>1. animateDisappearance()</td><td>2 REMOVED 和 4 DISAPPEARING</td></tr><tr><td>2. animateAppearance()</td><td>3 ADDED 和 5 APPEARING</td></tr><tr><td>3. animatePersistence()</td><td>1 PERSISTENT</td></tr><tr><td>4. animateChange()</td><td>Adapter.notifyItemChanged(int) 、notifyDataSetChanged()</td></tr></tbody></table> 
<p>我们看下第一个方法：</p> 
<pre><code class="prism language-java"><span class="token function">animateDisappearance</span><span class="token punctuation">(</span><span class="token class-name">ViewHolder</span> viewHolder<span class="token punctuation">,</span>
                <span class="token class-name">ItemHolderInfo</span> preLayoutInfo<span class="token punctuation">,</span>  <span class="token class-name">ItemHolderInfo</span> postLayoutInfo<span class="token punctuation">)</span>
</code></pre> 
<p>viewHolder 就是目标子view，preLayoutInfo、postLayoutInfo分别对应布局前、布局后 View的信息。</p> 
<blockquote> 
 <p>我们梳理一下逻辑：<br> 主要思路是：梳理出布局前、布局后哪些items存在，并且推断出每个 item的动画类别然后设置相应的动画。</p> 
</blockquote> 
<blockquote> 
 <p>具体实现是：执行 animateXXX方法，就能执行动画。但是 animateXXX需要preLayoutInfo， postLayoutInfo 这两个view的信息，只要提供了preLayoutInfo， postLayoutInfo流程就通了。</p> 
</blockquote> 
<p><strong>所以，我们的关键着眼点就在于 这个preLayoutInfo， postLayoutInfo 是怎么生成的。</strong><br> 搞清了这个问题，本文的主题就解决了。</p> 
<h3><a id="13_preLayoutInfopostLayoutInfo_50"></a>1.3 preLayoutInfo、postLayoutInfo的生成</h3> 
<p>preLayoutInfo、postLayoutInfo 分别是由 ItemAnimator 里的这两个方法生成的：</p> 
<pre><code class="prism language-java"> <span class="token operator">-</span> <span class="token class-name">ItemHolderInfo</span> <span class="token function">recordPreLayoutInformation</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">,</span>
    <span class="token class-name">RecyclerView<span class="token punctuation">.</span>ViewHolder</span> viewHolder<span class="token punctuation">,</span>
    <span class="token keyword">int</span> changeFlags<span class="token punctuation">,</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> payloads <span class="token punctuation">)</span>
  <span class="token operator">-</span> <span class="token class-name">ItemHolderInfo</span> <span class="token function">recordPostLayoutInformation</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">,</span>
    <span class="token class-name">RecyclerView<span class="token punctuation">.</span>ViewHolder</span> viewHolder <span class="token punctuation">)</span>
</code></pre> 
<p>它的调用入口在：RecyclerView.dispatchLayoutStep1()</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">dispatchLayoutStep1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">ItemHolderInfo</span> animationInfo <span class="token operator">=</span> mItemAnimator
                        <span class="token punctuation">.</span><span class="token function">recordPreLayoutInformation</span><span class="token punctuation">(</span>mState<span class="token punctuation">,</span> holder<span class="token punctuation">,</span>
                                <span class="token class-name">ItemAnimator</span><span class="token punctuation">.</span><span class="token function">buildAdapterChangeFlagsForAnimations</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">,</span>
                                holder<span class="token punctuation">.</span><span class="token function">getUnmodifiedPayloads</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    mViewInfoStore<span class="token punctuation">.</span><span class="token function">addToPreLayout</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> animationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>生成preLayoutInfo 并存入到 ViewInfoStore中，需要的时候再取出来。<br> 至此，我们对接上了上一篇文章 的 2.3 章节。</p> 
<h3><a id="14_ItemAnimatorrecordPreLayoutInformation_72"></a>1.4 ItemAnimator.recordPreLayoutInformation()</h3> 
<p>中间略过，最后调到 类：ItemAnimator.ItemHolderInfo：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ItemHolderInfo</span> <span class="token function">setFrom</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>ViewHolder</span> holder<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">final</span> <span class="token class-name">View</span> view <span class="token operator">=</span> holder<span class="token punctuation">.</span>itemView<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>left <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getLeft</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>top <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>right <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getRight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>bottom <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getBottom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其实就是存一下viewholder的 4 个顶点坐标。很朴素。</p> 
<h2><a id="View_postLayoutInfo_85"></a>二、计算“动画执行后，View应该要处于的状态”的信息 postLayoutInfo</h2> 
<h3><a id="21_ItemAnimatorrecordPostLayoutInformation_86"></a>2.1 ItemAnimator.recordPostLayoutInformation()</h3> 
<p>这个方法在RecyclerView中，只有一次调用：<br> dispatchLayoutStep3()<br> |<br> recordPostLayoutInformation()<br> 抽下核心方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">void</span> <span class="token function">dispatchLayoutStep3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">final</span> <span class="token class-name">ItemHolderInfo</span> animationInfo <span class="token operator">=</span> mItemAnimator
                        <span class="token punctuation">.</span><span class="token function">recordPostLayoutInformation</span><span class="token punctuation">(</span>mState<span class="token punctuation">,</span> holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
	mViewInfoStore<span class="token punctuation">.</span><span class="token function">addToPostLayout</span><span class="token punctuation">(</span>holder<span class="token punctuation">,</span> animationInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// Step 4: Process view info lists and trigger animations</span>
    mViewInfoStore<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>mViewInfoProcessCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>怎样计算“动画执行后，View应该要处于的状态”的信息的？</p> 
<h3><a id="22_dispatchLayoutStep2_102"></a>2.2 dispatchLayoutStep2()</h3> 
<p>方法注释是这么写的：<br> 第二个布局步骤，<strong>我们为最终状态做视图的实际布局</strong>。<em>如果需要，此步骤可能会运行多次(例如测量)。</em><br> 请注意加粗部分，这个 dispatchLayoutStep2() 方法就是真正布局的地方，在这个方法中所有的子View会被add到 RV中，布局完成后，我们就很容易得到一个item他的动画终点在哪里。</p> 
<blockquote> 
 <p><strong>所以，我们上面的问题：怎样计算“动画执行后，View应该要处于的状态”的信息的？<br> &gt; 这个提出问题的思路是对的，但是这个PostLayoutInformation 不是计算得来的，而是布局完成后，直接去取就行了。</strong></p> 
</blockquote> 
<p>我把这部分的核心方法拉出来，大家顺着这个思路追一下：</p> 
<pre><code class="prism language-java"><span class="token constant">RV</span><span class="token punctuation">.</span><span class="token function">dispatchLayoutStep2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">|</span><span class="token operator">--</span>	mLayout<span class="token punctuation">.</span><span class="token function">onLayoutChildren</span><span class="token punctuation">(</span>mRecycler<span class="token punctuation">,</span> mState<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">LinearLayoutManager</span><span class="token punctuation">.</span><span class="token function">onLayoutChildren</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">)</span>
<span class="token operator">|</span><span class="token operator">--</span><span class="token function">fill</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> mLayoutState<span class="token punctuation">,</span> state<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">|</span><span class="token operator">--</span><span class="token function">layoutChunk</span><span class="token punctuation">(</span>recycler<span class="token punctuation">,</span> state<span class="token punctuation">,</span> layoutState<span class="token punctuation">,</span> layoutChunkResult<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-java">【<span class="token class-name">LinearLayoutManager</span>】
<span class="token keyword">void</span> <span class="token function">layoutChunk</span><span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>Recycler</span> recycler<span class="token punctuation">,</span> <span class="token class-name">RecyclerView<span class="token punctuation">.</span>State</span> state<span class="token punctuation">,</span>
            <span class="token class-name">LayoutState</span> layoutState<span class="token punctuation">,</span> <span class="token class-name">LayoutChunkResult</span> result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">View</span> view <span class="token operator">=</span> layoutState<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>recycler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RecyclerView<span class="token punctuation">.</span>LayoutParams</span> params <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RecyclerView<span class="token punctuation">.</span>LayoutParams</span><span class="token punctuation">)</span> view<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mScrapList <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mShouldReverseLayout <span class="token operator">==</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mLayoutDirection
                    <span class="token operator">==</span> <span class="token class-name">LayoutState</span><span class="token punctuation">.</span><span class="token constant">LAYOUT_START</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mShouldReverseLayout <span class="token operator">==</span> <span class="token punctuation">(</span>layoutState<span class="token punctuation">.</span>mLayoutDirection
                    <span class="token operator">==</span> <span class="token class-name">LayoutState</span><span class="token punctuation">.</span><span class="token constant">LAYOUT_START</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addDisappearingView</span><span class="token punctuation">(</span>view<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">addDisappearingView</span><span class="token punctuation">(</span>view<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>这块调了addView方法，也是真正布局的地方。子view被添加后，它的坐标位置就出来了，直接取出来放到postLayoutInfo就完事了。</p> 
<h3><a id="23__143"></a>2.3 先布局，后执行动画？</h3> 
<p>当你看到这个地方的时候，不知道有这样的问题：</p> 
<blockquote> 
 <p><strong>dispatchLayoutStep2() 方法中，调用了addView，子view就显示出来了。然后再在dispatchLayoutStep3() 执行动画。画面不是就乱了吗？<br> &gt; 比如，添加一个View，View已经先显示出来了，然后又执行一个渐变动画显现出来，效果不就错了吗？</strong></p> 
</blockquote> 
<p>这里我犯了一个先入为主的错误，以前使用LinearLayout的时候，可能会直接addView添加一个子View。但是LinearLayout的addView与RV的addView实现是不一样的。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LinearLayout</span> <span class="token keyword">extends</span> <span class="token class-name">ViewGroup</span> <span class="token punctuation">{<!-- --></span>
</code></pre> 
<p>LinearLayout中没有addView方法，使用的是父类ViewGroup的方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addView</span><span class="token punctuation">(</span><span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token class-name">LayoutParams</span> params<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// addViewInner() will call child.requestLayout() when setting the new LayoutParams</span>
    <span class="token comment">// therefore, we call requestLayout() on ourselves before, so that the child's request</span>
    <span class="token comment">// will be blocked at our level</span>
    <span class="token function">requestLayout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">addViewInner</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> index<span class="token punctuation">,</span> params<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>LinearLayout的 addView 调用了 invalidate(true) 使组件重绘，把子view显示出来。</p> 
<p>再看一下RV的addView：</p> 
<pre><code class="prism language-java"> <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addViewInt</span><span class="token punctuation">(</span><span class="token class-name">View</span> child<span class="token punctuation">,</span> <span class="token keyword">int</span> index<span class="token punctuation">,</span> <span class="token keyword">boolean</span> disappearing<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">final</span> <span class="token class-name">ViewHolder</span> holder <span class="token operator">=</span> <span class="token function">getChildViewHolderInt</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mRecyclerView<span class="token punctuation">.</span>mViewInfoStore<span class="token punctuation">.</span><span class="token function">addToDisappearedInLayout</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
          mRecyclerView<span class="token punctuation">.</span>mViewInfoStore<span class="token punctuation">.</span><span class="token function">removeFromDisappearedInLayout</span><span class="token punctuation">(</span>holder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">final</span> <span class="token class-name">LayoutParams</span> lp <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LayoutParams</span><span class="token punctuation">)</span> child<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>holder<span class="token punctuation">.</span><span class="token function">wasReturnedFromScrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> holder<span class="token punctuation">.</span><span class="token function">isScrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          mChildHelper<span class="token punctuation">.</span><span class="token function">attachViewToParent</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> index<span class="token punctuation">,</span> child<span class="token punctuation">.</span><span class="token function">getLayoutParams</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>child<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> mRecyclerView<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// it was not a scrap but a valid child</span>
          mRecyclerView<span class="token punctuation">.</span>mLayout<span class="token punctuation">.</span><span class="token function">moveView</span><span class="token punctuation">(</span>currentIndex<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
          mChildHelper<span class="token punctuation">.</span><span class="token function">addView</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>lp<span class="token punctuation">.</span>mPendingInvalidate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          holder<span class="token punctuation">.</span>itemView<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          lp<span class="token punctuation">.</span>mPendingInvalidate <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>上面也只抽了主要方法出来，我们可以看出：<br> 调的是mViewInfoStore，mChildHelper.attachViewToParent，mLayout.moveView，mChildHelper.addView，itemView.invalidate()等等，并没有调用RV自己的invalidate。所以RV的addView执行完，并不会立即显示子View。</p> 
<blockquote> 
 <p>总结一下：</p> 
 <ul><li><strong>在 RecyclerView 中，当你使用 addView() 方法添加一个新的视图时，这个视图并不会立即显示在屏幕上。</strong></li><li><strong>RecyclerView 的布局和动画流程是异步执行的。当你调用 addView() 方法时，这个视图会被添加到 RecyclerView 的内部，但并不会立即显示。实际的显示过程是在 RecyclerView 完成布局和动画计算之后进行的。</strong></li><li><strong>如果你希望新添加的视图立即显示在屏幕上，你可以调用 invalidate() 方法来强制 RecyclerView 重新绘制自己。这样，新的视图会立即显示出来，但需要注意的是，这可能会导致 RecyclerView<br> 的重新布局和动画计算，可能会对性能产生一定的影响。</strong></li></ul> 
</blockquote> 
<h2><a id="_196"></a>三、整体逻辑</h2> 
<p>计算布局参数：根据布局规则和数据，计算每个视图的布局参数，如位置、大小、方向等。<br> 执行布局操作：根据计算出的布局参数，对每个视图进行布局操作，如测量视图尺寸、绘制视图等。<br> 更新视图状态：在布局完成后，需要更新视图的状态，如可见性、焦点等。<br> 触发布局事件：在布局完成后，可能需要触发一些与布局相关的事件，如滚动事件、动画事件等。</p> 
<p>处理动画逻辑：在布局过程中，如果需要对视图进行动画处理，则需要执行以下步骤：<br> 记录动画信息：使用ItemAnimator记录动画信息，包括动画类型、目标视图、动画持续时间等。<br> 判断是否需要动画：根据动画信息和视图的状态，判断是否需要执行动画。<br> 执行动画：如果需要执行动画，则调用相应的动画方法，如animateChange()、animateAdd()等，对视图进行动画处理。<br> 更新视图状态：在动画完成后，需要更新视图的状态，如动画结束标志、动画进度等。<br> 触发动画事件：在动画完成后，可能需要触发一些与动画相关的事件，如动画完成事件、动画取消事件等。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e04c175536c1266cadc46842d4d574cb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Flink（十）【处理函数】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/36c5c8334e1a72d8f7d5e04bcd1e99d6/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux安装VMware17报错Before you can run VMware,several modules must be compiled and……</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>