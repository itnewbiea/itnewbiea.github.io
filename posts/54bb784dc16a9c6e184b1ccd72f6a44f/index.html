<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>十六. Kubernetes 工作负载 之 StatefulSet - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="十六. Kubernetes 工作负载 之 StatefulSet" />
<meta property="og:description" content="目录 一. StatefulSet 基础解释二. StatefulSet 配合 Service 负载均衡网络(无头服务)的使用podManagementPolicy: pod的管理策略updateStrategy: pod更新策略 一. StatefulSet 基础解释 Deployment部署的应用一般称为无状态应用,StatefulSet部署的应用一般称为有状态应用 无状态应用：可以简单理解为无状态应用不会记录当前状态,例如网络,存储等信息,如果应用宕机重启,重启后网络,存储,顺序可能等可能会变,例如Deployment部署的业务代码有状态应用：可以记录当前状态,即使重启,重启后根据状态记录信息可以做到网络,存储,顺序等不变,例如中间件MySQL、Redis、MQ等等,以mysql为例,部署为有状态的服务,即使宕机重启访问地址不会变,其它服务还是可以正常访问的 并且使用StatefulSet部署的服务是有顺序的,创建pod时,会给创建的多个pod添加索引,部署,启动等都是按照这个索引顺序进行,停止或删除是按照索引逆序执行StatefulSet 使用场景总结: 稳定、唯一的网络标识(dnsname)必须配合Service使用,StatefulSet通过与其相关的无头服务Service为每个pod提供DNS解析条目,通过解析DNS解析条目访问pod稳定的、持久的存储, 每个Pod始终对应各自的存储路径(PersistantVolumeClaimTemplate)有序的、优雅的部署和缩放。按顺序地增加副本、减少副本，并在减少副本时执行清理有序的、自动的滚动更新。按顺序自动地执行滚动更新 StatefulSet注意点 给定 Pod 的存储必须由 PersistentVolume 驱动 基于所请求的 storage class 来提供，或者由管理员预先提供。删除或者收缩 StatefulSet 并不会 删除它关联的存储卷。 这样做是为了保证数据安全，它通常比自动清除 StatefulSet 所有相关的资源更有价值。StatefulSet 当前需要无头服务 来负责 Pod 的网络标识。你需要负责创建此服务。当删除 StatefulSets 时，StatefulSet 不提供任何终止 Pod 的保证。 为了实现 StatefulSet 中的Pod 可以有序地且体面地终止，可以在删除之前将 StatefulSet 缩放为 0。在默认 Pod 管理策略( OrderedReady ) 时使用 滚动更新，可能进入需要人工干预 才能修复的损坏状态 二. StatefulSet 配合 Service 负载均衡网络(无头服务)的使用 StatefulSe与Service负载均衡网络的配合,使用StatefulSet 部署的有状态应用网络,存储等信息不变,以访问地址不变为例,封装Service负载均衡网络时设置&#34; clusterIP: None&#34; 不要分配ClusterIP,headless service等,访问地址由Service内部代理的通过StatefulSe部署pod自己控制 该方式下k8s内部通过&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/54bb784dc16a9c6e184b1ccd72f6a44f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-23T11:29:37+08:00" />
<meta property="article:modified_time" content="2023-05-23T11:29:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">十六. Kubernetes 工作负载 之 StatefulSet</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_StatefulSet__1" rel="nofollow">一. StatefulSet 基础解释</a></li><li><a href="#_StatefulSet__Service__17" rel="nofollow">二. StatefulSet 配合 Service 负载均衡网络(无头服务)的使用</a></li><li><ul><li><a href="#podManagementPolicy_pod_64" rel="nofollow">podManagementPolicy: pod的管理策略</a></li><li><a href="#updateStrategy_pod_68" rel="nofollow">updateStrategy: pod更新策略</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_StatefulSet__1"></a>一. StatefulSet 基础解释</h2> 
<ol><li>Deployment部署的应用一般称为无状态应用,<strong>StatefulSet部署的应用一般称为有状态应用</strong></li></ol> 
<blockquote> 
 <ol><li>无状态应用：可以简单理解为无状态应用不会记录当前状态,例如网络,存储等信息,如果应用宕机重启,重启后网络,存储,顺序可能等可能会变,例如Deployment部署的业务代码</li><li>有状态应用：可以记录当前状态,即使重启,重启后根据状态记录信息可以做到网络,存储,顺序等不变,例如中间件MySQL、Redis、MQ等等,以mysql为例,部署为有状态的服务,即使宕机重启访问地址不会变,其它服务还是可以正常访问的</li></ol> 
</blockquote> 
<ol start="2"><li><strong>并且使用StatefulSet部署的服务是有顺序的</strong>,创建pod时,会给创建的多个pod添加索引,部署,启动等都是按照这个索引顺序进行,停止或删除是按照索引逆序执行</li><li>StatefulSet 使用场景总结:</li></ol> 
<blockquote> 
 <ol><li>稳定、唯一的网络标识(dnsname)必须配合Service使用,StatefulSet通过与其相关的无头服务Service为每个pod提供DNS解析条目,通过解析DNS解析条目访问pod</li><li>稳定的、持久的存储, 每个Pod始终对应各自的存储路径(PersistantVolumeClaimTemplate)</li><li>有序的、优雅的部署和缩放。按顺序地增加副本、减少副本，并在减少副本时执行清理</li><li>有序的、自动的滚动更新。按顺序自动地执行滚动更新</li></ol> 
</blockquote> 
<ol start="4"><li>StatefulSet注意点</li></ol> 
<blockquote> 
 <ol><li>给定 Pod 的存储必须由 PersistentVolume 驱动 基于所请求的 storage class 来提供，或者由管理员预先提供。</li><li>删除或者收缩 StatefulSet 并不会 删除它关联的存储卷。 这样做是为了保证数据安全，它通常比自动清除 StatefulSet 所有相关的资源更有价值。</li><li>StatefulSet 当前需要无头服务 来负责 Pod 的网络标识。你需要负责创建此服务。</li><li>当删除 StatefulSets 时，StatefulSet 不提供任何终止 Pod 的保证。 为了实现 StatefulSet 中的Pod 可以有序地且体面地终止，可以在删除之前将 StatefulSet 缩放为 0。</li><li>在默认 Pod 管理策略( OrderedReady ) 时使用 滚动更新，可能进入需要人工干预 才能修复的损坏状态</li></ol> 
</blockquote> 
<h2><a id="_StatefulSet__Service__17"></a>二. StatefulSet 配合 Service 负载均衡网络(无头服务)的使用</h2> 
<ol><li>StatefulSe与Service负载均衡网络的配合,使用StatefulSet 部署的有状态应用网络,存储等信息不变,以访问地址不变为例,封装Service负载均衡网络时设置" clusterIP: None" 不要分配ClusterIP,headless service等,访问地址由Service内部代理的通过StatefulSe部署pod自己控制</li></ol> 
<blockquote> 
 <ol><li>该方式下k8s内部通过"podName.serviceName.namespace.svc.cluster.local" 访问指定pod</li><li>通过无头服务Service代理StatefulSet 部署的多个pod,也是可以直接访问service,通过Service负载均衡选择指定pod访问</li><li>此时外部无法访问这个无头服务Service的,如果想要外部访问需要使用ingress网络定义所有的访问逻辑</li></ol> 
</blockquote> 
<ol start="2"><li>一个StatefulSet与Service示例:(下方解释)</li></ol> 
<blockquote> 
 <ol><li>下方使用StatefulSet部署mysql服务,部署3个副本,pod名称为none-mysql,并使用serviceName将当前部署的服务添加到none-service负载均衡网络中</li><li>封装Service负载均衡网络"none-service",通过"clusterIP: None"设置当前Service为无头服务,不分配ClusterIP,headless等</li><li>由于使用StatefulSet部署时,会给部署的多个pod添加索引,加上索引后每个pod名称都是唯一的,例如"none-mysql-0",“none-mysql-1”,“none-mysql-2”,内部管理的多个pod启停删除等都是由顺序的,访问ip也是固定的,即使pod重启也不会变</li><li>部署的服务添加到无头的负载均衡网络后,通过"podName.serviceName.namespace.svc.cluster.local"访问指定pod(后面的".svc.cluster.local"是固定格式),换算下来如果想要访问none-mysql第一个pod,请求"none-mysql-0.none-service.default.svc.cluster.local"即可</li></ol> 
</blockquote> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet  <span class="token comment">### 有状态副本集</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> stateful<span class="token punctuation">-</span>mysql
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> none<span class="token punctuation">-</span>mysql
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">"none-service"</span>  <span class="token comment">## 服务名，指定加到那个service里面</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment"># 三个副本</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment">## Pod模板</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> none<span class="token punctuation">-</span>mysql
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> none<span class="token punctuation">-</span>mysql
        <span class="token key atrule">image</span><span class="token punctuation">:</span> mysql
<span class="token punctuation">---</span>
<span class="token comment">#负载均衡网络</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Service
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> none<span class="token punctuation">-</span>service <span class="token comment">## 和部署的服务serviceName值与此处相同表示加入到当前网络中</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">app</span><span class="token punctuation">:</span> none<span class="token punctuation">-</span>mysql <span class="token comment">#选中哪些pod的标签</span>
  <span class="token key atrule">clusterIP</span><span class="token punctuation">:</span> None  <span class="token comment">## 设置为None 表示当前是一个无头服务,不要分配ClusterIP,headless service，整个集群的Pod能直接访问,注意此时浏览器目前不能访问,如果想要外部访问时需要使用ingress网络定义所有的访问逻辑</span>
  <span class="token key atrule">type</span><span class="token punctuation">:</span> ClusterIP
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> http
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">80</span>
    <span class="token key atrule">targetPort</span><span class="token punctuation">:</span> <span class="token number">80</span>
</code></pre> 
<h3><a id="podManagementPolicy_pod_64"></a>podManagementPolicy: pod的管理策略</h3> 
<ol><li>在使用StatefulSet 部署时,提供了一个podManagementPolicy属性,用来控制Pod创建,升级以及扩缩容逻辑,可以设置为:</li></ol> 
<blockquote> 
 <ol><li>OrderedReady: 按需(默认值,有序启动,StatefulSet部署时会给每个pod提供一个索引,会按照这个索引顺序启动,索引逆序停止)</li><li>Parallel:并发(同时创建启动,一般不使用)</li></ol> 
</blockquote> 
<h3><a id="updateStrategy_pod_68"></a>updateStrategy: pod更新策略</h3> 
<ol><li>在使用StatefulSet 部署时,提供了一个updateStrategy属性,用来控制更新策略,是一个属性对象,内部有rollingUpdate和type两个属性,默认情况下使用RollingUpdate滚动升级作为更新策略,可以指定为partition按分区升级</li></ol> 
<blockquote> 
 <p>使用StatefulSet时,会给部署的pod添加索引,在指定为partition更新策略,更新时只会更新索引大于等于partition的pod</p> 
</blockquote> 
<pre><code class="prism language-yaml"><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> apps/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> StatefulSet <span class="token comment">#有状态副本集</span>
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> stateful<span class="token punctuation">-</span>nginx
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">podManagementPolicy</span><span class="token punctuation">:</span> OrderedReady <span class="token comment">#所有Pod一起创建，OrderedReady：有序创建</span>
  <span class="token key atrule">updateStrategy</span><span class="token punctuation">:</span> <span class="token comment">#升级策略</span>
    <span class="token key atrule">rollingUpdate</span><span class="token punctuation">:</span>
  	<span class="token key atrule">partition</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#更新大于等于这个索引的pod</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span>
    <span class="token key atrule">matchLabels</span><span class="token punctuation">:</span>
      <span class="token key atrule">app</span><span class="token punctuation">:</span> ss<span class="token punctuation">-</span>nginx <span class="token comment">#hastomatch.spec.template.metadata.labels</span>
  <span class="token key atrule">serviceName</span><span class="token punctuation">:</span> <span class="token string">"nginx"</span>
  <span class="token key atrule">replicas</span><span class="token punctuation">:</span> <span class="token number">3</span> <span class="token comment">#三个副本</span>
  <span class="token key atrule">template</span><span class="token punctuation">:</span> <span class="token comment">#Pod模板</span>
    <span class="token key atrule">metadata</span><span class="token punctuation">:</span>
      <span class="token key atrule">labels</span><span class="token punctuation">:</span>
        <span class="token key atrule">app</span><span class="token punctuation">:</span> ss<span class="token punctuation">-</span>nginx
    <span class="token key atrule">spec</span><span class="token punctuation">:</span>
      <span class="token key atrule">containers</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> nginx
          <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bbbfdadde8de709222b3370653c2a80b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">什么是tensorflow</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2b69652c037ea06385e5532d348827bd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【js】超链接取消默认跳转行为</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>