<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>k8s（8）—— k8s存储之ConfigMap - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="k8s（8）—— k8s存储之ConfigMap" />
<meta property="og:description" content="目录 一、ConfigMap简介 1、ConfigMap的概念 二、Cofigmap配置管理 创建Cofigmap的方式有4种
1、使用字面值创建 2、使用文件进行创建 3、使用目录进行创建 4、编写cofigmap的yaml文件年创建 三、使用configmap设置环境变量 （一）、方法一：
1、创建yaml文件2、查看更新的情况 （二）、方法二：
1、修改yaml文件的配置内容2、测试 （三）、直接指定答应的key对应的值
1、修改yaml文件 2、测试 （四）通过数据卷使用configmap
1、查看官网信息2、创建yaml文件 四、configmap热更新 （一）、热更新的验证 1、创建yaml文件
2、修改文件cm4-config文件的内容查看更新
（二）、configmap热更新后，并不会触发相关的pod的滚动更新，需要手动触发：
1、创建nginx.conf文件 nginx端口服务的文件
2、以nginx.config 来创建configmap
3、要使yaml文件生效改变 pod的更新需要手动更新
一、ConfigMap简介 1、ConfigMap的概念 ConfigMap 资源提供了向 Pod 注入配置数据的方法。 ConfigMap 对象中存储的数据可以被 configMap 类型的卷引用，然后被应用到 Pod 中运行的容器化应用。
当引用 configMap 对象时，你可以简单的在 Volume 中通过它名称来引用。 还可以自定义 ConfigMap 中特定条目所要使用的路径。 例如，要将名为 log-config 的 ConfigMap 挂载到名为 configmap-pod 的 Pod 中
cofigmap 配置管理
Cofigmap由于保存配置数据，以键值对形式存储
Cofigmap资源提供了向Pod注入配置数据的方式
旨在让镜像和配置年文件解析藕，以便实现景象的可移植性和可复制性
典型的使用场所：
填充环境变量的值
设置容器内的命令行的参数
填充卷的配置文件
官网信息：https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c34e3e1f5689f1be30467b129c14cb47/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-06T22:31:00+08:00" />
<meta property="article:modified_time" content="2020-03-06T22:31:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">k8s（8）—— k8s存储之ConfigMap</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>目录</h4> 
<h4>一、ConfigMap简介</h4> 
<ul><li><span style="color:#3399ea;"><strong>1、ConfigMap的概念  </strong></span></li></ul> 
<p> </p> 
<h4>二、Cofigmap配置管理</h4> 
<p><strong>创建Cofigmap的方式有4种</strong></p> 
<ul><li><span style="color:#3399ea;">  1、使用字面值创建</span></li><li><span style="color:#3399ea;">  2、使用文件进行创建</span></li><li><span style="color:#3399ea;">  3、使用目录进行创建</span></li><li><span style="color:#3399ea;">  4、编写cofigmap的yaml文件年创建</span></li></ul> 
<p> </p> 
<h4>三、<strong>使用configmap设置环境变量</strong></h4> 
<p><strong>（一）、方法一：</strong></p> 
<ul><li><span style="color:#3399ea;">1、创建yaml文件</span></li><li><span style="color:#3399ea;">2、查看更新的情况</span></li></ul> 
<p><strong>（二）、方法二：</strong></p> 
<ul><li>1、<span style="color:#3399ea;">修改yaml文件的配置内容</span></li><li><span style="color:#3399ea;">2、测试</span></li></ul> 
<p><strong>（三）、直接指定答应的key对应的值</strong></p> 
<ul><li><span style="color:#3399ea;">1、修改yaml文件 </span></li><li><span style="color:#3399ea;">2、测试</span></li></ul> 
<p><strong>（四）通过数据卷使用configmap</strong></p> 
<ul><li><span style="color:#3399ea;">1、查看官网信息</span></li><li><span style="color:#3399ea;">2、创建yaml文件 </span></li></ul> 
<p> </p> 
<h4>四、configmap热更新</h4> 
<p><strong>（一）、热更新的验证 </strong></p> 
<p><span style="color:#3399ea;">1、创建yaml文件</span></p> 
<p><span style="color:#3399ea;">2、修改文件cm4-config文件的内容查看更新</span></p> 
<p><strong>（二）、configmap热更新后，并不会触发相关的pod的滚动更新，需要手动触发：</strong></p> 
<p><span style="color:#3399ea;">1、创建nginx.conf文件  nginx端口服务的文件</span></p> 
<p><span style="color:#3399ea;">2、以nginx.config 来创建configmap</span></p> 
<p><span style="color:#3399ea;">3、要使yaml文件生效改变 pod的更新需要手动更新</span></p> 
<p> </p> 
<p> </p> 
<p> </p> 
<h4>一、ConfigMap简介</h4> 
<ul><li><span style="color:#3399ea;"><strong>1、ConfigMap的概念  </strong></span></li></ul> 
<p>ConfigMap 资源提供了向 Pod 注入配置数据的方法。 ConfigMap 对象中存储的数据可以被 configMap 类型的卷引用，然后被应用到 Pod 中运行的容器化应用。</p> 
<p>当引用 configMap 对象时，你可以简单的在 Volume 中通过它名称来引用。 还可以自定义 ConfigMap 中特定条目所要使用的路径。 例如，要将名为 log-config 的 ConfigMap 挂载到名为 configmap-pod 的 Pod 中</p> 
<p> cofigmap 配置管理<br> Cofigmap由于保存配置数据，以键值对形式存储<br> Cofigmap资源提供了向Pod注入配置数据的方式<br> 旨在让镜像和配置年文件解析藕，以便实现景象的可移植性和可复制性<br> 典型的使用场所：<br>    填充环境变量的值<br>    设置容器内的命令行的参数<br>    填充卷的配置文件</p> 
<p>官网信息：<span style="color:#3399ea;">https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</span></p> 
<h4> </h4> 
<h4>一、Cofigmap配置管理</h4> 
<p><strong>创建Cofigmap的方式有4种</strong></p> 
<ul><li><span style="color:#3399ea;">  1、使用字面值创建</span></li><li><span style="color:#3399ea;">  2、使用文件进行创建</span></li><li><span style="color:#3399ea;">  3、使用目录进行创建</span></li><li><span style="color:#3399ea;">  4、编写cofigmap的yaml文件年创建</span></li></ul> 
<p> </p> 
<p><strong>1、使用字面创建</strong></p> 
<pre><code class="language-css">[kubeadm@server1 ~]$ mkdir configmap     ##创建目录（创建的目录是为了区分其他的实验）
[kubeadm@server1 ~]$
[kubeadm@server1 ~]$ cd configmap/
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl create configmap cm1-config --from-literal=key1=config1 --from-literal=key2=config2                             ##创建configmap
configmap/cm1-config created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get cm           ##查看是否创建成功
NAME         DATA   AGE
cm1-config   2      12s</code></pre> 
<p> </p> 
<p> </p> 
<p>1.2、查看是生成的configmap文件信息 </p> 
<pre><code class="language-css">
[kubeadm@server1 configmap]$ kubectl describe cm cm1-config        ##查看创建的日志

Name:         cm1-config
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
key1:               ##键值 
----  
config1              ##键值对应的值
key2:
----
config2
Events:  &lt;none&gt;
[kubeadm@server1 configmap]$

</code></pre> 
<p><img alt="" height="267" src="https://images2.imgbox.com/cc/67/0JmRmVGg_o.png" width="500"></p> 
<p> </p> 
<p><br><br><strong>2、使用文件创建</strong></p> 
<pre><code class="language-css">kubeadm@server1 configmap]$ kubectl create configmap my-config-2 --from-file=/etc/resolv.conf   ##使用/etc/resolv.conf 文件进行创建
configmap/my-config-2 created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl describe cm my-config-2             ##查看创建的结果的
Name:         my-config-2
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
resolv.conf:                                                             ##键值
----

nameserver 114.114.114.114                                               ##对应的内容

Events:  &lt;none&gt;
[kubeadm@server1 configmap]$</code></pre> 
<p><img alt="" height="152" src="https://images2.imgbox.com/42/1f/ggYQ6Of6_o.png" width="500"></p> 
<p><br><strong>3、使用目录创建</strong></p> 
<p>目录中文件名为key，文件的内容为value</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ cp /etc/passwd .            ##将文件拷贝到当前目录下
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ ls
passwd  resolv.conf
[kubeadm@server1 configmap]$ cp /etc/fstab .             ##拷贝fstab到当前的目录下
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ ls
fstab  passwd  resolv.conf
[kubeadm@server1 configmap]$ kubectl create configmap cm3-config --from-file=.     ##以当前的目录中的文件创建configmap
configmap/cm3-config created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl describe cm cm3-config                        ##查看cm3的创建信息
Name:         cm3-config
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
fstab:
----

#
# /etc/fstab
# Created by anaconda on Tue Dec 17 20:27:01 2019
#
# Accessible filesystems, by reference, are maintained under '/dev/disk'
# See man pages fstab(5), findfs(8), mount(8) and/or blkid(8) for more info
#
/dev/mapper/rhel-root   /                       xfs     defaults        0 0
UUID=66383b38-e7f8-4146-9002-9f37c9251ffd /boot                   xfs     defaults        0 0
#/dev/mapper/rhel-swap   swap                    swap    defaults        0 0

passwd:
----
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin

----

nameserver 114.114.114.114

Events:  &lt;none&gt;

</code></pre> 
<p> </p> 
<p><strong>4、编写cofigmap的yaml文件年创建</strong></p> 
<p>4.1、配置ConfigMap的yaml文件</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim cm1.yaml
[kubeadm@server1 configmap]$ vim cm1.yaml
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl create -f cm1.yaml        ##创建ConfigMap文件
^[[3~configmap/cm4-config created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get cm                    ##查看创建的cm
NAME         DATA   AGE
cm1-config   2      &lt;invalid&gt;
cm2-config   1      41m
cm3-config   3      38m
cm4-config   2      14s
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl describe cm cm4-config   ##查看创建的日信息
Name:         cm4-config
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
db_host:
----
172.25.6.250                                                 ##创建对应的键值
db_port:
----
3306                                                         ##创建对应的value值
Events:  &lt;none&gt;
[kubeadm@server1 configmap]$

</code></pre> 
<p><img alt="" height="247" src="https://images2.imgbox.com/43/a1/q5eRxnDf_o.png" width="500"></p> 
<p>4.2、测试</p> 
<p><img alt="" height="246" src="https://images2.imgbox.com/53/54/tomTK4Jj_o.png" width="500"></p> 
<p> </p> 
<p> </p> 
<h4><br> 三、<strong>使用configmap设置环境变量</strong></h4> 
<p><strong>（一）、方法一：</strong></p> 
<ul><li><span style="color:#3399ea;">1、创建yaml文件</span></li><li><span style="color:#3399ea;">2、查看更新的情况</span></li></ul> 
<p><strong>（二）、方法二：</strong></p> 
<ul><li>1、<span style="color:#3399ea;">修改yaml文件的配置内容</span></li><li><span style="color:#3399ea;">2、测试</span></li></ul> 
<p><strong>（三）、直接指定答应的key对应的值</strong></p> 
<ul><li><span style="color:#3399ea;">1、修改yaml文件 </span></li><li><span style="color:#3399ea;">2、测试</span></li></ul> 
<p><strong>（四）通过数据卷使用configmap</strong></p> 
<ul><li><span style="color:#3399ea;">1、查看官网信息</span></li><li><span style="color:#3399ea;">2、创建yaml文件 </span></li></ul> 
<p>（一）、方法一一一导入环境变量</p> 
<p>（二）、批量导入环境变量</p> 
<p>（三）、直接导入指定的环境变量</p> 
<p>  通过环境变量的方式直接转递给pod<br>   通过在pod的命令行下运行的方式<br>   作为volume的方式挂载到pod内<br>  </p> 
<p><br><strong>（一）、方法一：</strong></p> 
<ul><li><span style="color:#3399ea;">1、创建yaml文件</span></li><li><span style="color:#3399ea;">2、查看更新的情况</span></li></ul> 
<p>1、创建yaml文件</p> 
<p>指导入yaml文件中指定的key值</p> 
<pre><code class="language-css">kubeadm@server1 configmap]$ vim cm2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod1
spec:
  containers:
    - name: pod1
      image: busybox
      command: [ "/bin/sh", "-c", "env" ]           ##运行完后直接打印变量
      env:                                          ##环境变量
        - name: key1                                ##key1等于cmc4-confing中取的db_host对应的值
          valueFrom:
            configMapKeyRef:                        ##从configMapKeyRef中去取值
              name: cm4-config                      ##取值的服务对象
              key: db_host                          ##在cmc4-confing中取的值对应的key值
        - name: key2
          valueFrom:
            configMapKeyRef:
              name: cm4-config
              key: db_port
  restartPolicy: Never                              ##不用去重启pod</code></pre> 
<p>   <img alt="" height="264" src="https://images2.imgbox.com/03/e5/NswJXPWv_o.png" width="500">                                    <br>  </p> 
<p> </p> 
<p>1.2、测试：</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl create -f cm2.yaml
pod/pod1 created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get pod
NAME   READY   STATUS              RESTARTS   AGE
pod1   0/1     ContainerCreating   0          5s


[kubeadm@server1 configmap]$ kubectl get pod
NAME   READY   STATUS      RESTARTS   AGE
pod1   0/1     Completed   0          21s


[kubeadm@server1 configmap]$ kubectl describe cm cm4-config     
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data                                          ##cm-configmap上的内容
====
db_host:
----
172.25.6.250
db_port:
----
3306
Events:  &lt;none&gt;

</code></pre> 
<p> </p> 
<p> </p> 
<p>1.3、查看pod1的日志</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl logs pod1
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT=443
HOSTNAME=pod1
SHLVL=1
HOME=/root
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT=443
key1=172.25.6.250                                         ##对应文件中的内容
KUBERNETES_PORT_443_TCP_PROTO=tcp
key2=3306                                                 ##对应的是文件中cm4-config中的值已经被注入po1容器内
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_SERVICE_HOST=10.96.0.1
PWD=/</code></pre> 
<p><br>  </p> 
<p><strong>2、查看更新的情况</strong></p> 
<p>修改cm4-config中都内容</p> 
<pre><code class="language-css">
[kubeadm@server1 configmap]$ kubectl edit cm cm4-config        ##编辑cm4-config

加入：db_name: westos</code></pre> 
<p><img alt="" height="252" src="https://images2.imgbox.com/6b/d3/J8F7FlBd_o.png" width="500"></p> 
<p> </p> 
<p><br><br> 2.2、查看更新的情况</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl describe cm cm4-config
Name:         cm4-config
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
db_host:
----
172.25.6.250
db_name:
----
westos                                 ##修改后的内容
db_port:
----
3306
Events:  &lt;none&gt;</code></pre> 
<p><img alt="" height="204" src="https://images2.imgbox.com/f8/1b/UmONniCs_o.png" width="500"></p> 
<p>（更新成功！！！）</p> 
<p> </p> 
<p> </p> 
<p><strong>（二）、方法二：</strong></p> 
<ul><li>1、修改yaml文件的配置内容</li><li>2、测试</li></ul> 
<p>批量导入configmap文件中的多有参数：</p> 
<p>将cm4-config文件中所有的值导出来</p> 
<p><strong>1、修改yaml文件的配置内容</strong></p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim env2-config.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod2
spec:
  containers:
    - name: pod2
      image: busybox
      command: [ "/bin/sh", "-c", "env" ]
      envFrom:                                    ##导入环境变量
        - configMapRef:
              name: cm4-config                    ##从cm4-config中导入环境变量
  restartPolicy: Never


[kubeadm@server1 configmap]$ kubectl get pod
NAME   READY   STATUS      RESTARTS   AGE
pod1   0/1     Completed   0          5h7m
pod2   0/1     Completed   0          90s         ##查看是否生效
[kubeadm@server1 configmap]$</code></pre> 
<p><img alt="" height="78" src="https://images2.imgbox.com/c8/c0/Y0JDNhZF_o.png" width="500"></p> 
<p><img alt="" height="148" src="https://images2.imgbox.com/11/b2/jtKwQeOI_o.png" width="500"></p> 
<p> </p> 
<p><strong>2、测试：</strong><br> 在cm4-config中的所有值已经被导入到pod2中</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl logs pod2
KUBERNETES_SERVICE_PORT=443
KUBERNETES_PORT=tcp://10.96.0.1:443
HOSTNAME=pod2
SHLVL=1
db_port=3306
HOME=/root
db_name=westos
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_SERVICE_HOST=10.96.0.1
PWD=/
db_host=172.25.6.250
[kubeadm@server1 configmap]$</code></pre> 
<p><img alt="" height="153" src="https://images2.imgbox.com/bf/0f/KDxRm4Zc_o.png" width="500"></p> 
<h4> </h4> 
<h4> </h4> 
<p><strong>（三）、直接指定答应的key对应的值</strong></p> 
<ul><li><span style="color:#3399ea;">1、修改yaml文件 </span></li><li><span style="color:#3399ea;">2、测试</span></li></ul> 
<p><strong>1、修改yaml文件</strong></p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim commad-config.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod3
spec:
  containers:
    - name: pod3
      image: busybox
      command: [ "/bin/sh", "-c", "echo $(db_host) $(db_port)" ]   ##运行取db_host、db_port
      envFrom:                                                      ##导入环境变量
        - configMapRef:
              name: cm4-config                                      ##从cm4-config中导入环境变量
  restartPolicy: Never
~                                                                                                     


[kubeadm@server1 configmap]$ kubectl create -f commad-config.yaml
pod/pod3 created         ##创建

[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get pod           ，         ##查看pod是否运行成功
NAME   READY   STATUS              RESTARTS   AGE
pod1   0/1     Completed           0          5h31m
pod2   0/1     Completed           0          25m
pod3   0/1     ContainerCreating   0          4s

</code></pre> 
<p><img alt="" height="255" src="https://images2.imgbox.com/3d/c9/VCSYWZka_o.png" width="500"></p> 
<p><img alt="" height="132" src="https://images2.imgbox.com/2a/16/V2gKjAed_o.png" width="500"></p> 
<p><br> 2、测试：</p> 
<p>（之间打印文件中对应的configmap中的所有值）</p> 
<pre><code class="language-cpp">[kubeadm@server1 configmap]$ kubectl logs pod3          ##直接输入从cm4-config中提取的db_host、db_port的值的结果
172.25.6.250 3306</code></pre> 
<p><br>  </p> 
<p> </p> 
<p><strong>（四）通过数据卷使用configmap</strong></p> 
<ul><li><span style="color:#3399ea;">1、查看官网信息</span></li><li><span style="color:#3399ea;">2、创建yaml文件 </span></li></ul> 
<p>查看官网信息：https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/</p> 
<p><img alt="" height="266" src="https://images2.imgbox.com/7d/1d/H5wmaVW1_o.png" width="500"></p> 
<p> </p> 
<p><strong>2、创建yaml文件 </strong></p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim volume.config.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod4
spec:
  containers:
    - name: pod4
      image: busybox
      command: [ "/bin/sh", "-c", "cat /config/db_host" ]         ##在命令行中执行cat /config/db_host的命令
      volumeMounts:
      - name: config-volume
        mountPath: /config                                        ##挂接cm4-config到/config
  volumes:
    - name: config-volume
      configMap:                                                  ##要挂载的config-volume卷来自于special-config
        name: cm4-config
  restartPolicy: Never                                            ##不用重启</code></pre> 
<p><br> 数据提取的过程直接把cm4-config 挂载到 /config下 然后提取db_host</p> 
<p><img alt="" height="265" src="https://images2.imgbox.com/03/c4/ojMgfBSl_o.png" width="500"></p> 
<p> </p> 
<p>2.2、创建configmap、查看是否创建成功</p> 
<pre><code>[kubeadm@server1 configmap]$ kubectl create -f volume.config.yaml       ##创建 
pod/pod4 created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get pod                            ##查看pod是否成功运行
NAME   READY   STATUS              RESTARTS   AGE
pod1   0/1     Completed           0          5h54m
pod2   0/1     Completed           0          48m
pod3   0/1     Completed           0          22m
pod4   0/1     ContainerCreating   0          9s
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get pod
NAME   READY   STATUS      RESTARTS   AGE
pod1   0/1     Completed   0          5h54m
pod2   0/1     Completed   0          48m
pod3   0/1     Completed   0          23m
pod4   0/1     Completed   0          16s
[kubeadm@server1 configmap]$</code></pre> 
<p> </p> 
<p>2.3、测试：</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl logs pod4
172.25.6.250

</code></pre> 
<p> </p> 
<p> </p> 
<h4>四、configmap热更新</h4> 
<p><strong>（一）、热更新的验证 </strong></p> 
<ul><li><span style="color:#3399ea;">1、创建yaml文件</span></li><li><span style="color:#3399ea;">2、修改文件cm4-config文件的内容查看更新</span></li></ul> 
<p><strong>（二）、configmap热更新后，并不会触发相关的pod的滚动更新，需要手动触发：</strong></p> 
<ul><li><span style="color:#3399ea;">1、创建nginx.conf文件  nginx端口服务的文件</span></li><li><span style="color:#3399ea;">2、以nginx.config 来创建configmap</span></li><li><span style="color:#3399ea;">3、要使yaml文件生效改变 pod的更新需要手动更新</span></li></ul> 
<p><strong>3、验证方法二：</strong></p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl delete -f volume.config.yaml
pod "pod4" deleted
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ vim volume.config.yaml

修改： command: [ "/bin/sh", "-c", "ls /config/" ]                 ##在命令行中执行列出/config下的目录

[kubeadm@server1 configmap]$ kubectl delete -f volume.config.yaml
pod "pod4" deleted
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ vim volume.config.yaml
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl create -f volume.config.yaml
pod/pod4 created
[kubeadm@server1 configmap]$ kubectl get pod
NAME   READY   STATUS      RESTARTS   AGE
pod1   0/1     Completed   0          6h1m
pod2   0/1     Completed   0          55m
pod3   0/1     Completed   0          29m
pod4   0/1     Completed   0          7s
[kubeadm@server1 configmap]$
​

[kubeadm@server1 configmap]$ kubectl logs pod4
db_host
db_name
db_port
[kubeadm@server1 configmap]$
​</code></pre> 
<p><img alt="" height="204" src="https://images2.imgbox.com/c0/78/0VLvr2WY_o.png" width="500"></p> 
<p> </p> 
<p>3.2、测试：</p> 
<p><img alt="" height="189" src="https://images2.imgbox.com/04/ea/uix6ka7G_o.png" width="500"></p> 
<p><br><br><br><strong>4、验证方法三：</strong></p> 
<p>列出/config下所有目录的内容所有kry对应的值</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim volume.config.yaml
command: [ "/bin/sh", "-c", "cat /config/*" ]               ##在命令行中执行列出/config下所有目录的内容</code></pre> 
<p><img alt="" height="211" src="https://images2.imgbox.com/71/fd/U63q24E3_o.png" width="500"></p> 
<p> </p> 
<p>4.2、测试：</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl logs pod4
172.25.6.250 westos 3306</code></pre> 
<p><br>  </p> 
<p> </p> 
<h4>四、configmap热更新</h4> 
<p><strong>（一）、热更新的验证 </strong></p> 
<p><span style="color:#3399ea;">1、创建yaml文件</span></p> 
<p><span style="color:#3399ea;">2、修改文件cm4-config文件的内容查看更新</span></p> 
<p><strong>（二）、configmap热更新后，并不会触发相关的pod的滚动更新，需要手动触发：</strong></p> 
<p><span style="color:#3399ea;">1、创建nginx.conf文件  nginx端口服务的文件 </span></p> 
<p><span style="color:#3399ea;">2、以nginx.config 来创建configmap</span></p> 
<p><span style="color:#3399ea;">3、要使yaml文件生效改变 pod的更新需要手动更新</span></p> 
<p>一般都用在结点的热更新上</p> 
<p><strong>（一）、热更新的验证 </strong></p> 
<p>1、创建yaml文件</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim hot-config.yaml
apiVersion: apps/v1                  ##控制器的版本
kind: Deployment                    ##控制器的类型
metadata:
  name: my-nginx            ##控制器的名称
spec:
  replicas: 1                ##副本数为1这些pod由集群自动取分配给哪个节点
  selector:
    matchLabels:
      app: nginx                     ##标签
  template:                          ##模板
    metadata:                        ##pod数据类型
      labels:
        app: nginx                   ##标签
    spec:
      containers:                    ##pod容器
      - name: nginx                  ##名称
        image: nginx             ##v2镜像（名称要和仓库里的镜像名称相同）
        ports:                       ##端口
        - containerPort: 80          ##监听的端口名称
        volumeMounts:
        - name: config-volume
          mountPath: /config                                        ##挂接cm4-config到/config
      volumes:
        - name: config-volume
          configMap:                                                  ##要挂载的config-volume卷来自于special-config
            name: cm4-config

</code></pre> 
<p><img alt="" height="265" src="https://images2.imgbox.com/57/63/tTcENdwy_o.png" width="500"> </p> 
<p> </p> 
<p>1.2、创建并检查pod是否正常运行</p> 
<pre><code class="language-css">
[kubeadm@server1 configmap]$ kubectl create -f hot-config.yaml       ##创建
deployment.apps/my-nginx created


[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get pod                         ##查看pod是否运行正常 
NAME                        READY   STATUS    RESTARTS   AGE
my-nginx-5ff649fc5b-c7zs9   1/1     Running   0          75s
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$</code></pre> 
<p><img alt="" height="51" src="https://images2.imgbox.com/f0/66/gz2UMpZX_o.png" width="500"></p> 
<p> </p> 
<p>1.3、测试：</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl exec my-nginx-5ff649fc5b-c7zs9 ls /config    ##查看目录
db_host
db_name
db_port
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl exec my-nginx-5ff649fc5b-c7zs9 ls /config/db_port
/config/db_port
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl exec my-nginx-5ff649fc5b-c7zs9 cat  /config/db_port
3306            ##查看db_port的内容</code></pre> 
<p><img alt="" height="133" src="https://images2.imgbox.com/89/01/8f1s5Sj1_o.png" width="500"></p> 
<p><img alt="" height="66" src="https://images2.imgbox.com/a4/f7/TvlqaZdq_o.png" width="500"></p> 
<p> </p> 
<p> </p> 
<p><strong>2、修改文件cm4-config文件的内容查看更新</strong></p> 
<p>2.1、修改cm4-config中的内容</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl edit cm cm4-config
# Please edit the object below. Lines beginning with a '#' will be ignored,
# and an empty file will abort the edit. If an error occurs while saving this file will be
# reopened with the relevant failures.
#
apiVersion: v1
data:
  db_host: 172.25.6.250
  db_name: westos
  db_port: "8888"                                 ##把参数改为8888
kind: ConfigMap
metadata:
  creationTimestamp: "2020-03-05T03:14:23Z"
  name: cm4-config
  namespace: default
  resourceVersion: "1605475"
  selfLink: /api/v1/namespaces/default/configmaps/cm4-config
  uid: 17652f1d-d0d8-47e6-b28d-d94b65702505

</code></pre> 
<p><img alt="" height="224" src="https://images2.imgbox.com/d3/88/Saq6hxbs_o.png" width="500"></p> 
<p> </p> 
<p>2.2、测试：</p> 
<p>查看更新的情况</p> 
<p>（需要等待一些时间）</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl exec my-nginx-5ff649fc5b-c7zs9 cat  /config/db_port
8888                                                       ##参数已经改为8888</code></pre> 
<p> </p> 
<p><img alt="" height="77" src="https://images2.imgbox.com/50/ef/yyugMiAG_o.png" width="500"></p> 
<p><img alt="" height="157" src="https://images2.imgbox.com/36/98/8cuqT6gN_o.png" width="500"></p> 
<p> </p> 
<p><br><strong>（二）、configmap热更新后，并不会触发相关的pod的滚动更新，需要手动触发：</strong></p> 
<p><span style="color:#3399ea;">1、创建nginx.conf文件  nginx端口服务的文件 </span></p> 
<p><span style="color:#3399ea;">2、以nginx.config 来创建configmap</span></p> 
<p><span style="color:#3399ea;">3、要使yaml文件生效改变 pod的更新需要手动更新</span></p> 
<p><br> 热更新：<br> updata -&gt; nginx.conf -&gt; reload nginx (一般的更新过程)<br> 文件更新<br> pod -&gt; 运行command 中的命令 load nginx.conf -&gt; memory（存放到我们的内存中）-&gt; update nginx.conf -&gt; trigger pod(触发文件更新) -&gt; reload nginx</p> 
<p><strong>1、创建nginx.conf文件  nginx端口服务的文件 </strong></p> 
<pre><code class="language-css">
[kubeadm@server1 configmap]$ vim nginx.conf
server {
    listen      8000;                                ##修改nginx访问的配置文件 
    server_name _;

    location / {
        root /usr/share/nginx/html;
        index index.html index.html;
    }
}</code></pre> 
<p><br>  </p> 
<p>1.2、拉取一个bash查看nginx的配置信息</p> 
<pre><code>~                                                                                                                      
[kubeadm@server1 configmap]$ kubectl exec my-nginx-5ff649fc5b-c7zs9 -it bash     ##进入配置文件的bash中
root@my-nginx-5ff649fc5b-c7zs9:/#
root@my-nginx-5ff649fc5b-c7zs9:/# cd /etc/nginx/
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx#
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx# ls
conf.d    fastcgi_params    koi-utf  koi-win  mime.types  modules  nginx.conf  scgi_params    uwsgi_params  win-utf
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx#
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx# cd conf.d/               ##端口文件存放的目录
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx/conf.d#
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx/conf.d# ls
default.conf
root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx/conf.d# cat default.conf
server {
    listen       80;
    server_name  localhost;

    #charset koi8-r;

root@my-nginx-5ff649fc5b-c7zs9:/etc/nginx/conf.d#</code></pre> 
<p> </p> 
<p>1.3、编辑yaml文件</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ vim hot-config.yaml
apiVersion: apps/v1                  ##控制器的版本确定
kind: Deployment                    ##控制器的类型
metadata:
  name: my-nginx            ##控制器的名称
spec:
  replicas: 1                ##副本数为1这些pod由集群自动取分配给哪个节点
  selector:
    matchLabels:
      app: nginx                     ##标签
  template:                          ##模板
    metadata:                        ##pod数据类型
      labels:
        app: nginx                   ##标签
    spec:
      containers:                    ##pod容器
      - name: nginx                  ##名称
        image: nginx             ##v2镜像（名称要和仓库里的镜像名称相同）
        volumeMounts:
        - name: config-volume
          mountPath: /etc/nginx/conf.d                                        ##nginx默认的端口存放的路径
      volumes:
        - name: config-volume
          configMap:                                                     ##要挂载的config-volume卷来自于special-config
            name: nginx-config                                   ##配置成功端口会成功的放在/etc/nginx/conf.d 之后</code></pre> 
<p><img alt="" height="266" src="https://images2.imgbox.com/97/d2/v5T3A4Wp_o.png" width="500"><br>                                                                                                                                                                                                                                         </p> 
<p> </p> 
<p><strong>2、以nginx.config 来创建configmap</strong></p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl create configmap nginx.config --from-file=nginx.conf     ##通过文件的形式来创建configmap
configmap/nginx.conf created
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get pod
No resources found in default namespace.
[kubeadm@server1 configmap]$
[kubeadm@server1 configmap]$ kubectl get cm
NAME         DATA   AGE
nginx.config   1      15s
[kubeadm@server1 configmap]$</code></pre> 
<p><img alt="" height="144" src="https://images2.imgbox.com/b3/8b/CjRElO12_o.png" width="500"></p> 
<p><br> 2.2、查看创建的configmap的日志信息</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl describe cm nginx.config
Name:         nginx.conf
Namespace:    default
Labels:       &lt;none&gt;
Annotations:  &lt;none&gt;

Data
====
nginx.conf:                                   
----
server {
    listen      8000;
    server_name _;

    location / {
        root /usr/share/nginx/html;
        index index.html index.html;
    }
}

Events:  &lt;none&gt;
[kubeadm@server1 configmap]$

</code></pre> 
<p> </p> 
<p>2.3、创建confgimap</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl create  -f hot-config.yaml
deployment.apps/my-nginx created
[kubeadm@server1 configmap]$</code></pre> 
<p><br><br> 2.4、测试：</p> 
<p>查看nginx.conf文件是否被放到 /etc/nginx/conf.d/路径下</p> 
<pre><code class="language-css">
[kubeadm@server1 configmap]$ kubectl exec my-nginx-7dc8d7b68d-cm24d cat /etc/nginx/conf.d/nginx.conf  ##查看nginx.conf 文件是否已经被存放到 /etc/nginx/conf.d/
server {
    listen      8000;
    server_name _;

    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
    }
}</code></pre> 
<p><img alt="" height="178" src="https://images2.imgbox.com/72/f9/uknyrJOL_o.png" width="500"></p> 
<p> </p> 
<p> </p> 
<p>3、要使yaml文件生效改变 pod的更新需要手动更新</p> 
<p>出现这种情况的原因是ongfigmap 热更新后 并不是触发相关的Pod滚动更新，需要手动触发</p> 
<p>每次通过修改“version/config” 来触发Pod的滚动更新<br> 使用configmap挂载环境变量是不会更新的</p> 
<p>3.1、修改nginx-config配置文件中的端口为“8080”</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl edit cm nginx-config      ##修改配置文件


****


#apiVersion: v1
#data:
#  nginx.conf: |
#    server {
        listen      8080;        ##将端口改为8080
#        server_name _;

#        location / {
#            root /usr/share/nginx/html;
#            index index.html index.htm;
#        }
#    }

</code></pre> 
<p><img alt="" height="86" src="https://images2.imgbox.com/69/0e/9thTD2Zx_o.png" width="500"></p> 
<p><img alt="" height="210" src="https://images2.imgbox.com/fd/f9/8rtOEg86_o.png" width="500"></p> 
<p> </p> 
<p><br> 3.2、测试：</p> 
<p>查看更新因为系统的原因所以会比较慢</p> 
<p><img alt="" height="210" src="https://images2.imgbox.com/e7/da/lEILjZaB_o.png" width="500"></p> 
<p> </p> 
<p> </p> 
<p>3.3、访问8000端口（8000端口依然可以访问说明更新只是热更新，并没有触发pod的更新）</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ curl 10.244.2.77:8000
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }</code></pre> 
<p> </p> 
<p>3.4、访问8080端口（访问失败）</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ curl 10.244.2.77:8080
curl: (7) Failed connect to 10.244.2.77:8080; Connection refused
[kubeadm@server1 configmap]$</code></pre> 
<p><img alt="" height="267" src="https://images2.imgbox.com/a1/e5/3dytWXRP_o.png" width="500"></p> 
<p> </p> 
<p>3.5、如果需要触发pod更新，则需要</p> 
<p>3.5.1、输入手动更新的命令：</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl patch deployments.apps my-nginx --patch '{"spec": {"template": {"metadata": {"annotations": {"version/config": "20200223"}}}}}'         ##输入的命令其实就是在修改yaml文件中的内容 </code></pre> 
<p>3.5.2、会触发pod的更新</p> 
<pre><code class="language-css">[kubeadm@server1 configmap]$ kubectl get pod
NAME                        READY   STATUS              RESTARTS   AGE
my-nginx-657cf55d9c-6nzdn   0/1     ContainerCreating   0          20s          ##新更新的pod
my-nginx-7dc8d7b68d-cm24d   1/1     Running             0          45m         ##原来运行的pod</code></pre> 
<p><img alt="" height="229" src="https://images2.imgbox.com/bc/bc/w9TpU2O6_o.png" width="500"></p> 
<p> </p> 
<p> </p> 
<p>3.6、测试：</p> 
<pre><code class="language-cpp">[kubeadm@server1 configmap]$ kubectl get pod -o wide
NAME                        READY   STATUS    RESTARTS   AGE    IP            NODE      NOMINATED NODE   READINESS GATES
my-nginx-657cf55d9c-6nzdn   1/1     Running   0          4m1s   10.244.1.65   server4   &lt;none&gt;               &lt;none&gt;         ##pod更新相应的ip也更新
[kubeadm@server1 configmap]$


[kubeadm@server1 configmap]$ curl 10.244.1.65:8080           ##验证8080端口是否被成功的更新
&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
&lt;title&gt;Welcome to nginx!&lt;/title&gt;
&lt;style&gt;
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
</code></pre> 
<p><img alt="" height="210" src="https://images2.imgbox.com/b3/ca/QSr2b5MZ_o.png" width="500"></p> 
<p>测试发现pod已经更新再次访问时可以访问到8080端口的后端</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2ef57df8fbc2bbacc90559406403098c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">求字符串‘abaabcac’的next数组和nextval数组</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/609583a5cc21001442e20977f94fb153/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【工具-IDEA】如何在IDEA里面只运行一个java文件，而不是编译运行整个项目</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>