<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Apollo 配置中心详细教程 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Apollo 配置中心详细教程" />
<meta property="og:description" content="一、简介 Apollo（阿波罗）是携程框架部门研发的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。
服务端基于Spring Boot和Spring Cloud开发，打包后可以直接运行，不需要额外安装Tomcat等应用容器。
Java客户端 不依赖任何框架，能够运行于所有Java运行时环境，同时对Spring/Spring Boot环境也有较好的支持。
.Net客户端 不依赖任何框架，能够运行于所有.Net运行时环境。
官方 GitHub： github.com/ctripcorp/a…
官方 Gitee： gitee.com/nobodyiam/a…
二、安装部署 2.1 环境准备 java： JDK 1.8.&#43; maven： 3.3.9 mysql： 版本要求（5.6.5&#43;） 查看数据库版本：SHOW VARIABLES WHERE Variable_name = &#39;version&#39;; Apollo服务端： 1.9&#43; Apollo客户端： 1.7&#43;
2.2 安装包下载 源码下载 从(Apollo-github) 下载最新的源码，也可以通过 git 命令下载到本地
git clone github.com/ctripcorp/a…
下载安装包 地址：github.com/ctripcorp/a…
注意： 本文中使用的方式为 1.源码下载，进行演示。
2.3 创建数据库 Apollo 服务端总共需要两个数据库：ApolloPortalDB和 ApolloConfigDB
我们可以在下载的源码包里面找到，文件目录为：apollo\scripts\sql，路径如下图所示：
或者通过下载地址来获取SQL
ApolloPortalDB
SQL下载地址：github.com/ctripcorp/a… 导入成功后，验证SQL：select * from `ApolloPortalDB`.`ServerConfig`;
ApolloConfigDB
SQL下载地址：github.com/ctripcorp/a… 导入成功后，验证SQL：select * from `ApolloConfigDB`." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6fe258f5625b5c7c732f0f1be03cf9fc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-20T10:35:00+08:00" />
<meta property="article:modified_time" content="2023-09-20T10:35:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Apollo 配置中心详细教程</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3>一、简介</h3> 
<p>Apollo（阿波罗）是携程框架部门研发的分布式配置中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性，适用于微服务配置管理场景。</p> 
<p>服务端基于Spring Boot和Spring Cloud开发，打包后可以直接运行，不需要额外安装Tomcat等应用容器。</p> 
<p><strong>Java客户端</strong> 不依赖任何框架，能够运行于所有Java运行时环境，同时对Spring/Spring Boot环境也有较好的支持。</p> 
<p><strong>.Net客户端</strong> 不依赖任何框架，能够运行于所有.Net运行时环境。</p> 
<p><strong>官方 GitHub：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fctripcorp%2Fapollo" rel="nofollow" title="github.com/ctripcorp/a…">github.com/ctripcorp/a…</a></p> 
<p><strong>官方 Gitee：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fnobodyiam%2Fapollo" rel="nofollow" title="gitee.com/nobodyiam/a…">gitee.com/nobodyiam/a…</a></p> 
<h3>二、安装部署</h3> 
<h5>2.1 环境准备</h5> 
<p><strong>java</strong>： JDK 1.8.+ <strong>maven：</strong> 3.3.9 <strong>mysql：</strong> 版本要求（5.6.5+） 查看数据库版本：<code>SHOW VARIABLES WHERE Variable_name = 'version';</code> Apollo服务端： 1.9+ Apollo客户端： 1.7+</p> 
<h5>2.2 安装包下载</h5> 
<ol><li> <p>源码下载 从(<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapolloconfig%2Fapollo" rel="nofollow" title="Apollo-github">Apollo-github</a>) 下载最新的源码，也可以通过 git 命令下载到本地</p> 
  <blockquote> 
   <p>git clone <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fctripcorp%2Fapollo" rel="nofollow" title="github.com/ctripcorp/a…">github.com/ctripcorp/a…</a></p> 
  </blockquote> </li><li> <p>下载安装包 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fctripcorp%2Fapollo%2Freleases" rel="nofollow" title="github.com/ctripcorp/a…">github.com/ctripcorp/a…</a></p> </li></ol> 
<p><strong>注意：</strong> 本文中使用的方式为 1.源码下载，进行演示。</p> 
<h5>2.3 创建数据库</h5> 
<p>Apollo 服务端总共需要两个数据库：<code>ApolloPortalDB</code>和 <code>ApolloConfigDB</code></p> 
<p>我们可以在下载的源码包里面找到，文件目录为：<code>apollo\scripts\sql</code>，路径如下图所示：</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="214" src="https://images2.imgbox.com/57/39/OTkrz7La_o.png" width="736"></p> 
<p>或者通过下载地址来获取SQL</p> 
<p><strong>ApolloPortalDB</strong></p> 
<p>SQL下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fctripcorp%2Fapollo%2Ftree%2Fmaster%2Fscripts%2Fsql" rel="nofollow" title="github.com/ctripcorp/a…">github.com/ctripcorp/a…</a> 导入成功后，验证SQL：<code>select * from `ApolloPortalDB`.`ServerConfig`;</code></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="301" src="https://images2.imgbox.com/c5/04/rScBpcg8_o.png" width="1200"></p> 
<p><strong>ApolloConfigDB</strong></p> 
<p>SQL下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fctripcorp%2Fapollo%2Ftree%2Fmaster%2Fscripts%2Fsql" rel="nofollow" title="github.com/ctripcorp/a…">github.com/ctripcorp/a…</a> 导入成功后，验证SQL：<code>select * from `ApolloConfigDB`.`ServerConfig`;</code></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="198" src="https://images2.imgbox.com/56/9c/Fbp4VaKO_o.png" width="1200"></p> 
<h5>2.4 服务端配置调整（可选项）</h5> 
<p><strong>1. ApolloPortalDB库配置</strong></p> 
<p>操作表：<code>ServerConfig</code></p> 
<table><thead><tr><th>key</th><th>说明</th><th>默认值</th><th>values</th></tr></thead><tbody><tr><td>apollo.portal.envs</td><td>可支持的环境列表</td><td>dev</td><td>管理多个环境，以逗号分隔即可，不区分大小写，例如(DEV,TEST,UAT,PRO)</td></tr><tr><td>organizations</td><td>部门列表</td><td>[{"orgId":"TEST1","orgName":"样例部门1"},{"orgId":"TEST2","orgName":"样例部门2"}]</td><td>新建的应用中，部门是必选项，可以根据实际情况操作</td></tr><tr><td>superAdmin</td><td>Portal超级管理员</td><td>apollo</td><td>超级管理员拥有所有权限</td></tr><tr><td>api.readTimeout</td><td>http接口超时时间</td><td>10000</td><td></td></tr><tr><td>consumer.token.salt</td><td>设置token salt</td><td>someSalt</td><td>使用开放平台API，可以设置一个token salt 如果不使用 可以忽略</td></tr><tr><td>admin.createPrivateNamespace.switch</td><td>是否允许项目管理员创建私有namespace</td><td>true</td><td>设置为false 则项目管理员在页面上看不到创建private namespace的选项</td></tr></tbody></table> 
<p><strong>2. ApolloConfigDB库配置</strong></p> 
<p>操作表：<code>ServerConfig</code></p> 
<table><thead><tr><th>key</th><th>说明</th><th>默认值</th><th>values</th></tr></thead><tbody><tr><td>eureka.service.url</td><td>Eureka服务Url</td><td><a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2Feureka%2F" rel="nofollow" title="http://localhost:8080/eureka/">http://localhost:8080/eureka/</a></td><td>多个service以英文逗号分隔</td></tr><tr><td>namespace.lock.switch</td><td>功能开关，一次发布只能有一个人修改开关</td><td>false</td><td>配置为true，一次配置发布只能是一个人修改</td></tr><tr><td>config-service.cache.enabled</td><td>ConfigService是否开启缓存，开启后能提高性能，但是会增大内存消耗</td><td>false</td><td>配置为true，config service会缓存加载过的配置信息，从而加快后续配置获取性能</td></tr></tbody></table> 
<h5>2.5 打开工程</h5> 
<p>将下载下来的 Apollo 源码导入 idea 中，需要关注的项目主要是下面这三个：</p> 
<table><thead><tr><th>项目名</th><th>说明</th></tr></thead><tbody><tr><td>apollo-configservice</td><td>配置服务（meta server、eureka）</td></tr><tr><td>apollo-adminservice</td><td>配置管理服务</td></tr><tr><td>apollo-protal</td><td>apollo管理UI</td></tr></tbody></table> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="837" src="https://images2.imgbox.com/11/87/bpuVxSOE_o.png" width="466"></p> 
<p>我们找到 <code>/apollo/scripts/build.bat</code>的文件（Linux 是 bulid.sh）</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="685" src="https://images2.imgbox.com/19/ae/5U79FrAR_o.png" width="1200"></p> 
<p>修改数据库配置信息，注意这是两个库（<code>ApolloPortalDB</code>和 <code>ApolloConfigDB</code>）：</p> 
<pre><code class="hljs">rem apollo config db info(这个是ApolloConfigDB库)
set apollo_config_db_url="jdbc:mysql://localhost:3306/ApolloConfigDB?serverTimezone=UTC&amp;characterEncoding=utf-8"
set apollo_config_db_username="root"
set apollo_config_db_password="123456"

rem apollo portal db info(这个是ApolloPortalDB库)
set apollo_portal_db_url="jdbc:mysql://localhost:3306/ApolloPortalDB?serverTimezone=UTC&amp;characterEncoding=utf-8"
set apollo_portal_db_username="root"
set apollo_portal_db_password="123456"

rem meta server url, different environments should have different meta server addresses
rem 配置各环境meta service地址(configservice部署的地址)
rem 后面版本也是可以再运行时指定： -Dapollo.meta=http://192.168.*.*:8080
set dev_meta="http://localhost:8080"
set fat_meta="http://someIp:8080"
set uat_meta="http://anotherIp:8080"
set pro_meta="http://yetAnotherIp:8080"
</code></pre> 
<p></p> 
<p><strong>注意：</strong> 数据库连接，需要添加<code>serverTimezone=UTC</code>否则可能会报错</p> 
<p>修改完上面的配置以后，我们就可以执行<code>build.bat</code>批处理命令进行编译打包。 在windows 运行<code>build.bat</code>文件，如果是LInux 运行 <code>build.sh</code></p> 
<p>第一次会执行比较慢，需要下载Maven jar</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="384" src="https://images2.imgbox.com/48/9c/DBB9oa8f_o.png" width="1134"></p> 
<p>打包成功后，我们找到 <code>apollo-configservice、apollo-adminservice、apollo-portal </code>下target 目录，找到已经打好的三个jar包，copy 出来放到一个单独的目录，方便我们启动</p> 
<p>如下图所示：</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="173" src="https://images2.imgbox.com/6a/d1/mypgacJK_o.png" width="501"></p> 
<p>启动顺序为：<code>apollo-configservice &gt; apollo-adminservice &gt; apollo-portal</code>三个服务</p> 
<p>启动脚本，放到记事本，修改后缀名为 <code>.bat</code>就可以一键启动三个服务了</p> 
<pre></pre> 
<blockquote> 
 <p>@echo off</p> 
 <p>start cmd /c "java -jar apollo-configservice-1.10.0-SNAPSHOT.jar"</p> 
 <p>start cmd /c "java -jar apollo-adminservice-1.10.0-SNAPSHOT.jar"</p> 
 <p>start cmd /c "java -jar apollo-portal-1.10.0-SNAPSHOT.jar"</p> 
 <p>spause   // 防止运行完毕后直接关闭界面</p> 
 <p></p> 
</blockquote> 
<p>全部启动成功之后，打开浏览器输入：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8070%2F" rel="nofollow" title="http://localhost:8070/">http://localhost:8070/</a>，看到 Apollo 登录页面说明启动成功</p> 
<p><strong>用户名密码：</strong> apollo/admin</p> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="425" src="https://images2.imgbox.com/86/5c/2zRvQQB1_o.png" width="658"></p> 
<p>输入 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080" rel="nofollow" title="http://localhost:8080">http://localhost:8080</a> ，如果出现eureka 的管理界面，说明服务启动正常。</p> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="558" src="https://images2.imgbox.com/97/06/nEC7aQm2_o.png" width="1200"></p> 
<h3>三、客户端使用</h3> 
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapolloconfig%2Fapollo%2Fwiki%2FJava%25E5%25AE%25A2%25E6%2588%25B7%25E7%25AB%25AF%25E4%25BD%25BF%25E7%2594%25A8%25E6%258C%2587%25E5%258D%2597" rel="nofollow" title="客户端使用指南">客户端使用指南</a></p> 
<h5>3.1 导入jar包</h5> 
<blockquote> 
 <p><code>&lt;dependency&gt;</code></p> 
 <p><code>    &lt;groupId&gt;com.ctrip.framework.apollo&lt;/groupId&gt; </code></p> 
 <p><code>    &lt;artifactId&gt;apollo-client&lt;/artifactId&gt;</code></p> 
 <p><code>    &lt;version&gt;1.7.0&lt;/version&gt; </code></p> 
 <p><code>&lt;/dependency&gt;</code></p> 
 <p><code>&lt;!-- 数据库jar--&gt; </code></p> 
 <p><code>&lt;dependency&gt; </code></p> 
 <p><code>    &lt;groupId&gt;mysql&lt;/groupId&gt; </code></p> 
 <p><code>    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; </code></p> 
 <p><code>    &lt;scope&gt;runtime&lt;/scope&gt;</code></p> 
 <p><code>&lt;/dependency&gt; </code></p> 
 <p><code>&lt;dependency&gt; </code></p> 
 <p><code>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; </code></p> 
 <p><code>    &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;         </code></p> 
 <p><code>    &lt;version&gt;1.5.9.RELEASE&lt;/version&gt;</code></p> 
 <p><code>&lt;/dependency&gt; </code></p> 
</blockquote> 
<h5>3.2 发布配置</h5> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="414" src="https://images2.imgbox.com/73/be/YYCdUMNM_o.png" width="1200"></p> 
<p>创建应用</p> 
<ol><li>AppId：001</li><li>AppId：mxn-front-gateway</li></ol> 
<p><strong>AppId是应用的身份信息，是从服务端获取配置的一个重要信息。</strong></p> 
<p><strong>AppId：001的配置内容</strong></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="653" src="https://images2.imgbox.com/ef/07/rONfP1sH_o.png" width="1200"></p> 
<p><strong>AppId：mxn-front-gateway的配置内容</strong></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="390" src="https://images2.imgbox.com/de/6c/zoGs08AH_o.png" width="1200"></p> 
<p>上面的两张图，就是我们Apollo配置中心的详细配置页面</p> 
<ul><li>在页面左上方的环境列表模块展示了所有的环境和集群，用户可以自由切换。</li><li>页面中央展示了两个namespace 的配置信息，默认按照表格模式展示、编辑。用户也可以切换到文本模式，以文件形式查看、编辑。</li><li>页面上可以方便地进行发布、回滚、灰度、授权、查看更改历史和发布历史等操作</li></ul> 
<h5>3.3 操作配置项</h5> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="498" src="https://images2.imgbox.com/bc/7a/AQauRUEm_o.png" width="1200"></p> 
<p>输入配置内容</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="572" src="https://images2.imgbox.com/8b/b0/evLyLK2s_o.png" width="957"></p> 
<h5>3.4 发布配置</h5> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="507" src="https://images2.imgbox.com/60/17/lXwlMdzQ_o.png" width="1200"></p> 
<p>添加发布信息</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="478" src="https://images2.imgbox.com/39/34/C0DPzuQd_o.png" width="966"></p> 
<h3>四、Spring Boot 集成 Apollo</h3> 
<p>在Spring Boot中使用 apollo 配置比较方便，我们只需要在对应的配置(yml或者properties)中设置 apollo的（appid和meta）以及命名空间就行</p> 
<blockquote> 
 <p><strong>application.yml 配置</strong></p> 
 <p><code>app: </code></p> 
 <p><code>  id: 001 </code></p> 
 <p><code>apollo: </code></p> 
 <p><code>  meta: http://localhost:8080 </code></p> 
 <p><code>  bootstrap: </code></p> 
 <p><code>    enabled: true </code></p> 
 <p><code>    namespaces: dev.yml,test.properties </code></p> 
</blockquote> 
<p>Spring Boot 启动类，添加 <code>@EnableApolloConfig</code></p> 
<pre></pre> 
<blockquote> 
 <p><code>@SpringBootApplication </code></p> 
 <p><code>@EnableApolloConfig </code></p> 
 <p><code>public class ApolloMxnApplication { </code></p> 
 <p><code>public static void main(String[] args) {       SpringApplication.run(ApolloMxnApplication.class, args); </code></p> 
 <p><code>} } </code></p> 
</blockquote> 
<p>测试类，实时获取配置信息</p> 
<pre></pre> 
<blockquote> 
 <p></p> 
 <p><code>import org.springframework.beans.factory.annotation.Value; </code></p> 
 <p><code>import org.springframework.web.bind.annotation.RequestMapping; </code></p> 
 <p><code>import org.springframework.web.bind.annotation.RestController; </code></p> 
 <p><code>/** * </code></p> 
 <p><code>@program: apollo-mxn *</code></p> 
 <p><code>@ClassName TestController *</code></p> 
 <p><code>@description: * @author: lyy * </code></p> 
 <p><code>@create: 2021-09-15 17:45 * </code></p> 
 <p><code>@Version 1.0 **/ </code></p> 
 <p><code>@RestController </code></p> 
 <p><code>public class TestController { </code></p> 
 <p><code>  @Value(value = "${mxn.name}") </code></p> 
 <p><code>  private String name;</code></p> 
 <p><code>  @RequestMapping("test") </code></p> 
 <p><code>  public String test(){ </code></p> 
 <p><code>    return "hello world "+name; </code></p> 
 <p><code>  } </code></p> 
 <p><code>} </code></p> 
</blockquote> 
<p>这样我们就可以 从 meta 中 拉取两个命名空间(apollo-adminservice和apollo-configservice)的配置了</p> 
<p>Apollo</p> 
<h3>四、实现配置热加载</h3> 
<p>创建配置热加载实现类</p> 
<pre><code>import com.ctrip.framework.apollo.core.ConfigConsts;
import com.ctrip.framework.apollo.model.ConfigChangeEvent;
import com.ctrip.framework.apollo.spring.annotation.ApolloConfigChangeListener;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.jdbc.DataSourceProperties;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import javax.sql.DataSource;

/**
 * @program: apollo-mxn
 * @ClassName DataSourceConfig
 * @description: 实现配置信息热加载
 * @author: lyy
 * @create: 2021-09-15 16:41
 * @Version 1.0
 **/
@Configuration
@EnableConfigurationProperties(DataSourceProperties.class)
@Slf4j
public class ConfigHotLoad {

    @RefreshScope
    @Bean("dataSource_Bean")
    public DataSource dataSource(DataSourceProperties dataSourceProperties){
        return dataSourceProperties.initializeDataSourceBuilder().build();
    }

    @Autowired
    private ApplicationContext applicationContext;

    @Autowired
    private org.springframework.cloud.context.scope.refresh.RefreshScope refreshScope;

    /** @Author lyy
      * @Description //TODO 监听apollo 的配置变更
      * @Date 16:50 2021/9/15
      * @Param 
      * @return 
     **/
    @ApolloConfigChangeListener(value = {ConfigConsts.NAMESPACE_APPLICATION,"dev"},interestedKeyPrefixes = {"spring.datasource"})
    public void onChange(ConfigChangeEvent configChangeEvent){
        // 重新编译DataSource 初始化bean
        refreshScope.refresh("dataSource_Bean");
        log.info("Apollo config changed {}",applicationContext.getBean(DataSourceProperties.class).toString());

    }

}</code></pre> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="114" src="https://images2.imgbox.com/13/39/yt4ErcNg_o.png" width="444"></p> 
<p>我们 输入地址 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A%25E4%25BD%25A0%25E7%259A%2584%25E7%25AB%25AF%25E5%258F%25A3%2Ftest" rel="nofollow" title="http://localhost:你的端口/test">http://localhost:你的端口/test</a> 就可以看到，对应的配置名字，然后修改apollo里面的信息，发布后，再不启动项目的情况下，就可以更新我们的配置信息了</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="338" src="https://images2.imgbox.com/2c/a8/lUFZGnH3_o.png" width="1200"></p> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="128" src="https://images2.imgbox.com/e5/53/6LyWBe7O_o.png" width="544"></p> 
<p><strong>Apollo 本地缓存</strong></p> 
<blockquote> 
 <p>Linux：/opt/data/{appId}/config-cache Windows：C:\opt\data{appId}\config-cache</p> 
</blockquote> 
<h3>五、什么是 Apollo</h3> 
<p><strong>官方案例：</strong> 使用案例Demo可以参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fcodechina.csdn.net%2Fmirrors%2Fctripcorp%2Fapollo-use-cases" rel="nofollow" title="Apollo使用场景和示例代码">Apollo使用场景和示例代码</a>。</p> 
<h5>5.1 诞生背景</h5> 
<p>随着程序功能的日益复杂，程序的配置日益增多：各种功能的开关、参数的配置、服务器的地址……</p> 
<p>对程序配置的期望值也越来越高：配置修改后实时生效，灰度发布，分环境、分集群管理配置，完善的权限、审核机制……</p> 
<p>在这样的大环境下，传统的通过配置文件、数据库等方式已经越来越无法满足开发人员对配置管理的需求。</p> 
<p>Apollo配置中心应运而生！</p> 
<h5>5.2 Apollo 说明</h5> 
<p>Apollo（阿波罗）是携程框架部门研发的开源配置管理中心，能够集中化管理应用不同环境、不同集群的配置，配置修改后能够实时推送到应用端，并且具备规范的权限、流程治理等特性。</p> 
<p>Apollo支持4个维度管理Key-Value格式的配置：</p> 
<ol><li>application (应用)</li><li>environment (环境)</li><li>cluster (集群)</li><li>namespace (命名空间)</li></ol> 
<p>同时，Apollo基于开源模式开发，开源地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fctripcorp%2Fapollo" rel="nofollow" title="github.com/ctripcorp/a…">github.com/ctripcorp/a…</a></p> 
<h5>5.3 基础模型</h5> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="602" src="https://images2.imgbox.com/a8/ff/ZldhnCbH_o.png" width="956"></p> 
<p><strong>Apollo的基础模型：</strong></p> 
<blockquote> 
 <ol><li>用户在配置中心对配置进行修改并发布</li><li>配置中心通知Apollo客户端有配置更新</li><li>Apollo客户端从配置中心拉取最新的配置、更新本地配置并通知到应用</li></ol> 
</blockquote> 
<h3>六、Apollo特性</h3> 
<p>由于配置的特殊性，所以Apollo 从开始设计到完善就立志作为一个有治理能力的配置中心平台，Apollo的特性主要体现在以下几个方面</p> 
<ul><li><strong>统一配置的配置管理</strong> 
  <ol><li>Apollo提供了一个统一界面集中式管理不同环境（environment）、不同集群（cluster）、不同命名空间（namespace）的配置。</li><li>同一份代码部署在不同的集群，可以有不同的配置，比如zookeeper的地址等</li><li>通过命名空间（namespace）可以很方便地支持多个不同应用共享同一份配置，同时还允许应用对共享的配置进行覆盖</li></ol></li><li><strong>配置修改实时生效（热发布）</strong> 
  <ol><li>用户在Apollo修改完配置并发布后，客户端能实时（1秒）接收到最新的配置，并通知到应用程序</li></ol></li><li><strong>版本发布管理</strong> 
  <ol><li>所有的配置发布都有版本概念，从而可以方便地支持配置的回滚</li></ol></li><li><strong>灰度发布</strong> 
  <ol><li>支持配置的灰度发布，比如点了发布后，只对部分应用实例生效，等观察一段时间没问题后再推给所有应用实例</li></ol></li><li><strong>权限管理、发布审核、操作审计</strong> 
  <ol><li>应用和配置的管理都有完善的权限管理机制，对配置的管理还分为了编辑和发布两个环节，从而减少人为的错误。</li><li>所有的操作都有审计日志，可以方便地追踪问题</li></ol></li><li><strong>客户端配置信息监控</strong> 
  <ol><li>可以在界面上方便地看到配置在被哪些实例使用</li></ol></li><li><strong>提供Java和.Net原生客户端</strong> 
  <ol><li>提供了Java和.Net的原生客户端，方便应用集成</li><li>支持Spring Placeholder, Annotation和Spring Boot的ConfigurationProperties，方便应用使用（需要Spring 3.1.1+）</li><li>同时提供了Http接口，非Java和.Net应用也可以方便地使用</li></ol></li><li><strong>提供开放平台API</strong> 
  <ol><li>Apollo自身提供了比较完善的统一配置管理界面，支持多环境、多数据中心配置管理、权限、流程治理等特性。不过Apollo出于通用性考虑，不会对配置的修改做过多限制，只要符合基本的格式就能保存，不会针对不同的配置值进行针对性的校验，如数据库用户名、密码，Redis服务地址等</li><li>对于这类应用配置，Apollo支持应用方通过开放平台API在Apollo进行配置的修改 和发布，并且具备完善的授权和权限控制</li></ol></li><li><strong>部署简单</strong> 
  <ol><li>配置中心作为基础服务，可用性要求非常高，这就要求Apollo对外部依赖尽可能地少</li><li>目前唯一的外部依赖是MySQL，所以部署非常简单，只要安装好Java和MySQL就可以让Apollo跑起来</li><li>Apollo还提供了打包脚本，一键就可以生成所有需要的安装包，并且支持自定义运行时参数</li></ol></li></ul> 
<h3>七、Apollo原理</h3> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="734" src="https://images2.imgbox.com/f7/ef/xrcelmhe_o.png" width="1200"></p> 
<p>上图简要描述了Apollo客户端的实现原理：</p> 
<blockquote> 
 <ol><li>客户端和服务端保持了一个长连接，从而能第一时间获得配置更新的推送。</li><li>客户端还会定时从Apollo配置中心服务端拉取应用的最新配置。 
   <ul><li>这是一个fallback机制，为了防止推送机制失效导致配置不更新</li><li>客户端定时拉取会上报本地版本，所以一般情况下，对于定时拉取的操作，服务端都会返回304 - Not Modified</li><li>定时频率默认为每5分钟拉取一次，客户端也可以通过在运行时指定System &gt;Property: <code>apollo.refreshInterval</code>来覆盖，单位为分钟。</li></ul></li><li>客户端从Apollo配置中心服务端获取到应用的最新配置后，会保存在内存中</li><li>客户端会把从服务端获取到的配置在本地文件系统缓存一份 
   <ul><li>在遇到服务不可用，或网络不通的时候，依然能从本地恢复配置</li></ul></li><li>应用程序从Apollo客户端获取最新的配置、订阅配置更新通知</li></ol> 
</blockquote> 
<h3>八、自定义Cluster</h3> 
<h5>8.1 新建Cluster</h5> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="609" src="https://images2.imgbox.com/19/ca/xlhA6x08_o.png" width="239"></p> 
<p>点击后就进入到集群添加页面，一般情况下可以按照数据中心来划分集群 不过也支持自定义集群，比如可以为A机房的某一台机器和B机房的某一台机创建一个集群，使用一套配置。</p> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="420" src="https://images2.imgbox.com/a1/a4/tzl9Xck4_o.png" width="1200"></p> 
<p>Apollo会默认使用应用实例所在的数据中心作为cluster，所以如果两者一致的话，不需要额外配置。</p> 
<p>如果cluster和数据中心不一致的话，那么就需要通过System Property方式来指定运行时cluster：</p> 
<ul><li>-Dapollo.cluster=SomeCluster</li><li>这里注意<code>apollo.cluster</code>为全小写</li></ul> 
<h3>九、配置获取规则</h3> 
<p>在有了cluster概念后，配置的规则就显得重要了。比如应用部署在A机房，但是并没有在Apollo新建cluster，这个时候Apollo的行为是怎样的？或者在运行时指定了cluster=SomeCluster，但是并没有在Apollo新建cluster，这个时候Apollo的行为是怎样的？</p> 
<h5>9.1 应用自身配置的获取规则</h5> 
<p>当应用使用下面的语句获取配置时，我们称之为获取应用自身的配置，也就是应用自身的application namespace的配置。</p> 
<blockquote> 
 <p>Config config = ConfigService.getAppConfig();</p> 
</blockquote> 
<p>对这种情况的配置获取规则，简而言之如下：</p> 
<blockquote> 
 <ol><li>首先查找运行时cluster的配置（通过apollo.cluster指定）</li><li>如果没有找到，则查找数据中心cluster的配置</li><li>如果还是没有找到，则返回默认cluster的配置</li></ol> 
</blockquote> 
<p>图示如下：</p> 
<p class="img-center"><img alt="在这里插入图片描述" height="238" src="https://images2.imgbox.com/96/b2/7ZULARnR_o.png" width="772"></p> 
<p>所以如果应用部署在A数据中心，但是用户没有在Apollo创建cluster，那么获取的配置就是默认cluster（default）的。</p> 
<p>如果应用部署在A数据中心，同时在运行时指定了SomeCluster，但是没有在Apollo创建cluster，那么获取的配置就是A数据中心cluster的配置，如果A数据中心cluster没有配置的话，那么获取的配置就是默认cluster（default）的。</p> 
<h3>十、总体设计</h3> 
<p></p> 
<p class="img-center"><img alt="在这里插入图片描述" height="741" src="https://images2.imgbox.com/b9/e5/pxIIa5zg_o.png" width="856"></p> 
<p>上图来自网络</p> 
<p>上图简要描述了Apollo的总体设计，我们可以从下往上看：</p> 
<blockquote> 
 <ul><li>Config Service提供配置的读取、推送等功能，服务对象是Apollo客户端</li><li>Admin Service提供配置的修改、发布等功能，服务对象是Apollo Portal（管理界面）</li><li>Config Service和Admin Service都是多实例、无状态部署，所以需要将自己注册到Eureka中并保持心跳</li><li>在Eureka之上我们架了一层Meta Server用于封装Eureka的服务发现接口</li><li>Client通过域名访问Meta Server获取Config Service服务列表（IP+Port），而后直接通过IP+Port访问服务，同时在Client侧会做load balance、错误重试</li><li>Portal通过域名访问Meta Server获取Admin Service服务列表（IP+Port），而后直接通过IP+Port访问服务，同时在Portal侧会做load balance、错误重试</li><li>为了简化部署，我们实际上会把Config Service、Eureka和Meta Server三个逻辑角色部署在同一个JVM进程中</li></ul> 
</blockquote> 
<h3>十一、总结</h3> 
<p>到这里Apollo，就讲解完了，其实Apollo 可以理解成一个好用的配置管理中心，这里小农也是了解了一点皮毛，大家有不懂的地方，欢迎留言。</p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/218b767656d8c0f57f81c918b4a644b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Lostash同步Mysql数据到Elasticsearch（四）通过kibana辅助查看同步情况</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/cc9f7731f3ae07a380c8f4927dd0bcdd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">antd vue form表单校验总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>