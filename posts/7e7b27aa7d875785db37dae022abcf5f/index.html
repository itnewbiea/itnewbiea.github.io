<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>pod探针 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="pod探针" />
<meta property="og:description" content="目录 一、资源限制1、Pod 和 容器 的资源请求和限制2、CPU 资源单位3、内存 资源单位 二、重启策略三、健康检查：又称为探针（Probe） 一、资源限制 当定义 Pod 时可以选择性地为每个容器设定所需要的资源数量。 最常见的可设定资源是 CPU 和内存大小，以及其他类型的资源。当为 Pod 中的容器指定了 request 资源时，调度器就使用该信息来决定将 Pod 调度到哪个节点上。当还为容器指定了 limit 资源时，kubelet 就会确保运行的容器不会使用超出所设的 limit 资源量。kubelet 还会为容器预留所设的 request 资源量， 供该容器使用。如果 Pod 运行所在的节点具有足够的可用资源，容器可以使用超出所设置的 request 资源量。不过，容器不可以使用超出所设置的 limit 资源量。如果给容器设置了内存的 limit 值，但未设置内存的 request 值，Kubernetes 会自动为其设置与内存 limit 相匹配的 request 值。类似的，如果给容器设置了 CPU 的 limit 值但未设置 CPU 的 request 值，则 Kubernetes 自动为其设置 CPU 的 request 值 并使之与 CPU 的 limit 值匹配。 详解大家可以看官网
https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/ 1、Pod 和 容器 的资源请求和限制 模块含义spec." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/7e7b27aa7d875785db37dae022abcf5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-20T17:28:29+08:00" />
<meta property="article:modified_time" content="2021-08-20T17:28:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">pod探针</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">一、资源限制</a></li><li><ul><li><a href="#1Pod____11" rel="nofollow">1、Pod 和 容器 的资源请求和限制</a></li><li><a href="#2CPU__18" rel="nofollow">2、CPU 资源单位</a></li><li><a href="#3__21" rel="nofollow">3、内存 资源单位</a></li></ul> 
  </li><li><a href="#_108" rel="nofollow">二、重启策略</a></li><li><a href="#Probe_161" rel="nofollow">三、健康检查：又称为探针（Probe）</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>一、资源限制</h2> 
<ul><li>当定义 Pod 时可以选择性地为每个容器设定所需要的资源数量。 最常见的可设定资源是 CPU 和内存大小，以及其他类型的资源。</li><li>当为 Pod 中的容器指定了 request 资源时，调度器就使用该信息来决定将 Pod 调度到哪个节点上。当还为容器指定了 limit 资源时，kubelet 就会确保运行的容器不会使用超出所设的 limit 资源量。kubelet 还会为容器预留所设的 request 资源量， 供该容器使用。</li><li>如果 Pod 运行所在的节点具有足够的可用资源，容器可以使用超出所设置的 request 资源量。不过，容器不可以使用超出所设置的 limit 资源量。</li><li>如果给容器设置了内存的 limit 值，但未设置内存的 request 值，Kubernetes 会自动为其设置与内存 limit 相匹配的 request 值。类似的，如果给容器设置了 CPU 的 limit 值但未设置 CPU 的 request 值，则 Kubernetes 自动为其设置 CPU 的 request 值 并使之与 CPU 的 limit 值匹配。</li></ul> 
<p><strong>详解大家可以看官网</strong></p> 
<pre><code class="prism language-javascript">https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>docs<span class="token operator">/</span>concepts<span class="token operator">/</span>configuration<span class="token operator">/</span>manage<span class="token operator">-</span>compute<span class="token operator">-</span>resources<span class="token operator">-</span>container<span class="token operator">/</span>
</code></pre> 
<h3><a id="1Pod____11"></a>1、Pod 和 容器 的资源请求和限制</h3> 
<table><thead><tr><th>模块</th><th>含义</th></tr></thead><tbody><tr><td>spec.containers[].resources.requests.cpu</td><td>定义创建容器时预分配的CPU资源</td></tr><tr><td>spec.containers[].resources.requests.memory</td><td>定义创建容器时预分配的内存资源</td></tr><tr><td>spec.containers[].resources.limits.cpu</td><td>定义 cpu 的资源上限</td></tr><tr><td>spec.containers[].resources.limits.memory</td><td>定义内存的资源上限</td></tr></tbody></table> 
<h3><a id="2CPU__18"></a>2、CPU 资源单位</h3> 
<ul><li>CPU 资源的 request 和 limit 以 cpu 为单位。Kubernetes 中的一个 cpu 相当于1个 vCPU（1个超线程）。</li><li>Kubernetes 也支持带小数 CPU 的请求。spec.containers[].resources.requests.cpu 为 0.5 的容器能够获得一个 cpu 的一半 CPU 资源（类似于Cgroup对CPU资源的时间分片）。表达式 0.1 等价于表达式 100m（毫核），表示每 1000 毫秒内容器可以使用的 CPU 时间总量为 0.1*1000 毫秒。</li></ul> 
<h3><a id="3__21"></a>3、内存 资源单位</h3> 
<ul><li> <p>内存的 request 和 limit 以字节为单位。可以以整数表示，或者以10为底数的指数的单位（E、P、T、G、M、K）来表示， 或者以2为底数的指数的单位（Ei、Pi、Ti、Gi、Mi、Ki）来表示。</p> 
  <ul><li>如：1KB=10<sup>3=1000，1MB=10</sup>6=1000000=1000KB，1GB=10^9=1000000000=1000MB<br> 1KiB=2<sup>10=1024，1MiB=2</sup>20=1048576=1024KiB</li></ul> </li><li> <p>PS：在买硬盘的时候，操作系统报的数量要比产品标出或商家号称的小一些，主要原因是标出的是以 MB、GB为单位的，1GB 就是1,000,000,000Byte，而操作系统是以2进制为处理单位的，因此检查硬盘容量时是以MiB、GiB为单位，1GB=2^30=1,073,741,824，相比较而言，1GiB要比1GB多出1,073,741,824-1,000,000,000=73,741,824Byte，所以检测实际结果要比标出的少一些。</p> </li></ul> 
<pre><code class="prism language-javascript">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> frontend
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> app
    image<span class="token operator">:</span> images<span class="token punctuation">.</span>my<span class="token operator">-</span>company<span class="token punctuation">.</span>example<span class="token operator">/</span>app<span class="token operator">:</span>v4
    env<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">MYSQL_ROOT_PASSWORD</span>
      value<span class="token operator">:</span> <span class="token string">"password"</span>
    resources<span class="token operator">:</span>
      requests<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"64Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"250m"</span>
      limits<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"128Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"500m"</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> log<span class="token operator">-</span>aggregator
    image<span class="token operator">:</span> images<span class="token punctuation">.</span>my<span class="token operator">-</span>company<span class="token punctuation">.</span>example<span class="token operator">/</span>log<span class="token operator">-</span>aggregator<span class="token operator">:</span>v6
    resources<span class="token operator">:</span>
      requests<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"64Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"250m"</span>
      limits<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"128Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"500m"</span>
</code></pre> 
<p>此例子中的 Pod 有两个容器。每个容器的 request 值为 0.25 cpu 和 64MiB 内存，每个容器的 limit 值为 0.5 cpu 和 128MiB 内存。那么可以认为该 Pod 的总的资源 request 为 0.5 cpu 和 128 MiB 内存，总的资源 limit 为 1 cpu 和 256MiB 内存。</p> 
<pre><code class="prism language-javascript">vim pod2<span class="token punctuation">.</span>yaml
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> frontend
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> web
    image<span class="token operator">:</span> nginx
    env<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> <span class="token constant">WEB_ROOT_PASSWORD</span>
      value<span class="token operator">:</span> <span class="token string">"password"</span>
    resources<span class="token operator">:</span>
      requests<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"64Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"250m"</span>
      limits<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"128Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"500m"</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> wp
    image<span class="token operator">:</span> wordpress
    resources<span class="token operator">:</span>
      requests<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"64Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"250m"</span>
      limits<span class="token operator">:</span>
        memory<span class="token operator">:</span> <span class="token string">"128Mi"</span>
        cpu<span class="token operator">:</span> <span class="token string">"500m"</span>

kubectl apply <span class="token operator">-</span>f pod2<span class="token punctuation">.</span>yaml
kubectl describe pod frontend

kubectl <span class="token keyword">get</span> pods <span class="token operator">-</span>o wide
<span class="token constant">NAME</span>       <span class="token constant">READY</span>   <span class="token constant">STATUS</span>    <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>   <span class="token constant">IP</span>           <span class="token constant">NODE</span>     <span class="token constant">NOMINATED</span> <span class="token constant">NODE</span>   <span class="token constant">READINESS</span> <span class="token constant">GATES</span>
frontend   <span class="token number">2</span><span class="token operator">/</span><span class="token number">2</span>     Running   <span class="token number">5</span>          <span class="token number">15</span>m   <span class="token number">10.244</span><span class="token number">.2</span><span class="token number">.4</span>   node02   <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>           <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>

kubectl describe nodes node02				#由于当前虚拟机有<span class="token number">2</span>个<span class="token constant">CPU</span>，所以Pod的<span class="token constant">CPU</span> Limits一共占用了<span class="token number">50</span><span class="token operator">%</span>
Namespace                  Name                           <span class="token constant">CPU</span> Requests  <span class="token constant">CPU</span> Limits  Memory Requests  Memory Limits  <span class="token constant">AGE</span>
  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>                  <span class="token operator">--</span><span class="token operator">--</span>                           <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>  <span class="token operator">--</span><span class="token operator">-</span>
  <span class="token keyword">default</span>                    frontend                       <span class="token number">500</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token number">25</span><span class="token operator">%</span><span class="token punctuation">)</span>    <span class="token number">1</span> <span class="token punctuation">(</span><span class="token number">50</span><span class="token operator">%</span><span class="token punctuation">)</span>     <span class="token number">128</span><span class="token function">Mi</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token operator">%</span><span class="token punctuation">)</span>       <span class="token number">256</span><span class="token function">Mi</span> <span class="token punctuation">(</span><span class="token number">6</span><span class="token operator">%</span><span class="token punctuation">)</span>     <span class="token number">16</span>m
  kube<span class="token operator">-</span>system                kube<span class="token operator">-</span>flannel<span class="token operator">-</span>ds<span class="token operator">-</span>amd64<span class="token operator">-</span>f4pbp    <span class="token number">100</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">%</span><span class="token punctuation">)</span>     <span class="token number">100</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token operator">%</span><span class="token punctuation">)</span>   <span class="token number">50</span><span class="token function">Mi</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">%</span><span class="token punctuation">)</span>        <span class="token number">50</span><span class="token function">Mi</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">%</span><span class="token punctuation">)</span>      <span class="token number">19</span>h
  kube<span class="token operator">-</span>system                kube<span class="token operator">-</span>proxy<span class="token operator">-</span>pj4wp               <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation">)</span>        <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation">)</span>      <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation">)</span>           <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation">)</span>         <span class="token number">19</span>h
Allocated resources<span class="token operator">:</span>
  <span class="token punctuation">(</span>Total limits may be over <span class="token number">100</span> percent<span class="token punctuation">,</span> i<span class="token punctuation">.</span>e<span class="token punctuation">.</span><span class="token punctuation">,</span> overcommitted<span class="token punctuation">.</span><span class="token punctuation">)</span>
  Resource           Requests    Limits
  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>           <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
  cpu                <span class="token number">600</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token number">30</span><span class="token operator">%</span><span class="token punctuation">)</span>  <span class="token number">1100</span><span class="token function">m</span> <span class="token punctuation">(</span><span class="token number">55</span><span class="token operator">%</span><span class="token punctuation">)</span>
  memory             <span class="token number">178</span><span class="token function">Mi</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token operator">%</span><span class="token punctuation">)</span>  <span class="token number">306</span><span class="token function">Mi</span> <span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">%</span><span class="token punctuation">)</span>
  ephemeral<span class="token operator">-</span>storage  <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation">)</span>      <span class="token number">0</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token operator">%</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="_108"></a>二、重启策略</h2> 
<ul><li>Pod在遇到故障之后重启的动作 
  <ul><li>1、Always：当容器终止退出后，总是重启容器，默认策略</li><li>2、OnFailure：当容器异常退出（退出状态码非0）时，重启容器；正常退出则不重启容器</li><li>3、Never：当容器终止退出，从不重启容器。</li><li>#注意：K8S 中不支持重启 Pod 资源，只有删除重建</li></ul> </li></ul> 
<pre><code class="prism language-javascript">vim pod3<span class="token punctuation">.</span>yaml
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> foo
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> busybox
    image<span class="token operator">:</span> busybox
    args<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh
    <span class="token operator">-</span> <span class="token operator">-</span>c
    <span class="token operator">-</span> sleep <span class="token number">30</span><span class="token punctuation">;</span> exit <span class="token number">3</span>

 kubectl apply <span class="token operator">-</span>f pod3<span class="token punctuation">.</span>yaml
<span class="token comment">//查看Pod状态，等容器启动后30秒后执行exit退出进程进入error状态，就会重启次数加1</span>
kubectl <span class="token keyword">get</span> pods
<span class="token constant">NAME</span>                              <span class="token constant">READY</span>   <span class="token constant">STATUS</span>             <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>
foo                               <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running            <span class="token number">1</span>          <span class="token number">50</span>s


kubectl <span class="token keyword">delete</span> <span class="token operator">-</span>f pod3<span class="token punctuation">.</span>yaml

vim pod3<span class="token punctuation">.</span>yaml
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> foo
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> busybox
    image<span class="token operator">:</span> busybox
    args<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh
    <span class="token operator">-</span> <span class="token operator">-</span>c
    <span class="token operator">-</span> sleep <span class="token number">30</span><span class="token punctuation">;</span> exit <span class="token number">3</span>
  restartPolicy<span class="token operator">:</span> Never
#注意：跟container同一个级别

kubectl apply <span class="token operator">-</span>f pod3<span class="token punctuation">.</span>yaml

<span class="token comment">//容器进入error状态不会进行重启</span>
kubectl <span class="token keyword">get</span> pods <span class="token operator">-</span>w
</code></pre> 
<p><img src="https://images2.imgbox.com/86/2b/I1XtcURo_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3d/4a/jiICsvuq_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="Probe_161"></a>三、健康检查：又称为探针（Probe）</h2> 
<pre><code class="prism language-javascript">探针是由kubelet对容器执行的定期诊断。

探针的三种规则：
livenessProbe ：判断容器是否正在运行。如果探测失败，则kubelet会杀死容器，并且容器将根据 restartPolicy 来设置 Pod 状态。如果容器不提供存活探针，则默认状态为Success。

readinessProbe ：判断容器是否准备好接受请求。如果探测失败，端点控制器将从与 Pod 匹配的所有 service endpoints 中剔除删除该Pod的<span class="token constant">IP</span>地址。初始延迟之前的就绪状态默认为Failure。如果容器不提供就绪探针，则默认状态为Success。

startupProbe（这个<span class="token number">1.17</span>版本增加的）：判断容器内的应用程序是否已启动，主要针对于不能确定具体启动时间的应用。如果配置了 startupProbe 探测，在则在 startupProbe 状态为 Success 之前，其他所有探针都处于无效状态，直到它成功后其他探针才起作用。 如果 startupProbe 失败，kubelet 将杀死容器，容器将根据 restartPolicy 来重启。如果容器没有配置 startupProbe， 则默认状态为 Success。
#注：以上规则可以同时定义。在readinessProbe检测成功之前，Pod的running状态是不会变成ready状态的。

Probe支持三种检查方法：
exec ：在容器内执行指定命令。如果命令退出时返回码为<span class="token number">0</span>则认为诊断成功。

tcpSocket ：对指定端口上的容器的<span class="token constant">IP</span>地址进行<span class="token constant">TCP</span>检查（三次握手）。如果端口打开，则诊断被认为是成功的。

httpGet ：对指定的端口和路径上的容器的<span class="token constant">IP</span>地址执行HTTPGet请求。如果响应的状态码大于等于<span class="token number">200</span>且小于<span class="token number">400</span>，则诊断被认为是成功的

每次探测都将获得以下三种结果之一：
成功：容器通过了诊断。
失败：容器未通过诊断。
未知：诊断失败，因此不会采取任何行动

官网示例：
https<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io<span class="token operator">/</span>docs<span class="token operator">/</span>tasks<span class="token operator">/</span>configure<span class="token operator">-</span>pod<span class="token operator">-</span>container<span class="token operator">/</span>configure<span class="token operator">-</span>liveness<span class="token operator">-</span>readiness<span class="token operator">-</span>startup<span class="token operator">-</span>probes<span class="token operator">/</span>
</code></pre> 
<pre><code class="prism language-javascript">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    test<span class="token operator">:</span> liveness
  name<span class="token operator">:</span> liveness<span class="token operator">-</span>exec
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> liveness
    image<span class="token operator">:</span> k8s<span class="token punctuation">.</span>gcr<span class="token punctuation">.</span>io<span class="token operator">/</span>busybox
    args<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token operator">/</span>bin<span class="token operator">/</span>sh
    <span class="token operator">-</span> <span class="token operator">-</span>c
    <span class="token operator">-</span> touch <span class="token operator">/</span>tmp<span class="token operator">/</span>healthy<span class="token punctuation">;</span> sleep <span class="token number">30</span><span class="token punctuation">;</span> rm <span class="token operator">-</span>rf <span class="token operator">/</span>tmp<span class="token operator">/</span>healthy<span class="token punctuation">;</span> sleep <span class="token number">60</span>
    livenessProbe<span class="token operator">:</span>
      exec<span class="token operator">:</span>
        command<span class="token operator">:</span>
        <span class="token operator">-</span> cat
        <span class="token operator">-</span> <span class="token operator">/</span>tmp<span class="token operator">/</span>healthy
      failureThreshold<span class="token operator">:</span> <span class="token number">1</span>
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">5</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">5</span>
</code></pre> 
<ul><li> <p>#initialDelaySeconds：指定 kubelet 在执行第一次探测前应该等待5秒，即第一次探测是在容器启动后的第6秒才开始执行。默认是 0 秒，最小值是 0。<br> #periodSeconds：指定了 kubelet 应该每 5 秒执行一次存活探测。默认是 10 秒。最小值是 1。</p> </li><li> <p>#failureThreshold: 当探测失败时，Kubernetes 将在放弃之前重试的次数。 存活探测情况下的放弃就意味着重新启动容器。就绪探测情况下的放弃 Pod 会被打上未就绪的标签。默认值是 3。最小值是 1。<br> #timeoutSeconds：探测的超时后等待多少秒。默认值是 1 秒。最小值是 1。（在 Kubernetes 1.20 版本之前，exec 探针会忽略 timeoutSeconds 探针会无限期地 持续运行，甚至可能超过所配置的限期，直到返回结果为止。）</p> </li><li> <p>可以看到 Pod 中只有一个容器。kubelet 在执行第一次探测前需要等待 5 秒，kubelet 会每 5 秒执行一次存活探测。kubelet 在容器内执行命令 cat /tmp/healthy 来进行探测。如果命令执行成功并且返回值为 0，kubelet 就会认为这个容器是健康存活的。 当到达第 31 秒时，这个命令返回非 0 值，kubelet 会杀死这个容器并重新启动它。</p> </li></ul> 
<pre><code class="prism language-javascript">vim exec<span class="token punctuation">.</span>yaml
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> liveness<span class="token operator">-</span>exec
  namespace<span class="token operator">:</span> <span class="token keyword">default</span>
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> liveness<span class="token operator">-</span>exec<span class="token operator">-</span>container
    image<span class="token operator">:</span> busybox
    imagePullPolicy<span class="token operator">:</span> IfNotPresent
    command<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span><span class="token string">"-c"</span><span class="token punctuation">,</span><span class="token string">"touch /tmp/live ; sleep 30; rm -rf /tmp/live; sleep 3600"</span><span class="token punctuation">]</span>
    livenessProbe<span class="token operator">:</span>
      exec<span class="token operator">:</span>
        command<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"test"</span><span class="token punctuation">,</span><span class="token string">"-e"</span><span class="token punctuation">,</span><span class="token string">"/tmp/live"</span><span class="token punctuation">]</span>
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">1</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">3</span>
	  
kubectl create <span class="token operator">-</span>f exec<span class="token punctuation">.</span>yaml

kubectl describe pods liveness<span class="token operator">-</span>exec
Events<span class="token operator">:</span>
  Type     Reason     Age               From               Message
  <span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span>              <span class="token operator">--</span><span class="token operator">--</span>               <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
  Normal   Scheduled  <span class="token number">51</span>s               <span class="token keyword">default</span><span class="token operator">-</span>scheduler  Successfully assigned <span class="token keyword">default</span><span class="token operator">/</span>liveness<span class="token operator">-</span>exec<span class="token operator">-</span>pod to node02
  Normal   Pulled     <span class="token number">46</span>s               kubelet<span class="token punctuation">,</span> node02    Container image <span class="token string">"busybox"</span> already present on machine
  Normal   Created    <span class="token number">46</span>s               kubelet<span class="token punctuation">,</span> node02    Created container liveness<span class="token operator">-</span>exec<span class="token operator">-</span>container
  Normal   Started    <span class="token number">45</span>s               kubelet<span class="token punctuation">,</span> node02    Started container liveness<span class="token operator">-</span>exec<span class="token operator">-</span>container
  Warning  Unhealthy  <span class="token number">8</span><span class="token function">s</span> <span class="token punctuation">(</span>x3 over <span class="token number">14</span>s<span class="token punctuation">)</span>  kubelet<span class="token punctuation">,</span> node02    Liveness probe failed<span class="token operator">:</span>
  Normal   Killing    <span class="token number">8</span>s                kubelet<span class="token punctuation">,</span> node02    Container liveness<span class="token operator">-</span>exec<span class="token operator">-</span>container failed liveness probe<span class="token punctuation">,</span>will be restarted

kubectl <span class="token keyword">get</span> pods <span class="token operator">-</span>w
<span class="token constant">NAME</span>                <span class="token constant">READY</span>   <span class="token constant">STATUS</span>    <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>
liveness<span class="token operator">-</span>exec       <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">1</span>          <span class="token number">85</span>s
</code></pre> 
<p><img src="https://images2.imgbox.com/58/b4/KbrSi0WT_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-javascript"><span class="token comment">//示例2：httpGet方式</span>
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  labels<span class="token operator">:</span>
    test<span class="token operator">:</span> liveness
  name<span class="token operator">:</span> liveness<span class="token operator">-</span>http
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> liveness
    image<span class="token operator">:</span> k8s<span class="token punctuation">.</span>gcr<span class="token punctuation">.</span>io<span class="token operator">/</span>liveness
    args<span class="token operator">:</span>
    <span class="token operator">-</span> <span class="token operator">/</span>server
    livenessProbe<span class="token operator">:</span>
      httpGet<span class="token operator">:</span>
        path<span class="token operator">:</span> <span class="token operator">/</span>healthz
        port<span class="token operator">:</span> <span class="token number">8080</span>
        httpHeaders<span class="token operator">:</span>
        <span class="token operator">-</span> name<span class="token operator">:</span> Custom<span class="token operator">-</span>Header
          value<span class="token operator">:</span> Awesome
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">3</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">3</span>

在这个配置文件中，可以看到 Pod 也只有一个容器。initialDelaySeconds 字段告诉 kubelet 在执行第一次探测前应该等待 <span class="token number">3</span> 秒。periodSeconds 字段指定了 kubelet 每隔 <span class="token number">3</span> 秒执行一次存活探测。kubelet 会向容器内运行的服务（服务会监听 <span class="token number">8080</span> 端口）发送一个 <span class="token constant">HTTP</span> <span class="token constant">GET</span> 请求来执行探测。如果服务器上 <span class="token operator">/</span>healthz 路径下的处理程序返回成功代码，则 kubelet 认为容器是健康存活的。如果处理程序返回失败代码，则 kubelet 会杀死这个容器并且重新启动它。

任何大于或等于 <span class="token number">200</span> 并且小于 <span class="token number">400</span> 的返回代码标示成功，其它返回代码都标示失败。
vim httpget<span class="token punctuation">.</span>yaml
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> liveness<span class="token operator">-</span>httpget
  namespace<span class="token operator">:</span> <span class="token keyword">default</span>
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> liveness<span class="token operator">-</span>httpget<span class="token operator">-</span>container
    image<span class="token operator">:</span> soscscs<span class="token operator">/</span>myapp<span class="token operator">:</span>v1
    imagePullPolicy<span class="token operator">:</span> IfNotPresent
    ports<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> http
      containerPort<span class="token operator">:</span> <span class="token number">80</span>
    livenessProbe<span class="token operator">:</span>
      httpGet<span class="token operator">:</span>
        port<span class="token operator">:</span> http
        path<span class="token operator">:</span> <span class="token operator">/</span>index<span class="token punctuation">.</span>html
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">1</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">3</span>
      timeoutSeconds<span class="token operator">:</span> <span class="token number">10</span>
	  
kubectl create <span class="token operator">-</span>f httpget<span class="token punctuation">.</span>yaml

kubectl exec <span class="token operator">-</span>it liveness<span class="token operator">-</span>httpget <span class="token operator">--</span> rm <span class="token operator">-</span>rf <span class="token operator">/</span>usr<span class="token operator">/</span>share<span class="token operator">/</span>nginx<span class="token operator">/</span>html<span class="token operator">/</span>index<span class="token punctuation">.</span>html

kubectl <span class="token keyword">get</span> pods
<span class="token constant">NAME</span>               <span class="token constant">READY</span>   <span class="token constant">STATUS</span>    <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>
liveness<span class="token operator">-</span>httpget   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">1</span>          <span class="token number">2</span>m44s
</code></pre> 
<pre><code class="prism language-javascript"><span class="token comment">//示例3：tcpSocket方式</span>
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> goproxy
  labels<span class="token operator">:</span>
    app<span class="token operator">:</span> goproxy
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> goproxy
    image<span class="token operator">:</span> k8s<span class="token punctuation">.</span>gcr<span class="token punctuation">.</span>io<span class="token operator">/</span>goproxy<span class="token operator">:</span><span class="token number">0.1</span>
    ports<span class="token operator">:</span>
    <span class="token operator">-</span> containerPort<span class="token operator">:</span> <span class="token number">8080</span>
    readinessProbe<span class="token operator">:</span>
      tcpSocket<span class="token operator">:</span>
        port<span class="token operator">:</span> <span class="token number">8080</span>
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">5</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">10</span>
    livenessProbe<span class="token operator">:</span>
      tcpSocket<span class="token operator">:</span>
        port<span class="token operator">:</span> <span class="token number">8080</span>
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">15</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">20</span>

这个例子同时使用 readinessProbe 和 livenessProbe 探测。kubelet 会在容器启动 <span class="token number">5</span> 秒后发送第一个 readinessProbe 探测。这会尝试连接 goproxy 容器的 <span class="token number">8080</span> 端口。如果探测成功，kubelet 将继续每隔 <span class="token number">10</span> 秒运行一次检测。除了 readinessProbe 探测，这个配置包括了一个 livenessProbe 探测。kubelet 会在容器启动 <span class="token number">15</span> 秒后进行第一次 livenessProbe 探测。就像 readinessProbe 探测一样，会尝试连接 goproxy 容器的 <span class="token number">8080</span> 端口。如果 livenessProbe 探测失败，这个容器会被重新启动。

vim tcpsocket<span class="token punctuation">.</span>yaml
apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> Pod
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> probe<span class="token operator">-</span>tcp
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> nginx
    image<span class="token operator">:</span> soscscs<span class="token operator">/</span>myapp<span class="token operator">:</span>v1
    livenessProbe<span class="token operator">:</span>
      initialDelaySeconds<span class="token operator">:</span> <span class="token number">5</span>
      timeoutSeconds<span class="token operator">:</span> <span class="token number">1</span>
      tcpSocket<span class="token operator">:</span>
        port<span class="token operator">:</span> <span class="token number">8080</span>
      periodSeconds<span class="token operator">:</span> <span class="token number">3</span>

kubectl create <span class="token operator">-</span>f tcpsocket<span class="token punctuation">.</span>yaml

kubectl exec <span class="token operator">-</span>it probe<span class="token operator">-</span>tcp  <span class="token operator">--</span> netstat <span class="token operator">-</span>natp
Active Internet <span class="token function">connections</span> <span class="token punctuation">(</span>servers and established<span class="token punctuation">)</span>
Proto Recv<span class="token operator">-</span><span class="token constant">Q</span> Send<span class="token operator">-</span><span class="token constant">Q</span> Local Address           Foreign Address         State       <span class="token constant">PID</span><span class="token operator">/</span>Program name    
tcp        <span class="token number">0</span>      <span class="token number">0</span> <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">:</span><span class="token number">80</span>              <span class="token number">0.0</span><span class="token number">.0</span><span class="token number">.0</span><span class="token operator">:</span><span class="token operator">*</span>               <span class="token constant">LISTEN</span>      <span class="token number">1</span><span class="token operator">/</span>nginx<span class="token operator">:</span> master pro

kubectl <span class="token keyword">get</span> pods <span class="token operator">-</span>w
<span class="token constant">NAME</span>        <span class="token constant">READY</span>   <span class="token constant">STATUS</span>    <span class="token constant">RESTARTS</span>   <span class="token constant">AGE</span>
probe<span class="token operator">-</span>tcp   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">0</span>          <span class="token number">4</span>s
probe<span class="token operator">-</span>tcp   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">1</span>          <span class="token number">14</span>s
probe<span class="token operator">-</span>tcp   <span class="token number">1</span><span class="token operator">/</span><span class="token number">1</span>     Running   <span class="token number">2</span>          <span class="token number">26</span>s
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0acb293e6542a904219e0fe6a646593f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">java多线程按照时间段切割视频流片段</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c31140ff24709cd966b121f0385d8e9f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">k8s中Pod重启方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>