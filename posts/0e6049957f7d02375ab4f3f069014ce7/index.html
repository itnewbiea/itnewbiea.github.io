<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MySQL优化第二篇 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MySQL优化第二篇" />
<meta property="og:description" content="MySQL优化第二篇 性能分析小表驱动大表慢查询日志日志分析工具mysqldumpslow Show Profile进行SQL分析（重中之重） 七种JOIN
1、inner join ：可以简写为join，表示的是交集，也就是两张表的共同数据
sql语句：select * from tbl_emp e inner join tbl_dept d on e.deptId=d.id
2、left join （左外连接）：从集合上看就是A 、B 的交集加上A的私有，即左表的所有数据加上 左右表中相交的数据
sql 语句：select * from tbl_emp e left join tbl_dept d on e.deptId=d.id
前七条共有数据；第八条a表独有数据，b表补null
3、right join（右外连接，全B）：前七条共有数据；第八条b表独有数据，a表补null
4、左join独A：就是A表独有的部分，在left join的基础上加上where条件
sql语句：select * from tbl_emp e left join tbl_dept d on e.deptId=d.id where d.id is null
5、右join独B：就是B表的独有部分，同理可知在right join的基础上加上where条件
6、full join （全外连接）：MySQL不支持使用full join 如果想要实现全A&#43;B可以使用union去重中间部分（union关键字可以合并 并且 去重）
sql语句：
select * from tbl_emp a left join tbl_dept b on a." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0e6049957f7d02375ab4f3f069014ce7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-09-14T12:32:34+08:00" />
<meta property="article:modified_time" content="2023-09-14T12:32:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MySQL优化第二篇</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>MySQL优化第二篇</h4> 
 <ul><li><ul><li><a href="#_54" rel="nofollow">性能分析</a></li><li><a href="#_63" rel="nofollow">小表驱动大表</a></li><li><ul><li><a href="#_92" rel="nofollow">慢查询日志</a></li><li><a href="#mysqldumpslow_129" rel="nofollow">日志分析工具mysqldumpslow</a></li></ul> 
   </li><li><a href="#Show_ProfileSQL_165" rel="nofollow">Show Profile进行SQL分析（重中之重）</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p><strong>七种JOIN</strong></p> 
<p>1、inner join ：可以简写为join，表示的是交集，也就是两张表的共同数据</p> 
<p>sql语句：<strong>select * from tbl_emp e inner join tbl_dept d on e.deptId=d.id</strong><br> <img src="https://images2.imgbox.com/59/d1/AAEZ6qyY_o.png" alt="在这里插入图片描述"></p> 
<p>2、left join （左外连接）：从集合上看就是A 、B 的交集加上A的私有，即左表的所有数据加上 左右表中相交的数据</p> 
<p>sql 语句：<strong>select * from tbl_emp e left join tbl_dept d on e.deptId=d.id</strong></p> 
<p><img src="https://images2.imgbox.com/b2/6c/UADb8zyc_o.png" alt="在这里插入图片描述"></p> 
<p>前七条共有数据；第八条a表独有数据，b表补null</p> 
<p>3、right join（右外连接，全B）：前七条共有数据；第八条b表独有数据，a表补null</p> 
<p>4、左join独A：就是A表独有的部分，在left join的基础上加上where条件</p> 
<p>sql语句：<strong>select * from tbl_emp e left join tbl_dept d on e.deptId=d.id where d.id is null</strong></p> 
<p><img src="https://images2.imgbox.com/73/31/0lYqkD81_o.png" alt="在这里插入图片描述"></p> 
<p>5、右join独B：就是B表的独有部分，同理可知在right join的基础上加上where条件</p> 
<p>6、full join （全外连接）：MySQL不支持使用full join 如果想要实现全A+B可以使用union去重中间部分（<strong>union关键字可以合并 并且 去重</strong>）</p> 
<p>sql语句：</p> 
<p><strong>select * from tbl_emp a left join tbl_dept b on a.deptId=b.id</strong><br> <strong>union</strong><br> <strong>select * from tbl_emp a right join tbl_dept b on a.deptId=b.id</strong></p> 
<p><img src="https://images2.imgbox.com/07/c0/B409zR6s_o.png" alt="在这里插入图片描述"></p> 
<p>7、A、B各自独有集合</p> 
<p><strong>select * from tbl_emp a left join tbl_dept b on a.deptId=b.id where b.id is null</strong><br> <strong>union</strong><br> <strong>select * from tbl_emp a right join tbl_dept b on a.deptId=b.id where a.deptId is null</strong></p> 
<p><img src="https://images2.imgbox.com/f2/c7/i15nMjxS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_54"></a>性能分析</h3> 
<p>MySQL Query Optimizer（查询优化器）[ˈkwɪəri] [ˈɒptɪmaɪzə]<br> Mysql中专门负责优化SELECT语句的优化器模块，主要功能：通过计算分析系统中收集到的统计信息，为客户端请求的Query提供他认为最优的执行计划（他认为最优的数据检索方式，但不见得是DBA认为是最优的,这部分最耗费时间）</p> 
<p>当客户端向MySQL请求一条Query，命令解析器模块完成请求分类，区别出是SELECT并转发给MySQL Query Optimizer时，MySQL Query Optimizer首先会对整条Query进行优化，处理掉一些常量表达式的预算直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析Query 中的 Hint信息(如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果没有Hint 或Hint信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划</p> 
<h3><a id="_63"></a>小表驱动大表</h3> 
<p><strong>exists语法</strong>：SELECT * FROM table WHERE EXISTS (subquery)</p> 
<p>该语法可以理解为：<strong>将主查询的数据，放到子查询中做条件验证，根据验证结果（TRUE或FALSE）来决定主查询的数据结果是否得以保留</strong></p> 
<p>优化原则：</p> 
<p>小表驱动大表，即小的数据集驱动大的数据集</p> 
<p>就比如大表是A 小表是B</p> 
<p>1、当B表的数据集必须小于A表的数据集的时候，用in会比用exists好</p> 
<p>2、当A表的数据集是小于B表的数据集的时候，用exists会比较好</p> 
<p><strong>重点：A表与B表的id字段应该建立索引</strong></p> 
<p>in和exists的用法</p> 
<p>sql语句：</p> 
<p><strong>select * from tbl_emp e where e.deptId in (select id from tbl_dept d)</strong></p> 
<p><strong>select * from tbl_emp e where EXISTS (select 1 from tbl_dept d where e.deptId=d.id)</strong></p> 
<p><img src="https://images2.imgbox.com/47/a9/Ci8pknkG_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_92"></a>慢查询日志</h4> 
<p>MySQL的慢查询日志是MySQL提供的一种<strong>日志记录</strong>，它用来记录在MySQL中响应时间<strong>超过阀值的语句</strong>，**具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。long_query_time的默认值为10，意思是运行10秒以上的语句。由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql <strong>结合之前explain进行全面分析</strong></p> 
<p><strong>操作说明:</strong></p> 
<p>默认情况下，MySQL数据库没有开启慢查询日速，需要我们<strong>手动来设置这个参数</strong>。</p> 
<p>但是开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件。</p> 
<p><strong>查看是否开启以及如何开启慢查询</strong>：</p> 
<p>默认： <strong>SHOW VARIABLES LIKE ‘%slow_query_log%’;</strong></p> 
<p>开启：<strong>set global slow_query_log=1;</strong>，只对当前数据库生效，如果MySQL重启后则会失效</p> 
<p>永久开启：就必须修改配置文件my.cnf文件，将下面两行的数据配置进文件中</p> 
<p><strong>slow_query_log =1</strong><br> <strong>slow_query_log_file=/var/lib/mysqatguigu-slow.log</strong></p> 
<p><strong>重点：<strong>关于慢查询的参数</strong>slow_query_log_file</strong>，它指定慢查询日志文件的<strong>存放路径</strong>，系统默认会给一个缺省的文件host_name-slow.log（<strong>如果没有指定参数slow_query_log_file的话</strong>）</p> 
<p>查看慢sql阈值时间：即查看<strong>long_query_time</strong>的值。</p> 
<p>查看命令是：<strong>SHOW VARIABLES LIKE ‘long_query_time%’;</strong></p> 
<p>修改命令是：<strong>set global long_query_time=3;</strong></p> 
<p>查询当前有多少慢查询sql：<strong>show global status like ‘%Slow_queries%’</strong></p> 
<p><strong>重点：如果显示修改无效的话可以重开一个连接，或者换一个语句：show global variables like ‘long_query_time’;</strong></p> 
<h4><a id="mysqldumpslow_129"></a>日志分析工具mysqldumpslow</h4> 
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，是非常复杂且麻烦的，MySQL提供了日志分析工具<strong>mysqldumpslow</strong>。</p> 
<p>查看<strong>mysqldumpslow</strong>的帮助信息，<strong>mysqldumpslow --help</strong>。</p> 
<p>常用<strong>mysqldumpslow</strong>帮助信息：</p> 
<p><strong>s</strong>是表示按照何种方式排序<br> <strong>c</strong>访问次数<br> <strong>l</strong>锁定时间<br> <strong>r</strong>返回记录<br> <strong>t</strong>查询时间<br> <strong>al</strong>平均锁定时间<br> <strong>ar</strong>平均返回记录数<br> <strong>at</strong>平均查询时间<br> <strong>t</strong>即为返回前面多少条的数据<br> <strong>g</strong>后边搭配一个正则匹配模式，大小写不敏感的</p> 
<p><strong>常用举例：</strong></p> 
<p>得到返回记录集最多的10个SQL：</p> 
<p><strong>mysqldumpslow -s r -t 10 /var/lib/mysql/atguigu-slow.log</strong><br> 得到访问次数最多的10个SQL：</p> 
<p><strong>mysqldumpslow -s c -t 10 /var/lib/mysql/atguigu-slow.log</strong><br> 得到按照时间排序的前10条里面含有左连接的查询语句：</p> 
<p><strong>mysqldumpslow -s t -t 10 -g “left join” /var/lib/mysql/atguigu-slow.log</strong><br> 另外建议在使用这些命令时结合│和more 使用，否则有可能出现爆屏情况：</p> 
<p><strong>mysqldumpslow -s r-t 10 /ar/lib/mysql/atguigu-slow.log | more</strong></p> 
<h3><a id="Show_ProfileSQL_165"></a>Show Profile进行SQL分析（重中之重）</h3> 
<p>Show Profile是mysql提供可以用来<strong>分析当前会话中语句执行的资源消耗情况</strong>。可以用于SQL的调优的测量</p> 
<p>使用步骤：</p> 
<p>1、查看当前mysql是否支持：**show variables like 'profiling;**或者 <strong>show variables like ‘profiling %’;</strong></p> 
<p>2、开启这个功能（因为默认是关闭的，所以需要手动开启）：<strong>set profiling=on;</strong></p> 
<p>3、运行SQL</p> 
<p>4、查看结果：<strong>show profiles;</strong></p> 
<p>5、诊断SQL，<strong>show profile cpu,block io for query ID号;（ID号为第4步Query_ID列中数字）</strong></p> 
<p><strong>参数信息说明：</strong></p> 
<p><strong>ALL</strong>显示所有的开销信息。<br> <strong>BLOCK IO</strong>显示块lO相关开销。<br> **CONTEXT SWITCHES **上下文切换相关开销。<br> <strong>CPU</strong>显示CPU相关开销信息。<br> <strong>IPC</strong>显示发送和接收相关开销信息。<br> <strong>MEMORY</strong>显示内存相关开销信息。<br> <strong>PAGE FAULTS</strong>显示页面错误相关开销信息。<br> <strong>SOURCE</strong>显示和Source_function，Source_file，Source_line相关的开销信息。<br> <strong>SWAPS</strong>显示交换次数相关开销的信息。</p> 
<p><strong>Status列显示结果表示严重问题的有</strong></p> 
<ul><li><strong>converting HEAP to MyISAM</strong>查询结果太大，内存都不够用了往磁盘上搬了。</li><li><strong>Creating tmp table</strong>创建临时表，拷贝数据到临时表，用完再删除</li><li><strong>Copying to tmp table on disk</strong>把内存中临时表复制到磁盘，危险!</li><li><strong>locked</strong>锁了</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d31f6ddc08806a8cea1f2e44d0426d61/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">高通 Android 12 framework添加自定义按键上报应用层</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7ccc701e7f3ac6e931dc31ba47231a06/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">解决java.nio.file.AccessDeniedException: Permission denied</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>