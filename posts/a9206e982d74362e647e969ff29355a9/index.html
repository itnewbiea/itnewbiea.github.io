<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>找到Qt程序长时间运行崩溃原因的方法--Dump（DMP）文件 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="找到Qt程序长时间运行崩溃原因的方法--Dump（DMP）文件" />
<meta property="og:description" content="最近遇到一个问题，使用vs&#43;Qt开发应用程序，在本地测试正常，但在别人的机器上（windows平台）运行了一段时间（大概五天）崩溃了。所以这个时候我们应该怎样调试并找到程序崩溃的原因呢？发布的应用程序使用的是release版本。release版本是比较难调试的，因为缺少很多调试信息，在VC/VS中我们可以通过生成DMP &#43; PDB进行源码级定位，使用这种方法，当程序在别人电脑上出现异常或者崩溃的时候，会生成DMP文件，然后把该文件拷贝到自己的开发机器上，配合pdb文件调试就可以找到错误的位置，直接把问题定位到源代码中的位置。
本文参考了其它博主的博客，比如：
《vs2010 利用DMP文件、pdb文件查找release下的异常行号的方法》https://blog.csdn.net/itworld123/article/details/79041500
《让程序在崩溃时体面的退出之Dump文件》https://blog.csdn.net/starlee/article/details/6630816
感谢这两位博主的博客，本文在这两篇博客的基础上将代码作了一点改动，使得vs&#43;Qt开发windows应用程序一样可以使用这种方法进行定位调试。下面以开发环境为win7&#43;vs2015&#43;Qt5.9.0为例，介绍这个方法：
一、代码 使用vs（演示用的是vs2015）创建一个Qt工程，往工程里添加main.cpp、dmp3b.cpp、dmp3b.h三个文件。三个文件的代码分别如下图所示：
main.cpp
#include &#34;dmp3b.h&#34; #include &lt;QtWidgets/QApplication&gt; #include &lt;windows.h&gt; #include &lt;DbgHelp.h&gt; #pragma comment(lib,&#34;Dbghelp.lib&#34;) long __stdcall CrashInfocallback(_EXCEPTION_POINTERS *pexcp) { //创建 Dump 文件 HANDLE hDumpFile = ::CreateFile( L&#34;MEMORY.DMP&#34;, GENERIC_WRITE, 0, NULL, CREATE_ALWAYS, FILE_ATTRIBUTE_NORMAL, NULL ); if (hDumpFile != INVALID_HANDLE_VALUE) { //Dump信息 MINIDUMP_EXCEPTION_INFORMATION dumpInfo; dumpInfo.ExceptionPointers = pexcp; dumpInfo.ThreadId = GetCurrentThreadId(); dumpInfo.ClientPointers = TRUE; //写入Dump文件内容 ::MiniDumpWriteDump( GetCurrentProcess(), GetCurrentProcessId(), hDumpFile, MiniDumpNormal, &amp;dumpInfo, NULL, NULL ); } return 0; } int main(int argc, char *argv[]) { ::SetUnhandledExceptionFilter((LPTOP_LEVEL_EXCEPTION_FILTER)CrashInfocallback); QApplication a(argc, argv); DMP3B w; //w." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a9206e982d74362e647e969ff29355a9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-08-25T01:04:17+08:00" />
<meta property="article:modified_time" content="2018-08-25T01:04:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">找到Qt程序长时间运行崩溃原因的方法--Dump（DMP）文件</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>  最近遇到一个问题，使用vs+Qt开发应用程序，在本地测试正常，但在别人的机器上（windows平台）运行了一段时间（大概五天）崩溃了。所以这个时候我们应该怎样调试并找到程序崩溃的原因呢？发布的应用程序使用的是release版本。release版本是比较难调试的，因为缺少很多调试信息，在VC/VS中我们可以通过生成DMP + PDB进行源码级定位，使用这种方法，当程序在别人电脑上出现异常或者崩溃的时候，会生成DMP文件，然后把该文件拷贝到自己的开发机器上，配合pdb文件调试就可以找到错误的位置，直接把问题定位到源代码中的位置。</p> 
<p>  本文参考了其它博主的博客，比如：</p> 
<p>《vs2010 利用DMP文件、pdb文件查找release下的异常行号的方法》<a href="https://blog.csdn.net/itworld123/article/details/79041500">https://blog.csdn.net/itworld123/article/details/79041500</a></p> 
<p>《让程序在崩溃时体面的退出之Dump文件》<a href="https://blog.csdn.net/starlee/article/details/6630816">https://blog.csdn.net/starlee/article/details/6630816</a></p> 
<p>感谢这两位博主的博客，本文在这两篇博客的基础上将代码作了一点改动，使得vs+Qt开发windows应用程序一样可以使用这种方法进行定位调试。下面以开发环境为win7+vs2015+Qt5.9.0为例，介绍这个方法：</p> 
<h4>一、代码</h4> 
<p>  使用vs（演示用的是vs2015）创建一个Qt工程，往工程里添加main.cpp、dmp3b.cpp、dmp3b.h三个文件。三个文件的代码分别如下图所示：</p> 
<p><span style="color:#3399ea;">main.cpp</span></p> 
<pre class="has"><code class="language-cpp">#include "dmp3b.h"
#include &lt;QtWidgets/QApplication&gt;
#include &lt;windows.h&gt;
#include &lt;DbgHelp.h&gt;
#pragma comment(lib,"Dbghelp.lib")

long  __stdcall CrashInfocallback(_EXCEPTION_POINTERS *pexcp)
{
	//创建 Dump 文件
	HANDLE hDumpFile = ::CreateFile(
		L"MEMORY.DMP",
		GENERIC_WRITE,
		0,
		NULL,
		CREATE_ALWAYS,
		FILE_ATTRIBUTE_NORMAL,
		NULL
	);
	if (hDumpFile != INVALID_HANDLE_VALUE)
	{
		//Dump信息
		MINIDUMP_EXCEPTION_INFORMATION dumpInfo;
		dumpInfo.ExceptionPointers = pexcp;
		dumpInfo.ThreadId = GetCurrentThreadId();
		dumpInfo.ClientPointers = TRUE;
		//写入Dump文件内容
		::MiniDumpWriteDump(
			GetCurrentProcess(),
			GetCurrentProcessId(),
			hDumpFile,
			MiniDumpNormal,
			&amp;dumpInfo,
			NULL,
			NULL
		);
	}
	return 0;
}

int main(int argc, char *argv[])
{
	::SetUnhandledExceptionFilter((LPTOP_LEVEL_EXCEPTION_FILTER)CrashInfocallback);
	QApplication a(argc, argv);
	DMP3B w;
	//w.show();
	return a.exec();
}
</code></pre> 
<p> </p> 
<p><span style="color:#3399ea;">dmp3b.cpp</span></p> 
<pre class="has"><code class="language-cpp">#include "dmp3b.h"
#include &lt;QThread&gt;

class CrashTest
{
public:
	void Test()
	{
		Crash();
	}

private:
	void Crash()
	{
		int i = 13;
		int j = 0;
		int m = i / j;
		printf("m=%d\n", m);
	}
};

DMP3B::DMP3B(QWidget *parent)
	: QMainWindow(parent)
{
	ui.setupUi(this);
	this-&gt;show();
	QThread::msleep(5000);
	CrashTest test;
	test.Test();
}
</code></pre> 
<p> </p> 
<p><span style="color:#3399ea;">dmp3b.h</span></p> 
<pre class="has"><code class="language-cpp">#pragma once

#include &lt;QtWidgets/QMainWindow&gt;
#include "ui_dmp3b.h"

class DMP3B : public QMainWindow
{
	Q_OBJECT

public:
	DMP3B(QWidget *parent = Q_NULLPTR);

private:
	Ui::DMP3BClass ui;
};
</code></pre> 
<p> </p> 
<h4>二、运行效果</h4> 
<p>  将上述代码在vs编译，运行。界面上会出现一个窗口，5秒后，由于执行了语句int m = i / j; （j的值为0）程序会崩溃，如下图所示，然后工程目录下（或者exe文件所在目录下）会出现一个MEMORY.DMP文件。</p> 
<p><img alt="" class="has" height="440" src="https://images2.imgbox.com/2a/12/am2Eeay9_o.png" width="615"></p> 
<p> </p> 
<h4>三、使用DMP文件调试，定位找到崩溃原因</h4> 
<p>  将DMP文件复制到自己开发用的电脑对应的exe文件和pdb文件所在的目录下，如下图所示：</p> 
<p><img alt="" class="has" height="231" src="https://images2.imgbox.com/a8/1f/Xy6TWzon_o.png" width="361"></p> 
<p> </p> 
<p>鼠标左键双击DMP文件，如果电脑上装了vs，则会出现下图页面：</p> 
<p><img alt="" class="has" height="527" src="https://images2.imgbox.com/f4/27/8GnGqFPn_o.png" width="985"></p> 
<p> </p> 
<p>鼠标左键单击“使用仅限本机进行调试”。可以看到如下图所示，定位到语句int m = i/j;找到程序崩溃的问题。</p> 
<p><img alt="" class="has" height="613" src="https://images2.imgbox.com/10/4a/icyuqmNQ_o.png" width="505"></p> 
<p> </p> 
<h4>四、vs的设置</h4> 
<p>  要想实现上述功能，首先vs得经过一些设置，否则可能无法正常生成或者使用DMP文件。</p> 
<p>（一）：属性页-&gt;链接器-&gt;调试-&gt;生成调试信息，这里得选true（默认值是false），如下图所示。如果没有选true，可能不会生成pdb文件</p> 
<p><img alt="" class="has" height="694" src="https://images2.imgbox.com/78/44/oATBXRvj_o.png" width="1105"></p> 
<p> </p> 
<p>（二）：属性页-&gt;C/C++-&gt;常规-&gt;调试信息格式，这里得选“程序数据库(/Zi)”，如下图所示。否则双击打开DMP文件时，可能会显示“无可用源，此模块的调试信息中缺少源信息”，无法定位到源代码中的错误。</p> 
<p><img alt="" class="has" height="699" src="https://images2.imgbox.com/06/cb/BTF5Dr4r_o.png" width="1106"></p> 
<p> </p> 
<p>（三）：属性页-&gt;C/C++-&gt;优化-&gt;优化，这里得选“已禁用(/Od)”，如下图所示。否则双击打开DMP文件时，可能无法准确定位错误，或者定位到错误所在的函数外面</p> 
<p><img alt="" class="has" height="702" src="https://images2.imgbox.com/65/8e/pUeHTuae_o.png" width="1107"></p> 
<p> </p> 
<h4>五、其它注意事项</h4> 
<p>  （一）使用DMP文件和pdb文件调试时DMP、exe和pdb三个文件要保持版本一致。也就是说，如果你运行exe文件，程序崩溃，生成DMP文件后，此时你再重新编译程序，重新生成了exe文件和pdb文件。即使源码没有发生任何改动，你双击DMP文件也是没有办法再定位到源代码中的错误了。所以你得及时把exe文件和pdb文件做好备份。</p> 
<p>  （二）有些时候即使程序崩溃了也是没有办法生成DMP文件的，比如有时数组越界导致程序崩溃的时候。所以这个方法也不能保证一定能找到程序崩溃的原因，所以大家得掌握更多的调试手段。</p> 
<p> </p> 
<h4>六、总结</h4> 
<p>  windows平台下生成DMP文件是一种很重要的调试方法，可以帮助我们更好更快地定位程序崩溃的问题。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/bc67d0204c935acf567dc4ea482c82d3/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">通道突破</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/fc543e0374c5f9c81d0a3d66dce4a02c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">编译安装PHP7及扩展</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>