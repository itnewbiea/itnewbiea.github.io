<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>c#如何采集需要登录的页面 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="c#如何采集需要登录的页面" />
<meta property="og:description" content="首先说明：代码片段是从网络获取，然后自己修改。我想好的东西应该拿来分享。
先说下原理：当我们采集页面的时候，如果被采集的网站需要登录才能采集。不管是基于Cookie还是基于Session，我们都会首先发送一个Http请求头，这个Http请求头里面就包含了网站需要的Cookie信息。当网站接收到发送过来的Http请求头时，会从Http请求头获取相关的Cookie或者Session信息，然后由程序来处理，决定你是否有权限访问当前页面。
好了，原理搞清楚了，就好办了。我们所要做的仅仅是在采集的时候（或者说HttpWebRequest提交数据的时候），将Cookie信息放入Http请求头里面就可以了。
在这里我提供2种方法。
第一种，直接将Cookie信息放入HttpWebRequest的CookieContainer里。看代码：
protected void Page_Load(object sender, EventArgs e)
{
//设置Cookie，存入Hashtable
Hashtable ht = new Hashtable();
ht.Add(&#34;username&#34;, &#34;youraccount&#34;);
ht.Add(&#34;id&#34;, &#34;yourid&#34;);
this.Collect(ht);
}
public void Collect(Hashtable ht)
{
string content = string.Empty;
string url = &#34;http://www.ibest100.com/需要登录后才能采集的页面&#34;;
string host = &#34;http://www.ibest100.com&#34;;
try
{
//获取提交的字节
byte[] bs = Encoding.UTF8.GetBytes(content);
//设置提交的相关参数
HttpWebRequest req = (HttpWebRequest)HttpWebRequest.Create(url);
req.Method = &#34;POST&#34;;
req.ContentType = &#34;application/json;charset=utf-8&#34;;
req.ContentLength = bs.Length;
//将Cookie放入CookieContainer，然后再将CookieContainer添加到HttpWebRequest
CookieContainer cc = new CookieContainer();
cc.Add(new Uri(host), new Cookie(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/588ad0d465c4904a0a813d6ce4c84dcb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-02-28T11:10:00+08:00" />
<meta property="article:modified_time" content="2016-02-28T11:10:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">c#如何采集需要登录的页面</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div id="cnblogs_post_body" class="blogpost-body"> 
 <div id="articleContentLeft"> 
  <p>首先说明：代码片段是从网络获取，然后自己修改。我想好的东西应该拿来分享。</p> 
  <p>先说下原理：当我们采集页面的时候，如果被采集的网站需要登录才能采集。不管是基于Cookie还是基于Session，我们都会首先发送一个Http请求头，这个Http请求头里面就包含了网站需要的Cookie信息。当网站接收到发送过来的Http请求头时，会从Http请求头获取相关的Cookie或者Session信息，然后由程序来处理，决定你是否有权限访问当前页面。</p> 
  <p>好了，原理搞清楚了，就好办了。我们所要做的仅仅是在采集的时候（或者说HttpWebRequest提交数据的时候），将Cookie信息放入Http请求头里面就可以了。</p> 
  <p>在这里我提供2种方法。</p> 
  <p>第一种，直接将Cookie信息放入HttpWebRequest的CookieContainer里。看代码：</p> 
  <p>protected void Page_Load(object sender, EventArgs e)<br>        {<!-- --><br>            //设置Cookie，存入Hashtable<br>            Hashtable ht = new Hashtable();<br>            ht.Add("username", "youraccount");<br>            ht.Add("id", "yourid");<br>            this.Collect(ht);<br>        }<br>        public void Collect(Hashtable ht)<br>        {<!-- --><br>            string content = string.Empty;<br>            string url = "http://www.ibest100.com/需要登录后才能采集的页面";<br>            string host = "http://www.ibest100.com";<br>            try<br>            {<!-- --><br>                //获取提交的字节<br>                byte[] bs = Encoding.UTF8.GetBytes(content);<br>                //设置提交的相关参数<br>                HttpWebRequest req = (HttpWebRequest)HttpWebRequest.Create(url);<br>                req.Method = "POST";<br>                req.ContentType = "application/json;charset=utf-8";<br>                req.ContentLength = bs.Length;<br>                //将Cookie放入CookieContainer，然后再将CookieContainer添加到HttpWebRequest<br>                CookieContainer cc = new CookieContainer();<br>                cc.Add(new Uri(host), new Cookie("username", ht["username"].ToString()));<br>                cc.Add(new Uri(host), new Cookie("id", ht["id"].ToString()));<br>                req.CookieContainer = cc;<br>                //提交请求数据<br>                Stream reqStream = req.GetRequestStream();<br>                reqStream.Write(bs, 0, bs.Length);<br>                reqStream.Close();<br>                //接收返回的页面，必须的，不能省略<br>                WebResponse wr = req.GetResponse();<br>                System.IO.Stream respStream = wr.GetResponseStream();<br>                System.IO.StreamReader reader = new System.IO.StreamReader(respStream, System.Text.Encoding.GetEncoding("utf-8"));<br>                string t = reader.ReadToEnd();<br>                System.Web.HttpContext.Current.Response.Write(t);<br>                wr.Close();<br>            }<br>            catch (Exception ex)<br>            {<!-- --><br>                System.Web.HttpContext.Current.Response.Write("异常在getPostRespone:" + ex.Source + ":" + ex.Message);<br>            }</p> 
  <p>        }</p> 
  <p>第二种，每次打开采集程序时，需要先到被采集的网站模拟登录一次，获取CookieContainer，然后再采集。看代码：</p> 
  <p>protected void Page_Load(object sender, EventArgs e)<br>        {<!-- --><br>            try<br>            {<!-- --><br>                CookieContainer cookieContainer = new CookieContainer();<br>                string formatString = "username={0}&amp;password={1}";//***************<br>                string postString = string.Format(formatString, "youradminaccount", "yourpassword");<br>                //将提交的字符串数据转换成字节数组<br>                byte[] postData = Encoding.UTF8.GetBytes(postString);<br>                //设置提交的相关参数<br>                string URI = "http://www.ibest100.com/登录页面";//***************<br>                HttpWebRequest request = WebRequest.Create(URI) as HttpWebRequest;<br>                request.Method = "POST";<br>                request.KeepAlive = false;<br>                request.ContentType = "application/x-www-form-urlencoded";<br>                request.CookieContainer = cookieContainer;<br>                request.ContentLength = postData.Length;<br>                // 提交请求数据<br>                System.IO.Stream outputStream = request.GetRequestStream();<br>                outputStream.Write(postData, 0, postData.Length);<br>                outputStream.Close();<br>                //接收返回的页面，必须的，不能省略<br>                HttpWebResponse response = request.GetResponse() as HttpWebResponse;<br>                System.IO.Stream responseStream = response.GetResponseStream();<br>                System.IO.StreamReader reader = new System.IO.StreamReader(responseStream, Encoding.GetEncoding("gb2312"));<br>                string srcString = reader.ReadToEnd();<br>                //打开您要访问的页面<br>                URI = "http://www.ibest100.com/需要登录后才能采集的页面";//***************<br>                request = WebRequest.Create(URI) as HttpWebRequest;<br>                request.Method = "GET";<br>                request.KeepAlive = false;<br>                request.CookieContainer = cookieContainer;<br>                // 接收返回的页面<br>                response = request.GetResponse() as HttpWebResponse;<br>                responseStream = response.GetResponseStream();<br>                reader = new System.IO.StreamReader(responseStream, Encoding.GetEncoding("gb2312"));<br>                srcString = reader.ReadToEnd();<br>                //输出获取的页面或者处理<br>                Response.Write(srcString);<br>            }<br>            catch (WebException we)<br>            {<!-- --><br>                string msg = we.Message;<br>                Response.Write(msg);<br>            }<br>        }</p> 
  <p>也许有人会问，如果对方登录的时候要验证码怎么办？那你就用第一种方式吧，只不过需要你分析对方的Cookie。</p> 
  <p>应用范围：采集数据、论坛发帖、博客发文。</p> 
  <p>感谢来自网络 的文章 编辑:dezai</p> 
 </div> 
 <div>
   转载自: 
  <a href="http://www.aspnetjia.com/" rel="nofollow">http://www.aspnetjia.com</a> 
 </div> 
</div> 
<p>转载于:https://www.cnblogs.com/aspnetjia/p/5224276.html</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2567d9838cac1b169a38999e1f5e8f92/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java（多）线程中注入Spring的Bean</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4853d987075629ccd59831be39183b0c/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python制作报表</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>