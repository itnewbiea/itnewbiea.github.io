<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ansible的脚本——playbook 剧本 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ansible的脚本——playbook 剧本" />
<meta property="og:description" content="Ansible的脚本——playbook 剧本 一、playbook 剧本概述1、playbook介绍2、playbook格式3、playbooks本身由以下各部分组成4、yaml基本语法规则5、yaml支持的数据结构 二、示例:1、运行playbook2、定义、引用变量3、指定远程主机sudo切换用户4、when条件判断5、迭代6、Templates 模块（1）先准备一个以.j2 为后缀的template 模板文件，设置引用的变量（2）修改主机清单文件（3）编写playbook 7、tags模块8、Roles模块（1）roles 的目录结构（2）roles 内各目录含义解释（3）在一个playbook 中使用roles 的步骤 三、示例1、编写httpd模块2、编写mysql模块3、编写php模块-4、编写roles示例 四、编写httpd的playbook 一、playbook 剧本概述 1、playbook介绍 playbook是ansible用于配置，部署，和管理被控节点的剧本。通过playbook的详细描述，执行其中的tasks，可以让远端主机达到预期的状态。playbook是由一个或多个”play”组成的列表。 当对一台机器做环境初始化的时候往往需要不止做一件事情，这时使用playbook会更加适合。通过playbook你可以一次在多台机器执行多个指令。通过这种预先设计的配置保持了机器的配置统一，并很简单的执行日常任务。
ansible通过不同的模块实现相应的管理，管理的方式通过定义的清单文件(hosts)所管理的主机包括认证的方式连接的端口等。所有的功能都是通过调用不同的模块(modules)来完成不同的功能的。不管是执行单条命令还是play-book都是基于清单文件。
2、playbook格式 playbook由YMAL语言编写。YMAL格式是类似于JSON的文件格式，便于人理解和阅读，同时便于书写。一个剧本里面可以有多个play，每个play只能有一个tasks，每个tasks可以有多个name。通过 task 调用 ansible 的模块将多个 play 组织在一 个playbook中运行。 3、playbooks本身由以下各部分组成 Tasks任务，即通过task 调用ansible 的模板将多个操作组织在一 个playbook 中运行Variables变量Templates模板Handlers处理器，当changed状态 条件满足时，(notify) 触发执行的操作Roles角色 4、yaml基本语法规则 1、大小写敏感
2、使用缩进表示层级关系
3、缩进时不允许使用tab键、只允许使用空格
4、缩进的空格数目不重要，只要相同层级的元素左侧对齐即可
hosts定义节点，可以是组remote_user是你以什么用户身份进行登陆tasks是你的任务become:yes表示切换用户become_user: mysql表示切换到mysql用户，配合上一条使用- name:为下面执行的操作起名 5、yaml支持的数据结构 1、对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes）/ 字典（dictionary）
2、数组：一组按次序排列的值，又称为序列（sequence）/ 列表（list）
3、纯量：单个的、不可再分的值
二、示例: vim test1.yaml --- #yaml文件以---开头，以表明这是一个yaml文件，可省略 - name: first play #定义一个play的名称，可省略 gather_facts: false #设置不进行facts信息收集，这可以加快执行速度，可省略 hosts: webservers #指定要执行任务的被管理主机组，如多个主机组用冒号分隔 remote_user: root #指定被管理主机上执行任务的用户 tasks: #定义任务列表，任务列表中的各任务按次序逐个在hosts中指定的主机上执行 - name: test connection #自定义任务名称 ping: #使用 module: [options] 格式来定义一个任务 - name: disable selinux command: &#39;/sbin/setenforce 0&#39; #command模块和shell模块无需使用key=value格式 ignore_errors: True #如执行命令的返回值不为0，就会报错，tasks停止，可使用ignore_errors忽略失败的任务 - name: disable firewalld service: name=firewalld state=stopped #使用 module: options 格式来定义任务，option使用key=value格式 - name: install httpd yum: name=httpd state=latest - name: install configuration file for httpd copy: src=/opt/httpd." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4ad17940d454e3bbead251751129ed8c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-08-09T00:14:23+08:00" />
<meta property="article:modified_time" content="2021-08-09T00:14:23+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ansible的脚本——playbook 剧本</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Ansible的脚本——playbook 剧本</h4> 
 <ul><li><a href="#playbook__1" rel="nofollow">一、playbook 剧本概述</a></li><li><ul><li><a href="#1playbook_2" rel="nofollow">1、playbook介绍</a></li><li><a href="#2playbook_7" rel="nofollow">2、playbook格式</a></li><li><a href="#3playbooks_15" rel="nofollow">3、playbooks本身由以下各部分组成</a></li><li><a href="#4yaml_24" rel="nofollow">4、yaml基本语法规则</a></li><li><a href="#5yaml_38" rel="nofollow">5、yaml支持的数据结构</a></li></ul> 
  </li><li><a href="#_47" rel="nofollow">二、示例:</a></li><li><ul><li><a href="#1playbook_80" rel="nofollow">1、运行playbook</a></li><li><a href="#2_96" rel="nofollow">2、定义、引用变量</a></li><li><a href="#3sudo_117" rel="nofollow">3、指定远程主机sudo切换用户</a></li><li><a href="#4when_128" rel="nofollow">4、when条件判断</a></li><li><a href="#5_149" rel="nofollow">5、迭代</a></li><li><a href="#6Templates__181" rel="nofollow">6、Templates 模块</a></li><li><ul><li><a href="#1j2_template__184" rel="nofollow">（1）先准备一个以.j2 为后缀的template 模板文件，设置引用的变量</a></li><li><a href="#2_195" rel="nofollow">（2）修改主机清单文件</a></li><li><a href="#3playbook_207" rel="nofollow">（3）编写playbook</a></li></ul> 
   </li><li><a href="#7tags_235" rel="nofollow">7、tags模块</a></li><li><a href="#8Roles_273" rel="nofollow">8、Roles模块</a></li><li><ul><li><a href="#1roles__276" rel="nofollow">（1）roles 的目录结构</a></li><li><a href="#2roles__300" rel="nofollow">（2）roles 内各目录含义解释</a></li><li><a href="#3playbook_roles__312" rel="nofollow">（3）在一个playbook 中使用roles 的步骤</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_368" rel="nofollow">三、示例</a></li><li><ul><li><a href="#1httpd_379" rel="nofollow">1、编写httpd模块</a></li><li><a href="#2mysql_394" rel="nofollow">2、编写mysql模块</a></li><li><a href="#3php_410" rel="nofollow">3、编写php模块-</a></li><li><a href="#4roles_425" rel="nofollow">4、编写roles示例</a></li></ul> 
  </li><li><a href="#httpdplaybook_441" rel="nofollow">四、编写httpd的playbook</a></li></ul> 
</div> 
<p></p> 
<h2><a id="playbook__1"></a>一、playbook 剧本概述</h2> 
<h3><a id="1playbook_2"></a>1、playbook介绍</h3> 
<ul><li> <p>playbook是ansible用于配置，部署，和管理被控节点的剧本。通过playbook的详细描述，执行其中的tasks，可以让远端主机达到预期的状态。playbook是由一个或多个”play”组成的列表。 当对一台机器做环境初始化的时候往往需要不止做一件事情，这时使用playbook会更加适合。通过playbook你可以一次在多台机器执行多个指令。通过这种预先设计的配置保持了机器的配置统一，并很简单的执行日常任务。</p> </li><li> <p>ansible通过不同的模块实现相应的管理，管理的方式通过定义的清单文件(hosts)所管理的主机包括认证的方式连接的端口等。所有的功能都是通过调用不同的模块(modules)来完成不同的功能的。不管是执行单条命令还是play-book都是基于清单文件。</p> </li></ul> 
<h3><a id="2playbook_7"></a>2、playbook格式</h3> 
<ul><li>playbook由<mark>YMAL语言</mark>编写。YMAL格式是类似于JSON的文件格式，便于人理解和阅读，同时便于书写。</li><li>一个剧本里面可以有多个play，每个play只能有一个tasks，每个tasks可以有多个name。</li><li>通过 task 调用 ansible 的模块将多个 play 组织在一 个playbook中运行。</li></ul> 
<h3><a id="3playbooks_15"></a>3、playbooks本身由以下各部分组成</h3> 
<table><thead><tr><th>Tasks</th><th>任务，即通过task 调用ansible 的模板将多个操作组织在一 个playbook 中运行</th></tr></thead><tbody><tr><td>Variables</td><td>变量</td></tr><tr><td>Templates</td><td>模板</td></tr><tr><td>Handlers</td><td>处理器，当changed状态 条件满足时，(notify) 触发执行的操作</td></tr><tr><td>Roles</td><td>角色</td></tr></tbody></table> 
<h3><a id="4yaml_24"></a>4、yaml基本语法规则</h3> 
<blockquote> 
 <p>1、大小写敏感<br> 2、使用缩进表示层级关系<br> 3、缩进时不允许使用tab键、只允许使用空格<br> 4、缩进的空格数目不重要，只要相同层级的元素左侧对齐即可</p> 
</blockquote> 
<table><thead><tr><th>hosts</th><th>定义节点，可以是组</th></tr></thead><tbody><tr><td>remote_user</td><td>是你以什么用户身份进行登陆</td></tr><tr><td>tasks</td><td>是你的任务</td></tr><tr><td>become:yes</td><td>表示切换用户</td></tr><tr><td>become_user: mysql</td><td>表示切换到mysql用户，配合上一条使用</td></tr><tr><td>- name:</td><td>为下面执行的操作起名</td></tr></tbody></table> 
<h3><a id="5yaml_38"></a>5、yaml支持的数据结构</h3> 
<blockquote> 
 <p>1、对象：键值对的集合，又称为映射（mapping）/ 哈希（hashes）/ 字典（dictionary）</p> 
 <p>2、数组：一组按次序排列的值，又称为序列（sequence）/ 列表（list）</p> 
 <p>3、纯量：单个的、不可再分的值</p> 
</blockquote> 
<h2><a id="_47"></a>二、示例:</h2> 
<pre><code class="prism language-css">vim test1.yaml
---     #yaml文件以---开头，以表明这是一个yaml文件，可省略
- <span class="token property">name</span><span class="token punctuation">:</span> first play     #定义一个play的名称，可省略
  <span class="token property">gather_facts</span><span class="token punctuation">:</span> false    #设置不进行facts信息收集，这可以加快执行速度，可省略
  <span class="token property">hosts</span><span class="token punctuation">:</span> webservers    #指定要执行任务的被管理主机组，如多个主机组用冒号分隔
  <span class="token property">remote_user</span><span class="token punctuation">:</span> root    #指定被管理主机上执行任务的用户
  <span class="token property">tasks</span><span class="token punctuation">:</span>     #定义任务列表，任务列表中的各任务按次序逐个在hosts中指定的主机上执行
   - <span class="token property">name</span><span class="token punctuation">:</span> test connection    #自定义任务名称
     <span class="token property">ping</span><span class="token punctuation">:</span>     #使用 <span class="token property">module</span><span class="token punctuation">:</span> [options] 格式来定义一个任务
   - <span class="token property">name</span><span class="token punctuation">:</span> disable selinux
     <span class="token property">command</span><span class="token punctuation">:</span> <span class="token string">'/sbin/setenforce 0'</span>    #command模块和shell模块无需使用key=value格式
     <span class="token property">ignore_errors</span><span class="token punctuation">:</span> True     #如执行命令的返回值不为0，就会报错，tasks停止，可使用ignore_errors忽略失败的任务
   - <span class="token property">name</span><span class="token punctuation">:</span> disable firewalld
     <span class="token property">service</span><span class="token punctuation">:</span> name=firewalld state=stopped    #使用 <span class="token property">module</span><span class="token punctuation">:</span> options 格式来定义任务，option使用key=value格式
   - <span class="token property">name</span><span class="token punctuation">:</span> install httpd
     <span class="token property">yum</span><span class="token punctuation">:</span> name=httpd state=latest
   - <span class="token property">name</span><span class="token punctuation">:</span> install configuration file for httpd
     <span class="token property">copy</span><span class="token punctuation">:</span> src=/opt/httpd.conf dest=/etc/httpd/conf/httpd.conf    #这里需要一个事先准备好的/opt/httpd.conf文件
     <span class="token property">notify</span><span class="token punctuation">:</span> <span class="token string">"restart httpd"</span>    #如以上操作后为changed的状态时，会通过notify指定的名称触发对应名称的handlers操作
   - <span class="token property">name</span><span class="token punctuation">:</span> start httpd service
     <span class="token property">service</span><span class="token punctuation">:</span> enabled=true name=httpd state=started
  <span class="token property">handlers</span><span class="token punctuation">:</span>     #handlers中定义的就是任务，此处handlers中的任务使用的是service模块
   - <span class="token property">name</span><span class="token punctuation">:</span> restart httpd    #notify和handlers中任务的名称必须一致
     <span class="token property">service</span><span class="token punctuation">:</span> name=httpd state=restarted
     
##Ansible在执行完某个任务之后并不会立即去执行对应的handler而是在当前play中所有普通任务都执行完后再去执行handler，这样的好处是可以多次触发notify，但最后只执行一次对应的handler，从而避免多次重启。
</code></pre> 
<p><img src="https://images2.imgbox.com/84/1f/DceZE64p_o.png" alt="请添加图片描述"></p> 
<h3><a id="1playbook_80"></a>1、运行playbook</h3> 
<pre><code class="prism language-css">ansible-playbook test1.yaml
//<span class="token property">补充参数</span><span class="token punctuation">:</span>
-k <span class="token punctuation">(</span>-ask-pass<span class="token punctuation">)</span> <span class="token punctuation">:</span>用来交互输入ssh密码
-K <span class="token punctuation">(</span>-ask-become- pass<span class="token punctuation">)</span> <span class="token punctuation">:</span>用来交互输入sudo密码
<span class="token property">u</span><span class="token punctuation">:</span>指定用户
ansible-playbook test1.yaml --syntax-check      #检查yaml文件的语法是否正确
ansible-playbook test1.yaml --list-task          #检查tasks任务
ansible-playbook test1.yaml --list-hosts        #检查生效的主机
ansible-playbook test1.yaml --start-at-task=<span class="token string">'install httpd'</span>  #指定从某个task开始运行
ansible-playbook test1.yaml -e <span class="token string">"username-nginx"</span>  #在命令行里定义变量
</code></pre> 
<h3><a id="2_96"></a>2、定义、引用变量</h3> 
<pre><code class="prism language-css"><span class="token selector">- name: second play
  hosts: dbservers
  remote_ user: root
  vars:                #定义变量
   - groupname:mysql   #格式为key: value
   - username: nginx
  tasks:
   - name: create mysql group
     group: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>groupname<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">system=yes gid=306     #使用</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>key<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">引用变量的值
   - name: create nginx user
     user: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>username<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">uid=306 group=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>groupname<span class="token punctuation">}</span><span class="token punctuation">}</span>
   - <span class="token property">name</span><span class="token punctuation">:</span> copy info file
     <span class="token property">copy</span><span class="token punctuation">:</span> content=<span class="token selector">"</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>ansible_default_ipv4<span class="token punctuation">}</span><span class="token punctuation">}</span>" dest=/opt/vars.txt    #在setup模块中可以获取facts变量信息

ansible-playbook test1.yaml -e <span class="token string">"username=nginx"</span>   #在命令行里定义变量
</code></pre> 
<h3><a id="3sudo_117"></a>3、指定远程主机sudo切换用户</h3> 
<pre><code class="prism language-css">---
- <span class="token property">hosts</span><span class="token punctuation">:</span> dbservers
  remote <span class="token property">user</span><span class="token punctuation">:</span> root
  <span class="token property">become</span><span class="token punctuation">:</span> yes                #2.6版本以后的参数，之前是sudo，意思为切换用户运行
  become_ <span class="token property">user</span><span class="token punctuation">:</span> zhangsan     #指定sudo用户为zhangsan
<span class="token property">执行playbook时</span><span class="token punctuation">:</span> ansible-playbook test1.yml -K &lt;密码&gt;
</code></pre> 
<h3><a id="4when_128"></a>4、when条件判断</h3> 
<ul><li>在Ansible中，提供的唯一一个通用的条件判断是when指令，当when指令的值为true时，则该任务执行，否则不执行该任务。</li></ul> 
<blockquote> 
 <p>//when一个比较常见的应用场景是实现跳过某个主机不执行任务或者只有满足条件的主机执行任务</p> 
</blockquote> 
<pre><code class="prism language-css"><span class="token selector">vim test2.yaml
---
- hosts: all
  remote user: root
  tasks:
  - name: shutdown host
    command: /sbin/shutdown -r now
    when: ansible_default_ipv4.address == "192.168.80.12"   #when指令中的变量名不需要手动加上</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">}</span>
或
    <span class="token property">when</span><span class="token punctuation">:</span> inventory_hostname == <span class="token string">"&lt;主机名&gt;"</span>

ansible-playbook test2.yaml
</code></pre> 
<h3><a id="5_149"></a>5、迭代</h3> 
<pre><code class="prism language-css"><span class="token selector">Ansible提供了很多种循环结构，一般 都命名为with_items， 作用等同于loop循环。
vim test3.yaml
- name: play1
  hosts: dbservers
  gather_facts:false
  tasks:
    - name: create directories
      file:
        path: ”</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token selector">"
        state: directory
      with items:      #等同于loop:
        - /tmp/test1
        - /tmp/test2
   - name: add users
     user: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item.name<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">state=present groups=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>item.groups<span class="token punctuation">}</span><span class="token punctuation">}</span>
     <span class="token selector">with items :
       - name: test1
         groups: wheel
       - name: test2
         groups: root
或     
     with items:
       -</span> <span class="token punctuation">{<!-- --></span><span class="token property">name</span><span class="token punctuation">:</span><span class="token string">'test1'</span><span class="token property">，groups</span><span class="token punctuation">:</span> <span class="token string">'wheel'</span><span class="token punctuation">}</span>
       <span class="token selector">-</span> <span class="token punctuation">{<!-- --></span><span class="token property">name</span><span class="token punctuation">:</span><span class="token string">'test2'</span><span class="token property">，groups</span><span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">}</span>

ansible-playbook test3.yaml
</code></pre> 
<h3><a id="6Templates__181"></a>6、Templates 模块</h3> 
<ul><li>Jinja是基于Python的模板引擎。Template类是Jinja的一个重要组件，可以看作是一个编译过的模板文件，用来产生目标文本，传递Python的变量给模板去替换模板中的标记。</li></ul> 
<h4><a id="1j2_template__184"></a>（1）先准备一个以.j2 为后缀的template 模板文件，设置引用的变量</h4> 
<pre><code class="prism language-css"><span class="token selector">cp /etc/httpd/conf/httpd.conf /opt/httpd.conf.j2 

vim /opt/httpd.conf.j2
Listen</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>http_ port<span class="token punctuation">}</span><span class="token punctuation">}</span>         <span class="token selector">#42行，修改
ServerName</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>server_name<span class="token punctuation">}</span><span class="token punctuation">}</span>    #95行，修改
DocumentRoot <span class="token selector">"</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>root_dir<span class="token punctuation">}</span><span class="token punctuation">}</span>"   #119行，修改
</code></pre> 
<h4><a id="2_195"></a>（2）修改主机清单文件</h4> 
<p><mark>使用主机变量定义一个变量名相同，而值不同的变量</mark></p> 
<pre><code class="prism language-css">vim /etc/ansible/hosts
[webservers]
192.168.80.11 http_port=192.168.80.11<span class="token punctuation">:</span>80 server_name=www.accp.<span class="token property">com</span><span class="token punctuation">:</span>80 root_dir=/etc/httpd/htdocs

[dbservers]
192.168.80.12 http_port=192.168.80.12<span class="token punctuation">:</span>80 server_name=www.benet.<span class="token property">com</span><span class="token punctuation">:</span>80 root_dir=/etc/httpd/htdocs
</code></pre> 
<h4><a id="3playbook_207"></a>（3）编写playbook</h4> 
<pre><code class="prism language-css"><span class="token selector">vim apache.yaml
---
- hosts: all
  remote_uaer: root
  vars:
    - package: httpd
    - service: httpd
  tasks:
    - name: install httpd package
      yum: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>package<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">state=latest
    - name: install configure file
      template: src=/opt/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf   #使用template模板
      notify:
        - restart httpd
    - name: create root dir
      file: path=/etc/httpd/htdocs state=directory
    - name: start httpd server
      service: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span> service<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">enabled=true state=started
  handlers:
    - name: restart httpd
      service: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>service<span class="token punctuation">}</span><span class="token punctuation">}</span> state=restarted

ansible-playbook apache.yaml
</code></pre> 
<h3><a id="7tags_235"></a>7、tags模块</h3> 
<ul><li>可以在一个playbook中为某个或某些任务定义“标签”，在执行此playbook时通过ansible- playbook命令使用–tags选项能实现仅运行指定的tasks。</li><li>playbook还提供了一个特殊的tags为always。作用就是当使用always当tags的task时，无论执行哪一个tags时， 定义有always的tags都会执行。</li></ul> 
<pre><code class="prism language-css">vim webhosts.yaml
---
- <span class="token property">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token property">remote_user</span><span class="token punctuation">:</span> root
  <span class="token property">tasks</span><span class="token punctuation">:</span>
    - <span class="token property">name</span><span class="token punctuation">:</span> Copy hosts file
      <span class="token property">copy</span><span class="token punctuation">:</span> src=/etc/hosts dest=/opt/hosts
      <span class="token property">tags</span><span class="token punctuation">:</span>
      - only       #可自定义
    - <span class="token property">name</span><span class="token punctuation">:</span> touch file
      <span class="token property">file</span><span class="token punctuation">:</span> path=/opt/testhost state=touch .
      <span class="token property">tags</span><span class="token punctuation">:</span>
      - always     #表示始终要运行的代码

ansible-playbook webhosts.yaml --tags=<span class="token string">"only"</span>

vim dbhosts.yaml
---
- <span class="token property">hosts</span><span class="token punctuation">:</span> dbservers
  <span class="token property">remote_user</span><span class="token punctuation">:</span> root
  <span class="token property">tasks</span><span class="token punctuation">:</span>
    - <span class="token property">name</span><span class="token punctuation">:</span> Copy hosts file
      <span class="token property">copy</span><span class="token punctuation">:</span> src=/etc/hosts dest=/opt/hosts
      <span class="token property">tags</span> <span class="token punctuation">:</span>
      - only
    - <span class="token property">name</span><span class="token punctuation">:</span> touch file
      <span class="token property">file</span><span class="token punctuation">:</span> path=/opt/testhost state=touch
      <span class="token property">tags</span><span class="token punctuation">:</span>
      - always

ansible-playbook dbhosts.yaml
//分别去两台被管理主机上去查看文件创建情况
</code></pre> 
<h3><a id="8Roles_273"></a>8、Roles模块</h3> 
<ul><li>Ansible为了层次化、结构化地组织Playbook，使用了角色(roles) ，roles可以根据层次型结构自动装载变量文件、task 以及handlers等简单来讲，roles就是通过分别将变量、文件、任务、模块及处理器放置于单独的目录中，并可以便捷地include它们。roles-般用于基于主机构建服务的场景中，但也可以用于构建守护进程等场景中。</li></ul> 
<h4><a id="1roles__276"></a>（1）roles 的目录结构</h4> 
<pre><code class="prism language-css">cd /etc/ansible/
tree roles/
roles/
|—— web/
|   |—— files/
|	|—— templates/
|	|—— tasks/
|	|—— handlers/
|	|—— vars/
|	|—— defaults/
|	|__ meta/
|___db/
	|—— files/
	|—— templates/
	|—— tasks/
	|—— handlers/
	|—— vars/
	|—— defaults/
	|__ meta/
	
</code></pre> 
<h4><a id="2roles__300"></a>（2）roles 内各目录含义解释</h4> 
<table><thead><tr><th>目录</th><th>含义</th></tr></thead><tbody><tr><td>files</td><td>用来存放由copy模块或script 模块调用的文件。</td></tr><tr><td>templates</td><td>用来存放jinjia2 模板，template 模块会自动在此目录中寻找jinjia2 模板文件。</td></tr><tr><td>tasks</td><td>此目录应当包含一个main.yml 文件，用于定义此角色的任务列表，此文件可以使用include 包含其它的位于此目录的task文件。</td></tr><tr><td>handlers</td><td>此目录应当包含一个main.yml文件，用于定义此角色中触发条件时执行的动作。</td></tr><tr><td>vars</td><td>此目录应当包含一个main.yml 文件，用于定义此角色用到的变量。</td></tr><tr><td>defaults</td><td>此目录应当包含一个main.yml文件，用于为当前角色设定默认变量。</td></tr><tr><td>meta</td><td>此目录应当包含一个main.yml 文件，用于定义此角色的特殊设定及其依赖关系。</td></tr></tbody></table> 
<h4><a id="3playbook_roles__312"></a>（3）在一个playbook 中使用roles 的步骤</h4> 
<p><mark>(1)创建以roles 命名的目录</mark></p> 
<pre><code class="prism language-css">mkdir /etc/ansible/roles/ -p    #yum装完默认就有
</code></pre> 
<p><mark>(2)创建全局变量目录(可选)</mark></p> 
<pre><code class="prism language-css">mkdir /etc/ansible/group_vars/ -p
touch /etc/ansible/group_vars/all    #文件名自己定义，引用的时候注意
</code></pre> 
<p><mark>(3)在roles 目录中分别创建以各角色名称命令的目录，如httpd、mysql</mark></p> 
<pre><code class="prism language-css">mkdir /etc/ansible/roles/httpd
mkdir /etc/ansible/roles/mysql
</code></pre> 
<p><mark>(4)在每个角色命令的目录中分别创建files、handlers、 tasks、 templates、 meta、defaults和vars目录，用不到的目录可以创建为空目录，也可以不创建</mark></p> 
<pre><code class="prism language-css"><span class="token selector">mkdir /etc/ansible/roles/httpd/</span><span class="token punctuation">{<!-- --></span>files<span class="token punctuation">,</span>templates<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>handlers<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>defaults<span class="token punctuation">,</span>meta<span class="token punctuation">}</span>
<span class="token selector">mkdir /etc/ansible/roles/mysql/</span><span class="token punctuation">{<!-- --></span>files<span class="token punctuation">,</span>templates<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>handlers<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>defaults<span class="token punctuation">,</span>meta<span class="token punctuation">}</span> 
</code></pre> 
<p><mark>(5)在每个角色的handlers、 tasks、 meta、defaults、 vars目录下创建main.yml 文件，千万不能自定义文件名</mark></p> 
<pre><code class="prism language-css"><span class="token selector">touch /etc/ansible/roles/httpd/</span><span class="token punctuation">{<!-- --></span>defaults<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>meta<span class="token punctuation">,</span>handlers<span class="token punctuation">}</span><span class="token selector">/main.yml
touch /etc/ansible/roles/mysql/</span><span class="token punctuation">{<!-- --></span>defaults<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>meta<span class="token punctuation">,</span>handlers<span class="token punctuation">}</span>/main.yml
</code></pre> 
<p><mark>(6)修改site.yml 文件，针对不同主机去调用不同的角色</mark></p> 
<pre><code class="prism language-css">vim /etc/ansible/site.yml
---
- <span class="token property">hosts</span><span class="token punctuation">:</span> webservers
  remote_ <span class="token property">user</span><span class="token punctuation">:</span> root
  <span class="token property">roles</span><span class="token punctuation">:</span>
     - httpd
- <span class="token property">hosts</span><span class="token punctuation">:</span> dbservers
  remote <span class="token property">user</span><span class="token punctuation">:</span> root
  <span class="token property">roles</span> <span class="token punctuation">:</span>
     - mysql
</code></pre> 
<p><mark>(7)运行ansible-playbook</mark></p> 
<pre><code class="prism language-css">cd /etc/ansible
ansible-playbook site.yml
</code></pre> 
<h2><a id="_368"></a>三、示例</h2> 
<pre><code class="prism language-css"><span class="token selector">mkdir /etc/ansible/roles/httpd/</span><span class="token punctuation">{<!-- --></span>files<span class="token punctuation">,</span>templates<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>handlers<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>defaults<span class="token punctuation">,</span> meta<span class="token punctuation">}</span> <span class="token selector">-p
mkdir /etc/ansible/roles/mysql/</span><span class="token punctuation">{<!-- --></span>files<span class="token punctuation">,</span>templates<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>handlers<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>defaults<span class="token punctuation">,</span> meta<span class="token punctuation">}</span> <span class="token selector">-p
mkdir /etc/ansible/roles/php/</span><span class="token punctuation">{<!-- --></span>files<span class="token punctuation">,</span>templates<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>handlers<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>defaults<span class="token punctuation">,</span> meta<span class="token punctuation">}</span> <span class="token selector">-p

touch /etc/ansible/roles/httpd/</span><span class="token punctuation">{<!-- --></span>defaults<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>meta<span class="token punctuation">,</span>handlers<span class="token punctuation">}</span><span class="token selector">/main.yml
touch /etc/ansible/roles/mysql/</span><span class="token punctuation">{<!-- --></span>defaults<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>meta<span class="token punctuation">,</span>handlers<span class="token punctuation">}</span><span class="token selector">/main.yml
touch /etc/ansible/roles/ php/</span><span class="token punctuation">{<!-- --></span>defaults<span class="token punctuation">,</span>vars<span class="token punctuation">,</span>tasks<span class="token punctuation">,</span>meta<span class="token punctuation">,</span>handlers<span class="token punctuation">}</span>/main.yml
</code></pre> 
<h3><a id="1httpd_379"></a>1、编写httpd模块</h3> 
<pre><code class="prism language-css"><span class="token selector">写一个简单的tasks/main.yml
vim /etc/ansible/roles/httpd/tasks/main.yml
- name: install apache
  yum: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>pkg<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">state=latest
- name: start apache
  service: enabled=true name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>svc<span class="token punctuation">}</span><span class="token punctuation">}</span> state=started

//<span class="token property">定义变量</span><span class="token punctuation">:</span>可以定义在全局变量中，也可以定义在roles角色变量中，一般定义在角色变量中
vim /etc/ansible/roles/httpd/vars/main.ym1
<span class="token property">svc</span><span class="token punctuation">:</span> httpd
</code></pre> 
<h3><a id="2mysql_394"></a>2、编写mysql模块</h3> 
<pre><code class="prism language-css"><span class="token selector">vim /etc/ansible/roles/mysql/tasks/main.yml
- name: install mysql
  yum: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>pkg<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">state=fatest
- name: start mysql
  service: enabled=true name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>svc<span class="token punctuation">}</span><span class="token punctuation">}</span> state=started

vim /etc/ansible/roles/mysql/vars/main.yml
<span class="token property">pkg</span><span class="token punctuation">:</span>
  - mariadb
  - mariadb-server
<span class="token property">SVC</span><span class="token punctuation">:</span> mariadb
</code></pre> 
<h3><a id="3php_410"></a>3、编写php模块-</h3> 
<pre><code class="prism language-css"> <span class="token selector">vim /etc/ansible/roles/php/tasks/main.yml
- name: install php
  yum: name=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>pkg<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token selector">state=latest
- name: start php-fpm
  service: enabled=true name=</span><span class="token punctuation">{<!-- --></span> <span class="token punctuation">{<!-- --></span>svc<span class="token punctuation">}</span> <span class="token punctuation">}</span> state=started

vim /etc/ansible/roles/php/vars/main.yml
<span class="token property">pkg</span><span class="token punctuation">:</span>
  - php
  - php- fpm
<span class="token property">SVC</span><span class="token punctuation">:</span> php-fpm
</code></pre> 
<h3><a id="4roles_425"></a>4、编写roles示例</h3> 
<pre><code class="prism language-css">vim /etc/ansible/site.yml
---
- <span class="token property">hosts</span><span class="token punctuation">:</span> webservers
  <span class="token property">remote_user</span><span class="token punctuation">:</span> root
  <span class="token property">roles</span> <span class="token punctuation">:</span>
   - httpd
   - mysql
   - php

cd /etc/ansible
ansible-playbook site.yml
</code></pre> 
<h2><a id="httpdplaybook_441"></a>四、编写httpd的playbook</h2> 
<p>（1） Ansible 管理端编写好playbook剧本</p> 
<p><img src="https://images2.imgbox.com/1c/9b/7zwH0eIo_o.png" alt="在这里插入图片描述"></p> 
<p>（2）在webservers端（client1）准备httpd模板配置文件<br> <img src="https://images2.imgbox.com/a0/1e/L7kI9Cov_o.png" alt="在这里插入图片描述"></p> 
<p>（3）在webservers端（client1）将准备好的httpd模板配置文件发送到Ansible管理端<br> <img src="https://images2.imgbox.com/78/31/CLTUnxRE_o.png" alt="在这里插入图片描述"></p> 
<p>（4）确认被控制端的httpd服务是否安装，firewalld处于开启状态，本机的httpd模板文件准备完成并且路径和剧本配置一致</p> 
<p><img src="https://images2.imgbox.com/ba/b8/jqzW8s8Z_o.png" alt="在这里插入图片描述"></p> 
<p>（5） 执行playbook剧本<br> <img src="https://images2.imgbox.com/30/7b/NFqxM9py_o.png" alt="在这里插入图片描述"></p> 
<p>（6） 检查被deservers控制端（client2）192.168.80.60的httpd服务和防火墙状态以及httpd配置文件</p> 
<p><img src="https://images2.imgbox.com/60/3a/4bpJ05ry_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/55/a8/78lFhojy_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/db4ad686c4873c459e0d3fcdf949bee5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">选择框的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/05fc03e62968beae01d703783b33fd31/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">服务器自己换系统,云服务器换自己的系统</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>