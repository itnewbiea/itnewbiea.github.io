<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>wangEditor 粘贴从 word 复制的带图片内容的最佳实践 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="wangEditor 粘贴从 word 复制的带图片内容的最佳实践" />
<meta property="og:description" content="文章目录 为什么要写这篇文章基于 Layui 本地安装 wangEditor 最新版本下载 JS 和 CSS 文件在 Layui 中创建 wangEditor wangEditor 实现 word 带图片格式内容粘贴场景描述分析思路关键点：图片如何粘贴最终实现代码（因为仅涉及 JS 代码，所以只提供 JS 代码） 总结 为什么要写这篇文章 首先源自于实际项目的客户需求，真实且刚需。本人在网上查找了很多相关资料，也对比和参考了其他类似的文本编辑器，才实现到本文实现的效果。提前声明，本文没有做到百分百粘贴前后同样的效果，介意者慎入！！以免浪费您的宝贵时间。基于 wangEditor 免费开源的前提下实现，没有任何需要付费或使用限制。出于整理收藏、个人积累，分享出来，抛砖引玉。 基于 Layui 本地安装 wangEditor 最新版本 不建议使用官网的 CDN，亲测不是很稳定。官网安装文档
下载 JS 和 CSS 文件 在任意位置新建一个 test1 文件夹，打开控制台，目录定位到该文件夹，执行 npm install @wangeditor/editor 或 yarn add @wangeditor/editor;安装完成，打开 node_modules/@wangeditor/editor/dist 文件夹，即可找到 JS CSS 文件： index.jscss/style.css 把上面两个文件拷贝到你的项目中。 在 Layui 中创建 wangEditor 新建一个引入 Layui 的 HTML 文档 &lt;!doctype html&gt; &lt;html lang=&#34;en&#34;&gt; &lt;head&gt; &lt;meta charset=&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5196d5412597ad2510ae8dd7e4f98b91/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-30T11:43:36+08:00" />
<meta property="article:modified_time" content="2022-08-30T11:43:36+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">wangEditor 粘贴从 word 复制的带图片内容的最佳实践</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">为什么要写这篇文章</a></li><li><a href="#_Layui__wangEditor__8" rel="nofollow">基于 Layui 本地安装 wangEditor 最新版本</a></li><li><ul><li><a href="#_JS__CSS__12" rel="nofollow">下载 JS 和 CSS 文件</a></li><li><a href="#_Layui__wangEditor_20" rel="nofollow">在 Layui 中创建 wangEditor</a></li></ul> 
  </li><li><a href="#wangEditor__word__145" rel="nofollow">wangEditor 实现 word 带图片格式内容粘贴</a></li><li><ul><li><a href="#_147" rel="nofollow">场景描述</a></li><li><a href="#_154" rel="nofollow">分析思路</a></li><li><a href="#_183" rel="nofollow">关键点：图片如何粘贴</a></li><li><a href="#_JS__JS__195" rel="nofollow">最终实现代码（因为仅涉及 JS 代码，所以只提供 JS 代码）</a></li></ul> 
  </li><li><a href="#_379" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>为什么要写这篇文章</h2> 
<ul><li>首先源自于实际项目的客户需求，真实且刚需。</li><li>本人在网上查找了很多相关资料，也对比和参考了其他类似的文本编辑器，才实现到本文实现的效果。<strong>提前声明，本文没有做到百分百粘贴前后同样的效果，介意者慎入！！以免浪费您的宝贵时间。</strong></li><li>基于 wangEditor 免费开源的前提下实现，没有任何需要付费或使用限制。</li><li>出于整理收藏、个人积累，分享出来，抛砖引玉。</li></ul> 
<h2><a id="_Layui__wangEditor__8"></a>基于 Layui 本地安装 wangEditor 最新版本</h2> 
<p>不建议使用官网的 CDN，亲测不是很稳定。<a href="https://www.wangeditor.com/v5/installation.html#cdn" rel="nofollow">官网安装文档</a></p> 
<h3><a id="_JS__CSS__12"></a>下载 JS 和 CSS 文件</h3> 
<ul><li>在任意位置新建一个 test1 文件夹，打开控制台，目录定位到该文件夹，执行 npm install @wangeditor/editor 或 yarn add @wangeditor/editor;</li><li>安装完成，打开 node_modules/@wangeditor/editor/dist 文件夹，即可找到 JS CSS 文件： 
  <ul><li>index.js</li><li>css/style.css</li></ul> </li><li>把上面两个文件拷贝到你的项目中。</li></ul> 
<h3><a id="_Layui__wangEditor_20"></a>在 Layui 中创建 wangEditor</h3> 
<ul><li>新建一个引入 Layui 的 HTML 文档</li></ul> 
<pre><code>&lt;!doctype html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta http-equiv="x-ua-compatible" content="ie=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"&gt;
    &lt;title&gt;Page title&lt;/title&gt;
    &lt;link href="/lib/layui-2.7.0/css/layui.css" rel="stylesheet"&gt;
    &lt;style&gt;
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;script src="/lib/layui-2.7.0/layui.js"&gt;&lt;/script&gt;
    &lt;script&gt;
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre> 
<ul><li>定义编辑器 html 结构，并引入 css 和 js<br> 编辑器和工具栏是强制分离的，所以需要定义两个 div。此时代码结构如下。</li></ul> 
<pre><code>&lt;!doctype html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta http-equiv="x-ua-compatible" content="ie=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"&gt;
    &lt;title&gt;Page title&lt;/title&gt;
    &lt;link href="/lib/layui-2.7.0/css/layui.css" rel="stylesheet"&gt;
    &lt;link href="/lib/wangeditor/style.css" rel="stylesheet"&gt;
    &lt;style&gt;
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div&gt;
        &lt;!-- 工具栏 --&gt;
        &lt;div id="toolbar-container"&gt;&lt;/div&gt;
        &lt;!-- 编辑器 --&gt;
        &lt;div id="editor-container"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;script src="/lib/layui-2.7.0/layui.js"&gt;&lt;/script&gt;
    &lt;script src="/lib/wangeditor/index.js"&gt;&lt;/script&gt;
    &lt;script&gt;
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre> 
<ul><li>创建编辑器（主要是 JS 代码实现）</li></ul> 
<pre><code>&lt;!doctype html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta http-equiv="x-ua-compatible" content="ie=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"&gt;
    &lt;title&gt;Page title&lt;/title&gt;
    &lt;link href="/lib/layui-2.7.0/css/layui.css" rel="stylesheet"&gt;
    &lt;link href="/lib/wangeditor/style.css" rel="stylesheet"&gt;
    &lt;style&gt;
        body {
            padding: 20px;
        }
    &lt;/style&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;div style="border: 1px solid #e1e1e1;"&gt;
        &lt;!-- 工具栏 --&gt;
        &lt;div id="toolbar-container" style="border-bottom: 1px solid #e1e1e1;"&gt;&lt;/div&gt;
        &lt;!-- 编辑器 --&gt;
        &lt;div id="editor-container" style="height: 400px;"&gt;&lt;/div&gt;
    &lt;/div&gt;
    &lt;script src="/lib/layui-2.7.0/layui.js"&gt;&lt;/script&gt;
    &lt;script src="/lib/wangeditor/index.js"&gt;&lt;/script&gt;
    &lt;script&gt;
        const {
            createEditor,
            createToolbar
        } = window.wangEditor;

        // 编辑器配置
        const editorConfig = {};
        editorConfig.placeholder = '请输入内容';

        // 工具栏配置
        const toolbarConfig = {};

        // 创建编辑器
        const editor = createEditor({
            selector: '#editor-container',
            config: editorConfig,
            mode: 'default'
        });

        // 创建工具栏
        const toolbar = createToolbar({
            editor,
            selector: '#toolbar-container',
            config: toolbarConfig,
            mode: 'default'
        });
    &lt;/script&gt;
&lt;/body&gt;

&lt;/html&gt;
</code></pre> 
<p>至此 wangEditor 编辑器已经创建成功了。刷新页面后，就可以看到和官网一样界面效果了。</p> 
<h2><a id="wangEditor__word__145"></a>wangEditor 实现 word 带图片格式内容粘贴</h2> 
<h3><a id="_147"></a>场景描述</h3> 
<ul><li>新建一个 word 文档，并输入常规内容，如带样式的文本内容、列表、表格，并<strong>插入图片</strong>，然后选中复制；</li><li>打开上面创建的编辑器页面，点击编辑器输入区域，然后 ctrl+v 粘贴。</li></ul> 
<blockquote> 
 <p><strong>结果：</strong> 文字样式部分丢失，表格尚可，列表溢出，图片直接丢失。</p> 
</blockquote> 
<h3><a id="_154"></a>分析思路</h3> 
<p>针对上面的实践结果，逐个寻找解决方案：</p> 
<ul><li> <p>样式丢失</p> 
  <ul><li> <p>体现：如文本样式部分丢失、列表溢出等。</p> </li><li> <p>为什么会丢失呢？</p> 
    <ul><li> <p>这个问题其实很容易回答，word 中的文本样式肯定与我们平时写的 HTML 样式有差异，会导致样式丢失。</p> </li><li> <p>另外一方面，我们平时写的 HTML 格式非常灵活，但是 wangEditor 无法兼容所有的 HTML 格式，这一点官方文档有特别标红说明。也就是说，我们在编辑器输入内容时，wangEdior 会做一些处理（过滤，筛选，转换等）。</p> </li></ul> 
    <blockquote> 
     <p>例如，wangEditor 可以识别 <code>&lt;strong&gt;hello&lt;/strong&gt;</code> 为加粗，但无法识别 <code>&lt;span style="font-weight: bold;"&gt;hello&lt;/span&gt;</code> 等其他加粗方式。</p> 
    </blockquote> </li><li> <p>解决措施</p> 
    <ul><li>了解差异，对内容样式做额外的处理，使其尽量符合 wangEditor 支持的格式。</li><li>代码实践（这只是我的思路，你还可以有更好的实现思路~~）</li></ul> <pre><code>// 例如缩进会超出边框，直接过滤掉相关样式即可
html = html.replace(/text\-indent:\-(.*?)pt/gi, '')
</code></pre> </li></ul> </li><li> <p>图片丢失</p> 
  <ul><li>为什么丢失呢？<br> 这个问题比较复杂，需要我们先了解复制粘贴的原理，真是情况和我们想的完全不一样，它不是简单的把 A 的内容作为一个整体一次性复制到编辑器中，而是将 A 的内容中图片的标签和图片的内容（数据）分成两部分分别以不同方式传输。此处简单说明一下，下面<strong>关键点</strong>部分做详细介绍。</li><li>解决措施<br> 其实思路很清晰，就是我们将图片的内容复制到编辑器中，而且还可以正常显示。这块比较复杂，此处只做个概念介绍，，下面<strong>关键点</strong>部分做详细介绍。</li></ul> </li></ul> 
<h3><a id="_183"></a>关键点：图片如何粘贴</h3> 
<blockquote> 
 <p>【开门见山】</p> 
 <p><strong>通过 wangEditor 的编辑器配置 API 中的 <a href="https://www.wangeditor.com/v5/editor-config.html#custompaste" rel="nofollow">customPaste 自定义粘贴</a></strong>。</p> 
 <p>通过该 API 可以阻止编辑器的默认粘贴处理逻辑，可以实现自己的粘贴逻辑。</p> 
 <p><em>即：这里的自己的粘贴逻辑，就是解决图片粘贴的关键所在。</em></p> 
</blockquote> 
<p><em>~~原来，其实道理就这么简单！！</em></p> 
<h3><a id="_JS__JS__195"></a>最终实现代码（因为仅涉及 JS 代码，所以只提供 JS 代码）</h3> 
<ul><li>自定义 wangEditor 粘贴</li></ul> 
<pre><code>// 其他代码
....

&lt;script&gt;
    const {
        createEditor,
        createToolbar
    } = window.wangEditor;

    // 编辑器配置
    const editorConfig = {};
    editorConfig.placeholder = '请输入内容';

    // 自定义粘贴
    editorConfig.customPaste = (editor, event) =&gt; {

        // 获取粘贴的html部分（？？没错粘贴word时候，一部分内容就是html），该部分包含了图片img标签
        let html = event.clipboardData.getData('text/html');

        // 获取rtf数据（从word、wps复制粘贴时有），复制粘贴过程中图片的数据就保存在rtf中
        const rtf = event.clipboardData.getData('text/rtf');

        if (html &amp;&amp; rtf) { // 该条件分支即表示要自定义word粘贴

            // 列表缩进会超出边框，直接过滤掉
            html = html.replace(/text\-indent:\-(.*?)pt/gi, '')

            // 从html内容中查找粘贴内容中是否有图片元素，并返回img标签的属性src值的集合
            const imgSrcs = findAllImgSrcsFromHtml(html);

            // 如果有
            if (imgSrcs &amp;&amp; Array.isArray(imgSrcs) &amp;&amp; imgSrcs.length) {

                // 从rtf内容中查找图片数据
                const rtfImageData = extractImageDataFromRtf(rtf);

                // 如果找到
                if (rtfImageData.length) {

                    // TODO：此处可以将图片上传到自己的服务器上

                    // 执行替换：将html内容中的img标签的src替换成ref中的图片数据，如果上面上传了则为图片路径
                    html = replaceImagesFileSourceWithInlineRepresentation(html, imgSrcs, rtfImageData)
                    editor.dangerouslyInsertHtml(html);

                }
            }

            // 阻止默认的粘贴行为
            event.preventDefault();
            return false;
        } else {
            return true;
        }
    }

    // 工具栏配置
    const toolbarConfig = {};

    // 创建编辑器
    const editor = createEditor({
        selector: '#editor-container',
        config: editorConfig,
        mode: 'default'
    });

    // 创建工具栏
    const toolbar = createToolbar({
        editor,
        selector: '#toolbar-container',
        config: toolbarConfig,
        mode: 'default'
    });
&lt;/script&gt;
.....
// 其他代码
</code></pre> 
<ul><li>工具函数（上面的代码中有用到）</li></ul> 
<pre><code>&lt;script&gt;
/**
 * 从html代码中匹配返回图片标签img的属性src的值的集合
 * @param htmlData
 * @return Array
 */
function findAllImgSrcsFromHtml(htmlData) {

    let imgReg = /&lt;img.*?(?:&gt;|\/&gt;)/gi; //匹配图片中的img标签
    let srcReg = /src=[\'\"]?([^\'\"]*)[\'\"]?/i; // 匹配图片中的src

    let arr = htmlData.match(imgReg); //筛选出所有的img
    if (!arr || (Array.isArray(arr) &amp;&amp; !arr.length)) {
        return false;
    }


    let srcArr = [];
    for (let i = 0; i &lt; arr.length; i++) {
        let src = arr[i].match(srcReg);
        // 获取图片地址
        srcArr.push(src[1]);
    }

    return srcArr;
}

/**
 * 从rtf内容中匹配返回图片数据的集合
 * @param rtfData
 * @return Array
 */
function extractImageDataFromRtf(rtfData) {
    if (!rtfData) {
        return [];
    }

    const regexPictureHeader = /{\\pict[\s\S]+?({\\\*\\blipuid\s?[\da-fA-F]+)[\s}]*/
    const regexPicture = new RegExp('(?:(' + regexPictureHeader.source + '))([\\da-fA-F\\s]+)\\}', 'g');
    const images = rtfData.match(regexPicture);
    const result = [];

    if (images) {
        for (const image of images) {
            let imageType = false;

            if (image.includes('\\pngblip')) {
                imageType = 'image/png';
            } else if (image.includes('\\jpegblip')) {
                imageType = 'image/jpeg';
            }

            if (imageType) {
                result.push({
                    hex: image.replace(regexPictureHeader, '').replace(/[^\da-fA-F]/g, ''),
                    type: imageType
                });
            }
        }
    }

    return result;
}

/**
 * 将html内容中img标签的属性值替换
 * @param htmlData html内容
 * @param imageSrcs html中img的属性src的值的集合
 * @param imagesHexSources rtf中图片数据的集合，与html内容中的img标签对应
 * @param isBase64Data 是否是Base64的图片数据
 * @return String
 */
function replaceImagesFileSourceWithInlineRepresentation(htmlData, imageSrcs, imagesHexSources, isBase64Data =
    true) {
    if (imageSrcs.length === imagesHexSources.length) {
        for (let i = 0; i &lt; imageSrcs.length; i++) {
            const newSrc = isBase64Data ?
                `data:${imagesHexSources[i].type};base64,${_convertHexToBase64(imagesHexSources[i].hex)}` :
                imagesHexSources[i];

            htmlData = htmlData.replace(imageSrcs[i], newSrc);
        }
    }

    return htmlData;
}

/**
 * 十六进制转base64
 */
function _convertHexToBase64(hexString) {
    return btoa(hexString.match(/\w{2}/g).map(char =&gt; {
        return String.fromCharCode(parseInt(char, 16));
    }).join(''));
}
&lt;/script&gt;
</code></pre> 
<h2><a id="_379"></a>总结</h2> 
<ol><li> <p>本文基本上完美实现了从 word 复制粘贴图片的需求。</p> </li><li> <p>至于样式部分丢失的问题，目前不可能 100%解决，wangEditor 本身解析内容的原理导致，就目前而言，只能尽可能对损失或丢失的样式做一些额外的处理，使其接近复制粘贴的预期。</p> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/71e0d8e015ecfc26bae9a9de9b2d456d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Python多线程QThread的使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c4eec6b7e87118c89f06f61979ac3d4d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">傅里叶变换与Matlab</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>