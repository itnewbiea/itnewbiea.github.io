<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>fastApi 项目部署 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="fastApi 项目部署" />
<meta property="og:description" content="方式一，Uvicorn部署 Run a Server Manually - Uvicorn - FastAPI
1，linux服务器安装 python&gt;3.8 2，安装 uvicorn : pip install &#34;uvicorn[standard]&#34; 3，上传项目到服务器 main.py
from typing import Union from fastapi import FastAPI import uvicorn app = FastAPI() &#39;&#39;&#39; 启动命令 uvicorn main:app --reload --port 8000 #导出依赖 pip freeze &gt;requirements.txt api文档地址 http://localhost:8080/docs 参数类型: 请求正文（body）&#43;路径参数（{}）&#43;查询参数（?&amp;） &#39;&#39;&#39; @app.get(&#34;/&#34;) async def root(): return {&#34;message&#34;: &#34;Hello World&#34;} @app.get(&#34;/items/{item_id}&#34;) def read_item(item_id: int, q: Union[str, None] = None): return {&#34;item_id&#34;: item_id, &#34;q&#34;: q} # 第二种启动方式： if __name__ == &#39;__main__&#39;: uvicorn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/85135ed8bf4efa65947b825d6b54cb98/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-01T18:05:37+08:00" />
<meta property="article:modified_time" content="2024-01-01T18:05:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">fastApi 项目部署</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>方式一，Uvicorn部署</h2> 
<p><a href="https://fastapi.tiangolo.com/zh/deployment/manually/" rel="nofollow" title="Run a Server Manually - Uvicorn - FastAPI">Run a Server Manually - Uvicorn - FastAPI</a></p> 
<h3>      1，linux服务器安装 python&gt;3.8</h3> 
<h3>      2，安装 uvicorn :                </h3> 
<pre><code class="language-bash"> pip install "uvicorn[standard]"</code></pre> 
<h3>      3，上传项目到服务器</h3> 
<p>            main.py</p> 
<pre><code class="language-bash">from typing import Union
from fastapi import FastAPI
import uvicorn

app = FastAPI()
'''
启动命令
uvicorn main:app --reload --port 8000

#导出依赖
pip freeze &gt;requirements.txt

api文档地址
http://localhost:8080/docs

参数类型:
请求正文（body）+路径参数（{}）+查询参数（?&amp;）
'''


@app.get("/")
async def root():
    return {"message": "Hello World"}


@app.get("/items/{item_id}")
def read_item(item_id: int, q: Union[str, None] = None):
    return {"item_id": item_id, "q": q}


# 第二种启动方式：
if __name__ == '__main__':
    uvicorn.run(app="main:app", host="localhost", port=8000)
</code></pre> 
<p></p> 
<h3>      4，启动服务：                </h3> 
<pre><code class="language-bash">uvicorn main:app --host 0.0.0.0 --port 8080


# uvicorn main:app --host 0.0.0.0 --port 8080 --workers 4  # 启动4个进程</code></pre> 
<p><strong>                main 是项目启动文件main.py</strong></p> 
<p><strong>                app是main.py里的FastAPI对象（app = FastAPI() ）</strong></p> 
<p><strong>                允许所有ip连接：--host 0.0.0.0 </strong></p> 
<p><strong>                项目启动在8080端口 : --port 8080</strong></p> 
<p><span style="color:#fe2c24;">               <strong> 远程连接一断开服务会停止</strong></span></p> 
<p></p> 
<h2>方式二， Gunicorn 和 Uvicorn</h2> 
<p><a href="https://fastapi.tiangolo.com/zh/deployment/server-workers/" rel="nofollow" title="Server Workers - Gunicorn with Uvicorn - FastAPI">Server Workers - Gunicorn with Uvicorn - FastAPI</a></p> 
<p><strong>            Gunicorn将充当进程管理器，监听端口和IP。它会将通信传输到运行Uvicorn类的工作进程。Uvicorn将负责将Gunicornn发送的数据转换为FastAPI使用的ASGI标准。</strong></p> 
<h3>        1，安装Gunicorn 和 Uvicorn         </h3> 
<pre><code class="language-bash">pip install "uvicorn[standard]" gunicorn</code></pre> 
<h3>        2，启动服务： </h3> 
<pre><code class="language-bash">gunicorn main:app --workers 4 --worker-class uvicorn.workers.UvicornWorker --bind 0.0.0.0:8000


# -workers：要使用的worker进程的数量，每个进程将运行一个Uvicorn worker，在本例中为4个worker。
# 导入uvicon.workers.UvicornWorker
# --bind：这个命令告诉Gunicorn要监听的IP和端口，使用冒号（：）分隔IP和端口
# Gunicorn还将负责管理失效流程，并在需要时重新启动新流程，以保持进程数量。</code></pre> 
<p><span style="color:#fe2c24;"><strong>          这种启动方式远程连接断开不会停止服务</strong></span></p> 
<h3><span style="color:#fe2c24;"><strong>      </strong></span><span style="color:#0d0016;"><strong>  3，停止服务</strong></span></h3> 
<p>  <strong>      查找进程  &gt;&gt; kill 进程</strong></p> 
<pre><code>ps -ef|grep Uvicorn
ps -ef|grep Gunicorn</code></pre> 
<p></p> 
<h2>方式三，docker 容器</h2> 
<p><a href="https://fastapi.tiangolo.com/zh/deployment/docker/" rel="nofollow" title="FastAPI in Containers - Docker - FastAPI">FastAPI in Containers - Docker - FastAPI</a></p> 
<h3>        1，项目目录</h3> 
<p>                 <strong>.</strong><br>                 ├── app<br>                 │   ├── __init__.py<br>                 │   └── main.py<br>                 ├── Dockerfile<br>                 └── requirements.txt</p> 
<h3>        2，Dockerfile</h3> 
<pre><code class="language-bash">#
FROM python:3.9

# 设置工作目录
WORKDIR /code

# copy文件到容器
COPY ./requirements.txt /code/requirements.txt

#
RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple


#
COPY ./app /code/app

# 启动命令
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "80"]

# 使用nginx代理请求头
#CMD ["uvicorn", "app.main:app", "--proxy-headers", "--host", "0.0.0.0", "--port", "80"]</code></pre> 
<h3>        3，制作镜像</h3> 
<pre><code class="language-bash"># cd 到Dockerfile文件所在目录

docker build -t myimage .</code></pre> 
<h3>        4，运行容器</h3> 
<pre><code class="language-bash">docker run -d --name mycontainer -p 800:80 myimage

# -p:端口映射 宿主机端口:容器端口</code></pre> 
<h3>        5，测试项目</h3> 
<p><img alt="" height="139" src="https://images2.imgbox.com/a2/86/PFbmxs5u_o.png" width="634"></p> 
<h2>方式四，虚拟环境运行</h2> 
<p>        持续更新。。。</p> 
<p></p> 
<h2>git +docker +  bash 持续集成</h2> 
<h3>       1， 项目目录</h3> 
<p><img alt="" height="285" src="https://images2.imgbox.com/8f/1b/0ej0jU46_o.png" width="455"></p> 
<h3>        2，服务器安装git、docker</h3> 
<p>         </p> 
<h3>        3，项目父目录放一个脚本文件 startweb.sh</h3> 
<p><strong>                运行脚本 ： ./startweb.sh</strong></p> 
<pre><code class="language-bash">#!/bin/bash

image_name='apiimage'
contrainer_name='apiproject'
git_url='https://gitee.com/daixxxxx/apidemo.git'
project_name='apidemo'
prot=900

if [ ! -d "./${project_name}/" ];then
    echo "项目目录不存在"
	# 克隆代码
	git clone ${git_url}

	# 进入项目目录
	cd ${project_name}

	# 制作镜像 apiimage:镜像名
	docker build -t ${image_name} .
 
	# 运行容器  apidemo:容器名
	docker run -d --name ${contrainer_name} -p ${prot}:80 ${image_name} 

    
else
    echo "项目已经存在"
    # 进入dockerfile所在目录
   	cd ./${project_name}
  	# 拉取最新代码
   	git pull ${git_url}
	# 停止apidemo容器
	docker stop ${contrainer_name}
	# 删除容器
	docker rm ${contrainer_name}
	# 制作镜像
	docker build -t ${image_name} .
	# 运行容器
	docker run -d --name ${contrainer_name} -p ${prot}:80 ${image_name}
fi


# 检查容器运行状态
status=$(docker inspect --format='{<!-- -->{.State.Status}}' "$contrainer_name")
if [ "$status" = "running" ];then
	echo "项目部署成功"
else
	echo "项目部署失败"
fi
</code></pre> 
<p></p> 
<h3>        4 ，后续持续集成：提交代码 &gt;&gt; 运行脚本startweb.sh</h3> 
<pre><code class="language-bash"># cd 到脚本目录
./startweb.sh</code></pre> 
<h3>        5，停止项目        </h3> 
<pre><code class="language-bash"># 停止容器apiproject
docker stop apiproject</code></pre> 
<h2>Jenkins 持续集成</h2> 
<p>        持续更新。。。</p> 
<h2>k8s 持续集成</h2> 
<p>        持续更新。。。</p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d3157d0a4305e7bc78c06605c2b5d8e2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">听GPT 讲Rust源代码--library/alloc(2)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ed84d429962216e8ab6b2261be0e07f9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Springboot整合Elasticsearch 7.X 复杂查询</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>