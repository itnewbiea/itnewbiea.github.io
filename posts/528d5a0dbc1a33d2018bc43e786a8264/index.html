<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>.NET 8 网络改进 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content=".NET 8 网络改进" />
<meta property="og:description" content="作者：
Máňa - Software Engineer, .NET Natalia
Kondratyeva - Software Engineer, .NET
排版：Alan Wang
随着新的 .NET 版本的发布，发表有关网络空间中新的有趣变化的博客文章已经成为一种传统。今年，我们要介绍 HTTP 部分的变化、新增指标、新的 HttpClientFactoryAPI 等。
HTTP 指标 .NET 8 使用 .NET 6 中引入的 System.Diagnostics.Metrics API 将内置 HTTP 指标添加到 ASP.NET Core 和 HttpClient。Metrics API 和新内置指标的语义都是与 OpenTelemetry 密切合作设计的，确保新指标符合标准，并与 Prometheus 和 Grafana 等流行工具良好配合。
System.Diagnostics.MetricsAPI 引入了许多 EventCounters 所缺少的新功能。新的内置指标广泛利用了这些功能，从而通过更简单、更优雅的工具实现了更广泛的功能。举几个例子：
Histograms 允许我们能够报告持续时间，例如请求持续时间（ http.client.request.duration）或连接持续时间（http.client.connection.duration）。这些是没有 EventCounter 对应项的新指标。Multi-dimensionality 允许我们将标签（又名属性或标签）附加到测量值上，这意味着我们可以将 server.address （标识 URI 来源）或 error.type（描述请求失败时的错误原因）之类的信息与测量值一起报告。多维还可以实现简化：为了报告打开的 HTTP 连接数，SocketsHttpHandler 使用 3 个 EventCounters：http11-connections-current-total、http20-connections-current-total 和 http30-connections-current-total，而这些计数器的 Metrics 等效项是单个工具 http." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/528d5a0dbc1a33d2018bc43e786a8264/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-25T23:38:12+08:00" />
<meta property="article:modified_time" content="2023-12-25T23:38:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">.NET 8 网络改进</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>作者：<br> Máňa - Software Engineer, .NET Natalia<br> Kondratyeva - Software Engineer, .NET<br> 排版：Alan Wang</p> 
</blockquote> 
<p>随着新的 <a href="https://devblogs.microsoft.com/dotnet/announcing-dotnet-8/" rel="nofollow">.NET 版本的发布</a>，发表有关网络空间中新的有趣变化的博客文章已经成为一种传统。今年，我们要介绍 <a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#http" rel="nofollow">HTTP</a> 部分的变化、新增<a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#metrics" rel="nofollow">指标</a>、新的 HttpClientFactoryAPI 等。</p> 
<h3><a id="HTTP_6"></a>HTTP</h3> 
<h4><a id="_7"></a>指标</h4> 
<p>.NET 8 使用 .NET 6 中引入的 <a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/metrics" rel="nofollow">System.Diagnostics.Metrics API</a> 将内置 HTTP 指标添加到 ASP.NET Core 和 HttpClient。Metrics API 和新内置指标的语义都是与 OpenTelemetry 密切合作设计的，确保新指标符合标准，并与 <a href="https://prometheus.io/" rel="nofollow">Prometheus</a> 和 <a href="https://grafana.com/" rel="nofollow">Grafana</a> 等流行工具良好配合。</p> 
<p>System.Diagnostics.MetricsAPI 引入了许多 EventCounters 所缺少的新功能。新的内置指标广泛利用了这些功能，从而通过更简单、更优雅的工具实现了更广泛的功能。举几个例子：</p> 
<ul><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.metrics.meter.createhistogram?view=net-8.0" rel="nofollow">Histograms</a> 允许我们能够报告持续时间，例如请求持续时间（ <a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/built-in-metrics-system-net#instrument-httpclientconnectionduration" rel="nofollow">http.client.request.duration</a>）或连接持续时间（<a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/built-in-metrics-system-net#instrument-httpclientconnectionduration" rel="nofollow">http.client.connection.duration</a>）。这些是没有 EventCounter 对应项的新指标。</li><li><a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/metrics-instrumentation#multi-dimensional-metrics" rel="nofollow">Multi-dimensionality</a> 允许我们将标签（又名属性或标签）附加到测量值上，这意味着我们可以将 server.address （标识 <a href="https://www.rfc-editor.org/rfc/rfc9110.html#name-uri-origin%20%20http30-connections-current-total%20%20https://learn.microsoft.com/en-us/dotnet/core/diagnostics/available-counters#systemnethttp-counters" rel="nofollow">URI 来源</a>）或 error.type（描述请求失败时的错误原因）之类的信息与测量值一起报告。多维还可以实现简化：为了报告打开的 HTTP 连接数，SocketsHttpHandler 使用 3 个 EventCounters：http11-connections-current-total、http20-connections-current-total 和 <a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/available-counters#systemnethttp-counters" rel="nofollow">http30-connections-current-total</a>，而这些计数器的 Metrics 等效项是单个工具 <a href="https://learn.microsoft.com/dotnet/core/diagnostics/built-in-metrics-system-net#instrument-httpclientopen_connections" rel="nofollow">http.client.open_connections</a>，其中使用 network.protocol.version 标记报告 HTTP 版本。</li><li>为了帮助内置标签不足以对传出 HTTP 请求进行分类的用例，http.client.request.duration 指标支持注入用户定义的标签。这称为<a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/telemetry/metrics#enrichment" rel="nofollow">扩充</a>。</li><li><a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/telemetry/metrics#imeterfactory-and-ihttpclientfactory-integration" rel="nofollow">IMeterFactory 集成</a>可以隔离用于发出 HTTP 指标的 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.metrics.meter?view=net-8.0" rel="nofollow">Meter 实例</a>，从而更轻松地编写针对内置测量值运行验证的测试，并启用此类测试的并行执行。</li><li>虽然这并不是特定于内置网络指标，但值得一提的是 System.Digangostics.Metrics 中的集合 API 也更高级：它们是强类型且性能更高，并且允许多个同时侦听器和侦听器访问未聚合的测量结果。</li></ul> 
<p>这些优势结合在一起带来了更好、更丰富的指标，这些指标可以通过 Prometheus 等第三方工具更有效地收集。由于 <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" rel="nofollow">PromQL（Prometheus 查询语言）</a>的灵活性，它允许针对从 .NET 网络堆栈收集的多维指标创建复杂的查询，用户现在可以深入了解 HttpClient 和 SocketsHttpHandler 实例的状态和运行状况，这在以前是不可能的。</p> 
<p>不足之处在于，在 .NET 8 中，只有 System.Net.Http 和 System.Net.NameResolution 组件是使用 System.Diagnostics.Metrics 进行检测的，这意味着您仍然需要使用 EventCounters 从堆栈的较低层（例如 System.Net.Sockets）提取计数器. 虽然仍然支持以前版本中存在的所有内置 EventCounters，但 .NET 团队预计不会对 EventCounters 进行大量新投资，并且在未来的版本中会使用 System.Diagnostics.Metrics 添加新的内置检测工具。</p> 
<p>有关使用内置 HTTP 指标的更多信息，请阅读我们有关 <a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/telemetry/metrics" rel="nofollow">.NET 中的网络指标</a>的教程。它包括有关使用 Prometheus 和 Grafana 进行收集和报告的示例，还演示了如何丰富和测试内置 HTTP 指标。有关内置工具的完整列表，请参阅 <a href="https://learn.microsoft.com/en-us/dotnet/core/diagnostics/built-in-metrics-system-net" rel="nofollow">System.Net 指标</a>的文档。如果您对服务器端更感兴趣，请阅读有关 <a href="https://learn.microsoft.com/en-us/aspnet/core/log-mon/metrics/metrics?view=aspnetcore-8.0" rel="nofollow">ASP.NET Core 指标</a>的文档。</p> 
<h4><a id="_25"></a>扩展遥测</h4> 
<p>除了新指标之外，<a href="https://devblogs.microsoft.com/dotnet/net-5-new-networking-improvements/#telemetry" rel="nofollow">.NET 5</a> 中引入的现有基于 EventSource 的遥测事件还增加了有关 HTTP 连接的更多信息（<a href="https://github.com/dotnet/runtime/pull/88853">dotnet/runtime#88853</a>）：</p> 
<pre><code class="prism language-csharp"><span class="token operator">-</span> <span class="token function">ConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> versionMajor<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span></span> versionMinor<span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token function">ConnectionEstablished</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> versionMajor<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span></span> versionMinor<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">long</span></span> connectionId<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> scheme<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> remoteAddress<span class="token punctuation">)</span>

<span class="token operator">-</span> <span class="token function">ConnectionClosed</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> versionMajor<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span></span> versionMinor<span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token function">ConnectionClosed</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> versionMajor<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">byte</span></span> versionMinor<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">long</span></span> connectionId<span class="token punctuation">)</span>

<span class="token operator">-</span> <span class="token function">RequestHeadersStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token operator">+</span> <span class="token function">RequestHeadersStart</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">long</span></span> connectionId<span class="token punctuation">)</span>
</code></pre> 
<p>现在，当建立新连接时，该事件会记录 connectionId 及其方案、端口和对等 IP 地址。这样就能通过 RequestHeadersStart 事件将请求和响应与连接关联起来（当请求与池连接关联并开始处理时发生该事件），该事件还记录关联的 ConnectionId。这在用户希望查看为其 HTTP 请求提供服务的服务器的 IP 地址的诊断场景中尤其有价值，这也是添加此功能的主要动机（<a href="https://github.com/dotnet/runtime/issues/63159">dotnet/runtime#63159</a>）。</p> 
<p>事件可以通过多种方式使用，请参阅 <a href="https://learn.microsoft.com/en-us/dotnet/fundamentals/networking/telemetry/events" rel="nofollow">.NET 中的网络遥测 – 事件</a>。但为了在进程内增强日志记录，可以使用自定义 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.diagnostics.tracing.eventlistener?view=net-8.0" rel="nofollow">EventListener</a> 将请求/响应对与连接数据相关联：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token class-name">IPLoggingListener</span> ipLoggingListener <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token class-name">HttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Send requests in parallel.</span>
<span class="token keyword">await</span> Parallel<span class="token punctuation">.</span><span class="token function">ForAsync</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> ct<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Initialize the async local so that it can be populated by "RequestHeadersStart" event handler.</span>
    <span class="token class-name">RequestInfo</span> info <span class="token operator">=</span> RequestInfo<span class="token punctuation">.</span>Current<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"https://testserver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Response </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">response<span class="token punctuation">.</span>StatusCode</span><span class="token punctuation">}</span></span><span class="token string"> handled by connection </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">info<span class="token punctuation">.</span>ConnectionId</span><span class="token punctuation">}</span></span><span class="token string">. Remote IP: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">info<span class="token punctuation">.</span>RemoteAddress</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Process response...</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">RequestInfo</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">AsyncLocal<span class="token punctuation">&lt;</span>RequestInfo<span class="token punctuation">&gt;</span></span> _asyncLocal <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">RequestInfo</span> Current <span class="token operator">=&gt;</span> _asyncLocal<span class="token punctuation">.</span>Value <span class="token operator">??=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> RemoteAddress<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token class-name"><span class="token keyword">long</span></span> ConnectionId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">internal</span> <span class="token keyword">sealed</span> <span class="token keyword">class</span> <span class="token class-name">IPLoggingListener</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">EventListener</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span> s_connection2Endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ConcurrentDictionary<span class="token punctuation">&lt;</span><span class="token keyword">long</span><span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// EventId corresponds to [Event(eventId)] attribute argument and the payload indices correspond to the event method argument order.</span>

    <span class="token comment">// See: https://github.com/dotnet/runtime/blob/a6e4834d53ac591a4b3d4a213a8928ad685f7ad8/src/libraries/System.Net.Http/src/System/Net/Http/HttpTelemetry.cs#L100-L101</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> ConnectionEstablished_EventId <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> ConnectionEstablished_ConnectionIdIndex <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> ConnectionEstablished_RemoteAddressIndex <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>

    <span class="token comment">// See: https://github.com/dotnet/runtime/blob/a6e4834d53ac591a4b3d4a213a8928ad685f7ad8/src/libraries/System.Net.Http/src/System/Net/Http/HttpTelemetry.cs#L106-L107</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> ConnectionClosed_EventId <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> ConnectionClosed_ConnectionIdIndex <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token comment">// See: https://github.com/dotnet/runtime/blob/a6e4834d53ac591a4b3d4a213a8928ad685f7ad8/src/libraries/System.Net.Http/src/System/Net/Http/HttpTelemetry.cs#L118-L119</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> RequestHeadersStart_EventId <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token class-name"><span class="token keyword">int</span></span> RequestHeadersStart_ConnectionIdIndex <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnEventSourceCreated</span><span class="token punctuation">(</span><span class="token class-name">EventSource</span> eventSource<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>eventSource<span class="token punctuation">.</span>Name <span class="token operator">==</span> <span class="token string">"System.Net.Http"</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">EnableEvents</span><span class="token punctuation">(</span>eventSource<span class="token punctuation">,</span> EventLevel<span class="token punctuation">.</span>LogAlways<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">OnEventWritten</span><span class="token punctuation">(</span><span class="token class-name">EventWrittenEventArgs</span> eventData<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ReadOnlyCollection<span class="token punctuation">&lt;</span><span class="token keyword">object</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span><span class="token punctuation">?</span></span> payload <span class="token operator">=</span> eventData<span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>payload <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>eventData<span class="token punctuation">.</span>EventId<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> ConnectionEstablished_EventId<span class="token punctuation">:</span>
                <span class="token comment">// Remember the connection data.</span>
                <span class="token class-name"><span class="token keyword">long</span></span> connectionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>ConnectionEstablished_ConnectionIdIndex<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">?</span></span> remoteAddress <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">?</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>ConnectionEstablished_RemoteAddressIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>remoteAddress <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Connection </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">connectionId</span><span class="token punctuation">}</span></span><span class="token string"> established to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">remoteAddress</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    s_connection2Endpoint<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">,</span> remoteAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> ConnectionClosed_EventId<span class="token punctuation">:</span>
                connectionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>ConnectionClosed_ConnectionIdIndex<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">;</span>
                s_connection2Endpoint<span class="token punctuation">.</span><span class="token function">TryRemove</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">,</span> <span class="token keyword">out</span> _<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> RequestHeadersStart_EventId<span class="token punctuation">:</span>
                <span class="token comment">// Populate the async local RequestInfo with data from "ConnectionEstablished" event.</span>
                connectionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span>payload<span class="token punctuation">[</span>RequestHeadersStart_ConnectionIdIndex<span class="token punctuation">]</span><span class="token operator">!</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>s_connection2Endpoint<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>connectionId<span class="token punctuation">,</span> <span class="token keyword">out</span> remoteAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    RequestInfo<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>RemoteAddress <span class="token operator">=</span> remoteAddress<span class="token punctuation">;</span>
                    RequestInfo<span class="token punctuation">.</span>Current<span class="token punctuation">.</span>ConnectionId <span class="token operator">=</span> connectionId<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此外，Redirect 事件已扩展为包含重定向 URI：</p> 
<pre><code class="prism language-csharp"><span class="token operator">-</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Redirect</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> redirectUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="HTTP__134"></a>HTTP 错误代码</h4> 
<p>HttpClient 在诊断方面的问题之一是，当发生异常时，很难以编程方式区分错误的确切根本原因。区分它们的唯一方法是解析来自 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestexception?view=net-8.0" rel="nofollow">HttpRequestException 的异常消息</a>。此外，其他 HTTP 实现（如带有 <a href="https://learn.microsoft.com/en-us/windows/win32/winhttp/error-messages" rel="nofollow">ERROR_WINHTTP_*</a> 错误码的 WinHTTP）以数字代码或枚举的形式提供了此类功能。所以 .NET 8引入了一个类似的枚举，并在 HTTP 处理抛出的异常中提供了它，它们是：</p> 
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequestexception?view=net-8.0" rel="nofollow">HttpRequestException</a> 用于接收响应头之前的请求处理。</p> 
<p>读取响应内容时抛出 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httpioexception?view=net-8.0" rel="nofollow">HttpIOException</a>。</p> 
<p>在 <a href="https://github.com/dotnet/runtime/issues/76644">dotnet/runtime#76644 API</a> 提案中描述了 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.http.httprequesterror?view=net-8.0" rel="nofollow">HttpRequestError</a> 枚举的设计以及如何将其插入 HTTP 异常。</p> 
<p>现在，HttpClient 方法的使用者可以更容易、更可靠地处理特定的内部错误：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token class-name">HttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Handling problems with the server:</span>
<span class="token keyword">try</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token class-name">HttpResponseMessage</span> response <span class="token operator">=</span> <span class="token keyword">await</span> httpClient<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"https://testserver"</span><span class="token punctuation">,</span> HttpCompletionOption<span class="token punctuation">.</span>ResponseHeadersRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token class-name">Stream</span> responseStream <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStreamAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Process responseStream ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequestException</span> e<span class="token punctuation">)</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>HttpRequestError <span class="token operator">==</span> HttpRequestError<span class="token punctuation">.</span>NameResolutionError<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Unknown host: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">e</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// --&gt; Try different hostname.</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequestException</span> e<span class="token punctuation">)</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>HttpRequestError <span class="token operator">==</span> HttpRequestError<span class="token punctuation">.</span>ConnectionError<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Server unreachable: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">e</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// --&gt; Try different server.</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HttpIOException</span> e<span class="token punctuation">)</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>HttpRequestError <span class="token operator">==</span> HttpRequestError<span class="token punctuation">.</span>InvalidResponse<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Mangled responses: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">e</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// --&gt; Block list server.</span>
<span class="token punctuation">}</span>

<span class="token comment">// Handling problems with HTTP version selection:</span>
<span class="token keyword">try</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">using</span> <span class="token class-name">HttpResponseMessage</span> response <span class="token operator">=</span> <span class="token keyword">await</span> httpClient<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpRequestMessage</span><span class="token punctuation">(</span>HttpMethod<span class="token punctuation">.</span>Get<span class="token punctuation">,</span> <span class="token string">"https://testserver"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Version <span class="token operator">=</span> HttpVersion<span class="token punctuation">.</span>Version20<span class="token punctuation">,</span>
        VersionPolicy <span class="token operator">=</span> HttpVersionPolicy<span class="token punctuation">.</span>RequestVersionExact
    <span class="token punctuation">}</span><span class="token punctuation">,</span> HttpCompletionOption<span class="token punctuation">.</span>ResponseHeadersRead<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token class-name">Stream</span> responseStream <span class="token operator">=</span> <span class="token keyword">await</span> response<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStreamAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Process responseStream ...</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">HttpRequestException</span> e<span class="token punctuation">)</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>HttpRequestError <span class="token operator">==</span> HttpRequestError<span class="token punctuation">.</span>VersionNegotiationError<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"HTTP version is not supported: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">e</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Try with different HTTP version.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="HTTPS__189"></a>HTTPS 代理支持</h4> 
<p>这个版本中实现的最受欢迎的功能之一是支持 HTTPS 代理（<a href="https://github.com/dotnet/runtime/issues/31113">dotnet/runtime#31113</a>）。现在可以使用代理处理通过 HTTPS发送的请求，这意味着与代理的连接是安全的。这并没有涉及来自代理本身的请求，它仍然可以是 HTTP 或 HTTPS。对于纯文本 HTTP 请求，与 HTTPS 代理的连接是安全的（通过 HTTPS），然后是从代理到目标的纯文本请求。如果是 HTTPS 请求（代理隧道），打开隧道的初始 CONNECT 请求将通过安全通道 (HTTPS) 发送到代理，然后是从代理通过隧道到目的地的 HTTPS 请求。</p> 
<p>如果要利用该功能，只需在设置代理时使用 HTTPS 方案即可：</p> 
<pre><code class="prism language-csharp">
<span class="token keyword">using</span> <span class="token class-name">HttpClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClient</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">SocketsHttpHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">WebProxy</span><span class="token punctuation">(</span><span class="token string">"https://proxy.address:12345"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token class-name">HttpResponseMessage</span> response <span class="token operator">=</span> <span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"https://httpbin.org/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="HttpClientFactory_204"></a>HttpClientFactory</h3> 
<p>.NET 8 扩展了配置 <a href="https://learn.microsoft.com/en-us/dotnet/core/extensions/httpclient-factory" rel="nofollow">HttpClientFactory</a> 的方式，包括客户端默认设置、自定义日志记录和简化的 SocketsHttpHandler 配置。这些 API 在 Microsoft.Extensions.Http 包中实现，该包可在 NuGet 上获取，并包含对 .NET Standard 2.0 的支持。因此，此功能不仅适用于 .NET 8 上的客户端，而且适用于所有版本的 .NET，包括 .NET Framework（唯一的例外是 SocketsHttpHandler 相关 API，仅在 .NET 5+ 中可用）。</p> 
<h4><a id="_207"></a>为所有客户端设置默认值</h4> 
<p>.NET 8 添加了设置默认配置的功能，该配置将用于 HttpClientFactory（<a href="https://github.com/dotnet/runtime/issues/87914">dotnet/runtime#87914</a>）创建的所有 HttpClient。当所有或大多数注册客户端包含相同的配置子集时，这非常有用。</p> 
<p>考虑一个定义了两个命名客户端的示例，它们都需要在其消息处理程序链中使用 MyAuthHandler。</p> 
<pre><code class="prism language-csharp">services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"consoto"</span><span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://consoto.com/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpMessageHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyAuthHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"github"</span><span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://github.com/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpMessageHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyAuthHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>您现在可以使用以下 ConfigureHttpClientDefaults 方法提取公共部分：</p> 
<pre><code class="prism language-csharp">services<span class="token punctuation">.</span><span class="token function">ConfigureHttpClientDefaults</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpMessageHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyAuthHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// both clients will have MyAuthHandler added by default</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"consoto"</span><span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://consoto.com/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"github"</span><span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://github.com/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>所有与 AddHttpClient 一起使用的 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.ihttpclientbuilder?view=dotnet-plat-ext-8.0" rel="nofollow">IHttpClientBuilder</a> 扩展方法也可以在 ConfigureHttpClientDefaults 中使用。</p> 
<p>默认配置 (ConfigureHttpClientDefaults) 在客户端特定 (AddHttpClient) 配置之前应用于所有客户端；它们在注册中的相对位置并不重要。ConfigureHttpClientDefaults 可以注册多次，在这种情况下，配置将按照注册的顺序一一应用。配置的任何部分都可以在特定于客户端的配置中被重写或修改，例如，您可以为 HttpClient 对象或主处理程序设置额外的设置，删除以前添加的额外处理程序等。</p> 
<p>请注意，从 8.0 开始，<a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.httpclientbuilderextensions.configurehttpmessagehandlerbuilder?view=dotnet-plat-ext-8.0" rel="nofollow">ConfigureHttpMessageHandlerBuilder</a> 方法已被弃用。您应该改用 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.httpclientbuilderextensions.configureprimaryhttpmessagehandler?view=dotnet-plat-ext-8.0#microsoft-extensions-dependencyinjection-httpclientbuilderextensions-configureprimaryhttpmessagehandler%28microsoft-extensions-dependencyinjection-ihttpclientbuilder-system-action%28%28system-net-http-httpmessagehandler-system-iserviceprovider%29" rel="nofollow">ConfigurePrimaryHttpMessageHandler</a>(Action&lt;httpmessagehandler,iserviceprovider&lt; span=“”&gt;&gt;))) 或 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.httpclientbuilderextensions.configureadditionalhttpmessagehandlers?view=dotnet-plat-ext-8.0" rel="nofollow">ConfigureAdditionalHttpMessageHandlers</a> 方法，需要分别修改先前配置的主处理程序或附加处理程序列表。</p> 
<pre><code class="prism language-csharp"><span class="token comment">// by default, adds User-Agent header, uses HttpClientHandler with UseCookies=false</span>
<span class="token comment">// as a primary handler, and adds MyAuthHandler to all clients</span>
services<span class="token punctuation">.</span><span class="token function">ConfigureHttpClientDefaults</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span>
    b<span class="token punctuation">.</span><span class="token function">ConfigureHttpClient</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>DefaultRequestHeaders<span class="token punctuation">.</span>UserAgent<span class="token punctuation">.</span><span class="token function">ParseAdd</span><span class="token punctuation">(</span><span class="token string">"HttpClient/8.0"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token function">ConfigurePrimaryHttpMessageHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">HttpClientHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> UseCookies <span class="token operator">=</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddHttpMessageHandler</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MyAuthHandler<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// HttpClient will have both User-Agent (from defaults) and BaseAddress set</span>
<span class="token comment">// + client will have UseCookies=false and MyAuthHandler from defaults</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"modify-http-client"</span><span class="token punctuation">,</span> c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>BaseAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Uri</span><span class="token punctuation">(</span><span class="token string">"https://httpbin.org/"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// primary handler will have both UseCookies=false (from defaults) and MaxConnectionsPerServer set</span>
<span class="token comment">// + client will have User-Agent and MyAuthHandler from defaults</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"modify-primary-handler"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ConfigurePrimaryHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>HttpClientHandler<span class="token punctuation">)</span>h<span class="token punctuation">)</span><span class="token punctuation">.</span>MaxConnectionsPerServer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// MyWrappingHandler will be inserted at the top of the handlers chain</span>
<span class="token comment">// + client will have User-Agent, UseCookies=false and MyAuthHandler from defaults</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"insert-handler-into-chain"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ConfigureAdditionalHttpMessageHandlers</span><span class="token punctuation">(</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        handlers<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">MyWrappingHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// MyAuthHandler (initially from defaults) will be removed from the handler chain</span>
<span class="token comment">// + client will still have User-Agent and UseCookies=false from defaults</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"remove-handler-from-chain"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">ConfigureAdditionalHttpMessageHandlers</span><span class="token punctuation">(</span><span class="token punctuation">(</span>handlers<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
        handlers<span class="token punctuation">.</span><span class="token function">Remove</span><span class="token punctuation">(</span>handlers<span class="token punctuation">.</span><span class="token function">Single</span><span class="token punctuation">(</span>h <span class="token operator">=&gt;</span> h <span class="token keyword">is</span> <span class="token class-name">MyAuthHandler</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h4><a id="_HttpClient__264"></a>修改 HttpClient 日志记录</h4> 
<p>自定义（或者干脆关闭）HttpClientFactory 日志记录是长期请求的功能之一（<a href="https://github.com/dotnet/runtime/issues/77312">dotnet/runtime#77312</a>）。</p> 
<h5><a id="_267"></a>旧日志记录概述</h5> 
<p>HttpClientFactory 添加的默认（“旧”）日志记录非常冗长，每个请求发出 8 条日志消息：</p> 
<ol><li>使用请求 URI 启动通知 —— 在通过委托处理程序管道传播之前；</li><li>请求标头 —— 在处理程序管道之前；</li><li>使用请求 URI 启动通知 —— 在处理程序管道之后；</li><li>请求标头 —— 处理程序管道之后；</li><li>随着时间的流逝停止通知 —— 在通过委托处理程序管道传播回响应之前；</li><li>响应标头 —— 在传播回响应之前；</li><li>随着时间的流逝停止通知 —— 在传播回响应之后；</li><li>响应标头 —— 将响应传播回来之后。</li></ol> 
<p>这可以用下面的图来说明。在下图中，* 和 […] 表示日志记录事件（在默认实现中，日志消息被写入 ILogger），–&gt; 表示通过应用程序层和传输层的数据流。</p> 
<pre><code class="prism language-csharp">Request <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token class-name">Start</span> notification<span class="token punctuation">]</span>    <span class="token comment">// "Start processing HTTP request ..." (1)</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token class-name">Request</span> headers<span class="token punctuation">]</span>       <span class="token comment">// "Request Headers: ..." (2)</span>
      <span class="token operator">--</span><span class="token operator">&gt;</span> Additional Handler #<span class="token number">1</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token range operator">..</span><span class="token range operator">..</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> Additional Handler #N <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token class-name">Start</span> notification<span class="token punctuation">]</span>    <span class="token comment">// "Sending HTTP request ..." (3)</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token class-name">Request</span> headers<span class="token punctuation">]</span>       <span class="token comment">// "Request Headers: ..." (4)</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Transport<span class="token operator">--</span>layer<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-&gt;</span>
                                          <span class="token comment">// Server sends response</span>
                      <span class="token operator">&lt;</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>Transport<span class="token operator">--</span>layer<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
                <span class="token operator">&lt;</span><span class="token operator">--</span> Primary Handler <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token class-name">Stop</span> notification<span class="token punctuation">]</span>    <span class="token comment">// "Received HTTP response ..." (5)</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token class-name">Response</span> headers<span class="token punctuation">]</span>     <span class="token comment">// "Response Headers: ..." (6)</span>
          <span class="token operator">&lt;</span><span class="token operator">--</span> Additional Handler #N <span class="token operator">&lt;</span><span class="token operator">--</span>
        <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token range operator">..</span><span class="token range operator">..</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
      <span class="token operator">&lt;</span><span class="token operator">--</span> Additional Handler #<span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token class-name">Stop</span> notification<span class="token punctuation">]</span>    <span class="token comment">// "End processing HTTP request ..." (7)</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token class-name">Response</span> headers<span class="token punctuation">]</span>     <span class="token comment">// "Response Headers: ..." (8)</span>
  Response <span class="token operator">&lt;</span><span class="token operator">--</span>
</code></pre> 
<p>默认 HttpClientFactory 日志记录的控制台输出如下所示：</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> _httpClientFactory<span class="token punctuation">.</span><span class="token function">CreateClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"https://httpbin.org/get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
info<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>LogicalHandler<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>
      Start processing HTTP request <span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>httpbin<span class="token punctuation">.</span>org<span class="token operator">/</span><span class="token keyword">get</span>
trce<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>LogicalHandler<span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Headers<span class="token punctuation">:</span>
      <span class="token range operator">..</span><span class="token range operator">..</span>
info<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>ClientHandler<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span>
      Sending HTTP request <span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>httpbin<span class="token punctuation">.</span>org<span class="token operator">/</span><span class="token keyword">get</span>
trce<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>ClientHandler<span class="token punctuation">[</span><span class="token number">102</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Headers<span class="token punctuation">:</span>
      <span class="token range operator">..</span><span class="token range operator">..</span>
info<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>ClientHandler<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span>
      Received HTTP response headers after <span class="token number">581</span><span class="token punctuation">.</span>2898ms <span class="token operator">-</span> <span class="token number">200</span>
trce<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>ClientHandler<span class="token punctuation">[</span><span class="token number">103</span><span class="token punctuation">]</span>
      <span class="token class-name">Response</span> Headers<span class="token punctuation">:</span>
      <span class="token range operator">..</span><span class="token range operator">..</span>
info<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>LogicalHandler<span class="token punctuation">[</span><span class="token number">101</span><span class="token punctuation">]</span>
      End processing HTTP request after <span class="token number">618</span><span class="token punctuation">.</span>9736ms <span class="token operator">-</span> <span class="token number">200</span>
trce<span class="token punctuation">:</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpClient<span class="token punctuation">.</span>test<span class="token punctuation">.</span>LogicalHandler<span class="token punctuation">[</span><span class="token number">103</span><span class="token punctuation">]</span>
      <span class="token class-name">Response</span> Headers<span class="token punctuation">:</span>
      <span class="token range operator">..</span><span class="token range operator">..</span>
</code></pre> 
<p>请注意，为了查看跟踪级别消息，您需要在全局日志记录配置文件中选择此选项或通过 SetMinimumLevel(LogLevel.Trace)进行设置 。但即使只考虑信息级别的消息，“旧”日志记录每个请求仍然有 4 条消息。</p> 
<p>要删除默认（或之前添加的）日志记录，您可以使用新的 RemoveAllLoggers() 扩展方法。它与上面“<a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#set-up-defaults-for-all-clients" rel="nofollow">为所有客户端设置默认值</a>”部分中描述的 ConfigureHttpClientDefaults API 结合起来特别强大。这样，您就可以在一行中删除所有客户端的“旧”日志记录：</p> 
<pre><code class="prism language-csharp">services<span class="token punctuation">.</span><span class="token function">ConfigureHttpClientDefaults</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span> b<span class="token punctuation">.</span><span class="token function">RemoveAllLoggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// remove HttpClientFactory default logging for all clients</span>
</code></pre> 
<p>如果您需要恢复“旧”日志记录，例如 针对特定客户端，您可以使用 AddDefaultLogger() 来执行此操作。</p> 
<h5><a id="_339"></a>添加自定义日志记录</h5> 
<p>除了能够删除“旧”日志记录之外，新的 HttpClientFactory API 还允许您完全自定义日志记录。您可以指定当 HttpClient 启动请求、接收响应或引发异常时记录的内容和方式。</p> 
<p>您可以同时添加多个自定义记录器 - 例如，控制台和 ETW 记录器，或<a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#wrapping-and-not-wrapping-loggers" rel="nofollow">“包装”和“不包装”记录器</a>。由于其附加性质，您可能需要事先显式删除默认的“旧”日志记录。</p> 
<p>如果要添加自定义日志记录，您需要实现 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.http.logging.ihttpclientlogger?view=dotnet-plat-ext-8.0" rel="nofollow">IHttpClientLogger</a> 接口，然后使用 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.httpclientbuilderextensions.addlogger?view=dotnet-plat-ext-8.0" rel="nofollow">AddLogger</a> 将自定义记录器添加到客户端。请注意，日志记录实现不应引发任何异常，否则可能会中断请求执行。</p> 
<p>注册：</p> 
<pre><code class="prism language-csharp">services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SimpleConsoleLogger<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// register the logger in DI</span>

services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span> <span class="token comment">// add a client</span>
    <span class="token punctuation">.</span><span class="token function">RemoveAllLoggers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// remove previous logging</span>
    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddLogger</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>SimpleConsoleLogger<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// add the custom logger</span>
</code></pre> 
<p>示例记录器实现：</p> 
<pre><code class="prism language-csharp"><span class="token comment">// outputs one line per request to console</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SimpleConsoleLogger</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHttpClientLogger</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> <span class="token function">LogRequestStart</span><span class="token punctuation">(</span><span class="token class-name">HttpRequestMessage</span> request<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LogRequestStop</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> ctx<span class="token punctuation">,</span> <span class="token class-name">HttpRequestMessage</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpResponseMessage</span> response<span class="token punctuation">,</span> <span class="token class-name">TimeSpan</span> elapsed<span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">request<span class="token punctuation">.</span>Method</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">request<span class="token punctuation">.</span>RequestUri<span class="token punctuation">?.</span>AbsoluteUri</span><span class="token punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>response<span class="token punctuation">.</span>StatusCode</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">response<span class="token punctuation">.</span>StatusCode</span><span class="token punctuation">}</span></span><span class="token string"> in </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">elapsed<span class="token punctuation">.</span>TotalMilliseconds</span><span class="token punctuation">}</span></span><span class="token string">ms"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LogRequestFailed</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> ctx<span class="token punctuation">,</span> <span class="token class-name">HttpRequestMessage</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpResponseMessage<span class="token punctuation">?</span></span> response<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">TimeSpan</span> elapsed<span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">request<span class="token punctuation">.</span>Method</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">request<span class="token punctuation">.</span>RequestUri<span class="token punctuation">?.</span>AbsoluteUri</span><span class="token punctuation">}</span></span><span class="token string"> - Exception </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">e<span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>FullName</span><span class="token punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">e<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>示例输出：</p> 
<pre><code class="prism language-csharp"><span class="token class-name"><span class="token keyword">var</span></span> client <span class="token operator">=</span> _httpClientFactory<span class="token punctuation">.</span><span class="token function">CreateClient</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"https://httpbin.org/get"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">PostAsync</span><span class="token punctuation">(</span><span class="token string">"https://httpbin.org/post"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ByteArrayContent</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token number">42</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"http://httpbin.org/status/500"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">GetAsync</span><span class="token punctuation">(</span><span class="token string">"http://localhost:1234"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-csharp"><span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>httpbin<span class="token punctuation">.</span>org<span class="token operator">/</span><span class="token keyword">get</span> <span class="token operator">-</span> <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">393</span><span class="token punctuation">.</span>2039ms
<span class="token class-name">POST</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>httpbin<span class="token punctuation">.</span>org<span class="token operator">/</span>post <span class="token operator">-</span> <span class="token number">200</span> OK <span class="token keyword">in</span> <span class="token number">95</span><span class="token punctuation">.</span>524ms
<span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>httpbin<span class="token punctuation">.</span>org<span class="token operator">/</span>status<span class="token operator">/</span><span class="token number">500</span> <span class="token operator">-</span> <span class="token number">500</span> InternalServerError <span class="token keyword">in</span> <span class="token number">99</span><span class="token punctuation">.</span>5025ms
<span class="token class-name">GET</span> http<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token punctuation">:</span><span class="token number">1234</span><span class="token operator">/</span> <span class="token operator">-</span> Exception System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>HttpRequestException<span class="token punctuation">:</span> No connection could be made because the target machine actively refused it<span class="token punctuation">.</span> <span class="token punctuation">(</span><span class="token named-parameter punctuation">localhost</span><span class="token punctuation">:</span><span class="token number">1234</span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_387"></a>请求上下文对象</h5> 
<p>您可以使用上下文对象来匹配 LogRequestStart 调用和相应的 LogRequestStop 调用，从而将数据从一个调用传递到另一个调用。上下文对象由 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.http.logging.ihttpclientlogger.logrequeststart?view=dotnet-plat-ext-8.0" rel="nofollow">LogRequestStart</a> 产生，然后传递回 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.http.logging.ihttpclientlogger.logrequeststop?view=dotnet-plat-ext-8.0" rel="nofollow">LogRequestStop</a>。这可以是一个属性包或任何其他保存必要数据的对象。</p> 
<p>如果不需要上下文对象，实现可以从 LogRequestStart 返回 null。</p> 
<p>以下示例显示了如何使用上下文对象来传递自定义请求标识符。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RequestIdLogger</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IHttpClientLogger</span></span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">readonly</span> <span class="token class-name">ILogger</span> _log<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token function">RequestIdLogger</span><span class="token punctuation">(</span><span class="token class-name">ILogger<span class="token punctuation">&lt;</span>RequestIdLogger<span class="token punctuation">&gt;</span></span> log<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
        _log <span class="token operator">=</span> log<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>ILogger<span class="token punctuation">,</span> Guid<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">?</span><span class="token punctuation">,</span> Exception<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> _requestStart <span class="token operator">=</span>
        LoggerMessage<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Define</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Guid<span class="token punctuation">,</span> <span class="token keyword">string</span><span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            LogLevel<span class="token punctuation">.</span>Information<span class="token punctuation">,</span>
            EventIds<span class="token punctuation">.</span>RequestStart<span class="token punctuation">,</span>
            <span class="token string">"Request Id={RequestId} ({Host}) started"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>ILogger<span class="token punctuation">,</span> Guid<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">,</span> Exception<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> _requestStop <span class="token operator">=</span>
        LoggerMessage<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Define</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Guid<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            LogLevel<span class="token punctuation">.</span>Information<span class="token punctuation">,</span>
            EventIds<span class="token punctuation">.</span>RequestStop<span class="token punctuation">,</span>
            <span class="token string">"Request Id={RequestId} succeeded in {elapsed}ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Action<span class="token punctuation">&lt;</span>ILogger<span class="token punctuation">,</span> Guid<span class="token punctuation">,</span> Exception<span class="token punctuation">?</span><span class="token punctuation">&gt;</span></span> _requestFailed <span class="token operator">=</span>
        LoggerMessage<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Define</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>Guid<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>
            LogLevel<span class="token punctuation">.</span>Error<span class="token punctuation">,</span>
            EventIds<span class="token punctuation">.</span>RequestFailed<span class="token punctuation">,</span>
            <span class="token string">"Request Id={RequestId} FAILED"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> <span class="token function">LogRequestStart</span><span class="token punctuation">(</span><span class="token class-name">HttpRequestMessage</span> request<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name"><span class="token keyword">var</span></span> ctx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Context</span><span class="token punctuation">(</span>Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">_requestStart</span><span class="token punctuation">(</span>_log<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>RequestId<span class="token punctuation">,</span> request<span class="token punctuation">.</span>RequestUri<span class="token punctuation">?.</span>Host<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LogRequestStop</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> ctx<span class="token punctuation">,</span> <span class="token class-name">HttpRequestMessage</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpResponseMessage</span> response<span class="token punctuation">,</span> <span class="token class-name">TimeSpan</span> elapsed<span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token function">_requestStop</span><span class="token punctuation">(</span>_log<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Context<span class="token punctuation">)</span>ctx<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">.</span>RequestId<span class="token punctuation">,</span> elapsed<span class="token punctuation">.</span>TotalMilliseconds<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">LogRequestFailed</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> ctx<span class="token punctuation">,</span> <span class="token class-name">HttpRequestMessage</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpResponseMessage<span class="token punctuation">?</span></span> response<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">TimeSpan</span> elapsed<span class="token punctuation">)</span>
<span class="token operator">=&gt;</span> <span class="token function">_requestFailed</span><span class="token punctuation">(</span>_log<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Context<span class="token punctuation">)</span>ctx<span class="token operator">!</span><span class="token punctuation">)</span><span class="token punctuation">.</span>RequestId<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">EventIds</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">EventId</span> RequestStart <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"RequestStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">EventId</span> RequestStop <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"RequestStop"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">EventId</span> RequestFailed <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">"RequestFailed"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">record</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token class-name">Guid</span> RequestId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-csharp">
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span>d0d63b84<span class="token operator">-</span>cd67<span class="token operator">-</span>4d21<span class="token operator">-</span>ae9a<span class="token operator">-</span>b63d26dfde50 <span class="token punctuation">(</span>httpbin<span class="token punctuation">.</span>org<span class="token punctuation">)</span> <span class="token class-name">started</span>
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span>d0d63b84<span class="token operator">-</span>cd67<span class="token operator">-</span>4d21<span class="token operator">-</span>ae9a<span class="token operator">-</span><span class="token class-name">b63d26dfde50</span> succeeded <span class="token keyword">in</span> <span class="token number">530</span><span class="token punctuation">.</span>1664ms
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span><span class="token number">09403213</span><span class="token operator">-</span>dd3a<span class="token operator">-</span><span class="token number">4101</span><span class="token operator">-</span><span class="token number">88e8</span><span class="token operator">-</span>db8ab19e1eeb <span class="token punctuation">(</span>httpbin<span class="token punctuation">.</span>org<span class="token punctuation">)</span> <span class="token class-name">started</span>
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span><span class="token number">09403213</span><span class="token operator">-</span>dd3a<span class="token operator">-</span><span class="token number">4101</span><span class="token operator">-</span><span class="token number">88e8</span><span class="token operator">-</span><span class="token class-name">db8ab19e1eeb</span> succeeded <span class="token keyword">in</span> <span class="token number">83</span><span class="token punctuation">.</span>2484ms
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span>254e49bd<span class="token operator">-</span>f640<span class="token operator">-</span>4c56<span class="token operator">-</span>b62f<span class="token operator">-</span>5de678eca129 <span class="token punctuation">(</span>httpbin<span class="token punctuation">.</span>org<span class="token punctuation">)</span> <span class="token class-name">started</span>
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span>254e49bd<span class="token operator">-</span>f640<span class="token operator">-</span>4c56<span class="token operator">-</span>b62f<span class="token operator">-</span>5de678eca129 succeeded <span class="token keyword">in</span> <span class="token number">162</span><span class="token punctuation">.</span>7776ms
info<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">Request</span> Id<span class="token operator">=</span>e25ccb08<span class="token operator">-</span>b97e<span class="token operator">-</span><span class="token number">400d</span><span class="token operator">-</span>b42b<span class="token operator">-</span>b09d6c42adec <span class="token punctuation">(</span>localhost<span class="token punctuation">)</span> <span class="token class-name">started</span>
fail<span class="token punctuation">:</span> RequestIdLogger<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
      Куйгуые Шв<span class="token operator">=</span>у<span class="token number">25</span>сси<span class="token number">08</span><span class="token operator">-</span>и<span class="token number">97</span>у<span class="token operator">-</span><span class="token number">400</span>в<span class="token operator">-</span>и<span class="token number">42</span>и<span class="token operator">-</span>и<span class="token number">09</span>в<span class="token number">6</span>с<span class="token number">42</span>фвус АФШДУВ
</code></pre> 
<h5><a id="_466"></a>避免从内容流中读取</h5> 
<p>如果您打算读取和记录（例如：请求和响应内容），请注意，它可能会对最终用户体验产生不利的副作用并导致错误。例如，请求内容可能在发送之前被消耗，或者巨大的响应内容可能最终被缓冲在内存中。此外，在 .NET 7 之前，访问标头不是线程安全的，可能会导致错误和意外行为。</p> 
<h5><a id="_469"></a>谨慎使用异步日志记录</h5> 
<p>我们预计同步 IHttpClientLogger 接口适用于绝大多数自定义日志记录用例。出于性能原因，建议不要在日志记录中使用异步。但是，如果严格要求日志记录中的异步访问，您可以实现异步版本 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.http.logging.ihttpclientasynclogger?view=dotnet-plat-ext-8.0" rel="nofollow">IHttpClientAsyncLogger</a>。它派生自 IHttpClientLogger，因此可以使用相同的 AddLogger API 进行注册。</p> 
<p>请注意，在这种情况下，还应该实现日志记录方法的同步对应项，特别是如果该实现是面向 .NET Standard 或 .NET 5+ 的库的一部分。同步对应项是从同步 HttpClient.Send 方法调用的；即使 .NET Standard 表面不包含它们，.NET Standard 库也可以在 .NET 5+ 应用程序中使用，因此最终用户可以访问同步 HttpClient.Send 方法。</p> 
<h5><a id="_474"></a>包装和不包装记录器</h5> 
<p>当您添加记录器时，您可以显式设置 wrapHandlersPipeline 参数来指定记录器是否将被</p> 
<ul><li>包装处理程序管道（添加到管道的顶部，对应于上面<a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#old-logging-overview" rel="nofollow">旧日志记录概述部分</a>中的 1、2、7 和 8 号消息）</li></ul> 
<pre><code class="prism language-csharp">  Request <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStart</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>                <span class="token comment">// wrapHandlersPipeline=TRUE</span>
      <span class="token operator">--</span><span class="token operator">&gt;</span> Additional Handlers #<span class="token number">1</span><span class="token range operator">..</span>N <span class="token operator">--</span><span class="token operator">&gt;</span>    <span class="token comment">// handlers pipeline</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Transport<span class="token operator">--</span>layer<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
          <span class="token operator">&lt;</span><span class="token operator">--</span> Primary Handler <span class="token operator">&lt;</span><span class="token operator">--</span>
      <span class="token operator">&lt;</span><span class="token operator">--</span> Additional Handlers #N<span class="token range operator">..</span><span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">--</span>    <span class="token comment">// handlers pipeline</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStop</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>                 <span class="token comment">// wrapHandlersPipeline=TRUE</span>
  Response <span class="token operator">&lt;</span><span class="token operator">--</span>
</code></pre> 
<ul><li>或者，不包装处理程序管道（添加到底部，对应于上面<a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#old-logging-overview" rel="nofollow">旧日志记录概述部分</a>中的第 3、4、5 和 6 号消息）。</li></ul> 
<pre><code class="prism language-csharp">  Request <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">--</span><span class="token operator">&gt;</span> Additional Handlers #<span class="token number">1</span><span class="token range operator">..</span>N <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">// handlers pipeline</span>
<span class="token operator">*</span>     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStart</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>             <span class="token comment">// wrapHandlersPipeline=FALSE</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>Transport<span class="token operator">--</span>layer<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
          <span class="token operator">&lt;</span><span class="token operator">--</span> Primary Handler <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>     <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStop</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>              <span class="token comment">// wrapHandlersPipeline=FALSE</span>
    <span class="token operator">&lt;</span><span class="token operator">--</span> Additional Handlers #N<span class="token range operator">..</span><span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token comment">// handlers pipeline</span>
  Response <span class="token operator">&lt;</span><span class="token operator">--</span>
</code></pre> 
<p>默认情况下，记录器被添加为不包装。</p> 
<p>在向管道添加重试处理程序的情况下（例如 Polly 或某些自定义重试实现），包装和不包装管道之间的区别最为显着。在这种情况下，包装记录器（位于顶部）将记录有关单个成功请求的消息，记录的经过时间将是从用户发起请求到收到响应的总时间。非包装记录器（位于底部）将记录每次重试迭代，最初的迭代可能记录异常或不成功的状态代码，最后一个记录成功。每种情况消耗的时间纯粹是在主处理程序中花费的时间（实际在网络上发送请求的处理程序，例如 HttpClientHandler）。</p> 
<p>这可以用下图来说明：</p> 
<ul><li>包装案例（wrapHandlersPipeline=TRUE）</li></ul> 
<pre><code class="prism language-csharp">Request <span class="token operator">--</span><span class="token operator">&gt;</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStart</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> Additional Handlers #<span class="token number">1</span><span class="token range operator">..</span><span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">--</span><span class="token operator">&gt;</span> Retry Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
              <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//1</span>
                  <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token string">"503 Service Unavailable"</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
              <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//2</span>
                  <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">-&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token string">"503 Service Unavailable"</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
              <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//3</span>
                  <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token string">"200 OK"</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
            <span class="token operator">&lt;</span><span class="token operator">--</span> Retry Handler <span class="token operator">&lt;</span><span class="token operator">--</span>
        <span class="token operator">&lt;</span><span class="token operator">--</span> Additional Handlers #<span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token range operator">..</span><span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStop</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
  Response <span class="token operator">&lt;</span><span class="token operator">--</span>

info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>Wrapping<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>consoto<span class="token punctuation">.</span>com<span class="token operator">/</span>
info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>Wrapping<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token number">200</span> OK <span class="token operator">-</span> <span class="token number">809</span><span class="token punctuation">.</span>2135ms
</code></pre> 
<ul><li>不包装案例（wrapHandlersPipeline=FALSE）</li></ul> 
<pre><code class="prism language-csharp">Request <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">--</span><span class="token operator">&gt;</span> Additional Handlers #<span class="token number">1</span><span class="token range operator">..</span><span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">--</span><span class="token operator">&gt;</span> Retry Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//1</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStart</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token string">"503 Service Unavailable"</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStop</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//2</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStart</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token string">"503 Service Unavailable"</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStop</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
          <span class="token operator">--</span><span class="token operator">&gt;</span> <span class="token comment">//3</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStart</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
                <span class="token operator">--</span><span class="token operator">&gt;</span> Primary Handler <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">--</span> <span class="token string">"200 OK"</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
<span class="token operator">*</span>           <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">LogRequestStop</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
        <span class="token operator">&lt;</span><span class="token operator">--</span> Retry Handler <span class="token operator">&lt;</span><span class="token operator">--</span>
    <span class="token operator">&lt;</span><span class="token operator">--</span> Additional Handlers #<span class="token punctuation">(</span>N<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token range operator">..</span><span class="token number">1</span> <span class="token operator">&lt;</span><span class="token operator">--</span>
  Response <span class="token operator">&lt;</span><span class="token operator">--</span>
</code></pre> 
<pre><code class="prism language-csharp">info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>NotWrapping<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>consoto<span class="token punctuation">.</span>com<span class="token operator">/</span>
info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>NotWrapping<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token number">503</span> Service Unavailable <span class="token operator">-</span> <span class="token number">98</span><span class="token punctuation">.</span>613ms
info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>NotWrapping<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>consoto<span class="token punctuation">.</span>com<span class="token operator">/</span>
info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>NotWrapping<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token number">503</span> Service Unavailable <span class="token operator">-</span> <span class="token number">96</span><span class="token punctuation">.</span>1932ms
info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>NotWrapping<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
      <span class="token class-name">GET</span> https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>consoto<span class="token punctuation">.</span>com<span class="token operator">/</span>
info<span class="token punctuation">:</span> Example<span class="token punctuation">.</span>CustomLogger<span class="token punctuation">.</span>NotWrapping<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
      <span class="token number">200</span> OK <span class="token operator">-</span> <span class="token number">579</span><span class="token punctuation">.</span>2133ms
</code></pre> 
<h4><a id="_SocketsHttpHandler__577"></a>简化的 SocketsHttpHandler 配置</h4> 
<p>.NET 8 添加了更方便、更流畅的方式来使用 SocketsHttpHandler 作为 HttpClientFactory 中的主处理程序（<a href="https://github.com/dotnet/runtime/issues/84075">dotnet/runtime#84075</a>）。</p> 
<p>您可以使用 <a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.extensions.dependencyinjection.httpclientbuilderextensions.usesocketshttphandler?view=dotnet-plat-ext-8.0" rel="nofollow">UseSocketsHttpHandler</a> 方法设置和配置 SocketsHttpHandler。您可以使用 IConfiguration 从配置文件设置 SocketsHttpHandler 属性，也可以从代码中配置它，或者可以结合使用这两种方法。</p> 
<p>请注意，将 IConfiguration 应用于 SocketsHttpHandler 时，仅解析 bool、int、Enum 或 TimeSpan 类型的 SocketsHttpHandler 属性。IConfiguration 中所有不匹配的属性都将被忽略。配置仅在注册时解析一次并且不会重新加载，因此在应用程序重新启动之前，处理程序不会反映任何配置文件更改。</p> 
<pre><code class="prism language-csharp"><span class="token comment">// sets up properties on the handler directly</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"foo"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UseSocketsHttpHandler</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> h<span class="token punctuation">.</span>UseCookies <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// uses a builder to combine approaches</span>
services<span class="token punctuation">.</span><span class="token function">AddHttpClient</span><span class="token punctuation">(</span><span class="token string">"bar"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">UseSocketsHttpHandler</span><span class="token punctuation">(</span>b <span class="token operator">=&gt;</span>
        b<span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"HttpClient:bar"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// loads simple properties from config</span>
         <span class="token punctuation">.</span><span class="token function">Configure</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token comment">// sets up SslOptions in code</span>
         <span class="token punctuation">{<!-- --></span>
            h<span class="token punctuation">.</span>SslOptions<span class="token punctuation">.</span>RemoteCertificateValidationCallback <span class="token operator">=</span> <span class="token keyword">delegate</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">{<!-- --></span>
  <span class="token string">"HttpClient"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">"bar"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
      <span class="token string">"AllowAutoRedirect"</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token string">"UseCookies"</span><span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token string">"ConnectTimeout"</span><span class="token punctuation">:</span> <span class="token string">"00:00:05"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="QUIC_610"></a>QUIC</h3> 
<h4><a id="OpenSSL_3__612"></a>OpenSSL 3 支持</h4> 
<p>当前大多数 Linux 发行版在其最新版本中都采用了 OpenSSL 3：</p> 
<ul><li>Debian 12+：<a href="https://packages.debian.org/bookworm/openssl" rel="nofollow">Bookworm OpenSSL</a></li><li>Ubuntu 22+：<a href="https://packages.ubuntu.com/jammy/openssl" rel="nofollow">Jammy OpenSSL</a></li><li>Fedora 37+：<a href="https://packages.fedoraproject.org/pkgs/openssl/openssl/" rel="nofollow">Fedora OpenSSL</a></li><li>OpenSUSE：<a href="https://software.opensuse.org/package/openssl" rel="nofollow">Tumbleweed OpenSSL</a></li><li>AlmaLinux 9+：<a href="http://repo.almalinux.org/almalinux/9/BaseOS/x86_64/os/Packages/" rel="nofollow">AlmaLinux 9 软件包存储库</a></li></ul> 
<p>.NET 8 的 QUIC 支持已准备就绪（<a href="https://github.com/dotnet/runtime/issues/81801">dotnet/runtime#81801</a>）。</p> 
<p>实现这一目标的第一步是确保 System.Net.Quic 下使用的 QUIC 实现 <a href="https://github.com/microsoft/msquic">MsQuic</a> 可以与 OpenSSL 3+ 一起使用。这项工作在 MsQuic 存储库 <a href="https://github.com/microsoft/msquic/issues/2039">microsoft/msquic#2039</a> 中进行。下一步是确保构建并发布的 libmsquic 包相应的依赖于特定发行版和版本的默认 OpenSSL 版本。例如 Debian 发行版：</p> 
<ul><li><a href="https://packages.microsoft.com/debian/11/prod/pool/main/libm/libmsquic/" rel="nofollow">Debian 11 libmsquic</a> 依赖于 OpenSSL 1.1</li><li><a href="https://packages.microsoft.com/debian/12/prod/pool/main/libm/libmsquic/" rel="nofollow">Debian 12 libmsquic</a> 依赖于 OpenSSL 3</li></ul> 
<p>最后一步是确保正在测试的MsQuic 和 OpenSSL版本正确，并且测试覆盖了所有 .NET 支持的发行版。</p> 
<h4><a id="_629"></a>异常</h4> 
<p>在 .NET 7 中发布 QUIC API（作为<a href="https://github.com/dotnet/designs/blob/main/accepted/2021/preview-features/preview-features.md">预览功能</a>）后，我们收到了几个有关异常的问题：</p> 
<ul><li> <p><a href="https://github.com/dotnet/runtime/issues/78751">dotnet/runtime#78751</a>：<br> 找不到主机时 QuicConnection.ConnectAsync 引发 SocketException</p> </li><li> <p><a href="https://github.com/dotnet/runtime/issues/78096">dotnet/runtime#78096</a>：<br> QuicListener AcceptConnectionAsync 和 OperationCanceledException</p> </li><li> <p><a href="https://github.com/dotnet/runtime/issues/75115">dotnet/runtime#75115</a>：QuicListener.AcceptConnectionAsync 重新抛出异常</p> </li></ul> 
<p>在 .NET 8 中，System.Net.Quic 异常行为在 <a href="https://github.com/dotnet/runtime/issues/82262">dotnet/runtime#82262</a> 中进行了彻底修改，并且解决了上述问题。</p> 
<p>修订的主要目标之一是确保 System.Net.Quic 中的异常行为在整个命名空间中尽可能一致。总的来说，当前的行为可以总结如下：</p> 
<ul><li> <p>QuicException：特定于 QUIC 协议或与其处理相关的所有错误。</p> 
  <ul><li>连接由本地或由对等方关闭。</li><li>连接因不活动而超时。</li><li>流被本地或由对等方中止。</li><li><a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicerror?view=net-8.0" rel="nofollow">QuicError</a> 中描述的其他错误</li></ul> </li><li> <p>SocketException：针对网络问题，例如网络状况、名称解析或用户错误。</p> 
  <ul><li>地址已被使用。</li><li>无法访问目标主机。</li><li>指定的地址无效。</li><li>无法解析主机名。</li></ul> </li><li> <p>AuthenticationException：所有与 TLS 相关的问题。目标是具有与 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.security.sslstream?view=net-8.0" rel="nofollow">SslStream</a> 类似的行为。</p> 
  <ul><li>证书相关错误。</li><li>ALPN 协商错误。</li><li>握手期间用户取消。</li></ul> </li><li> <p>ArgumentException：当提供 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicconnectionoptions?view=net-8.0" rel="nofollow">QuicConnectionOptions</a> 或 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quiclisteneroptions?view=net-8.0" rel="nofollow">QuicListenerOptions</a> 无效时。</p> 
  <ul><li>提供的流限制不在 0-65535 范围内。</li><li>省略强制属性，例如：<a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicconnectionoptions.defaultcloseerrorcode?view=net-8.0#system-net-quic-quicconnectionoptions-defaultcloseerrorcode" rel="nofollow">DefaultCloseErrorCode</a> 或 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicconnectionoptions.defaultstreamerrorcode?view=net-8.0#system-net-quic-quicconnectionoptions-defaultstreamerrorcode" rel="nofollow">DefaultStreamErrorCode</a>。</li><li>未指定 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicclientconnectionoptions.clientauthenticationoptions?view=net-8.0" rel="nofollow">ClientAuthenticationOptions</a> 或 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicserverconnectionoptions.serverauthenticationoptions?view=net-8.0" rel="nofollow">ServerAuthenticationOptions</a>。</li></ul> </li><li> <p>OperationCanceledException：每当 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.threading.cancellationtoken?view=net-8.0" rel="nofollow">CancellationToken</a> 被触发时取消。</p> </li><li> <p>ObjectDisposedException：每当在已释放的对象上调用方法时。</p> </li></ul> 
<p>请注意，上述示例并不详尽。</p> 
<p>除了改变行为之外，<a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicexception?view=net-8.0" rel="nofollow">QuicException</a> 也发生了改变。其中一项变化是调整 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicerror?view=net-8.0" rel="nofollow">QuicError</a> 枚举值。现在 SocketException 涵盖的项目已被删除，并为用户回调错误添加了一个新值（<a href="https://github.com/dotnet/runtime/issues/87259">dotnet/runtime#87259</a>）。新添加的 CallbackError 用于区分</p> 
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quiclisteneroptions.connectionoptionscallback?view=net-8.0#system-net-quic-quiclisteneroptions-connectionoptionscallback" rel="nofollow">QuicListenerOptions.ConnectionOptionsCallback</a> 引发的异常与 System.Net.Quic 引发的异常（<a href="https://github.com/dotnet/runtime/pull/88614">dotnet/runtime#88614</a>）。因此，如果用户代码抛出 ArgumentException，<a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quiclistener.acceptconnectionasync?view=net-8.0" rel="nofollow">QuicListener.AcceptConnectionAsync</a> 会将其包装在 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicexception?view=net-8.0" rel="nofollow">QuicException</a> 中，并将 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicexception.quicerror?view=net-8.0" rel="nofollow">QuicError</a> 设置为 CallbackError，并且内部异常将包含原始用户抛出的异常。它可以这样使用：</p> 
<pre><code class="prism language-csharp"><span class="token keyword">await</span> <span class="token keyword">using</span> <span class="token class-name"><span class="token keyword">var</span></span> listener <span class="token operator">=</span> <span class="token keyword">await</span> QuicListener<span class="token punctuation">.</span><span class="token function">ListenAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QuicListenerOptions</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// ...</span>
    ConnectionOptionsCallback <span class="token operator">=</span> <span class="token punctuation">(</span>con<span class="token punctuation">,</span> hello<span class="token punctuation">,</span> token<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>blockedServers<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>hello<span class="token punctuation">.</span>ServerName<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Connection attempt from forbidden server: '</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">hello<span class="token punctuation">.</span>ServerName</span><span class="token punctuation">}</span></span><span class="token string">'."</span></span><span class="token punctuation">,</span> <span class="token keyword">nameof</span><span class="token punctuation">(</span>hello<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> ValueTask<span class="token punctuation">.</span><span class="token function">FromResult</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">QuicServerConnectionOptions</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// ...</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">try</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">await</span> listener<span class="token punctuation">.</span><span class="token function">AcceptConnectionAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">QuicException</span> ex<span class="token punctuation">)</span> <span class="token keyword">when</span> <span class="token punctuation">(</span>ex<span class="token punctuation">.</span>QuicError <span class="token operator">==</span> QuicError<span class="token punctuation">.</span>CallbackError <span class="token operator">&amp;&amp;</span> ex<span class="token punctuation">.</span>InnerException <span class="token keyword">is</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"Blocked connection attempt from forbidden server: </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ex<span class="token punctuation">.</span>InnerException<span class="token punctuation">.</span>Message</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>异常部分的最后一个更改是将传输错误代码添加到 QuicException 中（<a href="https://github.com/dotnet/runtime/pull/88550">dotnet/runtime#88550</a>）。传输错误代码由 <a href="https://www.rfc-editor.org/rfc/rfc9000.html#name-transport-error-codes" rel="nofollow">RFC 9000 传输错误代码</a>定义，并且 <a href="https://github.com/microsoft/msquic">MsQuic</a> 的 System.Net.Quic 已经可以使用它们，只是没有公开。因此，QuicException 中添加了一个新的可为 null 的属性：<a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.quic.quicexception.transporterrorcode?view=net-8.0" rel="nofollow">TransportErrorCode</a>。我们要感谢社区贡献者 <a href="https://github.com/AlexRadch">AlexRach</a>，他在 <a href="https://github.com/dotnet/runtime/pull/88614">dotnet/runtime#88614</a> 中实现了这一更改。</p> 
<h3><a id="Socket_707"></a>Socket</h3> 
<p>Socket 空间中影响最大的更改是显着减少无连接（UDP） Socket 的分配（<a href="https://github.com/dotnet/runtime/issues/30797">dotnet/runtime#30797</a>）。使用 UDP Socket 时，分配的最大贡献者之一是在每次调用 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.sockets.socket.receivefrom?view=net-8.0" rel="nofollow">Socket.ReceiveFrom</a> 时分配一个新的 EndPoint 对象（并支持 IPAddress 等分配）。为了缓解这个问题，引入了一组使用 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.socketaddress?view=net-8.0" rel="nofollow">SocketAddress</a> 的新 API（<a href="https://github.com/dotnet/runtime/issues/87397">dotnet/runtime#87397</a>）。SocketAddress 在内部将 IP 地址保存为平台相关形式的字节数组，以便可以将其直接传递给操作系统调用。因此，在调用本机 Socket 函数之前不需要复制 IP 地址数据。</p> 
<p>此外，新添加的 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.sockets.socket.receivefrom?view=net-8.0#system-net-sockets-socket-receivefrom%28system-span%28%28system-byte%29" rel="nofollow">ReceiveFrom</a>-system-net-sockets-socketflags-system-net-socketaddress)) 和 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.sockets.socket.receivefromasync?view=net-8.0#system-net-sockets-socket-receivefromasync%28system-memory%28%28system-byte%29" rel="nofollow">ReceiveFromAsync</a>-system-net-sockets-socketflags-system-net-socketaddress-system-threading-cancellationtoken)) 重载不会在每次调用时实例化新的 IPEndPoint，而是在适当的位置改变提供的 receiveAddress 参数。所有这些一起可以用来提高 UDP Socket 代码的效率：</p> 
<pre><code class="prism language-csharp">
<span class="token comment">// Same initialization code as before, no change here.</span>
<span class="token class-name">Socket</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Dgram<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Udp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Socket</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Dgram<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Udp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> message <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span><span class="token string">"Hello world!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token class-name">IPEndPoint</span> endpoint <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span>Loopback<span class="token punctuation">,</span> <span class="token number">12345</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// --------</span>
<span class="token comment">// Original code that would allocate IPEndPoint for each ReceiveFromAsync:</span>
<span class="token class-name">Task<span class="token punctuation">&lt;</span>SocketReceiveFromResult<span class="token punctuation">&gt;</span></span> receiveTaskOrig <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">ReceiveFromAsync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">SendToAsync</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">,</span> endpoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SocketReceiveFromResult</span> resultOrig <span class="token operator">=</span> <span class="token keyword">await</span> receiveTaskOrig<span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>ReceivedBytes<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" from "</span> <span class="token operator">+</span> result<span class="token punctuation">.</span>RemoteEndPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints:</span>
<span class="token comment">// Hello world! from 127.0.0.1:59769</span>

<span class="token comment">// --------</span>
<span class="token comment">// New variables that can be re-used for subsequent calls:</span>
<span class="token class-name">SocketAddress</span> receivedAddress <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">SocketAddress</span> targetAddress <span class="token operator">=</span> endpoint<span class="token punctuation">.</span><span class="token function">Serialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// New code that will mutate provided SocketAddress for each ReceiveFromAsync:</span>
<span class="token class-name">ValueTask<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">&gt;</span></span> receiveTaskNew <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">ReceiveFromAsync</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">,</span> receivedAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> client<span class="token punctuation">.</span><span class="token function">SendToAsync</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">,</span> targetAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> length <span class="token operator">=</span> <span class="token keyword">await</span> receiveTaskNew<span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>UTF8<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" from "</span> <span class="token operator">+</span> receivedAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints:</span>
<span class="token comment">// Hello world! from InterNetwork:16:{233,121,127,0,0,1,0,0,0,0,0,0,0,0}</span>
</code></pre> 
<p>最重要的是，在 <a href="https://github.com/dotnet/runtime/issues/86872">dotnet/runtime#86872</a> 中改进了 SocketAddress 的使用。SocketAddress 现在有几个额外的成员，使其本身更有用：</p> 
<ul><li>getter <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.socketaddress.buffer?view=net-8.0" rel="nofollow">Buffer</a>：访问整个底层地址缓冲区。</li><li>setter <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.socketaddress.size?view=net-8.0" rel="nofollow">Size</a>：能够调整上述缓冲区大小（只能调整到较小的尺寸）。</li><li>static <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.socketaddress.getmaximumaddresssize?view=net-8.0" rel="nofollow">GetMaximumAddressSize</a>：根据地址类型获取所需的缓冲区大小。</li><li>接口 IEquatable&lt;socketaddress&lt; span=“”&gt;&gt;：SocketAddress 可用于区分 Socket 与之通信的对等点，例如作为字典中的键（这不是新功能，它只是使其可通过接口调用）。</li></ul> 
<p>最后，删除了一些内部生成的 IP 地址数据副本，以提高性能。</p> 
<h3><a id="Networking_Primitives_754"></a>Networking Primitives</h3> 
<h4><a id="MIME__756"></a>MIME 类型</h4> 
<p>添加缺失的 MIME 类型是网络空间中投票最多的问题之一（<a href="https://github.com/dotnet/runtime/issues/1489">dotnet/runtime#1489</a>）。这是一个主要由社区驱动的更改，最终形成了 <a href="https://github.com/dotnet/runtime/issues/85807">dotnet/runtime#85807 API</a> 提案。由于此添加需要经过 API 审核流程，因此有必要确保添加的类型是相关的并遵循规范（<a href="https://www.iana.org/assignments/media-types/media-types.xhtml" rel="nofollow">IANA 媒体类型</a>）。对于这项准备工作，我们要感谢社区贡献者 <a href="https://github.com/Bilal-io">Bilal-io</a> 和 <a href="https://github.com/mmarinchenko">mmarinchenko</a>。</p> 
<h4><a id="IPNetwork_759"></a>IPNetwork</h4> 
<p>.NET 8 中添加的另一个新 API 是新类型 IPNetwork（<a href="https://github.com/dotnet/runtime/issues/79946">dotnet/runtime#79946</a>）。该结构允许指定 <a href="https://datatracker.ietf.org/doc/html/rfc4632" rel="nofollow">RFC 4632</a> 中定义的无类 IP 子网。例如：</p> 
<ul><li>127.0.0.0/8 用于与 A 类子网对应的无类定义。</li><li>42.42.128.0/17 用于 215 个地址的无类子网。</li><li>2a01:110:8012::/100 用于 228 个地址的 IPv6 子网。</li></ul> 
<p>新的 API 可以使用<a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.ipnetwork.-ctor?view=net-8.0#system-net-ipnetwork-ctor%28system-net-ipaddress-system-int32%29" rel="nofollow">构造函数</a>从 IPAddress 和前缀长度进行构造，也可以通过 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.ipnetwork.tryparse?view=net-8.0" rel="nofollow">TryParse</a> 或 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.ipnetwork.parse?view=net-8.0" rel="nofollow">Parse</a> 从字符串进行解析。最重要的是，它允许使用 <a href="https://learn.microsoft.com/en-us/dotnet/api/system.net.ipnetwork.contains?view=net-8.0" rel="nofollow">Contains</a> 方法检查 IPAddress 是否属于子网。示例用法如下：</p> 
<pre><code class="prism language-csharp">
<span class="token comment">// IPv4 with manual construction.</span>
<span class="token class-name">IPNetwork</span> ipNet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPNetwork</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IPAddress</span> ip1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IPAddress</span> ip2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPAddress</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token number">127</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ip1</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token punctuation">(</span>ipNet<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>ip1<span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">"belongs"</span> <span class="token punctuation">:</span> <span class="token string">"doesn't belong"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ipNet</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ip2</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token punctuation">(</span>ipNet<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>ip2<span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">"belongs"</span> <span class="token punctuation">:</span> <span class="token string">"doesn't belong"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ipNet</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints:</span>
<span class="token comment">// 255.0.0.1 doesn't belong to 127.0.0.0/8</span>
<span class="token comment">// 127.0.0.10 belongs to 127.0.0.0/8</span>

<span class="token comment">// IPv6 with parsing.</span>
<span class="token class-name">IPNetwork</span> ipNet <span class="token operator">=</span> IPNetwork<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"2a01:110:8012::/96"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IPAddress</span> ip1 <span class="token operator">=</span> IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"2a01:110:8012::1742:4244"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IPAddress</span> ip2 <span class="token operator">=</span> IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"2a01:110:8012:1010:914e:2451:16ff:ffff"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ip1</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token punctuation">(</span>ipNet<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>ip1<span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">"belongs"</span> <span class="token punctuation">:</span> <span class="token string">"doesn't belong"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ipNet</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ip2</span><span class="token punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp"><span class="token punctuation">(</span>ipNet<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>ip2<span class="token punctuation">)</span> <span class="token punctuation">?</span> <span class="token string">"belongs"</span> <span class="token punctuation">:</span> <span class="token string">"doesn't belong"</span><span class="token punctuation">)</span></span><span class="token punctuation">}</span></span><span class="token string"> to </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token expression language-csharp">ipNet</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Prints:</span>
<span class="token comment">// 2a01:110:8012::1742:4244 belongs to 2a01:110:8012::/96</span>
<span class="token comment">// 2a01:110:8012:1010:914e:2451:16ff:ffff doesn't belong to 2a01:110:8012::/96</span>
</code></pre> 
<p>请注意，不要将此类型与自 1.0 以来 ASP.NET Core 中存在的</p> 
<p><a href="https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.httpoverrides.ipnetwork?view=aspnetcore-8.0" rel="nofollow">Microsoft.AspNetCore.HttpOverrides.IPNetwork</a> 类混淆。我们预计 ASP.NET API 最终将迁移到新的 System.Net.IPNetwork 类型（<a href="https://github.com/dotnet/aspnetcore/issues/46157">dotnet/aspnetcore#46157</a>）。</p> 
<h3><a id="_793"></a>最后说明</h3> 
<p>本文选择的主题并不是 .NET 8 中所有更改的详尽列表，只是我们认为最有趣的内容。如果您对性能改进更感兴趣，您可以查看 Stephen 的大型性能博客文章中的<a href="https://devblogs.microsoft.com/dotnet/performance-improvements-in-net-8/#networking" rel="nofollow">网络部分</a>。如果您有任何疑问或发现任何错误，可以在 <a href="https://github.com/dotnet/runtime/issues">dotnet/runtime 存储库</a>中与我们联系。</p> 
<p>最后，我要感谢我的合著者：</p> 
<ul><li><a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#metrics" rel="nofollow">Metrics</a> 的作者：<a href="https://github.com/antonfirsov">@antonfirsov</a>。</li><li><a href="https://devblogs.microsoft.com/dotnet/dotnet-8-networking-improvements/#httpclientfactory" rel="nofollow">HttpClientFactory</a> 的作者：<a href="https://github.com/CarnaViire">@CarnaViire</a>。</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d645f3230edc0c76679a77b224c35626/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;结构体的内存分配细节</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/58f78e7d2c910b138ee1dca70a2b57b7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ensp实验</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>