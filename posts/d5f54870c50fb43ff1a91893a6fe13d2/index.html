<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android加密之全盘加密(FDE) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android加密之全盘加密(FDE)" />
<meta property="og:description" content="全盘加密
注意：搭载 Android 7.0 - 9 的设备支持全盘加密。搭载 Android 10 及更高版本的新设备必须使用文件级加密。
全盘加密是使用密钥（密钥本身也经过加密）对 Android 设备上的所有用户数据进行编码的过程。设备经过加密后，所有由用户创建的数据在存入磁盘之前都会自动加密，并且所有读取操作都会在将数据返回给调用进程之前自动解密数据。
全盘加密是在 Android 4.4 版中引入的，不过 Android 5.0 中又引入了以下新功能：
新增了快速加密方式，这种加密方式只会对数据分区中已使用的分块进行加密，以免首次启动用时过长。目前只有 EXT4 和 F2FS 文件系统支持快速加密。添加了 forceencrypt fstab 标记，以便在首次启动时进行加密。添加了对解锁图案和无密码加密的支持。添加了由硬件支持的加密密钥存储空间，该空间使用可信执行环境（TEE，例如 TrustZone）的签名功能。如需了解详情，请参阅存储已加密的密钥。 注意：对于升级到 Android 5.0 的设备，如果升级之后进行了加密，则可以通过恢复出厂设置还原到未加密状态。在首次启动时加密的新 Android 5.0 设备无法还原到未加密状态。
Android 5.0 版中有以下 4 种加密状态：
默认PIN 码密码解锁图案 首次启动时，设备会创建一个随机生成的 128 位主密钥，然后会使用默认密码和存储的盐对其进行哈希处理。默认密码是“default_password”。不过，设备还会通过 TEE（例如 TrustZone）为生成的哈希签名。TEE 会使用相应签名的哈希来加密主密钥。
您可以在 Android 开源项目的 cryptfs.cpp 文件中找到定义的默认密码。
当用户在设备上设置 PIN 码/通行码或密码时，只有 128 位的密钥会被重新加密并存储起来（也就是说，更改用户 PIN 码/通行码/解锁图案不会导致重新加密用户数据）。请注意，受管理的设备可能有 PIN 码、解锁图案或密码限制。
使用 forceencrypt 加密新设备
这是 Android 5.0 设备首次启动时的普通流程。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/d5f54870c50fb43ff1a91893a6fe13d2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-26T09:30:30+08:00" />
<meta property="article:modified_time" content="2021-03-26T09:30:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android加密之全盘加密(FDE)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:0cm;"><span style="color:#202124;">全盘加密</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">注意：搭载 Android 7.0 - 9 的设备支持全盘加密。搭载 Android 10 及更高版本的新设备必须使用<a href="https://source.android.google.cn/security/encryption/file-based" rel="nofollow"><span style="color:#202124;">文件级加密</span></a>。</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">全盘加密是使用密钥（密钥本身也经过加密）对 Android 设备上的所有用户数据进行编码的过程。设备经过加密后，所有由用户创建的数据在存入磁盘之前都会自动加密，并且所有读取操作都会在将数据返回给调用进程之前自动解密数据。</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">全盘加密是在 Android 4.4 版中引入的，不过 Android 5.0 中又引入了以下新功能：</span></p> 
<ul><li><span style="color:#202124;">新增了快速加密方式，这种加密方式只会对数据分区中已使用的分块进行加密，以免首次启动用时过长。目前只有 EXT4 和 F2FS 文件系统支持快速加密。</span></li><li><span style="color:#202124;">添加了</span> <span style="color:#202124;"><a href="https://source.android.google.cn/devices/storage/config" rel="nofollow"><span style="color:#202124;">forceencrypt</span> <span style="color:#202124;">fstab </span><span style="color:#202124;">标记</span></a></span><span style="color:#202124;">，以便在首次启动时进行加密。</span></li><li><span style="color:#202124;">添加了对解锁图案和无密码加密的支持。</span></li><li><span style="color:#202124;">添加了由硬件支持的加密密钥存储空间，该空间使用可信执行环境（TEE，例如 TrustZone）的签名功能。如需了解详情，请参阅<a href="https://source.android.google.cn/security/encryption/full-disk#storing_the_encrypted_key" rel="nofollow"><span style="color:#202124;">存储已加密的密钥</span></a>。</span></li></ul> 
<p style="margin-left:0cm;"><strong><span style="color:#202124;">注意</span></strong><span style="color:#202124;">：对于升级到 Android 5.0 的设备，如果升级之后进行了加密，则可以通过恢复出厂设置还原到未加密状态。在首次启动时加密的新 Android 5.0 设备无法还原到未加密状态。</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">Android 5.0 </span><span style="color:#202124;">版中有以下 4 种加密状态：</span></p> 
<ul><li><span style="color:#202124;">默认</span></li><li><span style="color:#202124;">PIN </span><span style="color:#202124;">码</span></li><li><span style="color:#202124;">密码</span></li><li><span style="color:#202124;">解锁图案</span></li></ul> 
<p style="margin-left:0cm;"><span style="color:#202124;">首次启动时，设备会创建一个随机生成的 128 位主密钥，然后会使用默认密码和存储的盐对其进行哈希处理。默认密码是“default_password”。不过，设备还会通过 TEE（例如 TrustZone）为生成的哈希签名。TEE 会使用相应签名的哈希来加密主密钥。</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">您可以在 Android 开源项目的</span> <span style="color:#202124;"><a href="https://android.googlesource.com/platform/system/vold/+/master/cryptfs.cpp" rel="nofollow"><span style="color:#202124;">cryptfs.cpp</span></a></span> <span style="color:#202124;">文件中找到定义的默认密码。</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">当用户在设备上设置 PIN 码/通行码或密码时，只有 128 位的密钥会被重新加密并存储起来（也就是说，更改用户 PIN 码/通行码/解锁图案不会导致重新加密用户数据）。请注意，</span><a href="http://developer.android.google.cn/guide/topics/admin/device-admin.html" rel="nofollow"><span style="color:#202124;">受管理的设备</span></a>可能有 PIN 码、解锁图案或密码限制。</p> 
<p style="margin-left:0cm;"><span style="color:#202124;">使用 forceencrypt 加密新设备</span></p> 
<p style="margin-left:0cm;"><span style="color:#202124;">这是 Android 5.0 设备首次启动时的普通流程。</span></p> 
<ol><li><span style="color:#202124;">检测带有</span> <span style="color:#202124;">forceencrypt</span> <span style="color:#202124;">标记的未加密文件系统</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">/data</span> <span style="color:#202124;">未加密，但需要加密，因为</span> <span style="color:#202124;">forceencrypt</span> <span style="color:#202124;">强制要求进行此项加密。 卸载</span> <span style="color:#202124;">/data</span><span style="color:#202124;">。</span></p> 
<ol><li><span style="color:#202124;">开始加密</span> <span style="color:#202124;">/data</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">vold.decrypt = "trigger_encryption"</span> <span style="color:#202124;">会触发</span> <span style="color:#202124;">init.rc</span><span style="color:#202124;">，从而使</span> <span style="color:#202124;">vold</span> <span style="color:#202124;">对</span> <span style="color:#202124;">/data</span> <span style="color:#202124;">进行无密码加密。（因为这应该是新设备，还没有设置密码。）</span></p> 
<ol><li><span style="color:#202124;">装载 tmpfs</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">vold</span> <span style="color:#202124;">会装载一个 tmpfs</span> <span style="color:#202124;">/data</span><span style="color:#202124;">（使用</span> <span style="color:#202124;">ro.crypto.tmpfs_options</span> <span style="color:#202124;">中的 tmpfs 选项），并会将</span> <span style="color:#202124;">vold.encrypt_progress</span> <span style="color:#202124;">属性设置为 0。vold</span> <span style="color:#202124;">会准备 tmpfs</span> <span style="color:#202124;">/data</span> <span style="color:#202124;">以便启动已加密的系统，并会将</span> <span style="color:#202124;">vold.decrypt</span> <span style="color:#202124;">属性设置为</span> <span style="color:#202124;">trigger_restart_min_framework</span></p> 
<ol><li><span style="color:#202124;">启动框架以显示进度</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">由于设备上几乎没有要加密的数据，加密过程很快就会完成，因此实际上通常并不会显示进度条。如需详细了解进度界面，请参阅<a href="https://source.android.google.cn/security/encryption/full-disk#encrypt_an_existing_device" rel="nofollow"><span style="color:#202124;">加密现有设备</span></a>。</span></p> 
<ol><li><span style="color:#202124;">/data</span> <span style="color:#202124;">加密后，关闭框架</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">vold</span> <span style="color:#202124;">会将</span> <span style="color:#202124;">vold.decrypt</span> <span style="color:#202124;">设置为</span> <span style="color:#202124;">trigger_default_encryption</span><span style="color:#202124;">，这会启动</span> <span style="color:#202124;">defaultcrypto</span> <span style="color:#202124;">服务。（这会启动以下流程来装载默认的已加密用户数据。）trigger_default_encryption</span> <span style="color:#202124;">会检查加密类型，以了解</span> <span style="color:#202124;">/data</span> <span style="color:#202124;">加密是否使用了密码。由于 Android 5.0 设备在首次启动时加密，应该没有设置任何密码，因此我们要解密并装载</span> <span style="color:#202124;">/data</span><span style="color:#202124;">。</span></p> 
<ol><li><span style="color:#202124;">装载</span> <span style="color:#202124;">/data</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">接下来，init</span> <span style="color:#202124;">会使用从</span> <span style="color:#202124;">ro.crypto.tmpfs_options</span><span style="color:#202124;">（在</span> <span style="color:#202124;">init.rc</span> <span style="color:#202124;">中设置）中选取的参数在 tmpfs RAMDisk 中装载</span> <span style="color:#202124;">/data</span><span style="color:#202124;">。</span></p> 
<ol><li><span style="color:#202124;">启动框架</span></li></ol> 
<p style="margin-left:0cm;"><span style="color:#202124;">将</span> <span style="color:#202124;">vold</span> <span style="color:#202124;">设置为</span> <span style="color:#202124;">trigger_restart_framework</span><span style="color:#202124;">，这会继续常规启动过程。</span></p> 
<h4 style="margin-left:0cm;"><strong><span style="color:#202124;">更改密码</span></strong></h4> 
<p style="margin-left:0cm;"><span style="color:#202124;">当用户选择在设置中更改或移除密码时，界面会向</span> <code><span style="color:#37474f;">vold</span></code> <span style="color:#202124;">发送</span> <code><span style="color:#37474f;">cryptfs changepw</span></code> <span style="color:#202124;">命令，然后</span> <code><span style="color:#37474f;">vold</span></code> <span style="color:#202124;">会使用新密码重新加密磁盘主密钥。</span></p> 
<p style="margin-left:0cm;"> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eeb75b4d73c6686947e5066269a38b2d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">php 微信公众号 41005,php 微信公众平台上传多媒体接口 41005错误</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1a9e9f01f3caf990d223516b5831a98b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">安装H3C Cloud Lab（HCL）时遇到的问题及解决办法汇总</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>