<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Skywalking Agent原理剖析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Skywalking Agent原理剖析" />
<meta property="og:description" content="Skywalking Agent原理剖析 Skywalking Agent原理剖析1 agent原理1.1 Java Agent1.2 定义自己的agent1.3 自定义方法耗时统计 2 Byte Buddy2.1 Byte Buddy应用场景2.2 Byte Buddy学习2.2.1 ByteBuddy语法2.2.2 ByteBuddy创建代理2.2.3 ByteBuddy程序中的应用 3 Skywalking源码导入31 源码环境搭建3.2 模块分析 4 Skywalking Agent启动流程剖析4.1 Skywalking Agent架构4.2 Skywalking Agent启动流程 5 Skywalking Agent源码剖析5.1 配置初始化5.2 插件加载5.3 解析插件5.3.1 PluginResourcesResolver5.3.2 PluginFinder5.3.3 AgentBuilder Skywalking Agent原理剖析 1 agent原理 使用Skywalking的时候，并没有修改程序中任何一行 Java 代码，这里便使用到了 Java Agent 技术，我们接下来展开对Java Agent 技术的学习。
1.1 Java Agent Java Agent 是从 JDK1.5 开始引入的，算是一个比较老的技术了。作为 Java 的开发工程师，我们常用的命令之一就是 java 命令，而 Java Agent 本身就是 java 命令的一个参数（即 -javaagent）。正如上一课时接入 SkyWalking Agent 那样，-javaagent 参数之后需要指定一个 jar 包，这个 jar 包需要同时满足下面两个条件：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f93bb4ec2b2af8629c2dec4e49e1025a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-01T23:00:21+08:00" />
<meta property="article:modified_time" content="2022-07-01T23:00:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Skywalking Agent原理剖析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Skywalking Agent原理剖析</h4> 
 <ul><li><a href="#Skywalking_Agent_1" rel="nofollow">Skywalking Agent原理剖析</a></li><li><ul><li><a href="#1_agent_2" rel="nofollow">1 agent原理</a></li><li><ul><li><a href="#11_Java_Agent_5" rel="nofollow">1.1 Java Agent</a></li><li><a href="#12_agent_22" rel="nofollow">1.2 定义自己的agent</a></li><li><a href="#13__157" rel="nofollow">1.3 自定义方法耗时统计</a></li></ul> 
   </li><li><a href="#2_Byte_Buddy_352" rel="nofollow">2 Byte Buddy</a></li><li><ul><li><a href="#21_Byte_Buddy_355" rel="nofollow">2.1 Byte Buddy应用场景</a></li><li><a href="#22_Byte_Buddy_379" rel="nofollow">2.2 Byte Buddy学习</a></li><li><ul><li><a href="#221_ByteBuddy_382" rel="nofollow">2.2.1 ByteBuddy语法</a></li><li><a href="#222_ByteBuddy_490" rel="nofollow">2.2.2 ByteBuddy创建代理</a></li><li><ul><li><a href="#223_ByteBuddy_587" rel="nofollow">2.2.3 ByteBuddy程序中的应用</a></li></ul> 
    </li></ul> 
   </li></ul> 
   </li><li><a href="#3_Skywalking_670" rel="nofollow">3 Skywalking源码导入</a></li><li><ul><li><a href="#31__673" rel="nofollow">31 源码环境搭建</a></li><li><a href="#32__702" rel="nofollow">3.2 模块分析</a></li></ul> 
   </li><li><a href="#4_Skywalking_Agent_758" rel="nofollow">4 Skywalking Agent启动流程剖析</a></li><li><ul><li><a href="#41_Skywalking_Agent_761" rel="nofollow">4.1 Skywalking Agent架构</a></li><li><a href="#42_Skywalking_Agent_777" rel="nofollow">4.2 Skywalking Agent启动流程</a></li></ul> 
   </li><li><a href="#5_Skywalking_Agent_905" rel="nofollow">5 Skywalking Agent源码剖析</a></li><li><ul><li><a href="#51__908" rel="nofollow">5.1 配置初始化</a></li><li><a href="#52__933" rel="nofollow">5.2 插件加载</a></li><li><a href="#53__1075" rel="nofollow">5.3 解析插件</a></li><li><ul><li><a href="#531_PluginResourcesResolver_1080" rel="nofollow">5.3.1 PluginResourcesResolver</a></li><li><a href="#532_PluginFinder_1176" rel="nofollow">5.3.2 PluginFinder</a></li><li><a href="#533_AgentBuilder_1260" rel="nofollow">5.3.3 AgentBuilder</a></li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Skywalking_Agent_1"></a>Skywalking Agent原理剖析</h2> 
<h3><a id="1_agent_2"></a>1 agent原理</h3> 
<p>使用Skywalking的时候，并没有修改程序中任何一行 Java 代码，这里便使用到了 Java Agent 技术，我们接下来展开对Java Agent 技术的学习。</p> 
<h4><a id="11_Java_Agent_5"></a>1.1 Java Agent</h4> 
<p>Java Agent 是从 JDK1.5 开始引入的，算是一个比较老的技术了。作为 Java 的开发工程师，我们常用的命令之一就是 java 命令，而 Java Agent 本身就是 java 命令的一个参数（即 -javaagent）。正如上一课时接入 SkyWalking Agent 那样，-javaagent 参数之后需要指定一个 jar 包，这个 jar 包需要同时满足下面两个条件：</p> 
<ol><li>在 META-INF 目录下的 MANIFEST.MF 文件中必须指定 premain-class 配置项。</li><li>premain-class 配置项指定的类必须提供了 premain() 方法。在 Java 虚拟机启动时，执行 main() 函数之前，虚拟机会先找到 -javaagent 命令指定 jar 包，然后执行premain-class 中的 premain() 方法。用一句概括其功能的话就是：main() 函数之前的一个拦截器。</li></ol> 
<p>使用 Java Agent 的步骤大致如下：<br> 3. 定义一个 MANIFEST.MF 文件，在其中添加 premain-class 配置项。<br> 4. 创建 premain-class 配置项指定的类，并在其中实现 premain() 方法，方法签名如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
    <span class="token comment">//... </span>
<span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>将 MANIFEST.MF 文件和 premain-class 指定的类一起打包成一个 jar 包。</li><li>使用 -javaagent 指定该 jar 包的路径即可执行其中的 premain() 方法。</li></ol> 
<h4><a id="12_agent_22"></a>1.2 定义自己的agent</h4> 
<p>1)探针工程<br> 创建工程 hailtaxi-agent 用来编写agent包，该类需要用 maven-assembly-plugin 打包，我们先引入该插件：</p> 
<pre><code class="prism language-xml"><span class="token prolog">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">"</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.itheima<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hailtaxi-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>maven-assembly-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configuration</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appendAssemblyId</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appendAssemblyId</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>jar-with-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRef</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>descriptorRefs</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>archive</span><span class="token punctuation">&gt;</span></span> <span class="token comment">&lt;!--自动添加META-INF/MANIFEST.MF --&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span><span class="token punctuation">&gt;</span></span>
                            <span class="token comment">&lt;!-- 添加 mplementation-*和Specification-*配置项--&gt;</span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>addDefaultImplementationEntries</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>addDefaultImplementationEntries</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>addDefaultSpecificationEntries</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>addDefaultSpecificationEntries</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
                        <span class="token comment">&lt;!-- 将 premain-class 配置项设置为com.itheima.LoginAgent--&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>com.itheima.LoginAgent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>
                            <span class="token comment">&lt;!--&lt;Premain-Class&gt;com.itheima.AgentByteBuddy&lt;/Premain-Class&gt;--&gt;</span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>archive</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configuration</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>executions</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>execution</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>make-assembly<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>phase</span><span class="token punctuation">&gt;</span></span>package<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>phase</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goals</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>goal</span><span class="token punctuation">&gt;</span></span>single<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goal</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>goals</span><span class="token punctuation">&gt;</span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>execution</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>executions</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>在该工程中编写一个类 com.itheima.LoginAgent ：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginAgent</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/***
     * 执行方法拦截
     * @param agentArgs：-javaagent 命令携带的参数。在前面介绍 SkyWalking Agent 接入时提到
     *                 agent.service_name 这个配置项的默认值有三种覆盖方式，
     *                 其中，使用探针配置进行覆盖，探针配置的值就是通过该参数传入的。
     * @param inst：java.lang.instrumen.Instrumentation 是 Instrumention 包中定义的一个接口，它提供了操作类定义的相关方法。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"参数:"</span> <span class="token operator">+</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再把该工程打包，在 D:/project/skywalking/hailtaxi-agent/target/hailtaxi-agent-1.0-SNAPSHOT.jar 生成了该探针包。<br> 此时我们把jar包解压， <strong>MANIFEST.MF</strong> 内容如下：</p> 
<pre><code class="prism language-bash">Manifest-Version: <span class="token number">1.0</span> 
Archiver-Version: Plexus Archiver 
Created-By: Apache Maven 
Built-By: admin 
Build-Jdk: <span class="token number">1.8</span>.0_91 
Specification-Title: hailtaxi-agent 
Specification-Version: <span class="token number">1.0</span>-SNAPSHOT 
Implementation-Title: hailtaxi-agent 
Implementation-Version: <span class="token number">1.0</span>-SNAPSHOT 
Implementation-Vendor-Id: com.itheima 
Premain-Class: com.itheima.LoginAgent 
</code></pre> 
<p>2)普通工程<br> 我们在创建一个普通工程 hailtaxi-user ，在该工程中创建一个普通类com.itheima.agent.UserInfo 并编写main方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"张三是个中国人！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用say()方法</span>
        <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/***
     * 测试时间
     * @throws InterruptedException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>我们再将如下参数配置到IDEA中：</p> 
<pre><code class="prism language-bash">-javaagent:D:/project/skywalking/hailtaxi-agent/target/hailtaxi-agent-1.0-SNAPSHOT.jar<span class="token operator">=</span>hailtaxi-user
</code></pre> 
<p>如果是多个参数，可以这么写 -javaagent:/xxx.jar=option1=value1,option2=value2 。</p> 
<p>此时运行效果如下：<br> <img src="https://images2.imgbox.com/2e/93/2cYAPNpc_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="13__157"></a>1.3 自定义方法耗时统计</h4> 
<p>Java Agent 能做的事情非常多，而刚才打印一句日志只是一个能功能展示。要想使用 java agent 做更多事，这里需要关注一下 premain() 方法中的第二个参数：Instrumentation 。Instrumentation 位于 java.lang.instrument 包中，通过这个工具包，我们可以编写一个强大的Java Agent 程序。<br> 下面先来简单介绍一下 Instrumentation 中的核心 API 方法：<br> <strong>addTransformer()/removeTransformer() 方法</strong>：注册/注销一个 ClassFileTransformer 类的实例，该 Transformer 会在类加载的时候被调用，可用于修改类定义。redefineClasses() 方法：该方法针对的是已经加载的类，它会对传入的类进行重新定义。<br> **getAllLoadedClasses()**方法：返回当前 JVM 已加载的所有类。<br> <strong>getInitiatedClasses()</strong> 方法：返回当前 JVM 已经初始化的类。<br> **getObjectSize()**方法：获取参数指定的对象的大小。<br> 我们要想实现更复杂的功能，需要先学习下 Byte Buddy ，我们接下来学习下byte buddy并且基于bytebuddy写出更多复杂应用。</p> 
<p>1)Byte Buddy介绍<br> Byte Buddy 是一个开源 Java 库，其主要功能是帮助用户屏蔽字节码操作，以及复杂的<br> Instrumentation API 。Byte Buddy 提供了一套类型安全的 API 和注解，我们可以直接使用这些 API 和注解轻松实现复杂的字节码操作。另外，Byte Buddy 提供了针对 Java Agent 的额外 API，帮助开发人员在 Java Agent 场景轻松增强已有代码。<br> 学习完上面方法后，我们基于java agent写一个统计方法耗时流程，此时我们需要将 Java Agent 与Byte Buddy 结合使用，统计 com.itheima.agent包下所有方法的耗时。</p> 
<p>2)引入依赖<br> 在 hailtaxi-agent 中引入byte buddy依赖：</p> 
<pre><code class="prism language-xml">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>net.bytebuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>byte-buddy-agent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.9.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3)创建统计拦截器<br> 创建 com.itheima.TimeInterceptor 实现统计拦截，代码如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Origin</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RuntimeType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">SuperCall</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Callable</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TimeInterceptor</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/***
     * 拦截方法
     * @RuntimeType：返回类型绑定，让返回结果和被调用的原对象方法返回结果类型保持一致
     * @Origin：原方法参数类型绑定
     * @SuperCall：绑定被调用对象的代理对象
     * @param method：拦截的方法
     * @param callable：调用对象的代理对象
     * @return
     * @throws Exception
     */</span>
    <span class="token annotation punctuation">@RuntimeType</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Origin</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span>
                                   <span class="token annotation punctuation">@SuperCall</span> <span class="token class-name">Callable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> callable<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//时间统计开始</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 执行原函数</span>
        <span class="token class-name">Object</span> result <span class="token operator">=</span> callable<span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//执行时间统计</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">":"</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里整体实现类似动态代理执行过程，也类似SpringAop中的环绕通知，其中几个注解我们一起来学习一下：</p> 
<pre><code class="prism language-bash">@RuntimeType 注解：告诉 Byte Buddy 不要进行严格的参数类型检测，在参数匹配失败时，尝试使用类型转换方式（runtime <span class="token builtin class-name">type</span> casting）进行类型转换，匹配相应方法。 
@Origin 注解：注入目标方法对应的 Method 对象。如果拦截的是字段的话，该注解应该标注到 Field 类型参数。 
@SuperCall：这个注解比较特殊，我们要在 intercept<span class="token punctuation">(</span><span class="token punctuation">)</span> 方法中调用目标方法的话，需要通过这种方式注入，与 Spring AOP 中的 ProceedingJoinPoint.proceed<span class="token punctuation">(</span><span class="token punctuation">)</span> 方法有点类似，需要注意的是， 这里不能修改调用参数，从上面的示例的调用也能看出来，参数不用单独传递，都包含在其中了。另外， 
@SuperCall 注解还可以修饰 Runnable 类型的参数，只不过目标方法的返回值就拿不到了。
</code></pre> 
<p>4)agent拦截配置<br> 创建Java Agent和Byte Buddy结合处理方法拦截配置流程，创建 com.itheima.AgentByteBuddy ，在该类中配置拦截的类和方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span></span><span class="token class-name">ByteBuddy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>agent<span class="token punctuation">.</span>builder<span class="token punctuation">.</span></span><span class="token class-name">AgentBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>description<span class="token punctuation">.</span>method<span class="token punctuation">.</span></span><span class="token class-name">MethodDescription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>description<span class="token punctuation">.</span>type<span class="token punctuation">.</span></span><span class="token class-name">TypeDescription</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span></span><span class="token class-name">DynamicType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>dynamic<span class="token punctuation">.</span>loading<span class="token punctuation">.</span></span><span class="token class-name">ClassLoadingStrategy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span></span><span class="token class-name">FixedValue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span></span><span class="token class-name">MethodDelegation</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>matcher<span class="token punctuation">.</span></span><span class="token class-name">ElementMatchers</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">net<span class="token punctuation">.</span>bytebuddy<span class="token punctuation">.</span>utility<span class="token punctuation">.</span></span><span class="token class-name">JavaModule</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>instrument<span class="token punctuation">.</span></span><span class="token class-name">Instrumentation</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AgentByteBuddy</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">/***
     * 执行方法拦截
     * @param agentArgs：-javaagent 命令携带的参数。在前面介绍 SkyWalking Agent 接入时提到
     *                 agent.service_name 这个配置项的默认值有三种覆盖方式，
     *                 其中，使用探针配置进行覆盖，探针配置的值就是通过该参数传入的。
     * @param inst：java.lang.instrumen.Instrumentation 是 Instrumention 包中定义的一个接口，它提供了操作类定义的相关方法。
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//动态构建操作，根据transformer规则执行拦截操作</span>
        <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Transformer</span> transformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Transformer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> builder<span class="token punctuation">,</span>
                                                    <span class="token class-name">TypeDescription</span> typeDescription<span class="token punctuation">,</span>
                                                    <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span>
                                                    <span class="token class-name">JavaModule</span> javaModule<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//构建拦截规则</span>
                <span class="token keyword">return</span> builder
                        <span class="token comment">//method()指定哪些方法需要被拦截，ElementMatchers.any()表示拦截所有方法</span>
                        <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodDescription</span><span class="token punctuation">&gt;</span></span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token comment">//intercept()指定拦截上述方法的拦截器</span>
                        <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token class-name">TimeInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        <span class="token comment">//采用Byte Buddy的AgentBuilder结合Java Agent处理程序</span>
        <span class="token keyword">new</span> <span class="token class-name">AgentBuilder</span>
                <span class="token comment">//采用ByteBuddy作为默认的Agent实例</span>
                <span class="token punctuation">.</span><span class="token function">Default</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//拦截匹配方式：类以com.itheima开始（其实即使com.itheima包下的所有类）</span>
                <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"com.itheima"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//拦截到的类由transformer处理</span>
                <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>transformer<span class="token punctuation">)</span>
                <span class="token comment">//安装到 Instrumentation</span>
                <span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 创建ByteBuddy对象</span>
        <span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// subclass增强方式</span>
                <span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">// 新类型的类名</span>
                <span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"com.itheima.Type"</span><span class="token punctuation">)</span>
                <span class="token comment">// 拦截其中的toString()方法</span>
                <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 让toString()方法返回固定值</span>
                <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">FixedValue</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 加载新类型，默认WRAPPER策略</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 通过 Java反射创建 com.xxx.Type实例</span>
                <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 调用 toString()方法</span>
                <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 指定方法名称</span>
        <span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span>
                <span class="token comment">// 指定方法的返回值</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 指定方法参数</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">takesArguments</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>同时将pom.xml中的premain-class替换成 AgentByteBuddy</p> 
<pre><code class="prism language-xml"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
                            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>com.itheima.AgentByteBuddy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>Premain-Class</span><span class="token punctuation">&gt;</span></span>
                        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifestEntries</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>修改 hailtaxi-user 中的 UserInfo 添加测试方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserInfo</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"张三是个中国人！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//调用say()方法</span>
        <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/***
     * 测试时间
     * @throws InterruptedException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">say</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>测试效果如下：</p> 
<pre><code class="prism language-bash">张三是个中国人！ 
hello<span class="token operator">!</span> 
say:5000ms 
main:7002ms
</code></pre> 
<h3><a id="2_Byte_Buddy_352"></a>2 Byte Buddy</h3> 
<p>在前面学习 Java Agent 技术时，结合 Byte Buddy 技术实现了统计方法执行时间的功能。 Byte Buddy在Skywalking中被广泛使用，我们接下来继续学习Byte Buddy，为后续分析 SkyWalking Agent打下基础。</p> 
<h4><a id="21_Byte_Buddy_355"></a>2.1 Byte Buddy应用场景</h4> 
<p>Java 是一种强类型的编程语言，即要求所有变量和对象都有一个确定的类型，如果在赋值操作中出现类型不兼容的情况，就会抛出异常。强类型检查在大多数情况下是可行的，然而在某些特殊场景下，强类型检查则成了巨大的障碍。<br> 我们在做一些通用工具封装的时候，类型检查就成了很大障碍。比如我们编写一个通用的Dao实现数据操作，我们根本不知道用户要调用的方法会传几个参数、每个参数是什么类型、需求变更又会出现什么类型，几乎没法在方法中引用用户方法中定义的任何类型。我们绝大多数通用工具封装都采用了反射机制，通过反射可以知道用户调用的方法或字段，但是Java反射有很多缺陷：</p> 
<pre><code class="prism language-bash"><span class="token number">1</span>:反射性能很差 
<span class="token number">2</span>:反射能绕开类型安全检查，不安全，比如权限暴力破解
</code></pre> 
<p>学完agent后，我们可以基于agent做出一些改变，运行时代码生成在 Java 应用启动之后再动态生成一些类定义，这样就可以模拟一些只有使用动态编程语言编程才有的特性，同时也不丢失 Java 的强类型检查。在运行时生成代码需要特别注意的是 Java 类型被 JVM 加载之后，一般不会被垃圾被回收，因此不应该过度使用代码生成。<br> java编程语言代码生成库不止 Byte Buddy 一个，以下代码生成库在 Java 中也很流行：</p> 
<p><strong>Java Proxy</strong><br> Java Proxy 是 JDK 自带的一个代理工具，它允许为实现了一系列接口的类生成代理类。Java Proxy 要求目标类必须实现接口是一个非常大限制，例如，在某些场景中，目标类没有实现任何接口且无法修改目标类的代码实现，Java Proxy 就无法对其进行扩展和增强了。<br> <strong>CGLIB</strong><br> CGLIB 诞生于 Java 初期，但不幸的是没有跟上 Java 平台的发展。虽然 CGLIB 本身是一个相当强大的库，但也变得越来越复杂。鉴于此，导致许多用户放弃了 CGLIB 。<br> <strong>Javassist</strong><br> Javassist 的使用对 Java 开发者来说是非常友好的，它使用Java 源代码字符串和Javassist 提供的一些简单 API ，共同拼凑出用户想要的 Java 类，Javassist 自带一个编译器，拼凑好的 Java 类在程序运行时会被编译成为字节码并加载到 JVM 中。Javassist 库简单易用，而且使用 Java 语法构建类与平时写 Java 代码类似，但是 Javassist 编译器在性能上比不了 Javac 编译器，而且在动态组合字符串以实现比较复杂的逻辑时容易出错。<br> <strong>Byte Buddy</strong><br> Byte Buddy 提供了一种非常灵活且强大的领域特定语言，通过编写简单的 Java 代码即可创建自定义的运行时类。与此同时，Byte Buddy 还具有非常开放的定制性，能够应付不同复杂度的需求。</p> 
<p>上面所有代码生成技术中，我们推荐使用Byte Buddy，因为Byte Buddy代码生成可的性能最高，ByteBuddy 的主要侧重点在于生成更快速的代码，如下图：<br> <img src="https://images2.imgbox.com/5d/ca/0f51L08H_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="22_Byte_Buddy_379"></a>2.2 Byte Buddy学习</h4> 
<p>我们接下来详细讲解一下Byte Buddy Api，对重要的方法和类进行深度剖析。</p> 
<h5><a id="221_ByteBuddy_382"></a>2.2.1 ByteBuddy语法</h5> 
<p>任何一个由 Byte Buddy 创建/增强的类型都是通过 ByteBuddy 类的实例来完成的，我们先来学习一下ByteBuddy类，如下代码：</p> 
<pre><code class="prism language-java"><span class="token class-name">DynamicType<span class="token punctuation">.</span>Unloaded</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dynamicType <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// 生成 Object的子类 </span>

<span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 

<span class="token comment">// 生成类的名称为"com.itheima.Type" </span>

<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"com.itheima.Type"</span><span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>Byte Buddy 动态增强代码总共有三种方式：</p> 
<pre><code class="prism language-java">subclass<span class="token operator">:</span>对应 <span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法。这种方式比较好理解，就是为目标类（即被增强的类）生成一个子类，在子类方法中插入动态代码。 
rebasing<span class="token operator">:</span>对应 <span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token function">rebasing</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法。当使用 rebasing 方式增强一个类时，<span class="token class-name">Byte</span> <span class="token class-name">Buddy</span> 保存目标类中所有方法的实现，也就是说，当 <span class="token class-name">Byte</span> <span class="token class-name">Buddy</span> 遇到冲突的字段或方法时，会将原来的字段或方法实现复制到具有兼容签名的重新命名的私有方法中，而不会抛弃这些字段和方法实现。从而达到不丢失实现的目的。这些重命名的方法可以继续通过重命名后的名称进行调用。
redefinition<span class="token operator">:</span>对应 <span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token function">redefine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法。当重定义一个类时，<span class="token class-name">Byte</span> <span class="token class-name">Buddy</span> 可以对一个已有的类添加属性和方法，或者删除已经存在的方法实现。如果使用其他的方法实现替换已经存在的方法实现，则原来存在的方法实现就会消失。 
</code></pre> 
<p>通过上述三种方式完成类的增强之后，我们得到的是 DynamicType.Unloaded 对象，表示的是一个未加载的类型，我们可以使用 ClassLoadingStrategy 加载此类型。ByteBuddy 提供了几种类加载策略，<br> 这些策略定义在 ClassLoadingStrategy.Default 中，其中：<br> WRAPPER 策略：创建一个新的 ClassLoader 来加载动态生成的类型。<br> CHILD_FIRST 策略：创建一个子类优先加载的 ClassLoader，即打破了双亲委派模型。<br> INJECTION 策略：使用反射将动态生成的类型直接注入到当前 ClassLoader 中。<br> 实现如下：</p> 
<pre><code class="prism language-java"><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> dynamicClazz <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// 生成 Object的子类 </span>

<span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 

<span class="token comment">// 生成类的名称为"com.itheima.Type" </span>

<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"com.itheima.Type"</span><span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Demo</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 

<span class="token comment">//使用WRAPPER 策略加载生成的动态类型 </span>

<span class="token class-name">ClassLoadingStrategy<span class="token punctuation">.</span>Default</span><span class="token punctuation">.</span>WRAPPER<span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>前面动态生成的 com.itheima.Type 类型只是简单的继承了 Object 类，在实际应用中动态生成新类型的一般目的就是为了增强原始的方法，下面通过一个示例展示 Byte Buddy 如何增强 toString() 方法：</p> 
<pre><code class="prism language-java"><span class="token comment">// 创建ByteBuddy对象 </span>

<span class="token class-name">String</span> str <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// subclass增强方式 </span>

<span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 

<span class="token comment">// 新类型的类名 </span>

<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string">"com.itheima.Type"</span><span class="token punctuation">)</span> 

<span class="token comment">// 拦截其中的toString()方法</span>

<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token comment">// 让toString()方法返回固定值 </span>

<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">FixedValue</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// 加载新类型，默认WRAPPER策略 </span>

<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// 通过 Java反射创建 com.xxx.Type实例 </span>

<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 

<span class="token comment">// 调用 toString()方法 </span>

<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>首先需要关注这里的 method() 方法，method() 方法可以通过传入的 ElementMatchers 参数匹配多个需要修改的方法，这里的 ElementMatchers.named(“toString”) 即为按照方法名匹配 toString() 方法。如果同时存在多个重载方法，则可以使用 ElementMatchers 其他 API 描述方法的签名，如下所示：</p> 
<pre><code class="prism language-java"><span class="token comment">// 指定方法名称 </span>

<span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span> 

<span class="token comment">// 指定方法的返回值 </span>

<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 

<span class="token comment">// 指定方法参数 </span>

<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">takesArguments</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre> 
<p>接下来需要关注的是 intercept() 方法，通过 method() 方法拦截到的所有方法会由Intercept()方法指定的 Implementation 对象决定如何增强。这里的 FixValue.value() 会将方法的实现修改为固定值，上例中就是固定返回 “Hello World!” 字符串。<br> Byte Buddy 中可以设置多个 method() 和 Intercept() 方法进行拦截和修改， Byte Buddy 会按照栈的顺序来进行拦截。</p> 
<h5><a id="222_ByteBuddy_490"></a>2.2.2 ByteBuddy创建代理</h5> 
<p>我们先创建一个普通类，再为该类创建代理类，创建代理对方法进行拦截做处理。<br> 1)普通类<br> 创建 com.itheima.service.UserService</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span> 

<span class="token comment">//方法1 </span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 

<span class="token keyword">return</span> <span class="token string">"张三"</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span>

<span class="token comment">//方法2 </span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 

<span class="token keyword">return</span> username<span class="token operator">+</span><span class="token string">"来自 【湖北省武汉市】"</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span>

<span class="token comment">//方法3 </span>

<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">String</span> city<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 

<span class="token keyword">return</span> username<span class="token operator">+</span><span class="token string">"来自 【湖北省"</span><span class="token operator">+</span>city<span class="token operator">+</span><span class="token string">"】"</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span> 

<span class="token punctuation">}</span>
</code></pre> 
<p>2)代理创建</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span>args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">{<!-- --></span>

<span class="token comment">//创建ByteBuddy </span>

        <span class="token class-name">UserService</span> userService<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//指定创建UserServiceImpl对象的子类 </span>

        <span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>

<span class="token comment">//匹配方法,所有方法均被拦截 </span>

        <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">isDeclaredBy</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//任何拦截都返回一个固定值 </span>

        <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">FixedValue</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"被拦截了吧！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//为特定方法添加拦截 </span>

        <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">named</span><span class="token punctuation">(</span><span class="token string">"address"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">takesArguments</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//返回固定值 </span>

        <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">FixedValue</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token string">"被拦截了吧！address()方法被特别关照了！"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">//创建动态对象 </span>

        <span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

        <span class="token class-name">ClassLoadingStrategy<span class="token punctuation">.</span>Default</span><span class="token punctuation">.</span>INJECTION<span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

        <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//会被拦截，返回固定值：被拦截了吧！ </span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">,</span><span class="token string">"武汉"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//会被拦截，返回固定值：被拦截了吧！address()方法被特别关照了！ </span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>userService<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
</code></pre> 
<p>此时我们运行，结果如下：</p> 
<pre><code class="prism language-bash">被拦截了吧！ 
被拦截了吧！ 
被拦截了吧！
address<span class="token punctuation">(</span><span class="token punctuation">)</span>方法被特别关照了！
</code></pre> 
<p><img src="https://images2.imgbox.com/03/c8/2ztrCxDi_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="223_ByteBuddy_587"></a>2.2.3 ByteBuddy程序中的应用</h6> 
<p>上面我们创建代理的案例中，把返回值设置成了固定值，但在真实程序汇总通常是要做特定业务流程处理，比如事务、日志、权限校验等，此时我们需要用到ByteBuddy的MethodDelegation对象，它可以将拦截的目标方法委托给其他对象处理，这里有几个注解我们先进行说明：<br> <strong>@RuntimeType</strong>：不进行严格的参数类型检测，在参数匹配失败时，尝试使用类型转换方式（runtime type casting）进行类型转换，匹配相应方法。<br> <strong>@This</strong>：注入被拦截的目标对象。<br> <strong>@AllArguments</strong>：注入目标方法的全部参数。<br> <strong>@Origin</strong>：注入目标方法对应的 Method 对象。如果拦截的是字段的话，该注解应该标注到 Field类型参数。<br> <strong>@Super</strong>：注入目标对象。通过该对象可以调用目标对象的所有方法。<br> <strong>@SuperCall</strong>：这个注解比较特殊，我们要在 intercept() 方法中调用目标方法的话，需要通过这种方式注入，与 Spring AOP 中的 ProceedingJoinPoint.proceed() 方法有点类似，需要注意的是，这里不能修改调用参数，从上面的示例的调用也能看出来，参数不用单独传递，都包含在其中了。<br> 另外，@SuperCall 注解还可以修饰 Runnable 类型的参数，只不过目标方法的返回值就拿不到了。</p> 
<p>1)修改案例方法<br> 我们修改一下之前写的案例类 com.itheima.service.UserService 添加日志打印：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">//方法1</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"com.itheima.service.UserService.username....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">"张三"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//方法2</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"com.itheima.service.UserService.address(String username)....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> username<span class="token operator">+</span><span class="token string">"来自 【湖北省武汉市】"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//方法3</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">address</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span><span class="token class-name">String</span> city<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"com.itheima.service.UserService.address(String username,String city)....."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> username<span class="token operator">+</span><span class="token string">"来自 【湖北省"</span><span class="token operator">+</span>city<span class="token operator">+</span><span class="token string">"】"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token punctuation">}</span>
</code></pre> 
<p>2)创建代理<br> 编写动态创建对象代理的方法：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ByteBuddyLogAspect</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//创建ByteBuddy</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">//指定创建UserServiceImpl对象的子类</span>
                <span class="token punctuation">.</span><span class="token function">subclass</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token comment">//匹配方法,所有方法均被拦截</span>
                <span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">isDeclaredBy</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//任何拦截都返回一个固定值</span>
                <span class="token comment">//.intercept(MethodDelegation.to(new AspectLog()))</span>
                <span class="token comment">//修改参数</span>
                <span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">MethodDelegation</span><span class="token punctuation">.</span><span class="token function">withDefaultConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">withBinders</span><span class="token punctuation">(</span>
                        <span class="token class-name">Morph<span class="token punctuation">.</span>Binder</span><span class="token punctuation">.</span><span class="token function">install</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AspectLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">//创建动态对象</span>
                <span class="token punctuation">.</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">ByteBuddy</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        <span class="token class-name">ClassLoadingStrategy<span class="token punctuation">.</span>Default</span><span class="token punctuation">.</span>INJECTION<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">getLoaded</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        userService<span class="token punctuation">.</span><span class="token function">username</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token string">"王五"</span><span class="token punctuation">,</span><span class="token string">"武汉"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">address</span><span class="token punctuation">(</span><span class="token string">"张三"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>此时测试运行结果如下：</p> 
<pre><code class="prism language-bash">准备执行Method<span class="token operator">=</span>username 
com.itheima.service.UserService.username<span class="token punctuation">..</span><span class="token punctuation">..</span>. 
方法执行完成Method<span class="token operator">=</span>username 
准备执行Method<span class="token operator">=</span>address 
com.itheima.service.UserService.address<span class="token punctuation">(</span>String username,String city<span class="token punctuation">)</span><span class="token punctuation">..</span><span class="token punctuation">..</span>. 
方法执行完成Method<span class="token operator">=</span>address 
准备执行Method<span class="token operator">=</span>address 
com.itheima.service.UserService.address<span class="token punctuation">(</span>String username<span class="token punctuation">)</span><span class="token punctuation">..</span><span class="token punctuation">..</span>. 
方法执行完成Method<span class="token operator">=</span>address
</code></pre> 
<h3><a id="3_Skywalking_670"></a>3 Skywalking源码导入</h3> 
<p>我们已经学习了Skywalking的应用，接下来我们将剖析Skywalking源码，深度学习Skywalking agent。</p> 
<h4><a id="31__673"></a>31 源码环境搭建</h4> 
<p>当前最新版本是8.3.0,我们首先找到8.3.0的版本，然后下载并导入到IDEA，下载地址<a href="https://github.com/apache/skywalking/tags">https://github.com/apache/skywalking/tags</a>，我们直接用git克隆到本地。</p> 
<p>1)下载工程<br> <img src="https://images2.imgbox.com/33/46/0InF0eZ4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/aa/b6/wABKOHhW_o.png" alt="在这里插入图片描述"><br> 这个过程比较耗时间，需要大家耐心等待，如果想提升下载速度，可以把github仓库地址导入到码云中，再下载，速度将会变得非常快。</p> 
<p>2)切换版本<br> 将Skywalking工程加入到Maven工程中，我们用的是当前最新版本8.3.0,因此需要切换版本：<br> <img src="https://images2.imgbox.com/69/48/vyS9vw8Z_o.png" alt="在这里插入图片描述"><br> 项目导入IDEA后，会从指定路径加载项目，我们需要在skywalking的pom.xml中配置项目路径，添加<br> 如下properties配置即可：<br> <code>&lt;maven.multiModuleProjectDirectory&gt;D:/project/skywalking/skywalking- 8.3.0/&lt;/maven.multiModuleProjectDirectory&gt;</code><br> 将 ${COVERALLS_REPO_TOKEN} 注释掉，我们只用于本地测试，不需要提交相关报告。<br> <img src="https://images2.imgbox.com/e8/dc/bhsPFaCy_o.png" alt="在这里插入图片描述"><br> 我们接下来生成一些需要用到的类，需要在工程中执行如下命令：</p> 
<pre><code class="prism language-bash"><span class="token function">git</span> submodule init 
<span class="token function">git</span> submodule update
</code></pre> 
<p>此时会生成一些类 skywalking\apm-protocol\apm-network\target\generated- sources\protobuf\java\org\apache\skywalking\apm\network\common\v3 目录下的类如下图：<br> <img src="https://images2.imgbox.com/cc/0a/fnDwrWfA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5c/3f/qUVw3QPL_o.png" alt="在这里插入图片描述"><br> 除了上面这里，还有很多个地方都需要这么操作，我们执行 OAPServerStartUp 的main方法启动Skywalking，只要执行找不到类，就找下有没有任何编译后生成的类没在类路径下，都把他们设置为类路径即可。<br> Skywalking依赖的插件特别多，因此依赖的包也特别多，我们把Skywalking安装到本地，会耗费很长时间，但不要担心，因为迟早会安装完成，如下图：</p> 
<h4><a id="32__702"></a>3.2 模块分析</h4> 
<p><strong>apm-application-toolkit</strong>:常用的工具工程，例如：log4j、log4j2、logback 等常见日志框架的接入接口，Kafka轮询调用注解，apm-application-toolkit 模块类似于暴露 API 定义，对应的处理逻辑在apm-sniffer/apm-toolkit-activation 模块中实现,如下图：<br> <img src="https://images2.imgbox.com/a0/e6/gCF2TsIk_o.png" alt="在这里插入图片描述"><br> <strong>apm-commons</strong>：SkyWalking 的公共组件和工具类。如下图所示，其中包含两个子模块，apmdatacarrier 模块提供了一个生产者-消费者模式的缓存组（DataCarrier），无论是在 Agent 端还是OAP 端都依赖该组件。apm-util 模块则提供了一些常用的工具类，例如，字符串处理工具类（StringUtil）、占位符处理的工具类（PropertyPlaceholderHelper、PlaceholderConfifigurerSupport）等等。<br> <strong>apache-skywalking-apm</strong>：SkyWalking 打包后使用的命令文件都在此目录中，例如，前文启动 OAP和 SkyWalking Rocketbot 使用的 startup.sh 文件。<br> <strong>apm-protocol</strong>：该模块中只有一个 apm-network 模块，我们需要关注的是其中定义的 .proto 文件，定义 Agent 与后端 OAP 使用 gRPC 交互时的协议。<br> <strong>apm-sniffffer</strong>：agent核心功能以及agent依赖插件，模块比较多：</p> 
<pre><code class="prism language-bash">apm-agent:只有一个类SkyWalkingAgent，是Skywalking的agent入口。 
apm-agent-core:看名字我们就知道它是Skywalking agent核心模块。 
apm-sdk-plugin:该模块下包含了 SkyWalking Agent 的全部插件。 
apm-toolkit-activation:apm-application-toolkit 模块的具体实现。 
apm-test-tools:Skywalking的测试功能。 
bootstrap-plugins:该插件主要提供了Http和多线程相关的功能支持，它里面有2个子工程。 
optional-plugins:可选插件，例如对spring支持、对kotlin支持等，它下面有多个插件工程实现。 
optional-reporter-plugins:该工程插件主要提供一些数据报告，集成了Kafka功能。
</code></pre> 
<p><strong>apm-webapp</strong>：SkyWalking Rocketbot 对应的后端。<br> <strong>oap-server</strong>：opa主程序，该工程中有多个模块，我们对核心模块进行说明：</p> 
<pre><code class="prism language-bash">analyzer:数据分析工程，例如对内存分析、仪表盘分析报告等，它下面有2个子工程。 

exporter:导出数据功能。oal-grammar:操作适配语法，例如SQL语法。 

oal-rt:操作解析器，上面提供了语法，该工程提供对操作解析功能。 

server-alarm-plugin:负责实现 SkyWalking 的告警功能。 

server-cluster-plugin:OAP集群管理功能，提供了很多第三方介入的组件。 

server-configuration:负责管理 OAP 的配置信息，也提供了接入多种配置管理组件的相关插件。 

server-core:SkyWalking OAP的核心实现都在该模块中。 

server-library:OAP 以及 OAP 各个插件依赖的公共模块，其中提供了双队列 Buffer、请求远端的 

Client 等工具类，这些模块都是对立于 SkyWalking OAP 体系之外的类库，我们可以直接拿着使用。 

server-query-plugin:SkyWalking Rocketbot 发送的请求首先由该模块接收处理，目前该模块只支 
持 GraphQL 查询。 

server-receiver-plugin:SkyWalking Agent 发送来的 Metrics、Trace 以及 Register 等写 
入请求都是首先由该模块接收处理的，不仅如此，该模块还提供了多种接收其他格式写入请求的插件。 

server-starter:OAP 服务启动的入口。 

server-storage-plugin:OAP 服务底层可以使用多种存储来保存 Metrics 数据以及Trace 数据，该 
模块中包含了接入相关存储的插件。 

skywalking-agent:SkyWalking Agent 编译后生成的 jar 包都会放到该目录中。 

skywalking-ui:SkyWalking Rocketbot 的前端。
</code></pre> 
<h3><a id="4_Skywalking_Agent_758"></a>4 Skywalking Agent启动流程剖析</h3> 
<p>我们已经学习了Skywalking常用操作，并且讲解了Java Agent，而且Skywalking Agent就是基于JavaAgent研发而来，我们接下来深入学习Skywalking Agent架构、原理、常用组件。</p> 
<h4><a id="41_Skywalking_Agent_761"></a>4.1 Skywalking Agent架构</h4> 
<p>我们在学习Skywalking之前，先了解一下微内核架构，如下图：<br> <img src="https://images2.imgbox.com/fd/e3/w14wkSCf_o.png" alt="在这里插入图片描述"><br> <strong>微内核架构</strong>（Microkernel Architecture），也被成为插件化架构（Plug-in Architecture）,是一种面向功能进行拆分的可扩展性架构，通常用于实现基于产品（原文为product-based，指存在多个版本，需要下载安装才能使用，与web-based想对应）的应用。</p> 
<p>微内核架构的好处：</p> 
<p>1:测试成本下降。从软件工程的角度看，微内核架构将变化的部分和不变的部分拆分，降低了测试的成本， 符合设计模式中的开放封闭原则。<br> 2:稳定性。由于每个插件模块相对独立，即使其中一个插件有问题，也可以保证内核系统以及其他插件的稳定性。<br> 3:可扩展性。在增加新功能或接入新业务的时候，只需要新增相应插件模块即可；在进行历史功能下线时，也只需删除相应插件模块即可。</p> 
<p>微内核的核心系统设计的关键技术有：插件管理，插件连接和插件通信。<br> SkyWalking Agent 采用了微内核架构（Microkernel Architecture），是一种面向功能进行拆分的可扩展性架构。<br> apm-agent-core:是Skywalking Agent的核心模块<br> apm-sdk-plugin:是Skywalking需要的各个插件模块<br> <img src="https://images2.imgbox.com/9b/4b/5r4ClHck_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="42_Skywalking_Agent_777"></a>4.2 Skywalking Agent启动流程</h4> 
<p>1)启动OAP<br> 我们接下来启动Skywalking oap，我们在 oap-server\server-starter 或者 oap-server\server- starter-es7 中找到 OAPServerStartUp 类，执行该类的main方法即可启动，但默认用的是H2存储，如果希望用elasticsearch存储，需要修改被调用的服务 server-bootstrap 的配置文件application.yml 配置elasticsearch位置：</p> 
<pre><code class="prism language-yml"><span class="token key atrule">storage</span><span class="token punctuation">:</span>
 <span class="token comment"># selector: ${SW_STORAGE:h2}</span>
  <span class="token key atrule">selector</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_STORAGE<span class="token punctuation">:</span>elasticsearch7<span class="token punctuation">}</span>
  <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span>
    <span class="token key atrule">nameSpace</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_NAMESPACE<span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">}</span>
    <span class="token key atrule">clusterNodes</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_STORAGE_ES_CLUSTER_NODES<span class="token punctuation">:</span>localhost<span class="token punctuation">:</span><span class="token number">9200</span><span class="token punctuation">}</span>
    <span class="token key atrule">protocol</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_STORAGE_ES_HTTP_PROTOCOL<span class="token punctuation">:</span><span class="token string">"http"</span><span class="token punctuation">}</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_ES_USER<span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">}</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_ES_PASSWORD<span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">}</span>
    <span class="token key atrule">trustStorePath</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_STORAGE_ES_SSL_JKS_PATH<span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">}</span>
    <span class="token key atrule">trustStorePass</span><span class="token punctuation">:</span> $<span class="token punctuation">{<!-- --></span>SW_STORAGE_ES_SSL_JKS_PASS<span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">}</span>
</code></pre> 
<p>执行 OAPServerStartUp 的main方法不报错就没问题。</p> 
<p><strong>2)启动SkyWalking Rocketbot</strong><br> apm-webapp 是 Spring Boot 的 Web项目，执行 ApplicationStartUp 中的 main() 方法。正常启动之后，访问 localhost:8080，看到 SkyWalking Rocketbot 的 UI 界面即为启动成功。<br> 如果修改启动端口，可以直接修改application.yml即可。</p> 
<p><strong>3)直接使用源码中的Agent</strong><br> 项目打包会生成 skywalking-agent.jar ，如下图：<br> <img src="https://images2.imgbox.com/d4/b3/mMzXxJKD_o.png" alt="在这里插入图片描述"><br> 我们来使用一下前面源码工程中打包生成的 skywalking-agent.jar<br> <img src="https://images2.imgbox.com/af/7e/HzPsJV4v_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SkyWalkingAgent</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ILog</span> LOGGER <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SkyWalkingAgent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Main entrance. Use byte-buddy transform to enhance all classes, which define in plugins.
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> agentArgs<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">PluginException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">final</span> <span class="token class-name">PluginFinder</span> pluginFinder<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//初始化加载 agent.config 配置文件，其中会检测 Java Agent 参数以及环境变量是否覆 盖了相应配置项</span>
                    <span class="token class-name">SnifferConfigInitializer</span><span class="token punctuation">.</span><span class="token function">initializeCoreConfig</span><span class="token punctuation">(</span>agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// try to resolve a new logger, and use the new logger to write the error log here</span>
            <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SkyWalkingAgent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"SkyWalking agent initialized failure. Shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// refresh logger again after initialization finishes</span>
            LOGGER <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">SkyWalkingAgent</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//管理插件            </span>
        pluginFinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginFinder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PluginBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">AgentPackageNotFoundException</span> ape<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ape<span class="token punctuation">,</span> <span class="token string">"Locate agent.jar failure. Shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"SkyWalking agent initialized failure. Shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//使用ByteBuddy创建AgentBuilder </span>
         <span class="token keyword">final</span> <span class="token class-name">ByteBuddy</span> byteBuddy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">TypeValidation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Config<span class="token punctuation">.</span>Agent</span><span class="token punctuation">.</span>IS_OPEN_DEBUGGING_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//忽略拦截配置</span>
        <span class="token class-name">AgentBuilder</span> agentBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span>byteBuddy<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span>
                <span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"net.bytebuddy."</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"org.slf4j."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"org.groovy."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">"javassist"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">".asm."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">".reflectasm."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"sun.reflect"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">allSkyWalkingAgentExcludeToolkit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">JDK9ModuleExporter<span class="token punctuation">.</span>EdgeClasses</span> edgeClasses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JDK9ModuleExporter<span class="token punctuation">.</span>EdgeClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            agentBuilder <span class="token operator">=</span> <span class="token class-name">BootstrapInstrumentBoost</span><span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>pluginFinder<span class="token punctuation">,</span> instrumentation<span class="token punctuation">,</span> agentBuilder<span class="token punctuation">,</span> edgeClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"SkyWalking agent inject bootstrap instrumentation failure. Shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            agentBuilder <span class="token operator">=</span> <span class="token class-name">JDK9ModuleExporter</span><span class="token punctuation">.</span><span class="token function">openReadEdge</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">,</span> agentBuilder<span class="token punctuation">,</span> edgeClasses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"SkyWalking agent open read edge in JDK 9+ failure. Shutting down."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Config<span class="token punctuation">.</span>Agent</span><span class="token punctuation">.</span>IS_CACHE_ENHANCED_CLASS<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                agentBuilder <span class="token operator">=</span> agentBuilder<span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheableTransformerDecorator</span><span class="token punctuation">(</span><span class="token class-name">Config<span class="token punctuation">.</span>Agent</span><span class="token punctuation">.</span>CLASS_CACHE_MODE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"SkyWalking agent class cache [{}] activated."</span><span class="token punctuation">,</span> <span class="token class-name">Config<span class="token punctuation">.</span>Agent</span><span class="token punctuation">.</span>CLASS_CACHE_MODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"SkyWalking agent can't active class cache."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
       <span class="token comment">//Java Agent创建代理流程</span>
        agentBuilder<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>pluginFinder<span class="token punctuation">.</span><span class="token function">buildMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>pluginFinder<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">AgentBuilder<span class="token punctuation">.</span>RedefinitionStrategy</span><span class="token punctuation">.</span>RETRANSFORMATION<span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//使用 JDK SPI加载的方式并启动 BootService 服务。</span>
            <span class="token class-name">ServiceManager</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"Skywalking agent boot failure."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//添加一个JVM钩子</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token class-name">ServiceManager</span><span class="token punctuation">.</span>INSTANCE<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">,</span> <span class="token string">"skywalking service shutdown thread"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我们总结一下Skywalking Agent启动流程:</p> 
<pre><code class="prism language-bash"><span class="token number">1</span>:初始化配置信息。该步骤中会加载 agent.config 配置文件，其中会检测 Java Agent 参数以及环境变量是否覆盖了相应配置项。 
<span class="token number">2</span>:查找并解析 skywalking-plugin.def 插件文件。 
<span class="token number">3</span>:AgentClassLoader 加载插件。 
<span class="token number">4</span>:PluginFinder 对插件进行分类管理。 
<span class="token number">5</span>:使用 Byte Buddy 库创建 AgentBuilder。这里会根据已加载的插件动态增强目标类，插入埋点逻辑。
<span class="token number">6</span>:使用 JDK SPI 加载并启动 BootService 服务。BootService 接口的实现会在后面的课时中展开详细介绍。 
<span class="token number">7</span>:添加一个 JVM 钩子，在 JVM 退出时关闭所有 BootService 服务。 
</code></pre> 
<h3><a id="5_Skywalking_Agent_905"></a>5 Skywalking Agent源码剖析</h3> 
<p>前面我们对Skywalking Agent启动流程源码进行了剖析，接下来我们对启动流程中每个步骤源码进行剖析。</p> 
<h4><a id="51__908"></a>5.1 配置初始化</h4> 
<pre><code class="prism language-bash">-javaagent:D:/project/skywalking/skywalking/apm-sniffer/apm-agent/target/skywalking-agent.jar 
-Dskywalking_config<span class="token operator">=</span>D:/project/skywalking/hailtaxi-parent/hailtaxi-driver/src/main/resources/agent.config 
-Dskywalking.collector.backend_service<span class="token operator">=</span><span class="token number">127.0</span>.0.1:11800
</code></pre> 
<p>启动driver服务的时候，会指定skywalking-agent.jar路径，同时会指定 agent.config 配置文件路径，如上配置，此时需要初始化加载该文件，加载流程可以从启动类 SkyWalkingAgent.premain() 方法找答案。<br> <img src="https://images2.imgbox.com/c9/86/CJdXKaPc_o.png" alt="在这里插入图片描述"><br> 加载解析文件的时候，permain()方法会调用initializeCoreConfig(String agentOptions)方法，并解析agent.config文件，并将文件内容存入到Properties中，此时加载是按照${配置项名称:默认值}的格式解析各个配置，如下图：<br> <img src="https://images2.imgbox.com/7c/f8/TzJ71mbI_o.png" alt="在这里插入图片描述"><br> loadConfig() 方法会优先根据环境变量（skywalking_config）指定的 agent.config 文件路径加载。若环境变量未指定 skywalking_ config 配置，则到 skywalking-agent.jar 同级的 config 目录下查找agent.confg 配置文件。<br> <img src="https://images2.imgbox.com/7e/c2/Banj9tO6_o.png" alt="在这里插入图片描述"><br> 解析前后的数据也是不一致的，如下图：<br> <img src="https://images2.imgbox.com/2e/1a/ib8IVm1i_o.png" alt="在这里插入图片描述"><br> overrideConfigBySystemProp() 方法中会遍历环境变量（即 System.getProperties() 集合），如果环境变 是以 “skywalking.” 开头的，则认为是 SkyWalking 的配置，同样会填充到 Config 类中，以覆盖agent.config 中的默认值。如下图：<br> <img src="https://images2.imgbox.com/f6/93/xVEuDmx6_o.png" alt="在这里插入图片描述"><br> ConfigInitializer 工具类，将配置信息填充到 Config 中的静态字段中，SkyWalking Agent 启动所需的全部配置都已经填充到 Config 中，后续使用配置信息时直接访问 Config 中的相应静态字段即可。<br> <img src="https://images2.imgbox.com/36/76/UBaEpOta_o.png" alt="在这里插入图片描述"><br> Config结构：<br> <img src="https://images2.imgbox.com/74/8f/iDwBQKcA_o.png" alt="在这里插入图片描述"></p> 
<p>Config中Agent类的 SERVICE_NAME 对应agent.config中的agent.service_name=<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          x 
         
        
          x 
         
        
       
         C 
        
       
         o 
        
       
         n 
        
       
         f 
        
       
         i 
        
       
         g 
        
       
         中 
        
       
         C 
        
       
         o 
        
       
         l 
        
       
         l 
        
       
         e 
        
       
         c 
        
       
         t 
        
       
         o 
        
       
         r 
        
       
         类 
        
       
         的 
        
       
         B 
        
       
         A 
        
       
         C 
        
       
         K 
        
       
         E 
        
       
         N 
        
        
        
          D 
         
        
          S 
         
        
       
         E 
        
       
         R 
        
       
         V 
        
       
         I 
        
       
         C 
        
       
         E 
        
       
         对 
        
       
         应 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         n 
        
       
         t 
        
       
         . 
        
       
         c 
        
       
         o 
        
       
         n 
        
       
         f 
        
       
         i 
        
       
         g 
        
       
         中 
        
       
         的 
        
       
         a 
        
       
         g 
        
       
         e 
        
       
         n 
        
       
         t 
        
       
         . 
        
       
         b 
        
       
         a 
        
       
         c 
        
       
         k 
        
       
         e 
        
       
         n 
        
        
        
          d 
         
        
          s 
         
        
       
         e 
        
       
         r 
        
       
         v 
        
       
         i 
        
       
         c 
        
       
         e 
        
       
         = 
        
       
      
        {xxx} Config中Collector类的 BACKEND_SERVICE 对应agent.config中的agent.backend_service= 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.88888em; vertical-align: -0.19444em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="mord mathdefault">x</span><span class="mord mathdefault">x</span></span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord cjk_fallback">中</span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault">c</span><span class="mord mathdefault">t</span><span class="mord mathdefault">o</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord cjk_fallback">类</span><span class="mord cjk_fallback">的</span><span class="mord mathdefault" style="margin-right: 0.05017em;">B</span><span class="mord mathdefault">A</span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="mord mathdefault" style="margin-right: 0.07153em;">K</span><span class="mord mathdefault" style="margin-right: 0.05764em;">E</span><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.328331em;"><span class="" style="top: -2.55em; margin-left: -0.02778em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathdefault" style="margin-right: 0.05764em;">E</span><span class="mord mathdefault" style="margin-right: 0.00773em;">R</span><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="mord mathdefault" style="margin-right: 0.07847em;">I</span><span class="mord mathdefault" style="margin-right: 0.07153em;">C</span><span class="mord mathdefault" style="margin-right: 0.05764em;">E</span><span class="mord cjk_fallback">对</span><span class="mord cjk_fallback">应</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault">c</span><span class="mord mathdefault">o</span><span class="mord mathdefault">n</span><span class="mord mathdefault" style="margin-right: 0.10764em;">f</span><span class="mord mathdefault">i</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">的</span><span class="mord mathdefault">a</span><span class="mord mathdefault" style="margin-right: 0.03588em;">g</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord mathdefault">t</span><span class="mord">.</span><span class="mord mathdefault">b</span><span class="mord mathdefault">a</span><span class="mord mathdefault">c</span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="mord mathdefault">e</span><span class="mord mathdefault">n</span><span class="mord"><span class="mord mathdefault">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mord mathdefault">i</span><span class="mord mathdefault">c</span><span class="mord mathdefault">e</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span></span></span></span></span>{xxx}</p> 
<h4><a id="52__933"></a>5.2 插件加载</h4> 
<p>加载插件执行流程：</p> 
<pre><code>1:new PluginBootstrap() 

2:PluginBootstrap().loadPlugins() 

3:AgentClassLoader.initDefaultLoader(); 没有指定类加载器的时候使用 PluginBootstrap.ClassLoader 

4:创建PluginResourcesResolver插件加载解析器 

5:将解析的插件存到List&lt;PluginDefine&gt; pluginClassList，此时只存储了插件的名字和类路径 

6:创建插件实例 

7:将所有插件添加到Skywalking内核中 
</code></pre> 
<p>插件加载流程如下：<br> 在 SkyWalkingAgent.premain() 方法中会执行插件加载，如下代码：</p> 
<pre><code class="prism language-java">pluginFinder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginFinder</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PluginBootstrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>加载插件的全部详细代码如下</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginBootstrap</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ILog</span> LOGGER <span class="token operator">=</span> <span class="token class-name">LogManager</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">PluginBootstrap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * load all plugins.
     *
     * @return plugin definition list.
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadPlugins</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AgentPackageNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//初始化AgentClassLoader</span>
        <span class="token class-name">AgentClassLoader</span><span class="token punctuation">.</span><span class="token function">initDefaultLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//创建PluginResourcesResolver插件加载解析器</span>
        <span class="token class-name">PluginResourcesResolver</span> resolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PluginResourcesResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span>URL<span class="token punctuation">&gt;</span></span> resources <span class="token operator">=</span> resolver<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>resources <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> resources<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            LOGGER<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"no plugin files (skywalking-plugin.def) found, continue to start application."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//循环加载插件路径</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>URL pluginUrl <span class="token operator">:</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//插件会存到List&lt;PluginDefine&gt; pluginClassList，PluginDefine中只有 插件名字和插件类路径</span>
                <span class="token class-name">PluginCfg</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>pluginUrl<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"plugin file [{}] init failure."</span><span class="token punctuation">,</span> pluginUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
         <span class="token comment">//获取解析的插件集合</span>
         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PluginDefine</span><span class="token punctuation">&gt;</span></span> pluginClassList <span class="token operator">=</span> <span class="token class-name">PluginCfg</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">getPluginClassList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> plugins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//循环所有插件</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">PluginDefine</span> pluginDefine <span class="token operator">:</span> pluginClassList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"loading plugin class {}."</span><span class="token punctuation">,</span> pluginDefine<span class="token punctuation">.</span><span class="token function">getDefineClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//创建插件实例（加载插件）</span>
                <span class="token class-name">AbstractClassEnhancePluginDefine</span> plugin <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">)</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>pluginDefine<span class="token punctuation">.</span><span class="token function">getDefineClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">AgentClassLoader</span>
                    <span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                plugins<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token string">"load plugin [{}] failure."</span><span class="token punctuation">,</span> pluginDefine<span class="token punctuation">.</span><span class="token function">getDefineClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//将插件添加到内核中</span>
        plugins<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">DynamicPluginLoader</span><span class="token punctuation">.</span>INSTANCE<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">AgentClassLoader</span><span class="token punctuation">.</span><span class="token function">getDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> plugins<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

</code></pre> 
<p>SkyWalking Agent 加载插件时使用到一个自定义的 ClassLoader ——AgentClassLoader，之所以自定义类加载器，目的是不在应用的 Classpath 中引入 SkyWalking 的插件 jar 包，这样就可以让应用无依赖、无感知的插件。<br> AgentClassLoader 作为一个类加载器，主要工作还是从其 Classpath 下加载类（或资源文件），对应的就是其 findClass() 方法和 findResource() 方法：<br> 我们来看一下findClass，主要根据类名获取它的Class：</p> 
<pre><code class="prism language-java">  <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//扫描classpath所有的jar包</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Jar</span><span class="token punctuation">&gt;</span></span> allJars <span class="token operator">=</span> <span class="token function">getAllJars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//把包替换成路径，最后加上.class</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token char">'.'</span><span class="token punctuation">,</span> <span class="token char">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">".class"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//循环查找所有的jar包</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Jar</span> jar <span class="token operator">:</span> allJars<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//加载jar包的信息</span>
            <span class="token class-name">JarEntry</span> entry <span class="token operator">=</span> jar<span class="token punctuation">.</span>jarFile<span class="token punctuation">.</span><span class="token function">getJarEntry</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//定位当前jar包位置</span>
                <span class="token class-name">URL</span> classFileUrl <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"jar:file:"</span> <span class="token operator">+</span> jar<span class="token punctuation">.</span>sourceFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"!/"</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//加载jar包</span>
                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data<span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">BufferedInputStream</span> is <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedInputStream</span><span class="token punctuation">(</span>
                    classFileUrl<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token keyword">final</span> <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">int</span> ch<span class="token punctuation">;</span>
                    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ch <span class="token operator">=</span> is<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    data <span class="token operator">=</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">return</span> <span class="token function">processLoadedClass</span><span class="token punctuation">(</span><span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                LOGGER<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token string">"find class fail."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token string">"Can't find "</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>findResource()方法主要获取文件路径，换句话理解，就是获取插件路径，我们来看下方法：</p> 
<pre><code class="prism language-java"> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">URL</span> <span class="token function">findResource</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//扫描classpath所有的jar包</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Jar</span><span class="token punctuation">&gt;</span></span> allJars <span class="token operator">=</span> <span class="token function">getAllJars</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//循环查找所有的jar包</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Jar</span> jar <span class="token operator">:</span> allJars<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//加载jar包的信息</span>
            <span class="token class-name">JarEntry</span> entry <span class="token operator">=</span> jar<span class="token punctuation">.</span>jarFile<span class="token punctuation">.</span><span class="token function">getJarEntry</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>entry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//获取jar包的路径</span>
                    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span><span class="token string">"jar:file:"</span> <span class="token operator">+</span> jar<span class="token punctuation">.</span>sourceFile<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"!/"</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MalformedURLException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="53__1075"></a>5.3 解析插件</h4> 
<p>我们在学习插件解析之前，先看看插件是如何定义的。我们可以打开 apm-sniffer/apm-sdk-plugin ，它里面都是要用到的插件集合：<br> <img src="https://images2.imgbox.com/28/2d/EWPQektW_o.png" alt="在这里插入图片描述"><br> 我们看看 mysql-5.x-plugin ，在resources(也就是classpath)中定义skywalking-plugin.def文件，在该文件中定义加载插件需要解析的类，而插件类以key=value形式定义，如下图：<br> <img src="https://images2.imgbox.com/95/0b/JJ1SDoMs_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="531_PluginResourcesResolver_1080"></a>5.3.1 PluginResourcesResolver</h5> 
<p>在 loadPlugins() 方法中使用了 PluginResourcesResolver , PluginResourcesResolver 是 Agent插件的资源解析器，会通过 AgentClassLoader 中的 findResource() 方法读取所有 Agent 插件中的 skywalking-plugin.def 文件。<br> <img src="https://images2.imgbox.com/bd/a2/AavNBbf3_o.png" alt="在这里插入图片描述"><br> 拿到全部插件的 skywalking-plugin.def 文件之后，PluginCfg 会逐行进行解析，转换成<br> PluginDefine 对象。PluginDefine 中有两个字段,分别对应 skywalking-plugin.def 中的key和value，解析流程如下：<br> <img src="https://images2.imgbox.com/4b/cb/R0SYRpBP_o.png" alt="在这里插入图片描述"><br> 接下来会遍历全部 PluginDefine 对象，通过反射将其中 defineClass 字段中记录的插件类实例化，核心逻辑如下：<br> <img src="https://images2.imgbox.com/c3/12/uQP87tO3_o.png" alt="在这里插入图片描述"><br> AbstractClassEnhancePluginDefine 抽象类是所有 Agent 插件类的顶级父类，其中定义了四个核心方法，决定了一个插件类应该增强哪些目标类、应该如何增强、具体插入哪些逻辑，如下所示：<br> <img src="https://images2.imgbox.com/4f/97/wAquA9zD_o.png" alt="在这里插入图片描述"><br> <strong>enhanceClass()</strong> <strong>方法</strong>：返回的 ClassMatch，用于匹配当前插件要增强的目标类。<br> <strong>defifine()</strong> <strong>方法</strong>：插件类增强逻辑的入口，底层会调用下面的 enhance() 方法和 witnessClass() 方法。<br> <strong>enhance()</strong> <strong>方法</strong>：真正执行增强逻辑的地方。<br> <strong>witnessClass()</strong> <strong>方法</strong>：一个开源组件可能有多个版本，插件会通过该方法识别组件的不同版本，防止对不兼容的版本进行增强。<br> <strong>ClassMatch</strong><br> enhanceClass() 方法决定了一个插件类要增强的目标类，返回值为 ClassMatch 类型对象。<br> ClassMatch 类似于一个过滤器，可以通过多种方式匹配到目标类，ClassMatch 接口的实现如下：<br> <img src="https://images2.imgbox.com/e6/8a/4LlN0aIL_o.png" alt="在这里插入图片描述"><br> <strong>NameMatch</strong>：根据其 className 字段（String 类型）匹配目标类的名称。</p> 
<p><strong>IndirectMatch</strong>：子接口中定义了两个方法。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IndirectMatch</span> <span class="token keyword">extends</span> <span class="token class-name">ClassMatch</span> <span class="token punctuation">{<!-- --></span> 

<span class="token comment">//Junction是Byte Buddy中的类，可以通过and、or等操作串联多个ElementMatcher,进行匹配</span>

<span class="token class-name">ElementMatcher<span class="token punctuation">.</span>Junction</span> <span class="token function">buildJunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">//用于检测传入的类型是否匹配该Match </span>

<span class="token keyword">boolean</span> <span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token class-name">TypeDescription</span> typeDescription<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span> 
</code></pre> 
<p><strong>MultiClassNameMatch</strong>：其中会指定一个 matchClassNames 集合，该集合内的类即为目标类。</p> 
<p><strong>ClassAnnotationMatch</strong>：根据标注在类上的注解匹配目标类。</p> 
<p><strong>MethodAnnotationMatch</strong>：根据标注在方法上的注解匹配目标类。</p> 
<p><strong>HierarchyMatch</strong>：根据父类或是接口匹配目标类。</p> 
<p>我们来分析一下ClassAnnotationMatch的buildJunction()方法和isMatch()方法：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ElementMatcher<span class="token punctuation">.</span>Junction</span> <span class="token function">buildJunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ElementMatcher<span class="token punctuation">.</span>Junction</span> junction <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//annotations：指定了该 ClassAnnotationMatch 对象需要检查的注解 </span>
        <span class="token comment">//遍历该对象需要检查的所有注解</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">IndirectMatch</span> indirectMatch <span class="token operator">:</span> indirectMatches<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>junction <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//检测类是否标注了指定注解</span>
                junction <span class="token operator">=</span> indirectMatch<span class="token punctuation">.</span><span class="token function">buildJunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//使用 and 方式将所有Junction对象连接起来</span>
                junction <span class="token operator">=</span> junction<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span>indirectMatch<span class="token punctuation">.</span><span class="token function">buildJunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
       <span class="token comment">// 排除接口</span>
        <span class="token keyword">return</span> junction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>isMatch()方法如下：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span> 

<span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isMatch</span><span class="token punctuation">(</span><span class="token class-name">TypeDescription</span> typeDescription<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 

<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> annotationList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> 

<span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>annotations<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 获取该类上的注解 </span>

<span class="token class-name">AnnotationList</span> declaredAnnotations <span class="token operator">=</span> 

typeDescription<span class="token punctuation">.</span><span class="token function">getDeclaredAnnotations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token comment">// 匹配一个删除一个 </span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AnnotationDescription</span> annotation <span class="token operator">:</span> declaredAnnotations<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 

annotationList<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>annotation<span class="token punctuation">.</span><span class="token function">getAnnotationType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getActualName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span>

<span class="token comment">// 如果全部删除，则匹配成功 </span>

<span class="token keyword">return</span> annotationList<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="532_PluginFinder_1176"></a>5.3.2 PluginFinder</h5> 
<p>PluginFinder 是 AbstractClassEnhancePluginDefine 查找器，可以根据给定的类查找用于增强的AbstractClassEnhancePluginDefine 集合。<br> 在 PluginFinder 的构造函数中会遍历前面课程已经实例化的AbstractClassEnhancePluginDefine ，并根据 enhanceClass() 方法返回的 ClassMatcher 类型进行分类，得到如下两个集合：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginFinder</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//pluginFinder将插件分类保存在两个集合中，分别是：按名字分类和按其他辅助信息分类</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LinkedList</span><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> nameMatchDefine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">LinkedList</span><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> signatureMatchDefine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> bootstrapClassMatchDefine <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">//构造方法</span>
    <span class="token keyword">public</span> <span class="token class-name">PluginFinder</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//抽象方法enhanceClass方法定义在插件的抽象基类 AbstractClassEnhancePluginDefine中，每一个插件必须去实现这个类中的方法</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractClassEnhancePluginDefine</span> plugin <span class="token operator">:</span> plugins<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//故enhanceClass是每个插件 都会自己去实现的方法，指定需要增强的类</span>
            <span class="token class-name">ClassMatch</span> match <span class="token operator">=</span> plugin<span class="token punctuation">.</span><span class="token function">enhanceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token keyword">instanceof</span> <span class="token class-name">NameMatch</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">NameMatch</span> nameMatch <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">NameMatch</span><span class="token punctuation">)</span> match<span class="token punctuation">;</span>
                <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> pluginDefines <span class="token operator">=</span> nameMatchDefine<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>nameMatch<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>pluginDefines <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    pluginDefines <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    nameMatchDefine<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>nameMatch<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pluginDefines<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                pluginDefines<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                signatureMatchDefine<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>plugin<span class="token punctuation">.</span><span class="token function">isBootstrapInstrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                bootstrapClassMatchDefine<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plugin<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token comment">//typeDescription是bytebuddy的内置接口，是对类的完整描述，包含了类的全类名 </span>
<span class="token comment">//传入typeDescription，返回可以运用于typeDescription的类的插件</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token class-name">TypeDescription</span> typeDescription<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> matchedPlugins <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//根据名字信息匹配查找</span>
        <span class="token class-name">String</span> typeName <span class="token operator">=</span> typeDescription<span class="token punctuation">.</span><span class="token function">getTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nameMatchDefine<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            matchedPlugins<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>nameMatchDefine<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>typeName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//通过除了名字之外的辅助信息，在signatureMatchDefine集合中查找</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractClassEnhancePluginDefine</span> pluginDefine <span class="token operator">:</span> signatureMatchDefine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">IndirectMatch</span> match <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">IndirectMatch</span><span class="token punctuation">)</span> pluginDefine<span class="token punctuation">.</span><span class="token function">enhanceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match<span class="token punctuation">.</span><span class="token function">isMatch</span><span class="token punctuation">(</span>typeDescription<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                matchedPlugins<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>pluginDefine<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> matchedPlugins<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">ElementMatcher</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">TypeDescription</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//设置匹配的规则，名字是否相同，通过名字直接匹配</span>
        <span class="token class-name">ElementMatcher<span class="token punctuation">.</span>Junction</span> judge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AbstractJunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">NamedElement</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">NamedElement</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> nameMatchDefine<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getActualName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment">//接口不增强，排除掉</span>
        <span class="token comment">//如果无法确定类的全限定名，则通过注解、回调信息等辅助方法间接匹配</span>
        judge <span class="token operator">=</span> judge<span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token function">not</span><span class="token punctuation">(</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractClassEnhancePluginDefine</span> define <span class="token operator">:</span> signatureMatchDefine<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">ClassMatch</span> match <span class="token operator">=</span> define<span class="token punctuation">.</span><span class="token function">enhanceClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>match <span class="token keyword">instanceof</span> <span class="token class-name">IndirectMatch</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                judge <span class="token operator">=</span> judge<span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">IndirectMatch</span><span class="token punctuation">)</span> match<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">buildJunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ProtectiveShieldMatcher</span><span class="token punctuation">(</span>judge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> <span class="token function">getBootstrapClassMatchDefine</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> bootstrapClassMatchDefine<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="533_AgentBuilder_1260"></a>5.3.3 AgentBuilder</h5> 
<p>利用bytebuddy的API生成一个代理，并执行transform方法和监听器Listener（主要是日志相关）。<br> 在premain中，通过链式调用，被builderMatch()匹配到的类都会执行transform方法，transform定义了字节码增强的逻辑：</p> 
<pre><code class="prism language-java"><span class="token comment">//使用ByteBuddy创建AgentBuilder </span>
<span class="token keyword">final</span> <span class="token class-name">ByteBuddy</span> byteBuddy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteBuddy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token class-name">TypeValidation</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">Config<span class="token punctuation">.</span>Agent</span><span class="token punctuation">.</span>IS_OPEN_DEBUGGING_CLASS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>Config.Agent.IS_OPEN_DEBUGGING_CLASS 在 agent.config 中对应配置agent.is_open_debugging_class<br> 如果将其配置为 true，则会将动态生成的类输出到 debugging 目录中。<br> AgentBuilder 是 Byte Buddy 库专门用来支持 Java Agent 的一个 API，如下所示：</p> 
<pre><code class="prism language-java"><span class="token keyword">new</span> <span class="token class-name">AgentBuilder<span class="token punctuation">.</span>Default</span><span class="token punctuation">(</span>byteBuddy<span class="token punctuation">)</span> <span class="token comment">// 设置使用的ByteBuddy对象 </span>
  <span class="token punctuation">.</span><span class="token function">ignore</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"net.bytebuddy."</span><span class="token punctuation">)</span><span class="token comment">// 不会拦截下列包中的类 </span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"org.slf4j."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"org.apache.logging."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"org.groovy."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">"javassist"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameContains</span><span class="token punctuation">(</span><span class="token string">".asm."</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">nameStartsWith</span><span class="token punctuation">(</span><span class="token string">"sun.reflect"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token function">allSkyWalkingAgentExcludeToolkit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 处理 Skywalking 的类 </span>
<span class="token comment">// synthetic类和方法是由编译器生成的，这种类也需要忽略 </span>
  <span class="token punctuation">.</span><span class="token function">or</span><span class="token punctuation">(</span><span class="token class-name">ElementMatchers</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TypeDescription</span><span class="token punctuation">&gt;</span></span><span class="token function">isSynthetic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
  <span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span>pluginFinder<span class="token punctuation">.</span><span class="token function">buildMatch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">// 拦截 </span>
  <span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">(</span>pluginFinder<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置Transform </span>
  <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Listener</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置Listener </span>
  <span class="token punctuation">.</span><span class="token function">installOn</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">)</span>
</code></pre> 
<p>上面代码中有些方法我们需要理解一下：<br> <strong>ignore()</strong> <strong>方法</strong>：忽略指定包中的类，对这些类不会进行拦截增强。<br> <strong>type()</strong> <strong>方法</strong>：在类加载时根据传入的 ElementMatcher 进行拦截，拦截到的目标类将会被transform() 方法中指定的 Transformer 进行增强。<br> <strong>transform()</strong> <strong>方法</strong>：这里指定的 Transformer 会对前面拦截到的类进行增强。<br> <strong>with()</strong> <strong>方法</strong>：添加一个 Listener 用来监听 AgentBuilder 触发的事件。<br> 首先， PluginFInder.buildMatch() 方法返回的 ElementMatcher 对象会将全部插件的匹配规则（即插件的 enhanceClass() 方法返回的 ClassMatch）用 OR 的方式连接起来，这样，所有插件能匹配到的所有类都会交给 Transformer 处理。<br> 再来看 with() 方法中添加的监听器 —— SkywalkingAgent.Listener，它继承了 AgentBuilder.Listener接口，当监听到 Transformation 事件时，会根据 IS_OPEN_DEBUGGING_CLASS 配置决定是否将增强之后的类持久化成 class 文件保存到指定的 log 目录中。注意，该操作是需要加锁的，会影响系统的性能，一般只在测试环境中开启，在生产环境中不会开启。<br> Skywalking.Transformer实现了 AgentBuilder.Transformer 接口，其 transform() 方法是插件增强目标类的入口。Skywalking.Transformer 会通过 PluginFinder 查找目标类匹配的插件（即AbstractClassEnhancePluginDefifine 对象），然后交由 AbstractClassEnhancePluginDefifine 完成增强，核心实现如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>builder<span class="token punctuation">,</span> 
<span class="token class-name">TypeDescription</span> typeDescription<span class="token punctuation">,</span> <span class="token comment">// 被拦截的目标类1：实际插件演示</span>
<span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">,</span> <span class="token comment">// 加载目标类的ClassLoader </span>
<span class="token class-name">JavaModule</span> <span class="token keyword">module</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
<span class="token comment">// 从PluginFinder中查找匹配该目标类的插件，PluginFinder的查找逻辑不再重复 </span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AbstractClassEnhancePluginDefine</span><span class="token punctuation">&gt;</span></span> pluginDefines <span class="token operator">=</span> 
pluginFinder<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>typeDescription<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>pluginDefines<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> 
<span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>newBuilder <span class="token operator">=</span> builder<span class="token punctuation">;</span> 
<span class="token class-name">EnhanceContext</span> context <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnhanceContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AbstractClassEnhancePluginDefinedefine</span> <span class="token operator">:</span> pluginDefines<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
<span class="token comment">// AbstractClassEnhancePluginDefine.define()方法是插件入口， </span>
<span class="token comment">// 在其中完成了对目标类的增强 </span>
<span class="token class-name">DynamicType<span class="token punctuation">.</span>Builder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span>possibleNewBuilder <span class="token operator">=</span> 
define<span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span>typeDescription<span class="token punctuation">,</span> 
newBuilder<span class="token punctuation">,</span> classLoader<span class="token punctuation">,</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>possibleNewBuilder <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
<span class="token comment">// 注意这里，如果匹配了多个插件，会被增强多次 </span>
newBuilder <span class="token operator">=</span> possibleNewBuilder<span class="token punctuation">;</span> 
  <span class="token punctuation">}</span> 
 <span class="token punctuation">}</span>
  <span class="token keyword">return</span> newBuilder<span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token keyword">return</span> builder<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6880d6aa9fd808ebb3ea9280faa3e9c9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Kubernetes搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8374b7cbae522355b1ff22bebeb875bd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何查看已链接手机的wifi密码？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>