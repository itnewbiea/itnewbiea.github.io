<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ROS2_Foxy学习5——基础编程_C&#43;&#43; - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ROS2_Foxy学习5——基础编程_C&#43;&#43;" />
<meta property="og:description" content="ROS2_Foxy学习5——基础编程_C&#43;&#43; 1 workspace1.1 工作空间及其层次1.2 检查依赖1.3 编译工具 colcon 2 编写 package2.1 功能包创建2.2 package.xml 和 CMakeLists.txt2.3 功能包编译、设置环境变量、运行 3 编写 topic3.1 发布 publisher3.2 订阅 subscriber3.3 修改 package.xml / CMakeLists.txt3.4 编译、运行两个节点 4 编写 service4.1 服务器端 server4.2 客户端 client4.3 修改 package.xml / CMakeLists.txt4.4 编译、运行两个节点 5 自定义消息 msg/srv5.1 创建消息功能包5.2 测试自定义消息接口5.3 应用自定义消息接口5.4 使用同一功能包的消息接口 6 使用 parameter6.1 参数的声明与获取6.2 终端修改参数6.3 launch文件修改参数 附件1 消息文件应用 里面的例子参考 官方教程，然后附带一些解释和一些推荐的便于理解的文章。 1 workspace 1.1 工作空间及其层次 空间的创建：ROS2与ROS1一样，创建工作空间目录，并在其中创建/src目录，用于存放package功能包。
层次的概念：ROS2增加了overlay和underlay的概念，用于在多个workspace同时工作时，处理各个workspace之间的层次问题，对于包名相同的package，上层workspace将覆盖(override)下层workspace中的同名package。
层次的配置：层次是通过环境变量配置的先后决定的，ROS通过setup.bash设置环境变量，ROS2安装路径一般设置为最下层的工作空间，即
$ source /opt/ros/foxy/setup.bash 运行新建workspace的package功能包，需要在对工作空间编译后的新终端中配置如下
# 设置当前工作空间中功能包的相关环境变量 $ ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/39e545df947dced3694f4a399be52805/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-29T17:18:49+08:00" />
<meta property="article:modified_time" content="2020-12-29T17:18:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ROS2_Foxy学习5——基础编程_C&#43;&#43;</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>ROS2_Foxy学习5——基础编程_C++</h4> 
 <ul><li><a href="#1_workspace_2" rel="nofollow">1 workspace</a></li><li><ul><li><a href="#11__3" rel="nofollow">1.1 工作空间及其层次</a></li><li><a href="#12__22" rel="nofollow">1.2 检查依赖</a></li><li><a href="#13__colcon_27" rel="nofollow">1.3 编译工具 colcon</a></li></ul> 
  </li><li><a href="#2__package_37" rel="nofollow">2 编写 package</a></li><li><ul><li><a href="#21__40" rel="nofollow">2.1 功能包创建</a></li><li><a href="#22_packagexml__CMakeListstxt_66" rel="nofollow">2.2 package.xml 和 CMakeLists.txt</a></li><li><a href="#23__101" rel="nofollow">2.3 功能包编译、设置环境变量、运行</a></li></ul> 
  </li><li><a href="#3__topic_115" rel="nofollow">3 编写 topic</a></li><li><ul><li><a href="#31__publisher_117" rel="nofollow">3.1 发布 publisher</a></li><li><a href="#32__subscriber_179" rel="nofollow">3.2 订阅 subscriber</a></li><li><a href="#33__packagexml__CMakeListstxt_213" rel="nofollow">3.3 修改 package.xml / CMakeLists.txt</a></li><li><a href="#34__240" rel="nofollow">3.4 编译、运行两个节点</a></li></ul> 
  </li><li><a href="#4__service_257" rel="nofollow">4 编写 service</a></li><li><ul><li><a href="#41__server_259" rel="nofollow">4.1 服务器端 server</a></li><li><a href="#42__client_297" rel="nofollow">4.2 客户端 client</a></li><li><a href="#43__packagexml__CMakeListstxt_360" rel="nofollow">4.3 修改 package.xml / CMakeLists.txt</a></li><li><a href="#44__386" rel="nofollow">4.4 编译、运行两个节点</a></li></ul> 
  </li><li><a href="#5__msgsrv_402" rel="nofollow">5 自定义消息 msg/srv</a></li><li><ul><li><a href="#51__403" rel="nofollow">5.1 创建消息功能包</a></li><li><a href="#52__461" rel="nofollow">5.2 测试自定义消息接口</a></li><li><a href="#53__463" rel="nofollow">5.3 应用自定义消息接口</a></li><li><a href="#54__470" rel="nofollow">5.4 使用同一功能包的消息接口</a></li></ul> 
  </li><li><a href="#6__parameter_477" rel="nofollow">6 使用 parameter</a></li><li><ul><li><a href="#61__479" rel="nofollow">6.1 参数的声明与获取</a></li><li><a href="#62__530" rel="nofollow">6.2 终端修改参数</a></li><li><a href="#63_launch_536" rel="nofollow">6.3 launch文件修改参数</a></li></ul> 
  </li><li><a href="#1__567" rel="nofollow">附件1 消息文件应用</a></li></ul> 
</div> 
<br> 里面的例子参考 
<a href="https://github.com/ros2/ros2_documentation">官方教程</a>，然后附带一些解释和一些推荐的便于理解的文章。 
<p></p> 
<h2><a id="1_workspace_2"></a>1 workspace</h2> 
<h3><a id="11__3"></a>1.1 工作空间及其层次</h3> 
<p>  <strong>空间的创建</strong>：ROS2与ROS1一样，创建工作空间目录，并在其中创建/src目录，用于存放package功能包。</p> 
<p>  <strong>层次的概念</strong>：ROS2增加了overlay和underlay的概念，用于在多个workspace同时工作时，处理各个workspace之间的层次问题，对于包名相同的package，上层workspace将覆盖(override)下层workspace中的同名package。</p> 
<p>  <strong>层次的配置</strong>：层次是通过环境变量配置的先后决定的，ROS通过setup.bash设置环境变量，ROS2安装路径一般设置为最下层的工作空间，即</p> 
<pre><code class="prism language-powershell">$ source <span class="token operator">/</span>opt<span class="token operator">/</span>ros<span class="token operator">/</span>foxy<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash
</code></pre> 
<p>  运行新建workspace的package功能包，需要在对工作空间编译后的新终端中配置如下</p> 
<pre><code class="prism language-powershell"><span class="token comment"># 设置当前工作空间中功能包的相关环境变量</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>local_setup<span class="token punctuation">.</span>sh 

<span class="token comment"># 设置当前工作空间中功能包的相关环境变量，同时设置该工作空间下其他底层工作空间的环境变量</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>setup<span class="token punctuation">.</span>sh	<span class="token comment"># 就是说这一个捎带着把ROS2安装路径的环境变量也设置了</span>
</code></pre> 
<h3><a id="12__22"></a>1.2 检查依赖</h3> 
<p>  编译前，需要对功能包检查依赖情况。</p> 
<pre><code class="prism language-powershell">$ rosdep install <span class="token operator">-</span>i <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>path src <span class="token operator">--</span>rosdistro foxy <span class="token operator">-</span>y
</code></pre> 
<h3><a id="13__colcon_27"></a>1.3 编译工具 colcon</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># 在workspace根目录编译工程</span>
$ colcon build	

<span class="token comment"># 有选择地编译包</span>
$ colcon build <span class="token operator">--</span>packages<span class="token operator">-</span><span class="token function">select</span> &lt;package_name&gt;
</code></pre> 
<p>  有关编译，可看一下后续的系列第七篇——<a href="https://blog.csdn.net/fangfang12138/article/details/112019046">编译</a>。</p> 
<h2><a id="2__package_37"></a>2 编写 package</h2> 
<p>  每一个package都能实现一个相对完整的功能。</p> 
<h3><a id="21__40"></a>2.1 功能包创建</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># 创建cmake功能包（在~/ws/src下）</span>
$ ros2 pkg create <span class="token operator">--</span>build<span class="token operator">-</span><span class="token function">type</span> ament_cmake &lt;package_name&gt;

<span class="token comment"># 创建cmake功能包（在~/ws/src下）</span>
<span class="token comment"># --dependencies 参数会将后边的依赖自动添加到package.xml和CMakeLists.txt中</span>
$ ros2 pkg create <span class="token operator">--</span>build<span class="token operator">-</span><span class="token function">type</span> ament_cmake &lt;package_name&gt; <span class="token operator">--</span>dependencies &lt;depend_name&gt;

<span class="token comment"># 创建cmake功能包（在~/ws/src下）</span>
<span class="token comment"># --node-name 参数将创建节点，但只能创建一个节点，注意参数位置</span>
$ ros2 pkg create <span class="token operator">--</span>build<span class="token operator">-</span><span class="token function">type</span> ament_cmake <span class="token operator">--</span>node<span class="token operator">-</span>name &lt;node_name&gt; &lt;package_name&gt;

	<span class="token comment"># 例如（在~/ws/src下）</span>
	$ ros2 pkg create <span class="token operator">--</span>build<span class="token operator">-</span><span class="token function">type</span> ament_cmake <span class="token operator">--</span>node<span class="token operator">-</span>name my_node my_package <span class="token operator">--</span>dependencies rclcpp
	<span class="token comment"># 将会在~/ws/src创建如下目录</span>
	workspace_folder<span class="token operator">/</span>
	    src<span class="token operator">/</span> 
	        my_package<span class="token operator">/</span> 
	        	 src<span class="token operator">/</span>
	        	 	my_node<span class="token punctuation">.</span><span class="token function">cpp</span>
	        	 include<span class="token operator">/</span>
	        	 	my_package<span class="token operator">/</span>
	             CMakeLists<span class="token punctuation">.</span>txt
	             package<span class="token punctuation">.</span>xml
</code></pre> 
<h3><a id="22_packagexml__CMakeListstxt_66"></a>2.2 package.xml 和 CMakeLists.txt</h3> 
<p>  使用ament编译系统的功能包会对应生成两个文件package.xml和CMakeLists.txt。<br>   <strong>package.xml</strong>：描述了功能包的发行信息、依赖信息等，内容如下。在自动创建后，需要手动修改功能包描述、功能包版本、功能包许可证信息等发行信息。以“ _depend”结尾的标签用来描述功能包依赖，在增加新的依赖时，需要添加到其中。</p> 
<pre><code class="prism language-xml"><span class="token comment">&lt;!--  功能包基础内容，不用修改   --&gt;</span>
<span class="token prolog">&lt;?xml version="1.0"?&gt;</span>
<span class="token prolog">&lt;?xml-model href="http://download.ros.org/schema/package_format3.xsd" schematypens="http://www.w3.org/2001/XMLSchema"?&gt;</span>
<span class="token comment">&lt;!--  下面是功能包的信息  --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name">format</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>3<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--  包名，新建的时候就定了，不改  --&gt;</span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>cpp_srvcli<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--  关于发行信息   --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>description</span><span class="token punctuation">&gt;</span></span>这里写功能描述<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>description</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maintainer</span> <span class="token attr-name">email</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>这里写邮箱地址<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Your Name<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maintainer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>license</span><span class="token punctuation">&gt;</span></span>这里写许可证<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>license</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!--  编译系统的依赖   --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>buildtool_depend</span><span class="token punctuation">&gt;</span></span>ament_cmake<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>buildtool_depend</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--  程序所需的依赖，根据需要修改添加   --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>rclcpp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
	<span class="token comment">&lt;!--  编译系统，新建功能包的时候可以指定   --&gt;</span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>export</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build_type</span><span class="token punctuation">&gt;</span></span>ament_cmake<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build_type</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>export</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>package</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  <strong>CMakeLists.txt</strong>：制定各文件或包的编译顺序的文档，如何编写CMakeLists.txt参见本系列第七篇——<a href="https://blog.csdn.net/fangfang12138/article/details/112019046">编译</a>。文档基本结构如下。</p> 
<pre><code class="prism language-cpp"><span class="token function">cmake_minimum_required</span><span class="token punctuation">(</span>VERSION <span class="token number">3.5</span><span class="token punctuation">)</span>	<span class="token comment">//cmake版本要求</span>
<span class="token function">project</span><span class="token punctuation">(</span>my_project<span class="token punctuation">)</span>					<span class="token comment">//功能包名，与同一功能包下package.xml中名字一样</span>

<span class="token function">ament_package</span><span class="token punctuation">(</span><span class="token punctuation">)</span>						<span class="token comment">//配置project，只调用一次，且在最后</span>
</code></pre> 
<h3><a id="23__101"></a>2.3 功能包编译、设置环境变量、运行</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># 记得检查依赖</span>
$ rosdep install <span class="token operator">-</span>i <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>path src <span class="token operator">--</span>rosdistro foxy <span class="token operator">-</span>y

<span class="token comment"># 编译，见上一小节</span>
$ colcon build

<span class="token comment"># 新终端设置环境变量</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash

<span class="token comment"># 运行包里的某个节点，运行多个节点、多个包，可使用launch文件</span>
$ ros2 run &lt;package_name&gt; &lt;node_name&gt;
</code></pre> 
<h2><a id="3__topic_115"></a>3 编写 topic</h2> 
<p>新建工作空间，并新建话题功能包（这里包名是cpp_pubsub）。</p> 
<h3><a id="31__publisher_117"></a>3.1 发布 publisher</h3> 
<p>在功能包的/src目录下，编写话题发布节点，publisher_member_function.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span>			<span class="token comment">//c++11日期和时间库		</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span>		<span class="token comment">//参见 注1</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span>			<span class="token comment">//c++内存管理库，使用智能指针必须包含此头文件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span>	<span class="token comment">//ROS2，C++接口的头文件</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"std_msgs/msg/string.hpp"</span>	<span class="token comment">//string类型的msg头文件</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token operator">::</span>chrono_literals<span class="token punctuation">;</span>

<span class="token comment">/* This example creates a subclass of Node and uses std::bind() to register a
* member function as a callback from the timer. */</span>

<span class="token comment">//定义一个节点类的子类</span>
<span class="token keyword">class</span> <span class="token class-name">MinimalPublisher</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span></span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span><span class="token operator">:</span>
	  	<span class="token comment">//构造函数：初始化节点名 minimal_publisher，然后创建了一个publisher和定时器</span>
	    <span class="token function">MinimalPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token string">"minimal_publisher"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	    <span class="token punctuation">{<!-- --></span>
	    	<span class="token comment">//创建一个发布者，发布的话题名为topic，话题消息是String，保存消息的队列长度是10</span>
      		publisher_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>create_publisher<span class="token operator">&lt;</span>std_msgs<span class="token operator">::</span>msg<span class="token operator">::</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	      	<span class="token comment">//创建一个定时器，定时500ms，定时触发回调函数timer_callback。</span>
	      	<span class="token comment">//这里用到了&lt;functional&gt;的一个特性</span>
	      	timer_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">create_wall_timer</span><span class="token punctuation">(</span><span class="token number">500</span>ms<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MinimalPublisher<span class="token operator">::</span>timer_callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>

  <span class="token keyword">private</span><span class="token operator">:</span>
  		<span class="token comment">//定时触发回调函数</span>
	    <span class="token keyword">void</span> <span class="token function">timer_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	    <span class="token punctuation">{<!-- --></span>
	    	<span class="token comment">//定义消息</span>
		    <span class="token keyword">auto</span> message <span class="token operator">=</span> std_msgs<span class="token operator">::</span>msg<span class="token operator">::</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    message<span class="token punctuation">.</span>data <span class="token operator">=</span> <span class="token string">"Hello, world! "</span> <span class="token operator">+</span> std<span class="token operator">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>count_<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token comment">//打印日志</span>
		    <span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Publishing: '%s'"</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		    <span class="token comment">//发布</span>
		    publisher_<span class="token operator">-&gt;</span><span class="token function">publish</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token punctuation">}</span>
    
    	<span class="token comment">//定义定时器和发布者指针</span>
	    rclcpp<span class="token operator">::</span>TimerBase<span class="token operator">::</span>SharedPtr timer_<span class="token punctuation">;</span>
	    rclcpp<span class="token operator">::</span>Publisher<span class="token operator">&lt;</span>std_msgs<span class="token operator">::</span>msg<span class="token operator">::</span>String<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr publisher_<span class="token punctuation">;</span>
	    
	    size_t count_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token punctuation">{<!-- --></span>
	    rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	    rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>MinimalPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>注：<br> 1、#include &lt; functional &gt; ，感兴趣的读者可以看下<a href="https://www.cnblogs.com/denggelin/p/5651456.html" rel="nofollow">这篇博客</a>，写的蛮不错的。</p> 
<h3><a id="32__subscriber_179"></a>3.2 订阅 subscriber</h3> 
<p>在功能包的/src目录下，编写话题订阅节点，subscriber_member_function.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"std_msgs/msg/string.hpp"</span></span>
<span class="token keyword">using</span> std<span class="token operator">::</span>placeholders<span class="token operator">::</span>_1<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MinimalSubscriber</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">MinimalSubscriber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token string">"minimal_subscriber"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      subscription_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>create_subscription<span class="token operator">&lt;</span>std_msgs<span class="token operator">::</span>msg<span class="token operator">::</span>String<span class="token operator">&gt;</span><span class="token punctuation">(</span>
      <span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MinimalSubscriber<span class="token operator">::</span>topic_callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">topic_callback</span><span class="token punctuation">(</span><span class="token keyword">const</span> std_msgs<span class="token operator">::</span>msg<span class="token operator">::</span>String<span class="token operator">::</span>SharedPtr msg<span class="token punctuation">)</span> <span class="token keyword">const</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"I heard: '%s'"</span><span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>data<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    rclcpp<span class="token operator">::</span>Subscription<span class="token operator">&lt;</span>std_msgs<span class="token operator">::</span>msg<span class="token operator">::</span>String<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr subscription_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>MinimalSubscriber<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="33__packagexml__CMakeListstxt_213"></a>3.3 修改 package.xml / CMakeLists.txt</h3> 
<p>  package.xml 添加如下依赖，如果创建包时，使用了–dependencies，则文件内已有如下语句。</p> 
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>rclcpp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>std_msgs<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  CMakeLists.txt 添加如下编译规则，如果创建包时，使用了–dependencies，则文件内已有find_package相关的语句。</p> 
<pre><code class="prism language-bash"><span class="token comment"># 搜索依赖</span>
    find_package<span class="token punctuation">(</span>rclcpp REQUIRED<span class="token punctuation">)</span>
    find_package<span class="token punctuation">(</span>std_msgs REQUIRED<span class="token punctuation">)</span>
<span class="token comment"># 创建可执行程序talker，后续参数是构成可执行文件的所有源文件</span>
    add_executable<span class="token punctuation">(</span>talker src/publisher_member_function.cpp<span class="token punctuation">)</span>
<span class="token comment"># 链接find_package()找到的包</span>
    ament_target_dependencies<span class="token punctuation">(</span>talker rclcpp std_msgs<span class="token punctuation">)</span>

    add_executable<span class="token punctuation">(</span>listener src/subscriber_member_function.cpp<span class="token punctuation">)</span>
    ament_target_dependencies<span class="token punctuation">(</span>listener rclcpp std_msgs<span class="token punctuation">)</span>

    install<span class="token punctuation">(</span>TARGETS
      talker
      listener
      DESTINATION
      lib/<span class="token variable">${PROJECT_NAME}</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="34__240"></a>3.4 编译、运行两个节点</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># 在工作空间根目录下，检查依赖</span>
$ rosdep install <span class="token operator">-</span>i <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>path src <span class="token operator">--</span>rosdistro foxy <span class="token operator">-</span>y
<span class="token comment"># 编译</span>
$ colcon build

<span class="token comment"># 配置环境变量，然后运行</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash
$ ros2 run cpp_pubsub talker

<span class="token comment"># 打开另一个终端，配置环境变量，运行</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash
$ ros2 run cpp_pubsub listener
</code></pre> 
<h2><a id="4__service_257"></a>4 编写 service</h2> 
<p>新建工作空间，并新建服务功能包（这里包名是cpp_srvcli）。</p> 
<h3><a id="41__server_259"></a>4.1 服务器端 server</h3> 
<p>在功能包的/src目录下，创建服务器端节点，add_two_ints_server.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"example_interfaces/srv/add_two_ints.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">::</span>Request<span class="token operator">&gt;</span> request<span class="token punctuation">,</span>
      std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">::</span>Response<span class="token operator">&gt;</span>      response<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	response<span class="token operator">-&gt;</span>sum <span class="token operator">=</span> request<span class="token operator">-&gt;</span>a <span class="token operator">+</span> request<span class="token operator">-&gt;</span>b<span class="token punctuation">;</span>
	<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Incoming request\na: %ld"</span> <span class="token string">" b: %ld"</span><span class="token punctuation">,</span>
		    request<span class="token operator">-&gt;</span>a<span class="token punctuation">,</span> request<span class="token operator">-&gt;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sending back response: [%ld]"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span>response<span class="token operator">-&gt;</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//创建名为add_two_ints_server的节点</span>
	std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>rclcpp<span class="token operator">::</span>Node<span class="token operator">&gt;</span> node <span class="token operator">=</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span><span class="token operator">::</span><span class="token function">make_shared</span><span class="token punctuation">(</span><span class="token string">"add_two_ints_server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">//创建名为add_two_ints的服务，绑定回调函数add</span>
	rclcpp<span class="token operator">::</span>Service<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr service <span class="token operator">=</span>
	node<span class="token operator">-&gt;</span>create_service<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"add_two_ints"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Ready to add two ints."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//入锁，等待客户端请求</span>
	rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="42__client_297"></a>4.2 客户端 client</h3> 
<p>在功能包的/src目录下，创建客户端节点，add_two_ints_client.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"example_interfaces/srv/add_two_ints.hpp"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token operator">::</span>chrono_literals<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"usage: add_two_ints_client X Y"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//创建名为add_two_ints_client的节点</span>
	std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>rclcpp<span class="token operator">::</span>Node<span class="token operator">&gt;</span> node <span class="token operator">=</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span><span class="token operator">::</span><span class="token function">make_shared</span><span class="token punctuation">(</span><span class="token string">"add_two_ints_client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//创建名为add_two_ints的客户端</span>
	rclcpp<span class="token operator">::</span>Client<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr client <span class="token operator">=</span>
	node<span class="token operator">-&gt;</span>create_client<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"add_two_ints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//采集request数据</span>
	<span class="token keyword">auto</span> request <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>example_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddTwoInts<span class="token operator">::</span>Request<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	request<span class="token operator">-&gt;</span>a <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	request<span class="token operator">-&gt;</span>b <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//search for service</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token operator">-&gt;</span><span class="token function">wait_for_service</span><span class="token punctuation">(</span><span class="token number">1</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rclcpp<span class="token operator">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">RCLCPP_ERROR</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Interrupted while waiting for the service. Exiting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"service not available, waiting again..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//发送request</span>
	<span class="token keyword">auto</span> result <span class="token operator">=</span> client<span class="token operator">-&gt;</span><span class="token function">async_send_request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// Wait for the result.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">spin_until_future_complete</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">==</span> rclcpp<span class="token operator">::</span>FutureReturnCode<span class="token operator">::</span>SUCCESS<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Sum: %ld"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RCLCPP_ERROR</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Failed to call service add_two_ints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="43__packagexml__CMakeListstxt_360"></a>4.3 修改 package.xml / CMakeLists.txt</h3> 
<p>  package.xml 添加如下依赖，如果创建包时，使用了–dependencies，则文件内已有如下语句。</p> 
<pre><code class="prism language-xml">    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>rclcpp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
  	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>depend</span><span class="token punctuation">&gt;</span></span>example_interfaces<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>depend</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>  CMakeLists.txt 添加如下编译规则，如果创建包时，使用了–dependencies，则文件内已有find_package相关的语句。</p> 
<pre><code class="prism language-bash"><span class="token comment"># 搜索依赖</span>
    find_package<span class="token punctuation">(</span>rclcpp REQUIRED<span class="token punctuation">)</span>
	find_package<span class="token punctuation">(</span>example_interfaces REQUIRED<span class="token punctuation">)</span>
<span class="token comment"># 创建可执行程序server，后续参数是构成可执行文件的所有源文件</span>
    add_executable<span class="token punctuation">(</span>server src/add_two_ints_server.cpp<span class="token punctuation">)</span>
<span class="token comment"># 链接find_package()找到的包</span>
    ament_target_dependencies<span class="token punctuation">(</span>server rclcpp example_interfaces<span class="token punctuation">)</span>

    add_executable<span class="token punctuation">(</span>client src/add_two_ints_client.cpp<span class="token punctuation">)</span>
	ament_target_dependencies<span class="token punctuation">(</span>client rclcpp example_interfaces<span class="token punctuation">)</span>

    install<span class="token punctuation">(</span>TARGETS
			  server
			  client
			  DESTINATION lib/<span class="token variable">${PROJECT_NAME}</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="44__386"></a>4.4 编译、运行两个节点</h3> 
<pre><code class="prism language-powershell"><span class="token comment"># 在工作空间根目录下，检查依赖</span>
$ rosdep install <span class="token operator">-</span>i <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>path src <span class="token operator">--</span>rosdistro foxy <span class="token operator">-</span>y
<span class="token comment"># 编译</span>
$ colcon build

<span class="token comment"># 配置环境变量，然后运行</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash
$ ros2 run cpp_srvcli server

<span class="token comment"># 打开另一个终端，配置环境变量，运行</span>
$ <span class="token punctuation">.</span> install<span class="token operator">/</span>setup<span class="token punctuation">.</span>bash
$ ros2 run cpp_srvcli client 2 3
</code></pre> 
<h2><a id="5__msgsrv_402"></a>5 自定义消息 msg/srv</h2> 
<h3><a id="51__403"></a>5.1 创建消息功能包</h3> 
<p>1、新建工作空间，并新建消息功能包（这里包名是tutorial_interfaces）。在<strong>消息功能包</strong>下，创建/msg和/srv文件夹（与/src同级），并在其中分别建立.msg和.srv文件(自定义的MSG，SRV和Action文件必须首字母大写)，有关消息内容，详见本系列第三篇<a href="https://blog.csdn.net/fangfang12138/article/details/111593629">《ROS2_Foxy学习（三）核心概念》</a>。</p> 
<p><strong>Num.msg</strong></p> 
<pre><code class="prism language-cpp">int64 num
</code></pre> 
<p><strong>AddThreeInts.srv</strong></p> 
<pre><code class="prism language-cpp">int64 a
int64 b
int64 c
<span class="token operator">--</span><span class="token operator">-</span>
int64 sum
</code></pre> 
<p>2、在package.xml文件中添加</p> 
<pre><code class="prism language-xml">	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build_depend</span><span class="token punctuation">&gt;</span></span>rosidl_default_generators<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build_depend</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exec_depend</span><span class="token punctuation">&gt;</span></span>rosidl_default_runtime<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exec_depend</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>member_of_group</span><span class="token punctuation">&gt;</span></span>rosidl_interface_packages<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>member_of_group</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>注：rosidl_default_generators为编译依赖，rosidl_default_runtime为运行依赖。<br> 3、在CMakeLists.txt文件中添加</p> 
<pre><code class="prism language-bash">find_package<span class="token punctuation">(</span>rosidl_default_generators REQUIRED<span class="token punctuation">)</span>

<span class="token comment"># You can use set to neatly list all of your interfaces:</span>
set<span class="token punctuation">(</span>msg_files
  <span class="token string">"msg/Num.msg"</span>
  <span class="token string">"msg/Message1.msg"</span>
  <span class="token string">"msg/Message2.msg"</span>
  <span class="token comment"># etc</span>
  <span class="token punctuation">)</span>

set<span class="token punctuation">(</span>srv_files
  <span class="token string">"srv/AddThreeInts.srv"</span>
  <span class="token string">"srv/Service1.srv"</span>
  <span class="token string">"srv/Service2.srv"</span>
   <span class="token comment"># etc</span>
  <span class="token punctuation">)</span>

<span class="token comment">#And generate all lists at once like so:</span>
rosidl_generate_interfaces<span class="token punctuation">(</span><span class="token variable">${PROJECT_NAME}</span>
  <span class="token variable">${msg_files}</span>
  <span class="token variable">${srv_files}</span>
  <span class="token comment"># 如果引用其他标准消息，需要添加下述语句，否则会造成编译通过，但运行失败的情况</span>
  <span class="token comment"># DEPENDENCIES std_msgs sensor_msgs</span>
<span class="token punctuation">)</span>

ament_export_dependencies<span class="token punctuation">(</span>rosidl_default_runtime<span class="token punctuation">)</span>
</code></pre> 
<p>注：可以省略set的步骤，在rosidl_generate_interfaces直接添加，如下，但不建议，还是需要一个良好的编程习惯。</p> 
<pre><code class="prism language-bash">rosidl_generate_interfaces<span class="token punctuation">(</span><span class="token variable">${PROJECT_NAME}</span>
  <span class="token string">"msg/Num.msg"</span>
  <span class="token string">"srv/AddThreeInts.srv"</span>
<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="52__461"></a>5.2 测试自定义消息接口</h3> 
<p>  功能包编译后（没有节点，没有运行），可以通过命令ros2 interface show来查看消息文件。</p> 
<h3><a id="53__463"></a>5.3 应用自定义消息接口</h3> 
<p>  在同一个工作空间下，除消息功能包外，再创建两个功能包，分别是话题功能包和服务功能包，参考3、4部分。</p> 
<p>1、CMakeLists.txt和package.xml与第3、4部分基本一致，其中，需要将消息依赖包（std_msgs和example_interfaces）替换成新建的消息功能包名，如tutorial_interfaces。<br> 2、各节点src文件，需要将消息类型进行替换，src文件修改见附件1。<br> 3、之后，编译运行（查依赖、编译包、配置环境、运行节点）。</p> 
<h3><a id="54__470"></a>5.4 使用同一功能包的消息接口</h3> 
<p>  若功能包需要使用自己定义的接口，需要在CMakeLists.txt中添加以下内容（In order to use the messages generated in the same package.）。</p> 
<pre><code class="prism language-bash">rosidl_target_interfaces<span class="token punctuation">(</span>publish_address_book
  <span class="token variable">${PROJECT_NAME}</span> <span class="token string">"rosidl_typesupport_cpp"</span><span class="token punctuation">)</span>
</code></pre> 
<p>注：publish_address_book是编译生成的可执行程序名。</p> 
<h2><a id="6__parameter_477"></a>6 使用 parameter</h2> 
<p>新建工作空间，并新建参数功能包（这里包名是cpp_parameters），使用参数dependencies，自动添加依赖rclcpp。</p> 
<h3><a id="61__479"></a>6.1 参数的声明与获取</h3> 
<p>在功能包的/src目录下，创建节点，cpp_parameters_node.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;rclcpp/rclcpp.hpp&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token operator">::</span>chrono_literals<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ParametersClass</span><span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span></span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">ParametersClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token string">"parameter_node"</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//声明：定义参数名及其值</span>
      <span class="token keyword">this</span><span class="token operator">-&gt;</span>declare_parameter<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"my_parameter"</span><span class="token punctuation">,</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">//</span>
      timer_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">create_wall_timer</span><span class="token punctuation">(</span><span class="token number">1000</span>ms<span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ParametersClass<span class="token operator">::</span>respond<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//获取：定时打印参数值</span>
    <span class="token keyword">void</span> <span class="token function">respond</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_parameter</span><span class="token punctuation">(</span><span class="token string">"my_parameter"</span><span class="token punctuation">,</span> parameter_string_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Hello %s"</span><span class="token punctuation">,</span> parameter_string_<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
  <span class="token keyword">private</span><span class="token operator">:</span>
    std<span class="token operator">::</span>string parameter_string_<span class="token punctuation">;</span>
    rclcpp<span class="token operator">::</span>TimerBase<span class="token operator">::</span>SharedPtr timer_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token operator">*</span> argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
  rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>ParametersClass<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>修改CMakelists.txt，然后编译运行。</p> 
<pre><code class="prism language-bash">add_executable<span class="token punctuation">(</span>parameter_node src/cpp_parameters_node.cpp<span class="token punctuation">)</span>
ament_target_dependencies<span class="token punctuation">(</span>parameter_node rclcpp<span class="token punctuation">)</span>

install<span class="token punctuation">(</span>TARGETS
  parameter_node
  DESTINATION lib/<span class="token variable">${PROJECT_NAME}</span>
<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="62__530"></a>6.2 终端修改参数</h3> 
<p>有关内容，详见本系列第三篇<a href="https://blog.csdn.net/fangfang12138/article/details/111593629">《ROS2_Foxy学习（三）核心概念》</a></p> 
<pre><code class="prism language-powershell">$ ros2 <span class="token keyword">param</span> list
$ ros2 <span class="token keyword">param</span> <span class="token function">set</span> &lt;node_name&gt; &lt;parameter_name&gt; &lt;value&gt;
</code></pre> 
<h3><a id="63_launch_536"></a>6.3 launch文件修改参数</h3> 
<p>在功能包的/launch目录下，创建launch文件，cpp_parameters_launch.py，修改parameters。</p> 
<pre><code class="prism language-python"><span class="token keyword">from</span> launch <span class="token keyword">import</span> LaunchDescription
<span class="token keyword">from</span> launch_ros<span class="token punctuation">.</span>actions <span class="token keyword">import</span> Node

<span class="token keyword">def</span> <span class="token function">generate_launch_description</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> LaunchDescription<span class="token punctuation">(</span><span class="token punctuation">[</span>
        Node<span class="token punctuation">(</span>
            package<span class="token operator">=</span><span class="token string">"cpp_parameters"</span><span class="token punctuation">,</span>
            executable<span class="token operator">=</span><span class="token string">"parameter_node"</span><span class="token punctuation">,</span>
            name<span class="token operator">=</span><span class="token string">"custom_parameter_node"</span><span class="token punctuation">,</span>
            output<span class="token operator">=</span><span class="token string">"screen"</span><span class="token punctuation">,</span>
            emulate_tty<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span>
            parameters<span class="token operator">=</span><span class="token punctuation">[</span>
                <span class="token punctuation">{<!-- --></span><span class="token string">"my_parameter"</span><span class="token punctuation">:</span> <span class="token string">"earth"</span><span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>修改CMakelists.txt，在6.1部分中CMakelists.txt最后增加以下部分。</p> 
<pre><code class="prism language-bash">install<span class="token punctuation">(</span>
  DIRECTORY launch
  DESTINATION share/<span class="token variable">${PROJECT_NAME}</span>
<span class="token punctuation">)</span>
</code></pre> 
<p>编译，然后运行launch文件。</p> 
<pre><code class="prism language-powershell">$ ros2 launch cpp_parameters cpp_parameters_launch<span class="token punctuation">.</span>py
</code></pre> 
<h2><a id="1__567"></a>附件1 消息文件应用</h2> 
<p>1、话题功能包——消息发布节点——publisher_member_function.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;functional&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tutorial_interfaces/msg/num.hpp"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token operator">::</span>chrono_literals<span class="token punctuation">;</span>

<span class="token comment">/* This example creates a subclass of Node and uses std::bind() to register a* member function as a callback from the timer. */</span>

<span class="token keyword">class</span> <span class="token class-name">MinimalPublisher</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">MinimalPublisher</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token string">"minimal_publisher"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">count_</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	  publisher_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>create_publisher<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>msg<span class="token operator">::</span>Num<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//10 是消息队列长度</span>
	  timer_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">create_wall_timer</span><span class="token punctuation">(</span><span class="token number">500</span>ms<span class="token punctuation">,</span>std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MinimalPublisher<span class="token operator">::</span>timer_callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">timer_callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	  <span class="token keyword">auto</span> message <span class="token operator">=</span> tutorial_interfaces<span class="token operator">::</span>msg<span class="token operator">::</span><span class="token function">Num</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	  message<span class="token punctuation">.</span>num <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>count_<span class="token operator">++</span><span class="token punctuation">;</span>
	  <span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Publishing: '%d'"</span><span class="token punctuation">,</span> message<span class="token punctuation">.</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  publisher_<span class="token operator">-&gt;</span><span class="token function">publish</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	rclcpp<span class="token operator">::</span>TimerBase<span class="token operator">::</span>SharedPtr timer_<span class="token punctuation">;</span>
	
	rclcpp<span class="token operator">::</span>Publisher<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>msg<span class="token operator">::</span>Num<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr publisher_<span class="token punctuation">;</span>
	
	size_t count_<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>MinimalPublisher<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>2、话题功能包——消息订阅节点——subscriber_member_function.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tutorial_interfaces/msg/num.hpp"</span></span>

<span class="token keyword">using</span> std<span class="token operator">::</span>placeholders<span class="token operator">::</span>_1<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">MinimalSubscriber</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
	<span class="token function">MinimalSubscriber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token string">"minimal_subscriber"</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
	  subscription_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token operator">-&gt;</span>create_subscription<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>msg<span class="token operator">::</span>Num<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"topic"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>MinimalSubscriber<span class="token operator">::</span>topic_callback<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> _1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token keyword">private</span><span class="token operator">:</span>
	<span class="token keyword">void</span> <span class="token function">topic_callback</span><span class="token punctuation">(</span><span class="token keyword">const</span> tutorial_interfaces<span class="token operator">::</span>msg<span class="token operator">::</span>Num<span class="token operator">::</span>SharedPtr msg<span class="token punctuation">)</span> <span class="token keyword">const</span>
	<span class="token punctuation">{<!-- --></span>
	  <span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token operator">-&gt;</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"I heard: '%d'"</span><span class="token punctuation">,</span> msg<span class="token operator">-&gt;</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	rclcpp<span class="token operator">::</span>Subscription<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>msg<span class="token operator">::</span>Num<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr subscription_<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>MinimalSubscriber<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>3、服务功能包——服务器端节点——add_three_ints_server.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tutorial_interfaces/srv/add_three_ints.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">const</span> std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">::</span>Request<span class="token operator">&gt;</span> request<span class="token punctuation">,</span>
      std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">::</span>Response<span class="token operator">&gt;</span>      response<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	response<span class="token operator">-&gt;</span>sum <span class="token operator">=</span> request<span class="token operator">-&gt;</span>a <span class="token operator">+</span> request<span class="token operator">-&gt;</span>b <span class="token operator">+</span> request<span class="token operator">-&gt;</span>c<span class="token punctuation">;</span>
	<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Incoming request\na: %ld"</span> <span class="token string">" b: %ld"</span> <span class="token string">" c: %ld"</span><span class="token punctuation">,</span>
		    request<span class="token operator">-&gt;</span>a<span class="token punctuation">,</span> request<span class="token operator">-&gt;</span>b<span class="token punctuation">,</span> request<span class="token operator">-&gt;</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"sending back response: [%ld]"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">long</span> <span class="token keyword">int</span><span class="token punctuation">)</span>response<span class="token operator">-&gt;</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//创建名为add_two_ints_server的节点</span>
	std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>rclcpp<span class="token operator">::</span>Node<span class="token operator">&gt;</span> node <span class="token operator">=</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span><span class="token operator">::</span><span class="token function">make_shared</span><span class="token punctuation">(</span><span class="token string">"add_three_ints_server"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">//创建名为add_two_ints的服务，绑定回调函数add</span>
	rclcpp<span class="token operator">::</span>Service<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr service <span class="token operator">=</span>
	node<span class="token operator">-&gt;</span>create_service<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"add_three_ints"</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>add<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Ready to add three ints."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//入锁，等待客户端请求</span>
	rclcpp<span class="token operator">::</span><span class="token function">spin</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
	rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>4、服务功能包——客户端节点——add_three_ints_client.cpp</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"rclcpp/rclcpp.hpp"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"tutorial_interfaces/srv/add_three_ints.hpp"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdlib&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;memory&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token operator">::</span>chrono_literals<span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	rclcpp<span class="token operator">::</span><span class="token function">init</span><span class="token punctuation">(</span>argc<span class="token punctuation">,</span> argv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"usage: add_two_ints_client X Y Z"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//创建名为add_three_ints_client的节点</span>
	std<span class="token operator">::</span>shared_ptr<span class="token operator">&lt;</span>rclcpp<span class="token operator">::</span>Node<span class="token operator">&gt;</span> node <span class="token operator">=</span> rclcpp<span class="token operator">::</span><span class="token class-name">Node</span><span class="token operator">::</span><span class="token function">make_shared</span><span class="token punctuation">(</span><span class="token string">"add_three_ints_client"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//创建名为add_three_ints的客户端</span>
	rclcpp<span class="token operator">::</span>Client<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">&gt;</span><span class="token operator">::</span>SharedPtr client <span class="token operator">=</span>
	node<span class="token operator">-&gt;</span>create_client<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token string">"add_three_ints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//采集request数据</span>
	<span class="token keyword">auto</span> request <span class="token operator">=</span> std<span class="token operator">::</span>make_shared<span class="token operator">&lt;</span>tutorial_interfaces<span class="token operator">::</span>srv<span class="token operator">::</span>AddThreeInts<span class="token operator">::</span>Request<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	request<span class="token operator">-&gt;</span>a <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	request<span class="token operator">-&gt;</span>b <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	request<span class="token operator">-&gt;</span>c <span class="token operator">=</span> <span class="token function">atoll</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//search for service</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>client<span class="token operator">-&gt;</span><span class="token function">wait_for_service</span><span class="token punctuation">(</span><span class="token number">1</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rclcpp<span class="token operator">::</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">RCLCPP_ERROR</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Interrupted while waiting for the service. Exiting."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"service not available, waiting again..."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//发送request</span>
	<span class="token keyword">auto</span> result <span class="token operator">=</span> client<span class="token operator">-&gt;</span><span class="token function">async_send_request</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// Wait for the result.</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">spin_until_future_complete</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token operator">==</span> rclcpp<span class="token operator">::</span>FutureReturnCode<span class="token operator">::</span>SUCCESS<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RCLCPP_INFO</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Sum: %ld"</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 
	<span class="token keyword">else</span> 
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">RCLCPP_ERROR</span><span class="token punctuation">(</span>rclcpp<span class="token operator">::</span><span class="token function">get_logger</span><span class="token punctuation">(</span><span class="token string">"rclcpp"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"Failed to call service add_three_ints"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	rclcpp<span class="token operator">::</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b42602059f408a7ffade8d5ee44019cc/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">基于正则化图神经网络的脑电情绪识别</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/96738d775e63d9872463956283e94947/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">2020年Android开发总结</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>