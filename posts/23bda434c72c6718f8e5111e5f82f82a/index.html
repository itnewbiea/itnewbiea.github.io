<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>索引失效造成的ORA-01502 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="索引失效造成的ORA-01502" />
<meta property="og:description" content="ORA-01502: 索引&#39;TSTUSER.IDXT&#39;或这类索引的分区处于不可用状态 这个错误是由于索引失效造成的，重建索引后，问题就解决了。 为了搞清楚索引为什么会失效，以及如何解决，做个测试： MOVE 表后会引启索引失效，会出现此问题。 SQL&gt; drop table t; 表已删除。 SQL&gt; create table t(a number); 表已创建。 SQL&gt; select tablespace_name from user_segments where segment_name=&#39;T&#39;; TABLESPACE_NAME ------------------------------------------------------------ USED_TEST 创建一个普通索引 SQL&gt; create index idxt on t(a); 索引已创建。 SQL&gt; insert into t values(10); 已创建 1 行。 SQL&gt; set linesize 200 SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name=&#39;IDXT&#39;; INDEX_NAME INDEX_TY TABLESPACE_NAME TABLE_TYPE STATUS --------------- -------- ------------------------------------------------------------ --------------- ---------------- IDXT NORMAL USED_TEST TABLE VALID 模拟索引是失效的情况： SQL&gt; alter table t move tablespace tools 2 ; 表已更改。 SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name=&#39;IDXT&#39;; INDEX_NAME INDEX_TY TABLESPACE_NAME TABLE_TYPE STATUS --------------- -------- ------------------------------------------------------------ --------------- --------------- IDXT NORMAL USED_TEST TABLE UNUSABLE SQL&gt; select * from t; A ---------- 10 SQL&gt; insert into t values(11); insert into t values(11) * 第 1 行出现错误: ORA-01502: 索引&#39;TSTUSER." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/23bda434c72c6718f8e5111e5f82f82a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2012-10-08T15:00:22+08:00" />
<meta property="article:modified_time" content="2012-10-08T15:00:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">索引失效造成的ORA-01502</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    ORA-01502: 索引'TSTUSER.IDXT'或这类索引的分区处于不可用状态 
<br> 
<br> 
<br> 这个错误是由于索引失效造成的，重建索引后，问题就解决了。 
<br> 
<br> 
<br> 为了搞清楚索引为什么会失效，以及如何解决，做个测试： 
<br> MOVE 表后会引启索引失效，会出现此问题。 
<br> 
<br> 
<br> 
<br> 
<br> SQL&gt; drop table t; 
<br> 
<br> 
<br> 表已删除。 
<br> 
<br> 
<br> SQL&gt; create table t(a number); 
<br> 
<br> 
<br> 表已创建。 
<br> 
<br> 
<br> SQL&gt; select tablespace_name from user_segments where segment_name='T'; 
<br> 
<br> 
<br> TABLESPACE_NAME                                                                 
<br> ------------------------------------------------------------                    
<br> USED_TEST                                                                       
<br> 创建一个普通索引 
<br> SQL&gt; create index idxt on t(a); 
<br> 
<br> 
<br> 索引已创建。 
<br> 
<br> 
<br> SQL&gt;  insert into t values(10); 
<br> 
<br> 
<br> 已创建 1 行。 
<br> 
<br> 
<br> SQL&gt; set linesize 200 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDXT'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ----------------        
<br> 
<br> 
<br>                                                                           
<br> IDXT            NORMAL   USED_TEST                                                    TABLE           VALID                   
<br> 
<br> 
<br>                                                                           
<br>             
<br>  模拟索引是失效的情况：                                                                                       
<br> 
<br> 
<br> SQL&gt; alter table  t move tablespace tools 
<br>   2  ; 
<br> 
<br> 
<br> 表已更改。 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDXT'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDXT            NORMAL   USED_TEST                                                    TABLE           UNUSABLE                
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; select * from t; 
<br> 
<br> 
<br>          A                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> ----------                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>         10                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; insert into t values(11); 
<br> insert into t values(11) 
<br> * 
<br> 第 1 行出现错误: 
<br> ORA-01502: 索引'TSTUSER.IDXT'或这类索引的分区处于不可用状态 
<br> 
<br> 
<br> 
<br> 
<br> 我们看到，当使用类似 alter table xxxxxx move tablespace xxxxxxx 命令后，索引就会失效。 
<br> 作为测试，也可以直接使用alter index idxt unusable;命令使索引失效 
<br> 
<br> 
<br> 对于普通表中的不同索引（非唯一索引），我们有两种方法解决这个问题。 
<br> 方法一：设置 skip_unusable_indexes=true; 
<br> 
<br> 
<br> SQL&gt; alter session set skip_unusable_indexes=true; 
<br> 
<br> 
<br> 会话已更改。 
<br> 
<br> 
<br> SQL&gt; insert into t values(11); 
<br> 
<br> 
<br> 已创建 1 行。 
<br> 
<br> 
<br> SQL&gt; commit; 
<br> 
<br> 
<br> 提交完成。 
<br> 
<br> 
<br> 
<br> 
<br> SQL&gt; select * from t; 
<br> 
<br> 
<br>          A                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> ----------                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>         10                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>         11                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDXT'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDXT            NORMAL   USED_TEST                                                    TABLE           UNUSABLE                
<br> 现在我们看到，这个索引的状态虽然还是“UNUSABLE”但是，通过设置“alter session set skip_unusable_indexes=true;”， 
<br> 我们已经可以访问这个表了，但是请注意，这种情况下，这个索引是不可用的，也就是说优化器在考虑是否要使用索引时是不考虑这个所以的 
<br> 
<br> 
<br> 。 
<br> 
<br> 
<br> 方法2：通过常见所以彻底解决这个问题 
<br> 首先，先设置 “skip_unusable_indexes=false”，也就是不跳过失效索引                                                            
<br> 
<br> 
<br> SQL&gt; alter session set skip_unusable_indexes=false; 
<br> 
<br> 
<br> 会话已更改。 
<br> 
<br> 
<br> SQL&gt; insert into t values(12); 
<br> insert into t values(12) 
<br> * 
<br> 第 1 行出现错误: 
<br> ORA-01502: 索引'TSTUSER.IDXT'或这类索引的分区处于不可用状态 
<br> 
<br> 
<br> 然后重建这个失效的索引 
<br> SQL&gt; alter index idxt rebuild; 
<br> 
<br> 
<br> 索引已更改。 
<br> 
<br> 
<br> SQL&gt; insert into t values(13); 
<br> 
<br> 
<br> 已创建 1 行。 
<br> 
<br> 
<br> SQL&gt; commit; 
<br> 
<br> 
<br> 提交完成。 
<br> 
<br> 
<br> SQL&gt; select * from t; 
<br> 
<br> 
<br>          A                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> ----------                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>         10                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>         11                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>         13                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDXT'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDXT            NORMAL   USED_TEST                                                    TABLE           VALID                   
<br> 
<br> 
<br>                                                                           
<br> 重建索引才是解决这类问题的彻底的方法。 
<br> 
<br> 
<br> 现在，我们建立一个唯一索引来看看： 
<br> SQL&gt; drop table t; 
<br> 
<br> 
<br> 表已删除。 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDXT'; 
<br> 
<br> 
<br> 未选定行 
<br> 
<br> 
<br> SQL&gt; create table t(a number); 
<br> 
<br> 
<br> 表已创建。 
<br> 
<br> 
<br> SQL&gt; create unique index idx_t on t(a); 
<br> 
<br> 
<br> 索引已创建。 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='T'; 
<br> 
<br> 
<br> 未选定行 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDX_T'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDX_T           NORMAL   USED_TEST                                                    TABLE           VALID                   
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; insert into t values(1); 
<br> 
<br> 
<br> 已创建 1 行。 
<br> 
<br> 
<br> SQL&gt; commit; 
<br> 
<br> 
<br> 提交完成。 
<br> 
<br> 
<br> SQL&gt; select * from t; 
<br> 
<br> 
<br>          A                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> ----------                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>          1                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> 将索引手工修改为unusable状态（模拟发生索引失效的情况）： 
<br> SQL&gt; alter index idx_t unusable; 
<br> 
<br> 
<br> 索引已更改。 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDX_T'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDX_T           NORMAL   USED_TEST                                                    TABLE           UNUSABLE                
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; insert into t values(2); 
<br> insert into t values(2) 
<br> * 
<br> 第 1 行出现错误: 
<br> ORA-01502: 索引'TSTUSER.IDX_T'或这类索引的分区处于不可用状态 
<br> 
<br> 
<br> 首先，我们通过重建索引（rebuild index）的方法来解决问题： 
<br> SQL&gt; alter index idx_t rebuild; 
<br> 
<br> 
<br> 索引已更改。 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDX_T'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDX_T           NORMAL   USED_TEST                                                    TABLE           VALID                   
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; insert into t values(3); 
<br> 
<br> 
<br> 已创建 1 行。 
<br> 
<br> 
<br> SQL&gt; commit; 
<br> 
<br> 
<br> 提交完成。 
<br> 
<br> 
<br> SQL&gt; select * from t; 
<br> 
<br> 
<br>          A                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> ----------                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>          1                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>          3                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> 现在我们再次模拟索引失效(unusable状态)： 
<br> SQL&gt; alter index idx_t unusable; 
<br> 
<br> 
<br> 索引已更改。 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDX_T'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDX_T           NORMAL   USED_TEST                                                    TABLE           UNUSABLE                
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; insert into t values(4); 
<br> insert into t values(4) 
<br> * 
<br> 第 1 行出现错误: 
<br> ORA-01502: 索引'TSTUSER.IDX_T'或这类索引的分区处于不可用状态 
<br> 
<br> 
<br> 然后，看看是否可以通过设置参数skip_unusable_indexes=true来解决问题： 
<br> SQL&gt; alter session set skip_unusable_indexes=true; 
<br> 
<br> 
<br> 会话已更改。 
<br> 
<br> 
<br> SQL&gt; insert into t values(4); 
<br> insert into t values(4) 
<br> * 
<br> 第 1 行出现错误: 
<br> ORA-01502: 索引'TSTUSER.IDX_T'或这类索引的分区处于不可用状态 
<br> 
<br> 
<br> 
<br> 
<br> SQL&gt; select index_name,index_type,tablespace_name,table_type,status from user_indexes where index_name='IDX_T'; 
<br> 
<br> 
<br> INDEX_NAME      INDEX_TY TABLESPACE_NAME                                              TABLE_TYPE      STATUS                  
<br> 
<br> 
<br>                                                                           
<br> --------------- -------- ------------------------------------------------------------ --------------- ---------------         
<br> 
<br> 
<br>                                                                           
<br> IDX_T           NORMAL   USED_TEST                                                    TABLE           UNUSABLE                
<br> 
<br> 
<br>                                                                           
<br> 
<br> 
<br> SQL&gt; alter index idx_t rebuild; 
<br> 
<br> 
<br> 索引已更改。 
<br> 
<br> 
<br> SQL&gt; insert into t values(4); 
<br> 
<br> 
<br> 已创建 1 行。 
<br> 
<br> 
<br> SQL&gt; commit; 
<br> 
<br> 
<br> 提交完成。 
<br> 
<br> 
<br> SQL&gt; select * from t; 
<br> 
<br> 
<br>          A                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br> ----------                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>          1                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>          3                                                                                                                    
<br> 
<br> 
<br>                                                                           
<br>          4                                                                                                                                                                                             
<br> 
<br> 
<br> SQL&gt; insert into t values(4); 
<br> insert into t values(4) 
<br> * 
<br> 第 1 行出现错误: 
<br> ORA-00001: 违反唯一约束条件 (TSTUSER.IDX_T) 
<br> 
<br> 
<br> 
<br> 
<br> SQL&gt; spool off; 
<br> 
<br> 
<br> 很显然，对于unique index，通过简单的设置参数是不能解决问题的，要解决unique index 失效的问题，只能通过重建索引来实现。
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d85ab720a7129726c2005ccd4f770eb6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">PHP-chr函数 对应的AscII码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f5d90ad4722ce4d069a8f1fd01c3b41f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何批量去除EXCEL单元格中的空格字符？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>