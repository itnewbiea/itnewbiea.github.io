<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CS144（2023 Spring）Lab 0：networking warmup（环境搭建 &amp; webget &amp; bytestream） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CS144（2023 Spring）Lab 0：networking warmup（环境搭建 &amp; webget &amp; bytestream）" />
<meta property="og:description" content="文章目录 前言其他笔记相关链接 1. Set up GNU/Linux on your computer2. Networking by hand3. Writing a network program using an OS stream socket3.1 Linux配置3.2 C&#43;&#43;规范3.3 Writing webget3.3.1 实现3.3.2 测试 4. An in-memory reliable byte stream4.1 思路分析4.2 代码展示4.3 代码测试 前言 最近心情非常郁闷，搓一个CS144玩玩吧，正好2023 spring出新版了。。。CS144的头4个Lab（加上0是5个），一步步实现了一个TCP。在开始之前，我想贴一下Lab中的这句话：The lab documents aren’t “specifications”—meaning they’re not intended to be consumed in a one-way fashion. They’re written closer to the level of detail that a software
engineer will get from a boss or client." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/04abe1627d08891407e1178e887bcb13/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-31T01:38:29+08:00" />
<meta property="article:modified_time" content="2023-08-31T01:38:29+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CS144（2023 Spring）Lab 0：networking warmup（环境搭建 &amp; webget &amp; bytestream）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">前言</a></li><li><ul><li><a href="#_6" rel="nofollow">其他笔记</a></li><li><a href="#_9" rel="nofollow">相关链接</a></li></ul> 
  </li><li><a href="#1_Set_up_GNULinux_on_your_computer_12" rel="nofollow">1. Set up GNU/Linux on your computer</a></li><li><a href="#2_Networking_by_hand_29" rel="nofollow">2. Networking by hand</a></li><li><a href="#3_Writing_a_network_program_using_an_OS_stream_socket_41" rel="nofollow">3. Writing a network program using an OS stream socket</a></li><li><ul><li><a href="#31_Linux_47" rel="nofollow">3.1 Linux配置</a></li><li><a href="#32_C_79" rel="nofollow">3.2 C++规范</a></li><li><a href="#33_Writing_webget_101" rel="nofollow">3.3 Writing webget</a></li><li><ul><li><a href="#331__102" rel="nofollow">3.3.1 实现</a></li><li><a href="#332__127" rel="nofollow">3.3.2 测试</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4_An_inmemory_reliable_byte_stream_191" rel="nofollow">4. An in-memory reliable byte stream</a></li><li><ul><li><a href="#41__192" rel="nofollow">4.1 思路分析</a></li><li><a href="#42__205" rel="nofollow">4.2 代码展示</a></li><li><a href="#43__370" rel="nofollow">4.3 代码测试</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>前言</h2> 
<p>最近心情非常郁闷，搓一个CS144玩玩吧，正好2023 spring出新版了。。。CS144的头4个Lab（加上0是5个），一步步实现了一个TCP。在开始之前，我想贴一下Lab中的这句话：<em><strong>The lab documents aren’t “specifications”—meaning they’re not intended to be consumed in a one-way fashion. They’re written closer to the level of detail that a software<br> engineer will get from a boss or client.</strong></em><br> 这句话是说这个Lab的文档并不那么标准化，它看起来更像你的leader给你的需求文档，这话什么意思呢，这里我就不解释了，相信大家跟着这个Lab从头到尾做一遍就会有体会了（笑<br> <img src="https://images2.imgbox.com/a8/59/G2Rrwsd7_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_6"></a>其他笔记</h3> 
<p><a href="https://blog.csdn.net/J__M__C/article/details/131713326">Lab 0: networking warmup</a><br> <a href="https://blog.csdn.net/J__M__C/article/details/132567895">Lab 1: stitching substrings into a byte stream</a></p> 
<h3><a id="_9"></a>相关链接</h3> 
<p><a href="https://cs144.github.io/" rel="nofollow">课程主页</a><br> <a href="https://cs144.github.io/assignments/check0.pdf" rel="nofollow">lab 0</a></p> 
<h2><a id="1_Set_up_GNULinux_on_your_computer_12"></a>1. Set up GNU/Linux on your computer</h2> 
<p><img src="https://images2.imgbox.com/a2/5a/5CmMAbjK_o.png" alt="在这里插入图片描述"><br> 官方推荐环境有vbox镜像、谷歌云，以及原生Ubuntu安装，我本来想下他那个镜像的就懒得配了，结果一看3G大，挂上魔法都只有100kb的龟速。。。还是用我的WSL吧，Ubuntu版本要求22.10，g++要求12.2</p> 
<p>命令行运行它这一串就行了</p> 
<pre><code>sudo apt update &amp;&amp; sudo apt install git cmake gdb build-essential clang \
clang-tidy clang-format gcc-doc pkg-config glibc-doc tcpdump tshark
</code></pre> 
<p>这里点是<br> <img src="https://images2.imgbox.com/55/51/FbenXR2Q_o.png" alt="在这里插入图片描述"><br> 安装速度比下载镜像不知道高到哪里去了（21min是因为我挂着等截图，实际估计一两分钟）（<br> <img src="https://images2.imgbox.com/b0/6f/nHizTWSn_o.png" alt="在这里插入图片描述"><br> 由于lab要求使用gcc12，而Ubuntu20的官方源没有gcc12，我选择将Ubuntu20直接更新到22，但是强烈不推荐，因为众所周知的原因，我在更新系统的途中耗时极多。。如图，花了得有几个小时。。建议去微软商店里面直接下载新的22。<br> <img src="https://images2.imgbox.com/71/09/O9ZdIoYn_o.png" alt="在这里插入图片描述"><br> 安装好gcc12后，可以如图指定gcc各版本优先级以指定默认版本。<br> <img src="https://images2.imgbox.com/7b/70/LQFcaAtk_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="2_Networking_by_hand_29"></a>2. Networking by hand</h2> 
<p>这一节主要是叫你手动搭建网络感受一下里面的过程，头俩没啥好说的，<strong>2.3 Listening and connecting</strong>的比较有意思，是叫搭建一个双工通信：<br> 首先我们在终端里跑一下<code>netcat -v -l -p 9090</code>：<br> <img src="https://images2.imgbox.com/99/08/Mc5FLolO_o.png" alt="在这里插入图片描述"><br> 然后新开一个终端，在里面运行<code>telnet localhost 9090</code>：<br> <img src="https://images2.imgbox.com/1f/d4/8MhHl3sB_o.png" alt="在这里插入图片描述"><br> 可以看到它建立了连接，这个时候我们回到刚才的终端，发现更新了：<br> <img src="https://images2.imgbox.com/a1/83/HBu8wzMe_o.png" alt="在这里插入图片描述"><br> 我们随便输入一点东西，并切到隔壁去，会发现隔壁也能收到并显示：<br> <img src="https://images2.imgbox.com/14/41/nKEqdVNg_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ae/ff/jfxgkRFK_o.png" alt="在这里插入图片描述"><br> 这个操作在两边都能完成，可以看出我们建立了双工通信。</p> 
<h2><a id="3_Writing_a_network_program_using_an_OS_stream_socket_41"></a>3. Writing a network program using an OS stream socket</h2> 
<p>Task3是叫用socket简单写一个网络编程。值得一提的是，Lab鼓励我们用上Modern C++，从代码上来看，Lab自己至少使用了C++20的内容，而我也会尽可能展示C++20乃至C++23的实现（）<br> <img src="https://images2.imgbox.com/f2/36/DteqHgC3_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="31_Linux_47"></a>3.1 Linux配置</h3> 
<p>这一步我们先在linux里拉取仓库代码后编译，不过这个项目要求cmake 3.24.2以上 = =，我的是3.22.1，汗。。。又要更新，我直接更新到了3.27.0。<br> <img src="https://images2.imgbox.com/fc/02/7SamYvPQ_o.png" alt="在这里插入图片描述"><br> 跟着流程走一遍编译：</p> 
<pre><code class="prism language-sh"><span class="token function">git</span> clone https://github.com/cs144/minnow
<span class="token builtin class-name">cd</span> minnow
cmake <span class="token parameter variable">-S</span> <span class="token builtin class-name">.</span> <span class="token parameter variable">-B</span> build
cmake <span class="token parameter variable">--build</span> build
</code></pre> 
<p>发现报了俩错<br> <img src="https://images2.imgbox.com/81/0d/1xxYpYKG_o.png" alt="在这里插入图片描述"><br> 把报错贴出来方便后来人搜索：</p> 
<blockquote> 
 <p>error: invalid return type ‘std::string’ {aka ‘std::__cxx11::basic_string’} of ‘constexpr’ function ‘static constexpr std::string ExpectationViolation::boolstr(bool)’<br> 16 | static constexpr std::string boolstr( bool b ) { return b ? “true” : “false”; }<br> | ^~~~~~~</p> 
</blockquote> 
<p>看一下报错说的是string不为constexpr类型，我记得constexpr string好像是C++20的内容，这里用的C++11，明显是编译器环境没整对，一查<code>g++ -v</code>，发现果然之前搞了gcc的默认忘改g++了，同样的操作软链接一下：<br> <img src="https://images2.imgbox.com/58/c6/lp4bU8Uo_o.png" alt="在这里插入图片描述"><br> 再跑一下编译，很成功：<br> <img src="https://images2.imgbox.com/62/a6/FTs5zOVm_o.png" alt="在这里插入图片描述"><br> 然后我们还是把他推到我们现有的库里</p> 
<pre><code class="prism language-sh"><span class="token function">git</span> remote <span class="token function">rm</span> origin                 <span class="token comment"># 删除当前远程库</span>
<span class="token function">git</span> remote <span class="token function">add</span> origin  + 远程仓库地址  <span class="token comment"># 连接到现有的自己的库</span>
<span class="token function">git</span> branch <span class="token parameter variable">-M</span> main
<span class="token function">git</span> push <span class="token parameter variable">-u</span> origin main
</code></pre> 
<p>然后在vs里导入这个仓库，不演示了。拿到手上先把构建项目的文件给加进gitignore里面：<br> <img src="https://images2.imgbox.com/9e/04/Bc6SjoAG_o.png" alt="在这里插入图片描述"><br> 我的工具链一般是VS上编辑完后，git到远程，然后wsl上拉取后编译运行。如果需要调试，就直接在VS上打断点在VS上运行调试，这个Lab有CMake，方便得多。</p> 
<h3><a id="32_C_79"></a>3.2 C++规范</h3> 
<p><img src="https://images2.imgbox.com/cb/d4/bw7wz9FF_o.png" alt="在这里插入图片描述"><br> 在开始之前，我们来看一下他提到的一些规范要求：</p> 
<ul><li>禁用动态内存分配（malloc&amp;free、new&amp;delete）</li><li>禁用裸指针、如果要用指针就用智能指针，不过看提示说CS144不太用得到指针</li><li>避免模板、线程、锁、虚函数，说CS144用不到这些</li><li>避免使用C风格字符串和C的那一套str-函数，用<code>std::string</code>代替</li><li>避免使用C风格cast，用<code>static_cast</code>代替，不过CS144一般用不到</li><li>尽量使用<code>const</code>引用传参</li><li>函数和变量能用<code>const</code>修饰则用<code>const</code>修饰</li><li>避免使用全局变量，把变量限定在尽可能小的作用域里</li><li>使用<code>cmake --build build --target tidy</code>获取代码建议，<code>cmake --build build --target format</code>去格式化</li></ul> 
<p>这几条都是比较常规的规范，没啥值得注意的。<br> <img src="https://images2.imgbox.com/17/af/bwdwXPfu_o.png" alt="在这里插入图片描述"></p> 
<p>然后他说Lab用类封装了各种各样的system function，并且叫你读一下<code>socket.hh</code>和<code>file_descriptor.hh</code>的公共接口，看它的描述，Socket是一种文件描述符，而TCPSocket是一种Socket。我们可以借助他的这个<a href="https://cs144.github.io/doc/lab0/class_t_c_p_socket.html" rel="nofollow">文档</a>看，实际看实现就是逐层继承的关系。<br> <img src="https://images2.imgbox.com/79/08/GCDPKUPq_o.png" alt="继承关系"><br> 看一下接口，都是很常规的socket API，值得注意的一点是今年这里面有的API和往年的不一样！所以还是要以源码为准：<br> <img src="https://images2.imgbox.com/00/13/I3HObQRd_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33_Writing_webget_101"></a>3.3 Writing webget</h3> 
<h4><a id="331__102"></a>3.3.1 实现</h4> 
<p>终于要开始写代码了，在<code>/apps/webget.cc</code>里面写<br> <img src="https://images2.imgbox.com/51/79/TZ56b0MA_o.png" alt="在这里插入图片描述"><br> 首先实现这个<code>getURL</code>，<br> <img src="https://images2.imgbox.com/14/82/Wr8sYRKt_o.png" alt="在这里插入图片描述"><br> 其中注意发请求的时候要用<code>\r\n</code>，单纯<code>\n</code>是不够的，此外今年的<code>FileDescriptor::read</code>由直接返回读取的数据改成了传个<code>string</code>引用进去，我分析这么改的原因是为了与新的<code>FileDescriptor::read( vector&lt;unique_ptr&lt;string&gt;&gt;&amp; buffers )</code>这个写入多值的函数形成API形式上的统一吧，不过这写着就丑陋一些了。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">get_URL</span><span class="token punctuation">(</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> host<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> path <span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  TCPSocket sock<span class="token punctuation">;</span>
  sock<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span> <span class="token function">Address</span><span class="token punctuation">(</span> host<span class="token punctuation">,</span> <span class="token string">"http"</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  sock<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"GET "</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">" HTTP/1.1\r\n"</span>    <span class="token comment">// 请求行</span>
             <span class="token string">"Host: "</span> <span class="token operator">+</span> host <span class="token operator">+</span> <span class="token string">"\r\n"</span>           <span class="token comment">// 告知服务器主机名</span>
             <span class="token string">"Connection: close\r\n"</span>            <span class="token comment">// 通知服务器关闭连接</span>
             <span class="token string">"\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                           <span class="token comment">// 空行</span>
  sock<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span> SHUT_WR <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 关闭写端</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">!</span>sock<span class="token punctuation">.</span><span class="token function">eof</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>   <span class="token comment">// 读取所有数据</span>
    string tmp<span class="token punctuation">;</span>
    sock<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span> tmp <span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> tmp<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  sock<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="332__127"></a>3.3.2 测试</h4> 
<p>我们在<code>build</code>文件夹下</p> 
<pre><code class="prism language-sh"><span class="token function">make</span>
./apps/webget cs144.keithw.org /hello
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/92/6l0TnEGf_o.png" alt="在这里插入图片描述"><br> 可以看到成功返回并打印了一些信息！<br> 接着继续在build下面跑<code>make check_webget</code>测试一下，这一步我最早出现了很奇葩的问题：<br> <img src="https://images2.imgbox.com/ea/b7/mZVrfx4S_o.png" alt="在这里插入图片描述"><br> 我把错误抠出来方便后来人搜索：</p> 
<pre><code class="prism language-sh">Test project /home/jmc/CS144/minnow/build
    Start <span class="token number">1</span>: compile with bug-checkers
<span class="token number">1</span>/2 Test <span class="token comment">#1: compile with bug-checkers ........***Timeout  12.05 sec</span>
<span class="token punctuation">[</span>  <span class="token number">6</span>%<span class="token punctuation">]</span> Built target minnow_debug
<span class="token punctuation">[</span> <span class="token number">18</span>%<span class="token punctuation">]</span> Built target util_sanitized
<span class="token punctuation">[</span> <span class="token number">25</span>%<span class="token punctuation">]</span> Built target minnow_sanitized
<span class="token punctuation">[</span> <span class="token number">29</span>%<span class="token punctuation">]</span> Built target minnow_testing_sanitized
<span class="token punctuation">[</span> <span class="token number">34</span>%<span class="token punctuation">]</span> Built target minnow_testing_debug
<span class="token punctuation">[</span> <span class="token number">45</span>%<span class="token punctuation">]</span> Built target util_debug
<span class="token punctuation">[</span> <span class="token number">47</span>%<span class="token punctuation">]</span> Building CXX object tests/CMakeFiles/byte_stream_capacity_sanitized.dir/byte_stream_capacity.cc.o
<span class="token punctuation">[</span> <span class="token number">50</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_basics_sanitized
<span class="token punctuation">[</span> <span class="token number">52</span>%<span class="token punctuation">]</span> Building CXX object tests/CMakeFiles/byte_stream_two_writes_sanitized.dir/byte_stream_two_writes.cc.o
<span class="token punctuation">[</span> <span class="token number">54</span>%<span class="token punctuation">]</span> Building CXX object tests/CMakeFiles/byte_stream_one_write_sanitized.dir/byte_stream_one_write.cc.o
<span class="token punctuation">[</span> <span class="token number">59</span>%<span class="token punctuation">]</span> Building CXX object tests/CMakeFiles/byte_stream_stress_test_sanitized.dir/byte_stream_stress_test.cc.o
<span class="token punctuation">[</span> <span class="token number">59</span>%<span class="token punctuation">]</span> Building CXX object tests/CMakeFiles/byte_stream_many_writes_sanitized.dir/byte_stream_many_writes.cc.o
<span class="token punctuation">[</span> <span class="token number">61</span>%<span class="token punctuation">]</span> Building CXX object tests/CMakeFiles/byte_stream_stress_test.dir/byte_stream_stress_test.cc.o
<span class="token punctuation">[</span> <span class="token number">63</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_basics
<span class="token punctuation">[</span> <span class="token number">65</span>%<span class="token punctuation">]</span> Built target byte_stream_basics_sanitized
<span class="token punctuation">[</span> <span class="token number">68</span>%<span class="token punctuation">]</span> Built target byte_stream_basics
<span class="token punctuation">[</span> <span class="token number">70</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_capacity
<span class="token punctuation">[</span> <span class="token number">72</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_one_write
<span class="token punctuation">[</span> <span class="token number">75</span>%<span class="token punctuation">]</span> Built target byte_stream_one_write
<span class="token punctuation">[</span> <span class="token number">77</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_two_writes
<span class="token punctuation">[</span> <span class="token number">79</span>%<span class="token punctuation">]</span> Built target byte_stream_capacity
<span class="token punctuation">[</span> <span class="token number">81</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_many_writes
<span class="token punctuation">[</span> <span class="token number">84</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_stress_test
<span class="token punctuation">[</span> <span class="token number">86</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_capacity_sanitized
<span class="token punctuation">[</span> <span class="token number">88</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_many_writes_sanitized
<span class="token punctuation">[</span> <span class="token number">90</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_two_writes_sanitized
<span class="token punctuation">[</span> <span class="token number">93</span>%<span class="token punctuation">]</span> Linking CXX executable byte_stream_stress_test_sanitized

    Start <span class="token number">2</span>: t_webget
Failed <span class="token builtin class-name">test</span> dependencies: compile with bug-checkers
<span class="token number">2</span>/2 Test <span class="token comment">#2: t_webget .........................***Not Run   0.00 sec</span>

<span class="token number">0</span>% tests passed, <span class="token number">2</span> tests failed out of <span class="token number">2</span>

Total Test <span class="token function">time</span> <span class="token punctuation">(</span>real<span class="token punctuation">)</span> <span class="token operator">=</span>  <span class="token number">12.06</span> sec

The following tests FAILED:
          <span class="token number">1</span> - compile with bug-checkers <span class="token punctuation">(</span>Timeout<span class="token punctuation">)</span>
          <span class="token number">2</span> - t_webget <span class="token punctuation">(</span>Not Run<span class="token punctuation">)</span>
Errors <span class="token keyword">while</span> running CTest
make<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>CMakeFiles/check_webget.dir/build.make:70：CMakeFiles/check_webget<span class="token punctuation">]</span> 错误 <span class="token number">8</span>
make<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>CMakeFiles/Makefile2:1822：CMakeFiles/check_webget.dir/all<span class="token punctuation">]</span> 错误 <span class="token number">2</span>
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: *** <span class="token punctuation">[</span>CMakeFiles/Makefile2:1829：CMakeFiles/check_webget.dir/rule<span class="token punctuation">]</span> 错误 <span class="token number">2</span>
make: *** <span class="token punctuation">[</span>Makefile:914：check_webget<span class="token punctuation">]</span> 错误 <span class="token number">2</span>
</code></pre> 
<p>研究半天，这个应该是性能问题，虚拟机性能不好，所以跑半天超时了，解决方法是多跑几遍，或者直接去<code>etc/tests.cmake</code>下面把超时时间改多一点，后面的也是同理：<br> <img src="https://images2.imgbox.com/72/58/6Yd7CbXY_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/74/41/MM2xn92O_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4_An_inmemory_reliable_byte_stream_191"></a>4. An in-memory reliable byte stream</h2> 
<h3><a id="41__192"></a>4.1 思路分析</h3> 
<p>这个task就是叫我们抽象出一个数据结构，可以在一边读一边写，同时用一个capacity限制一下缓冲区的大小，这本质是一个队列的抽象。今年的这个task相比往年的再抽象了一层专用于读与写的子类，比较有意思。</p> 
<p>我们先分析一下这个框架，很显然，我们的底层需要维护一个什么数据结构，然后还有几个显然是标志位的东西，我们直接维护一个flg然后置位即可。<br> <img src="https://images2.imgbox.com/3b/75/zcMpgTdt_o.png" alt="在这里插入图片描述"></p> 
<p>这个ByteStream的设计是有点类似于C++里基于流的IO的，和<code>stringstream</code>的功能差不多，都是实现基于<code>char</code>的流，不过bs和ss不同的是bs是FILO的，而ss是FIFO的，换言之我们的bs在这里像一个“滑动窗口”——-而且左右指针都始终向一个方向前进，这意味着如果我们像ss一样利用<code>string</code>这种简单的连续内存空间来维护我们的数据的话，将会造成左侧内存的浪费——写指针永远无法到达它以前到过的地方，因为它是单向运动的，此外它还无法实现完美转发，因为我们使用<code>operator+=</code>衔接串的话势必需要一次拷贝。</p> 
<p>那么<code>queue&lt;char&gt;</code>如何呢？看起来它完美地实现了我们的需求：它是天然的FIFO数据结构，但是还是那个问题——它无法实现完美转发，我们在声明中就可以看到，<code>push</code>接受的参数是一个<code>string</code>值，而我们将<code>string</code>拆成<code>char</code>的这个过程势必涉及到拷贝，它是一个<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
       
         n 
        
       
         ) 
        
       
      
        O(n) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span>的操作——这甚至还没有考虑零碎空间造成的开销。</p> 
<p>那如果考虑完美转发呢？<code>push</code>收到的是连续空间，我们就直接完美转发就行了。这意味着我们需要维护一片一片的连续内存，很容易想到，我们需要维护一个<code>queue&lt;string&gt;</code>，对于每个收到的字符串，我们直接转发进这个队列就行了，这样可以让我们的<code>push</code>操作本身达到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
       
         1 
        
       
         ) 
        
       
      
        O(1) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>时间复杂度，另外我们从测试程序可以看出，测试程序传给<code>push</code>的值本身就是个<code>move</code>来的右值，这意味着传参的过程也是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
       
         1 
        
       
         ) 
        
       
      
        O(1) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>的，因此实际上我们的这个操作时间复杂度就是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
       
         1 
        
       
         ) 
        
       
      
        O(1) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal" style="margin-right: 0.0278em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span></span>。<br> <img src="https://images2.imgbox.com/f1/0d/JpsrrpV7_o.png" alt="在这里插入图片描述"><br> 不过我们还需要考虑<code>pop</code>的实现，<code>pop</code>要求实现任意合法字符数量的弹出，一般思路是不断遍历并弹出队首，直到队首的长度不小于剩余需要遍历的数量的长度为止，然后用一个指针标记一下这个串这次遍历到的位置，下次就从这里开始遍历即可。因此我们需要维护队首字符串的起始位置，一种很优雅的实现是来自C++17的<code>std::string_view</code>，<code>std::string_view</code>实质上就是维护了连续字符内存上的两个指针。当然，我们也可以直接维护队首字符串的起始位置坐标，性能其实应该差距不大，这里就展示一下<code>string_view</code>吧。</p> 
<h3><a id="42__205"></a>4.2 代码展示</h3> 
<pre><code class="prism language-cpp"><span class="token comment">// byte_stream.hh</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;queue&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdexcept&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string_view&gt;</span></span>

<span class="token keyword">class</span> <span class="token class-name">Reader</span><span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">Writer</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">ByteStream</span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">protected</span><span class="token operator">:</span>
  <span class="token keyword">enum</span> <span class="token class-name">State</span> <span class="token punctuation">{<!-- --></span> CLOSED<span class="token punctuation">,</span> ERROR <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> capacity_<span class="token punctuation">;</span>
  <span class="token keyword">uint64_t</span> bytes_pushed_ <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 已写入的字节数</span>
  <span class="token keyword">uint64_t</span> bytes_popped_ <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">// 已弹出的字节数</span>

  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> flag <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>	<span class="token comment">// 0: normal, 1: closed, 2: error</span>
  std<span class="token double-colon punctuation">::</span>queue<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>string<span class="token operator">&gt;</span> buffer_data <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  std<span class="token double-colon punctuation">::</span>string_view buffer_view <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">explicit</span> <span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 提供ByteStream的 reader 和 writer 接口的辅助函数</span>
  Reader<span class="token operator">&amp;</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Reader<span class="token operator">&amp;</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
  Writer<span class="token operator">&amp;</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> Writer<span class="token operator">&amp;</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Writer</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ByteStream</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">void</span> <span class="token function">push</span><span class="token punctuation">(</span> std<span class="token double-colon punctuation">::</span>string data <span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 在可用容量允许的范围内向流中写入数据</span>

  <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 关闭流，不允许再向流中写入数据</span>
  <span class="token keyword">void</span> <span class="token function">set_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 流中出现错误，置位错误标志</span>

  <span class="token keyword">bool</span> <span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>      <span class="token comment">// 判断流是否已关闭</span>
  <span class="token keyword">uint64_t</span> <span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 计算流中剩余可用容量</span>
  <span class="token keyword">uint64_t</span> <span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>       <span class="token comment">// 计算流中已写入的字节数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Reader</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">ByteStream</span></span>
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
  std<span class="token double-colon punctuation">::</span>string_view <span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 返回流中下一个数据块的只读视图</span>
  <span class="token keyword">void</span> <span class="token function">pop</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> len <span class="token punctuation">)</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>      <span class="token comment">// 从流中弹出指定长度的数据块</span>

  <span class="token keyword">bool</span> <span class="token function">is_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 判断流是否已关闭且所有数据块都已弹出</span>
  <span class="token keyword">bool</span> <span class="token function">has_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>   <span class="token comment">// 判断流是否出现错误</span>

  <span class="token keyword">uint64_t</span> <span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span> <span class="token comment">// 计算当前流中剩余的字节数</span>
  <span class="token keyword">uint64_t</span> <span class="token function">bytes_popped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span><span class="token punctuation">;</span>   <span class="token comment">// 计算流中已弹出的字节数</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/*
 * read: A (provided) helper function thats peeks and pops up to `len` bytes
 * from a ByteStream Reader into a string;
 */</span>
<span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span> Reader<span class="token operator">&amp;</span> reader<span class="token punctuation">,</span> <span class="token keyword">uint64_t</span> len<span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span>string<span class="token operator">&amp;</span> out <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token comment">// byte_stream.cc</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdexcept&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"byte_stream.hh"</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token class-name">ByteStream</span><span class="token double-colon punctuation">::</span><span class="token function">ByteStream</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> capacity <span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">capacity_</span><span class="token punctuation">(</span> capacity <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">push</span><span class="token punctuation">(</span> string data <span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">auto</span> len <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 确定可写入的数据长度</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> len <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果可写入的数据长度为0，说明已经写满了，返回</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> len <span class="token operator">&lt;</span> data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 如果可写入的数据长度小于 data 的长度，说明只能写入部分数据</span>
    data<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span> len <span class="token punctuation">)</span><span class="token punctuation">;</span>             <span class="token comment">// 将 data 的长度截断为可写入的长度</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 将 data 写入到 buffer 中</span>
  buffer_data<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">move</span><span class="token punctuation">(</span> data <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> buffer_data<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">// 写入前为空时需要更新 buffer_view</span>
    buffer_view <span class="token operator">=</span> buffer_data<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  <span class="token comment">// 更新已写入的数据长度</span>
  bytes_pushed_ <span class="token operator">+=</span> len<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  flag <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> CLOSED <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">set_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  flag <span class="token operator">|=</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> ERROR <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> flag <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> CLOSED <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">available_capacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> capacity_ <span class="token operator">-</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Writer</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> bytes_pushed_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

string_view <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">peek</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> buffer_view<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">is_finished</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">is_closed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">bool</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">has_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> flag <span class="token operator">&amp;</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> ERROR <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">pop</span><span class="token punctuation">(</span> <span class="token keyword">uint64_t</span> len <span class="token punctuation">)</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> len <span class="token operator">&gt;</span> <span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 更新已弹出的数据长度</span>
  bytes_popped_ <span class="token operator">+=</span> len<span class="token punctuation">;</span>

  <span class="token comment">// 将 buffer 中的数据弹出</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span> len <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span> len <span class="token operator">&gt;=</span> buffer_view<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      len <span class="token operator">-=</span> buffer_view<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer_data<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      buffer_view <span class="token operator">=</span> buffer_data<span class="token punctuation">.</span><span class="token function">front</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 最开始就保证了 buffer_data 不为空</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
      buffer_view<span class="token punctuation">.</span><span class="token function">remove_prefix</span><span class="token punctuation">(</span> len <span class="token punctuation">)</span><span class="token punctuation">;</span>
      len <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_buffered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bytes_pushed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token function">bytes_popped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">uint64_t</span> <span class="token class-name">Reader</span><span class="token double-colon punctuation">::</span><span class="token function">bytes_popped</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token keyword">noexcept</span>
<span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> bytes_popped_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="43__370"></a>4.3 代码测试</h3> 
<p>在<code>build</code>下运行<code>make check0</code>，可以看到我的电脑上跑了10.90Gbit/s的速度，这个是和电脑有关的，我的电脑比较拉，和运气也有关系，当然和算法关系更大。<br> <img src="https://images2.imgbox.com/43/d6/ZFI0609H_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10c5ff457e3b9062a94a32d45542c7d7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java中Comparable接口和Comparator比较器的使用方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f7af13494ea7b5b5c71c351ec22981fd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">目标检测后的图像上绘制边界框和标签</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>