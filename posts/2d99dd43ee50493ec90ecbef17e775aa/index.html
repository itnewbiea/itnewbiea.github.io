<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PHP&#43;MySQL导出大量数据（Iterator yield） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PHP&#43;MySQL导出大量数据（Iterator yield）" />
<meta property="og:description" content="开发中经常遇到这样的场景
产品汪：我要在后台做一个功能，可以导出自定义时间范围的订单信息。开发小哥二话不说，半天就把功能做完并上线了。结果，第二天一上班产品汪过来就是拍桌子：MD，我想把去年一整年的订单都导出来，结果后台直接就挂了！
开发小哥一查，原来是内存溢出了，一年下来的的订单量足足有1000W条。于是，开发小哥跟产品汪吵了起来：你TM色不色傻，1000W的数据你导出来干diao，你是不是想把服务器给搞挂掉？
于是，产品汪与程序狗就这么结下梁子了。
但是。产品的需求你敢这样怼回去，那如果是老板提的这个需求呢，就是硬要把1000W条记录导出来，你还不得乖乖回去码代码？
那么，这个如果真要导出这大量数据，该怎么做呢？开发中我们经常会使用框架来提高我们的开发效率，但也意味着框架会对一些数据进行封装。
比如Yii2，当我们想获取去年一年的订单时，我们的代码会这样写：
Order::find()-&gt;where(&#34;create_time between &#39;2016-01-01&#39; AND &#39;2016-12-31&#39;&#34;)-&gt;all();
当我们将上面代码得到的结果集再拿去遍历时，数据量一大，就会内存溢出。 原因是：Yii2中，对all方法进行了封将，将大量的数据存入了数组中，而遍历大数据，必然会导致内存迅速上升。 那如何取出大量数据，而又不存到数组中呢？这就要用到了PHP中的迭代器：Iterator。如果有看过PDO::query的返回值类型的话，我们会发现，这个方法返回的 PDOStatement，正是对 Iterator 的实现。关于 Iterator，请自行脑补。
即然框架帮我们做了多余的封装，那么我们就改用原生API来实现。以下是完整代码
$sql = &#39;select * from user&#39;; $pdo = new \PDO(&#39;mysql:host=127.0.0.1;dbname=test&#39;, &#39;root&#39;, &#39;root&#39;); $pdo-&gt;setAttribute(\PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, false); $rows = $pdo-&gt;query($sql); $filename = date(&#39;Ymd&#39;) . &#39;.csv&#39;; //设置文件名 header(&#39;Content-Type: text/csv&#39;); header(&#34;Content-Disposition: attachment;filename={$filename}&#34;); $out = fopen(&#39;php://output&#39;, &#39;w&#39;); fputcsv($out, [&#39;id&#39;, &#39;username&#39;, &#39;password&#39;, &#39;create_time&#39;]); foreach ($rows as $row) { $line = [$row[&#39;id&#39;], $row[&#39;username&#39;], $row[&#39;password&#39;], $row[&#39;create_time&#39;]]; fputcsv($out, $line); } fclose($out); $memory = round((memory_get_usage() - $startMemory) / 1024 / 1024, 3) ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/2d99dd43ee50493ec90ecbef17e775aa/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-06-13T17:25:44+08:00" />
<meta property="article:modified_time" content="2017-06-13T17:25:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PHP&#43;MySQL导出大量数据（Iterator yield）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     开发中经常遇到这样的场景</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     产品汪：我要在后台做一个功能，可以导出自定义时间范围的订单信息。开发小哥二话不说，半天就把功能做完并上线了。结果，第二天一上班产品汪过来就是拍桌子：MD，我想把去年一整年的订单都导出来，结果后台直接就挂了！</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     开发小哥一查，原来是内存溢出了，一年下来的的订单量足足有1000W条。于是，开发小哥跟产品汪吵了起来：你TM色不色傻，1000W的数据你导出来干diao，你是不是想把服务器给搞挂掉？</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     于是，产品汪与程序狗就这么结下梁子了。</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     但是。产品的需求你敢这样怼回去，那如果是老板提的这个需求呢，就是硬要把1000W条记录导出来，你还不得乖乖回去码代码？</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     那么，这个如果真要导出这大量数据，该怎么做呢？开发中我们经常会使用框架来提高我们的开发效率，但也意味着框架会对一些数据进行封装。</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     比如Yii2，当我们想获取去年一年的订单时，我们的代码会这样写：</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     <code style='font-family:Menlo,Monaco,Consolas,"Courier New",monospace; font-size:14.4px; padding:2px 4px; color:rgb(199,37,78); background-color:rgb(249,242,244)'>Order::find()-&gt;where("create_time between '2016-01-01' AND '2016-12-31'")-&gt;all();</code></p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     当我们将上面代码得到的结果集再拿去遍历时，数据量一大，就会内存溢出。<br style=""> </p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     原因是：<span style="font-weight:700">Yii2中，对all方法进行了封将，将大量的数据存入了数组中，而<span style="color:rgb(255,0,0)">遍历大数据，必然会导致内存迅速上升</span>。</span><br style=""> </p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     那如何取出大量数据，而又不存到数组中呢？这就要用到了PHP中的迭代器：<span style="color:rgb(255,0,0)"><span style="font-weight:700">Iterator</span></span>。如果有看过PDO::query的返回值类型的话，我们会发现，这个方法返回的 <span style="color:rgb(255,0,0)"><span style="font-weight:700">PDOStatement</span></span>，正是对 <span style="font-weight:700; color:rgb(255,0,0)">Iterator </span>的实现。关于 <span style="font-weight:700; color:rgb(255,0,0)">Iterator</span>，请自行脑补。</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>     即然框架帮我们做了多余的封装，那么我们就改用原生API来实现。以下是完整代码</p> 
<pre><code class="language-php">$sql = 'select * from user';
$pdo = new \PDO('mysql:host=127.0.0.1;dbname=test', 'root', 'root');
$pdo-&gt;setAttribute(\PDO::MYSQL_ATTR_USE_BUFFERED_QUERY, false);
$rows = $pdo-&gt;query($sql);
$filename = date('Ymd') . '.csv'; //设置文件名
header('Content-Type: text/csv');
header("Content-Disposition: attachment;filename={$filename}");
$out = fopen('php://output', 'w');
fputcsv($out, ['id', 'username', 'password', 'create_time']);

foreach ($rows as $row) {
    $line = [$row['id'], $row['username'], $row['password'], $row['create_time']];

    fputcsv($out, $line);
}

fclose($out);
$memory = round((memory_get_usage() - $startMemory) / 1024 / 1024, 3) . 'M' . PHP_EOL;
file_put_contents('/tmp/test.txt', $memory, FILE_APPEND);</code></pre> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'>         在表中生成7位数量级的记录，执行上面的代码，通过查看内存使用，发现整个过程只占用了0.XM的内存，完全没有任何内存溢出的现象。</p> 
<p style='margin-top:0px; margin-bottom:20px; color:rgb(47,47,47); font-family:"lucida grande","lucida sans unicode",lucida,helvetica,"Hiragino Sans GB","Microsoft YaHei","WenQuanYi Micro Hei",sans-serif; font-size:16px'> <span style="white-space:pre"></span>原文链接：<a target="_blank" href="http://www.lbog.cn/blog/22" rel="nofollow noopener noreferrer">PHP+MySQL导出大量数据（Iterator yield）</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c1e61829196b53f147801243313f71e2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">新命令在Centos 7快速开启端口</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1295181e7cee9f60139f9133ea9aafa7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python3 类包装实现多线程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>