<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Wireshark抓包工具配置以及MQTT抓包分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Wireshark抓包工具配置以及MQTT抓包分析" />
<meta property="og:description" content="1、Wireshark抓包工具使用 打开Wireshark选择，需要抓取的物理网卡，添加过滤设置。
单击“捕获”，选择选项，输入需要捕获的IP地址和端口号。
如：
ip host 10.60.4.45 and tcp port 1883
ip host 10.60.4.45 and http port 80
单击开始，捕获即可。
2、Wireshark抓包工具常用过滤配置 抓包过滤器语法和实例
抓包过滤器类型Type（host、net、port）、方向Dir（src、dst）、协议Proto（ether、ip、tcp、udp、http、icmp、ftp等）、逻辑运算符（&amp;&amp; 与、|| 或、！非）
（1）协议过滤 比较简单，直接在抓包过滤框中直接输入协议名即可。
tcp，只显示TCP协议的数据包列表
http，只查看HTTP协议的数据包列表
icmp，只显示ICMP协议的数据包列表 （2）IP过滤
host 192.168.1.104
src host 192.168.1.104
dst host 192.168.1.104
（3）端口过滤
port 80
src port 80
dst port 80
（4）逻辑运算符&amp;&amp; 与、|| 或、！非
src host 192.168.1.104 &amp;&amp; dst port 80 抓取主机地址为192.168.1.80、目的端口为80的数据包
host 192.168.1.104 || host 192.168.1.102 抓取主机为192.168.1.104或者192.168.1.102的数据包
！broadcast 不抓取广播数据包
2、显示过滤器语法和实例
（1）比较操作符
比较操作符有== 等于、！= 不等于、&gt; 大于、&lt; 小于、&gt;= 大于等于、&lt;=小于等于。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b1ea78c312ef7c5c652f6353fb6894e3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-15T18:16:53+08:00" />
<meta property="article:modified_time" content="2023-11-15T18:16:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Wireshark抓包工具配置以及MQTT抓包分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1Wireshark_0"></a>1、Wireshark抓包工具使用</h3> 
<p>打开Wireshark选择，需要抓取的物理网卡，添加过滤设置。<br> 单击“捕获”，选择选项，输入需要捕获的IP地址和端口号。<br> 如：<br> ip host 10.60.4.45 and tcp port 1883<br> ip host 10.60.4.45 and http port 80</p> 
<p><img src="https://images2.imgbox.com/25/a6/Vgjtbdo2_o.png" alt="在这里插入图片描述"><br> 单击开始，捕获即可。<br> <img src="https://images2.imgbox.com/99/3b/FI2Tx56i_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2Wireshark_11"></a>2、Wireshark抓包工具常用过滤配置</h3> 
<div id="cnblogs_post_body" class="blogpost-body blogpost-body-html"> 
 <p>抓包过滤器语法和实例<br></p> 
 <p>   抓包过滤器类型Type（host、net、port）、方向Dir（src、dst）、协议Proto（ether、ip、tcp、udp、http、icmp、ftp等）、逻辑运算符（&amp;&amp; 与、|| 或、！非）</p> 
 <p>（1）协议过滤 <br></p> 
 <p>  比较简单，直接在抓包过滤框中直接输入协议名即可。</p> 
 <p>  tcp，只显示TCP协议的数据包列表</p> 
 <p>  http，只查看HTTP协议的数据包列表</p> 
 <p>  icmp，只显示ICMP协议的数据包列表 </p> 
 <p>（2）IP过滤</p> 
 <p>  host 192.168.1.104</p> 
 <p>  src host 192.168.1.104</p> 
 <p>  dst host  192.168.1.104</p> 
 <p>（3）端口过滤</p> 
 <p>  port 80</p> 
 <p>  src port 80</p> 
 <p>  dst port 80</p> 
 <p>（4）逻辑运算符&amp;&amp; 与、|| 或、！非</p> 
 <p>  src host 192.168.1.104 &amp;&amp; dst port 80 抓取主机地址为192.168.1.80、目的端口为80的数据包</p> 
 <p>  host 192.168.1.104 || host 192.168.1.102 抓取主机为192.168.1.104或者192.168.1.102的数据包</p> 
 <p>  ！broadcast 不抓取广播数据包</p> 
 <p>2、显示过滤器语法和实例</p> 
 <p>（1）比较操作符</p> 
 <p>  比较操作符有== 等于、！= 不等于、&gt; 大于、&lt; 小于、&gt;= 大于等于、&lt;=小于等于。</p> 
 <p>（2）协议过滤</p> 
 <p>  比较简单，直接在Filter框中直接输入协议名即可。<strong>注意：协议名称需要输入小写。</strong></p> 
 <p>  tcp，只显示TCP协议的数据包列表</p> 
 <p>  http，只查看HTTP协议的数据包列表</p> 
 <p>  icmp，只显示ICMP协议的数据包列表<br></p> 
 <p><img src="https://images2.imgbox.com/c1/b0/pjzH9dSV_o.png" alt="" class="medium-zoom-image"></p> 
 <p>（3） ip过滤</p> 
 <p>   ip.src ==192.168.1.104 显示源地址为192.168.1.104的数据包列表</p> 
 <p>   ip.dst==192.168.1.104, 显示目标地址为192.168.1.104的数据包列表</p> 
 <p>   ip.addr == 192.168.1.104 显示源IP地址或目标IP地址为192.168.1.104的数据包列表</p> 
 <p><img src="https://images2.imgbox.com/c3/0b/haA4qRVN_o.png" alt="" class="medium-zoom-image"></p> 
 <p>（4）端口过滤</p> 
 <p>  tcp.port ==80,  显示源主机或者目的主机端口为80的数据包列表。</p> 
 <p>  tcp.srcport == 80,  只显示TCP协议的源主机端口为80的数据包列表。</p> 
 <p>  tcp.dstport == 80，只显示TCP协议的目的主机端口为80的数据包列表。</p> 
 <p><img src="https://images2.imgbox.com/e2/a8/7h6oFP5n_o.png" alt="" class="medium-zoom-image"></p> 
 <p>（5） Http模式过滤</p> 
 <p>  http.request.method=="GET",   只显示HTTP GET方法的。</p> 
 <p>（6）逻辑运算符为 and/or/not<br></p> 
 <p>  过滤多个条件组合时，使用and/or。比如获取IP地址为192.168.1.104的ICMP数据包表达式为ip.addr == 192.168.1.104 and icmp<br></p> 
 <p align="center"><img src="https://images2.imgbox.com/ea/5b/E5i5JysX_o.png" alt="" class="medium-zoom-image"></p> 
 <p>（7）按照数据包内容过滤。假设我要以IMCP层中的内容进行过滤，可以单击选中界面中的码流，在下方进行选中数据。如下</p> 
</div> 
<p>右键单击选中后出现如下界面</p> 
<p><img src="https://images2.imgbox.com/85/91/8Os7J6Le_o.png" alt="" class="medium-zoom-image"></p> 
<p>后面条件表达式就需要自己填写。如下我想过滤出data数据包中包含"abcd"内容的数据流。<strong>包含的关键词是contains 后面跟上内容。</strong></p> 
<p>看到这， 基本上对wireshak有了初步了解。</p> 
<h2>Wireshark抓包分析TCP三次握手</h2> 
<p>（1）TCP三次握手连接建立过程</p> 
<p>    Step1：客户端发送一个SYN=1，ACK=0标志的数据包给服务端，请求进行连接，这是第一次握手；</p> 
<p>    Step2：服务端收到请求并且允许连接的话，就会发送一个SYN=1，ACK=1标志的数据包给发送端，告诉它，可以通讯了，并且让客户端发送一个确认数据包，这是第二次握手；</p> 
<p>   Step3：服务端发送一个SYN=0，ACK=1的数据包给客户端端，告诉它连接已被确认，这就是第三次握手。TCP连接建立，开始通讯。</p> 
<p align="center"><img src="https://images2.imgbox.com/ca/59/tbvhaOZ4_o.png" alt="" class="medium-zoom-image"></p> 
<p>（2）wireshark抓包获取访问指定服务端数据包</p> 
<p>    Step1：启动wireshark抓包，打开浏览器输入www.huawei.com。</p> 
<p>    Step2：使用ping www.huawei.com获取IP。</p> 
<p><img src="https://images2.imgbox.com/1d/89/MRSpnq4A_o.png" alt="" class="medium-zoom-image"></p> 
<p>    Step3：输入过滤条件获取待分析数据包列表 ip.addr == 211.162.2.183</p> 
<p><img src="https://images2.imgbox.com/c1/2b/h4QUfabu_o.png" alt="" class="medium-zoom-image"></p> 
<p>  图中可以看到wireshark截获到了三次握手的三个数据包。第四个包才是HTTP的， 这说明HTTP的确是使用TCP建立连接的。</p> 
<p><strong>第一次握手数据包</strong></p> 
<p>客户端发送一个TCP，标志位为SYN，序列号为0， 代表客户端请求建立连接。 如下图。</p> 
<p align="center">数据包的关键属性如下：</p> 
<p align="center">  SYN ：标志位，表示请求建立连接</p> 
<p align="center">  Seq = 0 ：初始建立连接值为0，数据包的相对序列号从0开始，表示当前还没有发送数据</p> 
<p align="center">  Ack =0：初始建立连接值为0，已经收到包的数量，表示当前没有接收到数据</p> 
<p><strong>第二次握手的数据包</strong></p> 
<p>服务器发回确认包, 标志位为 SYN,ACK. 将确认序号(Acknowledgement Number)设置为客户的I S N加1以.即0+1=1, 如下图</p> 
<p align="center"><img src="https://images2.imgbox.com/b8/68/C4w3v9gr_o.png" alt="" class="medium-zoom-image"></p> 
<p> 数据包的关键属性如下：</p> 
<p>  [SYN + ACK]: 标志位，同意建立连接，并回送SYN+ACK</p> 
<p>  Seq = 0 ：初始建立值为0，表示当前还没有发送数据</p> 
<p>  Ack = 1：表示当前端成功接收的数据位数，虽然客户端没有发送任何有效数据，确认号还是被加1，因为包含SYN或FIN标志位。（并不会对有效数据的计数产生影响，因为含有SYN或FIN标志位的包并不携带有效数据） </p> 
<p><strong>第三次握手的数据包</strong></p> 
<p>  客户端再次发送确认包(ACK) SYN标志位为0,ACK标志位为1.并且把服务器发来ACK的序号字段+1,放在确定字段中发送给对方.并且在数据段放写ISN的+1, 如下图:</p> 
<p align="center"><img src="https://images2.imgbox.com/c7/84/wejoYoHg_o.png" alt="" class="medium-zoom-image"></p> 
<p>数据包的关键属性如下：</p> 
<p>  ACK ：标志位，表示已经收到记录</p> 
<p>  Seq = 1 ：表示当前已经发送1个数据</p> 
<p>  Ack = 1 : 表示当前端成功接收的数据位数，虽然服务端没有发送任何有效数据，确认号还是被加1，因为包含SYN或FIN标志位（并不会对有效数据的计数产生影响，因为含有SYN或FIN标志位的包并不携带有效数据)。<br></p> 
<p>  就这样通过了TCP三次握手，建立了连接。开始进行数据交互</p> 
<p>下面针对数据交互过程的数据包进行一些说明：</p> 
<p>数据包的关键属性说明</p> 
<p>  Seq: 1 </p> 
<p>  Ack: 1: 说明现在共收到1字节数据</p> 
<p>  Seq: 1 <br>  Ack: 951: 说明现在服务端共收到951字节数据</p> 
<p>  在TCP层，有个FLAGS字段，这个字段有以下几个标识：SYN, FIN, ACK, PSH, RST, URG。如下</p> 
<p>    其中，对于我们日常的分析有用的就是前面的五个字段。它们的含义是：SYN表示建立连接，FIN表示关闭连接，ACK表示响应，PSH表示有DATA数据传输，RST表示连接重置。</p> Wireshark分析常用操作 
<p>  调整数据包列表中时间戳显示格式。调整方法为View --&gt;Time Display Format --&gt; Date and Time of Day。 </p> 
<h3><a id="3MQTT_111"></a>3、MQTT协议抓包分析</h3> 
<p>Wireshark抓包工具，抓取了ICMP以上的数据包。</p> 
<p><img src="https://images2.imgbox.com/01/13/4DFSyJ60_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b2/36/Jyl9MDku_o.png" alt="在这里插入图片描述"><br> Internet 协议版本 网络层。<br> <img src="https://images2.imgbox.com/57/58/1ElxwWXA_o.png" alt="在这里插入图片描述"><br> 传输控制层，数据<br> <img src="https://images2.imgbox.com/1f/9a/w2obJ6Ua_o.png" alt="在这里插入图片描述"></p> 
<p>TCP/UDP，传输层数据：MQTT包部分<br> 数据长度：33BYTE<br> <img src="https://images2.imgbox.com/e5/d9/FgxDMm0u_o.png" alt="在这里插入图片描述"><br> MQTT固定头</p> 
<p><img src="https://images2.imgbox.com/13/94/QKo59Fns_o.png" alt="在这里插入图片描述"></p> 
<p>可变部分头，（发布主题）<br> <img src="https://images2.imgbox.com/72/b7/8Ac8FYvy_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/47/ba/GDA6aIAS_o.png" alt="在这里插入图片描述"><br> MQTT负载，发布主题内容。<br> <img src="https://images2.imgbox.com/77/95/BdUAKq1t_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/1b/e1/xDfxjcVh_o.png" alt="在这里插入图片描述"></p> 
<h2>参考文档</h2> 
<p> <a href="https://www.cr173.com/html/20128_all.html" rel="noopener noopener noreferrer" target="_blank">wireshark抓包详细图文教程</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c4e306dd39778dc898ebf18ef768fe4e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何使用java语言下载https的网络文件</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/562db994089a3280fb0b8f2250638848/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Pinia 插件 pinia-plugin-persist 添加 persist 属性时报错：没有与此调用匹配的重载</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>