<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>BP-LSTM-Attention-transformer，含数据，可直接运行，TensorFlow - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="BP-LSTM-Attention-transformer，含数据，可直接运行，TensorFlow" />
<meta property="og:description" content="1、摘要 本文主要讲解：BP-LSTM-Attention-transformer，含数据，可直接运行，TensorFlow
主要思路：
使用bp神经网络做多分类使用cnn-lstm-attention做时间序列预测使用transformer做时间序列预测 2、数据介绍 bp的数据有八个类别，每个类别里有不同的特征的数据
lstm&#43;attention的数据是时间序列数据，蓄电池按时间的寿命数据
transformer数据是温度值跟pue的关系
3、文件介绍 4、完整代码和步骤 此代码的依赖环境如下：
tensorflow==2.5.0 keras==2.6.0 numpy==1.19.5 matplotlib==3.5.2 torch==1.8.0 opencv-python==4.2.0.32 pandas==1.1.5 scikit-learn==0.22.1 代码输出如下：
主运行程序入口
import math import os import time import csv import numpy as np import pandas as pd import torch import torch.nn as nn import matplotlib.pyplot as plt from sklearn import metrics from sklearn import preprocessing # 导入库 from sklearn.feature_selection import SelectKBest, f_regression from sklearn.metrics import mean_squared_error from sklearn.model_selection import train_test_split from sklearn." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b14fac05f1b6d5aa73719a7f05ec0385/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-06-03T16:54:09+08:00" />
<meta property="article:modified_time" content="2023-06-03T16:54:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">BP-LSTM-Attention-transformer，含数据，可直接运行，TensorFlow</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="1_1"></a>1、摘要</h4> 
<p>本文主要讲解：BP-LSTM-Attention-transformer，含数据，可直接运行，TensorFlow<br> 主要思路：</p> 
<ol><li>使用bp神经网络做多分类</li><li>使用cnn-lstm-attention做时间序列预测</li><li>使用transformer做时间序列预测</li></ol> 
<h4><a id="2_9"></a>2、数据介绍</h4> 
<p>bp的数据有八个类别，每个类别里有不同的特征的数据<br> <img src="https://images2.imgbox.com/38/24/oLwLzqyS_o.png" alt="在这里插入图片描述"><br> lstm+attention的数据是时间序列数据，蓄电池按时间的寿命数据<br> <img src="https://images2.imgbox.com/6a/02/irSRHcQd_o.png" alt="在这里插入图片描述"><br> transformer数据是温度值跟pue的关系<br> <img src="https://images2.imgbox.com/32/2d/XduOXxp0_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="3_17"></a>3、文件介绍</h4> 
<p><img src="https://images2.imgbox.com/ba/77/mAPXASvx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/52/c7/uGACDmQk_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d6/d6/0bj54QWr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/3d/52/duNBlEpQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b8/42/cxAZBIlw_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4_24"></a>4、完整代码和步骤</h4> 
<p>此代码的依赖环境如下：</p> 
<pre><code class="prism language-python">tensorflow<span class="token operator">==</span><span class="token number">2.5</span><span class="token number">.0</span>
keras<span class="token operator">==</span><span class="token number">2.6</span><span class="token number">.0</span>
numpy<span class="token operator">==</span><span class="token number">1.19</span><span class="token number">.5</span>
matplotlib<span class="token operator">==</span><span class="token number">3.5</span><span class="token number">.2</span>
torch<span class="token operator">==</span><span class="token number">1.8</span><span class="token number">.0</span>
opencv<span class="token operator">-</span>python<span class="token operator">==</span><span class="token number">4.2</span><span class="token number">.0</span><span class="token number">.32</span>
pandas<span class="token operator">==</span><span class="token number">1.1</span><span class="token number">.5</span>
scikit<span class="token operator">-</span>learn<span class="token operator">==</span><span class="token number">0.22</span><span class="token number">.1</span>
</code></pre> 
<p>代码输出如下：</p> 
<p>主运行程序入口</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> math
<span class="token keyword">import</span> os
<span class="token keyword">import</span> time
<span class="token keyword">import</span> csv
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt

<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> metrics
<span class="token keyword">from</span> sklearn <span class="token keyword">import</span> preprocessing  <span class="token comment"># 导入库</span>
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>feature_selection <span class="token keyword">import</span> SelectKBest<span class="token punctuation">,</span> f_regression
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>metrics <span class="token keyword">import</span> mean_squared_error
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>model_selection <span class="token keyword">import</span> train_test_split
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>preprocessing <span class="token keyword">import</span> MinMaxScaler
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable

<span class="token comment"># os.chdir(r'D:\项目\transformer-pue\实验')</span>


<span class="token keyword">def</span> <span class="token function">writeOneCsv</span><span class="token punctuation">(</span>relate_record<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>src<span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">,</span> newline<span class="token operator">=</span><span class="token string">'\n'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> csvFile<span class="token punctuation">:</span>
        writer <span class="token operator">=</span> csv<span class="token punctuation">.</span>writer<span class="token punctuation">(</span>csvFile<span class="token punctuation">)</span>
        writer<span class="token punctuation">.</span>writerow<span class="token punctuation">(</span>relate_record<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">min_max_select</span><span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> head_feature_num<span class="token punctuation">)</span><span class="token punctuation">:</span>
    scaler <span class="token operator">=</span> MinMaxScaler<span class="token punctuation">(</span>feature_range<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    all_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>scaler<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>X_train<span class="token punctuation">)</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>X_train<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
    scaled <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>preprocessing<span class="token punctuation">.</span>scale<span class="token punctuation">(</span>all_data<span class="token punctuation">)</span><span class="token punctuation">,</span> columns<span class="token operator">=</span>all_data<span class="token punctuation">.</span>columns<span class="token punctuation">)</span>
    X_train <span class="token operator">=</span> scaled<span class="token punctuation">.</span>loc<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token builtin">len</span><span class="token punctuation">(</span>X_train<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token comment"># 特征选择</span>
    X_scored <span class="token operator">=</span> SelectKBest<span class="token punctuation">(</span>score_func<span class="token operator">=</span>f_regression<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token string">'all'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>
    feature_scoring <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">'feature'</span><span class="token punctuation">:</span> X_train<span class="token punctuation">.</span>columns<span class="token punctuation">,</span>
        <span class="token string">'score'</span><span class="token punctuation">:</span> X_scored<span class="token punctuation">.</span>scores_
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    feat_scored <span class="token operator">=</span> feature_scoring<span class="token punctuation">.</span>sort_values<span class="token punctuation">(</span><span class="token string">'score'</span><span class="token punctuation">,</span> ascending<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">.</span>head<span class="token punctuation">(</span>head_feature_num<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token string">'feature'</span><span class="token punctuation">]</span>
    writeOneCsv<span class="token punctuation">(</span><span class="token punctuation">[</span>head_feature_num<span class="token punctuation">,</span> feat_scored<span class="token punctuation">.</span>values<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">'选择后的特征.csv'</span><span class="token punctuation">)</span>
    X_train <span class="token operator">=</span> X_train<span class="token punctuation">[</span>X_train<span class="token punctuation">.</span>columns<span class="token punctuation">[</span>X_train<span class="token punctuation">.</span>columns<span class="token punctuation">.</span>isin<span class="token punctuation">(</span>feat_scored<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> X_train<span class="token punctuation">.</span>values<span class="token punctuation">,</span> y_train<span class="token punctuation">.</span>values


<span class="token keyword">class</span> <span class="token class-name">PositionalEncoding</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> max_len<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>PositionalEncoding<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

        pe <span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>max_len<span class="token punctuation">,</span> d_model<span class="token punctuation">)</span>
        position <span class="token operator">=</span> torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> max_len<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">)</span><span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        div_term <span class="token operator">=</span> torch<span class="token punctuation">.</span>exp<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> d_model<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token operator">-</span>math<span class="token punctuation">.</span>log<span class="token punctuation">(</span><span class="token number">10000.0</span><span class="token punctuation">)</span> <span class="token operator">/</span> d_model<span class="token punctuation">)</span><span class="token punctuation">)</span>
        pe<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>position <span class="token operator">*</span> div_term<span class="token punctuation">)</span>
        pe<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> torch<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>position <span class="token operator">*</span> div_term<span class="token punctuation">)</span>
        pe <span class="token operator">=</span> pe<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>register_buffer<span class="token punctuation">(</span><span class="token string">'pe'</span><span class="token punctuation">,</span> pe<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x <span class="token operator">+</span> self<span class="token punctuation">.</span>pe<span class="token punctuation">[</span><span class="token punctuation">:</span>x<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">:</span><span class="token punctuation">]</span>


<span class="token keyword">class</span> <span class="token class-name">TransAm</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> feature_size<span class="token operator">=</span><span class="token number">250</span><span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>TransAm<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>model_type <span class="token operator">=</span> <span class="token string">'Transformer'</span>

        self<span class="token punctuation">.</span>src_mask <span class="token operator">=</span> <span class="token boolean">None</span>
        self<span class="token punctuation">.</span>pos_encoder <span class="token operator">=</span> PositionalEncoding<span class="token punctuation">(</span>feature_size<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>encoder_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>TransformerEncoderLayer<span class="token punctuation">(</span>d_model<span class="token operator">=</span>feature_size<span class="token punctuation">,</span> nhead<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>transformer_encoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>TransformerEncoder<span class="token punctuation">(</span>self<span class="token punctuation">.</span>encoder_layer<span class="token punctuation">,</span> num_layers<span class="token operator">=</span>num_layers<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>decoder <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> feature_size<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>init_weights<span class="token punctuation">(</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>feature_size <span class="token operator">=</span> feature_size
        self<span class="token punctuation">.</span>num_layers <span class="token operator">=</span> num_layers
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> dropout

    <span class="token keyword">def</span> <span class="token function">feature</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token string">"feature_size"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>feature_size<span class="token punctuation">,</span> <span class="token string">"num_layers"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>num_layers<span class="token punctuation">,</span> <span class="token string">"dropout"</span><span class="token punctuation">:</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">}</span>

    <span class="token keyword">def</span> <span class="token function">init_weights</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        initrange <span class="token operator">=</span> <span class="token number">0.1</span>
        self<span class="token punctuation">.</span>decoder<span class="token punctuation">.</span>bias<span class="token punctuation">.</span>data<span class="token punctuation">.</span>zero_<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>decoder<span class="token punctuation">.</span>weight<span class="token punctuation">.</span>data<span class="token punctuation">.</span>uniform_<span class="token punctuation">(</span><span class="token operator">-</span>initrange<span class="token punctuation">,</span> initrange<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> src<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>src_mask <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> self<span class="token punctuation">.</span>src_mask<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">:</span>
            device <span class="token operator">=</span> src<span class="token punctuation">.</span>device
            mask <span class="token operator">=</span> self<span class="token punctuation">.</span>_generate_square_subsequent_mask<span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>src_mask <span class="token operator">=</span> mask
        src <span class="token operator">=</span> self<span class="token punctuation">.</span>pos_encoder<span class="token punctuation">(</span>src<span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>transformer_encoder<span class="token punctuation">(</span>src<span class="token punctuation">,</span> self<span class="token punctuation">.</span>src_mask<span class="token punctuation">)</span>
        output <span class="token operator">=</span> output<span class="token punctuation">.</span>view<span class="token punctuation">(</span>output<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        output <span class="token operator">=</span> self<span class="token punctuation">.</span>decoder<span class="token punctuation">(</span>output<span class="token punctuation">)</span>
        <span class="token keyword">return</span> output

    <span class="token keyword">def</span> <span class="token function">_generate_square_subsequent_mask</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">:</span>
        mask <span class="token operator">=</span> <span class="token punctuation">(</span>torch<span class="token punctuation">.</span>triu<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>ones<span class="token punctuation">(</span>sz<span class="token punctuation">,</span> sz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>transpose<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        mask <span class="token operator">=</span> mask<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token string">'-inf'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>masked_fill<span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">float</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> mask


<span class="token keyword">class</span> <span class="token class-name">General_Regression_Training_3d</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token keyword">def</span> <span class="token function">reg_calculate</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> true<span class="token punctuation">,</span> prediction<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">'''
            To calculate the result of regression,
            including mse, rmse, mae, r2, four criterions.
        '''</span>
        prediction<span class="token punctuation">[</span>prediction <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        mse <span class="token operator">=</span> mean_squared_error<span class="token punctuation">(</span>true<span class="token punctuation">,</span> prediction<span class="token punctuation">)</span>
        mae <span class="token operator">=</span> metrics<span class="token punctuation">.</span>mean_absolute_error<span class="token punctuation">(</span>true<span class="token punctuation">,</span> prediction<span class="token punctuation">)</span>
        <span class="token keyword">return</span> mse<span class="token punctuation">,</span> mae

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> net<span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1e-3</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">,</span> <span class="token number">1e-7</span><span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span> epoch<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">,</span> use_more_gpu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                 weight_decay<span class="token operator">=</span><span class="token number">1e-8</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_path<span class="token operator">=</span><span class="token string">'CNN_Result'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

        self<span class="token punctuation">.</span>net <span class="token operator">=</span> net
        self<span class="token punctuation">.</span>resultDict <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"learning_rate"</span><span class="token punctuation">:</span> learning_rate<span class="token punctuation">,</span> <span class="token string">"batch_size"</span><span class="token punctuation">:</span> batch_size<span class="token punctuation">,</span> <span class="token string">"epoch"</span><span class="token punctuation">:</span> epoch<span class="token punctuation">,</span>
                           <span class="token string">"weight_decay"</span><span class="token punctuation">:</span> weight_decay<span class="token punctuation">,</span> <span class="token string">"use_more_gpu"</span><span class="token punctuation">:</span> use_more_gpu<span class="token punctuation">,</span> <span class="token string">"device"</span><span class="token punctuation">:</span> device<span class="token punctuation">,</span> <span class="token punctuation">}</span>
        self<span class="token punctuation">.</span>resultDict <span class="token operator">=</span> <span class="token builtin">dict</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>resultDict<span class="token punctuation">,</span> <span class="token operator">**</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>feature<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>batch_size <span class="token operator">=</span> batch_size
        self<span class="token punctuation">.</span>use_more_gpu <span class="token operator">=</span> use_more_gpu
        self<span class="token punctuation">.</span>lr <span class="token operator">=</span> learning_rate
        self<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch
        self<span class="token punctuation">.</span>weight_decay <span class="token operator">=</span> weight_decay
        self<span class="token punctuation">.</span>device <span class="token operator">=</span> device
        self<span class="token punctuation">.</span>epoch <span class="token operator">=</span> epoch

        self<span class="token punctuation">.</span>save_path <span class="token operator">=</span> save_path  <span class="token comment"># 设置一条保存路径，直接把所有的值都收藏起来</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_path<span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>avgLossList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># put the avgLoss data</span>
        self<span class="token punctuation">.</span>TrainLosses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>TestLosses <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>t <span class="token operator">=</span> <span class="token number">0</span>
        self<span class="token punctuation">.</span>D <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        self<span class="token punctuation">.</span>n <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 来记录 梯度衰减 的次数</span>
        self<span class="token punctuation">.</span>limit <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1e-5</span><span class="token punctuation">,</span> <span class="token number">1e-6</span><span class="token punctuation">,</span> <span class="token number">1e-7</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">create_batch_size</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span><span class="token punctuation">:</span>
        p <span class="token operator">=</span> np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>permutation<span class="token punctuation">(</span>X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        data <span class="token operator">=</span> X_train<span class="token punctuation">[</span>p<span class="token punctuation">]</span>
        label <span class="token operator">=</span> y_train<span class="token punctuation">[</span>p<span class="token punctuation">]</span>

        batch_size <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_size
        batch_len <span class="token operator">=</span> X_train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">//</span> batch_size <span class="token operator">+</span> <span class="token number">1</span>

        b_datas <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        b_labels <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>batch_len<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">try</span><span class="token punctuation">:</span>
                batch_data <span class="token operator">=</span> data<span class="token punctuation">[</span>batch_size <span class="token operator">*</span> i<span class="token punctuation">:</span> batch_size <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
                batch_label <span class="token operator">=</span> label<span class="token punctuation">[</span>batch_size <span class="token operator">*</span> i<span class="token punctuation">:</span> batch_size <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token keyword">except</span><span class="token punctuation">:</span>
                batch_data <span class="token operator">=</span> data<span class="token punctuation">[</span>batch_size <span class="token operator">*</span> i<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
                batch_label <span class="token operator">=</span> label<span class="token punctuation">[</span>batch_size <span class="token operator">*</span> i<span class="token punctuation">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
            b_datas<span class="token punctuation">.</span>append<span class="token punctuation">(</span>batch_data<span class="token punctuation">)</span>
            b_labels<span class="token punctuation">.</span>append<span class="token punctuation">(</span>batch_label<span class="token punctuation">)</span>

        <span class="token keyword">return</span> b_datas<span class="token punctuation">,</span> b_labels

    <span class="token keyword">def</span> <span class="token function">fit</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_test<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">''' training the network '''</span>
        <span class="token comment"># input the dataset and transform into dataLoad</span>
        <span class="token comment"># if y is a scalar</span>
        <span class="token keyword">if</span> y_train<span class="token punctuation">.</span>ndim <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            y_train <span class="token operator">=</span> y_train<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> y_test<span class="token punctuation">.</span>ndim <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            y_test <span class="token operator">=</span> y_test<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>X_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>X_test<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_train<span class="token punctuation">,</span> self<span class="token punctuation">.</span>y_test <span class="token operator">=</span> X_train<span class="token punctuation">,</span> X_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_test

        b_data<span class="token punctuation">,</span> b_labels <span class="token operator">=</span> self<span class="token punctuation">.</span>create_batch_size<span class="token punctuation">(</span>X_train<span class="token punctuation">,</span> y_train<span class="token punctuation">)</span>

        save_result <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_path<span class="token punctuation">,</span> <span class="token string">'Results.csv'</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            count <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">open</span><span class="token punctuation">(</span>save_result<span class="token punctuation">,</span> <span class="token string">'rU'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            count <span class="token operator">=</span> <span class="token number">1</span>

        net_weight <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>save_path<span class="token punctuation">,</span> <span class="token string">'Weight'</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>net_weight<span class="token punctuation">)</span><span class="token punctuation">:</span>
            os<span class="token punctuation">.</span>makedirs<span class="token punctuation">(</span>net_weight<span class="token punctuation">)</span>

        net_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>net_weight<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.pkl'</span><span class="token punctuation">)</span>
        net_para_path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>net_weight<span class="token punctuation">,</span> <span class="token builtin">str</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_parameters.pkl'</span><span class="token punctuation">)</span>

        <span class="token comment"># set the net use cpu or gpu</span>
        device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span>self<span class="token punctuation">.</span>device <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Let's use GPU: {}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>device<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Let's use CPU"</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>use_more_gpu <span class="token keyword">and</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Let's use"</span><span class="token punctuation">,</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>device_count<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"GPUs"</span><span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>net <span class="token operator">=</span> nn<span class="token punctuation">.</span>DataParallel<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

        <span class="token comment"># network change to train model</span>
        self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># set optimizer and loss function</span>
        <span class="token keyword">try</span><span class="token punctuation">:</span>
            optim <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>self<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>
        <span class="token keyword">except</span><span class="token punctuation">:</span>
            optim <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>Adam<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">,</span> weight_decay<span class="token operator">=</span>self<span class="token punctuation">.</span>weight_decay<span class="token punctuation">)</span>
        criterion <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># Officially start training</span>
        start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 计算时间</span>
        limit <span class="token operator">=</span> self<span class="token punctuation">.</span>limit<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> e <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>epoch<span class="token punctuation">)</span><span class="token punctuation">:</span>

            tempLoss <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
            self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>b_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    train_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>b_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                    train_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>b_labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    train_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>b_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    train_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>b_labels<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>train_x<span class="token punctuation">)</span>

                loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>prediction<span class="token punctuation">,</span> train_y<span class="token punctuation">)</span>
                tempLoss<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">(</span>loss<span class="token punctuation">)</span><span class="token punctuation">)</span>

                optim<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
                loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>
                optim<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            self<span class="token punctuation">.</span>D<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            avgloss <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>tempLoss<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token builtin">len</span><span class="token punctuation">(</span>tempLoss<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>avgLossList<span class="token punctuation">.</span>append<span class="token punctuation">(</span>avgloss<span class="token punctuation">)</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Training... epoch: {}, loss: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>avgLossList<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    test_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                    test_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                <span class="token keyword">else</span><span class="token punctuation">:</span>
                    test_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    test_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">)</span><span class="token punctuation">)</span>

                test_prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>
                test_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>test_prediction<span class="token punctuation">,</span> test_y<span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>TrainLosses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>avgloss<span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>TestLosses<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                self<span class="token punctuation">.</span>test_prediction <span class="token operator">=</span> test_prediction<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                self<span class="token punctuation">.</span>test_prediction<span class="token punctuation">[</span>self<span class="token punctuation">.</span>test_prediction <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>

            <span class="token comment"># epoch 终止装置</span>
            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>D<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">20</span><span class="token punctuation">:</span>
                loss1 <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>D<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                loss2 <span class="token operator">=</span> np<span class="token punctuation">.</span>mean<span class="token punctuation">(</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>self<span class="token punctuation">.</span>D<span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">10</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                d <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">float</span><span class="token punctuation">(</span>np<span class="token punctuation">.</span><span class="token builtin">abs</span><span class="token punctuation">(</span>loss2 <span class="token operator">-</span> loss1<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 計算loss的差值</span>

                <span class="token keyword">if</span> d <span class="token operator">&lt;</span> limit <span class="token keyword">or</span> e <span class="token operator">==</span> self<span class="token punctuation">.</span>epoch <span class="token operator">-</span> <span class="token number">1</span> <span class="token keyword">or</span> e <span class="token operator">&gt;</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>epoch <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">3</span> <span class="token operator">*</span> <span class="token punctuation">(</span>
                        self<span class="token punctuation">.</span>n <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 加入遍历完都没达成limit限定，就直接得到结果</span>

                    self<span class="token punctuation">.</span>D <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment"># 重置</span>
                    self<span class="token punctuation">.</span>n <span class="token operator">+=</span> <span class="token number">1</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'The error changes within {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>e <span class="token operator">=</span> e <span class="token operator">+</span> <span class="token number">1</span>

                    <span class="token keyword">print</span><span class="token punctuation">(</span>
                        <span class="token string">'Training... epoch: {}, loss: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">,</span> net_path<span class="token punctuation">)</span>
                    torch<span class="token punctuation">.</span>save<span class="token punctuation">(</span>self<span class="token punctuation">.</span>net<span class="token punctuation">.</span>state_dict<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> net_para_path<span class="token punctuation">)</span>

                    self<span class="token punctuation">.</span>net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                        test_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                        test_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
                    <span class="token keyword">else</span><span class="token punctuation">:</span>
                        test_x <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>X_test<span class="token punctuation">)</span><span class="token punctuation">)</span>
                        test_y <span class="token operator">=</span> Variable<span class="token punctuation">(</span>torch<span class="token punctuation">.</span>FloatTensor<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">)</span><span class="token punctuation">)</span>

                    test_prediction <span class="token operator">=</span> self<span class="token punctuation">.</span>net<span class="token punctuation">(</span>test_x<span class="token punctuation">)</span>
                    test_loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>test_prediction<span class="token punctuation">,</span> test_y<span class="token punctuation">)</span>

                    self<span class="token punctuation">.</span>test_prediction <span class="token operator">=</span> test_prediction<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>test_prediction<span class="token punctuation">[</span>self<span class="token punctuation">.</span>test_prediction <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
                    plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span>figsize<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test_prediction<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"red"</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>test_y<span class="token punctuation">.</span>tolist<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token operator">=</span><span class="token string">"green"</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">'real vs pred test'</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'pue'</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'x'</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'pred'</span><span class="token punctuation">,</span> <span class="token string">'real'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> loc<span class="token operator">=</span><span class="token string">'lower right'</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">"real_pred_"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>feature_selection_ratio<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.png'</span><span class="token punctuation">,</span> dpi<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">,</span> bbox_inches<span class="token operator">=</span><span class="token string">'tight'</span><span class="token punctuation">)</span>
                    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    self<span class="token punctuation">.</span>mse<span class="token punctuation">,</span> self<span class="token punctuation">.</span>mae <span class="token operator">=</span> self<span class="token punctuation">.</span>reg_calculate<span class="token punctuation">(</span>self<span class="token punctuation">.</span>y_test<span class="token punctuation">,</span> self<span class="token punctuation">.</span>test_prediction<span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'\033[1;35m Testing epoch: {}, loss: {} , mae: {} \033[0m!'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                             test_loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                                                                                             self<span class="token punctuation">.</span>mae<span class="token punctuation">)</span><span class="token punctuation">)</span>

                    <span class="token comment"># 已经梯度衰减了 2 次</span>
                    <span class="token keyword">if</span> self<span class="token punctuation">.</span>n <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
                        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'The meaning of the loop is not big, stop!!'</span><span class="token punctuation">)</span>
                        <span class="token keyword">break</span>
                    limit <span class="token operator">=</span> self<span class="token punctuation">.</span>limit<span class="token punctuation">[</span>self<span class="token punctuation">.</span>n<span class="token punctuation">]</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Now learning rate is : {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>lr<span class="token punctuation">[</span>self<span class="token punctuation">.</span>n<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    optim<span class="token punctuation">.</span>param_groups<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">"lr"</span><span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>lr<span class="token punctuation">[</span>self<span class="token punctuation">.</span>n<span class="token punctuation">]</span>
        mse_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>test_loss<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>data<span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>t <span class="token operator">=</span> end <span class="token operator">-</span> start
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Training completed!!! Time consuming: {}'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">str</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>t<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>


mse_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
ratio_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    pue <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span><span class="token string">'pue.csv'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'gbk'</span><span class="token punctuation">)</span>
    pue<span class="token punctuation">.</span>dropna<span class="token punctuation">(</span>axis<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> how<span class="token operator">=</span><span class="token string">'all'</span><span class="token punctuation">)</span>
    pue<span class="token punctuation">.</span>fillna<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    train <span class="token operator">=</span> pue<span class="token punctuation">.</span>drop<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'下一时刻PUE'</span><span class="token punctuation">,</span> <span class="token string">'时间戳'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> axis<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
    target <span class="token operator">=</span> pue<span class="token punctuation">[</span><span class="token string">'下一时刻PUE'</span><span class="token punctuation">]</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'feature_selection_ratio'</span><span class="token punctuation">)</span>
    feature_selection_ratio <span class="token operator">=</span> i <span class="token operator">/</span> <span class="token number">10</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>feature_selection_ratio<span class="token punctuation">)</span>
    ratio_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>feature_selection_ratio<span class="token punctuation">)</span>
    head_feature_num <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>feature_selection_ratio <span class="token operator">*</span> train<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    train<span class="token punctuation">,</span> target <span class="token operator">=</span> min_max_select<span class="token punctuation">(</span>train<span class="token punctuation">,</span> target<span class="token punctuation">,</span> head_feature_num<span class="token punctuation">)</span>

    <span class="token comment"># 切割数据样本集合测试集</span>
    X_train<span class="token punctuation">,</span> x_test<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> y_true <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>train<span class="token punctuation">,</span> target<span class="token punctuation">,</span> test_size<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>  <span class="token comment"># 20%测试集；80%训练集</span>
    X_train_Double <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> X_train<span class="token punctuation">:</span>
        tempList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> l <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            tempList<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">,</span> l<span class="token punctuation">]</span><span class="token punctuation">)</span>
        X_train_Double<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>tempList<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>tempList<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    X_train_Double <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X_train_Double<span class="token punctuation">)</span>

    X_test_Double <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> line <span class="token keyword">in</span> x_test<span class="token punctuation">:</span>
        tempList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> l <span class="token keyword">in</span> line<span class="token punctuation">:</span>
            tempList<span class="token punctuation">.</span>extend<span class="token punctuation">(</span><span class="token punctuation">[</span>l<span class="token punctuation">,</span> l<span class="token punctuation">]</span><span class="token punctuation">)</span>
        X_test_Double<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">[</span>np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>tempList<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>tempList<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    X_test_Double <span class="token operator">=</span> np<span class="token punctuation">.</span>array<span class="token punctuation">(</span>X_test_Double<span class="token punctuation">)</span>

    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"X_train_Double.shape:"</span><span class="token punctuation">,</span> X_train_Double<span class="token punctuation">.</span>shape<span class="token punctuation">,</span> <span class="token string">"X_test_Double.shape:"</span><span class="token punctuation">,</span> X_test_Double<span class="token punctuation">.</span>shape<span class="token punctuation">)</span>
    feature_size <span class="token operator">=</span> X_train_Double<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

    model <span class="token operator">=</span> TransAm<span class="token punctuation">(</span>feature_size<span class="token operator">=</span>feature_size<span class="token punctuation">,</span> num_layers<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> dropout<span class="token operator">=</span><span class="token number">0.2</span><span class="token punctuation">)</span>
    grt <span class="token operator">=</span> General_Regression_Training_3d<span class="token punctuation">(</span>model<span class="token punctuation">,</span> learning_rate<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">1e-3</span><span class="token punctuation">,</span> <span class="token number">1e-6</span><span class="token punctuation">,</span> <span class="token number">1e-8</span><span class="token punctuation">]</span><span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">512</span><span class="token punctuation">,</span> use_more_gpu<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span>
                                         weight_decay<span class="token operator">=</span><span class="token number">1e-3</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span> save_path<span class="token operator">=</span><span class="token string">'transformer_Result'</span><span class="token punctuation">,</span> epoch<span class="token operator">=</span><span class="token number">5000</span><span class="token punctuation">)</span>

    grt<span class="token punctuation">.</span>fit<span class="token punctuation">(</span>X_train_Double<span class="token punctuation">,</span> y_train<span class="token punctuation">,</span> X_test_Double<span class="token punctuation">,</span> y_true<span class="token punctuation">)</span>

plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>ratio_list<span class="token punctuation">,</span> mse_list<span class="token punctuation">,</span> <span class="token string">'r-.p'</span><span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">"mse"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">"feature_selection_ratio"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">"mse"</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>savefig<span class="token punctuation">(</span><span class="token string">'feature_selection_ratio_mse.png'</span><span class="token punctuation">)</span>
plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<p>所有完整代码和数据请移步：<br> <a href="https://download.csdn.net/download/qq_30803353/87462558">BP-LSTM-Attention-transformer，含数据，可直接运行，TensorFlow</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7a18cb4c4bd1d38318b2caf017dcc20c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深度学习AI编译器-LLVM简介</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/37a88724d3a8989965c431ae5195c52b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">攻防世界-Android2.0</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>