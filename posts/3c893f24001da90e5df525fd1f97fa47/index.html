<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（十八）Flink Table API &amp; SQL 编程指南 Table API 和Datastream API 集成 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="（十八）Flink Table API &amp; SQL 编程指南 Table API 和Datastream API 集成" />
<meta property="og:description" content="文章目录 DataStream 和 Table 之间的转换依赖项和导入配置执行行为datastream APItable API 批处理运行时模式Changelog统一 处理（仅插入）流 (Handling of (Insert-Only) Streams)fromDataStreamcreateTemporaryViewtoDataStream 处理变更日志流fromChangelogStreamtoChangelogStream 将 Table API 管道添加到 DataStream APITypeInformation 和 DataType 之间的映射TypeInformation 到 DataTypeDataType 到 TypeInformation 在定义数据处理管道时，Table API 和 DataStream API 同样重要。
DataStream API 在一个相对较低级别的命令式编程 API 中提供了流处理的原语（即时间、状态和数据流管理）。Table API 抽象了许多内部结构，并提供了结构化和声明性的 API。
两种 API 都可以处理有界和无界流。
处理历史数据时需要管理有界流。无限流发生在可能首先用历史数据初始化的实时处理场景中。
为了高效执行，两个 API 都以优化的批处理执行模式提供处理有界流。但是，由于批处理只是流的一种特殊情况，因此也可以在常规流执行模式下运行有界流的管道。
一个 API 中的管道可以端到端定义，而不依赖于另一个 API。但是，出于各种原因，混合使用这两种 API 可能会很有用：
在 DataStream API 中实现主管道之前，使用表生态系统轻松访问目录或连接到外部系统。在 DataStream API 中实现主管道之前，访问一些用于无状态数据规范化和清理的 SQL 函数。如果 Table API 中不存在更底层的操作（例如自定义计时器处理），请不要切换到 DataStream API。 Flink 提供了特殊的桥接功能，使与 DataStream API 的集成尽可能顺畅。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3c893f24001da90e5df525fd1f97fa47/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-06-11T14:46:39+08:00" />
<meta property="article:modified_time" content="2022-06-11T14:46:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（十八）Flink Table API &amp; SQL 编程指南 Table API 和Datastream API 集成</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#DataStream__Table__21" rel="nofollow">DataStream 和 Table 之间的转换</a></li><li><ul><li><a href="#_152" rel="nofollow">依赖项和导入</a></li><li><a href="#_176" rel="nofollow">配置</a></li><li><a href="#_209" rel="nofollow">执行行为</a></li><li><ul><li><a href="#datastream_API_214" rel="nofollow">datastream API</a></li><li><a href="#table_API_219" rel="nofollow">table API</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_266" rel="nofollow">批处理运行时模式</a></li><li><ul><li><a href="#Changelog_354" rel="nofollow">Changelog统一</a></li></ul> 
  </li><li><a href="#_Handling_of_InsertOnly_Streams_479" rel="nofollow">处理（仅插入）流 (Handling of (Insert-Only) Streams)</a></li><li><ul><li><a href="#fromDataStream_504" rel="nofollow">fromDataStream</a></li><li><a href="#createTemporaryView_732" rel="nofollow">createTemporaryView</a></li><li><a href="#toDataStream_806" rel="nofollow">toDataStream</a></li></ul> 
  </li><li><a href="#_878" rel="nofollow">处理变更日志流</a></li><li><ul><li><a href="#fromChangelogStream_902" rel="nofollow">fromChangelogStream</a></li><li><a href="#toChangelogStream_985" rel="nofollow">toChangelogStream</a></li></ul> 
  </li><li><a href="#_Table_API__DataStream_API_1115" rel="nofollow">将 Table API 管道添加到 DataStream API</a></li><li><a href="#TypeInformation__DataType__1181" rel="nofollow">TypeInformation 和 DataType 之间的映射</a></li><li><ul><li><a href="#TypeInformation__DataType_1194" rel="nofollow">TypeInformation 到 DataType</a></li><li><a href="#DataType__TypeInformation_1211" rel="nofollow">DataType 到 TypeInformation</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<p>在定义数据处理管道时，Table API 和 DataStream API 同样重要。</p> 
<p>DataStream API 在一个相对较低级别的命令式编程 API 中提供了流处理的原语（即时间、状态和数据流管理）。Table API 抽象了许多内部结构，并提供了结构化和声明性的 API。</p> 
<p>两种 API 都可以处理有界和无界流。</p> 
<p>处理历史数据时需要管理有界流。无限流发生在可能首先用历史数据初始化的实时处理场景中。</p> 
<p>为了高效执行，两个 API 都以优化的批处理执行模式提供处理有界流。但是，由于批处理只是流的一种特殊情况，因此也可以在常规流执行模式下运行有界流的管道。</p> 
<p>一个 API 中的管道可以端到端定义，而不依赖于另一个 API。但是，出于各种原因，混合使用这两种 API 可能会很有用：</p> 
<ul><li>在 DataStream API 中实现主管道之前，使用表生态系统轻松访问目录或连接到外部系统。</li><li>在 DataStream API 中实现主管道之前，访问一些用于无状态数据规范化和清理的 SQL 函数。</li><li>如果 Table API 中不存在更底层的操作（例如自定义计时器处理），请不要切换到 DataStream API。</li></ul> 
<p>Flink 提供了特殊的桥接功能，使与 DataStream API 的集成尽可能顺畅。</p> 
<blockquote> 
 <p>在 DataStream 和 Table API 之间切换会增加一些转换开销。例如，RowData部分处理二进制数据的表运行时的内部数据结构（即）需要转换为对用户更友好的数据结构（即Row）。通常，可以忽略此开销，但为了完整起见，此处提及。</p> 
</blockquote> 
<h2><a id="DataStream__Table__21"></a>DataStream 和 Table 之间的转换</h2> 
<p>Flink 提供了一个专门StreamTableEnvironment用于与 DataStream 集成的 API。TableEnvironment这些环境使用其他方法扩展常规，StreamExecutionEnvironment并将 DataStream API 中使用的作为参数。</p> 
<p>以下代码显示了如何在两个 API 之间来回切换的示例。的列名和类型Table自动派生自TypeInformation的DataStream。由于 DataStream API 本身不支持变更日志处理，因此代码在流到表和表到流的转换过程中假定仅附加/仅插入语义。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>

<span class="token comment">// create environments of both APIs</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create a DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token string">"John"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the insert-only DataStream as a Table</span>
<span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// register the Table object as a view and query it</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> inputTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span><span class="token string">"SELECT UPPER(f0) FROM InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the insert-only Table as a DataStream again</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a printing sink and execute in DataStream API</span>
resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +I[Alice]</span>
<span class="token comment">// +I[Bob]</span>
<span class="token comment">// +I[John]</span>
</code></pre> 
<p>fromDataStream和的完整语义toDataStream可以在下面的专门部分中找到。特别是，本节讨论了如何使用更复杂和嵌套的类型来影响模式派生。它还涵盖了使用事件时间和水印。</p> 
<p>根据查询的类型，在许多情况下，生成的动态表是一个管道，它不仅在将转换Table为 一个DataStream时产生仅插入更改，DataStream而且还会产生撤回和其他类型的更新。在表到流的转换过程中，这可能会导致类似于以下的异常</p> 
<pre><code class="prism language-java"><span class="token class-name">Table</span> sink '<span class="token class-name">Unregistered_DataStream_Sink_1</span><span class="token char">' doesn'</span>t support consuming update changes <span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">.</span>
</code></pre> 
<p>在这种情况下，需要再次修改查询或切换到toChangelogStream.</p> 
<p>以下示例显示了如何转换更新表。每个结果行都代表更改日志中的一个条目，该条目带有一个可以通过调用row.getKind()它来查询的更改标志。在示例中，第二个分数在(U )之前Alice创建更新，在( U) 更改之后创建更新.</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>

<span class="token comment">// create environments of both APIs</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create a DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
    <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the insert-only DataStream as a Table</span>
<span class="token class-name">Table</span> inputTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// register the Table object as a view and query it</span>
<span class="token comment">// the query contains an aggregation that produces updates</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> inputTable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Table</span> resultTable <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
    <span class="token string">"SELECT name, SUM(score) FROM InputTable GROUP BY name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the updating Table as a changelog DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> resultStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toChangelogStream</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a printing sink and execute in DataStream API</span>
resultStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +I[Alice, 12]</span>
<span class="token comment">// +I[Bob, 10]</span>
<span class="token comment">// -U[Alice, 12]</span>
<span class="token comment">// +U[Alice, 112]</span>
</code></pre> 
<p>fromChangelogStream和的完整语义toChangelogStream可以在下面的专门部分中找到。特别是，本节讨论了如何使用更复杂和嵌套的类型来影响模式派生。它涵盖了使用事件时间和水印。它讨论了如何为输入和输出流声明主键和更改日志模式。</p> 
<p>上面的示例显示了如何通过为每个传入记录连续发出逐行更新来增量计算最终结果。然而，在输入流是有限的（即有界的）的情况下，可以通过利用批处理原理更有效地计算结果。</p> 
<p>在批处理中，运算符可以在连续阶段执行，在发出结果之前消耗整个输入表。例如，连接运算符可以在执行实际连接之前对两个有界输入进行排序（即排序合并连接算法），或者在使用另一个输入之前从一个输入构建哈希表（即哈希连接算法的构建/探测阶段）。</p> 
<p>DataStream API 和 Table API 都提供了专门的批处理运行时模式。</p> 
<p>以下示例说明了统一管道只需切换一个标志即可处理批处理和流数据。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span>

<span class="token comment">// setup DataStream API</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set the batch runtime mode</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// uncomment this for streaming mode</span>
<span class="token comment">// env.setRuntimeMode(RuntimeExecutionMode.STREAMING);</span>

<span class="token comment">// setup Table API</span>
<span class="token comment">// the table environment adopts the runtime mode during initialization</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// define the same pipeline as above</span>

<span class="token comment">// prints in BATCH mode:</span>
<span class="token comment">// +I[Bob, 10]</span>
<span class="token comment">// +I[Alice, 112]</span>

<span class="token comment">// prints in STREAMING mode:</span>
<span class="token comment">// +I[Alice, 12]</span>
<span class="token comment">// +I[Bob, 10]</span>
<span class="token comment">// -U[Alice, 12]</span>
<span class="token comment">// +U[Alice, 112]</span>
</code></pre> 
<p>一旦将变更日志应用到外部系统（例如键值存储），可以看到两种模式都能够生成完全相同的输出表。通过在发出结果之前消耗所有输入数据，批处理模式的更改日志仅包含仅插入更改。另请参阅下面的专用批处理模式部分以获取更多信息。</p> 
<h3><a id="_152"></a>依赖项和导入</h3> 
<p>将 Table API 与 DataStream API 结合的项目需要添加以下桥接模块之一。flink-table-api-java它们包括对orflink-table-api-scala和相应语言特定的 DataStream API 模块的传递依赖。</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.flink<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>flink-table-api-java-bridge_2.12<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.15.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>provided<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>使用 DataStream API 和 Table API 的 Java 或 Scala 版本声明公共管道需要以下导入。</p> 
<pre><code class="prism language-java"><span class="token comment">// imports for Java DataStream API</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token comment">// imports for Table API with bridging to Java DataStream API</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_176"></a>配置</h3> 
<p>将TableEnvironment采用传递的所有配置选项StreamExecutionEnvironment。但是，不能保证对配置的进一步更改StreamExecutionEnvironment 会传播到StreamTableEnvironment其实例化之后。从 Table API 到 DataStream API 的选项传播发生在规划期间。</p> 
<p>我们建议在切换到 Table API 之前尽早在 DataStream API 中设置所有配置选项。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">ZoneId</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span>

<span class="token comment">// create Java DataStream API</span>

<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set various configuration early</span>

env<span class="token punctuation">.</span><span class="token function">setMaxParallelism</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addDefaultKryoSerializer</span><span class="token punctuation">(</span><span class="token class-name">MyCustomType</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">CustomKryoSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

env<span class="token punctuation">.</span><span class="token function">getCheckpointConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setCheckpointingMode</span><span class="token punctuation">(</span><span class="token class-name">CheckpointingMode</span><span class="token punctuation">.</span>EXACTLY_ONCE<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// then switch to Java Table API</span>

<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// set configuration early</span>

tableEnv<span class="token punctuation">.</span><span class="token function">getConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLocalTimeZone</span><span class="token punctuation">(</span><span class="token class-name">ZoneId</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">"Europe/Berlin"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// start defining your pipelines in both APIs...</span>
</code></pre> 
<h3><a id="_209"></a>执行行为</h3> 
<p>这两个 API 都提供了执行管道的方法。换句话说：如果需要，他们会编译一个作业图，该作业图将提交到集群并触发执行。结果将流式传输到声明的接收器。</p> 
<p>execute通常，两个 API 都使用方法名称中的术语来标记此类行为。但是，Table API 和 DataStream API 的执行行为略有不同。</p> 
<h4><a id="datastream_API_214"></a>datastream API</h4> 
<p>DataStream API StreamExecutionEnvironment使用构建器模式来构建复杂的管道。管道可能会分成多个分支，这些分支可能会或可能不会以接收器结束。环境缓冲所有这些定义的分支，直到提交作业。</p> 
<p>StreamExecutionEnvironment.execute()提交整个构建的管道并随后清除构建器。换句话说：不再声明源和接收器，并且可以将新管道添加到构建器中。因此，每个 DataStream 程序通常都以调用StreamExecutionEnvironment.execute(). 或者，DataStream.executeAndCollect()隐式定义一个接收器，用于将结果流式传输到本地客户端。</p> 
<h4><a id="table_API_219"></a>table API</h4> 
<p>StatementSet在 Table API 中，仅在每个分支必须声明最终接收器的情况下才支持分支管道。两者TableEnvironment都StreamTableEnvironment没有提供专用的通用execute()方法。相反，它们提供了提交单个源到接收器管道或语句集的方法：</p> 
<pre><code class="prism language-java">
<span class="token comment">// execute with explicit sink</span>
tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"OutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO OutputTable SELECT * FROM InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createStatementSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"OutputTable"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span><span class="token string">"OutputTable2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createStatementSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addInsertSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO OutputTable SELECT * FROM InputTable"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">addInsertSql</span><span class="token punctuation">(</span><span class="token string">"INSERT INTO OutputTable2 SELECT * FROM InputTable"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// execute with implicit local sink</span>

tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"SELECT * FROM InputTable"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>为了结合这两种执行行为，每次调用StreamTableEnvironment.toDataStream 或StreamTableEnvironment.toChangelogStream将具体化（即编译）Table API 子管道并将其插入到 DataStream API 管道构建器中。这意味着StreamExecutionEnvironment.execute() 或DataStream.executeAndCollect必须在之后调用。Table API 中的执行不会触发这些“外部部分”。</p> 
<pre><code class="prism language-java"><span class="token comment">// (1)</span>

<span class="token comment">// adds a branch with a printing sink to the StreamExecutionEnvironment</span>
tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// (2)</span>

<span class="token comment">// executes a Table API end-to-end pipeline as a Flink job and prints locally,</span>
<span class="token comment">// thus (1) has still not been executed</span>
table<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// executes the DataStream API pipeline with the sink defined in (1) as a</span>
<span class="token comment">// Flink job, (2) was already running before</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<h2><a id="_266"></a>批处理运行时模式</h2> 
<p>批处理运行时模式是有界Flink 程序的专用执行模式。</p> 
<p>一般来说，有界性是数据源的一个属性，它告诉我们来自该源的所有记录在执行之前是否已知，或者是否会无限期地显示新数据。反过来，如果一个工作的所有来源都是有界的，那么它是有界的，否则是无界的。</p> 
<p>另一方面，流式运行时模式可用于有界和无界作业。</p> 
<p>有关不同执行模式的更多信息，另请参阅相应的DataStream API 部分。</p> 
<p>Table API &amp; SQL 规划器为这两种模式中的任何一种都提供了一组专门的优化器规则和运行时运算符。</p> 
<p>目前，运行时模式不是从源自动派生的，因此，它必须显式设置或StreamExecutionEnvironment在实例化 采用StreamTableEnvironment：</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">EnvironmentSettings</span><span class="token punctuation">;</span>

<span class="token comment">// adopt mode from StreamExecutionEnvironment</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// or</span>

<span class="token comment">// set mode explicitly for StreamTableEnvironment</span>
<span class="token comment">// it will be propagated to StreamExecutionEnvironment during planning</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token class-name">EnvironmentSettings</span><span class="token punctuation">.</span><span class="token function">inBatchMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>在将运行时模式设置为BATCH 之前，必须满足以下先决条件：</p> 
<ul><li> <p>所有来源都必须声明自己是有界的。</p> </li><li> <p>目前，表源必须发出仅插入更改。</p> </li><li> <p>运算符需要足够量的堆外内存 来进行排序和其他中间结果。</p> </li><li> <p>所有表操作都必须在批处理模式下可用。目前，其中一些仅在流模式下可用。请查看相应的 Table API &amp; SQL 页面。</p> </li></ul> 
<p>批处理执行具有以下含义（除其他外）：</p> 
<ul><li> <p>渐进式水印既不会生成也不会在运算符中使用。但是，源在关闭之前会发出最大水印。</p> </li><li> <p>根据execution.batch-shuffle-mode. 与在流模式下执行相同的管道相比，这也意味着可能需要更少的资源。</p> </li><li> <p>检查点被禁用。插入了人工状态后端。</p> </li><li> <p>表操作不会产生增量更新，而只会产生一个完整的最终结果，该结果会转换为仅插入的变更日志流。</p> </li></ul> 
<blockquote> 
 <p>由于批处理可以被视为流处理的一种特殊情况，因此我们建议首先实现流式管道，因为它是有界和无界数据的最通用实现。</p> 
</blockquote> 
<p>理论上，流式管道可以执行所有运算符。但是，在实践中，某些操作可能没有多大意义，因为它们会导致状态不断增长，因此不受支持。全局排序是一个仅在批处理模式下可用的示例。简而言之：应该可以在批处理模式下运行工作流管道，但反之亦然。</p> 
<p>下面的示例展示了如何使用DataGen 表源来玩转批处理模式。许多来源提供隐含地使连接器有界的选项，例如，通过定义终止偏移量或时间戳。number-of-rows 在我们的示例中，我们使用该选项限制行数。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">TableDescriptor</span><span class="token punctuation">;</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
        <span class="token class-name">TableDescriptor</span><span class="token punctuation">.</span><span class="token function">forConnector</span><span class="token punctuation">(</span><span class="token string">"datagen"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"number-of-rows"</span><span class="token punctuation">,</span> <span class="token string">"10"</span><span class="token punctuation">)</span> <span class="token comment">// make the source bounded</span>
            <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span>
                <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TINYINT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// convert the Table to a DataStream and further transform the pipeline</span>
tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Byte</span><span class="token punctuation">&gt;</span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token string">"My custom operator: "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"payload"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">executeAndCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// My custom operator: 9660912d30a43c7b035e15bd...</span>
<span class="token comment">// My custom operator: 29f5f706d2144f4a4f9f52a0...</span>
<span class="token comment">// ...</span>

</code></pre> 
<h3><a id="Changelog_354"></a>Changelog统一</h3> 
<p>在大多数情况下，当从流模式切换到批处理模式时，管道定义本身可以在 Table API 和 DataStream API 中保持不变，反之亦然。但是，如前所述，由于避免了批处理模式下的增量操作，生成的变更日志流可能会有所不同。</p> 
<p>依赖于事件时间并利用水印作为完整性标记的基于时间的操作能够生成独立于运行时模式的仅插入更改日志流。</p> 
<p>下面的 Java 示例说明了一个 Flink 程序，该程序不仅在 API 级别上统一，而且在生成的更改日志流中也统一。该示例使用基于两个表中的时间属性 （ts） 的间隔连接来联接 SQL 中的两个表（UserTable 和 OrderTable）。它使用 DataStream API 实现一个自定义运算符，该运算符使用KeyedProcessFunction and value state对用户名进行重复数据删除。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueState</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>state<span class="token punctuation">.</span></span><span class="token class-name">ValueStateDescriptor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>common<span class="token punctuation">.</span>typeinfo<span class="token punctuation">.</span></span><span class="token class-name">Types</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">KeyedProcessFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span>

<span class="token comment">// setup DataStream API</span>
<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// use BATCH or STREAMING mode</span>
env<span class="token punctuation">.</span><span class="token function">setRuntimeMode</span><span class="token punctuation">(</span><span class="token class-name">RuntimeExecutionMode</span><span class="token punctuation">.</span>BATCH<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// setup Table API</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create a user stream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> userStream <span class="token operator">=</span> env
    <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:00:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:05:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:10:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>
        <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">ROW_NAMED</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token class-name">Types</span><span class="token punctuation">.</span>LOCAL_DATE_TIME<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>INT<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create an order stream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> orderStream <span class="token operator">=</span> env
    <span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:02:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">122</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:07:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">239</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"2021-08-21T13:11:00"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">999</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">returns</span><span class="token punctuation">(</span>
        <span class="token class-name">Types</span><span class="token punctuation">.</span><span class="token function">ROW_NAMED</span><span class="token punctuation">(</span>
            <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token string">"amount"</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token class-name">Types</span><span class="token punctuation">.</span>LOCAL_DATE_TIME<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>INT<span class="token punctuation">,</span> <span class="token class-name">Types</span><span class="token punctuation">.</span>INT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create corresponding tables</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span>
    <span class="token string">"UserTable"</span><span class="token punctuation">,</span>
    userStream<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"ts - INTERVAL '1' SECOND"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span>
    <span class="token string">"OrderTable"</span><span class="token punctuation">,</span>
    orderStream<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"uid"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"amount"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"ts"</span><span class="token punctuation">,</span> <span class="token string">"ts - INTERVAL '1' SECOND"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// perform interval join</span>
<span class="token class-name">Table</span> joinedTable <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">sqlQuery</span><span class="token punctuation">(</span>
        <span class="token string">"SELECT U.name, O.amount "</span> <span class="token operator">+</span>
        <span class="token string">"FROM UserTable U, OrderTable O "</span> <span class="token operator">+</span>
        <span class="token string">"WHERE U.uid = O.uid AND O.ts BETWEEN U.ts AND U.ts + INTERVAL '5' MINUTES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> joinedStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>joinedTable<span class="token punctuation">)</span><span class="token punctuation">;</span>

joinedStream<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// implement a custom operator using ProcessFunction and value state</span>
joinedStream
    <span class="token punctuation">.</span><span class="token function">keyBy</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> r<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">KeyedProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

          <span class="token class-name">ValueState</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> seen<span class="token punctuation">;</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token keyword">open</span><span class="token punctuation">(</span><span class="token class-name">Configuration</span> parameters<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              seen <span class="token operator">=</span> <span class="token function">getRuntimeContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span>
                  <span class="token keyword">new</span> <span class="token class-name">ValueStateDescriptor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">"seen"</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token annotation punctuation">@Override</span>
          <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Row</span> row<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span>
                  <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">String</span> name <span class="token operator">=</span> row<span class="token punctuation">.</span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>seen<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  seen<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  out<span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// execute unified pipeline</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints (in both BATCH and STREAMING mode):</span>
<span class="token comment">// +I[Bob, 239]</span>
<span class="token comment">// +I[Alice, 122]</span>
<span class="token comment">// +I[Bob, 999]</span>
<span class="token comment">//</span>
<span class="token comment">// Bob</span>
<span class="token comment">// Alice</span>

</code></pre> 
<h2><a id="_Handling_of_InsertOnly_Streams_479"></a>处理（仅插入）流 (Handling of (Insert-Only) Streams)</h2> 
<p>StreamTableEnvironment提供以下方法来转换 DataStream API：</p> 
<ul><li> <p>fromDataStream(DataStream)：将仅插入更改和任意类型的流解释为表。默认情况下不传播事件时间和水印。</p> </li><li> <p>fromDataStream(DataStream, Schema)：将仅插入更改和任意类型的流解释为表。可选模式允许丰富列数据类型并添加时间属性、水印策略、其他计算列或主键。</p> </li><li> <p>createTemporaryView(String, DataStream)：以名称注册流以在 SQL 中访问它。它是createTemporaryView(String, fromDataStream(DataStream)).</p> </li><li> <p>createTemporaryView(String, DataStream, Schema)：以名称注册流以在 SQL 中访问它。它是createTemporaryView(String, fromDataStream(DataStream, Schema)).</p> </li><li> <p>toDataStream(Table)：将表转换为仅插入更改的流。默认流记录类型是org.apache.flink.types.Row. 单个行时间属性列被写回到 DataStream API 的记录中。水印也被传播。</p> </li><li> <p>toDataStream(Table, AbstractDataType)：将表转换为仅插入更改的流。此方法接受一种数据类型来表达所需的流记录类型。规划器可能会插入隐式强制转换和重新排序列以将列映射到（可能是嵌套的）数据类型的字段。</p> </li><li> <p>toDataStream(Table, Class)：toDataStream(Table, DataTypes.of(Class)) 快速创建所需数据类型的快捷方式。</p> </li></ul> 
<p>从 Table API 的角度来看，与 DataStream API 之间的转换类似于读取或写入已使用 SQL中的CREATE TABLEDDL定义的虚拟表连接器。</p> 
<p>虚拟CREATE TABLE name (schema) WITH (options)语句中的模式部分可以从 DataStream 的类型信息中自动派生、丰富或完全使用 org.apache.flink.table.api.Schema.</p> 
<p>虚拟 DataStream 表连接器为每一行公开以下元数据：</p> 
<p><img src="https://images2.imgbox.com/16/bd/7MWktyDv_o.png" alt="在这里插入图片描述"><br> 虚拟 DataStream 表源实现SupportsSourceWatermark 并因此允许调用SOURCE_WATERMARK()内置函数作为水印策略以采用来自 DataStream API 的水印。</p> 
<h3><a id="fromDataStream_504"></a>fromDataStream</h3> 
<p>下面的代码展示了如何fromDataStream用于不同的场景。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span><span class="token punctuation">;</span>

<span class="token comment">// some example POJO</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>

  <span class="token keyword">public</span> <span class="token class-name">Instant</span> event_time<span class="token punctuation">;</span>

  <span class="token comment">// default constructor for DataStream API</span>
  <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

  <span class="token comment">// fully assigning constructor for Table API</span>
  <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">,</span> <span class="token class-name">Instant</span> event_time<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> score<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>event_time <span class="token operator">=</span> event_time<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// create a DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span>
    env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochMilli</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochMilli</span><span class="token punctuation">(</span><span class="token number">1001</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">ofEpochMilli</span><span class="token punctuation">(</span><span class="token number">1002</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 1 ===</span>

<span class="token comment">// derive all physical columns automatically</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `name` STRING,</span>
<span class="token comment">//  `score` INT,</span>
<span class="token comment">//  `event_time` TIMESTAMP_LTZ(9)</span>
<span class="token comment">// )</span>


<span class="token comment">// === EXAMPLE 2 ===</span>

<span class="token comment">// derive all physical columns automatically</span>
<span class="token comment">// but add computed columns (in this case for creating a proctime attribute column)</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>
    dataStream<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">columnByExpression</span><span class="token punctuation">(</span><span class="token string">"proc_time"</span><span class="token punctuation">,</span> <span class="token string">"PROCTIME()"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `name` STRING,</span>
<span class="token comment">//  `score` INT NOT NULL,</span>
<span class="token comment">//  `event_time` TIMESTAMP_LTZ(9),</span>
<span class="token comment">//  `proc_time` TIMESTAMP_LTZ(3) NOT NULL *PROCTIME* AS PROCTIME()</span>
<span class="token comment">//)</span>


<span class="token comment">// === EXAMPLE 3 ===</span>

<span class="token comment">// derive all physical columns automatically</span>
<span class="token comment">// but add computed columns (in this case for creating a rowtime attribute column)</span>
<span class="token comment">// and a custom watermark strategy</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>
        dataStream<span class="token punctuation">,</span>
        <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">columnByExpression</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">,</span> <span class="token string">"CAST(event_time AS TIMESTAMP_LTZ(3))"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">,</span> <span class="token string">"rowtime - INTERVAL '10' SECOND"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `name` STRING,</span>
<span class="token comment">//  `score` INT,</span>
<span class="token comment">//  `event_time` TIMESTAMP_LTZ(9),</span>
<span class="token comment">//  `rowtime` TIMESTAMP_LTZ(3) *ROWTIME* AS CAST(event_time AS TIMESTAMP_LTZ(3)),</span>
<span class="token comment">//  WATERMARK FOR `rowtime`: TIMESTAMP_LTZ(3) AS rowtime - INTERVAL '10' SECOND</span>
<span class="token comment">// )</span>


<span class="token comment">// === EXAMPLE 4 ===</span>

<span class="token comment">// derive all physical columns automatically</span>
<span class="token comment">// but access the stream record's timestamp for creating a rowtime attribute column</span>
<span class="token comment">// also rely on the watermarks generated in the DataStream API</span>

<span class="token comment">// we assume that a watermark strategy has been defined for `dataStream` before</span>
<span class="token comment">// (not part of this example)</span>
<span class="token class-name">Table</span> table <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>
        dataStream<span class="token punctuation">,</span>
        <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">columnByMetadata</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">,</span> <span class="token string">"TIMESTAMP_LTZ(3)"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">,</span> <span class="token string">"SOURCE_WATERMARK()"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `name` STRING,</span>
<span class="token comment">//  `score` INT,</span>
<span class="token comment">//  `event_time` TIMESTAMP_LTZ(9),</span>
<span class="token comment">//  `rowtime` TIMESTAMP_LTZ(3) *ROWTIME* METADATA,</span>
<span class="token comment">//  WATERMARK FOR `rowtime`: TIMESTAMP_LTZ(3) AS SOURCE_WATERMARK()</span>
<span class="token comment">// )</span>


<span class="token comment">// === EXAMPLE 5 ===</span>

<span class="token comment">// define physical columns manually</span>
<span class="token comment">// in this example,</span>
<span class="token comment">//   - we can reduce the default precision of timestamps from 9 to 3</span>
<span class="token comment">//   - we also project the columns and put `event_time` to the beginning</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>
        dataStream<span class="token punctuation">,</span>
        <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"event_time"</span><span class="token punctuation">,</span> <span class="token string">"TIMESTAMP_LTZ(3)"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"STRING"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> <span class="token string">"INT"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">watermark</span><span class="token punctuation">(</span><span class="token string">"event_time"</span><span class="token punctuation">,</span> <span class="token string">"SOURCE_WATERMARK()"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `event_time` TIMESTAMP_LTZ(3) *ROWTIME*,</span>
<span class="token comment">//  `name` VARCHAR(200),</span>
<span class="token comment">//  `score` INT</span>
<span class="token comment">// )</span>
<span class="token comment">// note: the watermark strategy is not shown due to the inserted column reordering projection</span>

</code></pre> 
<p>示例 1 说明了一个不需要基于时间的操作的简单用例。</p> 
<p>示例 4 是最常见的用例，当基于时间的操作（例如窗口或间隔连接）应成为管道的一部分时。示例 2 是这些基于时间的操作应该在处理时间内工作的最常见用例。</p> 
<p>示例 5 完全依赖于用户的声明。这对于用适当的数据类型替换来自 DataStream API（将RAW在 Table API 中）的泛型类型很有用。</p> 
<p>由于DataType比 更丰富TypeInformation，我们可以轻松启用不可变 POJO 和其他复杂的数据结构。以下 Java 示例显示了可能的情况。另请查看 DataStream API 的 Data Types &amp; Serialization页面以获取有关那里支持的类型的更多信息。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>

<span class="token comment">// the DataStream API does not support immutable POJOs yet,</span>
<span class="token comment">// the class will result in a generic type that is a RAW type in Table API by default</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">Integer</span> score<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>score <span class="token operator">=</span> score<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// create a DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// since fields of a RAW type cannot be accessed, every stream record is treated as an atomic type</span>
<span class="token comment">// leading to a table with a single column `f0`</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `f0` RAW('User', '...')</span>
<span class="token comment">// )</span>

<span class="token comment">// instead, declare a more useful data type for columns using the Table API's type system</span>
<span class="token comment">// in a custom schema and rename the columns in a following `as` projection</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv
    <span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>
        dataStream<span class="token punctuation">,</span>
        <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"f0"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `user` *User&lt;`name` STRING,`score` INT&gt;*</span>
<span class="token comment">// )</span>

<span class="token comment">// data types can be extracted reflectively as above or explicitly defined</span>

<span class="token class-name">Table</span> table3 <span class="token operator">=</span> tableEnv
    <span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>
        dataStream<span class="token punctuation">,</span>
        <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span>
                <span class="token string">"f0"</span><span class="token punctuation">,</span>
                <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRUCTURED</span><span class="token punctuation">(</span>
                    <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"user"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
table<span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `user` *User&lt;`name` STRING,`score` INT&gt;*</span>
<span class="token comment">// )</span>

</code></pre> 
<h3><a id="createTemporaryView_732"></a>createTemporaryView</h3> 
<p>DataStream可以直接注册为视图（可能通过模式丰富）。</p> 
<p>创建的视图DataStream只能注册为临时视图。由于它们的内联/匿名 性质，无法将它们注册到永久catalog中。<br> 下面的代码展示了如何createTemporaryView用于不同的场景。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>api<span class="token punctuation">.</span>java<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span></span><span class="token class-name">Tuple2</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>

<span class="token comment">// create some DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Tuple2</span><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
    <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">12L</span><span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">Tuple2</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token number">0L</span><span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 1 ===</span>

<span class="token comment">// register the DataStream as view "MyView" in the current session</span>
<span class="token comment">// all columns are derived automatically</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"MyView"</span><span class="token punctuation">,</span> dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"MyView"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `f0` BIGINT NOT NULL,</span>
<span class="token comment">//  `f1` STRING</span>
<span class="token comment">// )</span>


<span class="token comment">// === EXAMPLE 2 ===</span>

<span class="token comment">// register the DataStream as view "MyView" in the current session,</span>
<span class="token comment">// provide a schema to adjust the columns similar to `fromDataStream`</span>

<span class="token comment">// in this example, the derived NOT NULL information has been removed</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span>
    <span class="token string">"MyView"</span><span class="token punctuation">,</span>
    dataStream<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"f0"</span><span class="token punctuation">,</span> <span class="token string">"BIGINT"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"f1"</span><span class="token punctuation">,</span> <span class="token string">"STRING"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"MyView"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `f0` BIGINT,</span>
<span class="token comment">//  `f1` STRING</span>
<span class="token comment">// )</span>


<span class="token comment">// === EXAMPLE 3 ===</span>

<span class="token comment">// use the Table API before creating the view if it is only about renaming columns</span>

tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span>
    <span class="token string">"MyView"</span><span class="token punctuation">,</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> <span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"MyView"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">printSchema</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// (</span>
<span class="token comment">//  `id` BIGINT NOT NULL,</span>
<span class="token comment">//  `name` STRING</span>
<span class="token comment">// )</span>

</code></pre> 
<h3><a id="toDataStream_806"></a>toDataStream</h3> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span><span class="token punctuation">;</span>

<span class="token comment">// POJO with mutable fields</span>
<span class="token comment">// since no fully assigning constructor is defined, the field order</span>
<span class="token comment">// is alphabetical [event_time, name, score]</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Integer</span> score<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Instant</span> event_time<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
    <span class="token string">"CREATE TABLE GeneratedTable "</span>
    <span class="token operator">+</span> <span class="token string">"("</span>
    <span class="token operator">+</span> <span class="token string">"  name STRING,"</span>
    <span class="token operator">+</span> <span class="token string">"  score INT,"</span>
    <span class="token operator">+</span> <span class="token string">"  event_time TIMESTAMP_LTZ(3),"</span>
    <span class="token operator">+</span> <span class="token string">"  WATERMARK FOR event_time AS event_time - INTERVAL '10' SECOND"</span>
    <span class="token operator">+</span> <span class="token string">")"</span>
    <span class="token operator">+</span> <span class="token string">"WITH ('connector'='datagen')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"GeneratedTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 1 ===</span>

<span class="token comment">// use the default conversion to instances of Row</span>

<span class="token comment">// since `event_time` is a single rowtime attribute, it is inserted into the DataStream</span>
<span class="token comment">// metadata and watermarks are propagated</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 2 ===</span>

<span class="token comment">// a data type is extracted from class `User`,</span>
<span class="token comment">// the planner reorders fields and inserts implicit casts where possible to convert internal</span>
<span class="token comment">// data structures to the desired structured type</span>

<span class="token comment">// since `event_time` is a single rowtime attribute, it is inserted into the DataStream</span>
<span class="token comment">// metadata and watermarks are propagated</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>table<span class="token punctuation">,</span> <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// data types can be extracted reflectively as above or explicitly defined</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">toDataStream</span><span class="token punctuation">(</span>
        table<span class="token punctuation">,</span>
        <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRUCTURED</span><span class="token punctuation">(</span>
            <span class="token class-name">User</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
            <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">FIELD</span><span class="token punctuation">(</span><span class="token string">"event_time"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP_LTZ</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> 
<p>请注意，仅支持非更新表toDataStream。通常，基于时间的操作（例如窗口、间隔连接或MATCH_RECOGNIZE子句）非常适合仅插入管道，以及投影和过滤器等简单操作。</p> 
<p>具有产生更新操作的管道可以使用toChangelogStream.</p> 
<h2><a id="_878"></a>处理变更日志流</h2> 
<p>在内部，Flink 的表运行时是一个变更日志处理器。概念页面描述了 动态表和流如何 相互关联。</p> 
<p>StreamTableEnvironment提供以下方法来公开这些变更数据捕获(CDC) 功能：</p> 
<ul><li> <p>fromChangelogStream(DataStream)：将变更日志条目流解释为表格。流记录类型必须是org.apache.flink.types.Row，因为它的RowKind标志是在运行时评估的。默认情况下不传播事件时间和水印。此方法需要一个包含各种更改（在 中枚举org.apache.flink.types.RowKind）作为默认值的更改日志ChangelogMode。</p> </li><li> <p>fromChangelogStream(DataStream, Schema): 允许为DataStream类似于fromDataStream(DataStream, Schema). 否则语义等于fromChangelogStream(DataStream)。</p> </li><li> <p>fromChangelogStream(DataStream, Schema, ChangelogMode)：完全控制如何将流解释为变更日志。传递ChangelogMode帮助计划者区分insert-only、 upsert或retract行为。</p> </li><li> <p>toChangelogStream(Table): 的反向操作fromChangelogStream(DataStream)。它在运行时生成带有实例的流org.apache.flink.types.Row并为每条记录设置RowKind标志。该方法支持各种更新表。如果输入表包含单个行时间列，它将被传播到流记录的时间戳中。水印也将被传播。</p> </li><li> <p>toChangelogStream(Table, Schema): 的反向操作fromChangelogStream(DataStream, Schema)。该方法可以丰富产生的列数据类型。如有必要，计划者可能会插入隐式强制转换。可以将行时间写为元数据列。</p> </li><li> <p>toChangelogStream(Table, Schema, ChangelogMode)：完全控制如何将表转换为变更日志流。传递ChangelogMode帮助计划者区分insert-only、 upsert或retract行为。</p> </li></ul> 
<p>从 Table API 的角度来看，与 DataStream API 之间的转换类似于读取或写入已使用 SQL中的CREATE TABLEDDL定义的虚拟表连接器。</p> 
<p>因为fromChangelogStream行为类似于fromDataStream，我们建议在继续之前阅读上一节。</p> 
<p>此虚拟连接器还支持读取和写入rowtime流记录的元数据。</p> 
<p>虚拟表源实现SupportsSourceWatermark.</p> 
<h3><a id="fromChangelogStream_902"></a>fromChangelogStream</h3> 
<p>下面的代码展示了如何fromChangelogStream用于不同的场景。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>connector<span class="token punctuation">.</span></span><span class="token class-name">ChangelogMode</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">RowKind</span><span class="token punctuation">;</span>

<span class="token comment">// === EXAMPLE 1 ===</span>

<span class="token comment">// interpret the stream as a retract stream</span>

<span class="token comment">// create a changelog DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span>
    env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>UPDATE_BEFORE<span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>UPDATE_AFTER<span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the DataStream as a Table</span>
<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromChangelogStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// register the table under a name and perform an aggregation</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
tableEnv
    <span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"SELECT f0 AS name, SUM(f1) AS score FROM InputTable GROUP BY f0"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +----+--------------------------------+-------------+</span>
<span class="token comment">// | op |                           name |       score |</span>
<span class="token comment">// +----+--------------------------------+-------------+</span>
<span class="token comment">// | +I |                            Bob |           5 |</span>
<span class="token comment">// | +I |                          Alice |          12 |</span>
<span class="token comment">// | -D |                          Alice |          12 |</span>
<span class="token comment">// | +I |                          Alice |         100 |</span>
<span class="token comment">// +----+--------------------------------+-------------+</span>


<span class="token comment">// === EXAMPLE 2 ===</span>

<span class="token comment">// interpret the stream as an upsert stream (without a need for UPDATE_BEFORE)</span>

<span class="token comment">// create a changelog DataStream</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span>
    env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>INSERT<span class="token punctuation">,</span> <span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Row</span><span class="token punctuation">.</span><span class="token function">ofKind</span><span class="token punctuation">(</span><span class="token class-name">RowKind</span><span class="token punctuation">.</span>UPDATE_AFTER<span class="token punctuation">,</span> <span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// interpret the DataStream as a Table</span>
<span class="token class-name">Table</span> table <span class="token operator">=</span>
    tableEnv<span class="token punctuation">.</span><span class="token function">fromChangelogStream</span><span class="token punctuation">(</span>
        dataStream<span class="token punctuation">,</span>
        <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">primaryKey</span><span class="token punctuation">(</span><span class="token string">"f0"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ChangelogMode</span><span class="token punctuation">.</span><span class="token function">upsert</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// register the table under a name and perform an aggregation</span>
tableEnv<span class="token punctuation">.</span><span class="token function">createTemporaryView</span><span class="token punctuation">(</span><span class="token string">"InputTable"</span><span class="token punctuation">,</span> table<span class="token punctuation">)</span><span class="token punctuation">;</span>
tableEnv
    <span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span><span class="token string">"SELECT f0 AS name, SUM(f1) AS score FROM InputTable GROUP BY f0"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +----+--------------------------------+-------------+</span>
<span class="token comment">// | op |                           name |       score |</span>
<span class="token comment">// +----+--------------------------------+-------------+</span>
<span class="token comment">// | +I |                            Bob |           5 |</span>
<span class="token comment">// | +I |                          Alice |          12 |</span>
<span class="token comment">// | -U |                          Alice |          12 |</span>
<span class="token comment">// | +U |                          Alice |         100 |</span>
<span class="token comment">// +----+--------------------------------+-------------+</span>

</code></pre> 
<p>示例 1 中显示的默认值ChangelogMode对于大多数用例来说应该足够了，因为它接受各种更改。</p> 
<p>但是，示例 2 显示了如何通过使用 upsert 模式将更新消息的数量减少 50% 来限制传入更改的种类以提高效率。可以通过为toChangelogStream.</p> 
<h3><a id="toChangelogStream_985"></a>toChangelogStream</h3> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span></span><span class="token class-name">ProcessFunction</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">DataTypes</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Schema</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Table</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>data<span class="token punctuation">.</span></span><span class="token class-name">StringData</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span></span><span class="token class-name">Row</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Collector</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">Expressions</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token comment">// create Table with event-time</span>
tableEnv<span class="token punctuation">.</span><span class="token function">executeSql</span><span class="token punctuation">(</span>
    <span class="token string">"CREATE TABLE GeneratedTable "</span>
    <span class="token operator">+</span> <span class="token string">"("</span>
    <span class="token operator">+</span> <span class="token string">"  name STRING,"</span>
    <span class="token operator">+</span> <span class="token string">"  score INT,"</span>
    <span class="token operator">+</span> <span class="token string">"  event_time TIMESTAMP_LTZ(3),"</span>
    <span class="token operator">+</span> <span class="token string">"  WATERMARK FOR event_time AS event_time - INTERVAL '10' SECOND"</span>
    <span class="token operator">+</span> <span class="token string">")"</span>
    <span class="token operator">+</span> <span class="token string">"WITH ('connector'='datagen')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">Table</span> table <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">"GeneratedTable"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 1 ===</span>

<span class="token comment">// convert to DataStream in the simplest and most general way possible (no event-time)</span>

<span class="token class-name">Table</span> simpleTable <span class="token operator">=</span> tableEnv
    <span class="token punctuation">.</span><span class="token function">fromValues</span><span class="token punctuation">(</span><span class="token function">row</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">row</span><span class="token punctuation">(</span><span class="token string">"Alice"</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">row</span><span class="token punctuation">(</span><span class="token string">"Bob"</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">as</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"score"</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">groupBy</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>$<span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> $<span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

tableEnv
    <span class="token punctuation">.</span><span class="token function">toChangelogStream</span><span class="token punctuation">(</span>simpleTable<span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">executeAndCollect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">forEachRemaining</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token operator">::</span><span class="token function">println</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints:</span>
<span class="token comment">// +I[Bob, 12]</span>
<span class="token comment">// +I[Alice, 12]</span>
<span class="token comment">// -U[Alice, 12]</span>
<span class="token comment">// +U[Alice, 14]</span>


<span class="token comment">// === EXAMPLE 2 ===</span>

<span class="token comment">// convert to DataStream in the simplest and most general way possible (with event-time)</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toChangelogStream</span><span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// since `event_time` is a single time attribute in the schema, it is set as the</span>
<span class="token comment">// stream record's timestamp by default; however, at the same time, it remains part of the Row</span>

dataStream<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Row</span> row<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

             <span class="token comment">// prints: [name, score, event_time]</span>
             <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span><span class="token function">getFieldNames</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

             <span class="token comment">// timestamp exists twice</span>
             <span class="token keyword">assert</span> ctx<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> row<span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Instant</span><span class="token punctuation">&gt;</span></span><span class="token function">getFieldAs</span><span class="token punctuation">(</span><span class="token string">"event_time"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toEpochMilli</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 3 ===</span>

<span class="token comment">// convert to DataStream but write out the time attribute as a metadata column which means</span>
<span class="token comment">// it is not part of the physical schema anymore</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toChangelogStream</span><span class="token punctuation">(</span>
    table<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"name"</span><span class="token punctuation">,</span> <span class="token string">"STRING"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"score"</span><span class="token punctuation">,</span> <span class="token string">"INT"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">columnByMetadata</span><span class="token punctuation">(</span><span class="token string">"rowtime"</span><span class="token punctuation">,</span> <span class="token string">"TIMESTAMP_LTZ(3)"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// the stream record's timestamp is defined by the metadata; it is not part of the Row</span>

dataStream<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ProcessFunction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">,</span> <span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processElement</span><span class="token punctuation">(</span><span class="token class-name">Row</span> row<span class="token punctuation">,</span> <span class="token class-name">Context</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Collector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> out<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

            <span class="token comment">// prints: [name, score]</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>row<span class="token punctuation">.</span><span class="token function">getFieldNames</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// timestamp exists once</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span><span class="token function">timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">// === EXAMPLE 4 ===</span>

<span class="token comment">// for advanced users, it is also possible to use more internal data structures for efficiency</span>

<span class="token comment">// note that this is only mentioned here for completeness because using internal data structures</span>
<span class="token comment">// adds complexity and additional type handling</span>

<span class="token comment">// however, converting a TIMESTAMP_LTZ column to `Long` or STRING to `byte[]` might be convenient,</span>
<span class="token comment">// also structured types can be represented as `Row` if needed</span>

<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Row</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">toChangelogStream</span><span class="token punctuation">(</span>
    table<span class="token punctuation">,</span>
    <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span>
            <span class="token string">"name"</span><span class="token punctuation">,</span>
            <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">STRING</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bridgedTo</span><span class="token punctuation">(</span><span class="token class-name">StringData</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span>
            <span class="token string">"score"</span><span class="token punctuation">,</span>
            <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span>
            <span class="token string">"event_time"</span><span class="token punctuation">,</span>
            <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">TIMESTAMP_LTZ</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bridgedTo</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// leads to a stream of Row(name: StringData, score: Integer, event_time: Long)</span>

</code></pre> 
<h2><a id="_Table_API__DataStream_API_1115"></a>将 Table API 管道添加到 DataStream API</h2> 
<p>一个 Flink 作业可以由多个彼此相邻运行的断开连接的管道组成。</p> 
<p>在 Table API 中定义的 Source-to-sink 管道可以作为一个整体附加到，并且在调用DataStream APIStreamExecutionEnvironment 中的方法之一时将被提交。execute</p> 
<p>但是，源不一定必须是表源，也可以是之前转换为 Table API 的另一个 DataStream 管道。因此，可以为 DataStream API 程序使用表接收器。</p> 
<p>该功能可通过使用StreamStatementSet创建的专用实例获得 StreamTableEnvironment.createStatementSet()。通过使用语句集，计划者可以一起优化所有添加的语句，并提出一个或多个端到端管道，这些管道 StreamExecutionEnvironment在调用时添加StreamStatementSet.attachAsDataStream()。</p> 
<p>以下示例显示了如何在一个作业中将表程序添加到 DataStream API 程序。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>datastream<span class="token punctuation">.</span></span><span class="token class-name">DataStream</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>environment<span class="token punctuation">.</span></span><span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>sink<span class="token punctuation">.</span></span><span class="token class-name">DiscardingSink</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>

<span class="token class-name">StreamExecutionEnvironment</span> env <span class="token operator">=</span> <span class="token class-name">StreamExecutionEnvironment</span><span class="token punctuation">.</span><span class="token function">getExecutionEnvironment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">StreamTableEnvironment</span> tableEnv <span class="token operator">=</span> <span class="token class-name">StreamTableEnvironment</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">StreamStatementSet</span> statementSet <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">createStatementSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create some source</span>
<span class="token class-name">TableDescriptor</span> sourceDescriptor <span class="token operator">=</span>
    <span class="token class-name">TableDescriptor</span><span class="token punctuation">.</span><span class="token function">forConnector</span><span class="token punctuation">(</span><span class="token string">"datagen"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">option</span><span class="token punctuation">(</span><span class="token string">"number-of-rows"</span><span class="token punctuation">,</span> <span class="token string">"3"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">schema</span><span class="token punctuation">(</span>
            <span class="token class-name">Schema</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"myCol"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">INT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">column</span><span class="token punctuation">(</span><span class="token string">"myOtherCol"</span><span class="token punctuation">,</span> <span class="token class-name">DataTypes</span><span class="token punctuation">.</span><span class="token function">BOOLEAN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// create some sink</span>
<span class="token class-name">TableDescriptor</span> sinkDescriptor <span class="token operator">=</span> <span class="token class-name">TableDescriptor</span><span class="token punctuation">.</span><span class="token function">forConnector</span><span class="token punctuation">(</span><span class="token string">"print"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// add a pure Table API pipeline</span>
<span class="token class-name">Table</span> tableFromSource <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>sourceDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
statementSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableFromSource<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span>sinkDescriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// use table sinks for the DataStream API pipeline</span>
<span class="token class-name">DataStream</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> dataStream <span class="token operator">=</span> env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Table</span> tableFromStream <span class="token operator">=</span> tableEnv<span class="token punctuation">.</span><span class="token function">fromDataStream</span><span class="token punctuation">(</span>dataStream<span class="token punctuation">)</span><span class="token punctuation">;</span>
statementSet<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>tableFromStream<span class="token punctuation">.</span><span class="token function">insertInto</span><span class="token punctuation">(</span>sinkDescriptor<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// attach both pipelines to StreamExecutionEnvironment</span>
<span class="token comment">// (the statement set will be cleared after calling this method)</span>
statementSet<span class="token punctuation">.</span><span class="token function">attachAsDataStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// define other DataStream API parts</span>
env<span class="token punctuation">.</span><span class="token function">fromElements</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addSink</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DiscardingSink</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// use DataStream API to submit the pipelines</span>
env<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// prints similar to:</span>
<span class="token comment">// +I[1618440447, false]</span>
<span class="token comment">// +I[1259693645, true]</span>
<span class="token comment">// +I[158588930, false]</span>
<span class="token comment">// +I[1]</span>
<span class="token comment">// +I[2]</span>
<span class="token comment">// +I[3]</span>

</code></pre> 
<h2><a id="TypeInformation__DataType__1181"></a>TypeInformation 和 DataType 之间的映射</h2> 
<p>DataStream API 使用实例org.apache.flink.api.common.typeinfo.TypeInformation来描述在流中传输的记录类型。特别是，它定义了如何将记录从一个 DataStream 运算符序列化和反序列化到另一个。它还有助于将状态序列化为保存点和检查点。</p> 
<p>Table API 使用自定义数据结构在内部表示记录，org.apache.flink.table.types.DataType 并向用户公开以声明将数据结构转换为的外部格式，以便在源、接收器、UDF 或 DataStream API 中更轻松地使用。</p> 
<p>DataType比它更丰富，TypeInformation因为它还包括有关逻辑 SQL 类型的详细信息。因此，在转换过程中会隐式添加一些细节。</p> 
<p>一个列名和类型Table自动从TypeInformation. DataStream用于DataStream.getType()检查是否已通过 DataStream API 的反射类型提取工具正确检测到类型信息。如果最外面的记录 TypeInformation是 一个 CompositeType，则在派生表的模式时它将在第一级展平。</p> 
<p>DataStream API 并不总是能够TypeInformation根据反射提取更具体的内容。这通常会悄无声息地发生GenericTypeInfo，并得到通用 Kryo 序列化程序的支持。</p> 
<p>例如，Row无法对类进行反射分析，并且始终需要明确的类型信息声明。如果 DataStream API 中没有声明正确的类型信息，则该行将显示为RAW 数据类型，并且 Table API 无法访问其字段。.map(…).returns(TypeInformation) 在 Java 或.map(…)(TypeInformation)Scala 中使用以显式声明类型信息。</p> 
<h3><a id="TypeInformation__DataType_1194"></a>TypeInformation 到 DataType</h3> 
<p>TypeInformation转换为 DataType时适用以下规则：</p> 
<ul><li> <p>所有子类TypeInformation都映射到逻辑类型，包括与 Flink 内置序列化器对齐的可空性。</p> </li><li> <p>子类TupleTypeInfoBase被转换为行（for Row）或结构化类型（用于元组、POJO 和案例类）。</p> </li><li> <p>BigDecimal默认转换为DECIMAL(38, 18)。</p> </li><li> <p>字段的顺序PojoTypeInfo由以所有字段作为参数的构造函数确定。如果在转换过程中未找到，则字段顺序将按字母顺序排列。</p> </li><li> <p>GenericTypeInfo其他TypeInformation不能表示为所列之一的 org.apache.flink.table.api.DataTypes将被视为黑盒RAW类型。当前会话配置用于实现原始类型的序列化程序。届时将无法访问复合嵌套字段。</p> </li><li> <p>有关完整的翻译逻辑，请参阅 <a href="https://github.com/apache/flink/blob/release-1.15/flink-table/flink-table-common/src/main/java/org/apache/flink/table/types/utils/TypeInfoDataTypeConverter.java">TypeInfoDataTypeConverter</a> 。</p> </li></ul> 
<p>用于DataTypes.of(TypeInformation)在自定义模式声明或 UDF 中调用上述逻辑。</p> 
<h3><a id="DataType__TypeInformation_1211"></a>DataType 到 TypeInformation</h3> 
<p>表运行时将确保正确地将输出记录序列化到 DataStream API 的第一个运算符。</p> 
<p>之后，需要考虑 DataStream API 的类型信息语义。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0c86b5d0ab68dcce53b23cd9f7c224cd/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【opencvsharp】斑点检测 条码解码 图像操作 图像旋转/翻转/缩放 透视变换 图像显示控件 demo笔记</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/58e0820a8c0178764c459ed936339367/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Python实现将一张图片裁剪多张</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>