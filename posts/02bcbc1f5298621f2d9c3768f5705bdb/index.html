<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Unity WebGL&#43;jslib实现与js通信（例.图片下载） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Unity WebGL&#43;jslib实现与js通信（例.图片下载）" />
<meta property="og:description" content="一、项目配置 按照上一篇文章配置即可
二、调用测试 1.新建jslib,我这里用txt新建。
mergeInto(LibraryManager.library, { Hello: function () { window.alert(&#34;Hello, world!&#34;); }, HelloString: function (str) { window.alert(Pointer_stringify(str)); }, HelloFloat: function () { return 1; }, }); 2.如果遇到打包时报错，检测编码格式
3. 将jslib放入Unity-Plugins文件夹下
4.C#端代码，引入Dll
[DllImport(&#34;__Internal&#34;)] private static extern void Hello(); [DllImport(&#34;__Internal&#34;)] private static extern void HelloString(string str); [DllImport(&#34;__Internal&#34;)] private static extern float HelloFloat(); 5.C#端代码，调用
Hello(); HelloString(&#34;This is a string.&#34;); HelloFloat(); 6.打包测试，注意Editor模式运行会报错EntryPointNotFoundException。需要打包运行测试。
三、下载图片 1.对应jslib如下：
var ImageDownloaderPlugin = { ImageDownloader: function (str, fn) { console." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/02bcbc1f5298621f2d9c3768f5705bdb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-04T14:56:43+08:00" />
<meta property="article:modified_time" content="2023-08-04T14:56:43+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Unity WebGL&#43;jslib实现与js通信（例.图片下载）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 style="background-color:transparent;">一、项目配置</h2> 
<p>按照上一篇文章配置即可</p> 
<h2>二、调用测试</h2> 
<p>1.新建jslib,我这里用txt新建。</p> 
<pre><code>mergeInto(LibraryManager.library, 
{
 
  Hello: function ()
  {
    window.alert("Hello, world!");
  },
 
  HelloString: function (str) 
  {
    window.alert(Pointer_stringify(str));
  },
 
   HelloFloat: function () 
   {
       return 1;
   },
 
 });</code></pre> 
<p>2.如果遇到打包时报错，检测编码格式</p> 
<p><img alt="" height="124" src="https://images2.imgbox.com/ef/b0/0h5Or59M_o.png" width="824"></p> 
<p>3. 将jslib放入Unity-Plugins文件夹下</p> 
<p>4.C#端代码，引入Dll</p> 
<pre><code>    [DllImport("__Internal")]
    private static extern void Hello();
 
    [DllImport("__Internal")]
    private static extern void HelloString(string str);
 
    [DllImport("__Internal")]
    private static extern float HelloFloat();</code></pre> 
<p>5.C#端代码，调用</p> 
<pre><code>Hello();
HelloString("This is a string.");
HelloFloat();</code></pre> 
<p>6.打包测试，注意Editor模式运行会报错EntryPointNotFoundException。需要打包运行测试。</p> 
<h2>三、下载图片</h2> 
<p>1.对应jslib如下：</p> 
<pre><code class="hljs">var ImageDownloaderPlugin = {
    ImageDownloader: function (str, fn) {
        console.log("start jslib download");
        var msg = Pointer_stringify(str);
        var fname = Pointer_stringify(fn);
        var contentType = 'image/jpeg';

        function fixBinary(bin) {
            var length = bin.length;
            var buf = new ArrayBuffer(length);
            var arr = new Uint8Array(buf);
            for (var i = 0; i &lt; length; i++) {
                arr[i] = bin.charCodeAt(i);
            }
            return buf;
        }

        var binary = fixBinary(atob(msg));
        var data = new Blob([binary], { type: contentType });

        var link = document.createElement('a');
        link.download = fname;
        link.innerHTML = 'DownloadFile';
        link.setAttribute('id', 'ImageDownloaderLink');
        link.href = window.URL.createObjectURL(data);
        link.onclick = function () {
            var child = document.getElementById('ImageDownloaderLink');
            child.parentNode.removeChild(child);
        };
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        window.URL.revokeObjectURL(link.href);
    }
};
mergeInto(LibraryManager.library, ImageDownloaderPlugin)
</code></pre> 
<p><strong>注意</strong>编码格式，如果是utf-8的话，建议去掉“//中文注释”，否则unity会打包报错。</p> 
<p>2.C#中引入DLL</p> 
<pre><code class="hljs">    [DllImport("__Internal")]
    private static extern void ImageDownloader(string str, string fn);</code></pre> 
<p>3.完整代码如下：</p> 
<pre><code class="hljs">using System;
using System.Collections;
using System.Collections.Generic;
using System.IO;
using System.Runtime.InteropServices;
using UnityEngine;
using UnityEngine.UI;

public class GameManager : MonoBehaviour
{
    public Button saveBtn;

    public Image img;

    public Text text;


    [DllImport("__Internal")]
    private static extern void ImageDownloader(string str, string fn);
    
    public void DownloadImage(byte[] imageData, string imageFileName = "newpic")
    {
        if (imageData != null)
        {
            Debug.Log("Downloading..." + imageFileName);
            ImageDownloader(System.Convert.ToBase64String(imageData), imageFileName);
        }
    }

    // Start is called before the first frame update
    void Start()
    {

        text.text = "";

        saveBtn.onClick.AddListener(SavePicture);
    }


    void SavePicture()
    {
        //获取系统时间  
        System.DateTime now = new System.DateTime();
        now = System.DateTime.Now;
        string filename = string.Format("image{0}{1}{2}{3}.png", now.Day, now.Hour, now.Minute, now.Second);

        SaveTexture2DToPngFile(img.sprite.texture, filename);
        text.text = "图片已保存！";
    }


    public void SaveTexture2DToPngFile(Texture2D tex, string filePath)
    {
        byte[] data = DeCompress(tex).EncodeToPNG();
        DownloadImage(data, filePath);
    }

    public Texture2D DeCompress(Texture2D source)
    {
        RenderTexture renderTex = RenderTexture.GetTemporary(
            source.width,
            source.height,
            0,
            RenderTextureFormat.Default,
            RenderTextureReadWrite.Linear);

        Graphics.Blit(source, renderTex);
        RenderTexture previous = RenderTexture.active;
        RenderTexture.active = renderTex;
        Texture2D readableText = new Texture2D(source.width, source.height);
        readableText.ReadPixels(new Rect(0, 0, renderTex.width, renderTex.height), 0, 0);
        readableText.Apply();
        RenderTexture.active = previous;
        RenderTexture.ReleaseTemporary(renderTex);
        return readableText;
    }
}
</code></pre> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2a9824bdcd9010eee2c796e1b058c10f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">webpack5&#43;crypto</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5c13d7b0663aca8715428819521c2ce9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">论文阅读：ImageNet</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>