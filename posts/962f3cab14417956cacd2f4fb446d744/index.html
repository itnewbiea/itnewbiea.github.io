<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于STM32的电子琴音乐播放器设计 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于STM32的电子琴音乐播放器设计" />
<meta property="og:description" content="基于STM32的电子琴/音乐播放器设计 文章目录 基于STM32的电子琴/音乐播放器设计@[toc]引言第一章 总体设计1.1 系统功能1.2 主要技术性能指标 第二章 系统设计2.1 系统设计2.2 硬件设计2.2.1 整体仿真图2.2.2 按键模块2.2.3 扬声器模块2.2.4 显示模块2.2.5 主控模块 2.3 软件设计2.3.1 主要工作原理2.3.2 PWM发生器2.3.3 music播放器模块2.3.4 exti外部中断2.3.5 按键相关驱动2.3.6 LCD1602驱动2.3.7 主函数相关设计 第三章 系统调试3.1 仿真调试3.2 仿真结果3.3 实际电路调试3.4 功能测试3.5 过程中遇到的问题 第四章 总结3.2 仿真结果3.3 实际电路调试3.4 功能测试3.5 过程中遇到的问题 第四章 总结 引言 ​ 单片微型计算机室大规模集成电路技术发展的产物，属于第四代电子计算机它具有高性能、高速度、体积小、价格低廉、稳定可靠、应用广泛的特点。他的应用必定导致传统的控制技术从根本上发生变革。因此，单片机的开发应用已成为高科技和工程领域的一项重大课题。
​ 电子琴是现代电子科技与音乐结合的产物，是一种新型的键盘乐器。它在现代音乐扮演重要的角色，单片机具有强大的控制功能和灵活的编程实现特性，它已经溶入现代人们的生活中，成为不可替代的一部分。本文的主要内容是用STM32f103rbt6单片机为核心控制元件，设计一个电子琴。
​ 设计核心在于使用STM32单片机内置的
第一章 总体设计 1.1 系统功能 按照设计要求，本系统具有以下功能：
共有三个基本模式：电子琴模式、录音模式、播放器模式电子琴模式下，7个基本按键控制产生7种音调，功能键实现调节音阶和音量录音模式可分为录音和放音两个模块，录音状态下会记录弹奏的音调以及时间；放音模式调用音乐播放器某些模块，实现相同的功能。音乐播放器模块下，可以实现音乐的播放、暂停、切歌、调速、顺序播放、单曲循环、随机播放、以及进度条显示。有两个全局按键中断，可控制模式切换和全局静音/暂停。 1.2 主要技术性能指标 基本按键：7个；功能按键：6个；全局中断按键：2个；扬声器：1个；扬声器功率：1w；LCD1602：1块；主要模式：3个；曲库：8首；音域范围：262Hz~2217Hz；音量阶数：3阶；速度阶数：4阶；循环模式：3种； 第二章 系统设计 2.1 系统设计 ​ 总体系统设计上在硬件上共分为3个区域：基本按键区、功能按键区、LCD显示区。在软件的设计上共分为3个主要模式：电子琴模式、录音模式、播放器模式。主控模块选择使用STM32f103rbt6芯片，进行编程、控制、实现电子琴以及播放器功能。
2.2 硬件设计 2.2.1 整体仿真图 2.2.2 按键模块 ​ 按键模块分为两部分：基本按键和功能按键" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/962f3cab14417956cacd2f4fb446d744/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-09-30T10:06:12+08:00" />
<meta property="article:modified_time" content="2021-09-30T10:06:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于STM32的电子琴音乐播放器设计</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="STM32_0"></a>基于STM32的电子琴/音乐播放器设计</h2> 
<h3><a id="toc_3"></a> 
 <div class="toc"> 
  <h3>文章目录</h3> 
  <ul><li><a href="#STM32_0" rel="nofollow">基于STM32的电子琴/音乐播放器设计</a></li><li><ul><li><a href="#toc_3" rel="nofollow">@[toc]</a></li><li><a href="#_8" rel="nofollow">引言</a></li><li><a href="#%09_16" rel="nofollow">第一章 总体设计</a></li><li><ul><li><a href="#11%09_18" rel="nofollow">1.1 系统功能</a></li><li><a href="#12%09_28" rel="nofollow">1.2 主要技术性能指标</a></li></ul> 
    </li><li><a href="#%09_43" rel="nofollow">第二章 系统设计</a></li><li><ul><li><a href="#21%09_45" rel="nofollow">2.1 系统设计</a></li><li><a href="#22%09_49" rel="nofollow">2.2 硬件设计</a></li><li><ul><li><a href="#221%09_51" rel="nofollow">2.2.1 整体仿真图</a></li><li><a href="#222%09_55" rel="nofollow">2.2.2 按键模块</a></li><li><a href="#223%09_65" rel="nofollow">2.2.3 扬声器模块</a></li><li><a href="#224%09_71" rel="nofollow">2.2.4 显示模块</a></li><li><a href="#225%09_77" rel="nofollow">2.2.5 主控模块</a></li></ul> 
     </li><li><a href="#23%09_81" rel="nofollow">2.3 软件设计</a></li><li><ul><li><a href="#231%09_83" rel="nofollow">2.3.1 主要工作原理</a></li><li><a href="#232%09PWM_112" rel="nofollow">2.3.2 PWM发生器</a></li><li><a href="#233%09music_184" rel="nofollow">2.3.3 music播放器模块</a></li><li><a href="#234%09exti_346" rel="nofollow">2.3.4 exti外部中断</a></li><li><a href="#235%09_416" rel="nofollow">2.3.5 按键相关驱动</a></li><li><a href="#236%09LCD1602_450" rel="nofollow">2.3.6 LCD1602驱动</a></li><li><a href="#237%09_466" rel="nofollow">2.3.7 主函数相关设计</a></li></ul> 
    </li></ul> 
    </li><li><a href="#%09_850" rel="nofollow">第三章 系统调试</a></li><li><ul><li><a href="#31__852" rel="nofollow">3.1 仿真调试</a></li><li><a href="#32%09_856" rel="nofollow">3.2 仿真结果</a></li><li><a href="#33%09_860" rel="nofollow">3.3 实际电路调试</a></li><li><a href="#34%09_868" rel="nofollow">3.4 功能测试</a></li><li><a href="#35%09_884" rel="nofollow">3.5 过程中遇到的问题</a></li></ul> 
    </li><li><a href="#%09_890" rel="nofollow">第四章 总结</a></li><li><ul><li><a href="#32%09_896" rel="nofollow">3.2 仿真结果</a></li><li><a href="#33%09_900" rel="nofollow">3.3 实际电路调试</a></li><li><a href="#34%09_908" rel="nofollow">3.4 功能测试</a></li><li><a href="#35%09_924" rel="nofollow">3.5 过程中遇到的问题</a></li></ul> 
    </li><li><a href="#%09_930" rel="nofollow">第四章 总结</a></li></ul> 
  </li></ul> 
 </div></h3> 
<h3><a id="_8"></a>引言</h3> 
<p>​ 单片微型计算机室大规模集成电路技术发展的产物，属于第四代电子计算机它具有高性能、高速度、体积小、价格低廉、稳定可靠、应用广泛的特点。他的应用必定导致传统的控制技术从根本上发生变革。因此，单片机的开发应用已成为高科技和工程领域的一项重大课题。</p> 
<p>​ 电子琴是现代电子科技与音乐结合的产物，是一种新型的键盘乐器。它在现代音乐扮演重要的角色，单片机具有强大的控制功能和灵活的编程实现特性，它已经溶入现代人们的生活中，成为不可替代的一部分。本文的主要内容是用STM32f103rbt6单片机为核心控制元件，设计一个电子琴。</p> 
<p>​ 设计核心在于使用STM32单片机内置的</p> 
<h3><a id="%09_16"></a>第一章 总体设计</h3> 
<h4><a id="11%09_18"></a>1.1 系统功能</h4> 
<p>按照设计要求，本系统具有以下功能：</p> 
<ol><li>共有三个基本模式：电子琴模式、录音模式、播放器模式</li><li>电子琴模式下，7个基本按键控制产生7种音调，功能键实现调节音阶和音量</li><li>录音模式可分为录音和放音两个模块，录音状态下会记录弹奏的音调以及时间；放音模式调用音乐播放器某些模块，实现相同的功能。</li><li>音乐播放器模块下，可以实现音乐的播放、暂停、切歌、调速、顺序播放、单曲循环、随机播放、以及进度条显示。</li><li>有两个全局按键中断，可控制模式切换和全局静音/暂停。</li></ol> 
<h4><a id="12%09_28"></a>1.2 主要技术性能指标</h4> 
<ol><li>基本按键：7个；</li><li>功能按键：6个；</li><li>全局中断按键：2个；</li><li>扬声器：1个；</li><li>扬声器功率：1w；</li><li>LCD1602：1块；</li><li>主要模式：3个；</li><li>曲库：8首；</li><li>音域范围：262Hz~2217Hz；</li><li>音量阶数：3阶；</li><li>速度阶数：4阶；</li><li>循环模式：3种；</li></ol> 
<h3><a id="%09_43"></a>第二章 系统设计</h3> 
<h4><a id="21%09_45"></a>2.1 系统设计</h4> 
<p>​ 总体系统设计上在硬件上共分为3个区域：基本按键区、功能按键区、LCD显示区。在软件的设计上共分为3个主要模式：电子琴模式、录音模式、播放器模式。主控模块选择使用STM32f103rbt6芯片，进行编程、控制、实现电子琴以及播放器功能。</p> 
<h4><a id="22%09_49"></a>2.2 硬件设计</h4> 
<h5><a id="221%09_51"></a>2.2.1 整体仿真图</h5> 
<p><img src="https://images2.imgbox.com/ba/c0/QyutPR0u_o.png" alt="整体设计仿真"></p> 
<h5><a id="222%09_55"></a>2.2.2 按键模块</h5> 
<p>​ 按键模块分为两部分：基本按键和功能按键</p> 
<p><img src="https://images2.imgbox.com/03/f0/VEOuhLBx_o.png" alt="基本按键"></p> 
<p><img src="https://images2.imgbox.com/1a/86/Kpvhp3ys_o.png" alt="功能按键"></p> 
<p>俩个部分按键分别接在单片机的PC0-PC6以及PC8-PC13接口上。</p> 
<h5><a id="223%09_65"></a>2.2.3 扬声器模块</h5> 
<p><img src="https://images2.imgbox.com/50/d1/q4NuxtiB_o.png" alt="扬声器模块"></p> 
<p>扬声器模块接在单片机的PC07接口上。</p> 
<h5><a id="224%09_71"></a>2.2.4 显示模块</h5> 
<p><img src="https://images2.imgbox.com/a6/ee/xS90mhoR_o.png" alt="LCD模块"></p> 
<p>​ 将LCD1602的D0~D7分别连接到单片机的 PA0~7，使能端 E、 RW、 RS分别连接到单片机的 PA8、 PA11、 PA12。</p> 
<h5><a id="225%09_77"></a>2.2.5 主控模块</h5> 
<p><img src="https://images2.imgbox.com/fb/3d/Gnv5aPKr_o.png" alt="STM32f103rbt6芯片"></p> 
<h4><a id="23%09_81"></a>2.3 软件设计</h4> 
<h5><a id="231%09_83"></a>2.3.1 主要工作原理</h5> 
<p>​ 设计的主要工作原理是利用STM32所内置的定时器TIM3产生一个PWM信号驱动扬声器产生特定频率的声音。通过改变定时器TIM3的分频预置数改变PWM信号的频率从而产生不同音调的声音。通过改变占空比，从而产生不同音量的声音。</p> 
<p>​ 相关流程图如下：</p> 
<div class="mermaid flow-chart"> 
 <svg height="697.4609375" version="1.1" width="627.0078125" xmlns="http://www.w3.org/2000/svg" style="overflow: hidden; position: relative;" viewbox="-13.4765625 0 627.0078125 697.4609375" preserveaspectratio="xMidYMid meet"> 
  <desc style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
    Created with Raphaël 2.3.0 
  </desc> 
  <defs style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
   <marker id="raphael-marker-endblock33-obj6qqip" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj4aey4" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj0bfs5" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objolxlq" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objiyppz" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objasuja" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objb7pj0" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-objygwvo" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj35f0u" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
   <marker id="raphael-marker-endblock33-obj8w9et" markerheight="3" markerwidth="3" orient="auto" refx="1.5" refy="1.5" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"> 
    <use transform="rotate(180 1.5 1.5) scale(0.6,0.6)" stroke-width="1.6667" fill="black" stroke="none" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></use> 
   </marker> 
  </defs> 
  <rect x="0" y="0" width="50.015625" height="36.015625" rx="20" ry="20" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="st" transform="matrix(1,0,0,1,49.6016,15.0352)"></rect> 
  <text x="10" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="stt" class="flowchartt" transform="matrix(1,0,0,1,49.6016,15.0352)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     开始 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="106.015625" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="op" transform="matrix(1,0,0,1,21.6016,116.0859)"></rect> 
  <text x="10" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="opt" class="flowchartt" transform="matrix(1,0,0,1,21.6016,116.0859)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     各模块初始化 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M10,18.0078125L0,36.015625L125.21875,36.015625L145.21875,0L20,0L10,18.0078125" stroke-width="1" id="io" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,2,217.1367)"></path> 
  <text x="30" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="iot" class="flowchartt" transform="matrix(1,0,0,1,2,217.1367)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     模式选择输入 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M31.04296875,15.521484375L0,31.04296875L62.0859375,62.0859375L124.171875,31.04296875L62.0859375,0L0,31.04296875" stroke-width="1" id="mode1" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,12.5234,305.1523)"></path> 
  <text x="36.04296875" y="31.04296875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="mode1t" class="flowchartt" transform="matrix(1,0,0,1,12.5234,305.1523)" stroke-width="1"> 
   <tspan dy="4.80078125" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     模式=1? 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="98.015625" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="piano" transform="matrix(1,0,0,1,514.5156,318.1875)"></rect> 
  <rect x="10" y="0" width="78.015625" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" stroke-width="1" id="pianoi" transform="matrix(1,0,0,1,514.5156,318.1875)"></rect> 
  <text x="20" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="pianot" class="flowchartt" transform="matrix(1,0,0,1,514.5156,318.1875)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     钢琴模式 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M31.04296875,15.521484375L0,31.04296875L62.0859375,62.0859375L124.171875,31.04296875L62.0859375,0L0,31.04296875" stroke-width="1" id="mode2" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,12.5234,419.2383)"></path> 
  <text x="36.04296875" y="31.04296875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="mode2t" class="flowchartt" transform="matrix(1,0,0,1,12.5234,419.2383)" stroke-width="1"> 
   <tspan dy="4.80078125" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     模式=2? 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="97.203125" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="recall" transform="matrix(1,0,0,1,367.3125,432.2734)"></rect> 
  <rect x="10" y="0" width="77.203125" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" stroke-width="1" id="recalli" transform="matrix(1,0,0,1,367.3125,432.2734)"></rect> 
  <text x="20" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="recallt" class="flowchartt" transform="matrix(1,0,0,1,367.3125,432.2734)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     录音模式 
   </tspan> 
  </text> 
  <path fill="#ffffff" stroke="#000000" d="M31.04296875,15.521484375L0,31.04296875L62.0859375,62.0859375L124.171875,31.04296875L62.0859375,0L0,31.04296875" stroke-width="1" id="mode3" class="flowchart" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" transform="matrix(1,0,0,1,12.5234,533.3242)"></path> 
  <text x="36.04296875" y="31.04296875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="mode3t" class="flowchartt" transform="matrix(1,0,0,1,12.5234,533.3242)" stroke-width="1"> 
   <tspan dy="4.80078125" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     模式=3? 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="112.015625" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="player" transform="matrix(1,0,0,1,205.2969,546.3594)"></rect> 
  <rect x="10" y="0" width="92.015625" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;" stroke-width="1" id="playeri" transform="matrix(1,0,0,1,205.2969,546.3594)"></rect> 
  <text x="20" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="playert" class="flowchartt" transform="matrix(1,0,0,1,205.2969,546.3594)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     播放器模式 
   </tspan> 
  </text> 
  <rect x="0" y="0" width="106.015625" height="36.015625" rx="0" ry="0" fill="#ffffff" stroke="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);" stroke-width="1" class="flowchart" id="wait" transform="matrix(1,0,0,1,21.6016,660.4453)"></rect> 
  <text x="10" y="18.0078125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" id="waitt" class="flowchartt" transform="matrix(1,0,0,1,21.6016,660.4453)" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     等待模式选择 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M74.609375,51.05078125C74.609375,51.05078125,74.609375,104.8671007687226,74.609375,114.58977568177306" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj6qqip)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M74.609375,152.1015625C74.609375,152.1015625,74.609375,205.9178820187226,74.609375,215.64055693177306" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj4aey4)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M74.609375,253.15234375C74.609375,253.15234375,74.609375,295.126220703125,74.609375,303.6521644592285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj0bfs5)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <path fill="none" stroke="#000000" d="M136.6953125,336.1953125C136.6953125,336.1953125,487.1722312537022,336.1953125,513.0130587594683,336.1953125" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objolxlq)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="141.6953125" y="326.1953125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     yes 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M74.609375,367.23828125C74.609375,367.23828125,74.609375,409.212158203125,74.609375,417.7381019592285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objiyppz)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="79.609375" y="377.23828125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.79296875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     no 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M136.6953125,450.28125C136.6953125,450.28125,345.98426559381187,450.28125,365.8094886896124,450.28125" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objasuja)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="141.6953125" y="440.28125" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.8046875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     yes 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M74.609375,481.32421875C74.609375,481.32421875,74.609375,523.298095703125,74.609375,531.8240394592285" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objb7pj0)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="79.609375" y="491.32421875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.80078125" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     no 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M136.6953125,564.3671875C136.6953125,564.3671875,193.76793733239174,564.3671875,203.8002346662106,564.3671875" stroke-width="1" marker-end="url(#raphael-marker-endblock33-objygwvo)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="141.6953125" y="554.3671875" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.796875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     yes 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M74.609375,595.41015625C74.609375,595.41015625,74.609375,649.2264757687226,74.609375,658.9491506817731" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj35f0u)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
  <text x="79.609375" y="605.41015625" text-anchor="start" font-size="14px" stroke="none" fill="#000000" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); text-anchor: start; font-family: sans-serif; font-size: 14px; font-weight: normal;" stroke-width="1"> 
   <tspan dy="4.79296875" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);">
     no 
   </tspan> 
  </text> 
  <path fill="none" stroke="#000000" d="M21.6015625,678.453125C21.6015625,678.453125,-12.4765625,678.453125,-12.4765625,678.453125C-12.4765625,678.453125,-12.4765625,280.15234375,-12.4765625,280.15234375C-12.4765625,280.15234375,74.609375,280.15234375,74.609375,280.15234375C74.609375,280.15234375,74.609375,298.23975467681885,74.609375,303.64478177018464" stroke-width="1" marker-end="url(#raphael-marker-endblock33-obj8w9et)" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0); font-family: sans-serif; font-weight: normal;"></path> 
 </svg> 
</div> 
<h5><a id="232%09PWM_112"></a>2.3.2 PWM发生器</h5> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pwm.h"</span></span>

TIM_HandleTypeDef 	TIM3_Handler<span class="token punctuation">;</span>      	<span class="token comment">//定时器句柄 </span>
TIM_OC_InitTypeDef 	TIM3_CH2Handler<span class="token punctuation">;</span>	<span class="token comment">//定时器3通道1句柄</span>

<span class="token comment">//TIM1 PWM部分初始化 </span>
<span class="token comment">//arr：自动重装值。</span>
<span class="token comment">//psc：时钟预分频数</span>
<span class="token comment">//定时器溢出时间计算方法:Tout=((arr+1)*(psc+1))/Ft us.</span>
<span class="token comment">//Ft=定时器工作频率,单位:Mhz</span>
<span class="token keyword">void</span> <span class="token function">TIM3_PWM_Init</span><span class="token punctuation">(</span>u16 arr<span class="token punctuation">,</span>u16 psc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>  
    TIM3_Handler<span class="token punctuation">.</span>Instance<span class="token operator">=</span>TIM3<span class="token punctuation">;</span>         	<span class="token comment">//定时器1</span>
    TIM3_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Prescaler<span class="token operator">=</span>psc<span class="token punctuation">;</span>       	<span class="token comment">//定时器分频</span>
    TIM3_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>CounterMode<span class="token operator">=</span>TIM_COUNTERMODE_UP<span class="token punctuation">;</span><span class="token comment">//向上计数模式</span>
    TIM3_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>Period<span class="token operator">=</span>arr<span class="token punctuation">;</span>          	<span class="token comment">//自动重装载值</span>
    TIM3_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>ClockDivision<span class="token operator">=</span>TIM_CLOCKDIVISION_DIV1<span class="token punctuation">;</span><span class="token comment">//分频因子</span>
	TIM3_Handler<span class="token punctuation">.</span>Init<span class="token punctuation">.</span>AutoReloadPreload <span class="token operator">=</span> TIM_AUTORELOAD_PRELOAD_ENABLE<span class="token punctuation">;</span><span class="token comment">//使能自动重载</span>
    <span class="token function">HAL_TIM_PWM_Init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TIM3_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>       	<span class="token comment">//初始化PWM</span>
    
    TIM3_CH2Handler<span class="token punctuation">.</span>OCMode<span class="token operator">=</span>TIM_OCMODE_PWM1<span class="token punctuation">;</span> <span class="token comment">//模式选择PWM1</span>
    TIM3_CH2Handler<span class="token punctuation">.</span>Pulse<span class="token operator">=</span>arr<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>            <span class="token comment">//设置比较值,此值用来确定占空比，默认比较值为自动重装载值的一半,即占空比为50%</span>
    TIM3_CH2Handler<span class="token punctuation">.</span>OCPolarity<span class="token operator">=</span>TIM_OCPOLARITY_LOW<span class="token punctuation">;</span> <span class="token comment">//输出比较极性为低 </span>
    <span class="token function">HAL_TIM_PWM_ConfigChannel</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TIM3_Handler<span class="token punctuation">,</span><span class="token operator">&amp;</span>TIM3_CH2Handler<span class="token punctuation">,</span>TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//配置TIM3通道2</span>
	
    <span class="token function">HAL_TIM_PWM_Start</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TIM3_Handler<span class="token punctuation">,</span>TIM_CHANNEL_2<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开启PWM通道2</span>
	 	   
<span class="token punctuation">}</span>

<span class="token comment">//定时器底层驱动，时钟使能，引脚配置</span>
<span class="token comment">//此函数会被HAL_TIM_PWM_Init()调用</span>
<span class="token comment">//htim:定时器句柄</span>
<span class="token keyword">void</span> <span class="token function">HAL_TIM_PWM_MspInit</span><span class="token punctuation">(</span>TIM_HandleTypeDef <span class="token operator">*</span>htim<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
	
    <span class="token keyword">if</span><span class="token punctuation">(</span>htim<span class="token operator">-&gt;</span>Instance<span class="token operator">==</span>TIM3<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">__HAL_RCC_TIM3_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//使能定时器3</span>
		<span class="token function">__HAL_AFIO_REMAP_TIM3_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		    <span class="token comment">//TIM3通道引脚完全重映射使能</span>
		<span class="token function">__HAL_RCC_GPIOC_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">//开启GPIOC时钟</span>
		
		GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_7<span class="token punctuation">;</span>           	<span class="token comment">//PC6</span>
		GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_AF_PP<span class="token punctuation">;</span>  	<span class="token comment">//复用推挽输出</span>
		GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>          <span class="token comment">//上拉</span>
		GPIO_Initure<span class="token punctuation">.</span>Speed<span class="token operator">=</span>GPIO_SPEED_HIGH<span class="token punctuation">;</span>     <span class="token comment">//高速</span>
		<span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span> 	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//设置TIM3通道2的占空比</span>
<span class="token comment">//compare:比较值</span>
<span class="token keyword">void</span> <span class="token function">TIM_SetTIM3Compare2</span><span class="token punctuation">(</span>u32 compare<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM3<span class="token operator">-&gt;</span>CCR2<span class="token operator">=</span>compare<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>

<span class="token comment">//设置TIM3通道2的arr</span>
<span class="token keyword">void</span> <span class="token function">TIM_SetTIM3Autoreload</span><span class="token punctuation">(</span>u32 Autoreload<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TIM3<span class="token operator">-&gt;</span>ARR<span class="token operator">=</span>Autoreload<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//定时器3中断服务函数</span>
<span class="token keyword">void</span> <span class="token function">TIM3_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_TIM_IRQHandler</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>TIM3_Handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="233%09music_184"></a>2.3.3 music播放器模块</h5> 
<p>​ music模块包含了产生声音，静音，音乐播放，音乐切换，进度条展示等相关函数，全都由本人编写</p> 
<p>静音模块：通过调用<code>TIM_SetTIM3Compare2()</code>函数让占空比为0，进而达到静音效果。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token comment">//停止发声</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">TIM_SetTIM3Compare2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>发声函数：通过调用<code>TIM_SetTIM3Autoreload</code>设置TIM3的自动装载值实现产生特定频率PWM信号，传入的参数为声音频率和音量参数。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">buzzerSound</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span> usFraq<span class="token punctuation">,</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span> volume_level<span class="token punctuation">)</span><span class="token comment">//发声模块</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> Autoreload<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>usFraq<span class="token operator">&lt;=</span><span class="token number">122</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>usFraq<span class="token operator">&gt;</span><span class="token number">20000</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		Autoreload<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">8000000</span><span class="token operator">/</span>usFraq<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
		<span class="token function">TIM_SetTIM3Autoreload</span><span class="token punctuation">(</span>Autoreload<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">TIM_SetTIM3Compare2</span><span class="token punctuation">(</span>Autoreload<span class="token operator">&gt;&gt;</span>volume_level<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>进度条显示函数：可以显示播放进度以及全局状态，如当前曲目、暂停状态、音量、播放速度等。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">playstate</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span><span class="token keyword">char</span> n<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
			
	<span class="token keyword">switch</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c-           %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c--          %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c---         %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c----        %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c-----       %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c------      %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c-------     %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c--------    %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">8</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c---------   %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">9</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c----------  %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">10</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c----------- %c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">11</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c------------%c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">12</span><span class="token operator">:</span>
			<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"%c%c------------%c%d"</span><span class="token punctuation">,</span>n<span class="token punctuation">,</span>pausename<span class="token punctuation">[</span>pauseflag<span class="token punctuation">]</span><span class="token punctuation">,</span>speedname<span class="token punctuation">[</span>speed<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下一首函数：根据传入nextmode参数不同进行顺序，单曲，随机下一首。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">nextsong</span><span class="token punctuation">(</span><span class="token keyword">int</span> nextmode<span class="token punctuation">,</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> h<span class="token punctuation">;</span>
<span class="token comment">//	tNote *p;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>nextmode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
		next<span class="token operator">=</span><span class="token punctuation">(</span>next<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>nextmode<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
		next<span class="token operator">=</span>next<span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>nextmode<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		h<span class="token operator">=</span>i<span class="token operator">%</span><span class="token number">6</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
		next <span class="token operator">=</span> <span class="token punctuation">(</span>next<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">8</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>音乐播放函数：传入乐谱（由结构体数组实现），调用弹奏音符函数，实现音乐自动播放。</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">play_node</span><span class="token punctuation">(</span><span class="token keyword">int</span> tone<span class="token punctuation">,</span><span class="token keyword">int</span> time<span class="token punctuation">)</span><span class="token comment">//弹奏音符</span>
<span class="token punctuation">{<!-- --></span>
			<span class="token function">buzzerSound</span><span class="token punctuation">(</span>tone<span class="token punctuation">,</span>volume<span class="token punctuation">)</span><span class="token punctuation">;</span>
  		<span class="token function">delay_ms</span><span class="token punctuation">(</span>time<span class="token operator">/</span><span class="token punctuation">(</span><span class="token punctuation">(</span>speed<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">musicPlay</span><span class="token punctuation">(</span>tNote song<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">int</span> n<span class="token punctuation">)</span><span class="token comment">//音乐播放</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token function">play_node</span><span class="token punctuation">(</span><span class="token keyword">int</span> tone<span class="token punctuation">,</span><span class="token keyword">int</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
	u8 i<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> playflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> len <span class="token operator">=</span> song<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>song<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">||</span>song<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>playflag<span class="token operator">&amp;&amp;</span>mode<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
				key1 <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">switch</span><span class="token punctuation">(</span>key1<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> KEY13_PRES<span class="token operator">:</span>
					playflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY12_PRES<span class="token operator">:</span>
					vol<span class="token operator">=</span><span class="token punctuation">(</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//0~2循环</span>
				 <span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY11_PRES<span class="token operator">:</span>
					speed<span class="token operator">=</span><span class="token punctuation">(</span>speed<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY10_PRES<span class="token operator">:</span>
					nextmode<span class="token operator">=</span><span class="token punctuation">(</span>nextmode<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">;</span>
				<span class="token keyword">switch</span><span class="token punctuation">(</span>nextmode<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">"  SHUFFLE PLAY  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">"   ORDER PLAY   "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">"  SINGLE CYCLE  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>		
			<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pauseflag<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token function">play_node</span><span class="token punctuation">(</span>song<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token punctuation">,</span>song<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
			<span class="token function">playstate</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token operator">*</span>i<span class="token operator">/</span>len<span class="token punctuation">,</span>n<span class="token operator">+</span><span class="token number">48</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">nextsong</span><span class="token punctuation">(</span>nextmode<span class="token punctuation">,</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="234%09exti_346"></a>2.3.4 exti外部中断</h5> 
<p>​ 本设计使用了PC8，PC9口的按键作为两个外部中断，控制全局切换模式，以及全局暂停/静音</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"exti.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"music.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">NEXT_MODE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token punctuation">(</span>mode<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PAUSE</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>pauseflag<span class="token operator">=</span><span class="token operator">!</span>pauseflag<span class="token punctuation">)</span></span></span>

<span class="token keyword">extern</span> <span class="token keyword">int</span> mode<span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">int</span> pauseflag<span class="token punctuation">;</span>

<span class="token comment">//外部中断初始化</span>
<span class="token keyword">void</span> <span class="token function">EXTI_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    GPIO_InitTypeDef GPIO_Initure<span class="token punctuation">;</span>
    

    <span class="token function">__HAL_RCC_GPIOC_CLK_ENABLE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">//开启GPIOC时钟</span>

    GPIO_Initure<span class="token punctuation">.</span>Pin<span class="token operator">=</span>GPIO_PIN_8<span class="token operator">|</span>GPIO_PIN_9<span class="token punctuation">;</span> 	<span class="token comment">//PC8、PC9</span>
    GPIO_Initure<span class="token punctuation">.</span>Mode<span class="token operator">=</span>GPIO_MODE_IT_FALLING<span class="token punctuation">;</span>     <span class="token comment">//下降沿触发</span>
    GPIO_Initure<span class="token punctuation">.</span>Pull<span class="token operator">=</span>GPIO_PULLUP<span class="token punctuation">;</span>
    <span class="token function">HAL_GPIO_Init</span><span class="token punctuation">(</span>GPIOC<span class="token punctuation">,</span><span class="token operator">&amp;</span>GPIO_Initure<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//中断线8、9-PC8、9</span>
    <span class="token function">HAL_NVIC_SetPriority</span><span class="token punctuation">(</span>EXTI9_5_IRQn<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   	<span class="token comment">//抢占优先级为2，子优先级为1</span>
    <span class="token function">HAL_NVIC_EnableIRQ</span><span class="token punctuation">(</span>EXTI9_5_IRQn<span class="token punctuation">)</span><span class="token punctuation">;</span> 

<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">EXTI9_5_IRQHandler</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">HAL_GPIO_EXTI_IRQHandler</span><span class="token punctuation">(</span>GPIO_PIN_8<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//调用中断处理公用函数</span>
	<span class="token function">HAL_GPIO_EXTI_IRQHandler</span><span class="token punctuation">(</span>GPIO_PIN_9<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//调用中断处理公用函数</span>
<span class="token punctuation">}</span>
<span class="token comment">//中断服务程序中需要做的事情</span>
<span class="token comment">//在HAL库中所有的外部中断服务函数都会调用此函数</span>
<span class="token comment">//GPIO_Pin:中断引脚号</span>
<span class="token keyword">void</span> <span class="token function">HAL_GPIO_EXTI_Callback</span><span class="token punctuation">(</span><span class="token class-name">uint16_t</span> GPIO_Pin<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      	<span class="token comment">//消抖</span>
    <span class="token keyword">switch</span><span class="token punctuation">(</span>GPIO_Pin<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> GPIO_PIN_8<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>KEY8<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>  	
            <span class="token punctuation">{<!-- --></span>
							<span class="token function">buzzerSound</span><span class="token punctuation">(</span>FM2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
							<span class="token function">NEXT_MODE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//切换模式</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> GPIO_PIN_9<span class="token operator">:</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>KEY9<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>  
            <span class="token punctuation">{<!-- --></span>
							<span class="token function">PAUSE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//暂停</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
				
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h5><a id="235%09_416"></a>2.3.5 按键相关驱动</h5> 
<p>​ 按键初始化相关代码采用例程，在此不列出，只列出关键代码：</p> 
<pre><code class="prism language-c">	<span class="token keyword">static</span> u8 key_up<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//按键按松开标志</span>
u8 <span class="token function">KEY_Scan</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>	 

	<span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>key_up<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>  <span class="token comment">//支持连按		  </span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key_up<span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY5<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY6<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY8<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY9<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY10<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY11<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY12<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY13<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//去抖动 </span>
		key_up<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY0_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY1_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY2_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY3_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY4_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY5<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY5_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY6<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY6_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY8<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY8_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY9<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY9_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY10<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY10_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY11<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY11_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY12<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY12_PRES<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY13<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span> KEY13_PRES<span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY0<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY1<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY2<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY3<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY4<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY5<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY6<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY8<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY9<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY10<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY11<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY12<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY13<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>key_up<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> 	     
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">// 无按键按下</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 通过函数判断按键值，mode参数可调节是否支持连按。</p> 
<h5><a id="236%09LCD1602_450"></a>2.3.6 LCD1602驱动</h5> 
<p>​ LCD初始化相关代码采用例程，在此不列出，只列出关键代码：</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> tab0<span class="token punctuation">,</span>u8<span class="token operator">*</span> tab1<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>tab0<span class="token punctuation">)</span>
	  <span class="token function">LCD1602_Show_Str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tab0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>tab1<span class="token punctuation">)</span>
   	<span class="token function">LCD1602_Show_Str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>​ 定义函数LCD_SHOW，传入字符串显示，在避免直接调用LCD的显示函数，通过<code>tab0</code>和<code>tab1</code>的锁存，实现更丰富需求。</p> 
<h5><a id="237%09_466"></a>2.3.7 主函数相关设计</h5> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"main.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"lcd1602.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"music.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"pwm.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"exti.h"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MENU</span> <span class="token expression"><span class="token number">8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PIANO</span> <span class="token expression"><span class="token number">0</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RECORD</span> <span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PLAYER</span> <span class="token expression"><span class="token number">2</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">volume</span> <span class="token expression"><span class="token punctuation">(</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span></span></span>

<span class="token keyword">void</span> <span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> tab0<span class="token punctuation">,</span>u8<span class="token operator">*</span> tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> nextmode<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> mode <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> vol <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> tone <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
u8 tab0<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
u8 tab1<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> startflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> finishflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> psite<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> pauseflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
 vu8 key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token keyword">int</span> speed<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> relen<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> pausename<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'P'</span><span class="token punctuation">,</span><span class="token string">'S'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> speedname<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token string">'L'</span><span class="token punctuation">,</span><span class="token string">'N'</span><span class="token punctuation">,</span><span class="token string">'M'</span><span class="token punctuation">,</span><span class="token string">'H'</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">extern</span> tNote Score1<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score2<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score3<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score4<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score5<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score6<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score7<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> tNote Score8<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">//extern tNote Score1[];</span>
<span class="token comment">//extern tNote Score1[];</span>



<span class="token comment">//int next =1;</span>

<span class="token keyword">int</span> ToneList<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">{<!-- --></span><span class="token number">262</span><span class="token punctuation">,</span><span class="token number">294</span><span class="token punctuation">,</span><span class="token number">330</span><span class="token punctuation">,</span><span class="token number">349</span><span class="token punctuation">,</span><span class="token number">392</span><span class="token punctuation">,</span><span class="token number">440</span><span class="token punctuation">,</span><span class="token number">494</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">523</span><span class="token punctuation">,</span><span class="token number">587</span><span class="token punctuation">,</span><span class="token number">659</span><span class="token punctuation">,</span><span class="token number">698</span><span class="token punctuation">,</span><span class="token number">784</span><span class="token punctuation">,</span><span class="token number">880</span><span class="token punctuation">,</span><span class="token number">988</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">{<!-- --></span><span class="token number">1047</span><span class="token punctuation">,</span><span class="token number">1175</span><span class="token punctuation">,</span><span class="token number">1319</span><span class="token punctuation">,</span><span class="token number">1397</span><span class="token punctuation">,</span><span class="token number">1568</span><span class="token punctuation">,</span><span class="token number">1760</span><span class="token punctuation">,</span><span class="token number">1976</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">char</span> ToneName<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token string">'L'</span><span class="token punctuation">,</span><span class="token string">'M'</span><span class="token punctuation">,</span><span class="token string">'H'</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
tNote RecordScord<span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
<span class="token comment">//    u8 len;	</span>
<span class="token comment">//	u16 times=0;  </span>
	<span class="token keyword">int</span> reflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	
    <span class="token function">HAL_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    	<span class="token comment">//初始化HAL库    </span>
    <span class="token function">Stm32_Clock_Init</span><span class="token punctuation">(</span>RCC_PLL_MUL9<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置时钟,72M</span>
    <span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token number">72</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                 <span class="token comment">//初始化延时函数</span>
	<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>				<span class="token comment">//初始化串口115200</span>
	
    <span class="token function">LCD1602_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">TIM3_PWM_Init</span><span class="token punctuation">(</span><span class="token number">0xfffe</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">EXTI_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"1231"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">musicPlayRE</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
	                      <span class="token comment">/*0123456789ABCDEF*/</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">" Mode Selection "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"Please Press 1~3"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	  <span class="token function">buzzerSound</span><span class="token punctuation">(</span>FM1<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//musicPlay();</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> MENU<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			
			key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> KEY0_PRES<span class="token operator">:</span>
					mode <span class="token operator">=</span>PIANO<span class="token punctuation">;</span>
<span class="token comment">//					                    /*0123456789ABCDEF*/</span>
<span class="token comment">//					sprintf((char *)tab0,"   PIANO MODE   ");</span>
<span class="token comment">//					sprintf((char *)tab1," Tone=%c   Vol=%d ",(tone+67),vol);</span>
<span class="token comment">//					LCD_SHOW(tab0,tab1);</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY1_PRES<span class="token operator">:</span>
					mode <span class="token operator">=</span> RECORD<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY2_PRES<span class="token operator">:</span>
					mode <span class="token operator">=</span> PLAYER<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">default</span><span class="token operator">:</span>
					<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			
		<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> PIANO<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">"   PIANO MODE   "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">" Tone=C%c  Vol=%d "</span><span class="token punctuation">,</span>ToneName<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">,</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
			key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> KEY13_PRES<span class="token operator">:</span>
					vol<span class="token operator">=</span><span class="token punctuation">(</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//0~2循环</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY12_PRES<span class="token operator">:</span>
					tone <span class="token operator">=</span> <span class="token punctuation">(</span>tone<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY0<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//音量用函数转成分频值012---741</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY1<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY2<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY3<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY4<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY5<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY6<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token operator">-</span><span class="token number">3</span><span class="token operator">*</span>vol<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
			
		<span class="token keyword">while</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> RECORD<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>startflag<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				finishflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
				psite<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
				key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">"   RECORD MODE  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"  Key0 to Start "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> KEY0_PRES<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					startflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"  Come On! GO!  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> KEY13_PRES<span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>relen<span class="token punctuation">)</span>
					<span class="token function">musicPlayRE</span><span class="token punctuation">(</span>relen<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">else</span>
					<span class="token punctuation">{<!-- --></span>
						<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"  NO RECORDED  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
					
				
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>finishflag<span class="token punctuation">)</span>
				startflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> KEY13_PRES<span class="token operator">:</span>
					finishflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"  RECORD FINISH "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					RecordScord<span class="token punctuation">[</span>psite<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
					RecordScord<span class="token punctuation">[</span>psite<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY12_PRES<span class="token operator">:</span>
					tone <span class="token operator">=</span> <span class="token punctuation">(</span>tone<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY0<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY1<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY2<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY3<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY4<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY5<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>KEY6<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token function">buzzerSound</span><span class="token punctuation">(</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				reflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span>ToneList<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				RecordScord<span class="token punctuation">[</span>psite<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">++</span><span class="token punctuation">;</span>
				<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">buzzerQuiet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>reflag<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				psite<span class="token operator">++</span><span class="token punctuation">;</span>
				relen<span class="token operator">=</span>psite<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"P=%d key13 over  %c"</span><span class="token punctuation">,</span>psite<span class="token punctuation">,</span>ToneName<span class="token punctuation">[</span>tone<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>psite<span class="token operator">&gt;</span><span class="token number">98</span><span class="token punctuation">)</span>
				<span class="token punctuation">{<!-- --></span>
					finishflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"   SCORD FULL  "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					RecordScord<span class="token punctuation">[</span>psite<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
					RecordScord<span class="token punctuation">[</span>psite<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
				
				
			
			
			
		<span class="token punctuation">}</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span>mode <span class="token operator">==</span> PLAYER<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab0<span class="token punctuation">,</span><span class="token string">"   PLAYER MODE   "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">sprintf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>tab1<span class="token punctuation">,</span><span class="token string">"  Key13 to start "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>tab0<span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
					key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> KEY13_PRES<span class="token operator">:</span>
					<span class="token function">nextsong</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
						<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>

		<span class="token comment">//	musicPlay(Score1,0);</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>

			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score2<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>

			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score3<span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span>

			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score4<span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span>

			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score5<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span>

			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score6<span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span>
			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score7<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span>
			<span class="token function">musicPlay</span><span class="token punctuation">(</span>Score8<span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			
		<span class="token punctuation">}</span>
	
	<span class="token punctuation">}</span>
		
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">LCD_SHOW</span><span class="token punctuation">(</span>u8<span class="token operator">*</span> tab0<span class="token punctuation">,</span>u8<span class="token operator">*</span> tab1<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>tab0<span class="token punctuation">)</span>
	  <span class="token function">LCD1602_Show_Str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> tab0<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>tab1<span class="token punctuation">)</span>
   	<span class="token function">LCD1602_Show_Str</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">musicPlayRE</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">void</span> <span class="token function">play_node</span><span class="token punctuation">(</span><span class="token keyword">int</span> tone<span class="token punctuation">,</span><span class="token keyword">int</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> playflag<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>RecordScord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token operator">||</span>RecordScord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>playflag<span class="token operator">&amp;&amp;</span>mode<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
				key <span class="token operator">=</span> <span class="token function">KEY_Scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">switch</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">case</span> KEY13_PRES<span class="token operator">:</span>
					playflag<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY12_PRES<span class="token operator">:</span>
					vol<span class="token operator">=</span><span class="token punctuation">(</span>vol<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token comment">//0~2循环</span>
				 <span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> KEY11_PRES<span class="token operator">:</span>
					speed<span class="token operator">=</span><span class="token punctuation">(</span>speed<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">4</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>pauseflag<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token function">play_node</span><span class="token punctuation">(</span>RecordScord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mName<span class="token punctuation">,</span>RecordScord<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
			<span class="token function">playstate</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token operator">*</span>i<span class="token operator">/</span>len<span class="token punctuation">,</span><span class="token string">'R'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">LCD_SHOW</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>tab1<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="%09_850"></a>第三章 系统调试</h3> 
<h4><a id="31__852"></a>3.1 仿真调试</h4> 
<p>​ 本设计利用 Keil uVsion5进行程序编写，编译，调试，生成 .hex文件，在Proteus中进行原理图绘制，然后把 .hex文件下载到STM32F103RBT6中 进行仿真。 由于网络上 下载的 Proteus中 没有 STM32F103RBT6这个芯片型号，我们又从网上 下载芯片 进行仿真。</p> 
<h4><a id="32%09_856"></a>3.2 仿真结果</h4> 
<p>​ 仿真并没有取得预期结果，分析原因可能是因为仿真所使用的系统频率过低，没法实现正常的要求，所以未达到预期效果。</p> 
<h4><a id="33%09_860"></a>3.3 实际电路调试</h4> 
<p>​ 在搭建好实际电路后，各项功能均可正常工作。</p> 
<p>​ 同时，根据需要用孔板焊接了一套按键键盘。</p> 
<p><img src="https://images2.imgbox.com/c4/4b/mJkbSAyK_o.png" alt="屏幕截图 2021-07-16 105801"></p> 
<h4><a id="34%09_868"></a>3.4 功能测试</h4> 
<ol><li>单片机下载完成后，显示<code>Mode Selection Please Press 1-3</code>表示初始化完成等待选择模式</li><li>按下key1，进入Piano模式，可以开始弹奏。</li><li>按下key13可进行音量调节，key12可以调节音调</li><li>按下key8切换模式，进入录音模式</li><li>录音模式下，按key0进行开始录音</li><li>录音会记录音调以及持续时间，按下key13停止录音</li><li>录音完成后按下key13放音，可以听到记录的曲子</li><li>按下key13切换模式进入播放器模式</li><li>可以通过key0-key7选择曲目，也可以直接按key13开始播放</li><li>播放时，按下key13下一首，key12调音量，key11调速度，key10调节下一首模式，key9可暂停</li><li>播放时有进度条显示</li></ol> 
<p>至此，所有功能均无错误。</p> 
<h4><a id="35%09_884"></a>3.5 过程中遇到的问题</h4> 
<p>​ 在设计时，一开始选择使用面包板搭建外围电路，但是发现过于臃肿，所以自己焊接了一块按键键盘，便于操作。</p> 
<p>​ 在软件设计时，各种全局变量在不同函数之间的传递，导致逻辑十分混乱，通过画图，慢慢的理清逻辑修改bug</p> 
<h3><a id="%09_890"></a>第四章 总结</h3> 
<p>​ 本设计以实际电路为最后的结果，实现了所有与其功能，具有重要的现实意义。</p> 
<p>件，在Proteus中进行原理图绘制，然后把 .hex文件下载到STM32F103RBT6中 进行仿真。 由于网络上 下载的 Proteus中 没有 STM32F103RBT6这个芯片型号，我们又从网上 下载芯片 进行仿真。</p> 
<h4><a id="32%09_896"></a>3.2 仿真结果</h4> 
<p>​ 仿真并没有取得预期结果，分析原因可能是因为仿真所使用的系统频率过低，没法实现正常的要求，所以未达到预期效果。</p> 
<h4><a id="33%09_900"></a>3.3 实际电路调试</h4> 
<p>​ 在搭建好实际电路后，各项功能均可正常工作。</p> 
<p>​ 同时，根据需要用孔板焊接了一套按键键盘。</p> 
<p>[外链图片转存中…(img-mnecOLco-1632967473029)]</p> 
<h4><a id="34%09_908"></a>3.4 功能测试</h4> 
<ol><li>单片机下载完成后，显示<code>Mode Selection Please Press 1-3</code>表示初始化完成等待选择模式</li><li>按下key1，进入Piano模式，可以开始弹奏。</li><li>按下key13可进行音量调节，key12可以调节音调</li><li>按下key8切换模式，进入录音模式</li><li>录音模式下，按key0进行开始录音</li><li>录音会记录音调以及持续时间，按下key13停止录音</li><li>录音完成后按下key13放音，可以听到记录的曲子</li><li>按下key13切换模式进入播放器模式</li><li>可以通过key0-key7选择曲目，也可以直接按key13开始播放</li><li>播放时，按下key13下一首，key12调音量，key11调速度，key10调节下一首模式，key9可暂停</li><li>播放时有进度条显示</li></ol> 
<p>至此，所有功能均无错误。</p> 
<h4><a id="35%09_924"></a>3.5 过程中遇到的问题</h4> 
<p>​ 在设计时，一开始选择使用面包板搭建外围电路，但是发现过于臃肿，所以自己焊接了一块按键键盘，便于操作。</p> 
<p>​ 在软件设计时，各种全局变量在不同函数之间的传递，导致逻辑十分混乱，通过画图，慢慢的理清逻辑修改bug</p> 
<h3><a id="%09_930"></a>第四章 总结</h3> 
<p>​ 本设计以实际电路为最后的结果，实现了所有与其功能，具有重要的现实意义。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a6e824839ee0ff58c3990a4d4b8aea40/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">面试官：说说常见的排序算法有哪些？区别？</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a228529ed903331681676411eddf60b3/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android项目迁移到 AndroidX</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>