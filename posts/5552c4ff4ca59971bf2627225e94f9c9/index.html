<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>18.Flink开发笔记三 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="18.Flink开发笔记三" />
<meta property="og:description" content="Flink开发笔记三 1. 表2. 更新模式3. 输出到mysql4. 动态表转换成DataStream5. 时间特性6. 窗口6.1. 案例 7. 函数7.1. 一对一，scalar函数 1. 表 2. 更新模式 3. 输出到mysql 4. 动态表转换成DataStream 5. 时间特性 6. 窗口 6.1. 案例 package com.xiaofan.apitest.tabletest import com.xiaofan.apitest.source.SensorReading import org.apache.flink.streaming.api.TimeCharacteristic import org.apache.flink.streaming.api.functions.timestamps.BoundedOutOfOrdernessTimestampExtractor import org.apache.flink.streaming.api.scala._ import org.apache.flink.streaming.api.windowing.time.Time import org.apache.flink.table.api._ import org.apache.flink.table.api.bridge.scala.StreamTableEnvironment import org.apache.flink.types.Row object TimeAndWindowTest { def main(args: Array[String]): Unit = { val env: StreamExecutionEnvironment = StreamExecutionEnvironment.getExecutionEnvironment env.setParallelism(1) env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime) val tabEnv: StreamTableEnvironment = StreamTableEnvironment.create(env) val inputPath = &#34;D:\\big-data\\code\\FlinkTutorial\\src\\main\\resources\\sensor.txt&#34; val inputStream: DataStream[String] = env." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5552c4ff4ca59971bf2627225e94f9c9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-21T12:01:48+08:00" />
<meta property="article:modified_time" content="2021-04-21T12:01:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">18.Flink开发笔记三</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>Flink开发笔记三</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1. 表</a></li><li><a href="#2__3" rel="nofollow">2. 更新模式</a></li><li><a href="#3_mysql_5" rel="nofollow">3. 输出到mysql</a></li><li><a href="#4_DataStream_7" rel="nofollow">4. 动态表转换成DataStream</a></li><li><a href="#5__10" rel="nofollow">5. 时间特性</a></li><li><a href="#6__14" rel="nofollow">6. 窗口</a></li><li><ul><li><a href="#61__23" rel="nofollow">6.1. 案例</a></li></ul> 
  </li><li><a href="#7__121" rel="nofollow">7. 函数</a></li><li><ul><li><a href="#71_scalar_122" rel="nofollow">7.1. 一对一，scalar函数</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1. 表</h2> 
<p><img src="https://images2.imgbox.com/42/58/hqR1C9Ns_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2__3"></a>2. 更新模式</h2> 
<p><img src="https://images2.imgbox.com/46/2a/fPFkNsel_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_mysql_5"></a>3. 输出到mysql</h2> 
<p><img src="https://images2.imgbox.com/9a/33/HftLLj8o_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4_DataStream_7"></a>4. 动态表转换成DataStream</h2> 
<p><img src="https://images2.imgbox.com/49/c2/U65hHLak_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/da/a6/rHKSne9M_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5__10"></a>5. 时间特性</h2> 
<p><img src="https://images2.imgbox.com/2f/b5/Ea3ZkG0P_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/de/4f/pbqqVqbX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4c/d0/e9jUPVki_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="6__14"></a>6. 窗口</h2> 
<p><img src="https://images2.imgbox.com/09/ee/yHX0TkcG_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/35/b3/MrAsde9O_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/53/ad/P1RlBI7x_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f6/d1/ONtQETR2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e3/26/g2qZWR4G_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/44/78/9zYJ1dG9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/15/37/inDk1FpX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0f/4a/xAB5uTpS_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="61__23"></a>6.1. 案例</h3> 
<pre><code class="prism language-scala"><span class="token keyword">package</span> com<span class="token punctuation">.</span>xiaofan<span class="token punctuation">.</span>apitest<span class="token punctuation">.</span>tabletest

<span class="token keyword">import</span> com<span class="token punctuation">.</span>xiaofan<span class="token punctuation">.</span>apitest<span class="token punctuation">.</span>source<span class="token punctuation">.</span>SensorReading
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>TimeCharacteristic
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>functions<span class="token punctuation">.</span>timestamps<span class="token punctuation">.</span>BoundedOutOfOrdernessTimestampExtractor
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>_
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>streaming<span class="token punctuation">.</span>api<span class="token punctuation">.</span>windowing<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Time
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>_
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>table<span class="token punctuation">.</span>api<span class="token punctuation">.</span>bridge<span class="token punctuation">.</span>scala<span class="token punctuation">.</span>StreamTableEnvironment
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>flink<span class="token punctuation">.</span>types<span class="token punctuation">.</span>Row

<span class="token keyword">object</span> TimeAndWindowTest <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">val</span> env<span class="token operator">:</span> StreamExecutionEnvironment <span class="token operator">=</span> StreamExecutionEnvironment<span class="token punctuation">.</span>getExecutionEnvironment
    env<span class="token punctuation">.</span>setParallelism<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    env<span class="token punctuation">.</span>setStreamTimeCharacteristic<span class="token punctuation">(</span>TimeCharacteristic<span class="token punctuation">.</span>EventTime<span class="token punctuation">)</span>

    <span class="token keyword">val</span> tabEnv<span class="token operator">:</span> StreamTableEnvironment <span class="token operator">=</span> StreamTableEnvironment<span class="token punctuation">.</span>create<span class="token punctuation">(</span>env<span class="token punctuation">)</span>

    <span class="token keyword">val</span> inputPath <span class="token operator">=</span> <span class="token string">"D:\\big-data\\code\\FlinkTutorial\\src\\main\\resources\\sensor.txt"</span>
    <span class="token keyword">val</span> inputStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> env<span class="token punctuation">.</span>readTextFile<span class="token punctuation">(</span>inputPath<span class="token punctuation">)</span>

    <span class="token keyword">val</span> dataStream<span class="token operator">:</span> DataStream<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span> <span class="token operator">=</span> inputStream<span class="token punctuation">.</span>map<span class="token punctuation">(</span>
      data <span class="token keyword">=&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">val</span> arr<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span>
        SensorReading<span class="token punctuation">(</span>arr<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toLong<span class="token punctuation">,</span> arr<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toDouble<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">.</span>assignTimestampsAndWatermarks<span class="token punctuation">(</span><span class="token keyword">new</span> BoundedOutOfOrdernessTimestampExtractor<span class="token punctuation">[</span>SensorReading<span class="token punctuation">]</span><span class="token punctuation">(</span>Time<span class="token punctuation">.</span>milliseconds<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">override</span> <span class="token keyword">def</span> extractTimestamp<span class="token punctuation">(</span>element<span class="token operator">:</span> SensorReading<span class="token punctuation">)</span> <span class="token operator">=</span> element<span class="token punctuation">.</span>timestamp <span class="token operator">*</span> <span class="token number">1000L</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">val</span> sensorTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">,</span> $<span class="token string">"timestamp"</span><span class="token punctuation">.</span>rowtime<span class="token punctuation">(</span><span class="token punctuation">)</span> as <span class="token string">"ts"</span><span class="token punctuation">)</span>

    <span class="token comment">//    sensorTable.printSchema()</span>
    <span class="token comment">//    tabEnv.toAppendStream[Row](sensorTable).print()</span>

    <span class="token comment">// 1. Group Window</span>
    <span class="token comment">// 1.1. table api</span>
    <span class="token keyword">val</span> resultTable<span class="token operator">:</span> Table <span class="token operator">=</span> sensorTable
      <span class="token comment">//      .window(Tumble.over(10.seconds()).on($"ts").as($"tw")) // 每10秒统计一次，滚动时间窗口</span>
      <span class="token punctuation">.</span>window<span class="token punctuation">(</span>Tumble over <span class="token number">10.</span>seconds on $<span class="token string">"ts"</span> as $<span class="token string">"tw"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"tw"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">.</span>count<span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">.</span>avg<span class="token punctuation">,</span> $<span class="token string">"tw"</span><span class="token punctuation">.</span>end<span class="token punctuation">)</span>



    <span class="token comment">// 1.2. sql</span>
    tabEnv<span class="token punctuation">.</span>createTemporaryView<span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span>
    <span class="token keyword">val</span> sqlResultTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span>
      <span class="token string">"""
        |select
        | id,
        | count(id),
        | avg(temperature),
        | tumble_end(ts, interval '10' second)
        |from sensor
        |group by
        | id,
        | tumble(ts, interval '10' second)
        |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>

    <span class="token comment">//        timeResultTable.printSchema()</span>


    <span class="token comment">// 2. Over window: 统计每个sensor每条数据，与之前两行数据的平均温度</span>
    <span class="token comment">// 2.1. table api</span>
    <span class="token keyword">val</span> overResultTable<span class="token operator">:</span> Table <span class="token operator">=</span> sensorTable
      <span class="token punctuation">.</span>window<span class="token punctuation">(</span>Over partitionBy $<span class="token string">"id"</span> orderBy $<span class="token string">"ts"</span> preceding <span class="token number">2.</span>rows as $<span class="token string">"ow"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span>select<span class="token punctuation">(</span><span class="token string">"$id"</span><span class="token punctuation">,</span> $<span class="token string">"ts"</span><span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">.</span>count over $<span class="token string">"ow"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">.</span>avg over $<span class="token string">"ow"</span><span class="token punctuation">)</span>

    <span class="token comment">// 2.2. sql</span>
    <span class="token keyword">val</span> sqlOverWindowResult<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span>
      <span class="token string">"""
        |select
        | id,
        | ts,
        | count(id) over ow,
        | avg(temperature) over ow
        |from sensor
        |window ow as (
        | partition by id
        | order by ts
        | rows between 2 preceding and current row
        |)
        |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>

    tabEnv<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>
    tabEnv<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>sqlResultTable<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"sql"</span><span class="token punctuation">)</span>

    env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"time and window test"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="7__121"></a>7. 函数</h2> 
<h3><a id="71_scalar_122"></a>7.1. 一对一，scalar函数</h3> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> sensorTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">,</span> $<span class="token string">"timestamp"</span><span class="token punctuation">.</span>rowtime<span class="token punctuation">(</span><span class="token punctuation">)</span> as <span class="token string">"ts"</span><span class="token punctuation">)</span>

<span class="token comment">// 调用自定义函数，对id进行hash运算</span>
<span class="token comment">// 1. table api</span>
<span class="token keyword">val</span> hashCode <span class="token operator">=</span> <span class="token keyword">new</span> HashCode<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token keyword">val</span> resultTable<span class="token operator">:</span> Table <span class="token operator">=</span> sensorTable
  <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"ts"</span><span class="token punctuation">,</span> hashCode<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 2. sql</span>
tabEnv<span class="token punctuation">.</span>createTemporaryView<span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span>
<span class="token comment">// 注册函数</span>
tabEnv<span class="token punctuation">.</span>createTemporaryFunction<span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">,</span> hashCode<span class="token punctuation">)</span>

<span class="token keyword">val</span> resultSqlTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span><span class="token string">"select id, ts, hashCode(id) from sensor"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token comment">/**
 * 自定义标量函数
 */</span>
<span class="token keyword">class</span> HashCode<span class="token punctuation">(</span>factor<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> ScalarFunction <span class="token punctuation">{<!-- --></span>

  <span class="token comment">// 这个函数名字不能变</span>
  <span class="token keyword">def</span> eval<span class="token punctuation">(</span>s<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    s<span class="token punctuation">.</span>hashCode <span class="token operator">*</span> factor <span class="token operator">-</span> <span class="token number">10000</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>一对多<br> <img src="https://images2.imgbox.com/7b/26/o02zbtJa_o.png" alt="在这里插入图片描述"></li></ul> 
<pre><code class="prism language-scala"> <span class="token keyword">val</span> sensorTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">,</span> $<span class="token string">"timestamp"</span><span class="token punctuation">.</span>rowtime<span class="token punctuation">(</span><span class="token punctuation">)</span> as <span class="token string">"ts"</span><span class="token punctuation">)</span>

 <span class="token comment">// 调用自定义函数，对id进行hash运算</span>
 <span class="token comment">// 1. table api</span>
 <span class="token keyword">val</span> split <span class="token operator">=</span> <span class="token keyword">new</span> Split<span class="token punctuation">(</span><span class="token string">"_"</span><span class="token punctuation">)</span>
 <span class="token keyword">val</span> resultTable<span class="token operator">:</span> Table <span class="token operator">=</span> sensorTable
   <span class="token punctuation">.</span>joinLateral<span class="token punctuation">(</span>split<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span> as<span class="token punctuation">(</span><span class="token string">"word"</span><span class="token punctuation">,</span> <span class="token string">"length"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
   <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">,</span> $<span class="token string">"word"</span><span class="token punctuation">,</span> $<span class="token string">"length"</span><span class="token punctuation">)</span>

 <span class="token comment">// 2. sql</span>
 tabEnv<span class="token punctuation">.</span>createTemporaryView<span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span>
 tabEnv<span class="token punctuation">.</span>createTemporaryFunction<span class="token punctuation">(</span><span class="token string">"split"</span><span class="token punctuation">,</span> split<span class="token punctuation">)</span>

 <span class="token keyword">val</span> sqlResultTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span>
   <span class="token string">"""
     |select
     | id, ts, word, length
     |from
     | sensor, lateral table( split(id) ) as splitid (word, length)
     |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>


 tabEnv<span class="token punctuation">.</span>toAppendStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>sqlResultTable<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"sql "</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token comment">/**
 * 自定义Table函数
 */</span>

<span class="token keyword">class</span> Split<span class="token punctuation">(</span><span class="token keyword">var</span> separator<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> TableFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> eval<span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    str<span class="token punctuation">.</span>split<span class="token punctuation">(</span>separator<span class="token punctuation">)</span><span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>
      word <span class="token keyword">=&gt;</span> collect<span class="token punctuation">(</span><span class="token punctuation">(</span>word<span class="token punctuation">,</span> word<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>多对一 聚合函数</li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> sensorTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">,</span> $<span class="token string">"timestamp"</span><span class="token punctuation">.</span>rowtime<span class="token punctuation">(</span><span class="token punctuation">)</span> as <span class="token string">"ts"</span><span class="token punctuation">)</span>

<span class="token comment">// table api</span>
<span class="token keyword">val</span> avgTemp <span class="token operator">=</span> <span class="token keyword">new</span> AvgTemp
tabEnv<span class="token punctuation">.</span>createTemporaryFunction<span class="token punctuation">(</span><span class="token string">"avgTemp"</span><span class="token punctuation">,</span> avgTemp<span class="token punctuation">)</span>

<span class="token keyword">val</span> resultTable<span class="token operator">:</span> Table <span class="token operator">=</span> sensorTable
  <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>aggregate<span class="token punctuation">(</span>avgTemp<span class="token punctuation">(</span>$<span class="token string">"temperature"</span><span class="token punctuation">)</span> as <span class="token string">"avgTemp"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"avgTemp"</span><span class="token punctuation">)</span>

<span class="token comment">// sql</span>
tabEnv<span class="token punctuation">.</span>createTemporaryView<span class="token punctuation">(</span><span class="token string">"sensor"</span><span class="token punctuation">,</span> sensorTable<span class="token punctuation">)</span>
<span class="token keyword">val</span> sqlTableResult<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>sqlQuery<span class="token punctuation">(</span>
  <span class="token string">"""
    |select id, avgTemp(temperature)
    |from
    |sensor
    |group by id
    |"""</span><span class="token punctuation">.</span>stripMargin<span class="token punctuation">)</span>

tabEnv<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>sqlTableResult<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> AvgTempAcc<span class="token punctuation">(</span><span class="token keyword">var</span> sum<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token keyword">var</span> count<span class="token operator">:</span> <span class="token builtin">Int</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * 自定义聚合函数，求每个传感器的平均温度值， 保存状态（tempSum, tempCount）
 */</span>
<span class="token keyword">class</span> AvgTemp <span class="token keyword">extends</span> AggregateFunction<span class="token punctuation">[</span><span class="token builtin">Double</span><span class="token punctuation">,</span> AvgTempAcc<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">def</span> accumulate<span class="token punctuation">(</span>accumulator<span class="token operator">:</span> AvgTempAcc<span class="token punctuation">,</span> temp<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    accumulator<span class="token punctuation">.</span>sum <span class="token operator">+=</span> temp
    accumulator<span class="token punctuation">.</span>count <span class="token operator">+=</span> <span class="token number">1</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> getValue<span class="token punctuation">(</span>accumulator<span class="token operator">:</span> AvgTempAcc<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> accumulator<span class="token punctuation">.</span>sum <span class="token operator">/</span> accumulator<span class="token punctuation">.</span>count

  <span class="token keyword">override</span> <span class="token keyword">def</span> createAccumulator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> AvgTempAcc <span class="token operator">=</span> AvgTempAcc<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>多对多 – 表聚合函数<br> <img src="https://images2.imgbox.com/f5/9a/7l0nGCiN_o.png" alt="在这里插入图片描述"></li></ul> 
<pre><code class="prism language-scala"><span class="token keyword">val</span> sensorTable<span class="token operator">:</span> Table <span class="token operator">=</span> tabEnv<span class="token punctuation">.</span>fromDataStream<span class="token punctuation">(</span>dataStream<span class="token punctuation">,</span> $<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temperature"</span><span class="token punctuation">,</span> $<span class="token string">"timestamp"</span><span class="token punctuation">.</span>rowtime<span class="token punctuation">(</span><span class="token punctuation">)</span> as <span class="token string">"ts"</span><span class="token punctuation">)</span>

<span class="token comment">// table api</span>
<span class="token keyword">val</span> top2Temp <span class="token operator">=</span> <span class="token keyword">new</span> Top2Temp
tabEnv<span class="token punctuation">.</span>registerFunction<span class="token punctuation">(</span><span class="token string">"top2Temp"</span><span class="token punctuation">,</span> top2Temp<span class="token punctuation">)</span>

<span class="token keyword">val</span> resultTable<span class="token operator">:</span> Table <span class="token operator">=</span> sensorTable
  <span class="token punctuation">.</span>groupBy<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>flatAggregate<span class="token punctuation">(</span>top2Temp<span class="token punctuation">(</span>$<span class="token string">"temperature"</span><span class="token punctuation">)</span> as <span class="token punctuation">(</span><span class="token string">"temp"</span><span class="token punctuation">,</span> <span class="token string">"rank"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>select<span class="token punctuation">(</span>$<span class="token string">"id"</span><span class="token punctuation">,</span> $<span class="token string">"temp"</span><span class="token punctuation">,</span> $<span class="token string">"rank"</span><span class="token punctuation">)</span>

tabEnv<span class="token punctuation">.</span>toRetractStream<span class="token punctuation">[</span>Row<span class="token punctuation">]</span><span class="token punctuation">(</span>resultTable<span class="token punctuation">)</span><span class="token punctuation">.</span>print<span class="token punctuation">(</span><span class="token string">"table"</span><span class="token punctuation">)</span>


env<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"function test"</span><span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-scala"><span class="token keyword">case</span> <span class="token keyword">class</span> Top2TempAcc<span class="token punctuation">(</span><span class="token keyword">var</span> highestTemp<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token builtin">Double</span><span class="token punctuation">.</span>MinValue<span class="token punctuation">,</span> <span class="token keyword">var</span> secondHighestTemp<span class="token operator">:</span> <span class="token builtin">Double</span> <span class="token operator">=</span> <span class="token builtin">Double</span><span class="token punctuation">.</span>MinValue<span class="token punctuation">)</span>

<span class="token comment">/**
 * 自定义表聚合函数，提取素有温度值中最高的两个温度， 输入（temp，rank）
 */</span>
<span class="token keyword">class</span> Top2Temp <span class="token keyword">extends</span> TableAggregateFunction<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Top2TempAcc<span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> createAccumulator<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Top2TempAcc <span class="token operator">=</span> Top2TempAcc<span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token comment">// 实现计算聚合结果的函数</span>
  <span class="token keyword">def</span> accumulate<span class="token punctuation">(</span>acc<span class="token operator">:</span> Top2TempAcc<span class="token punctuation">,</span> temp<span class="token operator">:</span> <span class="token builtin">Double</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> acc<span class="token punctuation">.</span>highestTemp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      acc<span class="token punctuation">.</span>secondHighestTemp <span class="token operator">=</span> acc<span class="token punctuation">.</span>highestTemp
      acc<span class="token punctuation">.</span>highestTemp <span class="token operator">=</span> temp
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>temp <span class="token operator">&gt;</span> acc<span class="token punctuation">.</span>secondHighestTemp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      acc<span class="token punctuation">.</span>secondHighestTemp <span class="token operator">=</span> temp
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 实现一个输出结果的方法， 追中处理完表中所有数据时调用, 方法名不能变</span>
  <span class="token keyword">def</span> emitValue<span class="token punctuation">(</span>acc<span class="token operator">:</span> Top2TempAcc<span class="token punctuation">,</span> out<span class="token operator">:</span> Collector<span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token builtin">Double</span><span class="token punctuation">,</span> <span class="token builtin">Int</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span>highestTemp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    out<span class="token punctuation">.</span>collect<span class="token punctuation">(</span><span class="token punctuation">(</span>acc<span class="token punctuation">.</span>secondHighestTemp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a84d132d52136cd40ee7d300d361fb9d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">element ui table 组件固定列踩坑 使用doLayout</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ad34ca76a1d6a6af66a18dde6f629695/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">u盘格式化后如何恢复数据，三步轻松恢复！</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>