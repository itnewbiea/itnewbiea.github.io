<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>opencv dnn模块 示例(23) 目标检测 object_detection 之 yolov8 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="opencv dnn模块 示例(23) 目标检测 object_detection 之 yolov8" />
<meta property="og:description" content="文章目录 1、YOLOv8介绍1.1、概述1.2、骨干网络和 Neck1.3、Loss 计算1.4、数据增强1.5、训练策略1.6、推理过程 2、测试2.1、官方Python测试2.2、Opencv dnn测试2.3、测试统计 3、训练4、Yolov8-pose 简单使用 1、YOLOv8介绍 YOLOv3之前的所有YOLO对象检测模型都是用C语言编写的，并使用了Darknet框架，Ultralytics发布了第一个使用PyTorch框架实现的YOLO (YOLOv3)；YOLOv3之后，Ultralytics发布了YOLOv5，在2023年1月，Ultralytics发布了YOLOv8，包含五个模型，用于检测、分割和分类。 YOLOv8 Nano是其中最快和最小的，而YOLOv8 Extra Large (YOLOv8x)是其中最准确但最慢的，具体模型见后续的图。
YOLOv8附带以下预训练模型:
目标检测在图像分辨率为640的COCO检测数据集上进行训练。实例分割在图像分辨率为640的COCO分割数据集上训练。图像分类模型在ImageNet数据集上预训练，图像分辨率为224。 1.1、概述 心特性和改动可以归结为如下：
提供了一个全新的SOTA模型（state-of-the-art model），包括 P5 640 和 P6 1280 分辨率的目标检测网络和基于YOLACT的实例分割模型。和 YOLOv5 一样，基于缩放系数也提供了 N/S/M/L/X 尺度的不同大小模型，用于满足不同场景需求骨干网络和 Neck 部分可能参考了 YOLOv7 ELAN 设计思想，将 YOLOv5 的 C3 结构换成了梯度流更丰富的 C2f 结构，并对不同尺度模型调整了不同的通道数，属于对模型结构精心微调，不再是一套参数应用所有模型，大幅提升了模型性能。Head 部分相比 YOLOv5 改动较大，换成了目前主流的解耦头结构，将分类和检测头分离，同时也从Anchor-Based 换成了 Anchor-FreeLoss 计算方面采用了TaskAlignedAssigner正样本分配策略，并引入了Distribution Focal Loss训练的数据增强部分引入了 YOLOX 中的最后 10 epoch 关闭 Mosiac 增强的操作，可以有效地提升精度 1.2、骨干网络和 Neck 骨干网络和 Neck 部分可能参考了 YOLOv7 ELAN 设计思想，将 YOLOv5 的 C3 结构换成了梯度流更丰富的 C2f 结构，并对不同尺度模型调整了不同的通道数，属于对模型结构精心微调，不再是一套参数应用所有模型，大幅提升了模型性能。 具体改动为：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/fc4de3c49667a417422ed507f3438dfc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-17T21:30:00+08:00" />
<meta property="article:modified_time" content="2023-11-17T21:30:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">opencv dnn模块 示例(23) 目标检测 object_detection 之 yolov8</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1YOLOv8_2" rel="nofollow">1、YOLOv8介绍</a></li><li><ul><li><a href="#11_10" rel="nofollow">1.1、概述</a></li><li><a href="#12_Neck_19" rel="nofollow">1.2、骨干网络和 Neck</a></li><li><a href="#13Loss__34" rel="nofollow">1.3、Loss 计算</a></li><li><a href="#14_52" rel="nofollow">1.4、数据增强</a></li><li><a href="#15_59" rel="nofollow">1.5、训练策略</a></li><li><a href="#16_61" rel="nofollow">1.6、推理过程</a></li></ul> 
  </li><li><a href="#2_89" rel="nofollow">2、测试</a></li><li><ul><li><a href="#21Python_94" rel="nofollow">2.1、官方Python测试</a></li><li><a href="#22Opencv_dnn_117" rel="nofollow">2.2、Opencv dnn测试</a></li><li><a href="#23_395" rel="nofollow">2.3、测试统计</a></li></ul> 
  </li><li><a href="#3_407" rel="nofollow">3、训练</a></li><li><a href="#4Yolov8pose__472" rel="nofollow">4、Yolov8-pose 简单使用</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1YOLOv8_2"></a>1、YOLOv8介绍</h2> 
<p>YOLOv3之前的所有YOLO对象检测模型都是用C语言编写的，并使用了Darknet框架，Ultralytics发布了第一个使用PyTorch框架实现的YOLO (YOLOv3)；YOLOv3之后，Ultralytics发布了YOLOv5，在2023年1月，Ultralytics发布了YOLOv8，包含五个模型，用于检测、分割和分类。 YOLOv8 Nano是其中最快和最小的，而YOLOv8 Extra Large (YOLOv8x)是其中最准确但最慢的，具体模型见后续的图。</p> 
<p>YOLOv8附带以下预训练模型:</p> 
<ul><li>目标检测在图像分辨率为640的COCO检测数据集上进行训练。</li><li>实例分割在图像分辨率为640的COCO分割数据集上训练。</li><li>图像分类模型在ImageNet数据集上预训练，图像分辨率为224。</li></ul> 
<h3><a id="11_10"></a>1.1、概述</h3> 
<p>心特性和改动可以归结为如下：</p> 
<ol><li>提供了一个全新的SOTA模型（state-of-the-art model），包括 P5 640 和 P6 1280 分辨率的目标检测网络和基于YOLACT的实例分割模型。和 YOLOv5 一样，基于缩放系数也提供了 N/S/M/L/X 尺度的不同大小模型，用于满足不同场景需求</li><li>骨干网络和 Neck 部分可能参考了 YOLOv7 ELAN 设计思想，将 YOLOv5 的 C3 结构换成了梯度流更丰富的 C2f 结构，并对不同尺度模型调整了不同的通道数，属于对模型结构精心微调，不再是一套参数应用所有模型，大幅提升了模型性能。</li><li>Head 部分相比 YOLOv5 改动较大，换成了目前主流的解耦头结构，将分类和检测头分离，同时也从Anchor-Based 换成了 Anchor-Free</li><li>Loss 计算方面采用了TaskAlignedAssigner正样本分配策略，并引入了Distribution Focal Loss</li><li>训练的数据增强部分引入了 YOLOX 中的最后 10 epoch 关闭 Mosiac 增强的操作，可以有效地提升精度</li></ol> 
<p><img src="https://images2.imgbox.com/c1/85/CMvapLzT_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="12_Neck_19"></a>1.2、骨干网络和 Neck</h3> 
<p>骨干网络和 Neck 部分可能参考了 YOLOv7 ELAN 设计思想，将 YOLOv5 的 C3 结构换成了梯度流更丰富的 C2f 结构，并对不同尺度模型调整了不同的通道数，属于对模型结构精心微调，不再是一套参数应用所有模型，大幅提升了模型性能。 具体改动为：</p> 
<ul><li> <p>第一个卷积层的 kernel 从 6x6 变成了 3x3</p> </li><li> <p>所有的 C3 模块换成 C2f，可以发现多了更多的跳层连接和额外的 Split 操作<br> <img src="https://images2.imgbox.com/ac/69/uuXnxcmv_o.png" alt="参看openmmlab"></p> </li><li> <p>去掉了 Neck 模块中的 2 个卷积连接层</p> </li><li> <p>Backbone 中 C2f 的block 数从 3-6-9-3 改成了 3-6-6-3</p> </li><li> <p>查看 N/S/M/L/X 等不同大小模型，可以发现 N/S 和 L/X 两组模型只是改了缩放系数，但是 S/M/L 等骨干网络的通道数设置不一样，没有遵循同一套缩放系数。如此设计的原因应该是同一套缩放系数下的通道设置不是最优设计，YOLOv7 网络设计时也没有遵循一套缩放系数作用于所有模型</p> </li></ul> 
<p>Head 部分变化最大，从原先的耦合头变成了解耦头，并且从 YOLOv5 的 Anchor-Based 变成了 Anchor-Free。其结构如下所示：<br> <img src="https://images2.imgbox.com/88/9c/JVqTM9gH_o.png" alt="参看openmmlab"><br> 可以看出，不再有之前的 objectness 分支，只有解耦的分类和回归分支，并且其回归分支使用了 Distribution Focal Loss 中提出的积分形式表示法，</p> 
<h3><a id="13Loss__34"></a>1.3、Loss 计算</h3> 
<p>Loss 计算过程包括 2 个部分： 正负样本分配策略和 Loss 计算。</p> 
<p>现代目标检测器大部分都会在正负样本分配策略上面做文章，典型的如 YOLOX 的 simOTA、TOOD 的 TaskAlignedAssigner 和 RTMDet 的 DynamicSoftLabelAssigner，这类 Assigner 大都是动态分配策略，而 YOLOv5 采用的依然是静态分配策略。考虑到动态分配策略的优异性，YOLOv8 算法中则直接引用了 TOOD 的 TaskAlignedAssigner。</p> 
<p>TaskAlignedAssigner 的匹配策略简单总结为： <strong>根据分类与回归的分数加权的分数选择正样本。</strong></p> 
<p>s 是标注类别对应的预测分值，u 是预测框和 gt 框的 iou，两者相乘就可以衡量对齐程度。</p> 
<ol><li>对于每一个 GT，对所有的预测框基于 GT 类别对应分类分数，预测框与 GT 的 IoU 的加权得到一个关联分类以及回归的对齐分数 alignment_metrics</li><li>对于每一个 GT，直接基于 alignment_metrics 对齐分数选取 topK 大的作为正样本</li></ol> 
<p>Loss 计算包括 2 个分支： 分类和回归分支，没有了之前的 objectness 分支。</p> 
<ul><li>分类分支依然采用 BCE Loss</li><li>回归分支需要和 Distribution Focal Loss 中提出的积分形式表示法绑定，因此使用了 Distribution Focal Loss， 同时还使用了 CIoU Loss</li></ul> 
<ol start="3"><li>3 个 Loss 采用一定权重比例加权即可。</li></ol> 
<h3><a id="14_52"></a>1.4、数据增强</h3> 
<p>数据增强方面和 YOLOv5 差距不大，只不过引入了 YOLOX 中提出的最后 10 个 epoch 关闭 Mosaic 的操作。假设训练 epoch 是 500，其示意图如下左所示：<br> <img src="https://images2.imgbox.com/45/17/8X5MXeFQ_o.png" alt="在这里插入图片描述"></p> 
<p>数据增强后典型效果上右所示：考虑到不同模型应该采用的数据增强强度不一样，因此对于不同大小模型，有部分超参会进行修改，典型的如大模型会开启 MixUp 和 CopyPaste。</p> 
<h3><a id="15_59"></a>1.5、训练策略</h3> 
<p>YOLOv8 的训练策略和 YOLOv5 没有啥区别，最大区别就是模型的 训练总 epoch 数从 300 提升到了 500，这也导致训练时间急剧增加。</p> 
<h3><a id="16_61"></a>1.6、推理过程</h3> 
<p>YOLOv8 的推理过程和 YOLOv5 几乎一样，唯一差别在于前面需要对 Distribution Focal Loss 中的积分表示 bbox 形式进行解码，变成常规的 4 维度 bbox，后续计算过程就和 YOLOv5 一样了。</p> 
<p>以 COCO 80 类为例，假设输入图片大小为 640x640，MMYOLO 中实现的推理过程示意图如下所示：</p> 
<p>暂时无法在飞书文档外展示此内容</p> 
<p>其推理和后处理过程为：</p> 
<p><strong>(1) bbox 积分形式转换为 4d bbox 格式</strong><br> 对 Head 输出的 bbox 分支进行转换，利用 Softmax 和 Conv 计算将积分形式转换为 4 维 bbox 格式</p> 
<p><strong>(2) 维度变换</strong><br> YOLOv8 输出特征图尺度为 80x80、40x40 和 20x20 的三个特征图。Head 部分输出分类和回归共 6 个尺度的特征图。</p> 
<p>将 3 个不同尺度的类别预测分支、bbox 预测分支进行拼接，并进行维度变换。为了后续方便处理，会将原先的通道维度置换到最后，类别预测分支 和 bbox 预测分支 shape 分别为 (b, 80x80+40x40+20x20, 80)=(b,8400,80)，<strong>(b,8400,4)</strong>。</p> 
<p><strong>(3) 解码还原到原图尺度</strong><br> 分类预测分支进行 Sigmoid 计算，而 bbox 预测分支需要进行解码，还原为真实的原图解码后 xyxy 格式。</p> 
<p><strong>(4) 阈值过滤</strong><br> 遍历 batch 中的每张图，采用 score_thr 进行阈值过滤。在这过程中还需要考虑 multi_label 和 nms_pre，确保过滤后的检测框数目不会多于 nms_pre。</p> 
<p><strong>(5) 还原到原图尺度和 nms</strong><br> 基于前处理过程，将剩下的检测框还原到网络输出前的原图尺度，然后进行 nms 即可。最终输出的检测框不能多于 max_per_img。</p> 
<p>有一个特别注意的点：YOLOv5 中采用的 Batch shape 推理策略，在 YOLOv8 推理中暂时没有开启，不清楚后面是否会开启，在 MMYOLO 中快速测试了下，如果开启 Batch shape 会涨大概 0.1~0.2。</p> 
<h2><a id="2_89"></a>2、测试</h2> 
<p>使用Pip在一个Python&gt;=3.8环境中安装ultralytics包，此环境还需包含PyTorch&gt;=1.8。这也会安装所有必要的依赖项。</p> 
<pre><code>pip install ultralytics
</code></pre> 
<h3><a id="21Python_94"></a>2.1、官方Python测试</h3> 
<p>YOLOv8 可以在命令行界面（CLI）中直接使用，只需输入 yolo 命令：</p> 
<pre><code>yolo predict model=yolov8n.pt source='https://ultralytics.com/images/bus.jpg'
</code></pre> 
<p>以 <a href="https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8m.pt">coco数据集训练的 yolov8m.pt</a> 进行测试为例，执行脚本为 <code>yolo predict model=yolov8m.pt source=bus.jpg device=0</code>，运行输出如下</p> 
<pre><code>(yolo_pytorch) E:\yolov8-ultralytics&gt;yolo predict model=yolov8m.pt source='https://ultralytics.com/images/bus.jpg' device=0
Ultralytics YOLOv8.0.154  Python-3.9.16 torch-1.13.1+cu117 CUDA:0 (NVIDIA GeForce GTX 1080 Ti, 11264MiB)
YOLOv8m summary (fused): 218 layers, 25886080 parameters, 0 gradients, 78.9 GFLOPs

Found https://ultralytics.com/images/bus.jpg locally at bus.jpg
image 1/1 E:\DeepLearning\yolov8-ultralytics\bus.jpg: 640x480 4 persons, 1 bus, 19.0ms
Speed: 3.0ms preprocess, 19.0ms inference, 4.0ms postprocess per image at shape (1, 3, 640, 480)
Results saved to runs\detect\predict9
</code></pre> 
<p>首次运行时，会自动下载最新的模型文件。</p> 
<p>cpu 和 gpu的时间<br> <strong>CPU</strong> 3.0ms preprocess, 447.6ms inference, 1.0ms postprocess<br> <strong>GPU</strong> 3.0ms preprocess, 19.0ms inference, 4.0ms postprocess</p> 
<h3><a id="22Opencv_dnn_117"></a>2.2、Opencv dnn测试</h3> 
<p>按照惯例将pt转换为onnx模型<br> <code>yolo detect export model=yolov8m.pt format=onnx imgsz=640,640</code><br> 输出如下：</p> 
<pre><code>(yolo_pytorch) E:\DeepLearning\yolov8-ultralytics&gt;yolo detect export model=yolov8m.pt format=onnx imgsz=640,640
Ultralytics YOLOv8.0.154  Python-3.9.16 torch-1.13.1+cu117 CPU (Intel Core(TM) i7-7700K 4.20GHz)
YOLOv8m summary (fused): 218 layers, 25886080 parameters, 0 gradients, 78.9 GFLOPs

PyTorch: starting from 'yolov8m.pt' with input shape (1, 3, 640, 640) BCHW and output shape(s) (1, 84, 8400) (49.7 MB)

ONNX: starting export with onnx 1.14.0 opset 16...
ONNX: export success  3.3s, saved as 'yolov8m.onnx' (99.0 MB)

Export complete (7.4s)
Results saved to E:\DeepLearning\yolov8-ultralytics
Predict:         yolo predict task=detect model=yolov8m.onnx imgsz=640
Validate:        yolo val task=detect model=yolov8m.onnx imgsz=640 data=coco.yaml
Visualize:       https://netron.app
</code></pre> 
<p>注意，模型输出和前面版本的维度、顺序不一致，这里为 [84, 8400]，因此，依然沿用之前的代码，对后处理的解码部分略作修改。</p> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"opencv2/opencv.hpp"</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;fstream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;sstream&gt;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;random&gt;</span></span>

using namespace cv<span class="token punctuation">;</span>
using namespace dnn<span class="token punctuation">;</span>

<span class="token keyword">float</span> inpWidth<span class="token punctuation">;</span>
<span class="token keyword">float</span> inpHeight<span class="token punctuation">;</span>
<span class="token keyword">float</span> confThreshold<span class="token punctuation">,</span> scoreThreshold<span class="token punctuation">,</span> nmsThreshold<span class="token punctuation">;</span>
std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>string<span class="token operator">&gt;</span> classes<span class="token punctuation">;</span>
std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Scalar<span class="token operator">&gt;</span> colors<span class="token punctuation">;</span>


bool letterBoxForSquare <span class="token operator">=</span> true<span class="token punctuation">;</span>

cv<span class="token operator">::</span>Mat <span class="token function">formatToSquare</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token operator">::</span>Mat <span class="token operator">&amp;</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> cv<span class="token operator">::</span>Size inputSz<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Mat<span class="token operator">&gt;</span><span class="token operator">&amp;</span> out<span class="token punctuation">,</span> Net<span class="token operator">&amp;</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">drawPred</span><span class="token punctuation">(</span><span class="token keyword">int</span> classId<span class="token punctuation">,</span> <span class="token keyword">float</span> conf<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>

std<span class="token operator">::</span>random_device rd<span class="token punctuation">;</span>
std<span class="token operator">::</span>mt19937 <span class="token function">gen</span><span class="token punctuation">(</span><span class="token function">rd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
std<span class="token operator">::</span>uniform_int_distribution<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">dis</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token comment">// 根据选择的检测模型文件进行配置 </span>
    confThreshold <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">;</span>
    scoreThreshold <span class="token operator">=</span> <span class="token number">0.45</span><span class="token punctuation">;</span>
    nmsThreshold <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> scale <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token number">255.0</span><span class="token punctuation">;</span>  <span class="token comment">//0.00392</span>
    Scalar mean <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    bool swapRB <span class="token operator">=</span> true<span class="token punctuation">;</span>
    inpWidth <span class="token operator">=</span> <span class="token number">640</span><span class="token punctuation">;</span>
    inpHeight <span class="token operator">=</span> <span class="token number">640</span><span class="token punctuation">;</span>
    
    String modelPath <span class="token operator">=</span> R<span class="token string">"(E:\DeepLearning\yolov8-ultralytics\yolov8m.onnx)"</span><span class="token punctuation">;</span>
    String configPath<span class="token punctuation">;</span>

    String framework <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>

    <span class="token comment">//int backendId = cv::dnn::DNN_BACKEND_OPENCV;</span>
    <span class="token comment">//int targetId = cv::dnn::DNN_TARGET_CPU;    //cpu  350ms,   opencl 310</span>
    <span class="token keyword">int</span> backendId <span class="token operator">=</span> cv<span class="token operator">::</span>dnn<span class="token operator">::</span>DNN_BACKEND_CUDA<span class="token punctuation">;</span>
    <span class="token keyword">int</span> targetId <span class="token operator">=</span> cv<span class="token operator">::</span>dnn<span class="token operator">::</span>DNN_TARGET_CUDA<span class="token punctuation">;</span>       <span class="token comment">// cuda  15ms</span>

    String classesFile <span class="token operator">=</span> R<span class="token string">"(\data\coco.names)"</span><span class="token punctuation">;</span>

    <span class="token comment">// Open file with classes names.</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>classesFile<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">const</span> std<span class="token operator">::</span>string<span class="token operator">&amp;</span> file <span class="token operator">=</span> classesFile<span class="token punctuation">;</span>
        std<span class="token operator">::</span>ifstream <span class="token function">ifs</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ifs<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">CV_Error</span><span class="token punctuation">(</span>Error<span class="token operator">::</span>StsError<span class="token punctuation">,</span> <span class="token string">"File "</span> <span class="token operator">+</span> file <span class="token operator">+</span> <span class="token string">" not found"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>string line<span class="token punctuation">;</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">getline</span><span class="token punctuation">(</span>ifs<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            classes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            colors<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token function">dis</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dis</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">dis</span><span class="token punctuation">(</span>gen<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// Load a model.</span>
    Net net <span class="token operator">=</span> <span class="token function">readNet</span><span class="token punctuation">(</span>modelPath<span class="token punctuation">,</span> configPath<span class="token punctuation">,</span> framework<span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">setPreferableBackend</span><span class="token punctuation">(</span>backendId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">setPreferableTarget</span><span class="token punctuation">(</span>targetId<span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> outNames <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">getUnconnectedOutLayersNames</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//std::vector&lt;String&gt; outNames{"output"};</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>backendId <span class="token operator">==</span> cv<span class="token operator">::</span>dnn<span class="token operator">::</span>DNN_BACKEND_CUDA<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> dims<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>inpHeight<span class="token punctuation">,</span>inpWidth<span class="token punctuation">}</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span>Mat tmp <span class="token operator">=</span> cv<span class="token operator">::</span>Mat<span class="token operator">::</span><span class="token function">zeros</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> dims<span class="token punctuation">,</span> CV_32F<span class="token punctuation">)</span><span class="token punctuation">;</span>
        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Mat<span class="token operator">&gt;</span> outs<span class="token punctuation">;</span>

        net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>outs<span class="token punctuation">,</span> outNames<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// warmup</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Create a window</span>
    <span class="token keyword">static</span> <span class="token keyword">const</span> std<span class="token operator">::</span>string kWinName <span class="token operator">=</span> <span class="token string">"Deep learning object detection in OpenCV"</span><span class="token punctuation">;</span>

    cv<span class="token operator">::</span><span class="token function">namedWindow</span><span class="token punctuation">(</span>kWinName<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Open a video file or an image file or a camera stream.</span>
    VideoCapture cap<span class="token punctuation">;</span>
    cap<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span>R<span class="token string">"(E:\DeepLearning\yolov5\data\images\bus.jpg)"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    cv<span class="token operator">::</span>TickMeter tk<span class="token punctuation">;</span>
    <span class="token comment">// Process frames.</span>
    Mat frame<span class="token punctuation">,</span> blob<span class="token punctuation">;</span>

    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">//tk.reset();</span>
        <span class="token comment">//tk.start();</span>

        cap <span class="token operator">&gt;&gt;</span> frame<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>frame<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Create a 4D blob from a frame.</span>
        cv<span class="token operator">::</span>Mat modelInput <span class="token operator">=</span> frame<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>letterBoxForSquare <span class="token operator">&amp;&amp;</span> inpWidth <span class="token operator">==</span> inpHeight<span class="token punctuation">)</span>
            modelInput <span class="token operator">=</span> <span class="token function">formatToSquare</span><span class="token punctuation">(</span>modelInput<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">blobFromImage</span><span class="token punctuation">(</span>modelInput<span class="token punctuation">,</span> blob<span class="token punctuation">,</span> scale<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Size2f</span><span class="token punctuation">(</span>inpWidth<span class="token punctuation">,</span> inpHeight<span class="token punctuation">)</span><span class="token punctuation">,</span> mean<span class="token punctuation">,</span> swapRB<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Run a model.</span>
        net<span class="token punctuation">.</span><span class="token function">setInput</span><span class="token punctuation">(</span>blob<span class="token punctuation">)</span><span class="token punctuation">;</span>

        std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Mat<span class="token operator">&gt;</span> outs<span class="token punctuation">;</span>
        <span class="token comment">//tk.reset();</span>
        <span class="token comment">//tk.start();</span>

        <span class="token keyword">auto</span> tt1 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        net<span class="token punctuation">.</span><span class="token function">forward</span><span class="token punctuation">(</span>outs<span class="token punctuation">,</span> outNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> tt2 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">tk.stop();</span>
        <span class="token function">postprocess</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> modelInput<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> outs<span class="token punctuation">,</span> net<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//tk.stop();</span>

        <span class="token comment"> Put efficiency information.</span>
        <span class="token comment">//std::vector&lt;double&gt; layersTimes;</span>
        <span class="token comment">//double freq = getTickFrequency() / 1000;</span>
        <span class="token comment">//double t = net.getPerfProfile(layersTimes) / freq;</span>
        <span class="token comment">//std::string label = format("Inference time: %.2f ms  (%.2f ms)", t, /*tk.getTimeMilli()*/ (tt2 - tt1) / cv::getTickFrequency() * 1000);</span>
        std<span class="token operator">::</span>string label <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"Inference time: %.2f ms"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tt2 <span class="token operator">-</span> tt1<span class="token punctuation">)</span> <span class="token operator">/</span> cv<span class="token operator">::</span><span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        cv<span class="token operator">::</span><span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//printf("\r%s\t", label.c_str());</span>

        cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span>kWinName<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


cv<span class="token operator">::</span>Mat <span class="token function">formatToSquare</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token operator">::</span>Mat <span class="token operator">&amp;</span>source<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> col <span class="token operator">=</span> source<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>
    <span class="token keyword">int</span> row <span class="token operator">=</span> source<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>
    <span class="token keyword">int</span> _max <span class="token operator">=</span> <span class="token function">MAX</span><span class="token punctuation">(</span>col<span class="token punctuation">,</span> row<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span>Mat result <span class="token operator">=</span> cv<span class="token operator">::</span>Mat<span class="token operator">::</span><span class="token function">zeros</span><span class="token punctuation">(</span>_max<span class="token punctuation">,</span> _max<span class="token punctuation">,</span> CV_8UC3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    source<span class="token punctuation">.</span><span class="token function">copyTo</span><span class="token punctuation">(</span><span class="token function">result</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> col<span class="token punctuation">,</span> row<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>



<span class="token keyword">void</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> cv<span class="token operator">::</span>Size inputSz<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Mat<span class="token operator">&gt;</span><span class="token operator">&amp;</span> outs<span class="token punctuation">,</span> Net<span class="token operator">&amp;</span> net<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// yolov8 has an output of shape (batchSize, 84, 8400) (Num classes + box[x,y,w,h] + confidence[c])</span>

    <span class="token keyword">auto</span> tt1 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> x_factor <span class="token operator">=</span> inputSz<span class="token punctuation">.</span>width <span class="token operator">/</span> inpWidth<span class="token punctuation">;</span>
    <span class="token keyword">float</span> y_factor <span class="token operator">=</span> inputSz<span class="token punctuation">.</span>height <span class="token operator">/</span> inpHeight<span class="token punctuation">;</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> class_ids<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> confidences<span class="token punctuation">;</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Rect<span class="token operator">&gt;</span> boxes<span class="token punctuation">;</span>

    <span class="token comment">//int rows = outs[0].size[1];</span>
    <span class="token comment">//int dimensions = outs[0].size[2];</span>

    <span class="token comment">// [1, 84, 8400] -&gt; [8400,84]</span>
    <span class="token keyword">int</span> rows <span class="token operator">=</span> outs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> dimensions <span class="token operator">=</span> outs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> tmp <span class="token operator">=</span> outs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">reshape</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dimensions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">transpose</span><span class="token punctuation">(</span>tmp<span class="token punctuation">,</span> tmp<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">float</span> <span class="token operator">*</span><span class="token punctuation">)</span>tmp<span class="token punctuation">.</span>data<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">//float confidence = data[4];</span>
        <span class="token comment">//if(confidence &gt;= confThreshold) {<!-- --></span>
            <span class="token keyword">float</span> <span class="token operator">*</span>classes_scores <span class="token operator">=</span> data <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">;</span>

            cv<span class="token operator">::</span>Mat <span class="token function">scores</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> classes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> CV_32FC1<span class="token punctuation">,</span> classes_scores<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span>Point class_id<span class="token punctuation">;</span>
            <span class="token keyword">double</span> max_class_score<span class="token punctuation">;</span>

            <span class="token function">minMaxLoc</span><span class="token punctuation">(</span>scores<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>max_class_score<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>class_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>max_class_score <span class="token operator">&gt;</span> scoreThreshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                confidences<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>max_class_score<span class="token punctuation">)</span><span class="token punctuation">;</span>
                class_ids<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>class_id<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token keyword">float</span> x <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> y <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> w <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> h <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

                <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> w<span class="token punctuation">)</span> <span class="token operator">*</span> x_factor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> top <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>y <span class="token operator">-</span> <span class="token number">0.5</span> <span class="token operator">*</span> h<span class="token punctuation">)</span> <span class="token operator">*</span> y_factor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> width <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>w <span class="token operator">*</span> x_factor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> height <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>h <span class="token operator">*</span> y_factor<span class="token punctuation">)</span><span class="token punctuation">;</span>

                boxes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token comment">//}</span>

        data <span class="token operator">+=</span> dimensions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> indices<span class="token punctuation">;</span>
    <span class="token function">NMSBoxes</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> scoreThreshold<span class="token punctuation">,</span> nmsThreshold<span class="token punctuation">,</span> indices<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> tt2 <span class="token operator">=</span> cv<span class="token operator">::</span><span class="token function">getTickCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    std<span class="token operator">::</span>string label <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"NMS time: %.2f ms"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>tt2 <span class="token operator">-</span> tt1<span class="token punctuation">)</span> <span class="token operator">/</span> cv<span class="token operator">::</span><span class="token function">getTickFrequency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> idx <span class="token operator">=</span> indices<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        Rect box <span class="token operator">=</span> boxes<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token function">drawPred</span><span class="token punctuation">(</span>class_ids<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> confidences<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> box<span class="token punctuation">.</span>x<span class="token punctuation">,</span> box<span class="token punctuation">.</span>y<span class="token punctuation">,</span>
                 box<span class="token punctuation">.</span>x <span class="token operator">+</span> box<span class="token punctuation">.</span>width<span class="token punctuation">,</span> box<span class="token punctuation">.</span>y <span class="token operator">+</span> box<span class="token punctuation">.</span>height<span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">drawPred</span><span class="token punctuation">(</span><span class="token keyword">int</span> classId<span class="token punctuation">,</span> <span class="token keyword">float</span> conf<span class="token punctuation">,</span> <span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> top<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">,</span> <span class="token keyword">int</span> bottom<span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>right<span class="token punctuation">,</span> bottom<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    std<span class="token operator">::</span>string label <span class="token operator">=</span> <span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%.2f"</span><span class="token punctuation">,</span> conf<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Scalar color <span class="token operator">=</span> Scalar<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>classes<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token function">CV_Assert</span><span class="token punctuation">(</span>classId <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span>classes<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        label <span class="token operator">=</span> classes<span class="token punctuation">[</span>classId<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> label<span class="token punctuation">;</span>
        color <span class="token operator">=</span> colors<span class="token punctuation">[</span>classId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">int</span> baseLine<span class="token punctuation">;</span>
    Size labelSize <span class="token operator">=</span> <span class="token function">getTextSize</span><span class="token punctuation">(</span>label<span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>baseLine<span class="token punctuation">)</span><span class="token punctuation">;</span>

    top <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>top<span class="token punctuation">,</span> labelSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">rectangle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top <span class="token operator">-</span> labelSize<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token function">Point</span><span class="token punctuation">(</span>left <span class="token operator">+</span> labelSize<span class="token punctuation">.</span>width<span class="token punctuation">,</span> top <span class="token operator">+</span> baseLine<span class="token punctuation">)</span><span class="token punctuation">,</span> color<span class="token punctuation">,</span> FILLED<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> label<span class="token punctuation">,</span> <span class="token function">Point</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">)</span><span class="token punctuation">,</span> FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="23_395"></a>2.3、测试统计</h3> 
<p>python (CPU)：447ms<br> python (GPU)：19ms</p> 
<p>opencv dnn(CPU)：<br> opencv dnn(GPU)：</p> 
<p>以下包含 预处理+推理+后处理：<br> openvino（CPU）：217ms<br> onnxruntime（GPU）：21ms<br> TensorRT：14ms</p> 
<h2><a id="3_407"></a>3、训练</h2> 
<p>这里基本和yolov5的训练一样，直接使用yolov5的数据集（<a href="https://blog.csdn.net/wanggao_1990/article/details/132758180">跳转yolov5训练的链接</a>），调整 train.txt、val.txt 和 myvoc.txt 中的路径。<br> <img src="https://images2.imgbox.com/c9/63/rrUl90W7_o.png" alt="在这里插入图片描述"></p> 
<p>以 yolov8m 为例，训练脚本如下：</p> 
<pre><code class="prism language-sh">yolo detect train <span class="token assign-left variable">data</span><span class="token operator">=</span>custom-data<span class="token punctuation">\</span>vehicle<span class="token punctuation">\</span>myvoc.yaml <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8m.pt <span class="token assign-left variable">epochs</span><span class="token operator">=</span><span class="token number">20</span>
</code></pre> 
<p>输出界面如下：</p> 
<pre><code class="prism language-sh"><span class="token punctuation">(</span>yolo_pytorch<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>DeepLearning<span class="token punctuation">\</span>yolov8-ultralytics<span class="token operator">&gt;</span>yolo detect train <span class="token assign-left variable">data</span><span class="token operator">=</span>custom-data<span class="token punctuation">\</span>vehicle<span class="token punctuation">\</span>myvoc.yaml <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8m.pt <span class="token assign-left variable">epochs</span><span class="token operator">=</span><span class="token number">20</span>
Ultralytics YOLOv8.0.154  Python-3.9.16 torch-1.13.1+cu117 CUDA:0 <span class="token punctuation">(</span>NVIDIA GeForce GTX <span class="token number">1080</span> Ti, 11264MiB<span class="token punctuation">)</span>
WARNING  Upgrade to torch<span class="token operator">&gt;=</span><span class="token number">2.0</span>.0 <span class="token keyword">for</span> deterministic training.
engine<span class="token punctuation">\</span>trainer: <span class="token assign-left variable">task</span><span class="token operator">=</span>detect, <span class="token assign-left variable">mode</span><span class="token operator">=</span>train, <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8m.pt, <span class="token assign-left variable">data</span><span class="token operator">=</span>custom-data<span class="token punctuation">\</span>vehicle<span class="token punctuation">\</span>myvoc.yaml, <span class="token assign-left variable">epochs</span><span class="token operator">=</span><span class="token number">20</span>, <span class="token assign-left variable">patience</span><span class="token operator">=</span><span class="token number">50</span>, <span class="token assign-left variable">batch</span><span class="token operator">=</span><span class="token number">16</span>, <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">640</span>, <span class="token assign-left variable">save</span><span class="token operator">=</span>True, <span class="token assign-left variable">save_period</span><span class="token operator">=</span>-1, <span class="token assign-left variable">cache</span><span class="token operator">=</span>False, <span class="token assign-left variable">device</span><span class="token operator">=</span>None, <span class="token assign-left variable">workers</span><span class="token operator">=</span><span class="token number">8</span>, <span class="token assign-left variable">project</span><span class="token operator">=</span>None, <span class="token assign-left variable">name</span><span class="token operator">=</span>None, <span class="token assign-left variable">exist_ok</span><span class="token operator">=</span>False, <span class="token assign-left variable">pretrained</span><span class="token operator">=</span>True, <span class="token assign-left variable">optimizer</span><span class="token operator">=</span>auto, <span class="token assign-left variable">verbose</span><span class="token operator">=</span>True, <span class="token assign-left variable">seed</span><span class="token operator">=</span><span class="token number">0</span>, <span class="token assign-left variable">deterministic</span><span class="token operator">=</span>True, <span class="token assign-left variable">single_cls</span><span class="token operator">=</span>False, <span class="token assign-left variable">rect</span><span class="token operator">=</span>False, <span class="token assign-left variable">cos_lr</span><span class="token operator">=</span>False, <span class="token assign-left variable">close_mosaic</span><span class="token operator">=</span><span class="token number">10</span>, <span class="token assign-left variable">resume</span><span class="token operator">=</span>False, <span class="token assign-left variable">amp</span><span class="token operator">=</span>True, <span class="token assign-left variable">fraction</span><span class="token operator">=</span><span class="token number">1.0</span>, <span class="token assign-left variable">profile</span><span class="token operator">=</span>False, <span class="token assign-left variable">freeze</span><span class="token operator">=</span>None, <span class="token assign-left variable">overlap_mask</span><span class="token operator">=</span>True, <span class="token assign-left variable">mask_ratio</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">dropout</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">val</span><span class="token operator">=</span>True, <span class="token assign-left variable">split</span><span class="token operator">=</span>val, <span class="token assign-left variable">save_json</span><span class="token operator">=</span>False, <span class="token assign-left variable">save_hybrid</span><span class="token operator">=</span>False, <span class="token assign-left variable">conf</span><span class="token operator">=</span>None, <span class="token assign-left variable">iou</span><span class="token operator">=</span><span class="token number">0.7</span>, <span class="token assign-left variable">max_det</span><span class="token operator">=</span><span class="token number">300</span>, <span class="token assign-left variable">half</span><span class="token operator">=</span>False, <span class="token assign-left variable">dnn</span><span class="token operator">=</span>False, <span class="token assign-left variable">plots</span><span class="token operator">=</span>True, <span class="token assign-left variable">source</span><span class="token operator">=</span>None, <span class="token assign-left variable">show</span><span class="token operator">=</span>False, <span class="token assign-left variable">save_txt</span><span class="token operator">=</span>False, <span class="token assign-left variable">save_conf</span><span class="token operator">=</span>False, <span class="token assign-left variable">save_crop</span><span class="token operator">=</span>False, <span class="token assign-left variable">show_labels</span><span class="token operator">=</span>True, <span class="token assign-left variable">show_conf</span><span class="token operator">=</span>True, <span class="token assign-left variable">vid_stride</span><span class="token operator">=</span><span class="token number">1</span>, <span class="token assign-left variable">line_width</span><span class="token operator">=</span>None, <span class="token assign-left variable">visualize</span><span class="token operator">=</span>False, <span class="token assign-left variable">augment</span><span class="token operator">=</span>False, <span class="token assign-left variable">agnostic_nms</span><span class="token operator">=</span>False, <span class="token assign-left variable">classes</span><span class="token operator">=</span>None, <span class="token assign-left variable">retina_masks</span><span class="token operator">=</span>False, <span class="token assign-left variable">boxes</span><span class="token operator">=</span>True, <span class="token assign-left variable">format</span><span class="token operator">=</span>torchscript, <span class="token assign-left variable">keras</span><span class="token operator">=</span>False, <span class="token assign-left variable">optimize</span><span class="token operator">=</span>False, <span class="token assign-left variable">int8</span><span class="token operator">=</span>False, <span class="token assign-left variable">dynamic</span><span class="token operator">=</span>False, <span class="token assign-left variable">simplify</span><span class="token operator">=</span>False, <span class="token assign-left variable">opset</span><span class="token operator">=</span>None, <span class="token assign-left variable">workspace</span><span class="token operator">=</span><span class="token number">4</span>, <span class="token assign-left variable">nms</span><span class="token operator">=</span>False, <span class="token assign-left variable">lr0</span><span class="token operator">=</span><span class="token number">0.01</span>, <span class="token assign-left variable">lrf</span><span class="token operator">=</span><span class="token number">0.01</span>, <span class="token assign-left variable">momentum</span><span class="token operator">=</span><span class="token number">0.937</span>, <span class="token assign-left variable">weight_decay</span><span class="token operator">=</span><span class="token number">0.0005</span>, <span class="token assign-left variable">warmup_epochs</span><span class="token operator">=</span><span class="token number">3.0</span>, <span class="token assign-left variable">warmup_momentum</span><span class="token operator">=</span><span class="token number">0.8</span>, <span class="token assign-left variable">warmup_bias_lr</span><span class="token operator">=</span><span class="token number">0.1</span>, <span class="token assign-left variable">box</span><span class="token operator">=</span><span class="token number">7.5</span>, <span class="token assign-left variable">cls</span><span class="token operator">=</span><span class="token number">0.5</span>, <span class="token assign-left variable">dfl</span><span class="token operator">=</span><span class="token number">1.5</span>, <span class="token assign-left variable">pose</span><span class="token operator">=</span><span class="token number">12.0</span>, <span class="token assign-left variable">kobj</span><span class="token operator">=</span><span class="token number">1.0</span>, <span class="token assign-left variable">label_smoothing</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">nbs</span><span class="token operator">=</span><span class="token number">64</span>, <span class="token assign-left variable">hsv_h</span><span class="token operator">=</span><span class="token number">0.015</span>, <span class="token assign-left variable">hsv_s</span><span class="token operator">=</span><span class="token number">0.7</span>, <span class="token assign-left variable">hsv_v</span><span class="token operator">=</span><span class="token number">0.4</span>, <span class="token assign-left variable">degrees</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">translate</span><span class="token operator">=</span><span class="token number">0.1</span>, <span class="token assign-left variable">scale</span><span class="token operator">=</span><span class="token number">0.5</span>, <span class="token assign-left variable">shear</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">perspective</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">flipud</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">fliplr</span><span class="token operator">=</span><span class="token number">0.5</span>, <span class="token assign-left variable">mosaic</span><span class="token operator">=</span><span class="token number">1.0</span>, <span class="token assign-left variable">mixup</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">copy_paste</span><span class="token operator">=</span><span class="token number">0.0</span>, <span class="token assign-left variable">cfg</span><span class="token operator">=</span>None, <span class="token assign-left variable">tracker</span><span class="token operator">=</span>botsort.yaml, <span class="token assign-left variable">save_dir</span><span class="token operator">=</span>runs<span class="token punctuation">\</span>detect<span class="token punctuation">\</span>train4
Overriding model.yaml <span class="token assign-left variable">nc</span><span class="token operator">=</span><span class="token number">80</span> with <span class="token assign-left variable">nc</span><span class="token operator">=</span><span class="token number">4</span>

                   from  n    params  module                                       arguments
  <span class="token number">0</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>      <span class="token number">1392</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">3</span>, <span class="token number">48</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token number">1</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>     <span class="token number">41664</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">48</span>, <span class="token number">96</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token number">2</span>                  <span class="token parameter variable">-1</span>  <span class="token number">2</span>    <span class="token number">111360</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">96</span>, <span class="token number">96</span>, <span class="token number">2</span>, True<span class="token punctuation">]</span>
  <span class="token number">3</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">166272</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">96</span>, <span class="token number">192</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token number">4</span>                  <span class="token parameter variable">-1</span>  <span class="token number">4</span>    <span class="token number">813312</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">192</span>, <span class="token number">192</span>, <span class="token number">4</span>, True<span class="token punctuation">]</span>
  <span class="token number">5</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">664320</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">192</span>, <span class="token number">384</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token number">6</span>                  <span class="token parameter variable">-1</span>  <span class="token number">4</span>   <span class="token number">3248640</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">384</span>, <span class="token number">384</span>, <span class="token number">4</span>, True<span class="token punctuation">]</span>
  <span class="token number">7</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>   <span class="token number">1991808</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">384</span>, <span class="token number">576</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
  <span class="token number">8</span>                  <span class="token parameter variable">-1</span>  <span class="token number">2</span>   <span class="token number">3985920</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">576</span>, <span class="token number">576</span>, <span class="token number">2</span>, True<span class="token punctuation">]</span>
  <span class="token number">9</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">831168</span>  ultralytics.nn.modules.block.SPPF            <span class="token punctuation">[</span><span class="token number">576</span>, <span class="token number">576</span>, <span class="token number">5</span><span class="token punctuation">]</span>
 <span class="token number">10</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>         <span class="token number">0</span>  torch.nn.modules.upsampling.Upsample         <span class="token punctuation">[</span>None, <span class="token number">2</span>, <span class="token string">'nearest'</span><span class="token punctuation">]</span>
 <span class="token number">11</span>             <span class="token punctuation">[</span>-1, <span class="token number">6</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  ultralytics.nn.modules.conv.Concat           <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
 <span class="token number">12</span>                  <span class="token parameter variable">-1</span>  <span class="token number">2</span>   <span class="token number">1993728</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">960</span>, <span class="token number">384</span>, <span class="token number">2</span><span class="token punctuation">]</span>
 <span class="token number">13</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>         <span class="token number">0</span>  torch.nn.modules.upsampling.Upsample         <span class="token punctuation">[</span>None, <span class="token number">2</span>, <span class="token string">'nearest'</span><span class="token punctuation">]</span>
 <span class="token number">14</span>             <span class="token punctuation">[</span>-1, <span class="token number">4</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  ultralytics.nn.modules.conv.Concat           <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
 <span class="token number">15</span>                  <span class="token parameter variable">-1</span>  <span class="token number">2</span>    <span class="token number">517632</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">576</span>, <span class="token number">192</span>, <span class="token number">2</span><span class="token punctuation">]</span>
 <span class="token number">16</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>    <span class="token number">332160</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">192</span>, <span class="token number">192</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
 <span class="token number">17</span>            <span class="token punctuation">[</span>-1, <span class="token number">12</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  ultralytics.nn.modules.conv.Concat           <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
 <span class="token number">18</span>                  <span class="token parameter variable">-1</span>  <span class="token number">2</span>   <span class="token number">1846272</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">576</span>, <span class="token number">384</span>, <span class="token number">2</span><span class="token punctuation">]</span>
 <span class="token number">19</span>                  <span class="token parameter variable">-1</span>  <span class="token number">1</span>   <span class="token number">1327872</span>  ultralytics.nn.modules.conv.Conv             <span class="token punctuation">[</span><span class="token number">384</span>, <span class="token number">384</span>, <span class="token number">3</span>, <span class="token number">2</span><span class="token punctuation">]</span>
 <span class="token number">20</span>             <span class="token punctuation">[</span>-1, <span class="token number">9</span><span class="token punctuation">]</span>  <span class="token number">1</span>         <span class="token number">0</span>  ultralytics.nn.modules.conv.Concat           <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
 <span class="token number">21</span>                  <span class="token parameter variable">-1</span>  <span class="token number">2</span>   <span class="token number">4207104</span>  ultralytics.nn.modules.block.C2f             <span class="token punctuation">[</span><span class="token number">960</span>, <span class="token number">576</span>, <span class="token number">2</span><span class="token punctuation">]</span>
 <span class="token number">22</span>        <span class="token punctuation">[</span><span class="token number">15</span>, <span class="token number">18</span>, <span class="token number">21</span><span class="token punctuation">]</span>  <span class="token number">1</span>   <span class="token number">3778012</span>  ultralytics.nn.modules.head.Detect           <span class="token punctuation">[</span><span class="token number">4</span>, <span class="token punctuation">[</span><span class="token number">192</span>, <span class="token number">384</span>, <span class="token number">576</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
Model summary: <span class="token number">295</span> layers, <span class="token number">25858636</span> parameters, <span class="token number">25858620</span> gradients, <span class="token number">79.1</span> GFLOPs

Transferred <span class="token number">469</span>/475 items from pretrained weights
TensorBoard: Start with <span class="token string">'tensorboard --logdir runs\detect\train4'</span>, view at http://localhost:6006/
Freezing layer <span class="token string">'model.22.dfl.conv.weight'</span>
AMP: running Automatic Mixed Precision <span class="token punctuation">(</span>AMP<span class="token punctuation">)</span> checks with YOLOv8n<span class="token punctuation">..</span>.
AMP: checks passed
train: Scanning E:<span class="token punctuation">\</span>DeepLearning<span class="token punctuation">\</span>yolov8-ultralytics<span class="token punctuation">\</span>custom-data<span class="token punctuation">\</span>vehicle<span class="token punctuation">\</span>labels.cache<span class="token punctuation">..</span>. <span class="token number">998</span> images, <span class="token number">0</span> backgrounds, <span class="token number">0</span> corrupt: <span class="token number">100</span>%<span class="token operator">|</span>█████████
val: Scanning E:<span class="token punctuation">\</span>DeepLearning<span class="token punctuation">\</span>yolov8-ultralytics<span class="token punctuation">\</span>custom-data<span class="token punctuation">\</span>vehicle<span class="token punctuation">\</span>labels.cache<span class="token punctuation">..</span>. <span class="token number">998</span> images, <span class="token number">0</span> backgrounds, <span class="token number">0</span> corrupt: <span class="token number">100</span>%<span class="token operator">|</span>██████████<span class="token operator">|</span>
Plotting labels to runs<span class="token punctuation">\</span>detect<span class="token punctuation">\</span>train4<span class="token punctuation">\</span>labels.jpg<span class="token punctuation">..</span>.
optimizer: AdamW<span class="token punctuation">(</span>lr<span class="token operator">=</span><span class="token number">0.00125</span>, <span class="token assign-left variable">momentum</span><span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span> with parameter <span class="token function">groups</span> <span class="token number">77</span> weight<span class="token punctuation">(</span>decay<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span>, <span class="token number">84</span> weight<span class="token punctuation">(</span>decay<span class="token operator">=</span><span class="token number">0.0005</span><span class="token punctuation">)</span>, <span class="token number">83</span> bias<span class="token punctuation">(</span>decay<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">)</span>
Image sizes <span class="token number">640</span> train, <span class="token number">640</span> val
Using <span class="token number">8</span> dataloader workers
Logging results to runs<span class="token punctuation">\</span>detect<span class="token punctuation">\</span>train4
Starting training <span class="token keyword">for</span> <span class="token number">20</span> epochs<span class="token punctuation">..</span>.

      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size
       <span class="token number">1</span>/20      <span class="token number">8</span>.54G     <span class="token number">0.7725</span>      <span class="token number">1.499</span>      <span class="token number">1.019</span>         <span class="token number">28</span>        <span class="token number">640</span>: <span class="token number">100</span>%<span class="token operator">|</span>██████████<span class="token operator">|</span> <span class="token number">63</span>/63 <span class="token punctuation">[</span>00:4<span class="token operator"><span class="token file-descriptor important">7</span>&lt;</span>00:00,  <span class="token number">1</span>.34it/s<span class="token punctuation">]</span>
                 Class     Images  Instances      Box<span class="token punctuation">(</span>P          R      mAP50  mAP50-95<span class="token punctuation">)</span>: <span class="token number">100</span>%<span class="token operator">|</span>██████████<span class="token operator">|</span> <span class="token number">32</span>/32 <span class="token punctuation">[</span>00:1<span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>00:00,  <span class="token number">2</span>.31it/s<span class="token punctuation">]</span>
                   all        <span class="token number">998</span>       <span class="token number">2353</span>      <span class="token number">0.876</span>      <span class="token number">0.857</span>      <span class="token number">0.925</span>      <span class="token number">0.774</span>

      Epoch    GPU_mem   box_loss   cls_loss   dfl_loss  Instances       Size
       <span class="token number">2</span>/20      <span class="token number">8</span>.62G     <span class="token number">0.6806</span>     <span class="token number">0.7755</span>     <span class="token number">0.9495</span>         <span class="token number">83</span>        <span class="token number">640</span>:  <span class="token number">46</span>%<span class="token operator">|</span>████▌     <span class="token operator">|</span> <span class="token number">29</span>/63 <span class="token punctuation">[</span>00:1<span class="token operator"><span class="token file-descriptor important">7</span>&lt;</span>00:20,  <span class="token number">1</span>.65it/s<span class="token punctuation">]</span>
</code></pre> 
<h2><a id="4Yolov8pose__472"></a>4、Yolov8-pose 简单使用</h2> 
<p>人体姿态估计，使用coco数据集标注格式，17个关键点。</p> 
<p>对 <code>yolov8m-pose.pt</code> 转换得到onnx如下，</p> 
<pre><code class="prism language-sh"><span class="token punctuation">(</span>yolo_pytorch<span class="token punctuation">)</span> E:<span class="token punctuation">\</span>DeepLearning<span class="token punctuation">\</span>yolov8-ultralytics<span class="token operator">&gt;</span>yolo pose <span class="token builtin class-name">export</span> <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8m-pose.pt <span class="token assign-left variable">format</span><span class="token operator">=</span>onnx  <span class="token assign-left variable">batch</span><span class="token operator">=</span><span class="token number">1</span> <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">640</span>
Ultralytics YOLOv8.0.154  Python-3.9.16 torch-1.13.1+cu117 CPU <span class="token punctuation">(</span>Intel Core<span class="token punctuation">(</span>TM<span class="token punctuation">)</span> i7-7700K <span class="token number">4</span>.20GHz<span class="token punctuation">)</span>
YOLOv8m-pose summary <span class="token punctuation">(</span>fused<span class="token punctuation">)</span>: <span class="token number">237</span> layers, <span class="token number">26447596</span> parameters, <span class="token number">0</span> gradients, <span class="token number">81.0</span> GFLOPs

PyTorch: starting from <span class="token string">'yolov8m-pose.pt'</span> with input shape <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">3</span>, <span class="token number">640</span>, <span class="token number">640</span><span class="token punctuation">)</span> BCHW and output shape<span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">56</span>, <span class="token number">8400</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token number">50.8</span> MB<span class="token punctuation">)</span>

ONNX: starting <span class="token builtin class-name">export</span> with onnx <span class="token number">1.14</span>.0 opset <span class="token number">16</span><span class="token punctuation">..</span>.
ONNX: <span class="token builtin class-name">export</span> success  <span class="token number">3</span>.3s, saved as <span class="token string">'yolov8m-pose.onnx'</span> <span class="token punctuation">(</span><span class="token number">101.2</span> MB<span class="token punctuation">)</span>

Export complete <span class="token punctuation">(</span><span class="token number">7</span>.1s<span class="token punctuation">)</span>
Results saved to E:<span class="token punctuation">\</span>DeepLearning<span class="token punctuation">\</span>yolov8-ultralytics
Predict:         yolo predict <span class="token assign-left variable">task</span><span class="token operator">=</span>pose <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8m-pose.onnx <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">640</span>
Validate:        yolo val <span class="token assign-left variable">task</span><span class="token operator">=</span>pose <span class="token assign-left variable">model</span><span class="token operator">=</span>yolov8m-pose.onnx <span class="token assign-left variable">imgsz</span><span class="token operator">=</span><span class="token number">640</span> <span class="token assign-left variable">data</span><span class="token operator">=</span>/usr/src/app/ultralytics/datasets/coco-pose.yaml
Visualize:       https://netron.app
</code></pre> 
<p>输入为640时输出纬度为 （56,8400），56维数据格式定义为 4 + 1 + 17*3：<br> <strong>矩形框box[x,y,w,h]，目标置信度conf， 17组关键点 (x, y, conf)。</strong></p> 
<p>在后处理中，添加一个保存关键点的数据，一个显示关键点的函数</p> 
<pre><code class="prism language-c"><span class="token keyword">void</span> <span class="token function">postprocess</span><span class="token punctuation">(</span>Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">,</span> cv<span class="token operator">::</span>Size inputSz<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Mat<span class="token operator">&gt;</span><span class="token operator">&amp;</span> outs<span class="token punctuation">,</span> Net<span class="token operator">&amp;</span> net<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// yolov8-pose has an output of shape (batchSize, 56, 8400) (  box[x,y,w,h] + conf + 17*(x,y,conf) )</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Mat<span class="token operator">&gt;</span> keypoints<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">float</span> confidence <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>confidence <span class="token operator">&gt;=</span> confThreshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
				
                boxes<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>cv<span class="token operator">::</span><span class="token function">Rect</span><span class="token punctuation">(</span>left<span class="token punctuation">,</span> top<span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                cv<span class="token operator">::</span>Mat <span class="token function">keypoint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> dimensions <span class="token operator">-</span> <span class="token number">5</span><span class="token punctuation">,</span> CV_32F<span class="token punctuation">,</span> tmp<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">17</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    keypoint<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">*=</span> x_factor<span class="token punctuation">;</span>
                    keypoint<span class="token punctuation">.</span>at<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>i <span class="token operator">*</span> <span class="token number">3</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*=</span> y_factor<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                keypoints<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>keypoint<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        data <span class="token operator">+=</span> dimensions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> indices<span class="token punctuation">;</span>
    <span class="token function">NMSBoxes</span><span class="token punctuation">(</span>boxes<span class="token punctuation">,</span> confidences<span class="token punctuation">,</span> scoreThreshold<span class="token punctuation">,</span> nmsThreshold<span class="token punctuation">,</span> indices<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> indices<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token function">drawSkelton</span><span class="token punctuation">(</span>keypoints<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Scalar<span class="token operator">&gt;</span> kptcolors <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
     <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">170</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
     <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">170</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">170</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">85</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> keypairs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> keypairs <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">{<!-- --></span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">drawSkelton</span><span class="token punctuation">(</span><span class="token keyword">const</span> Mat<span class="token operator">&amp;</span> keypoints <span class="token punctuation">,</span> Mat<span class="token operator">&amp;</span> frame<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> pair <span class="token operator">:</span> keypairs<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span><span class="token operator">&amp;</span> pt1 <span class="token operator">=</span> keypoints<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point3f<span class="token operator">&gt;</span><span class="token punctuation">(</span>pair<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span><span class="token operator">&amp;</span> pt2 <span class="token operator">=</span> keypoints<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point3f<span class="token operator">&gt;</span><span class="token punctuation">(</span>pair<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pt1<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> pt2<span class="token punctuation">.</span>z <span class="token operator">&gt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cv<span class="token operator">::</span><span class="token function">line</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span>pt1<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt1<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span>pt2<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt2<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">17</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Point3f pt <span class="token operator">=</span> keypoints<span class="token punctuation">.</span>at<span class="token operator">&lt;</span>cv<span class="token operator">::</span>Point3f<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span>z <span class="token operator">&lt;</span> <span class="token number">0.5</span><span class="token punctuation">)</span> 
        	<span class="token keyword">continue</span><span class="token punctuation">;</span>   	
        cv<span class="token operator">::</span><span class="token function">circle</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> kptcolors<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cv<span class="token operator">::</span><span class="token function">putText</span><span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%d"</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Point</span><span class="token punctuation">(</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">,</span> pt<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>结果如下：<br> <img src="https://images2.imgbox.com/61/42/iyg7wPlv_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eb39d1edb4d090d122be6fc8f920ec49/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">linux内存空间深度清理</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4d55e059ecfbf7edbb837ca1ba6258ce/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Arcgis坐标系</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>