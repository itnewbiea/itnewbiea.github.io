<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C&#43;&#43; 在线刷题网站 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C&#43;&#43; 在线刷题网站" />
<meta property="og:description" content="文章目录 1. 前言2. 效果展示3. 框架4. common4.1 工具类4.2 日志 5. 编译5.1 前言5.2 正文5.3 PathUtil5.4 Compile 6. 运行6.1 限制进程资源6.2 Run 7. 执行7.1 json7.2 Start 参数7.3 FileUtil7.4 Start 8. 启动服务8.1 安装 httplib8.2 compile_server.cpp 9. 测试 compiler10. 梳理题目逻辑11. 建表12. 连接数据库12.1 MySQL 库12.2 查询操作 13. 题目页面13.1 ctemplate13.2 前端题库页面13.3 接收请求 14. 单个题目15. 负载均衡15.1 Machine15.2 LoadBalancer 15. 运行用户代码16. 密码密文存储17. 实现会话18. 拦截器19. 记录用户答题情况20. 展示用户完成的题目21. 项目代码 1. 前言 环境：CentOS 7.6
项目：在线刷题网站，是一个类似于「力扣」那样的刷题网站
项目基本功能：和力扣的核心功能一样，需要完成用户代码的编译，运行，跑测试用例，并将用户代码的执行结果返回给用户
所涉及库：除了一些基础库之外，还用到了
Boost 标准库，使用了操作字符串，时间戳，uuid 相关接口cpp-httplib：开源网络库，简化开发，不需要再写客户端服务端的套接字等繁琐代码ctemplate：开源库，用来渲染前端页面jsoncpp：开源库，用于序列化和反序列化MySQL C connect：用于操作数据库Ace 代码编辑器 亮点：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/36c1efb125932e85e4264015560f9244/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-02T22:41:00+08:00" />
<meta property="article:modified_time" content="2023-08-02T22:41:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C&#43;&#43; 在线刷题网站</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-dracula">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1. 前言</a></li><li><a href="#2__26" rel="nofollow">2. 效果展示</a></li><li><a href="#3__34" rel="nofollow">3. 框架</a></li><li><a href="#4_common_53" rel="nofollow">4. common</a></li><li><ul><li><a href="#41__54" rel="nofollow">4.1 工具类</a></li><li><a href="#42__88" rel="nofollow">4.2 日志</a></li></ul> 
  </li><li><a href="#5__137" rel="nofollow">5. 编译</a></li><li><ul><li><a href="#51__138" rel="nofollow">5.1 前言</a></li><li><a href="#52__150" rel="nofollow">5.2 正文</a></li><li><a href="#53_PathUtil_163" rel="nofollow">5.3 PathUtil</a></li><li><a href="#54_Compile_220" rel="nofollow">5.4 Compile</a></li></ul> 
  </li><li><a href="#6__309" rel="nofollow">6. 运行</a></li><li><ul><li><a href="#61__317" rel="nofollow">6.1 限制进程资源</a></li><li><a href="#62_Run_342" rel="nofollow">6.2 Run</a></li></ul> 
  </li><li><a href="#7__427" rel="nofollow">7. 执行</a></li><li><ul><li><a href="#71_json_444" rel="nofollow">7.1 json</a></li><li><a href="#72_Start__451" rel="nofollow">7.2 Start 参数</a></li><li><a href="#73_FileUtil_468" rel="nofollow">7.3 FileUtil</a></li><li><a href="#74_Start_550" rel="nofollow">7.4 Start</a></li></ul> 
  </li><li><a href="#8__669" rel="nofollow">8. 启动服务</a></li><li><ul><li><a href="#81__httplib_673" rel="nofollow">8.1 安装 httplib</a></li><li><a href="#82_compile_servercpp_694" rel="nofollow">8.2 compile_server.cpp</a></li></ul> 
  </li><li><a href="#9__compiler_723" rel="nofollow">9. 测试 compiler</a></li><li><a href="#10__754" rel="nofollow">10. 梳理题目逻辑</a></li><li><a href="#11__788" rel="nofollow">11. 建表</a></li><li><a href="#12__917" rel="nofollow">12. 连接数据库</a></li><li><ul><li><a href="#121_MySQL__922" rel="nofollow">12.1 MySQL 库</a></li><li><a href="#122__934" rel="nofollow">12.2 查询操作</a></li></ul> 
  </li><li><a href="#13__1098" rel="nofollow">13. 题目页面</a></li><li><ul><li><a href="#131_ctemplate_1102" rel="nofollow">13.1 ctemplate</a></li><li><a href="#132__1132" rel="nofollow">13.2 前端题库页面</a></li><li><a href="#133__1446" rel="nofollow">13.3 接收请求</a></li></ul> 
  </li><li><a href="#14__1479" rel="nofollow">14. 单个题目</a></li><li><a href="#15__1553" rel="nofollow">15. 负载均衡</a></li><li><ul><li><a href="#151_Machine_1556" rel="nofollow">15.1 Machine</a></li><li><a href="#152_LoadBalancer_1607" rel="nofollow">15.2 LoadBalancer</a></li></ul> 
  </li><li><a href="#15__1742" rel="nofollow">15. 运行用户代码</a></li><li><a href="#16__1841" rel="nofollow">16. 密码密文存储</a></li><li><a href="#17__1846" rel="nofollow">17. 实现会话</a></li><li><a href="#18__2019" rel="nofollow">18. 拦截器</a></li><li><a href="#19__2103" rel="nofollow">19. 记录用户答题情况</a></li><li><a href="#20__2200" rel="nofollow">20. 展示用户完成的题目</a></li><li><a href="#21__2212" rel="nofollow">21. 项目代码</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1. 前言</h2> 
<p>环境：<code>CentOS 7.6</code></p> 
<p>项目：在线刷题网站，是一个类似于「力扣」那样的刷题网站</p> 
<p>项目基本功能：和力扣的核心功能一样，需要完成用户代码的编译，运行，跑测试用例，并将用户代码的执行结果返回给用户</p> 
<p>所涉及库：除了一些基础库之外，还用到了</p> 
<ul><li><code>Boost</code> 标准库，使用了操作字符串，时间戳，uuid 相关接口</li><li><code>cpp-httplib</code>：开源网络库，简化开发，不需要再写客户端服务端的套接字等繁琐代码</li><li><code>ctemplate</code>：开源库，用来渲染前端页面</li><li><code>jsoncpp</code>：开源库，用于序列化和反序列化</li><li><code>MySQL C connect</code>：用于操作数据库</li><li><code>Ace</code> 代码编辑器</li></ul> 
<p>亮点：</p> 
<ul><li>使用了 <code>Boost</code>，<code>MySQL</code>，<code>ctemplate</code> ，<code>pthread</code>等相关库</li><li>实现负载均衡：一个服务器用来接收所有的代码编译请求，其他服务器用来编译用户代码，而前者会将请求均匀地发送给这些 编译服务器</li><li>对用户账号中的密码以 「盐值 + md5」 的方式进行密文存储，就算数据库被盗取，用户的密码仍然安全</li><li>手动实现了会话功能，可以自动登录</li><li>实现了管理员的录题功能</li><li>题库页面中，在用户已经完成的题目，的题号前打钩，就像这样<br> <img src="https://images2.imgbox.com/3a/bc/DkVoKw3Q_o.png" alt="在这里插入图片描述"></li></ul> 
<h2><a id="2__26"></a>2. 效果展示</h2> 
<p><img src="https://images2.imgbox.com/f7/8e/QHjlPIez_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/41/e9/tWljtjYv_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/71/8f/WFE7MjV9_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/14/26/pso5b6gv_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__34"></a>3. 框架</h2> 
<p>首先，先捋一下流程：用户会向服务器发送请求，比如申请获取题库，或者获得一个具体题目的具体信息，或者是将用户自己的代码交给服务器编译，运行，并获取结果</p> 
<p>结合前面提到了负载均衡，上述流程可以交给两个角色来完成，分别为 <code>dispatcher</code>，和 <code>executor</code></p> 
<ul><li>上述请求中，很明显，代码的编译，运行，跑测试用例环节是最费时的，所以这个请求可以专门给「编译 / 运行服务器」来处理</li><li><code>dispatcher</code>：用来将编译 / 运行请求均匀地分给「编译服务器」处理，除此之外，对于「申请获取题库」等等这些开销不大的请求，一个 <code>dispatcher</code>也可以顺手完成</li><li><code>executor</code>：就是一个专门「完成用户代码运行」请求的服务器，并且可能有多个<br> 具体就是：对用户代码进行编译，如果编译不通过，那就将编译结果返回给用户；否则拿用户代码来跑所有的测试用例，并按照自己的业务逻辑返回给用户一定的结果</li></ul> 
<p><img src="https://images2.imgbox.com/74/64/OWYC3l82_o.png" alt="在这里插入图片描述"></p> 
<p>所以项目可以分为<strong>三</strong>个文件夹，<code>ojserver (dispatcher)</code> 和 <code>compile_server (executor)</code>，再加一个大家都用得到的工具文件夹 <code>common</code>，专门提供各种使用频率高的接口</p> 
<h2><a id="4_common_53"></a>4. common</h2> 
<h3><a id="41__54"></a>4.1 工具类</h3> 
<p>在后续操作中，可能需要对时间进行操作，对字符串操作，对文件操作…，所以需要创建一个 <code>util.hpp</code> 文件，里面专门提供对各种数据进行操作的接口</p> 
<p>在这一切之前，先在 <code>common</code> 定义一个全局函数 <code>log</code>，用来打印日志，需要打印日志，也就需要打印相应时间，这里我们打印时间戳</p> 
<p>打印时间戳 —— 这里可以使用 <code>Boost</code> 库的相关接口</p> 
<p><strong>Boost 库的安装</strong></p> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> boost-devel
</code></pre> 
<p>然后引入生成时间戳的相关头文件</p> 
<pre><code class="prism language-cpp"><span class="token comment">// 时间戳接口 Boost 库</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
</code></pre> 
<p>随后，，就可以编写时间戳(ms)为单位，返回 <code>long long</code> 类型的整数时间戳，然后放在 <code>TimeUtil</code> 类中</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">TimeUtil</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">CurrentTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> now <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> timestamp <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">time_point_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> timestamp<span class="token punctuation">.</span><span class="token function">time_since_epoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="42__88"></a>4.2 日志</h3> 
<p>比如现在我需要打印一行日志，那么我们需要的信息有：日志等级，文件名（哪个文件打印的日志），以及该文件的代码行数。比如：<code>INFO: executor.cpp 182 行</code></p> 
<p>于是就可以创建这样一个打印日志函数，然后返回一个 <code>std::ostream</code> 对象，方便进行 <code>Log(level) &lt;&lt; filename &lt;&lt; line</code> 操作</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// LOG() &lt;&lt; msg</span>
    <span class="token keyword">inline</span> std<span class="token double-colon punctuation">::</span>ostream<span class="token operator">&amp;</span> <span class="token function">Log</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> level<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span> <span class="token keyword">int</span> line<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 添加日志等级</span>
        string msg <span class="token operator">=</span> <span class="token string">"["</span> <span class="token operator">+</span> level <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加文件的名称</span>
        msg <span class="token operator">+=</span> <span class="token string">"["</span> <span class="token operator">+</span> filename <span class="token operator">+</span> <span class="token char">']'</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加报错行</span>
        msg <span class="token operator">+=</span> <span class="token string">"["</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"]"</span><span class="token punctuation">;</span>
        <span class="token comment">// 添加日志的打印时间戳</span>
        msg <span class="token operator">+=</span> <span class="token string">"["</span><span class="token punctuation">;</span>
        msg <span class="token operator">+=</span> <span class="token function">to_string</span><span class="token punctuation">(</span><span class="token class-name">TimeUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CurrentTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        msg <span class="token operator">+=</span> <span class="token string">"] "</span><span class="token punctuation">;</span>

        cout <span class="token operator">&lt;&lt;</span> msg<span class="token punctuation">;</span>                                <span class="token comment">// 输入到缓冲区中, 但是不刷新</span>
        <span class="token keyword">return</span> std<span class="token double-colon punctuation">::</span>cout<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>但是在打印日志的时候，每次都需要手动输入文件名，和当前行，很不方便，所以在使用的时候可以这么用：<code>Log("WARNING", __FILE__, __LINE__)</code>就可以自动获取当前的文件名以及当前行数</p> 
<p>然后定义几个日志等级</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">enum</span> <span class="token punctuation">{<!-- --></span>      <span class="token comment">// 日志等级</span>
        INFO<span class="token punctuation">,</span>						<span class="token comment">// 普通通知</span>
        DEBUG<span class="token punctuation">,</span>						<span class="token comment">// 用于调式</span>
        WARNING<span class="token punctuation">,</span>					<span class="token comment">// 警告</span>
        ERROR<span class="token punctuation">,</span>						<span class="token comment">// 错误</span>
        FATAL						<span class="token comment">// 崩溃，可能导致服务器无法对外提供服务</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后再定义个宏，来简化 <code>Log</code> 函数的调用</p> 
<pre><code class="prism language-cpp">    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">LOG</span><span class="token expression"><span class="token punctuation">(</span>level<span class="token punctuation">)</span> <span class="token function">Log</span><span class="token punctuation">(</span>#level<span class="token punctuation">,</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span></span></span>
</code></pre> 
<p>解释：直接让 <code>LOG(level)</code> 来自动替换这个函数，不必重复输入，并且每次输入日志等级的字符串也麻烦，所以 <code>Log(#level, __FILE__, __LINE__)</code> 中的 井号# 可以让传进来的参数直接变成字符串</p> 
<p>比方说，调用 <code>LOG(INFO) &lt;&lt; "发生错误";</code> 的时候，最终会被替换成 <code>Log("INFO", __FILE__, __LINE__) &lt;&lt; "发生错误";</code></p> 
<h2><a id="5__137"></a>5. 编译</h2> 
<h3><a id="51__138"></a>5.1 前言</h3> 
<p>根据上面说的，<code>ojserver</code> 会接收到用户的代码，然后将编译，运行请求交给 <code>compiler</code> 进行处理</p> 
<p>也就是说 <code>compiler</code>的工作可以分为以下几个部分：接收请求，编译，跑测试用例，将结果返回</p> 
<p>大致思路：<code>compiler</code> 服务器会收到请求，请求里面包括用户的代码，然后需要将 用户代码 写入到一个 <code>.cpp</code> 的临时文件中，然后对这个源文件进行编译，随后生成可执行文件，再用这个可执行文件来跑测试用例，最后返回用户结果。</p> 
<p>所以需要一个临时文件夹来存放这里面<strong>产生的各种临时文件</strong>，命名为 <code>temp</code></p> 
<h3><a id="52__150"></a>5.2 正文</h3> 
<p>先想想，在编译代码之前，需要有什么？—— cpp 源文件，也就是需要知道文件名和文件路径</p> 
<p>首先所以这里创建一个文件 <code>compiler.hpp</code>，里面创建一个类 <code>Compiler</code> 专门负责编译，对于编译</p> 
<ul><li>如果编译成功，那就什么都不说，并且生成一个可执行文件。所以可以靠这个可执行文件是否存在，来判断是否编译成功</li><li>如果编译失败，那么这个编译结果需要告知用户，所以需要写在一个文件里</li></ul> 
<p>所以规定：假设现在有一个文件名 <code>F</code>，那么源文件命名为 <code>F.cpp</code>，对应的可执行文件为 <code>F.exe</code>，如果编译失败，那么编译失败的原因写入 <code>F.compile_err</code>文件，并且这些文件都会放在 <code>temp</code>目录下</p> 
<ul><li>相应的，后面这个可执行文件可能会有输入，输出，错误等数据，也需要为其建立相应的文件，分别是 <code>F.stdin</code>，<code>F.stdout</code>，<code>F.stderr</code></li></ul> 
<p>所以在编译的时候，只需要传入一个文件名，<code>compiler</code> 就可以找到对应的 <code>.cpp, .compile_err</code> 等文件，当然，前提是这个文件名是唯一的。</p> 
<h3><a id="53_PathUtil_163"></a>5.3 PathUtil</h3> 
<p>所以为了根据 文件名，从而获取各种格式的文件，这里就需要 关于路径的工具类，传入一个文件名，获取其完整路径</p> 
<pre><code class="prism language-cpp">	<span class="token comment">// 这个存放临时文件的文件夹的路径</span>
    <span class="token keyword">const</span> string tempPath <span class="token operator">=</span> <span class="token string">"./temp/"</span><span class="token punctuation">;</span>

    <span class="token comment">// 负责处理路径的工具类, 可以对路径进行各种拼接操作</span>
    <span class="token keyword">class</span> <span class="token class-name">PathUtil</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token comment">// 拼接出完整的文件路径, 添加前缀和后缀</span>
        <span class="token keyword">static</span> string <span class="token function">Joint</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> suffix<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string result <span class="token operator">=</span> tempPath<span class="token punctuation">;</span><span class="token comment">// temp 文件夹的路径</span>
            result <span class="token operator">+=</span> filename<span class="token punctuation">;</span>		<span class="token comment">// 添加文件名</span>
            result <span class="token operator">+=</span> suffix<span class="token punctuation">;</span> 		<span class="token comment">// 添加后缀</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取源文件路径</span>
        <span class="token keyword">static</span> string <span class="token function">SrcPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">Joint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">".cpp"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    
        <span class="token comment">// 获取可执行程序路径</span>
        <span class="token keyword">static</span> string <span class="token function">ExePath</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">Joint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">".exe"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 获取存储编译错误信息的程序路径</span>
        <span class="token keyword">static</span> string <span class="token function">CompileErrPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">Joint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">".compile_err"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 用户程序运行时的 stderr 文件路径</span>
        <span class="token keyword">static</span> string <span class="token function">StderrPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">Joint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">".stderr"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 用户程序的 stdin 文件路径</span>
        <span class="token keyword">static</span> string <span class="token function">StdinPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">Joint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">".stdin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

		<span class="token comment">// 用户程序的 stdout 路径</span>
        <span class="token keyword">static</span> string <span class="token function">StdoutPath</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token function">Joint</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">".stdout"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="54_Compile_220"></a>5.4 Compile</h3> 
<p>于是 <code>Compiler</code> 类中就可以对外提供一个编译的接口 <code>Compile</code></p> 
<p>该接口的实现思路：</p> 
<ul><li>外界提供一个文件名，该接口就可以找到该文件的 <code>.cpp</code> 文件路径</li><li>然后创建子进程，子进程需要先将 <code>.compile_err</code> 文件打开，因为编译过程可能会出错，所以需要预先打开，如果编译出错，就可以直接往这个文件中写入</li><li>使用程序替换，调用 <code>g++</code> 来编译这个 <code>.cpp</code> 程序，然后形成对应的可执行文<br> <code> execlp("g++", "g++", "-o", exe_path.c_str(), src_path.c_str(), "-std=c++11", nullptr);</code></li><li>如果编译错误，那么 g++ 会将错误信息写进 标准错误 中，所以在程序替换之前，还需要进行重定向，将原本写入 标准错误 中的信息，重定向到 <code>.compile_err</code> 文件中</li><li>然后父进程还需要等待子进程，如果编译成功，那么会生成相应的可执行文件，这里需要检验是否生成</li></ul> 
<hr> 
<p>所以这里还需要在 <code>util.hpp</code> 工具类中补充「<code>FileUtil</code>」类，来添加 「判断文件是否存在」的接口 <code>man 2 stat</code></p> 
<p><img src="https://images2.imgbox.com/34/20/5NV0qKzJ_o.png" alt="在这里插入图片描述"></p> 
<ul><li><code>char* path</code>：文件路径</li><li><code>struct stat* buf</code>：输出型参数，里面记录了文件的状态等信息，这里暂时用不到，这里只需要判断是否存在就够了</li><li><code>return val</code>：返回 0 表示成功</li></ul> 
<pre><code class="prism language-cpp">    <span class="token comment">// 对文件操作的工具类</span>
    <span class="token keyword">class</span> <span class="token class-name">FileUtil</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">Exists</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> path<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">struct</span> <span class="token class-name">stat</span> file_stat<span class="token punctuation">;</span>
            <span class="token comment">// 获取文件属性成功就会返回 0, 第二个参数 struct stat 就是文件属性，是输出型</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stat</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>file_stat<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>                 
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>；

</code></pre> 
<hr> 
<p>所以 <code>Compiler</code> 类中的 <code>Compile</code> —— 编译接口如下</p> 
<pre><code class="prism language-cpp">        <span class="token comment">// 返回值：是否编译成功</span>
        <span class="token comment">// 参数：编译的文件名</span>
        <span class="token comment">// file_name -- ./temp/file_name.cpp</span>
        <span class="token comment">// file_name -- ./temp/file_name.exe</span>
        <span class="token comment">// file_name -- ./temp/file_name.compile_err</span>
        <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">Compile</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> string src_path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">SrcPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> string exe_path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ExePath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> string compile_err_path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CompileErrPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                                              
                <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"创建子进程失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                                              
                <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果编译错误, 那么就将 stderr 重定向到日志文件中</span>
                <span class="token keyword">int</span> fileErr <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>compile_err_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fileErr <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>                  <span class="token comment">// 创建失败, 直接退出</span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"error 文件创建失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">dup2</span><span class="token punctuation">(</span>fileErr<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token operator">-&gt;</span>_fileno<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 重定向到 stderr 中</span>

                <span class="token comment">// 程序替换并不会影响原进程的文件描述符表，所以编译错误的话，错误信息会写入 .compile_err</span>
                <span class="token comment">// 程序替换, 负责编译文件</span>
                <span class="token function">execlp</span><span class="token punctuation">(</span><span class="token string">"g++"</span><span class="token punctuation">,</span> <span class="token string">"g++"</span><span class="token punctuation">,</span> <span class="token string">"-o"</span><span class="token punctuation">,</span> exe_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> src_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"-std=c++11"</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"g++ 程序替换失败, 编译失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token comment">// 编译完就退出</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 要等待子进程, 来检验是否生成了可执行程序</span>
                <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果存在这个文件的可执行文件, 那么就可以认为编译成功, 否则就是编译失败</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>exe_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> src_path <span class="token operator">&lt;&lt;</span> <span class="token string">" 成功生成可执行程序"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> src_path <span class="token operator">&lt;&lt;</span> <span class="token string">" 生成可执行文件失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="6__309"></a>6. 运行</h2> 
<p>大致思路：</p> 
<ul><li>如果编译成功，那么对应就会存在可执行文件，运行的时候就直接运行这个可执行文件。</li><li>创建子进程，让子进程发生程序替换执行这个可执行程序</li><li>该程序也应该有标准输入，标准输出，标准错误，所以在程序替换之前，需要分别打开对应的文件，并且进行重定向</li><li>父进程还需要等待子进程完成运行功能，并且获取子进程的退出结果，并裁去低 8 位，如果返回值为 0，说明一切顺利；如果返回值大于 0 ，说明程序运行时出现异常；如果返回值小于 0，说明出现了其他问题</li><li>补充：用户的代码在运行的时候不能过分占用资源，所以应该为用户代码运行资源设限制，比如 CPU 占用时间不能太长，申请的空间不能太多</li></ul> 
<h3><a id="61__317"></a>6.1 限制进程资源</h3> 
<p>Linux 中提供了限制进程资源的接口 <code>setrlimit</code> ，可以对 CPU 占用时间，内存空闲等等资源做限制</p> 
<ol><li>其中涉及到了一个结构体，<code>struct rlimit</code> 结构体，里面有两个成员，<code>rlim_max</code> 和 <code>rlim_cur</code>，分别表示资源的最大限制以及当前限制</li><li>也就是对于一个资源，对应的结构体需要填写两个属性，一个是最大限制，一个当前限制</li><li>当前限制可以控制进程在当前时间内对资源的限制，确保资源可以被合理地分配</li><li>最大限制是为了防止进程由于一些不可控因素导致资源过度使用，不过这里的最大限制我们就不关心了，具体还得看实际情况，所以设为最大值</li></ol> 
<pre><code class="prism language-cpp">        <span class="token comment">// 限制进程的资源, 并且 memory_limit 的单位是 KB</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LimitProcResource</span><span class="token punctuation">(</span><span class="token keyword">int</span> cpu_limit<span class="token punctuation">,</span> <span class="token keyword">int</span> memory_limit<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 设置 CPU 最大占用时长</span>
            <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> cpu<span class="token punctuation">;</span>
            cpu<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> RLIM_INFINITY<span class="token punctuation">;</span>         
            cpu<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> cpu_limit<span class="token punctuation">;</span>
            <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CPU<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 设置最大内存占用大小</span>
            <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> memory<span class="token punctuation">;</span>
            memory<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> RLIM_INFINITY<span class="token punctuation">;</span>
            memory<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> memory_limit <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
            <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="62_Run_342"></a>6.2 Run</h3> 
<p>于是 <code>Runner</code> 就可以对外提供一个跑用户代码的接口 <code>Run</code>，需要传入 文件名，CPU 限制，以及内存限制</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">Runner</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>

        <span class="token operator">~</span><span class="token function">Runner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 用于执行用户代码（可执行程序），只需要指明文件名就好了</span>
        <span class="token comment">// 如果返回值 &gt; 0 ，那么就是程序异常</span>
        <span class="token comment">// 如果返回值 == 0，运行正常, 没有异常</span>
        <span class="token comment">// 如果返回值 &lt; 0 ，那么就是其他问题</span>
        <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">Run</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> file_name<span class="token punctuation">,</span> <span class="token keyword">int</span> cpu_limit<span class="token punctuation">,</span> <span class="token keyword">int</span> memory_limit<span class="token punctuation">,</span> <span class="token keyword">int</span> question_id<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">const</span> string exe_path     <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ExePath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">// 这个可执行文件的路径</span>
            <span class="token keyword">const</span> string stdin_path   <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StdinPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 标准输入的路径</span>
            <span class="token keyword">const</span> string stdout_path  <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StdoutPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 标准输入的路径</span>
            <span class="token keyword">const</span> string stderr_path  <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StderrPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment">// 标准输出的路径</span>

            <span class="token function">umask</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> stdin_fd  <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>stdin_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> stdout_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>stdout_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> stderr_fd <span class="token operator">=</span> <span class="token function">open</span><span class="token punctuation">(</span>stderr_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> O_CREAT <span class="token operator">|</span> O_WRONLY<span class="token punctuation">,</span> <span class="token number">0644</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 将执行结果写入文件的读写 fd</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>stdin_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> stdout_fd <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> stderr_fd <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"文件打开失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            pid_t pid <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"创建子线程失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>stdin_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>stdout_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>stderr_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"开始执行"</span> <span class="token operator">&lt;&lt;</span> exe_path <span class="token operator">&lt;&lt;</span> <span class="token string">"文件"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"stdout_fd: "</span> <span class="token operator">&lt;&lt;</span> stdout_fd <span class="token operator">&lt;&lt;</span> <span class="token string">"  "</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"stdout: "</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">stdout</span><span class="token operator">-&gt;</span>_fileno <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token function">dup2</span><span class="token punctuation">(</span>stdin_fd<span class="token punctuation">,</span> <span class="token constant">stdin</span><span class="token operator">-&gt;</span>_fileno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">dup2</span><span class="token punctuation">(</span>stdout_fd<span class="token punctuation">,</span> <span class="token constant">stdout</span><span class="token operator">-&gt;</span>_fileno<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">dup2</span><span class="token punctuation">(</span>stderr_fd<span class="token punctuation">,</span> <span class="token constant">stderr</span><span class="token operator">-&gt;</span>_fileno<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">LimitProcResource</span><span class="token punctuation">(</span>cpu_limit<span class="token punctuation">,</span> memory_limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 执行程序替换, 并且携带一个参数 judge_fd, 也就是往 特定的文件 中写入数据</span>
                <span class="token function">execl</span><span class="token punctuation">(</span>exe_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exe_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
                <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"程序替换失败, 代码没能运行"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">close</span><span class="token punctuation">(</span>stdin_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>stdout_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">close</span><span class="token punctuation">(</span>stderr_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>


                <span class="token keyword">int</span> status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 <span class="token comment">// 获取子进程的退出结果</span>
                <span class="token function">waitpid</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 阻塞等待</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"等待判题完成"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"运行成功"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> status <span class="token operator">&amp;</span> <span class="token number">0x7F</span><span class="token punctuation">;</span>           <span class="token comment">// 返回进程的退出信号，如果是异常，就是正数</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 限制进程的资源, 并且 memory_limit 的单位是 KB</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">LimitProcResource</span><span class="token punctuation">(</span><span class="token keyword">int</span> cpu_limit<span class="token punctuation">,</span> <span class="token keyword">int</span> memory_limit<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 设置 CPU 最大占用时长</span>
            <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> cpu<span class="token punctuation">;</span>
            cpu<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> RLIM_INFINITY<span class="token punctuation">;</span>         
            cpu<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> cpu_limit<span class="token punctuation">;</span>
            <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_CPU<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 设置最大内存占用大小</span>
            <span class="token keyword">struct</span> <span class="token class-name">rlimit</span> memory<span class="token punctuation">;</span>
            memory<span class="token punctuation">.</span>rlim_max <span class="token operator">=</span> RLIM_INFINITY<span class="token punctuation">;</span>
            memory<span class="token punctuation">.</span>rlim_cur <span class="token operator">=</span> memory_limit <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
            <span class="token function">setrlimit</span><span class="token punctuation">(</span>RLIMIT_AS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>memory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="7__427"></a>7. 执行</h2> 
<p>至此为止，已经提供了编译 和 运行，接下来需要将这两个行为拼凑在一起，形成一个完成的服务，称为 执行 (<code>runtime</code>)</p> 
<p>接下来再创建一个文件 <code>runtime.hpp</code> ，其中提供一个类 <code>Runtime</code>，对外提供一个接口 <code>Start</code>，这个其实就是将编译和运行逻辑两个功能整合一下。</p> 
<p>大致思路：</p> 
<ul><li>编译的时候只知道了文件名，源文件的生成并不由编译负责，所以 <code>Start</code> 需要将用户代码写入到<code>.cpp</code> 文件中，再将文件名传给 <code>Compile</code> 接口，其会去编译这个 <code>.cpp</code> 文件</li><li>而文件名是 <code>Start</code> 中随机生成的一个全局唯一的字符串命名的，然后这个名字会以传参形式告知<code>Compile</code> 和 <code>Run</code></li><li><code>Compile</code> 函数编译完成之后，如果一切正常，那么可执行文件就可以顺利生成，此时就可以再调用 <code>Run</code> 函数来执行用户代码</li><li>记录 <code>Run</code> 函数的返回值，并将这个返回值转化成 对应的执行情况，比如 “代码运行成功”，“代码执行过程中发生段错误”</li><li>代码的编译，运行都会产生很多临时文件，所以在对一个用户请求构造完响应之后，需要将这个请求产生的中间文件都清理掉</li></ul> 
<p>补充：</p> 
<ul><li>当服务器收到请求之后，就会调用 <code>Start</code> 接口，所以 <code>Start</code> 需要网络中传输过来的 <code>json</code> 数据</li><li>同时，也需要将 <code>Start</code> 的运行结果转化成 <code>json</code> 形式的数据返回给前端</li><li>所以就需要用到序列化和反序列化</li></ul> 
<h3><a id="71_json_444"></a>7.1 json</h3> 
<p>安装 json 库，其中接口的使用可以看一下这篇文章 <a href="https://blog.csdn.net/jiangmin1994/article/details/106919980">jsoncpp 常用方法</a>，挺详细的</p> 
<pre><code class="prism language-shell">yum <span class="token function">install</span> jsoncpp-devel
</code></pre> 
<p>并且在编译的时候记得加上 <code>-ljsoncpp</code> 选项</p> 
<h3><a id="72_Start__451"></a>7.2 Start 参数</h3> 
<p>综上所述，我们内部规定：传到 <code>Start</code> 中的 <code>json</code> 数据需要有什么呢？</p> 
<ul><li><code>question_id</code>：当前用户写的题目对应的编号</li><li><code>cpu_limit</code>：就是上面说的，CPU 占用的时间，不同的题目可能会有不同的限制要求</li><li><code>memory_limit</code>：同上，内存的最大使用量</li><li><code>input</code>：可以是用户输入的测试用例，本文暂不实现</li><li><code>code</code>：用户运行的代码</li></ul> 
<p>那么 <code>Start</code> 函数完成之后，需要告知前端什么数据？</p> 
<ul><li><code>status</code>：该程序运行的状态码，可以自定义数字对应的含义，0 表示一切正常，&gt; 0 表示的是程序运行中发生的异常，比如发生段错误收到的 <code>SIGSEGV</code> 信号， &lt; 0 可以表示一些其他错误，比如 -1 表示代码为空，-2 表示编译不通过…</li><li><code>reason</code>：将 <code>status</code> 数字翻译成对应的信息描述</li><li><code>stdout</code>：编译成功且运行正常的程序，在运行过程中，可能会往标准输入和标准错误中打印数据，比如<code>cout &lt;&lt; "Debug: i = " &lt;&lt; i &lt;&lt; endl</code> 或者 <code>cerr &lt;&lt; ...</code>，那么这些数据也需要提取出来告知用户<br> 并且，在上文中 [ 6.2 运行 大致思路 ] 中提到了，我们将用户程序的标准输出 / 错误重定向到对应后缀的文件中了，所以 这里就是读文件操作</li><li><code>strerr</code>：同上 <code>stdout</code>，当然，这两个存在的前提是程序正常跑完了</li></ul> 
<p>然后将这些数据直接序列化成 <code>json</code> 数据，作为输出型参数传递给上层</p> 
<h3><a id="73_FileUtil_468"></a>7.3 FileUtil</h3> 
<p>所以，还需要在工具类 <code>FileUtil</code> 补充：生成全局唯一文件名，从文件中读取数据，往文件中写入数据的函数，清理产生的临时文件</p> 
<ul><li>生成全局唯一文件名<br> 直接通过 ms 级时间戳 + 全局唯一递增因子，进行拼接可以了</li></ul> 
<pre><code class="prism language-cpp">        <span class="token comment">// 生成唯一的文件名</span>
        <span class="token keyword">static</span> string <span class="token function">GetUniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 通过毫秒级时间戳 以及 原子性递增来保证唯一性</span>
            <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>atomic_uint <span class="token function">id</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            id <span class="token operator">++</span><span class="token punctuation">;</span>

            string ms_stamp <span class="token operator">=</span> <span class="token function">to_string</span><span class="token punctuation">(</span><span class="token class-name">TimeUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CurrentTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            string uid <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> ms_stamp <span class="token operator">+</span> <span class="token char">'_'</span> <span class="token operator">+</span> uid<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>从文件中写入数据<br> 传入一个文件路径，再传入要写入的文件，无脑写入就好</li></ul> 
<pre><code class="prism language-cpp">        <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">WriteToFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> tar<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> code<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            ofstream <span class="token function">out</span><span class="token punctuation">(</span>tar<span class="token punctuation">)</span><span class="token punctuation">;</span>               <span class="token comment">// 打开流</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>out<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token comment">// 如果没有被打卡</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            out<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            out<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>从文件中读取数据<br> 传入文件路径，这里可以区分一下：如果用户传入一个 true，那么将按文件原样读取内容到字符串中；如果传入一个 false，那么读取文件的时候会去掉换行符</li></ul> 
<pre><code class="prism language-cpp">        <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">ReadFromFile</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> tar<span class="token punctuation">,</span> string<span class="token operator">*</span> data<span class="token punctuation">,</span> <span class="token keyword">bool</span> newline<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            ifstream <span class="token function">in</span><span class="token punctuation">(</span>tar<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>in<span class="token punctuation">.</span><span class="token function">is_open</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>    <span class="token comment">// 如果没有打开</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            <span class="token comment">// 读取一行数据读到换行就停, 并且不会读取换行符</span>
            string line <span class="token punctuation">;</span>       
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">getline</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> line<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>data <span class="token operator">+=</span> line<span class="token punctuation">;</span>
                <span class="token operator">*</span>data <span class="token operator">+=</span> newline <span class="token operator">?</span> <span class="token string">"\n"</span> <span class="token operator">:</span> <span class="token string">""</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            in<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>清理产生的临时文件<br> 刚刚建立的各种文件，<code>.cpp</code>，<code>.compile_err</code>，<code>.stdout</code> 文件都是以 生成的唯一 <code>file_name</code> 为前缀的文件名，所以删除这些文件，传入 <code>file_name</code>，然后：如果文件存在，那删除</li></ul> 
<pre><code class="prism language-cpp">		<span class="token comment">// unlink: Linux 中提供的接口, 传入文件路径可以删除文件</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RemoveTempFiles</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> filename<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">SrcPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CompileErrPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ExePath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StdinPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StdoutPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            path <span class="token operator">=</span> <span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StderrPath</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>     <span class="token function">unlink</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="74_Start_550"></a>7.4 Start</h3> 
<p>所以最终 <code>Runtime</code> 代码如下</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">Runtime</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Start</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> in_json<span class="token punctuation">,</span> string<span class="token operator">*</span> out_json<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 将 json 数据反序列化成一个个具体的数据</span>
            Json<span class="token double-colon punctuation">::</span>Value root<span class="token punctuation">;</span>
            Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span>
            reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>in_json<span class="token punctuation">,</span> root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            string code      <span class="token operator">=</span> root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            string input     <span class="token operator">=</span> root<span class="token punctuation">[</span><span class="token string">"input"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> cpu_limit    <span class="token operator">=</span> root<span class="token punctuation">[</span><span class="token string">"cpu_limit"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> memory_limit <span class="token operator">=</span> root<span class="token punctuation">[</span><span class="token string">"memory_limit"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> question_id  <span class="token operator">=</span> root<span class="token punctuation">[</span><span class="token string">"question_id"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                     <span class="token comment">// 题目的编号</span>
            <span class="token comment">// 提取完成</span>

            <span class="token comment">// goto 中间的代码，不能出现变量的定义</span>
            Json<span class="token double-colon punctuation">::</span>Value ret_root<span class="token punctuation">;</span>
            <span class="token comment">// 获取唯一文件名</span>
            string file_name      <span class="token operator">=</span> <span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">GetUniqueName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> run_case         <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> final_status     <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token comment">// start 中最终的运行状态</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>code<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                final_status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> END<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取唯一性的文件名</span>
            <span class="token comment">// 将 code 中的代码写入到文件中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">WriteToFile</span><span class="token punctuation">(</span><span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">SrcPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"用户代码写入源文件中失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                final_status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> END<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 编译, 如果编译失败, 那么直接从这个 .compile_err 的文件中读取数据</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Compiler</span><span class="token double-colon punctuation">::</span><span class="token function">Compile</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                final_status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> END<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 获取 Run 函数的执行结果</span>
            run_case <span class="token operator">=</span> <span class="token class-name">Runner</span><span class="token double-colon punctuation">::</span><span class="token function">Run</span><span class="token punctuation">(</span>file_name<span class="token punctuation">,</span> cpu_limit<span class="token punctuation">,</span> memory_limit<span class="token punctuation">,</span> question_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>run_case <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                final_status <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span>
                <span class="token keyword">goto</span> END<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>run_case <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        <span class="token comment">// 程序出现异常, 就是收到了信号, 这时候返回值就是信号</span>
                final_status <span class="token operator">=</span> run_case<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>                          <span class="token comment">// 运行正常, 需要判断运行结果, 运行结果在 stdout 里面</span>
                final_status <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        END<span class="token operator">:</span>
            ret_root<span class="token punctuation">[</span><span class="token string">"status"</span><span class="token punctuation">]</span> <span class="token operator">=</span> final_status<span class="token punctuation">;</span>
            ret_root<span class="token punctuation">[</span><span class="token string">"reason"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">Translate</span><span class="token punctuation">(</span>final_status<span class="token punctuation">,</span> file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>final_status <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        <span class="token comment">// 全部运行顺利</span>
                string stdout_str<span class="token punctuation">;</span>
                <span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ReadFromFile</span><span class="token punctuation">(</span><span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StdoutPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stdout_str<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret_root<span class="token punctuation">[</span><span class="token string">"stdout"</span><span class="token punctuation">]</span> <span class="token operator">=</span> stdout_str<span class="token punctuation">;</span>

                string stderr_str<span class="token punctuation">;</span>
                <span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ReadFromFile</span><span class="token punctuation">(</span><span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">StderrPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>stderr_str<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ret_root<span class="token punctuation">[</span><span class="token string">"stderr"</span><span class="token punctuation">]</span> <span class="token operator">=</span> stderr_str<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            Json<span class="token double-colon punctuation">::</span>StyledWriter writer<span class="token punctuation">;</span>
            <span class="token operator">*</span>out_json <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ret_root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 然后去掉这些临时文件</span>
            <span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">RemoveTempFiles</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"删除文件"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// 将信号翻译成具体的原因</span>
        <span class="token keyword">static</span> string <span class="token function">Translate</span><span class="token punctuation">(</span><span class="token keyword">int</span> number<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> file_name<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string desc <span class="token punctuation">;</span>
            <span class="token keyword">switch</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
                desc <span class="token operator">=</span> <span class="token string">"代码运行成功"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1</span><span class="token operator">:</span>
                desc <span class="token operator">=</span> <span class="token string">"代码为空"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">2</span><span class="token operator">:</span> 
                desc <span class="token operator">=</span> <span class="token string">"未知错误"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">3</span><span class="token operator">:</span>    <span class="token comment">// -3 表示编译错误, 这时候就去 .compile_err 文件中读取编译错误的原因</span>
                <span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ReadFromFile</span><span class="token punctuation">(</span><span class="token class-name">PathUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CompileErrPath</span><span class="token punctuation">(</span>file_name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>desc<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SIGSEGV<span class="token operator">:</span>
                desc <span class="token operator">=</span> <span class="token string">"段错误"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SIGFPE<span class="token operator">:</span> 
                desc <span class="token operator">=</span> <span class="token string">"浮点数计算错误"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SIGABRT<span class="token operator">:</span> 
                desc <span class="token operator">=</span> <span class="token string">"内存溢出"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SIGXCPU<span class="token operator">:</span> 
                desc <span class="token operator">=</span> <span class="token string">"运行超时"</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">default</span><span class="token operator">:</span>
                desc <span class="token operator">=</span> <span class="token string">"未知错误 code = "</span> <span class="token operator">+</span> std<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> desc<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="8__669"></a>8. 启动服务</h2> 
<p>有了 <code>Start</code> 函数之后，上层只需要传递给 <code>Start</code> 函数 <code>json</code> 字符串，就可以获取到 这段代码 的编译，运行等相关情况了</p> 
<p>于是现在就需要一个能够接收到 服务请求的TCP服务器，这里使用开源库 <code>cpp-httplib</code></p> 
<h3><a id="81__httplib_673"></a>8.1 安装 httplib</h3> 
<p>安装网址：<a href="https://github.com/yhirose/cpp-httplib">cpp-httplib – github</a></p> 
<p>使用方式：将 <code>cpp-httplib.h</code> 文件直接放到项目文件夹中，用 <code>#include</code> 导入就好了</p> 
<p>但是这个玩意需要使用 高版本的 g++，所以这里还需要安装高版本的 g++，比如 7 版本</p> 
<pre><code class="prism language-shell"><span class="token function">sudo</span> yum instal1 centos-release-scl scl-utils-build

// 安装 G++ 高版本
<span class="token function">sudo</span> yum insta11 <span class="token parameter variable">-y</span> devtoolset-7-gcc devtoolset-7-gcc-c++
<span class="token function">ls</span> /opt/rh/

// 改用 g++ <span class="token number">7</span>, 仅本次登录 xshell 时有效
scl <span class="token builtin class-name">enable</span> devtoolset-7 <span class="token function">bash</span>
gcc <span class="token parameter variable">-v</span> 

// 然后在下面这个文件中添加上面那条 scl <span class="token builtin class-name">enable</span> <span class="token punctuation">..</span>. 命令，可以保持每次登录的时候都是高版本的 g++
<span class="token function">vim</span> ~/.bash_profile
</code></pre> 
<p><img src="https://images2.imgbox.com/64/2b/BXV0ZLXk_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="82_compile_servercpp_694"></a>8.2 compile_server.cpp</h3> 
<p>这里面放一个 <code>.cpp</code> 文件，使用 <code>httplib</code> 库中的接口启动一个服务器，用来接收用户的 代码 编译 / 运行请求，然后拿请求中用户发送的数据，交给 <code>Runtime.Start()</code> 处理，并将其返回的数据发回给前端</p> 
<pre><code class="prism language-cpp"><span class="token comment">// ./executor port 的方式运行, 也就是需要指定端口号</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>argc <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span>  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

    Server server<span class="token punctuation">;</span>

    <span class="token comment">// 注册这个路由以及它的回调函数</span>
    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/runtime"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Request<span class="token operator">&amp;</span> req<span class="token punctuation">,</span> Response<span class="token operator">&amp;</span> resp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 从 请求中的 body 获取 json 格式的数据, 包括用户代码, 题号等数据</span>
        string in_json <span class="token operator">=</span> req<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
        <span class="token comment">// 返回给前端的 json 数据, 输出型参数</span>
        string out_json <span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>in_json<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Runtime</span><span class="token double-colon punctuation">::</span><span class="token function">Start</span><span class="token punctuation">(</span>in_json<span class="token punctuation">,</span> <span class="token operator">&amp;</span>out_json<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"Start 执行完成"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            resp<span class="token punctuation">.</span><span class="token function">set_content</span><span class="token punctuation">(</span>out_json<span class="token punctuation">,</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 开始监听, 第二个参数是端口号</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="9__compiler_723"></a>9. 测试 compiler</h2> 
<p>至此，<code>executor (compiler)</code> 模块就差不多完成了，下文在项目主体完成之后，会有拓展，到时再来修改这里的代码。</p> 
<p>接下来我们测试一下：编写 <code>Makefile</code> 并执行</p> 
<pre><code class="prism language-shell">executor: compile_server.cpp
	g++ <span class="token parameter variable">-o</span> <span class="token variable">$@</span> $^ <span class="token parameter variable">-std</span><span class="token operator">=</span>c++11 <span class="token parameter variable">-ljsoncpp</span> <span class="token parameter variable">-lpthread</span> 

.PHONY:clean
clean:
	<span class="token function">rm</span> <span class="token parameter variable">-rf</span> executor 
</code></pre> 
<p><img src="https://images2.imgbox.com/28/10/2sN1V6k9_o.png" alt="在这里插入图片描述"></p> 
<p>⚠ 注意一下：<code>executor</code> 只负责编译运行程序，这里还不涉及到判题，所以我们用 postman 传一串 json 数据进去试试</p> 
<ul><li> <p>测试情况 1：代码耗时<br> <img src="https://images2.imgbox.com/6b/54/daHfMvAD_o.png" alt="在这里插入图片描述"><br> 响应：<br> <img src="https://images2.imgbox.com/87/5e/xzCFs8fV_o.png" alt="在这里插入图片描述"></p> </li><li> <p>测试情况 2：编译错误，代码少个分号<br> <img src="https://images2.imgbox.com/8a/3c/SBEmfbT7_o.png" alt="在这里插入图片描述">响应：<br> <img src="https://images2.imgbox.com/c4/f8/NIbzr9VY_o.png" alt="在这里插入图片描述"></p> </li><li> <p>测试情况 3：正常运行，并且代码需要打印数据 <code>hello</code><br> <img src="https://images2.imgbox.com/6f/6d/jPdPM7un_o.png" alt="在这里插入图片描述">响应：可以看出，该程序打印的数据也被提取了出来<br> <img src="https://images2.imgbox.com/7f/7d/oV6cmAO8_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h2><a id="10__754"></a>10. 梳理题目逻辑</h2> 
<p>在本项目中，一个单独的题目应该具有以下数据：</p> 
<ol><li>编号 <code>id</code></li><li>标题 <code>title</code></li><li>难度 <code>difficulty</code></li><li>题目描述 <code>desc</code></li><li>预代码 <code>pre_code</code></li><li>测试代码 <code>test_code</code></li><li>时间要求 <code>cpu_limit</code></li><li>空间要求 <code>memory_limit</code></li></ol> 
<p><strong>关于预代码 <code>pre_code</code></strong></p> 
<p>意思就是用户的代码，比如下面这个，同时也是用户写代码的地方</p> 
<p><img src="https://images2.imgbox.com/3c/49/vncNyADJ_o.png" alt="在这里插入图片描述"></p> 
<p><strong>测试代码 <code>test_code</code></strong></p> 
<p>这里需要针对每个题目设计测试用例，比如 <code>Test1(), Test2()...</code>等等，然后在 <code>main</code> 函数中调用这两个测试用例</p> 
<p><img src="https://images2.imgbox.com/55/ee/ggPcZ1QK_o.png" alt="在这里插入图片描述">所以最终的逻辑结构大致如下</p> 
<p><img src="https://images2.imgbox.com/ef/a8/xwlULLRT_o.png" alt="在这里插入图片描述">但是后续有个功能是需要记录用户的题目回答情况。处理方法是这样的：</p> 
<ol><li>程序替换的时候，传入一个参数 <code>fd</code>，这个 <code>fd</code> 就是记录该程序运行结果的文件对应的 <code>fd</code></li><li>最终程序即将运行完成的时候，将程序的运行结果写入到这个文件里面</li><li>后续主进程就可以去这个文件里面读数据，从而得到这个程序的运行情况，比如 100 个用例，用过了多少个，是否通过了所有的测试用例…</li><li>本文只记录是否通过所有的测试用例，所以只需要定义一个 <code>passed = 1</code> ，然后规定所有的测试用例方法返回值为 <code>int</code>，如果通过一个测试用例，那么返回 1，否则返回 0，然后让 <code>passed &amp;= test(1 - n)()</code>，如果其中一个不通过，那么 <code>passed</code> 最终就为 0</li><li>然后如果 <code>passed = 1</code> ，那么就往文件中写入 <code>1</code>，否则不写</li></ol> 
<p>那么这样的话，所有的 <code>test_code</code> 就有一个公共的代码段，可以将其读取出来。并且需要注意，这部分代码需要写入数据库中，所以相关的单引号和双引号需要注意格式</p> 
<p><img src="https://images2.imgbox.com/7e/e2/1C1dMXGW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="11__788"></a>11. 建表</h2> 
<p>然后在数据库中建立 [ 题库 ] 表，在这之前，因为远程登录的用户可能需要对表进行一系列操作，所以这里需要为他们授权</p> 
<pre><code class="prism language-cpp">   <span class="token number">1.</span> use mysql<span class="token punctuation">;</span>
   <span class="token number">2.</span> select User<span class="token punctuation">,</span> Host from user<span class="token punctuation">;</span>
   <span class="token number">3.</span> create user oj_client@<span class="token char">'%'</span> identified by <span class="token char">'123456'</span>
   <span class="token number">4.</span> create database oj_blog
   <span class="token number">5.</span> grant all on oj_blog<span class="token punctuation">.</span><span class="token operator">*</span> to oj_client@<span class="token char">'%'</span>  
   <span class="token number">6.</span> grant all on oj_blog<span class="token punctuation">.</span><span class="token operator">*</span> to oj_client@<span class="token char">'localhost'</span> 
</code></pre> 
<p>然后按照上面的要求建表</p> 
<pre><code class="prism language-sql"><span class="token keyword">use</span> oj_blog

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> questions <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    title <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    difficulty <span class="token keyword">VARCHAR</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    <span class="token identifier"><span class="token punctuation">`</span>desc<span class="token punctuation">`</span></span> <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    pre_code <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
    test_code <span class="token keyword">TEXT</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> 
    cpu_limit <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span><span class="token punctuation">,</span>
    memory_limit <span class="token keyword">INT</span> <span class="token keyword">DEFAULT</span> <span class="token number">50000</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<p>建完表之后，再插入一条数据方便测试</p> 
<pre><code class="prism language-cpp">insert <span class="token function">questions</span> <span class="token punctuation">(</span>title<span class="token punctuation">,</span> difficulty<span class="token punctuation">,</span> `desc`<span class="token punctuation">,</span> pre_code<span class="token punctuation">,</span> test_code<span class="token punctuation">)</span> <span class="token function">values</span> 
<span class="token punctuation">(</span><span class="token string">"两数之和"</span><span class="token punctuation">,</span> <span class="token string">"简单"</span><span class="token punctuation">,</span> 
'给定一个整数数组 nums 和一个整数目标值 target，请你在该数组中找出 和为目标值 target  的那 两个 整数，并返回它们的数组下标。

你可以假设每种输入只会对应一个答案。但是，数组中同一个元素在答案里不能重复出现。

你可以按任意顺序返回答案。

 

示例 <span class="token number">1</span>：

输入：nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token number">9</span>
输出：<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>
解释：因为 nums<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> nums<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">9</span> ，返回 <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span> 。

示例 <span class="token number">2</span>：

输入：nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token number">6</span>
输出：<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">]</span>

示例 <span class="token number">3</span>：

输入：nums <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> target <span class="token operator">=</span> <span class="token number">6</span>
输出：<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span>'<span class="token punctuation">,</span> 

'
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;map&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unordered_map&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;algorithm&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Solution</span> 
<span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">twoSum</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> nums<span class="token punctuation">,</span> <span class="token keyword">int</span> target<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>'<span class="token punctuation">,</span>
 '<span class="token keyword">int</span> <span class="token function">Test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> user_result <span class="token operator">=</span> <span class="token function">Solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">twoSum</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">answer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>answer <span class="token operator">!=</span> user_result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"用例 1 错误，预期结果为 [0, 1]"</span> <span class="token operator">&lt;&lt;</span>  endl<span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"用例 1 通过"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">Test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> user_result <span class="token operator">=</span> <span class="token function">Solution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">twoSum</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token function">answer</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>answer <span class="token operator">!=</span> user_result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"用例 2 错误，预期结果为 [1,2]"</span> <span class="token operator">&lt;&lt;</span>  endl<span class="token punctuation">;</span> 
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"用例 2 通过"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
<span class="token keyword">void</span> <span class="token function">WriteJudgeResult</span><span class="token punctuation">(</span><span class="token keyword">int</span> is_passed<span class="token punctuation">,</span> <span class="token keyword">int</span> fd<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>is_passed <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">char</span> result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> \'<span class="token number">1</span>\'<span class="token punctuation">;</span>
        <span class="token function">write</span><span class="token punctuation">(</span>fd<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>               
    <span class="token punctuation">}</span>
    <span class="token function">close</span><span class="token punctuation">(</span>fd<span class="token punctuation">)</span><span class="token punctuation">;</span>                          
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span><span class="token operator">*</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> is_passed <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token comment">// 判断是否通过所有测试用例, 1 表示通过全部, 0 表示一部分不通过</span>
    is_passed <span class="token operator">&amp;=</span> <span class="token function">Test1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 如果有一个方法返回 0 , 那么 is_passed 一直为 0</span>
    is_passed <span class="token operator">&amp;=</span> <span class="token function">Test2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">int</span> fd <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">WriteJudgeResult</span><span class="token punctuation">(</span>is_passed<span class="token punctuation">,</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>'<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="12__917"></a>12. 连接数据库</h2> 
<p>有了 <code>questions</code> 表之后，我们就可以直接查询这个表中的所有内容，来构建题库了，在这之前，需要先连接数据库，并且编写查询数据库的相关接口</p> 
<p>创建一个 <code>model</code> 类，来专门负责对数据库进行操作</p> 
<h3><a id="121_MySQL__922"></a>12.1 MySQL 库</h3> 
<p>而数据库，这里用的库的下载链接是：<a href="https://downloads.mysql.com/archives/c-c/" rel="nofollow">MySQL</a></p> 
<p><strong>安装过程</strong></p> 
<ol><li>可以直接下载到 Windows 中，然后将压缩包直接拖到 Linux 机器上</li><li>然后在自己的项目目录里面建立这个 玩意 的头文件和库的软链接，具体可以参考下面这个：（需要根据自己的实际文件目录修改）</li></ol> 
<pre><code class="prism language-shell"><span class="token function">ln</span> <span class="token parameter variable">-s</span> ~/third-party/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64/include include
<span class="token function">ln</span> <span class="token parameter variable">-s</span> ~/third-party/mysql-connector-c-6.1.11-linux-glibc2.12-x86_64/lib lib
</code></pre> 
<h3><a id="122__934"></a>12.2 查询操作</h3> 
<p>创建一个 <code>Model</code> 类，来专门实现对 MySQL 的访问，并且可以设计成单例模式</p> 
<ul><li>首先实现第一个接口 <code>visitMySQL(sql, result)</code> 然后利用 库 里面的接口，完成一个查询操作，这里查询特指的是 <code>select *</code> 的，就是需要获取一行的所有属性</li><li>并且这个函数可以设计成函数模板，类型 T，只要求对应的对象提供一个 <code>getObjectByRow</code>函数就好了（根据一行构建对象）</li></ul> 
<pre><code class="prism language-cpp">        <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span> <span class="token comment">// vect_out 输出型参数</span>
        <span class="token keyword">bool</span> <span class="token function">visitMySQL</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> sql<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">*</span>vect_out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"执行 SQL 语句: "</span> <span class="token operator">&lt;&lt;</span> sql <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token comment">// 开始执行 MySQL 的语句</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>WANING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> sql <span class="token operator">&lt;&lt;</span> <span class="token string">" 执行失败  | "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 提取结果, 这里是指针, 后面需要被释放</span>
            MYSQL_RES<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 分析结果, 获取行数</span>
            <span class="token keyword">int</span> rows <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> cols <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获取列数</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                MYSQL_ROW row_result <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取一行</span>
                T t<span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">getObjectByRow</span><span class="token punctuation">(</span>row_result<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// 根据 row_result 这一行来构建这个对象</span>
                vect_out<span class="token operator">-&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>			<span class="token comment">// 然后放进结果数组里面</span>
            <span class="token punctuation">}</span>

            <span class="token function">free</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// 释放结果空间</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>然后因为要从数据库中查出所有的题目，所以创建一个实体类 <code>Question</code>，里面的数据成员和数据库中的定义一样，然后提供 <code>getObjectByRow</code> 接口</li></ul> 
<pre><code class="prism language-cpp">    <span class="token keyword">struct</span> <span class="token class-name">Question</span>
    <span class="token punctuation">{<!-- --></span>
        string id<span class="token punctuation">;</span>              <span class="token comment">// 编号</span>
        string title<span class="token punctuation">;</span>           <span class="token comment">// 题目标题</span>
        string difficulty<span class="token punctuation">;</span>      <span class="token comment">// 难度, 简单，中等，困难</span>
        string desc<span class="token punctuation">;</span>            <span class="token comment">// 题目的描述</span>
        string pre_code<span class="token punctuation">;</span>        <span class="token comment">// 预代码</span>
        string test_code<span class="token punctuation">;</span>       <span class="token comment">// 测试用例, 需要和 pre_code 进行拼接</span>
        <span class="token keyword">int</span> cpu_limit<span class="token punctuation">;</span>          <span class="token comment">// 时间要求</span>
        <span class="token keyword">int</span> memory_limit<span class="token punctuation">;</span>       <span class="token comment">// 题目的空间要求（单位KB）</span>

        <span class="token keyword">void</span> <span class="token function">getObjectByRow</span><span class="token punctuation">(</span><span class="token keyword">const</span> MYSQL_ROW<span class="token operator">&amp;</span> row_result<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            id            <span class="token operator">=</span> row_result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            title         <span class="token operator">=</span> row_result<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            difficulty    <span class="token operator">=</span> row_result<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            desc          <span class="token operator">=</span> row_result<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            pre_code      <span class="token operator">=</span> row_result<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            test_code     <span class="token operator">=</span> row_result<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            cpu_limit     <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>row_result<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            memory_limit  <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>row_result<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>接着就可以很简单地实现获取题库所有题目的接口：</li></ul> 
<pre><code class="prism language-cpp">        <span class="token keyword">bool</span> <span class="token function">getAllQuestions</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Question<span class="token operator">&gt;</span><span class="token operator">*</span> vect_out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string sql <span class="token operator">=</span> <span class="token string">"select * from "</span><span class="token punctuation">;</span>
            sql <span class="token operator">+=</span> mysql_questions_table<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">visitMySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> vect_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ul><li>并且将 <code>Model</code> 设计成单例模式，全代码如下</li></ul> 
<pre><code class="prism language-cpp">    <span class="token keyword">const</span> string mysql_questions_table <span class="token operator">=</span> <span class="token string">"questions"</span><span class="token punctuation">;</span>           <span class="token comment">// 题库表的名字</span>
    <span class="token keyword">const</span> string mysql_database        <span class="token operator">=</span> <span class="token string">"oj_blog"</span><span class="token punctuation">;</span>             <span class="token comment">// 要操作的 database 名字</span>
    <span class="token keyword">const</span> string host                  <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span><span class="token punctuation">;</span>           <span class="token comment">// 连的机器</span>
    <span class="token keyword">const</span> string user                  <span class="token operator">=</span> <span class="token string">"oj_client"</span><span class="token punctuation">;</span>           <span class="token comment">// 身份</span>
    <span class="token keyword">const</span> string pwd                   <span class="token operator">=</span> <span class="token string">"password"</span><span class="token punctuation">;</span>      <span class="token comment">// 相应的密码</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> port                     <span class="token operator">=</span> <span class="token number">3306</span><span class="token punctuation">;</span>


    <span class="token comment">// 需要改造成单例模式</span>
    <span class="token keyword">class</span> <span class="token class-name">Model</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">static</span> Model<span class="token operator">*</span> model<span class="token punctuation">;</span>
        <span class="token keyword">static</span> mutex mtx<span class="token punctuation">;</span>
        MYSQL<span class="token operator">*</span> mysql<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">static</span> Model<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>model <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> model<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
        <span class="token keyword">bool</span> <span class="token function">visitMySQL</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> sql<span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> <span class="token operator">*</span>vect_out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"执行 SQL 语句: "</span> <span class="token operator">&lt;&lt;</span> sql <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token comment">// 开始执行 MySQL 的语句</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>WANING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> sql <span class="token operator">&lt;&lt;</span> <span class="token string">" 执行失败  | "</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 提取结果, 这里是指针, 后面需要被释放</span>
            MYSQL_RES<span class="token operator">*</span> result <span class="token operator">=</span> <span class="token function">mysql_store_result</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 分析结果, 获取行数</span>
            <span class="token keyword">int</span> rows <span class="token operator">=</span> <span class="token function">mysql_num_rows</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> cols <span class="token operator">=</span> <span class="token function">mysql_num_fields</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 获取列数</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> rows<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                MYSQL_ROW row_result <span class="token operator">=</span> <span class="token function">mysql_fetch_row</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">// 获取一行</span>
                T t<span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">getObjectByRow</span><span class="token punctuation">(</span>row_result<span class="token punctuation">)</span><span class="token punctuation">;</span>
                vect_out<span class="token operator">-&gt;</span><span class="token function">push_back</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token function">free</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// 释放结果空间</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">bool</span> <span class="token function">getAllQuestions</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Question<span class="token operator">&gt;</span><span class="token operator">*</span> vect_out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string sql <span class="token operator">=</span> <span class="token string">"select * from "</span><span class="token punctuation">;</span>
            sql <span class="token operator">+=</span> mysql_questions_table<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">visitMySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> vect_out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token function">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建 mysql 句柄</span>
            mysql <span class="token operator">=</span> <span class="token function">mysql_init</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">nullptr</span> <span class="token operator">==</span> <span class="token function">mysql_real_connect</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> host<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                                              pwd<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mysql_database<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token keyword">nullptr</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"连接数据库失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"连接数据库成功"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token comment">// 设置编码集</span>
            <span class="token function">mysql_set_character_set</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> <span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token function">Model</span><span class="token punctuation">(</span><span class="token keyword">const</span> Model<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        Model<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Model<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        <span class="token operator">~</span><span class="token function">Model</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 关闭 mysql 连接</span>
            <span class="token function">mysql_close</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    Model<span class="token operator">*</span> Model<span class="token double-colon punctuation">::</span>model <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    mutex Model<span class="token double-colon punctuation">::</span>mtx<span class="token punctuation">;</span>
</code></pre> 
<h2><a id="13__1098"></a>13. 题目页面</h2> 
<ul><li>创建一个 <code>controller</code> 类来负责处理所有的业务，当然 <code>controller</code> 也需要 <code>model*</code> 成员来方便操作数据库</li><li>除此之外，还需要 <code>view</code> 模块，来将 <code>controller</code> 处理完成的业务数据转化成前端的页面</li></ul> 
<h3><a id="131_ctemplate_1102"></a>13.1 ctemplate</h3> 
<p>想要对页面进行动态地渲染的话，这里使用的库是 <code>ctemplate</code></p> 
<p><strong>安装 ctemplate</strong></p> 
<pre><code class="prism language-shell"><span class="token number">1</span>. <span class="token function">git</span> clone https://hub.fastgit.xyz/OlafvdSpek/ctemplate.git
<span class="token number">2</span>. ./autogen.sh 
<span class="token number">3</span>. ./configure
<span class="token number">4</span>. <span class="token function">make</span> 	
编译
<span class="token number">5</span>. <span class="token function">make</span> <span class="token function">install</span> 
安装到系统中
</code></pre> 
<p>如果出现了问题：顺利安装，编译也能通过，但是运行的时候报错，错误是找不到共享库的位置</p> 
<pre><code class="prism language-shell">那么需要找到安装的 ctemplate 里面库，cd 到库文件夹 ctemplate/.libs 中，然后执行
<span class="token function">cp</span> * /lib64 
<span class="token function">cp</span> * /usr/lib64
ldconfig
</code></pre> 
<p>然后是相关的接口使用：</p> 
<ol><li><code> ctemplate::TemplateDictionary* sub_dict = dict.AddSectionDictionary("single_question");</code> 创建一个数据字典，可以通过 <code>dict.SetValue()</code>接口来构建 <code>HTML</code> 页面和想要渲染的数据的映射关系，比如下面这图</li><li>然后生成 HTML 页面 <code> ctemplate::Template *tpl = ctemplate::Template::GetTemplate(src_html, ctemplate::DO_NOT_STRIP);</code>这里的 <code>src_html</code> 就是需要别动态渲染的 HTML 文件路径</li><li>最后传入 输出型参数，以及字典地址，就可以完成页面的渲染了 <code> tpl-&gt;Expand(out_html, &amp;dict);</code></li></ol> 
<p><img src="https://images2.imgbox.com/d9/50/aKq2hjbC_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="132__1132"></a>13.2 前端题库页面</h3> 
<p>然后统一：将需要动态渲染的页面放在一个统一的文件夹中，这里定为 <code>temphtml</code> 即渲染</p> 
<p>然后首先制作一个基础的前端题库页面</p> 
<pre><code class="prism language-cpp"><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html lang<span class="token operator">=</span><span class="token string">"en"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta charset<span class="token operator">=</span><span class="token string">"UTF-8"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta http<span class="token operator">-</span>equiv<span class="token operator">=</span><span class="token string">"X-UA-Compatible"</span> content<span class="token operator">=</span><span class="token string">"IE=edge"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta name<span class="token operator">=</span><span class="token string">"viewport"</span> content<span class="token operator">=</span><span class="token string">"width=device-width, initial-scale=1.0"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>link rel<span class="token operator">=</span><span class="token string">"stylesheet"</span> href<span class="token operator">=</span><span class="token string">"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"</span><span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>OJ 题库<span class="token operator">&lt;</span><span class="token operator">/</span>title<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span>style<span class="token operator">&gt;</span>
        <span class="token operator">*</span> <span class="token punctuation">{<!-- --></span>
            margin<span class="token operator">:</span> <span class="token number">0</span>px<span class="token punctuation">;</span>
            padding<span class="token operator">:</span> <span class="token number">0</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 将导航栏和游览器周围取消贴合 */</span>
        body <span class="token punctuation">{<!-- --></span>
            width<span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            height<span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            background<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token number">232425</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 不要紧紧挨在一起 */</span>
        <span class="token punctuation">.</span>header <span class="token punctuation">{<!-- --></span>
            top<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            left<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            right<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            z<span class="token operator">-</span>index<span class="token operator">:</span> <span class="token number">9999</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>header <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 设置导航栏的背景颜色 */</span>
            background<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token number">2f</span>3233<span class="token punctuation">;</span>
            <span class="token comment">/* 文本颜色 */</span>
            color<span class="token operator">:</span> #fff<span class="token punctuation">;</span>
            <span class="token comment">/* 设置内边距 */</span>
            padding<span class="token operator">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        nav ul <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 导航栏使用横向排列 */</span>
            list<span class="token operator">-</span>style<span class="token operator">-</span>type<span class="token operator">:</span> none<span class="token punctuation">;</span>
            margin<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            padding<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        
        nav ul <span class="token punctuation">.</span>left <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 导航栏链接之间的右边距 */</span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        nav ul <span class="token punctuation">.</span>left <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 导航栏链接之间的右边距 */</span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">30</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        nav ul li a <span class="token punctuation">{<!-- --></span>
            color<span class="token operator">:</span> #fff<span class="token punctuation">;</span>
            font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">2.0</span>ch<span class="token punctuation">;</span>
            <span class="token comment">/* 去除下划线 */</span>
            text<span class="token operator">-</span>decoration<span class="token operator">:</span> none<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
        nav ul li a<span class="token operator">:</span>hover <span class="token punctuation">{<!-- --></span>
            <span class="token comment">/* 鼠标悬停的时候, 链接下面有下划线效果 */</span>
            text<span class="token operator">-</span>decoration<span class="token operator">:</span> underline<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/* 题库 */</span>
        <span class="token comment">/* 开始制作题单 */</span>
        <span class="token punctuation">.</span>leetcode <span class="token punctuation">{<!-- --></span>
            display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
            background<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token number">232425</span><span class="token punctuation">;</span>
            flex<span class="token operator">-</span>direction<span class="token operator">:</span> column<span class="token punctuation">;</span>
            align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
            font<span class="token operator">-</span>family<span class="token operator">:</span> Arial<span class="token punctuation">,</span> sans<span class="token operator">-</span>serif<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token punctuation">.</span>title <span class="token punctuation">{<!-- --></span>
            font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">28</span>px<span class="token punctuation">;</span>
            color<span class="token operator">:</span> #ccc<span class="token punctuation">;</span>
            font<span class="token operator">-</span>weight<span class="token operator">:</span> bold<span class="token punctuation">;</span>
            margin<span class="token operator">-</span>bottom<span class="token operator">:</span> <span class="token number">8</span>px<span class="token punctuation">;</span>
            padding<span class="token operator">-</span>top<span class="token operator">:</span> <span class="token number">20</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>table <span class="token punctuation">{<!-- --></span>
            display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
            flex<span class="token operator">-</span>direction<span class="token operator">:</span> column<span class="token punctuation">;</span>
            width<span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>row <span class="token punctuation">{<!-- --></span>
            display<span class="token operator">:</span> flex<span class="token punctuation">;</span>
            align<span class="token operator">-</span>items<span class="token operator">:</span> center<span class="token punctuation">;</span>
            padding<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
            border<span class="token operator">-</span>bottom<span class="token operator">:</span> <span class="token number">1</span>px solid #ddd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>row<span class="token operator">:</span>last<span class="token operator">-</span>child <span class="token punctuation">{<!-- --></span>
            border<span class="token operator">-</span>bottom<span class="token operator">:</span> none<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>status <span class="token punctuation">{<!-- --></span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
            width<span class="token operator">:</span> <span class="token number">50</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>problem <span class="token punctuation">{<!-- --></span>
            width<span class="token operator">:</span> <span class="token number">100</span>px<span class="token punctuation">;</span>
            flex<span class="token operator">-</span>grow<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">;</span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>problem a <span class="token punctuation">{<!-- --></span>
            text<span class="token operator">-</span>decoration<span class="token operator">:</span> none<span class="token punctuation">;</span>
            color<span class="token operator">:</span> white<span class="token punctuation">;</span>
            transition<span class="token operator">:</span> <span class="token number">0.3</span>s<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>problem a<span class="token operator">:</span>hover <span class="token punctuation">{<!-- --></span>
            color<span class="token operator">:</span> cyan<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>solution<span class="token operator">-</span>num <span class="token punctuation">{<!-- --></span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
            width<span class="token operator">:</span> <span class="token number">50</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>solution<span class="token operator">-</span>num a <span class="token punctuation">{<!-- --></span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
            color<span class="token operator">:</span> white<span class="token punctuation">;</span>
            text<span class="token operator">-</span>decoration<span class="token operator">:</span> none<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>difficulty <span class="token punctuation">{<!-- --></span>
            padding<span class="token operator">:</span> <span class="token number">5</span>px <span class="token number">10</span>px<span class="token punctuation">;</span>
            border<span class="token operator">-</span>radius<span class="token operator">:</span> <span class="token number">4</span>px<span class="token punctuation">;</span>
            margin<span class="token operator">-</span>left<span class="token operator">:</span> <span class="token number">40</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>简单 <span class="token punctuation">{<!-- --></span>
            color<span class="token operator">:</span> #<span class="token number">61ffff</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>中等 <span class="token punctuation">{<!-- --></span>
            color<span class="token operator">:</span> #ffea3e<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>困难 <span class="token punctuation">{<!-- --></span>
            color<span class="token operator">:</span> #d35580<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>rate <span class="token punctuation">{<!-- --></span>
            margin<span class="token operator">-</span>right<span class="token operator">:</span> <span class="token number">10</span>px<span class="token punctuation">;</span>
            color<span class="token operator">:</span> white<span class="token punctuation">;</span>
            width<span class="token operator">:</span> <span class="token number">50</span>px<span class="token punctuation">;</span>
            margin<span class="token operator">-</span>left<span class="token operator">:</span> <span class="token number">40</span>px<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>frequency <span class="token punctuation">{<!-- --></span>
            margin<span class="token operator">-</span>left<span class="token operator">:</span> <span class="token number">40</span>px<span class="token punctuation">;</span>
            width<span class="token operator">:</span> <span class="token number">60</span>px<span class="token punctuation">;</span>
            color<span class="token operator">:</span> white<span class="token punctuation">;</span>
            font<span class="token operator">-</span>style<span class="token operator">:</span> italic<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span>footer <span class="token punctuation">{<!-- --></span>
            position<span class="token operator">:</span> fixed<span class="token punctuation">;</span>
            bottom<span class="token operator">:</span> <span class="token number">7</span>px<span class="token punctuation">;</span>
            width<span class="token operator">:</span> <span class="token number">100</span><span class="token operator">%</span><span class="token punctuation">;</span>
            text<span class="token operator">-</span>align<span class="token operator">:</span> center<span class="token punctuation">;</span>
            background<span class="token operator">-</span>color<span class="token operator">:</span> #<span class="token number">232425</span><span class="token punctuation">;</span>
            background<span class="token operator">:</span> linear<span class="token operator">-</span><span class="token function">gradient</span><span class="token punctuation">(</span>to right<span class="token punctuation">,</span> #<span class="token number">00f</span><span class="token punctuation">,</span> #<span class="token number">00ffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">-</span>webkit<span class="token operator">-</span>background<span class="token operator">-</span>clip<span class="token operator">:</span> text<span class="token punctuation">;</span>
            <span class="token operator">-</span>webkit<span class="token operator">-</span>text<span class="token operator">-</span>fill<span class="token operator">-</span>color<span class="token operator">:</span> transparent<span class="token punctuation">;</span>
            font<span class="token operator">-</span>size<span class="token operator">:</span> <span class="token number">2.1</span>vh<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token operator">&lt;</span><span class="token operator">/</span>style<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"header"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 设置导航部分 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>nav<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> <span class="token operator">/</span> 就是跳转到默认的地方 <span class="token operator">--</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>i <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"fas fa-graduation-cap"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>i<span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/"</span> style<span class="token operator">=</span><span class="token string">"margin-left: 15px;"</span><span class="token operator">&gt;</span>首页<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/list"</span> style<span class="token operator">=</span><span class="token string">"color: yellow;"</span><span class="token operator">&gt;</span>题库<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span><span class="token operator">&gt;</span>竞赛<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span><span class="token operator">&gt;</span>讨论<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span><span class="token operator">&gt;</span>求职<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"left"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"../entry.html"</span> style<span class="token operator">=</span><span class="token string">"color: yellow;"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>entry_question<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>

                <span class="token operator">&lt;</span>li <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"login"</span> style<span class="token operator">=</span><span class="token string">"margin-left: auto;"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"login_and_reg.html"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>welcome<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>nav<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 导航栏结束 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 题库开始 <span class="token operator">--</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"main"</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 左边内容 <span class="token operator">--</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"main-left"</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 设置题库开始 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"leetcode"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"title"</span><span class="token operator">&gt;</span>题库<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"table"</span><span class="token operator">&gt;</span> 
                    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 标题 <span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div llass<span class="token operator">=</span><span class="token string">"status"</span> style<span class="token operator">=</span><span class="token string">"color: white; width: 50px; margin-right: 10px;"</span><span class="token operator">&gt;</span>️状态<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"problem"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span><span class="token operator">&gt;</span>题目<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"solution-num"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span><span class="token operator">&gt;</span>题解<span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"rate"</span><span class="token operator">&gt;</span>通过率<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"difficulty"</span> style<span class="token operator">=</span><span class="token string">"color: white;"</span><span class="token operator">&gt;</span>难度<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"frequency"</span><span class="token operator">&gt;</span>频率<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>

                    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 主体  <span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 循环的开始用 # <span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>#single_question<span class="token punctuation">}</span><span class="token punctuation">}</span>
                    <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> ✔ <span class="token operator">--</span><span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"status"</span><span class="token operator">&gt;</span>️<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>design<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"problem"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"/question/{<!-- -->{id}}"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>id<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token operator">&amp;</span>nbsp<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>title<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"solution-num"</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"#"</span><span class="token operator">&gt;</span><span class="token number">250</span><span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"rate"</span><span class="token operator">&gt;</span><span class="token number">56</span><span class="token operator">%</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"difficulty {<!-- -->{difficulty}}"</span><span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>difficulty<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                        <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"frequency"</span><span class="token operator">&gt;</span>高<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
                    <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 循环的结束用 <span class="token operator">/</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
                    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">/</span>single_question<span class="token punctuation">}</span><span class="token punctuation">}</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 设置题库结束 <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"footer"</span><span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span>h4<span class="token operator">&gt;</span>@CSDN<span class="token operator">:</span> https<span class="token operator">:</span><span class="token comment">//blog.csdn.net/weixin_63519461&lt;/h4&gt;</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> 
<p>然后是 <code>view</code> 中渲染题库的代码</p> 
<pre><code class="prism language-cpp">
        <span class="token comment">// 渲染所有题目的 html 页面</span>
        <span class="token keyword">void</span> <span class="token function">renderAllQuestions</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>Question<span class="token operator">&gt;</span><span class="token operator">&amp;</span> all<span class="token punctuation">,</span> string<span class="token operator">*</span> out_html<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 形成路径 </span>
            string src_html <span class="token operator">=</span> temphtml_path <span class="token operator">+</span> <span class="token string">"all_questions.html"</span><span class="token punctuation">;</span>
            <span class="token comment">// 数据字典</span>
            ctemplate<span class="token double-colon punctuation">::</span>TemplateDictionary <span class="token function">dict</span> <span class="token punctuation">(</span><span class="token string">"all_questions"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 起个名</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> Question<span class="token operator">&amp;</span> q <span class="token operator">:</span> all<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 这个 single_question 和 html 页面里面的 每一个循环中的名字有关系</span>
                ctemplate<span class="token double-colon punctuation">::</span>TemplateDictionary<span class="token operator">*</span> sub_dict <span class="token operator">=</span> dict<span class="token punctuation">.</span><span class="token function">AddSectionDictionary</span><span class="token punctuation">(</span><span class="token string">"single_question"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                sub_dict<span class="token operator">-&gt;</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sub_dict<span class="token operator">-&gt;</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
                sub_dict<span class="token operator">-&gt;</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"difficulty"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>difficulty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 3. 生成 html 页面</span>
            ctemplate<span class="token double-colon punctuation">::</span>Template <span class="token operator">*</span>tpl <span class="token operator">=</span> ctemplate<span class="token double-colon punctuation">::</span><span class="token class-name">Template</span><span class="token double-colon punctuation">::</span><span class="token function">GetTemplate</span><span class="token punctuation">(</span>src_html<span class="token punctuation">,</span> ctemplate<span class="token double-colon punctuation">::</span>DO_NOT_STRIP<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 4. 完成最终渲染</span>
            tpl<span class="token operator">-&gt;</span><span class="token function">Expand</span><span class="token punctuation">(</span>out_html<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>然后 <code>controller</code> 就可以调用渲染的函数了</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">Controller</span> 
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        Model<span class="token operator">*</span> model<span class="token punctuation">;</span>
        View view<span class="token punctuation">;</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">Controller</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
            <span class="token operator">:</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token class-name">Model</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token comment">// 根据题目数据构建网页, html 是一个输出型参数</span>
        <span class="token keyword">bool</span> <span class="token function">getAllQuestions</span><span class="token punctuation">(</span>string<span class="token operator">*</span> html<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">bool</span> ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            vector<span class="token operator">&lt;</span>Question<span class="token operator">&gt;</span> all<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">getAllQuestions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>all<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>              <span class="token comment">// 获取题库中所有题目的数据, 存放在 vector all 中</span>
                <span class="token function">sort</span><span class="token punctuation">(</span>all<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> all<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Question x<span class="token punctuation">,</span> <span class="token keyword">const</span> Question y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">return</span> <span class="token function">atoi</span><span class="token punctuation">(</span>x<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token function">atoi</span><span class="token punctuation">(</span>y<span class="token punctuation">.</span>id<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 将所有的题目数据 来 构建 html 页面</span>
                view<span class="token punctuation">.</span><span class="token function">renderAllQuestions</span><span class="token punctuation">(</span>all<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>html <span class="token operator">=</span> <span class="token string">"获取题目列表失败"</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="133__1446"></a>13.3 接收请求</h3> 
<p>然后就可以在 <code>ojserver</code> 里面利用 <code>httplib</code> 创建一个服务器了，然后注册路由，当有请求发送的时候，就会调用 <code>controller.getAllQuestions()</code> ，然后将渲染好的前端页面直接返回给前端</p> 
<pre><code class="prism language-cpp"><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Controller ctrl<span class="token punctuation">;</span>
    <span class="token comment">// 用户请求的服务路由功能</span>
    Server server<span class="token punctuation">;</span>

    <span class="token comment">// 获取题目页面</span>
    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token string">"/list"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>ctrl<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Request<span class="token operator">&amp;</span> req<span class="token punctuation">,</span> Response<span class="token operator">&amp;</span> resp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 返回所有题目的 html 网页</span>
        string html<span class="token punctuation">;</span>
        ctrl<span class="token punctuation">.</span><span class="token function">getAllQuestions</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 直接以 html 的数据格式返回</span>
        resp<span class="token punctuation">.</span><span class="token function">set_content</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">"text/html; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



    <span class="token comment">// 设置基础目录</span>
    server<span class="token punctuation">.</span><span class="token function">set_base_dir</span><span class="token punctuation">(</span><span class="token string">"./web"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">"0.0.0.0"</span><span class="token punctuation">,</span> <span class="token number">44444</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"服务器终止"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后编译程序，运行之后，访问，就可以看到对应题库页面了</p> 
<p><img src="https://images2.imgbox.com/b6/d5/viAiiYUj_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="14__1479"></a>14. 单个题目</h2> 
<p>题库和单个题库的编写页思路是大致一样的，只不过单个题目的编写需要用到在线的编辑器，ACE 编辑器</p> 
<ol><li>首先在 Model 类中编写第二个接口，根据 <code>question_id</code> 获得题目的具体对象</li></ol> 
<pre><code class="prism language-cpp">        <span class="token keyword">bool</span> <span class="token function">getQuestionById</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span> Question<span class="token operator">*</span> ques_out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string sql <span class="token operator">=</span> <span class="token string">"select * from "</span> <span class="token operator">+</span> mysql_questions_table <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">;</span>
            sql <span class="token operator">+=</span> <span class="token string">"where id = "</span><span class="token punctuation">;</span>
            sql <span class="token operator">+=</span> id<span class="token punctuation">;</span>
            vector<span class="token operator">&lt;</span>Question<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">visitMySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token operator">*</span>ques_out <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="2"><li>编写 <code>view</code> 模块中渲染单个页面的代码，out_html 是输出型参数，是渲染完的 HTML 页面字符串</li></ol> 
<pre><code class="prism language-cpp">        <span class="token comment">// 渲染 单个题目 的 html 页面</span>
        <span class="token keyword">void</span> <span class="token function">renderSingleQuestion</span><span class="token punctuation">(</span><span class="token keyword">const</span> Question<span class="token operator">&amp;</span> q<span class="token punctuation">,</span> string<span class="token operator">*</span> out_html<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            string src_html <span class="token operator">=</span> temphtml_path <span class="token operator">+</span> <span class="token string">"single_question.html"</span><span class="token punctuation">;</span>

            ctemplate<span class="token double-colon punctuation">::</span>TemplateDictionary <span class="token function">dict</span><span class="token punctuation">(</span><span class="token string">"single_question"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            dict<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dict<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"title"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>title<span class="token punctuation">)</span><span class="token punctuation">;</span>
            dict<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"difficulty"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>difficulty<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 换行的问题可以交给 &lt;pre&gt; 标签, 它可以最大限度地保留文本的原貌</span>
            dict<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"desc"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>desc<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 实现换行效果</span>
            dict<span class="token punctuation">.</span><span class="token function">SetValue</span><span class="token punctuation">(</span><span class="token string">"pre_code"</span><span class="token punctuation">,</span> q<span class="token punctuation">.</span>pre_code<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 生成 html 页面(可能并未完成渲染，我的理解), 这里的 src_html 是一个路径</span>
            <span class="token comment">// 这里估计就是完成一些字符串替换的工作，真正 Expand 才是返回真正的 html 页面</span>
            ctemplate<span class="token double-colon punctuation">::</span>Template<span class="token operator">*</span> tpl <span class="token operator">=</span> ctemplate<span class="token double-colon punctuation">::</span><span class="token class-name">Template</span><span class="token double-colon punctuation">::</span><span class="token function">GetTemplate</span><span class="token punctuation">(</span>src_html<span class="token punctuation">,</span> ctemplate<span class="token double-colon punctuation">::</span>DO_NOT_STRIP<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 开始渲染, 最终的结果放在 html 里面</span>
            tpl<span class="token operator">-&gt;</span><span class="token function">Expand</span><span class="token punctuation">(</span>out_html<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dict<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>然后是 <code>controller</code>：</li></ol> 
<pre><code class="prism language-cpp">        <span class="token keyword">bool</span> <span class="token function">getQuestionById</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span> string<span class="token operator">*</span> html<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">bool</span> ret <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            Question q<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">getQuestionById</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        <span class="token comment">// 获取单个题目的具体信息</span>
                view<span class="token punctuation">.</span><span class="token function">renderSingleQuestion</span><span class="token punctuation">(</span>q<span class="token punctuation">,</span> html<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token operator">*</span>html <span class="token operator">=</span> <span class="token string">"获取指定题目 "</span> <span class="token operator">+</span> q<span class="token punctuation">.</span>id <span class="token operator">+</span> <span class="token string">" 题目失败"</span><span class="token punctuation">;</span>
                ret <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>接着是 <code>ojserver.cpp</code> 中给服务器注册一项服务<br> 这里需要规定：在访问具体某一个题目的时候，<code>url</code> 中要带上题号，下面的 <code>/question/(\d+)</code> 后边的 d 表示匹配任意数字，并且可以通过 <code>req</code> 中的 <code>matches</code> 数组获取这个参数</li></ol> 
<pre><code class="prism language-cpp">    server<span class="token punctuation">.</span><span class="token function">Get</span><span class="token punctuation">(</span><span class="token raw-string string">R"(/question/(\d+))"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>ctrl<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Request<span class="token operator">&amp;</span> req<span class="token punctuation">,</span> Response<span class="token operator">&amp;</span> resp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        string question_id <span class="token operator">=</span> req<span class="token punctuation">.</span>matches<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        string html<span class="token punctuation">;</span>
        ctrl<span class="token punctuation">.</span><span class="token function">getQuestionById</span><span class="token punctuation">(</span>question_id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">set_content</span><span class="token punctuation">(</span>html<span class="token punctuation">,</span> <span class="token string">"text/html; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="5"><li>然后编译，执行，访问一下这个服务试试效果；<br> <img src="https://images2.imgbox.com/d1/86/KNBLjSn6_o.png" alt="在这里插入图片描述"></li></ol> 
<h2><a id="15__1553"></a>15. 负载均衡</h2> 
<p>在上面的 <code>single_question</code> 页面中，当用户提交代码的时候，首先应该由 <code>ojserver</code> 服务器接收到这个请求，然后再由 <code>ojserver</code> 判断所有的 <code>compiler</code> 负载最小的机器，再进行后续操作</p> 
<h3><a id="151_Machine_1556"></a>15.1 Machine</h3> 
<p>想要管理这些 <code>compiler</code> 服务器，就需要对他们抽象起来进行管理，所以可以使用 <code>Machine</code> 类管理，为了知道该服务器的负载情况，添加一个字段 <code>load</code> 表示现在正在处理的请求数量就好了，并且对外提供操作 <code>load</code> 的函数，并且可能同一时间会有多个请求，所以 <code>load</code> 需要加锁保护</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">struct</span> <span class="token class-name">Machine</span>
    <span class="token punctuation">{<!-- --></span>
        string ip<span class="token punctuation">;</span>              <span class="token comment">// 该负载机器的 ip</span>
        <span class="token keyword">int</span> port<span class="token punctuation">;</span>               <span class="token comment">// 该负载机器的 port</span>
        <span class="token keyword">uint64_t</span> load<span class="token punctuation">;</span>          <span class="token comment">// 该编译服务器的负载, 将来可能会有很多请求到这个机器上, 所以需要及时为这个 load 做更新</span>
        mutex<span class="token operator">*</span> mtx<span class="token punctuation">;</span>            
        
        <span class="token function">Machine</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token function">ip</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">port</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">,</span> <span class="token function">mtx</span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">loadIncrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 负载增加</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">++</span> load<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">loadDecrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment">// 负载减少</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">--</span> load<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">uint64_t</span> <span class="token function">getLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 			<span class="token comment">// 获取当前机器的负载情况 </span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">uint64_t</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            result <span class="token operator">=</span> load<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">void</span> <span class="token function">resetLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span>			<span class="token comment">// 将负载情况归 0</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            load <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>mtx <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span>     mtx<span class="token operator">-&gt;</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="152_LoadBalancer_1607"></a>15.2 LoadBalancer</h3> 
<p>这个类负责从所有的 <code>compiler</code> 中选择一个负载最小的，所以需要对这些 <code>Machine</code> 进行管理</p> 
<ol><li>该类在初始化的时候，就需要获取所有 <code>compiler</code> 的信息，关于这些 机器 的信息，可以写在文件里，然后在构造函数中读取出来并添加到容器中管理，并且默认这些机器具有能力接收请求<br> <img src="https://images2.imgbox.com/d1/08/CjjaVbiu_o.png" alt="在这里插入图片描述"></li><li>用三个容器管理这些 <code>Machine</code> ，第一个 <code>all_machines</code> 数组，下标表示这个 <code>Machine</code> 的 ID，内容表示这个 <code>Machine</code> 的相关属性；第二个 <code>online</code> 数组，存储所有正在工作或者等待接收工作的 <code>Machine</code> 下标，这个下标就是在 <code>all_machine</code> 里面的下标；第三个 <code>offline</code>，存储所有下线 / 崩溃导致异常 的机器下标</li><li>还需要提供让主机重新上线，或者下线的能力</li><li>最重要的还是，选择负载最小的主机，并返回这个机器的相关信息，同样，选择合适的机器的时候需要加锁保护</li></ol> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">LoadBalancer</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token comment">// 所有 Machines, 每一台主机都有自己的下标, 每个主机都有自己主机的 ID</span>
        vector<span class="token operator">&lt;</span>Machine<span class="token operator">&gt;</span> all_machines<span class="token punctuation">;</span>    
        <span class="token comment">// 所有在线主机的 ID </span>
        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> online<span class="token punctuation">;</span>
        <span class="token comment">// 所有离线主机的 ID</span>
        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> offline<span class="token punctuation">;</span>
        <span class="token comment">// 保证负载均衡的时候的数据安全</span>
        mutex mtx<span class="token punctuation">;</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token function">LoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">loadConf</span><span class="token punctuation">(</span>servers_conf_path<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"加载负载服务器失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"加载 "</span> <span class="token operator">&lt;&lt;</span> servers_conf_path <span class="token operator">&lt;&lt;</span> <span class="token string">" 配置文件成功"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 加载配置文件, 将配置文件里面机器的数据都读取出来</span>
        <span class="token keyword">bool</span> <span class="token function">loadConf</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> conf_path<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string conf_content<span class="token punctuation">;</span>                                    <span class="token comment">// 配置文件里面的内容</span>
            <span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">ReadFromFile</span><span class="token punctuation">(</span>conf_path<span class="token punctuation">,</span> <span class="token operator">&amp;</span>conf_content<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            conf_content<span class="token punctuation">.</span><span class="token function">pop_back</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                <span class="token comment">// 会多出一个空格</span>

            vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> lines<span class="token punctuation">;</span>                                   <span class="token comment">// 切分每一行</span>
            <span class="token class-name">StringUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Split</span><span class="token punctuation">(</span>conf_content<span class="token punctuation">,</span> <span class="token operator">&amp;</span>lines<span class="token punctuation">,</span> <span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 切分每一个 ip 和端口号</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 单独处理每一行  ip:port</span>
                vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> line<span class="token punctuation">;</span>      
                <span class="token comment">// 拆分字符串，以 ":" 为分隔符                          </span>
                <span class="token class-name">StringUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Split</span><span class="token punctuation">(</span>lines<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>line<span class="token punctuation">,</span> <span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"配置文件异常，切分数据失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                    <span class="token keyword">continue</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                Machine m<span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>ip   <span class="token operator">=</span> line<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>port <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>line<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>load <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>mtx  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">mutex</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                all_machines<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 这个机器启动之后, 默认是在线的, 并且存储的是主机在 all_machines 里面的下标</span>
                online<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>all_machines<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// id 输出型参数</span>
        <span class="token comment">// machine 也是输出型参数</span>
        <span class="token keyword">bool</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> id<span class="token punctuation">,</span> Machine<span class="token operator">*</span><span class="token operator">*</span> out_mac<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 选择合适的主机, 并且更新负载</span>
            <span class="token comment">// 后续可能需要离线主机</span>
            <span class="token comment">// 负载均衡选择主机的时候需要加锁</span>
            mtx<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 负载均衡的算法</span>
            <span class="token comment">// 1. 随机数 + hash</span>
            <span class="token comment">// 2. 轮询 + hash</span>
            <span class="token keyword">int</span> online_count <span class="token operator">=</span> online<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>online_count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                mtx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>FATAL<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"可用负载服务器为 0"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 通过遍历的方式找到所有负载最小的机器</span>
            <span class="token keyword">uint64_t</span> min_load <span class="token operator">=</span> all_machines<span class="token punctuation">[</span>online<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>id <span class="token operator">=</span> online<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token operator">*</span>out_mac <span class="token operator">=</span> <span class="token operator">&amp;</span>all_machines<span class="token punctuation">[</span>online<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> online_count<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">uint64_t</span> cur_load <span class="token operator">=</span> all_machines<span class="token punctuation">[</span>online<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>min_load <span class="token operator">&gt;</span> cur_load<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    min_load <span class="token operator">=</span> cur_load<span class="token punctuation">;</span>
                    <span class="token operator">*</span>id <span class="token operator">=</span> online<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token operator">*</span>out_mac <span class="token operator">=</span> <span class="token operator">&amp;</span>all_machines<span class="token punctuation">[</span>online<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            mtx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token comment">// 让所有主机上线</span>
        <span class="token keyword">bool</span> <span class="token function">enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            mtx<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 将 offline 所有内容插入到 offlilne 里面</span>
            online<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>online<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offline<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offline<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            offline<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>offline<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> offline<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mtx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"上线所有主机"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token comment">// 让一台主机下线</span>
        <span class="token keyword">bool</span> <span class="token function">disable</span><span class="token punctuation">(</span><span class="token keyword">int</span> which<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            mtx<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator it <span class="token operator">=</span> online<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> online<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>it <span class="token operator">==</span> which<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>         <span class="token comment">// 找到了需要离线的主机</span>
                    all_machines<span class="token punctuation">[</span>which<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">resetLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// 负载清 0</span>
                    online<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    offline<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>which<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>                  <span class="token comment">// 直接 break , 不用考虑 迭代器失效的问题</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>

                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            mtx<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token operator">~</span><span class="token function">LoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h2><a id="15__1742"></a>15. 运行用户代码</h2> 
<p>用户在编写完代码之后需要将代码交给服务器判题，用户在提交的时候提交的只是 <code>Solution()</code> 那部分代码，也就是 <code>pre_code</code>，所以最终判题的时候，需要将用户的 <code>pre_code</code> 和 数据库中的 <code>test_code</code> 进行拼接之后才能运行</p> 
<ol><li>首先注册一下判题服务，并且 ctrl 里面需要提供一个 <code>judge</code> 判题函数，并且请求中含有的参数有：<code>question_id, 用户代码</code></li></ol> 
<pre><code class="prism language-cpp">    server<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token raw-string string">R"(/judge/(\d+))"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token operator">&amp;</span>ctrl<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">const</span> Request<span class="token operator">&amp;</span> req<span class="token punctuation">,</span> Response<span class="token operator">&amp;</span> resp<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        string result_json <span class="token punctuation">;</span>
        string question_id <span class="token operator">=</span> req<span class="token punctuation">.</span>matches<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        ctrl<span class="token punctuation">.</span><span class="token function">judge</span><span class="token punctuation">(</span>question_id<span class="token punctuation">,</span> req<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result_json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        resp<span class="token punctuation">.</span><span class="token function">set_content</span><span class="token punctuation">(</span>result_json<span class="token punctuation">,</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol start="2"><li>在 <code>ctrl.judge</code> 函数中，将请求中的数据序列化，然后得到 <code>question_id</code> 和 <code>pre_code</code>。然后将 <code>question_id </code> 去查表，来获取这个 <code>question</code> 的具体数据，于是就可以在 <code>model</code> 中再补充一个函数</li></ol> 
<pre><code class="prism language-cpp">        <span class="token keyword">bool</span> <span class="token function">getQuestionById</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span> Question<span class="token operator">*</span> ques_out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            string sql <span class="token operator">=</span> <span class="token string">"select * from "</span> <span class="token operator">+</span> mysql_questions_table <span class="token operator">+</span> <span class="token string">" "</span><span class="token punctuation">;</span>
            sql <span class="token operator">+=</span> <span class="token string">"where id = "</span><span class="token punctuation">;</span>
            sql <span class="token operator">+=</span> id<span class="token punctuation">;</span>
            vector<span class="token operator">&lt;</span>Question<span class="token operator">&gt;</span> result<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">visitMySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token operator">*</span>ques_out <span class="token operator">=</span> result<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="3"><li>接着，根据该 <code>question</code> 的具体数据以及用户的 <code>pre_code</code> 代码，重新组装一个请求，再让选择器选择一个负载最低的机器，并发送，如果该请求失败，那么就重新选择机器再发送。如果请求成功，那么就将响应原样交付给前端处理</li></ol> 
<pre><code class="prism language-cpp">        <span class="token keyword">bool</span> <span class="token function">judge</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> id<span class="token punctuation">,</span> <span class="token keyword">const</span> string in_json<span class="token punctuation">,</span> string<span class="token operator">*</span> out_json<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// if (session == nullptr)     return false;</span>
            <span class="token comment">// cout &lt;&lt; "题目 id = " &lt;&lt; id &lt;&lt; endl;</span>
            <span class="token comment">// cout &lt;&lt; "user_id = " &lt;&lt; to_string(session-&gt;user_info.id) &lt;&lt; endl;</span>

            Question q<span class="token punctuation">;</span>
            model<span class="token operator">-&gt;</span><span class="token function">getQuestionById</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>q<span class="token punctuation">)</span><span class="token punctuation">;</span>

            Json<span class="token double-colon punctuation">::</span>Reader reader<span class="token punctuation">;</span>
            Json<span class="token double-colon punctuation">::</span>Value in_root<span class="token punctuation">;</span>
            reader<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>in_json<span class="token punctuation">,</span> in_root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            string code <span class="token operator">=</span> in_root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 重新拼接要编译的代码, 因为需要发送给远端服务器进行编译和运行, 所以也需要是 json 格式的字符串</span>
            Json<span class="token double-colon punctuation">::</span>Value send_root<span class="token punctuation">;</span>        <span class="token comment">// 还需要发送给远端</span>
            send_root<span class="token punctuation">[</span><span class="token string">"input"</span><span class="token punctuation">]</span>        <span class="token operator">=</span> in_root<span class="token punctuation">[</span><span class="token string">"input"</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">asString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            send_root<span class="token punctuation">[</span><span class="token string">"code"</span><span class="token punctuation">]</span>         <span class="token operator">=</span> code <span class="token operator">+</span> <span class="token string">"\n"</span> <span class="token operator">+</span> q<span class="token punctuation">.</span>test_code<span class="token punctuation">;</span>
            send_root<span class="token punctuation">[</span><span class="token string">"cpu_limit"</span><span class="token punctuation">]</span>    <span class="token operator">=</span> q<span class="token punctuation">.</span>cpu_limit<span class="token punctuation">;</span>
            send_root<span class="token punctuation">[</span><span class="token string">"memory_limit"</span><span class="token punctuation">]</span> <span class="token operator">=</span> q<span class="token punctuation">.</span>memory_limit<span class="token punctuation">;</span>
            <span class="token comment">// 生成一个 时间戳 + uuid 来定制当次的判题结果</span>
            send_root<span class="token punctuation">[</span><span class="token string">"question_id"</span><span class="token punctuation">]</span>  <span class="token operator">=</span> <span class="token function">atoi</span><span class="token punctuation">(</span>id<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// send_root["user_id"]      = session-&gt;user_info.id;</span>

            <span class="token comment">// 完成发送给负载服务器的 json 字符串</span>
            Json<span class="token double-colon punctuation">::</span>StyledWriter writer<span class="token punctuation">;</span>
            string send_str <span class="token operator">=</span> writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>send_root<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"收到一个判题请求"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">", 开始选择编译服务器"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token comment">// 选择负载服务器进行发送</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                Machine<span class="token operator">*</span> mac <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>balancer<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>id<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mac<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 发送 http 请求</span>
                Client <span class="token function">cli</span><span class="token punctuation">(</span>mac<span class="token operator">-&gt;</span>ip<span class="token punctuation">,</span> mac<span class="token operator">-&gt;</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                mac<span class="token operator">-&gt;</span><span class="token function">loadIncrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// 发送了请求, 负载增加</span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"选择主机成功, 主机 id = "</span> <span class="token operator">&lt;&lt;</span> id <span class="token operator">&lt;&lt;</span> <span class="token string">" | ip: "</span> <span class="token operator">&lt;&lt;</span> mac<span class="token operator">-&gt;</span>ip <span class="token operator">&lt;&lt;</span> <span class="token string">" | port: "</span> <span class="token operator">&lt;&lt;</span> mac<span class="token operator">-&gt;</span>port <span class="token operator">&lt;&lt;</span> 
                    <span class="token string">" | 当前主机的负载是 "</span> <span class="token operator">&lt;&lt;</span> mac<span class="token operator">-&gt;</span><span class="token function">getLoad</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token comment">// 向这个负载服务器发送 post 请求</span>
                <span class="token comment">// 这个 result 其实就是一个智能指针, 里面装的是一个 Response</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> result <span class="token operator">=</span> cli<span class="token punctuation">.</span><span class="token function">Post</span><span class="token punctuation">(</span><span class="token string">"/execute"</span><span class="token punctuation">,</span> send_str<span class="token punctuation">,</span> <span class="token string">"application/json; charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token operator">-&gt;</span>status <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"成功将请求发送给负载服务器, 完成编译和运行工作"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                        <span class="token operator">*</span>out_json <span class="token operator">=</span> result<span class="token operator">-&gt;</span>body<span class="token punctuation">;</span>       <span class="token comment">// 将这个请求的结果放到 out_json 中</span>
                        mac<span class="token operator">-&gt;</span><span class="token function">loadDecrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 请求完成, 负载减少</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>      <span class="token comment">// 请求成功, 就不需要再找其他机器了</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// 如果状态码不是 200 , 那么就重新选择主机</span>
                    mac<span class="token operator">-&gt;</span><span class="token function">loadDecrease</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 请求失败</span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>ERROR<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"当前请求主机离线, id: "</span> <span class="token operator">&lt;&lt;</span> id <span class="token operator">&lt;&lt;</span> <span class="token string">" | ip: "</span> <span class="token operator">&lt;&lt;</span>  mac<span class="token operator">-&gt;</span>ip <span class="token operator">&lt;&lt;</span> <span class="token string">" | port: "</span> <span class="token operator">&lt;&lt;</span> mac<span class="token operator">-&gt;</span>port <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                    balancer<span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// 让它离线</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>不过到这里之后，还是有点小问题，这里后边再解决（可能会出现段错误）</p> 
<h2><a id="16__1841"></a>16. 密码密文存储</h2> 
<p>由于文章篇幅有限，登录和注册功能无非就是往用户表中进行操作，但是用户的密码直接明文存在 MySQL 厘米不安全，所以推荐使用密文存储，而密文存储的思路在我的这篇文章里面有讲到 <a href="https://blog.csdn.net/weixin_63519461/article/details/128756997">Blog</a>，实现思路都是一样的</p> 
<p>这里分享一个本项目使用的 md5 代码：<a href="https://github.com/JieweiWei/md5/tree/master/src">github – md5</a></p> 
<h2><a id="17__1846"></a>17. 实现会话</h2> 
<p>接着就是会话的实现，首先处理一下会话的相关数据结构</p> 
<ol><li>首先管理会话的类<code>SessionMgr</code>设计成到单例模式，并且里面存一个哈希表，Key 是 SessionId，Value 是 HttpSession<br> 然后除了存储用户的直接个人数据之外，还需要存储一些会话相关的信息<br> <img src="https://images2.imgbox.com/1f/63/7YNn94Oc_o.png" alt="在这里插入图片描述"></li><li><code>create_stamp</code> 是用户不存在会话且第一次登录的时间，而 <code>last_stamp</code> 是用户在会话有效期内，最后一次登录的时间</li><li>用户每次登录，都需要更新 <code>last_stamp</code>（如果没过期的话）</li></ol> 
<pre><code class="prism language-cpp">        <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            last_stamp <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CurrentTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token keyword">long</span> <span class="token function">CurrentTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">auto</span> now <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>system_clock<span class="token double-colon punctuation">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">auto</span> timestamp <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">time_point_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>chrono<span class="token double-colon punctuation">::</span>milliseconds<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> timestamp<span class="token punctuation">.</span><span class="token function">time_since_epoch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="4"><li>然后 HttpSession 再提供一个判断过期的方法，其实就是 <code>last_stamp</code> + 过期的时间间隔对应的时间戳如果 &lt; 当前时间戳，那么判定为过期</li></ol> 
<pre><code class="prism language-cpp">        <span class="token keyword">bool</span> <span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1. 获取最晚登陆时间的 3 天后的时间戳</span>
            <span class="token keyword">long</span> <span class="token keyword">long</span> expired_stamp <span class="token operator">=</span> last_stamp <span class="token operator">+</span> expiration_stamp<span class="token punctuation">;</span>
            <span class="token comment">// 2. 获取当前的时间戳</span>
            <span class="token keyword">long</span> <span class="token keyword">long</span> cur_stamp <span class="token operator">=</span> <span class="token class-name">TimeUtil</span><span class="token double-colon punctuation">::</span><span class="token function">CurrentTimeStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> expired_stamp <span class="token operator">&lt;</span> cur_stamp<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<ol start="5"><li>然后管理这个会话的类 <code>SessionMgr</code> 需要提供一系列操作会话的函数，比如<br> 1、根据 SessionId 判断会话是否存在，如果存在，那么返回对应的 HttpSession<br> 2、如果用户是最近第一次登录，那么需要为用户分配一个全局唯一的 SessionID<br> 3、游览器发送的 SessionId 可能存在多个，所以需要逐个匹配到存在会话记录的用户<br> 4、会话是会过期的，还要定义一个扫描函数，将过期的会话移除<br> 5、Controller 在启动的时候，需要一个线程一起启动，每隔一段时间调用一次 扫描 函数</li></ol> 
<p>所以最终 SessionMgr 类的编写如下</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// 默认在 3 天之后, 这个会话会过期, 测试中使用 10 min</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> HttpSession<span class="token double-colon punctuation">::</span>expiration_stamp <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">;</span>

    <span class="token comment">// 设计成单例模式?</span>
    <span class="token keyword">class</span> <span class="token class-name">SessionMgr</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">static</span> SessionMgr<span class="token operator">*</span> session_mgr<span class="token punctuation">;</span>                                 <span class="token comment">// 单例模式中的对象</span>
        <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>                                          <span class="token comment">// 互斥锁</span>
        <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>mutex session_lock<span class="token punctuation">;</span>                                 <span class="token comment">// 用来保护 session 哈希表的线程安全</span>

        <span class="token keyword">static</span> boost<span class="token double-colon punctuation">::</span>uuids<span class="token double-colon punctuation">::</span>random_generator generator<span class="token punctuation">;</span>                <span class="token comment">// 用来生成随机的 session_id</span>
        unordered_map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> HttpSession<span class="token operator">*</span><span class="token operator">&gt;</span> session_mapper<span class="token punctuation">;</span>             <span class="token comment">// 用来管理 session 的哈希表</span>
    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">static</span> SessionMgr<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>session_mgr <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">{<!-- --></span>   <span class="token comment">// 定义作用域 来 限定这个智能锁</span>
                    std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>session_mgr <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> session_mgr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">SessionMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> session_mgr<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 根据 session_id 来匹配对应的 HttpSession</span>
        <span class="token comment">// 返回相应的指针</span>
        HttpSession<span class="token operator">*</span> <span class="token function">find</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> session_id<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>session_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 对哈希表加锁</span>

            unordered_map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> HttpSession<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator it <span class="token operator">=</span> session_mapper<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>session_id<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>it <span class="token operator">==</span> session_mapper<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> it<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 分配一个新的 HttpSession, 参数是 用户名</span>
        <span class="token comment">// 如果已经存在有 session_id, 那么就更新 last_stamp</span>
        string <span class="token function">generate</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">,</span> <span class="token keyword">const</span> string<span class="token operator">&amp;</span> username<span class="token punctuation">,</span> <span class="token keyword">int</span> grade<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 生成一个随机的 session_id</span>
            boost<span class="token double-colon punctuation">::</span>uuids<span class="token double-colon punctuation">::</span>uuid uuid <span class="token operator">=</span> <span class="token function">generator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            string session_id <span class="token operator">=</span> boost<span class="token double-colon punctuation">::</span>uuids<span class="token double-colon punctuation">::</span><span class="token function">to_string</span><span class="token punctuation">(</span>uuid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>session_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 对哈希表加锁</span>
            session_mapper<span class="token punctuation">.</span><span class="token function">emplace</span><span class="token punctuation">(</span>session_id<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token function">HttpSession</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> username<span class="token punctuation">,</span> grade<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 返回 为这个会话 分配的 session_id</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"分配了一个 session_id = "</span> <span class="token operator">&lt;&lt;</span> session_id <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">return</span> session_id<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果用户在 3 天内登录了, 那么就继续更新</span>
        <span class="token comment">// 参数传入这个会话, 然后更新这个会话的 最晚登录时间</span>
        <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span>HttpSession<span class="token operator">*</span> http_session<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            http_session<span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 扫描整个 session 表, 如果过期, 就删除</span>
        <span class="token keyword">void</span> <span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>session_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>unordered_map<span class="token operator">&lt;</span>string<span class="token punctuation">,</span> HttpSession<span class="token operator">*</span><span class="token operator">&gt;</span><span class="token double-colon punctuation">::</span>iterator it <span class="token operator">=</span> session_mapper<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> it <span class="token operator">!=</span> session_mapper<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">auto</span> temp <span class="token operator">=</span> it<span class="token punctuation">;</span>                             <span class="token comment">// 保存一下 迭代器 的位置, 防止迭代器失效</span>
                it <span class="token operator">++</span><span class="token punctuation">;</span>

                <span class="token comment">// 如果过期了, 那么直接将会话里面数据删除</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>temp<span class="token operator">-&gt;</span>second<span class="token operator">-&gt;</span><span class="token function">isExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">delete</span> temp<span class="token operator">-&gt;</span>second<span class="token punctuation">;</span>                    <span class="token comment">// 释放这个 HttpSession* 的空间</span>
                    session_mapper<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ids 表示 session_id 的集合</span>
        <span class="token comment">// 用来判断 这些 session_id 中有没有匹配的 会话, 存在匹配的会话就返回这个用户的会话信息</span>
        string <span class="token function">getLoginUser</span><span class="token punctuation">(</span><span class="token keyword">const</span> vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span><span class="token operator">&amp;</span> ids<span class="token punctuation">,</span> HttpSession<span class="token operator">*</span><span class="token operator">*</span> out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> id <span class="token operator">:</span> ids<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                HttpSession<span class="token operator">*</span> session <span class="token operator">=</span> <span class="token function">find</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 存在会话, 如果存在会话, 那就更新一下</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>session <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    session<span class="token operator">-&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>out <span class="token operator">!=</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token operator">*</span>out <span class="token operator">=</span> session<span class="token punctuation">;</span>
                        <span class="token keyword">return</span> id<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token string">""</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token function">SessionMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token function">SessionMgr</span><span class="token punctuation">(</span><span class="token keyword">const</span> SessionMgr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>                     <span class="token comment">// 拷贝构造</span>

        SessionMgr<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> SessionMgr<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>          <span class="token comment">// 赋值构造</span>

        <span class="token operator">~</span><span class="token function">SessionMgr</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>                                          <span class="token comment">// 析构函数</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    boost<span class="token double-colon punctuation">::</span>uuids<span class="token double-colon punctuation">::</span>random_generator SessionMgr<span class="token double-colon punctuation">::</span>generator<span class="token punctuation">;</span>

    SessionMgr<span class="token operator">*</span> SessionMgr<span class="token double-colon punctuation">::</span>session_mgr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>mutex SessionMgr<span class="token double-colon punctuation">::</span>session_lock<span class="token punctuation">;</span>
    std<span class="token double-colon punctuation">::</span>mutex SessionMgr<span class="token double-colon punctuation">::</span>mtx<span class="token punctuation">;</span>


    <span class="token comment">// 负责每隔一段 时间扫描一下 所有的 Session, 如果有过期的, 就进行清理</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">Scanner</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span> 
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 线程分离, 不必等待父进程回收资源</span>
        <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"自动回收过期 Session 线程启动"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 10 分钟就过一次</span>
            SessionMgr<span class="token operator">*</span> session_mgr <span class="token operator">=</span> <span class="token class-name">SessionMgr</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">// 获取这个对象</span>
            session_mgr<span class="token operator">-&gt;</span><span class="token function">scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                                           <span class="token comment">// 扫描并删除</span>
            <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="18__2019"></a>18. 拦截器</h2> 
<p>然后可以再实现一个简易版的拦截器，提供一个函数，专门负责从请求中获取 会话哈希表中存在的会话，并能得到对应的 SessionID 以及其匹配的会话 HttpSession。</p> 
<p>需要注意的是游览器可能会发送多个会话，所以这里还需要将请求中 Cookie 中的会话都提取出来</p> 
<pre><code class="prism language-cpp">    <span class="token keyword">class</span> <span class="token class-name">Interceptor</span>
    <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">static</span> Interceptor<span class="token operator">*</span> inter<span class="token punctuation">;</span>
        <span class="token keyword">static</span> SessionMgr<span class="token operator">*</span> session_mgr<span class="token punctuation">;</span>
        <span class="token keyword">static</span> std<span class="token double-colon punctuation">::</span>mutex mtx<span class="token punctuation">;</span>

    <span class="token keyword">public</span><span class="token operator">:</span>
        <span class="token keyword">static</span> Interceptor<span class="token operator">*</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inter <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                std<span class="token double-colon punctuation">::</span>lock_guard<span class="token operator">&lt;</span>std<span class="token double-colon punctuation">::</span>mutex<span class="token operator">&gt;</span> <span class="token function">guard</span><span class="token punctuation">(</span>mtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>inter <span class="token operator">==</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    session_mgr <span class="token operator">=</span> <span class="token class-name">SessionMgr</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 会话管理对象(指针)</span>
                    <span class="token keyword">return</span> inter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">Interceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                   <span class="token comment">// 拦截器单例模式对象(指针)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> inter<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 拦截请求, 验证登录状态</span>
        <span class="token comment">// 将会话中的 userinfo 提取出来, 如果存在会话, 那么返回用户信息, 并返回 session_id, 如果不存在返回, 那么返回 ""</span>
        string <span class="token function">interceptRequest</span><span class="token punctuation">(</span><span class="token keyword">const</span> Request<span class="token operator">&amp;</span> req<span class="token punctuation">,</span> HttpSession<span class="token operator">*</span><span class="token operator">*</span> out<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 需要验证用户的登录状态, 从 Request header 中里面获取 session_id</span>
            <span class="token keyword">static</span> <span class="token keyword">const</span> string prefix <span class="token operator">=</span> <span class="token string">"session_id="</span><span class="token punctuation">;</span>
            string cookie <span class="token operator">=</span> req<span class="token punctuation">.</span><span class="token function">get_header_value</span><span class="token punctuation">(</span><span class="token string">"Cookie"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            vector<span class="token operator">&lt;</span>string<span class="token operator">&gt;</span> session_ids<span class="token punctuation">;</span>

            size_t beg <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>beg <span class="token operator">!=</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                string session_id<span class="token punctuation">;</span>
                <span class="token comment">// 查找下一个 session_id= 的位置</span>
                beg <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span>prefix<span class="token punctuation">,</span> beg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>beg <span class="token operator">==</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                beg <span class="token operator">+=</span> prefix<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 查找分号的位置</span>
                size_t end <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">";"</span><span class="token punctuation">,</span> beg<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 提取 session_id</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>end <span class="token operator">==</span> string<span class="token double-colon punctuation">::</span>npos<span class="token punctuation">)</span>
                    session_id <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>beg<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> 
                    session_id <span class="token operator">=</span> cookie<span class="token punctuation">.</span><span class="token function">substr</span><span class="token punctuation">(</span>beg<span class="token punctuation">,</span> end <span class="token operator">-</span> beg<span class="token punctuation">)</span><span class="token punctuation">;</span>

                session_ids<span class="token punctuation">.</span><span class="token function">emplace_back</span><span class="token punctuation">(</span>session_id<span class="token punctuation">)</span><span class="token punctuation">;</span>

                beg <span class="token operator">=</span> end<span class="token punctuation">;</span> <span class="token comment">// 将查找起始位置移动到分号后的位置继续查找下一个 session_id</span>

                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"用户发送的会话 Id = "</span> <span class="token operator">&lt;&lt;</span> session_id <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> session_mgr<span class="token operator">-&gt;</span><span class="token function">getLoginUser</span><span class="token punctuation">(</span>session_ids<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token function">Interceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

        <span class="token function">Interceptor</span><span class="token punctuation">(</span><span class="token keyword">const</span> Interceptor<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        Interceptor<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token keyword">const</span> Interceptor<span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token keyword">delete</span><span class="token punctuation">;</span>

        <span class="token operator">~</span><span class="token function">Interceptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span>      <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>mutex Interceptor<span class="token double-colon punctuation">::</span>mtx<span class="token punctuation">;</span>
    Interceptor<span class="token operator">*</span> Interceptor<span class="token double-colon punctuation">::</span>inter <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
    SessionMgr<span class="token operator">*</span> Interceptor<span class="token double-colon punctuation">::</span>session_mgr <span class="token operator">=</span> <span class="token keyword">nullptr</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后在用户每一个申请的服务中，都可以获取用户的会话，然后可以从会话中获取该用户的数据，从而实现自动登录功能。</p> 
<p>补充一点，如果用户是第一次登录，那么需要为该用户创建一个新的会话，并分配一个 SessionID，然后再将这个 SessionID 放在 响应中的 <code>Set-Cookie</code> 字段中，这样游览器收到之后，下次访问该网站的资源的时候，就都会带上这个 SessionID 一起发送过来</p> 
<p>所以登录函数里面还要传一个拦截器获取到的 会话</p> 
<p><img src="https://images2.imgbox.com/14/fb/JKUcFtB1_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/7c/5d/5WbbTX4V_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/a9/26/6328Yx2g_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="19__2103"></a>19. 记录用户答题情况</h2> 
<p>这个功能的实现，还需要依靠一个表 <code>completed</code> ，表示所有用户完成的题目，如下是表结构，以及建表语句</p> 
<pre><code class="prism language-sql"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span> completed <span class="token punctuation">(</span>
    id <span class="token keyword">INT</span> <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
    user_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    question_id <span class="token keyword">INT</span><span class="token punctuation">,</span>
    completed_time <span class="token keyword">TIMESTAMP</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> users<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">FOREIGN</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>question_id<span class="token punctuation">)</span> <span class="token keyword">REFERENCES</span> questions<span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre> 
<p>每一条记录：哪个用户，完成了，哪一个题</p> 
<hr> 
<p>接着，想要实现这个功能，需要基于会话之上</p> 
<ol><li>上文已经实现了判题功能，并且在判完一个题目之后，如果通过，会往给定参数的 <code>fd</code> 文件描述符中写入数据</li><li>所以主线程只要基于这个会话，就能知道这个题目的用户 <code>id</code>，以及题号，然后再分别以读，写方式打开两个文件描述符，<code>write_fd</code> 给判题程序，<code>read_fd</code> 给主线程自己用，然后主线程等待完判题程序之后，就可以往 <code>read_fd</code> 中读数据了</li><li>如果能读到数据，那么就认为这个用户完成了这个题</li><li>注意：<code>judge_id</code> 是我用来 约定读写文件的文件名，反正只是一个唯一的文件名就可以了，怎么搞的都行</li></ol> 
<p><img src="https://images2.imgbox.com/dd/63/LoZFDcPR_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/8c/ab/R2B6yiAn_o.png" alt="在这里插入图片描述">接着是这个读文件的线程对应的函数</p> 
<pre><code class="prism language-cpp">    <span class="token comment">// 读取该判题结果</span>
    <span class="token keyword">void</span><span class="token operator">*</span> <span class="token function">ReadJudgeResult</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> args<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">pthread_detach</span><span class="token punctuation">(</span><span class="token function">pthread_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"启动线程读取结果"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        ThreadInfo<span class="token operator">*</span> info <span class="token operator">=</span> <span class="token punctuation">(</span>ThreadInfo<span class="token operator">*</span><span class="token punctuation">)</span>args<span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"read_fd = "</span> <span class="token operator">&lt;&lt;</span> info<span class="token operator">-&gt;</span>judge_read_fd <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">char</span> result<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> rd <span class="token operator">=</span> <span class="token function">read</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>judge_read_fd<span class="token punctuation">,</span> result<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"rd = "</span> <span class="token operator">&lt;&lt;</span> rd <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rd <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"user_id = "</span> <span class="token operator">&lt;&lt;</span> info<span class="token operator">-&gt;</span>user_id <span class="token operator">&lt;&lt;</span> <span class="token string">"  question_id = "</span> <span class="token operator">&lt;&lt;</span> info<span class="token operator">-&gt;</span>question_id <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"读取到一个通过的判题结果"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token comment">// 然后往数据库中插入数据</span>
            Model<span class="token operator">*</span> model <span class="token operator">=</span> <span class="token class-name">Model</span><span class="token double-colon punctuation">::</span><span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 如果已经通过了, 那么什么都不做</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">hasPassed</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>user_id<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>question_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"该用户再次通过该题"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>model<span class="token operator">-&gt;</span><span class="token function">insertPassedQuestion</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>user_id<span class="token punctuation">,</span> info<span class="token operator">-&gt;</span>question_id<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"user_id = "</span> <span class="token operator">+</span> info<span class="token operator">-&gt;</span>user_id <span class="token operator">&lt;&lt;</span> <span class="token string">" 的用户成功完成编号为 "</span> <span class="token operator">&lt;&lt;</span> info<span class="token operator">-&gt;</span>question_id <span class="token operator">&lt;&lt;</span> <span class="token string">" 的题目"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"用户通过题目时发生未知错误"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            cout <span class="token operator">&lt;&lt;</span> <span class="token string">"rd = "</span> <span class="token operator">&lt;&lt;</span> rd <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>WARNING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"读取判题结果失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将这个临时文件文件删除</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">FileUtil</span><span class="token double-colon punctuation">::</span><span class="token function">Exists</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>judge_file_path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">unlink</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>judge_file_path<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 然后关闭 读端口</span>
        <span class="token function">close</span><span class="token punctuation">(</span>info<span class="token operator">-&gt;</span>judge_read_fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">delete</span> info<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>然后是往 <code>completed</code> 表中添加一条用户答题记录的 <code>model</code> 中的接口</p> 
<pre><code class="prism language-cpp">        <span class="token comment">// 往数据库中执行 insert 语句</span>
        <span class="token keyword">int</span> <span class="token function">insertMySQL</span><span class="token punctuation">(</span><span class="token keyword">const</span> string<span class="token operator">&amp;</span> sql<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">LOG</span><span class="token punctuation">(</span>INFO<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"执行 SQL 语句: "</span> <span class="token operator">&lt;&lt;</span> sql <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">mysql_query</span><span class="token punctuation">(</span>mysql<span class="token punctuation">,</span> sql<span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">LOG</span><span class="token punctuation">(</span>WANING<span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> sql <span class="token operator">&lt;&lt;</span> <span class="token string">" 执行失败"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 否则返回受影响的行数, 也就是插入的行数</span>
            <span class="token keyword">return</span> <span class="token function">mysql_affected_rows</span><span class="token punctuation">(</span>mysql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

	    <span class="token comment">// 添加一条通过记录</span>
        <span class="token keyword">bool</span> <span class="token function">insertPassedQuestion</span><span class="token punctuation">(</span><span class="token keyword">int</span> user_id<span class="token punctuation">,</span> <span class="token keyword">int</span> question_id<span class="token punctuation">)</span> 
        <span class="token punctuation">{<!-- --></span>
            string sql <span class="token operator">=</span> <span class="token string">"insert completed (user_id, question_id) values("</span> <span class="token operator">+</span> <span class="token function">to_string</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", "</span> <span class="token operator">+</span> 
                            <span class="token function">to_string</span><span class="token punctuation">(</span>question_id<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">")"</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">insertMySQL</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>        <span class="token comment">// 受影响的行数位 1</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="20__2200"></a>20. 展示用户完成的题目</h2> 
<p>每当用户完成一个题目之后，<code>completed</code> 表中就会多增加一条记录，那么如果想知道一个用户总共完成了哪些题目，那么只需要 <code>select question_id from completed where user_id = 用户ID</code>，就可以得知该用户的答题情况了</p> 
<p>接着就可以在 <code>view</code> 中，根据 HttpSession 来获取该用户所有完成的题目ID，然后再将这些 <code>question_id</code> 存入哈希表中，方便后续查找</p> 
<p><img src="https://images2.imgbox.com/72/26/8x3lossC_o.png" alt="在这里插入图片描述">然后后面再渲染题库页面中的所有题库的时候，就判断一下该题号是否在哈希表中，如果存在，那么在打个勾；如果不存在，那就打个叉</p> 
<p><img src="https://images2.imgbox.com/5a/e9/6oQNStSn_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/1c/49/N9JNu70g_o.png" alt="在这里插入图片描述">于是就可以达成这种效果<br> <img src="https://images2.imgbox.com/6a/7b/xXM335mx_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="21__2212"></a>21. 项目代码</h2> 
<p><a href="https://gitee.com/enthusiastic-citizens6/project/tree/master/online_judge" rel="nofollow">Gitee</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/83460edd11c1376826646744054ee02b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">FFmpeg下载安装及Windows开发环境设置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/275a463417abf7f1e7e9dbf2a6b3e635/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【刷题打卡记录】力扣17. 电话号码的字母组合</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>