<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>机器视觉实验二：道路车流量计数实验（OpenCV-python代码） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="机器视觉实验二：道路车流量计数实验（OpenCV-python代码）" />
<meta property="og:description" content="一、实验目的 用OpenCV编写一个车辆计数程序，强化对课堂讲授内容如图像腐蚀、轮廓提取、边缘检测、视频读写等知识的深入理解和灵活应用。
二、实验要求 1、用OpenCV编写一个车辆计数程序，对一段视频里道路上的来往车辆进行计数统计，要求避免同一车辆重复统计，并尽量避免漏检、错检；
2、认真撰写实验报告，要求说明实验原理，对实验过程叙述清楚，关键代码给出注释，对实验结果给出合理解释，实验分析部分则需要指出实验结果优劣的原因以及如何进一步提高实验性能的方法或手段。
3、利用python版的OpenCV编写代码。
三、实验过程 import cv2 import numpy as np min_w = 90 min_h = 90 #检测线的高度 line_high = 550 #线的偏移 offset = 7 #统计车的数量 carno =0 #存放有效车辆的数组 cars = [] def center(x, y, w, h): #计算矩阵中心点 x1 = int(w/2) y1 = int(h/2) cx = x &#43; x1 cy = y &#43; y1 return cx, cy cap = cv2.VideoCapture(&#39;video.mp4&#39;) bgsubmog =cv2.createBackgroundSubtractorMOG2() #去背景 #形态学kernel kernel = cv2.getStructuringElement(cv2.MORPH_RECT, (5,5)) while True: ret, frame = cap." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/63e5c484711fba7a716a2fb4b6b7bb04/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-20T20:46:00+08:00" />
<meta property="article:modified_time" content="2023-05-20T20:46:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">机器视觉实验二：道路车流量计数实验（OpenCV-python代码）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>一、实验目的</h2> 
<p>用OpenCV编写一个车辆计数程序，强化对课堂讲授内容如图像腐蚀、轮廓提取、边缘检测、视频读写等知识的深入理解和灵活应用。</p> 
<h2><a id="_2"></a>二、实验要求</h2> 
<p>1、用OpenCV编写一个车辆计数程序，对一段视频里道路上的来往车辆进行计数统计，要求避免同一车辆重复统计，并尽量避免漏检、错检；<br> 2、认真撰写实验报告，要求说明实验原理，对实验过程叙述清楚，关键代码给出注释，对实验结果给出合理解释，实验分析部分则需要指出实验结果优劣的原因以及如何进一步提高实验性能的方法或手段。<br> 3、利用python版的OpenCV编写代码。</p> 
<h2><a id="_6"></a>三、实验过程</h2> 
<pre><code class="prism language-python"><span class="token keyword">import</span> cv2
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

min_w <span class="token operator">=</span> <span class="token number">90</span>
min_h <span class="token operator">=</span> <span class="token number">90</span>

<span class="token comment">#检测线的高度</span>
line_high <span class="token operator">=</span> <span class="token number">550</span>

<span class="token comment">#线的偏移</span>
offset <span class="token operator">=</span> <span class="token number">7</span>

<span class="token comment">#统计车的数量</span>
carno <span class="token operator">=</span><span class="token number">0</span>

<span class="token comment">#存放有效车辆的数组</span>
cars <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">def</span> <span class="token function">center</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#计算矩阵中心点</span>
    x1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>w<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
    y1 <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>h<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span>
    cx <span class="token operator">=</span> x <span class="token operator">+</span> x1
    cy <span class="token operator">=</span> y <span class="token operator">+</span> y1

    <span class="token keyword">return</span> cx<span class="token punctuation">,</span> cy

cap <span class="token operator">=</span> cv2<span class="token punctuation">.</span>VideoCapture<span class="token punctuation">(</span><span class="token string">'video.mp4'</span><span class="token punctuation">)</span>

bgsubmog <span class="token operator">=</span>cv2<span class="token punctuation">.</span>createBackgroundSubtractorMOG2<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#去背景</span>
<span class="token comment">#形态学kernel</span>
kernel <span class="token operator">=</span> cv2<span class="token punctuation">.</span>getStructuringElement<span class="token punctuation">(</span>cv2<span class="token punctuation">.</span>MORPH_RECT<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">while</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    ret<span class="token punctuation">,</span> frame <span class="token operator">=</span> cap<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ret <span class="token operator">==</span> <span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">:</span>     

        <span class="token comment">#灰度</span>
        frame <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_BGR2GRAY<span class="token punctuation">)</span>
        <span class="token comment">#去噪（高斯）</span>
        blur <span class="token operator">=</span> cv2<span class="token punctuation">.</span>GaussianBlur<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token comment">#去背影</span>
        mask <span class="token operator">=</span> bgsubmog<span class="token punctuation">.</span><span class="token builtin">apply</span><span class="token punctuation">(</span>blur<span class="token punctuation">)</span>

        <span class="token comment">#腐蚀， 去掉图中小斑块</span>
        erode <span class="token operator">=</span> cv2<span class="token punctuation">.</span>erode<span class="token punctuation">(</span>mask<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span> 

        <span class="token comment">#膨胀， 还原放大</span>
        dilate <span class="token operator">=</span> cv2<span class="token punctuation">.</span>dilate<span class="token punctuation">(</span>erode<span class="token punctuation">,</span> kernel<span class="token punctuation">,</span> iterations <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token comment">#闭操作，去掉物体内部的小块</span>
        close <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>dilate<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>
        close <span class="token operator">=</span> cv2<span class="token punctuation">.</span>morphologyEx<span class="token punctuation">(</span>close<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>MORPH_CLOSE<span class="token punctuation">,</span> kernel<span class="token punctuation">)</span>

        cnts<span class="token punctuation">,</span> h <span class="token operator">=</span> cv2<span class="token punctuation">.</span>findContours<span class="token punctuation">(</span>close<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>RETR_TREE<span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>CHAIN_APPROX_SIMPLE<span class="token punctuation">)</span>
    
        <span class="token comment">#画一条检测线</span>
        cv2<span class="token punctuation">.</span>line<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span> line_high<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1200</span><span class="token punctuation">,</span> line_high<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span>i<span class="token punctuation">,</span> c<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>cnts<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span>w<span class="token punctuation">,</span>h<span class="token punctuation">)</span> <span class="token operator">=</span> cv2<span class="token punctuation">.</span>boundingRect<span class="token punctuation">(</span>c<span class="token punctuation">)</span>

            <span class="token comment">#对车辆的宽高进行判断</span>
            <span class="token comment">#以验证是否是有效的车辆</span>
            isValid <span class="token operator">=</span> <span class="token punctuation">(</span> w <span class="token operator">&gt;=</span> min_w <span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span> h <span class="token operator">&gt;=</span> min_h<span class="token punctuation">)</span> 
            <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">not</span> isValid<span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">continue</span>

            <span class="token comment">#到这里都是有效的车 </span>
            cv2<span class="token punctuation">.</span>rectangle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>x<span class="token operator">+</span>w<span class="token punctuation">,</span> y<span class="token operator">+</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
            cpoint <span class="token operator">=</span> center<span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
            cars<span class="token punctuation">.</span>append<span class="token punctuation">(</span>cpoint<span class="token punctuation">)</span> 
            cv2<span class="token punctuation">.</span>circle<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token punctuation">(</span>cpoint<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

            <span class="token keyword">for</span> <span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span> <span class="token keyword">in</span> cars<span class="token punctuation">:</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> line_high <span class="token operator">-</span> offset<span class="token punctuation">)</span> <span class="token keyword">and</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> line_high <span class="token operator">+</span> offset <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">:</span>
                    carno <span class="token operator">+=</span><span class="token number">1</span>
                    cars<span class="token punctuation">.</span>remove<span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token punctuation">,</span> y <span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token keyword">print</span><span class="token punctuation">(</span>carno<span class="token punctuation">)</span>
        
        cv2<span class="token punctuation">.</span>putText<span class="token punctuation">(</span>frame<span class="token punctuation">,</span> <span class="token string">"Cars Count:"</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>carno<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>FONT_HERSHEY_SIMPLEX<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span>
        cv2<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span><span class="token string">'video'</span><span class="token punctuation">,</span> frame<span class="token punctuation">)</span>
        <span class="token comment">#cv2.imshow('erode', close)</span>
    
    key <span class="token operator">=</span> cv2<span class="token punctuation">.</span>waitKey<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token number">27</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">break</span>

cap<span class="token punctuation">.</span>release<span class="token punctuation">(</span><span class="token punctuation">)</span>
cv2<span class="token punctuation">.</span>destroyAllWindows<span class="token punctuation">(</span><span class="token punctuation">)</span>

</code></pre> 
<h2><a id="_99"></a>四、实验结果</h2> 
<p>实验结果如图所示，按Esc键退出。<br> <img src="https://images2.imgbox.com/8b/12/yOmcYTqm_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_103"></a>五、实验分析</h2> 
<p>1.本实验很好的结合并运用了之前博客讲述的openCV基础知识。从而实现道路车流量计数，如图像的灰度图，图像的去噪，图像处理kernel的构建，图像腐蚀，图像膨胀，图像闭操作、图像背景消除等。<br> 2.具体实现是根据估计定义汽车选框的大小，先去除视频中的背景去除，然后逐帧读取视频，转化为灰度图，并找出连续几帧中通过检测线的物体，并将其框起来，再通过根据物体的尺寸大小判断是否是汽车，如果是计数加一，否则不加以计数。<br> 3.但根据实际代码跑的情况来看，效果并不是太好，代码还不够完善，算法还有很大优化空间，比如对于摩托车算法有时也会计算出来，多个汽车在一起会导致计数错误。具体改进可以加入深度学习技术加入对汽车形体的识别，以及对汽车阴影的去除，从而提高技术的精确度。后续可能会更新加入深度学习技术的代码，尽情期待。</p> 
<blockquote> 
 <p>图像的灰度图在之前博客openCV基础知识（三）具体说明，链接为：https://blog.csdn.net/qq_26274961/article/details/121617487<br> 图像的去噪在之前博客openCV基础知识（五）具体说明，链接为：<br> https://blog.csdn.net/qq_26274961/article/details/121621414<br> 图像处理kernel的构建，图像腐蚀，图像膨胀，图像闭操作等图像的数学形态学在之前博客openCV基础知识（六）具体说明，链接为：https://blog.csdn.net/qq_26274961/article/details/121641637<br> 图像背景消除在之前博客openCV基础知识（八）具体说明，链接为：https://blog.csdn.net/qq_26274961/article/details/121731186</p> 
</blockquote> 
<h2><a id="_115"></a>六、代码文件</h2> 
<p>小程序员将代码文件和相关素材整理到了百度网盘里，因为文件大小基本不大，大家也不用担心限速问题。后期小程序员有能力的话，将在gitee或者github上上传相关素材。<br> 链接：https://pan.baidu.com/s/1Ce14ZQYEYWJxhpNEP1ERhg?pwd=7mvf<br> 提取码：7mvf</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/fac8eed44234ca101047d84471f35aaf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何在Ubuntu上编辑和运行C程序(新手入门)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2984d3b74a6fec949d3ef04a5a5da2b1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mobx数据更新，组件未刷新问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>