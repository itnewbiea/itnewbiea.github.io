<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【MySQL】MetaData Lock 之三 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【MySQL】MetaData Lock 之三" />
<meta property="og:description" content="一 简介 通过前面两篇文章的介绍，相信读到这里的各位对MDL 锁已经有了比较深入的了解了,本文将结合理论知识介绍几组MDL 锁的案例。 二 常见MDL 锁的场景 1 Waiting for global read lock 我们先构造一个Waiting for global read lock场景： session1: alter table t1 add c3 bigint; //大表执行需较长时间 session2: set global read only=on; //等待 查看 mysql&gt; show processlist;
&#43;----&#43;------&#43;-----------------&#43;------&#43;---------&#43;------&#43;------------------------------&#43;------------------------------&#43;
| Id | User | Host | db | Command | Time | State | Info |
&#43;----&#43;------&#43;-----------------&#43;------&#43;---------&#43;------&#43;------------------------------&#43;------------------------------&#43;
| 1 | root | localhost:5202 | test | Query | 12 | altering table | alter table t1 add c3 bigint |" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/7c05a3772d6e4713761f1cd4a65d3cad/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2015-09-05T20:10:15+08:00" />
<meta property="article:modified_time" content="2015-09-05T20:10:15+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【MySQL】MetaData Lock 之三</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="preview-main"> 
 <strong><span style="font-size:16px;">一 简介</span></strong> 
 <br>  通过前面两篇文章的介绍，相信读到这里的各位对MDL 锁已经有了比较深入的了解了,本文将结合理论知识介绍几组MDL 锁的案例。 
 <br> 
 <strong><span style="font-size:16px;"><br> 二 常见MDL 锁的场景</span></strong> 
 <br> 
 <span style="font-size:14px;"><strong>1 Waiting for global read lock</strong></span> 
 <br>   我们先构造一个Waiting for global read lock场景： 
 <br>   session1: alter table t1 add c3 bigint; //大表执行需较长时间 
 <br>   session2: set global read only=on; //等待 
 <br>   查看 
 <br> 
 <div id="codeText" class="codeText"> 
  <ol start="1" class="dp-css none_number"><li> <span style="color:#000000;">mysql<span style="color:#0000CC;">&gt;</span> show processlist<span style="color:#0000CC;">;</span><br></span> </li><li> <span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><br></li><li> <span style="color:#0000CC;">|</span> Id <span style="color:#0000CC;">|</span> User <span style="color:#0000CC;">|</span> Host <span style="color:#0000CC;">|</span> db <span style="color:#0000CC;">|</span> Command <span style="color:#0000CC;">|</span> Time <span style="color:#0000CC;">|</span> State <span style="color:#0000CC;">|</span> Info <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><br></li><li> <span style="color:#0000CC;">|</span> 1 <span style="color:#0000CC;">|</span> root <span style="color:#0000CC;">|</span> localhost<span style="color:#0000CC;">:</span>5202  <span style="color:#0000CC;">|</span> <span style="color:#0000FF;">test</span> <span style="color:#0000CC;">|</span> Query <span style="color:#0000CC;">|</span> 12 <span style="color:#0000CC;">|</span> altering table <span style="color:#0000CC;">|</span> alter table t1 <span style="color:#0000FF;">add</span> c3 bigint <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">|</span> 2 <span style="color:#0000CC;">|</span> root <span style="color:#0000CC;">|</span> localhost<span style="color:#0000CC;">:</span>14699 <span style="color:#0000CC;">|</span> <span style="color:#0000FF;">test</span> <span style="color:#0000CC;">|</span> Query <span style="color:#0000CC;">|</span> 3 <span style="color:#0000CC;">|</span> Waiting <span style="color:#0000FF;">for</span> global read <span style="color:#0000FF;">lock</span> <span style="color:#0000CC;">|</span> set global read_only<span style="color:#0000CC;">=</span>on <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">|</span> 3 <span style="color:#0000CC;">|</span> root <span style="color:#0000CC;">|</span> localhost<span style="color:#0000CC;">:</span>17085 <span style="color:#0000CC;">|</span> NULL <span style="color:#0000CC;">|</span> Query <span style="color:#0000CC;">|</span> 0 <span style="color:#0000CC;">|</span> init <span style="color:#0000CC;">|</span> show processlist <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span> </li></ol> 
 </div> 分析：  
 <br>  alter table t1 add c3 bigint;会加（GLOBAL,MDL_STATEMENT,MDL_INTENTION_EXCLUSIVE) 语句结束后才释放 
 <br>  set global read only=on; 会加（GLOBAL，MDL_EXPLICIT，MDL_SHARED） 
 <br>  由于session1执行时间比较长，一直持有MDL_INTENTION_EXCLUSIVE。从兼容性矩阵可以看出MDL_SHARED和MDL_INTENTION_EXCLUSIVE是不相容的，因此发生“Waiting for global read lock ”等待。直到session 1 alter操作完成释放MDL_INTENTION_EXCLUSIVE。set global read only=on;才可以继续执行。   
 <br> 
 <strong><span style="font-size:14px;">2.2 Waiting for commit lock</span></strong> 
 <br> session1:  
 <br>           begin; 
 <br>           insert into t1 vlaues(null, 'ab');         
 <br> session2: 
 <br>           flush table with read lock;//成功 
 <br> session1: commit //发生等待 
 <br> 
 <span style="line-height:1.3;font-family:Consolas, monospace;letter-spacing:.1px;">mysql</span> 
 <span style="line-height:1.3;font-family:Consolas, monospace;letter-spacing:.1px;color:#0000CC;">&gt;</span> 
 <span style="line-height:1.3;font-family:Consolas, monospace;letter-spacing:.1px;"> show processlist</span> 
 <span style="line-height:1.3;font-family:Consolas, monospace;letter-spacing:.1px;color:#0000CC;">;</span> 
 <div class="codeText"> 
  <ol start="1" class="dp-css none_number"><li> </li><li> <span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><br></li><li> <span style="color:#0000CC;">|</span> Id <span style="color:#0000CC;">|</span> User <span style="color:#0000CC;">|</span> Host <span style="color:#0000CC;">|</span> db <span style="color:#0000CC;">|</span> Command <span style="color:#0000CC;">|</span> Time <span style="color:#0000CC;">|</span> State <span style="color:#0000CC;">|</span> Info <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><br></li><li> <span style="color:#0000CC;">|</span> 1 <span style="color:#0000CC;">|</span> root <span style="color:#0000CC;">|</span> 127<span style="color:#0000CC;">.</span>0<span style="color:#0000CC;">.</span>0<span style="color:#0000CC;">.</span>1<span style="color:#0000CC;">:</span>5202 <span style="color:#0000CC;">|</span> <span style="color:#0000FF;">test</span> <span style="color:#0000CC;">|</span> Query <span style="color:#0000CC;">|</span> 7 <span style="color:#0000CC;">|</span> Waiting <span style="color:#0000FF;">for</span> commit <span style="color:#0000FF;">lock</span> <span style="color:#0000CC;">|</span> commit <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">|</span> 2 <span style="color:#0000CC;">|</span> root <span style="color:#0000CC;">|</span> 127<span style="color:#0000CC;">.</span>0<span style="color:#0000CC;">.</span>0<span style="color:#0000CC;">.</span>1<span style="color:#0000CC;">:</span>14699 <span style="color:#0000CC;">|</span> <span style="color:#0000FF;">test</span> <span style="color:#0000CC;">|</span> <span style="color:#FF0000;">Sleep</span> <span style="color:#0000CC;">|</span> 13 <span style="color:#0000CC;">|</span> <span style="color:#0000CC;">|</span> NULL <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">|</span> 3 <span style="color:#0000CC;">|</span> root <span style="color:#0000CC;">|</span> 127<span style="color:#0000CC;">.</span>0<span style="color:#0000CC;">.</span>0<span style="color:#0000CC;">.</span>1<span style="color:#0000CC;">:</span>17085 <span style="color:#0000CC;">|</span> NULL <span style="color:#0000CC;">|</span> Query <span style="color:#0000CC;">|</span> 0 <span style="color:#0000CC;">|</span> init <span style="color:#0000CC;">|</span> show processlist <span style="color:#0000CC;">|</span><br></li><li> <span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">-</span><span style="color:#0000CC;">+</span> </li></ol> 
 </div> 分析： 
 <br>  flush table with read lock;持有（COMMIT，MDL_EXPLICIT，MDL_SHARED） 
 <br>  commit时上（COMMIT，MDL_EXPLICIT，MDL_INTENTION_EXCLUSIVE）锁 
 <br>  MDL_SHARED和MDL_INTENTION_EXCLUSIVE是不相容的，因此发生等待. 
 <br> 
 <strong><span style="font-size:14px;">2.3 Waiting for table metadata lock</span></strong> 
 <br> 这个是比较常见的锁等待，总结下来有如下几种场景 
 <br> 
 1 长查询/mysqldump 阻塞DDL  
 <br> 
 <table border="0" cellpadding="0" cellspacing="0" width="628" style="width:471pt;" class="ke-zeroborder"><tbody><tr><td height="18" width="186" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> session1 </td><td width="155" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> session2 </td><td width="287" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> session3 </td></tr><tr><td height="18" colspan="2" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> Select count(*) from t; </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td width="155" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> alter table t add <br> column c3 int; </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td width="287" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> Show processlist；<br> session2：copy to tmp table </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> 阻塞 </td><td width="287" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> Show processlist;<br> session2：Waiting for table metadata lock </td></tr><tr><td height="18" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;">  A：执行完毕 </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td width="287" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> Show processlist; <br> session2：rename table </td></tr><tr><td height="18" colspan="2" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> Select count(*) from t; </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td></tr><tr><td height="18" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> B：执行完毕 </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td width="287" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> Show processlist;<br> session1: Sending data </td></tr></tbody></table> 
 <br> 会话1先执行select ,会话2后执行alter,在会话1执行完毕前，会话2拿不到MDL锁，从表格上面来看，主要阻塞在rename阶段。会话1在执行完毕后，会话2拿到MDL锁，变为rename table状态，这个操作持续时间非常短,会话1再次执行查询，当会话2执行完后，此时会话1正常执行。 
 <strong><u><span style="color:#E53333;">这说明对于MDL锁而言，select会阻塞alter，而alter不会阻塞select</span></u></strong>。在rename的瞬间，alter是会阻塞select的. 
 <br> 当执行select语句时，只要select语句在获取MDL_SHARED_READ锁之前，alter没有执行到rename阶段，那么select获取MDL_SHARED_READ锁成功，后续有alter执行到rename阶段，请求MDL_EXCLUSIVE锁时，就会被阻塞。rename阶段会持有MDL_EXCLUSIVE锁，但由于这个过程时间非常短(大头都在copy数据阶段)，并且是alter的最后一个阶段，所以基本感觉不到alter会阻塞select语句。由于MDL锁在事务提交后才释放，若线上存在大查询，或者存在未提交的事务，则会出现ddl卡住的现象。这里要注意的是，ddl卡住后，若再有select查询或DML进来，都会被堵住，就会出现threadrunning飙高的情况。 
 <br> 
 <div> 
  <br> 
 </div> 2 未提交的事务阻塞 DDL  
 <br>    
 <table border="0" cellpadding="0" cellspacing="0" width="879" class="ke-zeroborder"><tbody><tr><td height="18" width="337" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> session1 </td><td width="195" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> session2 </td><td width="347" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> session3 </td></tr><tr><td height="54" width="337" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> begin;<br> update t set where id=3; </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td width="195" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> alter table t add <br> column c3 int;//hang  </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td></tr><tr><td height="36" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> </td><td width="347" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;"> Show processlist;<br> session2：Waiting for table metadata lock </td></tr><tr><td height="18" style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> </td><td style="font-size:11pt;font-family:'宋体';border:.5pt solid #000000;background:#D9D9D9;"> Select count(*) from t;//hang </td></tr><tr><td height="90" width="337" style="font-size:11pt;font-family:'宋体';"> Show processlist;<br> session2：Waiting for table metadata lock<br> session3：Waiting for table metadata lock </td><td style="font-size:11pt;font-family:'宋体';"> </td><td width="347" style="font-size:11pt;font-family:'宋体';"> </td></tr></tbody></table> 
 <br> session1 对表t进行update操作，存在未提交的事务，故一直持有 MDL_SHARED_WRITE锁，由于没有执行COMMIT，会一直持有。session2 DDL 操作会请求TABLE-TRANSACTION-EXCLUSIVE锁，该锁与session1 的MDL_SHARED_WRITE 锁互斥，故 session2 的DDL 等待；session3的查询操作会请求TABLE- TRANSACTION- MDL_SHARED_READ锁，虽然MDL_SHARED_READ与活跃锁MDL_SHARED_WRITE不冲突，但是与session2的等待锁EXCLUSIVE冲突，因此也会等待。 
 <br> 解决该中场景的问题比较麻烦，但从show processlist 不能检查出哪个会话持有锁 。可以从两个方面进行调查  
 <br> a  
 查询 information_schema.innodb_trx 
 <br>    
 <img src="https://images2.imgbox.com/c5/ee/6rRLvBAN_o.png" width="700" height="96" alt=""> 
 <br> 
 b 检查 show engine innodb status ;  
 <br>    
 <img src="https://images2.imgbox.com/99/81/aIohEF9A_o.png" width="700" height="116" alt=""> 
 <br>   
 <strong>active N sec 说明事务持续了N秒，一般而言超过10秒的事务都是有问题的 </strong>。找到了活动的事务之后，要和开发沟通看看如何处理，能否直接kill 该回话？ 根据和开发沟通的结果采取相应的措施。 
 <br> 3 第1种情况的特例，存在一个查询失败的语句，比如查询不存在的列，语句失败返回，但是事务没有提交，此时alter仍然会被堵住。  
 <br>    通过show processlist看不到TableA上有任何操作，在information_schema.innodb_trx中也没有任何进行中的事务。这很可能是因为在一个显式的事务中，对TableA进行了一个失败的操作（比如查询了一个不存在的字段），这时事务没有开始，但是失败语句获取到的锁依然有效。从performance_schema.events_statements_current表中可以查到失败的语句。 
 <br> 官方手册上对此的说明如下： 
 <br> If the server acquires metadata locks for a statement that is syntactically valid but fails during execution, it does not release the locks early. Lock release is still deferred to the end of the transaction because the failed statement is written to the binary log and the locks protect log consistency. 
 <br> 也就是说除了语法错误，其他错误语句获取到的锁在这个事务提交或回滚之前，仍然不会释放掉。because the failed statement is written to the binary log and the locks protect log consistency 但是解释这一行为的原因很难理解，因为错误的语句根本不会被记录到二进制日志。 
 <br> 
 <br> 三 参考  
 <br> [1] 《 
 <a href="http://ctripmysqldba.iteye.com/blog/1938150" rel="nofollow">MySQL出现Waiting for table metadata lock的场景浅析</a>》  
 <br> [2] 《 
 <a href="http://http//ctripmysqldba.iteye.com/blog/2074124" rel="nofollow">MySQL中 metadata lock问题分析</a>》 
 <br> [3] 《 
 <a href="https://dev.mysql.com/doc/refman/5.5/en/metadata-locking.html" rel="nofollow">官方Metadata Lock 介绍</a>》 
 <br> 
 <div> 
  <br> 
  <br> 
  <span style="letter-spacing:.1px;color:#666666;font-family:'宋体', Arial;line-height:26px;">如果您觉得从这篇文章受益，可以<span style="color:#666666;font-family:'宋体', Arial;letter-spacing:.1px;line-height:26px;">微信支付</span>赞助 </span> 
  <strong style="letter-spacing:.1px;color:#666666;font-family:'宋体', Arial;line-height:26px;"><u>北在南方</u></strong> 
  <span style="letter-spacing:.1px;color:#666666;font-family:'宋体', Arial;line-height:26px;"> 一瓶饮料 ^_^</span> 
  <br style="letter-spacing:.1px;color:#666666;font-family:'宋体', Arial;line-height:26px;"> 
  <img src="https://images2.imgbox.com/6e/87/yh9OE710_o.jpg" width="571" height="518" alt="" style="letter-spacing:.1px;color:#666666;font-family:'宋体', Arial;line-height:26px;"> 
  <br> 
 </div> 
 <p style="clear:both;"></p> 
 <p class="translate"> 来自 “ ITPUB博客 ” ，链接：http://blog.itpub.net/22664653/viewspace-1791744/，如需转载，请注明出处，否则将追究法律责任。 </p> 
</div> 
<p>转载于:http://blog.itpub.net/22664653/viewspace-1791744/</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/88b19fe10f93a9fcd952c8b080b6fa3f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">设置三个Slider控件,管理背景颜色,任意改变一个控件,背景颜色都会发生改变</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c81984602e48e90a7c21ff3445815c97/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">保存dialog的位置和大小</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>