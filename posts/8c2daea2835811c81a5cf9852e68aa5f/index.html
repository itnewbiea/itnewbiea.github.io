<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>æå–CNNæ¨¡å‹ä¸­é—´å±‚è¾“å‡ºæ–¹æ³• - ITå­¦ä¹ è€…åšå®¢</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="æå–CNNæ¨¡å‹ä¸­é—´å±‚è¾“å‡ºæ–¹æ³•" />
<meta property="og:description" content="å‰è¨€ é’ˆå¯¹ç»“æ„ä¸­å®šä¹‰äº†å¤šä¸ªnn.sequentialçš„ç½‘ç»œæ¨¡å‹ï¼Œæ— æ³•ç›´æ¥è·å–å…¶å†…éƒ¨æŸä¸€ä¸­é—´å±‚çš„è¾“å‡ºï¼Œæœ¬æ–‡å°†ç»™å‡ºä¸¤ä¸ªæ–¹æ³•è¿›è¡Œè§£å†³ã€‚
æ–¹æ³• 1 é€å±‚è¿›è¡Œforward åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ï¼Œå®ç°æŒ‰ç…§æ‰§è¡Œé¡ºåºé€å±‚å‰å‘æ‰§è¡Œç½‘ç»œæ¨¡å‹ã€‚
-----å°†æ¨¡å‹è¾“å…¥ä»¥åŠæ¨¡å‹ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°ï¼Œè¿”å›ç›®æ ‡ç»“æœ
def extract_res(inp, model): for index, module in enumerate(model.modules()): # æŒ‰æ‰§è¡Œé¡ºåºéå†ç½‘ç»œå„å±‚æ“ä½œ if index in [0, 1, ...]: # å»é™¤éæ“ä½œå±‚ continue inp = module(inp) # é€å±‚å‰å‘æ‰§è¡Œï¼Œå¾—åˆ°ç»“æœ if index == 3: # åˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡å±‚ (ç¤ºä¾‹ä¸ºç´¢å¼•ä¸º3çš„æ“ä½œ) return inp tip: åˆ©ç”¨.modules()åœ¨è¿›è¡Œéå†æ“ä½œæ—¶ï¼Œå…¶é¡ºåºä¸ºï¼š
ã€æ€»ç½‘ç»œç»“æ„â€“&gt;å„éƒ¨åˆ†â€“&gt;å„éƒ¨åˆ†å†…éƒ¨ã€‘
==ã€‹å¯è§index = 0ï¼Œ1å¯¹åº”ä¸ºéæ“ä½œå±‚ï¼Œéœ€è¦é¿å…å…¶æ‰§è¡Œforwardã€‚
æ•…åœ¨ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œéœ€è¦æ³¨æ„æ‘’å¼ƒéæ“ä½œå±‚ï¼Œè·³è¿‡æ‰§è¡Œã€‚æ­¤å¤–ï¼Œé¡»æ¨ç†å‡ºç›®æ ‡è¾“å‡ºå±‚å¯¹åº”ç´¢å¼•å·ï¼Œæ‰èƒ½å®ç°ç²¾å‡†è·å–ã€‚
2 ä½¿ç”¨hookå‡½æ•° ï¼ˆ1ï¼‰å®šä¹‰ä¿å­˜hookå†…å®¹çš„å¯¹è±¡ç±»
class SaveOutput: def __init__(self): self.outputs = [] def __call__(self, module, module_in, module_out): self.outputs.append(module_out) def clear(self): self.outputs = [] ï¼ˆ2ï¼‰ ä¸ºå·ç§¯å±‚æ³¨å†Œhook" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8c2daea2835811c81a5cf9852e68aa5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-21T11:24:30+08:00" />
<meta property="article:modified_time" content="2022-04-21T11:24:30+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="ITå­¦ä¹ è€…åšå®¢" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">ITå­¦ä¹ è€…åšå®¢</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">æå–CNNæ¨¡å‹ä¸­é—´å±‚è¾“å‡ºæ–¹æ³•</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>å‰è¨€</h3> 
<p>é’ˆå¯¹ç»“æ„ä¸­å®šä¹‰äº†<strong>å¤šä¸ªnn.sequential</strong>çš„ç½‘ç»œæ¨¡å‹ï¼Œ<mark>æ— æ³•ç›´æ¥è·å–å…¶å†…éƒ¨æŸä¸€ä¸­é—´å±‚çš„è¾“å‡º</mark>ï¼Œæœ¬æ–‡å°†ç»™å‡ºä¸¤ä¸ªæ–¹æ³•è¿›è¡Œè§£å†³ã€‚<br> <img src="https://images2.imgbox.com/64/5a/oGfwUXzT_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/86/23/zaPgRPgK_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"></p> 
<h3><a id="_4"></a>æ–¹æ³•</h3> 
<h4><a id="1_forward_5"></a>1 é€å±‚è¿›è¡Œforward</h4> 
<p>åˆ›å»ºè‡ªå®šä¹‰å‡½æ•°ï¼Œå®ç°<mark>æŒ‰ç…§æ‰§è¡Œé¡ºåº</mark>é€å±‚å‰å‘æ‰§è¡Œç½‘ç»œæ¨¡å‹ã€‚<br> -----å°†<strong>æ¨¡å‹è¾“å…¥</strong>ä»¥åŠ<strong>æ¨¡å‹</strong>ä½œä¸ºå‚æ•°ä¼ å…¥å‡½æ•°ï¼Œè¿”å›<strong>ç›®æ ‡ç»“æœ</strong></p> 
<pre><code>def extract_res(inp, model):
    for index, module in enumerate(model.modules()):  # æŒ‰æ‰§è¡Œé¡ºåºéå†ç½‘ç»œå„å±‚æ“ä½œ
        if index in [0, 1, ...]:  # å»é™¤éæ“ä½œå±‚
            continue
        inp = module(inp)  # é€å±‚å‰å‘æ‰§è¡Œï¼Œå¾—åˆ°ç»“æœ
        if index == 3:  # åˆ¤æ–­æ˜¯å¦ä¸ºç›®æ ‡å±‚  (ç¤ºä¾‹ä¸ºç´¢å¼•ä¸º3çš„æ“ä½œ)
            return inp
</code></pre> 
<p><strong><mark>tip:</mark></strong> åˆ©ç”¨.modules()åœ¨è¿›è¡Œéå†æ“ä½œæ—¶ï¼Œå…¶é¡ºåºä¸ºï¼š<br> ã€æ€»ç½‘ç»œç»“æ„â€“&gt;å„éƒ¨åˆ†â€“&gt;å„éƒ¨åˆ†å†…éƒ¨ã€‘<br> <img src="https://images2.imgbox.com/cb/90/9gehq0HH_o.png" alt=""><br> <img src="https://images2.imgbox.com/e9/f4/UZRP7f0t_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><img src="https://images2.imgbox.com/d6/06/BMCGdJUe_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/38/cb/7bftssMh_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><img src="https://images2.imgbox.com/20/72/ZfOvivD4_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> <img src="https://images2.imgbox.com/da/3b/zsLssp9e_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><img src="https://images2.imgbox.com/ff/68/VInCkgkp_o.png" alt="åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°"><br> ==ã€‹å¯è§index = 0ï¼Œ1å¯¹åº”ä¸ºéæ“ä½œå±‚ï¼Œéœ€è¦é¿å…å…¶æ‰§è¡Œforwardã€‚<br> æ•…åœ¨ä½¿ç”¨æ­¤æ–¹æ³•æ—¶ï¼Œéœ€è¦æ³¨æ„<strong>æ‘’å¼ƒéæ“ä½œå±‚</strong>ï¼Œè·³è¿‡æ‰§è¡Œã€‚æ­¤å¤–ï¼Œé¡»<strong>æ¨ç†å‡ºç›®æ ‡è¾“å‡ºå±‚å¯¹åº”ç´¢å¼•å·</strong>ï¼Œæ‰èƒ½å®ç°ç²¾å‡†è·å–ã€‚</p> 
<hr> 
<h4><a id="2_hook_28"></a>2 ä½¿ç”¨hookå‡½æ•°</h4> 
<p>ï¼ˆ1ï¼‰å®šä¹‰ä¿å­˜hookå†…å®¹çš„å¯¹è±¡ç±»</p> 
<pre><code>class SaveOutput:
    def __init__(self):
        self.outputs = []

    def __call__(self, module, module_in, module_out):
        self.outputs.append(module_out)

    def clear(self):
        self.outputs = []
</code></pre> 
<p>ï¼ˆ2ï¼‰ ä¸ºå·ç§¯å±‚æ³¨å†Œhook</p> 
<pre><code>	hook_handles = []
	save_output = SaveOutput()
	for layer in model.modules():     # æŒ‰æ‰§è¡Œé¡ºåºéå†ç½‘ç»œå„å±‚æ“ä½œ
	if isinstance(layer, nn.Linear):   # æŒ‰æ“ä½œæŒ‡ä»¤è¿›è¡Œåˆ¤åˆ«
	        handle = layer.register_forward_hook(save_output)
	        hook_handles.append(handle)
</code></pre> 
<p>ä»£ç ä¸­ç¤ºä¾‹å³ä¸ºå¯»æ‰¾<strong>æ‰€æœ‰ä¸ºæ‰§è¡Œnn.Linearï¼ˆï¼‰çš„æ“ä½œå±‚</strong></p> 
<p>ï¼ˆ3ï¼‰ å¯¹è¾“å…¥xè¿›è¡Œé¢„æµ‹ï¼ˆè¿‡ç¨‹ä¸­æ¯è®¡ç®—ä¸€ä¸ªè¾“å‡ºå°†è‡ªåŠ¨è°ƒç”¨hookå‡½æ•°ï¼‰</p> 
<pre><code>out = model(x)  
</code></pre> 
<p>ï¼ˆ4ï¼‰å–å‡ºé€šè¿‡ç›®æ ‡å±‚çš„è¾“å‡º</p> 
<pre><code>data = save_output.outputs[2]    # 2ä¸ºç›®æ ‡æ“ä½œå±‚è¾“å‡ºåœ¨æœ€ç»ˆç»“æœåˆ—è¡¨ä¸­çš„ç´¢å¼•
</code></pre> 
<p><strong><mark>tip:</mark></strong> ç½‘ç»œ<strong>åŒ…å«å‡ ä¸ªæ“ä½œåŒåå±‚</strong>ï¼Œ<strong>save_output.outputsçš„sizeå°±ä¸ºå¤šå°‘</strong>ï¼Œå–å‡ºå¯¹åº”ä½ç½®çš„è¾“å‡ºå³å¯</p> 
<p>------tbc-------<br> æœ‰ç”¨å¯ä»¥ç‚¹ä¸ªå¤§æ‹‡æŒ‡å“¦ ğŸ¤­</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/773a7cd03bd0369470042f3ee075d1ae/" rel="prev">
			<span class="pager__subtitle">Â«&thinsp;Previous</span>
			<p class="pager__title">MySQLä¿®æ”¹æœ€å¤§è¿æ¥æ•°é™åˆ¶</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/40951c537f765bb94598bf0e71c3350b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;Â»</span>
			<p class="pager__title">golangä¸­çº§è¿›é˜¶ï¼ˆäº”ï¼‰ï¼šæ¥å£æ¥æ”¶è€…ã€ç»“æ„ä½“å¤šæ¥å£ã€æ¥å£åµŒå¥—ã€ç©ºæ¥å£ç±»å‹æ–­è¨€ä½¿ç”¨ç»†èŠ‚</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 ITå­¦ä¹ è€…åšå®¢.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>