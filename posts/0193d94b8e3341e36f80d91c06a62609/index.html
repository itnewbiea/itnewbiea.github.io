<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Oracle merge into 语句用法 Oracle merge into 批量更新 关联更新 批量修改 关联修改 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Oracle merge into 语句用法 Oracle merge into 批量更新 关联更新 批量修改 关联修改" />
<meta property="og:description" content="Oracle merge into 语句用法 Oracle merge into 批量更新 关联更新 批量修改 关联修改 一、概述 在开发任务中，遇到一个需求，同一批次的名单；根据一定的条件判断是否存在，若存在，则进行更新操作；若不存在，进行插入操作。实现方法有两种：
1. java代码中，使用业务逻辑来判断是否存在，存在，修改；不存在，添加。
2、由于使用的Oracle数据库，可以使用merge into语句来实现批量的添加、修改操作
本文将记录和讲解merge into 语句的使用 和 mybatis中使用 merge into 语句 。
二、代码示例 1、 merge into 语法规则 MERGE INTO target_table tt -- 目标表 USING source_table st -- 关联表 ON (tt.id = st.id AND tt.age = st.age ) -- 是否唯一条件，可以是多个 WHEN MATCHED AND tt.name &lt;&gt; st.name THEN -- 1、满足条件--带额外条件 WHEN MATCHED THEN -- 2、满足条件-- 不带额外条件 UPDATE SET -- 执行更新操作，注意没有 表名 update set tt." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0193d94b8e3341e36f80d91c06a62609/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-01T07:00:00+08:00" />
<meta property="article:modified_time" content="2024-01-01T07:00:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Oracle merge into 语句用法 Oracle merge into 批量更新 关联更新 批量修改 关联修改</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>Oracle merge into 语句用法 Oracle merge into 批量更新 关联更新 批量修改 关联修改</h2> 
<p></p> 
<h3>一、概述</h3> 
<p>        在开发任务中，遇到一个需求，同一批次的名单；根据一定的条件判断是否存在，若存在，则进行更新操作；若不存在，进行插入操作。实现方法有两种：</p> 
<p>        1. java代码中，使用业务逻辑来判断是否存在，存在，修改；不存在，添加。</p> 
<p>        2、由于使用的Oracle数据库，可以使用merge into语句来实现批量的添加、修改操作</p> 
<p>        本文将记录和讲解<strong>merge into 语句的使用</strong> 和 <strong>mybatis中使用 merge into 语句 </strong>。</p> 
<p></p> 
<h3>二、代码示例</h3> 
<h4>        1、 merge into 语法规则</h4> 
<pre><code class="language-sql">MERGE INTO target_table tt  -- 目标表
USING source_table st -- 关联表
ON (tt.id = st.id AND tt.age = st.age ) -- 是否唯一条件，可以是多个 

WHEN MATCHED AND tt.name &lt;&gt; st.name THEN  -- 1、满足条件--带额外条件
WHEN MATCHED THEN  -- 2、满足条件-- 不带额外条件
UPDATE SET  -- 执行更新操作，注意没有 表名 update set
    tt.name = st.name ,
    tt.age = st.age 

[ WHEN NOT MATCHED THEN ]  -- 3、不满足条件, 可选，非必须语句
INSERT (id, name) VALUES (st.id, st.name);  -- 执行添加操作，注意没有表名 insert
</code></pre> 
<p></p> 
<h4>        2.1、创建2张表</h4> 
<pre><code class="language-sql">-- WUDI.USER_TARGET definition

CREATE TABLE "WUDI"."USER_TARGET" 
   (    "ID" VARCHAR2(100), 
    "NAME" VARCHAR2(100), 
    "ADDR" VARCHAR2(100)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "WUDI" ;

COMMENT ON COLUMN WUDI.USER_TARGET.ID IS '主键';
COMMENT ON COLUMN WUDI.USER_TARGET.NAME IS '名字';
COMMENT ON COLUMN WUDI.USER_TARGET.ADDR IS '地址';

--- USER_SOURCE 表创建过程略</code></pre> 
<h4>        2.2、插入数据</h4> 
<pre><code class="language-sql">-- 1.1、 USER_TARGET 初始化数据 ID= 1,2,3

INSERT INTO WUDI.USER_TARGET(ID, NAME, ADDR) VALUES('1', 'TARGET=1', '');
INSERT INTO WUDI.USER_TARGET(ID, NAME, ADDR) VALUES('2', 'TARGET=2', '');
INSERT INTO WUDI.USER_TARGET(ID, NAME, ADDR) VALUES('3', 'TARGET=3', NULL);

-- 2.1、 USER_SOURCE 初始化数据 ID= 3,4,5
INSERT INTO WUDI.USER_SOURCE (ID, NAME, ADDR) VALUES('3', 'SOURCE=3', NULL);
INSERT INTO WUDI.USER_SOURCE (ID, NAME, ADDR) VALUES('4', 'SOURCE=4', NULL);
INSERT INTO WUDI.USER_SOURCE (ID, NAME, ADDR) VALUES('5', 'SOURCE=5', NULL);

</code></pre> 
<h5 style="background-color:transparent;">        2.2.1、USER_TARGET 表数据如下</h5> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/22/2e/5PdlCfft_o.png"></p> 
<h5 style="background-color:transparent;">        2.2.2、USER_SOURCE 表数据如下</h5> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/5d/22/1gnsRsUR_o.png"></p> 
<h4 style="background-color:transparent;">        2.3、使用merge into 更新</h4> 
<pre><code class="language-sql">--  MERGE INTO : USER_SOURCE 数据 合并到 USER_TARGET  , 存在修改；不存在添加
MERGE INTO USER_TARGET T1 
USING USER_SOURCE T2 
ON (T1.ID = T2.ID )
WHEN MATCHED THEN 
    UPDATE SET T1.NAME = T2.NAME
WHEN NOT MATCHED THEN 
INSERT (ID,NAME) VALUES(T2.ID,T2.NAME) ; 
</code></pre> 
<p></p> 
<h5 style="background-color:transparent;">        2.3.1、merge into 更新后 USER_TARGET 表数据如下</h5> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/47/c7/bNBj2Qob_o.png"></p> 
<h4>        2.4、使用merge into 更新 --- 子查询</h4> 
<pre><code class="language-sql">-- 3.2、不存在 ID=7,8 添加数据
MERGE INTO USER_TARGET T1 
USING (
    SELECT 7 AS ID , 'SOURCE=7' AS NAME  FROM DUAL 
    UNION ALL
    SELECT 8 AS ID , 'SOURCE=8' AS NAME  FROM DUAL 
)T2
ON (T1.ID = T2.ID)
WHEN NOT MATCHED THEN 
INSERT (ID,NAME) VALUES(T2.ID,T2.NAME) ; </code></pre> 
<h5 style="background-color:transparent;">        2.4.1、merge into 更新---子查询 USER_TARGET 表数据如下</h5> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/cc/29/qNi2m3js_o.png"></p> 
<h4>        3、MyBatis中使用示例</h4> 
<pre><code class="language-XML">&lt;update id="updateBatch" parameterType="list"&gt;
   MERGE INTO USER_TARGET T1
      USING (
          &lt;foreach collection="list" item="e"  separator="UNION ALL"&gt;
            SELECT #{e.id} AS ID , #{e.name} AS NAME FROM DUAL
         &lt;/foreach&gt;
         ) T2
      ON (T1.ID = T2.ID )
      WHEN MATCHED THEN
         UPDATE SET T1.NAME = T2.NAME
      WHEN NOT MATCHED THEN
         INSERT (ID,NAME) VALUES(T2.ID,T2.NAME) ;
&lt;/update&gt;
</code></pre> 
<h4>        4、merge into NULL值问题</h4> 
<p>        在使用merge into语句时，若遇到 on 中遇到的两个字段值，都是null值的情况，不会执行 when matched then 语句，会一直执行<span style="color:#fe2c24;"> when not matched then</span> ... ， 也就 on条件中<strong> null=null 的条件是<span style="background-color:#ff9900;">false </span></strong>， 如本示例中 ，会一直执行 when not matched then 。</p> 
<pre><code class="language-XML">ON (T1.ID = T2.ID AND T1.ADDR = T2.ADDR )</code></pre> 
<pre><code class="language-sql">MERGE INTO USER_TARGET T1 
USING (
   SELECT * FROM USER_SOURCE a WHERE a.id ='3'
)T2
-- ON 条件不满足，会执行insert插入数据
ON (T1.ID = T2.ID AND T1.ADDR=  T2.ADDR)
WHEN MATCHED THEN 
    UPDATE SET T1.NAME = T2.NAME
WHEN NOT MATCHED THEN 
INSERT (ID,NAME) VALUES(T2.ID,T2.NAME) ; </code></pre> 
<p><img alt="" height="732" src="https://images2.imgbox.com/03/25/oS3iCydj_o.png" width="649"></p> 
<h5 style="background-color:transparent;">        4.1、COALESCE函数解决 merge into null 值问题</h5> 
<p>        使用 <a href="https://www.cnblogs.com/zuiyue_jing/p/10135815.html" rel="nofollow" title="COALESCE 函数">COALESCE 函数</a>，可以将NULL值转换为某个固定的值，来进行判断，<u><strong>这样遇到 NULL=NULL的情况，可以转换为 1=1</strong></u> ，这样就可以避免NULL值的时候，判断情况不准确的问题。</p> 
<pre><code class="language-sql">MERGE INTO USER_TARGET T1 
USING (
   SELECT * FROM USER_SOURCE a WHERE a.id ='3'
)T2
-- COALESCE 函数，将NULL值转换为1
ON (T1.ID = T2.ID AND COALESCE(T1.ADDR,'1') = COALESCE( T2.ADDR,'1'))
WHEN MATCHED THEN 
    UPDATE SET T1.NAME = T2.NAME
WHEN NOT MATCHED THEN 
INSERT (ID,NAME) VALUES(T2.ID,T2.NAME) ; 
</code></pre> 
<p></p> 
<p class="img-center"><img alt="" height="627" src="https://images2.imgbox.com/b2/bf/3bOqExm1_o.png" width="574"></p> 
<h3></h3> 
<h3>三、总结</h3> 
<h4 style="background-color:transparent;">        1、on后面的关联条件成立时:</h4> 
<p>        on后面的关联条件成立时: WHEN MATCHED THEN ，可以 update、delete 。</p> 
<h4 style="background-color:transparent;"><strong>        2、on后面的关联条件不成立时: </strong></h4> 
<p>        on后面的关联条件不成立时: WHEN NOT MATCHED THEN ，可以insert</p> 
<p>        3、只会改变 目标表数据 <strong>MERGE INTO TABLE</strong> ， 不会改变 源表数据 USING TABLE</p> 
<p>        4、USING TBALE 支持： 视图 view 、表table 、子查询 subQuery</p> 
<p>        5、WHEN MATCHED THEN 和 WHEN NOT MATCHED THEN ， 可以二选其一，也可以同时存在。</p> 
<p></p> 
<h3>参考资料：</h3> 
<p><a href="https://blog.csdn.net/lanxingbudui/article/details/123126895" title="Oracle中merge into的使用方法">Oracle中merge into的使用方法</a></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ad2f9d66e63893f5278f74422e0195e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">案例081:基于微信小程序的移动平台的远程在线诊疗系统</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/905ead3203d7994afbd261406fedada1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">qs.stringify 使用arrayFormat属性 &#43; allowDots的数据处理 - 附示例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>