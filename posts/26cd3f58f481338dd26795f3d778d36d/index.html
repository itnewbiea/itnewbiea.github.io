<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C# 对ini文件的序列化和反序列化 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C# 对ini文件的序列化和反序列化" />
<meta property="og:description" content="1.对ini文件进行序列化和反序列化 using System; using System.Collections.Generic; using System.Linq; using System.Text; using System.Reflection; public class IniDeserialize&lt;T&gt; where T : class, new() { /// &lt;summary&gt; /// 若ini文件中无对应值，就提取默认对象中的值 /// &lt;/summary&gt; T _defaultT; /// &lt;summary&gt; /// 序列化后的对象 /// &lt;/summary&gt; public T Value { get; set; } IniRW _iniRW; public IniDeserialize(string path, T defaultT) { _iniRW = new IniRW(path); _defaultT = defaultT; Deserialize(); } /// &lt;summary&gt; /// 反序列化 /// &lt;/summary&gt; /// &lt;returns&gt;&lt;/returns&gt; bool Deserialize() { Value = new T(); Type tInfo = Value." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/26cd3f58f481338dd26795f3d778d36d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-11-08T17:00:22+08:00" />
<meta property="article:modified_time" content="2019-11-08T17:00:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C# 对ini文件的序列化和反序列化</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h3> 1.对ini文件进行序列化和反序列化</h3> 
<pre class="has"><code class="language-cs">    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using System.Reflection;
    
    public class IniDeserialize&lt;T&gt; where T : class, new()
    {
        /// &lt;summary&gt;
        /// 若ini文件中无对应值，就提取默认对象中的值
        /// &lt;/summary&gt;
        T _defaultT;

        /// &lt;summary&gt;
        /// 序列化后的对象
        /// &lt;/summary&gt;
        public T Value { get; set; }

        IniRW _iniRW;
        public IniDeserialize(string path, T defaultT)
        {
            _iniRW = new IniRW(path);
            _defaultT = defaultT;
            Deserialize();
        }

        /// &lt;summary&gt;
        /// 反序列化
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        bool Deserialize()
        {
            Value = new T();
            Type tInfo = Value.GetType();
            string section = tInfo.Name;
            foreach (PropertyInfo p in tInfo.GetProperties())
            {
                string key = p.Name;
                string iniValue = _iniRW.ReadString(section, key);
                if (iniValue == string.Empty)
                {
                    PropertyInfo pd = _defaultT.GetType().GetProperty(key);
                    iniValue = pd.GetValue(_defaultT, null) as string;
                }
                object value = iniValue.Format(p.PropertyType);
                p.SetValue(Value, value, null);
            }
            return true;
        }

        /// &lt;summary&gt;
        /// 序列化保存
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Serialize()
        {
            Type tInfo = Value.GetType();
            string section = tInfo.Name;
            foreach (PropertyInfo p in tInfo.GetProperties())
            {
                string key = p.Name;
                object value = p.GetValue(Value, null);
                _iniRW.WriteValue(section, key, value);
            }
            return true;
        }


    }
</code></pre> 
<h3> 2.对ini文件的读写</h3> 
<pre class="has"><code class="language-cs">    public class IniRW : IniUse
    {
        public string IniPath;

        public IniRW(string path)
        {
            IniPath = path;
        }

        public virtual bool WriteValue(string section, string key, object value)
        {
            string v = value == null ? "" : value.ToString();
            long ret = WritePrivateProfileString(section, key, v, IniPath);
            return true;
        }

        public virtual string ReadString(string section, string key)
        {
            StringBuilder sb = new StringBuilder(255);
            string def = string.Empty;
            int ret = GetPrivateProfileString(section, key, def, sb, 255, IniPath);
            return ret == 0 ? def : sb.ToString();
        }

        public int ReadInt(string section, string key)
        {
            return (int)ReadDouble(section, key);
        }

        public short ReadShort(string section, string key)
        {
            return (short)ReadDouble(section, key);
        }

        public byte ReadByte(string section, string key)
        {
            return (byte)ReadDouble(section, key);
        }

        public double ReadDouble(string section, string key)
        {
            double res = 0;
            string sb = ReadString(section, key);
            double.TryParse(sb, out res);
            return res;
        }

        public bool ReadBool(string section, string key)
        {
            bool res = false;
            string sb = ReadString(section, key).Trim();
            if (sb == "1")
            {
                return true;
            }
            else if (sb == "0")
            {
                return false;
            }
            bool.TryParse(sb, out res);
            return res;
        }


    }
</code></pre> 
<h3>3.调用 kernel32 对ini的读写</h3> 
<pre class="has"><code class="language-cs">    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Text;
    using System.Runtime.InteropServices; //WinAPI引用命名空间

    /// &lt;summary&gt;
    /// 对ini配置文件读写，写时文件不存在会自动创建(不会自动创建文件夹）
    /// &lt;/summary&gt;
    public class IniUse
    {
        [DllImport("kernel32")]
        public static extern long WritePrivateProfileString(string section, string key, string val, string filePath);

        /// &lt;summary&gt;
        /// 从ini文件中获取键值  不存在则自动创建 若不存在键时返回def默认值,当不存在且def为空值时才返回0，否则为1  ps:文件打开的状态下都可以读取
        /// &lt;/summary&gt;
        /// &lt;param name="section"&gt;&lt;/param&gt;
        /// &lt;param name="key"&gt;&lt;/param&gt;
        /// &lt;param name="def"&gt;&lt;/param&gt;
        /// &lt;param name="retVal"&gt;&lt;/param&gt;
        /// &lt;param name="size"&gt;&lt;/param&gt;
        /// &lt;param name="filePath"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        [DllImport("kernel32")]
        public static extern int GetPrivateProfileString(string section, string key, string def, StringBuilder retVal, int size, string filePath);

    }
</code></pre> 
<h3>4.将读取到的字符串转换为对应的类型 </h3> 
<pre class="has"><code class="language-cs">        using System;
        using System.ComponentModel;


        /// &lt;summary&gt;
        /// 将字符串格式化成指定的数据类型
        /// &lt;/summary&gt;
        /// &lt;param name="str"&gt;&lt;/param&gt;
        /// &lt;param name="type"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static object Format(this string str, Type type)
        {
            if (string.IsNullOrEmpty(str))
                return null;
            if (type == null)
                return str;
            if (type.IsArray)
            {
                Type elementType = type.GetElementType();
                string[] strs = str.Split(new char[] { ';' });
                Array array = Array.CreateInstance(elementType, strs.Length);
                for (int i = 0, c = strs.Length; i &lt; c; ++i)
                {
                    array.SetValue(ConvertSimpleType(strs[i], elementType), i);
                }
                return array;
            }
            return ConvertSimpleType(str, type);
        }

        private static object ConvertSimpleType(object value, Type destinationType)
        {
            object returnValue;
            if ((value == null) || destinationType.IsInstanceOfType(value))
            {
                return value;
            }
            string str = value as string;
            if ((str != null) &amp;&amp; (str.Length == 0))
            {
                return null;
            }
            TypeConverter converter = TypeDescriptor.GetConverter(destinationType);
            bool flag = converter.CanConvertFrom(value.GetType());
            if (!flag)
            {
                converter = TypeDescriptor.GetConverter(value.GetType());
            }
            if (!flag &amp;&amp; !converter.CanConvertTo(destinationType))
            {
                throw new InvalidOperationException("无法转换成类型：" + value.ToString() + "==&gt;" + destinationType);
            }
            try
            {
                returnValue = flag ? converter.ConvertFrom(null, null, value) : converter.ConvertTo(null, null, value, destinationType);
            }
            catch (Exception e)
            {
                throw new InvalidOperationException("类型转换出错：" + value.ToString() + "==&gt;" + destinationType, e);
            }
            return returnValue;
        }

    }
</code></pre> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10e6d40d367ad69daebd3bee3dc6ea25/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Mybatis jdbcType=DATE和jdbcType=TIMESTAMP的坑</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ca3f94ebdfe1dd6f049d3ca5ac9db846/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java 过滤器Url通配符处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>