<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>手写BundleAdjustment（尽量仅使用eigen库） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="手写BundleAdjustment（尽量仅使用eigen库）" />
<meta property="og:description" content="手写BundleAdjustment 使用手写BA解决了PnP问题，除了读取图片、显示图片用的opencv，其他基本上只使用了eigen、sophus。
代码放在了百度云上（github还在研究怎么用，以后可能会上）
链接：https://pan.baidu.com/s/1CBJMKXGeelBSuJUuk7E1mw
提取码：br5o
文章目录 手写BundleAdjustment 一、总览二、搭建各种数据结构1.存储一个关键点信息的KeyPoint类型2.存储匹配情况的Match类型 三、构建一些方法，即算法1、提取特征点的算法2、计算BREIEF描述子3、进行BFmatch4、其他的方法 四、手写BA结果 一、总览 由于c&#43;&#43;基本功及其不扎实，除了上课内容其他啥东西也没写过，因此本次实验的手写BA主要还是一个简单版的实现，在很多地方有了简化。复杂的算法逻辑等以后想加了再加，本次实验主要是搭建一个从读图、到提取特征点、到求得描述子、到匹配特征点、到求解相机位姿的一套流程框架，是对已学的视觉slam十四讲的前端内容做一个连贯的整理。
此次程序的总体框架按照高翔的十四讲上编写一个小型系统的框架来进行。如下图：
先解释下各文件夹里面装的东西。
app:主函数BA_PnP.cpp，及它的CmakeLists.txt.
bin:可执行文件.
build:编译中间文件.
cmake_modules: 啥也没有.
data:原始图片素材.
include:各种头文件，都是自己写的.
lib:不知道有啥用，应该是什么的中间文件存放地.
src:各种cpp文件，存放各种用于实现头文件的源文件.
test:啥也没有.
二、搭建各种数据结构 常言道，程序 = 数据类型 &#43; 算法 。之前对这句话没什么体会，这次编写下来，深感这句话是真理！此篇博客就先从数据结构开始讲起。
1.存储一个关键点信息的KeyPoint类型 存储关键点，在opencv中有cv::KeyPoint类型可以直接使用，本次实验用的是自己写的类型。
KeyPoint类主要需要存储关键点的坐标信息x_,y_.为了之后匹配关键点时方便些，给它加了id_参数。pyramid_金字塔层数没有用到。
类型的方法就随便搞了几个，主要是为了学习一下头文件和源文件的链接。
注意：在头文件和源文件链接时，需要在src/CMakeLists.txt之中加上源文件的名字，不然会链接不上。
KeyPoint.h：
#ifndef _KeyPoint_H_ #define _KeyPoint_H_ #include &#34;common_include.h&#34; class KeyPoint { public: EIGEN_MAKE_ALIGNED_OPERATOR_NEW; // typedef std::shared_ptr&lt;KeyPoint&gt; Ptr; int x_,y_; int id_; int num_;//周围一圈亮度差别大的点的个数，用来筛选，防止角点过于集中。 int pyramid_ = -1;//金字塔层数 KeyPoint(); KeyPoint(int x , int y , int id , int num ): x_(x) , y_(y) , id_(id) , num_(num){} KeyPoint(int x , int y , int id , int num , int pyramid): //有金字塔的构造 x_(x) , y_(y) , id_(id) , num_(num) , pyramid_(pyramid){} // KeyPoint(const cv::Mat &amp;img1 , double threshold = 10." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f2d88d21be18efe29d901354f9e98b5a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-03T16:07:37+08:00" />
<meta property="article:modified_time" content="2021-01-03T16:07:37+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">手写BundleAdjustment（尽量仅使用eigen库）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="BundleAdjustment_0"></a>手写BundleAdjustment</h3> 
<p><font color="#999AAA"> 使用手写BA解决了PnP问题，除了读取图片、显示图片用的opencv，其他基本上只使用了eigen、sophus。</font></p> 
<p>代码放在了百度云上（github还在研究怎么用，以后可能会上）<br> 链接：https://pan.baidu.com/s/1CBJMKXGeelBSuJUuk7E1mw<br> 提取码：br5o</p> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#BundleAdjustment_0" rel="nofollow">手写BundleAdjustment</a></li></ul> 
  </li><li><a href="#_12" rel="nofollow">一、总览</a></li><li><a href="#_27" rel="nofollow">二、搭建各种数据结构</a></li><li><ul><li><a href="#1KeyPoint_29" rel="nofollow">1.存储一个关键点信息的KeyPoint类型</a></li><li><a href="#2Match_102" rel="nofollow">2.存储匹配情况的Match类型</a></li></ul> 
  </li><li><a href="#_137" rel="nofollow">三、构建一些方法，即算法</a></li><li><ul><li><a href="#1_138" rel="nofollow">1、提取特征点的算法</a></li><li><a href="#2BREIEF_214" rel="nofollow">2、计算BREIEF描述子</a></li><li><a href="#3BFmatch_271" rel="nofollow">3、进行BFmatch</a></li><li><a href="#4_319" rel="nofollow">4、其他的方法</a></li></ul> 
  </li><li><a href="#BA_323" rel="nofollow">四、手写BA结果</a></li></ul> 
</div> 
<p></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_12"></a>一、总览</h2> 
<p>由于c++基本功及其不扎实，除了上课内容其他啥东西也没写过，因此本次实验的手写BA主要还是一个简单版的实现，在很多地方有了简化。复杂的算法逻辑等以后想加了再加，本次实验主要是搭建一个从读图、到提取特征点、到求得描述子、到匹配特征点、到求解相机位姿的一套流程框架，是对已学的视觉slam十四讲的前端内容做一个连贯的整理。<br> 此次程序的总体框架按照高翔的十四讲上编写一个小型系统的框架来进行。如下图：<br> <img src="https://images2.imgbox.com/37/bb/OLBxuaRd_o.png" alt="总体框架"><br> 先解释下各文件夹里面装的东西。<br> app:主函数BA_PnP.cpp，及它的CmakeLists.txt.<br> bin:可执行文件.<br> build:编译中间文件.<br> cmake_modules: 啥也没有.<br> data:原始图片素材.<br> include:各种头文件，都是自己写的.<br> lib:不知道有啥用，应该是什么的中间文件存放地.<br> src:各种cpp文件，存放各种用于实现头文件的源文件.<br> test:啥也没有.</p> 
<h2><a id="_27"></a>二、搭建各种数据结构</h2> 
<p>常言道，程序 = 数据类型 + 算法 。之前对这句话没什么体会，这次编写下来，深感这句话是真理！此篇博客就先从数据结构开始讲起。</p> 
<h3><a id="1KeyPoint_29"></a>1.存储一个关键点信息的KeyPoint类型</h3> 
<p>存储关键点，在opencv中有cv::KeyPoint类型可以直接使用，本次实验用的是自己写的类型。</p> 
<p>KeyPoint类主要需要存储关键点的坐标信息x_,y_.为了之后匹配关键点时方便些，给它加了id_参数。pyramid_金字塔层数没有用到。</p> 
<p>类型的方法就随便搞了几个，主要是为了学习一下头文件和源文件的链接。<br> 注意：在头文件和源文件链接时，需要在src/CMakeLists.txt之中加上源文件的名字，不然会链接不上。</p> 
<p><font color="#999AAA"> KeyPoint.h：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _KeyPoint_H_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _KeyPoint_H_</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"common_include.h"</span></span>

class KeyPoint <span class="token punctuation">{<!-- --></span>
    public<span class="token punctuation">:</span>
    EIGEN_MAKE_ALIGNED_OPERATOR_NEW<span class="token punctuation">;</span>
    <span class="token comment">// typedef std::shared_ptr&lt;KeyPoint&gt; Ptr;</span>

    <span class="token keyword">int</span> x_<span class="token punctuation">,</span>y_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> num_<span class="token punctuation">;</span><span class="token comment">//周围一圈亮度差别大的点的个数，用来筛选，防止角点过于集中。</span>
    <span class="token keyword">int</span> pyramid_ <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//金字塔层数</span>

    <span class="token function">KeyPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">KeyPoint</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token punctuation">,</span> <span class="token keyword">int</span> y <span class="token punctuation">,</span> <span class="token keyword">int</span> id <span class="token punctuation">,</span> <span class="token keyword">int</span> num <span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">x_</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">y_</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">id_</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">num_</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token function">KeyPoint</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token punctuation">,</span> <span class="token keyword">int</span> y <span class="token punctuation">,</span> <span class="token keyword">int</span> id <span class="token punctuation">,</span> <span class="token keyword">int</span> num <span class="token punctuation">,</span> <span class="token keyword">int</span> pyramid<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">//有金字塔的构造</span>
    <span class="token function">x_</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">y_</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">id_</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">num_</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">pyramid_</span><span class="token punctuation">(</span>pyramid<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token comment">// KeyPoint(const cv::Mat &amp;img1 , double threshold = 10.0 );</span>

    <span class="token keyword">long</span> <span class="token keyword">int</span> <span class="token function">getID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> id_<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    Vec2 <span class="token function">getPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<p><font color="#999AAA"> KeyPoint.cpp：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"common_include.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"KeyPoint.h"</span></span>

<span class="token comment">// KeyPoint::KeyPoint(const cv::Mat &amp;img1 , double threshold){<!-- --></span>
<span class="token comment">// }</span>

Vec2 KeyPoint<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">getPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Vec2 point<span class="token punctuation">;</span>
    point <span class="token operator">&lt;&lt;</span> x_ <span class="token punctuation">,</span> y_ <span class="token punctuation">;</span>
    <span class="token keyword">return</span> point<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><font color="#999AAA">src/CMakeLists.txt：</font></p> 
<pre><code class="prism language-c"><span class="token function">add_library</span><span class="token punctuation">(</span>myslam SHARED    #给类的头文件和源文件链接
    KeyPoint<span class="token punctuation">.</span>cpp
    FAST_detect<span class="token punctuation">.</span>cpp
    GetBrief<span class="token punctuation">.</span>cpp
    BFMatch<span class="token punctuation">.</span>cpp
    BundleAdjustment<span class="token punctuation">.</span>cpp
    pixel2cam<span class="token punctuation">.</span>cpp<span class="token punctuation">)</span>

<span class="token function">target_link_libraries</span><span class="token punctuation">(</span>myslam
    $<span class="token punctuation">{<!-- --></span>THIRD_PARTY_LIBS<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre> 
<h3><a id="2Match_102"></a>2.存储匹配情况的Match类型</h3> 
<p>在opencv中有cv::DMatch类型。主要功能是储存两个匹配好的关键点的信息，分别有他们的id。id1_,id2_。和它们之间的BF距离，distance_。<br> <font color="#999AAA">Match.h：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">ifndef</span> _MATCH_H_</span>
<span class="token macro property">#<span class="token directive keyword">define</span> _MATCH_H_</span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"common_include.h"</span></span>

class Match<span class="token punctuation">{<!-- --></span>
public<span class="token punctuation">:</span>
    <span class="token keyword">int</span> id1_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> id2_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> distance_<span class="token punctuation">;</span>

    <span class="token function">Match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">Match</span><span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token punctuation">,</span> <span class="token keyword">int</span> y <span class="token punctuation">,</span> <span class="token keyword">int</span> distance<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token function">id1_</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">id2_</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token function">distance_</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token operator">~</span><span class="token function">Match</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    Vec2 <span class="token function">getPoint</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            Vec2 point<span class="token punctuation">;</span>
        point <span class="token operator">&lt;&lt;</span> id1_ <span class="token punctuation">,</span> id2_ <span class="token punctuation">;</span>
        <span class="token keyword">return</span> point<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<hr color="#000000" size='1"'> 
<h2><a id="_137"></a>三、构建一些方法，即算法</h2> 
<h3><a id="1_138"></a>1、提取特征点的算法</h3> 
<p>算法逻辑：<br> 首先，排除掉原图像周围的一圈点，因为之后BFMatch时最多会用到特征点周围13个像素的位置的点比较，此处排除掉周围的点时干脆就去掉了20个点。</p> 
<p>而后，遍历每个点，比较此像素点和周围16个点的像素大小。这16个点都储存在mask中，详见slam十四讲第二版的P156.</p> 
<p>最后，如果和周围16个点中有14个点及以上是同时大于此像素点的，或者同时小于此像素点的，则判定这个点是一个特征是。（原版的FAST角点检测要求是连续的12个点大于或小于，当时为了早点把框架搭出来，就取巧了一些。）<br> 其中的参数14可以调整为13、15、16等，不同的参数选取出来的特征点的数量不同。</p> 
<p><font color="#999AAA">FAST_detect.cpp：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Eigen/Core"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"common_include.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"KeyPoint.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"FAST_detect.h"</span></span>
VecKeyPoint <span class="token function">FAST_detect</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Mat <span class="token operator">&amp;</span>img <span class="token punctuation">,</span> <span class="token keyword">double</span> percent<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    VecKeyPoint keypoints_<span class="token punctuation">;</span>
    <span class="token keyword">int</span> keyPoint_num <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// KeyPoint keypoint_(1.2,2.0,123,5);</span>
    <span class="token keyword">int</span> mask<span class="token punctuation">[</span><span class="token number">16</span><span class="token operator">*</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
        <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>
        <span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span>
        <span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> Vecfeature<span class="token punctuation">;</span>
    <span class="token keyword">int</span> bigger<span class="token punctuation">,</span>smaller<span class="token punctuation">,</span>equal<span class="token punctuation">;</span>
    
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> img<span class="token punctuation">.</span>rows<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> img<span class="token punctuation">.</span>cols<span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//图像　排除边缘五像素的点</span>
            smaller <span class="token operator">=</span> bigger <span class="token operator">=</span> equal <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> k<span class="token operator">&lt;</span><span class="token number">16</span><span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//周围１６个点，有15个大于或小于ｐｅｒｃｅｎｔ*像素值，则为角点</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token operator">+</span>mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token operator">+</span>mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&gt;=</span> percent <span class="token operator">*</span> img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    bigger <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-</span> img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token operator">+</span>mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token operator">+</span>mask<span class="token punctuation">[</span><span class="token number">2</span><span class="token operator">*</span>k<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token operator">-</span>percent <span class="token operator">*</span> img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                    smaller <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> 
                <span class="token keyword">else</span> equal <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>bigger <span class="token operator">&gt;=</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span> <span class="token comment">//邻域16个点中同时有１５个大于或小于目标点则认为是特征点（取巧的算法）//14 and 25;15 and 30</span>
                keyPoint_num <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                KeyPoint <span class="token function">keypoint_</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">,</span>keyPoint_num<span class="token punctuation">,</span>bigger<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// cout &lt;&lt; keypoint_.getPoint() &lt;&lt; endl;</span>
                keypoints_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>keypoint_<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>smaller <span class="token operator">&gt;=</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                keyPoint_num <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
                KeyPoint <span class="token function">keypoint_</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span>i<span class="token punctuation">,</span>keyPoint_num<span class="token punctuation">,</span>smaller<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// cout &lt;&lt; keypoint_.getPoint() &lt;&lt; endl;</span>
                keypoints_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>keypoint_<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
            
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"FAST Detect is over"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token keyword">return</span> keypoints_<span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="2BREIEF_214"></a>2、计算BREIEF描述子</h3> 
<p>BRIEF描述子算法见书本P157.<br> 大致就是比较了单个特征点周围256对点，将其大小关系储存在了vec1中。<br> 对所有的特征多求了描述子之后，将所有的特征点的描述子都储存在了Vecvec_之中。<br> vector&lt;vector&lt; int&gt; &gt; 是储存向量的向量。</p> 
<p><font color="#999AAA">GetBrief.cpp：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Eigen/Core"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"common_include.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"KeyPoint.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"GetBrief.h"</span></span>

vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">&gt;</span> <span class="token function">GetBrief</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token punctuation">:</span><span class="token punctuation">:</span>Mat <span class="token operator">&amp;</span>img <span class="token punctuation">,</span> VecKeyPoint <span class="token operator">&amp;</span>keypoints_<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
<span class="token keyword">int</span> mask_brief<span class="token punctuation">[</span><span class="token number">256</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
<span class="token comment">//**************此处省略256*4个参数，详见源代码***********</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

    vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> <span class="token operator">&gt;</span> Vecvec_<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>uint l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> l <span class="token operator">&lt;</span> keypoints_<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> l<span class="token operator">++</span> <span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> x <span class="token operator">=</span> keypoints_<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span>x_<span class="token punctuation">;</span>
        <span class="token keyword">int</span> y <span class="token operator">=</span> keypoints_<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">.</span>y_<span class="token punctuation">;</span>
        vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> vec1<span class="token punctuation">;</span>
        <span class="token comment">// cout &lt;&lt; l+1 &lt;&lt; "  x,y is " &lt;&lt; x &lt;&lt; "," &lt;&lt; y &lt;&lt; endl;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">256</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

            <span class="token keyword">int</span> row1 <span class="token operator">=</span> y<span class="token operator">+</span>mask_brief<span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> col1 <span class="token operator">=</span> x<span class="token operator">+</span>mask_brief<span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token punctuation">]</span> <span class="token punctuation">;</span> 

            <span class="token keyword">int</span> row2 <span class="token operator">=</span> y <span class="token operator">+</span> mask_brief<span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> col2 <span class="token operator">=</span> x <span class="token operator">+</span> mask_brief<span class="token punctuation">[</span><span class="token number">4</span><span class="token operator">*</span>i<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> p1 <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span> row1 <span class="token punctuation">)</span><span class="token punctuation">[</span> col1 <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> p2 <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>ptr<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span><span class="token punctuation">(</span> row2 <span class="token punctuation">)</span><span class="token punctuation">[</span> col2 <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>p1 <span class="token operator">&gt;</span> p2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                vec1<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>p1 <span class="token operator">&lt;=</span> p2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                vec1<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// for(unsigned int i = 0; i &lt; vec1.size(); ++i) {<!-- --></span>
        <span class="token comment">//   cout &lt;&lt; vec1[i];</span>
        <span class="token comment">// }</span>
        <span class="token comment">// cout &lt;&lt; endl &lt;&lt; "size is :" &lt;&lt; vec1.size() &lt;&lt; endl;</span>

        Vecvec_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>vec1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        vec1<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"GetBrief success"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token keyword">return</span> Vecvec_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="3BFmatch_271"></a>3、进行BFmatch</h3> 
<p>BFmatch的原理就是对遍历两张图片所有的特征点，计算所有的汉明距离，把距离最小的两个点视为匹配点。<br> 可以设置一个 阈值来筛选掉一些误匹配的点。此次把阈值设为了25.</p> 
<p><font color="#999AAA">BFMatch.cpp：</font></p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"common_include.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"BFMatch.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"Match.h"</span></span>

vector<span class="token operator">&lt;</span>Match<span class="token operator">&gt;</span> <span class="token function">BFMatch</span><span class="token punctuation">(</span>vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> Vecvec1 <span class="token punctuation">,</span> vector<span class="token operator">&lt;</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;&gt;</span> Vecvec2<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    vector<span class="token operator">&lt;</span>Match<span class="token operator">&gt;</span> matches_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> d_max <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span><span class="token comment">//25 is ok</span>
    <span class="token keyword">const</span> <span class="token keyword">int</span> d_min <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i1<span class="token operator">&lt;</span>Vecvec1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i1<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Vecvec1<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token comment">// matches[i1] = Match(0,0,0);</span>
        Match m<span class="token punctuation">{<!-- --></span>i1<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> dis <span class="token operator">=</span> <span class="token number">256</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> i2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i2 <span class="token operator">&lt;</span> Vecvec2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i2<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>

            <span class="token keyword">int</span> distance <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token comment">// int dis = 256;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> Vecvec1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">//计算汉明距离</span>
                <span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
                k <span class="token operator">=</span> Vecvec1<span class="token punctuation">[</span>i1<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> Vecvec2<span class="token punctuation">[</span>i2<span class="token punctuation">]</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                distance <span class="token operator">+</span><span class="token operator">=</span> k<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>distance <span class="token operator">&lt;</span> d_max <span class="token operator">&amp;&amp;</span> distance <span class="token operator">&lt;</span> dis <span class="token operator">&amp;&amp;</span> distance <span class="token operator">&gt;=</span> d_min<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//目前，每一次distance小于了之前的distance都输出了。应该是要对应点的最小值的点输出才行</span>
                dis <span class="token operator">=</span> distance<span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>id1_ <span class="token operator">=</span> i1<span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>id2_ <span class="token operator">=</span> i2<span class="token punctuation">;</span>
                m<span class="token punctuation">.</span>distance_ <span class="token operator">=</span> distance<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>m<span class="token punctuation">.</span>id2_ <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        matches_<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// cout &lt;&lt; "matches id1,id2,distance is: " &lt;&lt; m.id1_&lt;&lt;" " &lt;&lt; m.id2_ &lt;&lt; " " &lt;&lt; m.distance_ &lt;&lt; endl;</span>
        
    <span class="token punctuation">}</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"BFMatch is over"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
    <span class="token comment">// cout &lt;&lt; matches_.size() &lt;&lt; endl;</span>
    <span class="token keyword">return</span> matches_<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4_319"></a>4、其他的方法</h3> 
<p>其他的方法实现比较短，可以看源码理解。<br> BundleAdjustment.cpp部分和高博的源码相差无几，具体理解可以参照我另一篇博客：<br> <a href="https://blog.csdn.net/jiny_yang/article/details/109685192">视觉slam十四讲第ch7-PNP-3d2d手写位姿估计代码详解</a>.</p> 
<h2><a id="BA_323"></a>四、手写BA结果</h2> 
<p>展示一下此次手写BA的成果吧，因为有好多地方进行了简化处理，最终结果和高博的结果肯定还是会有一些误差。<br> 这是手写BA的结果：<br> <img src="https://images2.imgbox.com/2e/73/DRkLJEZ9_o.png" alt="结果展示"><br> 这是高博的结果：<br> <img src="https://images2.imgbox.com/d7/f6/E4clfLHX_o.png" alt="在这里插入图片描述"><br> 误差还算可以接受。</p> 
<p>下图是成果展示图片，可以看到匹配基本上误差不大。<img src="https://images2.imgbox.com/a5/8f/pGV0bWig_o.png" alt="在这里插入图片描述"><br> 有问题请在评论区留言哦~</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9842aee1e1e8e25ddd84cb2e07a12fd4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">HTML学习总篇——小白篇</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b18b28646650fc01046c6b7ed4c7799e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">HTML复习和查阅文档——小白篇(10)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>