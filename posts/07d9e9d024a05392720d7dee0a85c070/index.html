<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DockerFile构建镜像并发布 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DockerFile构建镜像并发布" />
<meta property="og:description" content="文章目录 为什么需要DockerFile什么是DockerFileDockerFile构建过程DockerFile指令DockerFile定义规则实战测试自定义扩展版centOS自定义镜像 Tomcat发布镜像到DockerHub发布镜像到阿里云镜像服务 为什么需要DockerFile 大家想想，Nginx，tomcat，mysql 这些镜像都是哪里来的？官方能写，我们不能写吗？
我们要研究自己如何做一个镜像，而且我们写的微服务项目以及springboot打包上云部署，Docker就是最方便的。
微服务打包成镜像，任何装了Docker的地方，都可以下载使用，极其的方便。
流程：开发应用=&gt;DockerFile=&gt;打包为镜像=&gt;上传到仓库（私有仓库，公有仓库）=&gt; 下载镜像 =&gt; 启动
什么是DockerFile dockerfile是用来构建Docker镜像的构建文件，是由一系列命令和参数构成的脚本。
构建步骤：
编写DockerFile文件docker build 构建镜像docker run 我们先找一个官方镜像来看它的DockerFile 有一个初步印象
以centos为例 地址：https://hub.docker.com/_/centos
DockerFile构建过程 Docker从基础镜像运行一个容器执行一条指令并对容器做出修改执行类似 docker commit 的操作提交一个新的镜像层Docker再基于刚提交的镜像运行一个新容器执行dockerfile中的下一条指令直到所有指令都执行完成！ 说明
从应用软件的角度来看，DockerFile，Docker镜像与Docker容器分别代表软件的三个不同阶段。
DockerFile 是软件的原材料 （代码）Docker 镜像则是软件的交付品 （.apk）Docker 容器则是软件的运行状态 （客户下载安装执行） DockerFile 面向开发，Docker镜像成为交付标准，Docker容器则涉及部署与运维，三者缺一不可！
DockerFile：需要定义一个DockerFile，DockerFile定义了进程需要的一切东西。DockerFile涉及的内容
包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进
程和内核进程（当引用进行需要和系统服务和内核进程打交道，这时需要考虑如何设计 namespace的权
限控制）等等。Docker镜像：在DockerFile 定义了一个文件之后，Docker build 时会产生一个Docker镜像，当运行Docker 镜像时，会真正开始提供服务Docker容器：容器是直接提供服务的 DockerFile指令 FROM # 基础镜像，当前新镜像是基于哪个镜像的 MAINTAINER # 镜像维护者的姓名混合邮箱地址 RUN # 容器构建时需要运行的命令 EXPOSE # 当前容器对外保留出的端口 WORKDIR # 指定在创建容器后，终端默认登录的进来工作目录，一个落脚点 ENV # 用来在构建镜像过程中设置环境变量 ADD # 将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar压缩包 COPY # 类似ADD，拷贝文件和目录到镜像中！ VOLUME # 容器数据卷，用于数据保存和持久化工作 CMD # 指定一个容器启动时要运行的命令，dockerFile中可以有多个CMD指令，但只有最 后一个生效！ ENTRYPOINT # 指定一个容器启动时要运行的命令！和CMD一样 ONBUILD # 当构建一个被继承的DockerFile时运行命令，父镜像在被子镜像继承后，父镜像的 ONBUILD被触发 DockerFile定义规则 每条保留字指令都必须为大写字母且后面要跟随至少一个参数指令按照从上到下，顺序执行#表示注释每条指令都会创建一个新的镜像层，并对镜像进行提交流程 实战测试自定义扩展版centOS Docker Hub 中99% 的镜像都是通过在base镜像（Scratch）中安装和配置需要的软件构建出来的" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/07d9e9d024a05392720d7dee0a85c070/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-14T14:27:51+08:00" />
<meta property="article:modified_time" content="2023-01-14T14:27:51+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DockerFile构建镜像并发布</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#DockerFile_1" rel="nofollow">为什么需要DockerFile</a></li><li><a href="#DockerFile_9" rel="nofollow">什么是DockerFile</a></li><li><a href="#DockerFile_29" rel="nofollow">DockerFile构建过程</a></li><li><a href="#DockerFile_57" rel="nofollow">DockerFile指令</a></li><li><a href="#DockerFile_76" rel="nofollow">DockerFile定义规则</a></li><li><a href="#centOS_88" rel="nofollow">实战测试自定义扩展版centOS</a></li><li><a href="#_Tomcat_274" rel="nofollow">自定义镜像 Tomcat</a></li><li><a href="#DockerHub_418" rel="nofollow">发布镜像到DockerHub</a></li><li><a href="#_479" rel="nofollow">发布镜像到阿里云镜像服务</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="DockerFile_1"></a>为什么需要DockerFile</h3> 
<p>大家想想，Nginx，tomcat，mysql 这些镜像都是哪里来的？官方能写，我们不能写吗？<br> 我们要研究自己如何做一个镜像，而且我们写的微服务项目以及springboot打包上云部署，Docker就是最方便的。<br> 微服务打包成镜像，任何装了Docker的地方，都可以下载使用，极其的方便。<br> 流程：开发应用=&gt;DockerFile=&gt;打包为镜像=&gt;上传到仓库（私有仓库，公有仓库）=&gt; 下载镜像 =&gt; 启动</p> 
<h3><a id="DockerFile_9"></a>什么是DockerFile</h3> 
<p>dockerfile是用来构建Docker镜像的构建文件，是由一系列命令和参数构成的脚本。<br> 构建步骤：</p> 
<ul><li>编写DockerFile文件</li><li>docker build 构建镜像</li><li>docker run</li></ul> 
<p>我们先找一个官方镜像来看它的DockerFile 有一个初步印象<br> 以centos为例 地址：<a href="https://hub.docker.com/_/centos" rel="nofollow">https://hub.docker.com/_/centos</a></p> 
<p><img src="https://images2.imgbox.com/8f/ac/Bs5D6o8q_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/83/4c/LRHtMEyA_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="DockerFile_29"></a>DockerFile构建过程</h3> 
<ul><li>Docker从基础镜像运行一个容器</li><li>执行一条指令并对容器做出修改</li><li>执行类似 docker commit 的操作提交一个新的镜像层</li><li>Docker再基于刚提交的镜像运行一个新容器</li><li>执行dockerfile中的下一条指令直到所有指令都执行完成！</li></ul> 
<p><strong>说明</strong></p> 
<p>从应用软件的角度来看，DockerFile，Docker镜像与Docker容器分别代表软件的三个不同阶段。</p> 
<ul><li>DockerFile 是软件的原材料 （代码）</li><li>Docker 镜像则是软件的交付品 （.apk）</li><li>Docker 容器则是软件的运行状态 （客户下载安装执行）</li></ul> 
<p>DockerFile 面向开发，Docker镜像成为交付标准，Docker容器则涉及部署与运维，三者缺一不可！</p> 
<p><img src="https://images2.imgbox.com/49/a4/iN2OhZoS_o.png" alt="在这里插入图片描述"></p> 
<ul><li>DockerFile：需要定义一个DockerFile，DockerFile定义了进程需要的一切东西。DockerFile涉及的内容<br> 包括执行代码或者是文件、环境变量、依赖包、运行时环境、动态链接库、操作系统的发行版、服务进<br> 程和内核进程（当引用进行需要和系统服务和内核进程打交道，这时需要考虑如何设计 namespace的权<br> 限控制）等等。</li><li>Docker镜像：在DockerFile 定义了一个文件之后，Docker build 时会产生一个Docker镜像，当运行Docker 镜像时，会真正开始提供服务</li><li>Docker容器：容器是直接提供服务的</li></ul> 
<h3><a id="DockerFile_57"></a>DockerFile指令</h3> 
<pre><code class="prism language-shell">FROM     <span class="token comment"># 基础镜像，当前新镜像是基于哪个镜像的</span>
MAINTAINER  <span class="token comment"># 镜像维护者的姓名混合邮箱地址</span>
RUN      <span class="token comment"># 容器构建时需要运行的命令</span>
EXPOSE    <span class="token comment"># 当前容器对外保留出的端口</span>
WORKDIR    <span class="token comment"># 指定在创建容器后，终端默认登录的进来工作目录，一个落脚点</span>
ENV      <span class="token comment"># 用来在构建镜像过程中设置环境变量</span>
ADD      <span class="token comment"># 将宿主机目录下的文件拷贝进镜像且ADD命令会自动处理URL和解压tar压缩包</span>
COPY     <span class="token comment"># 类似ADD，拷贝文件和目录到镜像中！</span>
VOLUME    <span class="token comment"># 容器数据卷，用于数据保存和持久化工作</span>
CMD      <span class="token comment"># 指定一个容器启动时要运行的命令，dockerFile中可以有多个CMD指令，但只有最</span>
后一个生效！
ENTRYPOINT  <span class="token comment"># 指定一个容器启动时要运行的命令！和CMD一样</span>
ONBUILD    <span class="token comment"># 当构建一个被继承的DockerFile时运行命令，父镜像在被子镜像继承后，父镜像的</span>
ONBUILD被触发
</code></pre> 
<p><img src="https://images2.imgbox.com/52/03/4ZCPP6ZU_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="DockerFile_76"></a>DockerFile定义规则</h3> 
<ul><li>每条保留字指令都必须为大写字母且后面要跟随至少一个参数</li><li>指令按照从上到下，顺序执行</li><li>#表示注释</li><li>每条指令都会创建一个新的镜像层，并对镜像进行提交流程</li></ul> 
<h3><a id="centOS_88"></a>实战测试自定义扩展版centOS</h3> 
<p>Docker Hub 中99% 的镜像都是通过在base镜像（Scratch）中安装和配置需要的软件构建出来的</p> 
<p><strong>自定义一个 centos</strong></p> 
<p>查看下官方默认的CentOS的情况：<br> <img src="https://images2.imgbox.com/b8/63/cVQAgWpY_o.png" alt="在这里插入图片描述"><br> 目的：使我们自己的镜像具备如下：登陆后的默认路径、vim编辑器、查看网络配置ifconfig支持</p> 
<blockquote> 
 <p>准备编写DockerFlie文件</p> 
</blockquote> 
<pre><code class="prism language-shell"><span class="token function">mkdir</span> dockerfile-test
<span class="token function">ls</span>
ceshi dockerfile-test docker-test-volume f1
<span class="token function">vim</span> mydockerfile-centos <span class="token comment"># 编辑文件</span>
</code></pre> 
<p>编写DockerFlie文件</p> 
<pre><code class="prism language-shell">FROM centos
MAINTAINER kuangshen<span class="token operator">&lt;</span><span class="token number">24736743</span>@qq.com<span class="token operator">&gt;</span>
ENV MYPATH /usr/local
WORKDIR <span class="token variable">$MYPATH</span>
RUN yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">vim</span>
RUN yum <span class="token parameter variable">-y</span> installEXPOSE <span class="token number">80</span>
CMD <span class="token builtin class-name">echo</span> <span class="token variable">$MYPATH</span>
CMD <span class="token builtin class-name">echo</span> <span class="token string">"----------end--------"</span>
CMD /bin/bash net-tools
</code></pre> 
<p><strong>构建</strong></p> 
<p>docker build -f dockerfile地址 -t 新镜像名字:TAG . 会看到 docker build 命令最后有一个 . . 表示当前目录</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> build <span class="token parameter variable">-f</span> mydockerfile-centos <span class="token parameter variable">-t</span> mycentos:0.1 <span class="token builtin class-name">.</span>
</code></pre> 
<p><strong>运行</strong></p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run <span class="token parameter variable">-it</span> 新镜像名字:TAG
</code></pre> 
<p><img src="https://images2.imgbox.com/71/20/fjJmd9ub_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到，我们自己的新镜像已经支持 vim/ifconfig的命令，扩展OK！</p> 
<p><strong>列出镜像的变更历史</strong></p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> <span class="token function">history</span> 镜像名
</code></pre> 
<p><img src="https://images2.imgbox.com/e3/08/CdYU8Mbb_o.png" alt="在这里插入图片描述"></p> 
<p><strong>CMD 和 ENTRYPOINT 的区别</strong></p> 
<p>两个命令都是指定一个容器启动时要运行的命令</p> 
<ul><li>CMD：Dockerfile 中可以有多个CMD 指令，但只有最后一个生效，CMD 会被 docker run 之后的参数替换！</li><li>ENTRYPOINT： Docker run 之后的参数会被当做参数传递给 ENTRYPOINT，之后形成新的命令组合！</li></ul> 
<p>CMD命令构建Dockerfile</p> 
<pre><code class="prism language-shell"><span class="token function">vim</span> dockerfile-cmd-test
</code></pre> 
<p>DockerFile</p> 
<pre><code class="prism language-shell">FROM centos
CMD <span class="token punctuation">[</span> <span class="token string">"ls"</span>, <span class="token string">"-a"</span> <span class="token punctuation">]</span>
</code></pre> 
<p>构建镜像</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> build <span class="token parameter variable">-f</span> dockerfile-cmd-test <span class="token parameter variable">-t</span> cmdtest <span class="token builtin class-name">.</span>
</code></pre> 
<pre><code class="prism language-shell">Sending build context to Docker daemon  <span class="token number">22</span>.02kB
Step <span class="token number">1</span>/2 <span class="token builtin class-name">:</span> FROM centos
---<span class="token operator">&gt;</span> 470671670cac
Step <span class="token number">2</span>/2 <span class="token builtin class-name">:</span> CMD <span class="token punctuation">[</span> <span class="token string">"ls"</span>, <span class="token string">"-a"</span> <span class="token punctuation">]</span>
---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> a3072987de38
Removing intermediate container a3072987de38
---<span class="token operator">&gt;</span> 554bc6952657
Successfully built 554bc6952657
Successfully tagged cmdtest:latest
</code></pre> 
<p>运行</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run 554bc6952657
</code></pre> 
<pre><code class="prism language-shell">.dockerenv
bin
dev
etc
home
lib
lib64
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>如果我们希望用 -l 列表展示信息，我们就需要加上 -l参数</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run cmdtest <span class="token parameter variable">-l</span>
docker: Error response from daemon: OCI runtime create failed:
container_linux.go:349: starting container process caused <span class="token string">"exec: <span class="token entity" title='\"'>\"</span>-l<span class="token entity" title='\"'>\"</span>:
executable file not found in <span class="token environment constant">$PATH</span>"</span><span class="token builtin class-name">:</span> unknown.

</code></pre> 
<p>问题：我们可以看到可执行文件找不到的报错，executable file not found。<br> 之前我们说过，跟在镜像名后面的是 command，运行时会替换 CMD 的默认值。<br> 因此这里的 -l 替换了原来的 CMD，而不是添加在原来的 ls -a 后面。而 -l 根本不是命令，所以自然找不到。</p> 
<p>那么如果我们希望加入 -l 这参数，我们就必须重新完整的输入这个命令：</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run cmdtest <span class="token function">ls</span> <span class="token parameter variable">-al</span>
</code></pre> 
<p>ENTRYPOINT命令构建Dockerfile</p> 
<pre><code class="prism language-shell"> <span class="token function">vim</span> dockerfile-entrypoint-test
</code></pre> 
<pre><code class="prism language-shell">FROM centos
ENTRYPOINT <span class="token punctuation">[</span> <span class="token string">"ls"</span>, <span class="token string">"-a"</span> <span class="token punctuation">]</span>
<span class="token comment"># 2、build 镜像</span>
<span class="token punctuation">[</span>root@kuangshen home<span class="token punctuation">]</span><span class="token comment"># docker build -f dockerfile-entrypoint-test -t</span>
entrypointtest <span class="token builtin class-name">.</span>
Sending build context to Docker daemon  <span class="token number">23</span>.04kB
Step <span class="token number">1</span>/2 <span class="token builtin class-name">:</span> FROM centos
---<span class="token operator">&gt;</span> 470671670cac
Step <span class="token number">2</span>/2 <span class="token builtin class-name">:</span> ENTRYPOINT <span class="token punctuation">[</span> <span class="token string">"ls"</span>, <span class="token string">"-a"</span> <span class="token punctuation">]</span>
---<span class="token operator">&gt;</span> Running <span class="token keyword">in</span> bac4ae055630
Removing intermediate container bac4ae055630
---<span class="token operator">&gt;</span> ae07199f9144
Successfully built ae07199f9144
Successfully tagged entrypointtest:latest
</code></pre> 
<p>执行</p> 
<pre><code class="prism language-java"> docker run ae07199f9144
</code></pre> 
<pre><code class="prism language-shell">.dockerenv
bin
dev
etc
home
lib
lib64
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<p>测试-l参数，发现可以直接使用，这里就是一种追加，我们可以明显的知道 CMD 和ENTRYPOINT 的区别了</p> 
<pre><code class="prism language-shell"> <span class="token function">docker</span> run entrypointtest <span class="token parameter variable">-l</span>
</code></pre> 
<pre><code class="prism language-shell">total <span class="token number">56</span>
drwxr-xr-x  <span class="token number">1</span> root root <span class="token number">4096</span> May <span class="token number">12</span> 04:21 <span class="token builtin class-name">.</span>
drwxr-xr-x  <span class="token number">1</span>-rwxr-xr-x  <span class="token number">1</span> root root   <span class="token number">0</span> May <span class="token number">12</span> 04:21 .dockerenv
lrwxrwxrwx  <span class="token number">1</span> root root   <span class="token number">7</span> May <span class="token number">11</span>  <span class="token number">2019</span> bin -<span class="token operator">&gt;</span> usr/bin
drwxr-xr-x  <span class="token number">5</span> root root  <span class="token number">340</span> May <span class="token number">12</span> 04:21 dev
drwxr-xr-x  <span class="token number">1</span> root root <span class="token number">4096</span> May <span class="token number">12</span> 04:21 etc
drwxr-xr-x  <span class="token number">2</span> root root <span class="token number">4096</span> May <span class="token number">11</span>  <span class="token number">2019</span> home
<span class="token punctuation">..</span><span class="token punctuation">..</span>. root root <span class="token number">4096</span> May <span class="token number">12</span> 04:21 <span class="token punctuation">..</span>
</code></pre> 
<h3><a id="_Tomcat_274"></a>自定义镜像 Tomcat</h3> 
<ul><li>mkdir -p kuangshen/build/tomcat</li><li>在上述目录下 touch read.txt</li><li>将 JDK 和 tomcat 安装的压缩包拷贝进上一步目录</li><li>在 /kuangshen/build/tomcat 目录下新建一个Dockerfile文件</li></ul> 
<pre><code class="prism language-shell"><span class="token comment"># vim Dockerfile</span>
FROM centos
MAINTAINER kuangshen<span class="token operator">&lt;</span><span class="token number">24736743</span>@qq.com<span class="token operator">&gt;</span>
<span class="token comment">#把宿主机当前上下文的read.txt拷贝到容器/usr/local/路径下</span>
COPY read.txt /usr/local/cincontainer.txt
<span class="token comment">#把java与tomcat添加到容器中</span>
ADD jdk-8u11-linux-x64.tar.gz /usr/local/
ADD apache-tomcat-9.0.22.tar.gz /usr/local/
<span class="token comment">#安装vim编辑器</span>
RUN yum <span class="token parameter variable">-y</span> <span class="token function">install</span> <span class="token function">vim</span>
<span class="token comment">#设置工作访问时候的WORKDIR路径，登录落脚点</span>
ENV MYPATH /usr/local
WORKDIR <span class="token variable">$MYPATH</span>
<span class="token comment">#配置java与tomcat环境变量</span>
ENV JAVA_HOME /usr/local/jdk1.8.0_11
ENV CLASSPATH <span class="token variable">$JAVA_HOME</span>/lib/dt.jar:<span class="token variable">$JAVA_HOME</span>/lib/tools.jar
ENV CATALINA_HOME /usr/local/apache-tomcat-9.0.22
ENV CATALINA_BASE /usr/local/apache-tomcat-9.0.22
ENV <span class="token environment constant">PATH</span> <span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$JAVA_HOME</span>/bin:<span class="token variable">$CATALINA_HOME</span>/lib:<span class="token variable">$CATALINA_HOME</span>/bin
<span class="token comment">#容器运行时监听的端口</span>
EXPOSE <span class="token number">8080</span>
<span class="token comment">#启动时运行tomcat</span>
<span class="token comment"># ENTRYPOINT ["/usr/local/apache-tomcat-9.0.22/bin/startup.sh" ]</span>
<span class="token comment"># CMD ["/usr/local/apache-tomcat-9.0.22/bin/catalina.sh","run"]</span>
CMD /usr/local/apache-tomcat-9.0.22/bin/startup.sh <span class="token operator">&amp;&amp;</span> <span class="token function">tail</span> <span class="token parameter variable">-F</span>
/usr/local/apache-tomcat-9.0.22/bin/logs/catalina.out
</code></pre> 
<p>当前文件状态</p> 
<p><img src="https://images2.imgbox.com/5a/24/8OaqBBn7_o.png" alt="在这里插入图片描述"></p> 
<p>构建镜像</p> 
<pre><code class="prism language-shell"> <span class="token function">docker</span> build <span class="token parameter variable">-t</span> diytomcat <span class="token builtin class-name">.</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token punctuation">..</span><span class="token punctuation">..</span>.
Successfully built ffdf6529937d
Successfully tagged diytomcat:latest  <span class="token comment"># 构建完成</span>
</code></pre> 
<p>查看确定构建完毕！</p> 
<pre><code class="prism language-shell"> <span class="token function">docker</span> images
</code></pre> 
<pre><code class="prism language-shell">REPOSITORY     TAG         IMAGE ID      CREATED     
 SIZE
diytomcat      latest       ffdf6529937d     <span class="token number">20</span> seconds ago 
 636MB
</code></pre> 
<p>运行启动 run</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> run <span class="token parameter variable">-d</span> <span class="token parameter variable">-p</span> <span class="token number">9090</span>:8080 <span class="token parameter variable">--name</span> mydiytomcat <span class="token parameter variable">-v</span> /home/kuangshen/build/tomcat/test:/usr/local/apache-tomcat-
<span class="token number">9.0</span>.22/webapps/test <span class="token parameter variable">-v</span> /home/kuangshen/build/tomcat/tomcat9logs/:/usr/local/apache-tomcat-9.0.22/logs <span class="token parameter variable">--privileged</span><span class="token operator">=</span>true diytomcat
</code></pre> 
<p><img src="https://images2.imgbox.com/19/c3/yHyLGveH_o.png" alt="在这里插入图片描述"></p> 
<p>备注：Docker挂载主机目录Docker访问出现cannot open directory .: Permission denied<br> 解决办法：在挂载目录后多加一个–privileged=true参数即可</p> 
<p>验证测试访问！ curl localhost:9090<br> <img src="https://images2.imgbox.com/ce/46/zvG93cz1_o.png" alt="在这里插入图片描述"><br> 结合前面学习的容器卷将测试的web服务test发布</p> 
<p><img src="https://images2.imgbox.com/69/11/K4ZYwIGD_o.png" alt="在这里插入图片描述"></p> 
<p>web.xml</p> 
<pre><code class="prism language-shell"><span class="token operator">&lt;</span>?xml <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"1.0"</span> <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">"UTF-8"</span>?<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>web-app xmlns:xsi<span class="token operator">=</span><span class="token string">"http://www.w3.org/2001/XMLSchema-instance"</span>
 <span class="token assign-left variable">xmlns</span><span class="token operator">=</span><span class="token string">"http://java.sun.com/xml/ns/javaee"</span>
 xsi:schemaLocation<span class="token operator">=</span><span class="token string">"http://java.sun.com/xml/ns/javaee
http://java.sun.com/xml/ns/javaee/web-app_2_5.xsd"</span>
 <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">"WebApp_ID"</span> <span class="token assign-left variable">version</span><span class="token operator">=</span><span class="token string">"2.5"</span><span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>display-name<span class="token operator">&gt;</span>test<span class="token operator">&lt;</span>/display-name<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/web-app<span class="token operator">&gt;</span>
</code></pre> 
<p>a.jsp</p> 
<pre><code class="prism language-shell"><span class="token operator">&lt;</span>%@ page <span class="token assign-left variable">language</span><span class="token operator">=</span><span class="token string">"java"</span> <span class="token assign-left variable">contentType</span><span class="token operator">=</span><span class="token string">"text/html; charset=UTF-8"</span>
<span class="token assign-left variable">pageEncoding</span><span class="token operator">=</span><span class="token string">"UTF-8"</span>%<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html PUBLIC <span class="token string">"-//W3C//DTD HTML 4.01 Transitional//EN"</span>
<span class="token string">"http://www.w3.org/TR/html4/loose.dtd"</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta http-equiv<span class="token operator">=</span><span class="token string">"Content-Type"</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">"text/html; charset=UTF-8"</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>hello，kuangshen<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
 -----------welcome------------
  <span class="token operator">&lt;</span>%<span class="token operator">=</span><span class="token string">" my docker tomcat，kuangshen666 "</span>%<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>% System.out.println<span class="token punctuation">(</span><span class="token string">"-------my docker tomcat-------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>%<span class="token operator">&gt;</span>
 <span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre> 
<p>测试</p> 
<p><img src="https://images2.imgbox.com/3d/fc/431Xq1tN_o.png" alt="在这里插入图片描述"><br> 查看日志</p> 
<pre><code class="prism language-shell"> <span class="token builtin class-name">cd</span> tomcat9logs/
 ll
</code></pre> 
<pre><code class="prism language-shell">total <span class="token number">24</span>
-rw-r----- <span class="token number">1</span> root root <span class="token number">6993</span> May <span class="token number">12</span> <span class="token number">12</span>:50 catalina.2020-05-12.log
-rw-r----- <span class="token number">1</span> root root <span class="token number">7024</span> May <span class="token number">12</span> <span class="token number">12</span>:53 catalina.out
-rw-r----- <span class="token number">1</span> root root   <span class="token number">0</span> May <span class="token number">12</span> <span class="token number">12</span>:47 host-manager.2020-05-12.log
-rw-r----- <span class="token number">1</span> root root  <span class="token number">408</span> May <span class="token number">12</span> <span class="token number">12</span>:47 localhost.2020-05-12.log
-rw-r----- <span class="token number">1</span> root root  <span class="token number">150</span> May <span class="token number">12</span> <span class="token number">12</span>:53 localhost_access_log.2020-05-12.txt
-rw-r----- <span class="token number">1</span> root root   <span class="token number">0</span> May <span class="token number">12</span> <span class="token number">12</span>:47 manager.2020-05-12.log

<span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token function">cat</span> catalina.out
</code></pre> 
<h3><a id="DockerHub_418"></a>发布镜像到DockerHub</h3> 
<p>注册dockerhub https://hub.docker.com/signup，需要有一个账号</p> 
<p>查看登录命令</p> 
<pre><code class="prism language-shell"> <span class="token function">docker</span> login <span class="token parameter variable">--help</span>
</code></pre> 
<pre><code class="prism language-shell">Usage: <span class="token function">docker</span> login <span class="token punctuation">[</span>OPTIONS<span class="token punctuation">]</span> <span class="token punctuation">[</span>SERVER<span class="token punctuation">]</span>
</code></pre> 
<p>登录</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> login <span class="token parameter variable">-u</span> kuangshen
Password:
WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span>
/root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/<span class="token comment">#credentials-</span>
store
Login Succeeded
</code></pre> 
<p>将镜像发布出去</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> push kuangshen/diytomcat:1.0
</code></pre> 
<pre><code class="prism language-shell">The push refers to repository <span class="token punctuation">[</span>docker.io/library/diytomcat<span class="token punctuation">]</span>
0f02399c6fdf: Preparing
e79ea0c3a34e: Preparing
09281fa8fe38: Preparing
b56a902b0aef: Preparing
0683de282177: Preparing
<span class="token comment"># 拒绝：请求的资源访问被拒绝</span>
denied: requested access to the resource is denied
</code></pre> 
<p>问题：本地镜像名无帐号信息，解决加 tag即可</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> tag 251ca4419332 kuangshen/diytomcat:1.0
</code></pre> 
<p>再次 push， ok</p> 
<pre><code class="prism language-java">docker push kuangshen<span class="token operator">/</span>diytomcat<span class="token operator">:</span><span class="token number">1.0</span>
</code></pre> 
<pre><code class="prism language-shell">The push refers to repository <span class="token punctuation">[</span>docker.io/kuangshen/diytomcat<span class="token punctuation">]</span>
0f02399c6fdf: Pushing <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span>                     <span class="token punctuation">]</span>
 <span class="token number">9</span>.729MB/59.76MB
e79ea0c3a34e: Pushing <span class="token punctuation">[</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">&gt;</span>                    <span class="token punctuation">]</span>
 <span class="token number">3</span>.188MB/15.41MB
09281fa8fe38: Pushing <span class="token punctuation">[</span><span class="token operator">&gt;</span>                         <span class="token punctuation">]</span>
 <span class="token number">3</span>.823MB/324MB
b56a902b0aef: Pushed
0683de282177: Pushing <span class="token punctuation">[</span><span class="token operator">=</span><span class="token operator">&gt;</span>                         <span class="token punctuation">]</span>
 <span class="token number">5</span>.997MB/237.1MB
</code></pre> 
<h3><a id="_479"></a>发布镜像到阿里云镜像服务</h3> 
<p>登录阿里云找到容器镜像服务<br> <img src="https://images2.imgbox.com/93/11/eWNq2LoS_o.png" alt="在这里插入图片描述"><br> 创建命名空间</p> 
<p><img src="https://images2.imgbox.com/c1/3d/sLlH5suJ_o.png" alt="在这里插入图片描述"><br> 创建镜像仓库<br> <img src="https://images2.imgbox.com/17/00/U9F3sB8q_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ea/f0/fm4eExQp_o.png" alt="在这里插入图片描述"></p> 
<p>点击进入这个镜像仓库，可以看到所有的信息</p> 
<p><img src="https://images2.imgbox.com/57/b1/3nvjjuUe_o.png" alt="在这里插入图片描述"></p> 
<p>测试推送发布</p> 
<p>登录阿里云</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> login <span class="token parameter variable">--username</span><span class="token operator">=</span><span class="token number">18225148644</span> registry.cn-beijing.aliyuncs.com
Password:
WARNING<span class="token operator">!</span> Your password will be stored unencrypted <span class="token keyword">in</span>
/root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/<span class="token comment">#credentials-</span>
store
Login Succeeded
</code></pre> 
<p>设置 tag</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> tag <span class="token punctuation">[</span>ImageId<span class="token punctuation">]</span> registry.cn-beijing.aliyuncs.com/bilibili-kuangshen/kuangshen-test:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-shell"><span class="token function">docker</span> tag 251ca4419332 registry.cn-beijing.aliyuncs.com/bilibili-kuangshen/kuangshen-test:v1.0
</code></pre> 
<p>推送命令</p> 
<pre><code class="prism language-shell"><span class="token function">docker</span> push registry.cn-beijing.aliyuncs.com/bilibili-kuangshen/kuangshen-test:<span class="token punctuation">[</span>镜像版本号<span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-shell"> <span class="token function">docker</span> push registry.cn-beijing.aliyuncs.com/bilibili-kuangshen/kuangshen-test:v1.0
</code></pre> 
<p>在阿里云镜像仓库查看效果！</p> 
<p><img src="https://images2.imgbox.com/ba/c8/vVkbtDtY_o.png" alt="在这里插入图片描述"></p> 
<p>总结</p> 
<p><img src="https://images2.imgbox.com/d8/ed/B2AVzMwM_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e8f17412ad221558bea16c561c9fa0e5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">分享111个JavaScript源码，总有一款适合您</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dbda89a760cf4cc2b882386b0220d9fe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">从 level-ip 源码来看 TCP 如何接收消息</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>