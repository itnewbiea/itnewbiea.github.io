<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android系统启动流程概览 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android系统启动流程概览" />
<meta property="og:description" content="目录 第一节 Android系统启动流程init进程 第二节 init.rc 解析第三节 Zygote进程的启动过程3.1 AndroidRuntime.start 做了三件事：3.1.1 startVm：3.1.2 startReg：3.1.2.1 设置创建可访问Java的线程方法3.1.2.2 注册所有的JNI方法 3.1.3 callMain() 3.2 （Java世界开始）ZygoteInit.main() 第四节 SystemServer 启动流程第五节 其他小点5.1 什么情况下 Zygote 进程会重启呢？5.2 fork函数5.3 写时拷贝（copy-on-write)5.4 内核空间、用户空间5.5 epoll5.6 内核的异常级别 第一节 Android系统启动流程 Boot Rom —— Bootloader —— Linux Kernel —— init进程 —— Zygote进程（dalvik/ art）—— systemServer —— Apps
init进程 init 进程是Linux系统中，用户空间启动的第一个进程。
创建并挂载一些文件目录启动属性服务解析 init.rc 配置文件，启动 Zygote 进程 挂载 seLinux 文件目录，创建seLinux，加载 安全策略
启动内核日志
启动属性系统，从文件读取属性
创建epoll
第二节 init.rc 解析 包含五种类型语句：
Action（包含command）CommandsServices（将由 init进程 启动的服务）Options（服务的选项）Import （其他配置文件） Zygote服务 也在init." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a2d52c1ae5aec044efff8601dc2f457e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-29T23:47:46+08:00" />
<meta property="article:modified_time" content="2023-05-29T23:47:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android系统启动流程概览</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_Android_1" rel="nofollow">第一节 Android系统启动流程</a></li><li><ul><li><a href="#init_4" rel="nofollow">init进程</a></li></ul> 
  </li><li><a href="#_initrc__14" rel="nofollow">第二节 init.rc 解析</a></li><li><a href="#_Zygote_41" rel="nofollow">第三节 Zygote进程的启动过程</a></li><li><ul><li><a href="#31_AndroidRuntimestart__73" rel="nofollow">3.1 AndroidRuntime.start 做了三件事：</a></li><li><ul><li><a href="#311_startVm_78" rel="nofollow">3.1.1 startVm：</a></li><li><a href="#312_startReg_83" rel="nofollow">3.1.2 startReg：</a></li><li><ul><li><a href="#3121_Java_88" rel="nofollow">3.1.2.1 设置创建可访问Java的线程方法</a></li><li><a href="#3122_JNI_119" rel="nofollow">3.1.2.2 注册所有的JNI方法</a></li></ul> 
    </li><li><a href="#313_callMain_184" rel="nofollow">3.1.3 callMain()</a></li></ul> 
   </li><li><a href="#32_JavaZygoteInitmain_215" rel="nofollow">3.2 （Java世界开始）ZygoteInit.main()</a></li></ul> 
  </li><li><a href="#_SystemServer__331" rel="nofollow">第四节 SystemServer 启动流程</a></li><li><a href="#__358" rel="nofollow">第五节 其他小点</a></li><li><ul><li><a href="#51__Zygote__359" rel="nofollow">5.1 什么情况下 Zygote 进程会重启呢？</a></li><li><a href="#52_fork_362" rel="nofollow">5.2 fork函数</a></li><li><a href="#53_copyonwrite_368" rel="nofollow">5.3 写时拷贝（copy-on-write)</a></li><li><a href="#54__374" rel="nofollow">5.4 内核空间、用户空间</a></li><li><a href="#55_epoll_377" rel="nofollow">5.5 epoll</a></li><li><a href="#56__380" rel="nofollow">5.6 内核的异常级别</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_Android_1"></a>第一节 Android系统启动流程</h2> 
<p>Boot Rom —— Bootloader —— Linux Kernel —— init进程 —— Zygote进程（dalvik/ art）—— systemServer —— Apps</p> 
<h3><a id="init_4"></a>init进程</h3> 
<p>init 进程是Linux系统中，用户空间启动的第一个进程。</p> 
<ol><li>创建并挂载一些文件目录</li><li>启动属性服务</li><li>解析 init.rc 配置文件，启动 Zygote 进程</li></ol> 
<p>挂载 seLinux 文件目录，创建seLinux，加载 安全策略<br> 启动内核日志<br> 启动属性系统，从文件读取属性<br> 创建epoll</p> 
<h2><a id="_initrc__14"></a>第二节 init.rc 解析</h2> 
<p>包含五种类型语句：</p> 
<ol><li>Action（包含command）</li><li>Commands</li><li>Services（将由 init进程 启动的服务）</li><li>Options（服务的选项）</li><li>Import （其他配置文件）</li></ol> 
<p>Zygote服务 也在init.rc中配置：<br> //进程名为Zygote，执行的真正程序是 /system/bin/app_process</p> 
<pre><code class="prism language-bash"><span class="token function">service</span> zygote /system/bin/app_process -Xzygote /system/bin --zygote --start-system-server           
    class main        //classname为main
    priority -20
    user root
    group root readproc reserved_disk
    socket zygote stream <span class="token number">660</span> root system
    socket usap_pool_primary stream <span class="token number">660</span> root system
    onrestart exec_background - system system -- /system/bin/vdc volume abort_fuse
    onrestart <span class="token function">write</span> /sys/power/state on
    onrestart restart audioserver
    onrestart restart cameraserver
    onrestart restart media
    onrestart restart netd
    onrestart restart wificond
    writepid /dev/cpuset/foreground/tasks
</code></pre> 
<h2><a id="_Zygote_41"></a>第三节 Zygote进程的启动过程</h2> 
<p>zygote受精卵，用于孵化子进程。所有APP及Systemserver进程 都由zygote 通过Linux的fork() 函数孵化出来的。<br> Zygote进程是Android系统中第一个带有art 虚拟机的进程，Zygote 与 SystemServer 进程以socket的方式进行通信。<br> Zygote是C/S模型的服务端，主要负责创建 Java 虚拟机，加载系统资源，启动 SystemServer 及其他进程。</p> 
<p>启动一个应用的流程：<br> 点击应用图标 —— AMS —— 发出socket —— Zygote —— linux fork() 新进程</p> 
<p>/frameworks/base/cmds/app_process/app_main.cpp<br> App_main.main() 有两种启动模式：</p> 
<ol><li>Zygote初始化模式</li><li>application模式</li></ol> 
<hr> 
<ul><li>Zygote初始化模式，会启动 SystemServer ，并指定自己的 socket 名字为 zygote</li><li>application模式，就是启动普通应用，参数有 class 名字及参数</li></ul> 
<hr> 
<p><em>（C++世界）(Zygote Service)App_main() —— AndroidRumtime.start() 【startVm() —— startReg()</em> —— callMain() 】—— <strong>（Java世界开始）ZygoteInit.main() 【registerZygoteSocket() —— preload() —— gc() —— startSystemServer() —— runSelectLoop()】</strong></p> 
<ol><li>AndroidRumtime.start() —— startVm() —— startReg()：AndroidRumtime：：Start() 函数中将启动 JavaVM，并注册所有FWK相关的系统 JNI 接口。为 Java 世界做好准备。</li><li>ZygoteInit.main() registerZygoteSocket() —— preload() —— gc() —— startSystemServer() —— runSelectLoop()：第一次进入Java世界，运行 ZygoteInit.java：：main() 初始化Zygote，并创建 Socket 的 Server 端。preload 常用的 Java 类库、系统 resources，执行 gc() 清理内存，为 fork 子进程做好准备。然后 fork 出子进程，在子进程中 初始化 SystemServer，初始化的过程中 启动 Android 系统所有的 Service。</li><li>（与此同时，Zygote 继续在后台监听 Socket 等待新的应用启动请求。）</li><li>（与此同时，Zygote 监听 SystemServer 的 SIGHID信号，一旦SystemServer挂掉，立即 kill 掉 Zygote 自己。init 会重启 Zygote，再启动 SystemServer，使系统恢复正常。 ）</li><li>AMS ready后，寻找系统的 “Startup” Application，向 Zygote 发请求。</li><li>Zygote fork 出“Startup” Application，也就是启动 Launcher 应用，然后显示出Home页面。</li></ol> 
<p>在fork SystemServer之前执行了 gc 操作，使得被 fork 出来的子进程有尽可能少的垃圾内存。</p> 
<hr> 
<p>ZygoteInit的启动入口是：<br> app_main.cpp(也就是Zygote的C++进程) ：：main() —— AppRuntime.start(“com.android.internal.os.ZygoteInit”)</p> 
<p>AndroidRuntime包括了：从下到上 libc、JNI、Java-VM、Java-lib</p> 
<h3><a id="31_AndroidRuntimestart__73"></a>3.1 AndroidRuntime.start 做了三件事：</h3> 
<ol><li>startVm()：</li><li>startReg()：</li><li>callMain()：</li></ol> 
<h4><a id="311_startVm_78"></a>3.1.1 startVm：</h4> 
<p>cmds/app_process.cpp<br> base/core/jni/AndroidRuntime.cpp startvm()<br> art/runtime/java_vm_ext.cc JNI_CreateJavaVM() 返回JniEnv JavaVm给Native代码，这样就可以访问java接口了<br> art/runtime/runtime.cc 提供art虚拟机运行时：创建堆管理对象gc::Heap、创建Java虚拟机对象JavaVmExt、为vm添加JniEnvHandler、连接主线程、创建类连接器</p> 
<h4><a id="312_startReg_83"></a>3.1.2 startReg：</h4> 
<p>主要做两件事：</p> 
<ol><li>设置创建可访问Java的线程方法</li><li>注册所有的JNI方法</li></ol> 
<h5><a id="3121_Java_88"></a>3.1.2.1 设置创建可访问Java的线程方法</h5> 
<p>system/core/libutils/Threads.cpp：：run() native层可以创建两种Thread：一种可以调用java方法的线程，一种是纯native的线程。<br> 可调用java的线程，会调用vm 将线程与 JNIEnv 绑定，使之可通过JNIEnv调用java方法。</p> 
<pre><code class="prism language-cpp"><span class="token comment">// base/core/jni/androidRuntime.cpp</span>
<span class="token comment">/*
 * Makes the current thread visible to the VM.
 *
 * The JNIEnv pointer returned is only valid for the current thread, and
 * thus must be tucked into thread-local storage.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">javaAttachThread</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> threadName<span class="token punctuation">,</span> JNIEnv<span class="token operator">*</span><span class="token operator">*</span> pEnv<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    JavaVMAttachArgs args<span class="token punctuation">;</span>
    JavaVM<span class="token operator">*</span> vm<span class="token punctuation">;</span>
    vm <span class="token operator">=</span> <span class="token class-name">AndroidRuntime</span><span class="token double-colon punctuation">::</span><span class="token function">getJavaVM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    result <span class="token operator">=</span> vm<span class="token operator">-&gt;</span><span class="token function">AttachCurrentThread</span><span class="token punctuation">(</span>pEnv<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> JNI_OK<span class="token punctuation">)</span>
        <span class="token function">ALOGI</span><span class="token punctuation">(</span><span class="token string">"NOTE: attach of thread '%s' failed\n"</span><span class="token punctuation">,</span> threadName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从数据结构上看，thread.h 类中，有一个 JNIEnvExt* 的指针变量 jni_env， 表明一个thread与一个jni_env关联。</p> 
<pre><code class="prism language-cpp"><span class="token comment">// runtime/thread.h</span>
<span class="token keyword">struct</span> <span class="token class-name">PACKED</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">)</span> tls_ptr_sized_values <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Every thread may have an associated JNI environment</span>
    JNIEnvExt<span class="token operator">*</span> jni_env<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="3122_JNI_119"></a>3.1.2.2 注册所有的JNI方法</h5> 
<p>除了系统的JNI接口（javacore nativehelper）FWK还有大量的Native实现，所有这些接口一次性通过startReg()来完成<br> base/core/jni/androidRuntime.cpp：：startReg()</p> 
<pre><code class="prism language-cpp"><span class="token comment">/*
 * Register android native functions with the VM.
 */</span>
<span class="token comment">/*static*/</span> <span class="token keyword">int</span> <span class="token class-name">AndroidRuntime</span><span class="token double-colon punctuation">::</span><span class="token function">startReg</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token function">register_jni_procs</span><span class="token punctuation">(</span>gRegJNI<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gRegJNI<span class="token punctuation">)</span><span class="token punctuation">,</span> env<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">register_jni_procs</span><span class="token punctuation">(</span><span class="token keyword">const</span> RegJNIRec array<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> size_t count<span class="token punctuation">,</span> JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>array<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">mProc</span><span class="token punctuation">(</span>env<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">static</span> <span class="token keyword">const</span> RegJNIRec gRegJNI<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_com_android_internal_os_RuntimeInit<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_com_android_internal_os_ZygoteInit_nativeZygoteInit<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_os_SystemClock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_util_EventLog<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_util_Log<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_util_MemoryIntArray<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_util_PathParser<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_util_StatsLog<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_app_admin_SecurityLog<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_content_AssetManager<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_content_StringBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_content_XmlBlock<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_content_res_ApkAssets<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">REG_JNI</span><span class="token punctuation">(</span>register_android_text_AndroidCharacter<span class="token punctuation">)</span><span class="token punctuation">,</span> 
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/core/jni/android_util_Log.cpp</span>
<span class="token keyword">int</span> <span class="token function">register_android_util_Log</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    jclass clazz <span class="token operator">=</span> <span class="token function">FindClassOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android/util/Log"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levels<span class="token punctuation">.</span>verbose <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token function">GetStaticFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"VERBOSE"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levels<span class="token punctuation">.</span>debug <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token function">GetStaticFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"DEBUG"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levels<span class="token punctuation">.</span>info <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token function">GetStaticFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"INFO"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levels<span class="token punctuation">.</span>warn <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token function">GetStaticFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"WARN"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levels<span class="token punctuation">.</span>error <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token function">GetStaticFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"ERROR"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    levels<span class="token punctuation">.</span>assert <span class="token operator">=</span> env<span class="token operator">-&gt;</span><span class="token function">GetStaticIntField</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> <span class="token function">GetStaticFieldIDOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> <span class="token string">"ASSERT"</span><span class="token punctuation">,</span> <span class="token string">"I"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">RegisterMethodsOrDie</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> <span class="token string">"android/util/Log"</span><span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> <span class="token function">NELEM</span><span class="token punctuation">(</span>gMethods<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Register native methods using JNI.
 */</span>
<span class="token comment">/*static*/</span> <span class="token keyword">int</span> <span class="token class-name">AndroidRuntime</span><span class="token double-colon punctuation">::</span><span class="token function">registerNativeMethods</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span>
    <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> <span class="token keyword">const</span> JNINativeMethod<span class="token operator">*</span> gMethods<span class="token punctuation">,</span> <span class="token keyword">int</span> numMethods<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token function">jniRegisterNativeMethods</span><span class="token punctuation">(</span>env<span class="token punctuation">,</span> className<span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// libnativehelper/JNIHelp.cpp</span>
<span class="token keyword">extern</span> <span class="token string">"C"</span> <span class="token keyword">int</span> <span class="token function">jniRegisterNativeMethods</span><span class="token punctuation">(</span>C_JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> className<span class="token punctuation">,</span> constJNINativeMethod<span class="token operator">*</span> gMethods<span class="token punctuation">,</span> <span class="token keyword">int</span> numMethods<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    JNIEnv<span class="token operator">*</span> e <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>JNIEnv<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>env<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token operator">*</span>env<span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">RegisterNatives</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> c<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> gMethods<span class="token punctuation">,</span> numMethods<span class="token punctuation">)</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="313_callMain_184"></a>3.1.3 callMain()</h4> 
<pre><code class="prism language-java"><span class="token comment">// frameworks/base/core/java/com.android.internal.os.RuntimeInit.java</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">/*
         * Now that we're running in interpreted code, call back into native code
         * to run the system.
         */</span>
        <span class="token function">nativeFinishInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>DEBUG<span class="token punctuation">)</span> <span class="token class-name">Slog</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Leaving RuntimeInit!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-cpp"><span class="token comment">// frameworks/base/core/jni/AndroidRuntime.cpp</span>
<span class="token comment">/*
 * Code written in the Java Programming Language calls here from main().
 */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">com_android_internal_os_RuntimeInit_nativeFinishInit</span><span class="token punctuation">(</span>JNIEnv<span class="token operator">*</span> env<span class="token punctuation">,</span> jobject clazz<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    gCurRuntime<span class="token operator">-&gt;</span><span class="token function">onStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// frameworks/base/cmds/app_process/app_main.cpp</span>
<span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">onStarted</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    AndroidRuntime<span class="token operator">*</span> ar <span class="token operator">=</span> <span class="token class-name">AndroidRuntime</span><span class="token double-colon punctuation">::</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ar<span class="token operator">-&gt;</span><span class="token function">callMain</span><span class="token punctuation">(</span>mClassName<span class="token punctuation">,</span> mClass<span class="token punctuation">,</span> mArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>callMain() 将调起Java世界的 com.android.internal.os.ZygoteInit 类的main()方法。</p> 
<h3><a id="32_JavaZygoteInitmain_215"></a>3.2 （Java世界开始）ZygoteInit.main()</h3> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ZygoteServer</span> zygoteServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">final</span> <span class="token class-name">Runnable</span> caller<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> startSystemServer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> socketName <span class="token operator">=</span> <span class="token string">"zygote"</span><span class="token punctuation">;</span>
            <span class="token class-name">String</span> abiList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token keyword">boolean</span> enableLazyPreload <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> argv<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"start-system-server"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    startSystemServer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"--enable-lazy-preload"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    enableLazyPreload <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    abiList <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>ABI_LIST_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    socketName <span class="token operator">=</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>SOCKET_NAME_ARG<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">"Unknown command line argument: "</span> <span class="token operator">+</span> argv<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

			<span class="token comment">// 注册Server socket</span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">registerServerSocketFromEnv</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span> 
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>enableLazyPreload<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                bootTimingsTraceLog<span class="token punctuation">.</span><span class="token function">traceBegin</span><span class="token punctuation">(</span><span class="token string">"ZygotePreload"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 加载类到内存</span>
                <span class="token function">preload</span><span class="token punctuation">(</span>bootTimingsTraceLog<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token punctuation">}</span>
			<span class="token function">preloadTextResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">// 垃圾回收</span>
			<span class="token function">gcAndFinalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>startSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">Runnable</span> r <span class="token operator">=</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span>abiList<span class="token punctuation">,</span> socketName<span class="token punctuation">,</span> zygoteServer<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
                <span class="token comment">// child (system_server) process.</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    r<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"Accepting command socket connections"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// The select loop returns early in the child process after a fork and</span>
            <span class="token comment">// loops forever in the zygote.</span>
            caller <span class="token operator">=</span> zygoteServer<span class="token punctuation">.</span><span class="token function">runSelectLoop</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"System zygote died with exception"</span><span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> ex<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{<!-- --></span>
            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>preload是Android 启动最耗时的部分之一</p> 
<pre><code class="prism language-java"><span class="token comment">/**
     * Prepare the arguments and forks for the system server process.
     *
     * Returns an {@code Runnable} that provides an entrypoint into system_server code in the
     * child process, and {@code null} in the parent.
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Runnable</span> <span class="token function">forkSystemServer</span><span class="token punctuation">(</span><span class="token class-name">String</span> abiList<span class="token punctuation">,</span> <span class="token class-name">String</span> socketName<span class="token punctuation">,</span>
            <span class="token class-name">ZygoteServer</span> zygoteServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/* Hardcoded command line to start the system server */</span>
        <span class="token class-name">String</span> args<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"--setuid=1000"</span><span class="token punctuation">,</span>
            <span class="token string">"--setgid=1000"</span><span class="token punctuation">,</span>
            <span class="token string">"--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1023,1024,1032,1065,3001,3002,3003,3006,3007,3009,3010"</span><span class="token punctuation">,</span>
            <span class="token string">"--capabilities="</span> <span class="token operator">+</span> capabilities <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> capabilities<span class="token punctuation">,</span>
            <span class="token string">"--nice-name=system_server"</span><span class="token punctuation">,</span>
            <span class="token string">"--runtime-args"</span><span class="token punctuation">,</span>
            <span class="token string">"--target-sdk-version="</span> <span class="token operator">+</span> <span class="token class-name">VMRuntime</span><span class="token punctuation">.</span>SDK_VERSION_CUR_DEVELOPMENT<span class="token punctuation">,</span>
            <span class="token string">"com.android.server.SystemServer"</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ZygoteConnection<span class="token punctuation">.</span>Arguments</span> parsedArgs <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> pid<span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            parsedArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ZygoteConnection<span class="token punctuation">.</span>Arguments</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ZygoteConnection</span><span class="token punctuation">.</span><span class="token function">applyDebuggerSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ZygoteConnection</span><span class="token punctuation">.</span><span class="token function">applyInvokeWithSystemProperty</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">boolean</span> profileSystemServer <span class="token operator">=</span> <span class="token class-name">SystemProperties</span><span class="token punctuation">.</span><span class="token function">getBoolean</span><span class="token punctuation">(</span>
                    <span class="token string">"dalvik.vm.profilesystemserver"</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>profileSystemServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                parsedArgs<span class="token punctuation">.</span>runtimeFlags <span class="token operator">|=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span>PROFILE_SYSTEM_SERVER<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/* Request to fork the system server process */</span>
            pid <span class="token operator">=</span> <span class="token class-name">Zygote</span><span class="token punctuation">.</span><span class="token function">forkSystemServer</span><span class="token punctuation">(</span>
                    parsedArgs<span class="token punctuation">.</span>uid<span class="token punctuation">,</span> parsedArgs<span class="token punctuation">.</span>gid<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>gids<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>runtimeFlags<span class="token punctuation">,</span>
                    <span class="token keyword">null</span><span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>permittedCapabilities<span class="token punctuation">,</span>
                    parsedArgs<span class="token punctuation">.</span>effectiveCapabilities<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalArgumentException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/* For child process */</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasSecondZygote</span><span class="token punctuation">(</span>abiList<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token function">waitForSecondaryZygote</span><span class="token punctuation">(</span>socketName<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            zygoteServer<span class="token punctuation">.</span><span class="token function">closeServerSocket</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token function">handleSystemServerProcess</span><span class="token punctuation">(</span>parsedArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h2><a id="_SystemServer__331"></a>第四节 SystemServer 启动流程</h2> 
<p>SystemServer 是 Zygote fork出来的第一个 Java 进程，此进程非要重要，提供了 Android 系统所有的核心服务。<br> SystemServer 中运行着AMS，WMS 等系统服务，Binder-x 之类的服务线程，UI-thread InputReader</p> 
<p>SystemServer 创建：ActivityThread、SystemContext、SystemUIContext<br> ContextImpl 是 Context 的实现类，其中封装了生成 4 种常用的 createContext 方法：</p> 
<ul><li>createSystemContext()</li><li>createSystemUiContext()</li><li>createAppContext()</li><li>createActivityContext()</li></ul> 
<p>启动Service</p> 
<pre><code class="prism language-java"><span class="token function">startBootstrapServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">startCoreServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">startOtherServices</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ul><li>startBootstrapServices()：启动系统启动所需的一小堆关键服务（AMS，PMS，RecoverySystemService，LightsService，DisplayManagerService，UserManagerService，OverlayManagerService）。这些服务具有复杂的相互依赖关系，这就是为什么我们在这里将它们全部初始化的原因。除非您的服务也与这些依赖关系纠缠在一起，否则它应该在其他函数中进行初始化。</li><li>startCoreServices()：启动一些在引导过程中没有互相交互的基本服务（BatteryService, UsageStatsService, WebViewUpdateService, BinderCallsStatsService）。</li><li>startOtherServices()：启动一些杂七杂八的东西（ConnectivityService，WMS，InputManagerService，TelephonyRegistry）</li></ul> 
<p>Zygote会在后台观察 SystemServer ，一旦 System 挂掉了，将其回收，然后重启 Zygote 自己。<br> Watchdog 也可能因某种原因，将 SystemServer Kill 掉，并重启。屏幕会黑屏一段时间。</p> 
<p>在 Unix-like 系统，父进程必须用 waitpid 等待子进程退出，否则子进程将变成 Zombie（僵尸）进程，不仅系统资源泄漏，而且系统将崩溃。没有 SystemServer 所有 Android 应用程序都无法运行。<br> waitpid() 是一个阻塞函数，所以通常处理是 在 signal 函数里无阻塞调用。<br> 每个子进程退出时 —— 发出 SIGCHID 信号 —— Zygote 会杀掉自己 —— 系统给所有子进程发送 SIGHUP 信号 —— 各子进程杀掉自己退出当前进程（子进程中的 Daemon 进程设置 SIG_IGN参数忽略 SIGHUP 信号继续运行）。</p> 
<h2><a id="__358"></a>第五节 其他小点</h2> 
<h3><a id="51__Zygote__359"></a>5.1 什么情况下 Zygote 进程会重启呢？</h3> 
<p>ServiceManager、SystemServer、SurfaceFlinger、Zygote自己 进程被杀</p> 
<h3><a id="52_fork_362"></a>5.2 fork函数</h3> 
<p>返回值 == 0：成功创建子进程，并进入子进程执行<br> 返回值 &gt; 0：成功创建子进程，返回子进程id，并继续沿原父进程执行<br> 返回值 &lt; 0：创建失败<br> 失败原因主要有：进程数超过系统上限（EAGAIN），系统内存不足（ENOMEM）<br> fork() 出的子进程，是父进程的一个copy，继承了整个进程的地址空间：包括进程上下文、进程堆栈、打开的文件描述符、信号控制设定、进程优先级、进程组号等。与父进程不同的只有进程号、计时器等少量信息。由上可见，fork() 函数的开销是很大的。</p> 
<h3><a id="53_copyonwrite_368"></a>5.3 写时拷贝（copy-on-write)</h3> 
<p>Linux 的 fork 采用写时拷贝。写时拷贝是一种可能推迟甚至避免拷贝的技术。内核此时并不复制整个进程的地址空间，而是让子进程共享父进程的地址空间。只有在需要写入时，才会复制地址空间，使子进程拥有自己的地址空间。</p> 
<p>panic<br> 内核出现异常会导致1 进程死亡，如果是中断上下文的异常或系统关键资源受到破坏，通常会导致2 内核挂起，不再响应任何事件。</p> 
<h3><a id="54__374"></a>5.4 内核空间、用户空间</h3> 
<p>在linux中， 将最高的1G字节（从虚拟地址0xC0000000到0xFFFFFFFF），供内核使用，称为“内核空间”。而将较低的3G字节（从虚拟地址 0x00000000到0xBFFFFFFF），供各个进程使用，称为“用户空间）<br> 内核非法使用了用户空间的地址故存在问题。</p> 
<h3><a id="55_epoll_377"></a>5.5 epoll</h3> 
<p>epoll<br> epoll_create、epoll_wait、epoll_ctl</p> 
<h3><a id="56__380"></a>5.6 内核的异常级别</h3> 
<pre><code class="prism language-java"><span class="token number">1.</span> bug
<span class="token number">2.</span> <span class="token class-name">Oops</span>
<span class="token number">3.</span> panic
</code></pre> 
<ul><li>Bug：是指那些不符合内核的正常设计，但内核能够检测出来并且对系统运行不会产生影响的问题，比如在原子上下文中休眠。</li><li>Oops：程序在内核态时，进入一种异常情况，比如引用非法指针导致的数据异常，数组越界导致的取指异常，此时异常处理机制能够捕获此异常，并将系统关键信息打印到串口上，正常情况下Oops消息会被记录到系统日志中去。<br> Oops发生时，进程处在内核态，很可能正在访问系统关键资源，并且获取了一些锁，当进程由于Oops异常退出时，无法释放已经获取的资源，导致其他需要获取此资源的进程挂起，对系统的正常运行造成影响。通常这种情况，系统处在不稳定的状态，很可能崩溃。</li><li>panic：当Oops发生在中断上下文中或者在进程0和1中，系统将彻底挂起，因为中断服务程序异常后，将无法恢复，这种情况即称为内核panic。另外当系统设置了panic标志时，无论Oops发生在中断上下文还是进程上下文，都将导致内核Panic。由于在中断复位程序中panic后，系统将不再进行调度，Syslogd将不会再运行，因此这种情况下，Oops的消息仅仅打印到串口上，不会被记录在系统日志中。</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4daa2f5b59264832131066c54b7d8801/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubuntu无界面安装MATLAB 2021a</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a8eb73ed5c74142c387f263105b2a0de/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Kepserver EX6配置opc ua服务端 以及客户端</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>