<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【一文吃透归并排序】基本归并·原地归并·自然归并 C&#43;&#43; - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【一文吃透归并排序】基本归并·原地归并·自然归并 C&#43;&#43;" />
<meta property="og:description" content="目录 1 引入情境基本归并排序实现 C&#43;&#43; 2 原地归并排序2-1 死板的解法2-2 原地工作区2-3 链表归并排序 3 自底向上归并排序4 两路自然归并排序4-1 形式化描述4-2 代码实现 1 引入情境 归并思想：假设有两队小孩，都是从矮到高排序，现在通过一扇门后合并为一队。要求：任何孩子，只有所有比它矮的孩子通过后，才能通过。
直接给出归并排序的伪代码： function merge_sort(A): if len(A) &gt; 1 then m = floor(len(A)/2) # 获取中心点 X = copy_array(A,0,m) Y = copy_array(A,m&#43;1,len(A)-1) #拆成差不多的两半 merge_sort(X) merge_sort(Y) # 分别排序 merge(A,X,Y) # 合并 假如我理解了上面归并，但是，在排序之前，怎么得到有序的两个队列呢？注意到，伪代码的出口是 l e n ( A ) ≤ 1 len(A) \leq 1 len(A)≤1 就会返回，即一个数本身有序。当它拆分到自然有序，返回头开始合并，直接上图：
一个更明确的例子，同色表明为一组，且基本是平均分割： 只剩下一个问题，merge(A,X,Y)是怎么做的？简单的理解，每次比较X,Y头部，选一个最小的放到目标有序数组A的队尾即可；若一队为空，另一队还有剩余就直接放到A的队尾。给出伪代码描述：
function Merge(A,X,Y): i=1,j=1,k=1 xlen=|X| ylen=|Y| # 从队伍头部选一个最小的放到目标队伍末尾 while i&lt;= xlen and j &lt;=ylen do if X[i] &lt;= Y[i] then A[k] = X[i] i = i &#43; 1 else A[k] = Y[j] j = j &#43; 1 k = k &#43; 1 # 处理剩余的部分，放到末尾 while i &lt;= xlen do A[k] = X[i] k = k &#43; 1 while j &lt;= ylen do A[k]= Y[j] j = j &#43; 1 关于时间复杂度，设排序用时为 T ( N ) T(N) T(N)，则递归开销为：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/70a32736099a8eb04f9d0f02ec068f21/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-14T14:06:44+08:00" />
<meta property="article:modified_time" content="2023-05-14T14:06:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【一文吃透归并排序】基本归并·原地归并·自然归并 C&#43;&#43;</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1 引入情境</a></li><li><ul><li><a href="#_C_66" rel="nofollow">基本归并排序实现 C++</a></li></ul> 
  </li><li><a href="#2__214" rel="nofollow">2 原地归并排序</a></li><li><ul><li><a href="#21__217" rel="nofollow">2-1 死板的解法</a></li><li><a href="#22__238" rel="nofollow">2-2 原地工作区</a></li><li><a href="#23__497" rel="nofollow">2-3 链表归并排序</a></li></ul> 
  </li><li><a href="#3__601" rel="nofollow">3 自底向上归并排序</a></li><li><a href="#4__709" rel="nofollow">4 两路自然归并排序</a></li><li><ul><li><a href="#41__716" rel="nofollow">4-1 形式化描述</a></li><li><a href="#42__786" rel="nofollow">4-2 代码实现</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__4"></a>1 引入情境</h2> 
<p>  <strong>归并思想</strong>：假设有两队小孩，都是从矮到高排序，现在通过一扇门后合并为一队。<mark>要求</mark>：任何孩子，只有所有比它矮的孩子通过后，才能通过。</p> 
<center> 
 <img src="https://images2.imgbox.com/95/58/JRq4vof3_o.jpg" width="60%"> 
</center>   直接给出归并排序的伪代码： 
<pre><code class="prism language-bash"><span class="token keyword">function</span> merge_sort<span class="token punctuation">(</span>A<span class="token punctuation">)</span>:
	<span class="token keyword">if</span> len<span class="token punctuation">(</span>A<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">then</span>
		m <span class="token operator">=</span> floor<span class="token punctuation">(</span>len<span class="token punctuation">(</span>A<span class="token punctuation">)</span>/2<span class="token punctuation">)</span>  <span class="token comment"># 获取中心点</span>
		X <span class="token operator">=</span> copy_array<span class="token punctuation">(</span>A,0,m<span class="token punctuation">)</span>
		Y <span class="token operator">=</span> copy_array<span class="token punctuation">(</span>A,m+1,len<span class="token punctuation">(</span>A<span class="token punctuation">)</span>-1<span class="token punctuation">)</span> <span class="token comment">#拆成差不多的两半</span>
		merge_sort<span class="token punctuation">(</span>X<span class="token punctuation">)</span>
		merge_sort<span class="token punctuation">(</span>Y<span class="token punctuation">)</span> <span class="token comment"># 分别排序</span>
		merge<span class="token punctuation">(</span>A,X,Y<span class="token punctuation">)</span> <span class="token comment"># 合并</span>
</code></pre> 
<p>  假如我理解了上面归并，但是，在排序之前，怎么得到有序的两个队列呢？注意到，伪代码的出口是 <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         e 
        
       
         n 
        
       
         ( 
        
       
         A 
        
       
         ) 
        
       
         ≤ 
        
       
         1 
        
       
      
        len(A) \leq 1 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.0197em;" class="mord mathnormal">l</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span> 就会返回，即一个数本身有序。当它拆分到自然有序，返回头开始合并，直接上图：</p> 
<center> 
 <img src="https://images2.imgbox.com/b8/ce/X6ik1hxn_o.png" width="70%"> 
</center>    一个更明确的例子，同色表明为一组，且基本是平均分割： 
<center> 
 <img src="https://images2.imgbox.com/8c/d6/hCWv2rfI_o.gif" width="60%"> 
</center> 
<p>  只剩下一个问题，<code>merge(A,X,Y)</code>是怎么做的？简单的理解，每次比较X,Y头部，选一个最小的放到目标有序数组A的队尾即可；若一队为空，另一队还有剩余就直接放到A的队尾。给出伪代码描述：</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> Merge<span class="token punctuation">(</span>A,X,Y<span class="token punctuation">)</span>:
	<span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>,j<span class="token operator">=</span><span class="token number">1</span>,k<span class="token operator">=</span><span class="token number">1</span>
	<span class="token assign-left variable">xlen</span><span class="token operator">=</span><span class="token operator">|</span>X<span class="token operator">|</span>
	<span class="token assign-left variable">ylen</span><span class="token operator">=</span><span class="token operator">|</span>Y<span class="token operator">|</span>
	<span class="token comment"># 从队伍头部选一个最小的放到目标队伍末尾</span>
	<span class="token keyword">while</span> i<span class="token operator">&lt;=</span> xlen and j <span class="token operator">&lt;=</span>ylen <span class="token keyword">do</span>
		<span class="token keyword">if</span> X<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> Y<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">then</span>
			A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> X<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			i <span class="token operator">=</span> i + <span class="token number">1</span>
		<span class="token keyword">else</span>
			A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> Y<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
			j <span class="token operator">=</span> j + <span class="token number">1</span>
		k <span class="token operator">=</span> k + <span class="token number">1</span>
	<span class="token comment"># 处理剩余的部分，放到末尾</span>
	<span class="token keyword">while</span> i <span class="token operator">&lt;=</span> xlen <span class="token keyword">do</span>
		A<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> X<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		k <span class="token operator">=</span> k + <span class="token number">1</span>
	<span class="token keyword">while</span> j <span class="token operator">&lt;=</span> ylen <span class="token keyword">do</span>
		A<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">=</span> Y<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
		j <span class="token operator">=</span> j + <span class="token number">1</span>
</code></pre> 
<p>   关于时间复杂度，设排序用时为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
       
         ( 
        
       
         N 
        
       
         ) 
        
       
      
        T(N) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.1389em;" class="mord mathnormal">T</span><span class="mopen">(</span><span style="margin-right: 0.109em;" class="mord mathnormal">N</span><span class="mclose">)</span></span></span></span></span>，则递归开销为：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          T 
         
        
          ( 
         
        
          N 
         
        
          ) 
         
        
          = 
         
        
          T 
         
        
          ( 
         
         
         
           N 
          
         
           2 
          
         
        
          ) 
         
        
          + 
         
        
          T 
         
        
          ( 
         
         
         
           N 
          
         
           2 
          
         
        
          ) 
         
        
          + 
         
        
          c 
         
        
          N 
         
        
       
         T(N) = T(\frac {N} {2})+T(\frac {N} {2})+cN 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span style="margin-right: 0.1389em;" class="mord mathnormal">T</span><span class="mopen">(</span><span style="margin-right: 0.109em;" class="mord mathnormal">N</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.0463em; vertical-align: -0.686em;"></span><span style="margin-right: 0.1389em;" class="mord mathnormal">T</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span style="margin-right: 0.109em;" class="mord mathnormal">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 2.0463em; vertical-align: -0.686em;"></span><span style="margin-right: 0.1389em;" class="mord mathnormal">T</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3603em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span style="margin-right: 0.109em;" class="mord mathnormal">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal">c</span><span style="margin-right: 0.109em;" class="mord mathnormal">N</span></span></span></span></span></span></p> 
<p>   对两半分别排序是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         2 
        
       
         T 
        
       
         ( 
        
        
        
          N 
         
        
          2 
         
        
       
         ) 
        
       
      
        2T(\frac {N} {2}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.2173em; vertical-align: -0.345em;"></span><span class="mord">2</span><span style="margin-right: 0.1389em;" class="mord mathnormal">T</span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.8723em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span style="margin-right: 0.109em;" class="mord mathnormal mtight">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.345em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span>，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         c 
        
       
         n 
        
       
      
        cn 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span></span></span></span></span>是合并两个队列用时，解开后是<code>O(NlgN)</code>。另一种直观理解的方式如下图，拆半分层最多是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
         g 
        
       
         N 
        
       
      
        lgN 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span style="margin-right: 0.0197em;" class="mord mathnormal">l</span><span style="margin-right: 0.0359em;" class="mord mathnormal">g</span><span style="margin-right: 0.109em;" class="mord mathnormal">N</span></span></span></span></span>层，每层归并都是O(N)，相乘即可。</p> 
<center> 
 <img src="https://images2.imgbox.com/55/e3/TYca2Qcc_o.jpg" width="60%"> 
</center> 
<h3><a id="_C_66"></a>基本归并排序实现 C++</h3> 
<p>   在实现之前，我们加一个小改进，在每队队伍加入一个哨兵：正无穷大（如果是非递增是负无穷），于是，<code>merge</code>的过程无需另行考虑剩余部分。</p> 
<pre><code class="prism language-bash"><span class="token comment"># 加入正无穷哨兵，会让一个较短的队列的下标阻塞在末尾</span>
<span class="token keyword">function</span> merge<span class="token punctuation">(</span>A,X,Y<span class="token punctuation">)</span>:
	append<span class="token punctuation">(</span>X,INF<span class="token punctuation">)</span> <span class="token comment"># 在队列尾加入哨兵，正无穷INF</span>
	append<span class="token punctuation">(</span>Y,INF<span class="token punctuation">)</span>
	<span class="token keyword">for</span> k from <span class="token number">1</span> to A.len <span class="token keyword">do</span>
		<span class="token keyword">if</span> X<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> Y<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">then</span>
			A<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">=</span>X<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
			i <span class="token operator">=</span> i + <span class="token number">1</span>
		<span class="token keyword">else</span>
			A<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">=</span>Y<span class="token punctuation">[</span>j<span class="token punctuation">]</span>
			j <span class="token operator">=</span>j + <span class="token number">1</span> 		
</code></pre> 
<p>   实现时发生了两个错误：</p> 
<ul><li><code>l+(r-l)&gt;&gt;1</code> 和<code>l+(r-l)/2</code>是不同的；<code>l+(r-l)/2</code>和<code>l+((r-l)&gt;&gt;1)</code>才等价</li><li>l 和 1 总是容易弄混；下载编程字体点链接<a href="https://github.com/adobe-fonts/source-code-pro/releases/tag/2.042R-u/1.062R-i/1.026R-vf">source code Pro</a></li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> INF<span class="token operator">=</span><span class="token number">1e5</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> Key<span class="token operator">=</span><span class="token keyword">int</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> Array <span class="token operator">=</span>vector<span class="token operator">&lt;</span>Key<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> m<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 开两个队列分别放 A[l,m) A[m,r)</span>
	Array <span class="token function">X</span><span class="token punctuation">(</span>m<span class="token operator">-</span>l<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//多一个哨兵的位置</span>
	Array <span class="token function">Y</span><span class="token punctuation">(</span>r<span class="token operator">-</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//复制元素</span>
	<span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span>l<span class="token punctuation">;</span>k<span class="token operator">&lt;</span>m<span class="token punctuation">;</span><span class="token operator">++</span>k<span class="token punctuation">)</span> X<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> k<span class="token operator">=</span>m<span class="token punctuation">;</span>k<span class="token operator">&lt;</span>r<span class="token punctuation">;</span><span class="token operator">++</span>k<span class="token punctuation">)</span> Y<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>

	X<span class="token punctuation">[</span>m<span class="token operator">-</span>l<span class="token punctuation">]</span><span class="token operator">=</span>INF<span class="token punctuation">;</span> <span class="token comment">//设置哨兵</span>
	Y<span class="token punctuation">[</span>r<span class="token operator">-</span>m<span class="token punctuation">]</span><span class="token operator">=</span>INF<span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">;</span><span class="token operator">++</span>l<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		A<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token operator">=</span>X<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> Y<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">?</span> X<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">:</span>Y<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// A[l,r)</span>
<span class="token keyword">void</span> <span class="token function">merge_sort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> m <span class="token operator">=</span> l<span class="token operator">+</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 防止溢出</span>
		<span class="token function">merge_sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>l<span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">merge_sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>m<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>l<span class="token punctuation">,</span>m<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">see_array</span><span class="token punctuation">(</span>string arr_info<span class="token punctuation">,</span><span class="token keyword">const</span> Array <span class="token operator">&amp;</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	cout<span class="token operator">&lt;&lt;</span>arr_info <span class="token operator">&lt;&lt;</span><span class="token string">" { "</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> item<span class="token operator">:</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		cout<span class="token operator">&lt;&lt;</span>item<span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cout<span class="token operator">&lt;&lt;</span><span class="token string">"}"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Array arr<span class="token punctuation">{<!-- --></span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// merge(arr,0,3,arr.size());</span>
	<span class="token function">merge_sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>arr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">see_array</span><span class="token punctuation">(</span><span class="token string">"sorted "</span><span class="token punctuation">,</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>  注意到，在merge中需要申请两个数组来放数据，<mark>频繁的申请释放内存</mark>会花费大量的时间。一个解决办法是<mark>一次性申请一个和待排序数组一样大的数组B</mark>，作为工作区。这一改进将所需空间从O(NLgN)减少到了O(N)，对十万个数字排序上速度提示20%~25%。C++实现如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> INF<span class="token operator">=</span><span class="token number">1e5</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> Key<span class="token operator">=</span><span class="token keyword">int</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> Array <span class="token operator">=</span>vector<span class="token operator">&lt;</span>Key<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span>Array <span class="token operator">&amp;</span>B<span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> m<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 合并 A[l,m) A[m,r) 到 B，再复制回来</span>
	<span class="token keyword">int</span> i<span class="token punctuation">,</span>j<span class="token punctuation">,</span>k<span class="token punctuation">;</span>
	<span class="token comment">// 记录两个队列的起点</span>
	i<span class="token operator">=</span>k<span class="token operator">=</span>l<span class="token punctuation">;</span>
	j<span class="token operator">=</span>m<span class="token punctuation">;</span>

	<span class="token comment">// 归并</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>m <span class="token operator">&amp;&amp;</span> j<span class="token operator">&lt;</span>r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		B<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">?</span> A<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">:</span>A<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// 收尾工作</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span>m<span class="token punctuation">)</span> B<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>j<span class="token operator">&lt;</span>r<span class="token punctuation">)</span> B<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>l<span class="token operator">&lt;</span>r<span class="token punctuation">;</span><span class="token operator">++</span>l<span class="token punctuation">)</span> A<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token operator">=</span>B<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">msort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span>Array <span class="token operator">&amp;</span>B<span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> m<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		m <span class="token operator">=</span> l<span class="token operator">+</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// 防止溢出</span>
		<span class="token function">msort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>l<span class="token punctuation">,</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">msort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>m<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>l<span class="token punctuation">,</span>m<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// A[l,r)</span>
<span class="token keyword">void</span> <span class="token function">merge_sort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Array <span class="token function">B</span><span class="token punctuation">(</span>r<span class="token operator">-</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//申请一个同样大小的工作区</span>
	<span class="token function">msort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>B<span class="token punctuation">,</span>l<span class="token punctuation">,</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">see_array</span><span class="token punctuation">(</span>string arr_info<span class="token punctuation">,</span><span class="token keyword">const</span> Array <span class="token operator">&amp;</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	cout<span class="token operator">&lt;&lt;</span>arr_info <span class="token operator">&lt;&lt;</span><span class="token string">" { "</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> item<span class="token operator">:</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		cout<span class="token operator">&lt;&lt;</span>item<span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	cout<span class="token operator">&lt;&lt;</span><span class="token string">"}"</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Array arr<span class="token punctuation">{<!-- --></span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">45</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token comment">// merge(arr,0,3,arr.size());</span>
	<span class="token function">merge_sort</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span>arr<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">see_array</span><span class="token punctuation">(</span><span class="token string">"sorted "</span><span class="token punctuation">,</span>arr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="2__214"></a>2 原地归并排序</h2> 
<p>  不带优化的基本实现需要空间O(NLgN)，使用工作区也需要O(N)，可以不用额外空间原地排序吗？</p> 
<h3><a id="21__217"></a>2-1 死板的解法</h3> 
<p>  如下图，类比插入排序，通过比较<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          i 
         
        
       
      
        x_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          j 
         
        
       
      
        x_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.0572em;" class="mord mathnormal mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的大小确定把谁放在当前<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          i 
         
        
       
      
        x_i 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.5806em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>的位置上；注意到如果<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          j 
         
        
       
      
        x_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.0572em;" class="mord mathnormal mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>是更小的那个，需要把第一个序列整体向后移动一步，即覆盖掉<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          x 
         
        
          j 
         
        
       
      
        x_j 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7167em; vertical-align: -0.2861em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3117em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span style="margin-right: 0.0572em;" class="mord mathnormal mtight">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span></span>，这样一来归并排序降低为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         O 
        
       
         ( 
        
        
        
          N 
         
        
          2 
         
        
       
         ) 
        
       
      
        O(N^2) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0641em; vertical-align: -0.25em;"></span><span style="margin-right: 0.0278em;" class="mord mathnormal">O</span><span class="mopen">(</span><span class="mord"><span style="margin-right: 0.109em;" class="mord mathnormal">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>。</p> 
<center> 
 <img src="https://images2.imgbox.com/98/ca/O8KmOndH_o.png" width="80%"> 
</center>   修改后的归并方法如下： 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> <span class="token function">naive_merge</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span><span class="token keyword">int</span> l<span class="token punctuation">,</span><span class="token keyword">int</span> m<span class="token punctuation">,</span><span class="token keyword">int</span> r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> i<span class="token punctuation">;</span>
	Key tmp<span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>l<span class="token operator">&lt;</span>m <span class="token operator">&amp;&amp;</span> m<span class="token operator">&lt;</span>r<span class="token punctuation">;</span><span class="token operator">++</span>l<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>A<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>m<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			tmp<span class="token operator">=</span>A<span class="token punctuation">[</span>m<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//先保存，后覆盖</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>m<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>i<span class="token operator">&gt;</span>l<span class="token punctuation">;</span><span class="token operator">--</span>i<span class="token punctuation">)</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>i<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
			A<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token operator">=</span>tmp<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22__238"></a>2-2 原地工作区</h3> 
<p>   注意，这一节有<code>亿点点的</code>抽象，看不懂可以跳过。原地工作区的思路是借用数组未排序的部分<mark>复用为</mark>归并的工作区，稍作思考就会发现有几个问题：</p> 
<ol><li> <p>工作区一般是空白的，如果和未排序元素共用，会不会直接把原来的、还没有排序的数据给覆盖，造成数据丢失？</p> </li><li> <p>有序的子序列很大，自然意味着剩余未排序的空间小，那用这么小的工作区能完成归并任务吗？是不是和有序的子数组也会重叠呢？</p> </li></ol> 
<p>  先记下这些问题并直接给出方案，并逐渐改进使问题得到应对。</p> 
<center> 
 <img src="https://images2.imgbox.com/44/3c/jDBalhwO_o.png" width="50%"> 
</center> 
<p>  核心操作就是交换未排序的数据到子序列中，伪代码描述：</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> merge<span class="token punctuation">(</span>A,<span class="token punctuation">[</span>i,m<span class="token punctuation">)</span>,<span class="token punctuation">[</span>j,n<span class="token punctuation">)</span>,k<span class="token punctuation">)</span>:
    <span class="token keyword">while</span> i<span class="token operator">&lt;</span>m and j <span class="token operator">&lt;</span>n <span class="token keyword">do</span> 
        <span class="token keyword">if</span> A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">then</span>
            swap<span class="token punctuation">(</span>A<span class="token punctuation">[</span>k<span class="token punctuation">]</span>,A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
            i <span class="token operator">=</span>i+1
        <span class="token keyword">else</span> 
            swap<span class="token punctuation">(</span>A<span class="token punctuation">[</span>k<span class="token punctuation">]</span>,A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
            j <span class="token operator">=</span>j+1
        <span class="token assign-left variable">k</span><span class="token operator">=</span>k+1
    <span class="token keyword">while</span> i<span class="token operator">&lt;</span>m <span class="token keyword">do</span>
        swap<span class="token punctuation">(</span>A<span class="token punctuation">[</span>k<span class="token punctuation">]</span>,A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token assign-left variable">i</span><span class="token operator">=</span>i+1
        <span class="token assign-left variable">k</span><span class="token operator">=</span>k+1
    <span class="token keyword">while</span> j<span class="token operator">&lt;</span>n <span class="token keyword">do</span>
        swap<span class="token punctuation">(</span>A<span class="token punctuation">[</span>k<span class="token punctuation">]</span>,A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token assign-left variable">j</span><span class="token operator">=</span>j+1
        <span class="token assign-left variable">k</span><span class="token operator">=</span>k+1
</code></pre> 
<p>  考虑问题2，在工作区&gt;=待归并元素长的条件下，容易实现数组的一半有序，因为可以拿另一半作为工作区。接下来的问题是，剩下的一半怎么搞？再递归呢？如果直接归并1/4和1/2，未排序的复用空间明显不够用。</p> 
<center> 
 <img src="https://images2.imgbox.com/96/28/K9UPNgT5_o.png" width="45%"> 
</center> 
<p>  实际上，工作区可以和任何一个有序的子数组重叠，但是需要保证，尚未归并的元素不会被覆盖。所以，当归并1/4和1/2的元素时，我们可以把工作区放在正中间，允许它和有序的子数组重叠。</p> 
<center> 
 <img src="https://images2.imgbox.com/c1/59/tH2OBluZ_o.png" width="45%"> 
</center>   接下来，我们看两个极端的例子： 
<center> 
 <img src="https://images2.imgbox.com/f8/10/d5b0hRB6_o.png" width="45%"> 
</center> 
<center> 
 <img src="https://images2.imgbox.com/d8/70/G1jyaBjL_o.png" width="45%"> 
</center> 
<p>   其他正常的例子与特殊情况均可保证工作区被换到左侧。于是算法明确了：总是重复对未排序部分的<strong>前1/2</strong>进行排序，从而将有序的结果交换到前一半，而使得工作区位于中间。渐渐当工作区足够小，剩余一个元素等价于插入排序；实际上对于最后几个元素（20以内）完全可以直接插入排序。伪代码描述如下：</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> sort<span class="token punctuation">(</span>A,l,r<span class="token punctuation">)</span>
	<span class="token keyword">if</span> r-l<span class="token operator">&gt;</span><span class="token number">0</span> <span class="token keyword">then</span>
		m <span class="token operator">=</span> floor<span class="token punctuation">((</span>l+r<span class="token punctuation">)</span>/2<span class="token punctuation">)</span>
		w <span class="token operator">=</span> l+r-m <span class="token comment"># 工作区的起点</span>
		sort1<span class="token punctuation">(</span>A,l,m,w<span class="token punctuation">)</span>  <span class="token comment"># 保证后一半元素有序</span>
		<span class="token keyword">while</span> w -l <span class="token operator">&gt;</span><span class="token number">1</span> <span class="token keyword">do</span> <span class="token comment"># 工作区间不为空</span>
			nr <span class="token operator">=</span> w
			w <span class="token operator">=</span> ceil<span class="token punctuation">((</span>l+nr<span class="token punctuation">)</span>/2<span class="token punctuation">)</span>
			sort1<span class="token punctuation">(</span>A,w,nr,l<span class="token punctuation">)</span> <span class="token comment"># 同样递归对后1/2排序后放到前面</span>
			merge<span class="token punctuation">(</span>A,<span class="token punctuation">[</span>l,l+nr-w<span class="token punctuation">]</span>,<span class="token punctuation">[</span>nr,r<span class="token punctuation">]</span>,w<span class="token punctuation">)</span>
		<span class="token comment">## 改用插入排序</span>
		<span class="token keyword">for</span> i from w down-to l <span class="token keyword">do</span>
			j <span class="token operator">=</span>i
			<span class="token keyword">while</span> j <span class="token operator">&lt;=</span> r and A<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>j-1<span class="token punctuation">]</span> <span class="token keyword">do</span>
				swap<span class="token punctuation">(</span>A<span class="token punctuation">[</span>j<span class="token punctuation">]</span>,A<span class="token punctuation">[</span>j-1<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token assign-left variable">j</span><span class="token operator">=</span>j+1

<span class="token comment">#反向调用sort 用于交换工作区和有序部分</span>
<span class="token keyword">function</span> sort1<span class="token punctuation">(</span>A,l,r,w<span class="token punctuation">)</span>
	<span class="token keyword">if</span> r-l <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token keyword">then</span>
		m <span class="token operator">=</span> floor<span class="token punctuation">((</span>l+r<span class="token punctuation">)</span>/2<span class="token punctuation">)</span>
		sort<span class="token punctuation">(</span>A,l,m<span class="token punctuation">)</span>
		sort<span class="token punctuation">(</span>A,m+1,r<span class="token punctuation">)</span>
		merge<span class="token punctuation">(</span>A,<span class="token punctuation">[</span>l,m<span class="token punctuation">]</span>,<span class="token punctuation">[</span>m+1,r<span class="token punctuation">]</span>,w<span class="token punctuation">)</span> <span class="token comment">#排序并放到w开始的位置</span>
	<span class="token keyword">else</span> <span class="token comment">#将所有元素交换到工作区</span>
		<span class="token keyword">while</span> l<span class="token operator">&lt;=</span>r <span class="token keyword">do</span>
			swap<span class="token punctuation">(</span>A<span class="token punctuation">[</span>l<span class="token punctuation">]</span>,A<span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token punctuation">)</span>
			l <span class="token operator">=</span>l+1
			w <span class="token operator">=</span>w+1
</code></pre> 
<p>  注意虽然实现了原地归并，即O(1)的空间复杂度，但多了不少额外的交换操作。和使用额外工作区的版本相比，对十万个数字排序，速度下降了<code>60%</code>。C++ 详细实现如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span> <span class="token comment">//随机数组</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">using</span> Key <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">;</span>

<span class="token comment">// 定于一个区间</span>
<span class="token keyword">struct</span> <span class="token class-name">Range</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> l<span class="token punctuation">,</span> r<span class="token punctuation">;</span>
    <span class="token function">Range</span><span class="token punctuation">(</span><span class="token keyword">int</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span> b<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">l</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">r</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span> <span class="token keyword">int</span> right<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        l <span class="token operator">=</span> left<span class="token punctuation">;</span>
        r <span class="token operator">=</span> right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> r <span class="token operator">-</span> l<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment">//[l,r);</span>

<span class="token comment">// 封装C语言的数组</span>
<span class="token keyword">struct</span> <span class="token class-name">Array</span>
<span class="token punctuation">{<!-- --></span>
    Key <span class="token operator">*</span>arr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    
    <span class="token function">Array</span><span class="token punctuation">(</span><span class="token keyword">int</span> l<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">len</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        arr <span class="token operator">=</span> <span class="token punctuation">(</span>Key <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Key<span class="token punctuation">)</span> <span class="token operator">*</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">static</span> <span class="token keyword">const</span> <span class="token keyword">int</span> M<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">//在1~M范围内生成随机数</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> M <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    Key <span class="token operator">&amp;</span><span class="token keyword">operator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>arr <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Key <span class="token operator">&amp;</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>arr <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Key tmp <span class="token operator">=</span> <span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">at</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">at</span><span class="token punctuation">(</span>j<span class="token punctuation">)</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">exchange</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>B<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Key <span class="token operator">*</span>tmp <span class="token operator">=</span> arr<span class="token punctuation">;</span>
        arr <span class="token operator">=</span> B<span class="token punctuation">.</span>arr<span class="token punctuation">;</span>
        B<span class="token punctuation">.</span>arr <span class="token operator">=</span> tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">show</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> info<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span>info<span class="token operator">&lt;&lt;</span><span class="token string">"["</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            cout<span class="token operator">&lt;&lt;</span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        cout<span class="token operator">&lt;&lt;</span><span class="token string">"]."</span><span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// @brief 将数组A的两个区间的内容归并到start开始的区域</span>
<span class="token comment">/// @param A 原数组</span>
<span class="token comment">/// @param X 原数组的一个区间</span>
<span class="token comment">/// @param Y 另一个区间</span>
<span class="token comment">/// @param start 存放归并结果的开始位置</span>
<span class="token keyword">void</span> <span class="token function">merge</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span> Range <span class="token operator">&amp;</span>X<span class="token punctuation">,</span> Range <span class="token operator">&amp;</span>Y<span class="token punctuation">,</span> <span class="token keyword">int</span> start<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>X<span class="token punctuation">.</span>l <span class="token operator">&lt;</span> X<span class="token punctuation">.</span>r <span class="token operator">&amp;&amp;</span> Y<span class="token punctuation">.</span>l <span class="token operator">&lt;</span> Y<span class="token punctuation">.</span>r<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> now <span class="token operator">=</span> A<span class="token punctuation">[</span>X<span class="token punctuation">.</span>l<span class="token punctuation">]</span> <span class="token operator">&lt;</span> A<span class="token punctuation">[</span>Y<span class="token punctuation">.</span>l<span class="token punctuation">]</span> <span class="token operator">?</span> X<span class="token punctuation">.</span>l<span class="token operator">++</span> <span class="token operator">:</span> Y<span class="token punctuation">.</span>l<span class="token operator">++</span><span class="token punctuation">;</span>
        A<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>start<span class="token operator">++</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>X<span class="token punctuation">.</span>l <span class="token operator">&lt;</span> X<span class="token punctuation">.</span>r<span class="token punctuation">)</span>
        A<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>start<span class="token operator">++</span><span class="token punctuation">,</span> X<span class="token punctuation">.</span>l<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>Y<span class="token punctuation">.</span>l <span class="token operator">&lt;</span> Y<span class="token punctuation">.</span>r<span class="token punctuation">)</span>
        A<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>start<span class="token operator">++</span><span class="token punctuation">,</span> Y<span class="token punctuation">.</span>l<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">merge_sort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> m<span class="token punctuation">,</span> n<span class="token punctuation">,</span> w<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> l <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        m <span class="token operator">=</span> l <span class="token operator">+</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> l<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">// mid</span>
        w <span class="token operator">=</span> l <span class="token operator">+</span> r <span class="token operator">-</span> m<span class="token punctuation">;</span>       <span class="token comment">// 工作区的终点+1</span>
        <span class="token function">sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将前一半排序放到后一半</span>

        <span class="token comment">//[l,w]当前待排序的区间</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>w <span class="token operator">-</span> l <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            n <span class="token operator">=</span> w<span class="token punctuation">;</span>
            w <span class="token operator">=</span> l <span class="token operator">+</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> l <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token function">sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> w<span class="token punctuation">,</span> n<span class="token punctuation">,</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 排序后一半放到前面</span>
            Range <span class="token function">X</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> l <span class="token operator">+</span> n <span class="token operator">-</span> w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Y</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将两头有序数组合并</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 剩下一两个数作插入排序</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>n <span class="token operator">=</span> w<span class="token punctuation">;</span> n <span class="token operator">&gt;=</span> l<span class="token punctuation">;</span> <span class="token operator">--</span>n<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>m <span class="token operator">=</span> n<span class="token punctuation">;</span> m <span class="token operator">&lt;</span> r <span class="token operator">&amp;&amp;</span> A<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">&lt;</span> A<span class="token punctuation">[</span>m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token operator">++</span>m<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                A<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> m <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// @brief 把A[l,r)排序后，放到从下标w开始的区域</span>
<span class="token keyword">void</span> <span class="token function">sort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span> <span class="token keyword">int</span> l<span class="token punctuation">,</span> <span class="token keyword">int</span> r<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> m<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> l <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        m <span class="token operator">=</span> l <span class="token operator">+</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> l<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token function">merge_sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">merge_sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> m<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Range <span class="token function">X</span><span class="token punctuation">(</span>l<span class="token punctuation">,</span> m<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">Y</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> X<span class="token punctuation">,</span> Y<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>l <span class="token operator">&lt;</span> r<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            A<span class="token punctuation">.</span><span class="token function">swap</span><span class="token punctuation">(</span>l<span class="token operator">++</span><span class="token punctuation">,</span> w<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> len <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
    Array <span class="token function">A</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">"srcArr "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// test sort</span>
    <span class="token comment">//  sort(A,0,3,3);</span>

    <span class="token function">merge_sort</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token string">"sorted "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="23__497"></a>2-3 链表归并排序</h3> 
<p>  和数组存储类似，链表也需要均分为两个差不多长的子序列，这里使用一种<mark>奇偶分割法</mark>，简单说，从原链表头部摘下节点，交替放到两个不同的子链表中。伪代码说明：</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> split<span class="token punctuation">(</span>L<span class="token punctuation">)</span>:
	<span class="token punctuation">(</span>A,B<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token punctuation">(</span>null,null<span class="token punctuation">)</span>
	<span class="token keyword">while</span> L not null <span class="token keyword">do</span>
		ptr <span class="token operator">=</span> L <span class="token comment"># 当前头结点</span>
		L <span class="token operator">=</span> next<span class="token punctuation">(</span>L<span class="token punctuation">)</span> <span class="token comment"># 头指针后移</span>
		A <span class="token operator">=</span> link<span class="token punctuation">(</span>p,A<span class="token punctuation">)</span> <span class="token comment">#将p放到链表A的头部</span>
		swap<span class="token punctuation">(</span>A,B<span class="token punctuation">)</span> <span class="token comment"># 交换，下次换B被插入新元素</span>
	<span class="token builtin class-name">return</span> <span class="token punctuation">(</span>A,B<span class="token punctuation">)</span>
</code></pre> 
<p>  C++ 详细实现如下：</p> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token keyword">int</span> INF<span class="token operator">=</span><span class="token number">1e5</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> Key<span class="token operator">=</span><span class="token keyword">int</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> Array <span class="token operator">=</span>vector<span class="token operator">&lt;</span>Key<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token punctuation">{<!-- --></span>
	Key val<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span> nxt<span class="token punctuation">;</span>
	<span class="token function">Node</span><span class="token punctuation">(</span>Key k<span class="token punctuation">,</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span> next<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">val</span><span class="token punctuation">(</span>k<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">nxt</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> Nptr<span class="token operator">=</span><span class="token keyword">struct</span> <span class="token class-name">Node</span><span class="token operator">*</span> <span class="token punctuation">;</span>

Nptr <span class="token function">link</span><span class="token punctuation">(</span>Nptr pre<span class="token punctuation">,</span>Nptr old_head<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	pre<span class="token operator">-&gt;</span>nxt<span class="token operator">=</span>old_head<span class="token punctuation">;</span>
	<span class="token keyword">return</span> pre<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Nptr <span class="token function">mk_list</span><span class="token punctuation">(</span><span class="token keyword">const</span> Array <span class="token operator">&amp;</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Nptr head<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Nptr p<span class="token operator">=</span>head<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>x<span class="token operator">:</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		Nptr now<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Node</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
		p<span class="token operator">-&gt;</span>nxt<span class="token operator">=</span>now<span class="token punctuation">;</span>
		p<span class="token operator">=</span>now<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> head<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


Nptr <span class="token function">merge</span><span class="token punctuation">(</span>Nptr ap<span class="token punctuation">,</span>Nptr bp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Nptr head<span class="token operator">=</span><span class="token keyword">new</span> <span class="token function">Node</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//哨兵，头结点</span>
	Nptr p<span class="token operator">=</span>head<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ap <span class="token operator">&amp;&amp;</span> bp<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>ap<span class="token operator">-&gt;</span>val<span class="token operator">&lt;</span>bp<span class="token operator">-&gt;</span>val<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">link</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
			ap<span class="token operator">=</span>ap<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
			<span class="token function">link</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
			bp<span class="token operator">=</span>bp<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span> <span class="token function">link</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span> <span class="token function">link</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> head<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Nptr <span class="token function">msort</span><span class="token punctuation">(</span>Nptr L<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Nptr p<span class="token punctuation">,</span> ap<span class="token punctuation">,</span>bp<span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>L <span class="token operator">||</span> <span class="token operator">!</span>L<span class="token operator">-&gt;</span>nxt<span class="token punctuation">)</span> <span class="token keyword">return</span> L<span class="token punctuation">;</span>

	ap<span class="token operator">=</span>bp<span class="token operator">=</span><span class="token keyword">nullptr</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>L<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		p<span class="token operator">=</span>L<span class="token punctuation">;</span>
		L<span class="token operator">=</span>L<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
		ap<span class="token operator">=</span><span class="token function">link</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">swap</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	ap<span class="token operator">=</span><span class="token function">msort</span><span class="token punctuation">(</span>ap<span class="token punctuation">)</span><span class="token punctuation">;</span>
	bp<span class="token operator">=</span><span class="token function">msort</span><span class="token punctuation">(</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">merge</span><span class="token punctuation">(</span>ap<span class="token punctuation">,</span>bp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
	Array A<span class="token punctuation">{<!-- --></span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">56</span><span class="token punctuation">,</span><span class="token number">23</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">31</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	Nptr l<span class="token operator">=</span><span class="token function">mk_list</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
	l<span class="token operator">=</span><span class="token function">msort</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">;</span>

	Nptr p<span class="token operator">=</span>l<span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		cout<span class="token operator">&lt;&lt;</span>p<span class="token operator">-&gt;</span>val<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
		p<span class="token operator">=</span>p<span class="token operator">-&gt;</span>nxt<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">test_list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3__601"></a>3 自底向上归并排序</h2> 
<p>  不从整体开始切分，而是一开始把每一个元素当成一个列表，然后，自底向上地合并相邻的列表，重复利用开始的那张图。注意到，因为不同切分数组，可以<mark>直接迭代</mark>，<mark>无需递归</mark>。</p> 
<center> 
 <img src="https://images2.imgbox.com/e8/6f/4tjdgKU5_o.png" width="70%"> 
</center> 
<ul><li>首先获得N个子列表，每个子列表一个元素；</li><li>将相邻的两个子序列合并，得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
          / 
         
        
          2 
         
        
       
         n/2 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathnormal">n</span><span class="mord">/2</span></span></span></span></span>个长度为2的子序列；重复这个过程，直到整体有序。</li></ul> 
<p>  伪代码描述:</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> sort<span class="token punctuation">(</span>A<span class="token punctuation">)</span>:
	B <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span> <span class="token comment"># 存放列表的列表，设下标从1开始</span>
	<span class="token keyword">for</span> each a <span class="token keyword">in</span> A <span class="token keyword">do</span>
		B.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>a<span class="token punctuation">}</span><span class="token punctuation">)</span>   <span class="token comment"># 存入N个长度为1的子列表</span>
	
	N <span class="token operator">=</span> B.length
	while<span class="token punctuation">(</span>N<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> i from <span class="token number">1</span> to floor<span class="token punctuation">(</span>N/2<span class="token punctuation">)</span> <span class="token keyword">do</span>
			B<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> merge<span class="token punctuation">(</span>B<span class="token punctuation">[</span>2i-1<span class="token punctuation">]</span>,B<span class="token punctuation">[</span>2i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token comment"># 每次取头两个合并</span>
		<span class="token keyword">if</span> Odd<span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token keyword">then</span>
			B<span class="token punctuation">[</span>ceil<span class="token punctuation">(</span>N/2<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> B<span class="token punctuation">[</span>N<span class="token punctuation">]</span> <span class="token comment"># 处理落单的</span>
		N <span class="token operator">=</span> ceil<span class="token punctuation">(</span>N/2<span class="token punctuation">)</span> <span class="token comment"># 向上取整</span>
	<span class="token keyword">if</span> B is empty <span class="token keyword">then</span>
		<span class="token builtin class-name">return</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
	<span class="token builtin class-name">return</span> B<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
</code></pre> 
<p>  严蔚敏的《数据结构（C语言版）》给出一种实现如下，写得真好：</p> 
<pre><code class="prism language-c"><span class="token comment">/********************************************************
*函数名称：Merge
*参数说明：pDataArray 无序数组；
 *          int *pTempArray 临时存储合并后的序列
 *          bIndex 需要合并的序列1的起始位置
 *          mIndex 需要合并的序列1的结束位置
                  并且作为序列2的起始位置
 *          eIndex 需要合并的序列2的结束位置
*说明：    将数组中连续的两个子序列合并为一个有序序列
*********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">Merge</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> pDataArray<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>pTempArray<span class="token punctuation">,</span> <span class="token keyword">int</span> bIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> mIndex<span class="token punctuation">,</span> <span class="token keyword">int</span> eIndex<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> mLength <span class="token operator">=</span> eIndex <span class="token operator">-</span> bIndex<span class="token punctuation">;</span>    <span class="token comment">//合并后的序列长度</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token comment">//记录合并后序列插入数据的偏移</span>
	<span class="token keyword">int</span> j <span class="token operator">=</span> bIndex<span class="token punctuation">;</span>    <span class="token comment">//记录子序列1插入数据的偏移</span>
	<span class="token keyword">int</span> k <span class="token operator">=</span> mIndex<span class="token punctuation">;</span>    <span class="token comment">//记录子序列2掺入数据的偏移</span>
 
	<span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> mIndex <span class="token operator">&amp;&amp;</span> k <span class="token operator">&lt;</span> eIndex<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pDataArray<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> pDataArray<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			pTempArray<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> pDataArray<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
			j<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			pTempArray<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> pDataArray<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
			k<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
 
	<span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">==</span> mIndex<span class="token punctuation">)</span>    <span class="token comment">//说明序列1已经插入完毕</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>k <span class="token operator">&lt;</span> eIndex<span class="token punctuation">)</span>
			pTempArray<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> pDataArray<span class="token punctuation">[</span>k<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>                <span class="token comment">//说明序列2已经插入完毕</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> mIndex<span class="token punctuation">)</span>
			pTempArray<span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> pDataArray<span class="token punctuation">[</span>j<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
	<span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> mLength<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>    <span class="token comment">//将合并后序列重新放入pDataArray</span>
		pDataArray<span class="token punctuation">[</span>bIndex <span class="token operator">+</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> pTempArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
 
<span class="token comment">/********************************************************
*函数名称：BottomUpMergeSort
*参数说明：pDataArray 无序数组；
 * 	   iDataNum为无序数据个数
*说明：    自底向上的归并排序
*********************************************************/</span>
<span class="token keyword">void</span> <span class="token function">BottomUpMergeSort</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> pDataArray<span class="token punctuation">,</span> <span class="token keyword">int</span> iDataNum<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> <span class="token operator">*</span>pTempArray <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token operator">*</span> iDataNum<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">//临时存放合并后的序列</span>
	<span class="token keyword">int</span> length <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token comment">//初始有序子序列长度为1</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;</span> iDataNum<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>length <span class="token operator">&lt;</span> iDataNum<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token number">2</span><span class="token operator">*</span>length<span class="token punctuation">)</span>
			<span class="token function">Merge</span><span class="token punctuation">(</span>pDataArray<span class="token punctuation">,</span> pTempArray<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i <span class="token operator">+</span> length<span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">2</span><span class="token operator">*</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> length <span class="token operator">&lt;</span> iDataNum<span class="token punctuation">)</span>
			<span class="token function">Merge</span><span class="token punctuation">(</span>pDataArray<span class="token punctuation">,</span> pTempArray<span class="token punctuation">,</span> i<span class="token punctuation">,</span> i <span class="token operator">+</span> length<span class="token punctuation">,</span> iDataNum<span class="token punctuation">)</span><span class="token punctuation">;</span>
		length <span class="token operator">*=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">//有序子序列长度*2</span>
	<span class="token punctuation">}</span>
	<span class="token function">free</span><span class="token punctuation">(</span>pTempArray<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>  几点说明:</p> 
<ul><li>length代表的是单个子序列的长度；</li><li>pTempArray 是上述文章提到的统一的工作区</li><li>实际排序时，并没有分为多个数组，而是只针对下标作逻辑上的合并，数据还在原来的数组中。 
  <ul><li>每次需要合并的两部分是 <code>A[i,i+length) 和 A[i+length,i+2*length)</code>注意右边界取不到。</li><li>下一次只需要把长度值翻倍即可，省去了许多开辟、释放空间的时间。</li></ul> </li></ul> 
<center> 
 <img src="https://images2.imgbox.com/85/bf/AeZ1EyJt_o.png" width="80%"> 
</center> 
<h2><a id="4__709"></a>4 两路自然归并排序</h2> 
<p>  从一个例子说起，如下图。虽然整个序列是混乱的，但是总有些部分是<mark>自然有序的</mark>（最差是一个数）；想象一个两头都被点燃的蜡烛，同样的，我们从序列的两头<mark>同时开始</mark>寻找一个<strong>非递减</strong>的序列，如图中左右两端的 [8,12,14]和[15,7]，合并到最右端；下一次找到后，合并到最最左端，这样做是为了平衡。</p> 
<center> 
 <img src="https://images2.imgbox.com/f1/98/FSjnTPVQ_o.png" width="96%"> 
</center> 
<p>  <strong>注意</strong>，上图数据归并后，左边是非递减，右边是<mark>非递增</mark>；且并不是一次完成所有的数据有序，而是多段有序，下面会进一步解释。</p> 
<h3><a id="41__716"></a>4-1 形式化描述</h3> 
<p>  自然归并排序的不变性质，如下图所示：</p> 
<center> 
 <img src="https://images2.imgbox.com/4b/f1/aNYwNxbI_o.png" width="96%"> 
</center> 
<ol><li>任何时候，a之前和d之后的元素已经被扫描并归并到工作区的左右两端。</li><li>每次都需要将非递减子序列<code>[a,b)</code>扩展到最长，同样的将<code>[c,d)</code>向左扩展到最长。</li><li><code>f</code>（front）之前和<code>r</code>（rear）之后的元素是已经处理过的，可能包含若干有序的子序列，并非直接有序。</li><li>奇数轮归并到<code>f</code>这一边，偶数轮归并到<code>r</code>那一边。</li><li>关键中的关键，当扫描一轮后，原数组和工作区交换，继续归并，此时原数组（指针）指向工作区，且有序的子序列明显增多。</li></ol> 
<p>  给出伪代码描述，如果还是看不明白建议抄一下伪代码：</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> sort<span class="token punctuation">(</span>A<span class="token punctuation">)</span>:
	<span class="token keyword">if</span> A.length <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token keyword">then</span>
		n <span class="token operator">=</span> A.length
		B <span class="token operator">=</span> creat-array<span class="token punctuation">(</span>n<span class="token punctuation">)</span> <span class="token comment"># 创建工作区</span>
		loop 
			<span class="token punctuation">[</span>a,b<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">1,1</span><span class="token punctuation">)</span>
			<span class="token punctuation">[</span>c,d<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>n+1,n+1<span class="token punctuation">)</span>
			f <span class="token operator">=</span> <span class="token number">1</span>,r <span class="token operator">=</span> n  <span class="token comment"># 工作区的首尾指针</span>
			t <span class="token operator">=</span> False <span class="token comment"># 控制从f还是r归并</span>
			<span class="token keyword">while</span> b <span class="token operator">&lt;</span> c <span class="token keyword">do</span>
				repeat 
					b <span class="token operator">=</span> b+1
				<span class="token keyword">until</span> b <span class="token operator">&gt;=</span> c <span class="token operator">||</span> A<span class="token punctuation">[</span>b<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>b-1<span class="token punctuation">]</span>
				repeat
					c <span class="token operator">=</span> c-1
				<span class="token keyword">until</span> c<span class="token operator">&lt;=</span>b <span class="token operator">||</span> A<span class="token punctuation">[</span>c-1<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>c<span class="token punctuation">]</span>
				<span class="token keyword">if</span> c <span class="token operator">&lt;</span> b <span class="token keyword">then</span> <span class="token comment"># 避免overlap 重叠</span>
					c <span class="token operator">=</span> b
				<span class="token keyword">if</span> b-a <span class="token operator">&gt;=</span>n <span class="token keyword">then</span> <span class="token comment"># 整个数组已经有序</span>
					<span class="token builtin class-name">return</span> A
				<span class="token keyword">if</span> t <span class="token keyword">then</span> <span class="token comment"># 从front归并</span>
					f <span class="token operator">=</span> merge<span class="token punctuation">(</span>A,<span class="token punctuation">[</span>a,b<span class="token punctuation">)</span>,<span class="token punctuation">[</span>c,d<span class="token punctuation">)</span>,B,f,1<span class="token punctuation">)</span>
				<span class="token keyword">else</span> <span class="token comment">#从rear归并</span>
				 	r <span class="token operator">=</span> merge<span class="token punctuation">(</span>A,<span class="token punctuation">[</span>a,b<span class="token punctuation">)</span>,<span class="token punctuation">[</span>c,d<span class="token punctuation">)</span>,B,r,-1<span class="token punctuation">)</span>
				a <span class="token operator">=</span> b
				d <span class="token operator">=</span> c
				t <span class="token operator">=</span> not t <span class="token comment"># 换方向</span>
			exchange A<span class="token operator">&lt;</span>-<span class="token operator">&gt;</span>B   <span class="token comment"># 关键的一步，切换工作区</span>
		<span class="token builtin class-name">return</span> A

<span class="token comment"># w 是工作区归并边界的下标 f 或 r</span>
<span class="token comment"># det 表示方向 +1 或 -1</span>
<span class="token keyword">function</span> merge<span class="token punctuation">(</span>A,<span class="token punctuation">[</span>a,b<span class="token punctuation">)</span>,<span class="token punctuation">[</span>c,d<span class="token punctuation">)</span>,B,w,det<span class="token punctuation">)</span>:
	<span class="token keyword">while</span> a<span class="token operator">&lt;</span>b and c<span class="token operator">&lt;</span>d <span class="token keyword">do</span>
		<span class="token keyword">if</span> A<span class="token punctuation">[</span>a<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>d-1<span class="token punctuation">]</span> <span class="token keyword">then</span>
			B<span class="token punctuation">[</span>w<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>a<span class="token punctuation">]</span>
			a <span class="token operator">=</span>a + <span class="token number">1</span>
		<span class="token keyword">else</span>
			B<span class="token punctuation">[</span>w<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>d-1<span class="token punctuation">]</span>
			d <span class="token operator">=</span> d-1
		w <span class="token operator">=</span> w+det

		<span class="token keyword">while</span> a <span class="token operator">&lt;</span> b <span class="token keyword">do</span>
			B<span class="token punctuation">[</span>w<span class="token punctuation">]</span> <span class="token operator">=</span> A<span class="token punctuation">[</span>a<span class="token punctuation">]</span>
			<span class="token assign-left variable">a</span><span class="token operator">=</span>a+1
			<span class="token assign-left variable">w</span><span class="token operator">=</span>w+det	

		<span class="token keyword">while</span> c <span class="token operator">&lt;</span> d <span class="token keyword">do</span>
			B<span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>d-1<span class="token punctuation">]</span>
			<span class="token assign-left variable">d</span><span class="token operator">=</span>d-1
			<span class="token assign-left variable">w</span><span class="token operator">=</span>w+det
	<span class="token builtin class-name">return</span> w
</code></pre> 
<h3><a id="42__786"></a>4-2 代码实现</h3> 
<p>  一些说明：</p> 
<ul><li>为了提高可读性，封装了C语言下的数组指针和区间类Range</li><li>参数很多时，建议先声明，然后统一赋值；注意到下标得到赋值在每一轮都需要更新</li></ul> 
<pre><code class="prism language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cmath&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;ctime&gt;</span> <span class="token comment">//随机数组</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>

<span class="token keyword">using</span> Key <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">;</span>

<span class="token comment">// 定义一个左闭右开的区间</span>
<span class="token keyword">struct</span> <span class="token class-name">Range</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> l<span class="token punctuation">,</span>r<span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">int</span> left<span class="token punctuation">,</span><span class="token keyword">int</span> right<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        l<span class="token operator">=</span>left<span class="token punctuation">;</span>
        r<span class="token operator">=</span>right<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> <span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> r<span class="token operator">-</span>l<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//[l,r);</span>

<span class="token comment">// 封装C语言的数组</span>
<span class="token keyword">struct</span> <span class="token class-name">Array</span>
<span class="token punctuation">{<!-- --></span>
    Key<span class="token operator">*</span> arr<span class="token punctuation">;</span>
    <span class="token keyword">int</span> len<span class="token punctuation">;</span>
    <span class="token function">Array</span><span class="token punctuation">(</span><span class="token keyword">int</span> len<span class="token punctuation">)</span><span class="token operator">:</span><span class="token function">len</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        arr<span class="token operator">=</span><span class="token punctuation">(</span>Key<span class="token operator">*</span><span class="token punctuation">)</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>Key<span class="token punctuation">)</span><span class="token operator">*</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Key<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>arr<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Key<span class="token operator">&amp;</span> <span class="token function">at</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>arr<span class="token operator">+</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">void</span> <span class="token function">exchange</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>B<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        Key<span class="token operator">*</span> tmp<span class="token operator">=</span>arr<span class="token punctuation">;</span>
        arr<span class="token operator">=</span>B<span class="token punctuation">.</span>arr<span class="token punctuation">;</span>
        B<span class="token punctuation">.</span>arr<span class="token operator">=</span>tmp<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token comment">/// @brief 合并A的两个区间 Up Down到工作区B的w开始处</span>
<span class="token comment">/// @param A 源序列</span>
<span class="token comment">/// @param Up 位于左边的非递减序列</span>
<span class="token comment">/// @param Down 位于右边的非递增序列</span>
<span class="token comment">/// @param B 工作区，和源序列同样大</span>
<span class="token comment">/// @param w 工作区的归并起点</span>
<span class="token comment">/// @param det 控制w的增长方向,+1 or -1</span>
<span class="token comment">/// @return 归并后的w值</span>
<span class="token keyword">int</span> <span class="token function">merge</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">,</span> Range <span class="token operator">&amp;</span>Up<span class="token punctuation">,</span> Range <span class="token operator">&amp;</span>Down<span class="token punctuation">,</span>
          Array <span class="token operator">&amp;</span>B<span class="token punctuation">,</span> <span class="token keyword">int</span> w<span class="token punctuation">,</span> <span class="token keyword">int</span> det<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>Up<span class="token punctuation">.</span>l<span class="token operator">&lt;</span>Up<span class="token punctuation">.</span>r <span class="token operator">&amp;&amp;</span> Down<span class="token punctuation">.</span>l<span class="token operator">&lt;</span>Down<span class="token punctuation">.</span>r<span class="token punctuation">;</span>w<span class="token operator">+=</span>det<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        B<span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token operator">=</span> <span class="token punctuation">(</span>A<span class="token punctuation">[</span>Up<span class="token punctuation">.</span>l<span class="token punctuation">]</span><span class="token operator">&lt;</span>A<span class="token punctuation">[</span>Down<span class="token punctuation">.</span>r<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span> A<span class="token punctuation">[</span>Up<span class="token punctuation">.</span>l<span class="token operator">++</span><span class="token punctuation">]</span><span class="token operator">:</span>A<span class="token punctuation">[</span><span class="token operator">--</span>Down<span class="token punctuation">.</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 收尾工作</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>Up<span class="token punctuation">.</span>l<span class="token operator">&lt;</span>Up<span class="token punctuation">.</span>r<span class="token punctuation">;</span>w<span class="token operator">+=</span>det<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        B<span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span>Up<span class="token punctuation">.</span>l<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>Down<span class="token punctuation">.</span>l<span class="token operator">&lt;</span>Down<span class="token punctuation">.</span>r<span class="token punctuation">;</span>w<span class="token operator">+=</span>det<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        B<span class="token punctuation">[</span>w<span class="token punctuation">]</span><span class="token operator">=</span>A<span class="token punctuation">[</span><span class="token operator">--</span>Down<span class="token punctuation">.</span>r<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> w<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

Array<span class="token operator">&amp;</span> <span class="token function">merge_sort</span><span class="token punctuation">(</span>Array <span class="token operator">&amp;</span>A<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span>len<span class="token operator">&lt;</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">return</span> A<span class="token punctuation">;</span>

    Array <span class="token function">B</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//申请工作区</span>
    Range Up<span class="token punctuation">,</span>Down<span class="token punctuation">;</span> <span class="token comment">//左边的非递减区间，右边的非递增区间</span>
    <span class="token keyword">int</span> front<span class="token punctuation">,</span>rear<span class="token punctuation">,</span>dir<span class="token punctuation">;</span><span class="token comment">//工作区的前后指针和方向</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        Up<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Down<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>A<span class="token punctuation">.</span>len<span class="token punctuation">,</span>A<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
        front<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        rear<span class="token operator">=</span>A<span class="token punctuation">.</span>len<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        dir<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">while</span><span class="token punctuation">(</span>Up<span class="token punctuation">.</span>r<span class="token operator">&lt;</span>Down<span class="token punctuation">.</span>l<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">++</span>Up<span class="token punctuation">.</span>r<span class="token punctuation">;</span> <span class="token comment">// 寻找非递减序列的右边界</span>
            <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>Up<span class="token punctuation">.</span>r<span class="token operator">&lt;</span>Down<span class="token punctuation">.</span>l <span class="token operator">&amp;&amp;</span> A<span class="token punctuation">[</span>Up<span class="token punctuation">.</span>r<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span>A<span class="token punctuation">[</span>Up<span class="token punctuation">.</span>r<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
            <span class="token keyword">do</span><span class="token punctuation">{<!-- --></span>
                <span class="token operator">--</span>Down<span class="token punctuation">.</span>l<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">while</span><span class="token punctuation">(</span>Up<span class="token punctuation">.</span>r<span class="token operator">&lt;</span>Down<span class="token punctuation">.</span>l <span class="token operator">&amp;&amp;</span> A<span class="token punctuation">[</span>Down<span class="token punctuation">.</span>l<span class="token punctuation">]</span><span class="token operator">&lt;=</span>A<span class="token punctuation">[</span>Down<span class="token punctuation">.</span>l<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span><span class="token punctuation">(</span>Down<span class="token punctuation">.</span>l<span class="token operator">&lt;</span>Up<span class="token punctuation">.</span>r<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                Down<span class="token punctuation">.</span>l<span class="token operator">=</span>Up<span class="token punctuation">.</span>r<span class="token punctuation">;</span> <span class="token comment">//消除可能的重叠</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 出口，已经有序</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>Up<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">&gt;=</span>A<span class="token punctuation">.</span>len<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> A<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>dir<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                front<span class="token operator">=</span><span class="token function">merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>Up<span class="token punctuation">,</span>Down<span class="token punctuation">,</span>B<span class="token punctuation">,</span>front<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                rear<span class="token operator">=</span><span class="token function">merge</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span>Up<span class="token punctuation">,</span>Down<span class="token punctuation">,</span>B<span class="token punctuation">,</span>rear<span class="token punctuation">,</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            Up<span class="token punctuation">.</span>l<span class="token operator">=</span>Up<span class="token punctuation">.</span>r<span class="token punctuation">;</span>
            Down<span class="token punctuation">.</span>r<span class="token operator">=</span>Down<span class="token punctuation">.</span>l<span class="token punctuation">;</span><span class="token comment">// 跳过已经扫描的部分</span>
            dir<span class="token operator">=</span><span class="token operator">!</span>dir<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        A<span class="token punctuation">.</span><span class="token function">exchange</span><span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> A<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token keyword">const</span> <span class="token keyword">int</span>  len<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span>
    Array <span class="token function">A</span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">srand</span><span class="token punctuation">(</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        A<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">=</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">%</span><span class="token number">25</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
        cout<span class="token operator">&lt;&lt;</span>A<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cout<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>

    <span class="token function">merge_sort</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>len<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        cout<span class="token operator">&lt;&lt;</span>A<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    cout<span class="token operator">&lt;&lt;</span>endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/572c839ef15ccd3924cc129126ae4dd9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Protobuf-net3.2.8中的protogen.exe之使用</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7df1d1896029ff94771db37e89993fed/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java中printf与println的区别(最详细）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>