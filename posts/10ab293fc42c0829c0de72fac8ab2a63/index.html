<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【单片机学习笔记】Windows&#43;Vscode&#43;STM32F4&#43;freeRTOS&#43;FatFs gcc环境搭建 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【单片机学习笔记】Windows&#43;Vscode&#43;STM32F4&#43;freeRTOS&#43;FatFs gcc环境搭建" />
<meta property="og:description" content="为摒弃在接受keil邮件，研究了下gun编译，以STM32F407为例，简单记录
1. 软件包准备 Git
选择对应版本直接安装即可https://git-scm.com/download/winmakegcc
​
1）将上述软件包放置于C盘根目录
2）添加环境变量
3）cmd命令行测试环境
分别输入
make -v gcc -v 2. 编写makefile # ------------------------------------------------ # # @file Makefile (based on gcc) # @author urien # @version v1.0.0 # # ChangeLog : # 2023-10-20 # ------------------------------------------------ ###################################### # target ###################################### TARGET = update ###################################### # building variables ###################################### # debug build? DEBUG = 1 # optimization OPT = -Og ####################################### # paths ####################################### # Build path BUILD_DIR = build ###################################### # source ###################################### # C sources C_DIRS &#43;= ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/10ab293fc42c0829c0de72fac8ab2a63/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-23T23:11:10+08:00" />
<meta property="article:modified_time" content="2023-10-23T23:11:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【单片机学习笔记】Windows&#43;Vscode&#43;STM32F4&#43;freeRTOS&#43;FatFs gcc环境搭建</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>为摒弃在接受keil邮件，研究了下gun编译，以STM32F407为例，简单记录</p> 
<h3><a id="1__1"></a>1. 软件包准备</h3> 
<ul><li>Git<br> 选择对应版本直接安装即可https://git-scm.com/download/win</li><li>make</li><li>gcc<br> ​<img src="https://images2.imgbox.com/5d/c7/OGxIeLAP_o.png" alt="在这里插入图片描述"><br> 1）将上述软件包放置于C盘根目录<br> <img src="https://images2.imgbox.com/16/a8/YyMXnwxA_o.png" alt="在这里插入图片描述"><br> 2）添加环境变量<br> <img src="https://images2.imgbox.com/b9/fb/A871Kadk_o.png" alt="在这里插入图片描述"></li></ul> 
<p>3）cmd命令行测试环境<br> 分别输入</p> 
<pre><code>make -v
gcc -v
</code></pre> 
<p><img src="https://images2.imgbox.com/5a/f9/OJSxQgTr_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/8b/f5/rNS0jn9Y_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2_makefile_22"></a>2. 编写makefile</h3> 
<pre><code class="prism language-makefile"># ------------------------------------------------
#
# @file Makefile (based on gcc)
# @author urien
# @version v1.0.0
#
# ChangeLog :
#   2023-10-20
# ------------------------------------------------

######################################
# target
######################################
TARGET = update


######################################
# building variables
######################################
# debug build?
DEBUG = 1
# optimization
OPT = -Og


#######################################
# paths
#######################################
# Build path
BUILD_DIR = build

######################################
# source
######################################
# C sources
C_DIRS += ../Libraries/FreeRTOS
C_DIRS += ../Libraries/FreeRTOS/portable/GCC/ARM_CM4F
C_DIRS += ../Libraries/CMSIS/Device/ST/STM32F4xx/Source
C_DIRS += ../Libraries/STM32F4xx_StdPeriph_Driver/src
C_DIRS += ../User/app
C_DIRS += ../User/bsp
C_DIRS += ../User/mid
C_DIRS += ../User/misc
C_DIRS += ../User/gui/app
C_DIRS += ../User/gui/lib
C_DIRS += ../User/usb
C_DIRS += ../Libraries/FATFS/source
C_DIRS += ../Libraries/STM32_USB_HOST_Library/Core/src
C_DIRS += ../Libraries/STM32_USB_HOST_Library/Class/MSC/src
C_DIRS += ../Libraries/PDF 
SRC_OBJS_DIRS += $(foreach DIR, $(C_DIRS), $(wildcard $(DIR)/*.c))
C_SOURCES = $(SRC_OBJS_DIRS) \
../Libraries/FreeRTOS/portable/MemMang/heap_4.c \
../Libraries/STM32_USB_OTG_Driver/src/usb_core.c \
../Libraries/STM32_USB_OTG_Driver/src/usb_hcd.c \
../Libraries/STM32_USB_OTG_Driver/src/usb_hcd_int.c \

# Core/Src/main.c \
# Core/Src/fr


# ASM sources
ASM_SOURCES =  \
startup_stm32f407xx.s


#######################################
# binaries
#######################################
PREFIX = arm-none-eabi-
# The gcc compiler bin path can be either defined in make command via GCC_PATH variable (&gt; make GCC_PATH=xxx)
# either it can be added to the PATH environment variable.
ifdef GCC_PATH
CC = $(GCC_PATH)/$(PREFIX)gcc
AS = $(GCC_PATH)/$(PREFIX)gcc -x assembler-with-cpp
CP = $(GCC_PATH)/$(PREFIX)objcopy
SZ = $(GCC_PATH)/$(PREFIX)size
else
CC = $(PREFIX)gcc
AS = $(PREFIX)gcc -x assembler-with-cpp
CP = $(PREFIX)objcopy
SZ = $(PREFIX)size
endif
HEX = $(CP) -O ihex
BIN = $(CP) -O binary -S
 
#######################################
# CFLAGS
#######################################
# cpu
CPU = -mcpu=cortex-m4

# fpu
FPU = -mfpu=fpv4-sp-d16

# float-abi
FLOAT-ABI = -mfloat-abi=hard

# mcu
MCU = $(CPU) -mthumb $(FPU) $(FLOAT-ABI)

# macros for gcc
# AS defines
AS_DEFS = 

# C defines
C_DEFS =  \
-DSTM32F407xx \
-DSTM32F40_41xxx \
-DUSE_STDPERIPH_DRIVER \
-DUSE_USB_OTG_FS \
-DUSER_VECT_TAB_ADDRESS \
# -D__FPU_PRESENT \
# -D__FPU_USED \

# AS includes
AS_INCLUDES =  

# C includes

C_INCS += ../Libraries/CMSIS/Include
C_INCS += ../Libraries/CMSIS/Core/Include
C_INCS += ../Libraries/CMSIS/Device/ST/STM32F4xx/Include
C_INCS += ../Libraries/STM32F4xx_StdPeriph_Driver/inc
C_INCS += ../Libraries/FreeRTOS/include
C_INCS += ../Libraries/FreeRTOS/GCC/ARM_CM4F
C_INCS += ../Libraries/FreeRTOS/portable/GCC/ARM_CM4F
C_INCS += ../Libraries/PDF
C_INCS += ../User/app
C_INCS += ../User/bsp
C_INCS += ../User/mid
C_INCS += ../User/misc
C_INCS += ../User/gui/app
C_INCS += ../User/gui/lib
C_INCS += ../User/usb
C_INCS += ../Libraries/STM32_USB_OTG_Driver/inc
C_INCS += ../Libraries/STM32_USB_HOST_Library/Class/MSC/inc
C_INCS += ../Libraries/STM32_USB_HOST_Library/Core/inc
C_INCS += ../Libraries/FATFS/source
INCS_OBJS_DIR = $(foreach DIR2, $(C_INCS), $(wildcard $(DIR2)/*.h))
INCS_OBJS_PATH = $(sort $(dir $(INCS_OBJS_DIR)))
C_INCLUDES = $(addprefix -I,$(INCS_OBJS_PATH)) \


# compile gcc flags
ASFLAGS = $(MCU) $(AS_DEFS) $(AS_INCLUDES) $(OPT) -Wall -fdata-sections -ffunction-sections

CFLAGS += $(MCU) $(C_DEFS) $(C_INCLUDES) $(OPT) -Wall -fdata-sections -ffunction-sections

ifeq ($(DEBUG), 1)
CFLAGS += -g -gdwarf-2
endif


# Generate dependency information
CFLAGS += -MMD -MP -MF"$(@:%.o=%.d)"


#######################################
# LDFLAGS
#######################################
# link script
LDSCRIPT = STM32F407VGTx_FLASH.ld

# libraries
LIBS = -lc -lm -lnosys 
LIBDIR = 
# LDFLAGS += -lc -lrdimon -u _printf_float
# LDFLAGS += -specs=nano.specs
LDFLAGS += $(MCU) -T$(LDSCRIPT) $(LIBDIR) $(LIBS) -Wl,-Map=$(BUILD_DIR)/$(TARGET).map,--cref -Wl,--gc-sections

# default action: build all
all: $(BUILD_DIR)/$(TARGET).elf $(BUILD_DIR)/$(TARGET).hex $(BUILD_DIR)/$(TARGET).bin


#######################################
# build the application
#######################################
# list of objects
OBJECTS = $(addprefix $(BUILD_DIR)/,$(notdir $(C_SOURCES:.c=.o)))
vpath %.c $(sort $(dir $(C_SOURCES)))
# list of ASM program objects
OBJECTS += $(addprefix $(BUILD_DIR)/,$(notdir $(ASM_SOURCES:.s=.o)))
vpath %.s $(sort $(dir $(ASM_SOURCES)))

$(BUILD_DIR)/%.o: %.c Makefile | $(BUILD_DIR) 
	$(CC) -c $(CFLAGS) -Wa,-a,-ad,-alms=$(BUILD_DIR)/$(notdir $(&lt;:.c=.lst)) $&lt; -o $@

$(BUILD_DIR)/%.o: %.s Makefile | $(BUILD_DIR)
	$(AS) -c $(CFLAGS) $&lt; -o $@

$(BUILD_DIR)/$(TARGET).elf: $(OBJECTS) Makefile
	$(CC) $(OBJECTS) $(LDFLAGS) -o $@
	$(SZ) $@

$(BUILD_DIR)/%.hex: $(BUILD_DIR)/%.elf | $(BUILD_DIR)
	$(HEX) $&lt; $@
	
$(BUILD_DIR)/%.bin: $(BUILD_DIR)/%.elf | $(BUILD_DIR)
	$(BIN) $&lt; $@	
	
$(BUILD_DIR):
	mkdir $@		

#######################################
# clean up
#######################################
clean:
	-rm -fR $(BUILD_DIR)
  
#######################################
# dependencies
#######################################
-include $(wildcard $(BUILD_DIR)/*.d)

#######################################
# download .hex/.bin by jlink
#######################################
#Your JLink installation directory
PATH_WINPC = 'C:/Program Files (x86)/SEGGER/JLink/'
#PATH_LINUX = /opt/SEGGER/JLink_V640b/JLinkExe
JK_DPATH = $(PATH_WINPC)
#Jlink script store directory
JKS_DIR = .
#Chip type
CHIP_TYPE = STM32F407VG
flash:
	@$(JK_DPATH)JLink.exe -device $(CHIP_TYPE) -if SWD -speed 4000 -autoconnect 1 -CommanderScript $(JKS_DIR)/flash.jlink
	@echo "Download Completed!"

debug:
	@$(JK_DPATH)JLinkGDBServer.exe -select USB -device $(CHIP_TYPE) -if SWD -speed auto -noir -LocalhostOnly

# *** EOF ***
</code></pre> 
<h3><a id="3___CC_ARM__GUNC___261"></a>3. __CC_ARM转__GUNC__注意</h3> 
<h5><a id="LD_263"></a>启动文件及LD文件</h5> 
<pre><code>通过CubeMx工具生成即可
</code></pre> 
<h5><a id="_268"></a>目录路径表示问题</h5> 
<pre><code class="prism language-c"><span class="token comment">// __CC_ARM环境</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DBG_PATH_DIR</span> <span class="token char">'\\'</span>		   <span class="token comment">// 目录结构</span></span>
<span class="token comment">// __GUNC__环境</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DBG_PATH_DIR</span> <span class="token char">'/'</span>		   <span class="token comment">// 目录结构</span></span>
</code></pre> 
<h5><a id="_277"></a>字节对齐及指定位置存储问题</h5> 
<pre><code class="prism language-c"><span class="token comment">// __CC_ARM环境</span>
<span class="token function">__align</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> ucaMemPool<span class="token punctuation">[</span>MEM_MAX_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 内存池(32字节对齐)</span>
<span class="token comment">// __GUNC__环境</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span>  </span><span class="token comment">// 内存池(32字节对齐)</span></span>
<span class="token keyword">unsigned</span> <span class="token keyword">char</span> ucaMemPool<span class="token punctuation">[</span>MEM_MAX_SIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">pack</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span></span>

<span class="token comment">// __CC_ARM环境</span>
<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> ucHeap<span class="token punctuation">[</span> configTOTAL_HEAP_SIZE <span class="token punctuation">]</span> <span class="token keyword">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token number">0X10000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token comment">// __GUNC__环境</span>
<span class="token keyword">static</span> <span class="token class-name">uint8_t</span> ucHeap<span class="token punctuation">[</span>configTOTAL_HEAP_SIZE<span class="token punctuation">]</span> <span class="token keyword">__attribute__</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">section</span><span class="token punctuation">(</span><span class="token string">".ccmram"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/**
其中.ccmram在LD中定义，如果没有则需要自定义
*/</span>
  <span class="token punctuation">.</span>ccmram <span class="token operator">:</span>
  <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _sccmram <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>       <span class="token comment">/* create a global symbol at ccmram start */</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>ccmram<span class="token punctuation">)</span>
    <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">.</span>ccmram<span class="token operator">*</span><span class="token punctuation">)</span>
    
    <span class="token punctuation">.</span> <span class="token operator">=</span> <span class="token function">ALIGN</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    _eccmram <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">;</span>       <span class="token comment">/* create a global symbol at ccmram end */</span>
  <span class="token punctuation">}</span> <span class="token operator">&gt;</span>CCMRAM AT<span class="token operator">&gt;</span> FLASH
</code></pre> 
<h5><a id="FreeRTOS_306"></a>FreeRTOS兼容问题</h5> 
<p><img src="https://images2.imgbox.com/e3/ab/x9OQfKL4_o.png" alt="在这里插入图片描述"></p> 
<p>底层接口RVDS替换为GCC</p> 
<h5><a id="const_311"></a><strong>const功能接口注册问题</strong></h5> 
<pre><code class="prism language-c"><span class="token comment">// __CC_ARM环境</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REGISTER_CMD</span><span class="token expression"><span class="token punctuation">(</span>cmd<span class="token punctuation">,</span> handler<span class="token punctuation">,</span> desc<span class="token punctuation">)</span>             </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">const</span> <span class="token keyword">char</span> _register_</span><span class="token punctuation">##</span><span class="token expression">cmd</span><span class="token punctuation">##</span><span class="token expression">_cmd<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> #cmd<span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
	<span class="token expression"><span class="token keyword">const</span> <span class="token keyword">char</span> _register_</span><span class="token punctuation">##</span><span class="token expression">cmd</span><span class="token punctuation">##</span><span class="token expression">_desc<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> #desc<span class="token punctuation">;</span>     </span><span class="token punctuation">\</span>
	<span class="token expression">CMD_USED <span class="token class-name">cmd_t</span> _register_</span><span class="token punctuation">##</span><span class="token expression">cmd <span class="token function">SECTION</span><span class="token punctuation">(</span></span><span class="token string">"CMDS"</span><span class="token expression"><span class="token punctuation">)</span> <span class="token operator">=</span> </span><span class="token punctuation">\</span>
		<span class="token expression"><span class="token punctuation">{<!-- --></span>                                            </span><span class="token punctuation">\</span>
			<span class="token expression">_register_</span><span class="token punctuation">##</span><span class="token expression">cmd</span><span class="token punctuation">##</span><span class="token expression">_cmd<span class="token punctuation">,</span>                   </span><span class="token punctuation">\</span>
			<span class="token expression">_register_</span><span class="token punctuation">##</span><span class="token expression">cmd</span><span class="token punctuation">##</span><span class="token expression">_desc<span class="token punctuation">,</span>                  </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>CMD_HASH<span class="token punctuation">,</span>                  </span><span class="token punctuation">\</span>
			<span class="token expression"><span class="token punctuation">(</span>cmd_handler<span class="token punctuation">)</span><span class="token operator">&amp;</span>handler<span class="token punctuation">}</span><span class="token punctuation">;</span></span></span>
<span class="token keyword">void</span> <span class="token function">cmd_get_time</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>param<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CALENDAR_T struCal<span class="token punctuation">;</span>
	<span class="token function">if_rtc_get</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>struCal<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__printf</span><span class="token punctuation">(</span><span class="token string">"%d-%d-%d %d:%d:%d %d\r\n"</span><span class="token punctuation">,</span> struCal<span class="token punctuation">.</span>year<span class="token punctuation">,</span> struCal<span class="token punctuation">.</span>month<span class="token punctuation">,</span> struCal<span class="token punctuation">.</span>day<span class="token punctuation">,</span>
			 struCal<span class="token punctuation">.</span>hour<span class="token punctuation">,</span> struCal<span class="token punctuation">.</span>minute<span class="token punctuation">,</span> struCal<span class="token punctuation">.</span>second<span class="token punctuation">,</span> struCal<span class="token punctuation">.</span>week<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">REGISTER_CMD</span><span class="token punctuation">(</span>get_time<span class="token punctuation">,</span> cmd_get_time<span class="token punctuation">,</span> get_time<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// __GUNC__环境需要实现功能注册必须建表。</span>
<span class="token comment">// 屏蔽原先接口</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">REGISTER_CMD</span><span class="token expression"><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span></span></span>
<span class="token comment">// 新建关联表</span>
<span class="token class-name">cmd_t</span> cmd_table<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"set_time"</span><span class="token punctuation">,</span> <span class="token string">"set_time[ymdhmsw]"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cmd_set_time<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"get_time"</span><span class="token punctuation">,</span> <span class="token string">"get_time"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cmd_get_time<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"get_sensor"</span><span class="token punctuation">,</span> <span class="token string">"get_sensor"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cmd_get_sensor<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">{<!-- --></span><span class="token string">"set_tp"</span><span class="token punctuation">,</span> <span class="token string">"set_tp[tp1 tp2]"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> cmd_set_target<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<h5><a id="USB_OTG_348"></a>USB_OTG问题</h5> 
<p>移植是需要删除一下文件：</p> 
<pre><code class="prism language-c">usbh_msc_fatfs<span class="token punctuation">.</span>c
usb_conf_template<span class="token punctuation">.</span>h
</code></pre> 
<h5><a id="_357"></a>特殊函数替换</h5> 
<p><strong>__CC_ARM环境</strong></p> 
<pre><code class="prism language-c"><span class="token comment">// THUMB指令不支持汇编内联</span>
<span class="token comment">// 采用如下方法实现执行汇编指令WFI</span>
__asm <span class="token keyword">void</span> <span class="token function">WFI_SET</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	WFI<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 关闭所有中断(但是不包括fault和NMI中断)</span>
__asm <span class="token keyword">void</span> <span class="token function">INTX_DISABLE</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CPSID I
		BX LR
<span class="token punctuation">}</span>
<span class="token comment">// 开启所有中断</span>
__asm <span class="token keyword">void</span> <span class="token function">INTX_ENABLE</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	CPSIE I
		BX LR
<span class="token punctuation">}</span>
<span class="token comment">// 设置栈顶地址</span>
<span class="token comment">// addr:栈顶地址</span>
__asm <span class="token keyword">void</span> <span class="token function">MSR_MSP</span><span class="token punctuation">(</span>u32 addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	MSR MSP<span class="token punctuation">,</span> r0 <span class="token comment">// set Main Stack value</span>
				 BX r14
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>__GUNC__环境</strong></p> 
<pre><code class="prism language-c"><span class="token comment">/**
 * @brief       执行: WFI指令(执行完该指令进入低功耗状态, 等待中断唤醒)
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">sys_wfi_set</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	__ASM <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"wfi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief       关闭所有中断(但是不包括fault和NMI中断)
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">sys_intx_disable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	__ASM <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"cpsid i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief       开启所有中断
 * @param       无
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">sys_intx_enable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	__ASM <span class="token keyword">volatile</span><span class="token punctuation">(</span><span class="token string">"cpsie i"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * @brief       设置栈顶地址
 * @note        左侧的红X, 属于MDK误报, 实际是没问题的
 * @param       addr: 栈顶地址
 * @retval      无
 */</span>
<span class="token keyword">void</span> <span class="token function">sys_msr_msp</span><span class="token punctuation">(</span><span class="token class-name">uint32_t</span> addr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">__set_MSP</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">/* 设置栈顶地址 */</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="IAP_434"></a>IAP相关问题</h5> 
<p>bootloader工程flash最好也修改限制自身的大小限制</p> 
<pre><code>MEMORY
{
  RAM (xrw) : ORIGIN = 0x20000000, LENGTH = 128K
  CCMRAM (xrw) : ORIGIN = 0x10000000, LENGTH = 64K
  FLASH (rx) : ORIGIN = 0x08000000, LENGTH = 64K
}
</code></pre> 
<p>bootloader跳转问题<br> <img src="https://images2.imgbox.com/1c/02/m9fCXXIY_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-c"><span class="token comment">// __GUNC__环境编译后得到的hex及bin文件无法满足以下条件</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tmp <span class="token operator">&amp;</span> <span class="token number">0x2FFE0000</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x20000000</span><span class="token punctuation">)</span> <span class="token comment">// 检查栈顶地址是否合法.</span>
目前没有找到更好的办法，做注释处理。
u32 tmp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
s8 <span class="token function">iap_load_app</span><span class="token punctuation">(</span>u32 appxaddr<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//	if ((tmp &amp; 0x2FFE0000) == 0x20000000) // 检查栈顶地址是否合法.</span>
	<span class="token punctuation">{<!-- --></span>
		jump2app <span class="token operator">=</span> <span class="token punctuation">(</span>iapfun<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span>vu32 <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>appxaddr <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 用户代码区第二个字为程序开始地址(复位地址)</span>
		<span class="token function">__set_MSP</span><span class="token punctuation">(</span>appxaddr<span class="token punctuation">)</span><span class="token punctuation">;</span>						  <span class="token comment">/* 设置栈顶地址 */</span>
		<span class="token comment">// MSR_MSP(*(vu32 *)appxaddr);					  // 初始化APP堆栈指针(用户代码区的第一个字用于存放栈顶地址)</span>
		<span class="token function">jump2app</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 跳转到APP.</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>application需要修改三处</p> 
<pre><code class="prism language-c"><span class="token comment">// 第一处 LD文件</span>
MEMORY
<span class="token punctuation">{<!-- --></span>
  <span class="token function">RAM</span> <span class="token punctuation">(</span>xrw<span class="token punctuation">)</span> <span class="token operator">:</span> ORIGIN <span class="token operator">=</span> <span class="token number">0x20000000</span><span class="token punctuation">,</span> LENGTH <span class="token operator">=</span> <span class="token number">128</span>K
  <span class="token function">CCMRAM</span> <span class="token punctuation">(</span>xrw<span class="token punctuation">)</span> <span class="token operator">:</span> ORIGIN <span class="token operator">=</span> <span class="token number">0x10000000</span><span class="token punctuation">,</span> LENGTH <span class="token operator">=</span> <span class="token number">64</span>K
  <span class="token function">FLASH</span> <span class="token punctuation">(</span>rx<span class="token punctuation">)</span> <span class="token operator">:</span> ORIGIN <span class="token operator">=</span> <span class="token number">0x08010000</span><span class="token punctuation">,</span> LENGTH <span class="token operator">=</span> <span class="token number">960</span>K
<span class="token punctuation">}</span>

<span class="token comment">// 第二处 makefile文件</span>
<span class="token comment">// 增加USER_VECT_TAB_ADDRESS宏定义</span>
C_DEFS <span class="token operator">=</span>  \
<span class="token operator">-</span>DUSER_VECT_TAB_ADDRESS \
    
<span class="token comment">// 第三处 system_stm32f4xx.c文件</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>VECT_TAB_SRAM<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VECT_TAB_BASE_ADDRESS</span> <span class="token expression">SRAM_BASE </span><span class="token comment">/*!&lt; Vector Table base address field. \
                                             This value must be a multiple of 0x200. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VECT_TAB_OFFSET</span> <span class="token expression"><span class="token number">0x00000000U</span>     </span><span class="token comment">/*!&lt; Vector Table base offset field. \
                                             This value must be a multiple of 0x200. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VECT_TAB_BASE_ADDRESS</span> <span class="token expression">FLASH_BASE </span><span class="token comment">/*!&lt; Vector Table base address field. \
                                              This value must be a multiple of 0x200. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">VECT_TAB_OFFSET</span> <span class="token expression"><span class="token number">0x00010000U</span>      </span><span class="token comment">/*!&lt; Vector Table base offset field. \
                                              This value must be a multiple of 0x200. */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>                                   <span class="token comment">/* VECT_TAB_SRAM */</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span>                                   <span class="token comment">/* USER_VECT_TAB_ADDRESS */</span></span>
</code></pre> 
<h5><a id="_499"></a>关于下载</h5> 
<p>下载可以借用sergger - jlink驱动，在makefile文件添加如下：</p> 
<pre><code class="prism language-makefile">#######################################
# download .hex/.bin by jlink
#######################################
#Your JLink installation directory
PATH_WINPC = 'C:/Program Files (x86)/SEGGER/JLink/'
#PATH_LINUX = /opt/SEGGER/JLink_V640b/JLinkExe
JK_DPATH = $(PATH_WINPC)
#Jlink script store directory
JKS_DIR = .
#Chip type
CHIP_TYPE = STM32F407VG
flash:
	@$(JK_DPATH)JLink.exe -device $(CHIP_TYPE) -if SWD -speed 4000 -autoconnect 1 -CommanderScript $(JKS_DIR)/flash.jlink
	@echo "Download Completed!"

debug:
	@$(JK_DPATH)JLinkGDBServer.exe -select USB -device $(CHIP_TYPE) -if SWD -speed auto -noir -LocalhostOnly
</code></pre> 
<p>主要注意两个地方：</p> 
<p>1）驱动的安装位置</p> 
<p>2）JKS_DIR定义的位置，这个直接索引编译后的hex文件</p> 
<h5><a id="_529"></a>浮点数打印及格式化问题</h5> 
<pre><code class="prism language-makefile">makefile文件中去除-specs=nano.specs
# LDFLAGS += -specs=nano.specs
</code></pre> 
<p>注意：去除后编译大小将增加40K代码空间</p> 
<h5><a id="VSCODE_538"></a>关于VSCODE编写代码高亮、索引、宏定义关联问题</h5> 
<p>在.vscode文件夹下根据需要添加目录索引及相关宏定义即可</p> 
<p><img src="https://images2.imgbox.com/0d/14/aT495K9L_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="4__543"></a>4. 关于二次开发</h4> 
<p>二次开发新建的文件，存放于user对应的目录下即可，无需修改makefile文件。</p> 
<h3><a id="4__545"></a>4. 编译、下载、清除</h3> 
<pre><code class="prism language-c">urien@urien MINGW64 <span class="token operator">/</span>d<span class="token operator">/</span>work<span class="token operator">/</span>prj_sealer<span class="token operator">/</span><span class="token number">05</span>软件<span class="token operator">/</span>biolink<span class="token operator">-</span>m4<span class="token operator">/</span>source<span class="token operator">/</span>application<span class="token operator">/</span><span class="token function">Project</span> <span class="token punctuation">(</span>branch_sealer_gcc<span class="token punctuation">)</span>
$ make <span class="token operator">-</span>j20
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token operator">-</span>mfloat<span class="token operator">-</span>abi<span class="token operator">=</span>hard <span class="token operator">-</span>TSTM32F407VGTx_FLASH<span class="token punctuation">.</span>ld  <span class="token operator">-</span>lc <span class="token operator">-</span>lm <span class="token operator">-</span>lnosys  <span class="token operator">-</span>Wl<span class="token punctuation">,</span><span class="token operator">-</span>Map<span class="token operator">=</span>build<span class="token operator">/</span>update<span class="token punctuation">.</span>map<span class="token punctuation">,</span><span class="token operator">--</span>cref <span class="token operator">-</span>Wl<span class="token punctuation">,</span><span class="token operator">--</span>gc<span class="token operator">-</span>sections <span class="token operator">-</span>o build<span class="token operator">/</span>update<span class="token punctuation">.</span>elf
arm<span class="token operator">-</span>none<span class="token operator">-</span>eabi<span class="token operator">-</span>size build<span class="token operator">/</span>update<span class="token punctuation">.</span>elf
   text    data     bss     dec     hex filename
 <span class="token number">243772</span>   <span class="token number">60912</span>  <span class="token number">113784</span>  <span class="token number">418468</span>   <span class="token number">662</span>a4 build<span class="token operator">/</span>update<span class="token punctuation">.</span>elf
arm<span class="token operator">-</span>none<span class="token operator">-</span>eabi<span class="token operator">-</span>objcopy <span class="token operator">-</span>O ihex build<span class="token operator">/</span>update<span class="token punctuation">.</span>elf build<span class="token operator">/</span>update<span class="token punctuation">.</span>hex
arm<span class="token operator">-</span>none<span class="token operator">-</span>eabi<span class="token operator">-</span>objcopy <span class="token operator">-</span>O binary <span class="token operator">-</span>S build<span class="token operator">/</span>update<span class="token punctuation">.</span>elf build<span class="token operator">/</span>update<span class="token punctuation">.</span>bin

urien@urien MINGW64 <span class="token operator">/</span>d<span class="token operator">/</span>work<span class="token operator">/</span>prj_sealer<span class="token operator">/</span><span class="token number">05</span>软件<span class="token operator">/</span>biolink<span class="token operator">-</span>m4<span class="token operator">/</span>source<span class="token operator">/</span>application<span class="token operator">/</span><span class="token function">Project</span> <span class="token punctuation">(</span>branch_sealer_gcc<span class="token punctuation">)</span>
$
</code></pre> 
<pre><code class="prism language-c">urien@urien MINGW64 <span class="token operator">/</span>d<span class="token operator">/</span>work<span class="token operator">/</span>prj_sealer<span class="token operator">/</span><span class="token number">05</span>软件<span class="token operator">/</span>biolink<span class="token operator">-</span>m4<span class="token operator">/</span>source<span class="token operator">/</span>application<span class="token operator">/</span><span class="token function">Project</span> <span class="token punctuation">(</span>branch_sealer_gcc<span class="token punctuation">)</span>
$ make flash
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Script processing completed<span class="token punctuation">.</span>

Download Completed<span class="token operator">!</span>

urien@urien MINGW64 <span class="token operator">/</span>d<span class="token operator">/</span>work<span class="token operator">/</span>prj_sealer<span class="token operator">/</span><span class="token number">05</span>软件<span class="token operator">/</span>biolink<span class="token operator">-</span>m4<span class="token operator">/</span>source<span class="token operator">/</span>application<span class="token operator">/</span><span class="token function">Project</span> <span class="token punctuation">(</span>branch_sealer_gcc<span class="token punctuation">)</span>
$
</code></pre> 
<pre><code class="prism language-c">urien@urien MINGW64 <span class="token operator">/</span>d<span class="token operator">/</span>work<span class="token operator">/</span>prj_sealer<span class="token operator">/</span><span class="token number">05</span>软件<span class="token operator">/</span>biolink<span class="token operator">-</span>m4<span class="token operator">/</span>source<span class="token operator">/</span>application<span class="token operator">/</span><span class="token function">Project</span> <span class="token punctuation">(</span>branch_sealer_gcc<span class="token punctuation">)</span>
$ make clean
rm <span class="token operator">-</span>fR build
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4efa6e42d5fb1d7c931614a1a7d83f85/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Ubuntu 22.04 更新完内核重启卡在 grub 命令行解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/a650a3308093ddf6f293b791c361adef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">java怎么将string转int数组</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>