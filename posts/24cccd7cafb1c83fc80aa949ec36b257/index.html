<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>16-k8s-configMap配置管理中心 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="16-k8s-configMap配置管理中心" />
<meta property="og:description" content="文章目录 一、相关概念二、基于目录创建configMap三、基于文件创建configMap四、基于自定义参数创建configMap五、configMap使用六、configMap热更新 一、相关概念 简介
为了解决传统容器中配置的挂载、变更、管理等问题，在k8s中引入了一个叫做configmap的资源对象，在configmap中，各个配置项都是以key-value的方式存在的，value的数据可以是一个配置文件的内容，这些配置项被保存在k8s使用的持久化存储etcd中。这样就形成了一个k8s中的配置中心，可以独立的对configmap中的数据进行修改，然后将configmap挂载到pod中进行使用，可以以env的方式，也可以以配置文件的方式在pod中进行引用。这样配置和pod就实现了解耦，都是k8s中独立的资源对象。
使用场景
• 填充环境变量的值
• 设置容器内的命令行参数
• 填充卷的配置文件
常用创建方式
• 基于目录创建
• 基于文件创建
• 基于自定义参数创建
configMap指令查看：kubectl create configMap -h
二、基于目录创建configMap 创建文件夹：mkdir /opt/config
创建文件：vi /opt/config/t1.properties
configmap1: name: myConfigmap1 创建文件：vi /opt/config/t2.properties
configmap2: name: myConfigmap2 创建configMap：kubectl create configmap my-config --from-file=/opt/config/
查看：kubectl get cm
查看详情：kubectl describe cm my-config
三、基于文件创建configMap 创建configMap：kubectl create configmap t1-config --from-file=/opt/config/t1.properties
查看：kubectl get cm
查看详情kubectl describe cm t1-config
基于文件创建configMap并且修改文件名：kubectl create cm t2-config --from-file=new-t2.yml=/opt/config/t2.properties
查看：kubectl describe cm t2-config" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/24cccd7cafb1c83fc80aa949ec36b257/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-10-17T08:39:26+08:00" />
<meta property="article:modified_time" content="2023-10-17T08:39:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">16-k8s-configMap配置管理中心</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#_1" rel="nofollow">一、相关概念</a></li><li><a href="#configMap_21" rel="nofollow">二、基于目录创建configMap</a></li><li><a href="#configMap_49" rel="nofollow">三、基于文件创建configMap</a></li><li><a href="#configMap_67" rel="nofollow">四、基于自定义参数创建configMap</a></li><li><a href="#configMap_75" rel="nofollow">五、configMap使用</a></li><li><a href="#configMap_197" rel="nofollow">六、configMap热更新</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_1"></a>一、相关概念</h3> 
<ol><li> <p>简介</p> <p>为了解决传统容器中配置的挂载、变更、管理等问题，在k8s中引入了一个叫做configmap的资源对象，在configmap中，各个配置项都是以key-value的方式存在的，value的数据可以是一个配置文件的内容，这些配置项被保存在k8s使用的持久化存储etcd中。这样就形成了一个k8s中的配置中心，可以独立的对configmap中的数据进行修改，然后将configmap挂载到pod中进行使用，可以以env的方式，也可以以配置文件的方式在pod中进行引用。这样配置和pod就实现了解耦，都是k8s中独立的资源对象。</p> </li><li> <p>使用场景</p> <p>• 填充环境变量的值<br> • 设置容器内的命令行参数<br> • 填充卷的配置文件</p> </li><li> <p>常用创建方式</p> <p>• 基于目录创建<br> • 基于文件创建<br> • 基于自定义参数创建</p> </li><li> <p>configMap指令查看：kubectl create configMap -h</p> </li></ol> 
<h3><a id="configMap_21"></a>二、基于目录创建configMap</h3> 
<ol><li> <p>创建文件夹：mkdir /opt/config</p> </li><li> <p>创建文件：vi /opt/config/t1.properties</p> <pre><code class="prism language-java">configmap1<span class="token operator">:</span> 
  name<span class="token operator">:</span> myConfigmap1
</code></pre> </li><li> <p>创建文件：vi /opt/config/t2.properties</p> <pre><code class="prism language-java">configmap2<span class="token operator">:</span> 
  name<span class="token operator">:</span> myConfigmap2
</code></pre> </li><li> <p>创建configMap：kubectl create configmap my-config --from-file=/opt/config/</p> </li><li> <p>查看：kubectl get cm<br> <img src="https://images2.imgbox.com/e0/4d/OmaZeFQe_o.png" alt="在这里插入图片描述"></p> </li><li> <p>查看详情：kubectl describe cm my-config<br> <img src="https://images2.imgbox.com/3e/5a/8lPsTgeW_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="configMap_49"></a>三、基于文件创建configMap</h3> 
<ol><li> <p>创建configMap：kubectl create configmap t1-config --from-file=/opt/config/t1.properties</p> </li><li> <p>查看：kubectl get cm<br> <img src="https://images2.imgbox.com/df/da/fEs5fr5v_o.png" alt="在这里插入图片描述"></p> </li><li> <p>查看详情kubectl describe cm t1-config<br> <img src="https://images2.imgbox.com/f6/73/sbA2jzHW_o.png" alt="在这里插入图片描述"></p> </li><li> <p>基于文件创建configMap并且修改文件名：kubectl create cm t2-config --from-file=new-t2.yml=/opt/config/t2.properties</p> </li><li> <p>查看：kubectl describe cm t2-config<br> <img src="https://images2.imgbox.com/e2/dd/ATEMqNnK_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="configMap_67"></a>四、基于自定义参数创建configMap</h3> 
<ol><li> <p>创建：kubectl create cm t3-config --from-literal=username=root --from-literal=password=admin</p> </li><li> <p>查看详情（这种方式创建不会有文件名）： kubectl describe cm t3-config<br> <img src="https://images2.imgbox.com/44/78/maapNHBA_o.png" alt="在这里插入图片描述"></p> </li></ol> 
<h3><a id="configMap_75"></a>五、configMap使用</h3> 
<ol><li> <p>创建一个pod，将configMap参数设置为环境变量并且打印出来</p> <p>1）vi /opt/env-test.yaml</p> <pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Pod</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> env<span class="token operator">-</span>test
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> env<span class="token operator">-</span>test
    image<span class="token operator">:</span> alpine
    command<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"env;sleep 3600"</span><span class="token punctuation">]</span>
    imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
    env <span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> username
      valueFrom<span class="token operator">:</span>
        configMapKeyRef<span class="token operator">:</span>
          name<span class="token operator">:</span> t3<span class="token operator">-</span>config # configMap的名字
          key<span class="token operator">:</span> username #表示从name的<span class="token class-name">ConfigMap</span>中获取名字为key 的 value，将其赋值给本地环境变量<span class="token constant">JAVA_YM_OPTS</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> password
      valueFrom<span class="token operator">:</span>
        configMapKeyRef<span class="token operator">:</span>
          name<span class="token operator">:</span> t3<span class="token operator">-</span>config
          key<span class="token operator">:</span> password
  restartPolicy<span class="token operator">:</span> <span class="token class-name">Never</span>

</code></pre> <p>2）创建pod：kubectl apply -f /opt/env-test.yaml</p> <p>3）查看：kubectl logs env-test<br> <img src="https://images2.imgbox.com/83/4a/GH3X8vMg_o.png" alt="在这里插入图片描述"></p> </li><li> <p>创建一个pod，将configMap参数挂载到pod里面去</p> <p>1）创建ytaml文件：vi /opt/env-test-pod.yaml</p> <p>ps：该方式将会把需要挂载的目录底下的文件都清除掉，被挂载文件夹的文件替换掉</p> <pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Pod</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> env<span class="token operator">-</span>test<span class="token operator">-</span>pod
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> env<span class="token operator">-</span>test
    image<span class="token operator">:</span> alpine
    command<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"env;sleep 3600"</span><span class="token punctuation">]</span>
    imagePullPolicy<span class="token operator">:</span> <span class="token class-name">IfNotPresent</span>
    volumeMounts<span class="token operator">:</span> #加载数据卷
    <span class="token operator">-</span> name<span class="token operator">:</span> t1<span class="token operator">-</span>config #表示加载volumes属性中哪个数据卷
      mountPath<span class="token operator">:</span> <span class="token string">"/usr/local/mysql/conf"</span> #想要将数据卷中的文件加载到哪个目录下
      readOnly<span class="token operator">:</span> <span class="token boolean">true</span> #是否只读
  volumes<span class="token operator">:</span> #数据卷挂载configmap<span class="token punctuation">.</span> secret
    <span class="token operator">-</span> name<span class="token operator">:</span> t1<span class="token operator">-</span>config  #数据卷的名字，随意设置
      configMap<span class="token operator">:</span> #数据卷类型为<span class="token class-name">CofngiMap</span>
        name<span class="token operator">:</span> t1<span class="token operator">-</span>config  # configMap 的名字，必须跟想要加载的 configmap 相同
        items<span class="token operator">:</span> #对configmap 中的 key进行映射，如果不指定，默认会讲configmap中所有 key全部转换为一个个同名的文件
        <span class="token operator">-</span> key <span class="token operator">:</span> <span class="token string">"t1.properties"</span> # configMap中的key
          path<span class="token operator">:</span> <span class="token string">"t1.properties"</span> #将该 key的值转换为文件
  restartPolicy <span class="token operator">:</span> <span class="token class-name">Never</span>
</code></pre> <p>2）创建pod：kubectl apply -f /opt/env-test-pod.yaml</p> <p>3）进入pod并且检查文件</p> <pre><code class="prism language-java">kubectl exec <span class="token operator">-</span>it env<span class="token operator">-</span>test<span class="token operator">-</span>pod <span class="token operator">--</span> sh
cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>mysql<span class="token operator">/</span>conf
ls
</code></pre> </li></ol> 
<p><img src="https://images2.imgbox.com/85/63/GN8jTKZB_o.png" alt="在这里插入图片描述"></p> 
<ol start="3"><li> <p>我们可以使用subPath属性避免上面那种完全覆盖文件夹的情况</p> <p>1）编辑文件夹：vi /opt/env-subPath-pod.yaml</p> <pre><code class="prism language-java">apiVersion<span class="token operator">:</span> v1
kind<span class="token operator">:</span> <span class="token class-name">Pod</span>
metadata<span class="token operator">:</span>
  name<span class="token operator">:</span> env<span class="token operator">-</span>subpath<span class="token operator">-</span>pod
spec<span class="token operator">:</span>
  containers<span class="token operator">:</span>
  <span class="token operator">-</span> name<span class="token operator">:</span> testc
    image<span class="token operator">:</span> busybox
    command<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"/bin/sleep"</span><span class="token punctuation">,</span><span class="token string">"10000"</span><span class="token punctuation">]</span>
    volumeMounts<span class="token operator">:</span>
      <span class="token operator">-</span> name<span class="token operator">:</span> t1<span class="token operator">-</span>config
        mountPath<span class="token operator">:</span> <span class="token operator">/</span>etc<span class="token operator">/</span>config<span class="token punctuation">.</span>ini   # 最终在容器中的文件名
        subPath<span class="token operator">:</span> config<span class="token punctuation">.</span>ini  #要挂载的confmap中的key的名称
  volumes<span class="token operator">:</span>
    <span class="token operator">-</span> name<span class="token operator">:</span> t1<span class="token operator">-</span>config
      configMap<span class="token operator">:</span>
        name<span class="token operator">:</span> t1<span class="token operator">-</span>config
        items<span class="token operator">:</span> #对configmap 中的 key进行映射，如果不指定，默认会讲configmap中所有 key全部转换为一个个同名的文件
        <span class="token operator">-</span> key <span class="token operator">:</span> <span class="token string">"t1.properties"</span> # configMap中的key
          path<span class="token operator">:</span> <span class="token string">"config.ini"</span> #将该key的值转换为文件
</code></pre> <p>2）创建pod：kubectl apply -f /opt/env-subPath-pod.yaml</p> <p>3）验证</p> <pre><code class="prism language-java">kubectl exec <span class="token operator">-</span>it env<span class="token operator">-</span>subpath<span class="token operator">-</span>pod  <span class="token operator">--</span> sh
cd <span class="token operator">/</span>etc
ls
</code></pre> </li></ol> 
<p><img src="https://images2.imgbox.com/ea/c1/FvZFcHoD_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="configMap_197"></a>六、configMap热更新</h3> 
<ol><li> <p>热更新情况</p> <pre><code class="prism language-java"><span class="token number">1</span><span class="token punctuation">)</span> 默认方式<span class="token punctuation">(</span>挂载configmap<span class="token punctuation">)</span><span class="token operator">:</span>会更新，更新周期是更新时间＋缓存时间
<span class="token number">2</span><span class="token punctuation">)</span> subPath<span class="token operator">:</span>不会更新
<span class="token number">3</span><span class="token punctuation">)</span> 变量形式<span class="token operator">:</span>如果pod 中的一个变量是从 configmap或 secret中得到，同样也是不会更新的
对于subPath 的方式，我们可以取消subPath 的使用<span class="token punctuation">,</span>将配置文件挂载到一个不存在的目录<span class="token punctuation">,</span>避免目录的要盖，然后再利用软连接的形式<span class="token punctuation">,</span>将该文件牯持到目标位置
</code></pre> </li><li> <p>前面我们是以env-test-pod节点为默认方式启动的节点，所以直接拿env-test-pod节点测试</p> </li><li> <p>验证热更新</p> <p>1）查看节点内容</p> <pre><code class="prism language-java">kubectl exec <span class="token operator">-</span>it env<span class="token operator">-</span>test<span class="token operator">-</span>pod <span class="token operator">--</span> sh
cd <span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>mysql<span class="token operator">/</span>conf
ls
</code></pre> </li></ol> 
<p><img src="https://images2.imgbox.com/77/1c/CHBuVVZB_o.png" alt="在这里插入图片描述"></p> 
<p>2）修改： kubectl edit cm t1-config</p> 
<p>加上热更新三个字</p> 
<pre><code class="prism language-java">data<span class="token operator">:</span>
  t1<span class="token punctuation">.</span>properties<span class="token operator">:</span> <span class="token string">"configmap1: \n  name: myConfigmap热更新\n"</span>
</code></pre> 
<p>3）需要稍等一会，然后重新访问：cat t1.properties<br> <img src="https://images2.imgbox.com/f2/fa/i5OyqZCt_o.png" alt="在这里插入图片描述"></p> 
<ol start="4"><li> <p>修改configMap文件的方式</p> <p>ps：除了直接修改kubectl edit cm以外，也可以使用replace</p> <p>1）修改配置文件：vi /opt/config/t1.properties</p> <pre><code class="prism language-java">configmap2<span class="token operator">:</span> 
  name<span class="token operator">:</span> myConfigmap2热更新replace
</code></pre> <p>2）刷新：kubectl create configmap t1-config --from-file=/opt/config/t1.properties --dry-run -o yaml | kubectl replace -f-</p> <p>3）需要稍等一会，然后重新访问：cat t1.properties<br> <img src="https://images2.imgbox.com/42/74/tfViSGnI_o.png" alt="在这里插入图片描述"></p> </li><li> <p>对于一些敏感服务的配置文件,在线上有时是不允许修改的,此时在配置configmap时可以设置禁止修改：kubectl edit cm t1-config</p> <p>增加：immutable: true</p> <pre><code class="prism language-java"># <span class="token class-name">Please</span> edit the object <span class="token class-name"><span class="token namespace">below<span class="token punctuation">.</span></span> Lines</span> beginning <span class="token keyword">with</span> <span class="token namespace">a</span> <span class="token char">'#'</span> will be ignored<span class="token punctuation">,</span>
# and an empty file will abort the <span class="token class-name"><span class="token namespace">edit<span class="token punctuation">.</span></span> If</span> an error occurs <span class="token keyword">while</span> saving <span class="token keyword">this</span> file will be
# reopened <span class="token keyword">with</span> <span class="token namespace">the</span> relevant failures<span class="token punctuation">.</span>
#
apiVersion<span class="token operator">:</span> v1
data<span class="token operator">:</span>
  t1<span class="token punctuation">.</span>properties<span class="token operator">:</span> <span class="token string">"configmap1: \n  name: myConfigmap1热更新replace\n"</span>
immutable<span class="token operator">:</span> <span class="token boolean">true</span>
kind<span class="token operator">:</span> <span class="token class-name">ConfigMap</span>
metadata<span class="token operator">:</span>
  creationTimestamp<span class="token operator">:</span> <span class="token string">"2023-07-21T14:32:47Z"</span>
  name<span class="token operator">:</span> t1<span class="token operator">-</span>config
  namespace<span class="token operator">:</span> <span class="token keyword">default</span>
  resourceVersion<span class="token operator">:</span> <span class="token string">"195897"</span>
  uid<span class="token operator">:</span> <span class="token number">683</span>b2f51<span class="token operator">-</span>a539<span class="token operator">-</span><span class="token number">4486</span><span class="token operator">-</span><span class="token number">8</span>ee6<span class="token operator">-</span>bf0b0a6eab11
</code></pre> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1b8ad305465673a03fca05e99a6ecb1e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">blob和ArrayBuffer格式图片如何显示</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/8437cf5a048c1664ae7820f64f8b6f10/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Unity AI Muse 基础教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>