<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android10(Api 29)新特性适配小结 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android10(Api 29)新特性适配小结" />
<meta property="og:description" content="文档说明 本文档主要对影响比较大的部分进行简单总结，内容并不全面；
本文档基于谷歌AndroidQ官方文档和华为Q版本应用兼容性整改指导(华为的有点过时)；
所用测试机：Google初代Pixel，AndroidQ-beta6-190730.005
版本号对应关系
Android-Q = Android-10 = Api29
Android-P = Android-9.0 = Api28
目录 文档说明 设备硬件标识符访问限制原来的做法替代方案 禁止后台启动Activity情况描述解决方法 后台应用增加定位限制情况描述解决方法 分区存储情况描述解决方法方法一、停用过滤视图，使用旧版存储模式方法二、将文件存储到过滤视图中，官方推荐。方法三、使用存储访问框架（SAF），由用户指定要读写的文件。方法四、获取用户指定的某个目录的读写权限1. 申请目录的访问权限2. 通过Uri读写文件 设备硬件标识符访问限制 限制应用访问不可重设的设备识别码，如 IMEI、序列号等，系统应用不受影响。
原来的做法 // 在AndroidQ上以下方法都会有问题 // 返回：866976045261713; TelephonyManager tm = (TelephonyManager) getSystemService(TELEPHONY_SERVICE); tm.getDeviceId(); tm.getSubscriberId(); tm.getDeviceId(TelephonyManager.PHONE_TYPE_NONE); //返回：66J0218B19000977; Build.getSerial(); 在低于AndroidQ的系统上没问题
在AndroidQ及以上的系统上运行时：
如targetSdkVersion&lt;Q，返回null或“unknown”；
如targetSdkVersion&gt;=Q，抛异常：
SecurityException: getDeviceId: The user 10196 does not meet the requirements to access device identifiers.
受影响的方法
Build getSerial() TelephonyManager getImei()getDeviceId()getMeid()getSimSerialNumber()getSubscriberId() 替代方案 方案一：
使用AndroidId代替，缺点是应用签署密钥或用户（如系统恢复出产设置）不同返回的Id不同。与实际测试结果相符。
经实际测试：相同签名密钥的不同应用androidId相同，不同签名的应用androidId不同。恢复出产设置或升级系统没测。
// 返回：496836e3a48d2d9d String androidId = Settings." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8790a0d0a0d2b391d173b8a53f78b2b3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-08-19T11:23:07+08:00" />
<meta property="article:modified_time" content="2019-08-19T11:23:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android10(Api 29)新特性适配小结</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h5><a id="_1"></a>文档说明</h5> 
<ol><li> <p>本文档主要对影响比较大的部分进行简单总结，内容并不全面；</p> </li><li> <p>本文档基于<a href="https://developer.android.google.cn/preview" rel="nofollow">谷歌AndroidQ官方文档</a>和<a href="https://developer.huawei.com/consumer/cn/devservice/doc/50127" rel="nofollow">华为Q版本应用兼容性整改指导</a>(华为的有点过时)；</p> </li><li> <p>所用测试机：Google初代Pixel，AndroidQ-beta6-190730.005</p> </li><li> <p>版本号对应关系</p> 
  <blockquote> 
   <p>Android-Q = Android-10 = Api29</p> 
   <p>Android-P = Android-9.0 = Api28</p> 
  </blockquote> </li></ol> 
<p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><ul><li><ul><li><ul><li><a href="#_1" rel="nofollow">文档说明</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_15" rel="nofollow">设备硬件标识符访问限制</a></li><li><ul><li><ul><li><a href="#_19" rel="nofollow">原来的做法</a></li><li><a href="#_51" rel="nofollow">替代方案</a></li></ul> 
   </li></ul> 
   </li><li><a href="#Activity_104" rel="nofollow">禁止后台启动Activity</a></li><li><ul><li><ul><li><a href="#_108" rel="nofollow">情况描述</a></li><li><a href="#_114" rel="nofollow">解决方法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_142" rel="nofollow">后台应用增加定位限制</a></li><li><ul><li><ul><li><a href="#_146" rel="nofollow">情况描述</a></li><li><a href="#_160" rel="nofollow">解决方法</a></li></ul> 
   </li></ul> 
   </li><li><a href="#_175" rel="nofollow">分区存储</a></li><li><ul><li><ul><li><a href="#_179" rel="nofollow">情况描述</a></li><li><a href="#_185" rel="nofollow">解决方法</a></li><li><ul><li><a href="#_187" rel="nofollow">方法一、停用过滤视图，使用旧版存储模式</a></li><li><a href="#_198" rel="nofollow">方法二、将文件存储到过滤视图中，官方推荐。</a></li><li><a href="#SAF_211" rel="nofollow">方法三、使用存储访问框架（SAF），由用户指定要读写的文件。</a></li><li><a href="#_217" rel="nofollow">方法四、获取用户指定的某个目录的读写权限</a></li><li><a href="#1__221" rel="nofollow">1. 申请目录的访问权限</a></li><li><a href="#2_Uri_247" rel="nofollow">2. 通过Uri读写文件</a></li></ul> 
    </li></ul> 
   </li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="_15"></a>设备硬件标识符访问限制</h3> 
<p>限制应用访问不可重设的设备识别码，如 IMEI、序列号等，系统应用不受影响。</p> 
<h5><a id="_19"></a>原来的做法</h5> 
<pre><code class="prism language-java"><span class="token comment">// 在AndroidQ上以下方法都会有问题</span>
<span class="token comment">// 返回：866976045261713; </span>
TelephonyManager tm <span class="token operator">=</span> <span class="token punctuation">(</span>TelephonyManager<span class="token punctuation">)</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>TELEPHONY_SERVICE<span class="token punctuation">)</span><span class="token punctuation">;</span>
tm<span class="token punctuation">.</span><span class="token function">getDeviceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tm<span class="token punctuation">.</span><span class="token function">getSubscriberId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
tm<span class="token punctuation">.</span><span class="token function">getDeviceId</span><span class="token punctuation">(</span>TelephonyManager<span class="token punctuation">.</span>PHONE_TYPE_NONE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//返回：66J0218B19000977; </span>
Build<span class="token punctuation">.</span><span class="token function">getSerial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<ol><li> <p>在低于AndroidQ的系统上没问题</p> </li><li> <p>在AndroidQ及以上的系统上运行时：</p> 
  <ul><li> <p>如<code>targetSdkVersion&lt;Q</code>，返回null或“unknown”；</p> </li><li> <p>如<code>targetSdkVersion&gt;=Q</code>，抛异常：</p> 
    <blockquote> 
     <p>SecurityException: getDeviceId: The user 10196 does not meet the requirements to access device identifiers.</p> 
    </blockquote> </li></ul> </li><li> <p>受影响的方法</p> 
  <ul><li><code>Build</code> 
    <ul><li><code>getSerial()</code></li></ul> </li><li><code>TelephonyManager</code> 
    <ul><li><code>getImei()</code></li><li><code>getDeviceId()</code></li><li><code>getMeid()</code></li><li><code>getSimSerialNumber()</code></li><li><code>getSubscriberId()</code></li></ul> </li></ul> </li></ol> 
<h5><a id="_51"></a>替代方案</h5> 
<ol><li> <p>方案一：</p> <p>使用AndroidId代替，缺点是应用签署密钥或用户（如系统恢复出产设置）不同返回的Id不同。与实际测试结果相符。<br> 经实际测试：相同签名密钥的不同应用androidId相同，不同签名的应用androidId不同。恢复出产设置或升级系统没测。</p> <pre><code class="prism language-java"><span class="token comment">// 返回：496836e3a48d2d9d</span>
String androidId <span class="token operator">=</span> Settings<span class="token punctuation">.</span>System<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Settings<span class="token punctuation">.</span>Secure<span class="token punctuation">.</span>ANDROID_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p>方案二：</p> <p>通过硬件信息拼接，缺点是还是不能保证唯一。<br> 经测试：似乎与方案一比更稳定，不受密钥影响，但非官方建议，没安全感。</p> <pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> String <span class="token function">makeDeviceId</span><span class="token punctuation">(</span>Context context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    String  deviceInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>BOARD<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>BRAND<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token comment">//CPU_ABI，这个值和appp使用的so库是arm64-v8a还是armeabi-v7a有关，舍弃</span>
            <span class="token comment">//.append(Build.CPU_ABI).append("#")</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>DEVICE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>DISPLAY<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>HOST<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>ID<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>MANUFACTURER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>MODEL<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>PRODUCT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>TAGS<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>TYPE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>USER<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"#"</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    	<span class="token comment">//22a49a46-b39e-36d1-b75f-a0d0b9c72d6c</span>
       <span class="token keyword">return</span> UUID<span class="token punctuation">.</span><span class="token function">nameUUIDFromBytes</span><span class="token punctuation">(</span>deviceInfo<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">"utf8"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">UnsupportedEncodingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    String androidId <span class="token operator">=</span> Settings<span class="token punctuation">.</span>System<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                Settings<span class="token punctuation">.</span>Secure<span class="token punctuation">.</span>ANDROID_ID<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> androidId<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> </li></ol> 
<h3><a id="Activity_104"></a>禁止后台启动Activity</h3> 
<p><a href="https://developer.android.google.cn/preview/privacy/background-activity-starts" rel="nofollow">官方文档</a></p> 
<h5><a id="_108"></a>情况描述</h5> 
<ol><li>AndroidQ上，后台启动Activity会被系统忽略，不管targetSdkVersion多少；</li><li>AndroidQ上，即使应用有前台服务也不行；</li><li>AndroidQ以下版本没影响。</li></ol> 
<h5><a id="_114"></a>解决方法</h5> 
<p>发送全屏通知:</p> 
<pre><code class="prism language-java"><span class="token comment">//AndroidManifest 声明新权限，不用动态申请</span>
<span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.USE_FULL_SCREEN_INTENT"</span><span class="token operator">/</span><span class="token operator">&gt;</span>

Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> ScopedStorageActivity<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
PendingIntent pendingIntent <span class="token operator">=</span> PendingIntent<span class="token punctuation">.</span><span class="token function">getActivity</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>
        REQ_CODE<span class="token punctuation">,</span> intent<span class="token punctuation">,</span> PendingIntent<span class="token punctuation">.</span>FLAG_UPDATE_CURRENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
Notification notification <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NotificationCompat<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> Constants<span class="token punctuation">.</span>CHANNEL_ID<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setSmallIcon</span><span class="token punctuation">(</span>R<span class="token punctuation">.</span>drawable<span class="token punctuation">.</span>ic_launcher_foreground<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setContentTitle</span><span class="token punctuation">(</span><span class="token string">"Incoming call"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setContentText</span><span class="token punctuation">(</span><span class="token string">"(919) 555-1234"</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setPriority</span><span class="token punctuation">(</span>NotificationCompat<span class="token punctuation">.</span>PRIORITY_HIGH<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setCategory</span><span class="token punctuation">(</span>NotificationCompat<span class="token punctuation">.</span>CATEGORY_ALARM<span class="token punctuation">)</span>
        <span class="token comment">//设置全屏通知后，发送通知直接启动Activity</span>
        <span class="token punctuation">.</span><span class="token function">setFullScreenIntent</span><span class="token punctuation">(</span>pendingIntent<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
NotificationManager manager <span class="token operator">=</span> <span class="token function">getSystemService</span><span class="token punctuation">(</span>NotificationManager<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
manager<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token number">445456</span><span class="token punctuation">,</span> notification<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>但是：在华为mate20（Api-28）上需要到设置中打开横幅通知；原生AndroidQ（beta6）上有效。</p> 
<h3><a id="_142"></a>后台应用增加定位限制</h3> 
<p><a href="https://developer.android.google.cn/preview/privacy/device-location" rel="nofollow">官方文档</a></p> 
<h5><a id="_146"></a>情况描述</h5> 
<ol><li> <p>后台应用要获取位置信息需要动态申请权限，</p> <p><code>&lt;uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION"/&gt;</code></p> </li><li> <p>在AndroidQ上运行：</p> 
  <ul><li><code>targetSdkVersion&lt;Q</code>，没影响，申请权限时系统默认会加上后台位置权限</li><li><code>targetSdkVersion&gt;=Q</code>，需申请；</li><li>应用变为后台应用90s后开始定位失败（Pixel AndroidQ-beta6）</li></ul> </li><li> <p><code>ACCESS_BACKGROUND_LOCATION</code>不能单独申请，需要和<code>ACCESS_COARSE_LOCATION/ACCESS_FINE_LOCATION</code>一起申请</p> </li></ol> 
<h5><a id="_160"></a>解决方法</h5> 
<ol><li> <p>动态申请即可；</p> </li><li> <p>启动前台服务</p> <pre><code class="prism language-java"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">-</span>需要设置foregroundServiceType为“location” <span class="token operator">-</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>service 
 android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">".permission.LocationService"</span>
    android<span class="token operator">:</span>foregroundServiceType<span class="token operator">=</span><span class="token string">"location"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> </li></ol> 
<h3><a id="_175"></a>分区存储</h3> 
<p><a href="https://developer.android.google.cn/preview/privacy/scoped-storage" rel="nofollow">官方文档</a></p> 
<h5><a id="_179"></a>情况描述</h5> 
<ol><li>从Android10开始应用将不可直接访问外部存储<code>（/sdcard）</code>文件，否则抛异常。</li><li>在AndroidQ上运行： 
  <ul><li><code>targetSdkVersion&lt;Q</code>，没影响；</li><li><code>targetSdkVersion&gt;=Q</code>，默认启用过滤视图，应用以外的文件需要通过<a href="https://developer.android.google.cn/guide/topics/providers/document-provider" rel="nofollow">存储访问框架</a>（SAF，StorageAccessFramework）读写。</li></ul> </li></ol> 
<h5><a id="_185"></a>解决方法</h5> 
<h6><a id="_187"></a>方法一、停用过滤视图，使用旧版存储模式</h6> 
<pre><code class="prism language-xml">   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>manifest</span> <span class="token attr-name">...</span> <span class="token punctuation">&gt;</span></span>
     <span class="token comment">&lt;!-- This attribute is "false" by default on apps targeting Android Q. --&gt;</span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>application</span> <span class="token attr-name"><span class="token namespace">android:</span>requestLegacyExternalStorage</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span> <span class="token attr-name">...</span> <span class="token punctuation">&gt;</span></span>
       ...
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>application</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>manifest</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h6><a id="_198"></a>方法二、将文件存储到过滤视图中，官方推荐。</h6> 
<pre><code class="prism language-java">   <span class="token comment">// /Android/data/com.example.androidq/files/Documents</span>
   File dir <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getExternalFilesDir</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>DIRECTORY_DOCUMENTS<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><b>优点：</b>不用申请读写权限；</p> 
<p><b>缺点：</b>随应用卸载而删除；</p> 
<p>​</p> 
<h6><a id="SAF_211"></a>方法三、使用存储访问框架（SAF），由用户指定要读写的文件。</h6> 
<p>​ 这个功能Android 4.4（API: 19）就有，<a href="https://developer.android.google.cn/guide/topics/providers/document-provider" rel="nofollow">官方文档在此</a>。</p> 
<h6><a id="_217"></a>方法四、获取用户指定的某个目录的读写权限</h6> 
<p>​ 从Android5.0（Api 21）开始就有，<a href="https://developer.android.google.cn/about/versions/android-5.0#Storage" rel="nofollow">官方文档</a>。<br> 步骤</p> 
<h6><a id="1__221"></a>1. 申请目录的访问权限</h6> 
<p>会打开系统的文件目录，由用户自己选择允许访问的目录，不用申请<code>WRITE/READ_EXTERNAL_STORAGE</code>权限。</p> 
<pre><code class="prism language-java">Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_OPEN_DOCUMENT_TREE<span class="token punctuation">)</span><span class="token punctuation">;</span>
intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION <span class="token operator">|</span> 
        Intent<span class="token punctuation">.</span>FLAG_GRANT_PERSISTABLE_URI_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>				
<span class="token function">startActivityForResult</span><span class="token punctuation">(</span>intent<span class="token punctuation">,</span> REQ_CODE<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>执行上述代码后会出现类似如下图界面，点击‘允许访问“DuoKan”’按钮，<br> <img src="https://images2.imgbox.com/cf/84/BkwJRyZ7_o.png" alt="允许访问权限"><br> 允许了之后通过<code>onActivityResult()</code>的<code>intent.getData()</code>得到该目录的Uri，通过Uri可获取子目录和文件。这种方式的<b>缺点</b>是应用重装后权限失效，即使可以保存了这个Uri也没用。</p> 
<pre><code class="prism language-java">Uri dirUri <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 持久化；应用重装后权限失效，即使知道这个uri也没用</span>
SPUtil<span class="token punctuation">.</span><span class="token function">setValue</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> SP_DOC_KEY<span class="token punctuation">,</span> dirUri<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//重要：少这行代码手机重启后会失去权限</span>
<span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">takePersistableUriPermission</span><span class="token punctuation">(</span>dirUri<span class="token punctuation">,</span> 
        Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="2_Uri_247"></a>2. 通过Uri读写文件</h6> 
<ul><li> <p>创建文件</p> <pre><code class="prism language-java"><span class="token comment">// 在mUri目录（‘DuoKan’目录）下创建'test.txt'文件</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">createFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DocumentFile documentFile <span class="token operator">=</span> DocumentFile<span class="token punctuation">.</span><span class="token function">fromTreeUri</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    DocumentFile file <span class="token operator">=</span> documentFile<span class="token punctuation">.</span><span class="token function">createFile</span><span class="token punctuation">(</span><span class="token string">"text/plain"</span><span class="token punctuation">,</span> <span class="token string">"test.txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>file <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LogUtil<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" created"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <p>主要用到DocumentFile类，和File类的方法类似，有isFile、isDirectory、exists、listFiles等方法</p> </li><li> <p>删除文件</p> <pre><code class="prism language-java"><span class="token comment">//删除"test.txt"</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">deleteFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    DocumentFile documentFile <span class="token operator">=</span> DocumentFile<span class="token punctuation">.</span><span class="token function">fromTreeUri</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> mUri<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// listFiles()，列出所有的子文件和文件夹</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>DocumentFile file <span class="token operator">:</span> documentFile<span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token string">"test.txt"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">boolean</span> delete <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            LogUtil<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"deleteFile: "</span> <span class="token operator">+</span> delete<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li><li> <p>写入数据</p> <pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">writeFile</span><span class="token punctuation">(</span>Uri uri<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        ParcelFileDescriptor pfd <span class="token operator">=</span> <span class="token function">getContentResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openFileDescriptor</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这种方法会覆盖原来文件内容</span>
        OutputStreamWriter output <span class="token operator">=</span> 
                <span class="token keyword">new</span> <span class="token class-name">OutputStreamWriter</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>pfd<span class="token punctuation">.</span><span class="token function">getFileDescriptor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 不能传uri.toString(),否则FileNotFoundException</span>
        <span class="token comment">// OutputStreamWriter output = new OutputStreamWriter(new FileOutputStream(uri.toString(), true));</span>
        output<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"这是一段文件写入测试\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        output<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        LogUtil<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"写入成功。"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        LogUtil<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> </li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ff77e311f46ea91733bd93ec68fecfbf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">unity 生成缩略图 , 图片缩放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/02fdc0348de5a4c35cc8df13e8e572aa/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iOS 12.4 越狱 unc0ver 已经支持</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>