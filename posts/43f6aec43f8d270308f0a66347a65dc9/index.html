<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android插件化原理及基础实现【hook篇】 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android插件化原理及基础实现【hook篇】" />
<meta property="og:description" content="插件化的理念 将应用分为多个模块，分出宿主与插件
用户安装宿主，动态加载插件
插件化的优点 按需加载、可插拔、动态更新
减小apk体积，解决方法是超过65535的问题
插件分开开发与编译，提高效率，降低耦合度
插件化的缺点 提升项目复杂度
插件化框架 特性dynamic-load-apkDynamicApkSmallDroidPluginVirtualAPK作者任玉刚携程wequick360滴滴四大组件支持只支持Activity只支持Activity只支持Activity全支持全支持插件无需在清单文件预注册√x√√√插件可以依赖宿主√√√x√支持PendingIntentxxx√√Android特性支持大部分大部分大部分几乎全部几乎全部兼容性适配一般一般中等高高插件构建无部署AAPTGradle插件无Gradle插件 插件的架构思路 Demo地址
如何加载插件？ 通过Android的类加载机制，和几个ClassLoader分别的作用可知，想要加载插件，就需要将插件项目打成dex或apk，然后根据DexClassLoader指定插件路径，即可加载
apk是一个完整的Android包，其中包含了dex代码部分，res资源部分，AndroidManifest清单部分，作为插件时，其资源也可以被用到
dex是一个纯代码的包，有多个class文件组合而成
dex可作为热修复，apk可以作为完整的插件使用，这里讲的是插件的使用，就以apk为例
独立声明一个插件工程，在其中编写代码，然后编译成apk，其过程和正常apk工程一样
将apk放入手机存储，然后通过DexClassLoader加载，此时，可以调用没有使用的资源的类的方法
插件中的类
public class PluginTest { public static void doSomeThing(){ Log.d(&#34;hahaha&#34;, &#34;PluginTest doSomeThing &#34;); } } 拷贝插件到私有目录，并创建插件的类加载器
private boolean copyPlugin() { String pluginName = &#34;plugin.apk&#34;; // 插件所在目录 mPluginPath = mContext.getExternalFilesDir(null).getAbsolutePath() &#43; File.separator &#43; pluginName; // 最终拷贝到的私有目录 String targetPath = mContext.getDir(PLUGIN_CACHE_DIR_NAME,Context.MODE_PRIVATE).getAbsolutePath(); if(!new File(mPluginPath).exists()){ // 如果插件不存在 Log.e(TAG,&#34;plugin not exists !!!&#34;); return false; } File targetFile = new File(targetPath); if(targetFile." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/43f6aec43f8d270308f0a66347a65dc9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-29T15:56:02+08:00" />
<meta property="article:modified_time" content="2022-05-29T15:56:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android插件化原理及基础实现【hook篇】</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h4><a id="_0"></a>插件化的理念</h4> 
<p>将应用分为多个模块，分出宿主与插件</p> 
<p>用户安装宿主，动态加载插件</p> 
<h4><a id="_6"></a>插件化的优点</h4> 
<p>按需加载、可插拔、动态更新</p> 
<p>减小apk体积，解决方法是超过65535的问题</p> 
<p>插件分开开发与编译，提高效率，降低耦合度</p> 
<h4><a id="_14"></a>插件化的缺点</h4> 
<p>提升项目复杂度</p> 
<h4><a id="_18"></a>插件化框架</h4> 
<table><thead><tr><th>特性</th><th>dynamic-load-apk</th><th>DynamicApk</th><th>Small</th><th>DroidPlugin</th><th>VirtualAPK</th></tr></thead><tbody><tr><td>作者</td><td>任玉刚</td><td>携程</td><td>wequick</td><td>360</td><td>滴滴</td></tr><tr><td>四大组件支持</td><td>只支持Activity</td><td>只支持Activity</td><td>只支持Activity</td><td>全支持</td><td>全支持</td></tr><tr><td>插件无需在清单文件预注册</td><td>√</td><td>x</td><td>√</td><td>√</td><td>√</td></tr><tr><td>插件可以依赖宿主</td><td>√</td><td>√</td><td>√</td><td>x</td><td>√</td></tr><tr><td>支持PendingIntent</td><td>x</td><td>x</td><td>x</td><td>√</td><td>√</td></tr><tr><td>Android特性支持</td><td>大部分</td><td>大部分</td><td>大部分</td><td>几乎全部</td><td>几乎全部</td></tr><tr><td>兼容性适配</td><td>一般</td><td>一般</td><td>中等</td><td>高</td><td>高</td></tr><tr><td>插件构建</td><td>无</td><td>部署AAPT</td><td>Gradle插件</td><td>无</td><td>Gradle插件</td></tr></tbody></table> 
<h4><a id="_31"></a>插件的架构思路</h4> 
<p><a href="https://github.com/Kyoto36/android_plugin_demo">Demo地址</a></p> 
<h5><a id="_35"></a>如何加载插件？</h5> 
<p>通过Android的类加载机制，和几个ClassLoader分别的作用可知，想要加载插件，就需要将插件项目打成dex或apk，然后根据DexClassLoader指定插件路径，即可加载</p> 
<p>apk是一个完整的Android包，其中包含了dex代码部分，res资源部分，AndroidManifest清单部分，作为插件时，其资源也可以被用到</p> 
<p>dex是一个纯代码的包，有多个class文件组合而成</p> 
<p>dex可作为热修复，apk可以作为完整的插件使用，这里讲的是插件的使用，就以apk为例</p> 
<p>独立声明一个插件工程，在其中编写代码，然后编译成apk，其过程和正常apk工程一样</p> 
<p>将apk放入手机存储，然后通过DexClassLoader加载，此时，可以调用没有使用的资源的类的方法</p> 
<p>插件中的类</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PluginTest</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">doSomeThing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"hahaha"</span><span class="token punctuation">,</span> <span class="token string">"PluginTest doSomeThing "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>拷贝插件到私有目录，并创建插件的类加载器</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">copyPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token class-name">String</span> pluginName <span class="token operator">=</span> <span class="token string">"plugin.apk"</span><span class="token punctuation">;</span>
  <span class="token comment">// 插件所在目录</span>
  mPluginPath <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getExternalFilesDir</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">File</span><span class="token punctuation">.</span>separator <span class="token operator">+</span> pluginName<span class="token punctuation">;</span>
  <span class="token comment">// 最终拷贝到的私有目录</span>
  <span class="token class-name">String</span> targetPath <span class="token operator">=</span> mContext<span class="token punctuation">.</span><span class="token function">getDir</span><span class="token punctuation">(</span>PLUGIN_CACHE_DIR_NAME<span class="token punctuation">,</span><span class="token class-name">Context</span><span class="token punctuation">.</span>MODE_PRIVATE<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mPluginPath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果插件不存在</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"plugin not exists !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">File</span> targetFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>targetFile<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果目标目录已有插件，则删除</span>
    targetFile<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>targetFile<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 如果目标目录不存在，则创建</span>
    targetFile<span class="token punctuation">.</span><span class="token function">getParentFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 拷贝插件到私有缓存目录</span>
    <span class="token class-name">FileInputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>mPluginPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileOutputStream</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">FileUtil</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> out<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"plugin copy failed !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 创建解析插件的ClassLoader</span>
  <span class="token comment">// PLUGIN_UNCOMPRESS_DIR 插件解压地址，但是在Android8之后就无用了，插件解压地址又系统特定</span>
  mPluginClassloader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span>PLUGIN_UNCOMPRESS_DIR<span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">,</span>mContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过插件的DexClassLoader，执行插件中的方法</p> 
<pre><code class="prism language-kotlin"><span class="token comment">// 调用插件中的类方法</span>
<span class="token comment">// 通过插件的DexClassLoader加载插件中的类</span>
<span class="token keyword">val</span> pluginTestClass <span class="token operator">=</span> PluginManager<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span>pluginClassloader<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.ls.pluginapp.PluginTest"</span></span><span class="token punctuation">)</span><span class="token operator">?:</span><span class="token keyword">return</span>
<span class="token comment">// 通过反射调用类静态方法</span>
ReflectUtils<span class="token punctuation">.</span><span class="token function">reflectStaticMethod</span><span class="token punctuation">(</span>pluginTestClass<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"doSomeThing"</span></span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="DexClassLoader_109"></a>不使用DexClassLoader加载插件类</h5> 
<p>如果只是反射几个类方法，可以使用插件的类加载器执行，但是一个插件中有很多类，而且还有组件，不可能全用插件的ClassLoader.loadClass</p> 
<p>参考Android的类加载逻辑可知，ClassLoader的loadClass方法，加载类是在pathList属性中的dexElements数组中查找类的</p> 
<p>根据这个，我们可以通过反射的方式，将插件DexClassLoader中的pathList.dexElements数组，复制到宿主APK的PathClassLoader的pathList.dexElements中去</p> 
<p>这样，PathClassLoader在查找类的时候，也就可以找到插件中的类了，而不需要借助DexClassLoader去加载了</p> 
<p>热修复的思路也是如此，将需要热修复的代码打成dex包，然后把dex包下载到本地，通过DexClassLoader解析，然后将DexClassLoader中的pathList.dexElements数组中的元素，复制到PathClassLoader中的pathList.dexElements数组的最前面，这样，PathClassLoader在寻找类的时候，会先找到最前面的类，也就是热修复过的类进行加载，而在后面的原有类就被忽略掉了</p> 
<p>合并dexElements的方法</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">dexMerge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>mPluginClassloader <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token class-name">String</span> pathList <span class="token operator">=</span> <span class="token string">"pathList"</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取到宿主ClassLoader的pathList属性</span>
  <span class="token class-name">Object</span> systemPathList <span class="token operator">=</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>mContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pathList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取到插件ClassLoader的pathList属性</span>
  <span class="token class-name">Object</span> pluginPathList <span class="token operator">=</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>mPluginClassloader<span class="token punctuation">,</span>pathList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">String</span> dexElements <span class="token operator">=</span> <span class="token string">"dexElements"</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取到宿主pathList的dexElements属性</span>
  <span class="token class-name">Object</span> systemDexElements <span class="token operator">=</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>systemPathList<span class="token punctuation">,</span>dexElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取到插件pathList的dexElements属性</span>
  <span class="token class-name">Object</span> pluginDexElements <span class="token operator">=</span> <span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>pluginPathList<span class="token punctuation">,</span>dexElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>systemDexElements <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> pluginDexElements <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// dexElements获取失败</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"dexElements not found, systemDexElements = "</span> <span class="token operator">+</span> systemDexElements <span class="token operator">+</span> <span class="token string">", pluginDexElements = "</span> <span class="token operator">+</span> pluginDexElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 合并宿主的dexElements和插件的dexElements为新的dexElements数组</span>
  <span class="token class-name">Object</span> newElements <span class="token operator">=</span> <span class="token function">combineArray</span><span class="token punctuation">(</span>pluginDexElements<span class="token punctuation">,</span>systemDexElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>newElements <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// dexElements合并失败</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"dexMerge failed !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 新的dexElements数组设置给宿主的pathList中的dexElements属性</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">ReflectUtils</span><span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>systemPathList<span class="token punctuation">,</span>dexElements<span class="token punctuation">,</span>newElements<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 新的dexElements设置失败</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string">"new dexElements set failed !!!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>直接在PathClassLoader中调用插件方法</p> 
<pre><code class="prism language-kotlin"><span class="token comment">// 通过PathClassLoader加载插件中的类</span>
<span class="token keyword">val</span> pluginTestClass <span class="token operator">=</span> classLoader<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"com.ls.pluginapp.PluginTest"</span></span><span class="token punctuation">)</span><span class="token operator">?:</span><span class="token keyword">return</span>
<span class="token comment">// 通过反射调用类静态方法</span>
ReflectUtils<span class="token punctuation">.</span><span class="token function">reflectStaticMethod</span><span class="token punctuation">(</span>pluginTestClass<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"doSomeThing"</span></span><span class="token punctuation">)</span>
</code></pre> 
<h5><a id="_169"></a>如何启动组件？</h5> 
<p>Activity的启动时通过请求AMS检查通过之后，然后再启动并调用器生命周期</p> 
<p>未在AMS中注册的Activity是无法通过检查的，也就是没有在AndroidManifest.xml中注册的Activity，无法启动</p> 
<p>而插件中的组件是没有在宿主的AndroidManifest.xml中注册的，也就是无法正常启动组件</p> 
<p>而根据Activity启动逻辑可以得出如下思路，来绕过AMS检查，从而启动Activity</p> 
<h6><a id="_179"></a>启动思路</h6> 
<p>因为Activity在启动前会请求AMS检查，那么可以在AMS检查前将包含插件Activity的Intent替换为已经在宿主清单文件中注册过的Activity的Intent</p> 
<p>待AMS检查完毕之后，在Activity真正启动之前，再将包含注册过的Activity的Intent替换会包含插件Activity的Intent</p> 
<p>如此狸猫换太子，插件的Activity就得以正常启动了</p> 
<p><img src="https://images2.imgbox.com/cc/a2/aaCWFnKG_o.png" alt=""></p> 
<h6><a id="_190"></a>第一次替换</h6> 
<p>根据AMS跨进程通讯源码可知，在启动Activity之前，会将Intent传给ActivityManager的一个静态属性ActivityManagerService单例对象的startActivity方法</p> 
<p>那么通过动态代理将其单例对象的方法执行代理过来，然后在startActivity方法执行之前，将其Intent参数，替换为已经注册过的Activity的Intent，然后交给AMS去检查</p> 
<p><img src="https://images2.imgbox.com/d0/07/xgh2YV5U_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="_199"></a>第一次替换的版本适配</h6> 
<p>ActivityManager的代码在API26的时候改版过，所以，动态代理时，其属性名有所变动</p> 
<p>通过源码对比可知，其改变了获取单例的静态方法与静态属性的名称，而类型没有改变，所以我们只需要将反射的名称改变即可</p> 
<p><img src="https://images2.imgbox.com/12/20/65CRHW25_o.png" alt="在这里插入图片描述"></p> 
<p>API29之后，启动Activity就不是调用ActivityManager了，而是独立出了一个ActivityTaskManager来管理Activity</p> 
<p><img src="https://images2.imgbox.com/3a/ed/y3BVeRZh_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> boolean <span class="token function">hookAMS</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 系统是9.0及以下，获取IActivityManager单例对象</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>P<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &lt;= 25，start hook AMS !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object singleton <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token comment">// 系统是7.1及以下，获取IActivityManager单例的类名是ActivityManagerNative，属性名是gDefault</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>Build<span class="token punctuation">.</span>VERSION<span class="token punctuation">.</span>SDK_INT <span class="token operator">&lt;=</span> Build<span class="token punctuation">.</span>VERSION_CODES<span class="token punctuation">.</span>N_MR1<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> clazz <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"android.app.ActivityManagerNative"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Object gDefault <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getStaticFieldValue</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"gDefault"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      singleton <span class="token operator">=</span> gDefault<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// api &lt;= 25，get gDefault failed</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &lt;= 25，get gDefault failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 系统是9.0及以下，获取IActivityManager单例的类名是ActivityManager，属性名是IActivityManagerSingleton</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
      Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &lt;= 28，start hook AMS !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Object IActivityManagerSingleton <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getStaticFieldValue</span><span class="token punctuation">(</span>ActivityManager<span class="token punctuation">.</span>class<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"IActivityManagerSingleton"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      singleton <span class="token operator">=</span> IActivityManagerSingleton<span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token comment">// api &lt;= 25，get IActivityManagerSingleton failed</span>
        Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &lt;= 28，get IActivityManagerSingleton failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 获取单例对象的实例，也就是AMS</span>
    Object AMSObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mInstance"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> IActivityManagerClazz <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"android.app.IActivityManager"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对AMS对象进行动态代理，拦截startActivity方法，将Intent参数替换成宿主的Activity</span>
    Object AMSProxy <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>IActivityManagerClazz<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"startActivity"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"Proxy IActivityManager startActivity invoke..."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> instanceof Intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Intent intent <span class="token operator">=</span> new <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> RegisteredActivity<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"actionIntent"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">)</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> intent<span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"replaced startActivity intent"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>AMSObject<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将动态代理实例设置给单例</span>
    boolean success <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>singleton<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mInstance"</span></span><span class="token punctuation">,</span>AMSProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &lt;= 28，AMS hook failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 系统是12及以下，获取IActivityTaskManager单例对象，API29开始将单独提取出了ActivityTaskManager来管理Activity</span>
  <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &lt;= 32，start hook A(T)MS !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取ActivityTaskManager类的静态属性IActivityTaskManagerSingleton，是一个单例</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> clazz <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"android.app.ActivityTaskManager"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Object IActivityTaskManagerSingleton <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getStaticFieldValue</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"IActivityTaskManagerSingleton"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取单例的实例，即A(T)MS对象</span>
    Object AMSObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>IActivityTaskManagerSingleton<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mInstance"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> IActivityTaskManagerClazz <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"android.app.IActivityTaskManager"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 对A(T)MS对象进行动态代理，拦截startActivity方法，将Intent参数替换成宿主的Activity</span>
    Object AMSProxy <span class="token operator">=</span> Proxy<span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>Thread<span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> new Class<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>IActivityTaskManagerClazz<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>proxy<span class="token punctuation">,</span> method<span class="token punctuation">,</span> args<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"startActivity"</span></span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"Proxy IActivityTaskManager startActivity invoke..."</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>int i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> args<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> instanceof Intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            Intent intent <span class="token operator">=</span> new <span class="token function">Intent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setClass</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> RegisteredActivity<span class="token punctuation">.</span>class<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">putExtra</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"actionIntent"</span></span><span class="token punctuation">,</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">)</span> args<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            args<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> intent<span class="token punctuation">;</span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"replaced startActivity intent"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>AMSObject<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 将动态代理实例设置给单例</span>
    boolean success <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>IActivityTaskManagerSingleton<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mInstance"</span></span><span class="token punctuation">,</span>AMSProxy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &gt; 28，AMS hook failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="_302"></a>第二次替换</h6> 
<p>通过AMS的第二次跨进程通讯可知，在AMS检查完成之后，是在Binder线程，需要通过Handler发送消息到UI线程去启动Activity，而Handler执行机制会先判断并执行成员属性mCallback</p> 
<p>这里将Handler的mCallback赋值为自己写的Callback，在其中处理LAUNCHER_ACTIVITY消息，将Intent替换回包含插件Activity的Intent，让系统去启动</p> 
<p>如此，一次插件Activity的启动就完成了</p> 
<h6><a id="_310"></a>第二次替换的版本适配</h6> 
<p>ActicityThread的源码造API28是经过一次改变，所以其发送Handler消息的方式和消息ID都改变了</p> 
<p>通过源码对比可知，其消息名称从LAUNCHER_ACTIVITY变成了EXECUTE_TRANSACTION，而且因为添加了事务的原因，其msg.obj不再是简单的ActivityClientRecord对象，而是ClientTransaction对象，而Intent就会放在ClientTransaction中的callbacks集合中的某一个Item中，而callbacks集合是一个ClientTransactionItem集合，其中的LauncherActivityItem是ClientTransaction的子类，也是启动Activity的Item，Intent就在其中</p> 
<p>此时通过遍历ClientTransaction的callbacks，找到LauncherActivityItem，将其中的Intent替换回包含插件Activity的Intent，让系统去启动</p> 
<p><img src="https://images2.imgbox.com/b3/41/a6Oqxe5E_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/3d/05/OFuxziEf_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> boolean <span class="token function">hookHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 拦截AMS检查完成之后的消息，将启动Activity的消息拦截，将消息中的Intent替换会插件Activity</span>
  <span class="token comment">// 获取ActivityThread类</span>
  Class<span class="token operator">&lt;</span><span class="token operator">?</span><span class="token operator">&gt;</span> activityThreadClazz <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"android.app.ActivityThread"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取ActivityThread的静态属性sCurrentActivityThread，也是它自己的实例</span>
  Object activityThreadObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getStaticFieldValue</span><span class="token punctuation">(</span>activityThreadClazz<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"sCurrentActivityThread"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 获取ActivityThread实例的mH属性，是一个Handler消息处理器</span>
  Object mHObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>activityThreadObject<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mH"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 设置Handler的实例属性mCallback为HookHmCallback，在其中进行消息拦截</span>
  boolean success <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>mHObject<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mCallback"</span></span><span class="token punctuation">,</span>new <span class="token function">HookHmCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"api &gt; 28，Handler hook failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> success<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> HookHmCallback implements Handler<span class="token punctuation">.</span><span class="token function">Callback</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> static <span class="token keyword">final</span> int LAUNCH_ACTIVITY         <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> static <span class="token keyword">final</span> int EXECUTE_TRANSACTION <span class="token operator">=</span> <span class="token number">159</span><span class="token punctuation">;</span>


  <span class="token annotation builtin">@Override</span>
  <span class="token keyword">public</span> boolean <span class="token function">handleMessage</span><span class="token punctuation">(</span><span class="token annotation builtin">@NonNull</span> Message msg<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">switch</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>what<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      <span class="token comment">// API 21 ~ 27 启动Activity的消息是LAUNCH_ACTIVITY</span>
      case LAUNCH_ACTIVITY<span class="token operator">:</span>
      Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"HookHmCallback handleMessage LAUNCH_ACTIVITY enter !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 消息对象是ActivityClientRecord对象，其中包含Intent</span>
      <span class="token comment">// 获取intent对象</span>
      Object intentObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"intent"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>intentObject instanceof  Intent<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        Intent intent <span class="token operator">=</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">)</span> intentObject<span class="token punctuation">;</span>
        <span class="token comment">// 将之前替换缓存下来的插件Intent替换回去</span>
        Parcelable actionIntent <span class="token operator">=</span> intent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"actionIntent"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>actionIntent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
          boolean success <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"intent"</span></span><span class="token punctuation">,</span>actionIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"HookHmCallback handleMessage LAUNCH_ACTIVITY replaced !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token comment">// API 28 ~ 32，添加了事务管理，启动Activity的消息是EXECUTE_TRANSACTION</span>
      case EXECUTE_TRANSACTION<span class="token operator">:</span>
      Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"HookHmCallback handleMessage EXECUTE_TRANSACTION enter !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 启动Activity之中EXECUTE_TRANSACTION其中一条消息，需要找到属于启动Activity的那条消息</span>
      <span class="token comment">// 消息对象是ClientTransaction对象，其中有ClientTransactionItem列表</span>
      <span class="token comment">// 启动Activity的Item是LaunchActivityItem，其中包含Intent</span>
      <span class="token comment">// 获取mActivityCallbacks，Item列表对象</span>
      Object mActivityCallbacksObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>obj<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mActivityCallbacks"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>mActivityCallbacksObject instanceof List<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        List mActivityCallbacks <span class="token operator">=</span> <span class="token punctuation">(</span>List<span class="token punctuation">)</span> mActivityCallbacksObject<span class="token punctuation">;</span>
        <span class="token comment">// 循环列表</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>Object callbackItem <span class="token operator">:</span> mActivityCallbacks<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment">// 找到LaunchActivityItem对象</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>TextUtils<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>callbackItem<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"android.app.servertransaction.LaunchActivityItem"</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取LaunchActivityItem的Intent对象</span>
            Object mIntentObject <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">getFieldValue</span><span class="token punctuation">(</span>callbackItem<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mIntent"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>mIntentObject instanceof Intent<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
              Intent mIntent <span class="token operator">=</span> <span class="token punctuation">(</span>Intent<span class="token punctuation">)</span> mIntentObject<span class="token punctuation">;</span>
              <span class="token comment">// 将之前替换缓存下来的插件Intent替换回去</span>
              Parcelable actionIntent <span class="token operator">=</span> mIntent<span class="token punctuation">.</span><span class="token function">getParcelableExtra</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"actionIntent"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>actionIntent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                boolean success <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">setField</span><span class="token punctuation">(</span>callbackItem<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"mIntent"</span></span><span class="token punctuation">,</span>actionIntent<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>success<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                  Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"HookHmCallback handleMessage EXECUTE_TRANSACTION replaced !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h5><a id="_404"></a>如何加载插件资源？</h5> 
<p>资源的加载是通过Resource对象完成的，获取Resource对象可以直接使用Context的getResource方法即可，而如此获取的Resource对象是宿主的Resource，也只能加载宿主apk中的资源</p> 
<p>通过资源加载流程可知，Resource对象的创建传入了AssetManager对象，和一些手机配置，手机配置无可厚非，直接使用Context获取就好了</p> 
<p>而AssetManager是管理资源的类，其中有个方法addAssetPath，是添加资源路径的，那么想要加载插件资源，只需要创建一个新的AssetManager对象，将插件的资源路径传入addAssetPath方法，然后根据新的AssetManager对象创建新的Resource对象，作为插件的资源加载入口，即可完成资源的加载</p> 
<p>而因为插件有时也可以独立运行，所以其Resource对象不能只用新创建的，需要根据场景使用系统的Resource或新创建的Resource</p> 
<p>其实，在宿主的Application中新创建一个Resource，作为插件的Resource，然后在插件中使用时使用getApplication().getResource()，作为资源加载入口</p> 
<p>那么此时，如果插件独立运行，其Application就不是宿主的Application，获取到的Resource对象自然就是系统的Resource</p> 
<p>而作为插件运行时，其Application就是宿主的Application，其Resource是通过插件路径新创建的Resource</p> 
<p>如此，在不同场景使用都不会有问题了</p> 
<p><img src="https://images2.imgbox.com/16/b6/e7IAuI3k_o.png" alt="在这里插入图片描述"></p> 
<p>创建插件的Resources对象</p> 
<pre><code class="prism language-kotlin"><span class="token keyword">private</span> boolean <span class="token function">createPluginResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 创建属于插件的Resources对象</span>
  Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"createPluginResource: enter !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 创建Resources所需的AssetManager对象</span>
    AssetManager pluginAssetManager <span class="token operator">=</span> AssetManager<span class="token punctuation">.</span>class<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 设置AssetManager的资源路径为插件路径</span>
    boolean success <span class="token operator">=</span> ReflectUtils<span class="token punctuation">.</span><span class="token function">reflectMethod</span><span class="token punctuation">(</span>pluginAssetManager<span class="token punctuation">,</span><span class="token string-literal singleline"><span class="token string">"addAssetPath"</span></span><span class="token punctuation">,</span>mPluginPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>success<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
      Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"createPluginResource: addAssetPath failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 创建Resources对象</span>
    mPluginResources <span class="token operator">=</span> new <span class="token function">Resources</span><span class="token punctuation">(</span>pluginAssetManager<span class="token punctuation">,</span>mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDisplayMetrics</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>mContext<span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> success<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string-literal singleline"><span class="token string">"createPluginResource: AssetManager instantiation failed !!!"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>重写宿主Application的getResources方法</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Resources</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 重写宿主Application的getResources方法</span>
  <span class="token comment">// 如果存在插件的Resources对象，便返回插件的Resources</span>
  <span class="token comment">// 否则返回宿主自己的Resources</span>
  <span class="token class-name">Resources</span> pluginResources <span class="token operator">=</span> <span class="token class-name">PluginManager</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getApplicationContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPluginResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span>pluginResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> pluginResources<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>插件中写BasePluginActivity，所有的Activity都继承它，然后重写它的getResources方法</p> 
<pre><code class="prism language-kotlin"><span class="token comment">/**
 * 插件的全部Activity都继承于这个类
 */</span>
<span class="token keyword">abstract</span> <span class="token keyword">class</span> BasePluginActivity <span class="token operator">:</span> <span class="token function">AppCompatActivity</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token operator">:</span> Bundle<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onCreate</span><span class="token punctuation">(</span>savedInstanceState<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Resources <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 因为插件的全部Activity都继承于这个类，所以当Activity需要加载资源的时候，会访问这个getResources方法</span>
        <span class="token comment">// 如果获取application的resources不为空</span>
        <span class="token comment">//    如果当前app以插件形式在宿主中运行，那得到的便是宿主Application中的Resources对象</span>
        <span class="token comment">//    又因为宿主的Application返回的是插件的Resources对象，所以最终加载的仍然是插件的资源</span>
        <span class="token comment">//    如果当前app独立运行，那么得到的便是是自身的Application，那么返回的将是自身的Resources对象</span>
        <span class="token comment">// 否则返回自身的Resources对象</span>
        <span class="token keyword">val</span> pluginResources <span class="token operator">=</span> application<span class="token operator">?</span><span class="token punctuation">.</span>resources
        <span class="token keyword">if</span><span class="token punctuation">(</span>pluginResources <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> pluginResources
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">getResources</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="Android_494"></a>Android类加载器</h4> 
<p><img src="https://images2.imgbox.com/5d/e1/qZ20GAWv_o.png" alt="在这里插入图片描述"></p> 
<p><code>BootClassLoader</code>：系统启动时用于加载系统常用类，ClassLoader内部类</p> 
<p><code>PathClassLoader</code>：加载系统类和已安装的应用程序类</p> 
<p><code>DexClassLoader</code>：在未安装的情况下加载dex文件及包含dex的apk或jar，热修复和插件化的基础</p> 
<h5><a id="_504"></a>双亲委托机制</h5> 
<p>对于类加载的过程，使用到了双亲委托机制</p> 
<ul><li>可以很好地避免重复加载</li><li>可以提高类使用的安全性，将不同的类交给不同的ClassLoader</li></ul> 
<p><img src="https://images2.imgbox.com/d0/a7/tg1S5eaq_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_514"></a>类加载逻辑</h5> 
<p>类的加载首先是通过双亲委托机制找到可以加载类的ClassLoader</p> 
<p>然后ClassLoader会先找缓存，如果没有，就会调用DexPathList类型的dexPathList属性的findClass方法</p> 
<p>而DexPathList的findClass方法，实质上就是在一个Element[] dexElement数组中查找对应的类，然后返回</p> 
<p><img src="https://images2.imgbox.com/4f/fd/qaITLQfi_o.png" alt=""></p> 
<h4><a id="Activity_525"></a>Activity启动逻辑</h4> 
<h5><a id="_527"></a>两次跨进程访问</h5> 
<p>Activity的启动，考虑到安全性的问题，需要请求系统的AMS(ActivityManagerService)进行检查，如果传入的Activity没有在apk的清单文件中注册过，那么apk安装之后，AMS便无法解析到其Activity的信息，在检查时，自然就是无法通过的</p> 
<p>因为AMS是系统进程，其他apk进程想要跨进程访问，需要通过Binder机制，也就是跨进程内存拷贝机制，而AMS检查完成之后需要通知apk进程，也是跨进程通讯，也需要用到Binder机制，所以是两次跨进程通讯</p> 
<p><img src="https://images2.imgbox.com/b2/af/0u95WhYZ_o.png" alt=""></p> 
<h6><a id="Activity_536"></a>第一次，检查Activity跨进程</h6> 
<p>第一次，启动Activity，通过startActivity方法，其方法最终调到ActivityManager中，然后根据其中的AMS静态属性，访问AMS进程，并调用器startActivity方法<br> <img src="https://images2.imgbox.com/04/52/phuT6VrC_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="Intent_542"></a>第二次，传回Intent跨进程</h6> 
<p>第二次，在AMS检查Activity完成之后，想要通知apk，就需要通过Binder，而在Binder线程中无法访问UI，所以会通过ActivityThread中的mH属性，也就是Handler对象发送消息，回调到apk的UI线程，然后去启动Activity，并调用其生命周期</p> 
<p>在API28是，系统源码经过了改版，添加了事务，在代码层面，其调用复杂度成倍正价，不过其原理是万变不离其宗</p> 
<p>API28以前<br> <img src="https://images2.imgbox.com/8c/03/lXJFNfAG_o.png" alt="在这里插入图片描述"></p> 
<p>API28及以后<br> <img src="https://images2.imgbox.com/7f/fd/kinpM0E4_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_555"></a>资源加载过程</h4> 
<p>在Activity启动过程中，ActivityThread在启动Activity之前，会为其创建对应的Context对象，而Context中自然也就带有Resource对象，Resource对象的创建，需要AssetManager作为参数，AssetManager是管理apk资源的类，其中有addAssetPath方法可以添加资源所在路径</p> 
<p>AssetManger根据资源路径创建完成，Resource根据AssetManager创建完成，Context也就创建完成，Activity正式启动，调用onCreate方法<br> <img src="https://images2.imgbox.com/6d/26/9ytXOBHe_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_563"></a>面试题</h4> 
<p><img src="https://images2.imgbox.com/74/a8/gV4y14oz_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/54/ca/h995AuMx_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/76/79/FysRiFMz_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/ed/87/1vSZsKS9_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/81b0bcf449321400eab4123d74390d94/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">实现tab选项卡的几种方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/25d95f03f86ac428eb9859ca4e3aeb13/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Shell进阶脚本70个练习</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>