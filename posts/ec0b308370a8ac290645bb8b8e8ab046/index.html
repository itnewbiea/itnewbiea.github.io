<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【SqlServer】抓取sql语句的几种方法 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【SqlServer】抓取sql语句的几种方法" />
<meta property="og:description" content="SqlServer抓取sql语句方法
方法1：SqlServer在运行场景后抓取消耗时间和资源较多的sql语句（备注：每次执行场景前续清空数据库缓存）:
（1）先清除缓存：dbcc freeProcCache
（2）SELECT DB_ID(DB.dbid) &#39;数据库名&#39;
, OBJECT_ID(db.objectid) &#39;对象&#39;
, QS.creation_time &#39;编译计划的时间&#39;
, QS.last_execution_time &#39;上次执行计划的时间&#39;
, QS.execution_count &#39;执行的次数&#39;
, QS.total_elapsed_time / 1000 &#39;占用的总时间（毫秒）&#39;
, QS.total_physical_reads &#39;物理读取总次数&#39;
, QS.total_worker_time / 1000 &#39;CPU 时间总量（毫秒）&#39;
, QS.total_logical_writes &#39;逻辑写入总次数&#39;
, QS.total_logical_reads N&#39;逻辑读取总次数&#39;
, QS.total_elapsed_time / 1000 N&#39;总花费时间（毫秒）&#39;
, SUBSTRING(ST.text, ( QS.statement_start_offset / 2 ) &#43; 1,
( ( CASE statement_end_offset
WHEN -1 THEN DATALENGTH(st.text)
ELSE QS.statement_end_offset
END - QS.statement_start_offset ) / 2 ) &#43; 1) AS &#39;执行语句&#39;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ec0b308370a8ac290645bb8b8e8ab046/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2013-06-27T14:10:53+08:00" />
<meta property="article:modified_time" content="2013-06-27T14:10:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【SqlServer】抓取sql语句的几种方法</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p align="left"> <strong><span style="font-size:18px">SqlServer抓取sql语句方法</span></strong><br> 方法1：SqlServer在运行场景后抓取消耗时间和资源较多的sql语句（备注：每次执行场景前续清空数据库缓存）:<br> （1）先清除缓存：dbcc freeProcCache<br> （2）SELECT  DB_ID(DB.dbid) '数据库名'<br>       , OBJECT_ID(db.objectid) '对象'<br>       , QS.creation_time '编译计划的时间'<br>       , QS.last_execution_time '上次执行计划的时间'<br>       , QS.execution_count '执行的次数'<br>       , QS.total_elapsed_time / 1000 '占用的总时间（毫秒）'<br>       , QS.total_physical_reads '物理读取总次数'<br>       , QS.total_worker_time / 1000 'CPU 时间总量（毫秒）'<br>       , QS.total_logical_writes '逻辑写入总次数'<br>       , QS.total_logical_reads N'逻辑读取总次数'<br>       , QS.total_elapsed_time / 1000 N'总花费时间（毫秒）'<br>       , SUBSTRING(ST.text, ( QS.statement_start_offset / 2 ) + 1,<br>                   ( ( CASE statement_end_offset<br>                         WHEN -1 THEN DATALENGTH(st.text)<br>                         ELSE QS.statement_end_offset<br>                       END - QS.statement_start_offset ) / 2 ) + 1) AS '执行语句'<br> FROM    sys.dm_exec_query_stats AS QS CROSS APPLY <br>         sys.dm_exec_sql_text(QS.sql_handle) AS ST INNER JOIN<br>         ( SELECT    *<br>           FROM      sys.dm_exec_cached_plans cp CROSS APPLY<br>                     sys.dm_exec_query_plan(cp.plan_handle)<br>         ) DB<br>             ON QS.plan_handle = DB.plan_handle<br> where   SUBSTRING(st.text, ( qs.statement_start_offset / 2 ) + 1,<br>                   ( ( CASE statement_end_offset<br>                         WHEN -1 THEN DATALENGTH(st.text)<br>                         ELSE qs.statement_end_offset<br>                       END - qs.statement_start_offset ) / 2 ) + 1) not like '%fetch%'<br>                       ORDER BY QS.total_elapsed_time / 1000 DESC </p> 
<p>方法2：使用SqlServer自带工具profiler抓取相关业务执行的sql语句，并将抓取的语句。（分析在查询分析其中执行计划（注：先在工具-&gt;选项-&gt;查询执行-&gt;高级中勾选SET STATISTICS TIME和SET STATISTICS IO））</p> 
<p>方法3：采用第三方工具spotlight</p> 
<p>方法4：使用sys.dm_exec_query_stats(视图）查询视图情况</p> 备注：此文章有部分是借鉴此地址 
<a target="_blank" href="http://msdn.microsoft.com/zh-cn/library/ms189741%28v=sql.110%29.aspx" rel="nofollow noopener noreferrer">http://msdn.microsoft.com/zh-cn/library/ms189741(v=sql.110).aspx</a>编写而来。
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/895be51ddd7fccfd143b3cf44daa4dd7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C# 子窗体与父窗体之间几种传值的方式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b6e042b8a842f3e3d09e18b343dbdc90/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">各种乱码问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>