<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【深度学习】模型部署的错误整理 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【深度学习】模型部署的错误整理" />
<meta property="og:description" content="目录
Pytorch部署错误
jetson nano部署错误
Pytorch以及其他框架部署错误 1_错误1：torch.nn.modules.module.ModuleAttributeError: &#39;MainNet&#39; object has no attribute &#39;copy&#39;
解决方法：重新打包pt文件，进行加载
1_错误2：TypeError: argument for rectangle() given by name (&#39;thickness&#39;) and position (4)
解决方法：先把图片的数据类型转为uint8形式，
img=np.ascontiguousarray(img) 然后调用cv2.rectangle()函数。
1_其他1：在编写YOLOV5后处理代码时，最好使用numpy中的flatten()函数将图片转换为流
import numpy as np data = np.random.rand(3, 640, 640) print(data.flatten().shape) # (1228800,) 注：直接使用 np.flatten() Pycharm会找不到
jetson nano部署错误 2_错误1：onnxruntime.capi.onnxruntime_pybind11_state.InvalidGraph: [ONNXRuntimeError] : 10 : INVALID_GRAPH : Load model from super_resolution.onnx failed:This is an invalid model. Type Error: Type &#39;tensor(float)&#39; of input parameter (4135) of operator (ConstantOfShape) in node (ConstantOfShape_2526) is invalid." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/474923aa0f1be3a2e8e14d917cb40a09/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-09T20:13:47+08:00" />
<meta property="article:modified_time" content="2020-11-09T20:13:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【深度学习】模型部署的错误整理</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="Pytorch%E9%83%A8%E7%BD%B2%E9%94%99%E8%AF%AF-toc" style="margin-left:0px;"><a href="#Pytorch%E9%83%A8%E7%BD%B2%E9%94%99%E8%AF%AF" rel="nofollow">Pytorch部署错误</a></p> 
<p id="jetson%20nano%E9%83%A8%E7%BD%B2%E9%94%99%E8%AF%AF-toc" style="margin-left:0px;"><a href="#jetson%20nano%E9%83%A8%E7%BD%B2%E9%94%99%E8%AF%AF" rel="nofollow">jetson nano部署错误</a></p> 
<hr id="hr-toc"> 
<h2 id="Pytorch%E9%83%A8%E7%BD%B2%E9%94%99%E8%AF%AF">Pytorch以及其他框架部署错误</h2> 
<p><strong><span style="color:#f33b45;">1_错误1</span>：</strong>torch.nn.modules.module.ModuleAttributeError: 'MainNet' object has no attribute 'copy'</p> 
<p style="text-indent:33px;">解决方法：重新打包pt文件，进行加载</p> 
<p style="text-indent:0;"><strong><span style="color:#f33b45;">1_</span></strong><span style="color:#f33b45;"><strong>错误2：</strong></span>TypeError: argument for rectangle() given by name ('thickness') and position (4)</p> 
<p style="text-indent:33px;">解决方法：先把图片的数据类型转为uint8形式，</p> 
<pre><code class="language-python">img=np.ascontiguousarray(img)</code></pre> 
<p style="text-indent:33px;">然后调用cv2.rectangle()函数。</p> 
<p style="text-indent:0;"><strong><span style="color:#f33b45;">1_</span></strong><span style="color:#f33b45;"><strong>其他1</strong></span><strong>：</strong>在编写YOLOV5后处理代码时，最好使用numpy中的flatten()函数将图片转换为流</p> 
<pre><code class="language-python">import numpy as np

data = np.random.rand(3, 640, 640) 
print(data.flatten().shape)    # (1228800,)</code></pre> 
<p style="text-indent:33px;">注：直接使用 np.flatten() Pycharm会找不到</p> 
<p style="text-indent:33px;"><img alt="" height="79" src="https://images2.imgbox.com/be/c1/vxw5cg0H_o.png" width="349"></p> 
<p style="text-indent:33px;"> </p> 
<h2 id="jetson%20nano%E9%83%A8%E7%BD%B2%E9%94%99%E8%AF%AF">jetson nano部署错误</h2> 
<p><strong><span style="color:#f33b45;">2_错误1</span>：</strong>onnxruntime.capi.onnxruntime_pybind11_state.InvalidGraph: [ONNXRuntimeError] : 10 : INVALID_GRAPH : Load model from super_resolution.onnx failed:This is an invalid model. Type Error: Type 'tensor(float)' of input parameter (4135) of operator (ConstantOfShape) in node (ConstantOfShape_2526) is invalid.</p> 
<p style="text-indent:33px;">解决方法：torch.onnx.export中<span style="color:#f33b45;">opset_version版本错误</span>，我的环境是Python3.8 + torch1.6 + torchvision 0.7，需要将opset_version=12（Pytorch官网的示例给的10，默认为9，YoloV5源码中给的opset_version=12）</p> 
<pre><code class="language-python">"""
# 打包与测试代码 
# 环境：Python3.8 pytorch1.6  torchvision0.7 
"""

# Some standard imports 
import numpy as np
import torch.onnx
import onnx,onnxruntime

from net import MainNet

torch_model = MainNet()

batch_size = 1

# Initialize model with the pretrained weights
map_location = lambda storage, loc: storage
if torch.cuda.is_available():
    map_location = None

torch_model.load_state_dict(torch.load(r"weights\70.pt", map_location=map_location),)

# set the model to inference mode
torch_model.eval()

x = torch.randn(batch_size, 3, 315, 315, requires_grad=True)
torch_out = torch_model(x)

# Export the model
torch.onnx.export(torch_model,               # model being run
                  x,                         # model input (or a tuple for multiple inputs)
                  "super_resolution.onnx",   # where to save the model (can be a file or file-like object)
                  export_params=True,        # store the trained parameter weights inside the model file
                  opset_version=12,          # the ONNX version to export the model to
                  do_constant_folding=True,  # whether to execute constant folding for optimization
                  input_names = ['input'],   # the model's input names
                  output_names = ['output'], # the model's output names
                  dynamic_axes={'input' : {0 : 'batch_size'},    # variable lenght axes
                                'output' : {0 : 'batch_size'}})


onnx_model = onnx.load("super_resolution.onnx")

onnx.checker.check_model(onnx_model)
print(1)    """ 使用print检测哪里出错了 """

ort_session = onnxruntime.InferenceSession("super_resolution.onnx")

""" 未使用 """
def to_numpy(tensor):
    return tensor.detach().cpu().numpy() if tensor.requires_grad else tensor.cpu().numpy()

# compute ONNX Runtime output prediction
ort_inputs = {ort_session.get_inputs()[0].name: x.detach().numpy() }
ort_outs = ort_session.run(None, ort_inputs)
print(2)

# compare ONNX Runtime and PyTorch results
""" Pytorch官网给的测试代码是不符合我的环境版本的，下面是错误实例 """
np.testing.assert_allclose(to_numpy(torch_out), ort_outs[0], rtol=1e-03, atol=1e-05)

""" 这是修改后的 """
np.testing.assert_allclose(torch_out[0].detach().numpy() , ort_outs[0], rtol=1e-03, atol=1e-05)

print("Exported model has been tested with ONNXRuntime, and the result looks good!")</code></pre> 
<p><strong><span style="color:#f33b45;">2_错误2</span>：</strong>pycuda._driver.LogicError: cuMemcpyHtoDAsync failed: invalid argument</p> 
<p style="text-indent:33px;">原因：TensorRt接收到的图片大小和当初打包ONNX时，占位的“input”大小不一样</p> 
<p style="text-indent:33px;">解决方法：使用<span style="color:#f33b45;">cv2.resize(img, ( w, h))</span> 进行变形或使用<span style="color:#f33b45;">cv2.copyMakeBorder(src, top, bottom, left, right, borderType, dst=None, value=None)</span>进行填充图片</p> 
<p style="text-indent:33px;">拓展：<a href="https://blog.csdn.net/weixin_34910922/article/details/109037254">cv2之padding扩充——cv2.copyMakeBorder</a></p> 
<p style="text-indent:0;"><strong><span style="color:#f33b45;">2_</span></strong><span style="color:#f33b45;"><strong>错误3：</strong></span>把onnx模型转TensorRT模型的trt模型报错：Your ONNX model has been generated with INT64 weights. while TensorRT does not natively support INT64. Attempting to cast down to INT32. </p> 
<p style="text-indent:33px;">解决方法：</p> 
<p style="text-indent:33px;">1、安装onnx-simplifier</p> 
<pre><code class="language-python">pip install onnx-simplifier </code></pre> 
<p style="text-indent:33px;">2、把之前转化的onnx模型转化为占位更少的onnx模型</p> 
<pre><code class="language-python">python -m onnxsim complex.onnx sim.onnx</code></pre> 
<p style="text-indent:33px;">3、然后在把onnx模型转换为TensorRT的trt模型</p> 
<blockquote> 
 <p>更新日志：</p> 
 <p style="text-indent:33px;">2020/11/9 --- 更新1_错误1和1_错误2</p> 
 <p style="text-indent:33px;">2020/11/11 --- 更新2_错误3和1_其他1</p> 
 <p style="text-indent:33px;">2020/12/4 --- 更新2_错误3和1_错误2</p> 
 <p>作者：阳一子</p> 
 <p>本文地址：<a href="https://blog.csdn.net/qq_279033270/article/details/109583514">https://blog.csdn.net/qq_279033270/article/details/109583514</a></p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/10aeeefeb63b82d24463864713be58c8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Markdown换行语法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/321915fbc7915ab7c8aa3de19be1ebcd/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python字符串的大小写转换</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>