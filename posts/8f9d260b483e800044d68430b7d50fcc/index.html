<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>交换机堆叠和集群配置与管理——1 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="交换机堆叠和集群配置与管理——1" />
<meta property="og:description" content="交换机堆叠和集群是两种可解决单台交换机性能不足、容易出现单点故障问题的交换机管理技术。实现堆叠和集群后的各成员交换机一起可看成一台逻辑交换机系统，可通过一个IP地址进行管理，各成员交换机间还可以实现负载均衡和容错。
华为交换机中堆叠技术为iStack（IntelligentStack，智能堆叠）；集群技术称之为CSS（Cluster Switch System，集群交换机系统）。但不同交换机系列所支持的堆叠或集群连接方式有所不同（有通过专门的堆叠卡或集群卡连接的，有通过普通业务口连接的）。这两种交换机管理技术在工作原理、配制方法和功能支持上存在许多相似性，但iStack堆叠中可以支持的成员交换机更多（对多9台），CSS只支持两台交换机的集群。
iStack基础
交换机堆叠是一种提高端口可用背板带宽，扩展交换机端口，提高可靠性，集中管理多台交换机的技术。
一、iStack概述
在iStack堆叠系统建立前，每台成员交换机都是单独的实体，都有自己独立的IP地址和MAC地址，对外体现为多台交换机。在iStack堆叠系统建立后，堆叠中的所有成员交换机对外体现为一个统一的逻辑实体，用户使用一个IP地址就可以对堆叠中的所有交换机进行管理和维护。
1、交换机角色
在iStack中所有的单台交换机都称为成员交换机，按照各自动能的不同分为以下三种角色：
（1）主交换机。主交换机在堆叠配置文件中显示为Master，负责整个读碟系统的管理。一个交换机堆叠只有一台主交换机。
（2）备交换机。备交换机在堆叠配置文件中显示为Standby，是主交换机的备用交换机，用于当原主交换机出现故障时接替主交换机工作，一个交换机堆叠也只有一台备交换机。
（3）从交换机。从交换机在堆叠配置文件中显示为Slave。除了主交换机外的其他所有交换机（包括备交换机）都是从交换机。
2、堆叠ID
为了便于识别和管理交换机堆叠中各成员交换机，为所有成员交换机（包括主交换机和备交换机）都分配了一个堆叠ID，即成员编号（MemberID）。且每个成员交换机的堆叠ID都是唯一的。
3、堆叠优先级
哪台交换机担当主备交换机角色呢？就要用到堆叠优先级属性了，用于堆叠角色选举过程中确定主交换机和备交换机角色。优先级值越大表示优先级越高。
4、堆叠物理成员端口
指采用普通业务口堆叠连接方式时，各成员交换机上用于堆叠连接的物理业务端口，不是指堆叠卡上的专门堆叠接口。
5、堆叠端口
指采用普通业务口堆叠连接方式时用于堆叠连接的逻辑端口，需要和堆叠物理成员端口绑定，即向逻辑堆叠端口中添加物理成员端口。堆叠的每台成员交换机上支持两个堆叠端口：Stack-Portn/1和Stac-Portn/2，其中n为成员交换机的堆叠ID。
二、iStack特性的产品支持
不同型号交换机之间不能混合堆叠。
1、堆叠主、备交换机选举
堆叠建立时，成员交换机之间相互发送堆叠竞争报文，选举出主、从交换机。当从交换机的VRP系统版本号与主交换机不一致时，从交换机将自动同步主交换机的VRP系统软件版本，复位重启后加入堆叠系统。主交换机收集成员信息并计算堆叠拓扑，然后将堆叠拓扑信息同步到所有的成员交换机。
主交换机选举规则：
（1）首先进行运行状态比较，已经运行的堆叠交换机中最先处于启动状态的交换机将被选举为主交换机。
（2）如果有多台成员交换机都已处于启动状态，则再对这些交换机进行堆叠优先级比较，堆叠优先级高的选举为主交换机。
（3）如果某些成员交换机的堆叠优先级一样，则再对这些成员交换机进行MAC地址比较，MAC地址小的交换机优先选举为主交换机。
备交换机选举规则：
（1）除主交换机外其他各成员交换机中最先处于启动状态的交换机成为备份交换机。
（2）如果有多台除主交换机外的其他交换机同时完成启动时，则这些成员交换机中堆叠优先级最高的交换机成为备交换机。
（3）如果以上这些交换机的堆叠优先级相同，则MAC地址最小的选为备交换机。
2、堆叠连接方式
不同S系列交换机的iStack堆叠连接方式不完全一样。S2700和S3700系列主要支持堆叠卡连接方式，是通过专门的堆叠卡中提供的堆叠端口（也可使用复用上行千兆口作为堆叠端口）和专用的SFP高速堆叠电缆连接的。
S5700和S6700系列支持以下两种堆叠连接方式：
（1）堆叠卡连接：各成员交换机之间通过专用的堆叠卡ETPC和专用的PCI-E堆叠电缆连接。
（2）业务口连接：各成员交换机间通过堆叠端口绑定的堆叠物理成员端口和SFP&#43;高速电缆相连。不需要专用的堆叠插卡。
3、堆叠连接拓扑结构
华为S系列交换机iStack堆叠的连接拓扑结构有“链形连接”和“环形连接”。环形连接拓扑结构是堆叠成员交换机通过堆叠端口交叉端口交叉相连形成一个“环”形结构。
链形结构拓扑结构中处于链两端的交换机只使用一个堆叠端口与邻居交换机相连，最终形成一个“链条”形结构（有点像交换机“级联”）。
环形结构拓扑比链形连接拓扑具有更高的可靠性，因为当链形连接拓扑结构中出现链路故障时会引起堆叠分裂；而当环形连接拓扑结构中某条链路故障时会形成链形连接，整体堆叠的业务不会受到影响。
4、堆叠的管理和维护
iStack堆叠建立后，所有的成员交换机形成一台逻辑交换机存在于网络中，所有成员交换机的资源由堆叠主交换机统一管理。用户可以通过任意一台成员交换机的网管接口或串口登录堆叠系统，对整个堆叠系统进行管理和维护。但同一时刻只能由一个网管接口或串口登录。堆叠后的交换机接口编号为：堆叠ID/子卡号/端口号。
5、堆叠成员加入
在iStack堆叠维护和使用过程中会继续进行拓扑收集工作，当发现有新的成员交换机（已配置了堆叠连接和堆叠功能）加入时会根据新加入交换机的状态采取不同的处理。
（1）如果新加入的交换机本身未形成堆叠，则新加入的交换机会被选为从交换机，堆叠系统中原有主、备角色不变。
（2）如果新加入的交换机本身已经形成了堆叠，此时相当于两个堆叠合并。这种情况下，两个堆叠系统的主交换机将选举出一个更优的交换机作为新堆叠系统的主交换机，其中一个堆叠系统（新主交换机所在堆叠系统）将保持不变，业务也不会受到影响；而另一个堆叠系统的所有交换机将重新启动后加入新堆叠，并将同步主交换机的配置，该堆叠的原有业务也将中断。
6、堆叠成员退出
iStack堆叠成员退出是指成员交换机从堆叠系统中离开，断开堆叠连接。此时会因为退出成员的角色不同对堆叠系统的影响有所不同。
（1）主交换机退出：备交换机升级为主交换机，更新堆叠拓扑结构并指定一个新的备交换机。
（2）备交换机退出：主交换机更新堆叠拓扑结构并指定一个新的备交换机。
（3）从交换机退出：主交换机更新堆叠拓扑结构。
7、堆叠主、备切换和堆叠系统MAC地址切换
当iStack堆叠系统成功建立后，如果主交换机故障或脱离堆叠系统，则备交换机自动升级为主交换机，然后由新的主交换机指定新的备交换机，进行主、备交换机数据同步。这里的堆叠主、备切换，以及堆叠系统MAC地址的切换又要区分3种情况：
（1）当堆叠系统第一次成功建立后，此时堆叠系统的MAC地址是主交换机的MAC地址。当主交换机发生故障或脱离堆叠系统时，在去使能堆叠系统MAC地址延时切换功能的情况下，系统MAC地址会立刻切换为新的主交换机的MAC地址。缺省使能堆叠系统延时切换功能，延时时间为10min。
（2）当堆叠系统成功建立之后，如果主交换机故障或脱离堆叠系统，如果堆叠系统配置了系统MAC地址切换时间，且在切换定时器超时时间内旧主交换机还没有重新加入堆叠系统，则新主交换机将堆叠系统的MAC地址切换为自己的MAC，反之，如果在切换定时器超时时间内旧主交换机重新加入堆叠系统，此时系统旧主交换机变为从交换机，但堆叠系统的MAC地址不切换。相当于，此时堆叠系统的MAC地址为从交换机MAC地址。
（3）当堆叠交换机中有从交换机离开时，如果离开的从交换机的MAC地址是堆叠系统的MAC地址，且该交换机在切换定时器超时时间内没有重新加入堆叠，则主交换机将堆叠系统MAC地址切换为自己的MAC地址。
8、堆叠分裂
iStack堆叠分裂是指稳态运行的堆叠系统中带电移出部分成员交换机，或者堆叠系统线缆多点故障导致一个堆叠系统变成多个堆叠系统。
堆叠系统分裂后，可能产生多个有相同配置的堆叠系统，导致网络中IP地址和MAC地址的冲突，引起网络故障。
9、双主检测
双主检测DAD（Dual-ActiveDetection），是一种检测和处理堆叠分裂的协议，可以实现堆叠分裂的检测、冲突处理和故障恢复，降低堆叠分裂对业务的影响，仅S5700和S6700系列支持，且仅支持由两台交换机组成的堆叠系统。
双主检测方式有两种：直连检测方式和Relay代理检测方式。
（1）直连检测方式：如上图，堆叠成员交换机间通过专用直连链路进行双主检测。在直连检测方式中，堆叠系统正常运行时，为了减轻CPU负担不发送DAD报文；堆叠系统分裂后，堆叠成员交换机以1s为周期通过检测链路发送DAD报文。
（2）Relay代理检测方式。如上图，Relay代理检测方式在堆叠系统跨交换机Eth-trunk上启用DAD检测，在代理交换机上启用DAD代理功能。代理交换机必须为支持DAD Relay代理功能的交换机。
在Relay代理检测方式中，堆叠系统正常运行时堆叠成员交换机以30s为周期通过检测链路发送DAD报文。堆叠成员交换机对在正常工作状态下收到的DAD报文不做任何处理；堆叠系统分裂后，堆叠成员交换机以1s为周期通过检测链路发送DAD报文。
堆叠分裂后，分裂成多部分的堆叠系统会在检测链路上相互发送DAD竞争报文。堆叠系统将接收到的报文信息与本部分竞争信息做比较：如本部分竞争为主交换机则不作处理，保持Active状态，正常转发业务报文；如果本部分竞争为备交换机，则需要关闭除保留端口（交换机上不会被关闭的端口）外的所有业务端口，转入Recovery状态，停止转发业务报文。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8f9d260b483e800044d68430b7d50fcc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2017-04-21T12:26:27+08:00" />
<meta property="article:modified_time" content="2017-04-21T12:26:27+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">交换机堆叠和集群配置与管理——1</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>交换机堆叠和集群是两种可解决单台交换机性能不足、容易出现单点故障问题的交换机管理技术。实现堆叠和集群后的各成员交换机一起可看成一台逻辑交换机系统，可通过一个IP地址进行管理，各成员交换机间还可以实现负载均衡和容错。</p> 
<p>华为交换机中堆叠技术为iStack（IntelligentStack，智能堆叠）；集群技术称之为CSS（Cluster Switch System，集群交换机系统）。但不同交换机系列所支持的堆叠或集群连接方式有所不同（有通过专门的堆叠卡或集群卡连接的，有通过普通业务口连接的）。这两种交换机管理技术在工作原理、配制方法和功能支持上存在许多相似性，但iStack堆叠中可以支持的成员交换机更多（对多9台），CSS只支持两台交换机的集群。</p> 
<p align="center"><strong><span style="color:red">iStack</span><span style="color:red">基础</span></strong></p> 
<p>交换机堆叠是一种提高端口可用背板带宽，扩展交换机端口，提高可靠性，集中管理多台交换机的技术。</p> 
<p><img alt="" src="https://images2.imgbox.com/5e/9d/8kNXvCnc_o.png"><br> </p> 
<p></p> 
<p><strong>    一、iStack概述</strong></p> 
<p>在iStack堆叠系统建立前，每台成员交换机都是单独的实体，都有自己独立的IP地址和MAC地址，对外体现为多台交换机。在iStack堆叠系统建立后，堆叠中的所有成员交换机对外体现为一个统一的逻辑实体，用户使用一个IP地址就可以对堆叠中的所有交换机进行管理和维护。</p> 
<p>1、交换机角色</p> 
<p>在iStack中所有的单台交换机都称为成员交换机，按照各自动能的不同分为以下三种角色：</p> 
<p>（1）主交换机。主交换机在堆叠配置文件中显示为Master，负责整个读碟系统的管理。<strong>一个交换机堆叠只有一台主交换机</strong>。</p> 
<p>（2）备交换机。备交换机在堆叠配置文件中显示为Standby，是主交换机的备用交换机，用于当原主交换机出现故障时接替主交换机工作，<strong>一个交换机堆叠也只有一台备交换机</strong>。</p> 
<p>（3）从交换机。从交换机在堆叠配置文件中显示为Slave。除了主交换机外的其他所有交换机（<strong>包括备交换机</strong>）都是从交换机。</p> 
<p>2、堆叠ID</p> 
<p>为了便于识别和管理交换机堆叠中各成员交换机，为所有成员交换机（包括主交换机和备交换机）都分配了一个堆叠ID，即成员编号（MemberID）。且每个成员交换机的堆叠ID都是唯一的。</p> 
<p>3、堆叠优先级</p> 
<p>哪台交换机担当主备交换机角色呢？就要用到堆叠优先级属性了，用于堆叠角色选举过程中确定主交换机和备交换机角色。优先级值越大表示优先级越高。</p> 
<p>4、堆叠物理成员端口</p> 
<p>指采用普通业务口堆叠连接方式时，各成员交换机上用于堆叠连接的物理业务端口，不是指堆叠卡上的专门堆叠接口。</p> 
<p>5、堆叠端口</p> 
<p>指采用普通业务口堆叠连接方式时用于堆叠连接的逻辑端口，需要和堆叠物理成员端口绑定，即向逻辑堆叠端口中添加物理成员端口。堆叠的每台成员交换机上支持两个堆叠端口：Stack-Portn/1和Stac-Portn/2，其中n为成员交换机的堆叠ID。</p> 
<p><strong>二、iStack特性的产品支持</strong></p> 
<p>不同型号交换机之间不能混合堆叠。</p> 
<p>1、堆叠主、备交换机选举</p> 
<p>堆叠建立时，成员交换机之间相互发送堆叠竞争报文，选举出主、从交换机。当从交换机的VRP系统版本号与主交换机不一致时，从交换机将自动同步主交换机的VRP系统软件版本，复位重启后加入堆叠系统。主交换机收集成员信息并计算堆叠拓扑，然后将堆叠拓扑信息同步到所有的成员交换机。</p> 
<p>主交换机选举规则：</p> 
<p>（1）首先进行运行状态比较，已经运行的堆叠交换机中最先处于启动状态的交换机将被选举为主交换机。</p> 
<p>（2）如果有多台成员交换机都已处于启动状态，则再对这些交换机进行堆叠优先级比较，堆叠优先级高的选举为主交换机。</p> 
<p>（3）如果某些成员交换机的堆叠优先级一样，则再对这些成员交换机进行MAC地址比较，MAC地址小的交换机优先选举为主交换机。</p> 
<p>备交换机选举规则：</p> 
<p>（1）除主交换机外其他各成员交换机中最先处于启动状态的交换机成为备份交换机。</p> 
<p>（2）如果有多台除主交换机外的其他交换机同时完成启动时，则这些成员交换机中堆叠优先级最高的交换机成为备交换机。</p> 
<p>（3）如果以上这些交换机的堆叠优先级相同，则MAC地址最小的选为备交换机。</p> 
<p>2、堆叠连接方式</p> 
<p>不同S系列交换机的iStack堆叠连接方式不完全一样。S2700和S3700系列主要支持堆叠卡连接方式，是通过专门的堆叠卡中提供的堆叠端口（也可使用复用上行千兆口作为堆叠端口）和专用的SFP高速堆叠电缆连接的。</p> 
<p>S5700和S6700系列支持以下两种堆叠连接方式：</p> 
<p>（1）堆叠卡连接：各成员交换机之间通过专用的堆叠卡ETPC和专用的PCI-E堆叠电缆连接。</p> 
<p>（2）业务口连接：各成员交换机间通过堆叠端口绑定的堆叠物理成员端口和SFP+高速电缆相连。不需要专用的堆叠插卡。</p> 
<img alt="" src="https://images2.imgbox.com/1d/f9/9gjQf2vf_o.png"> 
<br> 
<p></p> 
<p>3、堆叠连接拓扑结构</p> 
<p>华为S系列交换机iStack堆叠的连接拓扑结构有“链形连接”和“环形连接”。环形连接拓扑结构是堆叠成员交换机通过堆叠端口交叉端口交叉相连形成一个“环”形结构。</p> 
<img alt="" src="https://images2.imgbox.com/f2/f7/Scw84wNl_o.png"> 
<br> 
<p></p> 
<p> 链形结构拓扑结构中处于链两端的交换机只使用一个堆叠端口与邻居交换机相连，最终形成一个“链条”形结构（有点像交换机“级联”）。</p> 
<p><img alt="" src="https://images2.imgbox.com/c1/fa/URPgqbfB_o.png"><br> </p> 
<p></p> 
<p>环形结构拓扑比链形连接拓扑具有更高的可靠性，因为当链形连接拓扑结构中出现链路故障时会引起堆叠分裂；而当环形连接拓扑结构中某条链路故障时会形成链形连接，整体堆叠的业务不会受到影响。</p> 
<p>4、堆叠的管理和维护</p> 
<p>iStack堆叠建立后，所有的成员交换机形成一台逻辑交换机存在于网络中，所有成员交换机的资源由堆叠主交换机统一管理。用户可以通过任意一台成员交换机的网管接口或串口登录堆叠系统，对整个堆叠系统进行管理和维护。但同一时刻只能由一个网管接口或串口登录。堆叠后的交换机接口编号为：堆叠ID/子卡号/端口号。</p> 
<p>5、堆叠成员加入</p> 
<p>在iStack堆叠维护和使用过程中会继续进行拓扑收集工作，当发现有新的成员交换机（已配置了堆叠连接和堆叠功能）加入时会根据新加入交换机的状态采取不同的处理。</p> 
<p>（1）如果新加入的交换机本身未形成堆叠，则新加入的交换机会被选为从交换机，堆叠系统中原有主、备角色不变。</p> 
<p>（2）如果新加入的交换机本身已经形成了堆叠，此时相当于两个堆叠合并。这种情况下，两个堆叠系统的主交换机将选举出一个更优的交换机作为新堆叠系统的主交换机，其中一个堆叠系统（新主交换机所在堆叠系统）将保持不变，业务也不会受到影响；而另一个堆叠系统的所有交换机将重新启动后加入新堆叠，并将同步主交换机的配置，该堆叠的原有业务也将中断。</p> 
<p>6、堆叠成员退出</p> 
<p>iStack堆叠成员退出是指成员交换机从堆叠系统中离开，断开堆叠连接。此时会因为退出成员的角色不同对堆叠系统的影响有所不同。</p> 
<p>（1）主交换机退出：备交换机升级为主交换机，更新堆叠拓扑结构并指定一个新的备交换机。</p> 
<p>（2）备交换机退出：主交换机更新堆叠拓扑结构并指定一个新的备交换机。</p> 
<p>（3）从交换机退出：主交换机更新堆叠拓扑结构。</p> 
<p>7、堆叠主、备切换和堆叠系统MAC地址切换</p> 
<p>当iStack堆叠系统成功建立后，如果主交换机故障或脱离堆叠系统，则备交换机自动升级为主交换机，然后由新的主交换机指定新的备交换机，进行主、备交换机数据同步。这里的堆叠主、备切换，以及堆叠系统MAC地址的切换又要区分3种情况：</p> 
<p>（1）当堆叠系统第一次成功建立后，此时堆叠系统的MAC地址是主交换机的MAC地址。当主交换机发生故障或脱离堆叠系统时，在去使能堆叠系统MAC地址延时切换功能的情况下，系统MAC地址会立刻切换为新的主交换机的MAC地址。缺省使能堆叠系统延时切换功能，延时时间为10min。</p> 
<p>（2）当堆叠系统成功建立之后，如果主交换机故障或脱离堆叠系统，如果堆叠系统配置了系统MAC地址切换时间，且在切换定时器超时时间内旧主交换机还没有重新加入堆叠系统，则新主交换机将堆叠系统的MAC地址切换为自己的MAC，反之，如果在切换定时器超时时间内旧主交换机重新加入堆叠系统，此时系统旧主交换机变为从交换机，但<strong>堆叠系统的MAC地址不切换</strong>。相当于，<strong>此时堆叠系统的MAC地址为从交换机MAC地址</strong>。</p> 
<p>（3）当堆叠交换机中有从交换机离开时，如果离开的从交换机的MAC地址是堆叠系统的MAC地址，且该交换机在切换定时器超时时间内没有重新加入堆叠，则主交换机将堆叠系统MAC地址切换为自己的MAC地址。</p> 
<p>8、堆叠分裂</p> 
<p>iStack堆叠分裂是指稳态运行的堆叠系统中带电移出部分成员交换机，或者堆叠系统线缆多点故障导致一个堆叠系统变成多个堆叠系统。</p> 
<img alt="" src="https://images2.imgbox.com/10/1d/ZdKcTHp3_o.png"> 
<br> 
<p></p> 
<p>堆叠系统分裂后，可能产生多个有相同配置的堆叠系统，导致网络中IP地址和MAC地址的冲突，引起网络故障。</p> 
<p>9、双主检测</p> 
<p>双主检测DAD（Dual-ActiveDetection），是一种检测和处理堆叠分裂的协议，可以实现堆叠分裂的检测、冲突处理和故障恢复，降低堆叠分裂对业务的影响，仅S5700和S6700系列支持，且仅支持由两台交换机组成的堆叠系统。</p> 
<p>双主检测方式有两种：直连检测方式和Relay代理检测方式。</p> 
<img alt="" src="https://images2.imgbox.com/5d/68/UszsqBA4_o.png"> 
<br> 
<p></p> 
<p>（1）直连检测方式：如上图，堆叠成员交换机间通过专用直连链路进行双主检测。在直连检测方式中，堆叠系统正常运行时，为了减轻CPU负担不发送DAD报文；堆叠系统分裂后，堆叠成员交换机以1s为周期通过检测链路发送DAD报文。</p> 
<img alt="" src="https://images2.imgbox.com/ef/87/8Wt0pQkT_o.png"> 
<br> 
<p></p> 
<p>（2）Relay代理检测方式。如上图，Relay代理检测方式在堆叠系统跨交换机Eth-trunk上启用DAD检测，在代理交换机上启用DAD代理功能。代理交换机必须为支持DAD Relay代理功能的交换机。</p> 
<p>在Relay代理检测方式中，堆叠系统正常运行时堆叠成员交换机以30s为周期通过检测链路发送DAD报文。堆叠成员交换机对在正常工作状态下收到的DAD报文不做任何处理；堆叠系统分裂后，堆叠成员交换机以1s为周期通过检测链路发送DAD报文。</p> 
<p>堆叠分裂后，分裂成多部分的堆叠系统会在检测链路上相互发送DAD竞争报文。堆叠系统将接收到的报文信息与本部分竞争信息做比较：如本部分竞争为主交换机则不作处理，保持Active状态，正常转发业务报文；如果本部分竞争为备交换机，则需要关闭除保留端口（交换机上不会被关闭的端口）外的所有业务端口，转入Recovery状态，停止转发业务报文。</p> 
<p align="center"><strong><span style="color:red">iStack</span><span style="color:red">配置与管理</span></strong></p> 
<p>一、iStack堆叠配置任务</p> 
<p>iStack堆叠的最基本配置包括几个方面：使能堆叠功能，指定堆叠端口，配置堆叠ID和堆叠优先级，其他可选配置任务。堆叠卡连接方式和业务口连接方式的堆叠建立流程如下图：</p> 
<img alt="" src="https://images2.imgbox.com/ae/4a/8jDLD8nm_o.png"> 
<br> 
<p></p> 
<p>重新启动交换机使堆叠建立后，用户可以根据实际需求有选择的配置堆叠系统保留VLAN、堆叠系统MAC地址的切换时间和接口指示灯显示堆叠ID。</p> 
<p>1、（可选）配置堆叠端口（<strong>业务口连接方式必选</strong>）</p> 
<p>使用普通的业务口作为堆叠端口的物理成员端口。当堆叠成员交换机间通过业务口方式连接时，需要将普通的业务口配置为堆叠物理成员端口，并将其加入到逻辑堆叠端口中。堆叠端口必须和堆叠物理成员端口绑定才能有效。一个堆叠端口中可以加入多个堆叠物理成员端口。</p> 
<p>2、（可选）使能堆叠功能（<strong>堆叠卡连接方式必选</strong>）</p> 
<p>3、（可选）配置堆叠ID</p> 
<p>堆叠中所有成员交换机的堆叠ID都是唯一的。堆叠系统建立时，如果成员交换机的堆叠ID有冲突，主交换机将为冲突的成员交换机重新分配堆叠ID。</p> 
<p>4、（可选）配置堆叠优先级</p> 
<p>优先级值越大表示优先级越高，缺省每台成员交换机的缺省优先级是100。</p> 
<p>5、重新启动交换机</p> 
<p>6、（可选）配置主备倒换</p> 
<p>在iStack堆叠系统建立之后，如果主交换机出现故障或者脱离堆叠系统，则原来的备交换机自动提升为主交换机，然后根据选举规则确定新的备交换机，这是自动切换。还有一种人工强制倒换主、备交换机角色的情况。两种情况都涉及一个堆叠系统MAC地址的重新确定问题，具体要依据以下3种情况而定（当堆叠系统第一次成功建立后，此时堆叠系统的MAC地址是主交换机的MAC）</p> 
<p>（1）如果去使能了堆叠系统MAC地址延时切换功能，则堆叠系统MAC地址会立刻切换为新主交换机的MAC地址（缺省使能堆叠系统MAC地址延时切换功能，延迟10min）。</p> 
<p>（2）如果使能了堆叠系统MAC地址延时切换功能，在切换定时器超时时间内，如果旧主交换机还没有重新加入堆叠，新主交换机将堆叠系统MAC切换为自己的MAC；如果切换定时器超时时间内，旧主交换机重新加入堆叠，则旧主交换机变为从交换机，堆叠系统的MAC地址不切换，为旧主交换机的MAC地址。</p> 
<p>（3）如果现为从交换机，并且其MAC是堆叠系统的MAC地址，则当该交换机在切换定时器超时时间内没有从新加入堆叠时，新主交换机将堆叠系统MAC切换为自己的MAC。</p> 
<p>7、（可选）配置堆叠系统保留VLAN</p> 
<p>缺省堆叠系统使用VLAN4093作为堆叠系统的保留VLAN，用于堆叠协议报文的交互，其他业务不能使用此VLAN。</p> 
<p>8、（可选）配置堆叠系统MAC地址的切换时间</p> 
<p>区分两种情况：</p> 
<p>（1）如果在堆叠系统建立之前在所有成员交换机上已各自完成了系统MAC地址切换时间的配置，则在堆叠系统建立后系统MAC地址切换时间为主交换机上配置的切换时间。</p> 
<p>（2）如果在堆叠系统建立之后配置系统MAC地址切换时间，则在发生主备倒换后，但原主交换机仍在堆叠系统中，堆叠系统重启后系统MAC地址不发生改变，不会发生MAC切换。</p> 
<p>9、（可选）配置接口指示灯显示堆叠ID</p> 
<p><strong>二、配置iStack堆叠</strong></p> 
<p><img alt="" src="https://images2.imgbox.com/a6/42/PVxtgvko_o.png"><br> <img alt="" src="https://images2.imgbox.com/e7/e7/5q7wDpQg_o.png" width="664" height="957"><br> <img alt="" src="https://images2.imgbox.com/22/73/0LwcSGtQ_o.png"><br> <img alt="" src="https://images2.imgbox.com/ed/a7/auBj2cRp_o.png" width="662" height="403"><br> <br> <img src="https://images2.imgbox.com/a4/76/bWhQB4Or_o.png" alt=""></p> 
<p><span style="font-size:14px"><strong>三、<span style="font-family:Calibri">iStack</span>堆叠管理</strong></span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">1</span>）<span style="font-family:Calibri">display stack</span>查看堆叠成员交换机堆叠信息，包括堆叠拓扑和堆叠成员等信息</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">2</span>）<span style="font-family:Calibri">display stack peers</span>查看堆叠系统中成员交换机各堆叠端口相连的邻居信息。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">3</span>）<span style="font-family:Calibri">display stack configuration [slot slot-id]</span>查看所有或指定堆叠<span style="font-family:Calibri">ID</span>的成员交换机的堆叠配置信息，包括堆叠成员交换机当前以及下次启动时的堆叠<span style="font-family:Calibri">ID</span>、优先级信息。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">4</span>）在<span style="font-family:Calibri">S5700LI</span>和<span style="font-family:Calibri">S5710EI</span>中使用<span style="font-family:Calibri">display stack-port membership [slot-id/port-id] | membership [slot-id/port-id]</span>查看指定或所有成员交换机<span style="font-family:Calibri">/</span>堆叠端口下的成员端口信息。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">5</span>）在<span style="font-family:Calibri">S6700</span>中使用<span style="font-family:Calibri">display stack-port {global load-balance | load-balance [slot-id/port-id] | membership [slot-id/port-id]}</span>查看所有成员交换机的负载分担模式，或者指定成员交换机<span style="font-family:Calibri">/</span>堆叠端口下的成员端口信息。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">6</span>）<span style="font-family:Calibri">display interface stack-port [slot-id/port-id]</span>查看所有或指定堆叠成员交换机<span style="font-family:Calibri">/</span>堆叠端口下各成员接口的流量统计信息。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">7</span>）<span style="font-family:Calibri">reset counters stack-port [slpt-id/port-id]</span>清除所有或指定成员交换机<span style="font-family:Calibri">/</span>堆叠端口的状态统计信息。</span></p> 
<p><span style="font-size:14px"><strong>四、<span style="font-family:Calibri">iStack</span>堆叠配置示例</strong></span></p> 
<p><img src="https://images2.imgbox.com/22/8f/WWDoemNr_o.png" alt=""></p> 
<p><span style="font-size:14px">如上图拓扑，<span style="font-family:Calibri">ABCD</span>四台交换机（<span style="font-family:Calibri">S5700LI</span>）组成环形堆叠系统。<span style="font-family:Calibri">S5700LI</span>交换机中是以最后<span style="font-family:Calibri">2</span>个（每个堆叠端口一个成员端口时）或<span style="font-family:Calibri">4</span>个（每个堆叠端口两个成员端口时）业务端口作为堆叠端口的成员端口的，所以需要使用<span style="font-family:Calibri">SFP+</span>堆叠电缆连接各成员端口，但要注意同一条堆叠链路上的两个堆叠物理成员端口需加入不同堆叠端口，即本端交换机的堆叠端口<span style="font-family:Calibri">1</span>必须与对端交换机的堆叠端口<span style="font-family:Calibri">2</span>相连。</span></p> 
<p><span style="font-size:14px">本示例需配置三项任务：指定物理业务端口作为堆叠端口的成员端口，配置堆叠成员<span style="font-family:Calibri">ID</span>和堆叠优先级，重启各成员交换机。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">    </span>（<span style="font-family:Calibri">1</span>）在各成员交换机上配置堆叠端口，添加物理成员业务端口。</p> 
<p><span style="font-size:14px">将<span style="font-family:Calibri">SwitchA</span>的最后两个业务端口<span style="font-family:Calibri">GigabitEthernet0/0/27~gigabitEthernet0/0/28</span>分别配置为<span style="font-family:Calibri">1</span>号和<span style="font-family:Calibri">2</span>号堆叠端口的物理成员端口，并加入堆叠端口。此时注意各成员交换机的堆叠<span style="font-family:Calibri">ID</span>均为<span style="font-family:Calibri">0</span>。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">&lt;Huawei&gt;system-view</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei]sysname SwitchA</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA]stack port interface gigabitethernet 0/0/27 enable</span></p> 
<p><span style="font-family:Calibri; font-size:14px">Warning:Enabling stack port may cause configuration loss on the interface,countinue?[Y/N]:y</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA]stack port interace gigabitethernet 0/0/28 enable</span></p> 
<p><span style="font-family:Calibri; font-size:14px">Warning:Enabling stack port may cause configuration loss on the interface,countinue?[Y/N]:y</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA]interface stack-port 0/1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA-stack-port0/1]port member-group interface gigabitethernet 0/0/27</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA-stack-port0/1]quit</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA]interface stack-port 0/2</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA-stack-port0/2]port member-group interface gigabitethernet 0/0/28</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA-stack-port0/2]quit</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">2</span>）配置各成员交换机的堆叠<span style="font-family:Calibri">ID</span>和堆叠优先级。假设<span style="font-family:Calibri">A</span>为主交换机，<span style="font-family:Calibri">A</span>的优先级配置为<span style="font-family:Calibri">200</span>，其他保持缺省，即<span style="font-family:Calibri">100</span>。在堆叠<span style="font-family:Calibri">ID</span>方面，<span style="font-family:Calibri">A</span>采用缺省的<span style="font-family:Calibri">0</span>号，<span style="font-family:Calibri">B</span>、<span style="font-family:Calibri">C</span>、<span style="font-family:Calibri">D</span>分别分配堆叠<span style="font-family:Calibri">ID</span>为<span style="font-family:Calibri">1</span>、<span style="font-family:Calibri">2</span>、<span style="font-family:Calibri">3</span>。</span></p> 
<p><span style="font-size:14px">配置<span style="font-family:Calibri">SwitchA</span>的堆叠优先级为<span style="font-family:Calibri">200</span>：</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchA]stack slot 0 priority 200</span></p> 
<p><span style="font-family:Calibri; font-size:14px">Warning:Please do not frequently modify Priority,it will make the stack split!!countiune?[Y/N]:y</span></p> 
<p><span style="font-size:14px">配置<span style="font-family:Calibri">SwitchB</span>的堆叠<span style="font-family:Calibri">ID</span>为<span style="font-family:Calibri">1</span>：</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchB]stack slot 0 renumber 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">Warning:Please do not frequently modify slotid,it will make the stack split!!countiune?[Y/N]:y</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">3</span>）在各交换机上执行<span style="font-family:Calibri">save</span>，使用<span style="font-family:Calibri">reboot</span>重启各成员交换机。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">4</span>）在堆叠主交换机上执行<span style="font-family:Calibri">display stack</span>，验证结果。</span></p> 
<p><img src="https://images2.imgbox.com/42/f0/PSS4TUNh_o.png" alt=""></p> 
<p><strong><span style="font-size:14px">五、双主检测配置与管理</span></strong></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">1</span>）直连检测方式：成员交换机间通过专用直连链路进行双主检测；</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">2</span>）<span style="font-family:Calibri">Relay</span>代理检测方式：成员交换机间通过启用<span style="font-family:Calibri">Relay</span>代理功能的交换机进行双主检测。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">DAD</span>（双主检测）是华为公司的私有协议。<span style="font-family:Calibri">DAD</span>报文是<span style="font-family:Calibri">BPDU</span>报文，在代理交换机和直连检测链路的中间交换机上需要配置接口转发<span style="font-family:Calibri">BPDU</span>报文。</p> 
<p><span style="font-size:14px">两种检测方式互斥。可以同时配置<span style="font-family:Calibri">4</span>条直连检测链路或<span style="font-family:Calibri">4</span>个<span style="font-family:Calibri">Relay</span>代理检测<span style="font-family:Calibri">Eth-trunk</span>。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">1</span>、配置任务</p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">1</span>）配置检测方式：可以是直连检测方式或<span style="font-family:Calibri">Relay</span>代理检测方式</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">2</span>）（可选）配置保留端口。双主检测发现堆叠分裂故障后，为防止相同的<span style="font-family:Calibri">MAC</span>地址、<span style="font-family:Calibri">IP</span>地址引起网络振荡，需要将竞选失败的成员交换机上的所有业务端口关闭。如果有部分端口仅作报文透传功能，出现双主故障时不会影响到网络运行，这时通过命令将这些端口配置为保留端口。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">3</span>）（可选）恢复被关闭的端口。如果在堆叠系统分裂故障恢复前，原主交换机发生故障或被移出网络，则通过命令行先启用处于端口关闭状态的备份交换机，使所有业务口重新恢复正常，让它接替原主交换机工作。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">2</span>、配置步骤</p> 
<p><img src="https://images2.imgbox.com/48/b5/d94hVwba_o.png" width="635" height="944" alt=""><br> <img src="https://images2.imgbox.com/11/a0/FboUS4uN_o.png" alt=""></p> 
<p><span style="font-size:14px">配置好后，可用<span style="font-family:Calibri">display mad verbose [proxy | verbose]</span>命令查看双主检测配置信息。</span></p> 
<p><span style="font-size:14px"><strong>六、直连检测方式的<span style="font-family:Calibri">DAD</span>配置示例</strong></span></p> 
<p><img src="https://images2.imgbox.com/77/39/fk1DmUHg_o.png" alt=""></p> 
<p><span style="font-size:14px">如上拓扑，<span style="font-family:Calibri">A</span>和<span style="font-family:Calibri">B</span>组成堆叠系统，<span style="font-family:Calibri">A</span>的堆叠<span style="font-family:Calibri">ID</span>为<span style="font-family:Calibri">0</span>，<span style="font-family:Calibri">B</span>的堆叠<span style="font-family:Calibri">ID</span>为<span style="font-family:Calibri">1</span>。在<span style="font-family:Calibri">gigabitEthernet0/0/5</span>和<span style="font-family:Calibri">gigabitEthernet1/0/5</span>接口上配置采用直连双主检测功能，以减少堆叠分裂给网络带来的影响。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">    </span>（<span style="font-family:Calibri">1</span>）在<span style="font-family:Calibri">SwitchA</span>上配置接口<span style="font-family:Calibri">GigabitEthernet0/0/5</span>采用直连检测方式的<span style="font-family:Calibri">DAD</span>功能。</p> 
<p><span style="font-family:Calibri; font-size:14px">&lt;Huawei&gt;system-view</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei]interface gigabitetnernet 0/0/5</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Gigabitethernet0/0/5]mad detect mode direct</span></p> 
<p><span style="font-family:Calibri; font-size:14px">Warning:This command will block the port,and no other configuration running on this port is recommended.Countinue?[Y/N]:y</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">2</span>）在<span style="font-family:Calibri">SwitchB</span>上配置接口<span style="font-family:Calibri">GigabitEthernet1/0/5</span>采用直连检测方式的<span style="font-family:Calibri">DAD</span>功能。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">&lt;Huawei&gt;system-view</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei]interface gigabitetnernet 1/0/5</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Gigabitethernet1/0/5]mad detect mode direct</span></p> 
<p><span style="font-family:Calibri; font-size:14px">Warning:This command will block the port,and no other configuration running on this port is recommended.Countinue?[Y/N]:y</span></p> 
<p><span style="font-size:14px">配置后通过<span style="font-family:Calibri">display mad verbose</span>命令查看堆叠系统双主检测详细配置信息。</span></p> 
<p><img src="https://images2.imgbox.com/fa/04/Xgjb9XA1_o.png" alt=""></p> 
<p><span style="font-size:14px"><strong>七、<span style="font-family:Calibri">Relay</span>代理检测方式的<span style="font-family:Calibri">DAD</span>配置示例</strong></span></p> 
<p><img src="https://images2.imgbox.com/94/2c/Gmjv0IPW_o.png" alt=""></p> 
<p><span style="font-size:14px">如上拓扑，<span style="font-family:Calibri">A</span>、<span style="font-family:Calibri">B</span>组成堆叠系统，通过接口<span style="font-family:Calibri">Eth-Trunk1</span>与代理交换机<span style="font-family:Calibri">SwitchC</span>连接。现配置<span style="font-family:Calibri">Relay</span>代理双主检测功能。</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">1</span>）在交换机堆叠与代理交换机<span style="font-family:Calibri">SwitchC</span>相连的<span style="font-family:Calibri">Eth-Trunk</span>接口上配置采用<span style="font-family:Calibri">Relay</span>代理检测方式的<span style="font-family:Calibri">DAD</span>功能。</span></p> 
<p><span style="font-family:Calibri; font-size:14px">&lt;Huawei&gt;system-view</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei]interface eth-trunk 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Eth-Trunk1]mad detect mode relay</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Eth-Trunk1]quit</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei]interface gigabitethernet 0/0/5</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Gigabitethernet0/0/5]eth-trunk 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Gigabitethernet0/0/5]quit</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei]interface gigabitethernet 1/0/5</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Gigabitethernet1/0/5]eth-trunk 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[Huawei-Gigabitethernet1/0/5]quit</span></p> 
<p><span style="font-family:Calibri; font-size:14px">    </span>（<span style="font-family:Calibri">2</span>）在代理交换机<span style="font-family:Calibri">SwitchC</span>的<span style="font-family:Calibri">Eth-Trunk</span>接口上配置采用<span style="font-family:Calibri">Relay</span>代理检测方式的<span style="font-family:Calibri">DAD</span>功能。</p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC]interface eth-trunk 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC-Eth-Trunk1]mad relay</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC-Eth-Trunk1]quit</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC]interface gigabitethernet 0/0/1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC-Gigabitethernet0/0/1]eth-trunk 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC-Gigabitethernet0/0/1]quit</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC]interface gigabitethernet 0/0/2</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC-Gigabitethernet0/0/2]eth-trunk 1</span></p> 
<p><span style="font-family:Calibri; font-size:14px">[SwitchC-Gigabitethernet0/0/2]quit</span></p> 
<p><span style="font-size:14px">配置好后，通过<span style="font-family:Calibri">display mad verbose</span>查看堆叠系统<span style="font-family:Calibri">DAD</span>配置信息</span></p> 
<p><img src="https://images2.imgbox.com/6a/f8/aYy7e3Tc_o.png" alt=""></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ef737c80407bdba610b4d28c4fa90c4b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">org.springframework.beans.factor…</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7e02977a6d24a2fc525836e003e55589/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">visual studio fatal error C1083: 无法打开源文件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>