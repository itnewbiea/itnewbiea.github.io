<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>用STM32F103RCT6&#43;无源蜂鸣器&#43;4×4矩阵键盘实现电子琴的实验 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="用STM32F103RCT6&#43;无源蜂鸣器&#43;4×4矩阵键盘实现电子琴的实验" />
<meta property="og:description" content="使用了STM32CubeMX及Keil（HAL库） 材料：stm32开发板、无源蜂鸣器、4×4矩阵键盘、杜邦线、st-link 实验原理： 1、音高和矩形波周期有关 ，音强和占空比有关（？），通过设置TIM2为PWM，对应按键信息设置不同的方波周期，占空比恒为50%（音量不变），通过CH1(PA0)输出，PA0接无源蜂鸣器正极，无源蜂鸣器另一端接地，于是发出不同频率的声音(周期的数值是网上搜的。。。其中c应该是中央c) 2、只用了4×4的3×3的部分。。。（只发9个音。。。），采用轮询输入
实验设计：
PA0接无源蜂鸣器正极，无源蜂鸣器另一端接地
其它连线如图
对应的声音的按键如上图 按下按键发出声音 释放按键停止发声 STM32CubeMX中的主要的设置： 主要代码（以下只有USER CODE BEGIN里的代码）： main.c：
/* USER CODE BEGIN PV */ /* Private variables ---------------------------------------------------------*/ const int tones[] = { 1915, 1700, 1519, 1432, 1275, 1136, 1014, 956,853 }; //大概发出{ &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;a&#39;, &#39;b&#39;, &#39;C&#39;,&#39;D&#39; }; const uint16_t keys[]={GPIO_PIN_4,GPIO_PIN_5,GPIO_PIN_6}; //为了让下面的代码更少而写的数组。。。 /* USER CODE END PV */ /* USER CODE BEGIN PFP */ /* Private function prototypes -----------------------------------------------*/ void beeping(uint16_t pin,uint8_t times); /* USER CODE END PFP */ /* Infinite loop */ /* USER CODE BEGIN WHILE */ while (1) { /* USER CODE END WHILE */ /* USER CODE BEGIN 3 */ //判断3行中是否有按键被按下 if(HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_4)==0){ beeping(GPIO_PIN_4,0); } else if(HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_5)==0){ beeping(GPIO_PIN_5,1); } else if(HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_6)==0){ beeping(GPIO_PIN_6,2); } } /* USER CODE END 3 */ /* USER CODE BEGIN 4 */ //发声函数 void beeping(uint16_t pin,uint8_t times){ uint8_t i,key=&#39;n&#39;; for(i=0;i&lt;3;i&#43;&#43;){//检查是否按下了9个发声按键 HAL_GPIO_TogglePin(GPIOA,keys[i]); if(HAL_GPIO_ReadPin(GPIOC,pin)==1){ key=i&#43;times*3; HAL_GPIO_TogglePin(GPIOA,keys[i]); break; } HAL_GPIO_TogglePin(GPIOA,keys[i]); } if(!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c39b309d80eb99366393e5d5d634cddc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-02-09T00:56:00+08:00" />
<meta property="article:modified_time" content="2018-02-09T00:56:00+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">用STM32F103RCT6&#43;无源蜂鸣器&#43;4×4矩阵键盘实现电子琴的实验</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    使用了STM32CubeMX及Keil（HAL库） 
<br>材料：stm32开发板、无源蜂鸣器、4×4矩阵键盘、杜邦线、st-link 
<br> 
<br> 
<br> 
<span style="background-color:rgb(255,255,255);"><span style="font-size:24px;">实验原理：</span></span> 
<br>1、音高和矩形波周期有关 ，音强和占空比有关（？），通过设置TIM2为PWM，对应按键信息设置不同的方波周期，占空比恒为50%（音量不变），通过CH1(PA0)输出，PA0接无源蜂鸣器正极，无源蜂鸣器另一端接地，于是发出不同频率的声音(周期的数值是网上搜的。。。其中c应该是中央c) 
<br> 
<p>2、只用了4×4的3×3的部分。。。（只发9个音。。。），采用轮询输入</p> 
<p><br></p> 
<p><br></p> 
<p><span style="font-size:24px;">实验设计：</span><br></p> 
<p>PA0接无源蜂鸣器正极，无源蜂鸣器另一端接地</p> 
<p>其它连线如图</p> 
<img src="https://images2.imgbox.com/70/52/k9yrbnTZ_o.png" alt=""> 
<br>对应的声音的按键如上图 
<br>按下按键发出声音 
<br>释放按键停止发声 
<br> 
<br> 
<br> 
<span style="font-size:18px;">STM32CubeMX中的主要的设置：</span> 
<br> 
<br> 
<img src="https://images2.imgbox.com/cc/08/TJFE4U2Y_o.png" alt=""> 
<br> 
<img src="https://images2.imgbox.com/2d/c2/QOW32EVm_o.png" alt=""> 
<br> 
<img src="https://images2.imgbox.com/3b/37/mUYPpxcz_o.png" alt=""> 
<br> 
<br> 
<span style="font-size:18px;">主要代码（以下只有USER CODE BEGIN里的代码）：</span> 
<br> 
<p>main.c：</p> 
<p></p> 
<pre><code class="language-cpp">/* USER CODE BEGIN PV */
/* Private variables ---------------------------------------------------------*/
const int tones[] = { 1915, 1700, 1519, 1432, 1275, 1136, 1014, 956,853 }; //大概发出{ 'c', 'd', 'e', 'f', 'g', 'a', 'b', 'C','D' };
const uint16_t keys[]={GPIO_PIN_4,GPIO_PIN_5,GPIO_PIN_6}; //为了让下面的代码更少而写的数组。。。
/* USER CODE END PV */</code></pre> 
<br> 
<pre><code class="language-cpp">/* USER CODE BEGIN PFP */
/* Private function prototypes -----------------------------------------------*/
void beeping(uint16_t pin,uint8_t times);
/* USER CODE END PFP */</code></pre> 
<br> 
<pre><code class="language-cpp">/* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
  /* USER CODE END WHILE */

  /* USER CODE BEGIN 3 */
	  //判断3行中是否有按键被按下
		if(HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_4)==0){
			beeping(GPIO_PIN_4,0);
  }
		else if(HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_5)==0){
			beeping(GPIO_PIN_5,1);
		}
			else if(HAL_GPIO_ReadPin(GPIOC,GPIO_PIN_6)==0){
			beeping(GPIO_PIN_6,2);
			}
}
  /* USER CODE END 3 */</code></pre> 
<br> 
<pre><code class="language-cpp">/* USER CODE BEGIN 4 */

//发声函数
void beeping(uint16_t pin,uint8_t times){
	uint8_t i,key='n'; 
	for(i=0;i&lt;3;i++){//检查是否按下了9个发声按键
				HAL_GPIO_TogglePin(GPIOA,keys[i]);
				if(HAL_GPIO_ReadPin(GPIOC,pin)==1){
					key=i+times*3;
					HAL_GPIO_TogglePin(GPIOA,keys[i]);
					break;
				}
				HAL_GPIO_TogglePin(GPIOA,keys[i]);
			}
	if(!(key=='n')){ //若按下了9个发声按键中的一个
			TIM2_REInit(tones[key]*2); //发声
				while(HAL_GPIO_ReadPin(GPIOC,pin)==0); //等待释放
				HAL_TIM_PWM_Stop(&amp;htim2,TIM_CHANNEL_1); //停止发声
	}
	
}
/* USER CODE END 4 */</code></pre> 
<br> 
<p>tim.c</p> 
<p></p> 
<pre><code class="language-cpp">/* USER CODE BEGIN 1 */

//为了调整周期从而改变音调而写的函数，内容是把上面的MX_TIM2_Init()的定义重新写一下
void TIM2_REInit(int period) //传周期
{
  TIM_ClockConfigTypeDef sClockSourceConfig;
  TIM_MasterConfigTypeDef sMasterConfig;
  TIM_OC_InitTypeDef sConfigOC;

  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 71;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = period; //改变周期
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&amp;htim2) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&amp;htim2, &amp;sClockSourceConfig) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

  if (HAL_TIM_PWM_Init(&amp;htim2) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&amp;htim2, &amp;sMasterConfig) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

  sConfigOC.OCMode = TIM_OCMODE_PWM1;
  sConfigOC.Pulse = period/2; //占空比恒为50%
  sConfigOC.OCPolarity = TIM_OCPOLARITY_HIGH;
  sConfigOC.OCFastMode = TIM_OCFAST_DISABLE;
  if (HAL_TIM_PWM_ConfigChannel(&amp;htim2, &amp;sConfigOC, TIM_CHANNEL_1) != HAL_OK)
  {
    _Error_Handler(__FILE__, __LINE__);
  }

  HAL_TIM_MspPostInit(&amp;htim2);
HAL_TIM_PWM_Start(&amp;htim2, TIM_CHANNEL_1); //重启TIM2的CH1
}

/* USER CODE END 1 */</code></pre> 
<p>tim.h：<br></p> 
<p></p> 
<pre><code class="language-cpp">/* USER CODE BEGIN Prototypes */
void TIM2_REInit(int period);
/* USER CODE END Prototypes */</code></pre> 
<br> 
<p><span style="font-size:24px;">实验成果：</span></p> 
<p>正常地完成了预定的功能（233</p> 
<p><br></p> 
<p><br></p> 
<p><br></p>参考资料：一些蜂鸣器发声的例子
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2cdd103129e65678ec54d3023ac3d41b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">react实现前后台数据交互</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/82cb1bf9cc9a2794060d594662778605/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【算法】动态规划法——最长公共子序列（LCS）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>