<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【React系列】React生命周期、setState深入理解、 shouldComponentUpdate和PureComponent性能优化、脚手架 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【React系列】React生命周期、setState深入理解、 shouldComponentUpdate和PureComponent性能优化、脚手架" />
<meta property="og:description" content="本文来自#React系列教程：https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5MDAzNzkwNA==&amp;action=getalbum&amp;album_id=1566025152667107329)
一. 生命周期 1.1. 认识生命周期 很多的事物都有从创建到销毁的整个过程，这个过程称之为是生命周期；
React组件也有自己的生命周期，了解组件的生命周期可以让我们在最合适的地方完成自己想要的功能；
生命周期和生命周期函数的关系：
生命周期是一个抽象的概念，在生命周期的整个过程，分成了很多个阶段； 比如装载阶段（Mount），组件第一次在DOM树中被渲染的过程；比如更新过程（Update），组件状态发生变化，重新更新渲染的过程；比如卸载过程（Unmount），组件从DOM树中被移除的过程； React内部为了告诉我们当前处于哪些阶段，会对我们组件内部实现的某些函数进行回调，这些函数就是生命周期函数： 比如实现componentDidMount函数：组件已经挂载到DOM上时，就会回调；比如实现componentDidUpdate函数：组件已经发生了更新时，就会回调；比如实现componentWillUnmount函数：组件即将被移除时，就会回调； 我们可以在这些回调函数中编写自己的逻辑代码，来完成自己的需求功能；
我们谈React生命周期时，主要谈的类的生命周期，因为函数式组件是没有生命周期函数的；（后面我们可以通过hooks来模拟一些生命周期的回调）
1.2. 常用生命周期解析 我们先来学习一下最基础、最常用的生命周期函数：
上图第一个区域解析：
当我们挂载一个组件时，会先执行constructor构造方法来创建组件；紧接着调用render函数，获取要渲染的DOM结构（jsx），并且开始渲染DOM；当组件挂载成功（DOM渲染完成），会执行componentDidMount生命周期函数； 上图第二个区域解析：
当我们通过修改props，或者调用setState修改内部状态，或者直接调用forceUpdate时会重新调用render函数，进行更新操作；当更新完成时，会回调componentDidUpdate生命周期函数； 上图第三个区域解析：
当我们的组件不再使用，会被从DOM中移除掉（卸载）；这个时候会回调componentWillUnmount生命周期函数； 1.3. 生命周期函数 constructor
constructor(props) 如果不初始化 state 或不进行方法绑定，则不需要为 React 组件实现构造函数。
constructor中通常只做两件事情：
通过给 this.state 赋值对象来初始化内部的state；为事件绑定实例（this）； componentDidMount
componentDidMount() componentDidMount() 会在组件挂载后（插入 DOM 树中）立即调用。
componentDidMount中通常进行哪里操作呢？
依赖于DOM的操作可以在这里进行；在此处发送网络请求就最好的地方；（官方建议）可以在此处添加一些订阅（会在componentWillUnmount取消订阅）； componentDidUpdate
componentDidUpdate(prevProps, prevState, snapshot) componentDidUpdate() 会在更新后会被立即调用，首次渲染不会执行此方法。
当组件更新后，可以在此处对 DOM 进行操作；如果你对更新前后的 props 进行了比较，也可以选择在此处进行网络请求；（例如，当 props 未发生变化时，则不会执行网络请求）。 componentDidUpdate(prevProps) { // 典型用法（不要忘记比较 props）： if (this.props.userID !== prevProps.userID) { this.fetchData(this.props.userID); } } componentWillUnmount" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a8eace6db7e024fe941a18c7b170d570/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-04T13:32:06+08:00" />
<meta property="article:modified_time" content="2024-01-04T13:32:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【React系列】React生命周期、setState深入理解、 shouldComponentUpdate和PureComponent性能优化、脚手架</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>本文来自#React系列教程：<a href="https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5MDAzNzkwNA==&amp;action=getalbum&amp;album_id=1566025152667107329" rel="nofollow">https://mp.weixin.qq.com/mp/appmsgalbum?__biz=Mzg5MDAzNzkwNA==&amp;action=getalbum&amp;album_id=1566025152667107329</a>)</p> 
</blockquote> 
<h2><a id="__2"></a>一. 生命周期</h2> 
<h3><a id="11__3"></a>1.1. 认识生命周期</h3> 
<p>很多的事物都有从创建到销毁的整个过程，这个过程称之为是生命周期；</p> 
<p>React组件也有自己的生命周期，了解组件的生命周期可以让我们在最合适的地方完成自己想要的功能；</p> 
<p>生命周期和生命周期函数的关系：</p> 
<ul><li>生命周期是一个抽象的概念，在生命周期的整个过程，分成了很多个阶段； 
  <ul><li>比如装载阶段（Mount），组件第一次在DOM树中被渲染的过程；</li><li>比如更新过程（Update），组件状态发生变化，重新更新渲染的过程；</li><li>比如卸载过程（Unmount），组件从DOM树中被移除的过程；</li></ul> </li><li>React内部为了告诉我们当前处于哪些阶段，会对我们组件内部实现的某些函数进行回调，这些函数就是生命周期函数： 
  <ul><li>比如实现<code>componentDidMount</code>函数：组件已经挂载到DOM上时，就会回调；</li><li>比如实现<code>componentDidUpdate</code>函数：组件已经发生了更新时，就会回调；</li><li>比如实现<code>componentWillUnmount</code>函数：组件即将被移除时，就会回调；</li></ul> </li></ul> 
<p>我们可以在这些回调函数中编写自己的逻辑代码，来完成自己的需求功能；</p> 
<p>我们谈React生命周期时，主要谈的类的生命周期，因为函数式组件是没有生命周期函数的；（后面我们可以通过hooks来模拟一些生命周期的回调）</p> 
<h3><a id="12__24"></a>1.2. 常用生命周期解析</h3> 
<p>我们先来学习一下最基础、最常用的生命周期函数：</p> 
<p><img src="https://images2.imgbox.com/d0/46/nxBNrp7i_o.png" alt="在这里插入图片描述"></p> 
<p>上图第一个区域解析：</p> 
<ul><li>当我们挂载一个组件时，会先执行<code>constructor</code>构造方法来创建组件；</li><li>紧接着调用<code>render</code>函数，获取要渲染的DOM结构（jsx），并且开始渲染DOM；</li><li>当组件挂载成功（DOM渲染完成），会执行<code>componentDidMount</code>生命周期函数；</li></ul> 
<p>上图第二个区域解析：</p> 
<ul><li>当我们通过修改<code>props</code>，或者调用<code>setState</code>修改内部状态，或者直接调用<code>forceUpdate</code>时会重新调用<code>render</code>函数，进行更新操作；</li><li>当更新完成时，会回调<code>componentDidUpdate</code>生命周期函数；</li></ul> 
<p>上图第三个区域解析：</p> 
<ul><li>当我们的组件不再使用，会被从DOM中移除掉（卸载）；</li><li>这个时候会回调<code>componentWillUnmount</code>生命周期函数；</li></ul> 
<h3><a id="13__45"></a>1.3. 生命周期函数</h3> 
<p><strong>constructor</strong></p> 
<pre><code class="prism language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
</code></pre> 
<p>如果不初始化 <code>state</code> 或不进行方法绑定，则不需要为 React 组件实现构造函数。</p> 
<p><code>constructor</code>中通常只做两件事情：</p> 
<ul><li>通过给 <code>this.state</code> 赋值对象来初始化内部的<code>state</code>；</li><li>为事件绑定实例（<code>this</code>）；</li></ul> 
<p><strong>componentDidMount</strong></p> 
<pre><code class="prism language-javascript"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>componentDidMount()</code> 会在组件挂载后（插入 DOM 树中）立即调用。</p> 
<p><code>componentDidMount</code>中通常进行哪里操作呢？</p> 
<ul><li>依赖于DOM的操作可以在这里进行；</li><li>在此处发送网络请求就最好的地方；（官方建议）</li><li>可以在此处添加一些订阅（会在<code>componentWillUnmount</code>取消订阅）；</li></ul> 
<p><strong>componentDidUpdate</strong></p> 
<pre><code class="prism language-javascript"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>prevProps<span class="token punctuation">,</span> prevState<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span>
</code></pre> 
<p><code>componentDidUpdate()</code> 会在更新后会被立即调用，首次渲染不会执行此方法。</p> 
<ul><li>当组件更新后，可以在此处对 DOM 进行操作；</li><li>如果你对更新前后的 <code>props</code> 进行了比较，也可以选择在此处进行网络请求；（例如，当 <code>props</code> 未发生变化时，则不会执行网络请求）。</li></ul> 
<pre><code class="prism language-javascript"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 典型用法（不要忘记比较 props）：</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID <span class="token operator">!==</span> prevProps<span class="token punctuation">.</span>userID<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fetchData</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>props<span class="token punctuation">.</span>userID<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>componentWillUnmount</strong></p> 
<pre><code class="prism language-javascript"><span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p><code>componentWillUnmount()</code> 会在组件卸载及销毁之前直接调用。</p> 
<ul><li>在此方法中执行必要的清理操作；</li><li>例如，清除 timer，取消网络请求或清除在 <code>componentDidMount()</code> 中创建的订阅等；</li></ul> 
<p>代码验证所有的生命周期函数：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">HYTestCpn</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>HYTestCpn<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"HYTestCpn componentWillUnmount"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>

    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"调用constructor方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"调用render方法"</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>当前计数<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">&lt;=</span> <span class="token number">5</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">&lt;</span>HYTestCpn<span class="token operator">/</span><span class="token operator">&gt;</span><span class="token punctuation">}</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"调用componentDidMount方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"调用componentDidUpdate方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">componentWillUnmount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"调用componentWillUnmount方法"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="14__160"></a>1.4. 不常用生命周期</h3> 
<p>除了上面介绍的生命周期函数之外，还有一些不常用的生命周期函数：</p> 
<p><img src="https://images2.imgbox.com/ae/28/tMqSI66X_o.png" alt="在这里插入图片描述"></p> 
<ul><li><code>getDerivedStateFromProps</code>：<code>state</code> 的值在任何时候都依赖于 <code>props</code>时使用；该方法返回一个对象来更新<code>state</code>；</li><li><code>getSnapshotBeforeUpdate</code>：在React更新DOM之前回调的一个函数，可以获取DOM更新前的一些信息（比如说滚动位置）；</li><li><code>shouldComponentUpdate</code>：该生命周期函数很常用，但是我们等待讲性能优化时再来详细讲解；</li></ul> 
<p>另外，React中还提供了一些过期的生命周期函数，这些函数已经不推荐使用。</p> 
<p>更详细的生命周期相关的内容，可以参考官网：<a href="https://zh-hans.reactjs.org/docs/react-component.html" rel="nofollow">https://zh-hans.reactjs.org/docs/react-component.html</a></p> 
<h2><a id="_setState_174"></a>二. setState</h2> 
<p><strong>在 <code>constructor()</code> 函数中不要调用 <code>setState()</code> 方法</strong>。如果你的组件需要使用内部<code>state</code>，请直接<strong>在构造函数中为<code>this.state</code> 赋值初始 <code>state</code></strong>：</p> 
<pre><code class="prism language-javascript"><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 不要在这里调用 this.setState() </span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token keyword">this</span><span class="token punctuation">.</span>handleClick <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleClick</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>只能在构造函数中直接为 <code>this.state</code> 赋值。如需在其他方法中赋值，你应使用 <code>this.setState()</code> 替代。</p> 
<p><img src="https://images2.imgbox.com/51/61/ZwMHEjOB_o.jpg" alt="在这里插入图片描述"></p> 
<p>你可以用类似的方式改写代码来避免可变对象的产生。例如，我们有一个叫做 <code>colormap</code> 的对象。我们希望写一个方法来将 <code>colormap.right</code> 设置为 ＇<code>blue</code>＇。我们可以这么写：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
	colormap<span class="token punctuation">.</span>right <span class="token operator">=</span> <span class="token string">'blue'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为了不改变原本的对象，我们可以使用 <code>Object.assign</code> 方法：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">function</span> <span class="token function">updateColorMap</span><span class="token punctuation">(</span><span class="token parameter">colormap</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span><span class="token punctuation">,</span> colormap<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">right</span><span class="token operator">:</span> <span class="token string">'blue'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>现在 <code>updateColorMap</code> 返回了一个新的对象，而不是修改老对象。<code>Object.assign</code> 是ES6的方法，需要polyfill。</p> 
<h3><a id="_207"></a><strong>不可变数据的力量</strong></h3> 
<p>避免该问题最简单的方式是避免更改你正用于<code>props</code> 或 <code>state</code>的值。例如，上面<code>handleClick</code> 方法可以用 <code>concat</code> 重写：</p> 
<pre><code class="prism language-javascript"><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">words</span><span class="token operator">:</span> state<span class="token punctuation">.</span>words<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'marklar'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> 
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>ES6数组支持<strong>扩展运算符</strong>，这让代码写起来更方便了。如果你在使用<code>Create React App</code>，该语法已经默认支持了。</p> 
<pre><code class="prism language-javascript"><span class="token function">handleClick</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token parameter">state</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
		<span class="token literal-property property">words</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span>state<span class="token punctuation">.</span>words<span class="token punctuation">,</span> <span class="token string">'marklar'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> 
</code></pre> 
<p>参数一为带有形式参数的 <code>updater</code> 函数：<code>(state, props) =&gt; stateChange</code></p> 
<ul><li><code>state</code> 是对应用变化时组件状态的引用。当然，它不应直接被修改。</li><li>你应该使用基于 <code>state</code> 和 <code>props</code> 构建的新对象来表示变化。</li></ul> 
<p>例如，假设我们想根据 <code>props.step</code> 来增加 <code>state</code>：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">counter</span><span class="token operator">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> props<span class="token punctuation">.</span>step<span class="token punctuation">}</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><code>updater</code>函数中接收的<code>state</code>和<code>props</code>都保证为最新。<code>updater</code>的返回值会与<code>state</code>进行浅合并。</p> 
<h3><a id="setState_240"></a>setState异步更新</h3> 
<p><strong>setState的更新是异步的？</strong></p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Hello World"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>message<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>改变文本<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
	  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
	  <span class="token punctuation">}</span><span class="token punctuation">)</span>
	  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Hello World</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>最终打印结果是<code>Hello World</code>；可见<code>setState</code>是异步的操作，我们并不能在执行完<code>setState</code>之后立马拿到最新的<code>state</code>的结果。</p> 
<p><strong>为什么<code>setState</code>设计为异步呢？</strong></p> 
<ul><li><code>setState</code>设计为异步其实之前在GitHub上也有很多的讨论；</li><li>React核心成员（Redux的作者）Dan Abramov也有对应的回复，有兴趣的同学可以参考一下；</li><li><a href="https://github.com/facebook/react/issues/11527#issuecomment-360199710">https://github.com/facebook/react/issues/11527#issuecomment-360199710</a></li></ul> 
<p>我对其回答做一个简单的总结：</p> 
<ul><li><strong><code>setState</code>设计为异步，可以显著的提升性能；</strong> 
  <ul><li>如果每次调用 <code>setState</code>都进行一次更新，那么意味着<code>render</code>函数会被频繁调用，界面重新渲染，这样效率是很低的；</li><li>最好的办法应该是获取到多个更新，之后进行<strong>批量更新</strong>；</li></ul> </li><li><strong>如果同步更新了<code>state</code>，但是还没有执行<code>render</code>函数，那么<code>state</code>和<code>props</code>不能保持同步</strong>； 
  <ul><li><code>state</code>和<code>props</code>不能保持一致性，会在开发中产生很多的问题；</li></ul> </li></ul> 
<p><strong>那么如何可以获取到更新后的值呢？</strong></p> 
<ul><li><code>setState</code>接受两个参数：第二个参数是一个回调函数，这个回调函数会在更新后会执行；</li><li>格式如下：<code>setState(partialState, callback)</code></li></ul> 
<pre><code class="prism language-javascript"><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 你好啊,李银河</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当然，我们也可以在生命周期函数：</p> 
<pre><code class="prism language-javascript"><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span><span class="token parameter">prevProps<span class="token punctuation">,</span> provState<span class="token punctuation">,</span> snapshot</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="setState_312"></a>setState一定是异步？</h3> 
<p>疑惑：<code>setState</code>一定是异步更新的吗？</p> 
<p>验证一：在<code>setTimeout</code>中的更新：</p> 
<pre><code class="prism language-javascript"><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 你好啊,李银河</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>验证二：原生DOM事件：</p> 
<pre><code class="prism language-javascript"><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> btnEl <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"btn"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  btnEl<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 你好啊,李银河</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>其实分成两种情况：</p> 
<ul><li><strong>在 React 组件生命周期或 React 合成事件中，<code>setState</code> 是异步；</strong></li><li><strong>在<code>setTimeout</code>或者原生 DOM 事件中，<code>setState</code> 是同步；</strong></li></ul> 
<p>React中其实是通过一个函数来确定的：<code>enqueueSetState</code>部分实现（react-reconciler/ReactFiberClassComponent.js）</p> 
<pre><code class="prism language-javascript"><span class="token function">enqueueSetState</span><span class="token punctuation">(</span><span class="token parameter">inst<span class="token punctuation">,</span> payload<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token function">getInstance</span><span class="token punctuation">(</span>inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 会根据React上下文计算一个当前时间</span>
  <span class="token keyword">const</span> currentTime <span class="token operator">=</span> <span class="token function">requestCurrentTimeForUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> suspenseConfig <span class="token operator">=</span> <span class="token function">requestCurrentSuspenseConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 这个函数会返回当前是同步还是异步更新（准确的说是优先级）</span>
  <span class="token keyword">const</span> expirationTime <span class="token operator">=</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
    currentTime<span class="token punctuation">,</span>
    fiber<span class="token punctuation">,</span>
    suspenseConfig<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> update <span class="token operator">=</span> <span class="token function">createUpdate</span><span class="token punctuation">(</span>expirationTime<span class="token punctuation">,</span> suspenseConfig<span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/57/97/dJASi4g6_o.jpg" alt="在这里插入图片描述"></p> 
<p><code>computeExpirationForFiber</code>函数的部分实现：</p> 
<ul><li><code>Sync</code>是优先级最高的，即创建就更新；</li></ul> 
<pre><code class="prism language-javascript"><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">computeExpirationForFiber</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">currentTime</span><span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>
  <span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">suspenseConfig</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> SuspenseConfig<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> ExpirationTime <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> mode <span class="token operator">=</span> fiber<span class="token punctuation">.</span>mode<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> BlockingMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> Sync<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">const</span> priorityLevel <span class="token operator">=</span> <span class="token function">getCurrentPriorityLevel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>mode <span class="token operator">&amp;</span> ConcurrentMode<span class="token punctuation">)</span> <span class="token operator">===</span> NoMode<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> priorityLevel <span class="token operator">===</span> ImmediatePriority <span class="token operator">?</span> Sync <span class="token operator">:</span> Batched<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/3b/58/9ENejQN0_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="setState_390"></a>setState的合并</h3> 
<h4><a id="_391"></a>数据的合并</h4> 
<p>假如我们有这样的数据：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
  <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"coderwhy"</span><span class="token punctuation">,</span>
  <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Hello World"</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们需要更新<code>message</code>：</p> 
<pre><code class="prism language-javascript"><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>我通过<code>setState</code>去修改<code>message</code>，是不会对<code>name</code>产生影响的；</li></ul> 
<p>为什么不会产生影响呢？源码中其实是有对 <strong>原对象</strong> 和 <strong>新对象 进行合并的</strong>：</p> 
<p><img src="https://images2.imgbox.com/b3/1f/RMtk5JfN_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li><strong>事实上就是使用 <code>Object.assign(target, ...sources)</code> 来完成的；</strong></li></ul> 
<h4><a id="setState_419"></a>多个setState合并</h4> 
<p>比如我们还是有一个<code>counter</code>属性，记录当前的数字：</p> 
<ul><li>如果进行如下操作，那么<code>counter</code>会变成几呢？答案是<code>1</code>；</li><li>为什么呢？因为它会对多个<code>state</code>进行合并；</li></ul> 
<pre><code class="prism language-javascript">  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>其实在源码的<code>processUpdateQueue</code>中有一个<code>do...while</code>循环，就是从队列中取出多个<code>state</code>进行合并的；</p> 
<p><img src="https://images2.imgbox.com/a6/4f/4AGVG2VQ_o.jpg" alt="在这里插入图片描述"></p> 
<p>如何可以做到，让<code>counter</code>最终变成<code>3</code>呢？</p> 
<pre><code class="prism language-javascript"><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span> props</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>为什么传入一个函数就可以变出3呢？</p> 
<ul><li>原因是多个<code>state</code>进行合并时，每次遍历，都会执行一次函数：<br> <img src="https://images2.imgbox.com/b5/47/tUqTe7IK_o.jpg" alt="在这里插入图片描述"></li></ul> 
<h2><a id="_setState_474"></a>三. setState性能优化</h2> 
<h3><a id="React_476"></a>React更新机制</h3> 
<p>我们在前面已经学习React的渲染流程：<br> <img src="https://images2.imgbox.com/a8/b1/Fsb2sJXg_o.jpg" alt="在这里插入图片描述"></p> 
<p>那么React的更新流程呢？</p> 
<p><img src="https://images2.imgbox.com/c0/22/h8mmv230_o.jpg" alt="在这里插入图片描述"></p> 
<p>React在<code>props</code>或<code>state</code>发生改变时，会调用React的<code>render</code>方法，会创建一颗不同的树。</p> 
<p>React需要基于这两颗不同的树之间的差别来判断如何有效的更新UI：</p> 
<ul><li>如果一棵树参考另外一棵树进行完全比较更新，那么即使是最先进的算法，该算法的复杂程度为 <strong>O(n^3 )</strong>，其中 n 是树中元素的数量；</li><li><a href="https://grfia.dlsi.ua.es/ml/algorithms/references/editsurvey_bille.pdf" rel="nofollow">https://grfia.dlsi.ua.es/ml/algorithms/references/editsurvey_bille.pdf</a>；</li><li>如果在 React 中使用了该算法，那么展示 1000 个元素所需要执行的计算量将在十亿的量级范围；</li><li>这个开销太过昂贵了，React的更新性能会变得非常低效；</li></ul> 
<p>于是，React对这个算法进行了优化，将其优化成了<strong>O(n)</strong>，如何优化的呢？</p> 
<ul><li><strong>同层节点之间相互比较，不会垮节点比较；</strong></li><li><strong>不同类型的节点，产生不同的树结构；</strong></li><li><strong>开发中，可以通过<code>key</code>来指定哪些节点在不同的渲染下保持稳定；</strong></li></ul> 
<h3><a id="Diffing_499"></a>Diffing算法</h3> 
<h4><a id="1__500"></a><strong>1. 对比不同类型的元素</strong></h4> 
<p>当节点为不同的元素，React会拆卸原有的树，并且建立起新的树：</p> 
<ul><li>当一个元素从 <code>&lt;a&gt;</code> 变成 <code>&lt;img&gt;</code>，从 <code>&lt;Article&gt;</code> 变成 <code>&lt;Comment&gt;</code>，或从 <code>&lt;Button&gt;</code> 变成 <code>&lt;div&gt;</code> 都会触发一个完整的重建流程；</li><li>当卸载一棵树时，对应的DOM节点也会被销毁，组件实例将执行 <code>componentWillUnmount()</code> 方法；</li><li>当建立一棵新的树时，对应的 DOM 节点会被创建以及插入到 DOM 中，组件实例将执行 <code>componentWillMount()</code> 方法，紧接着 <code>componentDidMount()</code> 方法；</li></ul> 
<p>比如下面的代码更改：</p> 
<ul><li>React 会销毁 <code>Counter</code> 组件并且重新装载一个新的组件，而不会对<code>Counter</code>进行复用；</li></ul> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Counter</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>Counter</span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="2__520"></a><strong>2. 对比同一类型的元素</strong></h4> 
<p>当比对两个相同类型的 React 元素时，<strong>React 会保留 DOM 节点，仅比对及更新有改变的属性</strong>。</p> 
<p>比如下面的代码更改：</p> 
<ul><li>通过比对这两个元素，React 知道只需要修改 DOM 元素上的 <code>className</code> 属性；</li></ul> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>before<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stuff<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">className</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>after<span class="token punctuation">"</span></span> <span class="token attr-name">title</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>stuff<span class="token punctuation">"</span></span> <span class="token punctuation">/&gt;</span></span>
</code></pre> 
<p>比如下面的代码更改：</p> 
<ul><li>当更新 <code>style</code> 属性时，React 仅更新有所更变的属性。</li><li>通过比对这两个元素，React 知道只需要修改 DOM 元素上的 <code>color</code> 样式，无需修改 <code>fontWeight</code>。</li></ul> 
<pre><code class="prism language-javascript"><span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'red'</span><span class="token punctuation">,</span> <span class="token literal-property property">fontWeight</span><span class="token operator">:</span> <span class="token string">'bold'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>div style<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">color</span><span class="token operator">:</span> <span class="token string">'green'</span><span class="token punctuation">,</span> <span class="token literal-property property">fontWeight</span><span class="token operator">:</span> <span class="token string">'bold'</span><span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<p>如果是同类型的组件元素：</p> 
<ul><li>组件会保持不变，React会更新该组件的<code>props</code>，并且调用<code>componentWillReceiveProps()</code> 和 <code>componentWillUpdate()</code> 方法；</li><li>下一步，调用 <code>render()</code> 方法，diff 算法将在之前的结果以及新的结果中进行递归；</li></ul> 
<h4><a id="3__547"></a><strong>3. 对子节点进行递归</strong></h4> 
<p>在默认条件下，当递归 DOM 节点的子元素时，React 会同时遍历两个子元素的列表；当产生差异时，生成一个 <code>mutation</code>。</p> 
<p>我们来看一下在最后插入一条数据的情况：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>first<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>second<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>first<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>second<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>third<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>前面两个比较是完全相同的，所以不会产生<code>mutation</code>；</li><li>最后一个比较，产生一个<code>mutation</code>，将其插入到新的DOM树中即可；</li></ul> 
<p>但是如果我们是在中间插入一条数据：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>星际穿越<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>盗梦空间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>大话西游<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>星际穿越<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span><span class="token punctuation">&gt;</span></span>盗梦空间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<ul><li>React会对每一个子元素产生一个<code>mutation</code>，而不是保持 <code>&lt;li&gt;星际穿越&lt;/li&gt;</code>和<code>&lt;li&gt;盗梦空间&lt;/li&gt;</code>的不变；</li><li>这种低效的比较方式会带来一定的性能问题；</li></ul> 
<h3><a id="keys_587"></a>keys的优化</h3> 
<p>我们在前面遍历列表时，总是会提示一个警告，让我们加入一个<code>key</code>属性：</p> 
<p><img src="https://images2.imgbox.com/84/03/XGhQjhv1_o.jpg" alt="在这里插入图片描述"></p> 
<p>我们来看一个案例：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">movies</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">"星际穿越"</span><span class="token punctuation">,</span> <span class="token string">"盗梦空间"</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>电影列表<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>movies<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>插入数据<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">insertMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>方式一：在最后位置插入数据</p> 
<ul><li>这种情况，有无<code>key</code>意义并不大</li></ul> 
<pre><code class="prism language-javascript"><span class="token function">insertMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> newMovies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>movies<span class="token punctuation">,</span> <span class="token string">"大话西游"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">movies</span><span class="token operator">:</span> newMovies
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>方式二：在前面插入数据</p> 
<ul><li>这种做法，在没有<code>key</code>的情况下，所有的<code>li</code>都需要进行修改；</li></ul> 
<pre><code class="prism language-javascript"><span class="token function">insertMovie</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> newMovies <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"大话西游"</span><span class="token punctuation">,</span> <span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>movies<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">movies</span><span class="token operator">:</span> newMovies
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>当子元素(这里的<code>li</code>)拥有 <code>key</code> 时，React 使用 <code>key</code> 来匹配原有树上的子元素以及最新树上的子元素：</p> 
<ul><li>在下面这种场景下，<code>key</code>为<code>111</code>和<code>222</code>的元素仅仅进行位移，不需要进行任何的修改；</li><li>将<code>key</code>为<code>333</code>的元素插入到最前面的位置即可；</li></ul> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>111<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>星际穿越<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>222<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>盗梦空间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ul</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>333<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>Connecticut<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>111<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>星际穿越<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>li</span> <span class="token attr-name">key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>222<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>盗梦空间<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>li</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ul</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p><code>key</code>的注意事项：</p> 
<ul><li><code>key</code>应该是唯一的；</li><li><code>key</code>不要使用随机数（随机数在下一次<code>render</code>时，会重新生成一个数字）；</li><li>使用<code>index</code>作为<code>key</code>，对性能是没有优化的；</li></ul> 
<h3><a id="SCUshouldComponentUpdate_677"></a>SCU的优化（shouldComponentUpdate）</h3> 
<h4><a id="render_678"></a>render函数被调用</h4> 
<p>我们使用之前的一个嵌套案例：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> Component <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Header Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>Header<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Main Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Banner<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ProductList<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Banner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Banner Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Banner<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">ProductList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ProductList Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">5</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">Footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Footer Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>Footer<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"App Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>当前计数<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Header<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Main<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Footer<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>在<code>App</code>中，我们增加了一个计数器的代码；</li><li>当点击<code>+1</code>时，会重新调用<code>App</code>的<code>render</code>函数；</li><li>而当<code>App</code>的<code>render</code>函数被调用时，所有的子组件的<code>render</code>函数都会被重新调用；<br> <img src="https://images2.imgbox.com/19/fa/OfYb5L1B_o.jpg" alt="在这里插入图片描述"></li></ul> 
<p>那么，我们可以思考一下，在以后的开发中，我们只要是修改了<code>App</code>中的数据，所有的组件都需要重新<code>render</code>，进行<code>diff</code>算法，性能必然是很低的：</p> 
<ul><li>事实上，很多的组件没有必须要重新<code>render</code>；</li><li>它们调用<code>render</code>应该有一个前提，就是依赖的数据（<code>state、props</code>）发生改变时，再调用自己的<code>render</code>方法；</li></ul> 
<p>如何来控制<code>render</code>方法是否被调用呢？</p> 
<ul><li>通过<code>shouldComponentUpdate</code>方法即可；</li></ul> 
<h4><a id="shouldComponentUpdate_770"></a><strong>shouldComponentUpdate</strong></h4> 
<p>React给我们提供了一个生命周期方法 <code>shouldComponentUpdate</code>（很多时候，我们简称为<strong>SCU</strong>），这个方法接受参数，并且需要有返回值：</p> 
<p>该方法有两个参数：</p> 
<ul><li>参数一：<code>nextProps</code> 修改之后，最新的<code>props</code>属性</li><li>参数二：<code>nextState</code> 修改之后，最新的<code>state</code>属性</li></ul> 
<p>该方法返回值是一个<code>boolean</code>类型</p> 
<ul><li>返回值为<code>true</code>，那么就需要调用<code>render</code>方法；</li><li>返回值为<code>false</code>，那么就不需要调用<code>render</code>方法；</li><li>默认返回的是<code>true</code>，也就是只要<code>state</code>发生改变，就会调用<code>render</code>方法；</li></ul> 
<pre><code class="prism language-javascript"><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们可以控制它返回的内容，来决定是否需要重新渲染。</p> 
<p>比如我们在<code>App</code>中增加一个<code>message</code>属性：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Hello World"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"App Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>当前计数<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>改变文本<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Header<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Main<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Footer<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>jsx</code>中并没有依赖这个<code>message</code>，那么它的改变不应该引起重新渲染；</li><li>但是因为<code>render</code>监听到<code>state</code>的改变，就会重新<code>render</code>，所以最后<code>render</code>方法还是被重新调用了；</li></ul> 
<p>这个时候，我们可以通过实现<code>shouldComponentUpdate</code>来决定要不要重新调用<code>render</code>方法：</p> 
<pre><code class="prism language-javascript"><span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>nextState<span class="token punctuation">.</span>counter <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>这个时候，我们改变<code>counter</code>时，会重新渲染；</li><li>如果，我们改变的是<code>message</code>，那么默认返回的是<code>false</code>，那么就不会重新渲染；</li></ul> 
<p>但是我们的代码依然没有优化到最好，因为当<code>counter</code>改变时，所有的子组件依然重新渲染了：</p> 
<ul><li>所以，事实上，我们应该实现所有的子组件的<code>shouldComponentUpdate</code>；</li></ul> 
<p>比如<code>Main</code>组件，可以进行如下实现：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>

  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Main Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Banner<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ProductList<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>shouldComponentUpdate</code>默认返回一个<code>false</code>；</li><li>在特定情况下，需要更新时，我们在上面添加对应的条件即可；</li></ul> 
<h4><a id="PureComponent__memo_878"></a><strong>PureComponent 和 memo</strong></h4> 
<p>如果所有的类，我们都需要手动来实现 <code>shouldComponentUpdate</code>，那么会给我们开发者增加非常多的工作量。</p> 
<p>我们来设想一下<code>shouldComponentUpdate</code>中的各种判断的目的是什么？</p> 
<ul><li><code>props</code>或者<code>state</code>中的数据是否发生了改变，来决定<code>shouldComponentUpdate</code>返回<code>true</code>或者<code>false</code>；</li></ul> 
<p>事实上React已经考虑到了这一点，所以React已经默认帮我们实现好了，如何实现呢？</p> 
<ul><li><strong>将<code>class</code>继承自<code>PureComponent</code>。</strong></li></ul> 
<p>比如我们修改<code>Main</code>组件的代码：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Main Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Banner<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ProductList<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>PureComponent的原理是什么呢？</strong></p> 
<ul><li><strong>对<code>props</code>和<code>state</code>进行浅层比较；</strong></li></ul> 
<p>查看<code>PureComponent</code>相关的源码：</p> 
<p><code>react/ReactBaseClasses.js</code>中：</p> 
<p><img src="https://images2.imgbox.com/9d/3a/ZxuRy9pZ_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li>在<code>PureComponent</code>的原型上增加一个<code>isPureReactComponent</code>为<code>true</code>的属性</li></ul> 
<p><code>React-reconcilier/ReactFiberClassComponent.js</code>：</p> 
<p><img src="https://images2.imgbox.com/fa/1b/OdRzMJax_o.jpg" alt="在这里插入图片描述"></p> 
<p>这个方法中，调用 <code>!shallowEqual(oldProps, newProps) || !shallowEqual(oldState, newState)</code>，这个<code>shallowEqual</code>就是进行浅层比较：</p> 
<p><img src="https://images2.imgbox.com/91/a6/UeRj7dGY_o.jpg" alt="在这里插入图片描述"></p> 
<p><strong>那么，如果是一个函数式组件呢？</strong></p> 
<p>我们需要使用一个<strong>高阶组件<code>memo</code>：</strong></p> 
<ul><li>我们将之前的<code>Header、Banner、ProductList</code>都通过<code>memo</code>函数进行一层包裹；</li><li><code>Footer</code>没有使用<code>memo</code>函数进行包裹；</li><li>最终的效果是，当<code>counter</code>发生改变时，<code>Header、Banner、ProductList</code>的函数不会重新执行，而<code>Footer</code>的函数会被重新执行；</li></ul> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> Component<span class="token punctuation">,</span> PureComponent<span class="token punctuation">,</span> memo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> MemoHeader <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Header Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>Header<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">class</span> <span class="token class-name">Main</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Main Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>MemoBanner<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>MemoProductList<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> MemoBanner <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Banner Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>Banner<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> MemoProductList <span class="token operator">=</span> <span class="token function">memo</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"ProductList Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">2</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">3</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">4</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span>li<span class="token operator">&gt;</span>商品<span class="token number">5</span><span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
  <span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token function">Footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"Footer Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>Footer<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">Component</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"Hello World"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">"App Render 被调用"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>当前计数<span class="token operator">:</span> <span class="token punctuation">{<!-- --></span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span><span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>改变文本<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>MemoHeader<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Main<span class="token operator">/</span><span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>Footer<span class="token operator">/</span><span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">counter</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter <span class="token operator">+</span> <span class="token number">1</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">shouldComponentUpdate</span><span class="token punctuation">(</span><span class="token parameter">nextProps<span class="token punctuation">,</span> nextState</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextState<span class="token punctuation">.</span>counter <span class="token operator">!==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>counter<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">changeText</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">message</span><span class="token operator">:</span> <span class="token string">"你好啊,李银河"</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong><code>memo</code>的原理是什么呢？</strong></p> 
<p><code>react/memo.js</code>：</p> 
<p><img src="https://images2.imgbox.com/ff/ba/aNALipl6_o.jpg" alt="在这里插入图片描述"></p> 
<ul><li>最终返回一个对象，这个对象中有一个<code>compare</code>函数</li></ul> 
<p><img src="https://images2.imgbox.com/76/49/UlRg206N_o.png" alt="在这里插入图片描述"></p> 
<ul><li>默认是进行了浅比较</li></ul> 
<h3><a id="_1033"></a>不可变数据的力量</h3> 
<p>我们通过一个案例来演练我们之前说的不可变数据的重要性：</p> 
<pre><code class="prism language-javascript"><span class="token keyword">import</span> React<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span> PureComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'react'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">App</span> <span class="token keyword">extends</span> <span class="token class-name">PureComponent</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">props</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>state <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
      <span class="token literal-property property">friends</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"lilei"</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1.76</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"lucy"</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1.65</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{<!-- --></span> <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"tom"</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">30</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1.78</span> <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
      <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span>朋友列表<span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>ul<span class="token operator">&gt;</span>
          <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">item<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
              <span class="token keyword">return</span> <span class="token punctuation">(</span>
                <span class="token operator">&lt;</span>li key<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>item<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>span<span class="token operator">&gt;</span><span class="token punctuation">{<!-- --></span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">姓名:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>item<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> 年龄: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${<!-- --></span>item<span class="token punctuation">.</span>age<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">&gt;</span>
                  <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">incrementAge</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>年龄<span class="token operator">+</span><span class="token number">1</span><span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
                <span class="token operator">&lt;</span><span class="token operator">/</span>li<span class="token operator">&gt;</span>
              <span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token operator">&lt;</span><span class="token operator">/</span>ul<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>button onClick<span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token parameter">e</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">insertFriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token operator">&gt;</span>添加新数据<span class="token operator">&lt;</span><span class="token operator">/</span>button<span class="token operator">&gt;</span>
      <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token function">insertFriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
     
  <span class="token punctuation">}</span>

  <span class="token function">incrementAge</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/99/7b/ZlI60fDr_o.png" alt="在这里插入图片描述"></p> 
<p><strong>我们来思考一下<code>inertFriend</code>应该如何实现？</strong></p> 
<p>实现方式一：</p> 
<pre><code class="prism language-javascript"><span class="token function">insertFriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"why"</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1.88</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">friends</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>这种方式会造成界面不会发生刷新，添加新的数据；</li><li>原因是继承自<code>PureComponent</code>，会进行浅层比较，浅层比较过程中两个<code>friends</code>是相同的对象；</li></ul> 
<p>实现方式二：</p> 
<pre><code class="prism language-javascript"><span class="token function">insertFriend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">friends</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends<span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">"why"</span><span class="token punctuation">,</span> <span class="token literal-property property">age</span><span class="token operator">:</span> <span class="token number">18</span><span class="token punctuation">,</span> <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">1.88</span><span class="token punctuation">}</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li><code>[...this.state.friends, {name: "why", age: 18, height: 1.88}]</code>会生成一个新的数组引用；</li><li>在进行浅层比较时，两个引用的是不同的数组，所以它们是不相同的；</li></ul> 
<p><strong>我们再来思考一下<code>incrementAge</code>应该如何实现？</strong></p> 
<p>实现方式一：</p> 
<pre><code class="prism language-javascript"><span class="token function">incrementAge</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>age <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">friends</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>和上面方式一类似</li></ul> 
<p>实现方式二：</p> 
<pre><code class="prism language-javascript"><span class="token function">incrementAge</span><span class="token punctuation">(</span><span class="token parameter">index</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">const</span> newFriends <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token keyword">this</span><span class="token punctuation">.</span>state<span class="token punctuation">.</span>friends<span class="token punctuation">]</span><span class="token punctuation">;</span>
  newFriends<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>age <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
    <span class="token literal-property property">friends</span><span class="token operator">:</span> newFriends
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> 
<ul><li>和上面方式二类似</li></ul> 
<p>所以，在真实开发中，我们要尽量保证<code>state、props</code>中的数据不可变性，这样我们才能合理和安全的使用<code>PureComponent</code>和<code>memo</code>。</p> 
<p>当然，后面项目中我会结合<code>immutable.js</code>来保证数据的不可变性。</p> 
<p><strong>总之，更新state的原则是，不要直接修改state中的原始对象或数组，而是要通过新创建一个对象或数组的拷贝，在拷贝的对象上进行修改之后，再通过<code>setState</code>设置更新给state中的原始对象。</strong></p> 
<h3><a id="_shouldComponentUpdate__1148"></a>官网对 shouldComponentUpdate 的描述</h3> 
<p><img src="https://images2.imgbox.com/96/9e/BhVPSL1o_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4a/f6/mu5qTLrq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/54/f3/91z6RH0U_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_Reactcreatereactapp_1155"></a>四. React的脚手架：create-react-app</h2> 
<p><strong>create-react-app 创建项目以及 npm、yarn 包管理工具的使用</strong> <a href="https://mp.weixin.qq.com/s?__biz=Mzg5MDAzNzkwNA==&amp;mid=2247483968&amp;idx=1&amp;sn=848a39155d9ab4aaa0202b262b419348&amp;chksm=cfe3f1bff89478a9da582a9199227bfaac617acaea2504822fae7086dc2195b79b7819d3db51&amp;scene=178&amp;cur_album_id=1566025152667107329#rd" rel="nofollow">参考这里</a></p> 
<p><strong>快捷创建react应用的脚手架命令：</strong></p> 
<p><img src="https://images2.imgbox.com/9d/14/TMGbnQlG_o.jpg" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5a/31/odGmEVvG_o.jpg" alt="在这里插入图片描述"></p> 
<p><strong>启动React项目</strong></p> 
<p><img src="https://images2.imgbox.com/82/72/tWrmsxLH_o.jpg" alt="在这里插入图片描述"></p> 
<p><strong>编译React项目</strong></p> 
<p><img src="https://images2.imgbox.com/30/b0/VqQZWIYZ_o.jpg" alt="在这里插入图片描述"></p> 
<h2><a id="_React_1174"></a>五. React开发依赖</h2> 
<p><img src="https://images2.imgbox.com/43/fb/fjuHyZCt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_Babel_1177"></a><strong>认识 Babel</strong></h3> 
<p><img src="https://images2.imgbox.com/87/48/Nq8FnEVR_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_React_1179"></a><strong>引入 React</strong></h3> 
<p><img src="https://images2.imgbox.com/d4/2a/o5BipTBf_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5dba8c9c88decb21a3f0d5d83586ef35/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">使用acado生成mpc控制器c&#43;&#43;代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c9311d48fab3945ead8239dfa9b6a1e1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Ubuntu18.04 升级Ubuntu20.04</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>