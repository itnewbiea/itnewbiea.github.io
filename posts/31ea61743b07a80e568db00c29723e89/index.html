<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>支持Windows和Linux的文件目录创建和删除操作 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="支持Windows和Linux的文件目录创建和删除操作" />
<meta property="og:description" content="文件目录的创建和删除在Windows和Linux下使用的函数有所不同，这里整理了一份。另外在删除目录时，需要先删除目录中的内容。在这里只做了删除目录的内容，没有做删除当前目录的操作。代码如下： file_util.h
#ifndef FILE_UTIL_H #define FILE_UTIL_H #ifdef WIN32 #include &lt;windows.h&gt; #include &lt;direct.h&gt; #include &lt;io.h&gt; #else #include &lt;unistd.h&gt; #include &lt;dirent.h&gt; #include &lt;sys/stat.h&gt; #endif // !WIN32 #include &lt;cstring&gt; #include &lt;string&gt; #ifdef WIN32 #define STRDUP(a) _strdup((a)) #define ACCESS _access #define MKDIR(a) _mkdir((a)) #define RMDIR(a) _rmdir((a)) #else #define STRDUP(a) strdup((a)) #define ACCESS access #define MKDIR(a) mkdir((a), 0755) #define RMDIR(a) rmdir((a)) #endif struct BASE_DIR { #ifdef WIN32 HANDLE dir; WIN32_FIND_DATAA file; bool eof; #else DIR *dir; struct dirent *file; #endif bool file_is_dir; std::string dir_name; std::string file_name; }; int creatDir(const char *p_dir); bool openDir(const char *dir_name, BASE_DIR &amp;base_dir); bool isOpenedDir(const BASE_DIR &amp;base_dir); void closeDir(BASE_DIR &amp;base_dir); bool removeDir(const char *dir_name); #endif // !" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/31ea61743b07a80e568db00c29723e89/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-11-30T10:23:34+08:00" />
<meta property="article:modified_time" content="2016-11-30T10:23:34+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">支持Windows和Linux的文件目录创建和删除操作</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>文件目录的创建和删除在Windows和Linux下使用的函数有所不同，这里整理了一份。另外在删除目录时，需要先删除目录中的内容。在这里只做了删除目录的内容，没有做删除当前目录的操作。代码如下： <br> file_util.h</p> 
<pre class="prettyprint"><code class="language-c++ hljs vala"><span class="hljs-preprocessor">#ifndef FILE_UTIL_H</span>
<span class="hljs-preprocessor">#define FILE_UTIL_H</span>

<span class="hljs-preprocessor">#ifdef WIN32</span>
<span class="hljs-preprocessor">#include &lt;windows.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;direct.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;io.h&gt;</span>
<span class="hljs-preprocessor">#else</span>
<span class="hljs-preprocessor">#include &lt;unistd.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;dirent.h&gt;</span>
<span class="hljs-preprocessor">#include &lt;sys/stat.h&gt;</span>
<span class="hljs-preprocessor">#endif // !WIN32</span>

<span class="hljs-preprocessor">#include &lt;cstring&gt;</span>
<span class="hljs-preprocessor">#include &lt;string&gt;</span>

<span class="hljs-preprocessor">#ifdef WIN32</span>
<span class="hljs-preprocessor">#define STRDUP(a) _strdup((a))</span>
<span class="hljs-preprocessor">#define ACCESS _access</span>
<span class="hljs-preprocessor">#define MKDIR(a) _mkdir((a))</span>
<span class="hljs-preprocessor">#define RMDIR(a) _rmdir((a))</span>
<span class="hljs-preprocessor">#else</span>
<span class="hljs-preprocessor">#define STRDUP(a) strdup((a))</span>
<span class="hljs-preprocessor">#define ACCESS access</span>
<span class="hljs-preprocessor">#define MKDIR(a) mkdir((a), 0755)</span>
<span class="hljs-preprocessor">#define RMDIR(a) rmdir((a))</span>
<span class="hljs-preprocessor">#endif</span>

<span class="hljs-keyword">struct</span> BASE_DIR
{
<span class="hljs-preprocessor">#ifdef WIN32</span>
   <span class="hljs-constant"> HANDLE </span>dir;
    WIN32_FIND_DATAA file;
    <span class="hljs-keyword">bool</span> eof;
<span class="hljs-preprocessor">#else</span>
   <span class="hljs-constant"> DIR </span>*dir;
    <span class="hljs-keyword">struct</span> dirent *file;
<span class="hljs-preprocessor">#endif</span>

    <span class="hljs-keyword">bool</span> file_is_dir;
    std::<span class="hljs-keyword">string</span> dir_name;
    std::<span class="hljs-keyword">string</span> file_name;
};

<span class="hljs-keyword">int</span> creatDir(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *p_dir);
<span class="hljs-keyword">bool</span> openDir(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dir_name,<span class="hljs-constant"> BASE_DIR </span>&amp;base_dir);
<span class="hljs-keyword">bool</span> isOpenedDir(<span class="hljs-keyword">const</span><span class="hljs-constant"> BASE_DIR </span>&amp;base_dir);
<span class="hljs-keyword">void</span> closeDir(BASE_DIR &amp;base_dir);
<span class="hljs-keyword">bool</span> removeDir(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dir_name);

<span class="hljs-preprocessor">#endif // !FILE_UTIL_H</span></code></pre> 
<p>file_util.cpp</p> 
<pre class="prettyprint"><code class="language-c++ hljs cpp"><span class="hljs-preprocessor">#include "file_util.h"</span>
<span class="hljs-preprocessor">#include &lt;malloc.h&gt;</span>

<span class="hljs-comment">// 创建目录，如果已经存在，则不会创建</span>
<span class="hljs-keyword">int</span> creatDir(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *p_dir)
{
    <span class="hljs-keyword">int</span> ret;
    <span class="hljs-keyword">char</span>* p_dup_dir = STRDUP(p_dir);
    <span class="hljs-keyword">int</span> len = <span class="hljs-built_in">strlen</span>(p_dup_dir);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; len; i++) {
        <span class="hljs-keyword">if</span> (p_dup_dir[i] == <span class="hljs-string">'\\'</span> || p_dup_dir[i] == <span class="hljs-string">'/'</span>) {
            p_dup_dir[i] = <span class="hljs-string">'\0'</span>;
            ret = ACCESS(p_dup_dir, <span class="hljs-number">0</span>);
            <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
                ret = MKDIR(p_dup_dir);
                <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
                }
            }
            p_dup_dir[i] = <span class="hljs-string">'/'</span>;
        }
    }

    ret = MKDIR(p_dup_dir);
    <span class="hljs-built_in">free</span>(p_dup_dir);
    <span class="hljs-keyword">return</span> ret;
}

<span class="hljs-keyword">bool</span> openDir(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dir_name, BASE_DIR &amp;base_dir)
{
    <span class="hljs-keyword">if</span> (NULL == dir_name || <span class="hljs-string">'\0'</span> == dir_name[<span class="hljs-number">0</span>]) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

    base_dir.dir_name = dir_name;
    <span class="hljs-keyword">if</span> (<span class="hljs-string">'/'</span> != *base_dir.dir_name.rbegin()) {
        base_dir.dir_name += <span class="hljs-string">"/"</span>;
    }

<span class="hljs-preprocessor">#ifdef WIN32</span>
    base_dir.file_name = base_dir.dir_name + <span class="hljs-string">"*"</span>;
    base_dir.dir = FindFirstFileA(base_dir.file_name.c_str(), &amp;base_dir.file);
    <span class="hljs-keyword">if</span> (INVALID_HANDLE_VALUE == base_dir.dir) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }
    base_dir.eof = <span class="hljs-keyword">false</span>;
<span class="hljs-preprocessor">#else</span>
    base_dir.dir = opendir(dir_name);
    <span class="hljs-keyword">if</span> (NULL == base_dir.dir) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }
    base_dir.file = readdir(base_dir.dir);
<span class="hljs-preprocessor">#endif <span class="hljs-comment">// WIN32</span></span>

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
}

<span class="hljs-keyword">bool</span> isOpenedDir(<span class="hljs-keyword">const</span> BASE_DIR &amp;base_dir)
{
<span class="hljs-preprocessor">#ifdef WIN32</span>
    <span class="hljs-keyword">return</span> (INVALID_HANDLE_VALUE != base_dir.dir);
<span class="hljs-preprocessor">#else</span>
    <span class="hljs-keyword">return</span> (NULL != base_dir.dir);
<span class="hljs-preprocessor">#endif <span class="hljs-comment">// WIN32</span></span>
}

<span class="hljs-keyword">void</span> closeDir(BASE_DIR &amp;base_dir)
{
    <span class="hljs-keyword">if</span> (!isOpenedDir(base_dir)) {
        <span class="hljs-keyword">return</span>;
    }

<span class="hljs-preprocessor">#ifdef WIN32</span>
    FindClose(base_dir.dir);
    base_dir.dir = INVALID_HANDLE_VALUE;
<span class="hljs-preprocessor">#else</span>
    closedir(base_dir.dir);
    base_dir.dir = NULL;
<span class="hljs-preprocessor">#endif <span class="hljs-comment">// WIN32</span></span>
}

<span class="hljs-keyword">bool</span> removeDir(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *dir_name)
{
    BASE_DIR base_dir;

    <span class="hljs-keyword">if</span> (!openDir(dir_name, base_dir)) {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
    }

<span class="hljs-preprocessor">#ifdef WIN32</span>
    <span class="hljs-keyword">while</span> (!base_dir.eof) {
        WIN32_FIND_DATAA file = base_dir.file;
        base_dir.eof = !FindNextFileA(base_dir.dir, &amp;base_dir.file);

        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != <span class="hljs-built_in">strcmp</span>(file.cFileName, <span class="hljs-string">"."</span>) &amp;&amp; <span class="hljs-number">0</span> != <span class="hljs-built_in">strcmp</span>(file.cFileName, <span class="hljs-string">".."</span>)) {
            base_dir.file_name = base_dir.dir_name + file.cFileName;
            base_dir.file_is_dir = (<span class="hljs-number">0</span> != (file.dwFileAttributes &amp; FILE_ATTRIBUTE_DIRECTORY));
            <span class="hljs-keyword">if</span> (base_dir.file_is_dir) {
                removeDir(base_dir.file_name.c_str());
                RMDIR(base_dir.file_name.c_str());
            }
            <span class="hljs-keyword">else</span> {
                remove(base_dir.file_name.c_str());
            }

        }
    }
<span class="hljs-preprocessor">#else</span>
    <span class="hljs-keyword">while</span> (NULL != base_dir.file) {
        <span class="hljs-keyword">struct</span> dirent *file = base_dir.file;
        base_dir.file = readdir(base_dir.dir);

        <span class="hljs-keyword">if</span> (<span class="hljs-number">0</span> != <span class="hljs-built_in">strcmp</span>(file-&gt;d_name, <span class="hljs-string">"."</span>) &amp;&amp; <span class="hljs-number">0</span> != <span class="hljs-built_in">strcmp</span>(file-&gt;d_name, <span class="hljs-string">".."</span>)) {
            base_dir.file_name = base_dir.dir_name + file-&gt;d_name;
            base_dir.file_is_dir = <span class="hljs-keyword">false</span>;

            <span class="hljs-keyword">struct</span> stat stat_buf;
            <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> != lstat(base_dir.file_name.c_str(), &amp;stat_buf) &amp;&amp; <span class="hljs-number">0</span> != (S_IFDIR &amp; stat_buf.st_mode)) {
                base_dir.file_is_dir = <span class="hljs-keyword">true</span>;
            }
            <span class="hljs-keyword">if</span> (base_dir.file_is_dir) {
                removeDir(base_dir.file_name.c_str());
                RMDIR(base_dir.file_name.c_str());
            }
            <span class="hljs-keyword">else</span> {
                remove(base_dir.file_name.c_str());
            }
        }
    }
<span class="hljs-preprocessor">#endif <span class="hljs-comment">// WIN32</span></span>

    closeDir(base_dir);

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;
}</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6d1f7897fee3d46b7a411bcd013b0970/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">MAC笔记本 Safari,Chrome等浏览器无法打开网页</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4438c65a0284b2d63be96d2dd1264690/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CAS集群部署基于Redis缓存配置详细方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>