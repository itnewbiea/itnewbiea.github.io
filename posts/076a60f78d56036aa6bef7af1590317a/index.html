<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>视觉SLAM十四讲 第八讲 视觉里程计2 8.3 使用LK光流 代码解析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="视觉SLAM十四讲 第八讲 视觉里程计2 8.3 使用LK光流 代码解析" />
<meta property="og:description" content="整体思路
单层图像的光流
对第一帧图像提取FAST角点对提取到的角点提取光流特征检测及描述子生成，调用opencv的GFTTDetector对特征点，假定一个初始的运动量dx=0,dy=0。采用高斯牛顿法，最小化光度误差，求解运动量 雅可比矩阵dx/dt,dy/dt即u,v。由u&#43;1的像素值减u-1的像素值，得到dx/dt，同理得到dy/dt。由雅可比矩阵构建 矩阵和 ，代价值为像素点x和运动后的x&#43;dx点所在的灰度差。由LDLT分解求解dx，dy，即更新量。当代价值或更新量小于阈值时，停止，否则重复1-4步骤。 多层图像的光流
对第一帧图像提取FAST角点对提取到的角点提取光流特征检测及描述子生成，调用opencv的GFTTDetector构建4层图像金字塔由底层的图像的特征点坐标，映射到顶层的特征点坐标，构建特征点的金字塔。遍历每一层金字塔，对每层金字塔求光流 从分辨率最低的图像求LK光流初始值 最顶层，即分辨率最低的层，没有初始值，给一个初始的运动量dx=0,dy=0。从第二层到最底层，有初始值，dx=kp2[i].pt.x-kp.pt.x，同理初始化dy。 采用高斯牛顿法，最小化光度误差，求解运动量 雅可比矩阵dx/dt,dy/dt即u,v。由u&#43;1的像素值减u-1的像素值，得到dx/dt，同理得到dy/dt。由雅可比矩阵构建 H=J^TJ 矩阵和 b=-J^Tf(x) ，代价值为像素点x和运动后的x&#43;dx点所在的灰度差。由LDLT分解求解dx，dy，即更新量。当代价值或更新量小于阈值时，停止，否则重复1-4步骤。将求到的kp2，放到到下一层（坐标值乘以2）。 opencv的光流
直接调用calcOpticalFlowPyrLK函数计算光流，得到第二帧中关键点所在位置。
代码
// // Created by Xiang on 2017/12/19. // #include &lt;opencv2/opencv.hpp&gt; #include &lt;string&gt; #include &lt;chrono&gt; #include &lt;Eigen/Core&gt; #include &lt;Eigen/Dense&gt; using namespace std; using namespace cv; string file_1 = &#34;./LK1.png&#34;; // first image string file_2 = &#34;./LK2.png&#34;; // second image /// Optical flow tracker and interface class OpticalFlowTracker { public: OpticalFlowTracker( const Mat &amp;img1_, const Mat &amp;img2_, const vector&lt;KeyPoint&gt; &amp;kp1_, vector&lt;KeyPoint&gt; &amp;kp2_, vector&lt;bool&gt; &amp;success_, bool inverse_ = true, bool has_initial_ = false) : img1(img1_), img2(img2_), kp1(kp1_), kp2(kp2_), success(success_), inverse(inverse_), has_initial(has_initial_) {} void calculateOpticalFlow(const Range &amp;range); private: const Mat &amp;img1; const Mat &amp;img2; const vector&lt;KeyPoint&gt; &amp;kp1; vector&lt;KeyPoint&gt; &amp;kp2; vector&lt;bool&gt; &amp;success; bool inverse = true; bool has_initial = false; }; /** * single level optical flow * @param [in] img1 the first image * @param [in] img2 the second image * @param [in] kp1 keypoints in img1 * @param [in|out] kp2 keypoints in img2, if empty, use initial guess in kp1 * @param [out] success true if a keypoint is tracked successfully * @param [in] inverse use inverse formulation?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/076a60f78d56036aa6bef7af1590317a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-03-24T20:34:16+08:00" />
<meta property="article:modified_time" content="2020-03-24T20:34:16+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">视觉SLAM十四讲 第八讲 视觉里程计2 8.3 使用LK光流 代码解析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>整体思路<br> 单层图像的光流</p> 
<ol><li>对第一帧图像提取FAST角点</li><li>对提取到的角点提取光流</li><li>特征检测及描述子生成，调用opencv的GFTTDetector</li><li>对特征点，假定一个初始的运动量dx=0,dy=0。</li><li>采用高斯牛顿法，最小化光度误差，求解运动量 
  <ol><li>雅可比矩阵dx/dt,dy/dt即u,v。由u+1的像素值减u-1的像素值，得到dx/dt，同理得到dy/dt。</li><li>由雅可比矩阵构建 矩阵和 ，代价值为像素点x和运动后的x+dx点所在的灰度差。</li><li>由LDLT分解求解dx，dy，即更新量。</li><li>当代价值或更新量小于阈值时，停止，否则重复1-4步骤。</li></ol> </li></ol> 
<p>多层图像的光流</p> 
<ol><li>对第一帧图像提取FAST角点</li><li>对提取到的角点提取光流</li><li>特征检测及描述子生成，调用opencv的GFTTDetector</li><li>构建4层图像金字塔</li><li>由底层的图像的特征点坐标，映射到顶层的特征点坐标，构建特征点的金字塔。</li><li>遍历每一层金字塔，对每层金字塔求光流 
  <ol><li>从分辨率最低的图像求LK光流</li><li>初始值 
    <ol><li>最顶层，即分辨率最低的层，没有初始值，给一个初始的运动量dx=0,dy=0。</li><li>从第二层到最底层，有初始值，dx=kp2[i].pt.x-kp.pt.x，同理初始化dy。</li></ol> </li><li>采用高斯牛顿法，最小化光度误差，求解运动量 
    <ol><li>雅可比矩阵dx/dt,dy/dt即u,v。由u+1的像素值减u-1的像素值，得到dx/dt，同理得到dy/dt。</li><li>由雅可比矩阵构建 H=J^TJ 矩阵和 b=-J^Tf(x) ，代价值为像素点x和运动后的x+dx点所在的灰度差。</li><li>由LDLT分解求解dx，dy，即更新量。</li><li>当代价值或更新量小于阈值时，停止，否则重复1-4步骤。</li><li>将求到的kp2，放到到下一层（坐标值乘以2）。</li></ol> </li></ol> </li></ol> 
<p>opencv的光流<br> 直接调用calcOpticalFlowPyrLK函数计算光流，得到第二帧中关键点所在位置。<br> 代码</p> 
<pre><code class="prism language-cpp"><span class="token comment">//</span>
<span class="token comment">// Created by Xiang on 2017/12/19.</span>
<span class="token comment">//</span>

<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;opencv2/opencv.hpp&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;string&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;chrono&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Eigen/Core&gt;</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;Eigen/Dense&gt;</span></span>

<span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token keyword">namespace</span> cv<span class="token punctuation">;</span>

string file_1 <span class="token operator">=</span> <span class="token string">"./LK1.png"</span><span class="token punctuation">;</span>  <span class="token comment">// first image</span>
string file_2 <span class="token operator">=</span> <span class="token string">"./LK2.png"</span><span class="token punctuation">;</span>  <span class="token comment">// second image</span>

<span class="token comment">/// Optical flow tracker and interface</span>
<span class="token keyword">class</span> <span class="token class-name">OpticalFlowTracker</span> <span class="token punctuation">{<!-- --></span>
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token function">OpticalFlowTracker</span><span class="token punctuation">(</span>
        <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img1_<span class="token punctuation">,</span>
        <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img2_<span class="token punctuation">,</span>
        <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp1_<span class="token punctuation">,</span>
        vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp2_<span class="token punctuation">,</span>
        vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>success_<span class="token punctuation">,</span>
        <span class="token keyword">bool</span> inverse_ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token keyword">bool</span> has_initial_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token operator">:</span>
        <span class="token function">img1</span><span class="token punctuation">(</span>img1_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">img2</span><span class="token punctuation">(</span>img2_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">kp1</span><span class="token punctuation">(</span>kp1_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">kp2</span><span class="token punctuation">(</span>kp2_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">success</span><span class="token punctuation">(</span>success_<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">inverse</span><span class="token punctuation">(</span>inverse_<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token function">has_initial</span><span class="token punctuation">(</span>has_initial_<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>

    <span class="token keyword">void</span> <span class="token function">calculateOpticalFlow</span><span class="token punctuation">(</span><span class="token keyword">const</span> Range <span class="token operator">&amp;</span>range<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img1<span class="token punctuation">;</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img2<span class="token punctuation">;</span>
    <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp1<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp2<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>success<span class="token punctuation">;</span>
    <span class="token keyword">bool</span> inverse <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">bool</span> has_initial <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * single level optical flow
 * @param [in] img1 the first image
 * @param [in] img2 the second image
 * @param [in] kp1 keypoints in img1
 * @param [in|out] kp2 keypoints in img2, if empty, use initial guess in kp1
 * @param [out] success true if a keypoint is tracked successfully
 * @param [in] inverse use inverse formulation?
 */</span>
<span class="token keyword">void</span> <span class="token function">OpticalFlowSingleLevel</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img1<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img2<span class="token punctuation">,</span>
    <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp1<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp2<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>success<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> inverse <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token keyword">bool</span> has_initial_guess <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * multi level optical flow, scale of pyramid is set to 2 by default
 * the image pyramid will be create inside the function
 * @param [in] img1 the first pyramid
 * @param [in] img2 the second pyramid
 * @param [in] kp1 keypoints in img1
 * @param [out] kp2 keypoints in img2
 * @param [out] success true if a keypoint is tracked successfully
 * @param [in] inverse set true to enable inverse formulation
 */</span>
<span class="token keyword">void</span> <span class="token function">OpticalFlowMultiLevel</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img1<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img2<span class="token punctuation">,</span>
    <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp1<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp2<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>success<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> inverse <span class="token operator">=</span> <span class="token boolean">false</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * get a gray scale value from reference image (bi-linear interpolated)
 * @param img
 * @param x
 * @param y
 * @return the interpolated value of this pixel
 */</span>
<span class="token keyword">inline</span> <span class="token keyword">float</span> <span class="token function">GetPixelValue</span><span class="token punctuation">(</span><span class="token keyword">const</span> cv<span class="token operator">::</span>Mat <span class="token operator">&amp;</span>img<span class="token punctuation">,</span> <span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// boundary check</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;=</span> img<span class="token punctuation">.</span>cols<span class="token punctuation">)</span> x <span class="token operator">=</span> img<span class="token punctuation">.</span>cols <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;=</span> img<span class="token punctuation">.</span>rows<span class="token punctuation">)</span> y <span class="token operator">=</span> img<span class="token punctuation">.</span>rows <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
    uchar <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token operator">&amp;</span>img<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token keyword">int</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token operator">*</span> img<span class="token punctuation">.</span>step <span class="token operator">+</span> <span class="token keyword">int</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> xx <span class="token operator">=</span> x <span class="token operator">-</span> <span class="token function">floor</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> yy <span class="token operator">=</span> y <span class="token operator">-</span> <span class="token function">floor</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">float</span><span class="token punctuation">(</span>
        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> xx<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> yy<span class="token punctuation">)</span> <span class="token operator">*</span> data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span>
        xx <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> yy<span class="token punctuation">)</span> <span class="token operator">*</span> data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span>
        <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> xx<span class="token punctuation">)</span> <span class="token operator">*</span> yy <span class="token operator">*</span> data<span class="token punctuation">[</span>img<span class="token punctuation">.</span>step<span class="token punctuation">]</span> <span class="token operator">+</span>
        xx <span class="token operator">*</span> yy <span class="token operator">*</span> data<span class="token punctuation">[</span>img<span class="token punctuation">.</span>step <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// images, note they are CV_8UC1, not CV_8UC3</span>
    Mat img1 <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>file_1<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Mat img2 <span class="token operator">=</span> <span class="token function">imread</span><span class="token punctuation">(</span>file_2<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// key points, using GFTT here.</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> kp1<span class="token punctuation">;</span>
    Ptr<span class="token operator">&lt;</span>GFTTDetector<span class="token operator">&gt;</span> detector <span class="token operator">=</span> GFTTDetector<span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// maximum 500 keypoints</span>
    detector<span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">detect</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp1<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// now lets track these key points in the second image</span>
    <span class="token comment">// first use single level LK in the validation picture</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> kp2_single<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> success_single<span class="token punctuation">;</span>
    <span class="token function">OpticalFlowSingleLevel</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> kp1<span class="token punctuation">,</span> kp2_single<span class="token punctuation">,</span> success_single<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// then test multi-level LK</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> kp2_multi<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> success_multi<span class="token punctuation">;</span>
    chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point t1 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">OpticalFlowMultiLevel</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> kp1<span class="token punctuation">,</span> kp2_multi<span class="token punctuation">,</span> success_multi<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point t2 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> time_used <span class="token operator">=</span> chrono<span class="token operator">::</span>duration_cast<span class="token operator">&lt;</span>chrono<span class="token operator">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"optical flow by gauss-newton: "</span> <span class="token operator">&lt;&lt;</span> time_used<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token comment">// use opencv's flow for validation</span>
    vector<span class="token operator">&lt;</span>Point2f<span class="token operator">&gt;</span> pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>kp<span class="token operator">:</span> kp1<span class="token punctuation">)</span> pt1<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>kp<span class="token punctuation">.</span>pt<span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>uchar<span class="token operator">&gt;</span> status<span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">float</span><span class="token operator">&gt;</span> error<span class="token punctuation">;</span>
    t1 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">calcOpticalFlowPyrLK</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> pt1<span class="token punctuation">,</span> pt2<span class="token punctuation">,</span> status<span class="token punctuation">,</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t2 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    time_used <span class="token operator">=</span> chrono<span class="token operator">::</span>duration_cast<span class="token operator">&lt;</span>chrono<span class="token operator">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"optical flow by opencv: "</span> <span class="token operator">&lt;&lt;</span> time_used<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token comment">// plot the differences of those functions</span>
    Mat img2_single<span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> img2_single<span class="token punctuation">,</span> CV_GRAY2BGR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kp2_single<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success_single<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cv<span class="token operator">::</span><span class="token function">circle</span><span class="token punctuation">(</span>img2_single<span class="token punctuation">,</span> kp2_single<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">line</span><span class="token punctuation">(</span>img2_single<span class="token punctuation">,</span> kp1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">,</span> kp2_single<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Mat img2_multi<span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> img2_multi<span class="token punctuation">,</span> CV_GRAY2BGR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> kp2_multi<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>success_multi<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cv<span class="token operator">::</span><span class="token function">circle</span><span class="token punctuation">(</span>img2_multi<span class="token punctuation">,</span> kp2_multi<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">line</span><span class="token punctuation">(</span>img2_multi<span class="token punctuation">,</span> kp1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">,</span> kp2_multi<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    Mat img2_CV<span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> img2_CV<span class="token punctuation">,</span> CV_GRAY2BGR<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pt2<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>status<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            cv<span class="token operator">::</span><span class="token function">circle</span><span class="token punctuation">(</span>img2_CV<span class="token punctuation">,</span> pt2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">line</span><span class="token punctuation">(</span>img2_CV<span class="token punctuation">,</span> pt1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pt2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> cv<span class="token operator">::</span><span class="token function">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">250</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"tracked single level"</span><span class="token punctuation">,</span> img2_single<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"tracked multi level"</span><span class="token punctuation">,</span> img2_multi<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">imshow</span><span class="token punctuation">(</span><span class="token string">"tracked by opencv"</span><span class="token punctuation">,</span> img2_CV<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cv<span class="token operator">::</span><span class="token function">waitKey</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">OpticalFlowSingleLevel</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img1<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img2<span class="token punctuation">,</span>
    <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp1<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp2<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>success<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> inverse<span class="token punctuation">,</span> <span class="token keyword">bool</span> has_initial<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    kp2<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>kp1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    success<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span>kp1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    OpticalFlowTracker <span class="token function">tracker</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> img2<span class="token punctuation">,</span> kp1<span class="token punctuation">,</span> kp2<span class="token punctuation">,</span> success<span class="token punctuation">,</span> inverse<span class="token punctuation">,</span> has_initial<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">parallel_for_</span><span class="token punctuation">(</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> kp1<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                  std<span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>OpticalFlowTracker<span class="token operator">::</span>calculateOpticalFlow<span class="token punctuation">,</span> <span class="token operator">&amp;</span>tracker<span class="token punctuation">,</span> placeholders<span class="token operator">::</span>_1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> OpticalFlowTracker<span class="token operator">::</span><span class="token function">calculateOpticalFlow</span><span class="token punctuation">(</span><span class="token keyword">const</span> Range <span class="token operator">&amp;</span>range<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// parameters</span>
    <span class="token keyword">int</span> half_patch_size <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> iterations <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>size_t i <span class="token operator">=</span> range<span class="token punctuation">.</span>start<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> range<span class="token punctuation">.</span>end<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> kp <span class="token operator">=</span> kp1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">double</span> dx <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dy <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// dx,dy need to be estimated</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>has_initial<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            dx <span class="token operator">=</span> kp2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">-</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
            dy <span class="token operator">=</span> kp2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">-</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">double</span> cost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> lastCost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> succ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// indicate if this point succeeded</span>

        <span class="token comment">// Gauss-Newton iterations</span>
        Eigen<span class="token operator">::</span>Matrix2d H <span class="token operator">=</span> Eigen<span class="token operator">::</span>Matrix2d<span class="token operator">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// hessian</span>
        Eigen<span class="token operator">::</span>Vector2d b <span class="token operator">=</span> Eigen<span class="token operator">::</span>Vector2d<span class="token operator">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// bias</span>
        Eigen<span class="token operator">::</span>Vector2d J<span class="token punctuation">;</span>  <span class="token comment">// jacobian</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> iter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iter <span class="token operator">&lt;</span> iterations<span class="token punctuation">;</span> iter<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inverse <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                H <span class="token operator">=</span> Eigen<span class="token operator">::</span>Matrix2d<span class="token operator">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                b <span class="token operator">=</span> Eigen<span class="token operator">::</span>Vector2d<span class="token operator">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// only reset b</span>
                b <span class="token operator">=</span> Eigen<span class="token operator">::</span>Vector2d<span class="token operator">::</span><span class="token function">Zero</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            cost <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token comment">// compute cost and jacobian</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> <span class="token operator">-</span>half_patch_size<span class="token punctuation">;</span> x <span class="token operator">&lt;</span> half_patch_size<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> <span class="token operator">-</span>half_patch_size<span class="token punctuation">;</span> y <span class="token operator">&lt;</span> half_patch_size<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">double</span> error <span class="token operator">=</span> <span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> x<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> y<span class="token punctuation">)</span> <span class="token operator">-</span>
                                   <span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> x <span class="token operator">+</span> dx<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> y <span class="token operator">+</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token comment">// Jacobian</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>inverse <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        J <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">*</span> Eigen<span class="token operator">::</span><span class="token function">Vector2d</span><span class="token punctuation">(</span>
                            <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> dx <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> dy <span class="token operator">+</span> y<span class="token punctuation">)</span> <span class="token operator">-</span>
                                   <span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> dx <span class="token operator">+</span> x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> dy <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> dx <span class="token operator">+</span> x<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> dy <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span>
                                   <span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img2<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> dx <span class="token operator">+</span> x<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> dy <span class="token operator">+</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>iter <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// in inverse mode, J keeps same for all iterations</span>
                        <span class="token comment">// NOTE this J does not change when dx, dy is updated, so we can store it and only compute error</span>
                        J <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.0</span> <span class="token operator">*</span> Eigen<span class="token operator">::</span><span class="token function">Vector2d</span><span class="token punctuation">(</span>
                            <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> y<span class="token punctuation">)</span> <span class="token operator">-</span>
                                   <span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> x<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">-</span>
                                   <span class="token function">GetPixelValue</span><span class="token punctuation">(</span>img1<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>x <span class="token operator">+</span> x<span class="token punctuation">,</span> kp<span class="token punctuation">.</span>pt<span class="token punctuation">.</span>y <span class="token operator">+</span> y <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// compute H, b and set cost;</span>
                    b <span class="token operator">+</span><span class="token operator">=</span> <span class="token operator">-</span>error <span class="token operator">*</span> J<span class="token punctuation">;</span>
                    cost <span class="token operator">+</span><span class="token operator">=</span> error <span class="token operator">*</span> error<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>inverse <span class="token operator">==</span> <span class="token boolean">false</span> <span class="token operator">||</span> iter <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// also update H</span>
                        H <span class="token operator">+</span><span class="token operator">=</span> J <span class="token operator">*</span> J<span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

            <span class="token comment">// compute update</span>
            Eigen<span class="token operator">::</span>Vector2d update <span class="token operator">=</span> H<span class="token punctuation">.</span><span class="token function">ldlt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">solve</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>std<span class="token operator">::</span><span class="token function">isnan</span><span class="token punctuation">(</span>update<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// sometimes occurred when we have a black or white patch and H is irreversible</span>
                cout <span class="token operator">&lt;&lt;</span> <span class="token string">"update is nan"</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
                succ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>iter <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> cost <span class="token operator">&gt;</span> lastCost<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// update dx, dy</span>
            dx <span class="token operator">+</span><span class="token operator">=</span> update<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            dy <span class="token operator">+</span><span class="token operator">=</span> update<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            lastCost <span class="token operator">=</span> cost<span class="token punctuation">;</span>
            succ <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>update<span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">1e-2</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// converge</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        success<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> succ<span class="token punctuation">;</span>

        <span class="token comment">// set kp2</span>
        kp2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>pt <span class="token operator">=</span> kp<span class="token punctuation">.</span>pt <span class="token operator">+</span> <span class="token function">Point2f</span><span class="token punctuation">(</span>dx<span class="token punctuation">,</span> dy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">OpticalFlowMultiLevel</span><span class="token punctuation">(</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img1<span class="token punctuation">,</span>
    <span class="token keyword">const</span> Mat <span class="token operator">&amp;</span>img2<span class="token punctuation">,</span>
    <span class="token keyword">const</span> vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp1<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> <span class="token operator">&amp;</span>kp2<span class="token punctuation">,</span>
    vector<span class="token operator">&lt;</span><span class="token keyword">bool</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>success<span class="token punctuation">,</span>
    <span class="token keyword">bool</span> inverse<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token comment">// parameters</span>
    <span class="token keyword">int</span> pyramids <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> pyramid_scale <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> scales<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.25</span><span class="token punctuation">,</span> <span class="token number">0.125</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// create pyramids</span>
    chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point t1 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vector<span class="token operator">&lt;</span>Mat<span class="token operator">&gt;</span> pyr1<span class="token punctuation">,</span> pyr2<span class="token punctuation">;</span> <span class="token comment">// image pyramids</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pyramids<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            pyr1<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pyr2<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            Mat img1_pyr<span class="token punctuation">,</span> img2_pyr<span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">resize</span><span class="token punctuation">(</span>pyr1<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img1_pyr<span class="token punctuation">,</span>
                       cv<span class="token operator">::</span><span class="token function">Size</span><span class="token punctuation">(</span>pyr1<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cols <span class="token operator">*</span> pyramid_scale<span class="token punctuation">,</span> pyr1<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rows <span class="token operator">*</span> pyramid_scale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            cv<span class="token operator">::</span><span class="token function">resize</span><span class="token punctuation">(</span>pyr2<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> img2_pyr<span class="token punctuation">,</span>
                       cv<span class="token operator">::</span><span class="token function">Size</span><span class="token punctuation">(</span>pyr2<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cols <span class="token operator">*</span> pyramid_scale<span class="token punctuation">,</span> pyr2<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rows <span class="token operator">*</span> pyramid_scale<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pyr1<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img1_pyr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            pyr2<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>img2_pyr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span>time_point t2 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> time_used <span class="token operator">=</span> chrono<span class="token operator">::</span>duration_cast<span class="token operator">&lt;</span>chrono<span class="token operator">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    cout <span class="token operator">&lt;&lt;</span> <span class="token string">"build pyramid time: "</span> <span class="token operator">&lt;&lt;</span> time_used<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

    <span class="token comment">// coarse-to-fine LK tracking in pyramids</span>
    vector<span class="token operator">&lt;</span>KeyPoint<span class="token operator">&gt;</span> kp1_pyr<span class="token punctuation">,</span> kp2_pyr<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>kp<span class="token operator">:</span>kp1<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">auto</span> kp_top <span class="token operator">=</span> kp<span class="token punctuation">;</span>
        kp_top<span class="token punctuation">.</span>pt <span class="token operator">*</span><span class="token operator">=</span> scales<span class="token punctuation">[</span>pyramids <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        kp1_pyr<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>kp_top<span class="token punctuation">)</span><span class="token punctuation">;</span>
        kp2_pyr<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>kp_top<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> level <span class="token operator">=</span> pyramids <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> level <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> level<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// from coarse to fine</span>
        success<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t1 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">OpticalFlowSingleLevel</span><span class="token punctuation">(</span>pyr1<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">,</span> pyr2<span class="token punctuation">[</span>level<span class="token punctuation">]</span><span class="token punctuation">,</span> kp1_pyr<span class="token punctuation">,</span> kp2_pyr<span class="token punctuation">,</span> success<span class="token punctuation">,</span> inverse<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        t2 <span class="token operator">=</span> chrono<span class="token operator">::</span>steady_clock<span class="token operator">::</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> time_used <span class="token operator">=</span> chrono<span class="token operator">::</span>duration_cast<span class="token operator">&lt;</span>chrono<span class="token operator">::</span>duration<span class="token operator">&lt;</span><span class="token keyword">double</span><span class="token operator">&gt;&gt;</span><span class="token punctuation">(</span>t2 <span class="token operator">-</span> t1<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cout <span class="token operator">&lt;&lt;</span> <span class="token string">"track pyr "</span> <span class="token operator">&lt;&lt;</span> level <span class="token operator">&lt;&lt;</span> <span class="token string">" cost time: "</span> <span class="token operator">&lt;&lt;</span> time_used<span class="token punctuation">.</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>level <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>kp<span class="token operator">:</span> kp1_pyr<span class="token punctuation">)</span>
                kp<span class="token punctuation">.</span>pt <span class="token operator">/</span><span class="token operator">=</span> pyramid_scale<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>kp<span class="token operator">:</span> kp2_pyr<span class="token punctuation">)</span>
                kp<span class="token punctuation">.</span>pt <span class="token operator">/</span><span class="token operator">=</span> pyramid_scale<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span>kp<span class="token operator">:</span> kp2_pyr<span class="token punctuation">)</span>
        kp2<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>kp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> 
<p>附录<br> 数据集准备：<br> TUM提供的公开RGB-D数据集，含有许多个RGB-D视频，可以作为RGB-D或单目SLAM的实验数据。还提供了用运动捕捉系统测量的精确轨迹，可以作为标准轨迹以校准SLAM系统。本程序中使用了一部分“freburg1_desk”数据集中的图像。<br> 数据位于data/下，以压缩包形式提供(data.tar.gz)。由于TUM数据集是从实际环境中采集的，解压后，将看到以下这些文件：<br> rgb.txt和depth.txt记录了各文件的采集实际和对应的文件名。<br> rgb/和depth/目录存放着采集到的PNG格式图像文件。彩色图像的8位3通道，深度图为16位单通道图像。文件名即采集时间。<br> groundtruth.txt为外部运动捕捉系统采集到的相机位姿，格式为 ，可以看成标准轨迹。<br> 彩色图、深度图和标准轨迹的采集都是独立的，轨迹的采集频率比图像高很多。在使用数据之前，需要根据采集时间对数据进行一次时间上的对齐，一边对彩色图和深度图进行配对。原则上，可以把采集时间相近于一个阈值的数据，看成是一对图像。并把相近时间的位姿，看作是该图像的真实采集位置。<br> TUM提供了一个Python脚本“associate.py”帮助完成这件事。将该文件放到数据集目录下，运行：python associate.py rgb.txt depth.txt&gt;associate.txt。<br> 这段脚本根据输入的两个文件中的采集时间进行配对，最后输出到文件associate.txt。输出文件含有配对后的两幅图像的时间、文件名信息，可以作为后续处理的来源。此外，TUM数据集还提供了笔记估计轨迹于标准轨迹的工具。</p> 
<p>参考文献<br> 高翔《视觉SLAM十四讲：从理论到实践》及代码</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/06d945e01cf9efbf92d629575669a05d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">启动应用程序时出现应用程序无法正常启动(0xc000007b)</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/57d06ae1a37bab99435dbde67e2bc8d8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">视觉SLAM十四讲 第八讲 视觉里程计2 8.5直接法 代码解析</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>