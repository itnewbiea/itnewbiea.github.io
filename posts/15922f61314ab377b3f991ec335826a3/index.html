<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>微信小程序接入易云章（H5）人脸识别 uniApp - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="微信小程序接入易云章（H5）人脸识别 uniApp" />
<meta property="og:description" content="1.打开人脸识别页面
&lt;template&gt; &lt;view&gt; &lt;web-view @message=&#34;getMessage&#34; v-if=&#34;isWedView&#34; :src=&#34;wedViewSrc&#34;&gt;&lt;/web-view&gt; &lt;/view&gt; &lt;/template&gt; &lt;script&gt; export default{ data(){ return{ isWedView:false, id:0, wedViewSrc:&#39;&#39;, type:1 } }, onLoad(parameter) { console.log(parameter) uni.showLoading({ title: &#39;加载中&#39; }); this.id = parameter.id; this.type = parameter.type; //1考试人脸识别2看视频人脸识别 this.$http(this.$api.faceSwiping,{ api_token:uni.getStorageSync(&#39;token&#39;), url:&#39;https://sheke.test03.qcw800.com/xxxx.html&#39; //人脸识别成功后的回调地址 }).then(res=&gt;{ console.log(res,&#39;刷脸&#39;) if(res.data.code == 0){ uni.hideLoading(); this.isWedView = true; this.wedViewSrc = `https://sheke.test03.qcw800.com/xxxx.html?url=${res.data.data.url}`; }else{ this.$toast(res.data.msg,&#39;获取人脸识别url失败&#39;); } }) }, methods:{ getMessage(e) { //接收web-view传过来的参数 console.log(e.detail.data[0].options,&#39;webView传回的参数&#39;); this.$http(this.$api.faceResult,{ api_token:uni.getStorageSync(&#39;token&#39;), orderNo:e.detail.data[0].options }).then(res=&gt;{ console.log(res,&#39;人脸扫面结果&#39;) if (res.data.code == 0) { if(this." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/15922f61314ab377b3f991ec335826a3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-12-27T15:10:05+08:00" />
<meta property="article:modified_time" content="2022-12-27T15:10:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">微信小程序接入易云章（H5）人脸识别 uniApp</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>1.打开人脸识别页面</p> 
<pre><code class="language-html">&lt;template&gt;
	&lt;view&gt;
		&lt;web-view @message="getMessage" v-if="isWedView" :src="wedViewSrc"&gt;&lt;/web-view&gt;
	&lt;/view&gt;
&lt;/template&gt;

&lt;script&gt;
	export default{
		data(){
			return{
				isWedView:false,
				id:0,
				wedViewSrc:'',
				type:1
			}
		},
		onLoad(parameter) {
			console.log(parameter)
			uni.showLoading({
				title: '加载中'
			});
			this.id = parameter.id; 
			this.type = parameter.type; //1考试人脸识别2看视频人脸识别
			this.$http(this.$api.faceSwiping,{
				api_token:uni.getStorageSync('token'),
				url:'https://sheke.test03.qcw800.com/xxxx.html'  //人脸识别成功后的回调地址
			}).then(res=&gt;{
				console.log(res,'刷脸')
				if(res.data.code == 0){
					uni.hideLoading();
					this.isWedView = true;
					this.wedViewSrc = `https://sheke.test03.qcw800.com/xxxx.html?url=${res.data.data.url}`;
				}else{
					this.$toast(res.data.msg,'获取人脸识别url失败');
				}
			})
		},
		methods:{
			getMessage(e) {   //接收web-view传过来的参数
				console.log(e.detail.data[0].options,'webView传回的参数');
				this.$http(this.$api.faceResult,{
					api_token:uni.getStorageSync('token'),
					orderNo:e.detail.data[0].options
				}).then(res=&gt;{
					console.log(res,'人脸扫面结果')
					if (res.data.code == 0) {
						if(this.type == 1){
							this.$nav('/Apages/pages/examination/onlineExamination?id='+this.id+'&amp;type=2&amp;classify_id='+0,4);
						}
					} else{
						this.$toast('人脸识别失败')
						if(this.type == 2){
							this.$nav('',3);
						}
					}
				})
			}
		}
	}
&lt;/script&gt;

&lt;style lang="scss" scoped&gt;
	
&lt;/style&gt;</code></pre> 
<p>2.因为要用的是三方链接，而微信小程序的web-view业务域名无法添加三方链接域名，把后端返回的连接域名，就是替换三方的连接添加到业务域名上<a href="https://ida.qcw800.com" rel="nofollow" title="https://ida.qcw800.com">https://ida.qcw800.com</a></p> 
<p><img alt="" height="564" src="https://images2.imgbox.com/23/8b/INeacTI5_o.png" width="1200"></p> 
<p>所以解决方法是写一个H5页面放到项目服务器中调用，H5页面内容</p> 
<pre><code class="language-html">&lt;html&gt;
    &lt;head&gt;
    &lt;/head&gt;
    &lt;body&gt;
        
        &lt;script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"&gt;&lt;/script&gt;  //微信小程序依赖
        &lt;script src="https://js.cdn.aliyun.dcloud.net.cn/dev/uni-app/uni.webview.1.5.2.js"&gt;&lt;/script&gt;  //uniApp依赖
        &lt;script&gt;
            var searchStr = location.search;
            console.log(searchStr,'参数',searchStr.slice(1,4));
            if (searchStr.slice(1,4) == 'url') {
                searchStr = searchStr.substr(5);
                var form2 = document.createElement("form");
                form2.method="post";
                form2.action="https://sheke.test03.qcw800.com/ida.php?need302=1";
                var url = document.createElement("input");
                url.name="url";
                url.type="hidden";
                url.value = searchStr;
                form2.appendChild(url);
                document.body.appendChild(form2);
                form2.submit(); //提交
            }else{
                searchStr = searchStr.substr(1);
                searchStr = searchStr.split('&amp;');
                searchStr = searchStr[0].split('=');
                // alert(searchStr[1]);
                document.addEventListener('UniAppJSBridgeReady', function() {
                    uni.postMessage({
                        data: {
                            options:searchStr[1]   //向微信小程序传参
                        }
                    });
                    uni.getEnv(function(res) {
                        console.log('当前环境：' + JSON.stringify(res));
                    });
                });
                uni.navigateBack({   //触发微信小程序传参
                    delta: 0
                });
            }
                
        &lt;/script&gt;
    &lt;/body&gt;
&lt;/html&gt;</code></pre> 
<p>（H5写法二，这个方法是使用axios请求完成的，请求后会自动打开人脸识别链接，不推荐使用，因为写的不全，需要修改整理）</p> 
<pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta http-equiv="X-UA-Compatible" content="IE=edge"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
    &lt;title&gt;人脸识别&lt;/title&gt;
    &lt;style&gt;
        iframe{
            width: 100%;
            height: 100vh;
        }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;script src="https://unpkg.com/axios/dist/axios.min.js"&gt;&lt;/script&gt;
    &lt;script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/2.2.2/jquery.min.js" type="application/javascript"&gt;&lt;/script&gt;
    &lt;script&gt;
        //获取Location对象的search属性值,location对象中search属性返回的是问号之后的URL
        var searchStr = location.search;
        //去除无用的字符"?"
        searchStr = searchStr.substr(1);
        //将searchStr字符串分割成数组，数组中的每一个元素为一个参数和参数值
        var searchs = searchStr.split("&amp;");
        //获得第一个参数和值
        var address = searchs[0].split("=");
        //将第一个value输出到h5
        // document.write("&lt;h3 style=\"text-align:center\"&gt;" + "第一个value的值：" + address[1] + "&lt;/h3&gt;");
        console.log(address,'参数',searchs);
        $.post(
            'https://sheke.test03.qcw800.com/ida.php',
        {
            url:'https://ida.webank.com/api/web/login?webankAppId=IDAPDSzC&amp;version=1.0.0&amp;nonce=a7e558a36393456c913440599558bd1d&amp;orderNo=202212261515373785&amp;h5faceId=wb00802ad7a79b72b56b8de80158bb5e&amp;url=https%3A%2F%2Fwww.baidu.com&amp;userId=4998aacb0b6b4fd7b10f52e4b941a050&amp;sign=2E172788A188AA5DDFFE406934A3AA8ECDB451F6&amp;from=browser&amp;redirectType=1'
        },
        function(res){
            window.location.href="https://ida.qcw800.com/s/web/h5/";
        }
        )
        // if (searchs.length == 1) {
        //     axios.post('',"",
        //             // url: 'https://sheke.test03.qcw800.com/shualian.html'
        //         ).then(function (response) {
        //         // console.log(response.data)
        //         // console.log(response.data.data.url);
        //         // document.write(`&lt;iframe style='width: 100%;height: 100vh;' src=""&gt;&lt;/iframe&gt;`);
               
        //         // window.open(response.data.data.url,'_blank');
        //     }).catch(function (err) {
        //         console.log(err)
        //     });
        // }else{
        //     console.log('返回小程序');
        // }
    &lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre> 
<p> <img alt="" height="172" src="https://images2.imgbox.com/1c/c9/BB1WFe8A_o.png" width="1200"></p> 
<p> </p> 
<p> 3.因为在H5里使用三方链接进行人脸识别也会被微信小程序识别到，不被允许，所以要使用后端写一个三方链接替换，把三方链接替换成我们自己的服务器连接，这样既可以把我们的连接添加到微信小程序后台的<strong>业务域名</strong>（web-view）中使用，后端代码：</p> 
<pre><code class="language-php">&lt;?php
$url = $_POST['url'];
$need302 = @$_GET['need302'] ?: 0;
if(!$url || $url== ''){
    echo "url不能为空，必须用post传";
    die;
}
$url = urldecode($url);
$headerData = get_head($url);
$headerData = str_replace("webank.com",'qcw800.com',$headerData);
$headerArr = explode("\n",$headerData);
ob_start();
ob_clean();
ob_flush();
ob_end_clean();
foreach($headerArr as $key=&gt;$val){
	if(!$need302){
		if($key &gt; 3 &amp;&amp; $key &lt; 41) {
		        header($val,false);
				contiue;
		//        usleep(100);
		   }
	}
	header($val,false);
   
}
print_r($headerArr);
die;
//header('Location:https://ida.qcw800.com/s/web/h5/#/action/h5pre/');
function get_head($sUrl){
    $oCurl = curl_init();
// 设置请求头, 有时候需要,有时候不用,看请求网址是否有对应的要求
    $header[] = "Content-type: application/x-www-form-urlencoded";
    $user_agent = "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.146 Safari/537.36";

    curl_setopt($oCurl, CURLOPT_URL, $sUrl);
    curl_setopt($oCurl, CURLOPT_HTTPHEADER,$header);
// 返回 response_header, 该选项非常重要,如果不为 true, 只会获得响应的正文
    curl_setopt($oCurl, CURLOPT_HEADER, true);
// 是否不需要响应的正文,为了节省带宽及时间,在只需要响应头的情况下可以不要正文
    curl_setopt($oCurl, CURLOPT_NOBODY, true);
// 使用上面定义的 ua
    curl_setopt($oCurl, CURLOPT_USERAGENT,$user_agent);
    curl_setopt($oCurl, CURLOPT_RETURNTRANSFER, 1 );
// 不用 POST 方式请求, 意思就是通过 GET 请求
    curl_setopt($oCurl, CURLOPT_POST, false);

    $sContent = curl_exec($oCurl);
// 获得响应结果里的：头大小
    $headerSize = curl_getinfo($oCurl, CURLINFO_HEADER_SIZE);
// 根据头大小去获取头信息内容
    $header = substr($sContent, 0, $headerSize);

    curl_close($oCurl);

    return $header;
}</code></pre> 
<p>4.开始人脸识别</p> 
<p><img alt="" height="739" src="https://images2.imgbox.com/8b/3f/CiUV06Lv_o.png" width="416"></p> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f454bd531bb3a7a26a2052633955740f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">获取微信小程序版本号，uni</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9f0ce430da994835ab99d21153606350/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">tar 解压缩命令</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>