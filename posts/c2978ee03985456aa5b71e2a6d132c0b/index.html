<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>paddle模型cpu部署，压缩，量化 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="paddle模型cpu部署，压缩，量化" />
<meta property="og:description" content="NAS介绍 神经结构搜索（Neural Architecture Search，简称NAS）
NAS的原理是给定一个称为搜索空间的候选神经网络结构集合，用某种策略从中搜索出最优网络结构。神经网络结构的优劣即性能用某些指标如精度、速度来度量，称为性能评估。这一过程如下图所示。
NAS 参数重要性定义 首先对预训练模型的参数和head根据其重要性进行重排序，把重要的参数和head排在参数的前侧，保证训练过程中的参数裁剪不会裁剪掉这些重要的参数。参数的重要性计算是先使用dev数据计算一遍每个参数的梯度，然后根据梯度和参数的整体大小来计算当前参数的重要性，head的的重要性计算是通过传入一个全1的对head的mask，并计算这个mask的梯度，根据mask的梯度来判断每个Multi-Head Attention层中每个Head的重要性。
两种蒸馏压缩方式差异 由BERT到Bi-LSTM的知识蒸馏和使用DynaBERT中的策略对BERT进行压缩本质上的原理是一样的，只不过第一种方式蒸馏到的学生模型的结构是已知固定提取定义好的，第二种方式是通过不断的搜索比对得出的。
量化部署 量化
一般而言，神经网络模型的参数都是用的32bit长度的浮点型数表示。实际上，有时不需要保留那么高的精度，可以通过量化的方法减少模型的存储空间，通常用INT8代替Float32存储。比如，SGD（Stochastic Gradient Descent）所需要的精度仅为6~8bit，因此合理的量化网络也可保证精度的情况下减小模型的存储体积，并且能够大幅度加速，使得神经网络在CPU上的运行成为可能。通常，量化包含多种方法，例如：二值神经网络、三元权重网络以及XNOR网络。
要求 5 Paddle Inference 部署量化模型
检查机器
大家可以通过在命令行红输入lscpu查看本机支持指令。
在支持avx512_vnni的CPU服务器上，如：Casecade Lake, Model name: Intel® Xeon® Gold X2XX，INT8精度和性能最高，INT8性能提升为FP32模型的3~3.7倍。
在支持avx512但是不支持avx512_vnni的CPU服务器上，如：SkyLake, Model name：Intel® Xeon® Gold X1XX，INT8性能为FP32性能的1.5倍左右。
请确保机器支持完整的avx512指令集。
步骤 X86 CPU部署量化模型的步骤：
产出量化模型：使用PaddleSlim训练并产出量化模型，用户可以使用PaddleSlim产出量化训练模型或者离线量化模型。
转换量化模型：将量化模型转换成最终部署的量化模型
部署量化模型：使用Paddle Inference预测库部署量化模型
流程步骤如下：
产出量化模型：使用PaddleSlim训练并产出量化模型。注意模型中被量化的算子的参数值应该在INT8范围内，但是类型仍为float型。
在CPU上转换量化模型：在CPU上使用DNNL库转化量化模型为INT8模型。
在CPU上部署预测：在CPU上部署样例并进行预测。
参考X86 Linux上预测部署示例和X86 Windows上预测部署示例，准备预测库，对模型进行部署。
请注意，在X86 CPU预测端部署量化模型，必须开启MKLDNN，不要开启IrOptim。
if args.model_dir == &#34;&#34;: config = Config(args.model_file, args.params_file) else: config = Config(args.model_dir) config.enable_mkldnn() config.set_cpu_math_library_num_threads(args.threads) config.switch_ir_optim(False) config." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c2978ee03985456aa5b71e2a6d132c0b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-19T14:46:18+08:00" />
<meta property="article:modified_time" content="2021-10-19T14:46:18+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">paddle模型cpu部署，压缩，量化</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="NAS_0"></a>NAS介绍</h2> 
<p>神经结构搜索（Neural Architecture Search，简称NAS）<br> NAS的原理是给定一个称为搜索空间的候选神经网络结构集合，用某种策略从中搜索出最优网络结构。神经网络结构的优劣即性能用某些指标如精度、速度来度量，称为性能评估。这一过程如下图所示。<br> <img src="https://images2.imgbox.com/db/45/6EnLYaZF_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="NAS__4"></a>NAS 参数重要性定义</h2> 
<p>首先对预训练模型的参数和head根据其重要性进行重排序，把重要的参数和head排在参数的前侧，保证训练过程中的参数裁剪不会裁剪掉这些重要的参数。参数的重要性计算是先使用dev数据计算一遍每个参数的梯度，然后根据梯度和参数的整体大小来计算当前参数的重要性，head的的重要性计算是通过传入一个全1的对head的mask，并计算这个mask的梯度，根据mask的梯度来判断每个Multi-Head Attention层中每个Head的重要性。</p> 
<h2><a id="_7"></a>两种蒸馏压缩方式差异</h2> 
<p>由BERT到Bi-LSTM的知识蒸馏和使用DynaBERT中的策略对BERT进行压缩本质上的原理是一样的，只不过第一种方式蒸馏到的学生模型的结构是已知固定提取定义好的，第二种方式是通过不断的搜索比对得出的。</p> 
<h2><a id="_10"></a>量化部署</h2> 
<p>量化<br> 一般而言，神经网络模型的参数都是用的32bit长度的浮点型数表示。实际上，有时不需要保留那么高的精度，可以通过量化的方法减少模型的存储空间，通常用INT8代替Float32存储。比如，SGD（Stochastic Gradient Descent）所需要的精度仅为6~8bit，因此合理的量化网络也可保证精度的情况下减小模型的存储体积，并且能够大幅度加速，使得神经网络在CPU上的运行成为可能。通常，量化包含多种方法，例如：二值神经网络、三元权重网络以及XNOR网络。</p> 
<h3><a id="_13"></a>要求</h3> 
<p>5 Paddle Inference 部署量化模型<br> 检查机器<br> 大家可以通过在命令行红输入lscpu查看本机支持指令。<br> 在支持avx512_vnni的CPU服务器上，如：Casecade Lake, Model name: Intel® Xeon® Gold X2XX，INT8精度和性能最高，INT8性能提升为FP32模型的3~3.7倍。<br> 在支持avx512但是不支持avx512_vnni的CPU服务器上，如：SkyLake, Model name：Intel® Xeon® Gold X1XX，INT8性能为FP32性能的1.5倍左右。</p> 
<p>请确保机器支持完整的avx512指令集。</p> 
<h3><a id="_22"></a>步骤</h3> 
<p>X86 CPU部署量化模型的步骤：</p> 
<p>产出量化模型：使用PaddleSlim训练并产出量化模型，用户可以使用PaddleSlim产出量化训练模型或者离线量化模型。<br> 转换量化模型：将量化模型转换成最终部署的量化模型<br> 部署量化模型：使用Paddle Inference预测库部署量化模型</p> 
<p>流程步骤如下：</p> 
<p>产出量化模型：使用PaddleSlim训练并产出量化模型。注意模型中被量化的算子的参数值应该在INT8范围内，但是类型仍为float型。<br> 在CPU上转换量化模型：在CPU上使用DNNL库转化量化模型为INT8模型。<br> 在CPU上部署预测：在CPU上部署样例并进行预测。</p> 
<p>参考X86 Linux上预测部署示例和X86 Windows上预测部署示例，准备预测库，对模型进行部署。<br> 请注意，在X86 CPU预测端部署量化模型，必须开启MKLDNN，不要开启IrOptim。</p> 
<pre><code class="prism language-csharp"><span class="token keyword">if</span> args<span class="token punctuation">.</span>model_dir <span class="token operator">==</span> <span class="token string">""</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> <span class="token function">Config</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>model_file<span class="token punctuation">,</span> args<span class="token punctuation">.</span>params_file<span class="token punctuation">)</span>
<span class="token keyword">else</span><span class="token punctuation">:</span>
    config <span class="token operator">=</span> <span class="token function">Config</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>model_dir<span class="token punctuation">)</span>
config<span class="token punctuation">.</span><span class="token function">enable_mkldnn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
config<span class="token punctuation">.</span><span class="token function">set_cpu_math_library_num_threads</span><span class="token punctuation">(</span>args<span class="token punctuation">.</span>threads<span class="token punctuation">)</span>
config<span class="token punctuation">.</span><span class="token function">switch_ir_optim</span><span class="token punctuation">(</span>False<span class="token punctuation">)</span>
config<span class="token punctuation">.</span><span class="token function">enable_memory_optim</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

predictor <span class="token operator">=</span> <span class="token function">create_predictor</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1a5b16b9f7caa2edb4768498ff9d5fcf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; STL vector遍历方式及其效率分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b524788c1d57345637c1e9e0424f7731/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">iframe监听页面是否加载完成</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>