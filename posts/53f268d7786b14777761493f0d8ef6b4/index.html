<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>深度学习3—用三层全连接神经网络训练MNIST手写数字字符集 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="深度学习3—用三层全连接神经网络训练MNIST手写数字字符集" />
<meta property="og:description" content="上一篇文章：深度学习2—任意结点数的三层全连接神经网络
距离上篇文章过去了快四个月了，真是时光飞逝，之前因为要考博所以耽误了更新，谁知道考完博后之前落下的接近半个学期的工作是如此之多，以至于弄到现在才算基本填完坑，实在是疲惫至极。
另外在这段期间，发现了一本非常好的神经网络入门书籍，本篇的很多细节问题本人就是在这本书上找到的答案，强烈推荐一下：
上篇文章介绍了如何实现一个任意结点数的三层全连接神经网络。本篇，我们将利用已经写好的代码，搭建一个输入层、隐含层、输出层分别为784、100、10的三层全连接神经网络来训练闻名已久的mnist手写数字字符集，然后自己手写一个数字来看看网络是否能比较给力的工作。
在正式做之前，还是按照惯例讲几个会用到的知识点。
mnist数字字符集的结构解析，这个我单独写了一篇文章来做介绍了，如有需要了解请先移步：深度学习3番外篇—mnist数据集格式及转换我们之前都是直接放入几个数作为输入，然后给网络几个数作为目标来训练网络的，而mnist手写字符集给我们的是一堆手写的28*28像素的图片还有图片对应的手写数字标签，我们怎么对它进行转换？
转换是这样的，我们把图片的所有像素当做输入，也就是28*28=784个像素直接作为输入，然后用0~9总共十个数作为输出目标的指引(当标签是“5”，则目标输出为0.01、0.01、0.01、0.01、0.01、0.99、0.01、0.01、0.01、0.01，依次类推)。
这里有一点比较有意思，为什么要用0.01而不是0，用0.99而不是1？
答案是我们用的激活函数永远不能输出0，1这两个数，因此如果取了这两个数则网络永远无法达到预期，会有训练过度的可能。
另外，细心的你可能也想到了，我们之前输入的数都是在0-1的范围内的，而像素的灰度取值范围在0-255，因此我们需要先对灰度值做一个归一化处理然后再放入网络中。
这里归一化处理的方式也比较有意思，假设X为输入，我们的处理公式如下：
X ÷ 255 × 0.99 &#43; 0.01 X÷255×0.99&#43;0.01 X÷255×0.99&#43;0.01
为什么要乘0.99再加0.01？
答案是我们不希望输入取到0值，因为0有个小学生都知道的特点，任何数乘以它都等于0，因此无论输入层到隐含层的权值是多少，在输入等于0的时候都是一样的，这会影响权值的更新。我们前面只确定了输入和输出层的节点个数，隐含层的节点个数还不知道，那我们怎么选取呢？答案可能让人难过，没有绝对正确的公式，只有几个经验公式(似乎有优化算法可以确定隐含层节点个数，后面如有需要开一篇专门讨论)：
m = n &#43; l &#43; α m=\sqrt{n&#43;l}&#43;\alpha m=n&#43;l ​&#43;α m = l o g 2 n m=log_{2}n m=log2​n m = n l m=\sqrt{nl} m=nl ​
其中， m m m是隐含层节点数， n n n是输入层节点数， l l l是输出层节点数， α \alpha α是 0 0 0~ 10 10 10之间的常数
本篇取第三个，最后因为比较接近100，就直接取了100(怎么感觉好随意。。。)。因为这次的输入节点有784个，算是比较多的，要十分注意在初始化网络参数的时候要避免参数与输入节点的积之和过大的情况出现。因为我们用的是sigmod函数作为激活函数，它的波形如下图所示：
可以看到，如果输入的数值过大或过小，波形会趋于平缓，也就是通常所说的“梯度消失”，我们要避免这种情况的出现。当然这也是用sigmod函数作为激活函数的问题。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/53f268d7786b14777761493f0d8ef6b4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-19T20:02:47+08:00" />
<meta property="article:modified_time" content="2022-10-19T20:02:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">深度学习3—用三层全连接神经网络训练MNIST手写数字字符集</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>上一篇文章：<a href="http://blog.csdn.net/weixinhum/article/details/79326209">深度学习2—任意结点数的三层全连接神经网络</a></p> 
<p>距离上篇文章过去了快四个月了，真是时光飞逝，之前因为要考博所以耽误了更新，谁知道考完博后之前落下的接近半个学期的工作是如此之多，以至于弄到现在才算基本填完坑，实在是疲惫至极。</p> 
<p>另外在这段期间，发现了一本非常好的神经网络入门书籍，本篇的很多细节问题本人就是在这本书上找到的答案，强烈推荐一下：</p> 
<p><img src="https://images2.imgbox.com/0b/6b/iYYqedPH_o.png" alt="这里写图片描述"></p> 
<p>上篇文章介绍了如何实现一个任意结点数的三层全连接神经网络。本篇，我们将利用已经写好的代码，搭建一个输入层、隐含层、输出层分别为784、100、10的三层全连接神经网络来训练闻名已久的mnist手写数字字符集，然后自己手写一个数字来看看网络是否能比较给力的工作。</p> 
<p>在正式做之前，还是按照惯例讲几个会用到的知识点。</p> 
<ol><li>mnist数字字符集的结构解析，这个我单独写了一篇文章来做介绍了，如有需要了解请先移步：<a href="http://blog.csdn.net/weixinhum/article/details/74908042">深度学习3番外篇—mnist数据集格式及转换</a></li><li>我们之前都是直接放入几个数作为输入，然后给网络几个数作为目标来训练网络的，而mnist手写字符集给我们的是一堆手写的28*28像素的图片还有图片对应的手写数字标签，我们怎么对它进行转换？<br> 转换是这样的，我们把图片的所有像素当做输入，也就是28*28=784个像素直接作为输入，然后用0~9总共十个数作为输出目标的指引(当标签是“5”，则目标输出为0.01、0.01、0.01、0.01、0.01、0.99、0.01、0.01、0.01、0.01，依次类推)。<br> 这里有一点比较有意思，为什么要用0.01而不是0，用0.99而不是1？<br> 答案是我们用的激活函数永远不能输出0，1这两个数，因此如果取了这两个数则网络永远无法达到预期，会有训练过度的可能。<br> 另外，细心的你可能也想到了，我们之前输入的数都是在0-1的范围内的，而像素的灰度取值范围在0-255，因此我们需要先对灰度值做一个归一化处理然后再放入网络中。<br> 这里归一化处理的方式也比较有意思，假设X为输入，我们的处理公式如下：<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          X 
         
        
          ÷ 
         
        
          255 
         
        
          × 
         
        
          0.99 
         
        
          + 
         
        
          0.01 
         
        
       
         X÷255×0.99+0.01 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.7667em; vertical-align: -0.0833em;"></span><span class="mord mathnormal" style="margin-right: 0.0785em;">X</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">÷</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">255</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.7278em; vertical-align: -0.0833em;"></span><span class="mord">0.99</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0.01</span></span></span></span></span><br> 为什么要乘0.99再加0.01？<br> 答案是我们不希望输入取到0值，因为0有个小学生都知道的特点，任何数乘以它都等于0，因此无论输入层到隐含层的权值是多少，在输入等于0的时候都是一样的，这会影响权值的更新。</li><li>我们前面只确定了输入和输出层的节点个数，隐含层的节点个数还不知道，那我们怎么选取呢？答案可能让人难过，没有绝对正确的公式，只有几个经验公式(似乎有优化算法可以确定隐含层节点个数，后面如有需要开一篇专门讨论)：<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           m 
          
         
           = 
          
          
           
           
             n 
            
           
             + 
            
           
             l 
            
           
          
         
           + 
          
         
           α 
          
         
        
          m=\sqrt{n+l}+\alpha 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.04em; vertical-align: -0.1006em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9394em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord mathnormal">n</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span></span></span><span class="" style="top: -2.8994em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
             <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
              <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
             </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1006em;"><span class=""></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span></span></span></span></span></span><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           m 
          
         
           = 
          
         
           l 
          
         
           o 
          
          
          
            g 
           
          
            2 
           
          
         
           n 
          
         
        
          m=log_{2}n 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span><span class="mord mathnormal">o</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">g</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord mathnormal">n</span></span></span></span></span></span><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
       
        
         
         
           m 
          
         
           = 
          
          
           
           
             n 
            
           
             l 
            
           
          
         
        
          m=\sqrt{nl} 
         
        
      </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.04em; vertical-align: -0.0589em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9811em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span></span></span><span class="" style="top: -2.9411em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
             <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
              <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
             </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.0589em;"><span class=""></span></span></span></span></span></span></span></span></span></span><br> 其中，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          m 
         
        
       
         m 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span></span>是隐含层节点数，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
       
         n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span></span>是输入层节点数，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
       
         l 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span></span></span></span></span>是输出层节点数，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          α 
         
        
       
         \alpha 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span></span></span></span></span>是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          0 
         
        
       
         0 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">0</span></span></span></span></span>~<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          10 
         
        
       
         10 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">10</span></span></span></span></span>之间的常数<br> 本篇取第三个，最后因为比较接近100，就直接取了100(怎么感觉好随意。。。)。</li><li>因为这次的输入节点有784个，算是比较多的，要十分注意在初始化网络参数的时候要避免参数与输入节点的积之和过大的情况出现。因为我们用的是sigmod函数作为激活函数，它的波形如下图所示：<br> <img src="https://images2.imgbox.com/20/34/cPjUv4Xb_o.png" alt="这里写图片描述"><br> 可以看到，如果输入的数值过大或过小，波形会趋于平缓，也就是通常所说的“梯度消失”，我们要避免这种情况的出现。当然这也是用sigmod函数作为激活函数的问题。<br> 那么究竟权值取多少合适呢，一般的做法是取-1~1中间的随机数，而数学家得到的经验规则告诉我们，可以在一个节点传入链接数量平方根倒数的大致范围内随机采样，初始化权值。以我们隐含层到输出层权重为例，输出层节点有100条传入链接，则其权重范围在<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          − 
         
        
          1 
         
        
          / 
         
         
         
           100 
          
         
        
       
         -1/\sqrt{100} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1572em; vertical-align: -0.25em;"></span><span class="mord">−</span><span class="mord">1/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9072em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord">100</span></span></span><span class="" style="top: -2.8672em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
            <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
             <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
            </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1328em;"><span class=""></span></span></span></span></span></span></span></span></span>至<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          1 
         
        
          / 
         
         
         
           100 
          
         
        
       
         1/\sqrt{100} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1572em; vertical-align: -0.25em;"></span><span class="mord">1/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9072em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord">100</span></span></span><span class="" style="top: -2.8672em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
            <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
             <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
            </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1328em;"><span class=""></span></span></span></span></span></span></span></span></span>之间。</li><li>最后，我们要判断输出的是否准确，则先做前向传播，得到10个输出之后，找到最大的一个跟标签对比，如果相同则网络预测正确。</li></ol> 
<hr> 
<p>那么，原理介绍完了，我们先对下图所示的第一、二张图像和相应的标签进行训练，主要代码如下（整个工程的代码会在最后面给出）：</p> 
<p><img src="https://images2.imgbox.com/f6/1d/N6k7ZNfQ_o.png" alt="这里写图片描述"></p> 
<pre><code class="prism language-c"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">3000</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	mnet<span class="token punctuation">.</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span>mNumImg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前向传播</span>
	mnet<span class="token punctuation">.</span><span class="token function">backPropagation</span><span class="token punctuation">(</span>mNumImg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outputdata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//反向传播</span>
	mnet<span class="token punctuation">.</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span>mNumImg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前向传播</span>
	mnet<span class="token punctuation">.</span><span class="token function">backPropagation</span><span class="token punctuation">(</span>mNumImg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>outputdata<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//反向传播</span>
<span class="token punctuation">}</span>
mnet<span class="token punctuation">.</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span>mNumImg<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
mnet<span class="token punctuation">.</span><span class="token function">printresual</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出结果</span>
mnet<span class="token punctuation">.</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span>mNumImg<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>inputdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
mnet<span class="token punctuation">.</span><span class="token function">printresual</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>运行结果如下：</p> 
<p><img src="https://images2.imgbox.com/c6/74/qrEDY8jF_o.png" alt="这里写图片描述"></p> 
<p>可以看到训练了3000次之后该网络可以分类之前输入的两个数字了（10个数字中最大的为预测结果，为了方便后面的正确率统计，一般会写一个函数将最大的数选出来和标签进行对比，看看网络的判断是不是正确的）。<br> 　　<br> <img src="https://images2.imgbox.com/cb/5f/bWXtrqsw_o.png" alt="这里写图片描述"></p> 
<p>可以看到，该网络基本能达到96%的准确率，而且还有上升的趋势，因为训练时间感人，所以这里就不再接着训练了，据网上查询到的结果，该网络基本精确率基本到96%多一些，不到97%就到头了。</p> 
<hr> 
<h3><a id="C_61"></a><strong>C++实现</strong></h3> 
<p>因为网络结构都没有改，改的只是各层节点的个数，前面提到的一些注意点，因此如果对整套代码有不明白的地方可以移步前两篇文章或看看本篇前面提到的5个注意点。</p> 
<p>因为代码量变得比较多了，因此为了方便管理将工程分成了四个文件。</p> 
<h4><a id="settingh_66"></a>setting.h</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"time.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream&gt;</span></span>
using namespace std<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">IPNNUM</span> <span class="token expression"><span class="token number">784</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">HDNNUM</span> <span class="token expression"><span class="token number">100</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">OPNNUM</span> <span class="token expression"><span class="token number">10</span></span></span>
</code></pre> 
<h4><a id="nethpp_78"></a>net.hpp</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"setting.h"</span></span>

class node
<span class="token punctuation">{<!-- --></span>
public<span class="token operator">:</span>
	<span class="token keyword">double</span> value<span class="token punctuation">;</span> <span class="token comment">//数值，存储结点最后的状态</span>
	<span class="token keyword">double</span> <span class="token operator">*</span>W <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>    <span class="token comment">//结点到下一层的权值</span>

	<span class="token keyword">void</span> <span class="token function">initNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化函数，必须调用以初始化权值个数</span>
	<span class="token operator">~</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//析构函数，释放掉权值占用内存</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> node<span class="token operator">::</span><span class="token function">initNode</span><span class="token punctuation">(</span><span class="token keyword">int</span> num<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	W <span class="token operator">=</span> new <span class="token keyword">double</span><span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> num<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//给权值赋一个随机值</span>
	<span class="token punctuation">{<!-- --></span>
		W<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">/</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">2</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			W<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span>W<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

node<span class="token operator">::</span><span class="token operator">~</span><span class="token function">node</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>W <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		delete<span class="token punctuation">[</span><span class="token punctuation">]</span>W<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">//网络类，描述神经网络的结构并实现前向传播以及后向传播</span>
class net
<span class="token punctuation">{<!-- --></span>
public<span class="token operator">:</span>
	node inlayer<span class="token punctuation">[</span>IPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">//输入层</span>
	node hidlayer<span class="token punctuation">[</span>HDNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//隐含层</span>
	node outlayer<span class="token punctuation">[</span>OPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//输出层</span>

	<span class="token keyword">double</span> yita <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span><span class="token comment">//学习率η</span>
	<span class="token keyword">double</span> k1<span class="token punctuation">;</span><span class="token comment">//输入层偏置项权重</span>
	<span class="token keyword">double</span> k2<span class="token punctuation">;</span><span class="token comment">//隐含层偏置项权重</span>
	<span class="token keyword">double</span> Tg<span class="token punctuation">[</span>OPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//训练目标</span>
	<span class="token keyword">double</span> O<span class="token punctuation">[</span>OPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//网络实际输出</span>

	<span class="token function">net</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//构造函数，用于初始化各层和偏置项权重</span>
	<span class="token keyword">double</span> <span class="token function">sigmoid</span><span class="token punctuation">(</span><span class="token keyword">double</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//激活函数</span>
	<span class="token keyword">double</span> <span class="token function">getLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//损失函数，输入为目标值</span>
	<span class="token keyword">void</span> <span class="token function">forwardPropagation</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前向传播,输入为输入层节点的值</span>
	<span class="token keyword">void</span> <span class="token function">backPropagation</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//反向传播，输入为目标输出值</span>
	<span class="token keyword">void</span> <span class="token function">printresual</span><span class="token punctuation">(</span><span class="token keyword">int</span> trainingTimes<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//打印信息</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

net<span class="token operator">::</span><span class="token function">net</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">//初始化输入层和隐含层偏置项权值，给一个随机值</span>
	<span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span><span class="token punctuation">)</span><span class="token function">time</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	k1 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">/</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	k2 <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">100</span> <span class="token operator">/</span> <span class="token keyword">double</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//初始化输入层到隐含层节点权重</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> IPNNUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		inlayer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">initNode</span><span class="token punctuation">(</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//初始化隐含层到输出层节点权重</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> HDNNUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		hidlayer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">initNode</span><span class="token punctuation">(</span>OPNNUM<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//激活函数</span>
<span class="token keyword">double</span> net<span class="token operator">::</span><span class="token function">sigmoid</span><span class="token punctuation">(</span><span class="token keyword">double</span> z<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//损失函数</span>
<span class="token keyword">double</span> net<span class="token operator">::</span><span class="token function">getLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">double</span> mloss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> OPNNUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mloss <span class="token operator">+=</span> <span class="token function">pow</span><span class="token punctuation">(</span>O<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-</span> Tg<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> mloss <span class="token operator">/</span> OPNNUM<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//前向传播</span>
<span class="token keyword">void</span> net<span class="token operator">::</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>input<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> iNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iNNum <span class="token operator">&lt;</span> IPNNUM<span class="token punctuation">;</span> iNNum<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//输入层节点赋值</span>
	<span class="token punctuation">{<!-- --></span>
		inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> input<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> hNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> hNNum <span class="token operator">&lt;</span> HDNNUM<span class="token punctuation">;</span> hNNum<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//算出隐含层结点的值</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">double</span> z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> iNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iNNum <span class="token operator">&lt;</span> IPNNUM<span class="token punctuation">;</span> iNNum<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			z <span class="token operator">+=</span> inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">*</span>inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		z <span class="token operator">+=</span> k1<span class="token punctuation">;</span><span class="token comment">//加上偏置项</span>
		hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">sigmoid</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> oNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> oNNum <span class="token operator">&lt;</span> OPNNUM<span class="token punctuation">;</span> oNNum<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//算出输出层结点的值</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">double</span> z <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> hNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> hNNum <span class="token operator">&lt;</span> HDNNUM<span class="token punctuation">;</span> hNNum<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			z <span class="token operator">+=</span> hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">*</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		z <span class="token operator">+=</span> k2<span class="token punctuation">;</span><span class="token comment">//加上偏置项</span>
		O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">=</span> outlayer<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token function">sigmoid</span><span class="token punctuation">(</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">//反向传播，这里为了公式好看一点多写了一些变量作为中间值</span>
<span class="token comment">//计算过程用到的公式在博文中已经推导过了，如果代码没看明白请看看博文</span>
<span class="token keyword">void</span> net<span class="token operator">::</span><span class="token function">backPropagation</span><span class="token punctuation">(</span><span class="token keyword">double</span> <span class="token operator">*</span>T<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> OPNNUM<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		Tg<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> T<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> iNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> iNNum <span class="token operator">&lt;</span> IPNNUM<span class="token punctuation">;</span> iNNum<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//更新输入层权重</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> hNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> hNNum <span class="token operator">&lt;</span> HDNNUM<span class="token punctuation">;</span> hNNum<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">double</span> y <span class="token operator">=</span> hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
			<span class="token keyword">double</span> loss <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> oNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> oNNum <span class="token operator">&lt;</span> OPNNUM<span class="token punctuation">;</span> oNNum<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				loss <span class="token operator">+=</span> <span class="token punctuation">(</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">-</span> Tg<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span> <span class="token operator">-=</span> yita <span class="token operator">*</span> loss<span class="token operator">*</span>y<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token operator">*</span>inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> hNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> hNNum <span class="token operator">&lt;</span> HDNNUM<span class="token punctuation">;</span> hNNum<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//更新隐含层权重</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> oNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> oNNum <span class="token operator">&lt;</span> OPNNUM<span class="token punctuation">;</span> oNNum<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">-=</span> yita <span class="token operator">*</span> <span class="token punctuation">(</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">-</span> Tg<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>
				O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> net<span class="token operator">::</span><span class="token function">printresual</span><span class="token punctuation">(</span><span class="token keyword">int</span> trainingTimes<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">double</span> loss <span class="token operator">=</span> <span class="token function">getLoss</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"训练次数："</span> <span class="token operator">&lt;&lt;</span> trainingTimes <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"loss："</span> <span class="token operator">&lt;&lt;</span> loss <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> oNNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> oNNum <span class="token operator">&lt;</span> OPNNUM<span class="token punctuation">;</span> oNNum<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		cout <span class="token operator">&lt;&lt;</span> <span class="token string">"输出"</span> <span class="token operator">&lt;&lt;</span> oNNum <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"："</span> <span class="token operator">&lt;&lt;</span> O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="getImghpp_239"></a>getImg.hpp</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">once</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"setting.h"</span></span>

class ImgData<span class="token comment">//单张图像</span>
<span class="token punctuation">{<!-- --></span>
public<span class="token operator">:</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> tag<span class="token punctuation">;</span>
	<span class="token keyword">double</span> data<span class="token punctuation">[</span>IPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">double</span> label<span class="token punctuation">[</span>OPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

class getImg
<span class="token punctuation">{<!-- --></span>
public<span class="token operator">:</span>
	ImgData<span class="token operator">*</span> mImgData<span class="token punctuation">;</span>
	<span class="token keyword">void</span> <span class="token function">imgTrainDataRead</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>datapath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>labelpath<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token operator">~</span><span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> getImg<span class="token operator">::</span><span class="token function">imgTrainDataRead</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>datapath<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>labelpath<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/***********读取图片数据***********/</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> readbuf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//信息数据读取空间</span>
	FILE <span class="token operator">*</span>f<span class="token punctuation">;</span>
	<span class="token function">fopen_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>f<span class="token punctuation">,</span> datapath<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fread_s</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取魔数，即文件标志位</span>
	<span class="token function">fread_s</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据集图像个数</span>
	<span class="token keyword">int</span> sumOfImg <span class="token operator">=</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> readbuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//图像个数</span>
	<span class="token function">fread_s</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据集图像行数</span>
	<span class="token keyword">int</span> imgheight <span class="token operator">=</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> readbuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//图像行数</span>
	<span class="token function">fread_s</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据集图像列数</span>
	<span class="token keyword">int</span> imgwidth <span class="token operator">=</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> readbuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//图像列数</span>
	mImgData <span class="token operator">=</span> new ImgData<span class="token punctuation">[</span>sumOfImg<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>data <span class="token operator">=</span> new <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">[</span>IPNNUM<span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sumOfImg<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">fread_s</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> IPNNUM<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> IPNNUM<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据集图像列数</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> px <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> px <span class="token operator">&lt;</span> IPNNUM<span class="token punctuation">;</span> px<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//图像数据归一化</span>
		<span class="token punctuation">{<!-- --></span>
			mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">[</span>px<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">[</span>px<span class="token punctuation">]</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span><span class="token number">255</span><span class="token operator">*</span><span class="token number">0.99</span><span class="token operator">+</span><span class="token number">0.01</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	delete<span class="token punctuation">[</span><span class="token punctuation">]</span>data<span class="token punctuation">;</span>
	<span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/**********************************/</span>
   <span class="token comment">/***********读取标签数据***********/</span>
   <span class="token comment">/**********************************/</span>
	<span class="token function">fopen_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>f<span class="token punctuation">,</span> labelpath<span class="token punctuation">,</span> <span class="token string">"rb"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">fread_s</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取魔数，即文件标志位</span>
	<span class="token function">fread_s</span><span class="token punctuation">(</span>readbuf<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据集图像个数</span>
	sumOfImg <span class="token operator">=</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>readbuf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">+</span> readbuf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//图像个数</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> sumOfImg<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">fread_s</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取数据集图像列数</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.01</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">[</span>mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>tag<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0.99</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">fclose</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

getImg<span class="token operator">::</span><span class="token operator">~</span><span class="token function">getImg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	delete<span class="token punctuation">[</span><span class="token punctuation">]</span>mImgData<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="BPNetCcpp_309"></a>BPNetC.cpp</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"setting.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"net.hpp"</span><span class="token comment">//神经网络</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"getImg.hpp"</span><span class="token comment">//训练数据</span></span>

<span class="token keyword">void</span> <span class="token function">AccuracyRate</span><span class="token punctuation">(</span><span class="token keyword">int</span> time<span class="token punctuation">,</span> net <span class="token operator">*</span>mnet<span class="token punctuation">,</span> getImg <span class="token operator">*</span>mImg<span class="token punctuation">)</span><span class="token comment">//精确率评估</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">double</span> tagright <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//正确个数统计</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> count <span class="token operator">&lt;</span> <span class="token number">10000</span><span class="token punctuation">;</span> count<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		mnet<span class="token operator">-&gt;</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span>mImg<span class="token operator">-&gt;</span>mImgData<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前向传播</span>
		<span class="token keyword">double</span> value <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">;</span>
		<span class="token keyword">int</span> gettag <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">100</span><span class="token punctuation">;</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>mnet<span class="token operator">-&gt;</span>outlayer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">&gt;</span> value<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				value <span class="token operator">=</span> mnet<span class="token operator">-&gt;</span>outlayer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
				gettag <span class="token operator">=</span> i<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>mImg<span class="token operator">-&gt;</span>mImgData<span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">.</span>tag <span class="token operator">==</span> gettag<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			tagright<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">//mnet.printresual(0);//信息打印</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"第"</span> <span class="token operator">&lt;&lt;</span> time <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"轮:  "</span><span class="token punctuation">;</span>
	cout <span class="token operator">&lt;&lt;</span> <span class="token string">"正确率为:"</span> <span class="token operator">&lt;&lt;</span> tagright <span class="token operator">/</span> <span class="token number">10000</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	getImg mGetTrainImg<span class="token punctuation">;</span>
	mGetTrainImg<span class="token punctuation">.</span><span class="token function">imgTrainDataRead</span><span class="token punctuation">(</span><span class="token string">"train-images.idx3-ubyte"</span><span class="token punctuation">,</span> <span class="token string">"train-labels.idx1-ubyte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	getImg mGetTestImg<span class="token punctuation">;</span>
	mGetTestImg<span class="token punctuation">.</span><span class="token function">imgTrainDataRead</span><span class="token punctuation">(</span><span class="token string">"t10k-images.idx3-ubyte"</span><span class="token punctuation">,</span> <span class="token string">"t10k-labels.idx1-ubyte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	net mnet<span class="token punctuation">;</span><span class="token comment">//神经网络对象</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">60000</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			mnet<span class="token punctuation">.</span><span class="token function">forwardPropagation</span><span class="token punctuation">(</span>mGetTrainImg<span class="token punctuation">.</span>mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//前向传播</span>
			mnet<span class="token punctuation">.</span><span class="token function">backPropagation</span><span class="token punctuation">(</span>mGetTrainImg<span class="token punctuation">.</span>mImgData<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>label<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//反向传播</span>
		<span class="token punctuation">}</span>
		<span class="token function">AccuracyRate</span><span class="token punctuation">(</span>j<span class="token punctuation">,</span><span class="token operator">&amp;</span>mnet<span class="token punctuation">,</span> <span class="token operator">&amp;</span>mGetTestImg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token string">"搞完收工!\n"</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="python_361"></a><strong>python实现</strong></h3> 
<p>距离C++第一个版本完成过去了有半年多了，因为入学后各种事情搞得分身乏术，剩下一点时间也用来打游戏调解了哈哈哈。</p> 
<p>最近因为<strong>研究需要！！！</strong> 又开始看神经网络，因此顺便修改了C++的第一个版本，并且把python版本也做了出来。万万没想到之前写的版本有bug，调了一天才调通了，看了之前文章python代码的同志们实在是抱歉！</p> 
<p>另外，虽然完美的跑通了代码（其实也就是把C++版本翻译了一下），但python的运行速度之低实在是让人想哭（这里有极大部分是本人水平不够的关系，但本人一点都不想去学怎么提高其效率，因为不需要）。因此，在这篇过后将直接取消python实现这一块，哈哈哈哈哈！那么就用该块最后一份代码送它上路吧！</p> 
<h4><a id="ReadDatapy_367"></a>ReadData.py</h4> 
<pre><code class="prism language-py"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> struct

<span class="token keyword">def</span> <span class="token function">loadImageSet</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"load image set"</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
	binfile<span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
	buffers <span class="token operator">=</span> binfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
	head <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span><span class="token string">'&gt;IIII'</span> <span class="token punctuation">,</span> buffers <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"head,"</span><span class="token punctuation">,</span>head<span class="token punctuation">)</span>
	offset <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span><span class="token string">'&gt;IIII'</span><span class="token punctuation">)</span>
	imgNum <span class="token operator">=</span> head<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	width <span class="token operator">=</span> head<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
	height <span class="token operator">=</span> head<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
	<span class="token comment">#[60000]*28*28</span>
	bits <span class="token operator">=</span> imgNum <span class="token operator">*</span> width <span class="token operator">*</span> height
	bitsString <span class="token operator">=</span> <span class="token string">'&gt;'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>bits<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'B'</span> <span class="token comment">#读取定长数据段，即字符集图片总和</span>
	imgs <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span>bitsString<span class="token punctuation">,</span>buffers<span class="token punctuation">,</span>offset<span class="token punctuation">)</span>
	binfile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
	imgs <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>imgs<span class="token punctuation">,</span><span class="token punctuation">[</span>imgNum<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span>width<span class="token operator">*</span>height<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">#将字符集图片分隔为单张图片</span>
	<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"load imgs finished"</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> imgs

<span class="token keyword">def</span> <span class="token function">loadLabelSet</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">:</span>
	<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"load label set"</span><span class="token punctuation">,</span>filename<span class="token punctuation">)</span>
	binfile <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>
	buffers <span class="token operator">=</span> binfile<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span>
	head <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span><span class="token string">'&gt;II'</span> <span class="token punctuation">,</span> buffers <span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">"head,"</span><span class="token punctuation">,</span>head<span class="token punctuation">)</span>
	imgNum<span class="token operator">=</span>head<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
	offset <span class="token operator">=</span> struct<span class="token punctuation">.</span>calcsize<span class="token punctuation">(</span><span class="token string">'&gt;II'</span><span class="token punctuation">)</span>
	numString <span class="token operator">=</span> <span class="token string">'&gt;'</span><span class="token operator">+</span><span class="token builtin">str</span><span class="token punctuation">(</span>imgNum<span class="token punctuation">)</span><span class="token operator">+</span><span class="token string">"B"</span>
	labels <span class="token operator">=</span> struct<span class="token punctuation">.</span>unpack_from<span class="token punctuation">(</span>numString <span class="token punctuation">,</span> buffers <span class="token punctuation">,</span> offset<span class="token punctuation">)</span>
	binfile<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>
	labels <span class="token operator">=</span> np<span class="token punctuation">.</span>reshape<span class="token punctuation">(</span>labels<span class="token punctuation">,</span><span class="token punctuation">[</span>imgNum<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">print</span> <span class="token punctuation">(</span><span class="token string">'load label finished'</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> labels
</code></pre> 
<h4><a id="BPNetPypy_406"></a>BPNetPy.py</h4> 
<pre><code class="prism language-py"><span class="token keyword">import</span> ReadData <span class="token keyword">as</span> rd
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> math
<span class="token keyword">import</span> random
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np

IPNNUM<span class="token operator">=</span><span class="token number">784</span>     <span class="token comment">#输入层节点数</span>
HDNNUM<span class="token operator">=</span><span class="token number">100</span>    <span class="token comment">#隐含层节点数</span>
OPNNUM<span class="token operator">=</span><span class="token number">10</span>     <span class="token comment">#输出层节点数</span>

<span class="token keyword">class</span> <span class="token class-name">node</span><span class="token punctuation">:</span>
    <span class="token comment">#结点类，用以构成网络</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>connectNum<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        self<span class="token punctuation">.</span>value<span class="token operator">=</span><span class="token number">0</span> <span class="token comment">#数值，存储结点最后的状态，对应到文章示例为X1，Y1等值</span>
        self<span class="token punctuation">.</span>W <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token operator">*</span>np<span class="token punctuation">.</span>random<span class="token punctuation">.</span>random_sample<span class="token punctuation">(</span>connectNum<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.01</span>

<span class="token keyword">class</span> <span class="token class-name">net</span><span class="token punctuation">:</span>
    <span class="token comment">#网络类，描述神经网络的结构并实现前向传播以及后向传播</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#初始化函数，用于初始化各层间节点和偏置项权重</span>
        <span class="token comment">#输入层结点</span>
        self<span class="token punctuation">.</span>inlayer<span class="token operator">=</span><span class="token punctuation">[</span>node<span class="token punctuation">(</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> IPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>inlayer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>node<span class="token punctuation">(</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token comment">#隐含层结点</span>
        self<span class="token punctuation">.</span>hidlayer<span class="token operator">=</span><span class="token punctuation">[</span>node<span class="token punctuation">(</span>OPNNUM<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> HDNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">.</span>append<span class="token punctuation">(</span>node<span class="token punctuation">(</span>OPNNUM<span class="token punctuation">)</span><span class="token punctuation">)</span>             
        <span class="token comment">#输出层结点</span>
        self<span class="token punctuation">.</span>outlayer<span class="token operator">=</span><span class="token punctuation">[</span>node<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> obj <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>outlayer<span class="token operator">=</span><span class="token punctuation">[</span>node<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">]</span>                 

        self<span class="token punctuation">.</span>yita <span class="token operator">=</span> <span class="token number">0.1</span>                                            <span class="token comment">#学习率η</span>
        self<span class="token punctuation">.</span>k1<span class="token operator">=</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>                       <span class="token comment">#输入层偏置项权重</span>
        self<span class="token punctuation">.</span>k2<span class="token operator">=</span>random<span class="token punctuation">.</span>random<span class="token punctuation">(</span><span class="token punctuation">)</span>                       <span class="token comment">#隐含层偏置项权重</span>
        self<span class="token punctuation">.</span>Tg<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>OPNNUM<span class="token punctuation">)</span>                   <span class="token comment">#训练目标</span>
        self<span class="token punctuation">.</span>O<span class="token operator">=</span>np<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span>OPNNUM<span class="token punctuation">)</span>                     <span class="token comment">#网络实际输出</span>

    <span class="token keyword">def</span> <span class="token function">sigmoid</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>z<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#激活函数</span>
        <span class="token keyword">return</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>exp<span class="token punctuation">(</span><span class="token operator">-</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">getLoss</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#损失函数</span>
        loss<span class="token operator">=</span><span class="token number">0</span>
        <span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            loss<span class="token operator">+=</span><span class="token builtin">pow</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">-</span>self<span class="token punctuation">.</span>Tg<span class="token punctuation">[</span>num<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> loss<span class="token operator">/</span>OPNNUM

    <span class="token keyword">def</span> <span class="token function">forwardPropagation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#前向传播</span>
        <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> IPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#输入层节点赋值</span>
            self<span class="token punctuation">.</span>inlayer<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">for</span> hNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
             <span class="token comment">#算出隐含层结点的值</span>
            z <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> iNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>IPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
                z<span class="token operator">+=</span>self<span class="token punctuation">.</span>inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">*</span>self<span class="token punctuation">.</span>inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span>
            <span class="token comment">#加上偏置项</span>
            z<span class="token operator">+=</span> self<span class="token punctuation">.</span>k1
            self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>z<span class="token punctuation">)</span>
        <span class="token keyword">for</span> oNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#算出输出层结点的值</span>
            z <span class="token operator">=</span> <span class="token number">0</span>
            <span class="token keyword">for</span> hNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
                z <span class="token operator">+=</span> self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value<span class="token operator">*</span> self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span>
            z <span class="token operator">+=</span> self<span class="token punctuation">.</span>k2
            self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">=</span> self<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>z<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">backPropagation</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>T<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#反向传播，这里为了公式好看一点多写了一些变量作为中间值</span>
        <span class="token keyword">for</span> num <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>Tg<span class="token punctuation">[</span>num<span class="token punctuation">]</span> <span class="token operator">=</span> T<span class="token punctuation">[</span>num<span class="token punctuation">]</span>
        <span class="token keyword">for</span> iNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>IPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#更新输入层权重</span>
            <span class="token keyword">for</span> hNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
                y <span class="token operator">=</span> self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value
                loss <span class="token operator">=</span> <span class="token number">0</span>
                <span class="token keyword">for</span> oNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    loss<span class="token operator">+=</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>Tg<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span>
                self<span class="token punctuation">.</span>inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span> <span class="token operator">-=</span> self<span class="token punctuation">.</span>yita<span class="token operator">*</span>loss<span class="token operator">*</span>y<span class="token operator">*</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span> y<span class="token punctuation">)</span><span class="token operator">*</span>self<span class="token punctuation">.</span>inlayer<span class="token punctuation">[</span>iNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value
        <span class="token keyword">for</span> hNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>HDNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token comment">#更新隐含层权重</span>
            <span class="token keyword">for</span> oNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
                self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>W<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token operator">-=</span> self<span class="token punctuation">.</span>yita<span class="token operator">*</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span> <span class="token operator">-</span> self<span class="token punctuation">.</span>Tg<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token operator">*</span>\
                    <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">-</span> self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">*</span>self<span class="token punctuation">.</span>hidlayer<span class="token punctuation">[</span>hNNum<span class="token punctuation">]</span><span class="token punctuation">.</span>value

    <span class="token keyword">def</span> <span class="token function">printresual</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span>trainingTimes<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#信息打印</span>
        loss <span class="token operator">=</span> self<span class="token punctuation">.</span>getLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"训练次数："</span><span class="token punctuation">,</span> trainingTimes<span class="token punctuation">)</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"loss"</span><span class="token punctuation">,</span>loss<span class="token punctuation">)</span>
        <span class="token keyword">for</span> oNNum <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span>OPNNUM<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"输出"</span><span class="token punctuation">,</span>oNNum<span class="token punctuation">,</span><span class="token string">":"</span><span class="token punctuation">,</span>self<span class="token punctuation">.</span>O<span class="token punctuation">[</span>oNNum<span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment">#主程序</span>
mnet<span class="token operator">=</span>net<span class="token punctuation">(</span><span class="token punctuation">)</span>
imgs<span class="token operator">=</span>rd<span class="token punctuation">.</span>loadImageSet<span class="token punctuation">(</span><span class="token string">"train-images.idx3-ubyte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
labels<span class="token operator">=</span>rd<span class="token punctuation">.</span>loadLabelSet<span class="token punctuation">(</span><span class="token string">"train-labels.idx1-ubyte"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">##显示图像</span>
<span class="token comment">#im=np.array(input)</span>
<span class="token comment">#im = im.reshape(28,28)</span>
<span class="token comment">#fig = plt.figure()</span>
<span class="token comment">#plotwindow = fig.add_subplot(111)</span>
<span class="token comment">#plt.imshow(im , cmap='gray')</span>
<span class="token comment">#plt.show()</span>
<span class="token keyword">for</span> n <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
    <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">input</span><span class="token operator">=</span><span class="token punctuation">(</span>imgs<span class="token punctuation">[</span>x<span class="token punctuation">,</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">255</span><span class="token operator">*</span><span class="token number">0.99</span><span class="token operator">+</span><span class="token number">0.01</span><span class="token punctuation">)</span><span class="token punctuation">.</span>ravel<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#ravel多维转1维</span>
        target<span class="token operator">=</span>np<span class="token punctuation">.</span>ones<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">0.01</span>
        target<span class="token punctuation">[</span>labels<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0.99</span>
        mnet<span class="token punctuation">.</span>forwardPropagation<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span>
        mnet<span class="token punctuation">.</span>backPropagation<span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>n<span class="token operator">%</span><span class="token number">200</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            mnet<span class="token punctuation">.</span>printresual<span class="token punctuation">(</span>n<span class="token punctuation">)</span>
</code></pre> 
<h3><a id="pytorchCPU_529"></a><strong>pytorch的CPU实现</strong></h3> 
<pre><code class="prism language-py"><span class="token comment"># coding=utf-8</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>datasets <span class="token keyword">as</span> dsets
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms

<span class="token comment">#网络模型</span>
<span class="token keyword">class</span> <span class="token class-name">Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#定义Net的初始化函数，这个函数定义了该神经网络的基本结构</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#复制并使用Net的父类的初始化方法，即先运行nn.Module的初始化函数</span>
        self<span class="token punctuation">.</span>intohid_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">#定义输入层到隐含层的连结关系函数</span>
        self<span class="token punctuation">.</span>hidtoout_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">#定义隐含层到输出层的连结关系函数</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#定义该神经网络的向前传播函数，该函数必须定义，一旦定义成功，向后传播函数也会自动生成</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>intohid_layer<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#输入input在输入层经过经过加权和与激活函数后到达隐含层</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidtoout_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">#类似上面</span>
        <span class="token keyword">return</span> x

mnet <span class="token operator">=</span> Net<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#数据集</span>
train_dataset <span class="token operator">=</span> dsets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span>root <span class="token operator">=</span> <span class="token string">'../mnist/'</span><span class="token punctuation">,</span> <span class="token comment">#选择数据的根目录</span>
                           train <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># 选择训练集</span>
                           transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 转换成tensor变量</span>
                           download <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 不从网络上download图片</span>
test_dataset <span class="token operator">=</span> dsets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span>root <span class="token operator">=</span> <span class="token string">'../mnist/'</span><span class="token punctuation">,</span> <span class="token comment"># 选择数据的根目录</span>
                           train <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token comment"># 选择训练集</span>
                           transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment"># 转换成tensor变量</span>
                           download <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 不从网络上download图片</span>
<span class="token comment"># 加载数据</span>
train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset <span class="token operator">=</span> train_dataset<span class="token punctuation">,</span> 
                                           batch_size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">#每一次训练选用的数据个数</span>
                                           shuffle <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment">#将数据打乱</span>
test_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset <span class="token operator">=</span> test_dataset<span class="token punctuation">,</span>
                                          batch_size <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span><span class="token comment">#每一次训练选用的数据个数</span>
                                          shuffle <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>

loss_fn <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#损失函数定义，可修改</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>mnet<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#训练次数</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'current epoch = %d'</span> <span class="token operator">%</span> epoch<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#利用enumerate取出一个可迭代对象的内容</span>
        images <span class="token operator">=</span> Variable<span class="token punctuation">(</span>images<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> Variable<span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#将标签转为单列矩阵</span>
        target<span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span>dim <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> index <span class="token operator">=</span> labels<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">)</span><span class="token comment">#将标签转为onehot形式</span>
        target<span class="token operator">+=</span><span class="token number">0.01</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">#清空节点值</span>
        outputs <span class="token operator">=</span> mnet<span class="token punctuation">(</span>images<span class="token punctuation">)</span>          <span class="token comment">#前向传播</span>
        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> target<span class="token punctuation">)</span>  <span class="token comment">#损失计算</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment">#后向传播</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment">#更新权值</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">10000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            total <span class="token operator">=</span> <span class="token number">0</span>
            correct <span class="token operator">=</span> <span class="token number">0.0</span>
            <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
                images <span class="token operator">=</span> Variable<span class="token punctuation">(</span>images<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                outputs <span class="token operator">=</span> mnet<span class="token punctuation">(</span>images<span class="token punctuation">)</span>                                        <span class="token comment">#前向传播</span>
                _<span class="token punctuation">,</span> predicts <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>                <span class="token comment">#返回预测结果</span>
                total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicts <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Accuracy = %.2f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token builtin">float</span><span class="token punctuation">(</span>correct<span class="token punctuation">)</span> <span class="token operator">/</span> total<span class="token punctuation">)</span><span class="token punctuation">)</span>

end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'花费时间%.2f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<p>上面的代码在频率为3.40GHz的电脑上，训练10遍，每次都遍历一整个训练集要花费1000s左右，也就是16.7分钟左右，因全连接神经网络的过拟合问题，正确率基本到了97.5%之后就再也升不上去了。</p> 
<h3><a id="pytorchGPU_606"></a><strong>pytorch的GPU实现</strong></h3> 
<pre><code class="prism language-py"><span class="token comment"># coding=utf-8</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>autograd <span class="token keyword">import</span> Variable
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>datasets <span class="token keyword">as</span> dsets
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms

<span class="token comment">#网络模型</span>
<span class="token keyword">class</span> <span class="token class-name">Net</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#定义Net的初始化函数，这个函数定义了该神经网络的基本结构</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Net<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">#复制并使用Net的父类的初始化方法，即先运行nn.Module的初始化函数</span>
        self<span class="token punctuation">.</span>intohid_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">784</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token comment">#定义输入层到隐含层的连结关系函数</span>
        self<span class="token punctuation">.</span>hidtoout_layer <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token comment">#定义隐含层到输出层的连结关系函数</span>
    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> <span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment">#定义该神经网络的向前传播函数，该函数必须定义，一旦定义成功，向后传播函数也会自动生成</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>intohid_layer<span class="token punctuation">(</span><span class="token builtin">input</span><span class="token punctuation">)</span><span class="token punctuation">)</span>   <span class="token comment">#输入input在输入层经过经过加权和与激活函数后到达隐含层</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>sigmoid<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hidtoout_layer<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">#类似上面</span>
        <span class="token keyword">return</span> x

mnet <span class="token operator">=</span> Net<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">#数据集</span>
train_dataset <span class="token operator">=</span> dsets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span>root <span class="token operator">=</span> <span class="token string">'../mnist/'</span><span class="token punctuation">,</span> <span class="token comment">#选择数据的根目录</span>
                           train <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token comment"># 选择训练集</span>
                           transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment"># 转换成tensor变量</span>
                           download <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 不从网络上download图片</span>
test_dataset <span class="token operator">=</span> dsets<span class="token punctuation">.</span>MNIST<span class="token punctuation">(</span>root <span class="token operator">=</span> <span class="token string">'../mnist/'</span><span class="token punctuation">,</span> <span class="token comment"># 选择数据的根目录</span>
                           train <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token comment"># 选择训练集</span>
                           transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment"># 转换成tensor变量</span>
                           download <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span> <span class="token comment"># 不从网络上download图片</span>
<span class="token comment"># 加载数据</span>
train_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset <span class="token operator">=</span> train_dataset<span class="token punctuation">,</span> 
                                           batch_size <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span><span class="token comment">#每一次训练选用的数据个数</span>
                                           shuffle <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span><span class="token comment">#将数据打乱</span>
test_loader <span class="token operator">=</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data<span class="token punctuation">.</span>DataLoader<span class="token punctuation">(</span>dataset <span class="token operator">=</span> test_dataset<span class="token punctuation">,</span>
                                          batch_size <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span><span class="token comment">#每一次训练选用的数据个数</span>
                                          shuffle <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">)</span>

loss_fn <span class="token operator">=</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>MSELoss<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">#损失函数定义，可修改</span>
optimizer <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>mnet<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>

start <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token comment">#训练次数</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'current epoch = %d'</span> <span class="token operator">%</span> epoch<span class="token punctuation">)</span>
    <span class="token keyword">for</span> i<span class="token punctuation">,</span> <span class="token punctuation">(</span>images<span class="token punctuation">,</span> labels<span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token comment">#利用enumerate取出一个可迭代对象的内容</span>
        images <span class="token operator">=</span> Variable<span class="token punctuation">(</span>images<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> Variable<span class="token punctuation">(</span>labels<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        labels <span class="token operator">=</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>LongTensor<span class="token punctuation">(</span>labels<span class="token punctuation">)</span><span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token comment">#将标签转为单列矩阵</span>
        target<span class="token operator">=</span> torch<span class="token punctuation">.</span>zeros<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>scatter_<span class="token punctuation">(</span>dim <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> index <span class="token operator">=</span> labels<span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">)</span><span class="token comment">#将标签转为onehot形式</span>
        target<span class="token operator">+=</span><span class="token number">0.01</span>
        optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>               <span class="token comment">#清空节点值</span>
        outputs <span class="token operator">=</span> mnet<span class="token punctuation">(</span>images<span class="token punctuation">)</span>           <span class="token comment">#前向传播</span>
        loss <span class="token operator">=</span> loss_fn<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> target<span class="token punctuation">)</span>  <span class="token comment">#损失计算</span>
        loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>                          <span class="token comment">#后向传播</span>
        optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>                         <span class="token comment">#更新权值</span>
        <span class="token keyword">if</span> i <span class="token operator">%</span> <span class="token number">10000</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            total <span class="token operator">=</span> <span class="token number">0</span>
            correct <span class="token operator">=</span> <span class="token number">0.0</span>
            <span class="token keyword">for</span> images<span class="token punctuation">,</span> labels <span class="token keyword">in</span> test_loader<span class="token punctuation">:</span>
                images <span class="token operator">=</span> Variable<span class="token punctuation">(</span>images<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">28</span> <span class="token operator">*</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                outputs <span class="token operator">=</span> mnet<span class="token punctuation">(</span>images<span class="token punctuation">)</span>                                        <span class="token comment">#前向传播</span>
                _<span class="token punctuation">,</span> predicts <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>                <span class="token comment">#返回预测结果</span>
                total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicts <span class="token operator">==</span> labels<span class="token punctuation">.</span>cuda<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Accuracy = %.2f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span><span class="token number">100</span> <span class="token operator">*</span> <span class="token builtin">float</span><span class="token punctuation">(</span>correct<span class="token punctuation">)</span> <span class="token operator">/</span> total<span class="token punctuation">)</span><span class="token punctuation">)</span>

end <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'花费时间%.2f'</span> <span class="token operator">%</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a85b8b3306436793bce8fc1520ffb1fb/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言数据结构之链表</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3fdb84ba5b2bff77b1bb307b1c41a790/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Mybatis使用IN()查询出现的错误解决记录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>