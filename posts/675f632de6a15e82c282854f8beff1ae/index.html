<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>基于STM32的颜色传感器TCS3472 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="基于STM32的颜色传感器TCS3472" />
<meta property="og:description" content="文章目录 前言一、TCS3472是什么？二、RGB 颜色传感器分析三、驱动TCS34723.1读取R,G,B 四、测试TCS34724.1参数测试 总结 前言 最近由于课程设计要求，用到了一款颜色传感器芯片TCS3472，可以读取物体表面三种RGB三种颜色分量。
环境 keil5 uvison
单片机：STM32ZET6，颜色传感器TCS3472
标准库驱动
串口或者WIFI读取
一、TCS3472是什么？ TCS3472 光电转换器包含一个 3×4 光电二极管阵列、四个集成光电二极管电流 的模数转换器(ADC)、数据寄存器、一个状态机和一个 I²C 接口。
3×4 光电二极 管阵列由红光、绿光、蓝光和清晰(未滤光)光电二极管组成。此外，光电二极管 还涂有红外阻挡滤光片。
四个积分 ADC 同时将放大的光电二极管电流转换为 16 位数字值。转换周期完成后，结果被传输到数据寄存器，数据寄存器采用双缓冲 方式，以确保数据的完整性。所有内部时序以及低功率等待状态都由状态机控制。
TCS3472 数据通信通过高达 400 kHz 的双线 I²C 快速串行总线完成。行业标准 I²C 总线方便了与微控制器和嵌入式处理器的轻松直接连接。除 I²C 总线外，TCS3472 还提供单独的中断信号输出。当中断使能且超过用户定义的阈值时，有效-低电 平中断将被置位，并保持置位状态，直到控制器将其清零。此中断功能无需轮询 TCS3472，从而简化并提高了系统软件的效率。用户可以定义中断阈值的上限和 下限，并应用中断持续过滤器。中断持续过滤器允许用户定义在生成中断之前所 需的连续超出阈值事件的数量。中断输出是开漏的，因此可以与其他器件进行布 线。
二、RGB 颜色传感器分析 颜色传感器用白光照射到物体，物体反射回来的光由红光、绿光、蓝光和清 晰(未滤光)光电二极管吸收，产生光电效应，并且产生光电流，四个积分 ADC 同时将放大的光电二极管电流转换为 16 位数字值。转换周期完成后，结果被传 输到数据寄存器，数据寄存器采用双缓冲方式，以确保数据的完整性。
三、驱动TCS3472 TCS3472采用IIC驱动，STM32采用IO口模拟IIc驱动
TCS3472.c
这个是用寄存器来写的，PB口，如果要改端口的话，也要改相应的寄存器。
#include &#34;sys.h&#34; /******************************************************************************/ #define TCS34725_ADDRESS (0x29) #define TCS34725_COMMAND_BIT (0x80) #define TCS34725_ENABLE (0x00) #define TCS34725_ENABLE_AIEN (0x10) /* RGBC Interrupt Enable */ #define TCS34725_ENABLE_WEN (0x08) /* Wait enable - Writing 1 activates the wait timer */ #define TCS34725_ENABLE_AEN (0x02) /* RGBC Enable - Writing 1 actives the ADC, 0 disables it */ #define TCS34725_ENABLE_PON (0x01) /* Power on - Writing 1 activates the internal oscillator, 0 disables it */ #define TCS34725_ATIME (0x01) /* Integration time */ #define TCS34725_WTIME (0x03) /* Wait time (if TCS34725_ENABLE_WEN is asserted) */ #define TCS34725_WTIME_2_4MS (0xFF) /* WLONG0 = 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/675f632de6a15e82c282854f8beff1ae/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-07-05T21:23:57+08:00" />
<meta property="article:modified_time" content="2021-07-05T21:23:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">基于STM32的颜色传感器TCS3472</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_7" rel="nofollow">前言</a></li><li><a href="#TCS3472_15" rel="nofollow">一、TCS3472是什么？</a></li><li><a href="#RGB__22" rel="nofollow">二、RGB 颜色传感器分析</a></li><li><a href="#TCS3472_25" rel="nofollow">三、驱动TCS3472</a></li><li><ul><li><a href="#31RGB_493" rel="nofollow">3.1读取R,G,B</a></li></ul> 
  </li><li><a href="#TCS3472_582" rel="nofollow">四、测试TCS3472</a></li><li><ul><li><a href="#41_585" rel="nofollow">4.1参数测试</a></li></ul> 
  </li><li><a href="#_594" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<p><img src="https://images2.imgbox.com/1c/ed/mUoq3gry_o.jpg" alt="在这里插入图片描述"></p> 
<hr color="#000000" size='1"'> 
<h2><a id="_7"></a>前言</h2> 
<p>最近由于课程设计要求，用到了一款颜色传感器芯片TCS3472，可以读取物体表面三种RGB三种颜色分量。<br> <strong>环境 keil5 uvison<br> 单片机：STM32ZET6，颜色传感器TCS3472<br> 标准库驱动</strong><br> <strong>串口或者WIFI读取</strong><br> <img src="https://images2.imgbox.com/f1/3a/1CrCTJSc_o.gif" alt="在这里插入图片描述"></p> 
<h2><a id="TCS3472_15"></a>一、TCS3472是什么？</h2> 
<p>TCS3472 光电转换器包含一个 3×4 光电二极管阵列、<strong>四个集成光电二极管电流 的模数转换器(ADC)</strong>、数据寄存器、一个状态机和一个 I²C 接口。<br> <strong>3×4 光电二极 管阵列由红光、绿光、蓝光和清晰(未滤光)光电二极管组成</strong>。此外，光电二极管 还涂有红外阻挡滤光片。<br> 四个积分 ADC 同时将放大的光电二极管电流转换为 16 位数字值。转换周期完成后，结果被传输到数据寄存器，数据寄存器采用双缓冲 方式，以确保数据的完整性。所有内部时序以及低功率等待状态都由状态机控制。<br> TCS3472 数据通信通过高达 400 kHz 的双线 I²C 快速串行总线完成。行业标准 I²C 总线方便了与微控制器和嵌入式处理器的轻松直接连接。除 I²C 总线外，TCS3472 还提供单独的中断信号输出。当中断使能且超过用户定义的阈值时，有效-低电 平中断将被置位，并保持置位状态，直到控制器将其清零。此中断功能无需轮询 TCS3472，从而简化并提高了系统软件的效率。用户可以定义中断阈值的上限和 下限，并应用中断持续过滤器。中断持续过滤器允许用户定义在生成中断之前所 需的连续超出阈值事件的数量。中断输出是开漏的，因此可以与其他器件进行布 线。</p> 
<h2><a id="RGB__22"></a>二、RGB 颜色传感器分析</h2> 
<p>颜色传感器用白光照射到物体，物体反射回来的光由红光、绿光、蓝光和清 晰(未滤光)光电二极管吸收，产生光电效应，并且产生光电流，四个积分 ADC 同时将放大的光电二极管电流转换为 16 位数字值。转换周期完成后，结果被传 输到数据寄存器，数据寄存器采用双缓冲方式，以确保数据的完整性。<br> <img src="https://images2.imgbox.com/67/22/LA3Ps7dx_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="TCS3472_25"></a>三、驱动TCS3472</h2> 
<p>TCS3472采用IIC驱动，STM32采用IO口模拟IIc驱动<br> TCS3472.c<br> 这个是用寄存器来写的，PB口，如果要改端口的话，也要改相应的寄存器。</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token comment">/******************************************************************************/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ADDRESS          (0x29)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_COMMAND_BIT      (0x80)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ENABLE           (0x00)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ENABLE_AIEN      (0x10)    </span><span class="token comment">/* RGBC Interrupt Enable */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ENABLE_WEN       (0x08)    </span><span class="token comment">/* Wait enable - Writing 1 activates the wait timer */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ENABLE_AEN       (0x02)    </span><span class="token comment">/* RGBC Enable - Writing 1 actives the ADC, 0 disables it */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ENABLE_PON       (0x01)    </span><span class="token comment">/* Power on - Writing 1 activates the internal oscillator, 0 disables it */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ATIME            (0x01)    </span><span class="token comment">/* Integration time */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_WTIME            (0x03)    </span><span class="token comment">/* Wait time (if TCS34725_ENABLE_WEN is asserted) */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_WTIME_2_4MS      (0xFF)    </span><span class="token comment">/* WLONG0 = 2.4ms   WLONG1 = 0.029s */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_WTIME_204MS      (0xAB)    </span><span class="token comment">/* WLONG0 = 204ms   WLONG1 = 2.45s  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_WTIME_614MS      (0x00)    </span><span class="token comment">/* WLONG0 = 614ms   WLONG1 = 7.4s   */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_AILTL            (0x04)    </span><span class="token comment">/* Clear channel lower interrupt threshold */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_AILTH            (0x05)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_AIHTL            (0x06)    </span><span class="token comment">/* Clear channel upper interrupt threshold */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_AIHTH            (0x07)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS             (0x0C)    </span><span class="token comment">/* Persistence register - basic SW filtering mechanism for interrupts */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_NONE        (0b0000)  </span><span class="token comment">/* Every RGBC cycle generates an interrupt                                */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_1_CYCLE     (0b0001)  </span><span class="token comment">/* 1 clean channel value outside threshold range generates an interrupt   */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_2_CYCLE     (0b0010)  </span><span class="token comment">/* 2 clean channel values outside threshold range generates an interrupt  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_3_CYCLE     (0b0011)  </span><span class="token comment">/* 3 clean channel values outside threshold range generates an interrupt  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_5_CYCLE     (0b0100)  </span><span class="token comment">/* 5 clean channel values outside threshold range generates an interrupt  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_10_CYCLE    (0b0101)  </span><span class="token comment">/* 10 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_15_CYCLE    (0b0110)  </span><span class="token comment">/* 15 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_20_CYCLE    (0b0111)  </span><span class="token comment">/* 20 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_25_CYCLE    (0b1000)  </span><span class="token comment">/* 25 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_30_CYCLE    (0b1001)  </span><span class="token comment">/* 30 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_35_CYCLE    (0b1010)  </span><span class="token comment">/* 35 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_40_CYCLE    (0b1011)  </span><span class="token comment">/* 40 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_45_CYCLE    (0b1100)  </span><span class="token comment">/* 45 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_50_CYCLE    (0b1101)  </span><span class="token comment">/* 50 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_55_CYCLE    (0b1110)  </span><span class="token comment">/* 55 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_PERS_60_CYCLE    (0b1111)  </span><span class="token comment">/* 60 clean channel values outside threshold range generates an interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_CONFIG           (0x0D)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_CONFIG_WLONG     (0x02)    </span><span class="token comment">/* Choose between short and long (12x) wait times via TCS34725_WTIME */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_CONTROL          (0x0F)    </span><span class="token comment">/* Set the gain level for the sensor */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_ID               (0x12)    </span><span class="token comment">/* 0x44 = TCS34721/TCS34725, 0x4D = TCS34723/TCS34727 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_STATUS           (0x13)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_STATUS_AINT      (0x10)    </span><span class="token comment">/* RGBC Clean channel interrupt */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_STATUS_AVALID    (0x01)    </span><span class="token comment">/* Indicates that the RGBC channels have completed an integration cycle */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_CDATAL           (0x14)    </span><span class="token comment">/* Clear channel data */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_CDATAH           (0x15)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_RDATAL           (0x16)    </span><span class="token comment">/* Red channel data */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_RDATAH           (0x17)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_GDATAL           (0x18)    </span><span class="token comment">/* Green channel data */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_GDATAH           (0x19)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_BDATAL           (0x1A)    </span><span class="token comment">/* Blue channel data */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_BDATAH           (0x1B)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_2_4MS   0xFF   </span><span class="token comment">/**&lt;  2.4ms - 1 cycle    - Max Count: 1024  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_24MS    0xF6   </span><span class="token comment">/**&lt;  24ms  - 10 cycles  - Max Count: 10240 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_50MS    0xEB   </span><span class="token comment">/**&lt;  50ms  - 20 cycles  - Max Count: 20480 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_101MS   0xD5   </span><span class="token comment">/**&lt;  101ms - 42 cycles  - Max Count: 43008 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_154MS   0xC0   </span><span class="token comment">/**&lt;  154ms - 64 cycles  - Max Count: 65535 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_240MS   0x9C   </span><span class="token comment">/**&lt;  240ms - 100 cycles - Max Count: 65535 */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_INTEGRATIONTIME_700MS   0x00   </span><span class="token comment">/**&lt;  700ms - 256 cycles - Max Count: 65535 */</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_GAIN_1X                 0x00   </span><span class="token comment">/**&lt;  No gain  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_GAIN_4X                 0x01   </span><span class="token comment">/**&lt;  4x gain  */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_GAIN_16X                0x02   </span><span class="token comment">/**&lt;  16x gain */</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS34725_GAIN_60X                0x03   </span><span class="token comment">/**&lt;  60x gain */</span>
<span class="token comment">/******************************************************************************/</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">delay_s</span><span class="token punctuation">(</span>u32 i<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SDA_IN()  {GPIOB-&gt;CRH&amp;=0xFFFF0FFF;GPIOB-&gt;CRH|=8&lt;&lt;12;}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SDA_OUT() {GPIOB-&gt;CRH&amp;=0xFFFF0FFF;GPIOB-&gt;CRH|=3&lt;&lt;12;}</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SDA_READ   GPIOB-&gt;IDR&amp;(1&lt;&lt;11)</span>

<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SCL_H     GPIO_SetBits(GPIOB,GPIO_Pin_10)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SCL_L     GPIO_ResetBits(GPIOB,GPIO_Pin_10)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SDA_H     GPIO_SetBits(GPIOB,GPIO_Pin_11)</span>
<span class="token macro property">#<span class="token directive keyword">define</span> TCS_SDA_L     GPIO_ResetBits(GPIOB,GPIO_Pin_11)</span>
<span class="token comment">/******************************************************************************/</span>
<span class="token macro property">#<span class="token directive keyword">define</span> max3v(v1, v2, v3)   ((v1)&lt;(v2)? ((v2)&lt;(v3)?(v3):(v2)):((v1)&lt;(v3)?(v3):(v1)))</span>
<span class="token macro property">#<span class="token directive keyword">define</span> min3v(v1, v2, v3)   ((v1)&gt;(v2)? ((v2)&gt;(v3)?(v3):(v2)):((v1)&gt;(v3)?(v3):(v1)))</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>  c<span class="token punctuation">;</span>      <span class="token comment">//[0-65536]</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>  r<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>  g<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span>  b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>COLOR_RGBC<span class="token punctuation">;</span><span class="token comment">//RGBC</span>

<span class="token keyword">typedef</span> <span class="token keyword">struct</span><span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">short</span> h<span class="token punctuation">;</span>       <span class="token comment">//[0,360]</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>  s<span class="token punctuation">;</span>       <span class="token comment">//[0,100]</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">char</span>  l<span class="token punctuation">;</span>       <span class="token comment">//[0,100]</span>
<span class="token punctuation">}</span>COLOR_HSL<span class="token punctuation">;</span><span class="token comment">//HSL</span>

COLOR_RGBC rgb<span class="token punctuation">;</span>
COLOR_HSL  hsl<span class="token punctuation">;</span>
<span class="token comment">/******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_10<span class="token operator">|</span>GPIO_Pin_11<span class="token punctuation">;</span><span class="token comment">//PB10/PB10=外接I2C</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span><span class="token comment">//通用推挽输出	</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_50MHz<span class="token punctuation">;</span><span class="token comment">//速度</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//对选中管脚初始化</span>
	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOB<span class="token punctuation">,</span>GPIO_Pin_10<span class="token operator">|</span>GPIO_Pin_11<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//高电平</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">TCS_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	TCS_SDA_H<span class="token punctuation">;</span>
	TCS_SCL_H<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(4);</span>
	TCS_SDA_L<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(4);</span>
	TCS_SCL_L<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">TCS_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	TCS_SCL_L<span class="token punctuation">;</span>
	TCS_SDA_L<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(4);</span>
	TCS_SCL_H<span class="token punctuation">;</span>
	TCS_SDA_H<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">40</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(4);							   	</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token comment">//返回值：1，接收应答失败</span>
<span class="token comment">//        0，接收应答成功</span>
u8 <span class="token function">TCS34725_I2C_Wait_ACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u32 t<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TCS_SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SDA设置为输入  </span>
	TCS_SDA_H<span class="token punctuation">;</span> 
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(1);</span>
	TCS_SCL_H<span class="token punctuation">;</span> 
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(1);</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>TCS_SDA_READ<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		t<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>t <span class="token operator">&gt;</span> <span class="token number">250</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">TCS34725_I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	TCS_SCL_L<span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token comment">//产生ACK应答</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_ACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TCS_SCL_L<span class="token punctuation">;</span>
	<span class="token function">TCS_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	TCS_SDA_L<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
	TCS_SCL_H<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
	TCS_SCL_L<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token comment">//不产生ACK应答		    </span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_NACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	TCS_SCL_L<span class="token punctuation">;</span>
	<span class="token function">TCS_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	TCS_SDA_H<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
	TCS_SCL_H<span class="token punctuation">;</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
	TCS_SCL_L<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token comment">//I2C发送一个字节		  </span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_Send_Byte</span><span class="token punctuation">(</span>u8 byte<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 i<span class="token punctuation">;</span>
	
	<span class="token function">TCS_SDA_OUT</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//sda线输出</span>
	TCS_SCL_L<span class="token punctuation">;</span><span class="token comment">//拉低时钟开始数据传输</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>byte<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>TCS_SDA_H<span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			TCS_SDA_L<span class="token punctuation">;</span>
		byte <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		
		<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
		TCS_SCL_H<span class="token punctuation">;</span>
		<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
		TCS_SCL_L<span class="token punctuation">;</span>
		<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token comment">//读1个字节，ack=1时，发送ACK，ack=0，发送nACK   </span>
u8 <span class="token function">TCS34725_I2C_Read_Byte</span><span class="token punctuation">(</span>u8 ack<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 i<span class="token punctuation">,</span>receive <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TCS_SDA_IN</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		TCS_SCL_L<span class="token punctuation">;</span>
		<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(2);</span>
		TCS_SCL_H<span class="token punctuation">;</span>
		receive <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>TCS_SDA_READ<span class="token punctuation">)</span> receive<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//delay_us(1);</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span> <span class="token function">TCS34725_I2C_NACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送nACK</span>
	<span class="token keyword">else</span> <span class="token function">TCS34725_I2C_ACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//发送ACK </span>
	
	<span class="token keyword">return</span> receive<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*********************************************/</span>
<span class="token comment">/*******************************************************************************
 * @brief Writes data to a slave device.
 *
 * @param slaveAddress - Adress of the slave device.
 * @param dataBuffer - Pointer to a buffer storing the transmission data.
 * @param bytesNumber - Number of bytes to write.
 * @param stopBit - Stop condition control.
 *                  Example: 0 - A stop condition will not be sent;
 *                           1 - A stop condition will be sent.
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_Write</span><span class="token punctuation">(</span>u8 slaveAddress<span class="token punctuation">,</span> u8<span class="token operator">*</span> dataBuffer<span class="token punctuation">,</span>u8 bytesNumber<span class="token punctuation">,</span> u8 stopBit<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TCS34725_I2C_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>slaveAddress <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">//发送从机地址写命令</span>
	<span class="token function">TCS34725_I2C_Wait_ACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bytesNumber<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token function">TCS34725_I2C_Send_Byte</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>dataBuffer <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">TCS34725_I2C_Wait_ACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>stopBit <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">TCS34725_I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief Reads data from a slave device.
 *
 * @param slaveAddress - Adress of the slave device.
 * @param dataBuffer - Pointer to a buffer that will store the received data.
 * @param bytesNumber - Number of bytes to read.
 * @param stopBit - Stop condition control.
 *                  Example: 0 - A stop condition will not be sent;
 *                           1 - A stop condition will be sent.
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_I2C_Read</span><span class="token punctuation">(</span>u8 slaveAddress<span class="token punctuation">,</span> u8<span class="token operator">*</span> dataBuffer<span class="token punctuation">,</span> u8 bytesNumber<span class="token punctuation">,</span> u8 stopBit<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_I2C_Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TCS34725_I2C_Send_Byte</span><span class="token punctuation">(</span><span class="token punctuation">(</span>slaveAddress <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	   <span class="token comment">//发送从机地址读命令</span>
	<span class="token function">TCS34725_I2C_Wait_ACK</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> bytesNumber<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">==</span> bytesNumber <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span><span class="token punctuation">(</span>dataBuffer <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">TCS34725_I2C_Read_Byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读取的最后一个字节发送NACK</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token operator">*</span><span class="token punctuation">(</span>dataBuffer <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">TCS34725_I2C_Read_Byte</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>stopBit <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">TCS34725_I2C_Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief Writes data into TCS34725 registers, starting from the selected
 *        register address pointer.
 *
 * @param subAddr - The selected register address pointer.
 * @param dataBuffer - Pointer to a buffer storing the transmission data.
 * @param bytesNumber - Number of bytes that will be sent.
 *
 * @return None.
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_Write</span><span class="token punctuation">(</span>u8 subAddr<span class="token punctuation">,</span> u8<span class="token operator">*</span> dataBuffer<span class="token punctuation">,</span> u8 bytesNumber<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    u8 sendBuffer<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    u8 byte <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    
    sendBuffer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> subAddr <span class="token operator">|</span> TCS34725_COMMAND_BIT<span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>byte <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> byte <span class="token operator">&lt;=</span> bytesNumber<span class="token punctuation">;</span> byte<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        sendBuffer<span class="token punctuation">[</span>byte<span class="token punctuation">]</span> <span class="token operator">=</span> dataBuffer<span class="token punctuation">[</span>byte <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token function">TCS34725_I2C_Write</span><span class="token punctuation">(</span>TCS34725_ADDRESS<span class="token punctuation">,</span> sendBuffer<span class="token punctuation">,</span> bytesNumber <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief Reads data from TCS34725 registers, starting from the selected
 *        register address pointer.
 *
 * @param subAddr - The selected register address pointer.
 * @param dataBuffer - Pointer to a buffer that will store the received data.
 * @param bytesNumber - Number of bytes that will be read.
 *
 * @return None.
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_Read</span><span class="token punctuation">(</span>u8 subAddr<span class="token punctuation">,</span> u8<span class="token operator">*</span> dataBuffer<span class="token punctuation">,</span> u8 bytesNumber<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	subAddr <span class="token operator">|</span><span class="token operator">=</span> TCS34725_COMMAND_BIT<span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_I2C_Write</span><span class="token punctuation">(</span>TCS34725_ADDRESS<span class="token punctuation">,</span> <span class="token punctuation">(</span>u8<span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>subAddr<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TCS34725_I2C_Read</span><span class="token punctuation">(</span>TCS34725_ADDRESS<span class="token punctuation">,</span> dataBuffer<span class="token punctuation">,</span> bytesNumber<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725设置积分时间
 *
 * @return None
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_SetIntegrationTime</span><span class="token punctuation">(</span>u8 time<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">TCS34725_Write</span><span class="token punctuation">(</span>TCS34725_ATIME<span class="token punctuation">,</span> <span class="token operator">&amp;</span>time<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725设置增益
 *
 * @return None
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_SetGain</span><span class="token punctuation">(</span>u8 gain<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">TCS34725_Write</span><span class="token punctuation">(</span>TCS34725_CONTROL<span class="token punctuation">,</span> <span class="token operator">&amp;</span>gain<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725使能
 *
 * @return None
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_Enable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 cmd <span class="token operator">=</span> TCS34725_ENABLE_PON<span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_Write</span><span class="token punctuation">(</span>TCS34725_ENABLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cmd <span class="token operator">=</span> TCS34725_ENABLE_PON <span class="token operator">|</span> TCS34725_ENABLE_AEN<span class="token punctuation">;</span>
	<span class="token function">TCS34725_Write</span><span class="token punctuation">(</span>TCS34725_ENABLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">//delay_s(600000);//delay_ms(3);//延时应该放在设置AEN之后</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725失能
 *
 * @return None
*******************************************************************************/</span>
<span class="token keyword">void</span> <span class="token function">TCS34725_Disable</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 cmd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_Read</span><span class="token punctuation">(</span>TCS34725_ENABLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	cmd <span class="token operator">=</span> cmd <span class="token operator">&amp;</span> <span class="token operator">~</span><span class="token punctuation">(</span>TCS34725_ENABLE_PON <span class="token operator">|</span> TCS34725_ENABLE_AEN<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TCS34725_Write</span><span class="token punctuation">(</span>TCS34725_ENABLE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>cmd<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725初始化
 *
 * @return ID - ID寄存器中的值
*******************************************************************************/</span>
u8 <span class="token function">TCS34725_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_I2C_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token function">TCS34725_Read</span><span class="token punctuation">(</span>TCS34725_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>id<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//TCS34725 的 ID 是 0x44 可以根据这个来判断是否成功连接,0x4D是TCS34727;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>id<span class="token operator">==</span><span class="token number">0x4D</span> <span class="token operator">|</span> id<span class="token operator">==</span><span class="token number">0x44</span><span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token function">TCS34725_SetIntegrationTime</span><span class="token punctuation">(</span>TCS34725_INTEGRATIONTIME_50MS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">TCS34725_SetGain</span><span class="token punctuation">(</span>TCS34725_GAIN_1X<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">TCS34725_Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725获取单个通道数据
 *
 * @return data - 该通道的转换值
*******************************************************************************/</span>
u16 <span class="token function">TCS34725_GetChannelData</span><span class="token punctuation">(</span>u8 reg<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 tmp<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
	u16 data<span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_Read</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	data <span class="token operator">=</span> <span class="token punctuation">(</span>tmp<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> tmp<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token keyword">return</span> data<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/*******************************************************************************
 * @brief TCS34725获取各个通道数据
 *
 * @return 1 - 转换完成，数据可用
 *   	   0 - 转换未完成，数据不可用
*******************************************************************************/</span>
u8 <span class="token function">TCS34725_GetRawData</span><span class="token punctuation">(</span>COLOR_RGBC <span class="token operator">*</span>rgbc<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 status <span class="token operator">=</span> TCS34725_STATUS_AVALID<span class="token punctuation">;</span>
	
	<span class="token function">TCS34725_Read</span><span class="token punctuation">(</span>TCS34725_STATUS<span class="token punctuation">,</span> <span class="token operator">&amp;</span>status<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>status <span class="token operator">&amp;</span> TCS34725_STATUS_AVALID<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		rgbc<span class="token operator">-&gt;</span>c <span class="token operator">=</span> <span class="token function">TCS34725_GetChannelData</span><span class="token punctuation">(</span>TCS34725_CDATAL<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		rgbc<span class="token operator">-&gt;</span>r <span class="token operator">=</span> <span class="token function">TCS34725_GetChannelData</span><span class="token punctuation">(</span>TCS34725_RDATAL<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		rgbc<span class="token operator">-&gt;</span>g <span class="token operator">=</span> <span class="token function">TCS34725_GetChannelData</span><span class="token punctuation">(</span>TCS34725_GDATAL<span class="token punctuation">)</span><span class="token punctuation">;</span>	
		rgbc<span class="token operator">-&gt;</span>b <span class="token operator">=</span> <span class="token function">TCS34725_GetChannelData</span><span class="token punctuation">(</span>TCS34725_BDATAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/******************************************************************************/</span>
<span class="token comment">//RGB转HSL</span>
<span class="token keyword">void</span> <span class="token function">RGBtoHSL</span><span class="token punctuation">(</span>COLOR_RGBC <span class="token operator">*</span>Rgb<span class="token punctuation">,</span> COLOR_HSL <span class="token operator">*</span>Hsl<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	u8 maxVal<span class="token punctuation">,</span>minVal<span class="token punctuation">,</span>difVal<span class="token punctuation">;</span>
	u8 r <span class="token operator">=</span> Rgb<span class="token operator">-&gt;</span>r<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>Rgb<span class="token operator">-&gt;</span>c<span class="token punctuation">;</span>   <span class="token comment">//[0-100]</span>
	u8 g <span class="token operator">=</span> Rgb<span class="token operator">-&gt;</span>g<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>Rgb<span class="token operator">-&gt;</span>c<span class="token punctuation">;</span>
	u8 b <span class="token operator">=</span> Rgb<span class="token operator">-&gt;</span>b<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span>Rgb<span class="token operator">-&gt;</span>c<span class="token punctuation">;</span>
	
	maxVal <span class="token operator">=</span> <span class="token function">max3v</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>g<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	minVal <span class="token operator">=</span> <span class="token function">min3v</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span>g<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
	difVal <span class="token operator">=</span> maxVal<span class="token operator">-</span>minVal<span class="token punctuation">;</span>
	
	<span class="token comment">//计算亮度</span>
	Hsl<span class="token operator">-&gt;</span>l <span class="token operator">=</span> <span class="token punctuation">(</span>maxVal<span class="token operator">+</span>minVal<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">;</span>   <span class="token comment">//[0-100]</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>maxVal <span class="token operator">==</span> minVal<span class="token punctuation">)</span><span class="token comment">//若r=g=b,灰度</span>
	<span class="token punctuation">{<!-- --></span>
		Hsl<span class="token operator">-&gt;</span>h <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> 
		Hsl<span class="token operator">-&gt;</span>s <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token comment">//计算色调</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>maxVal<span class="token operator">==</span>r<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>g<span class="token operator">&gt;=</span>b<span class="token punctuation">)</span>
				Hsl<span class="token operator">-&gt;</span>h <span class="token operator">=</span> <span class="token number">60</span><span class="token operator">*</span><span class="token punctuation">(</span>g<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token operator">/</span>difVal<span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				Hsl<span class="token operator">-&gt;</span>h <span class="token operator">=</span> <span class="token number">60</span><span class="token operator">*</span><span class="token punctuation">(</span>g<span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token operator">/</span>difVal<span class="token operator">+</span><span class="token number">360</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
			<span class="token punctuation">{<!-- --></span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>maxVal<span class="token operator">==</span>g<span class="token punctuation">)</span>Hsl<span class="token operator">-&gt;</span>h <span class="token operator">=</span> <span class="token number">60</span><span class="token operator">*</span><span class="token punctuation">(</span>b<span class="token operator">-</span>r<span class="token punctuation">)</span><span class="token operator">/</span>difVal<span class="token operator">+</span><span class="token number">120</span><span class="token punctuation">;</span>
				<span class="token keyword">else</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>maxVal<span class="token operator">==</span>b<span class="token punctuation">)</span>Hsl<span class="token operator">-&gt;</span>h <span class="token operator">=</span> <span class="token number">60</span><span class="token operator">*</span><span class="token punctuation">(</span>r<span class="token operator">-</span>g<span class="token punctuation">)</span><span class="token operator">/</span>difVal<span class="token operator">+</span><span class="token number">240</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		
		<span class="token comment">//计算饱和度</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>Hsl<span class="token operator">-&gt;</span>l<span class="token operator">&lt;=</span><span class="token number">50</span><span class="token punctuation">)</span>Hsl<span class="token operator">-&gt;</span>s<span class="token operator">=</span>difVal<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token punctuation">(</span>maxVal<span class="token operator">+</span>minVal<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//[0-100]</span>
		<span class="token keyword">else</span>
			Hsl<span class="token operator">-&gt;</span>s<span class="token operator">=</span>difVal<span class="token operator">*</span><span class="token number">100</span><span class="token operator">/</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token operator">-</span><span class="token punctuation">(</span>maxVal<span class="token operator">+</span>minVal<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/******************************************************************************/</span>


</code></pre> 
<h3><a id="31RGB_493"></a>3.1读取R,G,B</h3> 
<p>只要把驱动代码写好，在主函数里面调用就可以了，这里开一个1ms的定时器<br> <img src="https://images2.imgbox.com/7f/02/5fvkkSVs_o.png" alt="在这里插入图片描述"><br> main.c文件</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"led.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"delay.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"key.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"sys.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usart.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"math.h"</span> </span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdio.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"string.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"stdlib.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"tcs34725.c"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"timer.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"esp8266.h"</span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">"usart3.h"</span></span>
<span class="token comment">/************************************************
 ALIENTEK精英STM32开发板实验4
 串口 实验   
 技术支持：www.openedv.com
 淘宝店铺：http://eboard.taobao.com 
 关注微信公众平台微信号："正点原子"，免费获取STM32资料。
 广州市星翼电子科技有限公司  
 作者：正点原子 @ALIENTEK
************************************************/</span>
<span class="token comment">/**************************************************/</span>

<span class="token macro property">#<span class="token directive keyword">define</span> LED_blink      GPIOA-&gt;ODR^=(1&lt;&lt;5)</span>
<span class="token comment">/**************************************************/</span>
<span class="token keyword">void</span> <span class="token function">delay_s</span><span class="token punctuation">(</span>u32 i<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">GPIO_Config</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
  GPIO_InitTypeDef GPIO_InitStructure<span class="token punctuation">;</span>
	<span class="token function">RCC_APB2PeriphClockCmd</span><span class="token punctuation">(</span>RCC_APB2Periph_GPIOA<span class="token operator">|</span>RCC_APB2Periph_GPIOB<span class="token operator">|</span>RCC_APB2Periph_GPIOC<span class="token operator">|</span>RCC_APB2Periph_AFIO<span class="token punctuation">,</span> ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//使能GPIOA,GPIOB,GPIOC,AFIO;</span>
	<span class="token function">GPIO_PinRemapConfig</span><span class="token punctuation">(</span>GPIO_Remap_SWJ_JTAGDisable<span class="token punctuation">,</span>ENABLE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Pin <span class="token operator">=</span> GPIO_Pin_5<span class="token punctuation">;</span>        <span class="token comment">//是LED</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Mode <span class="token operator">=</span> GPIO_Mode_Out_PP<span class="token punctuation">;</span> <span class="token comment">//复用推挽输出	</span>
	GPIO_InitStructure<span class="token punctuation">.</span>GPIO_Speed <span class="token operator">=</span> GPIO_Speed_10MHz<span class="token punctuation">;</span><span class="token comment">//速度</span>
	<span class="token function">GPIO_Init</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span> <span class="token operator">&amp;</span>GPIO_InitStructure<span class="token punctuation">)</span><span class="token punctuation">;</span>           <span class="token comment">//对选中管脚初始化</span>
	<span class="token function">GPIO_SetBits</span><span class="token punctuation">(</span>GPIOA<span class="token punctuation">,</span>GPIO_Pin_5<span class="token punctuation">)</span><span class="token punctuation">;</span>                  <span class="token comment">//上电点亮LED</span>
<span class="token punctuation">}</span>

 <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
  
	<span class="token function">delay_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	    	 <span class="token comment">//延时函数初始化	  </span>
	<span class="token function">NVIC_PriorityGroupConfig</span><span class="token punctuation">(</span>NVIC_PriorityGroup_2<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置NVIC中断分组2:2位抢占优先级，2位响应优先级</span>
  <span class="token function">GPIO_Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 <span class="token comment">//串口初始化为115200</span>
  <span class="token function">usart3_init</span><span class="token punctuation">(</span><span class="token number">115200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	 				<span class="token comment">//串口初始化为115200</span>
 	<span class="token function">LED_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>			     <span class="token comment">//LED端口初始化</span>
	<span class="token function">KEY_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token comment">//初始化与按键连接的硬件接口</span>
	<span class="token function">delay_s</span><span class="token punctuation">(</span><span class="token number">0x1fffff</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">TCS34725_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">TIM3_Int_Init</span><span class="token punctuation">(</span><span class="token number">999</span><span class="token punctuation">,</span><span class="token number">71</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//1ms定时</span>
  <span class="token comment">//esp8266_start_trans();							//esp8266进行初始化</span>
	<span class="token comment">//esp8266_send_data("20",50);</span>
	<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"Initial OK!\r\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>time1_cntr<span class="token operator">&gt;=</span><span class="token number">200</span><span class="token punctuation">)</span>  <span class="token comment">//0.2s</span>
			<span class="token punctuation">{<!-- --></span>
				time1_cntr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
				LED_blink<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>time2_cntr<span class="token operator">&gt;=</span><span class="token number">1000</span><span class="token punctuation">)</span>  <span class="token comment">//1s</span>
			<span class="token punctuation">{<!-- --></span>
				time2_cntr<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
				<span class="token function">TCS34725_GetRawData</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rgb<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//读两次，实际测试时发现读到的颜色总是上一次的颜色</span>
				<span class="token function">RGBtoHSL</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rgb<span class="token punctuation">,</span><span class="token operator">&amp;</span>hsl<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"R=%d G=%d B=%d C=%d\r\n"</span><span class="token punctuation">,</span>rgb<span class="token punctuation">.</span>r<span class="token punctuation">,</span>rgb<span class="token punctuation">.</span>g<span class="token punctuation">,</span>rgb<span class="token punctuation">.</span>b<span class="token punctuation">,</span>rgb<span class="token punctuation">.</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//u3_printf("R=%d G=%d B=%d C=%d\r\n",rgb.r,rgb.g,rgb.b,rgb.c);	//发送命令</span>
				<span class="token comment">//printf("H=%d S=%d L=%d\r\n",hsl.h,hsl.s,hsl.l);</span>
			<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


</code></pre> 
<h2><a id="TCS3472_582"></a>四、测试TCS3472</h2> 
<p>我们随便测试一下便知<br> <img src="https://images2.imgbox.com/1d/d0/OOt9Wyu4_o.gif" alt="在这里插入图片描述"></p> 
<h3><a id="41_585"></a>4.1参数测试</h3> 
<p><img src="https://images2.imgbox.com/84/d7/D5fdYp6s_o.gif" alt="在这里插入图片描述"><br> 这里可能看的不是很清楚，测的是我的手机壳，测得的数据是R=56,G=154,B=117<br> 打开word看一下，是非常吻合的<br> <img src="https://images2.imgbox.com/ff/5e/tDRzJVsa_o.png" alt="在这里插入图片描述"><br> 数据手册里面积分时间也可以设置</p> 
<p><img src="https://images2.imgbox.com/df/9e/5gogMMhW_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_594"></a>总结</h2> 
<p><strong>可能会出现的问题</strong></p> 
<ol><li> <p>STM32 和 Arduino 例程串口输出没有数据或者数据输出乱码？<br> 答： 确认波特率是否设置为 115200，对于 STM32 例程请确认电脑正确连接开发<br> 板 USART1（PA9,PA10），PA9 为 TXD，并且选择正确的 COM 端口。控制面板-&gt;<br> 硬件-&gt;设 备管理器。</p> </li><li> <p>STM32 和 Arduino 例程串口输出 RGB 数据全部为 0 或者初始化失败？<br> 答：请确认器件连接没有问题，如果没问题请按下复位按键。并且确认是否改了端口。如果改了，检查是否修改完全。</p> </li><li> <p>输出的 RGB 数据全为 253 并且中断引脚产生中断等等<br> 答：这种情况是光强超出检查范围，减小增益可以完美解决</p> </li><li> <p>修改积分时间后导致颜色不正常？<br> 答：因为积分时间决定了 RGBC 通道数据最大值，修改积分时间会导致颜色偏<br> 暗或者偏白。只需要增加或减少 LED 亮度即可。</p> </li><li> <p>修改积分时间无法触发中断或者一直重复中断？<br> 答： 中断是和 Clear 通道里面的数据进行比较，Clear 通道里面的数据和积分<br> 时间有关系，经过实际测量在增益为 60 倍情况下积分时间通道最大值<br> <img src="https://images2.imgbox.com/79/d3/KtQDW5jS_o.png" alt="在这里插入图片描述"><br> 所以用户如果需要速度比较快的采集数据时，要注意重新设置中断数值。另外<br> 在积分时间 为 2.4ms 时 RGB 数据比较低所以转换出来的颜色与实际颜色有<br> 偏差，需要加大 LED 灯亮度即可。<br> <img src="https://images2.imgbox.com/00/19/AXXhgLfW_o.png" alt="在这里插入图片描述"></p> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/eea918ef737b152b7fe25a16834c89a9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Java #垃圾回收相关算法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/3d17fedb23fa55bc18f6c227cc3be737/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">ubuntu 系统狠慢 或者很卡的原因</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>