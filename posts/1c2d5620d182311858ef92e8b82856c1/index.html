<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S的安全机制 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S的安全机制" />
<meta property="og:description" content="引言 Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。API Server 是集群内部各个组件通信的中介， 也是外部控制的入口。所以 Kubernetes 的安全机制基本就是围绕保护 API Server 来设计的。
比如 kubectl 如果想向 API Server 请求资源，需要过三关，第一关是认证（Authentication），第二关是鉴权（Authorization）， 第三关是准入控制（Admission Control），只有通过这三关才可能会被 K8S 创建资源。
一、K8S安全框架介绍 访问K8S集群的资源需要过三关：认证、鉴权、准入控制 普通用户若要安全访问集群API Server，往往需要证书、 Token或者用户名&#43;密码；Pod访问，需要ServiceAccount K8S安全控制框架主要由下面3个阶段进行控制，每一个阶段 都支持插件方式，通过API Server配置来启用插件。 1. Authentication：用于识别用户身份, 方式有: SSL证书，token, 用户名&#43;密码等
2. Authorization：确认是否对资源具有相关的权限
3. Admission Control： 判断操作是否符合集群的要求
当kubectl ，ui，程序 等请求某个 k8s 接口，先认证（判断真伪），鉴权（是否有权限这么做？），
准入控制（能不能个这么干？）
二、认证（Authentication） 三种客户端身份认证：
HTTPS 证书认证：基于CA证书签名的数字证书认证 kube-apiserver etcd kubelet 连接kube-apiserver
kube-proxy连接 kube-apiserver
均采用 https传输方式
HTTP Token认证：通过一个Token来识别用户 客户端携带一个token来请求server端，如果server端含有这个token，那么认证成功否则失败
HTTP Base认证：用户名&#43;密码的方式认证 比较原始的方式，在k8s中基本很少使用
三、授权鉴权（Authorization） RBAC（Role-Based Access Control，基于角色的访问控制）：
负责完成授权（Authorization）工作。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1c2d5620d182311858ef92e8b82856c1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-31T17:15:20+08:00" />
<meta property="article:modified_time" content="2022-10-31T17:15:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S的安全机制</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h4>引言</h4> 
<p><br> Kubernetes 作为一个分布式集群的管理工具，保证集群的安全性是其一个重要的任务。API Server 是集群内部各个组件通信的中介， 也是外部控制的入口。所以 Kubernetes 的安全机制基本就是围绕保护 API Server 来设计的。<br> 比如 kubectl 如果想向 API Server 请求资源，需要过三关，第一关是认证（Authentication），第二关是鉴权（Authorization）， 第三关是准入控制（Admission Control），只有通过这三关才可能会被 K8S 创建资源。</p> 
<h2>一、K8S安全框架介绍</h2> 
<ul><li>访问K8S集群的资源需要过三关：认证、鉴权、准入控制 </li><li>普通用户若要安全访问集群API Server，往往需要证书、 Token或者用户名+密码；Pod访问，需要ServiceAccount </li><li>K8S安全控制框架主要由下面3个阶段进行控制，每一个阶段 都支持插件方式，通过API Server配置来启用插件。</li></ul> 
<p>     1. Authentication：用于识别用户身份, 方式有: SSL证书，token, 用户名+密码等</p> 
<p>      2. Authorization：确认是否对资源具有相关的权限</p> 
<p>      3. Admission Control： 判断操作是否符合集群的要求</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/01/69/2qQsyvqV_o.png"></p> 
<p>当kubectl ，ui，程序 等请求某个 k8s 接口，先认证（判断真伪），鉴权（是否有权限这么做？），</p> 
<p>准入控制（能不能个这么干？）</p> 
<p><img alt="" height="502" src="https://images2.imgbox.com/e3/fb/fuDjONp1_o.png" width="916"></p> 
<h2> 二、认证（Authentication）</h2> 
<p>三种客户端身份认证：</p> 
<ul><li>HTTPS 证书认证：基于CA证书签名的数字证书认证</li></ul> 
<p>      kube-apiserver      </p> 
<p>      etcd  </p> 
<p>      kubelet 连接kube-apiserver</p> 
<p>      kube-proxy连接 kube-apiserver</p> 
<p>      均采用 https传输方式</p> 
<ul><li>HTTP Token认证：通过一个Token来识别用户</li></ul> 
<p>客户端携带一个token来请求server端，如果server端含有这个token，那么认证成功否则失败</p> 
<ul><li>HTTP Base认证：用户名+密码的方式认证</li></ul> 
<p>比较原始的方式，在k8s中基本很少使用</p> 
<h2>三、授权鉴权（Authorization）</h2> 
<p>RBAC（Role-Based Access Control，基于角色的访问控制）：</p> 
<p>负责完成授权（Authorization）工作。</p> 
<p>根据API请求属性，决定允许还是拒绝。</p> 
<ul><li>user：用户名</li><li>group：用户分组</li><li>extra：用户额外信息</li><li>API • 请求路径：例如/api，/healthz • API请求方法：get，list，create，update，patch，watch，delete</li><li>HTTP请求方法：get，post，put，delete</li><li>资源</li><li>子资源 </li><li>命名空间</li><li>API组</li></ul> 
<h2>四、准入控制（Adminssion Control）</h2> 
<p>Adminssion Control实际上是一个准入控制器插件列表，发送到API Server的请求都需要经过这个列表中的每个准入控制器 插件的检查，检查不通过，则拒绝请求。</p> 
<h2>五、使用RBAC授权</h2> 
<p>RBAC（Role-Based Access Control，基于角色的访问控制），允许通过Kubernetes API动态配置策略。</p> 
<p>• 角色 </p> 
<ul><li>Role：授权特定命名空间的访问权限</li><li>ClusterRole：授权所有命名空间的访问权限</li></ul> 
<p>• 角色绑定</p> 
<ul><li>RoleBinding：将角色绑定到主体（即subject）</li><li>ClusterRoleBinding：将集群角色绑定到主体</li></ul> 
<p>• 主体（subject） </p> 
<ul><li>User：用户</li><li>Group：用户组</li><li>ServiceAccount：服务账号</li></ul> 
<p></p> 
<p>用户或者用户组，服务账号，与具备某些权限的角色绑定，然后将该角色的权限继承过来，这一点类似阿里云的 ram 授权。这里需要注意 定义的角色是 Role作用域只能在指定的名称空间下有效，如果是ClusterRole可作用于所有名称空间下。</p> 
<p>Rolebinding 和Role 对应，ClusterRoleBinding 和 ClusterRole 对应。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/0d/d4/bjPLZ07T_o.png"></p> 
<p></p> 
<h2>六、RABC示例 </h2> 
<p>示例：为benjamin用户授权default命名空间Pod读取权限</p> 
<p>1. 用K8S CA签发客户端证书</p> 
<p>2. 生成kubeconfig授权文件</p> 
<p>3. 创建RBAC权限策略</p> 
<h3>6.1 通过CA证书生成自签证书</h3> 
<p></p> 
<pre><code>mkdir  /root/benjamin

sh  cert.sh  

cat &gt; ca-config.json &lt;&lt;EOF
{
  "signing": {
    "default": {
      "expiry": "87600h"
    },
    "profiles": {
      "kubernetes": {
        "usages": [
            "signing",
            "key encipherment",
            "server auth",
            "client auth"
        ],
        "expiry": "87600h"
      }
    }
  }
}
EOF

cat &gt; benjamin-csr.json &lt;&lt;EOF
{
  "CN": "benjamin",
  "hosts": [],
  "key": {
    "algo": "rsa",
    "size": 2048
  },
  "names": [
    {
      "C": "CN",
      "ST": "BeiJing",
      "L": "BeiJing",
      "O": "k8s",
      "OU": "System"
    }
  ]
}
EOF

cfssl gencert -ca=/opt/kubernetes/ssl/ca.pem -ca-key=/opt/kubernetes/ssl/ca-key.pem -config=ca-config.json -profile=kubernetes benjamin-csr.json | cfssljson -bare benjami</code></pre> 
<p>通过指定的ca配置生成 benjamin-key.pem  benjamin.pem</p> 
<h3>6.2 生成kubeconfig授权文件</h3> 
<pre><code>cd /root/benjamin

sh config.sh

kubectl config set-cluster kubernetes \
  --certificate-authority=/opt/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=https://192.168.31.63:6443 \
  --kubeconfig=benjamin.kubeconfig
 
# 设置客户端认证
kubectl config set-credentials benjamin \
  --client-key=benjamin-key.pem \
  --client-certificate=benjamin.pem \
  --embed-certs=true \
  --kubeconfig=benjamin.kubeconfig

# 设置默认上下文
kubectl config set-context kubernetes \
  --cluster=kubernetes \
  --user=benjamin \
  --kubeconfig=benjamin.kubeconfig

# 设置当前使用配置
kubectl config use-context kubernetes --kubeconfig=benjamin.kubeconfig</code></pre> 
<p>执行 config.sh 生成benjamin.kubeconfig</p> 
<h2>6.3 创建RABC授权</h2> 
<pre><code>kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  namespace: default
  name: pod-reader
rules:
- apiGroups: [""]
  resources: ["pods"]
  verbs: ["get", "watch", "list"]

---

kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: read-pods
  namespace: default
subjects:
- kind: User
  name: benjamin 
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: Role
  name: pod-reader
  apiGroup: rbac.authorization.k8s.io</code></pre> 
<h3>6.4 验证</h3> 
<p>将master节点的kubectl 命令分发到node节点</p> 
<pre>scp /usr/bin/kubectl 192.168.161.12:/usr/bin/</pre> 
<p>如果不指定 kubeconfig 文件的时候发现 查看不了</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/32/4c/czNZphAz_o.png"></p> 
<p></p> 
<p>指定授权后的kubeconfig文件 可以查看你default名称空间下的 pod资源</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/16/5f/PNJgVx4D_o.png"></p> 
<p>查看default 名称空间下pod的日志发现也是不可以</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/16/4f/O4Ho420p_o.png"></p> 
<p>但是却不能访问非 default 名称空间下的pod，和所有名称空间下的其他资源，因为授权查看的资源只有default名称空间下的pod资源。</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/84/04/jlzRAwif_o.png"></p> 
<p></p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/25/b4/5cDHZCdk_o.png"></p> 
<p></p> 
<h4 id="BXC39">增加权限验证</h4> 
<p>根据上面的rabc.yaml 增加resources 列表 查看pod日志和查看service的权限</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e0/f0/h6gv2NBL_o.png"></p> 
<p>重新应用配置  kubectl  apply -f rabc.yaml</p> 
<p></p> 
<p>重新配置后：</p> 
<p>可以查看default 空间下pod日志</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/e8/c5/Etu4NFxj_o.png"></p> 
<p>可以查看default空间下service</p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/fb/05/X8RMBavX_o.png"></p> 
<p>如何让自定义授权文件成为默认文件？</p> 
<pre> cp benjamin.kubeconfig /root/.kube/config</pre> 
<p>如果没有  .kube 目录就创建一个，这样就会读取默认配置文件  /root/.kube/config </p> 
<p class="img-center"><img alt="" src="https://images2.imgbox.com/f8/73/fLnx4H92_o.png"></p> 
<h3 id="o8cfh">7、官网链接</h3> 
<p><a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/" rel="nofollow" title="Using RBAC Authorization | Kubernetes">Using RBAC Authorization | Kubernetes</a></p> 
<p></p> 
<p><strong>总结：</strong></p> 
<p>你与日月齐光，明动四方</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dc6d58ad6d28c98206f8bc8cae7edeb9/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">K8S服务搭建过程中出现的憨批错误</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b5f1fee8c433c3a55bfb7bd85661f4a8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Helm扩展</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>