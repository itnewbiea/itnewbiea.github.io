<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>高效VolumeLighting的实现及说明 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="高效VolumeLighting的实现及说明" />
<meta property="og:description" content="VolumeLighting的本质就是模拟丁达尔效应，即光线在空气中的散射效果。对于游戏渲染，远景可以直接使用大气散射实现，而近景则使用RayMatching的VolumeLighting实现。
具体可以看我做的Unity实现 https://gitee.com/alienity/srp-volume-lighting，有兴趣的同学可以看每次的提交记录，基本都记录了我每次提交的改进
实现原理 VolumeLighting原理很简单，就是使用RayMatching对每一小段的光照进行积分，最后把积分的结果加到最终渲染的纹理上。
我们做的完善的点
做了半分辨率的VolumeLighting纹理的RayMatching积分用Dither对RayMatching的起点做偏移，可以达到空间上对阶梯型的纹理做一次滤波使用BilateralUpSampling基于Depth做了上采样做RayMatching的时候使用3DTexture累计每一步得到的Volume积分强度，最后在绘制Transparent物体的时候直接从这张3DTexture中采样 废话不多说，我们看看代码实现
float4 RayMarch(float2 screenUV, float3 rayStart, float3 rayDir, float rayLength) { int stepCount = _SampleCount; float stepDifference = 1.0f / stepCount; float stepSize = rayLength * stepDifference; float3 step = rayDir * stepSize; int accVolumeWidth; int accVolumeHeight; int accVolumeDepth; _3DVolumeAccumulateTexture.GetDimensions(accVolumeWidth, accVolumeHeight, accVolumeDepth); int2 relativeXY = int2(accVolumeWidth, accVolumeHeight) * screenUV; // 因为这里使用了半分辨率，所以计算dither的时候也手动使用半分辨率计算 uint2 screenPos = uint2(screenUV * _ScreenParams.xy * 0.5f); uint2 ditherPos = fmod(screenPos, 4); float offset = _dither4x4[ditherPos." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/fe6ab004c37c40dede210e6f09df2465/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-03-28T16:30:48+08:00" />
<meta property="article:modified_time" content="2021-03-28T16:30:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">高效VolumeLighting的实现及说明</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><img src="https://images2.imgbox.com/30/4c/AWo8WpQg_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/0c/2d/TJ5zgNpA_o.jpg" alt="在这里插入图片描述"><br> VolumeLighting的本质就是模拟<a href="https://baike.baidu.com/item/%E4%B8%81%E8%BE%BE%E5%B0%94%E6%95%88%E5%BA%94" rel="nofollow">丁达尔效应</a>，即光线在空气中的散射效果。对于游戏渲染，远景可以直接使用大气散射实现，而近景则使用RayMatching的VolumeLighting实现。</p> 
<p>具体可以看我做的Unity实现 <a href="https://gitee.com/alienity/srp-volume-lighting" rel="nofollow">https://gitee.com/alienity/srp-volume-lighting</a>，有兴趣的同学可以看每次的提交记录，基本都记录了我每次提交的改进</p> 
<h2><a id="_5"></a>实现原理</h2> 
<p>VolumeLighting原理很简单，就是使用RayMatching对每一小段的光照进行积分，最后把积分的结果加到最终渲染的纹理上。</p> 
<p>我们做的完善的点</p> 
<ol><li>做了半分辨率的VolumeLighting纹理的RayMatching积分</li><li>用Dither对RayMatching的起点做偏移，可以达到空间上对阶梯型的纹理做一次滤波</li><li>使用BilateralUpSampling基于Depth做了上采样</li><li>做RayMatching的时候使用3DTexture累计每一步得到的Volume积分强度，最后在绘制Transparent物体的时候直接从这张3DTexture中采样</li></ol> 
<p>废话不多说，我们看看代码实现</p> 
<pre><code class="prism language-c">	float4 <span class="token function">RayMarch</span><span class="token punctuation">(</span>float2 screenUV<span class="token punctuation">,</span> float3 rayStart<span class="token punctuation">,</span> float3 rayDir<span class="token punctuation">,</span> <span class="token keyword">float</span> rayLength<span class="token punctuation">)</span>
	<span class="token punctuation">{<!-- --></span>
		<span class="token keyword">int</span> stepCount <span class="token operator">=</span> _SampleCount<span class="token punctuation">;</span>

		<span class="token keyword">float</span> stepDifference <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">/</span> stepCount<span class="token punctuation">;</span>
		<span class="token keyword">float</span> stepSize <span class="token operator">=</span> rayLength <span class="token operator">*</span> stepDifference<span class="token punctuation">;</span>
		float3 step <span class="token operator">=</span> rayDir <span class="token operator">*</span> stepSize<span class="token punctuation">;</span>

		<span class="token keyword">int</span> accVolumeWidth<span class="token punctuation">;</span>
		<span class="token keyword">int</span> accVolumeHeight<span class="token punctuation">;</span>
		<span class="token keyword">int</span> accVolumeDepth<span class="token punctuation">;</span>
		_3DVolumeAccumulateTexture<span class="token punctuation">.</span><span class="token function">GetDimensions</span><span class="token punctuation">(</span>accVolumeWidth<span class="token punctuation">,</span> accVolumeHeight<span class="token punctuation">,</span> accVolumeDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>

		int2 relativeXY <span class="token operator">=</span> <span class="token function">int2</span><span class="token punctuation">(</span>accVolumeWidth<span class="token punctuation">,</span> accVolumeHeight<span class="token punctuation">)</span> <span class="token operator">*</span> screenUV<span class="token punctuation">;</span>

		<span class="token comment">// 因为这里使用了半分辨率，所以计算dither的时候也手动使用半分辨率计算</span>
		uint2 screenPos <span class="token operator">=</span> <span class="token function">uint2</span><span class="token punctuation">(</span>screenUV <span class="token operator">*</span> _ScreenParams<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token number">0.5f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		uint2 ditherPos <span class="token operator">=</span> <span class="token function">fmod</span><span class="token punctuation">(</span>screenPos<span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">float</span> offset <span class="token operator">=</span> _dither4x4<span class="token punctuation">[</span>ditherPos<span class="token punctuation">.</span>x<span class="token punctuation">]</span><span class="token punctuation">[</span>ditherPos<span class="token punctuation">.</span>y<span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">0.0625f</span><span class="token punctuation">;</span>
		rayStart <span class="token operator">+</span><span class="token operator">=</span> step <span class="token operator">*</span> offset<span class="token punctuation">;</span>


		float3 volColor <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">[</span>loop<span class="token punctuation">]</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> stepCount<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
		<span class="token punctuation">{<!-- --></span>
			float3 currPositionWS <span class="token operator">=</span> rayStart <span class="token operator">+</span> step <span class="token operator">*</span> i<span class="token punctuation">;</span>

			<span class="token comment">// 转换到主光源空间</span>
			float4 shadowCoord <span class="token operator">=</span> <span class="token function">TransformWorldToShadowCoord</span><span class="token punctuation">(</span>currPositionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
			Light mainLight <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span>shadowCoord<span class="token punctuation">)</span><span class="token punctuation">;</span>

			volColor <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0.1</span> <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>color <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>shadowAttenuation <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>shadowAttenuation<span class="token punctuation">;</span>

<span class="token macro property">#<span class="token directive keyword">ifdef</span> _ADDITIONAL_LIGHTS</span>
			<span class="token comment">// uint pixelLightCount = GetAdditionalLightsCount();</span>
			uint pixelLightCount <span class="token operator">=</span> _AdditionalLightsCount<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span>uint lightIndex <span class="token operator">=</span> <span class="token number">0u</span><span class="token punctuation">;</span> lightIndex <span class="token operator">&lt;</span> pixelLightCount<span class="token punctuation">;</span> <span class="token operator">++</span>lightIndex<span class="token punctuation">)</span>
			<span class="token punctuation">{<!-- --></span>
				Light light <span class="token operator">=</span> <span class="token function">GetAdditionalLight</span><span class="token punctuation">(</span>lightIndex<span class="token punctuation">,</span> currPositionWS<span class="token punctuation">,</span> <span class="token function">half4</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				volColor <span class="token operator">+</span><span class="token operator">=</span> <span class="token number">0.1</span> <span class="token operator">*</span> light<span class="token punctuation">.</span>color <span class="token operator">*</span> light<span class="token punctuation">.</span>distanceAttenuation <span class="token operator">*</span> light<span class="token punctuation">.</span>shadowAttenuation <span class="token operator">*</span> light<span class="token punctuation">.</span>shadowAttenuation<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>

			<span class="token comment">// 计算在视椎体中的相对深度位置，使用cell向上取整</span>
			<span class="token keyword">int</span> relativeDepth <span class="token operator">=</span> <span class="token function">round</span><span class="token punctuation">(</span><span class="token function">saturate</span><span class="token punctuation">(</span>stepDifference<span class="token operator">*</span><span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> accVolumeDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
			_3DVolumeAccumulateTexture<span class="token punctuation">[</span><span class="token function">int3</span><span class="token punctuation">(</span>relativeXY<span class="token punctuation">,</span> relativeDepth<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> volColor <span class="token operator">*</span> stepDifference<span class="token punctuation">;</span>

		<span class="token punctuation">}</span>

		<span class="token keyword">return</span> <span class="token function">float4</span><span class="token punctuation">(</span>volColor <span class="token operator">*</span> stepDifference<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
</code></pre> 
<p>我们使用的是光栅化的方法做了RayMathcing，先把绘制的分辨率减半，</p> 
<p><img src="https://images2.imgbox.com/a7/80/AD5NnFQz_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/e9/80/Gz1LnzwF_o.png" alt="在这里插入图片描述"></p> 
<p>我们对每个像素都做固定次数的RayMatching，实际效果看起来也还行，毕竟Volume信息都是低频信息，同时为了避免产生阶梯的效果，我们对每个RayMatching的起点都做了Dither的偏移。通过以上两张图的对比，添加了Dither之后的效果会好很多。</p> 
<pre><code class="prism language-c">half4 <span class="token function">frag</span><span class="token punctuation">(</span>Varyings input<span class="token punctuation">)</span> <span class="token punctuation">:</span> SV_Target
<span class="token punctuation">{<!-- --></span>
	<span class="token function">UNITY_SETUP_INSTANCE_ID</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">UNITY_SETUP_STEREO_EYE_INDEX_POST_VERTEX</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
	half2 uv <span class="token operator">=</span> input<span class="token punctuation">.</span>uv<span class="token punctuation">;</span>

	uint2 depthUV <span class="token operator">=</span> uv <span class="token operator">*</span> _ScreenParams<span class="token punctuation">.</span>xy<span class="token punctuation">;</span>
	half deviceDepth00 <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">LoadSceneDepth</span><span class="token punctuation">(</span>depthUV<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.00001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	half deviceDepth01 <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">LoadSceneDepth</span><span class="token punctuation">(</span>depthUV<span class="token operator">+</span><span class="token function">uint2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.00001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	half deviceDepth10 <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">LoadSceneDepth</span><span class="token punctuation">(</span>depthUV<span class="token operator">+</span><span class="token function">uint2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.00001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	half deviceDepth11 <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">LoadSceneDepth</span><span class="token punctuation">(</span>depthUV<span class="token operator">+</span><span class="token function">uint2</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.00001f</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	half2 _screenSizeFrag <span class="token operator">=</span> _ScreenSize<span class="token punctuation">.</span>zw<span class="token punctuation">;</span>
	half4 volumeCol00 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_HalfVolumeTex<span class="token punctuation">,</span> sampler_HalfVolumeTex<span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	half4 volumeCol01 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_HalfVolumeTex<span class="token punctuation">,</span> sampler_HalfVolumeTex<span class="token punctuation">,</span> uv<span class="token operator">+</span><span class="token function">float2</span><span class="token punctuation">(</span>_screenSizeFrag<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	half4 volumeCol10 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_HalfVolumeTex<span class="token punctuation">,</span> sampler_HalfVolumeTex<span class="token punctuation">,</span> uv<span class="token operator">+</span><span class="token function">float2</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _screenSizeFrag<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	half4 volumeCol11 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_HalfVolumeTex<span class="token punctuation">,</span> sampler_HalfVolumeTex<span class="token punctuation">,</span> uv<span class="token operator">+</span>_screenSizeFrag<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>

	half4 color <span class="token operator">=</span> <span class="token punctuation">(</span>volumeCol00 <span class="token operator">*</span> deviceDepth00 
					<span class="token operator">+</span> volumeCol10 <span class="token operator">*</span> deviceDepth01 
					<span class="token operator">+</span> volumeCol10 <span class="token operator">*</span> deviceDepth10 
					<span class="token operator">+</span> volumeCol11 <span class="token operator">*</span> deviceDepth11<span class="token punctuation">)</span> 
					<span class="token operator">/</span><span class="token punctuation">(</span>deviceDepth00 <span class="token operator">+</span> deviceDepth01 <span class="token operator">+</span> deviceDepth10 <span class="token operator">+</span> deviceDepth11<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> color<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>因为我们是使用半分辨率做了RayMatching，所以这里使用了BilateralUpSampling做上采样，依赖的额外信息就是Depth，因为depth的值在边界的时候差别会非常的大，有可能为0，所以为了避免上采样之后的volume值也变成0，在每个depth的值上加了一个非常小的bias。</p> 
<p>绘制不透明物理的时候，我们只需要把Volume的纹理直接叠加到场景上就好了</p> 
<pre><code class="prism language-c"><span class="token macro property">#<span class="token directive keyword">if</span> defined(_VOLUMEFUSE_ON)</span>
    float3 positionNDC <span class="token operator">=</span> input<span class="token punctuation">.</span>positionNDC<span class="token punctuation">.</span>xyz <span class="token operator">/</span> input<span class="token punctuation">.</span>positionNDC<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
	<span class="token keyword">float</span> deviceDepth <span class="token operator">=</span> <span class="token function">SampleSceneDepth</span><span class="token punctuation">(</span>positionNDC<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">if</span> UNITY_REVERSED_Z</span>
    deviceDepth <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> deviceDepth<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
	float3 samplePos <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span>positionNDC<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> deviceDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    float3 accVolumeColor <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE3D</span><span class="token punctuation">(</span>_3DVolumeAccumulateTexture<span class="token punctuation">,</span> sampler_3DVolumeAccumulateTexture<span class="token punctuation">,</span> samplePos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    color<span class="token punctuation">.</span>rgb <span class="token operator">+</span><span class="token operator">=</span> accVolumeColor<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
<span class="token macro property">#<span class="token directive keyword">endif</span></span>
</code></pre> 
<p>最后为了让透明物体绘制的时候也受到Volume的影响，我们把Volume的每一步都累积到了一张3DTexture上，最后我们需要在绘制不透明物体的时候根据深度从3DTexture中采样，就可以得到相机到当前位置累计的Volume的强度值。</p> 
<h2><a id="_126"></a>引用</h2> 
<p>[1] <a href="https://github.com/SlightlyMad/VolumetricLights">https://github.com/SlightlyMad/VolumetricLights</a><br> [2] <a href="https://book.douban.com/subject/25738978/" rel="nofollow">https://book.douban.com/subject/25738978/</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1a9e9f01f3caf990d223516b5831a98b/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">安装H3C Cloud Lab（HCL）时遇到的问题及解决办法汇总</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b6ccbbd522e051ec3433378e01612d89/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Element 快速入门</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>