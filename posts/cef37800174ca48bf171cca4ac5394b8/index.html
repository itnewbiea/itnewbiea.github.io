<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>nvme-cli常用指令 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="nvme-cli常用指令" />
<meta property="og:description" content="NVMe management command line interface
1.下载地址
https://github.com/linux-nvme/nvme-cli
2.安装
unzip nvme-cli-master.zip
cd nvme-cli-master.zip make &amp;&amp; make install
/dev/nvme1 nvme1为主控
/dev/nvme1n1 nvme1n1为NVMe硬盘名称
/dev/nvme1n1p1 硬盘nvme1n1的分区
3.常用指令
1）nvme format -s 1 /dev/nvme1n1 格式化硬盘（secure erase drives）
nvme format /dev/nvme1n1 -n 1 -l 1 4k对齐
nvme format /dev/nvme1n1 -n 1 -l 0 恢复初始状态512
nvme format /dev/nvme1n1 -l 0 Optane device Units512
参数详情请参考：http://www.pudn.com/Download/item/id/3180638.html
2）nvme smart-log /dev/nvme0n1 读取硬盘nvme0n1的smart信息
部分其他参数详解参考：https://www.percona.com/blog/2017/02/09/using-nvme-command-line-tools-to-check-nvme-flash-health/
3）nvme升/降固件版本
nvme reset /dev/nvme1 重置硬盘（NVMe硬盘固件版本进行upgrade/downgrading后要进行reset后才能effective，如果不重置主控需reboot 系统）
4)OP(Over-Provisioning)
为什么要进行OP，请参考：https://blog.csdn.net/weixin_40343504/article/details/83145713" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/cef37800174ca48bf171cca4ac5394b8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-10-17T14:17:48+08:00" />
<meta property="article:modified_time" content="2018-10-17T14:17:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">nvme-cli常用指令</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>NVMe management command line interface<br> <strong>1.下载地址</strong><br> https://github.com/linux-nvme/nvme-cli<br> <strong>2.安装</strong><br> unzip nvme-cli-master.zip<br> cd nvme-cli-master.zip <br> make &amp;&amp; make install<br> <img src="https://images2.imgbox.com/40/ec/OtDWDGJc_o.jpg" alt="这里写图片描述"><br> /dev/nvme1 nvme1为主控<br> /dev/nvme1n1 nvme1n1为NVMe硬盘名称<br> /dev/nvme1n1p1 硬盘nvme1n1的分区<br> <strong>3.常用指令</strong><br> 1）nvme format -s 1 /dev/nvme1n1 格式化硬盘（secure erase drives）<br> <img src="https://images2.imgbox.com/b3/a2/Enl2cb4X_o.png" alt="在这里插入图片描述"><br> <strong>nvme format /dev/nvme1n1 -n 1 -l 1 4k对齐</strong><br> <strong>nvme format /dev/nvme1n1 -n 1 -l 0 恢复初始状态512</strong><br> <strong>nvme format /dev/nvme1n1 -l 0 Optane device Units512</strong></p> 
<p>参数详情请参考：http://www.pudn.com/Download/item/id/3180638.html</p> 
<p>2）nvme smart-log /dev/nvme0n1 读取硬盘nvme0n1的smart信息<br> <img src="https://images2.imgbox.com/13/80/Q8rO29El_o.png" alt="在这里插入图片描述"><br> 部分其他参数详解参考：https://www.percona.com/blog/2017/02/09/using-nvme-command-line-tools-to-check-nvme-flash-health/<br> 3）nvme升/降固件版本<br> <img src="https://images2.imgbox.com/f8/0d/P9m3EEbg_o.jpg" alt="这里写图片描述"><br> nvme reset /dev/nvme1 重置硬盘（NVMe硬盘固件版本进行upgrade/downgrading后要进行reset后才能effective，如果不重置主控需reboot 系统）</p> 
<p>4)OP(Over-Provisioning)<br> 为什么要进行OP，请参考：https://blog.csdn.net/weixin_40343504/article/details/83145713</p> 
<h6><a id="nvme_adminpassthru_devnvme0_o_0x9_cdw100xc1_cdw110x2000000_cdw120x0_29"></a>nvme admin-passthru /dev/nvme0 -o 0x9 --cdw10=0xc1 --cdw11=0x2000000 --cdw12=0x0</h6> 
<p>OP to GB<br> 1.The decimal value of LBA is (X * 1000 * 1000 * 1000 / 512), then convert it to Hex Value.<br> 2. Put the Hex Value to cdw11<br> 3. If the Hex Value over 0xFFFFFFFF, put the high overflow digits to cdw 12.<br> 4. Example:<br> ⦁ 3200 GB<br> ⦁ Decimal value is 6,250,000,000 and Hex Value is 0x174876E80<br> The value for cdw12 should be 0x1 and for cdw11 is 0x74876E80.<br> ⦁ 2000 GB<br> ⦁ Decimal value is 3,906,250,000 and Hex Value is 0xE8D4A510<br> The value for cdw12 should be 0x0 and for cdw11 is 0xE8D4A510.<br> ⦁ 4000 GB<br> ⦁ 7,814,037,168 // 0x1 D1C0 BEB0<br> ⦁ 7200 GB - 0x3 4630 B8A0<br> 6400 GB - 0x2 E90E DD00<br> 例一：<br> <img src="https://images2.imgbox.com/16/66/ibWVQmFt_o.jpg" alt="在这里插入图片描述"><br> 例二：<br> 原容量OPed到3.4T<br> [root@localhost nvme-cli-master]# nvme admin-passthru /dev/nvme9n1 -o 0x9 --cdw10=0xc1 --cdw11=0x18BCFE568 --cdw12=0x1<br> NVMe command result:00000000</p> 
<p>5）nvme-cli 创建namespaces<br> 什么是Namespace?<br> 简单地说，namespace是对用户空间的逻辑划分，就是把用户空间这块大披萨划分开，大家各吃各的。那么大披萨长什么样呢？划成一片片儿披萨又什么样呢？我们知道，跟其他传统的存储设备一样，非易失性存储器也是可以格式化为逻辑块的，每个逻辑块都有自己的地址，俗称logical block address，简称LBA，我们就是通过LBA来吃披萨（读写IO）的。逻辑地址长相很普通，是从0,1,2….直到最大块地址。<br> 逻辑块地址计算是有讲究的，严格依据JEDEC218A里面定义的逻辑块与容量关系公式。比如4KiB一个逻辑块的话， 500G就需要<strong>2646 + 244188 * 500 = 122096646</strong>个逻辑地址了，这些逻辑块就组成了namespace(512B一块逻辑块的话，500G就需要21168+1953504*500=976773168个逻辑地址)。那么一块SSD是否可以划分为多个namespace来供不同的应用场景使用呢？答案是肯定的。</p> 
<h3><a id="500G465Gnamaspaces_56"></a>例如：创建一个500G和一个465G的namaspaces</h3> 
<p>检查SSD上剩余空间是否足够创建目标namespace。使用Identify命令查看unvmcap的值可知剩余可分配容量，单位是Byte。<br> <img src="https://images2.imgbox.com/9f/86/mUGhgfuQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code>#进行以下步骤前请务必确保自己的SSD支持NS
#一般大厂才会有进行NS的需求，请和你的厂商确保SSD支持。
#个人的盘不建议尝试进行NS操作
1.detach
nvme detach-ns /dev/nvme0 -n 1 -c 0
nvme delete-ns /dev/nvme0 -n 1
nvme reset /dev/nvme0

2.创建
**#1953125000 = 1,000,000,000,000/512 = 1,953,125,000 (1TB)**
nvme create-ns /dev/nvme0 -s 976562500 -c 976562500 -f 0 -d 0 -m 0
nvme attach-ns /dev/nvme0 -n 1 -c 0

nvme create-ns /dev/nvme0 -s 975175680 -c 975175680 -f 0 -d 0 -m 0  #第二个创建的必须
nvme attach-ns /dev/nvme0 -n 2 -c 0

nvme reset /dev/nvme0
nvme list
[root@localhost Muti-namespace_Test]# nvme list
Node             SN                   Model                                    Namespace Usage                      Format           FW Rev  
---------------- -------------------- ---------------------------------------- --------- -------------------------- ---------------- --------
/dev/nvme0n1     XXXXXX   XXXXX                      1         500.36  GB / 500.36  GB    512   B +  0 B   VDV10152
/dev/nvme0n2     XXXXXX   XXXXX                      2         499.29  GB / 499.29  GB    512   B +  0 B   VDV10152

3,删除
nvme detach-ns /dev/nvme0 -n 1 -c 0
nvme detach-ns /dev/nvme0 -n 2 -c 0

nvme delete-ns /dev/nvme0 -n 1
nvme delete-ns /dev/nvme0 -n 2

4.恢复
nvme create-ns /dev/nvme0 -s 1000204886016 -c 1000204886016 -f 0 -d 0 -m 0  #1000204886016是通过“nvme id-ctrl /dev/nvme0n1 | grep tnvmcap”抓取并除以512
nvme attach-ns /dev/nvme0 -n 1 -c 0
nvme reset /dev/nvme0

nvme list
[root@localhost Muti-namespace_Test]# nvme list

</code></pre> 
<p><strong>4.PCIe硬盘寿命计算</strong><br> 可以通过nvme-cli读取PCIe硬盘smart信息，进行进行计算硬盘的Endurance、DWPD(Drive Writes Per Day)。<br> 建议寿命测试仅企业级可能有必要，个人没必要进行此项操作。<br> <strong>a.测试前读取硬盘smart-log信息</strong></p> 
<pre><code>[root@localhost nvme-cli-master]# nvme intel smart-log-add /dev/nvme0n1       
Additional Smart Log for NVME device:nvme0n1 namespace-id:ffffffff
key                               normalized raw
program_fail_count              :   0%       0
erase_fail_count                :   0%       0
wear_leveling                   :   0%       min: 0, max: 0, avg: 0
end_to_end_error_detection_count: 100%       159
crc_error_count                 : 100%       25963
timed_workload_media_wear       : 100%       0.000%
timed_workload_host_reads       : 100%       8%
timed_workload_timer            : 100%       120864 min
thermal_throttle_status         : 100%       0%, cnt: 1
retry_buffer_overflow_count     : 100%       0
pll_lock_loss_count             : 100%       0
nand_bytes_written              :   0%       sectors: 0
host_bytes_written              : 100%       sectors: 26008485

</code></pre> 
<p><strong>b.fio进行读写一定的数据</strong><br> <strong>c.fio结束后再次执行nvme intel smart-log-add /dev/nvme0n1读取smart-log信息</strong><br> <strong>d.计算</strong><br> <img src="https://images2.imgbox.com/88/aa/QVd1Nr19_o.png" alt="在这里插入图片描述"><br> 盘进入稳态后进行随机写得到DWPD的值更为准确<br> <img src="https://images2.imgbox.com/31/d5/8UrNQbUI_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a49676da9de075317834a185ea2ac69c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">React阻止事件冒泡</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/59aa0eb10c949c8acba365a3c6205dd9/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">C#.NET调用jar包（java环境配置及ikvm安装）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>