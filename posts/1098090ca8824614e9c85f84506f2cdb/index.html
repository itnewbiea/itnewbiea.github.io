<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>12. 离线处理之业务数据采集、生成用户画像、推广效果分析以及知识点总结 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="12. 离线处理之业务数据采集、生成用户画像、推广效果分析以及知识点总结" />
<meta property="og:description" content="离线处理之业务数据采集、生成用户画像、推广效果分析以及知识点总结 1. Azkaban周期性调度任务1.1. 总览1.2. 调度脚本1.3. [Azkaban安装并设置定时任务Schedule以及邮件发送接收](https://blog.csdn.net/aizhenshi/article/details/80828726?utm_source=blogxgwz5) 2. 业务数据采集2.1. 后台通过`logback`把业务接口日志写入到本地文件2.1.1. logback配置文件2.1.2. 拦截器当中记录接口日志2.1.3. 本地日志目录2.1.4. 日志格式 2.2. 通过Flume采集数据到Kafka2.2.1. Flume配置文件 2.3. Storm消费Kafka数据，写入Hbase2.3.1. `LogReaderSpout.java`2.3.2. `UserLogBolt.java`2.3.3 `ToHbaseBolt.java` 2.4. [Hive和Hbase的整合](https://blog.csdn.net/fanjianhai/article/details/106016931)2.4.1. HIve和Hbase的表关联2.4.2. Hive数据样式2.4.3. Hbase数据样式2.4.4. `Hive和Hbase关联后，操作一方同样会影响另一方数据` 2.5. 通过Sqoop把业务数据从PostgreSql导入Hive数仓 3. 生成用户画像3.1. hive分区设置3.2. 用户登录日志3.3. 用户终端类型和机型3.4. 用户最高委员会职务3.5. 用户信息3.6. 画像信息3.7. 生成用户画像 4. 推广效果分析4.1. 采集微论文曝光数据4.2. 采集广告曝光数据4.3. 曝光量多维度统计4.4. 不同维度进行曝光量的统计4.5. 统计日汇总维度4.6. 同步统计结果 5. 知识点总结5.1. Tomcat5.1.1. [Tomcat使用详细教程](https://blog.csdn.net/weixin_39657319/article/details/83268378)5.1.2. [用脚本实现windows与linux之间文件的传输 ](https://blog.csdn.net/xqhrs232/article/details/78403080) 5.2. Hive Hql常用方法总结5.2.1. [ROW_NUMBER() OVER函数的基本用法](https://jingyan.baidu.com/article/9989c74604a644f648ecfef3.html)5.2.2. [SQL语言-- SELECT CASE WHEN THEN](https://blog.csdn.net/qq_34777600/article/details/81699270)5.2.3. [Hive列转行 (Lateral View &#43; explode)详解](https://zhuanlan.zhihu.com/p/115913870)5.2.4. [HiveSQL行转列lateral view explore()以及连接concat_ws()和列转行collect_list()&amp;collect_set()区别的使用案例](https://blog." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1098090ca8824614e9c85f84506f2cdb/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-07-21T18:37:07+08:00" />
<meta property="article:modified_time" content="2020-07-21T18:37:07+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">12. 离线处理之业务数据采集、生成用户画像、推广效果分析以及知识点总结</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>离线处理之业务数据采集、生成用户画像、推广效果分析以及知识点总结</h4> 
 <ul><li><a href="#1_Azkaban_1" rel="nofollow">1. Azkaban周期性调度任务</a></li><li><ul><li><a href="#11__2" rel="nofollow">1.1. 总览</a></li><li><a href="#12__7" rel="nofollow">1.2. 调度脚本</a></li><li><a href="#13_AzkabanSchedulehttpsblogcsdnnetaizhenshiarticledetails80828726utm_sourceblogxgwz5_58" rel="nofollow">1.3. [Azkaban安装并设置定时任务Schedule以及邮件发送接收](https://blog.csdn.net/aizhenshi/article/details/80828726?utm_source=blogxgwz5)</a></li></ul> 
  </li><li><a href="#2__60" rel="nofollow">2. 业务数据采集</a></li><li><ul><li><a href="#21_logback_61" rel="nofollow">2.1. 后台通过`logback`把业务接口日志写入到本地文件</a></li><li><ul><li><a href="#211_logback_62" rel="nofollow">2.1.1. logback配置文件</a></li><li><a href="#212__64" rel="nofollow">2.1.2. 拦截器当中记录接口日志</a></li><li><a href="#213__67" rel="nofollow">2.1.3. 本地日志目录</a></li><li><a href="#214__69" rel="nofollow">2.1.4. 日志格式</a></li></ul> 
   </li><li><a href="#22_FlumeKafka_184" rel="nofollow">2.2. 通过Flume采集数据到Kafka</a></li><li><ul><li><a href="#221_Flume_185" rel="nofollow">2.2.1. Flume配置文件</a></li></ul> 
   </li><li><a href="#23_StormKafkaHbase_231" rel="nofollow">2.3. Storm消费Kafka数据，写入Hbase</a></li><li><ul><li><a href="#231_LogReaderSpoutjava_232" rel="nofollow">2.3.1. `LogReaderSpout.java`</a></li><li><a href="#232_UserLogBoltjava_286" rel="nofollow">2.3.2. `UserLogBolt.java`</a></li><li><a href="#233_ToHbaseBoltjava_364" rel="nofollow">2.3.3 `ToHbaseBolt.java`</a></li></ul> 
   </li><li><a href="#24_HiveHbasehttpsblogcsdnnetfanjianhaiarticledetails106016931_430" rel="nofollow">2.4. [Hive和Hbase的整合](https://blog.csdn.net/fanjianhai/article/details/106016931)</a></li><li><ul><li><a href="#241_HIveHbase_431" rel="nofollow">2.4.1. HIve和Hbase的表关联</a></li><li><a href="#242_Hive_433" rel="nofollow">2.4.2. Hive数据样式</a></li><li><a href="#243_Hbase_436" rel="nofollow">2.4.3. Hbase数据样式</a></li><li><a href="#244_HiveHbase_438" rel="nofollow">2.4.4. `Hive和Hbase关联后，操作一方同样会影响另一方数据`</a></li></ul> 
   </li><li><a href="#25_SqoopPostgreSqlHive_440" rel="nofollow">2.5. 通过Sqoop把业务数据从PostgreSql导入Hive数仓</a></li></ul> 
  </li><li><a href="#3__520" rel="nofollow">3. 生成用户画像</a></li><li><ul><li><a href="#31_hive_521" rel="nofollow">3.1. hive分区设置</a></li><li><a href="#32__527" rel="nofollow">3.2. 用户登录日志</a></li><li><a href="#33__545" rel="nofollow">3.3. 用户终端类型和机型</a></li><li><a href="#34__562" rel="nofollow">3.4. 用户最高委员会职务</a></li><li><a href="#35__583" rel="nofollow">3.5. 用户信息</a></li><li><a href="#36__608" rel="nofollow">3.6. 画像信息</a></li><li><a href="#37__678" rel="nofollow">3.7. 生成用户画像</a></li></ul> 
  </li><li><a href="#4__693" rel="nofollow">4. 推广效果分析</a></li><li><ul><li><a href="#41__694" rel="nofollow">4.1. 采集微论文曝光数据</a></li><li><a href="#42__709" rel="nofollow">4.2. 采集广告曝光数据</a></li><li><a href="#43___733" rel="nofollow">4.3. 曝光量多维度统计</a></li><li><a href="#44___851" rel="nofollow">4.4. 不同维度进行曝光量的统计</a></li><li><a href="#45__1031" rel="nofollow">4.5. 统计日汇总维度</a></li><li><a href="#46__1042" rel="nofollow">4.6. 同步统计结果</a></li></ul> 
  </li><li><a href="#5__1061" rel="nofollow">5. 知识点总结</a></li><li><ul><li><a href="#51_Tomcat_1062" rel="nofollow">5.1. Tomcat</a></li><li><ul><li><a href="#511_Tomcathttpsblogcsdnnetweixin_39657319articledetails83268378_1063" rel="nofollow">5.1.1. [Tomcat使用详细教程](https://blog.csdn.net/weixin_39657319/article/details/83268378)</a></li><li><a href="#512_windowslinux_httpsblogcsdnnetxqhrs232articledetails78403080_1064" rel="nofollow">5.1.2. [用脚本实现windows与linux之间文件的传输 ](https://blog.csdn.net/xqhrs232/article/details/78403080)</a></li></ul> 
   </li><li><a href="#52_Hive_Hql_1067" rel="nofollow">5.2. Hive Hql常用方法总结</a></li><li><ul><li><a href="#521_ROW_NUMBER_OVERhttpsjingyanbaiducomarticle9989c74604a644f648ecfef3html_1068" rel="nofollow">5.2.1. [ROW_NUMBER() OVER函数的基本用法](https://jingyan.baidu.com/article/9989c74604a644f648ecfef3.html)</a></li><li><a href="#522_SQL_SELECT_CASE_WHEN_THENhttpsblogcsdnnetqq_34777600articledetails81699270_1070" rel="nofollow">5.2.2. [SQL语言-- SELECT CASE WHEN THEN](https://blog.csdn.net/qq_34777600/article/details/81699270)</a></li><li><a href="#523_Hive_Lateral_View__explodehttpszhuanlanzhihucomp115913870_1072" rel="nofollow">5.2.3. [Hive列转行 (Lateral View + explode)详解](https://zhuanlan.zhihu.com/p/115913870)</a></li><li><a href="#524_HiveSQLlateral_view_exploreconcat_wscollect_listcollect_sethttpsblogcsdnnetweixin_39043567articledetails90666521_1073" rel="nofollow">5.2.4. [HiveSQL行转列lateral view explore()以及连接concat_ws()和列转行collect_list()&amp;collect_set()区别的使用案例](https://blog.csdn.net/weixin_39043567/article/details/90666521)</a></li><li><a href="#525_Hive_SQL_grouping_sets_httpswwwcnblogscomAllenrgp10648231html_1075" rel="nofollow">5.2.5. [Hive SQL grouping sets 用法](https://www.cnblogs.com/Allen-rg/p/10648231.html)</a></li><li><a href="#526_hivelateral_view__explodehttpsblogcsdnnetguodong2karticledetails79459282_1076" rel="nofollow">5.2.6. [hive中的lateral view 与 explode函数的使用](https://blog.csdn.net/guodong2k/article/details/79459282)</a></li></ul> 
  </li></ul> 
  </li><li><a href="#6__1078" rel="nofollow">6. 寄语：知己知彼，不狂不馁，仔细地找准了自己生命的目标，板浆摇橹向人生茫茫之海努力划去。</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1_Azkaban_1"></a>1. Azkaban周期性调度任务</h2> 
<h3><a id="11__2"></a>1.1. 总览</h3> 
<p><img src="https://images2.imgbox.com/4d/43/Vrjvm8mA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/34/b7/QeeWwYvh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9e/bb/kw5FmS1U_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="12__7"></a>1.2. 调度脚本</h3> 
<ul><li> <p><code>system_pre.properties</code></p> <pre><code class="prism language-bash">dbUrl<span class="token operator">=</span>jdbc:postgresql://rm-2zeqbua7952ni0c14.pg.rds.aliyuncs.com:3433/medchat
userName<span class="token operator">=</span>******
password<span class="token operator">=</span>******
</code></pre> </li><li> <p><code>bass_get_data.job</code></p> <pre><code class="prism language-bash">type<span class="token operator">=</span>command
command<span class="token operator">=</span>sh sqoop_coll.sh <span class="token variable">${dbUrl}</span> <span class="token variable">${userName}</span> <span class="token variable">${password}</span>
</code></pre> </li><li> <p><code>bass_serv_profile.job</code></p> <pre><code class="prism language-bash">type<span class="token operator">=</span>command
command<span class="token operator">=</span>sh bass_serv_profile.sh
dependencies<span class="token operator">=</span>bass_get_data
</code></pre> </li><li> <p><code>bass_serv_profile.sh</code></p> <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">echo</span> <span class="token string">"run profile start <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y-%m-%d,%H:%m:%s'</span><span class="token variable">`</span></span>"</span>
lastDay<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"yesterday"</span> +%Y-%m-%d<span class="token variable">`</span></span>
<span class="token comment">#生成用户画像</span>
hive -hiveconf lastDay<span class="token operator">=</span><span class="token variable">$lastDay</span> -f serv_profile.sql
<span class="token keyword">echo</span> <span class="token string">"run profile end <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y-%m-%d,%H:%m:%s'</span><span class="token variable">`</span></span>"</span>
</code></pre> </li><li> <p><code>bass_ad_analysis.job</code></p> <pre><code class="prism language-bash">type<span class="token operator">=</span>command
command<span class="token operator">=</span>sh bass_ad_analysis.sh <span class="token variable">${dbUrl}</span> <span class="token variable">${userName}</span> <span class="token variable">${password}</span>
dependencies<span class="token operator">=</span>bass_serv_profile
</code></pre> </li><li> <p><code>bass_ad_analysis.sh</code></p> <pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">echo</span> <span class="token string">"run ad analysis start <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y-%m-%d,%H:%m:%s'</span><span class="token variable">`</span></span>"</span>
dbUrl<span class="token operator">=</span><span class="token variable">$1</span>
userName<span class="token operator">=</span><span class="token variable">$2</span>
password<span class="token operator">=</span><span class="token variable">$3</span>
lastDay<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"yesterday"</span> +%Y-%m-%d<span class="token variable">`</span></span>
<span class="token comment">#广告效果分析</span>
hive -hiveconf lastDay<span class="token operator">=</span><span class="token variable">$lastDay</span> -hiveconf dbUrl<span class="token operator">=</span><span class="token variable">$dbUrl</span> -hiveconf userName<span class="token operator">=</span><span class="token variable">$userName</span> -hiveconf password<span class="token operator">=</span><span class="token variable">$password</span> -f ad_analysis.sql
<span class="token keyword">echo</span> <span class="token string">"run analysis end <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y-%m-%d,%H:%m:%s'</span><span class="token variable">`</span></span>"</span>
</code></pre> </li></ul> 
<h3><a id="13_AzkabanSchedulehttpsblogcsdnnetaizhenshiarticledetails80828726utm_sourceblogxgwz5_58"></a>1.3. <a href="https://blog.csdn.net/aizhenshi/article/details/80828726?utm_source=blogxgwz5">Azkaban安装并设置定时任务Schedule以及邮件发送接收</a></h3> 
<h2><a id="2__60"></a>2. 业务数据采集</h2> 
<h3><a id="21_logback_61"></a>2.1. 后台通过<code>logback</code>把业务接口日志写入到本地文件</h3> 
<h4><a id="211_logback_62"></a>2.1.1. logback配置文件</h4> 
<p><img src="https://images2.imgbox.com/f5/4f/mf228qVS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="212__64"></a>2.1.2. 拦截器当中记录接口日志</h4> 
<p><img src="https://images2.imgbox.com/ac/ab/iGkRuUpl_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4f/fc/6r0iLuID_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="213__67"></a>2.1.3. 本地日志目录</h4> 
<p><img src="https://images2.imgbox.com/6b/b8/Ri6cmAbu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="214__69"></a>2.1.4. 日志格式</h4> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"time"</span><span class="token punctuation">:</span><span class="token string">"2020-07-17 09:06:06.897"</span><span class="token punctuation">,</span>
    <span class="token string">"modelName"</span><span class="token punctuation">:</span><span class="token string">"MINI-PORTAL"</span><span class="token punctuation">,</span>
    <span class="token string">"host"</span><span class="token punctuation">:</span><span class="token string">"172.17.176.152"</span><span class="token punctuation">,</span>
    <span class="token string">"thread"</span><span class="token punctuation">:</span><span class="token string">"http-nio-8902-exec-62"</span><span class="token punctuation">,</span>
    <span class="token string">"level"</span><span class="token punctuation">:</span><span class="token string">"INFO "</span><span class="token punctuation">,</span>
    <span class="token string">"file"</span><span class="token punctuation">:</span><span class="token string">"MedChatLogger.java:110"</span><span class="token punctuation">,</span>
    <span class="token string">"source"</span><span class="token punctuation">:</span><span class="token string">"adFile"</span><span class="token punctuation">,</span>
    <span class="token string">"adLogonName"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"os"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"operFlag"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token string">"inputParam"</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
        <span class="token string">"logonName"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
            <span class="token string">"15165428830"</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">"logonPwd"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
            <span class="token string">"******"</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"channel"</span><span class="token punctuation">:</span><span class="token string">"ANDROID"</span><span class="token punctuation">,</span>
    <span class="token string">"language"</span><span class="token punctuation">:</span><span class="token string">"en"</span><span class="token punctuation">,</span>
    <span class="token string">"isNeedSync"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token string">"remote"</span><span class="token punctuation">:</span><span class="token string">"114.247.227.197"</span><span class="token punctuation">,</span>
    <span class="token string">"message"</span><span class="token punctuation">:</span><span class="token string">"User login successfully"</span><span class="token punctuation">,</span>
    <span class="token string">"version"</span><span class="token punctuation">:</span><span class="token string">"1.3.0-preview"</span><span class="token punctuation">,</span>
    <span class="token string">"mac"</span><span class="token punctuation">:</span><span class="token string">"A1000037DFFE57"</span><span class="token punctuation">,</span>
    <span class="token string">"url"</span><span class="token punctuation">:</span><span class="token string">"/html/gateway/api.ajax"</span><span class="token punctuation">,</span>
    <span class="token string">"token"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"result"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"token"</span><span class="token punctuation">:</span><span class="token string">"49f1428d2aea459fb795799b8f841254"</span><span class="token punctuation">,</span>
            <span class="token string">"isCanPublish"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"isCanAudit"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isBelongEditorialBoard"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isBelongTeam"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"isHaveEducation"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isHaveWorkExperience"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"authFlag"</span><span class="token punctuation">:</span><span class="token string">"Y"</span><span class="token punctuation">,</span>
            <span class="token string">"isForcedAuth"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"servId"</span><span class="token punctuation">:</span><span class="token string">"100034"</span><span class="token punctuation">,</span>
            <span class="token string">"imPwd"</span><span class="token punctuation">:</span><span class="token string">"5ED47664D3C844ED075D121089B10DD8"</span><span class="token punctuation">,</span>
            <span class="token string">"pushId"</span><span class="token punctuation">:</span><span class="token string">"100034"</span><span class="token punctuation">,</span>
            <span class="token string">"pushAlias"</span><span class="token punctuation">:</span><span class="token string">"MOBILE"</span><span class="token punctuation">,</span>
            <span class="token string">"servName"</span><span class="token punctuation">:</span><span class="token string">"æ–‡é£žæ‰¬"</span><span class="token punctuation">,</span>
            <span class="token string">"servIcon"</span><span class="token punctuation">:</span><span class="token string">"doctor/headportrait/person/1566811863179164958.jpg"</span><span class="token punctuation">,</span>
            <span class="token string">"gender"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token string">"servInfoDegree"</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span>
            <span class="token string">"isVoice"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isShock"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isCertApply"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isHaveChannel"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"cityName"</span><span class="token punctuation">:</span><span class="token string">"Yanbian Korean Autonomous Prefecture"</span><span class="token punctuation">,</span>
            <span class="token string">"isSpecialServ"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isShowZone"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"isHaveAuth"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"isHaveProfile"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isCanNotice"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"dutyDesc"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
            <span class="token string">"channelEduPublishType"</span><span class="token punctuation">:</span><span class="token string">"SPEECH"</span><span class="token punctuation">,</span>
            <span class="token string">"mainDesc"</span><span class="token punctuation">:</span><span class="token string">"åŒ—äº¬åŒ»é™¢"</span><span class="token punctuation">,</span>
            <span class="token string">"noticeInfo"</span><span class="token punctuation">:</span><span class="token punctuation">{<!-- --></span>
                <span class="token string">"noticeChatId"</span><span class="token punctuation">:</span><span class="token keyword">null</span><span class="token punctuation">,</span>
                <span class="token string">"noticeChatName"</span><span class="token punctuation">:</span><span class="token keyword">null</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"isSwitchPhone"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isShowMobile"</span><span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token string">"isOpenEduInvite"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isAnonymous"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"paymentSalt"</span><span class="token punctuation">:</span><span class="token string">"MTUxNjU1Mjg4NjQ="</span><span class="token punctuation">,</span>
            <span class="token string">"isRealName"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"isHavePaymentPassword"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"maxBankCardCount"</span><span class="token punctuation">:</span><span class="token string">"5"</span><span class="token punctuation">,</span>
            <span class="token string">"menuArr"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
                <span class="token string">"ARTICLE"</span><span class="token punctuation">,</span>
                <span class="token string">"PEER"</span><span class="token punctuation">,</span>
                <span class="token string">"CHAT"</span><span class="token punctuation">,</span>
                <span class="token string">"ME"</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"servIdentityType"</span><span class="token punctuation">:</span><span class="token string">"DOCTOR"</span><span class="token punctuation">,</span>
            <span class="token string">"isRemindDisturb"</span><span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
            <span class="token string">"eduCount"</span><span class="token punctuation">:</span><span class="token string">"1"</span><span class="token punctuation">,</span>
            <span class="token string">"valueAddedService"</span><span class="token punctuation">:</span><span class="token string">"0"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"subErrcode"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"carrier"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"GATEWAY_MEDCHAT"</span><span class="token punctuation">:</span><span class="token string">"GATEWAY_MEDCHAT"</span><span class="token punctuation">,</span>
    <span class="token string">"errCode"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"model"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"adServId"</span><span class="token punctuation">:</span><span class="token string">"0"</span><span class="token punctuation">,</span>
    <span class="token string">"net"</span><span class="token punctuation">:</span><span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token string">"apiType"</span><span class="token punctuation">:</span><span class="token string">"LOGIN"</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-json"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"time"</span><span class="token punctuation">:</span><span class="token string">"2020-07-17 10:26:59.535"</span><span class="token punctuation">,</span>
    <span class="token string">"modelName"</span><span class="token punctuation">:</span><span class="token string">"MINI-PORTAL"</span><span class="token punctuation">,</span>
    <span class="token string">"host"</span><span class="token punctuation">:</span><span class="token string">"172.17.176.152"</span><span class="token punctuation">,</span>
    <span class="token string">"thread"</span><span class="token punctuation">:</span><span class="token string">"http-nio-8902-exec-82"</span><span class="token punctuation">,</span>
    <span class="token string">"level"</span><span class="token punctuation">:</span><span class="token string">"INFO "</span><span class="token punctuation">,</span>
    <span class="token string">"file"</span><span class="token punctuation">:</span><span class="token string">"MedChatLogger.java:110"</span><span class="token punctuation">,</span>
    <span class="token string">"source"</span><span class="token punctuation">:</span><span class="token string">"adFile"</span><span class="token punctuation">,</span>
    <span class="token string">"apiType"</span><span class="token punctuation">:</span><span class="token string">"QUERY_CEDU_PLATFORM_INFO_LIST@AD_INFO"</span><span class="token punctuation">,</span>
    <span class="token string">"adServId"</span><span class="token punctuation">:</span><span class="token string">"100242"</span><span class="token punctuation">,</span>
    <span class="token string">"result"</span><span class="token punctuation">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"adId"</span><span class="token punctuation">:</span><span class="token string">"657"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="22_FlumeKafka_184"></a>2.2. 通过Flume采集数据到Kafka</h3> 
<h4><a id="221_Flume_185"></a>2.2.1. Flume配置文件</h4> 
<pre><code># Each channel's type is defined.
#agent.channels.memoryChannel.type = memory

# Other config values specific to each type of channel(sink or source)
# can be defined as well
# In this case, it specifies the capacity of the memory channel
#agent.channels.memoryChannel.capacity = 100
# Name the components on this agent
a1.sources = r1
a1.sinks = k1
a1.channels = c1

# Describe/configure the source
#a1.sources.r1.type = exec
#a1.sources.r1.command = tail -F /opt/log/ad-mini-portal3.log
a1.sources.r1.type = TAILDIR
a1.sources.r1.positionFile = /home/medchat/apache-flume-1.8.0-bin/logfile_stats/taildir_position.json
a1.sources.r1.filegroups = f1 f2 f3
a1.sources.r1.filegroups.f1 = /home/medchat/medchat-mini-portal/apache-tomcat/logs/doctor/ad-mini-portal.*log
a1.sources.r1.filegroups.f2 = /home/medchat/medchat-console/apache-tomcat-8.0.21/logs/console/ad-console.*log
a1.sources.r1.filegroups.f3 = /home/medchat/medchat-portal/apache-tomcat-8.0.21/logs/portal-yxck/ad-portal.*log
a1.sources.r1.fileHeader = true

# Describe the sink
a1.sinks.k1.type = org.apache.flume.sink.kafka.KafkaSink
a1.sinks.k1.kafka.bootstrap.servers= 172.17.176.160:9092,172.17.176.159:9092,172.17.176.158:9092
a1.sinks.k1.kafka.topic= adMiniPortal
a1.sinks.k1.serializer.class=kafka.serializer.StringEncoder
a1.sinks.k1.kafka.producer.acks=1
a1.sinks.k1.custom.encoding=UTF-8


# Use a channel which buffers events in memory
a1.channels.c1.type = memory
a1.channels.c1.capacity = 1000
a1.channels.c1.transactionCapacity = 100

# Bind the source and sink to the channel
a1.sources.r1.channels = c1
a1.sinks.k1.channel = c1
</code></pre> 
<p><img src="https://images2.imgbox.com/3d/17/jywHG5Uz_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23_StormKafkaHbase_231"></a>2.3. Storm消费Kafka数据，写入Hbase</h3> 
<h4><a id="231_LogReaderSpoutjava_232"></a>2.3.1. <code>LogReaderSpout.java</code></h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>rta<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>spouts<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Duration<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>ConsumerRecords<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>consumer<span class="token punctuation">.</span>KafkaConsumer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>spout<span class="token punctuation">.</span>SpoutOutputCollector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseRichSpout<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Fields<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Values<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>rta<span class="token punctuation">.</span>util<span class="token punctuation">.</span>KafkaUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>medchat<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span>PropConfigUtil<span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogReaderSpout</span> <span class="token keyword">extends</span> <span class="token class-name">BaseRichSpout</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> String TOPIC <span class="token operator">=</span> PropConfigUtil<span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"kafka.topic"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> KafkaConsumer<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> consumer<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> SpoutOutputCollector collector<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">open</span><span class="token punctuation">(</span>Map conf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">,</span> SpoutOutputCollector collector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>collector <span class="token operator">=</span> collector<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumer <span class="token operator">=</span> KafkaUtil<span class="token punctuation">.</span><span class="token function">getConsumer</span><span class="token punctuation">(</span>TOPIC<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">nextTuple</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        ConsumerRecords<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> String<span class="token punctuation">&gt;</span></span> messageList <span class="token operator">=</span> consumer<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>Duration<span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>message <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> null <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>collector<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Values</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        declarer<span class="token punctuation">.</span><span class="token function">declare</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Fields</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h4><a id="232_UserLogBoltjava_286"></a>2.3.2. <code>UserLogBolt.java</code></h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>rta<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>bolts<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span>Timestamp<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HashMap<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token keyword">import</span> net<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONArray<span class="token punctuation">;</span>
<span class="token keyword">import</span> net<span class="token punctuation">.</span>sf<span class="token punctuation">.</span>json<span class="token punctuation">.</span>JSONObject<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>BasicOutputCollector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseBasicBolt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>core<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>MarketingLogger<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span>HbaseUtil<span class="token punctuation">;</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>medchat<span class="token punctuation">.</span>core<span class="token punctuation">.</span>util<span class="token punctuation">.</span>DatetimeUtil<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserLogBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBasicBolt</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5627408245880685574</span>L<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> String tableName <span class="token operator">=</span> <span class="token string">"user_log"</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">,</span> BasicOutputCollector collector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String log <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getStringByField</span><span class="token punctuation">(</span><span class="token string">"value"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            JSONObject jsonObject <span class="token operator">=</span> JSONObject<span class="token punctuation">.</span><span class="token function">fromObject</span><span class="token punctuation">(</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">recordAll</span><span class="token punctuation">(</span>log<span class="token punctuation">,</span> jsonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">recordAds</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            MarketingLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//记录所有行为日志</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordAll</span><span class="token punctuation">(</span>String log<span class="token punctuation">,</span> JSONObject jsonObject<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        Timestamp timeStamp <span class="token operator">=</span> DatetimeUtil<span class="token punctuation">.</span><span class="token function">string2Timestamp</span><span class="token punctuation">(</span>jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"time"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String adServId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"adServId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String time <span class="token operator">=</span> DatetimeUtil<span class="token punctuation">.</span><span class="token function">date2StringDateTimeNoLine</span><span class="token punctuation">(</span>timeStamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">9</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String servId <span class="token operator">=</span> String<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%08d"</span><span class="token punctuation">,</span> Long<span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span>adServId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//rowKey:14位时间戳+8位servId+5位随机Id</span>
        String rowKey <span class="token operator">=</span> time <span class="token operator">+</span> <span class="token string">"|"</span> <span class="token operator">+</span> servId <span class="token operator">+</span> <span class="token string">"|"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
        Map<span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics function"><span class="token punctuation">&lt;</span>String<span class="token punctuation">,</span> Object<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"rowKey"</span><span class="token punctuation">,</span> rowKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"columnFamily"</span><span class="token punctuation">,</span> <span class="token string">"action"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"columnName"</span><span class="token punctuation">,</span> <span class="token string">"info"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"columnValue"</span><span class="token punctuation">,</span> log<span class="token punctuation">)</span><span class="token punctuation">;</span>
        HbaseUtil<span class="token punctuation">.</span><span class="token function">insertOnly</span><span class="token punctuation">(</span>tableName<span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">//广告统计相关</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordAds</span><span class="token punctuation">(</span>JSONObject jsonObject<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span>
        String adServId <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"adServId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String apiType <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"apiType"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>apiType<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">"@AD_INFO"</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            JSONArray jsonArray <span class="token operator">=</span> jsonObject<span class="token punctuation">.</span><span class="token function">getJSONArray</span><span class="token punctuation">(</span><span class="token string">"result"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String ids <span class="token operator">=</span> jsonArray<span class="token punctuation">.</span><span class="token function">getJSONObject</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getString</span><span class="token punctuation">(</span><span class="token string">"adId"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            String<span class="token punctuation">[</span><span class="token punctuation">]</span> idsArr <span class="token operator">=</span> ids<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>String id <span class="token operator">:</span> idsArr<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                String rowKey <span class="token operator">=</span> adServId <span class="token operator">+</span> <span class="token string">"|"</span> <span class="token operator">+</span> id<span class="token punctuation">;</span>
                HbaseUtil<span class="token punctuation">.</span><span class="token function">autoIncrementColumn</span><span class="token punctuation">(</span><span class="token string">"realtime_ad_stat"</span><span class="token punctuation">,</span> rowKey<span class="token punctuation">,</span> <span class="token string">"show_cnt"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="233_ToHbaseBoltjava_364"></a>2.3.3 <code>ToHbaseBolt.java</code></h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>rta<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>bolts<span class="token punctuation">;</span>

<span class="token keyword">import</span> java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
<span class="token keyword">import</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>conf<span class="token punctuation">.</span>Configuration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>HBaseConfiguration<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>TableName<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Connection<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>client<span class="token punctuation">.</span>ConnectionFactory<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Table<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>hadoop<span class="token punctuation">.</span>hbase<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Bytes<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>task<span class="token punctuation">.</span>TopologyContext<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>BasicOutputCollector<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>OutputFieldsDeclarer<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>topology<span class="token punctuation">.</span>base<span class="token punctuation">.</span>BaseBasicBolt<span class="token punctuation">;</span>
<span class="token keyword">import</span> org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>storm<span class="token punctuation">.</span>tuple<span class="token punctuation">.</span>Tuple<span class="token punctuation">;</span>

<span class="token keyword">import</span> com<span class="token punctuation">.</span>nuhtech<span class="token punctuation">.</span>marketing<span class="token punctuation">.</span>core<span class="token punctuation">.</span>logger<span class="token punctuation">.</span>MarketingLogger<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ToHbaseBolt</span> <span class="token keyword">extends</span> <span class="token class-name">BaseBasicBolt</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">long</span> serialVersionUID <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">5627408245880685574</span>L<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">transient</span> Table table<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">"rawtypes"</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">prepare</span><span class="token punctuation">(</span>Map stormConf<span class="token punctuation">,</span> TopologyContext context<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        Configuration conf <span class="token operator">=</span> HBaseConfiguration<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        conf<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"hbase.zookeeper.quorum"</span><span class="token punctuation">,</span> <span class="token string">"192.168.1.23:2181,192.168.1.24:2181,192.168.1.25:2181"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>Connection conn <span class="token operator">=</span> ConnectionFactory<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span>conf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            table <span class="token operator">=</span> conn<span class="token punctuation">.</span><span class="token function">getTable</span><span class="token punctuation">(</span>TableName<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">"realtime_ad_stat"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            MarketingLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span>Tuple input<span class="token punctuation">,</span> BasicOutputCollector collector<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        String action <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getStringByField</span><span class="token punctuation">(</span><span class="token string">"action"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        String rowkey <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getStringByField</span><span class="token punctuation">(</span><span class="token string">"rowkey"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Long pv <span class="token operator">=</span> input<span class="token punctuation">.</span><span class="token function">getLongByField</span><span class="token punctuation">(</span><span class="token string">"cnt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"view"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                table<span class="token punctuation">.</span><span class="token function">incrementColumnValue</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>rowkey<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"stat"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"view_cnt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"click"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>action<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                table<span class="token punctuation">.</span><span class="token function">incrementColumnValue</span><span class="token punctuation">(</span>Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>rowkey<span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"stat"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Bytes<span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span><span class="token string">"click_cnt"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pv<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            MarketingLogger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">declareOutputFields</span><span class="token punctuation">(</span>OutputFieldsDeclarer declarer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Do nothing</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="24_HiveHbasehttpsblogcsdnnetfanjianhaiarticledetails106016931_430"></a>2.4. <a href="https://blog.csdn.net/fanjianhai/article/details/106016931">Hive和Hbase的整合</a></h3> 
<h4><a id="241_HIveHbase_431"></a>2.4.1. HIve和Hbase的表关联</h4> 
<p><img src="https://images2.imgbox.com/c3/f0/lWTmSq45_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="242_Hive_433"></a>2.4.2. Hive数据样式</h4> 
<p><img src="https://images2.imgbox.com/35/9b/K6IglgHf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="243_Hbase_436"></a>2.4.3. Hbase数据样式</h4> 
<p><img src="https://images2.imgbox.com/c1/07/WiKrqctS_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="244_HiveHbase_438"></a>2.4.4. <code>Hive和Hbase关联后，操作一方同样会影响另一方数据</code></h4> 
<h3><a id="25_SqoopPostgreSqlHive_440"></a>2.5. 通过Sqoop把业务数据从PostgreSql导入Hive数仓</h3> 
<pre><code class="prism language-bash"><span class="token shebang important">#!/bin/bash</span>
<span class="token keyword">echo</span> <span class="token string">"sqoop coll start <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y-%m-%d,%H:%m:%s'</span><span class="token variable">`</span></span>"</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> $<span class="token comment"># -eq 3 ] ;then</span>
<span class="token keyword">echo</span> <span class="token string">"the args you input is right"</span>
CONNECTURL<span class="token operator">=</span><span class="token variable">$1</span>
USERNAME<span class="token operator">=</span><span class="token variable">$2</span>
PASSWORD<span class="token operator">=</span><span class="token variable">$3</span>
lastDay<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">date</span> -d <span class="token string">"yesterday"</span> +%Y-%m-%d<span class="token variable">`</span></span>
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table f_serv --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table f_serv --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table f_serv_identity --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table f_serv_identity --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table f_serv_base --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table f_serv_base --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table s_hospital --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table s_hospital --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table f_channel_subscribe --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table f_channel_subscribe --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table mr_editorial_board_member --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table mr_editorial_board_member --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table e_presidium_member --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table e_presidium_member --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table e_rostrum_member --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table e_rostrum_member --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table e_edu_member --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table e_edu_member --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table mr_article_read_record --columns <span class="token string">"read_record_id, article_id, serv_id, read_start_time, read_end_time, duration, update_datetime, create_datetime, thesis_type, spread_plan_id"</span> --where <span class="token string">"create_datetime::date='<span class="token variable">${lastDay}</span>'"</span> --hive-partition-key <span class="token string">"dt"</span> --hive-partition-value <span class="token string">"<span class="token variable">${lastDay}</span>"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table mr_article_read_record --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table mr_article_laud --columns <span class="token string">"article_laud_id, article_id, serv_id,update_datetime, create_datetime, thesis_type, spread_plan_id"</span> --where <span class="token string">"create_datetime::date='<span class="token variable">${lastDay}</span>'"</span> --hive-partition-key <span class="token string">"dt"</span> --hive-partition-value <span class="token string">"<span class="token variable">${lastDay}</span>"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table mr_article_laud --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table mr_article_comment --columns <span class="token string">"article_comment_id,article_id,serv_id,comment_type,ref_article_comment_id,content,ref_serv_id,status,update_datetime,create_datetime,content_original,thesis_type,spread_plan_id"</span> --where <span class="token string">"create_datetime::date='<span class="token variable">${lastDay}</span>'"</span> --hive-partition-key <span class="token string">"dt"</span> --hive-partition-value <span class="token string">"<span class="token variable">${lastDay}</span>"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">'\001'</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table mr_article_comment --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table mr_forward --columns <span class="token string">"forward_id,serv_id,forward_type,forward_channel,refer_id,status,update_datetime,create_datetime,content,source_serv_id,target_serv_ids,target_group_id"</span> --where <span class="token string">"create_datetime::date='<span class="token variable">${lastDay}</span>'"</span> --hive-partition-key <span class="token string">"dt"</span> --hive-partition-value <span class="token string">"<span class="token variable">${lastDay}</span>"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">'\001'</span> --hive-drop-import-delims --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table mr_forward --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table mr_favorite --columns <span class="token string">"favorite_id,serv_id,favorite_type,type,favorite_json,favorite_serv_id,refer_id,content,duration,favorite_url,status,update_datetime,create_datetime,file_size,refer_type"</span> --where <span class="token string">"create_datetime::date='<span class="token variable">${lastDay}</span>'"</span> --hive-partition-key <span class="token string">"dt"</span> --hive-partition-value <span class="token string">"<span class="token variable">${lastDay}</span>"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">'\001'</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table mr_favorite --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table sp_spread_plan --columns <span class="token string">"spread_plan_id,service_provider_id,scheme_id,audit_status,publish_status,release_date,exp_date,update_datetime,create_datetime"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">','</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table sp_spread_plan --hive-overwrite
sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --table sp_plan_filter --columns <span class="token string">"seq_nbr, spread_plan_id, serv_id, update_datetime, create_datetime"</span> --where <span class="token string">"create_datetime::date='<span class="token variable">${lastDay}</span>'"</span> --hive-partition-key <span class="token string">"dt"</span> --hive-partition-value <span class="token string">"<span class="token variable">${lastDay}</span>"</span> --null-string <span class="token string">'\\N'</span> --null-non-string <span class="token string">'\\N'</span> --fields-terminated-by <span class="token string">'\001'</span> --delete-target-dir --num-mappers 1 --hive-import --hive-database default --hive-table sp_plan_filter --hive-overwrite

hadoop fs -test -e /user/hive/warehouse/mr_plan_article
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -ne 0 <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span>
    sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --query <span class="token string">"select a.article_id,a.sale_article_id,b.spread_plan_id from mr_article a,sp_sale_article b where a.dispatch_type='SALE' and a.sale_article_id=b.sale_article_id and b.spread_plan_id is not null and \<span class="token variable">$CONDITIONS</span>"</span> --fields-terminated-by <span class="token string">'\001'</span> --m 1 --lines-terminated-by <span class="token string">'\n'</span> --hive-drop-import-delims --split-by article_id --target-dir /user/hive/warehouse/mr_plan_article
<span class="token keyword">else</span>
    hdfs dfs -rm -r /user/hive/warehouse/mr_plan_article
    sqoop <span class="token function">import</span> --connect <span class="token variable">$CONNECTURL</span> --username <span class="token variable">$USERNAME</span> --password <span class="token variable">$PASSWORD</span> --query <span class="token string">"select a.article_id,a.sale_article_id,b.spread_plan_id from mr_article a,sp_sale_article b where a.dispatch_type='SALE' and a.sale_article_id=b.sale_article_id and b.spread_plan_id is not null and \<span class="token variable">$CONDITIONS</span>"</span> --fields-terminated-by <span class="token string">'\001'</span> --m 1 --lines-terminated-by <span class="token string">'\n'</span> --hive-drop-import-delims --split-by article_id --target-dir /user/hive/warehouse/mr_plan_article
<span class="token keyword">fi</span>
<span class="token keyword">else</span>
<span class="token keyword">echo</span> <span class="token string">"the args you input is error"</span>
<span class="token keyword">fi</span>
<span class="token keyword">echo</span> <span class="token string">"sqoop coll end <span class="token variable"><span class="token variable">`</span><span class="token function">date</span> <span class="token string">'+%Y-%m-%d,%H:%m:%s'</span><span class="token variable">`</span></span>"</span>
</code></pre> 
<ul><li> <p><code>f_serv用户表</code><br> <img src="https://images2.imgbox.com/19/cd/yWRTLy8v_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>f_serv_identity用户身份信息表</code><br> <img src="https://images2.imgbox.com/bd/44/WEVAW0t8_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>f_serv_base用户基本信息表</code><br> <img src="https://images2.imgbox.com/e3/85/us3NNmGa_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>s_hospital医院表</code><br> <img src="https://images2.imgbox.com/9a/bc/6IM8qmda_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>f_channel_subscribe学科订阅表</code><br> <img src="https://images2.imgbox.com/45/1b/Zns2ZOBs_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>mr_editorial_board_member学术组织成员表</code><br> <img src="https://images2.imgbox.com/4c/7a/DCQV2uwy_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>e_presidium_member主席团成员表</code><br> <img src="https://images2.imgbox.com/97/e1/9wCkJu5r_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>e_rostrum_member主席台成员表</code><br> <img src="https://images2.imgbox.com/fa/70/FW3j6MFJ_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>e_edu_member会场成员表</code><br> <img src="https://images2.imgbox.com/8c/18/PYd2uRLp_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>mr_article_read_record文章阅读表</code><br> <img src="https://images2.imgbox.com/f9/4d/nFMRS2zs_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>mr_article_laud文章点赞表</code><br> <img src="https://images2.imgbox.com/34/ae/heervkq5_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>mr_article_comment文章评论表</code><br> <img src="https://images2.imgbox.com/65/43/ueCCobQt_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>mr_forward用户转发表</code><br> <img src="https://images2.imgbox.com/d4/60/VUBsodAT_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dd/3d/XEJ9IdQ0_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>mr_favorite用户收藏表</code><br> <img src="https://images2.imgbox.com/3b/d6/czWpJQqT_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>sp_spread_plan推广计划表</code><br> <img src="https://images2.imgbox.com/e0/82/dQF8ojaJ_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>sp_plan_filter广告过滤表</code><br> <img src="https://images2.imgbox.com/77/c2/GYwhXyzo_o.png" alt="在这里插入图片描述"></p> </li><li> <p><strong><code>注意点</code></strong></p> 
  <ul><li><a href="https://blog.csdn.net/CaptainJava/article/details/82625858">sqoop导入hive数据时对换行等特殊字符处理</a></li><li><a href="https://blog.csdn.net/jsjsjs1789/article/details/70093104">sqoop --split-by详解</a></li><li><a href="https://blog.csdn.net/lookqlp/article/details/84358608?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.nonecase&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-3.nonecase">关于sqoop --split-by 及 -m的理解</a></li></ul> </li></ul> 
<h2><a id="3__520"></a>3. 生成用户画像</h2> 
<h3><a id="31_hive_521"></a>3.1. hive分区设置</h3> 
<pre><code>set hive.exec.dynamic.partition=true;
set hive.exec.dynamic.partition.mode=nonstrict;
</code></pre> 
<h3><a id="32__527"></a>3.2. 用户登录日志</h3> 
<pre><code>insert overwrite table s_login_log partition(dt)    -- 分区
select
       get_json_object(info, '$.result[0].servId'),
       get_json_object(info, '$.modelName'),    -- 后台模型名称
       get_json_object(info, '$.channel') ,     -- terminal_type 终端类型
       get_json_object(info, '$.model'),        -- phone_model 手机机型
       get_json_object(info, '$.time'),         -- create_datetime 创建时间
       substr(get_json_object(info, '$.time'),1,10) -- 分区字段
from user_log
where
      get_json_object(info, '$.apiType')='LOGIN' and get_json_object(info, '$.operFlag')='true' and substr(get_json_object(info, '$.time'),1,10)='${hiveconf:lastDay}';

</code></pre> 
<p><img src="https://images2.imgbox.com/94/df/yiYk5c3f_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="33__545"></a>3.3. 用户终端类型和机型</h3> 
<pre><code>insert into serv_terminal
select
       serv_id,terminal_type,phone_model
from
    (select
            serv_id,terminal_type,phone_model,max(create_datetime)
    from s_login_log
    where dt='${hiveconf:lastDay}'
    group by
             serv_id,terminal_type,phone_model
    ) a;
</code></pre> 
<p><img src="https://images2.imgbox.com/db/65/ejoTBB3K_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="34__562"></a>3.4. 用户最高委员会职务</h3> 
<pre><code>insert overwrite table mr_newspaper_duty_highest
select
       serv_id,newspaper_title,newspaper_title_order
from
     (select row_number() over (partition by serv_id order by newspaper_title_order) top,*
     from
        (select t.serv_id,n.newspaper_title,n.newspaper_title_name,newspaper_title_order
        from
             mr_editorial_board_member t,mr_newspaper_title n
        where
              t.newspaper_title = n.newspaper_title
        )as b
    ) as c
where
      top&lt;=1
order by serv_id,newspaper_title_order;
</code></pre> 
<p><img src="https://images2.imgbox.com/9c/02/ofZClka1_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="35__583"></a>3.5. 用户信息</h3> 
<pre><code>insert overwrite table f_serv_info
select
       a.serv_id,a.identity,g.terminal_type,
       case when length(b.province_code)!=6 then null else b.province_code end  province_code,b.city_code,
       case when b.gender in('F','M') then b.gender else null end gender,
       case when a.identity='DOCTOR' and c.hospital_duty is not null then c.hospital_duty else 'DOC_QT' end hospital_duty,
       case when a.identity='DOCTOR' and c.hospital_title is not null then c.hospital_title else 'OTH' end hospital_title,
       case when a.identity='DOCTOR' then c.department_id else null end department_id,
       case when a.identity='DOCTOR'  and f.department_type_id is not null then f.department_type_id  else 27 end department_type_id,
       case when a.identity='DOCTOR' then d.hospital_id else null end hospital_id,
       case when a.identity='DOCTOR' and d.hospital_level!='' then d.hospital_level else null end hospital_level,
       e.newspaper_title
from f_serv a
left join f_serv_base b on(a.serv_id=b.serv_id)
left join f_serv_identity c on(a.serv_id=c.serv_id)
left join s_hospital d on(c.hospital_id=d.hospital_id)
left join mr_newspaper_duty_highest e on(a.serv_id=e.serv_id)
left join s_department f on(c.department_id=f.department_id)
left join serv_terminal g on(a.serv_id=g.serv_id)
where a.auth_flag in('Y','R');
</code></pre> 
<p><img src="https://images2.imgbox.com/3a/4e/QDz4fDPN_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="36__608"></a>3.6. 画像信息</h3> 
<ul><li> <p><code>个人信息标签</code></p> <pre><code>insert overwrite table f_serv_tag_value  partition(module='basic_info')
select
       serv_id, mp['key'], mp['value']
from(
    select a.serv_id,
             array(map('key', 'identity', 'value', a.identity),
                    map('key', 'device_type', 'value', a.terminal_type),
                    map('key', 'gender', 'value',a.gender),
                    map('key', 'province_code', 'value', a.province_code),
                    map('key', 'city_code', 'value', a.city_code),
                    map('key', 'hospital_id', 'value', a.hospital_id),
                    map('key', 'department_id', 'value', a.department_id),
                    map('key', 'department_type_id', 'value', a.department_type_id),
                    map('key', 'hospital_title', 'value', a.hospital_title),
                    map('key', 'hospital_duty', 'value', a.hospital_duty),
                    map('key', 'hospital_level', 'value', a.hospital_level)
                   ) arr
    from f_serv_info a
    ) s  lateral view explode(arr) arrtable as mp;
</code></pre> <p><img src="https://images2.imgbox.com/2e/8e/piAIqZ5v_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>频道标签</code></p> <pre><code>insert overwrite table f_serv_tag_value  partition(module='channel_subscribe')
select
       serv_id, mp['key'], mp['value']
from
     (select a.serv_id,array(map('key', 'channel_subscribe', 'value', a.channel_list)) arr
     from
          (select
               serv_id,concat_ws(',',collect_list(cast(channel_id as string))) as channel_list
          from
               f_channel_subscribe
          group by
               serv_id
          ) a
    )s  lateral view explode(arr) arrtable as mp;
</code></pre> <p><img src="https://images2.imgbox.com/f2/52/ZrqSGzje_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>委员会标签</code></p> <pre><code>insert overwrite table f_serv_tag_value  partition(module='newspaper_title')
select serv_id, mp['key'], mp['value']
from(
select a.serv_id,array(map('key', 'newspaper_title', 'value', a.newspaper_title)) arr
from (select serv_id,concat_ws(',',collect_set(newspaper_title)) newspaper_title from mr_editorial_board_member group by serv_id) a
)s  lateral view explode(arr) arrtable as mp;
</code></pre> <p><img src="https://images2.imgbox.com/3b/c3/MwdJ2Bp4_o.png" alt="在这里插入图片描述"></p> </li><li> <p><code>演讲台标签</code></p> <pre><code>insert overwrite table f_serv_tag_value  partition(module='edu')
select serv_id, mp['key'], mp['value']
from(
select b.serv_id,array(map('key', 'channel_edu', 'value', b.channel_edu_id)) arr
from (select serv_id,concat_ws(',',collect_set(cast(channel_edu_id as string))) channel_edu_id
from (select channel_edu_id,serv_id from e_presidium_member
union
select channel_edu_id,serv_id from e_rostrum_member
union
select channel_edu_id,serv_id from e_edu_member)  a group by serv_id) b
)s  lateral view explode(arr) arrtable as mp;
</code></pre> <p><img src="https://images2.imgbox.com/68/38/RxOUFRUS_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h3><a id="37__678"></a>3.7. 生成用户画像</h3> 
<pre><code>insert overwrite table f_serv_profile
select
    serv_id,
    concat('{', concat_ws(',', collect_set(concat('"', tag, '"', ':', '"', value, '"'))), '}') as json_string
from f_serv_tag_value where serv_id is not null
group by serv_id ;

insert into table serv_sysc select serv_id,profile from f_serv_profile ;
</code></pre> 
<p><img src="https://images2.imgbox.com/8b/5a/0wzBZP2U_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="4__693"></a>4. 推广效果分析</h2> 
<h3><a id="41__694"></a>4.1. 采集微论文曝光数据</h3> 
<pre><code>insert into table mr_article_show_record  partition(dt='${hiveconf:lastDay}')
select
       get_json_object(info, '$.apiType') apiType,
       num adId,
       get_json_object(info, '$.adServId') servId,
       get_json_object(info, '$.time') time
from user_log LATERAL VIEW explode(split(get_json_object(info, '$.result[0].adId'),',')) zqm AS num
where
      get_json_object(info, '$.apiType') like '%@ARTICLE_INFO' and substr(get_json_object(info, '$.time'),1,10)='${hiveconf:lastDay}';
</code></pre> 
<p><img src="https://images2.imgbox.com/23/57/4kfC2CzL_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="42__709"></a>4.2. 采集广告曝光数据</h3> 
<pre><code>insert overwrite table mr_ad_show_record  partition(dt='${hiveconf:lastDay}')
select
       get_json_object(info, '$.apiType') apiType,
       num adId,
       get_json_object(info, '$.adServId') servId,
       get_json_object(info, '$.time') time
from user_log LATERAL VIEW explode(split(get_json_object(info, '$.result[0].adId'),',')) zqm AS num
where
      get_json_object(info, '$.apiType') like '%@AD_INFO' and substr(get_json_object(info, '$.time'),1,10)='${hiveconf:lastDay}';
</code></pre> 
<p><img src="https://images2.imgbox.com/c8/a3/LLWFeBWE_o.png" alt="在这里插入图片描述"></p> 
<ul><li><code>合并微文论曝光数据</code><pre><code>insert into table mr_ad_show_record  partition(dt='${hiveconf:lastDay}')
select
       a.api_type,
       b.spread_plan_id,
       a.serv_id,
       a.show_time
from mr_article_show_record a,mr_plan_article b where a.article_id=b.article_id and a.dt='${hiveconf:lastDay}'
</code></pre> </li></ul> 
<h3><a id="43___733"></a>4.3. 曝光量多维度统计</h3> 
<pre><code>insert overwrite table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,
       b.identity,
       b.terminal_type,
       b.province_code,
       b.gender,
       b.hospital_duty,
       b.hospital_title,
       b.department_type_id,
       b.hospital_level,
       b.newspaper_title,
       'show' analysis_type,
       GROUPING__ID,
       count(a.serv_id) active_num
from mr_ad_show_record a
join f_serv_info b on(a.serv_id=b.serv_id)
where a.dt='${hiveconf:lastDay}'
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

-- 点击量多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'click' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select spread_plan_id,serv_id from mr_article_read_record where thesis_type='ADVERT' and dt='${hiveconf:lastDay}'
    union all
    select p.spread_plan_id,t.serv_id from mr_article_read_record t,mr_plan_article p where t.article_id=p.article_id and t.thesis_type='ARTICLE' and t.dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--阅读量多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'read' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select spread_plan_id,serv_id from mr_article_read_record where thesis_type='ADVERT' and duration&gt;=2 and dt='${hiveconf:lastDay}'
    union all
    select p.spread_plan_id,t.serv_id from mr_article_read_record t,mr_plan_article p where t.article_id=p.article_id and t.thesis_type='ARTICLE' and t.duration&gt;=2 and t.dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--点赞量多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'up' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select spread_plan_id,serv_id from mr_article_laud where thesis_type='ADVERT' and dt='${hiveconf:lastDay}'
    union all
    select p.spread_plan_id,t.serv_id from mr_article_laud t,mr_plan_article p where t.article_id=p.article_id and t.thesis_type='ARTICLE' and t.dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--评论量多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'comment' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select spread_plan_id,serv_id from mr_article_comment where thesis_type='ADVERT' and dt='${hiveconf:lastDay}'
    union all
    select p.spread_plan_id,t.serv_id from mr_article_comment t,mr_plan_article p where t.article_id=p.article_id and t.thesis_type='ARTICLE' and t.dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--收藏量多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'coll' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select refer_id spread_plan_id,serv_id from mr_favorite where refer_type='ADVERT' and dt='${hiveconf:lastDay}'
    union all
    select p.spread_plan_id,t.serv_id from mr_favorite t,mr_plan_article p where t.refer_id=p.article_id and t.refer_type='ARTICLE' and t.dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--转发量多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'forward' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select refer_id spread_plan_id,serv_id from mr_forward where forward_type='20' and dt='${hiveconf:lastDay}'
    union all
    select p.spread_plan_id,t.serv_id from mr_forward t,mr_plan_article p where t.refer_id=p.article_id and t.forward_type='1' and  t.dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--问卷多维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'answer' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select spread_plan_id,serv_id from sp_serv_reply where dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

--用户不敢兴趣维度统计
insert into table rp_spread_analysis_detail partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title,'filter' analysis_type,GROUPING__ID,count(a.serv_id) active_num
from
    (select spread_plan_id,serv_id from sp_plan_filter where dt='${hiveconf:lastDay}') a
join f_serv_info b on(a.serv_id=b.serv_id)
group by  a.spread_plan_id,b.identity,b.terminal_type,b.province_code,b.gender,b.hospital_duty,b.hospital_title,b.department_type_id,b.hospital_level,b.newspaper_title
grouping sets ((a.spread_plan_id,b.identity),(a.spread_plan_id,b.terminal_type),(a.spread_plan_id,b.province_code),(a.spread_plan_id,b.gender),(a.spread_plan_id,b.hospital_duty),(a.spread_plan_id,b.hospital_title),(a.spread_plan_id,b.department_type_id),(a.spread_plan_id,b.hospital_level),(a.spread_plan_id,b.newspaper_title));

</code></pre> 
<p><img src="https://images2.imgbox.com/34/7f/dasawl8W_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="44___851"></a>4.4. 不同维度进行曝光量的统计</h3> 
<pre><code>--统计身份维度
insert overwrite table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'identity' attr_type,a.identity attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,identity,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='11111111'
    group by spread_plan_id,identity) a;

--统计医院等级维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'hospitalLevel' attr_type,a.hospital_level attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select spread_plan_id,hospital_level,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='111111101'
    group by spread_plan_id,hospital_level) a;

--统计职称维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'hospitalTitle' attr_type,a.hospital_title attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,hospital_title,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='111110111'
    group by spread_plan_id,hospital_title) a;

--统计职务维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'hospitalDuty' attr_type,a.hospital_duty attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,hospital_duty,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='111101111'
    group by spread_plan_id,hospital_duty) a;

--统计性别维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'sex' attr_type,a.gender attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,gender,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='111011111'
    group by spread_plan_id,gender) a;
--统计机型维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'os' attr_type,a.terminal_type attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,terminal_type,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='101111111'
    group by spread_plan_id,terminal_type) a;
--统计省份维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'provinceCode' attr_type,a.province_code attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,province_code,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='110111111'
    group by spread_plan_id,province_code) a;

--统计科室分类维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
    a.spread_plan_id,'department' attr_type,a.department_id attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,department_id,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='111111011'
    group by spread_plan_id,department_id) a;

--统计委员会职务维度
insert into table rp_spread_analysis partition(dt='${hiveconf:lastDay}')
select
       a.spread_plan_id,'boardTitle' attr_type,a.newspaper_title attr_value,a.show_num,a.click_num,0 click_rate,a.read_num,a.up_num,a.comment_num,a.forward_num ,a.coll_num,'${hiveconf:lastDay}' total_date,a.answer_num,a.filter_num
from (
    select
        spread_plan_id,newspaper_title,
        sum(if(analysis_type='show',active_num,0)) as show_num,
        sum(if(analysis_type='click',active_num,0)) as click_num,
        sum(if(analysis_type='read',active_num,0)) as read_num ,
        sum(if(analysis_type='up',active_num,0)) as up_num ,
        sum(if(analysis_type='comment',active_num,0)) as comment_num,
        sum(if(analysis_type='coll',active_num,0)) as coll_num,
        sum(if(analysis_type='forward',active_num,0)) as forward_num,
        sum(if(analysis_type='answer',active_num,0)) as answer_num,
        sum(if(analysis_type='filter',active_num,0)) as filter_num
    from rp_spread_analysis_detail
    where dt='${hiveconf:lastDay}' and  bin(grouping_id)='111111110'
    group by spread_plan_id,newspaper_title) a;
</code></pre> 
<h3><a id="45__1031"></a>4.5. 统计日汇总维度</h3> 
<pre><code>insert overwrite table rp_spread partition(dt='${hiveconf:lastDay}')
select
       spread_plan_id,sum(show_num),sum(click_num),0,sum(read_num),sum(up_num),sum(comment_num),sum(forward_num),sum(coll_num),total_date,sum(answer_num),sum(filter_num)
from rp_spread_analysis
where total_date='${hiveconf:lastDay}'and attr_type='identity'
group by spread_plan_id,total_date;
</code></pre> 
<p><img src="https://images2.imgbox.com/ee/cd/LkqQ9K4W_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="46__1042"></a>4.6. 同步统计结果</h3> 
<pre><code>SELECT dboutput('${hiveconf:dbUrl}', '${hiveconf:userName}', '${hiveconf:password}', 'INSERT INTO rp_spread (spread_plan_id, show_num, click_num, read_num, up_num, comment_num, forward_num,coll_num,answer_num,filter_num, total_date,create_datetime) VALUES (?,?,?,?,?,?,?,?,?,?,?,?);', spread_plan_id, show_num, click_num, read_num, up_num, comment_num, forward_num,coll_num,answer_num,filter_num, total_date, current_timestamp)
FROM rp_spread where total_date='${hiveconf:lastDay}';

SELECT dboutput('${hiveconf:dbUrl}', '${hiveconf:userName}', '${hiveconf:password}', 'INSERT INTO rp_spreed_analysis (spread_plan_id, attr_type, attr_value, show_num, click_num, read_num, up_num, comment_num, forward_num, coll_num,answer_num,filter_num, total_date, create_datetime) VALUES (?,?,?,?,?,?,?,?,?,?,?,?,?,?);',spread_plan_id, attr_type, attr_value, show_num, click_num, read_num, up_num, comment_num, forward_num, coll_num,answer_num,filter_num, total_date, current_timestamp)
FROM rp_spread_analysis where total_date='${hiveconf:lastDay}';

SELECT dboutput('${hiveconf:dbUrl}', '${hiveconf:userName}', '${hiveconf:password}', 'INSERT INTO rp_analysis_log (log_type,log_info,create_datetime) VALUES (?,?,?);', 'item_analysis','success', current_timestamp);


</code></pre> 
<p><img src="https://images2.imgbox.com/20/71/FAdOi9NA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/de/15/B8iQeoFW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/99/af/L5aMT7qq_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="5__1061"></a>5. 知识点总结</h2> 
<h3><a id="51_Tomcat_1062"></a>5.1. Tomcat</h3> 
<h4><a id="511_Tomcathttpsblogcsdnnetweixin_39657319articledetails83268378_1063"></a>5.1.1. <a href="https://blog.csdn.net/weixin_39657319/article/details/83268378">Tomcat使用详细教程</a></h4> 
<h4><a id="512_windowslinux_httpsblogcsdnnetxqhrs232articledetails78403080_1064"></a>5.1.2. <a href="https://blog.csdn.net/xqhrs232/article/details/78403080">用脚本实现windows与linux之间文件的传输 </a></h4> 
<ul><li><a href="https://winscp.net/eng/docs/lang:chs" rel="nofollow"><code>WinSCP官网</code></a></li></ul> 
<h3><a id="52_Hive_Hql_1067"></a>5.2. Hive Hql常用方法总结</h3> 
<h4><a id="521_ROW_NUMBER_OVERhttpsjingyanbaiducomarticle9989c74604a644f648ecfef3html_1068"></a>5.2.1. <a href="https://jingyan.baidu.com/article/9989c74604a644f648ecfef3.html" rel="nofollow">ROW_NUMBER() OVER函数的基本用法</a></h4> 
<h4><a id="522_SQL_SELECT_CASE_WHEN_THENhttpsblogcsdnnetqq_34777600articledetails81699270_1070"></a>5.2.2. <a href="https://blog.csdn.net/qq_34777600/article/details/81699270">SQL语言-- SELECT CASE WHEN THEN</a></h4> 
<h4><a id="523_Hive_Lateral_View__explodehttpszhuanlanzhihucomp115913870_1072"></a>5.2.3. <a href="https://zhuanlan.zhihu.com/p/115913870" rel="nofollow">Hive列转行 (Lateral View + explode)详解</a></h4> 
<h4><a id="524_HiveSQLlateral_view_exploreconcat_wscollect_listcollect_sethttpsblogcsdnnetweixin_39043567articledetails90666521_1073"></a>5.2.4. <a href="https://blog.csdn.net/weixin_39043567/article/details/90666521">HiveSQL行转列lateral view explore()以及连接concat_ws()和列转行collect_list()&amp;collect_set()区别的使用案例</a></h4> 
<h4><a id="525_Hive_SQL_grouping_sets_httpswwwcnblogscomAllenrgp10648231html_1075"></a>5.2.5. <a href="https://www.cnblogs.com/Allen-rg/p/10648231.html" rel="nofollow">Hive SQL grouping sets 用法</a></h4> 
<h4><a id="526_hivelateral_view__explodehttpsblogcsdnnetguodong2karticledetails79459282_1076"></a>5.2.6. <a href="https://blog.csdn.net/guodong2k/article/details/79459282">hive中的lateral view 与 explode函数的使用</a></h4> 
<h2><a id="6__1078"></a>6. 寄语：知己知彼，不狂不馁，仔细地找准了自己生命的目标，板浆摇橹向人生茫茫之海努力划去。</h2>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/46f84bef3cbd47cad2d8a6b5e71bd80c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【内核调度】【休眠进程的唤醒】【wake_up_process】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/36359047d3bdffdb98abbbb8d7a5876e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【目标检测】Towards Accurate One-Stage Object Detection with AP-Loss</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>