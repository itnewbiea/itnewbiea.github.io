<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>canal&#43;rabbitmq解决mysql与redis缓存数据一致性问题 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="canal&#43;rabbitmq解决mysql与redis缓存数据一致性问题" />
<meta property="og:description" content="文章目录 1 mysql1.1 开启 MySQL的binlog1.2 重启mysql1.3 查看binlog是否已被开启1.4 修改密码策略1.5 新建canal用户并授权 2 rabbitmq2.1 拉取rabbitmq镜像2.2 运行rabbitmq镜像2.3 进入Rabbitmq Management 3 canal3.1 下载canal3.2 创建解压目录并解压3.3 修改配置文件3.3.1 conf/canal.properties3.3.2 conf/example/instance.properties 3.4 启动canal 4 Spring Boot集成rabbitmq4.1 在pom.xml中添加maven依赖4.2 yml文件4.3 RabbitConfig配置文件4.4 CanalMessage.java4.5 RabbitmqListener.java 1 mysql 1.1 开启 MySQL的binlog vi /etc/my.cnf log-bin=mysql-bin #开启 binlog binlog-format=ROW #选择 ROW 模式 server_id=1 #配置MySQL replaction需要定义，不要和canal的 slaveId重复 ROW：模式 除了记录sql语句之外，还会记录每个字段的变化情况，能够清楚的记录每行数据的变化历史，但会占用较多的空间。
STATEMENT：模式只记录了sql语句，但是没有记录上下文信息，在进行数据恢复的时候可能会导致数据的丢失情况；
MIX：模式比较灵活的记录，理论上说当遇到了表结构变更的时候，就会记录为statement模式。当遇到了数据更新或者删除情况下就会变为row模式；
1.2 重启mysql systemctl restart mysqld 1.3 查看binlog是否已被开启 SHOW VARIABLES LIKE &#39;log_bin&#39;; 1.4 修改密码策略 set global validate_password_policy=LOW; set global validate_password_length=5; 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/62b54bf0b49b6b1b2efd93cd401591b7/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-05-02T03:31:31+08:00" />
<meta property="article:modified_time" content="2022-05-02T03:31:31+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">canal&#43;rabbitmq解决mysql与redis缓存数据一致性问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><a href="#1_mysql_2" rel="nofollow">1 mysql</a></li><li><ul><li><a href="#11__MySQLbinlog_3" rel="nofollow">1.1 开启 MySQL的binlog</a></li><li><a href="#12_mysql_19" rel="nofollow">1.2 重启mysql</a></li><li><a href="#13_binlog_24" rel="nofollow">1.3 查看binlog是否已被开启</a></li><li><a href="#14__30" rel="nofollow">1.4 修改密码策略</a></li><li><a href="#15_canal_36" rel="nofollow">1.5 新建canal用户并授权</a></li></ul> 
   </li><li><a href="#2_rabbitmq_45" rel="nofollow">2 rabbitmq</a></li><li><ul><li><a href="#21_rabbitmq_47" rel="nofollow">2.1 拉取rabbitmq镜像</a></li><li><a href="#22_rabbitmq_51" rel="nofollow">2.2 运行rabbitmq镜像</a></li><li><a href="#23_Rabbitmq_Management_55" rel="nofollow">2.3 进入Rabbitmq Management</a></li></ul> 
   </li><li><a href="#3_canal_58" rel="nofollow">3 canal</a></li><li><ul><li><a href="#31_canal_59" rel="nofollow">3.1 下载canal</a></li><li><a href="#32__63" rel="nofollow">3.2 创建解压目录并解压</a></li><li><a href="#33__74" rel="nofollow">3.3 修改配置文件</a></li><li><ul><li><a href="#331_confcanalproperties_75" rel="nofollow">3.3.1 conf/canal.properties</a></li><li><a href="#332_confexampleinstanceproperties_92" rel="nofollow">3.3.2 conf/example/instance.properties</a></li></ul> 
    </li><li><a href="#34_canal_110" rel="nofollow">3.4 启动canal</a></li></ul> 
   </li><li><a href="#4_Spring_Bootrabbitmq_129" rel="nofollow">4 Spring Boot集成rabbitmq</a></li><li><ul><li><a href="#41_pomxmlmaven_130" rel="nofollow">4.1 在pom.xml中添加maven依赖</a></li><li><a href="#42_yml_139" rel="nofollow">4.2 yml文件</a></li><li><a href="#43_RabbitConfig_158" rel="nofollow">4.3 RabbitConfig配置文件</a></li><li><a href="#44_CanalMessagejava_255" rel="nofollow">4.4 CanalMessage.java</a></li><li><a href="#45_RabbitmqListenerjava_314" rel="nofollow">4.5 RabbitmqListener.java</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h3><a id="1_mysql_2"></a>1 mysql</h3> 
<h4><a id="11__MySQLbinlog_3"></a>1.1 开启 MySQL的binlog</h4> 
<pre><code class="prism language-powershell">vi <span class="token operator">/</span>etc/my<span class="token punctuation">.</span>cnf
</code></pre> 
<pre><code class="prism language-powershell">log-bin=mysql-bin <span class="token comment">#开启 binlog</span>
binlog-format=ROW <span class="token comment">#选择 ROW 模式</span>
server_id=1    <span class="token comment">#配置MySQL replaction需要定义，不要和canal的 slaveId重复</span>
</code></pre> 
<blockquote> 
 <p>ROW：模式 除了记录sql语句之外，还会记录每个字段的变化情况，能够清楚的记录每行数据的变化历史，但会占用较多的空间。<br> STATEMENT：模式只记录了sql语句，但是没有记录上下文信息，在进行数据恢复的时候可能会导致数据的丢失情况；<br> MIX：模式比较灵活的记录，理论上说当遇到了表结构变更的时候，就会记录为statement模式。当遇到了数据更新或者删除情况下就会变为row模式；</p> 
</blockquote> 
<h4><a id="12_mysql_19"></a>1.2 重启mysql</h4> 
<pre><code class="prism language-powershell">systemctl restart mysqld
</code></pre> 
<h4><a id="13_binlog_24"></a>1.3 查看binlog是否已被开启</h4> 
<pre><code class="prism language-powershell">SHOW VARIABLES LIKE <span class="token string">'log_bin'</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/de/5d/Msv2u04g_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="14__30"></a>1.4 修改密码策略</h4> 
<pre><code class="prism language-powershell"><span class="token function">set</span> global validate_password_policy=LOW<span class="token punctuation">;</span>
<span class="token function">set</span> global validate_password_length=5<span class="token punctuation">;</span>
</code></pre> 
<h4><a id="15_canal_36"></a>1.5 新建canal用户并授权</h4> 
<pre><code class="prism language-powershell">DROP USER <span class="token string">'canal'</span>@<span class="token string">'%'</span><span class="token punctuation">;</span>
CREATE USER <span class="token string">'canal'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'canal'</span><span class="token punctuation">;</span>  
GRANT ALL PRIVILEGES ON <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> TO <span class="token string">'canal'</span>@<span class="token string">'%'</span> IDENTIFIED BY <span class="token string">'canal'</span><span class="token punctuation">;</span>  
FLUSH PRIVILEGES<span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2_rabbitmq_45"></a>2 rabbitmq</h3> 
<p>因为使用Docker来安装rabbitmq比较方便，所以本文选用Docker进行安装，未安装Docker的请移步<a href="https://blog.csdn.net/dreaming9420/article/details/124082181?spm=1001.2014.3001.5501">Docker从零基础入门到使用</a>。</p> 
<h4><a id="21_rabbitmq_47"></a>2.1 拉取rabbitmq镜像</h4> 
<pre><code class="prism language-powershell">docker pull rabbitmq:3<span class="token punctuation">.</span>9<span class="token punctuation">.</span>16-management
</code></pre> 
<h4><a id="22_rabbitmq_51"></a>2.2 运行rabbitmq镜像</h4> 
<pre><code class="prism language-powershell">docker run <span class="token operator">-</span>d <span class="token operator">--</span>name rabbitmq-test <span class="token operator">--</span>hostname my-rabbit <span class="token operator">-</span>p 15672:15672 <span class="token operator">-</span>p 5672:5672 rabbitmq:3<span class="token punctuation">.</span>9<span class="token punctuation">.</span>16-management
</code></pre> 
<h4><a id="23_Rabbitmq_Management_55"></a>2.3 进入Rabbitmq Management</h4> 
<p>在浏览器地址栏中输入 ip:15672，默认Username和Password均为guest<br> <img src="https://images2.imgbox.com/51/39/7WijAkIi_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3_canal_58"></a>3 canal</h3> 
<h4><a id="31_canal_59"></a>3.1 下载canal</h4> 
<p><a href="https://github.com/alibaba/canal/releases/">下载地址</a><br> <img src="https://images2.imgbox.com/08/f8/aJdGmDDi_o.png" alt="在这里插入图片描述"><br> 下载之后通过XFTP或WinSCP上传到centos</p> 
<h4><a id="32__63"></a>3.2 创建解压目录并解压</h4> 
<ul><li>创建解压目录</li></ul> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">/</span>tmp/canal
</code></pre> 
<ul><li>解压</li></ul> 
<pre><code class="prism language-powershell">tar <span class="token operator">-</span>zxvf canal<span class="token punctuation">.</span>deployer-1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>5<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz <span class="token operator">-</span>C <span class="token operator">/</span>tmp/canal/
</code></pre> 
<h4><a id="33__74"></a>3.3 修改配置文件</h4> 
<h5><a id="331_confcanalproperties_75"></a>3.3.1 conf/canal.properties</h5> 
<pre><code class="prism language-powershell"> vi <span class="token operator">/</span>tmp/canal/conf/canal<span class="token punctuation">.</span>properties
</code></pre> 
<pre><code class="prism language-powershell">canal<span class="token punctuation">.</span>serverMode = rabbitMQ <span class="token comment">#设置服务器模式为rabbitMQ</span>
rabbitmq<span class="token punctuation">.</span>host =127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1 <span class="token comment">#ip</span>
rabbitmq<span class="token punctuation">.</span>virtual<span class="token punctuation">.</span>host = <span class="token operator">/</span> <span class="token comment">#虚拟主机</span>
rabbitmq<span class="token punctuation">.</span>exchange = mysql <span class="token comment">#交换机名称</span>
rabbitmq<span class="token punctuation">.</span>username = guest <span class="token comment">#用户名</span>
rabbitmq<span class="token punctuation">.</span>password =guest <span class="token comment">#密码</span>
rabbitmq<span class="token punctuation">.</span>deliveryMode = direct <span class="token comment">#交换机类型</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/e0/5a/zLNN36Cz_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/0c/5d/MWNDKI13_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ed/92/NchYNYFv_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="332_confexampleinstanceproperties_92"></a>3.3.2 conf/example/instance.properties</h5> 
<pre><code class="prism language-powershell"> vi <span class="token operator">/</span>tmp/canal/conf/example/instance<span class="token punctuation">.</span>properties
</code></pre> 
<pre><code class="prism language-powershell"><span class="token comment">## mysql serverId 不能与mysql的server_id一样</span>
canal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>slaveId = 1234
  
<span class="token comment">#mysql数据库ip:port</span>
canal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>master<span class="token punctuation">.</span>address = 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>1:3306 

<span class="token comment">#rabbitmq中exchange与queue进行绑定的路由键</span>
canal<span class="token punctuation">.</span>mq<span class="token punctuation">.</span>topic=mysql-binlog

<span class="token comment">#mysql数据库账号密码</span>
canal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>dbUsername = 
canal<span class="token punctuation">.</span>instance<span class="token punctuation">.</span>dbPassword = 
</code></pre> 
<h4><a id="34_canal_110"></a>3.4 启动canal</h4> 
<ul><li>进入canal启动目录</li></ul> 
<pre><code class="prism language-powershell">cd <span class="token operator">/</span>tmp/canal/bin
</code></pre> 
<p>假如服务器内存小，则<code>修改启动文件startup.sh的jvm参数</code>，否则会出现canal无法启动问题，或者是运行着出现com.alibaba.otter.canal.protocol.exception.CanalClientException: java.net.ConnectException</p> 
<pre><code class="prism language-powershell">vi startup<span class="token punctuation">.</span>sh
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/7b/9Ow70l5k_o.png" alt="在这里插入图片描述"></p> 
<ul><li>启动canal</li></ul> 
<pre><code class="prism language-powershell"><span class="token punctuation">.</span><span class="token operator">/</span>startup<span class="token punctuation">.</span>sh
</code></pre> 
<h3><a id="4_Spring_Bootrabbitmq_129"></a>4 Spring Boot集成rabbitmq</h3> 
<h4><a id="41_pomxmlmaven_130"></a>4.1 在pom.xml中添加maven依赖</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
	<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-amqp<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="42_yml_139"></a>4.2 yml文件</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">rabbitmq</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> localhost
    <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">5672</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">password</span><span class="token punctuation">:</span> guest
    <span class="token key atrule">publisher-confirms</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>  <span class="token comment"># 开启confirm模式，确保消息成功发送到交换器</span>
    <span class="token key atrule">listener</span><span class="token punctuation">:</span>
      <span class="token key atrule">type</span><span class="token punctuation">:</span> simple <span class="token comment"># 设置容器类型</span>
      <span class="token key atrule">simple</span><span class="token punctuation">:</span>
        <span class="token key atrule">default-requeue-rejected</span><span class="token punctuation">:</span> <span class="token boolean important">false</span> <span class="token comment"># basicReject或basicNack后不重新入队，使其进入死信队列</span>
        <span class="token key atrule">acknowledge-mode</span><span class="token punctuation">:</span> manual <span class="token comment"># 选择使用手动ack，不使用自动ack</span>
        <span class="token key atrule">retry</span><span class="token punctuation">:</span>
          <span class="token key atrule">enabled</span><span class="token punctuation">:</span> <span class="token boolean important">true</span> <span class="token comment"># 开启消息消费失败重试</span>
          <span class="token key atrule">max-attempts</span><span class="token punctuation">:</span> <span class="token number">5</span> <span class="token comment"># 重试次数</span>
          <span class="token key atrule">initial-interval</span><span class="token punctuation">:</span> <span class="token number">3000</span> <span class="token comment"># 重试时间间隔</span>
</code></pre> 
<h4><a id="43_RabbitConfig_158"></a>4.3 RabbitConfig配置文件</h4> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Logger</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">LoggerFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>connection<span class="token punctuation">.</span></span><span class="token class-name">ConnectionFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">RabbitTemplate</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>


<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RabbitConfig</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">exchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建一个Direct Exchange，设置为持久化，不自动删除</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">"mysql"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Exchange</span> <span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 死信Exchange</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DirectExchange</span><span class="token punctuation">(</span><span class="token string">"dead.letter.exchange"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/**
         *  durable=true 持久化queue的元数据
         *  exclusive = false 队列不独占，允许多个消费者访问
         *  autoDelete = false 当最后一个消费者断开连接之后队列是否自动被删除
         */</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> args <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置当前队列绑定的死信交换器</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-exchange"</span><span class="token punctuation">,</span> <span class="token string">"dead.letter.exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 配置当前队列的死信队列路由key，如果不设置默认为当前队列的路由key</span>
        args<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"x-dead-letter-routing-key"</span><span class="token punctuation">,</span> <span class="token string">"dead.letter.routing.key"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"binlog"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Queue</span> <span class="token function">deadLetterQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 死信Queue</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Queue</span><span class="token punctuation">(</span><span class="token string">"dead.letter.queue"</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">binding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 将上面的mysql Exchange与binlog Queue以"mysql-binlog"为路由键进行绑定，无参数</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span>
                <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">queue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">exchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">"mysql-binlog"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Binding</span> <span class="token function">deadLetterBinding</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 绑定死信Queue与死信Exchange</span>
        <span class="token keyword">return</span> <span class="token class-name">BindingBuilder</span>
                <span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token function">deadLetterQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">to</span><span class="token punctuation">(</span><span class="token function">deadLetterExchange</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token string">"dead.letter.routing.key"</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">noargs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">RabbitTemplate</span> <span class="token function">createRabbitTemplate</span><span class="token punctuation">(</span><span class="token class-name">ConnectionFactory</span> connectionFactory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">RabbitTemplate</span> rabbitTemplate <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RabbitTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConnectionFactory</span><span class="token punctuation">(</span>connectionFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 开启强制委托模式</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setMandatory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// ack=true表示Exchange接收到了消息</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setConfirmCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>correlationData<span class="token punctuation">,</span> ack<span class="token punctuation">,</span> cause<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>ack<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"消息已发送到Exchange"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"消息未能发送到Exchange,{}"</span><span class="token punctuation">,</span> cause<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 当消息发送给Exchange后，Exchange路由到Queue失败时会执行ReturnCallBack</span>
        rabbitTemplate<span class="token punctuation">.</span><span class="token function">setReturnCallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span>message<span class="token punctuation">,</span> replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span> <span class="token operator">-&gt;</span>
                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"mq消息不可达,message:{},replyCode:{},replyText:{},exchange:{},routing:{}"</span><span class="token punctuation">,</span>
                        message<span class="token punctuation">,</span> replyCode<span class="token punctuation">,</span> replyText<span class="token punctuation">,</span> exchange<span class="token punctuation">,</span> routingKey<span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> rabbitTemplate<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="44_CanalMessagejava_255"></a>4.4 CanalMessage.java</h4> 
<pre><code class="prism language-powershell">import lombok<span class="token punctuation">.</span><span class="token keyword">Data</span><span class="token punctuation">;</span>

import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Map<span class="token punctuation">;</span>

@<span class="token keyword">Data</span>
public <span class="token keyword">class</span> CanalMessage&lt;T&gt; <span class="token punctuation">{<!-- --></span>

    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 更新后的数据
     <span class="token operator">*</span><span class="token operator">/</span>
    private List&lt;T&gt; <span class="token keyword">data</span><span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 数据库名
     <span class="token operator">*</span><span class="token operator">/</span>
    private String database<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> binlog executeTime<span class="token punctuation">,</span> 执行耗时
     <span class="token operator">*</span><span class="token operator">/</span>
    private long es<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> id
     <span class="token operator">*</span><span class="token operator">/</span>
    private int id<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 标识是否是ddl语句，比如create table/drop table
     <span class="token operator">*</span><span class="token operator">/</span>
    private boolean isDdl<span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 更新前的有变更的列的数据
     <span class="token operator">*</span><span class="token operator">/</span>
    private List&lt;Map&lt;String<span class="token punctuation">,</span> Object&gt;&gt; old<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 主键字段名
     <span class="token operator">*</span><span class="token operator">/</span>
    private List&lt;String&gt; pkNames<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> ddl/query的sql语句
     <span class="token operator">*</span><span class="token operator">/</span>
    private String sql<span class="token punctuation">;</span>

    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 表名
     <span class="token operator">*</span><span class="token operator">/</span>
    private String table<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> dml build timeStamp
     <span class="token operator">*</span><span class="token operator">/</span>
    private long ts<span class="token punctuation">;</span>
    <span class="token operator">/</span><span class="token operator">*</span><span class="token operator">*</span>
     <span class="token operator">*</span> 事件类型:INSERT/UPDATE/DELETE
     <span class="token operator">*</span><span class="token operator">/</span>
    private String <span class="token function">type</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="45_RabbitmqListenerjava_314"></a>4.5 RabbitmqListener.java</h4> 
<pre><code class="prism language-powershell">import com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>fastjson<span class="token punctuation">.</span>JSON<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>company<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>CanalMessage<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>company<span class="token punctuation">.</span>springboot<span class="token punctuation">.</span>sys<span class="token punctuation">.</span>entity<span class="token punctuation">.</span>User<span class="token punctuation">;</span>
import com<span class="token punctuation">.</span>rabbitmq<span class="token punctuation">.</span>client<span class="token punctuation">.</span>Channel<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>Logger<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span>LoggerFactory<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Exchange<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Queue<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>QueueBinding<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>rabbit<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>RabbitListener<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>amqp<span class="token punctuation">.</span>support<span class="token punctuation">.</span>AmqpHeaders<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span><span class="token keyword">data</span><span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span>RedisTemplate<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Header<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>messaging<span class="token punctuation">.</span>handler<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Payload<span class="token punctuation">;</span>
import org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span>Component<span class="token punctuation">;</span>

import javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>Resource<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>io<span class="token punctuation">.</span>IOException<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span>StandardCharsets<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>time<span class="token punctuation">.</span>Duration<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>List<span class="token punctuation">;</span>
import java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>Random<span class="token punctuation">;</span>

@Component
public <span class="token keyword">class</span> RabbitmqListener <span class="token punctuation">{<!-- --></span>

    @Resource
    private RedisTemplate&lt;String<span class="token punctuation">,</span> Object&gt; redisTemplate<span class="token punctuation">;</span>

    private final Logger logger = LoggerFactory<span class="token punctuation">.</span>getLogger<span class="token punctuation">(</span>getClass<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    @RabbitListener<span class="token punctuation">(</span>bindings = @QueueBinding<span class="token punctuation">(</span>value = @Queue<span class="token punctuation">(</span>value = <span class="token string">"binlog"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exchange = @Exchange<span class="token punctuation">(</span>value = <span class="token string">"mysql"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    public void businessQueue<span class="token punctuation">(</span>@Payload byte<span class="token punctuation">[</span><span class="token punctuation">]</span> message<span class="token punctuation">,</span> Channel channel<span class="token punctuation">,</span> @Header<span class="token punctuation">(</span>AmqpHeaders<span class="token punctuation">.</span>DELIVERY_TAG<span class="token punctuation">)</span> long deliveryTag<span class="token punctuation">)</span> throws IOException <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">/</span><span class="token operator">/</span> canal发送到rabbitmq的消息默认为二进制字节流，无法看懂，所以将二进制字节流转换为String类型
            String realMessage = new String<span class="token punctuation">(</span>message<span class="token punctuation">,</span> StandardCharsets<span class="token punctuation">.</span>UTF_8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">/</span><span class="token operator">/</span> 将String转换为对象类型
            CanalMessage&lt;User&gt; canalMessage = JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>realMessage<span class="token punctuation">,</span> CanalMessage<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token operator">/</span><span class="token operator">/</span> 只针对test数据库中的user表
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"test"</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>canalMessage<span class="token punctuation">.</span>getDatabase<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> &amp;&amp; <span class="token string">"user"</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>canalMessage<span class="token punctuation">.</span>getTable<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"UPDATE"</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>canalMessage<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token string">"INSERT"</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>canalMessage<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token operator">/</span><span class="token operator">/</span> userList不能直接等于canalMessage<span class="token punctuation">.</span>getData<span class="token punctuation">(</span><span class="token punctuation">)</span>，否则会出现类型无法转换问题
                    List&lt;User&gt; userList = JSON<span class="token punctuation">.</span>parseArray<span class="token punctuation">(</span>JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>realMessage<span class="token punctuation">)</span><span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>User user : userList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span>user<span class="token punctuation">.</span>toString<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span>opsForValue<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"user::"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>getId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> user<span class="token punctuation">,</span> Duration<span class="token punctuation">.</span>ofSeconds<span class="token punctuation">(</span>60 <span class="token operator">*</span> 60 <span class="token operator">+</span> new Random<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>nextInt<span class="token punctuation">(</span>60 <span class="token operator">*</span> 10<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">"DELETE"</span><span class="token punctuation">.</span>equals<span class="token punctuation">(</span>canalMessage<span class="token punctuation">.</span>getType<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    List&lt;User&gt; userList = JSON<span class="token punctuation">.</span>parseArray<span class="token punctuation">(</span>JSON<span class="token punctuation">.</span>parseObject<span class="token punctuation">(</span>realMessage<span class="token punctuation">)</span><span class="token punctuation">.</span>getString<span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span>User user : userList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        redisTemplate<span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token string">"user::"</span> <span class="token operator">+</span> user<span class="token punctuation">.</span>getId<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token operator">/</span><span class="token operator">/</span> 手动ack<span class="token punctuation">,</span>确认消息已被消费
            channel<span class="token punctuation">.</span>basicAck<span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>Exception e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">/</span><span class="token operator">/</span> requeue=false 表示被拒绝的消息进入死信队列
            channel<span class="token punctuation">.</span>basicNack<span class="token punctuation">(</span>deliveryTag<span class="token punctuation">,</span> false<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span>printStackTrace<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    @RabbitListener<span class="token punctuation">(</span>bindings = @QueueBinding<span class="token punctuation">(</span>value = @Queue<span class="token punctuation">(</span>value = <span class="token string">"dead.letter.queue"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exchange = @Exchange<span class="token punctuation">(</span>value = <span class="token string">"dead.letter.exchange"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    public void deadLetterQueue<span class="token punctuation">(</span>@Payload byte<span class="token punctuation">[</span><span class="token punctuation">]</span> message<span class="token punctuation">,</span> Channel channel<span class="token punctuation">,</span> @Header<span class="token punctuation">(</span>AmqpHeaders<span class="token punctuation">.</span>DELIVERY_TAG<span class="token punctuation">)</span> long deliveryTag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
       logger<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">"死信队列业务逻辑"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7c0c6417aad8e9e0a40c9d7f2233ae36/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">VSCode无go的代码提示</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b8b2a150c368b69eba5f170d8d3f448b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">单片机常用的几种字符串处理函数对比记录</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>