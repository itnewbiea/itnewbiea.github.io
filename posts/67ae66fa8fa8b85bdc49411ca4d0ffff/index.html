<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Node.js之 EventEmitter - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Node.js之 EventEmitter" />
<meta property="og:description" content="大多数 Node.js 核心 API 构建于惯用的异步事件驱动架构，其中某些类型的对象（又称触发器，Emitter）会触发命名事件来调用函数（又称监听器，Listener）。 例如，net.Server 会在每次有新连接时触发事件，fs.ReadStream 会在打开文件时触发事件，stream会在数据可读时触发事件。
从官网上的这段话，我们能获取到的信息就是，Node.js 的核心 API 是使用的一套共同的异步事件驱动，因此这个肯定会独立成一个专属的类。今天我们一起学习这个类 EventEmitter。
EventEmitter 所有能触发事件的对象都是 EventEmitter 类的实例。 这些对象有一个 eventEmitter.on() 函数，用于将一个或多个函数绑定到命名事件上。 事件的命名通常是驼峰式的字符串，但也可以使用任何有效的 JavaScript 属性键。
先来一个简单的示例 const { EventEmitter } = require(&#39;events&#39;) const eventEmitter = new EventEmitter() // 添加事件回调 eventEmitter.on(&#39;say&#39;, () =&gt; { console.log(&#39;say hello&#39;); }) setTimeout(() =&gt; { eventEmitter.emit(&#39;say&#39;) }, 1000) console.log(&#39;执行结束！&#39;); // 执行结果 // 执行结束！ // say hello 通过观察上面的方法，可以得出的是： 通过 on 注册事件，等同 addListener(event, listener)；可以异步触发监听的事件。 再看 const { EventEmitter } = require(&#39;events&#39;) const eventEmitter = new EventEmitter() eventEmitter." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/67ae66fa8fa8b85bdc49411ca4d0ffff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-06T10:15:05+08:00" />
<meta property="article:modified_time" content="2021-01-06T10:15:05+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Node.js之 EventEmitter</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>大多数 Node.js 核心 API 构建于惯用的异步事件驱动架构，其中某些类型的对象（又称触发器，Emitter）会触发命名事件来调用函数（又称监听器，Listener）。 例如，net.Server 会在每次有新连接时触发事件，fs.ReadStream 会在打开文件时触发事件，stream会在数据可读时触发事件。</p> 
</blockquote> 
<p>从官网上的这段话，我们能获取到的信息就是，Node.js 的核心 API 是使用的一套共同的异步事件驱动，因此这个肯定会独立成一个专属的类。今天我们一起学习这个类 <code>EventEmitter</code>。</p> 
<h3><a id="EventEmitter_5"></a><code>EventEmitter</code></h3> 
<blockquote> 
 <p>所有能触发事件的对象都是 EventEmitter 类的实例。 这些对象有一个 eventEmitter.on() 函数，用于将一个或多个函数绑定到命名事件上。 事件的命名通常是驼峰式的字符串，但也可以使用任何有效的 JavaScript 属性键。</p> 
</blockquote> 
<h4><a id="_7"></a>先来一个简单的示例</h4> 
<pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> EventEmitter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 添加事件回调</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'say hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行结束！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行结果</span>
<span class="token comment">// 执行结束！</span>
<span class="token comment">// say hello</span>
</code></pre> 
<h5><a id="_27"></a>通过观察上面的方法，可以得出的是：</h5> 
<ol><li>通过 <code>on</code> 注册事件，等同 <code>addListener(event, listener)</code>；</li><li>可以异步触发监听的事件。</li></ol> 
<h4><a id="_31"></a>再看</h4> 
<pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> EventEmitter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener2'</span><span class="token punctuation">,</span> argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener3'</span><span class="token punctuation">,</span> argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token string">'xx'</span> <span class="token comment">// 设置返回值</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// prependListener 添加 listener 函数到名为 eventName 的事件的监听器数组的开头。</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">prependListener</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'prependListener'</span><span class="token punctuation">,</span> argv1<span class="token punctuation">,</span> argv2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'listener1'</span><span class="token punctuation">,</span> <span class="token string">'argv1'</span><span class="token punctuation">,</span> <span class="token string">'argv2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行结束！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行结果</span>
<span class="token comment">// 执行结束！</span>
<span class="token comment">// prependListener argv1 argv2</span>
<span class="token comment">// listener1 argv1 argv2</span>
<span class="token comment">// listener2 argv1 argv2</span>
<span class="token comment">// listener3 argv1 argv2</span>
</code></pre> 
<h5><a id="_63"></a>由上面的示例可以得出：</h5> 
<ol><li>同一个监听事件，可以有多个监听；</li><li>同一个事件，添加监听器，是有一个监听器数组统一控制，主要体现在执行顺序上；</li><li>被调用的监听器返回的任何值都将会被忽略并丢弃。</li></ol> 
<h4><a id="_68"></a>再看</h4> 
<pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> EventEmitter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

eventEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行结束！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 执行结束！</span>
<span class="token comment">// 111</span>
<span class="token comment">// 222</span>
</code></pre> 
<h5><a id="_89"></a>由上面的示例可以得出：</h5> 
<ol><li>返回对 EventEmitter 的引用，以便可以链式调用。</li></ol> 
<h5><a id="_92"></a>接下来看</h5> 
<pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> EventEmitter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// setMaxListeners 为特定事件设置监听数量</span>
eventEmitter<span class="token punctuation">.</span><span class="token function">setMaxListeners</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">444</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 获取特定事件的监听器连接数</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>eventEmitter<span class="token punctuation">.</span><span class="token function">listenerCount</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
  eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'say'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行结束！'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 4</span>
<span class="token comment">// 执行结束！</span>
<span class="token comment">// (node:7748) MaxListenersExceededWarning: Possible EventEmitter memory leak detected. 4 say listeners added. Use emitter.setMaxListeners() to increase limit</span>
<span class="token comment">// 111</span>
<span class="token comment">// 222</span>
<span class="token comment">// 333</span>
<span class="token comment">// 444</span>
</code></pre> 
<h5><a id="_128"></a>由上面的示例可以得出：</h5> 
<ol><li>如果为特定事件添加了超过了设置的监听器数量，则 EventEmitter 会打印一个警告。 这有助于发现内存泄露。</li><li>listenerCount(‘listenerName’) 获取特定事件的监听器连接数</li></ol> 
<h4><a id="_132"></a>最后看</h4> 
<pre><code class="prism language-js"><span class="token keyword">const</span> <span class="token punctuation">{<!-- --></span> EventEmitter <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> eventEmitter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

eventEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span>
<span class="token comment">// events.js:189</span>
<span class="token comment">//     throw err; // Unhandled 'error' event</span>
<span class="token comment">//     ^</span>

<span class="token comment">// Error [ERR_UNHANDLED_ERROR]: Unhandled error. (undefined)</span>
<span class="token comment">//     at EventEmitter.emit (events.js:187:17)</span>
<span class="token comment">//     at Object.&lt;anonymous&gt; (C:\Users\admin\Desktop\blogs\node\demo.js:71:14) </span>
<span class="token comment">//     at Module._compile (internal/modules/cjs/loader.js:778:30)</span>
<span class="token comment">//     at Object.Module._extensions..js (internal/modules/cjs/loader.js:789:10)</span>
<span class="token comment">//     at Module.load (internal/modules/cjs/loader.js:653:32)</span>
<span class="token comment">//     at tryModuleLoad (internal/modules/cjs/loader.js:593:12)</span>
<span class="token comment">//     at Function.Module._load (internal/modules/cjs/loader.js:585:3)</span>
<span class="token comment">//     at Function.Module.runMain (internal/modules/cjs/loader.js:831:12)      </span>
<span class="token comment">//     at startup (internal/bootstrap/node.js:283:19)</span>
<span class="token comment">//     at bootstrapNodeJSCore (internal/bootstrap/node.js:623:3)</span>
</code></pre> 
<h4><a id="_154"></a>总结：</h4> 
<ol><li>EventEmitter 定义了一个特殊的事件 error，它包含了错误的语义，我们在遇到 异常的时候通常会触发 error 事件。当 error 被触发时，EventEmitter 规定如果没有响 应的监听器，Node.js 会把它当作异常，退出程序并输出错误信息。</li><li>所以我们最好先定义一个 <code>eventEmitter.on('error', callback)</code></li></ol> 
<h4><a id="EventEmitter__159"></a><code>EventEmitter</code> 的常用方法</h4> 
<ol><li><code>once(event, listener)</code>: 为指定事件注册一个单次监听器，即 监听器最多只会触发一次，触发后立刻解除该监听器。</li><li><code>removeListener(event, listener)</code>: 移除指定事件的某个监听器，监听器必须是该事件已经注册过的监听器。 它接受两个参数，第一个是事件名称，第二个是回调函数名称。</li><li><code>removeAllListeners([event])</code>: 移除所有事件的所有监听器， 如果指定事件，则移除指定事件的所有监听器。</li><li><code>listeners(event)</code>: 返回指定事件的监听器数组。</li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/c899dd4da2eadfceaf9f379e1b692d02/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">手把手教你vue3.0项目搭建</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/df592ebe9fd6d0b01cebb684e5c9f805/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">图片标注工具Labelme-简明使用教程</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>