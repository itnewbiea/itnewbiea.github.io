<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>配置普通linux平台用户访问k8s集群 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="配置普通linux平台用户访问k8s集群" />
<meta property="og:description" content="生产环境对于业务的稳定性要求是相当高的，为了防止误操作，通常是通过不同的账号与权限来进行限制的。对于k8s集群而言，部署的时候通常是以linux root用户的身份进行部署的，k8s的安全机制是，认证、鉴权、准入控制；意味着除root用户外，其他普通用户不具备请求k8s集群资源的权限。普通用户访问k8s资源需要做认证与授权操作。
认证： 1、查看
认证之前首先查看普通用户（自定义的普通用户zs）访问k8s集群报什么错
[root@master01 ~]# su - zs
[zs@master01 ~]$ kubectl get nodes
报错提示：连接到本机8080端口的服务被拒绝了，是否指明了正确的主机或者端口。即不能与apiserver交互。
2、创建证书（切回root用户）
[root@master01 ~]# cd /etc/kubernetes/pki/ [root@master01 pki]# openssl genrsa -out zs.key 2048 [root@master01 pki]# openssl req -new -key zs.key -out zs.csr -subj &#34;/CN=zs/O=zs&#34;
[root@master01 pki]# openssl x509 -req -in zs.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out zs.crt -days 3650
3、查看、设置集群、用户、上下文信息
查看集群信息、因为我之前做高可用，所以监听的端口是16443而不是6443，正常情况下默认是6443。
[zs@master01 ~]$ kubectl cluster-info
设置名为kubernetes集群
[root@master01 pki]# kubectl config set-cluster kubernetes --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/318f9b667298cfde64a397d62886c607/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-28T08:46:53+08:00" />
<meta property="article:modified_time" content="2023-01-28T08:46:53+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">配置普通linux平台用户访问k8s集群</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="margin-left:.0001pt;text-align:justify;">生产环境对于业务的稳定性要求是相当高的，为了防止误操作，通常是通过不同的账号与权限来进行限制的。对于k8s集群而言，部署的时候通常是以linux root用户的身份进行部署的，k8s的安全机制是，认证、鉴权、准入控制；意味着除root用户外，其他普通用户不具备请求k8s集群资源的权限。普通用户访问k8s资源需要做认证与授权操作。</p> 
<h3 style="text-align:justify;"><strong>认证：</strong></h3> 
<p style="margin-left:.0001pt;text-align:justify;">1、查看</p> 
<p style="margin-left:.0001pt;text-align:justify;">认证之前首先查看普通用户（自定义的普通用户zs）访问k8s集群报什么错</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 ~]# su - zs</p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl get  nodes</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="71" src="https://images2.imgbox.com/c6/56/vyg6q7sk_o.png" width="691"></p> 
<p style="margin-left:.0001pt;text-align:justify;">报错提示：连接到本机8080端口的服务被拒绝了，是否指明了正确的主机或者端口。即不能与apiserver交互。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="text-align:justify;">2、创建证书（切回root用户）</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 ~]# cd /etc/kubernetes/pki/       </p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# openssl genrsa -out zs.key 2048  </p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# openssl req -new -key zs.key -out zs.csr -subj "/CN=zs/O=zs"</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# openssl x509 -req -in zs.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out zs.crt -days 3650</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="text-align:justify;">3、查看、设置集群、用户、上下文信息</p> 
<p style="margin-left:.0001pt;text-align:justify;">查看集群信息、因为我之前做高可用，所以监听的端口是16443而不是6443，正常情况下默认是6443。</p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl  cluster-info</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="71" src="https://images2.imgbox.com/60/53/TJlXtLWy_o.png" width="692"></p> 
<p style="margin-left:.0001pt;text-align:justify;">设置名为kubernetes集群</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# kubectl  config  set-cluster  kubernetes --embed-certs=true  --certificate-authority=/etc/kubernetes/pki/ca.crt  --server=https://192.168.11.200:16443</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">设置用户</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# kubectl  config  set-credentials  zs --embed-certs=true --client-certificate=/etc/kubernetes/pki/zs.crt  --client-key=/etc/kubernetes/pki/zs.key</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">设置上下文信息</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# kubectl  config  set-context  zs@kubernetes  --cluster=kubernetes  --user=zs</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="text-align:justify;">4、拷贝证书文件即集群文件至普通用户家目录，并更改归属关系</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# mkdir /home/zs/.kube</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# cp zs.key zs.crt  zs.csr  /home/zs/</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# cp /root/.kube/config  /home/zs/.kube/</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 pki]# chown -R zs:zs /home/zs/</p> 
<p style="margin-left:.0001pt;text-align:justify;">此时认证已经完成，但是认证完成并不代表你有任何权限访问集群资源</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<h3 style="text-align:justify;"><strong>授权</strong></h3> 
<p style="margin-left:.0001pt;text-align:justify;">授权即创建角色，并将角色与对象绑定</p> 
<p style="text-align:justify;">1、创建Clusterrole与Clusterrolebinding，即用户与权限绑定实现用户对资源的请求操作</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 test]# kubectl  apply  -f  zs.clusterrrole.clusterrolebind.yml</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 test]# cat zs.clusterrole.clusterrolebind.yml</p> 
<p style="margin-left:.0001pt;text-align:justify;">---</p> 
<p style="margin-left:.0001pt;text-align:justify;">apiVersion: rbac.authorization.k8s.io/v1</p> 
<p style="margin-left:.0001pt;text-align:justify;">kind: ClusterRole</p> 
<p style="margin-left:.0001pt;text-align:justify;">metadata:</p> 
<p style="margin-left:.0001pt;text-align:justify;">  name: zsclusterrole</p> 
<p style="margin-left:.0001pt;text-align:justify;">rules:</p> 
<p style="margin-left:.0001pt;text-align:justify;">- apiGroups: ["*"] # "" 表示所有api组</p> 
<p style="margin-left:.0001pt;text-align:justify;">  resources: ["*"] #*表示所有资源</p> 
<p style="margin-left:.0001pt;text-align:justify;">  verbs: ["list","watch","get"]  </p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">---</p> 
<p style="margin-left:.0001pt;text-align:justify;">apiVersion: rbac.authorization.k8s.io/v1</p> 
<p style="margin-left:.0001pt;text-align:justify;">kind: ClusterRoleBinding</p> 
<p style="margin-left:.0001pt;text-align:justify;">metadata:</p> 
<p style="margin-left:.0001pt;text-align:justify;">  name: zsclusterrolebinding</p> 
<p style="margin-left:.0001pt;text-align:justify;">subjects:</p> 
<p style="margin-left:.0001pt;text-align:justify;"># 你可以指定不止一个“subject（主体）”</p> 
<p style="margin-left:.0001pt;text-align:justify;">- kind: User</p> 
<p style="margin-left:.0001pt;text-align:justify;">  name: zs # "name" 是区分大小写的</p> 
<p style="margin-left:.0001pt;text-align:justify;">  apiGroup: rbac.authorization.k8s.io</p> 
<p style="margin-left:.0001pt;text-align:justify;">roleRef:</p> 
<p style="margin-left:.0001pt;text-align:justify;">  # "roleRef" 指定与某 Role 或 ClusterRole 的绑定关系</p> 
<p style="margin-left:.0001pt;text-align:justify;">  kind: ClusterRole        # 此字段必须是 Role 或 ClusterRole</p> 
<p style="margin-left:.0001pt;text-align:justify;">  name: zsclusterrole  # 此字段必须与你要绑定的 Role 或 ClusterRole 的名称匹配</p> 
<p style="margin-left:.0001pt;text-align:justify;">  apiGroup: rbac.authorization.k8s.io</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">此时已经完成角色创建及绑定，即可以访问哪些资源，对哪些资源有什么操作权限。</p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="text-align:justify;">2、验证操作</p> 
<p style="margin-left:.0001pt;text-align:justify;">切换到zs用户，查看当前所处的上下文，并非zs用户的，切换到zs用户的上下文</p> 
<p style="margin-left:.0001pt;text-align:justify;">[root@master01 ~]# su - zs</p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl  config  get-contexts</p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl  config  use-context  zs@kubernetes</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="156" src="https://images2.imgbox.com/17/8a/6OEMHOOZ_o.png" width="692"></p> 
<p style="margin-left:.0001pt;text-align:justify;"></p> 
<p style="margin-left:.0001pt;text-align:justify;">验证鉴权操作，因为上面设置的权限是对所有资源有查看权限，这里使用删除作为验证。集群中有一个我自定义的deployment与service</p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl  get  svc,deployment</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="125" src="https://images2.imgbox.com/bc/6e/cqTmk7md_o.png" width="692"></p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl  delete  deployments.apps  nginx-deployment</p> 
<p style="margin-left:.0001pt;text-align:justify;">[zs@master01 ~]$ kubectl  delete  svc define</p> 
<p style="margin-left:.0001pt;text-align:justify;"><img alt="" height="149" src="https://images2.imgbox.com/b9/7b/6hZm5zYT_o.png" width="691"></p> 
<p style="margin-left:.0001pt;text-align:justify;">最终，发现所有资源都可以看，因为上面设置的权限是看，但是不能删除。权限即角色的创建与修改可以根据需要自行查看。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/21b2207ae0a27a5bde5b1d8608fd169f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OCCT里的Mesh网格计算流程</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1ab8ef2af2a0426ad762fb13ca187c4e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MySQL登录报错1045解决办法-1045-Access denied for user ‘root‘@‘‘(using password:YES)</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>