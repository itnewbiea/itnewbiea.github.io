<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>java获取视频详细信息并截图做封面的两种实现方式 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="java获取视频详细信息并截图做封面的两种实现方式" />
<meta property="og:description" content="目录
两种视频处理方式介绍
jave方式
Javacv的方式
两种视频处理方式介绍 一种jave获取视频信息，使用FFmpeg方式截取视频第n帧生成图片 需要下载一个ffmpeg.exe文件一种是通过Javacv的方式获取视频信息和截图 jave方式 public static void main(String[] args) { String videoPath = &#34;D:\\szw\\photo\\test\\55f9e02108b642.mp4&#34;; String ffmpegPath = &#34;src/main/resources/libs/ffmpeg.exe&#34;; getVideoInfo(videoPath); processImg(videoPath, &#34;1&#34;, ffmpegPath); } 几种pom依赖 &lt;dependency&gt; &lt;groupId&gt;it.sauronsoftware&lt;/groupId&gt; &lt;artifactId&gt;jave&lt;/artifactId&gt; &lt;version&gt;1.0.2&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.github.dadiyang&lt;/groupId&gt; &lt;artifactId&gt;jave&lt;/artifactId&gt; &lt;version&gt;1.0.2&lt;/version&gt; &lt;/dependency&gt; &lt;!-- https://mvnrepository.com/artifact/ws.schild/jave-core --&gt; &lt;dependency&gt; &lt;groupId&gt;ws.schild&lt;/groupId&gt; &lt;artifactId&gt;jave-core&lt;/artifactId&gt; &lt;version&gt;2.7.3&lt;/version&gt; &lt;/dependency&gt; VideoUtil： import java.awt.*; import java.awt.image.BufferedImage; import java.io.File; import java.io.FileInputStream; import java.io.IOException; import java.io.InputStream; import java.math.BigDecimal; import java.math.RoundingMode; import java.nio.channels.FileChannel; import java.util.HashMap; import java.util.List; import java." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c2b55d69bb0dd5de0810f84804d525ff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-01T16:37:33+08:00" />
<meta property="article:modified_time" content="2023-08-01T16:37:33+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">java获取视频详细信息并截图做封面的两种实现方式</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <p id="main-toc"><strong>目录</strong></p> 
 <p id="%E4%B8%A4%E7%A7%8D%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D-toc" style="margin-left:80px;"><a href="#%E4%B8%A4%E7%A7%8D%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D" rel="nofollow">两种视频处理方式介绍</a></p> 
 <p id="jave%E6%96%B9%E5%BC%8F-toc" style="margin-left:80px;"><a href="#jave%E6%96%B9%E5%BC%8F" rel="nofollow">jave方式</a></p> 
 <p id="Javacv%E7%9A%84%E6%96%B9%E5%BC%8F-toc" style="margin-left:80px;"><a href="#Javacv%E7%9A%84%E6%96%B9%E5%BC%8F" rel="nofollow">Javacv的方式</a></p> 
 <hr id="hr-toc"> 
 <h4 id="%E4%B8%A4%E7%A7%8D%E8%A7%86%E9%A2%91%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D">两种视频处理方式介绍</h4> 
 <ul><li>一种jave获取视频信息，使用FFmpeg方式截取视频第n帧生成图片 
   <ul><li>需要下载一个ffmpeg.exe文件</li><li><img alt="" height="32" src="https://images2.imgbox.com/66/cd/Vv1uhA17_o.png" width="603"></li></ul></li><li>一种是通过Javacv的方式获取视频信息和截图</li></ul> 
 <h4 id="jave%E6%96%B9%E5%BC%8F">jave方式</h4> 
 <pre><code class="language-html">public static void main(String[] args) {
    String videoPath = "D:\\szw\\photo\\test\\55f9e02108b642.mp4";
    String ffmpegPath = "src/main/resources/libs/ffmpeg.exe";
    getVideoInfo(videoPath);
    processImg(videoPath, "1", ffmpegPath);
}</code></pre> 
 <ul><li>  <strong>几种pom依赖</strong></li></ul> 
 <pre><code class="language-java">&lt;dependency&gt;
    &lt;groupId&gt;it.sauronsoftware&lt;/groupId&gt;
    &lt;artifactId&gt;jave&lt;/artifactId&gt;
    &lt;version&gt;1.0.2&lt;/version&gt;
&lt;/dependency&gt;

&lt;dependency&gt;
    &lt;groupId&gt;com.github.dadiyang&lt;/groupId&gt;
    &lt;artifactId&gt;jave&lt;/artifactId&gt;
    &lt;version&gt;1.0.2&lt;/version&gt;
&lt;/dependency&gt;

&lt;!-- https://mvnrepository.com/artifact/ws.schild/jave-core --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;ws.schild&lt;/groupId&gt;
    &lt;artifactId&gt;jave-core&lt;/artifactId&gt;
    &lt;version&gt;2.7.3&lt;/version&gt;
&lt;/dependency&gt;</code></pre> 
 <ul><li><strong>  VideoUtil：</strong></li></ul> 
 <pre><code>import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.nio.channels.FileChannel;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import it.sauronsoftware.jave.Encoder;
import org.apache.commons.lang.StringUtils;
import org.bytedeco.javacv.FFmpegFrameGrabber;
import org.bytedeco.javacv.Frame;
import org.bytedeco.javacv.Java2DFrameConverter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.imageio.ImageIO;

/**
 * 视频工具类
 *
 * @Author: szw
 * @Date: 2020/7/9 9:42
 */
public class VideoUtil {
    private static final Logger LOGGER = LoggerFactory.getLogger(VideoUtil.class);

    /**
     * 通过jave方式获取视频信息
     * @param realPath 视频文件路径
     * @return Map&lt;String, Object&gt;
     */
    public static Map&lt;String, Object&gt; getVideoInfo(String realPath) {
        FileInputStream fis;
        File source = new File(realPath);
        Encoder encoder = new Encoder();
        FileChannel fc = null;
        Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
        try {
            it.sauronsoftware.jave.MultimediaInfo m = encoder.getInfo(source);
            long ls = m.getDuration();
            LOGGER.debug("此视频时长为:" + ls / 60000 + "分" + (ls) / 1000 + "秒！");
            // 视频帧宽高
            LOGGER.debug("此视频高度为:" + m.getVideo().getSize().getHeight());
            LOGGER.debug("此视频宽度为:" + m.getVideo().getSize().getWidth());
            LOGGER.debug("此视频格式为:" + m.getFormat());
            result.put("videoHigh", m.getVideo().getSize().getHeight());
            result.put("videoWide", m.getVideo().getSize().getWidth());
            result.put("format", m.getFormat());
            fis = new FileInputStream(source);
            fc = fis.getChannel();
            BigDecimal fileSize = new BigDecimal(fc.size());
            String size = fileSize.divide(new BigDecimal(1048576), 2, RoundingMode.HALF_UP) + "MB";
            LOGGER.debug("此视频大小为" + size);
            result.put("size", size);
            return result;
        } catch (Exception e) {
            e.printStackTrace();
            return result;
        } finally {
            if (null != fc) {
                try {
                    fc.close();
                } catch (IOException e) {
                    e.printStackTrace();
                }
            }
        }
    }

    /**
     * 使用 FFmpeg 截取视频第几帧生成图片
     *
     * @param videoPath 视频路径
     * @param frame     第几帧
     * @param utilPath  工具包地址
     * @return String    图片的相对路劲
     */
    public static String processImg(String videoPath, String frame, String utilPath) {
        File file = new File(videoPath);
        if (!file.exists()) {
            System.err.println("路径[" + videoPath + "]对应的视频文件不存在!");
            return null;
        }
        List&lt;String&gt; commands = new java.util.ArrayList&lt;String&gt;();
        commands.add(utilPath);
        commands.add("-i");
        commands.add(videoPath);
        commands.add("-y");
        commands.add("-f");
        commands.add("image2");
        commands.add("-ss");
        commands.add(frame);    // 这个参数是设置截取视频多少秒时的画面
        commands.add("-t");
        commands.add("0.001");
        commands.add("-s");
        commands.add("800x1200"); // 宽X高
        String imgPath = videoPath.substring(0, videoPath.lastIndexOf(".")) + "-cover" + ".jpg";
        commands.add(imgPath);
        try {
            ProcessBuilder builder = new ProcessBuilder();
            builder.command(commands);
            builder.redirectErrorStream(true);
            LOGGER.debug("视频截图开始...");
            Process process = builder.start();
            InputStream in = process.getInputStream();
            // 写入本地
            FileUtil.writeToLocal(imgPath, in);
            LOGGER.debug("截取成功");
            return imgPath;
        } catch (Exception e) {
            e.printStackTrace();
            return null;
        }
    }
}


</code></pre> 
 <h4 id="Javacv%E7%9A%84%E6%96%B9%E5%BC%8F">Javacv的方式</h4> 
 <p>JavaCV是一个计算机视觉领域的封装库，封装了包括 OpenCV，FFmpeg 等<br> GitHub： https://github.com/bytedeco/javacv<br> OpenCV 的文档地址： https://docs.opencv.org/master<br>  </p> 
 <pre><code class="language-html">public static void main(String[] args) {
    String videoPath = "D:\\szw\\photo\\test\\55f9e02108b642.mp4";
    Map&lt;String, Object&gt; screenshot = getScreenshot(videoPath);
    System.out.println(screenshot);
}</code></pre> 
 <p></p> 
 <ul><li><strong>pom依赖,</strong>我的后来版本改到1.5.3了 <pre><code class="language-html">&lt;version&gt;1.5.3&lt;/version&gt;</code></pre> </li></ul> 
 <pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.bytedeco&lt;/groupId&gt;
    &lt;artifactId&gt;javacv-platform&lt;/artifactId&gt;
    &lt;version&gt;1.3.1&lt;/version&gt;
&lt;/dependency&gt;</code></pre> 
 <ul><li><strong>VideoUtil</strong></li></ul> 
 <pre><code>
import java.awt.*;
import java.awt.image.BufferedImage;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStream;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.nio.channels.FileChannel;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import it.sauronsoftware.jave.Encoder;
import org.apache.commons.lang.StringUtils;
import org.bytedeco.javacv.FFmpegFrameGrabber;
import org.bytedeco.javacv.Frame;
import org.bytedeco.javacv.Java2DFrameConverter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.imageio.ImageIO;

/**
 * 视频工具类
 *
 * @Author: szw
 * @Date: 2020/7/9 9:42
 */
public class VideoUtil {
    private static final Logger LOGGER = LoggerFactory.getLogger(VideoUtil.class);

    /**
     * 通过Javacv的方式获取视频截图
     *
     * @param filePath 视频文件路径
     * @return Map&lt;String, Object&gt;
     */
    public static Map&lt;String, Object&gt; getScreenshot(String filePath) {
        try {
            LOGGER.debug("截取视频截图开始：" + System.currentTimeMillis());
            Map&lt;String, Object&gt; result = new HashMap&lt;String, Object&gt;();
            FFmpegFrameGrabber grabber = FFmpegFrameGrabber.createDefault(filePath);

            // 第一帧图片存储位置
            String targerFilePath = filePath.substring(0, filePath.lastIndexOf("\\"));
            // 视频文件名
            String fileName = filePath.substring(filePath.lastIndexOf("\\") + 1);
            // 图片名称
            String targetFileName = fileName.substring(0, fileName.lastIndexOf("."));
            LOGGER.debug("视频路径是：" + targerFilePath);
            LOGGER.debug("视频文件名：" + fileName);
            LOGGER.debug("图片名称是：" + targetFileName);

            grabber.start();
            //设置视频截取帧（默认取第一帧）
            Frame frame = grabber.grabImage();
            //视频旋转度
            String rotate = grabber.getVideoMetadata("rotate");
            Java2DFrameConverter converter = new Java2DFrameConverter();
            //绘制图片
            BufferedImage bi = converter.getBufferedImage(frame);
            if (rotate != null) {
                // 旋转图片
                bi = rotate(bi, Integer.parseInt(rotate));
            }
            //图片的类型
            String imageMat = "jpg";
            //图片的完整路径
            String imagePath = targerFilePath + File.separator + targetFileName + "." + imageMat;
            //创建文件
            File output = new File(imagePath);
            ImageIO.write(bi, imageMat, output);

            //拼接Map信息
            result.put("videoWide", bi.getWidth());
            result.put("videoHigh", bi.getHeight());
            long duration = grabber.getLengthInTime() / (1000 * 1000);
            result.put("rotate", StringUtils.isBlank(rotate) ? "0" : rotate);
            result.put("format", grabber.getFormat());
            result.put("imgPath", output.getPath());
            result.put("time", duration);
            LOGGER.debug("视频的宽:" + bi.getWidth());
            LOGGER.debug("视频的高:" + bi.getHeight());
            LOGGER.debug("视频的旋转度：" + rotate);
            LOGGER.debug("视频的格式：" + grabber.getFormat());
            LOGGER.debug("此视频时长（s/秒）：" + duration);
            grabber.stop();
            LOGGER.debug("截取视频截图结束：" + System.currentTimeMillis());
            return result;
        } catch (Exception e) {
            LOGGER.error("VideoUtil getScreenshot fail: {}", ExceptionStackTrace.printStackTrace(e));
            return null;
        }
    }

    /**
     * 根据视频旋转度来调整图片
     *
     * @param src   BufferedImage
     * @param angel angel	视频旋转度
     * @return BufferedImage
     */
    public static BufferedImage rotate(BufferedImage src, int angel) {
        int src_width = src.getWidth(null);
        int src_height = src.getHeight(null);
        int type = src.getColorModel().getTransparency();
        Rectangle rect_des = calcRotatedSize(new Rectangle(new Dimension(src_width, src_height)), angel);
        BufferedImage bi = new BufferedImage(rect_des.width, rect_des.height, type);
        Graphics2D g2 = bi.createGraphics();
        g2.translate((rect_des.width - src_width) / 2, (rect_des.height - src_height) / 2);
        g2.rotate(Math.toRadians(angel), src_width / 2, src_height / 2);
        g2.drawImage(src, 0, 0, null);
        g2.dispose();
        return bi;
    }


    /**
     * 计算图片旋转大小
     *
     * @param src   Rectangle
     * @param angel int
     * @return Rectangle
     */
    public static Rectangle calcRotatedSize(Rectangle src, int angel) {
        if (angel &gt;= 90) {
            if (angel / 90 % 2 == 1) {
                int temp = src.height;
                src.height = src.width;
                src.width = temp;
            }
            angel = angel % 90;
        }
        double r = Math.sqrt(src.height * src.height + src.width * src.width) / 2;
        double len = 2 * Math.sin(Math.toRadians(angel) / 2) * r;
        double angel_alpha = (Math.PI - Math.toRadians(angel)) / 2;
        double angel_dalta_width = Math.atan((double) src.height / src.width);
        double angel_dalta_height = Math.atan((double) src.width / src.height);
        int len_dalta_width = (int) (len * Math.cos(Math.PI - angel_alpha - angel_dalta_width));
        int len_dalta_height = (int) (len * Math.cos(Math.PI - angel_alpha - angel_dalta_height));
        int des_width = src.width + len_dalta_width * 2;
        int des_height = src.height + len_dalta_height * 2;
        return new java.awt.Rectangle(new Dimension(des_width, des_height));
    }
}


</code></pre> 
 <p> <img alt="" height="234" src="https://images2.imgbox.com/0b/8f/NdlXE8nk_o.png" width="692"></p> 
 <p><img alt="" height="159" src="https://images2.imgbox.com/fb/5e/gKTURGtB_o.png" width="334"></p> 
 <h4>问题解决</h4> 
 <p><strong>main方法测试没问题，项目运行后报系统找不到指定的文件，（虽然能运行但一堆报错看着也不舒服）</strong></p> 
 <p>java.io.FileNotFoundException: D:\szw\repository\org\bytedeco\tesseract-platform\4.1.1-1.5.3\tesseract-windows-x86_64.jar (系统找不到指定的文件。)</p> 
 <p>参考这篇：BUG记录-找不到jaxb相关jar包<a href="https://blog.csdn.net/qq_44695727/article/details/106296294" title="BUG记录-SpringBoot找不到jaxb相关jar包_jaxb.jar_瑶山的博客-CSDN博客">BUG记录-SpringBoot找不到jaxb相关jar包_jaxb.jar_瑶山的博客-CSDN博客</a></p> 
 <p><strong>找到报错jar位置，解压(没有打jar包软件用360压缩打开) -&gt; META-INF -&gt; MANIFEST.MF -&gt;打开文件找到Class-Path 删除 -&gt;再打包回jar</strong></p> 
 <p>重新运行</p> 
 <p><img alt="" height="58" src="https://images2.imgbox.com/b9/39/RsqktufX_o.png" width="366"></p> 
 <p><img alt="" height="239" src="https://images2.imgbox.com/b1/35/s0mi795n_o.png" width="566"></p> 
 <p><img alt="" height="329" src="https://images2.imgbox.com/89/b4/5FFDzsim_o.png" width="562"></p> 
 <p><img alt="" height="173" src="https://images2.imgbox.com/c7/a3/bIXG0pek_o.png" width="368"></p> 
 <p>报错jar修改后就正常了</p> 
 <p>也可以下载我删减好的-&gt;0积分免费下载</p> 
 <p>javaCV所有相关jar删减完成版：<a href="https://download.csdn.net/download/qq_44695727/12597497" title="https://download.csdn.net/download/qq_44695727/12597497">https://download.csdn.net/download/qq_44695727/12597497</a></p> 
 <p>javaCV所有相关jar未删减版：<a href="https://download.csdn.net/download/qq_44695727/12596763" title="https://download.csdn.net/download/qq_44695727/12596763">https://download.csdn.net/download/qq_44695727/12596763</a></p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/01921510f6792d0bf5ca5ad7e72d6f28/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【css】样式 &#43;GASP</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/06e805b6da9f72d48e82dac417ca5d03/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">nvidia-smi no devices were found 这个bug唉，可算解决了</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>