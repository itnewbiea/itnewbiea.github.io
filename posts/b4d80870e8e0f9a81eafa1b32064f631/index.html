<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>JSONP 方式实现跨域请求数据 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="JSONP 方式实现跨域请求数据" />
<meta property="og:description" content="前言 在了解 浏览器的同源政策（SOP） 后知道了浏览器的同源政策对保护用户信息安全的重要性。但是有些时候我们确实需要两个网站间的数据共享。例如腾讯天气的天气数据就是从其他服务器上获取到的，并不是腾讯天气服务器上的数据。那它们是怎么做到跨域资源（数据）共享的呢？在这里学习一下 jsonp 方式实现跨域资源共享。
JSONP 实现原理 并不是页面中所有的请求都受同源政策的限制。例如外链外部 js 文件文件时是不受同源政策的限制的，这也是为什么在使用 jQuery 时，我们并不是一定要将库文件下载到项目后才能引入使用。我们也可以直接引入 jQuery 的线上文件，并不影响正常使用。它的原理是虽然此时进行了跨域（线上资源在 jQuery 的官网上），但是 script 标签的 src 属性外链的资源请求不受浏览器同源政策的影响。这也是我们使用 JSONP 实现跨域资源共享的原理。
JSONP 的基础原理如下示例代码所示（注意 A 服务器监听 3000 端口，B 服务器监听 3001 端口，下面的所有示例都在同源政策的基础上改进，所以不会再做具体说明。）：
&lt;!-- A服务器响应的页面中的代码 --&gt; &lt;body&gt; &lt;h2&gt;A服务器的页面&lt;/h2&gt; &lt;!-- 全局作用域下定义fn1函数（用来处理接收数据） --&gt; &lt;script&gt; function fn1(data) { console.log(data); } &lt;/script&gt; &lt;!-- 利用script标签发送跨域请求 --&gt; &lt;script src=&#34;http://localhost:3001/jsonp1&#34;&gt;&lt;/script&gt; &lt;/body&gt; 如下图是响应的结果，想必从图中也你可以猜出了服务器端的代码。
// B服务器响应路由的代码 B.get(&#39;/jsonp1&#39;, (req, res) =&gt; { res.send(&#39;fn1({name: &#34;tkop&#34;, age: 18})&#39;); }); 结合上面的代码示例总结 JSONP 的原理：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b4d80870e8e0f9a81eafa1b32064f631/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-04-21T16:54:11+08:00" />
<meta property="article:modified_time" content="2021-04-21T16:54:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">JSONP 方式实现跨域请求数据</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_1"></a>前言</h3> 
<p>在了解 <strong><a href="https://blog.csdn.net/TKOP_/article/details/115802396">浏览器的同源政策（SOP）</a></strong> 后知道了浏览器的同源政策对保护用户信息安全的重要性。但是有些时候我们确实需要两个网站间的数据共享。例如腾讯天气的天气数据就是从其他服务器上获取到的，并不是腾讯天气服务器上的数据。那它们是怎么做到跨域资源（数据）共享的呢？在这里学习一下 jsonp 方式实现跨域资源共享。</p> 
<h4><a id="JSONP__7"></a>JSONP 实现原理</h4> 
<p><em><strong>并不是页面中所有的请求都受同源政策的限制</strong>。例如外链外部 js 文件文件时是不受同源政策的限制的，这也是为什么在使用 jQuery 时，我们并不是一定要将库文件下载到项目后才能引入使用。我们也可以直接引入 jQuery 的线上文件，并不影响正常使用。它的原理是虽然此时进行了跨域（线上资源在 jQuery 的官网上），但是 script 标签的 src 属性外链的资源请求不受浏览器同源政策的影响。这也是我们使用 JSONP 实现跨域资源共享的原理。</em></p> 
<p>JSONP 的基础原理如下示例代码所示（注意 A 服务器监听 3000 端口，B 服务器监听 3001 端口，下面的所有示例都在同源政策的基础上改进，所以不会再做具体说明。）：</p> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- A服务器响应的页面中的代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>A服务器的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 全局作用域下定义fn1函数（用来处理接收数据） --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
        <span class="token keyword">function</span> <span class="token function">fn1</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 利用script标签发送跨域请求 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:3001/jsonp1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>如下图是响应的结果，想必从图中也你可以猜出了服务器端的代码。</p> 
<p><img src="https://images2.imgbox.com/a8/98/vJp3aZq1_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/49/00/cA71xYOj_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-javascript"><span class="token comment">// B服务器响应路由的代码</span>
<span class="token constant">B</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/jsonp1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'fn1({name: "tkop", age: 18})'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>结合上面的代码示例总结 JSONP 的原理：</p> script 标签可以向服务器发送请求，最常见的是请求 js 脚本文件，客户端接收到服务器响应的 js 脚本文件后会立即执行。但是这个请求响应过程不受同源政策的限制，即使请求头信息中的 Sec-Fetch-Site 字段值不是 same-origin（同源），即使响应头中没有 Access-Control-Allow-Origin 字段，浏览器依旧会将服务响应的数据视为 js 脚本并在客户端运行。 
<p></p> 
<p>JSOPN 正是利用了这一点，在客户端接收到响应前提前在全局作用域下声明一个用于接收处理响应数据的函数。再利用 script 标签发送请求，<strong>此时服务器端返回的不再是一个脚本文件，而是返回该函数的调用（函数调用的字符串）。并且将客户端需要的数据作为实参传递给函数。在客户端接收到响应后会将返回结果作为 js 脚本执行（调用返回的函数），这样就达到了获取并处理数据的目的</strong>。为了更加清楚原理我们再继续看看下面的示例代码。</p> 
<pre><code class="prism language-html"><span class="token comment">&lt;!-- A服务器响应的页面中的代码 --&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>A服务器的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>http://localhost:3001/jsonp1<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>这次我不想直接在全局定义数据处理函数了，我想直接得到一个全局变量作为响应得到的数据（这个前后端交流成本非常高，而且还有后端开发者给你定义变量。。。。这是不可能的，<strong>纯粹是为了演示原理而已</strong>）。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// B服务器响应路由的代码</span>
<span class="token constant">B</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/jsonp1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'var data = "这就是响应数据"'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<blockquote> 
 <p><strong>这就是上面的客户端代码即使没有声明 data 也不会报错的原因，返回的数据就是 data 声明</strong>。</p> 
</blockquote> 
<h4><a id="JSONP__ajax__74"></a>JSONP 模仿 ajax 请求</h4> 
<p>上面已经介绍了 jsonp 的基本原理，<strong>可以看出这种方案实际上已经不属于 ajax 请求的范围了</strong>。但是它可以模仿 ajax 请求，使用其原理 jsonp 是怎么模仿 ajax 请求的呢？</p> 
<ol><li> <p>上面示例中的请求都是在页面加载过程就发送出去的，不像 ajax 根据客户端需要去发送。为<strong>实现这一点，我们可以在只有需要发送请求时在页面动态追加 script 标签。请求会在 script 标签被追加到页面时发送</strong>。</p> </li><li> <p>发送请求接收到响应后在页面追加的 script 标签需要删除。如果不进行删除，每发送一次请求页面就会增加一个 script 标签。但是怎么判断 script 标签已经追加到页面且请求已经发送了呢？可以监听 <strong>script 标签的 onload 事件实现</strong>。</p> </li><li> <p>另一个是函数名的问题。服务器返回的某函数的调用时，函数名必须与客户端声明的函数名称保持一致。这增加了前后端的沟通成本，不利于高效开发。为什么不在前端将函数名作为参数传递到后端呢？后端在获取到该参数后作为函数名并返回函数调用。</p> </li></ol> 
<p>客户端代码如下：</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>A服务器的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>向B发送ajax请求<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 提前定义全局函数fn2 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
        <span class="token keyword">function</span> <span class="token function">fn2</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
        <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 创建script标签</span>
            <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置script标签的src属性</span>
            script<span class="token punctuation">.</span>src <span class="token operator">=</span> <span class="token string">'http://localhost:3001/jsonp2?callback=fn2'</span><span class="token punctuation">;</span>
            <span class="token comment">// 将script标签追加到页面中</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在script标签追加完成请求发送后将其删除</span>
            script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>服务器端代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token constant">B</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/jsonp2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> callback <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>callback <span class="token operator">+</span> <span class="token string">'({ name: "tkop", age: 18 })'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>上面的代码个人亲自敲完后运行没有出错，可以发送请求和获得响应数据，并达到预期结果。</p> 
<h4><a id="JSONP__126"></a>JSONP 函数封装</h4> 
<p>JSONP 也可以像 ajax 那样将发送请求处理响应的过程封装成一个函数。在需要发送请求时，只需要调用并传入指定参数即可。参考 ajax 函数的封装过程，按照思考的步骤进行 JSONP 函数的封装。</p> 
<ol><li> <p><em>请求地址、请求参数和响应处理函数可以作为函数的参数传入。但是由于 JSONP 方式只能发送 get 方式的请求，所以也就没有请求方式判断和请求参数格式不同等问题的处理（相比较于以前 ajax 函数的封装简单了不少）</em>。</p> </li><li> <p><em>响应处理函数作为参数传入 jsonp 请求函数，理想做法是以匿名函数的方式传入。如果是在全局作用域声明一个命名函数在将其传入 jsonp 请求函数，这是 jsonp 的封装性非常低</em>。</p> </li><li> <p><em>这样又会出现两个问题。问题 1：函数必须要挂载在全局作用域内，在后端返回函数调用时才可以找到相应的函数。问题 2：在发送请求时必须将函数名作为参数传递给后端</em>。</p> </li><li> <p><em>针对以上两个问题，可以直接在函数内部封装给函数命名和将其挂载在全局作用域下的代码</em>。</p> </li><li> <p><em>但是还是需要解决一个问题，就是不能在内部为所有请求的函数起同一个函数名，这样会造成函数覆盖的问题。例如给按钮 1 和按钮 2 都绑定点击事件，点击后均是发送 jsonp 请求，如果它们的响应处理函数命名相同，那无疑都会执行后面定义的那个函数</em>。</p> </li><li> <p><em>所以需要给每个函数的命名是随机而不同的</em>。</p> </li></ol> 
<p>服务器端 jsonp 函数封装的过程和发送 jsonp 请求的代码</p> 
<pre><code class="prism language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">&gt;</span></span>A服务器的页面<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>btn<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>向B发送jsonp请求<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text/javascript<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
        <span class="token keyword">var</span> btn <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'btn'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">function</span> <span class="token function">jsonp</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 处理其他参数的拼接</span>
            <span class="token keyword">var</span> params <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token keyword">in</span> options<span class="token punctuation">.</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                params <span class="token operator">+=</span> <span class="token string">'&amp;'</span> <span class="token operator">+</span> k <span class="token operator">+</span> <span class="token string">'='</span> <span class="token operator">+</span> options<span class="token punctuation">.</span>data<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 响应处理函数</span>
            <span class="token keyword">var</span> fnName <span class="token operator">=</span> <span class="token string">'myJsonp'</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            window<span class="token punctuation">[</span>fnName<span class="token punctuation">]</span> <span class="token operator">=</span> options<span class="token punctuation">.</span>success<span class="token punctuation">;</span>
            <span class="token comment">// 请求完整地址</span>
            <span class="token keyword">var</span> url <span class="token operator">=</span> options<span class="token punctuation">.</span>url <span class="token operator">+</span> <span class="token string">'?callback='</span> <span class="token operator">+</span> fnName <span class="token operator">+</span> params<span class="token punctuation">;</span>
            <span class="token comment">// 创建script标签</span>
            <span class="token keyword">var</span> script <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 设置script标签的src属性</span>
            script<span class="token punctuation">.</span>src <span class="token operator">=</span> url<span class="token punctuation">;</span>
            <span class="token comment">// 将script标签追加到页面中</span>
            document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 在script标签追加完成请求发送后将其删除</span>
            script<span class="token punctuation">.</span><span class="token function-variable function">onload</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
                window<span class="token punctuation">[</span>fnName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        btn<span class="token punctuation">.</span><span class="token function-variable function">onclick</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 地址</span>
                url<span class="token punctuation">:</span> <span class="token string">'http://localhost:3001/jsonp3'</span><span class="token punctuation">,</span>
                <span class="token comment">// 其他请求参数</span>
                data<span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    name<span class="token punctuation">:</span> <span class="token string">'tkop'</span><span class="token punctuation">,</span>
                    age<span class="token punctuation">:</span> <span class="token number">18</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token comment">// 响应处理函数</span>
                success<span class="token punctuation">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>服务器端的响应代码</p> 
<pre><code class="prism language-javascript"><span class="token constant">B</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/jsonp3'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">var</span> callback <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'TKOP'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token number">123456</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> callback <span class="token operator">+</span> <span class="token string">'('</span> <span class="token operator">+</span> data <span class="token operator">+</span> <span class="token string">')'</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>对服务器端的响应代码可以做一下优化，响应对象下有一个 jsonp() 方法封装了回调函数名的获取和与数据字符串拼接为函数调用的过程。所以使用这个方法的后端实现示例代码如下：</p> 
<pre><code class="prism language-javascript"><span class="token constant">B</span><span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/jsonp3'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span> name<span class="token punctuation">:</span> <span class="token string">'TKOP'</span><span class="token punctuation">,</span> password<span class="token punctuation">:</span> <span class="token number">123456</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 响应结果</span>
<span class="token comment">//typeof myJsonp07452599508118731 === 'function' &amp;&amp; myJsonp07452599508118731({"name":"TKOP","password":123456});</span>
</code></pre> 
<blockquote> 
 <p>写完验证没有问题后，我在想：这样岂不是每发送一个请求就会在全局挂载一个全局函数吗？需不需要在接收到响应并调用处理函数后将它删了？我觉得有必要，所以处理需要删除 script 标签外我另外添加了清除全局函数的代码。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/94/fb/UZojNxc3_o.png" alt="在这里插入图片描述"><br> 封装结果如上图所示，发送几次请求后没有问题，如果试一下给其他按钮绑定点击事件发送 jsonp 请求的也没有发现问题。</p> 
<h4><a id="_224"></a>其他方式</h4> 
<p>实现跨域的方式还有 CORS 和 WebSocket ，但是在此记录的是利用服务器作为中间人向其他服务器请求数据的方式。因为同源政策只是浏览器为保护用户信息安全而在客户端执行的策略，而服务器是没有同源政策的。浏览器不跨域向服务器请求数据时，服务器转而向其他服务器请求数据，在得到其他服务器响应的数据后转手响应给浏览器。这也隐式实现了跨域的数据请求。原理如下：</p> 
<blockquote> 
 <p>aaa: A 哥我希望得到这些数据。<br> A : 这些数据在 B 上，我去跟他要吧，你自己去要的话，他不会给你。<br> A : B 哥我要这些数据。<br> B : 给你。<br> A ：aaa 这是你要的数据。</p> 
</blockquote> 
<p>具体的实现服务器端需要使用到第三方库（request）向另一个服务器发送请求和接收处理响应。</p> 
<pre><code class="prism language-javascript"><span class="token comment">// aaa 页面脚本向自己的服务器发送ajax请求</span>
<span class="token function">ajax</span><span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
	type<span class="token punctuation">:</span> <span class="token string">'get'</span><span class="token punctuation">,</span>
	url<span class="token punctuation">:</span> <span class="token string">'http://localhost:3000/server'</span><span class="token punctuation">,</span>
	success<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// A服务器的响应路由</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/server'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 向B服务器发送请求</span>
	<span class="token function">request</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3001/cross'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> response<span class="token punctuation">,</span> body<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
		res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// B服务器响应路由</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/cross'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{<!-- --></span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>有关 CORS 和 WebSocket 有空再总结。。。。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/03c284d0f9a743763930ed658879fc7f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[现代密码学] Crypto 知识点总结（古典密码&amp;&amp;对称加密&amp;&amp;hash函数）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/760545ae4e4a54eb85782390fbb96102/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">samba不允许一个用户使用一个以上用户名与服务器或共享资源的多重连接</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>