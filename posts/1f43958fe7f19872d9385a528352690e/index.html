<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S平台应用安全(Secret Service Ingress) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S平台应用安全(Secret Service Ingress)" />
<meta property="og:description" content="平台应用安全 1 平台应用安全1.1 敏感数据1.1.1 应用数据1.1.2 Secret基础1.1.3 Secret案例11.1.4 Secret案例2 1.2 数据访问1.2.1 网络体系解读1.2.2 Service实践1.2.3 Service进阶1.2.4 Service解读 1.3 应用流量1.3.1 Ingress基础1.3.2 Ingress实践1.3.3 Ingress进阶1.3.4 Ingress认证1.3.5 Ingress高阶1.3.6 Ingress扩展 1 平台应用安全 1.1 敏感数据 1.1.1 应用数据 学习目标
这一节，我们从 基础知识、资源对象、小结 三个方面来学习
基础知识
Docker存储
Docker的文件系统 与Docker容器具有相同的生命周期，但是Docker容器肯定会遇到同时运行到多节点场景中，这个时候，会因为节点崩溃、服务崩溃、网络原因，导致容器异常退出，所以一旦我们将数据存储到容器内部，肯定会导致数据丢失。 - Docker镜像是只读的文件，Docker容器可读可写，但是不能够数据持久化。 所以为了避免这种数据异常丢失的情况，我们一般会将 容器的数据(程序状态数据、应用存储数据等)，存储在容器的文件系统之外。 - 通过引入外部的存储空间来实现 数据的可持久化效果。 存储方式
Docker的两种文件存储机制： host存储方式 - 通过数据卷 或者 数据卷容器，将当前宿主机上面的文件系统目录与容器里面的工作目录进行一一的关联。 - 即使我们对本地是磁盘做 raid等冗余功能，但是这种等级的安全很鸡肋。 网络存储方式 - 通过网络的方式，将外部的存储空间挂载到当前宿主机，然后借助于host机制实现容器数据的可持久化。 资源对象
资源对象体系
k8s集群中的容器数据存储
k8s集群中的多pod中多容器间的数据存储机制，有两个关键点： 1 容器引擎对共享式存储设备的支持类型： - 多路并行读写 - 多个容器内可以同时对同一个存储设备进行读写操作 - 多路只读 - 多个容器内可以同时对同一个存储设备进行只读操作 - 单路读写 - 多个容器内可以通过同一个中间容器对同一个存储设备进行读写操作 2 pod内部容器使用存储卷有两步： - 在Pod上定义存储卷，并关联至目标存储服务上 - 在需要用到存储卷的容器上，挂载其所属的Pod的存储卷 资源对象属性" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1f43958fe7f19872d9385a528352690e/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-06T20:31:06+08:00" />
<meta property="article:modified_time" content="2023-07-06T20:31:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S平台应用安全(Secret Service Ingress)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>平台应用安全</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 平台应用安全</a></li><li><ul><li><a href="#11__3" rel="nofollow">1.1 敏感数据</a></li><li><ul><li><a href="#111__5" rel="nofollow">1.1.1 应用数据</a></li><li><a href="#112_Secret_85" rel="nofollow">1.1.2 Secret基础</a></li><li><a href="#113_Secret1_277" rel="nofollow">1.1.3 Secret案例1</a></li><li><a href="#114_Secret2_418" rel="nofollow">1.1.4 Secret案例2</a></li></ul> 
   </li><li><a href="#12__519" rel="nofollow">1.2 数据访问</a></li><li><ul><li><a href="#121__521" rel="nofollow">1.2.1 网络体系解读</a></li><li><a href="#122_Service_609" rel="nofollow">1.2.2 Service实践</a></li><li><a href="#123_Service_706" rel="nofollow">1.2.3 Service进阶</a></li><li><a href="#124_Service_878" rel="nofollow">1.2.4 Service解读</a></li></ul> 
   </li><li><a href="#13__1151" rel="nofollow">1.3 应用流量</a></li><li><ul><li><a href="#131_Ingress_1153" rel="nofollow">1.3.1 Ingress基础</a></li><li><a href="#132_Ingress_1287" rel="nofollow">1.3.2 Ingress实践</a></li><li><a href="#133_Ingress_1514" rel="nofollow">1.3.3 Ingress进阶</a></li><li><a href="#134_Ingress_1663" rel="nofollow">1.3.4 Ingress认证</a></li><li><a href="#135_Ingress_1903" rel="nofollow">1.3.5 Ingress高阶</a></li><li><a href="#136_Ingress_1996" rel="nofollow">1.3.6 Ingress扩展</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 平台应用安全</h2> 
<h3><a id="11__3"></a>1.1 敏感数据</h3> 
<h4><a id="111__5"></a>1.1.1 应用数据</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、资源对象、小结 三个方面来学习</p> 
<p><strong>基础知识</strong></p> 
<p>Docker存储</p> 
<pre><code>	Docker的文件系统 与Docker容器具有相同的生命周期，但是Docker容器肯定会遇到同时运行到多节点场景中，这个时候，会因为节点崩溃、服务崩溃、网络原因，导致容器异常退出，所以一旦我们将数据存储到容器内部，肯定会导致数据丢失。
		- Docker镜像是只读的文件，Docker容器可读可写，但是不能够数据持久化。
	所以为了避免这种数据异常丢失的情况，我们一般会将 容器的数据(程序状态数据、应用存储数据等)，存储在容器的文件系统之外。
		- 通过引入外部的存储空间来实现 数据的可持久化效果。
</code></pre> 
<p>存储方式</p> 
<pre><code class="prism language-powershell">Docker的两种文件存储机制：
host存储方式
	<span class="token operator">-</span> 通过数据卷 或者 数据卷容器，将当前宿主机上面的文件系统目录与容器里面的工作目录进行一一的关联。
	<span class="token operator">-</span> 即使我们对本地是磁盘做 raid等冗余功能，但是这种等级的安全很鸡肋。
网络存储方式
	<span class="token operator">-</span> 通过网络的方式，将外部的存储空间挂载到当前宿主机，然后借助于host机制实现容器数据的可持久化。
</code></pre> 
<p><img src="https://images2.imgbox.com/2b/43/qfZST6P0_o.png" alt="在这里插入图片描述"></p> 
<p><strong>资源对象</strong></p> 
<p>资源对象体系</p> 
<p><img src="https://images2.imgbox.com/61/d2/4A29DNuU_o.png" alt="在这里插入图片描述"></p> 
<p>k8s集群中的容器数据存储</p> 
<p><img src="https://images2.imgbox.com/57/87/gHta0wKe_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">k8s集群中的多pod中多容器间的数据存储机制，有两个关键点：
1 容器引擎对共享式存储设备的支持类型：
  	<span class="token operator">-</span> 多路并行读写 <span class="token operator">-</span> 多个容器内可以同时对同一个存储设备进行读写操作
  	<span class="token operator">-</span> 多路只读 <span class="token operator">-</span> 多个容器内可以同时对同一个存储设备进行只读操作
  	<span class="token operator">-</span> 单路读写 <span class="token operator">-</span> 多个容器内可以通过同一个中间容器对同一个存储设备进行读写操作
2 pod内部容器使用存储卷有两步：
	<span class="token operator">-</span> 在Pod上定义存储卷，并关联至目标存储服务上
  	<span class="token operator">-</span> 在需要用到存储卷的容器上，挂载其所属的Pod的存储卷 
</code></pre> 
<p>资源对象属性</p> 
<pre><code>spec:
  volumes:
  - name &lt;string&gt;  				# 存储卷名称标识，仅可使用DNS标签格式的字符，在当前Pod中必须唯一
    VOL_TYPE &lt;Object&gt;  			# 存储卷插件及具体的目标存储供给方的相关配置
  containers:
  - name: …
    image: …
    volumeMounts:
    - name &lt;string&gt;  			# 要挂载的存储卷的名称，必须匹配存储卷列表中某项的定义
      mountPath &lt;string&gt; 		# 容器文件系统上的挂载点路径
      readOnly &lt;boolean&gt;  		# 是否挂载为只读模式，默认为“否”
      subPath &lt;string&gt;     		# 挂载存储卷上的一个子目录至指定的挂载点
      subPathExpr &lt;string&gt;  	# 挂载由指定的模式匹配到的存储卷的文件或目录至挂载点
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="112_Secret_85"></a>1.1.2 Secret基础</h4> 
<p>学习目标</p> 
<p>这一节，我们从 属性解读、简单实践、小结 三个方面来学习</p> 
<p><strong>属性解读</strong></p> 
<p>如何为容器化应用提供配置信息？</p> 
<pre><code class="prism language-powershell">1 启动容器时，直接向应用程序传递参数，args: <span class="token punctuation">[</span><span class="token punctuation">]</span>
2 将定义好的配置文件焙进镜像之中；
3 通过环境变量向容器传递配置数据：有个前提要求，应用得支持从环境变量加载配置信息； 
4 制作镜像时，使用entrypoint脚本来预处理变量，常见的做法就是使用非交互式编辑工具，将环境变量的值替换到应用的配置文件中； 
5 基于存储卷向容器传递配置文件； 
注意：
	对于运行容器中的配置改变，需要通过应用程序重载相关配置
</code></pre> 
<p>k8s的配置管理</p> 
<pre><code class="prism language-powershell">	kubernetes提供了对pod中容器应用的集中配置管理组件：ConfigMap、Secret等。通过这些组件来实现向pod中的容器中注入配置信息的机制。
	在k8s集群中，有一些核心的配置属性信息是非常敏感的，所以这些信息在传递的过程中，是不希望外人能够看到的，所以，k8s提供了一种加密场景中的配置管理资源对象 <span class="token operator">--</span> secret。
	Secret的对象需要单独定义并创建，然后以数据卷的形式挂载到Pod中，Secret的数据将以文件的形式保存，容器通过读取文件可以获取需要的数据。
</code></pre> 
<p>secret类型</p> 
<table><thead><tr><th>类型</th><th>解析</th></tr></thead><tbody><tr><td>generic</td><td>通用类型，基于base64编码的，长用来存储密码，公钥之类的。常见的子类型有：<br>kubernetes.io/basic-auth、kubernetes.io/rbd、kubernetes.io/ssh-auth(比较重要)</td></tr><tr><td>docker-registry</td><td>专用于让kubelet启动Pod时从私有镜像仓库pull镜像时，首先认证到Registry时使用</td></tr><tr><td>tls</td><td>专门用于保存tls/ssl用到证书和配对儿的私钥</td></tr></tbody></table> 
<p>命令解析</p> 
<pre><code class="prism language-powershell">查看命令帮助
<span class="token comment"># kubectl create secret --help</span>
Create a secret <span class="token keyword">using</span> specified subcommand<span class="token punctuation">.</span>

Available Commands:
  docker-registry   创建一个给 Docker registry 使用的 secret
  generic           Create a secret <span class="token keyword">from</span> a local file<span class="token punctuation">,</span> directory<span class="token punctuation">,</span> or literal value
  tls               创建一个 TLS secret

Usage:
  kubectl create secret <span class="token namespace">[flags]</span> <span class="token namespace">[options]</span>

Use <span class="token string">"kubectl &lt;command&gt; --help"</span> <span class="token keyword">for</span> more information about a given command<span class="token punctuation">.</span>
结果显示：
	secret 主要有三种类型 tls、generic、docker-registry

</code></pre> 
<pre><code class="prism language-powershell">创建generic类型的secret
kubectl create secret generic <span class="token operator">--</span>help
参数详解:
    <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>file=<span class="token punctuation">[</span><span class="token punctuation">]</span> 				以配置文件的方式创建配置数据
    <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>literal=<span class="token punctuation">[</span><span class="token punctuation">]</span>			以命令行设置键值对的方式配置数据
</code></pre> 
<pre><code class="prism language-powershell">创建tls类型的secret
kubectl create secret tls <span class="token operator">--</span>help
参数详解:
    <span class="token operator">--</span>cert=path/to/cert/file 	指定证书文件
    <span class="token operator">--</span>key=path/to/key/file		指定秘钥文件
</code></pre> 
<pre><code class="prism language-powershell">创建docker-registry类型的secret
kubectl create secret docker-registry <span class="token operator">--</span>help
参数详解:
    <span class="token operator">--</span>docker-username=user 		指定登录用户
    <span class="token operator">--</span>docker-password=password	指定登录密码
    <span class="token operator">--</span>docker-server=string		指定docker仓库
    <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>file=<span class="token namespace">[key=]</span>source	指定秘钥文件
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>命令创建secret实践</p> 
<pre><code class="prism language-powershell">kubectl create secret generic my-secret <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>literal=key1=supersecret <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>literal=key2=topsecret
</code></pre> 
<p>资源对象方式创建secret</p> 
<pre><code class="prism language-powershell">我们以用户名和密码的加密方式进行认证，首先对用户名和密码进行base64加密
<span class="token punctuation">]</span><span class="token comment"># echo -n 'admin' | base64</span>
YWRtaW4=
<span class="token punctuation">]</span><span class="token comment"># echo -n 'password' | base64</span>
cGFzc3dvcmQ=

注意：
	<span class="token operator">-</span>n的作用是仅仅传递字符串内容，而不包括字符串末尾的换行符
</code></pre> 
<pre><code class="prism language-powershell">secret资源定义文件  01_kubernetes_application_secure_secret_data<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Secret
metadata:
 name: superopsmsb-secret
<span class="token function">type</span>: kubernetes<span class="token punctuation">.</span>io/basic-auth
<span class="token keyword">data</span>:
 username: YWRtaW4=
 password: cGFzc3dvcmQ=
	
生成新的对象
kubectl apply <span class="token operator">-</span>f 01_kubernetes_application_secure_secret_data<span class="token punctuation">.</span>yaml
</code></pre> 
<p>pod应用资源对象</p> 
<pre><code class="prism language-powershell">创建资源对象 02_kubernetes_application_secure_secret_nginx_pod<span class="token punctuation">.</span>yml
apiVersion: v1
kind: Pod
metadata:
  name: superopsmsb-secret
spec:
  volumes:
  <span class="token operator">-</span> name: secret-1
    secret:
     secretName: superopsmsb-secret
  <span class="token operator">-</span> name: secret-2
    secret:
     secretName: my-secret     
  containers:
    <span class="token operator">-</span> name: nginx-web
      image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
      volumeMounts:
       <span class="token operator">-</span> name: secret-1
         mountPath: <span class="token operator">/</span>secret-1/
       <span class="token operator">-</span> name: secret-2
         mountPath: <span class="token operator">/</span>secret-2/         
创建资源对象
kubectl apply <span class="token operator">-</span>f 02_kubernetes_application_secure_secret_nginx_pod<span class="token punctuation">.</span>yml
</code></pre> 
<p>查看效果</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@kubernetes-master1 /data/kubernetes/storage]</span><span class="token comment"># kubectl  describe  pod superopsmsb-secret</span>
Name:         superopsmsb-secret
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Containers:
  nginx-web:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    Mounts:
      <span class="token operator">/</span>secret-1/ <span class="token keyword">from</span> secret-1 <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
      <span class="token operator">/</span>secret-2/ <span class="token keyword">from</span> secret-2 <span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Volumes:
  secret-1:
    <span class="token function">Type</span>:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span>
    SecretName:  superopsmsb-secret
    Optional:    false
  secret-2:
    <span class="token function">Type</span>:        Secret <span class="token punctuation">(</span>a volume populated by a Secret<span class="token punctuation">)</span>
    SecretName:  my-secret
    Optional:    false
</code></pre> 
<pre><code class="prism language-powershell">查看文件内容效果
<span class="token punctuation">]</span><span class="token comment"># kubectl  exec -it superopsmsb-secret -- /bin/bash</span>
root@superopsmsb-secret:<span class="token operator">/</span><span class="token comment"># ls /secret-1/</span>
password  username
root@superopsmsb-secret:<span class="token operator">/</span><span class="token comment"># ls /secret-2/</span>
key1  key2
root@superopsmsb-secret:<span class="token operator">/</span><span class="token comment"># echo $(cat /secret-1/username)</span>
admin
root@superopsmsb-secret:<span class="token operator">/</span><span class="token comment"># echo $(cat /secret-2/key1)</span>
supersecret
</code></pre> 
<p>小结</p> 
<pre><code>
</code></pre> 
<h4><a id="113_Secret1_277"></a>1.1.3 Secret案例1</h4> 
<p>学习目标</p> 
<p>这一节，我们从 案例解读、简单实践、小结 三个方面来学习。</p> 
<p><strong>案例解读</strong></p> 
<p>需求</p> 
<pre><code>实践一个基于https来访问的nginx的web服务
</code></pre> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">准备nginx容器的配置目录
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># mkdir nginx-conf-tls</span>

创建主配置文件 
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># vim nginx-conf-tls/superopsmsb.conf</span>
server <span class="token punctuation">{<!-- --></span>
    listen 443 ssl<span class="token punctuation">;</span>
    server_name www<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">;</span>
    ssl_certificate <span class="token operator">/</span>etc/nginx/certs/tls<span class="token punctuation">.</span>crt<span class="token punctuation">;</span> 
    ssl_certificate_key <span class="token operator">/</span>etc/nginx/certs/tls<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
    ssl_session_timeout 5m<span class="token punctuation">;</span>
    ssl_protocols TLSv1 TLSv1<span class="token punctuation">.</span>1 TLSv1<span class="token punctuation">.</span>2<span class="token punctuation">;</span>
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:<span class="token operator">!</span>aNULL:<span class="token operator">!</span>MD5:<span class="token operator">!</span>RC4:<span class="token operator">!</span>DHE<span class="token punctuation">;</span> 
    ssl_prefer_server_ciphers on<span class="token punctuation">;</span>
    include <span class="token operator">/</span>etc/nginx/conf<span class="token punctuation">.</span>d/myserver-<span class="token operator">*</span><span class="token punctuation">.</span>cfg<span class="token punctuation">;</span>
    location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
        root <span class="token operator">/</span>usr/share/nginx/html<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

server <span class="token punctuation">{<!-- --></span>
    listen 80<span class="token punctuation">;</span>
    server_name www<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com<span class="token punctuation">;</span> 
    <span class="token keyword">return</span> 301 https:<span class="token operator">/</span><span class="token operator">/</span><span class="token variable">$host</span><span class="token variable">$request_uri</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>创建证书</p> 
<pre><code class="prism language-powershell">准备nginx容器的配置目录
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># mkdir tls-key</span>

做证书
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># openssl  genrsa -out tls-key/tls.key 2048</span>

做成自签证书
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># openssl req  -new -x509 -key tls-key/tls.key  -out tls-key/tls.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=www.superopsmsb.com</span>
注意：
	域名必须是我们使用的域名信息
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>创建资源对象文件</p> 
<pre><code class="prism language-powershell">创建cm资源对象
kubectl create configmap nginx-ssl-conf <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>file=nginx-conf-tls/

创建secret资源对象
kubectl create secret tls nginx-ssl-secret <span class="token operator">--</span>cert=tls-key/tls<span class="token punctuation">.</span>crt <span class="token operator">--</span>key=tls-key/tls<span class="token punctuation">.</span>key
</code></pre> 
<p>创建应用资源对象</p> 
<pre><code class="prism language-powershell">创建资源配置文件 03_kubernetes_application_secure_secret_cm_nginx_pod<span class="token punctuation">.</span>yml 
apiVersion: v1
kind: Pod
metadata:
  name: superops-nginx-ssl
spec:
  containers:
  <span class="token operator">-</span> image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
    name: nginx-web
    volumeMounts:
    <span class="token operator">-</span> name: nginxcerts
      mountPath: <span class="token operator">/</span>etc/nginx/certs/
      readOnly: true
    <span class="token operator">-</span> name: nginxconfs
      mountPath: <span class="token operator">/</span>etc/nginx/conf<span class="token punctuation">.</span>d/
      readOnly: true
  volumes:
  <span class="token operator">-</span> name: nginxcerts
    secret:
      secretName: nginx-ssl-secret
  <span class="token operator">-</span> name: nginxconfs
    configMap:
      name: nginx-ssl-conf
      optional: false
      
应用资源配置文件
kubectl apply <span class="token operator">-</span>f 03_kubernetes_application_secure_secret_cm_nginx_pod<span class="token punctuation">.</span>yml
</code></pre> 
<p>检查效果</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">]</span><span class="token comment"># kubectl get pods -o wide</span>
NAME                 READY   STATUS    RESTARTS   AGE   IP             NODE    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
superops-nginx-ssl   1/1     Running   0          79s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>2<span class="token punctuation">.</span>6     node2

使用https测试
<span class="token punctuation">]</span><span class="token comment">#  curl -H "Host:www.superopsmsb.com" https://10.244.2.6</span>
curl: <span class="token punctuation">(</span>60<span class="token punctuation">)</span> SSL certificate problem: self signed certificate
More details here: https:<span class="token operator">/</span><span class="token operator">/</span>curl<span class="token punctuation">.</span>haxx<span class="token punctuation">.</span>se/docs/sslcerts<span class="token punctuation">.</span>html

curl failed to verify the legitimacy of the server and therefore could not
establish a secure connection to it<span class="token punctuation">.</span> To learn more about this situation and
how to fix it<span class="token punctuation">,</span> please visit the web page mentioned above<span class="token punctuation">.</span>
结果提示：
	由于是自签证书，所以默认不允许通过，我们可以通过 <span class="token operator">-</span>k的方式，让它忽略警告。
	
<span class="token punctuation">]</span><span class="token comment"># curl -k -H "Host:www.superopsmsb.com" https://10.244.2.6</span>
Hello Nginx<span class="token punctuation">,</span> superops-nginx-ssl-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>0

使用http访问
<span class="token punctuation">]</span><span class="token comment"># curl  http://10.244.2.6</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;<span class="token operator">/</span>title&gt;&lt;<span class="token operator">/</span>head&gt;
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显式：
	这个 301 就是我们定制的返回信息。
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="114_Secret2_418"></a>1.1.4 Secret案例2</h4> 
<p>学习目标</p> 
<p>这一节，我们从 案例解读、简单实践、小结 三个方面来学习</p> 
<p><strong>案例解读</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	截止目前，我们的镜像仓库是以http的方式来存在的，为了方便所有位置都可以正常的下载仓库镜像，所以我们将镜像仓库设置为了公开的。而对于一些私密性的镜像或者说敏感性的镜像来说，我们需要建立一个私有的仓库，在获取镜像的时候，需要通过密码方式才可以下载。
</code></pre> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">在docker harbor中创建一个私有的仓库 register。
</code></pre> 
<p><img src="https://images2.imgbox.com/de/05/0j09dtpu_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">在A主机上提交镜像到私有仓库
docker tag kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1 kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/register/nginx_web:v0<span class="token punctuation">.</span>1
docker push kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/register/nginx_web:v0<span class="token punctuation">.</span>1
</code></pre> 
<pre><code class="prism language-powershell">在B主机上下载私有仓库镜像
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># docker pull kubernetes-register.superopsmsb.com/register/nginx_web:v0.1</span>
Error response <span class="token keyword">from</span> daemon: unauthorized: unauthorized to access repository: register/nginx_web<span class="token punctuation">,</span> action: pull: unauthorized to access repository: register/nginx_web<span class="token punctuation">,</span> action: pull
结果显示：
	无法从私有镜像仓库中获取镜像
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>命令实践</p> 
<pre><code class="prism language-powershell">创建docker-registry类型的secret
kubectl create secret docker-registry <span class="token operator">--</span>help
参数详解:
    <span class="token operator">--</span>docker-username=user 		指定登录用户
    <span class="token operator">--</span>docker-password=password	指定登录密码
    <span class="token operator">--</span>docker-server=string		指定docker仓库
    <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>file=<span class="token namespace">[key=]</span>source	指定秘钥文件
</code></pre> 
<p>创建secret</p> 
<pre><code class="prism language-powershell">创建secret对象
kubectl create secret docker-registry docker-secret <span class="token operator">--</span>docker-server=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com <span class="token operator">--</span>docker-username=shuji <span class="token operator">--</span>docker-password=A12345678a 
</code></pre> 
<p>应用secret</p> 
<pre><code class="prism language-powershell">创建资源对象 04_kubernetes_application_secure_secret_docker_pod<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: superops-docker
spec:
  containers:
  <span class="token operator">-</span> image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
    name: nginx-web
  imagePullSecrets:
    <span class="token operator">-</span> name: docker-secret
</code></pre> 
<pre><code class="prism language-powershell">使用资源对象
kubectl apply <span class="token operator">-</span>f 04_kubernetes_application_secure_secret_docker_pod<span class="token punctuation">.</span>yaml

查看效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># kubectl describe pod superops-docker</span>
Name:         superops-docker
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Containers:
  nginx-web:
    Container ID:   docker:<span class="token operator">/</span><span class="token operator">/</span>6cb4b5486a23b5441372579ea2775ce21308007ac9b1dbd19e6d9d92aa65dd5a
    Image:          kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/register/nginx_web:v0<span class="token punctuation">.</span>1
    Image ID:       docker-pullable:<span class="token operator">/</span><span class="token operator">/</span>kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/register/nginx_web@sha256:4ad6f78ef6996fb7f239b9cfa00891ec8a14a23fb981cc9064c830890143b02c
结果显示：
	可以从通过secret的方式从私有仓库中获取镜像
</code></pre> 
<p>小结</p> 
<pre><code>
</code></pre> 
<h3><a id="12__519"></a>1.2 数据访问</h3> 
<h4><a id="121__521"></a>1.2.1 网络体系解读</h4> 
<p>学习目标</p> 
<p>这一节，我们从 应用流程、细节解读、小结 三个方面来学习</p> 
<p><strong>应用流程</strong></p> 
<p>入口</p> 
<pre><code class="prism language-powershell">	Kubernetes 的 Service定义了一个服务的访问入口地址，前端的应用Pod通过Service访问其背后一组有Pod副本组成的集群示例，Service通过Label Selector访问指定的后端Pod，RC保证Service的服务能力和服务质量处于预期状态。

    Service是Kubernetes中最高一级的抽象资源对象，每个Service提供一个独立的服务，集群Service彼此间使用TCP/IP进行通信，将不同的服务组合在一起运行起来，就行了我们所谓的<span class="token string">"系统"</span>，效果如下图
</code></pre> 
<p><img src="https://images2.imgbox.com/bf/f1/NgN5KOug_o.png" alt="在这里插入图片描述"></p> 
<p>service</p> 
<pre><code class="prism language-powershell">	service是Kubernetes里最核心的资源对象之一，每一个Service都是一个完整的业务服务，我们之前学到的Pod、RC、Deployment等资源对象都是为Service服务的。他们之间的关系如下图：
</code></pre> 
<p><img src="https://images2.imgbox.com/1a/41/VLxqgJsz_o.png" alt="在这里插入图片描述"></p> 
<p><strong>细节解读</strong></p> 
<p>service模式解析</p> 
<p><img src="https://images2.imgbox.com/e6/b6/40yrJZ3G_o.png" alt="在这里插入图片描述"></p> 
<p>service类型</p> 
<pre><code class="prism language-powershell">	对于k8s来说，内部服务的自由通信可以满足我们环境的稳定运行，但是我们作为一个平台，其核心功能还是将平台内部的服务发布到外部环境，那么在k8s环境平台上，Service主要有四种样式来满足我们的需求，种类如下：
</code></pre> 
<pre><code class="prism language-powershell">ClusterIP
	这是service默认的服务暴露模式，主要针对的对象是集群内部。
NodePort
	在ClusterIP的基础上，以&lt;NodeIP&gt;:&lt;NodePort&gt;方式对外提供服务，默认端口范围沿用Docker初期的随机端口范围 30000~32767，但是NodePort设定的时候，会在集群所有节点上实现相同的端口。
	
LoadBalancer
	基于NodePort之上，使用运营商负载均衡器方式实现对外提供服务底层是基于IaaS云创建一个k8s云，同时该平台也支持LBaaS产品服务。
	
ExternalName
	当前k8s集群依赖集群外部的服务，那么通过externalName将外部主机引入到k8s集群内部外部主机名以 DNS方式解析为一个 CNAME记录给k8s集群的其他主机来使用这种Service既不会有ClusterIP，也不会有NodePort<span class="token punctuation">.</span>而且依赖于内部的CoreDNS功能
</code></pre> 
<p>资源属性</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Service
metadata:
  name: …
  namespace: …
  labels:
    key1: value1
    key2: value2
spec:
  <span class="token function">type</span> &lt;string&gt;   					<span class="token comment"># Service类型，默认为ClusterIP</span>
  selector &lt;map<span class="token namespace">[string]</span>string&gt;  	<span class="token comment"># 等值类型的标签选择器，内含“与”逻辑</span>
  ports：  						   <span class="token comment"># Service的端口对象列表</span>
  <span class="token operator">-</span> name &lt;string&gt;  					<span class="token comment"># 端口名称</span>
    protocol &lt;string&gt;  				<span class="token comment"># 协议，目前仅支持TCP、UDP和SCTP，默认为TCP</span>
    port &lt;integer&gt;  				<span class="token comment"># Service的端口号</span>
    targetPort  &lt;string&gt;  			<span class="token comment"># 后端目标进程的端口号或名称，名称需由Pod规范定义</span>
    nodePort &lt;integer&gt;  			<span class="token comment"># 节点端口号，仅适用于NodePort和LoadBalancer类型</span>
  clusterIP  &lt;string&gt;  				<span class="token comment"># Service的集群IP，建议由系统自动分配</span>
  externalTrafficPolicy  &lt;string&gt; 	<span class="token comment"># 外部流量策略处理方式，Local表示由当前节点处理，Cluster表示向集群范围调度</span>
  loadBalancerIP  &lt;string&gt;  		<span class="token comment"># 外部负载均衡器使用的IP地址，仅适用于LoadBlancer</span>
  externalName &lt;string&gt;  			<span class="token comment"># 外部服务名称，该名称将作为Service的DNS CNAME值</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="122_Service_609"></a>1.2.2 Service实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 资源解读、NodePort实践、小结 三个方面来学习</p> 
<p><strong>资源解读</strong></p> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">创建部署资源对象
kubectl create deployment nginx <span class="token operator">--</span>image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1 <span class="token operator">--</span>replicas=3
</code></pre> 
<p>创建资源对象</p> 
<pre><code class="prism language-powershell">资源对象文件 05_kubernetes_application_secure_svc_clusterIP<span class="token punctuation">.</span>yml
apiVersion: v1
kind: Service
metadata:
  name: superopsmsb-nginx-service
spec:
  selector:
    app: nginx
  ports:
  <span class="token operator">-</span> name: http
    port: 80
    
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 05_kubernetes_application_secure_svc_clusterIP<span class="token punctuation">.</span>yml
</code></pre> 
<pre><code class="prism language-powershell">确认资源
kubectl get svc superopsmsb-nginx-service
kubectl describe svc superopsmsb-nginx-service

访问效果
<span class="token punctuation">]</span><span class="token comment"># curl 10.100.79.167</span>
Hello Nginx<span class="token punctuation">,</span> nginx-756889d9f-fq5nh-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1

清理环境
kubectl delete <span class="token operator">-</span>f 05_kubernetes_application_secure_svc_clusterIP<span class="token punctuation">.</span>yml
</code></pre> 
<p><strong>NodePort实践</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">NodePort会在所有的节点主机上，暴露一个指定或者随机的端口，供外部的服务能够正常的访问pod内部的资源。
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">资源对象文件 06_kubernetes_application_secure_svc_nodePort<span class="token punctuation">.</span>yml
apiVersion: v1
kind: Service
metadata:
  name: superopsmsb-nginx-nodeport
spec:
  selector:
    app: nginx
  <span class="token function">type</span>: NodePort
  ports:
  <span class="token operator">-</span> name: http
    port: 80
    nodePort: 30080
    
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 06_kubernetes_application_secure_svc_nodePort<span class="token punctuation">.</span>yml
</code></pre> 
<pre><code class="prism language-powershell">确认资源
kubectl get svc superopsmsb-nginx-nodeport
kubectl describe svc superopsmsb-nginx-nodeport

访问效果
<span class="token punctuation">]</span><span class="token comment"># curl 10.0.0.12:30080</span>
Hello Nginx<span class="token punctuation">,</span> nginx-756889d9f-xjtrb-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1

清理环境
kubectl delete <span class="token operator">-</span>f 06_kubernetes_application_secure_svc_nodePort<span class="token punctuation">.</span>yml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="123_Service_706"></a>1.2.3 Service进阶</h4> 
<p>学习目标</p> 
<p>这一节，我们从 本地流量、会话粘滞、小结 三个方面来学习</p> 
<p><strong>本地流量</strong></p> 
<p>场景</p> 
<pre><code class="prism language-powershell">默认情况下，当一个svc的模式为NodePort类型的时候，他会在所有的集群节点上开放一个相同的端口，但是因为svc默认访问的效果是轮训，所以，当我们在指定一个具体node节点来进行访问的话，它也会自动跳转到其他主机。
</code></pre> 
<pre><code class="prism language-powershell">查看pod对象
<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
NAME                    READY   STATUS        RESTARTS   AGE
nginx-756889d9f-fq5nh   1/1     Running       0          13m
nginx-756889d9f-kcn5c   1/1     Running       0          13m
nginx-756889d9f-xjtrb   1/1     Running       0          13m

查看svc对象
<span class="token punctuation">]</span><span class="token comment"># kubectl get svc superopsmsb-nginx-nodeport</span>
NAME                         <span class="token function">TYPE</span>       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
superopsmsb-nginx-nodeport   NodePort   10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>220<span class="token punctuation">.</span>50   &lt;none&gt;        80:30080/TCP   2m13s

测试效果
<span class="token punctuation">]</span><span class="token comment"># &gt; /tmp/svc.txt</span>
<span class="token punctuation">]</span><span class="token comment"># for i in {1..100}; do curl -s 10.0.0.16:30080 &gt;&gt; /tmp/svc.txt; done</span>
<span class="token punctuation">]</span><span class="token comment"># for i in fq5nh kcn5c xjtrb; do grep $i /tmp/svc.txt | wc -l; done</span>
40
28
32
结果显示：
	可以看到，svc代理的多个pod是以均匀的方式进行代理的。
</code></pre> 
<p>需求</p> 
<pre><code class="prism language-powershell">	如果指定的节点上有对应的pod服务，那么就没有必要来回跳转了，直接用本地流量就可以很好的提高业务的访问效率。service 的提供了一个属性可以定制流量的使用模式：
	externalTrafficPolicy  &lt;string&gt; 	<span class="token comment"># 外部流量策略处理方式</span>
		<span class="token operator">-</span> Local表示由当前节点处理，如果当前节点出现问题，则导致访问异常
		<span class="token operator">-</span> Cluster表示向集群范围调度
</code></pre> 
<pre><code class="prism language-powershell">默认情况下，svc的流量调度采用的是集群范围调度
<span class="token punctuation">]</span><span class="token comment"># kubectl get svc superopsmsb-nginx-nodeport -o yaml  | grep TrafficPolicy</span>
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
</code></pre> 
<p>调整为本地流量调度</p> 
<pre><code class="prism language-powershell">资源对象文件 07_kubernetes_application_secure_svc_local<span class="token punctuation">.</span>yml
apiVersion: v1
kind: Service
metadata:
  name: superopsmsb-nginx-local
spec:
  selector:
    app: nginx
  <span class="token function">type</span>: NodePort
  externalTrafficPolicy: Local
  ports:
  <span class="token operator">-</span> name: http
    port: 80
    nodePort: 30080
    
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 07_kubernetes_application_secure_svc_local<span class="token punctuation">.</span>yml
</code></pre> 
<pre><code class="prism language-powershell">确认资源
kubectl get svc superopsmsb-nginx-local
kubectl describe svc superopsmsb-nginx-local

访问效果
<span class="token punctuation">]</span><span class="token comment"># &gt; /tmp/svc.txt</span>
<span class="token punctuation">]</span><span class="token comment"># for i in {1..100}; do curl -s 10.0.0.16:30080 &gt;&gt; /tmp/svc.txt; done</span>
<span class="token punctuation">]</span><span class="token comment"># for i in fq5nh kcn5c xjtrb; do grep $i /tmp/svc.txt | wc -l; done</span>
100
0
0
结果显示：
	使用的是本地流量了

清理环境
kubectl delete <span class="token operator">-</span>f 07_kubernetes_application_secure_svc_local<span class="token punctuation">.</span>yml
</code></pre> 
<p><strong>会话粘滞</strong></p> 
<p>场景</p> 
<pre><code class="prism language-powershell">	kubernetes的Service功能可以通过多种方式将pod对象提供的服务对外开放，但是当pod多的时候，用户访问service的时候，service默认是按照轮训的情况进行转发，如果我们的用户请求由一定的会话要求，即希望同一个客户能访问一个pod的时候，我们可以使用service的affinity机制来实现，它能将同一个客户端的请求始终转发至同一个后端Pod对象，它是由kube-proxy的ipvs机制来实现的。
	默认情况下，service所提供的会话粘性效果默认在10800s<span class="token punctuation">(</span>3小时<span class="token punctuation">)</span>后会重新调度<span class="token punctuation">,</span>而且仅能基于客户端IP进行识别，调度粒度较粗，不推荐使用
</code></pre> 
<p>属性解析</p> 
<pre><code class="prism language-powershell">属性信息
spec<span class="token punctuation">.</span>sessionAffinity，定义粘性会话的类型，可为 None 和 ClientIP
spec<span class="token punctuation">.</span>sessionAffinityConfig<span class="token punctuation">.</span>clientIP，配置会话保持时长，默认10800s 范围 1-86400

配置样式
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
</code></pre> 
<p>调整为本地流量调度</p> 
<pre><code class="prism language-powershell">资源对象文件 08_kubernetes_application_secure_svc_session<span class="token punctuation">.</span>yml
apiVersion: v1
kind: Service
metadata:
  name: superopsmsb-nginx-session
spec:
  selector:
    app: nginx
  sessionAffinity: ClientIP
  ports:
  <span class="token operator">-</span> name: http
    port: 80
    nodePort: 30080
    
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 08_kubernetes_application_secure_svc_session<span class="token punctuation">.</span>yml
</code></pre> 
<pre><code class="prism language-powershell">确认资源
kubectl get svc superopsmsb-nginx-session
kubectl describe svc superopsmsb-nginx-session

访问效果
<span class="token punctuation">]</span><span class="token comment"># &gt; /tmp/svc.txt</span>
<span class="token punctuation">]</span><span class="token comment"># for i in {1..100}; do curl -s 10.105.65.217 &gt;&gt; /tmp/svc.txt; done</span>
<span class="token punctuation">]</span><span class="token comment"># for i in fq5nh kcn5c xjtrb; do grep $i /tmp/svc.txt | wc -l; done</span>
0
100
0
结果显示：
	应用层面使用的是会话粘滞效果了

清理环境
kubectl delete <span class="token operator">-</span>f 08_kubernetes_application_secure_svc_session<span class="token punctuation">.</span>yml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="124_Service_878"></a>1.2.4 Service解读</h4> 
<p>学习目标</p> 
<p>这一节，我们从 ClusterIP原理、NodePort原理、小结 三个方面来学习</p> 
<p><strong>ClusterIP原理</strong></p> 
<p>简介</p> 
<pre><code>ClusterIP 是service默认的服务暴露模式，主要针对的对象是集群内部。是集群外部流量引入集群的首要方式。
这一节，我们好好的说一下ClusterIP的访问原理，我们主要以 iptables的模式来进行解析。
</code></pre> 
<pre><code>iptables代理模式下的ClusterIP，每个Service在每个节点上(由kube-proxy负责生成)都会生成相应的iptables规则
</code></pre> 
<p>iptables规则解析</p> 
<table><thead><tr><th>规则名称</th><th>规则解析</th></tr></thead><tbody><tr><td>KUBE-SERVICES</td><td>包含所有ClusterIP类型的Service的流量匹配规则，由PREROUTING和OUTPUT两个内置链直接调用；<br>每个Service对象包含两条规则定义: 对于所有发往Service（目标IP为Service_IP且目标端口为Service_Port）的请求报文<br>前一条用于为那些非源自Pod网络（! -s 10.244.0.0/16）中请求报文借助于KUBE-MARQ-MASK自定义链中的规则打上特有的防火墙标记<br>后一条负责将所有报文转至专用的以KUBE-SVC为名称前缀的自定义链，后缀是Service信息hash值。</td></tr><tr><td>KUBE-MARK-MASQ</td><td>专用目的自定义链，所有转至该自定义链的报文都将被置入防火墙标记（0x4000）以便于将特定的类型的报文定义为单独的分类<br>目的在将该类报文转发到目标端点之前由POSTROUTING规则链进行源地址转换。</td></tr><tr><td>KUBE-SVC-</td><td>定义一个服务的流量调度规则，它通过随机调度算法（RANDOM）将请求分发给该Service的所有后端端点<br>每个后端端点定义在以KUBE-SEP为前缀名称的自定链上，后缀是端点信息的hash值。</td></tr><tr><td>KUBE-SEP-</td><td>定义一个端点相关的流量处理规则，它通常包含两条规则<br>前一条用于为那些源自该端点自身（-s ep_ip）的请求流量调用自定义链KUBE-MARQ-MASK打上防火墙标记<br>后一条负责将发往该端点的所有流量进行目标IP地址和端口转换，新目标为该端点的IP和端口（-j DNAT --to-destination ep_ip:ep_port）。</td></tr><tr><td>KUBE-POSTROUTING</td><td>专用的自定义链，由内置链POSTROUTING无条件调用，负责将拥有特有防火墙标记0x4000的请求报文进行源地址转换（Target为实现地址伪装的MASQUERADE），新的源地址为报文离开协议栈时流经接口的主IP（primary ip）地址。</td></tr><tr><td>KUBE-NODEPORTS</td><td>当采用基于ClusterIP的NodePort模型的时候，KUBE-SERVICES会把请求转发给KUBE-NODEPORTS，由KUBE-NODEPORTS将信息转交给KUBE-SVC-规则</td></tr></tbody></table> 
<pre><code>注意：关于iptables的防火墙规则顺序，几乎上每个版本都会发生一些改动
</code></pre> 
<p>环境准备</p> 
<pre><code class="prism language-powershell">准备默认的环境资源对象
kubectl create deployment my-nginx <span class="token operator">--</span>image=kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1 <span class="token operator">--</span>replicas=3
kubectl expose deployment my-nginx <span class="token operator">--</span>port 80
</code></pre> 
<pre><code class="prism language-powershell">查看svc和pod的基本效果
<span class="token punctuation">]</span><span class="token comment"># kubectl get svc my-nginx</span>
NAME       <span class="token function">TYPE</span>        CLUSTER-IP    EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
my-nginx   ClusterIP   10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>9<span class="token punctuation">.</span>95   &lt;none&gt;        80/TCP    3m30s
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/auth_secure]</span><span class="token comment"># kubectl get pod -o wide</span>
NAME                       READY   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> IP            NODE              <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
my-nginx-d46c77b9b-c98zg   1/1     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>14   kubernetes-node2  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
my-nginx-d46c77b9b-scwgm   1/1     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>5<span class="token punctuation">.</span>6    kubernetes-node3  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
my-nginx-d46c77b9b-z67sw   1/1     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>10   kubernetes-node1  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>在node节点上分析iptables的流程</p> 
<pre><code class="prism language-powershell">第一条 OUTPUT链 和 PREROUTING
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  OUTPUT</span>
<span class="token operator">-</span>P OUTPUT ACCEPT
<span class="token operator">-</span>A OUTPUT <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"cali:tVnHkvAo15HuiPy0"</span> <span class="token operator">-</span>j cali-OUTPUT
<span class="token operator">-</span>A OUTPUT <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes service portals"</span> <span class="token operator">-</span>j KUBE-SERVICES
<span class="token operator">-</span>A OUTPUT <span class="token operator">!</span> <span class="token operator">-</span>d 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/8 <span class="token operator">-</span>m addrtype <span class="token operator">--</span>dst-<span class="token function">type</span> LOCAL <span class="token operator">-</span>j DOCKER

<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  PREROUTING</span>
<span class="token operator">-</span>P PREROUTING ACCEPT
<span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"cali:6gwbT8clXdHdC1b1"</span> <span class="token operator">-</span>j cali-PREROUTING
<span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes service portals"</span> <span class="token operator">-</span>j KUBE-SERVICES
<span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>m addrtype <span class="token operator">--</span>dst-<span class="token function">type</span> LOCAL <span class="token operator">-</span>j DOCKER

结果显式：
	所有的数据都交给 KUBE-SERVICES 链处理
		<span class="token operator">-</span> 本机的数据来源 ：独立的docker容器、Pod、<span class="token keyword">Process</span>等
		<span class="token operator">-</span> 其他主机的数据来源，任意对象
</code></pre> 
<pre><code class="prism language-powershell">第二条 KUBE-SERVICES链 <span class="token punctuation">(</span>自定义链<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-SERVICES</span>

确定与测试svc有关系的防火墙规则
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-SERVICES | grep my-nginx</span>
<span class="token operator">-</span>A KUBE-SERVICES <span class="token operator">-</span>d 10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>9<span class="token punctuation">.</span>95/32 <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx cluster IP"</span> <span class="token operator">-</span>m tcp <span class="token operator">--</span>dport 80 <span class="token operator">-</span>j KUBE-SVC-L65ENXXZWWSAPRCR

结果显示：
	这是一条自定义规则链
	只要是发往 service网址<span class="token punctuation">(</span>10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>9<span class="token punctuation">.</span>95<span class="token punctuation">)</span>的数据包都转交给 KUBE-SVC-L65ENXXZWWSAPRCR 链
</code></pre> 
<pre><code class="prism language-powershell">第三条 KUBE-SVC-&lt;HASH&gt;链<span class="token punctuation">(</span>针对service与后端endpoint的负载均衡法则<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  KUBE-SVC-L65ENXXZWWSAPRCR</span>
<span class="token operator">-</span>N KUBE-SVC-L65ENXXZWWSAPRCR
<span class="token operator">-</span>A KUBE-SVC-L65ENXXZWWSAPRCR <span class="token operator">!</span> <span class="token operator">-</span>s 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/16 <span class="token operator">-</span>d 10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>9<span class="token punctuation">.</span>95/32 <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx cluster IP"</span> <span class="token operator">-</span>m tcp <span class="token operator">--</span>dport 80 <span class="token operator">-</span>j KUBE-MARK-MASQ
<span class="token operator">-</span>A KUBE-SVC-L65ENXXZWWSAPRCR <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx -&gt; 10.244.3.10:80"</span> <span class="token operator">-</span>m statistic <span class="token operator">--</span>mode random <span class="token operator">--</span>probability 0<span class="token punctuation">.</span>33333333349 <span class="token operator">-</span>j KUBE-SEP-5U6QNRMHL7SGMPSD
<span class="token operator">-</span>A KUBE-SVC-L65ENXXZWWSAPRCR <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx -&gt; 10.244.4.14:80"</span> <span class="token operator">-</span>m statistic <span class="token operator">--</span>mode random <span class="token operator">--</span>probability 0<span class="token punctuation">.</span>50000000000 <span class="token operator">-</span>j KUBE-SEP-IW6DUZ27KH7RMJIV
<span class="token operator">-</span>A KUBE-SVC-L65ENXXZWWSAPRCR <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx -&gt; 10.244.5.6:80"</span> <span class="token operator">-</span>j KUBE-SEP-XLZEZNQVHC5A6ZHD

结果显示：
	对于源地址不是k8s集群内部的网段<span class="token punctuation">(</span><span class="token operator">!</span> <span class="token operator">-</span>s 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/16<span class="token punctuation">)</span><span class="token punctuation">,</span>同时目标地址是service地址<span class="token punctuation">(</span><span class="token operator">-</span>d 10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>9<span class="token punctuation">.</span>95/32<span class="token punctuation">)</span>的请求进行转发<span class="token punctuation">(</span><span class="token operator">-</span>j KUBE-MARK-MASQ<span class="token punctuation">)</span>
	对于通过第一条规则的正常请求进行转发，模式是随机<span class="token punctuation">(</span><span class="token operator">--</span>mode random<span class="token punctuation">)</span>
	对于不同后端endpoint的转发，第一个节点的流量是1/3<span class="token punctuation">,</span> 对于第二个后端是剩余流量的1/2，最终可以保证所有节点流量负载是1:1
	由于第三个节点没有在当前节点，在其他主机节点，所以需要进行转发<span class="token punctuation">(</span><span class="token operator">-</span>j KUBE-SEP-XLZEZNQVHC5A6ZHD<span class="token punctuation">)</span>
注意：
	这三条负载均衡规则是按照 node1-node2-node3 的顺序排列的
</code></pre> 
<pre><code class="prism language-powershell">第四条 KUBE-MARK-MASQ 链
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-MARK-MASQ</span>
<span class="token operator">-</span>N KUBE-MARK-MASQ
<span class="token operator">-</span>A KUBE-MARK-MASQ <span class="token operator">-</span>j MARK <span class="token operator">--</span><span class="token function">set-xmark</span> 0x4000/0x4000
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables   -t nat -L KUBE-MARK-MASQ</span>
Chain KUBE-MARK-MASQ <span class="token punctuation">(</span>22 references<span class="token punctuation">)</span>
target     prot opt source               destination
MARK       all  <span class="token operator">--</span>  anywhere             anywhere             MARK or 0x4000

结果显示：
	这是一条自定义规则链
	该规则的目的就是为当前规则的请求，添加一个特殊的标签，然后运行所有数据通过
</code></pre> 
<pre><code class="prism language-powershell">第五条 KUBE-SEP-&lt;HASH&gt; 链 <span class="token punctuation">(</span>后端endpoint地址的请求处理<span class="token punctuation">)</span>

本机endpoint转发规则
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-SEP-IW6DUZ27KH7RMJIV</span>
<span class="token operator">-</span>N KUBE-SEP-IW6DUZ27KH7RMJIV
<span class="token operator">-</span>A KUBE-SEP-IW6DUZ27KH7RMJIV <span class="token operator">-</span>s 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>14/32 <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx"</span> <span class="token operator">-</span>j KUBE-MARK-MASQ
<span class="token operator">-</span>A KUBE-SEP-IW6DUZ27KH7RMJIV <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx"</span> <span class="token operator">-</span>m tcp <span class="token operator">-</span>j DNAT <span class="token operator">--</span>to-destination 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>14:80

其他主机endpoint转发规则
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-SEP-5U6QNRMHL7SGMPSD</span>
<span class="token operator">-</span>N KUBE-SEP-5U6QNRMHL7SGMPSD
<span class="token operator">-</span>A KUBE-SEP-5U6QNRMHL7SGMPSD <span class="token operator">-</span>s 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>10/32 <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx"</span> <span class="token operator">-</span>j KUBE-MARK-MASQ
<span class="token operator">-</span>A KUBE-SEP-5U6QNRMHL7SGMPSD <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx"</span> <span class="token operator">-</span>m tcp <span class="token operator">-</span>j DNAT <span class="token operator">--</span>to-destination 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>10:80

结果显示：
	这些规则都是自定义规则链，规则中主要做两件事情：
	1 如果源地址<span class="token punctuation">(</span><span class="token operator">-</span>s 10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>4<span class="token punctuation">.</span>14/32<span class="token punctuation">)</span>是当前节点自己，那么就交给KUBE-MARK-MASQ链处理，
	2 如果是源地址是其他节点对象，那么就做DNAT处理，由当前资源对象<span class="token punctuation">(</span>pod<span class="token punctuation">)</span>来处理
</code></pre> 
<pre><code class="prism language-powershell">第六条 POSTROUTING  <span class="token operator">+</span> KUBE-POSTROUTING链 <span class="token punctuation">(</span>信息的处理<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  POSTROUTING</span>
<span class="token operator">-</span>P POSTROUTING ACCEPT
<span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"cali:O3lYWMrLQYEMJtB5"</span> <span class="token operator">-</span>j cali-POSTROUTING
<span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes postrouting rules"</span> <span class="token operator">-</span>j KUBE-POSTROUTING
<span class="token operator">-</span>A POSTROUTING <span class="token operator">-</span>s 172<span class="token punctuation">.</span>17<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/16 <span class="token operator">!</span> <span class="token operator">-</span>o docker0 <span class="token operator">-</span>j MASQUERADE
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  KUBE-POSTROUTING</span>
<span class="token operator">-</span>N KUBE-POSTROUTING
<span class="token operator">-</span>A KUBE-POSTROUTING <span class="token operator">-</span>m mark <span class="token operator">!</span> <span class="token operator">--</span>mark 0x4000/0x4000 <span class="token operator">-</span>j <span class="token keyword">RETURN</span>
<span class="token operator">-</span>A KUBE-POSTROUTING <span class="token operator">-</span>j MARK <span class="token operator">--</span><span class="token function">set-xmark</span> 0x4000/0x0
<span class="token operator">-</span>A KUBE-POSTROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes service traffic requiring SNAT"</span> <span class="token operator">-</span>j MASQUERADE
结果显式：
	POSTROUTING
		所有请求交给KUBE-POSTROUTING自定义链来处理
	KUBE-POSTROUTING
		对所有不携带mark标识的数据，直接<span class="token keyword">RETURN</span><span class="token punctuation">(</span>因为是子链，所以是上级规则的下一条，即POSTROUTING的第二条规则<span class="token punctuation">)</span>
		如果请求携带mark特殊标识，先将当前的mark标识置为0，然后对源地址进行转换的地址伪装，便于请求的后续处理
</code></pre> 
<p>流程小结</p> 
<p><img src="https://images2.imgbox.com/8b/89/AoN0oDmX_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	一个 Service会在任何一台主机上生成 至少14条规则<span class="token punctuation">,</span>后端pod多的话，规则更多，所以大量service场景下，iptabels规则还是相当多的，性能可能会收到一定程度的影响。
	默认的调度算法是均衡的随机调度算法。
</code></pre> 
<p><strong>NodePort原理</strong></p> 
<p>环境准备</p> 
<pre><code class="prism language-powershell">切换成nodeport类型
kubectl delete svc my-nginx
kubectl expose deployment my-nginx <span class="token operator">--</span>port=80 <span class="token operator">--</span><span class="token function">type</span>=NodePort

确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl get svc my-nginx</span>
NAME       <span class="token function">TYPE</span>       CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>        AGE
my-nginx   NodePort   10<span class="token punctuation">.</span>107<span class="token punctuation">.</span>70<span class="token punctuation">.</span>222   &lt;none&gt;        80:31519/TCP   37s
注意：
	不要使用本地流量externalTrafficPolicy: Local，不然的话转发规则你懂得
</code></pre> 
<p>在node节点上分析iptables的流程</p> 
<pre><code class="prism language-powershell">第一条 OUTPUT链 和 PREROUTING
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S OUTPUT</span>
<span class="token operator">-</span>P OUTPUT ACCEPT
<span class="token operator">-</span>A OUTPUT <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"cali:tVnHkvAo15HuiPy0"</span> <span class="token operator">-</span>j cali-OUTPUT
<span class="token operator">-</span>A OUTPUT <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes service portals"</span> <span class="token operator">-</span>j KUBE-SERVICES
<span class="token operator">-</span>A OUTPUT <span class="token operator">!</span> <span class="token operator">-</span>d 127<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0/8 <span class="token operator">-</span>m addrtype <span class="token operator">--</span>dst-<span class="token function">type</span> LOCAL <span class="token operator">-</span>j DOCKER

<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  PREROUTING</span>
<span class="token operator">-</span>P PREROUTING ACCEPT
<span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"cali:6gwbT8clXdHdC1b1"</span> <span class="token operator">-</span>j cali-PREROUTING
<span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes service portals"</span> <span class="token operator">-</span>j KUBE-SERVICES
<span class="token operator">-</span>A PREROUTING <span class="token operator">-</span>m addrtype <span class="token operator">--</span>dst-<span class="token function">type</span> LOCAL <span class="token operator">-</span>j DOCKER

结果显式：
	所有的数据都交给 KUBE-SERVICES 链处理
		<span class="token operator">-</span> 本机的数据来源 ：独立的docker容器、Pod、<span class="token keyword">Process</span>等
		<span class="token operator">-</span> 其他主机的数据来源，任意对象
</code></pre> 
<pre><code class="prism language-powershell">第二条 KUBE-SERVICES链 <span class="token punctuation">(</span>自定义链<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-SERVICES</span>
<span class="token operator">-</span>N KUBE-SERVICES
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>A KUBE-SERVICES <span class="token operator">-</span>d 10<span class="token punctuation">.</span>107<span class="token punctuation">.</span>70<span class="token punctuation">.</span>222/32 <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx cluster IP"</span> <span class="token operator">-</span>m tcp <span class="token operator">--</span>dport 80 <span class="token operator">-</span>j KUBE-SVC-L65ENXXZWWSAPRCR
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token operator">-</span>A KUBE-SERVICES <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes service nodeports; NOTE: this must be the last rule in this chain"</span> <span class="token operator">-</span>m addrtype <span class="token operator">--</span>dst-<span class="token function">type</span> LOCAL <span class="token operator">-</span>j KUBE-NODEPORTS

结果显示：
	如果需要走 ClusterIP 的话，直接走第一条规则，由于我们这里准备走的是 NodePort类型，所以走的是最后一条<span class="token punctuation">,</span>另外如果所有的kube-service规则都没有匹配到的话，也会走最后一条，跳转到 KUBE-NODEPORTS 链进行处理
	
注意：
	虽然我们故意将最佳使用本地流量的 externalTrafficPolicy: Local 属性取消了，但是默认值仍然是它。因为没有特殊的指定externalTrafficPolicy，所以基于cluster全局的调度策略进行流量的指定，一旦设定了这条属性，则会在KUBE-NODEPORTS内部和 KUBE-SVC-XXX 之间，增加一个 KUBE-XLB-XXX 的本地调度策略
</code></pre> 
<pre><code class="prism language-powershell">第三条 KUBE-NODEPORTS链<span class="token punctuation">(</span>针对service与后端endpoint的负载均衡法则<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S  KUBE-NODEPORTS</span>
<span class="token operator">-</span>N KUBE-NODEPORTS
<span class="token operator">-</span>A KUBE-NODEPORTS <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"kubernetes-dashboard/kubernetes-dashboard"</span> <span class="token operator">-</span>m tcp <span class="token operator">--</span>dport 30443 <span class="token operator">-</span>j KUBE-EXT-CEZPIJSAUFW5MYPQ
<span class="token operator">-</span>A KUBE-NODEPORTS <span class="token operator">-</span>p tcp <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"default/my-nginx"</span> <span class="token operator">-</span>m tcp <span class="token operator">--</span>dport 31519 <span class="token operator">-</span>j KUBE-EXT-L65ENXXZWWSAPRCR
结果显示：
	每一个nodeport类型的service都会在这里生成一条规则
</code></pre> 
<pre><code class="prism language-powershell">第四条 KUBE-SEP-&lt;HASH&gt; 链 <span class="token punctuation">(</span>后端endpoint地址的请求处理<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># iptables -t nat -S KUBE-EXT-L65ENXXZWWSAPRCR</span>
<span class="token operator">-</span>N KUBE-EXT-L65ENXXZWWSAPRCR
<span class="token operator">-</span>A KUBE-EXT-L65ENXXZWWSAPRCR <span class="token operator">-</span>m comment <span class="token operator">--</span>comment <span class="token string">"masquerade traffic for default/my-nginx external destinations"</span> <span class="token operator">-</span>j KUBE-MARK-MASQ
<span class="token operator">-</span>A KUBE-EXT-L65ENXXZWWSAPRCR <span class="token operator">-</span>j KUBE-SVC-L65ENXXZWWSAPRCR

结果显示：
	将相关流量转发给了KUBE-MARK-MASQ 或者 转发给 KUBE-SEP-XXX了
</code></pre> 
<pre><code class="prism language-powershell">后续的 KUBE-MARK-MASQ 链、POSTROUTING链、KUBE-POSTROUTING链的操作与clusterIP的效果就一致了
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/13/b5mb7nHd_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	一个 Service会在任何一台主机上生成 至少 15条规则<span class="token punctuation">,</span>后端pod多的话，规则更多，所以大量service场景下，iptabels规则还是相当多的，性能可能会收到一定程度的影响。
	默认的调度算法是均衡的随机调度算法。
</code></pre> 
<pre><code class="prism language-powershell">	关于 NodePort<span class="token punctuation">(</span>携带externalTrafficPolicy属性<span class="token punctuation">)</span> 的规则 和 ExternalIP 等模型的出口方式，大家自己来梳理
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h3><a id="13__1151"></a>1.3 应用流量</h3> 
<h4><a id="131_Ingress_1153"></a>1.3.1 Ingress基础</h4> 
<p>学习目标</p> 
<p>这一节，我们从 场景需求、方案解读、小结 三个方面来学习。</p> 
<p><strong>场景需求</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	在实际的应用中，kubenetes接受的不仅仅有内部的流量，还有外部流量，我们可以通过两种方式实现将集群外部的流量引入到集群的内部中来，从而实现外部客户的正常访问。
</code></pre> 
<pre><code class="prism language-powershell">service方式：
    nodePort、externalIP 等service对象方式，借助于 namespace、iptables、ipvs 等代理模式实现流量的转发。
Host方式：
    通过node节点的 hostNetwork 与 hostPort 及配套的port映射，以间接的方式实现service的效果
</code></pre> 
<p>k8s网络</p> 
<p><img src="https://images2.imgbox.com/ef/0e/5op5uHKQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">在业内有一个不成文的说法，就是：
	将集群内部 pod之类对象 之间的网络通信称为 东西向流量；
	将集群外部应用 和 集群内部之间对象 之间的网络通信 称为 南北向流量。
		南入↓  <span class="token operator">--</span> ingress
		北出↑  <span class="token operator">--</span> egress
</code></pre> 
<p>问题</p> 
<pre><code class="prism language-powershell">	1 在实际的应用中，虽然我们可以基于service或host等多种方式实现集群内外的网络通信，但是这些内容都是基于四层协议来进行调度的，而且服务级别的健康检查功能很难实现。
	2 而对于外部流量的接入，一般都是http<span class="token punctuation">(</span>s<span class="token punctuation">)</span>协议的数据，四层协议是无法实现的。尤其是涉及到各种ssl会话的管理，由于其位于osi七层模型的会话层，要高于传输层的四层，service和host是无法正常实现的。
	3 虽然service能够实现将外部流量引入到集群内部，但是其本质上，是通过网络规则方式来进行转发的，形象的说法就是在墙上打洞，将集群内部的服务暴露到外部。甚至这些洞和洞之间根本没有关联关系。	
</code></pre> 
<p>方案</p> 
<p><img src="https://images2.imgbox.com/42/2b/xyIoJbrD_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	为了解决上述的问题，就引入了一种新的解决方法ingress，简单来说，它可以解决上面提出的三个问题：
		1 可以基于https的方式，将集群外部的流量统一的引入到集群内部
		2 通过一个统一的流量入口，避免将集群内部大量的<span class="token string">"洞"</span>暴露给外部。
	
	ingress这种利用应用层协议来进行流量的负载均衡效果，它可以实现让用户通过域名来访问相应的service就可以了，无需关心Node IP及Port是什么，避免了信息的泄露。
</code></pre> 
<pre><code class="prism language-powershell">	ingress 是k8s上的一种标准化资源格式，它为了剥离与特定负载均衡功能实现软件的相关性，而抽象出来的一种公共的统一的声明式配置格式。然后借助于特定的ingress controller功能负责将其加载并转换成k8s集群内部的配置信息。
	ingress的特点符合我们之前对于CRD的学习 <span class="token operator">-</span> ingress <span class="token operator">+</span> controller，所以，其具备了动态更新并加载新配置的特性。而且ingress本身是不具备实现集群内外流量通信的功能的，这个功能是通过 controller来实现的。
</code></pre> 
<p><strong>方案解读</strong></p> 
<p>实现</p> 
<pre><code class="prism language-powershell">	Ingress由任何具有反向代理功能的程序实现，如Nginx、Traefik、Envoy、HAProxy、Vulcand等，Ingress本身是运行于集群中的Pod资源对象。
	ingress 主要包含两个组件Ingress Controller和Ingress。
</code></pre> 
<table><thead><tr><th>组件</th><th>解析</th></tr></thead><tbody><tr><td>Ingress</td><td>将Nginx的配置抽象成一个Ingress对象，每个服务对应一个ingress的yaml配置文件</td></tr><tr><td>Ingress Controller</td><td>将新加入的Ingress转化成Nginx的配置文件并使之生效</td></tr></tbody></table> 
<p>问题梳理</p> 
<pre><code class="prism language-powershell">如果我们将ingress 以pod的方式部署到k8s集群内部，那么就会遇到多个问题：
	1 ingress的pod如何引入外部流量
		<span class="token operator">-</span> 通过一个专用的service就可以实现了
	2 ingress的pod如何把流量负载均衡到其他pod
		<span class="token operator">-</span> 关于pod负载均衡的流量，直接通过controller转发给后端pod即可。
	3 后端应用的pod很多，如何知道谁是我们要转发的目标？
		<span class="token operator">-</span> 通过k8s的server对所有的pod进行分组管理，借助于controller内部的负载均衡配置，找到对应的目标。
</code></pre> 
<p>原理解析</p> 
<pre><code class="prism language-powershell">Ingress是授权入站连接到达集群服务的规则集合。
    从外部流量调度到nodeport上的service
    从service调度到ingress-controller
    ingress-controller根据ingress<span class="token namespace">[Pod]</span>中的定义（虚拟主机或者后端的url）
    根据虚拟主机名直接调度到后端的一组应用pod中
</code></pre> 
<p><img src="https://images2.imgbox.com/0e/52/ye05iEp0_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">注意：
	整个流程中涉及到了两处service内容
	service ingress-nginx 是帮ingress controller接入外部流量的
	虚线表示service对后端的应用进行分组，实现是ingress实际的访问流程
</code></pre> 
<p>常见的解决方案</p> 
<pre><code class="prism language-powershell">对于ingress controller的软件实现，其实没有特殊的要求，只要能够实现七层的负载均衡功能效果即可，各种组织对于ingress的controller虽然实现方式不同，但是功能基本上一样，常见的实现方式有：
Ingress-Nginx: Kong
HAProxy
	性能相对于nginx来说，较稳定
Envoy: 
	基于C+<span class="token operator">+</span>语言开发，本身就为动态环境设计的，支持配置动态加载的XDS API
	不能像ingress-nginx一样，直接加载配置文件并动态加载转换成对应的应用配置，所以需要借助于其他控制平面工具来实现。
	常见解决方案：Contour<span class="token punctuation">,</span> Gloo
Traefik
</code></pre> 
<pre><code class="prism language-powershell">注意：ingress 自从 1<span class="token punctuation">.</span>6版本引入后，在1<span class="token punctuation">.</span>19 正式进入了一个稳定版本状态。
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="132_Ingress_1287"></a>1.3.2 Ingress实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 环境部署、简单实践、小结 三个方面来学习。</p> 
<p><strong>环境部署</strong></p> 
<pre><code class="prism language-powershell">参考资料：https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kubernetes/ingress-nginx
安装文档：https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/ingress-nginx/deploy/
</code></pre> 
<p>配置文件解析</p> 
<pre><code class="prism language-powershell">apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1   			<span class="token comment"># 资源所属的API群组和版本</span>
kind: Ingress   							<span class="token comment"># 资源类型标识符</span>
metadata:  									<span class="token comment"># 元数据</span>
  name &lt;string&gt;  							<span class="token comment"># 资源名称</span>
  annotations:   							<span class="token comment"># 资源注解，v1beta1使用下面的注解来指定要解析该资源的控制器类型</span>
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: &lt;string&gt;   <span class="token comment"># 适配的Ingress控制器类别,便于多ingress组件场景下，挑选针对的类型</span>
  namespace &lt;string&gt;  						<span class="token comment"># 名称空间</span>
spec:
  rules &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object&gt;   						<span class="token comment"># Ingress规则列表，也就是http转发时候用到的 url关键字</span>
  <span class="token operator">-</span> host &lt;string&gt;   						<span class="token comment"># 虚拟主机的FQDN，支持“*”前缀通配，不支持IP，不支持指定端口</span>
    http &lt;Object&gt;
      paths &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object&gt;   					<span class="token comment"># 虚拟主机PATH定义的列表，由path和backend组成</span>
      <span class="token operator">-</span> path &lt;string&gt;   					<span class="token comment"># 流量匹配的HTTP PATH，必须以/开头</span>
        pathType &lt;string&gt;  					<span class="token comment"># 支持Exact、Prefix和ImplementationSpecific，必选</span>
        backend &lt;Object&gt;   					<span class="token comment"># 匹配到的流量转发到的目标后端</span>
          resource &lt;Object&gt;   				<span class="token comment"># 引用的同一名称空间下的资源，与下面两个字段互斥</span>
          service &lt;object&gt;  				<span class="token comment"># 关联的后端Service对象</span>
            name &lt;string&gt;  					<span class="token comment"># 后端Service的名称</span>
            port &lt;object&gt;  					<span class="token comment"># 后端Service上的端口对象</span>
              name &lt;string&gt;  	 			<span class="token comment"># 端口名称</span>
              number &lt;integer&gt;   			<span class="token comment"># 端口号</span>
  tls &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object&gt;   							<span class="token comment"># TLS配置，用于指定上rules中定义的哪些host需要工作HTTPS模式</span>
  <span class="token operator">-</span> hosts &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;   						<span class="token comment"># 使用同一组证书的主机名称列表</span>
    secretName &lt;string&gt;   					<span class="token comment"># 保存于数字证书和私钥信息的secret资源名称，用于主机认证</span>
  backend &lt;Object&gt;   						<span class="token comment"># 默认backend的定义，可嵌套字段及使用格式跟rules字段中的相同</span>
  ingressClassName  &lt;string&gt;   				<span class="token comment"># ingress类名称，用于指定适配的控制器，类似于注解的功能</span>
</code></pre> 
<p>环境部署</p> 
<pre><code class="prism language-powershell">获取配置文件
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/app_secure
mkdir ingress <span class="token punctuation">;</span> cd ingress
wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com/kubernetes/ingress-nginx/controller-v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>1/deploy/static/provider/baremetal/deploy<span class="token punctuation">.</span>yaml
<span class="token function">mv</span> deploy<span class="token punctuation">.</span>yaml ingress-deploy<span class="token punctuation">.</span>yaml
<span class="token function">cp</span> ingress-deploy<span class="token punctuation">.</span>yaml<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">默认镜像
<span class="token punctuation">]</span><span class="token comment"># grep image: ingress-deploy.yaml | awk -F '/|@' '{print $(NF-1)}' | uniq</span>
controller:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>1
kube-webhook-certgen:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0

获取镜像
<span class="token keyword">for</span> i in nginx-ingress-controller:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>1 kube-webhook-certgen:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
<span class="token keyword">do</span>
  docker pull registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$i</span>
  docker tag registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$i</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$i</span>
  docker push kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$i</span>
  docker rmi registry<span class="token punctuation">.</span>cn-hangzhou<span class="token punctuation">.</span>aliyuncs<span class="token punctuation">.</span>com/google_containers/<span class="token variable">$i</span>
done
注意：
	controller的名称是需要更改一下，阿里云的镜像名称多了一个标识
</code></pre> 
<pre><code class="prism language-powershell">修改基础镜像
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># grep image: ingress-deploy.yaml</span>
          image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/nginx-ingress-controller:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>1
          image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/kube-webhook-certgen:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
          image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/kube-webhook-certgen:v1<span class="token punctuation">.</span>3<span class="token punctuation">.</span>0
          
开放访问入口地址  
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># vim ingress-deploy.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
334 apiVersion: v1
335 kind: Service
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
344   namespace: ingress-nginx
345 spec:
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
348   ipFamilyPolicy: SingleStack
349   externalIPs: <span class="token punctuation">[</span><span class="token string">'10.0.0.12'</span><span class="token punctuation">]</span>			<span class="token comment"># 限制集群外部访问的入口ip</span>
350   ports:
351   <span class="token operator">-</span> appProtocol: http
352     name: http
353     port: 80
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
628   failurePolicy: Ignore				    <span class="token comment"># 为了避免默认的准入控制限制，改为Ignore</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">应用资源配置文件
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># kubectl apply -f ingress-deploy.yaml</span>

确认效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># kubectl get all -n ingress-nginx</span>
NAME                                            READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-admission-create-s5p7h        0/1     Completed   0          105s
pod/ingress-nginx-admission-patch-qnjmv         0/1     Completed   0          105s
pod/ingress-nginx-controller-6cc467dfd9-c2dfg   1/1     Running     0          105s

NAME                                         <span class="token function">TYPE</span>        CLUSTER-IP       EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>                      AGE
service/ingress-nginx-controller             NodePort    10<span class="token punctuation">.</span>109<span class="token punctuation">.</span>163<span class="token punctuation">.</span>145   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12     80:30439/TCP<span class="token punctuation">,</span>443:31912/TCP   105s
service/ingress-nginx-controller-admission   ClusterIP   10<span class="token punctuation">.</span>96<span class="token punctuation">.</span>223<span class="token punctuation">.</span>121    &lt;none&gt;        443/TCP                      105s

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment<span class="token punctuation">.</span>apps/ingress-nginx-controller   1/1     1            1           105s

NAME                                                  DESIRED   CURRENT   READY   AGE
replicaset<span class="token punctuation">.</span>apps/ingress-nginx-controller-6cc467dfd9   1         1         1       105s

NAME                                       COMPLETIONS   DURATION   AGE
job<span class="token punctuation">.</span>batch/ingress-nginx-admission-create   1/1           8s         105s
job<span class="token punctuation">.</span>batch/ingress-nginx-admission-patch    1/1           7s         105s
</code></pre> 
<pre><code class="prism language-powershell">测试访问页面
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># curl 10.0.0.12:30439</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;404 Not Found&lt;<span class="token operator">/</span>title&gt;&lt;<span class="token operator">/</span>head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;404 Not Found&lt;<span class="token operator">/</span>h1&gt;&lt;<span class="token operator">/</span>center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;<span class="token operator">/</span>center&gt;
&lt;<span class="token operator">/</span>body&gt;
&lt;<span class="token operator">/</span>html&gt;
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">定义nginx服务
kubectl create deployment superopsmsb-nginx <span class="token operator">--</span>image kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
kubectl expose deployment superopsmsb-nginx <span class="token operator">--</span>port 80

定义tomcat服务
kubectl create deployment superopsmsb-tomcat <span class="token operator">--</span>image kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/tomcat_web:v0<span class="token punctuation">.</span>1
kubectl expose deployment superopsmsb-tomcat <span class="token operator">--</span>port 8080
</code></pre> 
<p>创建ingress</p> 
<pre><code class="prism language-powershell">定义资源文件 09_kubernetes_application_secure_ingress_test<span class="token punctuation">.</span>yaml 
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: superopsmsb-ingress
  annotations:
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: <span class="token string">"nginx"</span>
spec:
  rules:
  <span class="token operator">-</span> host: nginx<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-nginx
            port: 
              number: 80

属性解析：
	注释信息，对于不同的ingress的内容是不一样的
	对于ingress来说，最终要的就是rules了，这里的hosts是一个自定义的域名
    
应用资源文件
kubectl apply <span class="token operator">-</span>f 09_kubernetes_application_secure_ingress_test<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># kubectl get ingress</span>
NAME                  <span class="token keyword">CLASS</span>    HOSTS                   ADDRESS   PORTS   AGE
superopsmsb-ingress   &lt;none&gt;   nginx<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com             80      17s

查看详细信息
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># kubectl describe ingress superopsmsb-ingress</span>
Name:             superopsmsb-ingress
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Rules:
  Host                   Path  Backends
  <span class="token operator">--</span><span class="token operator">--</span>                   <span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
  nginx<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
                         <span class="token operator">/</span>   superopsmsb-nginx:80 <span class="token punctuation">(</span>10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>5<span class="token punctuation">.</span>15:80<span class="token punctuation">)</span>
Annotations:             kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: nginx
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显式：
	ingress 将 后端的superopsmsb-nginx-service:80 的样式自动与 ingress 的 url<span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">)</span> 关联在一起了
</code></pre> 
<pre><code class="prism language-powershell">访问效果
<span class="token punctuation">]</span><span class="token comment"># echo '10.0.0.12 nginx.superopsmsb.com' &gt;&gt; /etc/hosts</span>

确认效果
<span class="token punctuation">]</span><span class="token comment"># curl nginx.superopsmsb.com</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-deployment-64fc5c5f6c-dt4hx-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>0
<span class="token punctuation">]</span><span class="token comment"># curl 10.0.0.12 -H "Host: nginx.superopsmsb.com"</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-74bf9646c5-bqcld-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
结果显式：
	通过域名可以正常的访问后端的服务，而非域名访问方式受到了限制
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="133_Ingress_1514"></a>1.3.3 Ingress进阶</h4> 
<p>学习目标</p> 
<p>这一节，我们从 多host、多url、小结 三个方面来学习。</p> 
<p><strong>多host</strong></p> 
<p>需求</p> 
<pre><code>访问 tomcat.superopsmsb.com/的时候，返回tomcat的结果
访问 nginx.superopsmsb.com/的时候，返回nginx的结果
</code></pre> 
<p>资源配置文件</p> 
<pre><code class="prism language-powershell">编辑资源定义文件 10_kubernetes_application_secure_ingress_mulhost<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: superopsmsb-ingress-mulhost
  annotations:
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: <span class="token string">"nginx"</span>
spec:
  rules:
  <span class="token operator">-</span> host: nginx<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-nginx
            port:
              number: 80
  <span class="token operator">-</span> host: tomcat<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-tomcat
            port:
              number: 8080
 配置解析：
 	这里面有两个主机访问的地址是同一个后端端口，如果还用number的话，就无法正常的识别导致同一个地址访问不同的后端效果
              
应用资源文件
kubectl apply <span class="token operator">-</span>f 10_kubernetes_application_secure_ingress_mulhost<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看ingress效果
kubectl get ingress
kubectl describe ingress superopsmsb-ingress-mulhost
</code></pre> 
<pre><code class="prism language-powershell">访问效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl 10.0.0.12 -H "Host: nginx.superopsmsb.com"</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-74bf9646c5-bqcld-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl 10.0.0.12 -H "Host: tomcat.superopsmsb.com"</span>
Hello Tomcat<span class="token punctuation">,</span> superopsmsb-tomcat-5bc5cc946d-jnbhc-10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>23
</code></pre> 
<pre><code class="prism language-powershell">环境收尾
kubectl delete <span class="token operator">-</span>f 10_kubernetes_application_secure_ingress_mulhost<span class="token punctuation">.</span>yaml
</code></pre> 
<ul><li>单域名多url访问</li></ul> 
<p>需求</p> 
<pre><code>访问 shuji.superopsmsb.com/tomcat的时候，返回tomcat的结果
访问 shuji.superopsmsb.com/nginx的时候，返回nginx的结果

注意事项：
	由于这里涉及到了域名的url转发，而后端服务有可能不存在，随意我们需要在后端url转发的时候，取消转发关键字。
	方法就是，在annotation中添加一个重写的规则
		nginx.ingress.kubernetes.io/rewrite-target: /
		即，所有的请求，把ingress匹配到的url关键字清除掉
</code></pre> 
<p>测试效果</p> 
<pre><code class="prism language-powershell">编辑资源定义文件 11_kubernetes_application_secure_ingress_mulurl<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: superopsmsb-ingress-mulurl
  annotations:
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: <span class="token string">"nginx"</span>
    nginx<span class="token punctuation">.</span>ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/rewrite-target: <span class="token operator">/</span>
spec:
  rules:
  <span class="token operator">-</span> host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>nginx
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-nginx
            port:
              number: 80
      <span class="token operator">-</span> path: <span class="token operator">/</span>tomcat
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-tomcat
            port:
              number: 8080
              
应用资源文件
kubectl  apply <span class="token operator">-</span>f 11_kubernetes_application_secure_ingress_mulurl<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看效果
kubectl get ingress
kubectl describe ingress superopsmsb-ingress-mulurl
</code></pre> 
<pre><code class="prism language-powershell">浏览器访问效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl 10.0.0.12/nginx -H "Host: shuji.superopsmsb.com"       Hello Nginx, superopsmsb-nginx-74bf9646c5-bqcld-1.23.1</span>
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl 10.0.0.12/tomcat -H "Host: shuji.superopsmsb.com"</span>
Hello Tomcat<span class="token punctuation">,</span> superopsmsb-tomcat-5bc5cc946d-jnbhc-10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>23
</code></pre> 
<pre><code class="prism language-powershell">环境收尾
kubectl delete <span class="token operator">-</span>f 11_kubernetes_application_secure_ingress_mulurl<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="134_Ingress_1663"></a>1.3.4 Ingress认证</h4> 
<p>学习目标</p> 
<p>这一节，我们从 web认证、属性认证、小结 三个方面来学习。</p> 
<p><strong>web认证</strong></p> 
<p>需求</p> 
<pre><code>我们准备对基础的nginx应用进行https方式来进行访问

方法：
	ingress的tls规则就可以帮助我们实现对http应用进行https升级
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">定制secret文件
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/app_secure
mkdir ingress-tls &amp;&amp; cd ingress-tls
<span class="token punctuation">(</span>umask 077<span class="token punctuation">;</span> openssl genrsa <span class="token operator">-</span>out tls<span class="token punctuation">.</span>key 2048<span class="token punctuation">)</span>
openssl req <span class="token operator">-</span>new <span class="token operator">-</span>x509 <span class="token operator">-</span>key tls<span class="token punctuation">.</span>key <span class="token operator">-</span>out tls<span class="token punctuation">.</span>crt <span class="token operator">-</span>subj <span class="token string">"/CN=nginx.superopsmsb.com"</span> <span class="token operator">-</span>days 365
kubectl create secret tls superopsmsb-ingress-tls <span class="token operator">--</span>cert=<span class="token punctuation">.</span><span class="token operator">/</span>tls<span class="token punctuation">.</span>crt <span class="token operator">--</span>key=<span class="token punctuation">.</span><span class="token operator">/</span>tls<span class="token punctuation">.</span>key

确认效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress-tls]</span><span class="token comment"># ls</span>
tls<span class="token punctuation">.</span>crt  tls<span class="token punctuation">.</span>key
</code></pre> 
<pre><code class="prism language-powershell">编辑资源定义文件 12_kubernetes_application_secure_ingress_tls<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: superopsmsb-ingress-tls
  annotations:
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: <span class="token string">"nginx"</span>
spec:
  rules:
  <span class="token operator">-</span> host: nginx<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-nginx
            port:
              number: 80
  tls:
  <span class="token operator">-</span> hosts:
    <span class="token operator">-</span> shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    secretName: superopsmsb-ingress-tls
              
应用资源文件
kubectl apply <span class="token operator">-</span>f 12_kubernetes_application_secure_ingress_tls<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看效果
kubectl get ingress
kubectl describe ingress superopsmsb-ingress-tls
</code></pre> 
<pre><code class="prism language-powershell">访问测试效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl 10.0.0.12 -H "Host: nginx.superopsmsb.com"</span>
&lt;html&gt;
&lt;head&gt;&lt;title&gt;308 Permanent Redirect&lt;<span class="token operator">/</span>title&gt;&lt;<span class="token operator">/</span>head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;308 Permanent Redirect&lt;<span class="token operator">/</span>h1&gt;&lt;<span class="token operator">/</span>center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;<span class="token operator">/</span>center&gt;
&lt;<span class="token operator">/</span>body&gt;
&lt;<span class="token operator">/</span>html&gt;

<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl https://10.0.0.12 -H "Host: nginx.superopsmsb.com" -k</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-74bf9646c5-bqcld-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre> 
<p><strong>属性认证</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	如果我们的容器应用本身就已经实现了https的功能，关于对集群内部的ingress的tls访问方式，可以借助于ingress controller的annotation的方式向nginx中传递一些属性，从而上nginx支持相应的功能。
		1 通过两个annotation中的规则
			ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/ssl-passthrough: <span class="token string">"true"</span>
				<span class="token operator">-</span> 以为后面的dashboard本身就做了tls功能，所以这里进行tls代理即可
    		nginx<span class="token punctuation">.</span>ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/backend-protocol: <span class="token string">"HTTPS"</span>
    			<span class="token operator">-</span> 对后端直接启动https协议访问即可。
    			
参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/ingress-nginx/user-guide/nginx-configuration/annotations/
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">构建nginx镜像 <span class="token operator">-</span> 开放443端口
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>images/web/nginx

编辑Dockerfile增加如下内容
EXPOSE 80 443

构建镜像
docker build <span class="token operator">-</span>t kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>2 <span class="token punctuation">.</span>

提交镜像
docker push kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>2
</code></pre> 
<pre><code class="prism language-powershell">清理deployment和svc
kubectl delete deployments<span class="token punctuation">.</span>apps superopsmsb-nginx
kubectl delete svc superopsmsb-nginx

创建https格式的业务应用
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/app_secure
kubectl create configmap nginx-ssl-conf <span class="token operator">--</span><span class="token keyword">from</span><span class="token operator">-</span>file=nginx-conf-tls/
kubectl create secret tls nginx-ssl-secret <span class="token operator">--</span>cert=tls-key/tls<span class="token punctuation">.</span>crt <span class="token operator">--</span>key=tls-key/tls<span class="token punctuation">.</span>key
</code></pre> 
<pre><code class="prism language-powershell">资源清单文件 13_kubernetes_application_secure_ingress_tls_deployment<span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: superopsmsb-nginx
spec:
  replicas: 1
  selector:
    matchLabels:
      app: superopsmsb-nginx
  template:
    metadata:
      labels:
        app: superopsmsb-nginx
    spec:
      containers:
      <span class="token operator">-</span> name: nginx
        image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>2
        volumeMounts:
        <span class="token operator">-</span> name: nginxcerts
          mountPath: <span class="token operator">/</span>etc/nginx/certs/
          readOnly: true
        <span class="token operator">-</span> name: nginxconfs
          mountPath: <span class="token operator">/</span>etc/nginx/conf<span class="token punctuation">.</span>d/
          readOnly: true
      volumes:
      <span class="token operator">-</span> name: nginxcerts
        secret:
          secretName: nginx-ssl-secret
      <span class="token operator">-</span> name: nginxconfs
        configMap:
          name: nginx-ssl-conf
          optional: false
<span class="token operator">--</span><span class="token operator">-</span>
kind: Service
apiVersion: v1
metadata:
  name: superopsmsb-nginx
spec:
  ports:
  <span class="token operator">-</span> name: http
    port: 80
    protocol: TCP
    targetPort: 80
  <span class="token operator">-</span> name: https
    port: 443
    protocol: TCP
    targetPort: 443
  selector:
    app: superopsmsb-nginx
应用资源配置文件
kubectl apply <span class="token operator">-</span>f 13_kubernetes_application_secure_ingress_tls_deployment<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">测试效果
kubectl get  svc superopsmsb-nginx
kubectl describe  svc superopsmsb-nginx
</code></pre> 
<pre><code class="prism language-powershell">访问Pod
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl -k -H "Host:www.superopsmsb.com" https://10.244.5.17</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-7b89fbfd4-bzgkd-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1

访问svc
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl https://10.103.23.88 -k</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-fb8c87f7f-vp22q-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre> 
<p>ingress定制</p> 
<pre><code class="prism language-powershell">资源对象文件 14_kubernetes_application_secure_ingress_tls<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: superopsmsb-ingress-tls
  annotations:
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: <span class="token string">"nginx"</span>
    ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/ssl-passthrough: <span class="token string">"true"</span>
    nginx<span class="token punctuation">.</span>ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/backend-protocol: <span class="token string">"HTTPS"</span>
spec:
  rules:
  <span class="token operator">-</span> host: www<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>
        pathType: Prefix
        backend:
          service:
            name: superopsmsb-nginx
            port:
              number: 443    			<span class="token comment"># 转发的时候，使用443端口</span>
              
应用资源对象
kubectl apply <span class="token operator">-</span>f 14_kubernetes_application_secure_ingress_tls<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查效果
kubectl get ingress
kubectl describe ingress superopsmsb-ingress-tls

确认效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl -k -H "Host:www.superopsmsb.com" https://10.0.0.12     Hello Nginx, superopsmsb-nginx-fb8c87f7f-vp22q-1.23.1</span>
</code></pre> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="135_Ingress_1903"></a>1.3.5 Ingress高阶</h4> 
<p>学习目标</p> 
<p>这一节，我们从 动态URL、简单实践、小结 三个方面来学习。</p> 
<p><strong>动态URL</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	我们知道，对于k8s的dashboard来说，它所实现的功能还是比较多的，而且原则上要求必须是https方式来进行访问。我们之前是通过service的方式实现正常的请求访问。有了ingress，我们也可以自由的访问dashboard了。比如我们访问k8s的dashboard的首页地址是
	https:<span class="token operator">/</span><span class="token operator">/</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:nodeport/<span class="token comment">#/login</span>
</code></pre> 
<p>思路</p> 
<pre><code class="prism language-powershell">	我们可以通过annotation中的规则来实现url的动态格式重写
		nginx<span class="token punctuation">.</span>ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/rewrite-target: <span class="token operator">/</span><span class="token variable">$2</span>
   			
参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/ingress-nginx/user-guide/nginx-configuration/annotations/
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>资源对象</p> 
<pre><code class="prism language-powershell">定制ingress资源配置文件 15_kubernetes_application_secure_ingress_tls_dashboard<span class="token punctuation">.</span>yaml
apiVersion: networking<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1
kind: Ingress
metadata:
  name: superopsmsb-ingress-dashboard
  namespace: kubernetes-dashboard
  annotations:
    kubernetes<span class="token punctuation">.</span>io/ingress<span class="token punctuation">.</span><span class="token keyword">class</span>: <span class="token string">"nginx"</span>
    ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/ssl-passthrough: <span class="token string">"true"</span>
    nginx<span class="token punctuation">.</span>ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/backend-protocol: <span class="token string">"HTTPS"</span>
    nginx<span class="token punctuation">.</span>ingress<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/rewrite-target: <span class="token operator">/</span><span class="token variable">$2</span>	
spec:
  rules:
  <span class="token operator">-</span> host: shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com
    http:
      paths:
      <span class="token operator">-</span> path: <span class="token operator">/</span>dashboard<span class="token punctuation">(</span><span class="token operator">/</span><span class="token punctuation">|</span>$<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">)</span>
        pathType: Prefix
        backend:
          service:
            name: kubernetes-dashboard
            port: 
              number: 443
注意：
	dashboard的应用是在kubernetes-dashboard命名空间里面
	
应用资源文件
kubectl apply <span class="token operator">-</span>f 15_kubernetes_application_secure_ingress_tls_dashboard<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看效果
kubectl get ingress <span class="token operator">-</span>n kubernetes-dashboard
kubectl describe ingress <span class="token operator">-</span>n kubernetes-dashboard
</code></pre> 
<pre><code class="prism language-powershell">浏览器访问 https:<span class="token operator">/</span><span class="token operator">/</span>shuji<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/dashboard/ 查看效果
</code></pre> 
<p><img src="https://images2.imgbox.com/ca/17/L7CvbF0r_o.png" alt="在这里插入图片描述"></p> 
<pre><code>结果显示：
	借助于nginx-controller的tls功能可以正常的实现相关的https的效果。
</code></pre> 
<pre><code class="prism language-powershell">token准备
cd <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token operator">/</span>secure
kubectl apply <span class="token operator">-</span>f 10_kubernetes_platform_secure_lisi_config<span class="token punctuation">.</span>yaml
kubectl describe  secrets lisi-secret  <span class="token operator">-</span>n superopsmsb
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code>
</code></pre> 
<h4><a id="136_Ingress_1996"></a>1.3.6 Ingress扩展</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	默认情况下，Ingress是通过 Deployment <span class="token operator">+</span> nodePort的方式将集群内部的服务暴露出去的，而且默认情况下，整个kubernetes集群中只有一个ingress-nginx实例。

<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># kubectl get pod -n ingress-nginx  | grep controll</span>
ingress-nginx-controller-6cc467dfd9-c2dfg   1/1     Running     0          52m
</code></pre> 
<p>思路：</p> 
<pre><code class="prism language-powershell">	如果集群中唯一的ingress-nginx出现了故障，将导致整个kubernetes集群不可用。所以我们需要将这个集群业务的唯一入口进行高可用处理，根据我们之前的kubernetes资源对象知识，我们可以按照以下思路来进行：
	1 借助于Daemonset的方式实现ingress的多节点部署
	2 为了限制ingress-controller仅仅部署到master节点上，我们这里采用nodeSeler的方式来筛选master节点
	3 为了避免NodePort的劣势凸显，可以直接使用宿主机的80和443端口，我们可以采用HostNetwork的方式实现Cluster和node的网络互通，让Cluster直接监听node的端口。前提是宿主机的这两个端口不被占用
	所以最终我们可以确定 DaemonSet <span class="token operator">+</span> HostNetwork <span class="token operator">+</span> nodeSelector方式来部署ingress-nginx高可用集群。
</code></pre> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">文件备份
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># cp ingress-deploy.yaml ingress-daemonset.yaml</span>
</code></pre> 
<p>检查主机环境</p> 
<pre><code class="prism language-powershell"><span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># for i in {12..14}; do  ssh root@10.0.0.$i "netstat -tnulp | egrep '443|80'"; done</span>
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:2380          0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>               LISTEN      2146/etcd
tcp6       0      0 :::6443                 :::<span class="token operator">*</span>                    LISTEN      31072/kube-apiserve
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13:2380          0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>               LISTEN      2234/etcd
tcp6       0      0 :::6443                 :::<span class="token operator">*</span>                    LISTEN      28944/kube-apiserve
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14:2380          0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:<span class="token operator">*</span>               LISTEN      2186/etcd
tcp6       0      0 :::6443                 :::<span class="token operator">*</span>                    LISTEN      29045/kube-apiserve
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>修改文件</p> 
<pre><code class="prism language-powershell">修改资源清单文件
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># vim ingress-daemonset.yaml</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
390 apiVersion: apps/v1
391 kind: DaemonSet			<span class="token comment"># 将Deployment修改为 DaemonSet</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
491       dnsPolicy: ClusterFirst
492       hostNetwork: true   <span class="token comment"># 增加cluster和node网络的互通</span>
493       tolerations:
494         <span class="token operator">-</span> operator: Exists
495       nodeSelector:
496         ingressSelect: <span class="token string">"true"</span>  <span class="token comment"># 专属的节点部署标签,而且必须加上双引号</span>
497         kubernetes<span class="token punctuation">.</span>io/os: linux
</code></pre> 
<pre><code class="prism language-powershell">所有master节点添加标识
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># for i in 1 2 3</span>
<span class="token keyword">do</span> 
  kubectl label node kubernetes-master<span class="token variable">$i</span> ingressSelect=true
done
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># kubectl apply -f ingress-daemonset.yaml</span>

查看效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># kubectl get pod -n ingress-nginx  -o wide</span>
NAME                                   READY   STATUS      RESTARTS   AGE    IP            NODE                 NOMINATED NODE   READINESS GATES
ingress-nginx-admission-create-mn4tl   0/1     Completed   0          116s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>2<span class="token punctuation">.</span>25   kubernetes-node2     &lt;none&gt;           &lt;none&gt;
ingress-nginx-admission-patch-rbtl5    0/1     Completed   0          116s   10<span class="token punctuation">.</span>244<span class="token punctuation">.</span>3<span class="token punctuation">.</span>31   kubernetes-node3     &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-85c26         1/1     Running     0          116s   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14     kubernetes-master3   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-88w6j         1/1     Running     0          116s   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12     kubernetes-master1   &lt;none&gt;           &lt;none&gt;
ingress-nginx-controller-v2k7z         1/1     Running     0          116s   10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13     kubernetes-master2   &lt;none&gt;           &lt;none&gt;
<span class="token punctuation">[</span>root@kubernetes-mas
</code></pre> 
<pre><code class="prism language-powershell">端口检查效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure/ingress]</span><span class="token comment"># for i in {12..14}; do  ssh root@10.0.0.$i "netstat -tnulp | egrep ':(443|80)'"; done</span>
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:443     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>78308/nginx: master
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:80      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>78308/nginx: master
tcp6       0      0 :::443          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>78308/nginx: master
tcp6       0      0 :::80           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>78308/nginx: master
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:80      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72502/nginx: master
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:443     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72502/nginx: master
tcp6       0      0 :::80           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72502/nginx: master
tcp6       0      0 :::443          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72502/nginx: master
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:80      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72415/nginx: master
tcp        0      0 0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0:443     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72415/nginx: master
tcp6       0      0 :::80           <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72415/nginx: master
tcp6       0      0 :::443          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>72415/nginx: master
</code></pre> 
<p>确认效果</p> 
<pre><code class="prism language-powershell">创建资源对象
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># kubectl apply -f 14_kubernetes_application_secure_ingress_tls.yaml</span>

查看效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># kubectl describe ingress superopsmsb-ingress-tls</span>
Name:             superopsmsb-ingress-tls
Labels:           &lt;none&gt;
Namespace:        default
Address:          10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>13<span class="token punctuation">,</span>10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>14
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Events:
  <span class="token function">Type</span>    Reason  Age                <span class="token keyword">From</span>                      Message
  <span class="token operator">--</span><span class="token operator">--</span>    <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span>               <span class="token operator">--</span><span class="token operator">--</span>                      <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
  Normal  Sync    17s <span class="token punctuation">(</span>x2 over 40s<span class="token punctuation">)</span>  nginx-ingress-controller  Scheduled <span class="token keyword">for</span> sync
  Normal  Sync    17s <span class="token punctuation">(</span>x2 over 40s<span class="token punctuation">)</span>  nginx-ingress-controller  Scheduled <span class="token keyword">for</span> sync
  Normal  Sync    17s <span class="token punctuation">(</span>x2 over 40s<span class="token punctuation">)</span>  nginx-ingress-controller  Scheduled <span class="token keyword">for</span> sync
</code></pre> 
<pre><code class="prism language-powershell">查看访问效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/app_secure]</span><span class="token comment"># curl -k -H "Host: www.superopsmsb.com" https://10.0.0.12</span>
Hello Nginx<span class="token punctuation">,</span> superopsmsb-nginx-fb8c87f7f-vp22q-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6cda6ce9415f8e1101bd9b4dd14a9eb2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android中的SDK以及利用Android Studio生成aar</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6903c859f5d6f59c2b8143336c605a92/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CF补题：CodeTON Round 5 (Div. 1 &#43; Div. 2, Rated, Prizes!)（B,C）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>