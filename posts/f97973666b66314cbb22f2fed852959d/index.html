<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Oracle insert all 详解 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Oracle insert all 详解" />
<meta property="og:description" content="文章目录 1 概述2 insert 的两种形式2.1 insert first2.2 insert all 3 数据一致性（同时插入）3.1 验证：insert into 数据不一致3.2 验证：insert all 数据一致 1 概述 1. 作用：&#39;正确、高效&#39; 的将 &#39;同一批数据&#39; 插入至 &#39;不同的表&#39; 中 2. 好处 (1) &#39;正确&#39;：避免数据差异 (2) &#39;高效&#39;：优于写多个 insert into（因为无论插入多少张表，&#39;主表&#39; 只会被读取一次） 3. 场景，若需求：将表 t 中的数据 &#39;同时插入&#39; 至表 t1、t2 若不知晓 insert all 语句，咱可能会使用 insert into 两次 insert into t1 select * from t; insert into t2 select * from t; 问题：在两次 insert 过程中，有可能 t 表的数据发生了改变， 从而导致 t1、t2 &#39;得到的数据不一致&#39;。 解决办法：insert all 2 insert 的两种形式 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f97973666b66314cbb22f2fed852959d/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-01-16T21:47:25+08:00" />
<meta property="article:modified_time" content="2019-01-16T21:47:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Oracle insert all 详解</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1__2" rel="nofollow">1 概述</a></li><li><a href="#2_insert__21" rel="nofollow">2 insert 的两种形式</a></li><li><ul><li><a href="#21_insert_first_45" rel="nofollow">2.1 insert first</a></li><li><a href="#22_insert_all_68" rel="nofollow">2.2 insert all</a></li></ul> 
  </li><li><a href="#3__83" rel="nofollow">3 数据一致性（同时插入）</a></li><li><ul><li><a href="#31_insert_into__85" rel="nofollow">3.1 验证：insert into 数据不一致</a></li><li><a href="#32_insert_all__154" rel="nofollow">3.2 验证：insert all 数据一致</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__2"></a>1 概述</h2> 
<pre><code class="prism language-sql"><span class="token number">1.</span> 作用：<span class="token string">'正确、高效'</span> 的将 <span class="token string">'同一批数据'</span> 插入至 <span class="token string">'不同的表'</span> 中

<span class="token number">2.</span> 好处
   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token string">'正确'</span>：避免数据差异
   <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token string">'高效'</span>：优于写多个 <span class="token keyword">insert</span> <span class="token keyword">into</span>（因为无论插入多少张表，<span class="token string">'主表'</span> 只会被读取一次）
   
<span class="token number">3.</span> 场景，若需求：将表 t 中的数据 <span class="token string">'同时插入'</span> 至表 t1、t2
   若不知晓 <span class="token keyword">insert</span> <span class="token keyword">all</span> 语句，咱可能会使用 <span class="token keyword">insert</span> <span class="token keyword">into</span> 两次
   <span class="token keyword">insert</span> <span class="token keyword">into</span> t1 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>
   <span class="token keyword">insert</span> <span class="token keyword">into</span> t2 <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t<span class="token punctuation">;</span>

   问题：在两次 <span class="token keyword">insert</span> 过程中，有可能 t 表的数据发生了改变，
   从而导致 t1、t2 <span class="token string">'得到的数据不一致'</span>。
   
   解决办法：<span class="token keyword">insert</span> <span class="token keyword">all</span>
</code></pre> 
<h2><a id="2_insert__21"></a>2 insert 的两种形式</h2> 
<pre><code class="prism language-sql"><span class="token number">1.</span> <span class="token keyword">insert</span> <span class="token keyword">first</span>: 仅对 <span class="token string">'第一个'</span> 匹配成功项进行插入
<span class="token number">2.</span> <span class="token keyword">insert</span> <span class="token keyword">all</span>  : 对 <span class="token string">'每个'</span> 匹配成功项都进行插入
</code></pre> 
<p><strong>基础数据准备：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">create</span> <span class="token keyword">table</span> stu_info <span class="token punctuation">(</span>
   sno   number<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   sname varchar2<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
   sex   varchar2<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">insert</span> <span class="token keyword">into</span> stu_info<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'瑶瑶'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> stu_info<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'优优'</span><span class="token punctuation">,</span> <span class="token string">'男'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> stu_info<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span> <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'倩倩'</span><span class="token punctuation">,</span> <span class="token string">'女'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>

<span class="token comment">-- 两张测试表</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> stu_info_1 <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info <span class="token keyword">where</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">create</span> <span class="token keyword">table</span> stu_info_2 <span class="token keyword">as</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info <span class="token keyword">where</span> <span class="token number">1</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="21_insert_first_45"></a>2.1 insert first</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- 仅对 '第一个' 匹配成功项进行插入</span>
<span class="token keyword">insert</span> <span class="token keyword">first</span>
  <span class="token keyword">when</span> sno <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token comment">-- 不能用别名哦，如：t.sno</span>
    <span class="token keyword">into</span> stu_info_1<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span>
  <span class="token keyword">when</span> sno <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token keyword">then</span>
    <span class="token keyword">into</span> stu_info_2<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span> 
<span class="token keyword">select</span> t<span class="token punctuation">.</span>sno<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token keyword">from</span> stu_info t<span class="token punctuation">;</span>
</code></pre> 
<p><strong>查询结果：</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info_1<span class="token punctuation">;</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> stu_info_2<span class="token punctuation">;</span>
</code></pre> 
<p><strong>图示：仅对 ‘第一个’ 匹配成功项进行插入</strong><br> <img src="https://images2.imgbox.com/75/b6/718mEAuF_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22_insert_all_68"></a>2.2 insert all</h3> 
<pre><code class="prism language-sql"><span class="token comment">-- 对 '每个' 匹配成功项都进行插入</span>
<span class="token keyword">insert</span> <span class="token keyword">all</span>
  <span class="token keyword">when</span> sno <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token keyword">then</span> <span class="token comment">-- 不能写别名哦，如：t.sno</span>
    <span class="token keyword">into</span> stu_info_1<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span>
  <span class="token keyword">when</span> sno <span class="token operator">&gt;=</span> <span class="token number">3</span> <span class="token keyword">then</span>
    <span class="token keyword">into</span> stu_info_2<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span> 
<span class="token keyword">select</span> t<span class="token punctuation">.</span>sno<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token keyword">from</span> stu_info t<span class="token punctuation">;</span>
</code></pre> 
<p><strong>查询结果：对 ‘每个’ 匹配成功项都进行插入</strong><br> <img src="https://images2.imgbox.com/77/e7/WVGwvbWB_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3__83"></a>3 数据一致性（同时插入）</h2> 
<h3><a id="31_insert_into__85"></a>3.1 验证：insert into 数据不一致</h3> 
<pre><code class="prism language-sql"><span class="token number">1.</span> 模拟：将表 stu_info 中的数据同时插入 stu_info_1 和 stu_info_2

<span class="token number">2.</span> 分三个窗口模拟 <span class="token string">'同时插入(并行)'</span>
   <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> 窗口<span class="token number">1</span>: 将 stu_info 数据插入 stu_info_1（模拟时长 <span class="token number">30</span> s）
   <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> 窗口<span class="token number">2</span>: 将 stu_info 数据插入 stu_info_2（模拟时长 <span class="token number">30</span> s）
   <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> 窗口<span class="token number">3</span>：此时更新 stu_info 记录，使之影响 tu_info_1 和 stu_info_2（上述模拟时长内） 

<span class="token number">3.</span> 清空表 stu_info_1、stu_info_2 <span class="token comment">-- 若有数据</span>
   <span class="token keyword">truncate</span> <span class="token keyword">table</span> stu_info_1<span class="token punctuation">;</span>
   <span class="token keyword">truncate</span> <span class="token keyword">table</span> stu_info_2<span class="token punctuation">;</span>

<span class="token number">4.</span> dbms_lock 包权限 <span class="token comment">-- 若无权限，sys 用户授权</span>
   <span class="token comment">-- conn system/system@orcl as sysdba</span>
   <span class="token keyword">grant</span> <span class="token keyword">execute</span> <span class="token keyword">on</span> sys<span class="token punctuation">.</span>dbms_lock <span class="token keyword">to</span> scott<span class="token punctuation">;</span>
</code></pre> 
<p><strong>图示：</strong><br> <img src="https://images2.imgbox.com/fe/3d/Y0JvkTLL_o.png" alt="在这里插入图片描述"></p> 
<p><strong>窗口1：插入 stu_info_1，更新 sno = 2 的记录时，等待（模拟执行时长）</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">declare</span>
<span class="token keyword">begin</span>
  <span class="token keyword">for</span> i <span class="token operator">in</span> <span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">3</span> <span class="token keyword">loop</span>
  
    <span class="token keyword">if</span> i <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span>
      dbms_lock<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 模拟执行时长：30 秒</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
  
    <span class="token keyword">insert</span> <span class="token keyword">into</span> stu_info_1
      <span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span>
      <span class="token keyword">select</span> t<span class="token punctuation">.</span>sno<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token keyword">from</span> stu_info t <span class="token keyword">where</span> t<span class="token punctuation">.</span>sno <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span>
  
  <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>窗口2：插入 stu_info_1，更新 sno = 3 的记录时，等待（模拟执行时长）</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">declare</span>
<span class="token keyword">begin</span>
  <span class="token keyword">for</span> i <span class="token operator">in</span> <span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">3</span> <span class="token keyword">loop</span>
  
    <span class="token keyword">if</span> i <span class="token operator">=</span> <span class="token number">3</span> <span class="token keyword">then</span>
      dbms_lock<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 模拟执行时长：30 秒</span>
    <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
  
    <span class="token keyword">insert</span> <span class="token keyword">into</span> stu_info_2
      <span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span>
      <span class="token keyword">select</span> t<span class="token punctuation">.</span>sno<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token keyword">from</span> stu_info t <span class="token keyword">where</span> t<span class="token punctuation">.</span>sno <span class="token operator">=</span> i<span class="token punctuation">;</span>
    <span class="token keyword">commit</span><span class="token punctuation">;</span>
  
  <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>窗口3：更新 stu_info 记录，使之影响 tu_info_1 和 stu_info_2（上述模拟时长内）</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">update</span> stu_info t <span class="token keyword">set</span> t<span class="token punctuation">.</span>sname <span class="token operator">=</span> <span class="token string">'update_2'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token string">'22'</span> <span class="token keyword">where</span> t<span class="token punctuation">.</span>sno <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>测试结果：stu_info_1 和 stu_info_2 两者记录不一致！</strong><br> <img src="https://images2.imgbox.com/08/35/YlVbQnWl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32_insert_all__154"></a>3.2 验证：insert all 数据一致</h3> 
<pre><code class="prism language-sql"><span class="token number">1.</span> 同理，可分为 两个窗口测试

<span class="token number">2.</span> 清空表 stu_info_1、stu_info_2，并还原 stu_info 的数据
</code></pre> 
<p><strong>窗口1：插入数据至 stu_info_1 和 stu_info_1</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">declare</span>
<span class="token keyword">begin</span>
   <span class="token keyword">for</span> i <span class="token operator">in</span> <span class="token number">1</span> <span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token number">3</span> <span class="token keyword">loop</span>
   
      <span class="token keyword">if</span> i <span class="token operator">=</span> <span class="token number">2</span> <span class="token keyword">then</span>
         dbms_lock<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">-- 模拟执行时长：30 秒</span>
      <span class="token keyword">end</span> <span class="token keyword">if</span><span class="token punctuation">;</span>
   
      <span class="token keyword">insert</span> <span class="token keyword">all</span> 
         <span class="token keyword">into</span> stu_info_1<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span> 
         <span class="token keyword">into</span> stu_info_2<span class="token punctuation">(</span>sno<span class="token punctuation">,</span> sname<span class="token punctuation">,</span> sex<span class="token punctuation">)</span>
      <span class="token keyword">select</span> t<span class="token punctuation">.</span>sno<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sname<span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token keyword">from</span> stu_info t <span class="token keyword">where</span> t<span class="token punctuation">.</span>sno <span class="token operator">=</span> i<span class="token punctuation">;</span> 
      <span class="token keyword">commit</span><span class="token punctuation">;</span>
   
   <span class="token keyword">end</span> <span class="token keyword">loop</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>窗口2：更新 stu_info 记录，使之影响 tu_info_1 和 stu_info_2（上述模拟时长内）</strong></p> 
<pre><code class="prism language-sql"><span class="token keyword">update</span> stu_info t <span class="token keyword">set</span> t<span class="token punctuation">.</span>sname <span class="token operator">=</span> <span class="token string">'update_3'</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>sex <span class="token operator">=</span> <span class="token string">'33'</span> <span class="token keyword">where</span> t<span class="token punctuation">.</span>sno <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">commit</span><span class="token punctuation">;</span>
</code></pre> 
<p><strong>测试结果：</strong><br> <img src="https://images2.imgbox.com/fb/49/h671oRGy_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ea5c3ef12c2ca384fe0f831a89ddb1c4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CSkin界面库窗体设置</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4867bb9c44fd9d6495bcf2091a1b0ab1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Qt实现简易计算器</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>