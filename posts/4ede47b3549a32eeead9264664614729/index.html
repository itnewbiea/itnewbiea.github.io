<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>解决STM32F407串口数据乱码问题 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="解决STM32F407串口数据乱码问题" />
<meta property="og:description" content="问题描述： 我使用的开发板是正点原子的stm32f407探索者开发板 ，看的视频是野火的野火F407开发板-霸天虎视频-【中级篇】，使用的固件库是从野火资料下载中心下载的（问题就出在这），在做串口实验的时候，上位机接收到的数据显示总是乱码，具体如下图所示
不正常的实验现象 发送的信息是：&#34;\r\n您发送的消息为:\r\n&#34;
解决方法： 1、排除硬件问题。使用正点原子的串口例程，通信结果是正常的，因此问题一定出在软件上。 2、当前项目搜索“#define PLL_M ”——在system_stm32f4xx.c文件中，确保PLL_M的值与板子上的晶振保持一致。如晶振是25MHz，PLL_M=25；晶振是8MHz，PLL_M=8。同文件中其他几个需要注意的参数宏定义是： #define PLLM 8 //VCO输入=HSE/PLL_M=8M/8=1M，1M≤VCO输入≤2M #define PLLN 336 //VCO倍频输出=1M*PLL_N=1M*336=336M，50≤PLLN≤432，100≤VCO倍频输出≤432. #define PLLP 2 //PLLCLK=336M/PLL_P=336M/2=168M=SYSCLK，PLLP={2,4,6,8}，SYSCLK≤168M #define PLLQ 7 //PLL48CK=336M/PLL_Q=36M/7=48M，4≤PLL_Q≤15,PLL48CK≤48 Ctrl&#43;F 3、当前项目搜索“#define HSE_VALUE”——在stm32f4xx.h文件中，确保HSE_VALUE的值与板子上的晶振保持一致。如晶振是25MHz，HSE_VALUE=25000000；晶振是8MHz，HSE_VALUE=8000000。 正常的实验现象 原因分析： 1、PLL_M 对系统的影响。在系统进入到main函数之前，会先进行时钟配置，具体的过程在启动文件startup_stm32f40_41xxx.s中调用SystemInit函数来完成，而SystemInit函数中又调用了SetSysClock函数来最终完成配置。在SetSysClock函数中 RCC-&gt;PLLCFGR = PLL_M | (PLL_N &lt;&lt; 6) | (((PLL_P &gt;&gt; 1) -1) &lt;&lt; 16) | (RCC_PLLCFGR_PLLSRC_HSE) | (PLL_Q &lt;&lt; 24); 更具体的可以看野火F407开发板-霸天虎视频-【中级篇】16——RCC时钟树讲解非常详细 2、HSE_VALUE对系统的影响。在串口的初始化函数USART_Init中，配置波特率的时候使用到了系统时钟，而获取系统时钟的方法是调用RCC_GetClocksFreq函数，而RCC_GetClocksFreq函数获得系统时钟的过程是 void RCC_GetClocksFreq(RCC_ClocksTypeDef* RCC_Clocks) { uint32_t tmp = 0, presc = 0, pllvco = 0, pllp = 2, pllsource = 0, pllm = 2; /* Get SYSCLK source -------------------------------------------------------*/ tmp = RCC-&gt;CFGR &amp; RCC_CFGR_SWS; switch (tmp) { case 0x00: /* HSI used as system clock source */ RCC_Clocks-&gt;SYSCLK_Frequency = HSI_VALUE; break; case 0x04: /* HSE used as system clock source */ RCC_Clocks-&gt;SYSCLK_Frequency = HSE_VALUE; break; ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4ede47b3549a32eeead9264664614729/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-05-14T15:36:26+08:00" />
<meta property="article:modified_time" content="2021-05-14T15:36:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">解决STM32F407串口数据乱码问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>问题描述：</h2> 
<p>我使用的开发板是正点原子的<a href="http://www.openedv.com/docs/boards/stm32/zdyz_stm32f407_explorer.html" rel="nofollow">stm32f407探索者开发板</a> ，看的视频是野火的<a href="https://www.bilibili.com/video/BV1xt411X74L?p=18" rel="nofollow">野火F407开发板-霸天虎视频-【中级篇】</a>，<u><strong>使用的固件库是从<a href="http://doc.embedfire.com/products/link/zh/latest/stm32/ebf_stm32f407_batianhu_v1_v2/download/stm32f407_batianhu_v1_v2.html" rel="nofollow">野火资料下载中心</a>下载的（问题就出在这</strong>）</u>，在做串口实验的时候，上位机接收到的数据显示总是乱码，具体如下图所示</p> 
<div style="text-align:center;"> 
 <figure class="image"> 
  <img alt='发送的数据是："\r\n您发送的消息为:\r\n"' height="391" src="https://images2.imgbox.com/66/42/wrxBDfeZ_o.png" width="375"> 
  <figcaption>
    不正常的实验现象 
  </figcaption> 
 </figure> 
</div> 
<blockquote> 
 <p>发送的信息是："\r\n您发送的消息为:\r\n"</p> 
</blockquote> 
<h2 id="articleContentId">解决方法：</h2> 
<ul><li> <h3>1、排除硬件问题。使用正点原子的串口例程，通信结果是正常的，因此问题一定出在软件上。</h3> </li><li> <h3>2、<span style="color:#f33b45;">当前项目</span>搜索“#define <span style="color:#f33b45;">PLL_M</span> ”——在system_stm32f4xx.c文件中，确保PLL_M的值与板子上的晶振保持一致。如晶振是25MHz，PLL_M=25；晶振是8MHz，PLL_M=8。同文件中其他几个需要注意的参数宏定义是：</h3> </li></ul> 
<pre><code class="language-cpp">#define PLLM 8   //VCO输入=HSE/PLL_M=8M/8=1M，1M≤VCO输入≤2M
#define PLLN 336  //VCO倍频输出=1M*PLL_N=1M*336=336M，50≤PLLN≤432，100≤VCO倍频输出≤432.
#define PLLP 2   //PLLCLK=336M/PLL_P=336M/2=168M=SYSCLK，PLLP={2,4,6,8}，SYSCLK≤168M
#define PLLQ 7   //PLL48CK=336M/PLL_Q=36M/7=48M，4≤PLL_Q≤15,PLL48CK≤48</code></pre> 
<div style="text-align:center;"> 
 <figure class="image"> 
  <img alt="" height="483" src="https://images2.imgbox.com/6b/09/ZoTBkVzw_o.png" width="668"> 
  <figcaption>
    Ctrl+F 
  </figcaption> 
 </figure> 
</div> 
<ul><li> <h3>3、<span style="color:#f33b45;">当前项目</span>搜索“#define <span style="color:#f33b45;">HSE_VALUE</span>”——在stm32f4xx.h文件中，确保HSE_VALUE的值与板子上的晶振保持一致。如晶振是25MHz，HSE_VALUE=25000000；晶振是8MHz，HSE_VALUE=8000000。</h3> </li></ul> 
<div style="text-align:center;"> 
 <figure class="image"> 
  <img alt="" height="389" src="https://images2.imgbox.com/4d/10/PyguReas_o.png" width="375"> 
  <figcaption>
    正常的实验现象 
  </figcaption> 
 </figure> 
</div> 
<h2>原因分析：</h2> 
<ul><li> <h3>1、<span style="color:#f33b45;">PLL_M</span> 对系统的影响。在系统进入到main函数之前，会先进行时钟配置，具体的过程在启动文件startup_stm32f40_41xxx.s中调用SystemInit函数来完成，而SystemInit函数中又调用了SetSysClock函数来最终完成配置。在SetSysClock函数中</h3> </li></ul> 
<pre><code class="language-cpp">RCC-&gt;PLLCFGR = PLL_M | (PLL_N &lt;&lt; 6) | (((PLL_P &gt;&gt; 1) -1) &lt;&lt; 16) |
                   (RCC_PLLCFGR_PLLSRC_HSE) | (PLL_Q &lt;&lt; 24);</code></pre> 
<h3>更具体的可以看<a href="https://www.bilibili.com/video/BV1xt411X74L?p=2" rel="nofollow">野火F407开发板-霸天虎视频-【中级篇】16——RCC时钟树讲解非常详细</a></h3> 
<ul><li> <h3>2、<span style="color:#f33b45;">HSE_VALUE</span>对系统的影响。在串口的初始化函数USART_Init中，配置波特率的时候使用到了系统时钟，而获取系统时钟的方法是调用RCC_GetClocksFreq函数，而RCC_GetClocksFreq函数获得系统时钟的过程是</h3> </li></ul> 
<pre><code class="language-cpp">void RCC_GetClocksFreq(RCC_ClocksTypeDef* RCC_Clocks)
{
  uint32_t tmp = 0, presc = 0, pllvco = 0, pllp = 2, pllsource = 0, pllm = 2;

  /* Get SYSCLK source -------------------------------------------------------*/
  tmp = RCC-&gt;CFGR &amp; RCC_CFGR_SWS;
  
  switch (tmp)
  {
    case 0x00:  /* HSI used as system clock source */
        RCC_Clocks-&gt;SYSCLK_Frequency = HSI_VALUE;
        break;
    case 0x04:  /* HSE used as system clock  source */
        RCC_Clocks-&gt;SYSCLK_Frequency = HSE_VALUE;
        break;
.......</code></pre> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7acc616f8482ac5a3099ac1c8e07a911/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Android webview复用优化方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/e3a26ae4aa48926e4696260a00a59e4b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Flink学习笔记（5）——算子</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>