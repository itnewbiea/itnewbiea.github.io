<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【t-SNE可视化CNNs特征向量-代码】 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【t-SNE可视化CNNs特征向量-代码】" />
<meta property="og:description" content="t-SNE可视化CNNs特征向量-代码 本博客主要是自己学习记录，参考网络，欢迎指正
整体代码 ModelPath是存放训练好的模型参数的路径 DatasetPath是存放数据集的文件夹的路径，其中不同类别放在不同的子文件夹里 也可以参考【t-SNE可视化-代码】
import os import torch as t from torch import nn from torch.utils.data import DataLoader as DL from torch import optim import torchvision.datasets as datasets from torchvision import transforms as T import torchvision.models as models import numpy as np import matplotlib.pyplot as plt from sklearn.manifold import TSNE from Config.config import ConfigCLS from Classification.Dataset.ChestXRayCLS.chestxray import ChestXRay from Classification.Dataset.RefugeCLS.refuge import REFUGE from Classification.TrainFunc.runner import NetRunner ModelPATH = &#39;resnet18/checkpoint/best_f1score." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0d55dca4b288b9f1fa783d3b68aee403/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-07T16:46:17+08:00" />
<meta property="article:modified_time" content="2023-03-07T16:46:17+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【t-SNE可视化CNNs特征向量-代码】</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="tSNECNNs_0"></a>t-SNE可视化CNNs特征向量-代码</h2> 
<p><strong>本博客主要是自己学习记录，参考网络，欢迎指正</strong></p> 
<h3><a id="_2"></a>整体代码</h3> 
<pre><code class="prism language-python">ModelPath是存放训练好的模型参数的路径
DatasetPath是存放数据集的文件夹的路径，其中不同类别放在不同的子文件夹里
</code></pre> 
<p>也可以参考<a href="https://blog.csdn.net/a5_b6c7/article/details/122983085">【t-SNE可视化-代码】</a></p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> os
<span class="token keyword">import</span> torch <span class="token keyword">as</span> t
<span class="token keyword">from</span> torch <span class="token keyword">import</span> nn
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader <span class="token keyword">as</span> DL
<span class="token keyword">from</span> torch <span class="token keyword">import</span> optim
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>datasets <span class="token keyword">as</span> datasets
<span class="token keyword">from</span> torchvision <span class="token keyword">import</span> transforms <span class="token keyword">as</span> T
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt
<span class="token keyword">from</span> sklearn<span class="token punctuation">.</span>manifold <span class="token keyword">import</span> TSNE

<span class="token keyword">from</span> Config<span class="token punctuation">.</span>config <span class="token keyword">import</span> ConfigCLS
<span class="token keyword">from</span> Classification<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>ChestXRayCLS<span class="token punctuation">.</span>chestxray <span class="token keyword">import</span> ChestXRay
<span class="token keyword">from</span> Classification<span class="token punctuation">.</span>Dataset<span class="token punctuation">.</span>RefugeCLS<span class="token punctuation">.</span>refuge <span class="token keyword">import</span> REFUGE
<span class="token keyword">from</span> Classification<span class="token punctuation">.</span>TrainFunc<span class="token punctuation">.</span>runner <span class="token keyword">import</span> NetRunner

ModelPATH <span class="token operator">=</span> <span class="token string">'resnet18/checkpoint/best_f1score.pth'</span>
DatasetPath <span class="token operator">=</span> <span class="token string">'datasets'</span>

<span class="token keyword">class</span> <span class="token class-name">Identity</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span>Identity<span class="token punctuation">,</span> self<span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">return</span> x

<span class="token keyword">def</span> <span class="token function">plot_embedding</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> label<span class="token punctuation">,</span> title<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    :param data:数据集
    :param label:样本标签
    :param title:图像标题
    :return:图像
    """</span>
    x_min<span class="token punctuation">,</span> x_max <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token builtin">min</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    data <span class="token operator">=</span> <span class="token punctuation">(</span>data <span class="token operator">-</span> x_min<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>x_max <span class="token operator">-</span> x_min<span class="token punctuation">)</span>		<span class="token comment"># 对数据进行归一化处理</span>
    fig <span class="token operator">=</span> plt<span class="token punctuation">.</span>figure<span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment"># 创建图形实例</span>
    ax <span class="token operator">=</span> plt<span class="token punctuation">.</span>subplot<span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>		<span class="token comment"># 创建子图</span>
    <span class="token comment"># 遍历所有样本</span>
    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token comment"># 在图中为每个数据点画出标签</span>
        <span class="token keyword">if</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(0.82)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'brown'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(1.64)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'red'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(2.46)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'orangered'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(3.28)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'orange'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(4.10)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'chartreuse'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">5</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(4.92)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'cyan'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">6</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(5.74)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'lime'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(6.56)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'dodgerblue'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">8</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(7.38)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'blue'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(8.20)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'m'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span>
        <span class="token keyword">elif</span> label<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token number">10</span><span class="token punctuation">:</span>
            <span class="token comment"># colorplt = plt.cm.Set1(9)</span>
            colorplt <span class="token operator">=</span> <span class="token string">'deeppink'</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
        plt<span class="token punctuation">.</span>scatter<span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span>i<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token operator">=</span>colorplt<span class="token punctuation">,</span> marker<span class="token operator">=</span><span class="token string">'o'</span><span class="token punctuation">,</span> s<span class="token operator">=</span><span class="token number">30</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xticks<span class="token punctuation">(</span><span class="token punctuation">)</span>		<span class="token comment"># 指定坐标的刻度</span>
    plt<span class="token punctuation">.</span>yticks<span class="token punctuation">(</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span>title<span class="token punctuation">,</span> fontsize<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> fig

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>

    img_transform_test <span class="token operator">=</span> T<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        T<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        T<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        T<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>mean<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    feature_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    label_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>

    test_set <span class="token operator">=</span> datasets<span class="token punctuation">.</span>ImageFolder<span class="token punctuation">(</span>DatasetPath<span class="token punctuation">,</span> transform<span class="token operator">=</span>img_transform_test<span class="token punctuation">)</span>
    test_loader <span class="token operator">=</span> DL<span class="token punctuation">(</span>test_set<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> num_workers<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

    net <span class="token operator">=</span> models<span class="token punctuation">.</span>resnet18<span class="token punctuation">(</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span>fc <span class="token operator">=</span> Identity<span class="token punctuation">(</span><span class="token punctuation">)</span>
    net <span class="token operator">=</span> net
    net<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>t<span class="token punctuation">.</span>load<span class="token punctuation">(</span>ModelPATH<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    net<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    num <span class="token operator">=</span> <span class="token number">0</span>

    <span class="token keyword">for</span> index<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>test_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
        pic<span class="token punctuation">,</span> label <span class="token operator">=</span> data

        prediction <span class="token operator">=</span> net<span class="token punctuation">(</span>pic<span class="token punctuation">)</span>

        <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            feature_list <span class="token operator">=</span> prediction<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
            label_list <span class="token operator">=</span> label<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            feature_list <span class="token operator">=</span> t<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>feature_list<span class="token punctuation">,</span> prediction<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
            label_list <span class="token operator">=</span> t<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>label_list<span class="token punctuation">,</span> label<span class="token punctuation">.</span>clone<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>detach<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>

        num <span class="token operator">=</span><span class="token operator">+</span> <span class="token number">1</span>

    ts <span class="token operator">=</span> TSNE<span class="token punctuation">(</span>perplexity<span class="token operator">=</span><span class="token number">50</span><span class="token punctuation">,</span> n_components<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> init<span class="token operator">=</span><span class="token string">'pca'</span><span class="token punctuation">,</span> random_state<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">)</span>
    result <span class="token operator">=</span> ts<span class="token punctuation">.</span>fit_transform<span class="token punctuation">(</span>feature_list<span class="token punctuation">)</span>
    fig <span class="token operator">=</span> plot_embedding<span class="token punctuation">(</span>result<span class="token punctuation">,</span> label_list<span class="token punctuation">,</span> <span class="token string">'t-SNE Embedding of digits'</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="_145"></a>结果图展示</h3> 
<p><img src="https://images2.imgbox.com/ec/32/s1XYoqUQ_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd5c85005fc1091522a5ec81aaa6d029/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">多线程 | FutureTask实践</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/5efdd030472033c9330c5f4ded8ee67f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">联系互联网和汽车的纽带：国内车载小程序市场现状和发展趋势</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>