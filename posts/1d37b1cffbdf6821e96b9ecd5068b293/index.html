<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>【STM32】串口通信乱码（认识系统时钟来源） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="【STM32】串口通信乱码（认识系统时钟来源）" />
<meta property="og:description" content="使用 stm32f407 与电脑主机进行串口通信时，串口助手打印乱码，主要从以下方面进行排查：
检查传输协议设置是否一致（波特率、数据位、停止位、校验位）检查MCU外部晶振频率是否和库函数设置的一致 最终发现是外部晶振频率和库函数不一致的问题。
一、时钟分析 1、认识时钟源 我们要检查的是 APB2总线的时钟源是否设置正常，因为我们当前使用的串口 USART1 与 APB2 总线（高速总线）相连，从下图看，时钟源有三个：
HSI：高速内部时钟，RC振荡器，频率为16MHzHSE：高速外部时钟，接外部时钟源，频率范围为4MHz~26MHzPLL：锁相环倍频输出，其时钟输入源可选择为 HSI/M、HSE/M（本质还是 由HSE或HSI控制） 就结果而言，选择的时钟源是 PLLCLK。（若想了解，可以参考最后一部分）
2、计算系统时钟 现在已经知道了选择的是 PLLCLK 作为时钟源，那么我们就可以顺着这条路线计算系统时钟的值。正点原子 stm32f407 的外设时钟频率 HSE = 8 M
① 输入 HSE
② 经过 M 分频，得到的结果为 HSE / M = 8 / M
③ ④ ⑤ ⑥ 经过 N 倍频，VCO的输出为 (HSE / M ) * N
⑦ 再次 P 分频就得到 SYSCLK = (HSE / M ) * N / P" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/1d37b1cffbdf6821e96b9ecd5068b293/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-21T21:33:57+08:00" />
<meta property="article:modified_time" content="2023-08-21T21:33:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">【STM32】串口通信乱码（认识系统时钟来源）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>使用 stm32f407 与电脑主机进行串口通信时，串口助手打印乱码，主要从以下方面进行排查：</p> 
<ul><li><span style="color:#494949;">检查传输协议设置是否一致（波特率、数据位、停止位、校验位）</span></li><li><span style="color:#494949;">检查MCU外部晶振频率是否和库函数设置的一致</span></li></ul> 
<p>最终发现是外部晶振频率和库函数不一致的问题。</p> 
<p></p> 
<h2>一、时钟分析</h2> 
<h3>1、认识时钟源</h3> 
<p>我们要检查的是 APB2总线的时钟源是否设置正常，因为我们当前使用的串口 USART1 与 APB2 总线（高速总线）相连，从下图看，时钟源有三个：</p> 
<ul><li><span style="color:#494949;">HSI：高速内部时钟，RC振荡器，频率为16MHz</span></li><li><span style="color:#494949;">HSE：高速外部时钟，接外部时钟源，频率范围为4MHz~26MHz</span></li><li><span style="color:#494949;">PLL：锁相环倍频输出，其时钟输入源可选择为 HSI/M、HSE/M（本质还是 由HSE或HSI控制）</span></li></ul> 
<p>就结果而言，选择的时钟源是 <span style="color:#fe2c24;"><strong>PLLCLK</strong></span>。（若想了解，可以参考最后一部分）</p> 
<p class="img-center"><img alt="" height="265" src="https://images2.imgbox.com/81/ba/i7wZ2VMr_o.png" width="647"></p> 
<p></p> 
<h3>2、计算系统时钟</h3> 
<p>现在已经知道了选择的是 PLLCLK 作为时钟源，那么我们就可以顺着这条路线计算系统时钟的值。正点原子 stm32f407 的外设时钟频率 HSE = 8 M</p> 
<p>① 输入 HSE</p> 
<p>② 经过 M 分频，得到的结果为 HSE / M = 8 / M</p> 
<p>③ ④ ⑤ ⑥ 经过 N 倍频，VCO的输出为 (HSE / M ) * N</p> 
<p>⑦ 再次 P 分频就得到 <strong><span style="color:#fe2c24;">SYSCLK = (HSE / M ) * N / P</span></strong></p> 
<p class="img-center"><img alt="" height="241" src="https://images2.imgbox.com/a8/5e/MulBFSaF_o.png" width="394"></p> 
<p></p> 
<h2>二、解决外部晶振频率和库函数不一致的问题</h2> 
<p>从上面<span style="color:#494949;">可知，选择的系统时钟频率  SYSCLK = (HSE / M ) * N / P，配置文件预期的 SYSCLK = 144MHz，其余参数也都指定了</span></p> 
<p class="img-center"><img alt="" height="65" src="https://images2.imgbox.com/bb/8a/JjT8wb76_o.png" width="390"></p> 
<p class="img-center"><img alt="" height="150" src="https://images2.imgbox.com/d6/32/49HGnAKp_o.png" width="403"></p> 
<p>实际上 HSE 需要视开发板具体情况而定，stm32f4 的 HSE 为 8 MHz，然而配置文件中配置的频率是 25 M，为了不影响原本的SYSCLK，我们需要修改 HSE 和 PLL_M。</p> 
<ul><li>HSE = 8 M = 8000000</li><li>PLL_M = (<span style="color:#494949;">HSE / SYSCLK ) * N / P = 8</span></li></ul> 
<p></p> 
<p></p> 
<h3><span style="color:#494949;">1、修改 HSE</span></h3> 
<p>HSE 在程序中的体现为宏定义 HSE_VALUE ，该宏定义在 stm32f4xx.h 文件中</p> 
<p class="img-center"><img alt="" height="117" src="https://images2.imgbox.com/7b/26/X0YT74Aw_o.png" width="372"></p> 
<p>这里有两种修改方法，可任选一种修改</p> 
<p class="img-center"><img alt="" height="117" src="https://images2.imgbox.com/92/b8/ey7Kb8iF_o.png" width="601"></p> 
<h3>2、修改 PLL_M</h3> 
<p>分频数 M 在程序中的体现是宏定义 PLL_M，该宏定义在 system_stm32f4xx.c 文件中</p> 
<p class="img-center"><img alt="" height="75" src="https://images2.imgbox.com/4d/1f/7OQPsffO_o.png" width="361"></p> 
<p> </p> 
<h2>三、为什么可以确定时钟源为 PLLCLK 而不是 HSE</h2> 
<p>stm32 在启动的时候就会调用 SystemInit 函数，这个函数就包含了初始化外设的时钟源。这个函数定义在 system_stm32f4xx.c 中。我们直接找到 SetSysClock 函数，这之前的都是将控制寄存器位清零的操作。</p> 
<p class="img-center"><img alt="" height="69" src="https://images2.imgbox.com/9e/22/9EU2E8ao_o.png" width="607"></p> 
<p>我们进入到 SetSysClock 函数，首先是HSE使能，等待时钟准备就绪。刚上电的时候 HSE 晶振不稳定，需要等待 6 个晶振时钟周期。</p> 
<p class="img-center"><img alt="" height="147" src="https://images2.imgbox.com/ac/f0/MiFaxQHz_o.png" width="502"></p> 
<p>PLL 使能，等待时钟准备就绪。一开始 PLL 处于被锁定状态，这里需要等待 PLL 解锁。</p> 
<p class="img-center"><img alt="" height="184" src="https://images2.imgbox.com/63/4e/jKXjXPFg_o.png" width="513"></p> 
<p>一切准备就绪，然后将 PLL 设为系统时钟。 </p> 
<p class="img-center"><img alt="" height="75" src="https://images2.imgbox.com/a1/cc/WgzbCvCX_o.png" width="500"></p> 
<p> </p> 
<p>参考文章：</p> 
<p><a href="https://m.elecfans.com/article/2024658.html" rel="nofollow" title="在串口通信实验中出现通信乱码怎么办-电子发烧友网 (elecfans.com)">在串口通信实验中出现通信乱码怎么办-电子发烧友网 (elecfans.com)</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6c61fa55ed8db0efd9dfb627bb6f9eb6/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Reactor 第十篇 定制一个生产的WebClient</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/1ed7840a525f55873ad1f1c58330c2cc/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">通俗易懂的C语言指针知识讲解(详细,深入) 1</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>