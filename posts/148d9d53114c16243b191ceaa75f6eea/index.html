<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>张正友相机标定（全流程，含畸变，matlab源代码解析） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="张正友相机标定（全流程，含畸变，matlab源代码解析）" />
<meta property="og:description" content="张正友标定的具体原理很多文章已经介绍，这里主要结合源代码对其中的基本原理及本人遇到的问题进行介绍。（仅介绍基本原理供本人复习，同时方便他人，如有问题，请及时指正勿喷）
1. 标定基本思路介绍 相机标定，即获取其内参、外参、畸变系数（内参与外参及相机成像模型的解释可以参考SLAM入门之视觉里程计）。
具体可以描述为
s m − = K [ R T ] M s\overset{-}{\mathop{m}}\,=K[\begin{matrix} R &amp; T \\ \end{matrix}]M sm−=K[R​T​]M
其中s为世界坐标系到图像坐标系的尺度因子，K为内参矩阵，具体为
K = [ f x 0 c 1 0 f y c 2 0 0 1 ] K=\left[ \begin{matrix} {{f}_{x}} &amp; 0 &amp; {{c}_{1}} \\ 0 &amp; {{f}_{y}} &amp; {{c}_{2}} \\ 0 &amp; 0 &amp; 1 \\ \end{matrix} \right] K= ​fx​00​0fy​0​c1​c2​1​ ​
[R T]为旋转矩阵与平移向量，M为三维坐标点。
张正友标定方法的核心即是采用平面标定板，从而可以方便的将标定点的真值Z置为0，以此方便计算。
具体流程主要为" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/148d9d53114c16243b191ceaa75f6eea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-03T23:05:59+08:00" />
<meta property="article:modified_time" content="2023-12-03T23:05:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">张正友相机标定（全流程，含畸变，matlab源代码解析）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>张正友标定的具体原理很多文章已经介绍，这里主要结合源代码对其中的基本原理及本人遇到的问题进行介绍。（仅介绍基本原理供本人复习，同时方便他人，如有问题，请及时指正勿喷）</p> 
<h3><a id="1__3"></a>1. 标定基本思路介绍</h3> 
<p>相机标定，即获取其内参、外参、畸变系数（内参与外参及相机成像模型的解释可以参考<a href="https://www.cnblogs.com/wangguchangqing/p/8126333.html" rel="nofollow">SLAM入门之视觉里程计</a>）。<br> 具体可以描述为<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          s 
         
         
          
           
            
            
              m 
             
            
           
          
            − 
           
          
          
        
          = 
         
        
          K 
         
        
          [ 
         
         
          
           
            
            
              R 
             
            
           
           
            
            
              T 
             
            
           
          
         
        
          ] 
         
        
          M 
         
        
       
         s\overset{-}{\mathop{m}}\,=K[\begin{matrix} R &amp; T \\ \end{matrix}]M 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1389em;"></span><span class="mord mathnormal">s</span><span class="mord"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1389em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop mathnormal" style="position: relative; top: -0.0347em;">m</span></span></span><span class="" style="top: -3.6306em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.2em; vertical-align: -0.35em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mopen">[</span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.85em;"><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0077em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.35em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.85em;"><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.35em;"><span class=""></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span></span><br> 其中s为世界坐标系到图像坐标系的尺度因子，K为内参矩阵，具体为<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          K 
         
        
          = 
         
         
         
           [ 
          
          
           
            
             
              
              
                f 
               
              
                x 
               
              
             
            
            
             
             
               0 
              
             
            
            
             
              
              
                c 
               
              
                1 
               
              
             
            
           
           
            
             
             
               0 
              
             
            
            
             
              
              
                f 
               
              
                y 
               
              
             
            
            
             
              
              
                c 
               
              
                2 
               
              
             
            
           
           
            
             
             
               0 
              
             
            
            
             
             
               0 
              
             
            
            
             
             
               1 
              
             
            
           
          
         
           ] 
          
         
        
       
         K=\left[ \begin{matrix} {<!-- -->{f}_{x}} &amp; 0 &amp; {<!-- -->{c}_{1}} \\ 0 &amp; {<!-- -->{f}_{y}} &amp; {<!-- -->{c}_{2}} \\ 0 &amp; 0 &amp; 1 \\ \end{matrix} \right] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 3.6em; vertical-align: -1.55em;"></span><span class="minner"><span class="mopen"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M403 1759 V84 H666 V0 H319 V1759 v0 v1759 h347 v-84
H403z M403 1759 V0 H319 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1076em;">f</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.1514em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.2861em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.21em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord"><span class="mord"><span class="mord mathnormal">c</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -1.81em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span><span class="mclose"><span class="delimsizing mult"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 2.05em;"><span class="" style="top: -4.05em;"><span class="pstrut" style="height: 5.6em;"></span><span class="" style="width: 0.667em; height: 3.6em;"> 
              <svg width="0.667em" height="3.600em" viewbox="0 0 667 3600"> 
               <path d="M347 1759 V0 H0 V84 H263 V1759 v0 v1759 H0 v84 H347z
M347 1759 V0 H263 V1759 v0 v1759 h84z"></path> 
              </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.55em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span><br> [R T]为旋转矩阵与平移向量，M为三维坐标点。</p> 
<p>张正友标定方法的核心即是采用平面标定板，从而可以方便的将标定点的真值Z置为0，以此方便计算。</p> 
<p>具体流程主要为<br> 1、计算相机内参（由于采用平面标定板，可以很方面的计算出单应矩阵，然后根据单应矩阵计算出内参）</p> 
<ol start="2"><li>计算初始相机外参（计算出内参后，根据单应矩阵直接计算即可获得外参）</li><li>最大似然优化相机内参与外参（1、2得到的结果必定是带有误差的，因此需进行优化，此处误差函数不考虑畸变）</li><li>计算畸变系数（以上一步算到的结果作为真值计算畸变系数）</li><li>所有参数一起最大似然优化 （将所有参数内参、外参、畸变系数一起优化）</li></ol> 
<pre><code class="prism language-bash">%% <span class="token number">1</span>. 计算初始相机内参
<span class="token assign-left variable">K</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">D</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">RT_list</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>K,H_list<span class="token punctuation">]</span> <span class="token operator">=</span> CalInitK<span class="token punctuation">(</span>CaliBoard,img_points<span class="token punctuation">)</span><span class="token punctuation">;</span>

%% <span class="token number">2</span>. 计算初始相机外参
RT_list <span class="token operator">=</span> CalInitRT<span class="token punctuation">(</span>K,H_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

%% <span class="token number">3</span>. 最大似然优化 
<span class="token punctuation">[</span>K,RT_list<span class="token punctuation">]</span> <span class="token operator">=</span> MinReprojErrorKRT<span class="token punctuation">(</span>K,RT_list,CaliBoard,img_points<span class="token punctuation">)</span><span class="token punctuation">;</span>

%% <span class="token number">4</span>. 计算畸变系数 
%   D <span class="token builtin class-name">:</span> 畸变参数,分别为k1,k2,k3,p1,p2
D <span class="token operator">=</span> CalDAll<span class="token punctuation">(</span>K,RT_list,CaliBoard,img_points<span class="token punctuation">)</span><span class="token punctuation">;</span>

%% <span class="token number">5</span>. 所有参数一起最大似然优化 
<span class="token punctuation">[</span>K,D,RT_list<span class="token punctuation">]</span> <span class="token operator">=</span> MinReprojErrorKDRT<span class="token punctuation">(</span>K,D,RT_list,CaliBoard,img_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="2__54"></a>2. 相机内参计算</h3> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> <span class="token punctuation">[</span>K,H_list<span class="token punctuation">]</span> <span class="token operator">=</span> CalInitK<span class="token punctuation">(</span>CaliBoard,img_points<span class="token punctuation">)</span>
% 相机初始内参计算
% <span class="token number">1</span>.计算单应矩阵
% <span class="token number">2</span>.根据旋转矩阵的特性，构建方程
% <span class="token number">3</span>.根据旋转矩阵的特性，构建方程


% inputs,
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点
%
% outputs,
%   K <span class="token builtin class-name">:</span> 相机内参
%   H_list <span class="token builtin class-name">:</span> 单应矩阵序列

K <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
H_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
%% <span class="token number">1</span>.计算单应矩阵
<span class="token keyword">for</span> i <span class="token operator">=</span> <span class="token number">1</span>:size<span class="token punctuation">(</span>img_points,1<span class="token punctuation">)</span>
    img_points_tmp <span class="token operator">=</span> cell2mat<span class="token punctuation">(</span>img_points<span class="token punctuation">(</span>i<span class="token punctuation">))</span><span class="token punctuation">;</span>
    index <span class="token operator">=</span> img_points_tmp<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tmp1 <span class="token operator">=</span> CaliBoard<span class="token punctuation">(</span>index,1:2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tmp2 <span class="token operator">=</span> img_points_tmp<span class="token punctuation">(</span>:,2:3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    H <span class="token operator">=</span> CalH<span class="token punctuation">(</span>tmp1,tmp2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    H_list<span class="token punctuation">(</span>i,:,:<span class="token punctuation">)</span> <span class="token operator">=</span> H<span class="token punctuation">;</span>
end

%% <span class="token number">2</span>.计算lambda*K^<span class="token punctuation">{<!-- --></span>-T<span class="token punctuation">}</span>*k^<span class="token punctuation">{<!-- --></span>-1<span class="token punctuation">}</span>,lambda为放缩因子
B <span class="token operator">=</span> CalB<span class="token punctuation">(</span>H_list<span class="token punctuation">)</span><span class="token punctuation">;</span>

%% <span class="token number">3</span>.根据B<span class="token operator">=</span>lambda*K^<span class="token punctuation">{<!-- --></span>-T<span class="token punctuation">}</span>*k^<span class="token punctuation">{<!-- --></span>-1<span class="token punctuation">}</span>计算K，lambda为放缩因子
v0 <span class="token operator">=</span> <span class="token punctuation">(</span>B<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span>*B<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span>-B<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span>*B<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">))</span>/<span class="token punctuation">(</span>B<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span>*B<span class="token punctuation">(</span><span class="token number">2,2</span><span class="token punctuation">)</span>-B<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span>*B<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
B_inv <span class="token operator">=</span> inv<span class="token punctuation">(</span>B<span class="token punctuation">)</span><span class="token punctuation">;</span> 
lambda <span class="token operator">=</span> B_inv<span class="token punctuation">(</span><span class="token number">3,3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
B_inv <span class="token operator">=</span> B_inv/lambda<span class="token punctuation">;</span>
c_x <span class="token operator">=</span> B_inv<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
c_y <span class="token operator">=</span> B_inv<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
f_x <span class="token operator">=</span> sqrt<span class="token variable"><span class="token punctuation">((</span>B_inv<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">-</span>c_x<span class="token operator">*</span>c_x<span class="token punctuation">))</span></span><span class="token punctuation">;</span>
f_y <span class="token operator">=</span> sqrt<span class="token variable"><span class="token punctuation">((</span>B_inv<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token operator">-</span>c_y<span class="token operator">*</span>c_y<span class="token punctuation">))</span></span><span class="token punctuation">;</span>
<span class="token assign-left variable">K</span><span class="token operator">=</span><span class="token punctuation">[</span>f_x,0,c_x<span class="token punctuation">;</span>
    <span class="token number">0</span>,f_y,c_y<span class="token punctuation">;</span>
    <span class="token number">0,0</span>,1<span class="token punctuation">]</span><span class="token punctuation">;</span>

end
</code></pre> 
<h4><a id="21__103"></a>2.1 单应矩阵计算</h4> 
<p>为方便计算，张正友采用了平面标定板，因此内参矩阵与旋转平移矩阵的乘积可以视作单应矩阵H即可得<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          s 
         
         
          
           
            
            
              m 
             
            
           
          
            − 
           
          
          
        
          = 
         
        
          K 
         
        
          [ 
         
         
          
           
            
            
              R 
             
            
           
           
            
            
              T 
             
            
           
          
         
        
          ] 
         
        
          M 
         
        
          = 
         
        
          H 
         
        
          M 
         
        
       
         s\overset{-}{\mathop{m}}\,=K[\begin{matrix} R &amp; T \\ \end{matrix}]M\text{=}HM 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.1389em;"></span><span class="mord mathnormal">s</span><span class="mord"><span class="mop op-limits"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.1389em;"><span class="" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class=""><span class="mop mathnormal" style="position: relative; top: -0.0347em;">m</span></span></span><span class="" style="top: -3.6306em; margin-left: 0em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.2em; vertical-align: -0.35em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mopen">[</span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.85em;"><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0077em;">R</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.35em;"><span class=""></span></span></span></span></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="arraycolsep" style="width: 0.5em;"></span><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.85em;"><span class="" style="top: -3.01em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.35em;"><span class=""></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mord text"><span class="mord">=</span></span><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span></span></span></span></span></span><br> <img src="https://images2.imgbox.com/c7/0e/XUQJ67Rt_o.png" alt="在这里插入图片描述"></p> 
<p>上面的公式若仅依靠这个变换自然是不成立的，但是考虑到Z为0，则可以变换为</p> 
<p><img src="https://images2.imgbox.com/f7/04/wAwhIbaq_o.png" alt="在这里插入图片描述"></p> 
<p>根据上述公式，可以列出等式<br> <img src="https://images2.imgbox.com/98/bc/ln18PX8W_o.png" alt="在这里插入图片描述"></p> 
<p>将其变换为对应的矩阵（为方便计算，将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          H 
         
        
          33 
         
        
       
      
        H_{33} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">33</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>视为1）<br> 则可得<br> <img src="https://images2.imgbox.com/20/8d/VsTg2tGo_o.png" alt="在这里插入图片描述"></p> 
<p>根据多个对应点构建多个上述方程，即可求解单应矩阵H。如上述矩阵所述，一个对应点可构建2个方程，H矩阵总共有8个未知数，则至少需要4个对应点。</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> H <span class="token operator">=</span> CalH<span class="token punctuation">(</span>CaliBoard,img_points<span class="token punctuation">)</span>
% % 相机单应矩阵计算
% 为方便计算，张正友采用了平面标定板，因此内参矩阵与旋转平移矩阵的乘积可以视作单应矩阵H即可得
% <span class="token assign-left variable">sm</span><span class="token operator">=</span>K<span class="token punctuation">[</span>r1 r2 T<span class="token punctuation">]</span>M,将其K<span class="token punctuation">[</span>r1 r2 T<span class="token punctuation">]</span>视为H，重构方程可得P1<span class="token operator">=</span>H*P，s为尺度因子，暂时隐藏
% 根据P1<span class="token operator">=</span>H*P得到两个方程，将H视为向量，构建方程
% 转变成A*X<span class="token operator">=</span>B的矩阵形式
% P1<span class="token punctuation">(</span>X1,Y1<span class="token punctuation">)</span>,表示img_points
% P<span class="token punctuation">(</span>X,Y<span class="token punctuation">)</span>，表示CaliBoard
% inputs,
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点（单张图像）
%
% outputs,
%   H <span class="token builtin class-name">:</span> 单应矩阵

<span class="token assign-left variable">H</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
XX1 <span class="token operator">=</span> CaliBoard<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span>.*img_points<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
X1Y <span class="token operator">=</span> img_points<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span>.*CaliBoard<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
XY1 <span class="token operator">=</span> CaliBoard<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span>.*img_points<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
YY1 <span class="token operator">=</span> CaliBoard<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span>.*img_points<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span><span class="token punctuation">;</span>

A <span class="token operator">=</span> zeros<span class="token punctuation">(</span>size<span class="token punctuation">(</span>CaliBoard,1<span class="token punctuation">)</span>*2,8<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>CaliBoard,1<span class="token punctuation">)</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,1:3<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>CaliBoard<span class="token punctuation">(</span>i,1:2<span class="token punctuation">)</span>,1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,7:8<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>-XX1<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>,-X1Y<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,4:6<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>CaliBoard<span class="token punctuation">(</span>i,1:2<span class="token punctuation">)</span>,1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,7:8<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>-XY1<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>,-YY1<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
end
<span class="token assign-left variable">B</span><span class="token operator">=</span>reshape<span class="token punctuation">(</span>img_points.<span class="token string">',[size(CaliBoard,1)*size(CaliBoard,2),1]);

H = A\B;
H=[H;1];
H = reshape(H,[3,3])'</span><span class="token punctuation">;</span>
end




</code></pre> 
<h4><a id="22__168"></a>2.2 基于单应矩阵计算相机内参</h4> 
<p>如2.1中所说，单应矩阵H=K[r1 r2 T]，但因为计算H时添加了<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          H 
         
        
          99 
         
        
       
      
        H_{99} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">99</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为1的约束，因此计算出来的结果应当添加一个尺寸因子，即计算出来的<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         H 
        
       
         = 
        
       
         λ 
        
       
         ∗ 
        
       
         K 
        
       
         ∗ 
        
       
      
        H = \lambda*K* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mord">∗</span></span></span></span></span>[r1 r2 T] ，可转为<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           k 
          
         
           1 
          
         
        
          ∗ 
         
        
          [ 
         
         
         
           H 
          
         
           1 
          
         
         
         
           H 
          
         
           2 
          
         
         
         
           H 
          
         
           3 
          
         
        
          ] 
         
        
          = 
         
        
          λ 
         
        
          ∗ 
         
        
          [ 
         
        
          r 
         
        
          1 
         
        
          r 
         
        
          2 
         
        
          T 
         
        
          ] 
         
        
       
         k_1*[H_1 H_2 H_3] = \lambda*[r1 r2 T] 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8444em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0315em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">]</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord">1</span><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="mclose">]</span></span></span></span></span></span><br> 其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          H 
         
        
          1 
         
        
       
         , 
        
        
        
          H 
         
        
          2 
         
        
       
         , 
        
        
        
          H 
         
        
          3 
         
        
       
      
        H_1,H_2,H_3 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8778em; vertical-align: -0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0813em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为单应矩阵的列。基于此结果，以及旋转矩阵的定义特性，可以构建两个方程，即<br> <img src="https://images2.imgbox.com/3f/ce/666aZRZA_o.png" alt="在这里插入图片描述"></p> 
<p>为了方便计算，可将<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          k 
         
         
         
           − 
          
         
           T 
          
         
        
        
        
          K 
         
         
         
           − 
          
         
           1 
          
         
        
       
      
        k^{-T}K^{-1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span>视为一个矩阵B先行求解，可得<br> <img src="https://images2.imgbox.com/6b/34/xp60xsM6_o.png" alt="在这里插入图片描述"><br> 其中，由于B为<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          k 
         
         
         
           − 
          
         
           T 
          
         
        
        
        
          K 
         
         
         
           − 
          
         
           1 
          
         
        
       
      
        k^{-T}K^{-1} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span></span>，可得<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          k 
         
         
         
           − 
          
         
           T 
          
         
        
        
        
          K 
         
         
         
           − 
          
         
           1 
          
         
        
       
         = 
        
       
         ( 
        
        
        
          k 
         
         
         
           − 
          
         
           T 
          
         
        
        
        
          K 
         
         
         
           − 
          
         
           1 
          
         
        
        
        
          ) 
         
        
          T 
         
        
       
      
        k^{-T}K^{-1}=(k^{-T}K^{-1})^T 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.0913em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0315em;">k</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span></span></span></span>，则B为对称矩阵，可将B定义为<br> <img src="https://images2.imgbox.com/ab/bc/TBep3jVO_o.png" alt="在这里插入图片描述"><br> 由上式可知B中有6个未知数，即最少需要3个H矩阵。同时，上述B中的式子如果计算出来，可以看出<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          B 
         
        
          12 
         
        
       
      
        B_{12} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.0502em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span>为0，因此，增加了一个约束条件，最少只需要两个H即可计算出结果。（此处为考虑下面n=2的情况）<br> 附：关于标定图片数量n和内参获取的关系（来自参考文献[2]）</p> 
<ul><li>如果 n&gt;=3，就可以得到唯一解b（带有一个比例因子λ）。</li><li>如果 n=2，也就是只有两张标定图片，那么我们可以设置内参中的γ=0（γ表示由于制造误差产生的两个坐标轴偏斜参数，通常很小，可忽略），将前面式子（搬运到下图）中γ=0可以看到对应 B12=0，换句话说，就是增加了一个约束条件：[0, 1, 0, 0, 0, 0]b = 0。（此处从运算角度上不理解，但若仅考虑未知数的数目，假设K只有4个未知数，则2个H足够计算）</li><li>如果n=1，只能假设u0, v0已知（位于图像中心）且 γ=0，这样只能解出fx, fy两个参数。<br> <img src="https://images2.imgbox.com/7d/29/csGMlhIw_o.png" alt="在这里插入图片描述"><br> 基于此，即可计算出B的值。（公式图片来自参考文献[2]）<br> <img src="https://images2.imgbox.com/3a/7e/gCZRJW6r_o.png" alt="在这里插入图片描述"><br> 然后基于B的值直接进行求解即可计算出内参。<br> <img src="https://images2.imgbox.com/93/1a/9h7QEZoH_o.png" alt="在这里插入图片描述"><br> 附：此处本人采用直接计算出B的逆矩阵，得到<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           B 
          
          
          
            − 
           
          
            1 
           
          
         
        
          = 
         
        
          K 
         
        
          ∗ 
         
         
         
           K 
          
         
           T 
          
         
        
       
         B^{-1}=K*K^{T} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0502em;">B</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8413em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span></span></span></span></span>,即<br> <img src="https://images2.imgbox.com/c8/b8/dD7b0Vee_o.png" alt="在这里插入图片描述"><br> 所得结果也一致（暂时不知道区别）</li></ul> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> B <span class="token operator">=</span> CalB<span class="token punctuation">(</span>H_list<span class="token punctuation">)</span>
% 相机内参K^<span class="token punctuation">{<!-- --></span>-T<span class="token punctuation">}</span>*k^<span class="token punctuation">{<!-- --></span>-1<span class="token punctuation">}</span>计算
% 根据旋转矩阵的性质，每个单应矩阵可以得到两个方程
% 最终得到 v_<span class="token punctuation">{<!-- --></span><span class="token number">12</span><span class="token punctuation">}</span>*b<span class="token operator">=</span><span class="token number">0</span>,<span class="token punctuation">(</span>v_<span class="token punctuation">{<!-- --></span><span class="token number">11</span><span class="token punctuation">}</span>-v_<span class="token punctuation">{<!-- --></span><span class="token number">22</span><span class="token punctuation">}</span><span class="token punctuation">)</span>*b<span class="token operator">=</span><span class="token number">0</span>,其中b为<span class="token punctuation">[</span>B11,B12,B13,B22,B23,B33<span class="token punctuation">]</span>^T
% v为~<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>v<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>ij<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">=</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token punctuation">\</span>left<span class="token punctuation">[</span> <span class="token punctuation">\</span>begin<span class="token punctuation">{<!-- --></span>matrix<span class="token punctuation">}</span>
%    <span class="token punctuation">\</span>begin<span class="token punctuation">{<!-- --></span>matrix<span class="token punctuation">}</span>
%    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j1<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&amp;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j2<span class="token punctuation">}</span><span class="token punctuation">}</span>+<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i2<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j1<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&amp;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i2<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j2<span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token punctuation">\</span><span class="token punctuation">\</span>
% <span class="token punctuation">\</span>end<span class="token punctuation">{<!-- --></span>matrix<span class="token punctuation">}</span> <span class="token operator">&amp;</span> <span class="token punctuation">\</span>begin<span class="token punctuation">{<!-- --></span>matrix<span class="token punctuation">}</span>
%    <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i3<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j1<span class="token punctuation">}</span><span class="token punctuation">}</span>+<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i1<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j3<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&amp;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i3<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j2<span class="token punctuation">}</span><span class="token punctuation">}</span>+<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i2<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j3<span class="token punctuation">}</span><span class="token punctuation">}</span> <span class="token operator">&amp;</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>i3<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span>h<span class="token punctuation">}</span>_<span class="token punctuation">{<!-- --></span>j3<span class="token punctuation">}</span><span class="token punctuation">}</span>  <span class="token punctuation">\</span><span class="token punctuation">\</span>
% <span class="token punctuation">\</span>end<span class="token punctuation">{<!-- --></span>matrix<span class="token punctuation">}</span>  <span class="token punctuation">\</span><span class="token punctuation">\</span>
% <span class="token punctuation">\</span>end<span class="token punctuation">{<!-- --></span>matrix<span class="token punctuation">}</span> <span class="token punctuation">\</span>right<span class="token punctuation">]</span><span class="token punctuation">}</span>^<span class="token punctuation">{<!-- --></span>T<span class="token punctuation">}</span><span class="token punctuation">}</span>

% inputs,
%   H_list <span class="token builtin class-name">:</span> 单应矩阵列表
%
% outputs,
%   B <span class="token builtin class-name">:</span> K^<span class="token punctuation">{<!-- --></span>-T<span class="token punctuation">}</span>*k^<span class="token punctuation">{<!-- --></span>-1<span class="token punctuation">}</span>

<span class="token assign-left variable">B</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

% 计算v
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>H_list,1<span class="token punctuation">)</span>
    h <span class="token operator">=</span> squeeze<span class="token punctuation">(</span>H_list<span class="token punctuation">(</span>i,:,:<span class="token punctuation">))</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">h</span><span class="token operator">=</span>h<span class="token string">'; % 公式计算时考虑按照列划分的1,2,3，所以需转置一下
    tmp_v(1,1) = h(1,1)*h(2,1);
    tmp_v(1,2) = h(1,2)*h(2,1)+h(1,1)*h(2,2);
    tmp_v(1,3) = h(1,3)*h(2,1)+h(1,1)*h(2,3);
    tmp_v(1,4) = h(1,2)*h(2,2);
    tmp_v(1,5) = h(1,3)*h(2,2)+h(1,2)*h(2,3);
    tmp_v(1,6) = h(1,3)*h(2,3);
    
    tmp_v(2,1) = h(1,1)*h(1,1)-h(2,1)*h(2,1);
    tmp_v(2,2) = 2*(h(1,2)*h(1,1)-h(2,2)*h(2,1));
    tmp_v(2,3) = 2*(h(1,3)*h(1,1)-h(2,3)*h(2,1));
    tmp_v(2,4) = h(1,2)*h(1,2)-h(2,2)*h(2,2);
    tmp_v(2,5) = 2*(h(1,3)*h(1,2)-h(2,3)*h(2,2));
    tmp_v(2,6) = h(1,3)*h(1,3)-h(2,3)*h(2,3);

    v(2*i-1:2*i,:) = tmp_v;
end

[U,S,V] = JOS_SVD(v);
b=V(:,6)'</span><span class="token punctuation">;</span>
B <span class="token operator">=</span><span class="token punctuation">[</span>b<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span>,b<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span>,b<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    b<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span>,b<span class="token punctuation">(</span><span class="token number">1,4</span><span class="token punctuation">)</span>,b<span class="token punctuation">(</span><span class="token number">1,5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     b<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span>,b<span class="token punctuation">(</span><span class="token number">1,5</span><span class="token punctuation">)</span>,b<span class="token punctuation">(</span><span class="token number">1,6</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
end
</code></pre> 
<h3><a id="3__244"></a>3 计算相机外参</h3> 
<p>相机内参知道后，根据公式<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         H 
        
       
         = 
        
       
         λ 
        
       
         ∗ 
        
       
         K 
        
       
         ∗ 
        
       
      
        H = \lambda*K* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="mord">∗</span></span></span></span></span>[r1 r2 T] 可直接计算外参，即<br> <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          K 
         
         
         
           − 
          
         
           1 
          
         
        
       
         H 
        
       
         = 
        
       
         λ 
        
       
         ∗ 
        
       
      
        K^{-1}H = \lambda* 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right: 0.0813em;">H</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">λ</span><span class="mord">∗</span></span></span></span></span>[r1 r2 T]<br> 由于旋转矩阵每列的模为1，可直接计算出外参矩阵。</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> <span class="token punctuation">[</span>RT_list<span class="token punctuation">]</span> <span class="token operator">=</span> CalInitRT<span class="token punctuation">(</span>K,H_list<span class="token punctuation">)</span>
% 相机初始内参计算
% r1 <span class="token operator">=</span> lambda*M^-1*h_1,lambda与求解内参时的不同，
% 个人理解求第二个尺度因子时需添加R为1的约束，求第一个时H本身是up to scale的，无关紧要。
% r2 <span class="token operator">=</span> lambda*M^-1*h_2
% r3 <span class="token operator">=</span> r1 x r2
% t <span class="token operator">=</span> lambda*M_1*h_3
%
% inputs,
%   K <span class="token builtin class-name">:</span> 相机内参
%   H_list :单应矩阵序列
%
% outputs,
%   RT_list <span class="token builtin class-name">:</span> 相机外参序列

RT_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
K_inv <span class="token operator">=</span> inv<span class="token punctuation">(</span>K<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>H_list,1<span class="token punctuation">)</span>
    h <span class="token operator">=</span> squeeze<span class="token punctuation">(</span>H_list<span class="token punctuation">(</span>i,:,:<span class="token punctuation">))</span><span class="token punctuation">;</span>
    lambda <span class="token operator">=</span> <span class="token number">1</span>/norm<span class="token punctuation">(</span>K_inv*h<span class="token punctuation">(</span>:,1<span class="token punctuation">))</span><span class="token punctuation">;</span>
    r1 <span class="token operator">=</span> lambda*K_inv*h<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r2 <span class="token operator">=</span> lambda*K_inv*h<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    r3 <span class="token operator">=</span> cross<span class="token punctuation">(</span>r1,r2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    t <span class="token operator">=</span> lambda*K_inv*h<span class="token punctuation">(</span>:,3<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rt <span class="token operator">=</span> <span class="token punctuation">[</span>r1,r2,r3,t<span class="token punctuation">]</span><span class="token punctuation">;</span>
    RT_list<span class="token punctuation">(</span>i,:,:<span class="token punctuation">)</span> <span class="token operator">=</span> rt<span class="token punctuation">;</span>
end
end
</code></pre> 
<h3><a id="4__279"></a>4. 最大似然优化</h3> 
<p>根据上述计算出的内参、外参矩阵，构建最小重投影误差函数，优化内参外参。其中需要注意的几个点主要为</p> 
<ol><li>旋转矩阵应转换为向量</li><li>优化是参数输入进去应为一个向量</li><li>重投影误差输出可以为二维矩阵（即X,Y两个方向）</li></ol> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> <span class="token punctuation">[</span>K_new,RT_list_new<span class="token punctuation">]</span> <span class="token operator">=</span> MinReprojErrorKRT<span class="token punctuation">(</span>K,RT_list,CaliBoard,img_points<span class="token punctuation">)</span>
% 最小化重投影误差函数
% inputs,
%   K <span class="token builtin class-name">:</span> 待优化相机内参
%   RT_list <span class="token builtin class-name">:</span> 待优化旋转平移矩阵
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点
%
% outputs,
%   K_new <span class="token builtin class-name">:</span> 优化后的相机内参
%   RT_list <span class="token builtin class-name">:</span> 优化后的旋转平移矩阵

<span class="token assign-left variable">K_new</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">RT_list_new</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

% 构建变量及初始值
X_init <span class="token punctuation">(</span><span class="token number">1</span>:4<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>K<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span>,K<span class="token punctuation">(</span><span class="token number">2,2</span><span class="token punctuation">)</span>,K<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span>,K<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>RT_list,1<span class="token punctuation">)</span>
    X_init <span class="token punctuation">(</span>i*6-1:i*6+1<span class="token punctuation">)</span> <span class="token operator">=</span> rodrigues<span class="token punctuation">(</span>squeeze<span class="token punctuation">(</span>RT_list<span class="token punctuation">(</span>i,:,1:3<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    X_init <span class="token punctuation">(</span><span class="token number">2</span>+i*6:4+i*6<span class="token punctuation">)</span> <span class="token operator">=</span> RT_list<span class="token punctuation">(</span>i,:,4<span class="token punctuation">)</span><span class="token string">';
end

% 优化参数
options = optimoptions(@lsqnonlin,'</span>Algorithm<span class="token string">','</span>levenberg-marquardt'<span class="token punctuation">)</span><span class="token punctuation">;</span>
f <span class="token operator">=</span> @<span class="token punctuation">(</span>x<span class="token punctuation">)</span>ReprojErrorKRT<span class="token punctuation">(</span>x,CaliBoard,img_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>result,resnorm,residual <span class="token punctuation">]</span> <span class="token operator">=</span> lsqnonlin<span class="token punctuation">(</span>f,X_init,<span class="token punctuation">[</span><span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token punctuation">]</span>,options<span class="token punctuation">)</span><span class="token punctuation">;</span>

%结果重构
K_new <span class="token operator">=</span> K<span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">2,2</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>RT_list,1<span class="token punctuation">)</span>
    RT_list_new<span class="token punctuation">(</span>i,:,1:3<span class="token punctuation">)</span> <span class="token operator">=</span> rodrigues<span class="token punctuation">(</span>result <span class="token punctuation">(</span>i*6-1:i*6+1<span class="token punctuation">))</span><span class="token punctuation">;</span>
    RT_list_new<span class="token punctuation">(</span>i,:,4<span class="token punctuation">)</span> <span class="token operator">=</span>  result <span class="token punctuation">(</span><span class="token number">2</span>+i*6:4+i*6<span class="token punctuation">)</span><span class="token punctuation">;</span>
end

end

</code></pre> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> erros_list <span class="token operator">=</span> ReprojErrorKRT<span class="token punctuation">(</span>X,CaliBoard,img_points<span class="token punctuation">)</span>
% 重投影误差函数
% inputs,
%   X: 待优化的参数，
%       X<span class="token punctuation">(</span><span class="token number">1</span>:4<span class="token punctuation">)</span>，f_x,f_y,c_x,c_y
%       X<span class="token punctuation">(</span><span class="token number">5</span>:7<span class="token punctuation">)</span> r
%       X<span class="token punctuation">(</span><span class="token number">8</span>:10<span class="token punctuation">)</span> t
%       以此类推，直到结束
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点
%
% outputs,
%   erros_list <span class="token builtin class-name">:</span> 重投影误差<span class="token punctuation">(</span>x,y两个方向，二维矩阵<span class="token punctuation">)</span>

<span class="token assign-left variable">repro</span><span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token assign-left variable">repro_list</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">erros_list</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">K</span><span class="token operator">=</span><span class="token punctuation">[</span>X<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,0,X<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">0</span>,X<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>,X<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">0,0</span>,1<span class="token punctuation">]</span><span class="token punctuation">;</span>
CaliBoard <span class="token operator">=</span> <span class="token punctuation">[</span>CaliBoard<span class="token punctuation">(</span>:,1:2<span class="token punctuation">)</span>,ones<span class="token punctuation">(</span>size<span class="token punctuation">(</span>CaliBoard,1<span class="token punctuation">)</span>,1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>img_points,1<span class="token punctuation">)</span>
    img_points_tmp <span class="token operator">=</span> cell2mat<span class="token punctuation">(</span>img_points<span class="token punctuation">(</span>i<span class="token punctuation">))</span><span class="token punctuation">;</span>
    index <span class="token operator">=</span> img_points_tmp<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CaliBoard_tmp <span class="token operator">=</span> CaliBoard<span class="token punctuation">(</span>index,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">R</span><span class="token operator">=</span> rodrigues<span class="token punctuation">(</span> X <span class="token punctuation">(</span>i*6-1:i*6+1<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">T</span><span class="token operator">=</span> X <span class="token punctuation">(</span><span class="token number">2</span>+i*6:4+i*6<span class="token punctuation">)</span><span class="token string">';
    RT = [R(:,1:2),T];
    img_points_proj = K*RT*CaliBoard_tmp'</span><span class="token punctuation">;</span>
    img_points_proj<span class="token punctuation">(</span><span class="token number">1</span>,:<span class="token punctuation">)</span><span class="token operator">=</span>img_points_proj<span class="token punctuation">(</span><span class="token number">1</span>,:<span class="token punctuation">)</span>./img_points_proj<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img_points_proj<span class="token punctuation">(</span><span class="token number">2</span>,:<span class="token punctuation">)</span><span class="token operator">=</span>img_points_proj<span class="token punctuation">(</span><span class="token number">2</span>,:<span class="token punctuation">)</span>./img_points_proj<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img_points_proj<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">img_points_proj</span><span class="token operator">=</span>img_points_proj'<span class="token punctuation">;</span>
    error <span class="token operator">=</span>squeeze<span class="token punctuation">(</span>img_points_tmp<span class="token punctuation">(</span>:,2:3<span class="token punctuation">))</span>-img_points_proj<span class="token punctuation">(</span>:,1:2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">erros_list</span><span class="token operator">=</span><span class="token punctuation">[</span>erros_list<span class="token punctuation">;</span>error<span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    % 调试用
    erros_dis <span class="token operator">=</span>vecnorm<span class="token punctuation">(</span>error,2,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    repro <span class="token operator">=</span> repro+sum<span class="token punctuation">(</span>erros_dis.*erros_dis<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">repro_list</span><span class="token operator">=</span><span class="token punctuation">[</span>repro_list<span class="token punctuation">;</span>sum<span class="token punctuation">(</span>erros_dis.*erros_dis<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
end
end
</code></pre> 
<h3><a id="5__374"></a>5. 计算畸变系数</h3> 
<p>在不考虑畸变系数的情况下优化完内外参数后，可以计算畸变系数。需要注明，畸变变换是在归一化平面进行的，因此计算时可以直接将坐标变换到归一化坐标系方便进行计算，也方便进行理解。<br> 设（u,v）为标定板根据外参投影到归一化平面上的点坐标，<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
        
          u 
         
         
         
           d 
          
         
           i 
          
         
           s 
          
         
        
       
         , 
        
        
        
          v 
         
         
         
           d 
          
         
           i 
          
         
           s 
          
         
        
       
         ) 
        
       
      
        (u_{dis},v_{dis}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3361em;"><span class="" style="top: -2.55em; margin-left: -0.0359em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">d</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight">s</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>为畸变后的坐标，也即实际图像坐标根据内参反向映射到归一化平面。则可得<br> <img src="https://images2.imgbox.com/17/e9/uzmkxmuz_o.png" alt="在这里插入图片描述"><br> 其中<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
        
        
          r 
         
        
          2 
         
        
       
         = 
        
        
        
          u 
         
        
          2 
         
        
       
         + 
        
        
        
          v 
         
        
          2 
         
        
       
      
        r^2=u^2+v^2 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0278em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.8974em; vertical-align: -0.0833em;"></span><span class="mord"><span class="mord mathnormal">u</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8141em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span><br> 将其转化为方程，则是<br> <img src="https://images2.imgbox.com/b6/21/pbrcHhXJ_o.png" alt="在这里插入图片描述"><br> 可以写成<br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          A 
         
        
          D 
         
        
          = 
         
        
          d 
         
        
       
         AD=d 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right: 0.0278em;">D</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal">d</span></span></span></span></span></span><br> 则可直接计算出畸变参数。<br> 附：注意事项</p> 
<ul><li>注意变换是在归一化坐标系，所以最好的办法就是转换到归一化坐标系进行计算，不然容易发生错误。</li></ul> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> D <span class="token operator">=</span> CalDAll<span class="token punctuation">(</span>K,RT_list,CaliBoard,img_points<span class="token punctuation">)</span>
% 畸变参数计算函数，径向畸变与切向畸变

%将函数记成A*D<span class="token operator">=</span>d
% inputs,
%   K <span class="token builtin class-name">:</span> 相机内参
%   RT_list <span class="token builtin class-name">:</span> 旋转平移矩阵
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点
%
% outputs,
%   dis <span class="token builtin class-name">:</span> 畸变参数,分别为k1,k2,k3,p1,p2

img_points_all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
CaliBoard <span class="token operator">=</span> <span class="token punctuation">[</span>CaliBoard<span class="token punctuation">(</span>:,1:2<span class="token punctuation">)</span>,ones<span class="token punctuation">(</span>size<span class="token punctuation">(</span>CaliBoard,1<span class="token punctuation">)</span>,1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
img_points__proj_norm_all <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

% 重投影获取归一化坐标点
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>img_points,1<span class="token punctuation">)</span>
    
    img_points_tmp <span class="token operator">=</span> cell2mat<span class="token punctuation">(</span>img_points<span class="token punctuation">(</span>i<span class="token punctuation">))</span><span class="token punctuation">;</span>
    RT <span class="token operator">=</span> <span class="token punctuation">[</span>squeeze<span class="token punctuation">(</span>RT_list<span class="token punctuation">(</span>i,:,1:2<span class="token punctuation">))</span>,squeeze<span class="token punctuation">(</span>RT_list<span class="token punctuation">(</span>i,:,4<span class="token punctuation">))</span><span class="token string">'];
    
    %获取所有图像点
    img_points_all=[img_points_all;squeeze(img_points_tmp(:,2:3))];
    
    % 理想点在归一化坐标系上的点 x
    img_points_proj_norm = RT*CaliBoard'</span><span class="token punctuation">;</span>
    img_points_proj_norm<span class="token punctuation">(</span><span class="token number">1</span>,:<span class="token punctuation">)</span><span class="token operator">=</span>img_points_proj_norm<span class="token punctuation">(</span><span class="token number">1</span>,:<span class="token punctuation">)</span>./img_points_proj_norm<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img_points_proj_norm<span class="token punctuation">(</span><span class="token number">2</span>,:<span class="token punctuation">)</span><span class="token operator">=</span>img_points_proj_norm<span class="token punctuation">(</span><span class="token number">2</span>,:<span class="token punctuation">)</span>./img_points_proj_norm<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img_points_proj_norm<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">img_points_proj_norm</span><span class="token operator">=</span>img_points_proj_norm<span class="token string">';
    img_points__proj_norm_all= [img_points__proj_norm_all;img_points_proj_norm(:,1:2)];
end


% 畸变后的点在归一化坐标系上的点 x_dis
img_points_norm_all = inv(K)*[img_points_all,ones(size(img_points_all,1),1)]'</span><span class="token punctuation">;</span>
img_points_norm_all <span class="token operator">=</span>img_points_norm_all'<span class="token punctuation">;</span>
% 计算D,d
r2 <span class="token operator">=</span> sum<span class="token punctuation">(</span>img_points__proj_norm_all.*img_points__proj_norm_all,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
r4 <span class="token operator">=</span> r2.*r2<span class="token punctuation">;</span>
r6 <span class="token operator">=</span> r2.*r4<span class="token punctuation">;</span>

u <span class="token operator">=</span> img_points__proj_norm_all<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">v</span> <span class="token operator">=</span> img_points__proj_norm_all<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span><span class="token punctuation">;</span>
u_dis <span class="token operator">=</span> img_points_norm_all<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
v_dis <span class="token operator">=</span> img_points_norm_all<span class="token punctuation">(</span>:,2<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>img_points_all,1<span class="token punctuation">)</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,1<span class="token punctuation">)</span> <span class="token operator">=</span> u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*r2<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,2<span class="token punctuation">)</span> <span class="token operator">=</span> u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*r4<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,3<span class="token punctuation">)</span> <span class="token operator">=</span> u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*r6<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,4<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>*u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i-1,5<span class="token punctuation">)</span> <span class="token operator">=</span> r2<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>+2*u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,1<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*r2<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,2<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*r4<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,3<span class="token punctuation">)</span> <span class="token operator">=</span> v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*r6<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,4<span class="token punctuation">)</span> <span class="token operator">=</span> r2<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>+2*v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    A<span class="token punctuation">(</span><span class="token number">2</span>*i,5<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span>*u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>*v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    d<span class="token punctuation">(</span><span class="token number">2</span>*i-1,1<span class="token punctuation">)</span> <span class="token operator">=</span> u_dis<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>-u<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    d<span class="token punctuation">(</span><span class="token number">2</span>*i,1<span class="token punctuation">)</span> <span class="token operator">=</span> v_dis<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span>-v<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
end

D <span class="token operator">=</span> A<span class="token punctuation">\</span>d<span class="token punctuation">;</span>

end
</code></pre> 
<h3><a id="6__461"></a>6. 考虑畸变系数的优化</h3> 
<p>与4中基本一致，只是投影时考虑到了畸变参数。</p> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> <span class="token punctuation">[</span>K_new,D_new,RT_list_new<span class="token punctuation">]</span> <span class="token operator">=</span> MinReprojErrorKDRT<span class="token punctuation">(</span>K,D,RT_list,CaliBoard,img_points<span class="token punctuation">)</span>
% 最小化重投影误差函数
% inputs,
%   K <span class="token builtin class-name">:</span> 待优化相机内参
%   D: 待优化的相机畸变参数
%   RT_list <span class="token builtin class-name">:</span> 待优化旋转平移矩阵
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点
%
% outputs,
%   K_new <span class="token builtin class-name">:</span> 优化后的相机内参
%   D_new: 优化后的相机畸变参数
%   RT_list <span class="token builtin class-name">:</span> 优化后的旋转平移矩阵

<span class="token assign-left variable">K_new</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">RT_list_new</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">D_new</span><span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
% 构建变量及初始值
X_init <span class="token punctuation">(</span><span class="token number">1</span>:4<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">[</span>K<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span>,K<span class="token punctuation">(</span><span class="token number">2,2</span><span class="token punctuation">)</span>,K<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span>,K<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
X_init<span class="token punctuation">(</span><span class="token number">5</span>:9<span class="token punctuation">)</span> <span class="token operator">=</span> D<span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>RT_list,1<span class="token punctuation">)</span>
    X_init <span class="token punctuation">(</span>i*6+4:i*6+6<span class="token punctuation">)</span> <span class="token operator">=</span> rodrigues<span class="token punctuation">(</span>squeeze<span class="token punctuation">(</span>RT_list<span class="token punctuation">(</span>i,:,1:3<span class="token punctuation">))</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    X_init <span class="token punctuation">(</span><span class="token number">7</span>+i*6:9+i*6<span class="token punctuation">)</span> <span class="token operator">=</span> RT_list<span class="token punctuation">(</span>i,:,4<span class="token punctuation">)</span><span class="token string">';
end

% 优化参数
options = optimoptions(@lsqnonlin,'</span>Algorithm<span class="token string">','</span>levenberg-marquardt'<span class="token punctuation">)</span><span class="token punctuation">;</span>
f <span class="token operator">=</span> @<span class="token punctuation">(</span>x<span class="token punctuation">)</span>ReprojErrorKDRT<span class="token punctuation">(</span>x,CaliBoard,img_points<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">[</span>result,resnorm,residual <span class="token punctuation">]</span> <span class="token operator">=</span> lsqnonlin<span class="token punctuation">(</span>f,X_init,<span class="token punctuation">[</span><span class="token punctuation">]</span>,<span class="token punctuation">[</span><span class="token punctuation">]</span>,options<span class="token punctuation">)</span><span class="token punctuation">;</span>

%结果重构
K_new <span class="token operator">=</span> K<span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">1,1</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">2,2</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">1,3</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
K_new<span class="token punctuation">(</span><span class="token number">2,3</span><span class="token punctuation">)</span> <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
D_new <span class="token operator">=</span> result<span class="token punctuation">(</span><span class="token number">5</span>:9<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>RT_list,1<span class="token punctuation">)</span>
    RT_list_new<span class="token punctuation">(</span>i,:,1:3<span class="token punctuation">)</span> <span class="token operator">=</span> rodrigues<span class="token punctuation">(</span>result <span class="token punctuation">(</span>i*6+4:i*6+6<span class="token punctuation">))</span><span class="token punctuation">;</span>
    RT_list_new<span class="token punctuation">(</span>i,:,4<span class="token punctuation">)</span> <span class="token operator">=</span>  result <span class="token punctuation">(</span><span class="token number">7</span>+i*6:9+i*6<span class="token punctuation">)</span><span class="token punctuation">;</span>
end

end

</code></pre> 
<pre><code class="prism language-bash"><span class="token keyword">function</span> error <span class="token operator">=</span> ReprojErrorKDRT<span class="token punctuation">(</span>X,CaliBoard,img_points<span class="token punctuation">)</span>
% 重投影误差函数,考虑畸变参数
% inputs,
%   X: 待优化的参数，
%       X<span class="token punctuation">(</span><span class="token number">1</span>:4<span class="token punctuation">)</span>，f_x,f_y,c_x,c_y
%       X<span class="token punctuation">(</span><span class="token number">5</span>:9<span class="token punctuation">)</span>,k1,k2,k3,p1,p2
%       X<span class="token punctuation">(</span><span class="token number">10</span>:12<span class="token punctuation">)</span> r
%       X<span class="token punctuation">(</span><span class="token number">12</span>:14<span class="token punctuation">)</span> t
%       以此类推，直到结束
%   CaliBoard <span class="token builtin class-name">:</span> 标定板真实坐标点
%   img_points :相机拍摄到的图像提取到的标定板点
%
% outputs,
%   erros_list <span class="token builtin class-name">:</span> 重投影误差<span class="token punctuation">(</span>x,y两个方向，二维矩阵<span class="token punctuation">)</span>

<span class="token assign-left variable">repro</span><span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token assign-left variable">repro_list</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">K</span><span class="token operator">=</span><span class="token punctuation">[</span>X<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>,0,X<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">0</span>,X<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>,X<span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token number">0,0</span>,1<span class="token punctuation">]</span><span class="token punctuation">;</span>
k1 <span class="token operator">=</span> X<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
k2 <span class="token operator">=</span> X<span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
k3 <span class="token operator">=</span> X<span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1 <span class="token operator">=</span> X<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p2 <span class="token operator">=</span> X<span class="token punctuation">(</span><span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

CaliBoard <span class="token operator">=</span> <span class="token punctuation">[</span>CaliBoard<span class="token punctuation">(</span>:,1:2<span class="token punctuation">)</span>,ones<span class="token punctuation">(</span>size<span class="token punctuation">(</span>CaliBoard,1<span class="token punctuation">)</span>,1<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">img_points_proj_norm_all</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token assign-left variable">img_points_all</span><span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
% 重投影获取像素坐标点
<span class="token keyword">for</span> <span class="token assign-left variable">i</span><span class="token operator">=</span><span class="token number">1</span>:size<span class="token punctuation">(</span>img_points,1<span class="token punctuation">)</span>
    img_points_tmp <span class="token operator">=</span> cell2mat<span class="token punctuation">(</span>img_points<span class="token punctuation">(</span>i<span class="token punctuation">))</span><span class="token punctuation">;</span>
    index <span class="token operator">=</span> img_points_tmp<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    CaliBoard_tmp <span class="token operator">=</span> CaliBoard<span class="token punctuation">(</span>index,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token assign-left variable">R</span><span class="token operator">=</span> rodrigues<span class="token punctuation">(</span> X <span class="token punctuation">(</span>i*6+4:i*6+6<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">T</span><span class="token operator">=</span> X <span class="token punctuation">(</span><span class="token number">7</span>+i*6:9+i*6<span class="token punctuation">)</span><span class="token string">';
    RT = [R(:,1:2),T];
    
    % 理想点在归一化坐标系上的点 x
    img_points_proj_norm = RT*CaliBoard'</span><span class="token punctuation">;</span>
    img_points_proj_norm<span class="token punctuation">(</span><span class="token number">1</span>,:<span class="token punctuation">)</span><span class="token operator">=</span>img_points_proj_norm<span class="token punctuation">(</span><span class="token number">1</span>,:<span class="token punctuation">)</span>./img_points_proj_norm<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img_points_proj_norm<span class="token punctuation">(</span><span class="token number">2</span>,:<span class="token punctuation">)</span><span class="token operator">=</span>img_points_proj_norm<span class="token punctuation">(</span><span class="token number">2</span>,:<span class="token punctuation">)</span>./img_points_proj_norm<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token punctuation">;</span>
    img_points_proj_norm<span class="token punctuation">(</span><span class="token number">3</span>,:<span class="token punctuation">)</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token assign-left variable">img_points_proj_norm</span><span class="token operator">=</span>img_points_proj_norm<span class="token string">';
    img_points_proj_norm_all= [img_points_proj_norm_all;img_points_proj_norm(:,1:2)];
    %获取所有图像点
    img_points_all=[img_points_all;squeeze(img_points_tmp(:,2:3))];end

% 计算D,d
r2 = sum(img_points_proj_norm_all.*img_points_proj_norm_all,2);
r4 = r2.*r2;
r6 = r2.*r4;

x = img_points_proj_norm_all(:,1);
y = img_points_proj_norm_all(:,2);

x_dis = x.*(1+k1.*r2+k2.*r4+k3.*r6)+2*p1*(x.*y)+p2*(r2+2*x.*x);
y_dis = y.*(1+k1.*r2+k2.*r4+k3.*r6)+2*p2*(x.*y)+p1*(r2+2*y.*y);

img_points_proj_all = K*[x_dis,y_dis,ones(size(x_dis,1),1)]'</span><span class="token punctuation">;</span>
img_points_proj_all <span class="token operator">=</span> img_points_proj_all'<span class="token punctuation">;</span>
error <span class="token operator">=</span> img_points_proj_all<span class="token punctuation">(</span>:,1:2<span class="token punctuation">)</span>-img_points_all<span class="token punctuation">;</span>
end
</code></pre> 
<h2><a id="_578"></a>参考文献</h2> 
<p>[1] 张正友标定算法原理详解.https://www.jianshu.com/p/9d2fe4c2e3b7<br> [2]张正友标定法-完整学习笔记-从原理到实战. https://zhuanlan.zhihu.com/p/136827980<br> [3]张正友标定法.https://www.cnblogs.com/linzzz98/articles/13604279.html</p> 
<h2><a id="_584"></a>相关资源代码</h2> 
<p>部分库可以下载看<br> https://download.csdn.net/download/zhangpan333/85445628</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/f2aeea98ab4ed24900eb7d7d4512968e/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">开发工具篇第三讲：你连maven都不懂面试官怎么敢要你</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/31e901c8952dbe4b562b858c67a42567/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">三维重建——NeuralRecon项目源码解读</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>