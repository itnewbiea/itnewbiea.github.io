<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GAMES101：作业3记录 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GAMES101：作业3记录" />
<meta property="og:description" content="文章目录 总览使用框架代码说明运行与结果代码实现rasterize_triangle(const Triangle&amp; t)的实现get_projection_matrix()的实现phong_fragment_shader()的实现texture_fragment_shader()的实现bump_fragment_shader()的实现displacement_fragment_shader()的实现尝试其他的obj模型双线性插值 总览 在这次编程任务中，我们会进一步模拟现代图形技术。我们在代码中添加了Object Loader(用于加载三维模型), Vertex Shader 与 Fragment Shader，并且支持了纹理映射。
而在本次实验中，你需要完成的任务是:
修改函数 rasterize_triangle(const Triangle&amp; t) in rasterizer.cpp: 在此处实现与作业 2 类似的插值算法，实现法向量、颜色、纹理颜色的插值。修改函数 get_projection_matrix() in main.cpp: 将你自己在之前的实验中实现的投影矩阵填到此处，此时你可以运行 ./Rasterizer output.png normal来观察法向量实现结果。修改函数 phong_fragment_shader() in main.cpp: 实现 Blinn-Phong 模型计算 Fragment Color.修改函数 texture_fragment_shader() in main.cpp: 在实现 Blinn-Phong的基础上，将纹理颜色视为公式中的 kd，实现 TextureShading Fragment Shader.修改函数 bump_fragment_shader() in main.cpp: 在实现 Blinn-Phong 的基础上，仔细阅读该函数中的注释，实现 Bump mapping.修改函数 displacement_fragment_shader() in main.cpp: 在实现 Bump mapping 的基础上，实现 displacement mapping
这将会生成命名为 Rasterizer 的可执行文件。使用该可执行文件时，你传入的第二个参数将会是生成的图片文件名，而第三个参数可以是如下内容： 使用 texture: 使用代码中的 texture shader." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c879a398f0fb960c49d4665f297dfce8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-03T22:29:57+08:00" />
<meta property="article:modified_time" content="2024-01-03T22:29:57+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GAMES101：作业3记录</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_2" rel="nofollow">总览</a></li><li><a href="#_15" rel="nofollow">使用</a></li><li><a href="#_28" rel="nofollow">框架代码说明</a></li><li><a href="#_39" rel="nofollow">运行与结果</a></li><li><a href="#_57" rel="nofollow">代码实现</a></li><li><ul><li><a href="#rasterize_triangleconst_Triangle_t_155" rel="nofollow">rasterize_triangle(const Triangle&amp; t)的实现</a></li><li><a href="#get_projection_matrix_287" rel="nofollow">get_projection_matrix()的实现</a></li><li><a href="#phong_fragment_shader_357" rel="nofollow">phong_fragment_shader()的实现</a></li><li><a href="#texture_fragment_shader_411" rel="nofollow">texture_fragment_shader()的实现</a></li><li><a href="#bump_fragment_shader_514" rel="nofollow">bump_fragment_shader()的实现</a></li><li><a href="#displacement_fragment_shader_661" rel="nofollow">displacement_fragment_shader()的实现</a></li><li><a href="#obj_753" rel="nofollow">尝试其他的obj模型</a></li><li><a href="#_793" rel="nofollow">双线性插值</a></li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="_2"></a>总览</h2> 
<p>在这次编程任务中，我们会进一步模拟现代图形技术。我们在代码中添加了Object Loader(用于加载三维模型), Vertex Shader 与 Fragment Shader，并且支持了纹理映射。</p> 
<p>而在本次实验中，你需要完成的任务是:</p> 
<ul><li>修改函数 <code>rasterize_triangle(const Triangle&amp; t)</code> in rasterizer.cpp: 在此处实现与作业 2 类似的插值算法，实现法向量、颜色、纹理颜色的插值。</li><li>修改函数 <code>get_projection_matrix()</code> in main.cpp: 将你自己在之前的实验中实现的投影矩阵填到此处，此时你可以运行 ./Rasterizer output.png normal来观察法向量实现结果。</li><li>修改函数 <code>phong_fragment_shader()</code> in main.cpp: 实现 Blinn-Phong 模型计算 Fragment Color.</li><li>修改函数 <code>texture_fragment_shader()</code> in main.cpp: 在实现 Blinn-Phong的基础上，将纹理颜色视为公式中的 kd，实现 TextureShading Fragment Shader.</li><li>修改函数 <code>bump_fragment_shader()</code> in main.cpp: 在实现 Blinn-Phong 的基础上，仔细阅读该函数中的注释，实现 Bump mapping.</li><li>修改函数 <code>displacement_fragment_shader()</code> in main.cpp: 在实现 Bump mapping 的基础上，实现 displacement mapping<br> 这将会生成命名为 Rasterizer 的可执行文件。使用该可执行文件时，你传入的第二个参数将会是生成的图片文件名，而第三个参数可以是如下内容：</li></ul> 
<h2><a id="_15"></a>使用</h2> 
<p><strong>texture</strong>: 使用代码中的 texture shader.<br> 使用举例: <code>./Rasterizer output.png texture</code><br> <strong>normal</strong>: 使用代码中的 normal shader.<br> 使用举例: <code>./Rasterizer output.png normal</code><br> <strong>phong</strong>: 使用代码中的 blinn-phong shader.<br> 使用举例: <code>./Rasterizer output.png phong</code><br> <strong>bump</strong>: 使用代码中的 bump shader.<br> 使用举例: <code>./Rasterizer output.png bump</code><br> <strong>displacement</strong>: 使用代码中的 displacement shader.<br> 使用举例: <code>./Rasterizer output.png displacement</code><br> 当你修改代码之后，你需要重新 make 才能看到新的结果。</p> 
<h2><a id="_28"></a>框架代码说明</h2> 
<p>相比上次实验，我们对框架进行了如下修改：</p> 
<ul><li>我们引入了一个第三方.obj 文件加载库来读取更加复杂的模型文件，这部分库文件在OBJ_Loader.h file. 你无需详细理解它的工作原理，只需知道这个库将会传递给我们一个被命名被 TriangleList 的 Vector，其中每个三角形都有对应的点法向量与纹理坐标。此外，与模型相关的纹理也将被一同加载。<br> <strong>注意：如果你想尝试加载其他模型，你目前只能手动修改模型路径。</strong></li><li>我们引入了一个新的 Texture 类以从图片生成纹理，并且提供了查找纹理颜色的接口：Vector3f getColor(float u, float v)</li><li>我们创建了 Shader.hpp 头文件并定义 <code>fragment_shader_payload</code>，其中包括了 Fragment Shader 可能用到的参数。目前 <code>main.cpp</code> 中有三个 Fragment Shader，其中 fragment_shader 是按照法向量上色的样例 Shader，其余两个将由你来实现。</li><li>主渲染流水线开始于 <code>rasterizer::draw(std::vector&lt;Triangle&gt; &amp;TriangleList)</code>.我们再次进行一系列变换，这些变换一般由 Vertex Shader 完成。在此之后，我们调用函数 rasterize_triangle.</li><li>rasterize_triangle 函数与你在作业 2 中实现的内容相似。不同之处在于被设定的数值将不再是常数，而是按照 <code>Barycentric Coordinates</code> 对<strong>法向量、颜色、纹理颜色与底纹颜色</strong> (Shading Colors) 进行插值。回忆我们上次为了计算<code>z value</code> 而提供的 <code>[alpha, beta, gamma]</code>，这次你将需要将其应用在其他参数的插值上。你需要做的是计算插值后的颜色，并将 Fragment Shader 计算得到的颜色写入 framebuffer，这要求你首先使用插值得到的结果设置 <code>fragment shader payload</code>，并调用 fragment shader 得到计算结果。</li></ul> 
<h2><a id="_39"></a>运行与结果</h2> 
<p>在你按照上述说明将上次作业的代码复制到对应位置，并作出相应修改之后（请务必认真阅读说明），你就可以运行默认的 normal shader 并观察到如下结果：</p> 
<p><img src="https://images2.imgbox.com/52/08/rHanTOgG_o.png" alt="在这里插入图片描述"><br> 实现 Blinn-Phong 反射模型之后的结果应该是：</p> 
<p><img src="https://images2.imgbox.com/df/1f/tb9z2LkF_o.png" alt="在这里插入图片描述"><br> 实现纹理之后的结果应该是：</p> 
<p><img src="https://images2.imgbox.com/7e/24/pPAwTULs_o.png" alt="在这里插入图片描述"><br> 实现 Bump Mapping 后，你将看到可视化的凹凸向量:<br> <img src="https://images2.imgbox.com/b4/41/0DKnziQh_o.png" alt="在这里插入图片描述"><br> 实现 Displacement Mapping 后，你将看到如下结果:</p> 
<p><img src="https://images2.imgbox.com/ac/cb/TOu3gwPW_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h2><a id="_57"></a>代码实现</h2> 
<p>我们先看一下<code>rasterizer::draw</code>的实现：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> rst<span class="token double-colon punctuation">::</span>rasterizer<span class="token double-colon punctuation">::</span><span class="token function">draw</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>Triangle <span class="token operator">*</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span>TriangleList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">float</span> f1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">-</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> f2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">50</span> <span class="token operator">+</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.0</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Matrix4f mvp <span class="token operator">=</span> projection <span class="token operator">*</span> view <span class="token operator">*</span> model<span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">auto</span><span class="token operator">&amp;</span> t<span class="token operator">:</span>TriangleList<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        Triangle newtri <span class="token operator">=</span> <span class="token operator">*</span>t<span class="token punctuation">;</span>

        std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span>Eigen<span class="token double-colon punctuation">::</span>Vector4f<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span> mm <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span>view <span class="token operator">*</span> model <span class="token operator">*</span> t<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>view <span class="token operator">*</span> model <span class="token operator">*</span> t<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span>view <span class="token operator">*</span> model <span class="token operator">*</span> t<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//得到相机下的四维坐标</span>
        

        std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span>Eigen<span class="token double-colon punctuation">::</span>Vector3f<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span> viewspace_pos<span class="token punctuation">;</span>
        std<span class="token double-colon punctuation">::</span><span class="token function">transform</span><span class="token punctuation">(</span>mm<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mm<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> viewspace_pos<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">return</span> v<span class="token punctuation">.</span><span class="token keyword">template</span> <span class="token generic-function"><span class="token function">head</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//得到相机下的三维坐标</span>
 
        Eigen<span class="token double-colon punctuation">::</span>Vector4f v<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                mvp <span class="token operator">*</span> t<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                mvp <span class="token operator">*</span> t<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                mvp <span class="token operator">*</span> t<span class="token operator">-&gt;</span>v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//计算屏幕坐标</span>

        <span class="token comment">//Homogeneous division</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> vec <span class="token operator">:</span> v<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            vec<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/=</span>vec<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vec<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/=</span>vec<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vec<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">/=</span>vec<span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           
        <span class="token punctuation">}</span><span class="token comment">//进行了齐次除法，也就是透视除法，视锥体被变换到一个立方体</span>


        Eigen<span class="token double-colon punctuation">::</span>Matrix4f inv_trans <span class="token operator">=</span> <span class="token punctuation">(</span>view <span class="token operator">*</span> model<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">inverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">transpose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector4f n<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
                inv_trans <span class="token operator">*</span> <span class="token function">to_vec4</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>normal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                inv_trans <span class="token operator">*</span> <span class="token function">to_vec4</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>normal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                inv_trans <span class="token operator">*</span> <span class="token function">to_vec4</span><span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>normal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">//计算变换以后得新法线的方向</span>

        <span class="token comment">//Viewport transformation</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span> vert <span class="token operator">:</span> v<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            vert<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span>width<span class="token operator">*</span><span class="token punctuation">(</span>vert<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vert<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span>height<span class="token operator">*</span><span class="token punctuation">(</span>vert<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> f1 <span class="token operator">+</span> f2<span class="token punctuation">;</span><span class="token comment">//这里要添加一个负号</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//screen space coordinates</span>
            newtri<span class="token punctuation">.</span><span class="token function">setVertex</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//view space normal</span>
            newtri<span class="token punctuation">.</span><span class="token function">setNormal</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> n<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token generic-function"><span class="token function">head</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        newtri<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">148</span><span class="token punctuation">,</span><span class="token number">121.0</span><span class="token punctuation">,</span><span class="token number">92.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newtri<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">148</span><span class="token punctuation">,</span><span class="token number">121.0</span><span class="token punctuation">,</span><span class="token number">92.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        newtri<span class="token punctuation">.</span><span class="token function">setColor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">148</span><span class="token punctuation">,</span><span class="token number">121.0</span><span class="token punctuation">,</span><span class="token number">92.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Also pass view space vertice position</span>
        <span class="token function">rasterize_triangle</span><span class="token punctuation">(</span>newtri<span class="token punctuation">,</span> viewspace_pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>① 经过MV变换我们得到view space的点，存在mm里，而后传递给viewspace_pos，后面传递给了<code>rasterize_triangle</code>函数作为着色点的位置用于计算光源到着色点的单位向量。<br> ② 经过MVP变换我们得到投影空间的点，这时候已经投影到了平面，不过这时候投影的原点在矩形的中心，保存在了v，然后对这个齐次坐标进行了齐次除法（x,y,z分量除以第四个分量）w坐标记录了原本的z值，但是后面似乎没有用到。<br> ③ MV变换后的点法向量和原来的法向量不同，中间差了一个矩阵: <span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         M 
        
       
         V 
        
        
        
          ) 
         
         
         
           − 
          
         
           T 
          
         
        
       
      
        (MV)^{-T} 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.0913em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.109em;">M</span><span class="mord mathnormal" style="margin-right: 0.2222em;">V</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8413em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right: 0.1389em;">T</span></span></span></span></span></span></span></span></span></span></span></span></span>，这个推导在这篇文章里有写：<a href="https://blog.csdn.net/qq_38065509/article/details/105691559?spm=1001.2014.3001.5502">计算机图形学五：局部光照模型(Blinn-Phong 反射模型)与着色方法(Phong Shading)</a><br> ④ 为了变换到当前的屏幕的空间（原点在左下角，x轴向右，y轴向上），再次对MVP变换后的点做了一次变换：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span> <span class="token operator">&amp;</span> vert <span class="token operator">:</span> v<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    vert<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span>width<span class="token operator">*</span><span class="token punctuation">(</span>vert<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vert<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token operator">*</span>height<span class="token operator">*</span><span class="token punctuation">(</span>vert<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> f1 <span class="token operator">+</span> f2<span class="token punctuation">;</span><span class="token comment">//这里要添加一个负号</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>下面是从论坛截的一些同学的评论，觉得也挺好。<a href="https://games-cn.org/forums/topic/zuoye3-interpolated_shadingcoords/" rel="nofollow">作业3 interpolated_shadingcoords</a></p> 
<p><img src="https://images2.imgbox.com/47/47/IdX2IIAe_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/91/99/SgFjTgHq_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e2/6c/0mRL1QeC_o.png" alt="在这里插入图片描述"><br> 总结：在rasterizer::draw()函数里，使用newtri记录三角形的指针，并重新定义了三角形的属性：①法线：在相机空间viewspace（只进行MV变换）通过<code>setNormal()</code>函数实现;②顶点位置：在screen space(屏幕空间)，通过<code>setVertex()</code>函数实现，③viewspace下的三角形顶点的坐标通过参数的形式传递给了<code>rasterize_triangle()</code>函数，用作viewspace下使用重心插值公式渲染像素点的坐标interpolated_shadingcoords（详情看<code>rasterize_triangle()</code>函数）</p> 
<h3><a id="rasterize_triangleconst_Triangle_t_155"></a>rasterize_triangle(const Triangle&amp; t)的实现</h3> 
<pre><code class="prism language-cpp"><span class="token keyword">void</span> rst<span class="token double-colon punctuation">::</span>rasterizer<span class="token double-colon punctuation">::</span><span class="token function">rasterize_triangle</span><span class="token punctuation">(</span><span class="token keyword">const</span> Triangle<span class="token operator">&amp;</span> t<span class="token punctuation">,</span> <span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>array<span class="token operator">&lt;</span>Eigen<span class="token double-colon punctuation">::</span>Vector3f<span class="token punctuation">,</span> <span class="token number">3</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span> view_pos<span class="token punctuation">)</span> 
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO: From your HW3, get the triangle rasterization code.</span>
    <span class="token comment">// TODO: Inside your rasterization loop:</span>
    <span class="token comment">//    * v[i].w() is the vertex view space depth value z. //顶点的深度值</span>
    <span class="token comment">//    * Z is interpolated view space depth for the current pixel //当前像素的坐标值的深度</span>
    <span class="token comment">//    * zp is depth between zNear and zFar, used for z-buffer//zp计算的像素在zNear和zFar之间的深度，使用在z-buffer算法里</span>
    
    <span class="token comment">// float Z = 1.0 / (alpha / v[0].w() + beta / v[1].w() + gamma / v[2].w());//alpha beta gamma通过插值函数求出</span>
    <span class="token comment">// float zp = alpha * v[0].z() / v[0].w() + beta * v[1].z() / v[1].w() + gamma * v[2].z() / v[2].w();</span>
    <span class="token comment">// zp *= Z;</span>

    <span class="token comment">//view_pos: 这里使用的是相机下看到的坐标</span>

    <span class="token comment">// TODO: Interpolate the attributes:</span>
    <span class="token comment">// auto interpolated_color</span>
    <span class="token comment">// auto interpolated_normal</span>
    <span class="token comment">// auto interpolated_texcoords</span>
    <span class="token comment">// auto interpolated_shadingcoords</span>

    <span class="token comment">// Use: fragment_shader_payload payload( interpolated_color, interpolated_normal.normalized(), interpolated_texcoords, texture ? &amp;*texture : nullptr);</span>
    <span class="token comment">// Use: payload.view_pos = interpolated_shadingcoords;</span>
    <span class="token comment">// Use: Instead of passing the triangle's color directly to the frame buffer, pass the color to the shaders first to get the final color;</span>
    <span class="token comment">// Use: auto pixel_color = fragment_shader(payload);</span>

    <span class="token keyword">auto</span> v <span class="token operator">=</span> t<span class="token punctuation">.</span><span class="token function">toVector4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       
    <span class="token comment">// TODO : Find out the bounding box of current triangle.</span>
    <span class="token keyword">int</span> bounding_box_left_x <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bounding_box_right_x <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bounding_box_bottom_y <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">min</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> bounding_box_top_y <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> x <span class="token operator">=</span> bounding_box_left_x<span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> bounding_box_right_x<span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> y <span class="token operator">=</span> bounding_box_bottom_y<span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> bounding_box_top_y<span class="token punctuation">;</span> y<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">insideTriangle</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// If so, use the following code to get the interpolated z value.   </span>
                <span class="token keyword">auto</span><span class="token punctuation">[</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computeBarycentric2D</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">float</span> Z <span class="token operator">=</span> <span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>alpha <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beta <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gamma <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 计算正确的深度值</span>
                <span class="token keyword">float</span> zp <span class="token operator">=</span> alpha <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beta <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gamma <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                zp <span class="token operator">*=</span> Z<span class="token punctuation">;</span> <span class="token comment">//zp是正确的深度值</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>zp <span class="token operator">&lt;</span>  depth_buf<span class="token punctuation">[</span><span class="token function">get_index</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    depth_buf<span class="token punctuation">[</span><span class="token function">get_index</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> zp<span class="token punctuation">;</span>
                    
                    <span class="token comment">//auto interpolated_color</span>
                    <span class="token keyword">auto</span> interpolated_color <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> t<span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">auto</span> interpolated_normal <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> t<span class="token punctuation">.</span>normal<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>normal<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>normal<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">auto</span> interpolated_texcoords <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> t<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">auto</span> interpolated_shadingcoords <span class="token operator">=</span> <span class="token function">interpolate</span><span class="token punctuation">(</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">,</span> view_pos<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view_pos<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> view_pos<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    fragment_shader_payload <span class="token function">payload</span><span class="token punctuation">(</span> interpolated_color<span class="token punctuation">,</span> interpolated_normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> interpolated_texcoords<span class="token punctuation">,</span> texture <span class="token operator">?</span> <span class="token operator">&amp;</span><span class="token operator">*</span>texture <span class="token operator">:</span> <span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    payload<span class="token punctuation">.</span>view_pos <span class="token operator">=</span> interpolated_shadingcoords<span class="token punctuation">;</span>
                    <span class="token keyword">auto</span> pixel_color <span class="token operator">=</span> <span class="token function">fragment_shader</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">set_pixel</span><span class="token punctuation">(</span><span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector2i</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>  pixel_color<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span> 
</code></pre> 
<p>这里使用<code>toVector4</code>函数将t的w值全部变为了1，这里本来需要存储深度值的，但是这几行代码还是把z的值求出来了（范围在0.1到50）：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">auto</span><span class="token punctuation">[</span>alpha<span class="token punctuation">,</span> beta<span class="token punctuation">,</span> gamma<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">computeBarycentric2D</span><span class="token punctuation">(</span>x <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> y <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">,</span> t<span class="token punctuation">.</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> Z <span class="token operator">=</span><span class="token number">1.0</span><span class="token operator">/</span><span class="token punctuation">(</span>alpha <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beta <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gamma <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 计算正确的深度值</span>
<span class="token keyword">float</span> zp <span class="token operator">=</span> alpha <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> beta <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> gamma <span class="token operator">*</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">/</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">w</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
zp <span class="token operator">*=</span> Z<span class="token punctuation">;</span> <span class="token comment">//zp是正确的深度值</span>
</code></pre> 
<p>首先这里使用了<code>computeBarycentric2D</code>进行插值，这里使用了二维点来插值得到了在view平面上的alpha,beta和gamma，这里使用了平面的重心坐标公式，这里直接给出可以和上面的代码比较（具体可以到<code>computeBarycentric2D</code>这个函数下面查看）：</p> 
<p><img src="https://images2.imgbox.com/97/9d/iqB1NgUK_o.png" alt="在这里插入图片描述"></p> 
<p>具体可以查看这几篇文章：</p> 
<p><a href="https://blog.csdn.net/qq_38065509/article/details/105446756?spm=1001.2014.3001.5502">计算机图形学三(补充)：重心坐标(barycentric coordinates)详解及其作用</a><br> <a href="https://www.cs.ucr.edu/~craigs/courses/2018-fall-cs-130/lectures/perspective-correct-interpolation.pdf" rel="nofollow">Perspective Correct Interpolation</a></p> 
<p>但是这肯定是有误差的，我们希望的还是在真实的三维空间找到它的深度，这时候就需要用到透视校正插值了，这里给出透视校正插值的公式，具体可以看这篇文章的推导了解透视校正插值：<a href="https://blog.csdn.net/Motarookie/article/details/124284471?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-1-124284471-blog-105878504.235%5Ev39%5Epc_relevant_anti_vip&amp;spm=1001.2101.3001.4242.1&amp;utm_relevant_index=4">【重心坐标插值、透视矫正插值】原理以及用法见解(GAMES101深度测试部分讨论)</a></p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           Z 
          
         
           t 
          
         
        
          = 
         
         
         
           1 
          
          
           
           
             α 
            
            
            
              Z 
             
            
              A 
             
            
           
          
            + 
           
           
           
             β 
            
            
            
              Z 
             
            
              B 
             
            
           
          
            + 
           
           
           
             γ 
            
            
            
              Z 
             
            
              C 
             
            
           
          
         
        
          = 
         
        
          1 
         
        
       
         Z_t=\frac{1}{\frac{\alpha}{Z_A}+\frac{\beta}{Z_B}+\frac{\gamma}{Z_C}}=1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.589em; vertical-align: -1.2675em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.1778em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.6954em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.3567em; margin-left: -0.0715em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1433em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.394em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0037em;">α</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4453em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9322em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.3567em; margin-left: -0.0715em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0502em;">B</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1433em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0528em;">β</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4453em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7475em;"><span class="" style="top: -2.655em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3448em;"><span class="" style="top: -2.3567em; margin-left: -0.0715em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0715em;">C</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1433em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0556em;">γ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4453em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.2675em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span></span></p> 
<p>由于使用的三角形在<code>toVector4</code>函数的作用下三个顶点的深度都变为1，所以这里等价于：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           Z 
          
         
           t 
          
         
        
          = 
         
         
         
           1 
          
          
          
            α 
           
          
            + 
           
          
            β 
           
          
            + 
           
          
            γ 
           
          
         
        
          = 
         
        
          1 
         
        
       
         Z_t=\frac{1}{\alpha+\beta+\gamma}=1 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.8333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0715em;">Z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.2806em;"><span class="" style="top: -2.55em; margin-left: -0.0715em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 2.2019em; vertical-align: -0.8804em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.3214em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0528em;">β</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.0556em;">γ</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8804em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.6444em;"></span><span class="mord">1</span></span></span></span></span></span></p> 
<p>然后计算真实的深度（后面两行的代码）</p> 
<p><img src="https://images2.imgbox.com/0b/d3/CpK2heKJ_o.png" alt="在这里插入图片描述"><br> <span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          z 
         
        
          p 
         
        
          = 
         
        
          ( 
         
        
          α 
         
         
          
          
            z 
           
          
            0 
           
          
         
           1 
          
         
        
          + 
         
        
          β 
         
         
          
          
            z 
           
          
            1 
           
          
         
           1 
          
         
        
          + 
         
        
          γ 
         
         
          
          
            z 
           
          
            2 
           
          
         
           1 
          
         
        
          ) 
         
        
          = 
         
        
          α 
         
         
         
           z 
          
         
           0 
          
         
        
          + 
         
        
          β 
         
         
         
           z 
          
         
           1 
          
         
        
          + 
         
        
          γ 
         
         
         
           z 
          
         
           2 
          
         
        
       
         zp = (\alpha \frac{z_0}{1}+\beta \frac{z_1}{1} + \gamma\frac{z_2}{1})=\alpha z_0 + \beta z_1 + \gamma z_2 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.7936em; vertical-align: -0.686em;"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.7936em; vertical-align: -0.686em;"></span><span class="mord mathnormal" style="margin-right: 0.0528em;">β</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 1.7936em; vertical-align: -0.686em;"></span><span class="mord mathnormal" style="margin-right: 0.0556em;">γ</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">1</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 0.7333em; vertical-align: -0.15em;"></span><span class="mord mathnormal" style="margin-right: 0.0037em;">α</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.8889em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0528em;">β</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span></span><span class="base"><span class="strut" style="height: 0.625em; vertical-align: -0.1944em;"></span><span class="mord mathnormal" style="margin-right: 0.0556em;">γ</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.3011em;"><span class="" style="top: -2.55em; margin-left: -0.044em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>依然计算出了0.1到50 的深度（但我觉得这个深度不是真正的深度，真正的深度应该和摄像机的位置有关？不过下面的计算不影响，我们只是用这个“深度”判断是否更靠近相机）。</p> 
<p>关于透视校正插值可以看这篇文章：</p> 
<p><a href="https://blog.csdn.net/qq_38065509/article/details/105878504?spm=1001.2014.3001.5502">计算机图形学六：正确使用重心坐标插值(透视矫正插值(Perspective-Correct Interpolation))和图形渲染管线总结</a></p> 
<p>注意这一句：</p> 
<pre><code class="prism language-cpp"><span class="token function">set_pixel</span><span class="token punctuation">(</span><span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector2i</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span><span class="token punctuation">,</span>  pixel_color<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>和之前的渲染三角形不一样，参数列表的第一个参数是<code>Eigen::Vector2i</code>类型的，我复制作业2的代码提示数组的维度不一样报错了，原来的是<code>Eigen::Vector3f</code>的类型。</p> 
<p>另外和作业2一样，<code>insideTriangle</code>函数的参数列表里的x和y我们还是使用了float类型，因为我们在<code>rasterize_triangle(const Triangle&amp; t)</code>中使用了x+0.5和y+0.5作为这个函数的第一和第二个参数（像素的中心）。</p> 
<pre><code class="prism language-cpp"><span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">insideTriangle</span><span class="token punctuation">(</span><span class="token keyword">float</span> x<span class="token punctuation">,</span> <span class="token keyword">float</span> y<span class="token punctuation">,</span> <span class="token keyword">const</span> Vector4f<span class="token operator">*</span> _v<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span><span class="token comment">// 这里还是一样进行了参数列表的修改</span>
    Vector3f v<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">3</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
        v<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>_v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>_v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Vector3f f0<span class="token punctuation">,</span>f1<span class="token punctuation">,</span>f2<span class="token punctuation">;</span>
    f0 <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    f1 <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    f2 <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Vector3f <span class="token function">p</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span>y<span class="token punctuation">,</span><span class="token number">1.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>f0<span class="token punctuation">)</span><span class="token operator">*</span>f0<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>f1<span class="token punctuation">)</span><span class="token operator">*</span>f1<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>f2<span class="token punctuation">)</span><span class="token operator">*</span>f2<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="get_projection_matrix_287"></a>get_projection_matrix()的实现</h3> 
<p>首先在main.cpp插入我们之前写的投影矩阵的代码，直接复制以前的就好：</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Matrix4f <span class="token function">get_projection_matrix</span><span class="token punctuation">(</span><span class="token keyword">float</span> eye_fov<span class="token punctuation">,</span> <span class="token keyword">float</span> aspect_ratio<span class="token punctuation">,</span> <span class="token keyword">float</span> zNear<span class="token punctuation">,</span> <span class="token keyword">float</span> zFar<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO: Use the same projection matrix from the previous assignments</span>
    Eigen<span class="token double-colon punctuation">::</span>Matrix4f projection <span class="token operator">=</span> Eigen<span class="token double-colon punctuation">::</span><span class="token class-name">Matrix4f</span><span class="token double-colon punctuation">::</span><span class="token function">Identity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> t <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>zNear<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">tan</span><span class="token punctuation">(</span>eye_fov <span class="token operator">*</span> MY_PI <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">180</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> r <span class="token operator">=</span> aspect_ratio <span class="token operator">*</span> t<span class="token punctuation">;</span>
    <span class="token keyword">float</span> l <span class="token operator">=</span> <span class="token operator">-</span>r<span class="token punctuation">;</span>
    <span class="token keyword">float</span> b <span class="token operator">=</span> <span class="token operator">-</span>t<span class="token punctuation">;</span>
    <span class="token keyword">float</span> n <span class="token operator">=</span> <span class="token operator">-</span>zNear<span class="token punctuation">;</span>
    <span class="token keyword">float</span> f <span class="token operator">=</span> <span class="token operator">-</span>zFar<span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> n <span class="token operator">/</span> <span class="token punctuation">(</span>r <span class="token operator">-</span> l<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>l <span class="token operator">-</span> r<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> n <span class="token operator">/</span> <span class="token punctuation">(</span>t <span class="token operator">-</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>b <span class="token operator">+</span> t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>b <span class="token operator">-</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>f <span class="token operator">+</span> n<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>n <span class="token operator">-</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> f <span class="token operator">*</span> n <span class="token operator">/</span> <span class="token punctuation">(</span>f <span class="token operator">-</span> n<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1.0</span><span class="token punctuation">;</span>
    <span class="token function">projection</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.0</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> projection<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>为了不让我们的图形覆盖的顺序颠倒，我们需要修改<code>rasterizer.cpp</code>中的<code>void rst::rasterizer::draw(std::vector&lt;Triangle *&gt; &amp;TriangleList)</code></p> 
<p>找到这一行：</p> 
<pre><code class="prism language-c">vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> f1 <span class="token operator">+</span> f2<span class="token punctuation">;</span>
</code></pre> 
<p>右边的<code>vert.z()</code>前面添加一个负号</p> 
<pre><code class="prism language-c">vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">-</span>vert<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> f1 <span class="token operator">+</span> f2<span class="token punctuation">;</span>
</code></pre> 
<p>否则可能会出现和之前一样的牛牛的屁屁对着我们的情况（三角形的覆盖是顺序有问题，这里是左右手系对应的问题，因为我的投影矩阵使用的还是右手系也就是闫老师说的那个矩阵，但是框架代码使用的是左手系，需要颠倒一下）。</p> 
<p>我们编译，在命令行输入命令</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token operator">/</span>Rasterizer output<span class="token punctuation">.</span>png normal
</code></pre> 
<p>可以得到：<br> <img src="https://images2.imgbox.com/71/03/O8MEwMhu_o.png" alt="在这里插入图片描述"><br> 我们看下纹理映射实现的源码：</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">normal_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f return_color <span class="token operator">=</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>normal<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">head</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token number">3</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2.f</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f result<span class="token punctuation">;</span>
    result <span class="token operator">&lt;&lt;</span> return_color<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">,</span> return_color<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">,</span> return_color<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">255</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>因为发现的方向的三个分量的范围是[-1,1]，我们加上1就变为[0,2]，再除以2就归一化为[0,1]，也就变成了RGB三个颜色分量的范围。</p> 
<h3><a id="phong_fragment_shader_357"></a>phong_fragment_shader()的实现</h3> 
<p>使用Phong Shading，详细可以参考<a href="https://blog.csdn.net/qq_38065509/article/details/105691559?spm=1001.2014.3001.5501">计算机图形学五：局部光照模型(Blinn-Phong 反射模型)与着色方法(Phong Shading)</a>，公式如下：<br> <img src="https://images2.imgbox.com/ef/0d/ZZfwGNOy_o.png" alt="在这里插入图片描述"></p> 
<p>这里根据公式写代码即可：</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">phong_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">&gt;</span> lights <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">{<!-- --></span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> lights<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f r <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> point<span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f l <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f v <span class="token operator">=</span> <span class="token punctuation">(</span>eye_pos <span class="token operator">-</span> point<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f h <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f ambient <span class="token operator">=</span> ka<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>amb_light_intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f diffuse <span class="token operator">=</span> kd<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f specular <span class="token operator">=</span> ks<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>
        result_color <span class="token operator">=</span> result_color <span class="token operator">+</span> ambient <span class="token operator">+</span> diffuse <span class="token operator">+</span> specular<span class="token punctuation">;</span>  
    <span class="token punctuation">}</span>
 
    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre> 
<p>我们编译，在命令行输入命令</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token operator">/</span>Rasterizer output<span class="token punctuation">.</span>png phong
</code></pre> 
<p><img src="https://images2.imgbox.com/e2/76/e77HvI7j_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="texture_fragment_shader_411"></a>texture_fragment_shader()的实现</h3> 
<p>纹理shader的实现其实就是用u,v去纹理图去找对应的颜色，我们需要知道该点像素的u和v，需要使用重心公式，其实现方式为：</p> 
<p><img src="https://images2.imgbox.com/7c/0d/79YKIT8U_o.png" alt="在这里插入图片描述"><br> 详细原理可以看：<a href="https://blog.csdn.net/qq_38065509/article/details/105929046?spm=1001.2014.3001.5502">计算机图形学七：纹理映射(Texture Mapping)及Mipmap技术</a></p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">texture_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f return_color <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: Get the texture value at the texture coordinates of the current fragment</span>
        <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        return_color <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f texture_color<span class="token punctuation">;</span>
    texture_color <span class="token operator">&lt;&lt;</span> return_color<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> return_color<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> return_color<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> texture_color <span class="token operator">/</span> <span class="token number">255.f</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">&gt;</span> lights <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">{<!-- --></span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> texture_color<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> lights<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>
        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>
               <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f r <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> point<span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f l <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f v <span class="token operator">=</span> <span class="token punctuation">(</span>eye_pos <span class="token operator">-</span> point<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f h <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f ambient <span class="token operator">=</span> ka<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>amb_light_intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f diffuse <span class="token operator">=</span> kd<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f specular <span class="token operator">=</span> ks<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0.0</span><span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>
        
        result_color <span class="token operator">=</span> result_color <span class="token operator">+</span> ambient <span class="token operator">+</span> diffuse <span class="token operator">+</span> specular<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>和Phong Shading差不多，只不过这里我们使用的颜色要从纹理获得（实现的原理也很简单，通过u和v进行颜色的映射），而不是想Phong Shading里使用的是模型自己的颜色，关键代码在这里：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO: Get the texture value at the texture coordinates of the current fragment</span>
    <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    return_color <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里的<code>tex_coords</code>是通过<code>rasterize_triangle()</code>函数而来（回想我们在这个函数进行了纹理、法线、纹理坐标、颜色的插值得到像素点的最终渲染的属性，最后生成一个payload作为参数给渲染器帮我们着色，<code>tex_coords</code>在这个函数里是<code>interpolated_texcoords</code>，它是通过三角形的三个顶点的纹理坐标得来的，而三角形的三个纹理坐标我们是在main函数通过<code>setTexCoord</code>函数实现的）。</p> 
<p>我们可以查看getColor源码的实现，注意这里为了防止数组的越界，我们需要给u和v设定范围限制（对应前面的四句if代码）。</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">getColor</span><span class="token punctuation">(</span><span class="token keyword">float</span> u<span class="token punctuation">,</span> <span class="token keyword">float</span> v<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>

    <span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> u<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> v<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> u<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> v<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> u_img <span class="token operator">=</span> u <span class="token operator">*</span> width<span class="token punctuation">;</span>
    <span class="token keyword">auto</span> v_img <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> v<span class="token punctuation">)</span> <span class="token operator">*</span> height<span class="token punctuation">;</span>

    <span class="token keyword">auto</span> color <span class="token operator">=</span> image_data<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>v_img<span class="token punctuation">,</span> u_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们编译，在命令行输入命令</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token operator">/</span>Rasterizer output<span class="token punctuation">.</span>png texture
</code></pre> 
<p><img src="https://images2.imgbox.com/4e/d7/4pJqI1v3_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="bump_fragment_shader_514"></a>bump_fragment_shader()的实现</h3> 
<p>bump mapping的思想是在像素的表面进行微小的高度变化（使用纹理）计算扰动点的法向量（只在渲染计算的时候做，实际并没有改变像素的高度）</p> 
<p><img src="https://images2.imgbox.com/11/e2/rSGnGmOa_o.png" alt="在这里插入图片描述"></p> 
<p>二维的实现</p> 
<p><img src="https://images2.imgbox.com/9f/12/pq4mCcHq_o.png" alt="在这里插入图片描述"></p> 
<p>这里如图像素对应的切向量的是(1,dp)，所以法向量就是(-dp,1).。</p> 
<p>三维的实现也是同样的，沿u方向和v方向的的切向量分别是(1,0,dp/du)和(0,1,dp/dv)（u和v是纹理坐标的方向，对应的是x轴和y轴，u和v方向垂直）。所以法向量要和这两个切向量垂直为(-dp/du,-dp/dv,1)，读者可以检验一下法向量和这两个切向量的垂直性。<br> <img src="https://images2.imgbox.com/d4/85/TtBUowyN_o.png" alt="在这里插入图片描述"></p> 
<p>根据注释写代码：这里使用的TBN矢量中，N是法线方向(normal)，代码里取的是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
       
         x 
        
       
         , 
        
       
         y 
        
       
         , 
        
       
         z 
        
       
         ) 
        
       
      
        (x,y,z) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="mclose">)</span></span></span></span></span>，B和T分别在切线空间里，注释提示我们T这里取的是<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         ( 
        
        
         
         
           x 
          
         
           y 
          
         
         
          
          
            ( 
           
          
          
          
            x 
           
          
            2 
           
          
         
           + 
          
          
          
            z 
           
          
            2 
           
          
         
           ) 
          
         
        
       
         , 
        
        
         
          
          
            x 
           
          
            2 
           
          
         
           + 
          
          
          
            z 
           
          
            2 
           
          
         
        
       
         , 
        
        
         
         
           z 
          
         
           y 
          
         
         
          
           
           
             x 
            
           
             2 
            
           
          
            + 
           
           
           
             z 
            
           
             2 
            
           
          
         
        
       
         ) 
        
       
      
        (\frac{xy}{\sqrt(x^2+z^2)},\sqrt{x^2+z^2},\frac{zy}{\sqrt{x^2+z^2}}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1.743em; vertical-align: -0.8296em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7475em;"><span class="" style="top: -2.4642em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0369em;"><span class="svg-align" style="top: -3.4286em;"><span class="pstrut" style="height: 3.4286em;"></span><span class="mopen mtight" style="padding-left: 1.19em;">(</span></span><span class="" style="top: -3.0089em;"><span class="pstrut" style="height: 3.4286em;"></span><span class="hide-tail mtight" style="min-width: 0.853em; height: 1.5429em;"> 
                   <svg width="400em" height="1.5429em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4197em;"><span class=""></span></span></span></span></span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8296em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9134em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8734em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
           <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
            <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1266em;"><span class=""></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7475em;"><span class="" style="top: -2.5445em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9221em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mtight" style="padding-left: 0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8821em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail mtight" style="min-width: 0.853em; height: 1.08em;"> 
                   <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1179em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">zy</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.538em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span>，尽管这个T的模是1，我们可以很容易地检验这是一个单位向量：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
           
          
          
           
            
             
             
              
              
                ( 
               
               
                
                
                  x 
                 
                
                  y 
                 
                
                
                 
                  
                  
                    x 
                   
                  
                    2 
                   
                  
                 
                   + 
                  
                  
                  
                    z 
                   
                  
                    2 
                   
                  
                 
                
               
              
                ) 
               
              
             
               2 
              
             
            
              + 
             
             
              
              
                ( 
               
               
                
                 
                 
                   x 
                  
                 
                   2 
                  
                 
                
                  + 
                 
                 
                 
                   z 
                  
                 
                   2 
                  
                 
                
               
              
                ) 
               
              
             
               2 
              
             
            
              + 
             
            
              ( 
             
             
              
              
                z 
               
              
                y 
               
              
              
               
                
                
                  x 
                 
                
                  2 
                 
                
               
                 + 
                
                
                
                  z 
                 
                
                  2 
                 
                
               
              
             
             
             
               ) 
              
             
               2 
              
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
             
              
               
               
                 x 
                
               
                 2 
                
               
               
               
                 y 
                
               
                 2 
                
               
              
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
            
              + 
             
             
             
               x 
              
             
               2 
              
             
            
              + 
             
             
             
               z 
              
             
               2 
              
             
            
              + 
             
             
              
               
               
                 z 
                
               
                 2 
                
               
               
               
                 y 
                
               
                 2 
                
               
              
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
             
              
               
               
                 x 
                
               
                 2 
                
               
               
               
                 y 
                
               
                 2 
                
               
              
                + 
               
               
               
                 x 
                
               
                 4 
                
               
              
                + 
               
              
                2 
               
               
               
                 x 
                
               
                 2 
                
               
               
               
                 z 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 4 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
               
               
                 y 
                
               
                 2 
                
               
              
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
             
              
               
               
                 x 
                
               
                 2 
                
               
               
               
                 y 
                
               
                 2 
                
               
              
                + 
               
               
               
                 x 
                
               
                 4 
                
               
              
                + 
               
               
               
                 x 
                
               
                 2 
                
               
               
               
                 z 
                
               
                 2 
                
               
              
                + 
               
               
               
                 x 
                
               
                 2 
                
               
               
               
                 z 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 4 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
               
               
                 y 
                
               
                 2 
                
               
              
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
             
              
               
               
                 x 
                
               
                 2 
                
               
              
                ( 
               
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 y 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
                ) 
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
                ( 
               
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 y 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
                ) 
               
              
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
             
            
              ( 
             
             
             
               x 
              
             
               2 
              
             
            
              + 
             
             
             
               y 
              
             
               2 
              
             
            
              + 
             
             
             
               z 
              
             
               2 
              
             
            
              = 
             
            
              1 
             
            
              ) 
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
             
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
            
              = 
             
            
              1 
             
            
           
          
         
        
       
         \begin{aligned} &amp;\left(\frac{xy}{\sqrt{x^2+z^2}}\right)^2+\left(\sqrt{x^2+z^2}\right)^2+(\frac{zy}{\sqrt{x^2+z^2}})^2\\ =&amp;\frac{x^2y^2}{x^2+z^2}+x^2+z^2+\frac{z^2y^2}{x^2+z^2}\\ =&amp;\frac{x^2y^2+x^4+2x^2z^2+z^4+z^2y^2}{x^2+z^2}\\ =&amp;\frac{x^2y^2+x^4+x^2z^2+x^2z^2+z^4+z^2y^2}{x^2+z^2}\\ =&amp;\frac{x^2(x^2+y^2+z^2)+z^2(x^2+y^2+z^2)}{x^2+z^2}\quad(x^2+y^2+z^2=1)\\ =&amp;\frac{x^2+z^2}{x^2+z^2}=1\end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 15.7062em; vertical-align: -7.6031em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 8.1031em;"><span class="" style="top: -10.1031em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"></span></span><span class="" style="top: -7.362em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mrel">=</span></span></span><span class="" style="top: -4.8015em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mrel">=</span></span></span><span class="" style="top: -2.2411em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mrel">=</span></span></span><span class="" style="top: 0.3193em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mrel">=</span></span></span><span class="" style="top: 2.8798em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.6031em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 8.1031em;"><span class="" style="top: -10.1031em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size3">(</span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.1966em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9134em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8734em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
                             <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                              <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                             </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1266em;"><span class=""></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.93em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size3">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.654em;"><span class="" style="top: -3.9029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top: 0em;"><span class="delimsizing size2">(</span></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0623em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.0223em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
                      <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                       <path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path> 
                      </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1777em;"><span class=""></span></span></span></span></span><span class="mclose delimcenter" style="top: 0em;"><span class="delimsizing size2">)</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 1.354em;"><span class="" style="top: -3.6029em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.1966em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9134em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8734em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
                           <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                            <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1266em;"><span class=""></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">zy</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.93em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -7.362em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -4.8015em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: -2.2411em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">4</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span class="" style="top: 0.3193em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 1em;"></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8641em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">1</span><span class="mclose">)</span></span></span><span class="" style="top: 2.8798em;"><span class="pstrut" style="height: 3.654em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.7693em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 7.6031em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>但是这里我认为是有问题的，但是它和N并不垂直。</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
          
           
            
           
          
          
           
            
             
            
              N 
             
            
              ⋅ 
             
            
              T 
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
            
              ( 
             
            
              x 
             
            
              , 
             
            
              y 
             
            
              , 
             
            
              z 
             
            
              ) 
             
            
              ⋅ 
             
            
              ( 
             
             
              
              
                x 
               
              
                y 
               
              
              
               
               
                 ( 
                
               
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
                ) 
               
              
             
            
              , 
             
             
              
               
               
                 x 
                
               
                 2 
                
               
              
                + 
               
               
               
                 z 
                
               
                 2 
                
               
              
             
            
              , 
             
             
              
              
                z 
               
              
                y 
               
              
              
               
                
                
                  x 
                 
                
                  2 
                 
                
               
                 + 
                
                
                
                  z 
                 
                
                  2 
                 
                
               
              
             
            
              ) 
             
            
           
          
         
         
          
           
           
             = 
            
           
          
          
           
            
             
             
              
              
                2 
               
               
               
                 x 
                
               
                 2 
                
               
              
                y 
               
              
                + 
               
              
                2 
               
               
               
                 z 
                
               
                 2 
                
               
              
                y 
               
              
              
               
                
                
                  x 
                 
                
                  2 
                 
                
               
                 + 
                
                
                
                  z 
                 
                
                  2 
                 
                
               
              
             
            
           
          
         
        
       
         \begin{aligned}&amp;N\cdot T\\ =&amp;(x,y,z)\cdot(\frac{xy}{\sqrt(x^2+z^2)},\sqrt{x^2+z^2},\frac{zy}{\sqrt{x^2+z^2}})\\ =&amp;\frac{2x^2y+2z^2y}{\sqrt{x^2+z^2}}\end{aligned} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 6.7587em; vertical-align: -3.1293em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.6293em;"><span class="" style="top: -6.2804em;"><span class="pstrut" style="height: 3.4911em;"></span><span class="mord"></span></span><span class="" style="top: -4.5129em;"><span class="pstrut" style="height: 3.4911em;"></span><span class="mord"><span class="mrel">=</span></span></span><span class="" style="top: -1.5918em;"><span class="pstrut" style="height: 3.4911em;"></span><span class="mord"><span class="mrel">=</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.1293em;"><span class=""></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 3.6293em;"><span class="" style="top: -6.2804em;"><span class="pstrut" style="height: 3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mord mathnormal" style="margin-right: 0.109em;">N</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span></span></span><span class="" style="top: -4.5129em;"><span class="pstrut" style="height: 3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mopen">(</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.175em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.935em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mopen" style="padding-left: 1em;">(</span></span><span class="" style="top: -2.895em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
                           <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                            <path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path> 
                           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.305em;"><span class=""></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 1.13em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0623em;"><span class="svg-align" style="top: -3.2em;"><span class="pstrut" style="height: 3.2em;"></span><span class="mord" style="padding-left: 1em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.0223em;"><span class="pstrut" style="height: 3.2em;"></span><span class="hide-tail" style="min-width: 1.02em; height: 1.28em;"> 
                    <svg width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"> 
                     <path d="M263,681c0.7,0,18,39.7,52,119
c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120
c340,-704.7,510.7,-1060.3,512,-1067
l0 -0
c4.7,-7.3,11,-11,19,-11
H40000v40H1012.3
s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232
c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1
s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26
c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z
M1001 80h400000v40h-400000z"></path> 
                    </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1777em;"><span class=""></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.1076em;"><span class="" style="top: -2.1966em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9134em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8734em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
                           <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                            <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1266em;"><span class=""></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.0359em;">zy</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.93em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span><span class="" style="top: -1.5918em;"><span class="pstrut" style="height: 3.4911em;"></span><span class="mord"><span class="mord"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.4911em;"><span class="" style="top: -2.1966em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9134em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8734em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
                           <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                            <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1266em;"><span class=""></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">2</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.8141em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right: 0.0359em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.93em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 3.1293em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>正确的应该是：<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         T 
        
       
         = 
        
       
         ( 
        
       
         − 
        
        
         
         
           x 
          
         
           y 
          
         
         
          
          
            ( 
           
          
          
          
            x 
           
          
            2 
           
          
         
           + 
          
          
          
            z 
           
          
            2 
           
          
         
           ) 
          
         
        
       
         , 
        
        
         
          
          
            x 
           
          
            2 
           
          
         
           + 
          
          
          
            z 
           
          
            2 
           
          
         
        
       
         , 
        
       
         − 
        
        
         
         
           z 
          
         
           y 
          
         
         
          
           
           
             x 
            
           
             2 
            
           
          
            + 
           
           
           
             z 
            
           
             2 
            
           
          
         
        
       
         ) 
        
       
      
        T=(-\frac{xy}{\sqrt(x^2+z^2)},\sqrt{x^2+z^2},-\frac{zy}{\sqrt{x^2+z^2}}) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6833em;"></span><span class="mord mathnormal" style="margin-right: 0.1389em;">T</span><span class="mspace" style="margin-right: 0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.2778em;"></span></span><span class="base"><span class="strut" style="height: 1.743em; vertical-align: -0.8296em;"></span><span class="mopen">(</span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7475em;"><span class="" style="top: -2.4642em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.0369em;"><span class="svg-align" style="top: -3.4286em;"><span class="pstrut" style="height: 3.4286em;"></span><span class="mopen mtight" style="padding-left: 1.19em;">(</span></span><span class="" style="top: -3.0089em;"><span class="pstrut" style="height: 3.4286em;"></span><span class="hide-tail mtight" style="min-width: 0.853em; height: 1.5429em;"> 
                   <svg width="400em" height="1.5429em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.4197em;"><span class=""></span></span></span></span></span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">y</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.8296em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9134em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord" style="padding-left: 0.833em;"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7401em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8734em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail" style="min-width: 0.853em; height: 1.08em;"> 
           <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
            <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
           </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1266em;"><span class=""></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.1667em;"></span><span class="mord">−</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.7475em;"><span class="" style="top: -2.5445em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord sqrt mtight"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.9221em;"><span class="svg-align" style="top: -3em;"><span class="pstrut" style="height: 3em;"></span><span class="mord mtight" style="padding-left: 0.833em;"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.044em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.7463em;"><span class="" style="top: -2.786em; margin-right: 0.0714em;"><span class="pstrut" style="height: 2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -2.8821em;"><span class="pstrut" style="height: 3em;"></span><span class="hide-tail mtight" style="min-width: 0.853em; height: 1.08em;"> 
                   <svg width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"> 
                    <path d="M95,702
c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14
c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54
c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10
s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429
c69,-144,104.5,-217.7,106.5,-221
l0 -0
c5.3,-9.3,12,-14,20,-14
H400000v40H845.2724
s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7
c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z
M834 80h400000v40h-400000z"></path> 
                   </svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.1179em;"><span class=""></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.4461em;"><span class="pstrut" style="height: 3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right: 0.0359em;">zy</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.538em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span></span></span></span></span>，这个博客画了这个T在三维坐标下的图（TBN三个矢量应该是相互垂直的！）,画得还是比较清楚的【图源<a href="https://blog.csdn.net/weixin_44491423/article/details/127290398">games101——作业3</a>】：<br> <img src="https://images2.imgbox.com/7b/97/BZkMyQuG_o.png" alt="在这里插入图片描述"></p> 
<p>而B向量就是T和N的叉乘的结果了</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">bump_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">&gt;</span> lights <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">{<!-- --></span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span> 
    Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>


    <span class="token keyword">float</span> kh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> kn <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>

    <span class="token comment">// TODO: Implement bump mapping here</span>
    <span class="token comment">// Let n = normal = (x, y, z)</span>
    <span class="token comment">// Vector t = (x*y/sqrt(x*x+z*z),sqrt(x*x+z*z),z*y/sqrt(x*x+z*z))</span>
    <span class="token comment">// Vector b = n cross product t</span>
    <span class="token comment">// Matrix TBN = [t b n]</span>
    <span class="token comment">// dU = kh * kn * (h(u+1/w,v)-h(u,v))</span>
    <span class="token comment">// dV = kh * kn * (h(u,v+1/h)-h(u,v))</span>
    <span class="token comment">// Vector ln = (-dU, -dV, 1)</span>
    <span class="token comment">// Normal n = normalize(TBN * ln)</span>
    <span class="token keyword">float</span> x <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">-</span>x<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span>z<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f b <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Matrix3f TBN<span class="token punctuation">;</span>
    TBN <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    t<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    t<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> w <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
    <span class="token keyword">float</span> h <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
    <span class="token keyword">float</span> dU <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u <span class="token operator">+</span> <span class="token number">1.0</span> <span class="token operator">/</span> w<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> dV <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v <span class="token operator">+</span> <span class="token number">1.0</span> <span class="token operator">/</span> h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Eigen<span class="token double-colon punctuation">::</span>Vector3f ln <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">-</span>dU<span class="token punctuation">,</span> <span class="token operator">-</span>dV<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
normal <span class="token operator">=</span> <span class="token punctuation">(</span>TBN <span class="token operator">*</span> ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    


    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    result_color <span class="token operator">=</span> normal<span class="token punctuation">;</span>

    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们用下面的代码得到全局的TBN矩阵（我们最终的法向量还是要在相机空间里表示的，这是一个全局的变换矩阵）：</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">-</span>x<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token operator">-</span>z<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
Eigen<span class="token double-colon punctuation">::</span>Vector3f b <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
Eigen<span class="token double-colon punctuation">::</span>Matrix3f TBN<span class="token punctuation">;</span>
TBN <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                t<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                t<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后我们需要计算再沿纹理图u和v方向的像素的变化量，计算导数用的是差分的方式再乘上一个系数：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">float</span> dU <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u <span class="token operator">+</span> <span class="token number">1.0</span> <span class="token operator">/</span> w<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> dV <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v <span class="token operator">+</span> <span class="token number">1.0</span> <span class="token operator">/</span> h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>注释提示这样求扰动后的法向量：</p> 
<pre><code class="prism language-c"><span class="token comment">// Vector ln = (-dU, -dV, 1)</span>
<span class="token comment">// Normal n = normalize(TBN * ln)</span>
</code></pre> 
<p>是先求扰动后的法向量（但没有归一化）再转换为相机空间的法向量，然后再归一化，而不是像ppt说的先对法向量归一化再转换到相机空间，猜测把归一化放到后面能减少一定的浮点误差，提前归一化要进行开平方根操作会造成变换到相机空间的误差。</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f ln <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">-</span>dU<span class="token punctuation">,</span> <span class="token operator">-</span>dV<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
normal <span class="token operator">=</span> <span class="token punctuation">(</span>TBN <span class="token operator">*</span> ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>我们编译，在命令行输入命令</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token operator">/</span>Rasterizer output<span class="token punctuation">.</span>png bump
</code></pre> 
<p><img src="https://images2.imgbox.com/d8/68/6R9MS7qX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="displacement_fragment_shader_661"></a>displacement_fragment_shader()的实现</h3> 
<p>位移贴图displacement mapping除了类似凹凸贴图，改变了法向量，而且实际移动了三维空间中点的位置，进而直接影响 Blinn-Phong 模型中的<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         l 
        
       
      
        l 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.6944em;"></span><span class="mord mathnormal" style="margin-right: 0.0197em;">l</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         v 
        
       
      
        v 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.4306em;"></span><span class="mord mathnormal" style="margin-right: 0.0359em;">v</span></span></span></span></span>。</p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">displacement_fragment_shader</span><span class="token punctuation">(</span><span class="token keyword">const</span> fragment_shader_payload<span class="token operator">&amp;</span> payload<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ka <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">,</span> <span class="token number">0.005</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f kd <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ks <span class="token operator">=</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span><span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">,</span> <span class="token number">0.7937</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">auto</span> l1 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">auto</span> l2 <span class="token operator">=</span> light<span class="token punctuation">{<!-- --></span><span class="token punctuation">{<!-- --></span><span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{<!-- --></span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>light<span class="token operator">&gt;</span> lights <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>l1<span class="token punctuation">,</span> l2<span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f amb_light_intensity<span class="token punctuation">{<!-- --></span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f eye_pos<span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">float</span> p <span class="token operator">=</span> <span class="token number">150</span><span class="token punctuation">;</span>

    Eigen<span class="token double-colon punctuation">::</span>Vector3f color <span class="token operator">=</span> payload<span class="token punctuation">.</span>color<span class="token punctuation">;</span> 
    Eigen<span class="token double-colon punctuation">::</span>Vector3f point <span class="token operator">=</span> payload<span class="token punctuation">.</span>view_pos<span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f normal <span class="token operator">=</span> payload<span class="token punctuation">.</span>normal<span class="token punctuation">;</span>

    <span class="token keyword">float</span> kh <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> kn <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">;</span>
    
    <span class="token comment">// TODO: Implement displacement mapping here</span>
    <span class="token comment">// Let n = normal = (x, y, z)</span>
    <span class="token comment">// Vector t = (x*y/sqrt(x*x+z*z),sqrt(x*x+z*z),z*y/sqrt(x*x+z*z))</span>
    <span class="token comment">// Vector b = n cross product t</span>
    <span class="token comment">// Matrix TBN = [t b n]</span>
    <span class="token comment">// dU = kh * kn * (h(u+1/w,v)-h(u,v))</span>
    <span class="token comment">// dV = kh * kn * (h(u,v+1/h)-h(u,v))</span>
    <span class="token comment">// Vector ln = (-dU, -dV, 1)</span>
    <span class="token comment">// Position p = p + kn * n * h(u,v)</span>
    <span class="token comment">// Normal n = normalize(TBN * ln)</span>
     <span class="token keyword">float</span> x <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> y <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> z <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f t <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>x<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">,</span>z<span class="token operator">*</span>y<span class="token operator">/</span><span class="token function">sqrt</span><span class="token punctuation">(</span>x<span class="token operator">*</span>x<span class="token operator">+</span>z<span class="token operator">*</span>z<span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f b <span class="token operator">=</span> normal<span class="token punctuation">.</span><span class="token function">cross</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Matrix3f TBN<span class="token punctuation">;</span>
    TBN <span class="token operator">&lt;&lt;</span> t<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    t<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    t<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> b<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">z</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">x</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">.</span><span class="token function">y</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> w <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span>width<span class="token punctuation">;</span>
    <span class="token keyword">float</span> h <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span>height<span class="token punctuation">;</span>
    <span class="token keyword">float</span> dU <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u <span class="token operator">+</span> <span class="token number">1.0</span><span class="token operator">/</span>w<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> dV <span class="token operator">=</span> kh <span class="token operator">*</span> kn <span class="token operator">*</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v <span class="token operator">+</span> <span class="token number">1.0</span> <span class="token operator">/</span> h<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span> <span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Eigen<span class="token double-colon punctuation">::</span>Vector3f ln <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token operator">-</span>dU<span class="token punctuation">,</span> <span class="token operator">-</span>dV<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    point <span class="token operator">=</span> point <span class="token operator">+</span> kn <span class="token operator">*</span> normal <span class="token operator">*</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    normal <span class="token operator">=</span> <span class="token punctuation">(</span>TBN <span class="token operator">*</span> ln<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    Eigen<span class="token double-colon punctuation">::</span>Vector3f result_color <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> light <span class="token operator">:</span> lights<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// TODO: For each light source in the code, calculate what the *ambient*, *diffuse*, and *specular* </span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f r <span class="token operator">=</span> light<span class="token punctuation">.</span>position <span class="token operator">-</span> point<span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f l <span class="token operator">=</span> r<span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f v <span class="token operator">=</span> <span class="token punctuation">(</span>eye_pos <span class="token operator">-</span> point<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f h <span class="token operator">=</span> <span class="token punctuation">(</span>l <span class="token operator">+</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">normalized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f ambient <span class="token operator">=</span> ka<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>amb_light_intensity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f diffuse <span class="token operator">=</span> kd<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> normal<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>l<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Eigen<span class="token double-colon punctuation">::</span>Vector3f specular <span class="token operator">=</span> ks<span class="token punctuation">.</span><span class="token function">cwiseProduct</span><span class="token punctuation">(</span>light<span class="token punctuation">.</span>intensity<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> std<span class="token double-colon punctuation">::</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">float</span><span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">pow</span><span class="token punctuation">(</span>normal<span class="token punctuation">.</span><span class="token function">dot</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// components are. Then, accumulate that result on the *result_color* object.</span>
        result_color <span class="token operator">=</span> result_color <span class="token operator">+</span> ambient <span class="token operator">+</span> diffuse <span class="token operator">+</span> specular<span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> result_color <span class="token operator">*</span> <span class="token number">255.f</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>和bump mapping最主要的区别在于：</p> 
<pre><code class="prism language-cpp">point <span class="token operator">=</span> point <span class="token operator">+</span> kn <span class="token operator">*</span> normal <span class="token operator">*</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColor</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">norm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>改变了顶点的坐标（沿着原来的发现的方向），顶点的坐标等于原顶点的坐标加法线向量乘系数kn乘纹理在该位置的颜色的模长，然后也是使用phong shading来渲染</p> 
<p>我们编译，输入命令：</p> 
<pre><code class="prism language-cpp"><span class="token punctuation">.</span><span class="token operator">/</span>Rasterizer output<span class="token punctuation">.</span>png displacement
</code></pre> 
<p><img src="https://images2.imgbox.com/53/8e/IFEtFsc4_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="obj_753"></a>尝试其他的obj模型</h3> 
<p>参考的<a href="https://zhuanlan.zhihu.com/p/460967740" rel="nofollow">Games101｜作业3 + shading + 双线性插值 + 疑惑</a></p> 
<p>需要安装meshlab，参考<a href="https://blog.csdn.net/qq_42257666/article/details/124806666">ubuntu安装meshlab，全网最简单的方法</a></p> 
<p>记得改路径</p> 
<p><img src="https://images2.imgbox.com/09/45/e5nmivw4_o.png" alt="从github上下载obj模型，导入meshlab，"></p> 
<p>记得该eye_pos！！！没有改可能会出现段错误，图形跑到700*700的框框外面去了，找不到对应的颜色。</p> 
<p>输出时应该是下面这样（输出为obj）</p> 
<p><img src="https://images2.imgbox.com/c2/7b/tfPmUZ9g_o.png" alt="在这里插入图片描述"><br> 然后文件夹下除了obj还有obj.mtl格式的文件，没有的话texture可能出问题（我这里保存的是teapot2.obj和teapot.obj.mtl）</p> 
<p><img src="https://images2.imgbox.com/c2/1d/y9JSid3V_o.png" alt="在这里插入图片描述"><br> 记得main函数修改路径：obj_path、loadout、texture_path。</p> 
<p>normal shader</p> 
<p><img src="https://images2.imgbox.com/82/d9/e7GeVp7W_o.png" alt="在这里插入图片描述"></p> 
<p>phong shader</p> 
<p><img src="https://images2.imgbox.com/af/86/UMRdc2Oc_o.png" alt="在这里插入图片描述"></p> 
<p>bump shader 有点过于粗糙的感觉</p> 
<p><img src="https://images2.imgbox.com/bc/ae/vXGPMpt0_o.png" alt="在这里插入图片描述"><br> texture shader<br> <img src="https://images2.imgbox.com/01/cd/qy3hwmTw_o.png" alt="在这里插入图片描述"></p> 
<p>displacement shader<br> <img src="https://images2.imgbox.com/62/32/vSijBCuf_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_793"></a>双线性插值</h3> 
<p>找个压缩图片的网站，我们把小奶牛的texture压缩为512*512的（原来是1024*1024的）保存下来，在把texture的路径改为这个512*512的。<br> <a href="https://oktools.net/tinyimg" rel="nofollow">OKTools-图片压缩</a></p> 
<p><img src="https://images2.imgbox.com/b6/70/yoKQo9hL_o.png" alt="在这里插入图片描述"><br> 找到四个顶点，先沿宽度方向插值，再沿高度方向插值。</p> 
<p><code>getColorBilinear</code></p> 
<pre><code class="prism language-cpp">Eigen<span class="token double-colon punctuation">::</span>Vector3f <span class="token function">getColorBilinear</span><span class="token punctuation">(</span><span class="token keyword">float</span> u<span class="token punctuation">,</span> <span class="token keyword">float</span> v<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> u<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span> v<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>u<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> u<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>v<span class="token operator">&gt;</span><span class="token number">1</span><span class="token punctuation">)</span> v<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

        <span class="token keyword">auto</span> u_img <span class="token operator">=</span> u <span class="token operator">*</span> width<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> v_img <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> v<span class="token punctuation">)</span> <span class="token operator">*</span> height<span class="token punctuation">;</span>
        <span class="token keyword">float</span> ul <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>u_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> uh <span class="token operator">=</span> <span class="token function">ceil</span><span class="token punctuation">(</span>u_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> vl <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>v_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> vh <span class="token operator">=</span> <span class="token function">ceil</span><span class="token punctuation">(</span>v_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> s <span class="token operator">=</span> <span class="token punctuation">(</span>u_img <span class="token operator">-</span> ul<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>uh <span class="token operator">-</span> ul<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">float</span> t <span class="token operator">=</span> <span class="token punctuation">(</span>v_img <span class="token operator">-</span> vl<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>vh <span class="token operator">-</span> vl<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 双线性插值</span>
        <span class="token keyword">auto</span> color_o <span class="token operator">=</span> image_data<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>v_img<span class="token punctuation">,</span> u_img<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> color_00 <span class="token operator">=</span> image_data<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>vl<span class="token punctuation">,</span> ul<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//color的序号按照u,v的顺序来，大值对应h，小值对应l</span>
        <span class="token keyword">auto</span> color_01 <span class="token operator">=</span> image_data<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>vh<span class="token punctuation">,</span> ul<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> color_10 <span class="token operator">=</span> image_data<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>vl<span class="token punctuation">,</span> uh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> color_11 <span class="token operator">=</span> image_data<span class="token punctuation">.</span><span class="token generic-function"><span class="token function">at</span><span class="token generic class-name"><span class="token operator">&lt;</span>cv<span class="token double-colon punctuation">::</span>Vec3b<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span>vh<span class="token punctuation">,</span> uh<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> color_lerp1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span> <span class="token operator">*</span> color_00 <span class="token operator">+</span> s <span class="token operator">*</span> color_10<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> color_lerp2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> s<span class="token punctuation">)</span> <span class="token operator">*</span> color_01 <span class="token operator">+</span> s <span class="token operator">*</span> color_11<span class="token punctuation">;</span>

        <span class="token keyword">auto</span> color <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> t<span class="token punctuation">)</span> <span class="token operator">*</span> color_lerp1 <span class="token operator">+</span> t <span class="token operator">*</span> color_lerp2 <span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Eigen</span><span class="token double-colon punctuation">::</span><span class="token function">Vector3f</span><span class="token punctuation">(</span>color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>记得把texture_fragment_shader获取颜色的方法改为双线性插值的方法<code>getColorBilinear</code>，主要是这一段代码：</p> 
<pre><code class="prism language-cpp"><span class="token keyword">if</span> <span class="token punctuation">(</span>payload<span class="token punctuation">.</span>texture<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// TODO: Get the texture value at the texture coordinates of the current fragment</span>
    <span class="token keyword">float</span> u <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> v <span class="token operator">=</span> payload<span class="token punctuation">.</span>tex_coords<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// return_color = payload.texture-&gt;getColor(u, v);</span>
    return_color <span class="token operator">=</span> payload<span class="token punctuation">.</span>texture<span class="token operator">-&gt;</span><span class="token function">getColorBilinear</span><span class="token punctuation">(</span>u<span class="token punctuation">,</span> v<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<p>测试：使用双线性插值：</p> 
<p><img src="https://images2.imgbox.com/63/6b/F0CLPX7o_o.png" alt="在这里插入图片描述"><br> 不使用双线性插值：</p> 
<p><img src="https://images2.imgbox.com/38/62/G7BRAVpV_o.png" alt="在这里插入图片描述"><br> 可以看到效果还是很明显的。</p> 
<p>另外关于作业3框架的一些问题可以参考这篇知乎的文章，写的很好：<a href="https://zhuanlan.zhihu.com/p/509902950" rel="nofollow">《GAMES101》作业框架问题详解</a>，尽管作业里的深度插值用的不是真实的深度，但是我们还是得到了正确的效果（题目也说了，深度处理为了正值，离相机越近深度是越小的，深度相当于做了一个线性的映射到0.1到50，不过深度的大小情况是不变的，该靠近相机的还是靠近相机，所以我们最后还是可以看到这只牛牛）。</p> 
<p>其他记录：</p> 
<p>+<a href="https://games-cn.org/forums/topic/%e4%bd%9c%e4%b8%9a3%e6%9b%b4%e6%ad%a3%e5%85%ac%e5%91%8a/" rel="nofollow">讨论区 › 作业3更正公告</a></p> 
<p><img src="https://images2.imgbox.com/a8/67/5uMIEBQJ_o.png" alt="在这里插入图片描述"></p> 
<ul><li><a href="https://games-cn.org/forums/topic/lecture-9%e4%b8%ba%e4%bb%80%e4%b9%88%e7%a6%bb%e8%a7%86%e8%a7%92%e8%bf%91%e7%9a%84%e5%83%8f%e7%b4%a0%e7%82%b9%ef%bc%8c%e5%af%b9%e5%ba%94%e7%9a%84%e7%ba%b9%e7%90%86%e5%8c%ba%e5%9f%9f%e8%b6%8a%e5%b0%8f/" rel="nofollow">讨论区 › [Lecture 9]为什么离视角近的像素点，对应的纹理区域越小？</a></li></ul> 
<p><img src="https://images2.imgbox.com/7a/86/zchaNmaF_o.png" alt="在这里插入图片描述"></p> 
<ul><li><a href="https://games-cn.org/forums/topic/%e5%85%b3%e4%ba%8e%e5%87%a0%e4%b8%aa%e6%80%9d%e8%b7%af%e9%97%ae%e9%a2%98%e5%ad%a6%e4%b9%a0%e4%b9%a0%e6%83%af%e4%b8%8e%e5%ad%a6%e4%b9%a0%e6%96%b9%e6%b3%95/" rel="nofollow">讨论区 › 关于几个思路问题(学习习惯与学习方法)</a></li></ul> 
<p><img src="https://images2.imgbox.com/2e/86/gbQYpL5S_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/99/b3/LvDs9894_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/93/dc/Ac8bVDrI_o.png" alt="在这里插入图片描述"></p> 
<ul><li><a href="https://games-cn.org/forums/topic/displacement-%e5%8e%9f%e7%90%86%e9%97%ae%e9%a2%98/" rel="nofollow">displacement 原理问题</a></li></ul> 
<p><img src="https://images2.imgbox.com/2f/cd/1B0wUg76_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5f/e4/9Kn8sJTB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cc/c1/gEjCpBaz_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9741ca4d68d82d417407e987ab99a17a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Hi5 2.0 虚拟手与追踪器（Tracker）的位置修正</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f1c4c75a8ec58af9a1b8cf6bc7d8bd3f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">docker小白第十一天</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>