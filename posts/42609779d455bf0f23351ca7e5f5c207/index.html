<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>修改android默认锁屏方式 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="修改android默认锁屏方式" />
<meta property="og:description" content="代码为公司的定制版基于android5.1，没有具体比较锁屏部分应该和原生代码有所不同。本文基于浏览代码结果，没有手机版本和代码版本不一致（APP上还是一脉相承）所以没有在手机上直接试验。
首先在自己手机的版本上显示的默认锁屏方式在“设置”-&gt;“安全”-&gt;“屏幕锁定方式”其值为“滑动”，
首先寻找“滑动”字符串packages/apps/Settings/res/values-zh-rCN/strings.xml
&lt;string name=&#34;unlock_set_unlock_none_title&#34; msgid=&#34;5679243878975864640&#34;&gt;&#34;滑动&#34;&lt;/string&gt;
被引用：
packages/apps/Settings/res/xml/security_settings_picker.xml
被引用：
packages/apps/Settings/src/com/android/settings/ChooseLockGeneric.java
没有其他发现，转而向寻找“安全”
&lt;string name=&#34;security_settings_title&#34; msgid=&#34;7945465324818485460&#34;&gt;&#34;安全&#34;&lt;/string&gt;
安全选项界面
&lt;activity android:name=&#34;Settings$SecuritySettingsActivity&#34;
android:label=&#34;@string/security_settings_title&#34;
android:configChanges=&#34;orientation|keyboardHidden|screenSize&#34;
android:taskAffinity=&#34;&#34;
android:parentActivityName=&#34;Settings&#34;&gt;
&lt;intent-filter&gt;
&lt;action android:name=&#34;android.intent.action.MAIN&#34; /&gt;
&lt;action android:name=&#34;android.settings.SECURITY_SETTINGS&#34; /&gt;
&lt;action android:name=&#34;android.credentials.UNLOCK&#34; /&gt;
&lt;category android:name=&#34;android.intent.category.DEFAULT&#34; /&gt;
&lt;category android:name=&#34;android.intent.category.VOICE_LAUNCH&#34; /&gt;
&lt;/intent-filter&gt;
&lt;meta-data android:name=&#34;com.android.settings.FRAGMENT_CLASS&#34;
android:value=&#34;com.android.settings.SecuritySettings&#34; /&gt;
&lt;meta-data android:name=&#34;com.android.settings.TOP_LEVEL_HEADER_ID&#34;
android:resource=&#34;@id/security_settings&#34; /&gt;
&lt;meta-data android:name=&#34;com.android.settings.PRIMARY_PROFILE_CONTROLLED&#34;
android:value=&#34;true&#34; /&gt;
&lt;/activity&gt;
别名设置：
&lt;activity-alias android:name=&#34;SecuritySettings&#34;
android:label=&#34;@string/security_settings_title&#34;
android:configChanges=&#34;orientation|keyboardHidden|screenSize&#34;
android:exported=&#34;true&#34;
android:targetActivity=&#34;Settings$SecuritySettingsActivity&#34;&gt;
&lt;meta-data android:name=&#34;com.android.settings.FRAGMENT_CLASS&#34;
android:value=&#34;com.android.settings.SecuritySettings&#34; /&gt;
&lt;meta-data android:name=&#34;com.android.settings.TOP_LEVEL_HEADER_ID&#34;
android:resource=&#34;@id/security_settings&#34; /&gt;
&lt;/activity-alias&gt;
所以找到SecuritySettings.java，这里是“设置”-&gt;&#34;安全&#34;界面，也是开始寻找如何修改默认锁屏方式的入口。
第二阶段：寻找判断的过程" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/42609779d455bf0f23351ca7e5f5c207/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2016-03-31T13:55:52+08:00" />
<meta property="article:modified_time" content="2016-03-31T13:55:52+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">修改android默认锁屏方式</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><span style="font-size:14px">代码为公司的定制版基于android5.1，没有具体比较锁屏部分应该和原生代码有所不同。本文基于浏览代码结果，没有手机版本和代码版本不一致（APP上还是一脉相承）所以没有在手机上直接试验。</span></p> 
<p><span style="font-size:14px">首先在自己手机的版本上显示的默认锁屏方式在“设置”-&gt;“安全”-&gt;“屏幕锁定方式”其值为“滑动”，</span></p> 
<p><span style="font-size:14px">首先寻找“滑动”字符串packages/apps/Settings/res/values-zh-rCN/strings.xml</span></p> 
<p><span style="font-size:14px">&lt;string name="<span style="color:rgb(0,0,255)">unlock_set_unlock_none_title</span>" msgid="5679243878975864640"&gt;"<span style="font-family:宋体">滑动</span><span style="font-family:Calibri">"&lt;/string&gt;</span></span></p> 
<p><span style="font-size:14px">被引用：</span></p> 
<p><span style="font-size:14px">packages/apps/Settings/res/xml/security_settings_picker.xml</span></p> 
<p><span style="font-size:14px">被引用：</span></p> 
<p><span style="font-size:14px">packages/apps/Settings/src/com/android/settings/ChooseLockGeneric.java</span></p> 
<p><span style="font-size:14px">没有其他发现，转而向寻找“安全”</span></p> 
<p><span style="font-size:14px"><br> </span></p> 
<p><span style="font-size:14px">&lt;string name="security_settings_title" msgid="7945465324818485460"&gt;"安全"&lt;/string&gt;<br> 安全选项界面<br> &lt;activity android:name="<span style="color:#ff0000">Settings$SecuritySettingsActivity</span>"<br>                 android:label="@string/security_settings_title"<br>                 android:configChanges="orientation|keyboardHidden|screenSize"<br>                 android:taskAffinity=""<br>                 android:parentActivityName="Settings"&gt;<br>             &lt;intent-filter&gt;<br>                 &lt;action android:name="android.intent.action.MAIN" /&gt;<br>                 &lt;action android:name="android.settings.SECURITY_SETTINGS" /&gt;<br>                 &lt;action android:name="android.credentials.UNLOCK" /&gt;<br>                 &lt;category android:name="android.intent.category.DEFAULT" /&gt;<br>                 &lt;category android:name="android.intent.category.VOICE_LAUNCH" /&gt;<br>             &lt;/intent-filter&gt;<br>             &lt;meta-data android:name="com.android.settings.FRAGMENT_CLASS"<br>                 android:value="com.android.settings.SecuritySettings" /&gt;<br>             &lt;meta-data android:name="com.android.settings.TOP_LEVEL_HEADER_ID"<br>                 android:resource="@id/security_settings" /&gt;<br>             &lt;meta-data android:name="com.android.settings.PRIMARY_PROFILE_CONTROLLED"<br>                 android:value="true" /&gt;<br>         &lt;/activity&gt;<br> 别名设置：<br> &lt;activity-alias android:name="<span style="color:#ff0000">SecuritySettings</span>"<br>                 android:label="@string/security_settings_title"<br>                 android:configChanges="orientation|keyboardHidden|screenSize"<br>                 android:exported="true"<br>                 <span style="color:#ff0000">android:targetActivity="Settings$SecuritySettingsActivity"</span>&gt;<br>             &lt;meta-data android:name="com.android.settings.FRAGMENT_CLASS"<br>                 android:value="com.android.settings.SecuritySettings" /&gt;<br>             &lt;meta-data android:name="com.android.settings.TOP_LEVEL_HEADER_ID"<br>                 android:resource="@id/security_settings" /&gt;<br>         &lt;/activity-alias&gt;<br> </span></p> 
<p><span style="font-size:14px">所以找到SecuritySettings.java，这里是“设置”-&gt;"安全"界面，也是开始寻找如何修改默认锁屏方式的入口。</span></p> 
<p><span style="font-size:14px">第二阶段：寻找判断的过程</span></p> 
<p></p> 
<p><span style="font-size:14px">决定分支走向显示“滑动”的判断</span></p> 
<p><span style="font-size:14px">if (!lockPatternUtils.isSecure()) {<!-- --></span></p> 
<p><span style="font-size:14px">            // if there are multiple users, disable "None" setting</span></p> 
<p><span style="font-size:14px">            UserManager mUm = (UserManager) context. getSystemService(Context.USER_SERVICE);</span></p> 
<p><span style="font-size:14px">            List&lt;UserInfo&gt; users = mUm.getUsers(true);</span></p> 
<p><span style="font-size:14px">            final boolean singleUser = users.size() == 1;</span></p> 
<p><span style="font-size:14px"> </span></p> 
<p><span style="font-size:14px">            if (singleUser &amp;&amp; lockPatternUtils.isLockScreenDisabled()) {<!-- --></span></p> 
<p><span style="font-size:14px">                resid = R.xml.security_settings_lockscreen;</span></p> 
<p><span style="font-size:14px">            } else {<!-- --></span></p> 
<p><span style="font-size:14px">                <span style="color:rgb(0,0,255)">resid = R.xml.security_settings_chooser;</span></span></p> 
<p><span style="font-size:14px">            }</span></p> 
<p><span style="font-size:14px">        }</span></p> 
<p><span style="font-size:14px"><span style="font-family:Calibri">经过查看xml文件发现蓝色的是“滑动”的界面，</span>随后会根据<span style="font-family:Calibri">resid</span><span style="font-family:宋体">判断加载哪个</span><span style="font-family:Calibri">xml:</span></span></p> 
<p><span style="font-size:14px">addPreferencesFromResource(resid)</span></p> 
<p><span style="font-size:14px">得到默认锁屏方式是“滑动”的条件：</span></p> 
<p><span style="font-size:14px">（1）lockPatternUtils.isSecure() == false</span></p> 
<p><span style="font-size:14px">（2）singleUser &amp;&amp; lockPatternUtils.isLockScreenDisabled() == false</span></p> 
<p><span style="font-size:14px">singleUser<span style="font-family:宋体">在单用户为</span><span style="font-family:Calibri">true</span><span style="font-family:宋体">，主要看</span><span style="font-family:Calibri">isLockScreenDisabled()是否为false</span></span></p> 
<p><span style="font-family:Calibri"><span style="font-size:14px">根据lockPatternUtils类型找到对应文件：</span></span></p> 
<p><span style="font-size:14px">./frameworks/base/core/java/com/android/internal/widget/LockPatternUtils.java</span></p> 
<p><span style="font-size:14px">为了<span style="font-family:Calibri">isLockScreenDisabled()为false，getLong(DISABLE_LOCKSCREEN_KEY, 0)应该为0，或者在多用户模式特定情况下（当前情况不是，而且也暂未遇过），所以此处认为决定因素就是<span style="font-family:Calibri">getLong(DISABLE_LOCKSCREEN_KEY, 0)的取值</span>。</span><br> public boolean isLockScreenDisabled() {<!-- --></span></p> 
<p><span style="font-size:14px">        if (!isSecure() &amp;&amp; <span style="color:rgb(0,0,255)"> getLong(DISABLE_LOCKSCREEN_KEY, 0) != 0</span>) {<!-- --></span></p> 
<p><span style="font-size:14px">            // Check if the number of switchable users forces the lockscreen.</span></p> 
<p><span style="font-size:14px">            final List&lt;UserInfo&gt; users = UserManager.get(mContext).getUsers(true);</span></p> 
<p><span style="font-size:14px">            final int userCount = users.size();</span></p> 
<p><span style="font-size:14px">            int switchableUsers = 0;</span></p> 
<p><span style="font-size:14px">            for (int i = 0; i &lt; userCount; i++) {<!-- --></span></p> 
<p><span style="font-size:14px">                if (users.get(i).supportsSwitchTo()) {<!-- --></span></p> 
<p><span style="font-size:14px">                    switchableUsers++;</span></p> 
<p><span style="font-size:14px">                }</span></p> 
<p><span style="font-size:14px">            }</span></p> 
<p><span style="font-size:14px">            return switchableUsers &lt; 2;</span></p> 
<p><span style="font-size:14px">        }</span></p> 
<p><span style="font-size:14px">        return false;</span></p> 
<p><span style="font-size:14px">}</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">public final static String DISABLE_LOCKSCREEN_KEY = "lockscreen.disabled";</span><span style="font-family:宋体">）</span></span></p> 
<p><span style="font-size:14px">锁屏方式为“无”或“滑动”是在isSecure()为false，如果要修改默认锁屏方式从“无”到“滑动”，或者“滑动”到“无”，蓝色得到的</span></p> 
<p><span style="font-size:14px"> </span></p> 
<p><span style="font-size:14px">getLong()<span style="font-family:宋体">方法：</span></span></p> 
<p><span style="font-size:14px">private long getLong(String secureSettingKey, long defaultValue) {<!-- --></span></p> 
<p><span style="font-size:14px">        try {<!-- --></span></p> 
<p><span style="font-size:14px">            return <span style="color:rgb(0,0,255)"> getLockSettings(</span>).getLong(secureSettingKey, defaultValue,</span></p> 
<p><span style="font-size:14px">                    getCurrentOrCallingUserId());</span></p> 
<p><span style="font-size:14px">        } catch (RemoteException re) {<!-- --></span></p> 
<p><span style="font-size:14px">            return defaultValue;</span></p> 
<p><span style="font-size:14px">        }</span></p> 
<p><span style="font-size:14px">}</span></p> 
<p><span style="font-size:14px">调用：</span></p> 
<p><span style="font-size:14px">private <span style="color:rgb(0,0,255)">ILockSettings</span> getLockSettings() {<!-- --></span></p> 
<p><span style="font-size:14px">        if (mLockSettingsService == null) {<!-- --></span></p> 
<p><span style="font-size:14px">            ILockSettings service = ILockSettings.Stub.asInterface(</span></p> 
<p><span style="font-size:14px">                    ServiceManager.getService("lock_settings"));</span></p> 
<p><span style="font-size:14px">            mLockSettingsService = service;</span></p> 
<p><span style="font-size:14px">        }</span></p> 
<p><span style="font-size:14px">        return mLockSettingsService;</span></p> 
<p><span style="font-size:14px">}</span></p> 
<p><span style="font-size:14px">对应服务（就是把ILockSettings去掉前面的I后再搜索相关文件，如果想详细点后面加上Service再找）：</span></p> 
<p><span style="font-size:14px">./frameworks/base/services/core/java/com/android/server/LockSettingsService.java</span></p> 
<p><span style="font-size:14px">public long getLong(String key, long defaultValue, int userId) throws RemoteException {<!-- --></span></p> 
<p><span style="font-size:14px">        checkReadPermission(key, userId);</span></p> 
<p><span style="font-size:14px"> </span></p> 
<p><span style="font-size:14px">        String value = <span style="color:rgb(0,0,255)"> mStorage</span>.readKeyValue(key, null, userId);</span></p> 
<p><span style="font-size:14px">        return TextUtils.isEmpty(value) ? defaultValue : Long.parseLong(value);</span></p> 
<p><span style="font-size:14px">}</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">private final LockSettingsStorage mStorage;</span><span style="font-family:宋体">）</span></span></p> 
<p><span style="font-size:14px">./frameworks/base/services/core/java/com/android/server/LockSettingsStorage.java</span></p> 
<p><span style="font-size:14px">public String readKeyValue(String key, String defaultValue, int userId) {<!-- --></span></p> 
<p><span style="font-size:14px">        int version;</span></p> 
<p><span style="font-size:14px">        synchronized (mCache) {<!-- --></span></p> 
<p><span style="font-size:14px">            if (mCache.hasKeyValue(key, userId)) {<!-- --></span></p> 
<p><span style="font-size:14px">                return mCache.peekKeyValue(key, defaultValue, userId);</span></p> 
<p><span style="font-size:14px">            }</span></p> 
<p><span style="font-size:14px">            version = mCache.getVersion();</span></p> 
<p><span style="font-size:14px">        }</span></p> 
<p><span style="font-size:14px"> </span></p> 
<p><span style="font-size:14px">        Cursor cursor;</span></p> 
<p><span style="font-size:14px">        Object result = DEFAULT;</span></p> 
<p><span style="font-size:14px">        SQLiteDatabase db = mOpenHelper.getReadableDatabase();</span></p> 
<p><span style="font-size:14px">        <span style="color:rgb(0,0,255)">if ((cursor = db.query(TABLE, COLUMNS_FOR_QUERY,</span></span></p> 
<p><span style="color:rgb(0,0,255)"><span style="font-size:14px">                COLUMN_USERID + "=? AND " + COLUMN_KEY + "=?",</span></span></p> 
<p><span style="color:rgb(0,0,255)"><span style="font-size:14px">                new String[] { Integer.toString(userId), key },</span></span></p> 
<p><span style="font-size:14px"><span style="color:rgb(0,0,255)">                null, null, null)) != null)</span> {<!-- --></span></p> 
<p><span style="font-size:14px">            if (cursor.moveToFirst()) {<!-- --></span></p> 
<p><span style="font-size:14px">                result = cursor.getString(0);</span></p> 
<p><span style="font-size:14px">            }</span></p> 
<p><span style="font-size:14px">            cursor.close();</span></p> 
<p><span style="font-size:14px">        }</span></p> 
<p><span style="font-size:14px">        mCache.putKeyValueIfUnchanged(key, result, userId, version);</span></p> 
<p><span style="font-size:14px">        return result == DEFAULT ? defaultValue : (String) result;</span></p> 
<p><span style="font-size:14px">    }</span></p> 
<p><span style="font-size:14px">（<span style="font-family:Calibri">private static final String TABLE = "locksettings";</span><span style="font-family:宋体">）</span></span></p> 
<p><span style="font-size:14px">查询<span style="font-family:Calibri">locksettings</span><span style="font-family:宋体">表的值</span><span style="font-family:Calibri">lockscreen.disabled</span></span></p> 
<p><span style="font-size:14px">对应文件<span style="font-family:Calibri">/data/system/locksettings.db</span></span></p> 
<p><span style="font-family:Calibri"><span style="font-size:14px">我想直接改db文件的值应该也可以，不过这样改会使整个锁屏的逻辑放生变化，锁屏方式所不属于disable都发生改变从词意上也说不通，所以除非想试着玩还是别这么改。</span></span></p> 
<p><span style="font-size:14px"><br> </span></p> 
<p><span style="font-family:Calibri"><span style="font-size:14px"></span></span></p> 
<p>数据库的<span style="font-family:Calibri">lockscreen.disabled</span><span style="font-family:宋体">值的设置：</span></p> 
<p>相关文件：</p> 
<p><span style="color:rgb(0,0,255)">frameworks/base/packages/SettingsProvider/src/com/android/providers/settings/DatabaseHelper.java</span></p> 
<p>frameworks/base/core/java/android/provider/Settings.java:        public static final String LOCKSCREEN_DISABLED = "lockscreen.disabled";</p> 
<p>DatabaseHelper.java<span style="font-family:宋体">文件：</span></p> 
<p> if (SystemProperties.getBoolean("<span style="color:rgb(0,0,255)">ro.lockscreen.disable.default</span>", false) == true) {<!-- --></p> 
<p>                loadSetting(stmt, Settings.System.LOCKSCREEN_DISABLED, "1");</p> 
<p>            } else {<!-- --></p> 
<p>                loadBooleanSetting(stmt, Settings.System.LOCKSCREEN_DISABLED,</p> 
<p>                        <span style="color:rgb(0,0,255)">R.bool.def_lockscreen_disabled</span>);</p> 
<p>            }</p> 
<p>private void loadBooleanSetting(SQLiteStatement stmt, String key, int resid) {<!-- --></p> 
<p>        loadSetting(stmt, key,</p> 
<p>                mContext.getResources().getBoolean(resid) ? "1" : "0");</p> 
<p>}</p> 
<p>所以比较合适的修改是在ro.lockscreen.disable.default和def_lockscreen_disabled的值,这个肯定和原生及其他定制不同，应该看自己的实际代码（也许判断都不同）。</p> 
<p>ro.locksreeen.disable.default的值在系统属性中，要查找具体的生成之处。</p> 
<p>R.bool.def_lockscreen_disabled<span style="font-family:宋体">为</span><span style="font-family:Calibri">false</span><span style="font-family:宋体">则</span><span style="font-family:Calibri">lockscreen.disabled</span><span style="font-family:宋体">值为</span><span style="font-family:Calibri">0</span><span style="font-family:宋体">，否则为</span><span style="font-family:Calibri">1</span></p> 
<p>R.bool.def_lockscreen_disabled<span style="font-family:宋体">对应文件：</span></p> 
<p>./frameworks/base/packages/SettingsProvider/res/values/defaults.xml:    &lt;bool name="def_lockscreen_disabled"&gt;false&lt;/bool&gt;</p> 
<p>可能在定制系统的<span style="font-family:Calibri">overlay</span><span style="font-family:宋体">里有相应的修改：</span></p> 
<p>./device/generic/x86/<span style="color:rgb(0,0,255)">overlay</span>/frameworks/base/packages/SettingsProvider/res/values/defaults.xml:    &lt;bool name="def_lockscreen_disabled"&gt;true&lt;/bool&gt;</p> 
<p>./device/generic/armv7-a-neon/<span style="color:rgb(0,0,255)">overlay</span>/frameworks/base/packages/SettingsProvider/res/values/defaults.xml:    &lt;bool name="def_lockscreen_disabled"&gt;true&lt;/bool&gt;</p> 
<br> 
<br>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5970cd92199766412273c2f656d46d63/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信Token验证代码的实现</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/d735656c22a24dd503e0c53a3fd26abb/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">web前端初学者必学的css样式</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>