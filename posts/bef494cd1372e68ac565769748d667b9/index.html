<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mysql 内部xa_MySQL-XA事务（一）简介 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="mysql 内部xa_MySQL-XA事务（一）简介" />
<meta property="og:description" content="01-分布式事务处理机制DTP模型
MySQL XA事务是基于Open Group 的&lt;&gt; 标准来实现的，目的是为了适配分布式事务，允许多个数据库实例参与到一个全局的事务中。XA事务功能在很早之前就被引入了，直到MySQL-5.7版本才趋于完善，很多数据库中间件也开始使用XA事务来实现分布式事务。先来看下Open Group组织所定义的分布式事务处理模型，也被称为DTP模型，如下：
其中涉及到的AP/RM/TM三个角色和定义如下：AP(Application Program)：应用程序，主要是定义事务边界以及那些组成事务的特定于应用程序的操作。
RM(Resouces Manager)：资源管理器，管理一些共享资源的自治域，如提供对诸如数据库之类的共享资源的访问。
TM(Transaction Manager)：事务管理器，管理全局事务，协调事务的提交或者回滚，并协调故障恢复。02-MySQL-XA事务操作
在理解MySQL XA事务的工作原理时，需要将X/Open DTP模型中的各个组件映射到相关的MySQL组件中。MySQL引入binlog存储引擎作为操作日志的存储和传输，binlog和innobase同时参与到事务的提交过程，无论是普通事务操作还是XA事务操作，在MySQL内部都是一个分布式事务的处理过程，不同点在于MySQL XA事务的提交过程中将commit(2pc)操作显示的分为XA prepare 和XA commit两个过程来处理(细节稍有不同)，以此来适配全局分布式事务。DTP模型与MySQL内部XA事务的对应关系如下：
而在全局分布式事务中，MySQL实例对应到DTP中的RM，如下：
MySQL对外提供了如下6条命令，供事务管理器来进行调度。xa start 开启一个XA事务
xa end 结束一个XA事务操作
xa prepare 准备提交一个XA事务
xa commit 正式提交一个XA事务
xa rollback 回滚一个XA事务
xa recover 列出所有处于prepared状态的XA事务
实际操作一遍就能明白，如下：//开启XA事务
mysql&gt; xa start &#39;trx1&#39;;
Query OK, 0 rows affected (0.00 sec)
//事务操作
mysql&gt; insert into t1(name) values(&#39;ashe&#39;);
Query OK, 1 row affected (0.00 sec)
//事务操作
mysql&gt; insert into t1(name) values(&#39;zed&#39;);" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/bef494cd1372e68ac565769748d667b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-01-27T20:07:49+08:00" />
<meta property="article:modified_time" content="2021-01-27T20:07:49+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">mysql 内部xa_MySQL-XA事务（一）简介</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p align="center"><img src="https://images2.imgbox.com/55/93/lYFlHgER_o.png" alt="8df8e23c9ae308a172c8dfb5ff3dde57.png"><img src="https://images2.imgbox.com/4f/fe/K4c5wz0P_o.png" alt="cf7c48fd91afc98ab88f7087c3deb592.png">01-分布式事务处理机制DTP模型<img src="https://images2.imgbox.com/bc/7b/YdThyf14_o.png" alt="e8d6b3254373121cf1852ab9d4f88752.png"></p> 
 <p>MySQL XA事务是基于Open Group 的&lt;&gt; 标准来实现的，目的是为了适配分布式事务，允许多个数据库实例参与到一个全局的事务中。XA事务功能在很早之前就被引入了，直到MySQL-5.7版本才趋于完善，很多数据库中间件也开始使用XA事务来实现分布式事务。先来看下Open Group组织所定义的分布式事务处理模型，也被称为DTP模型，如下：</p> 
 <p align="center"><img src="https://images2.imgbox.com/82/1e/MUXlmOhO_o.png" alt="ffdf4277224dcb5fce7ba605e68a420a.png"></p> 
 <p>其中涉及到的AP/RM/TM三个角色和定义如下：AP(Application Program)：应用程序，主要是定义事务边界以及那些组成事务的特定于应用程序的操作。</p> 
 <p>RM(Resouces Manager)：资源管理器，管理一些共享资源的自治域，如提供对诸如数据库之类的共享资源的访问。</p> 
 <p align="center">TM(Transaction Manager)：事务管理器，管理全局事务，协调事务的提交或者回滚，并协调故障恢复。<img src="https://images2.imgbox.com/33/fd/hpMg0Ucp_o.png" alt="ec1ce9949fddbec3be2ce631e7f84c5f.png"><img src="https://images2.imgbox.com/a8/c3/jc5LkLFj_o.png" alt="cf7c48fd91afc98ab88f7087c3deb592.png">02-MySQL-XA事务操作<img src="https://images2.imgbox.com/90/f9/SYSRiWDO_o.png" alt="e8d6b3254373121cf1852ab9d4f88752.png"></p> 
 <p>在理解MySQL XA事务的工作原理时，需要将X/Open DTP模型中的各个组件映射到相关的MySQL组件中。MySQL引入binlog存储引擎作为操作日志的存储和传输，binlog和innobase同时参与到事务的提交过程，无论是普通事务操作还是XA事务操作，在MySQL内部都是一个分布式事务的处理过程，不同点在于MySQL XA事务的提交过程中将commit(2pc)操作显示的分为XA prepare 和XA commit两个过程来处理(细节稍有不同)，以此来适配全局分布式事务。DTP模型与MySQL内部XA事务的对应关系如下：</p> 
 <p align="center"><img src="https://images2.imgbox.com/47/e8/UxLBPoTz_o.png" alt="356e496d2e84e83083d22db679981143.png"></p> 
 <p>而在全局分布式事务中，MySQL实例对应到DTP中的RM，如下：</p> 
 <p align="center"><img src="https://images2.imgbox.com/08/47/Z5Y4cTmo_o.png" alt="e4865598c415199b32a99b2bdf551b27.png"></p> 
 <p>MySQL对外提供了如下6条命令，供事务管理器来进行调度。xa start 开启一个XA事务</p> 
 <p>xa end 结束一个XA事务操作</p> 
 <p>xa prepare 准备提交一个XA事务</p> 
 <p>xa commit 正式提交一个XA事务</p> 
 <p>xa rollback 回滚一个XA事务</p> 
 <p>xa recover 列出所有处于prepared状态的XA事务</p> 
 <p>实际操作一遍就能明白，如下：//开启XA事务</p> 
 <p>mysql&gt; xa start 'trx1';</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>//事务操作</p> 
 <p>mysql&gt; insert into t1(name) values('ashe');</p> 
 <p>Query OK, 1 row affected (0.00 sec)</p> 
 <p>//事务操作</p> 
 <p>mysql&gt; insert into t1(name) values('zed');</p> 
 <p>Query OK, 1 row affected (0.00 sec)</p> 
 <p>//结束XA事务操作</p> 
 <p>mysql&gt; xa end 'trx1';</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>//预提交XA事务</p> 
 <p>mysql&gt; xa prepare 'trx1';</p> 
 <p>Query OK, 0 rows affected (0.00 sec)</p> 
 <p>//正式提交XA事务</p> 
 <p>mysql&gt; xa commit 'trx1';</p> 
 <p>Query OK, 0 rows affected (0.00 sec)查看对应的binlog文件，可以发现，MySQL-5.7版本中引入了XA_prepare_log_event，将binlog日志一分为二，整体占用两个GTID，所以如果是在半同步复制场景下，一个XA事务的提交过程，需要两次ACK的等待(commit one phase除外)，如下：SET @@SESSION.GTID_NEXT= '5a28b508-aa9d-11e9-99e8-8f54f8e077b5:4'/*!*/;</p> 
 <p># at 299</p> 
 <p>#190807 21:11:30 server id 110110 end_log_pos 392 CRC32 0x22e49420 Query thread_id=3 exec_time=0 error_code=0</p> 
 <p>SET TIMESTAMP=1565183490/*!*/;</p> 
 <p>SET @@session.pseudo_thread_id=3/*!*/;</p> 
 <p>SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0, @@session.unique_checks=1, @@session.autocommit=1/*!*/;</p> 
 <p>SET @@session.sql_mode=1073741824/*!*/;</p> 
 <p>SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;</p> 
 <p>/*!\C utf8 *//*!*/;</p> 
 <p>SET @@session.character_set_client=33,@@session.collation_connection=33,@@session.collation_server=45/*!*/;</p> 
 <p>SET @@session.lc_time_names=0/*!*/;</p> 
 <p>SET @@session.collation_database=DEFAULT/*!*/;</p> 
 <p>XA START X'74727831',X'',1</p> 
 <p>/*!*/;</p> 
 <p># at 392</p> 
 <p>#190807 21:11:30 server id 110110 end_log_pos 451 CRC32 0xf18efdf5 Rows_query</p> 
 <p># insert into t1(name) values('ashe')</p> 
 <p># at 451</p> 
 <p>#190807 21:11:30 server id 110110 end_log_pos 499 CRC32 0xae2d7b3e Table_map: `ashe`.`t1` mapped to number 108</p> 
 <p># at 499</p> 
 <p>#190807 21:11:30 server id 110110 end_log_pos 544 CRC32 0x05941ec3 Write_rows: table id 108 flags: STMT_END_F</p> 
 <p>### INSERT INTO `ashe`.`t1`</p> 
 <p>### SET</p> 
 <p>### @1=2 * INT meta=0 nullable=0 is_null=0 */</p> 
 <p>### @2='ashe' * VARSTRING(40) meta=40 nullable=1 is_null=0 */</p> 
 <p># at 544</p> 
 <p>#190807 21:11:34 server id 110110 end_log_pos 602 CRC32 0x7e7c4788 Rows_query</p> 
 <p># insert into t1(name) values('zed')</p> 
 <p># at 602</p> 
 <p>#190807 21:11:34 server id 110110 end_log_pos 650 CRC32 0xdd1eb844 Table_map: `ashe`.`t1` mapped to number 108</p> 
 <p># at 650</p> 
 <p>#190807 21:11:34 server id 110110 end_log_pos 694 CRC32 0x6d7e2039 Write_rows: table id 108 flags: STMT_END_F</p> 
 <p>### INSERT INTO `ashe`.`t1`</p> 
 <p>### SET</p> 
 <p>### @1=3 * INT meta=0 nullable=0 is_null=0 */</p> 
 <p>### @2='zed' * VARSTRING(40) meta=40 nullable=1 is_null=0 */</p> 
 <p># at 694</p> 
 <p>#190807 21:11:56 server id 110110 end_log_pos 785 CRC32 0xb00e4eb4 Query thread_id=3 exec_time=0 error_code=0</p> 
 <p>SET TIMESTAMP=1565183516/*!*/;</p> 
 <p>XA END X'74727831',X'',1</p> 
 <p>/*!*/;</p> 
 <p># at 785</p> 
 <p>#190807 21:11:56 server id 110110 end_log_pos 825 CRC32 0x239f7336 XA PREPARE X'74727831',X'',1</p> 
 <p>XA PREPARE X'74727831',X'',1</p> 
 <p>/*!*/;</p> 
 <p># at 825</p> 
 <p>#190807 21:12:00 server id 110110 end_log_pos 890 CRC32 0x73388f78 GTID last_committed=1 sequence_number=2 rbr_only=no</p> 
 <p>SET @@SESSION.GTID_NEXT= '5a28b508-aa9d-11e9-99e8-8f54f8e077b5:5'/*!*/;</p> 
 <p># at 890</p> 
 <p>#190807 21:12:00 server id 110110 end_log_pos 984 CRC32 0x04f221b5 Query thread_id=3 exec_time=0 error_code=0</p> 
 <p>SET TIMESTAMP=1565183520/*!*/;</p> 
 <p>XA COMMIT X'74727831',X'',1</p> 
 <p>/*!*/;</p> 
 <p>ROLLBACK /* added by mysqlbinlog */ /*!*/;</p> 
 <p>SET @@SESSION.GTID_NEXT= 'AUTOMATIC' /* added by mysqlbinlog */ /*!*/;</p> 
 <p>DELIMITER ;</p> 
 <p># End of log file</p> 
 <p>/*!50003 SET COMPLETION_TYPE=@OLD_COMPLETION_TYPE*/;</p> 
 <p>/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=0*/;</p> 
 <p align="center"><img src="https://images2.imgbox.com/34/64/O80Cn7RQ_o.png" alt="ec1ce9949fddbec3be2ce631e7f84c5f.png"><img src="https://images2.imgbox.com/27/71/sfI19ETu_o.png" alt="cf7c48fd91afc98ab88f7087c3deb592.png">03-MySQL-XA事务状态流转<img src="https://images2.imgbox.com/7f/2b/GUgZpr4l_o.png" alt="e8d6b3254373121cf1852ab9d4f88752.png"></p> 
 <p>XA事务在MySQL内部共有五种状态，如下:XA_NOTR     //未开始</p> 
 <p>XA_ACTIVE 活跃状态</p> 
 <p>XA_IDLE  //空闲状态</p> 
 <p>XA_PREPARED //准备提交状态</p> 
 <p>XA_ROLLBACK_ONLY /只能回滚</p> 
 <p>状态流转图：</p> 
 <p align="center"><img src="https://images2.imgbox.com/6d/2d/fDG3K8MA_o.png" alt="36001b9c94859ee8cd604d463c606fec.png"></p> 
 <p align="center"><img src="https://images2.imgbox.com/b6/ec/WMNljJyD_o.png" alt="a6af313a2dc707e47400479c34b053b2.png"></p> 
 <p align="center">事务状态流转受到InnoDB参数innodb_rollback_on_timeout的影响，这一点会在下一篇文章中解释，关于MySQL XA事务处理的内部细节，也会放在后续的文章中。<img src="https://images2.imgbox.com/07/f4/OiUwB6xN_o.png" alt="a7fcab0a8cc87e7c129f122ec44a253b.png"></p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dd8c70cbf23e4837ffcc2803e894e0f7/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">《Leaflet 基础知识点》- 地图定位、跳转和缩放</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/db79869fdb1f89785a58e03a4091c92e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">layui 手机端弹出键盘_用电脑连接苹果手机热点的三种方法，你会哪一种？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>