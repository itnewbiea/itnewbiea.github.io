<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Spark访问安全HBase异常No valid credentials provided - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Spark访问安全HBase异常No valid credentials provided" />
<meta property="og:description" content="原始文章链接：https://alphablacktan.github.io/bigdata/2018/08/12/Spark访问安全HBase异常No-valid-credentials-provided/
问题现象 在Spark（cluster模式）上访问安全HBase抛出如下异常：
... DEBUG | Connecting to linux18/10.75.202.18:21310 | org.apache.hadoop.hbase.ipc.RpcClientImpl$Connection.setupIOStreams(RpcClientImpl.java:713) INFO | RPC Server Kerberos principal name for service=MasterService is hbase/hadoop.hadoop.com@HADOOP.COM | org.apache.hadoop.hbase.ipc.RpcClientImpl$Connection.processPreambleResponse(RpcClientImpl.java:817) DEBUG | PrivilegedAction as:alphatan (auth:SIMPLE) from:org.apache.hadoop.hbase.ipc.RpcClientImpl$Connection.setupIOStreams(RpcClientImpl.java:741) | org.apache.hadoop.security.UserGroupInformation.logPrivilegedAction(UserGroupInformation.java:1805) DEBUG | Creating SASL GSSAPI client. Server&#39;s Kerberos principal name is hbase/hadoop.hadoop.com@HADOOP.COM | org.apache.hadoop.hbase.security.HBaseSaslRpcClient.&lt;init&gt;(HBaseSaslRpcClient.java:103) DEBUG | PrivilegedActionException as:alphatan (auth:SIMPLE) cause:javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)] | org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8e6f8dc266adf57bf24de117181b0fd5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2018-02-24T21:38:06+08:00" />
<meta property="article:modified_time" content="2018-02-24T21:38:06+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Spark访问安全HBase异常No valid credentials provided</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p><a href="https://alphablacktan.github.io/bigdata/2018/08/12/Spark%E8%AE%BF%E9%97%AE%E5%AE%89%E5%85%A8HBase%E5%BC%82%E5%B8%B8No-valid-credentials-provided/" rel="nofollow">原始文章链接：https://alphablacktan.github.io/bigdata/2018/08/12/Spark访问安全HBase异常No-valid-credentials-provided/</a></p> 
<h2><a id="_1"></a>问题现象</h2> 
<p>在Spark（cluster模式）上访问安全HBase抛出如下异常：</p> 
<pre><code>...
DEBUG | Connecting to linux18/10.75.202.18:21310 | org.apache.hadoop.hbase.ipc.RpcClientImpl$Connection.setupIOStreams(RpcClientImpl.java:713)
INFO | RPC Server Kerberos principal name for service=MasterService is hbase/hadoop.hadoop.com@HADOOP.COM | org.apache.hadoop.hbase.ipc.RpcClientImpl$Connection.processPreambleResponse(RpcClientImpl.java:817)
DEBUG | PrivilegedAction as:alphatan (auth:SIMPLE) from:org.apache.hadoop.hbase.ipc.RpcClientImpl$Connection.setupIOStreams(RpcClientImpl.java:741) | org.apache.hadoop.security.UserGroupInformation.logPrivilegedAction(UserGroupInformation.java:1805)
DEBUG | Creating SASL GSSAPI client. Server's Kerberos principal name is hbase/hadoop.hadoop.com@HADOOP.COM | org.apache.hadoop.hbase.security.HBaseSaslRpcClient.&lt;init&gt;(HBaseSaslRpcClient.java:103)
DEBUG | PrivilegedActionException as:alphatan (auth:SIMPLE) cause:javax.security.sasl.SaslException: GSS initiate failed [Caused by GSSException: No valid credentials provided (Mechanism level: Failed to find any Kerberos tgt)] | org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1782)
...
</code></pre> 
<p>如捕捉到上诉DEBUG日志，在最后将会引发一个TGT异常，因为公司保守，无法将总结带出，笔者在此全手打就不敲出完整堆栈了。</p> 
<h2><a id="_15"></a>问题分析</h2> 
<p>Spark作为分布式计算框架，其cluster模式业务逻辑运行于YARN集群的多个独立JAVA进程中。Spark实现会将UGI的currentUser的Auth模式设置为SIMPLE，因此即使在Spark业务代码里再次进行认证依然会抛出上诉异常。</p> 
<h2><a id="_19"></a>问题解决方案</h2> 
<ol><li> <p>在连接安全HBase时，使用对应ugi的doAs()接口包装连接逻辑，进而避免按照默认使用SIMPLE模式连接安全HBase。</p> <pre><code> ugi.doAs(new PrivilegedAction&lt;Void&gt;() {
 	public Void run() {
 		...
 		/* Connect HBase code */
 		...

 		return null;
 	}
 });
</code></pre> </li><li> <p>修改Spark提交实现，在提交任务时传递token给Driver。这个实现比较复杂，有兴趣的读者可以自行琢磨，笔者就不在这里过多描述了。</p> </li></ol>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3f44cf4e616ff10d66c28a82e596a635/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Spark使用小窍门</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/857880f25392abdce40876892aedbbbe/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">程序员千万别找太漂亮的女生做女朋友</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>