<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zabbix自定义监控 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zabbix自定义监控" />
<meta property="og:description" content="1-进程监控 1-1 在agent端编写脚本 取出需要监控资源的状态值 //创建目录 [root@localhost ~]# mkdir /scripts //编写内容脚本 [root@localhost ~]# vim /scripts/check_process.sh [root@localhost ~]# cat /scripts/check_process.sh #!/bin/bash status=$(ps -ef |grep $1|grep -Ev &#34;$0|grep&#34;|wc -l) if [ $status -eq 0 ];then echo &#39;1&#39; else echo &#39;0&#39; fi //给执行权限 [root@localhost ~]# chmod &#43;x /scripts/check_process.sh //查看 [root@localhost ~]# ll /scripts/check_process.sh -rwxr-xr-x 1 root root 134 Sep 6 21:23 /scripts/check_process.sh 1-2 在agent端编写配置文件 //将下面两行取消注释作修改，或者直接添加这两行 [root@localhost ~]# vim /usr/local/etc/zabbix_agentd.conf # Mandatory: no # Range: 0-1 # Default: UnsafeUserParameters=1 //取消注释 改为1 ### Option: UserParameter # User-defined parameter to monitor." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/6166ac46c3e2a5236e9b0f8b7c7f3498/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-09-06T22:46:54+08:00" />
<meta property="article:modified_time" content="2022-09-06T22:46:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zabbix自定义监控</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <h2>1-进程监控</h2> 
<h3>1-1 在agent端编写脚本 取出需要监控资源的状态值</h3> 
<pre><code class="hljs">//创建目录
[root@localhost ~]# mkdir /scripts

//编写内容脚本
[root@localhost ~]# vim /scripts/check_process.sh
[root@localhost ~]# cat /scripts/check_process.sh 
#!/bin/bash
status=$(ps -ef |grep $1|grep -Ev "$0|grep"|wc -l)
if [ $status -eq 0 ];then
            echo '1'
    else
                echo '0'
        fi

//给执行权限
[root@localhost ~]# chmod +x /scripts/check_process.sh 

//查看
[root@localhost ~]# ll /scripts/check_process.sh 
-rwxr-xr-x 1 root root 134 Sep  6 21:23 /scripts/check_process.sh
</code></pre> 
<h3>1-2 在agent端编写配置文件</h3> 
<pre><code class="hljs">//将下面两行取消注释作修改，或者直接添加这两行
[root@localhost ~]# vim /usr/local/etc/zabbix_agentd.conf
# Mandatory: no
# Range: 0-1
# Default:
UnsafeUserParameters=1    //取消注释 改为1

### Option: UserParameter
#       User-defined parameter to monitor. There can be several user-defined parameters.
#       Format: UserParameter=&lt;key&gt;,&lt;shell command&gt;
#       See 'zabbix_agentd' directory for examples.
#
# Mandatory: no
# Default:
 UserParameter=check_process[*],/bin/bash /scripts/check_process.sh $1  //取消注释写入内容

//重启agent，生效作更改的配置
[root@localhost ~]# pkill zabbix_agentd
[root@localhost ~]# zabbix_agentd 
[root@localhost ~]# ss -anlt
State      Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process     
LISTEN     0           128                    0.0.0.0:10050                0.0.0.0:*                    
LISTEN     0           128                    0.0.0.0:22                   0.0.0.0:*                    
LISTEN     0           128                       [::]:22                      [::]:* 

//安装httpd服务
[root@localhost ~]# yum -y install httpd
[root@localhost ~]# systemctl start httpd
[root@localhost ~]# ss -anlt
State      Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process     
LISTEN     0           128                    0.0.0.0:10050                0.0.0.0:*                    
LISTEN     0           128                    0.0.0.0:22                   0.0.0.0:*                    
LISTEN     0           128                          *:80                         *:*                    
LISTEN     0           128                       [::]:22                      [::]:*  

                    
//在Server端测试刚刚所做的进程监控配置
[root@localhost ~]# zabbix_get -s 192.168.79.131 -k check_process[httpd]
0
[root@localhost ~]# zabbix_get -s 192.168.79.131 -k check_process[mysql]
1

</code></pre> 
<h3>1-3 在web界面添加监控项</h3> 
<p><img alt="" height="737" src="https://images2.imgbox.com/bd/a8/rQZgqQWl_o.png" width="1200"></p> 
<p><img alt="" height="998" src="https://images2.imgbox.com/f0/52/Polgt3IT_o.png" width="1200"> </p> 
<h3><img alt="" height="1032" src="https://images2.imgbox.com/2b/a0/Tflv5leW_o.png" width="1200">1-4 在web界面添加触发器</h3> 
<p><img alt="" height="758" src="https://images2.imgbox.com/27/ba/aYU3s0zN_o.png" width="1200"></p> 
<p><img alt="" height="1032" src="https://images2.imgbox.com/67/fa/UmIAnadK_o.png" width="1200"></p> 
<p><img alt="" height="837" src="https://images2.imgbox.com/0e/16/rmxuPs8q_o.png" width="1200"> <img alt="" height="997" src="https://images2.imgbox.com/89/be/vGVE13zn_o.png" width="1200"></p> 
<h3> 1-5 手动触发警告</h3> 
<pre><code class="hljs">//在agent端中关闭服务器
[root@localhost ~]# systemctl stop httpd</code></pre> 
<p><img alt="" height="996" src="https://images2.imgbox.com/6e/5e/YKiPQLbW_o.png" width="1200"></p> 
<h2><img alt="" height="990" src="https://images2.imgbox.com/70/05/hV5jOVMR_o.png" width="1200"></h2> 
<p> </p> 
<h2>2-日志监控</h2> 
<h3>2-1在agent端编写脚本 取出需要监控资源的状态值</h3> 
<p> </p> 
<pre><code class="hljs">//下载python的编译器
[root@localhost ~]# yum -y install python3

//写python脚本。因shell脚本只能在Linux系统执行，如zabbix需要监控Windows系统\
//则需要python脚本，py脚本在这两操作系统都能运行
[root@localhost ~]# vim /scripts/log.py
#!/usr/bin/env python3
import sys
import re

def prePos(seekfile):
    global curpos
    try:
        cf = open(seekfile)
    except IOError:
        curpos = 0
        return curpos
    except FileNotFoundError:
        curpos = 0
        return curpos
    else:
        try:
            curpos = int(cf.readline().strip())
        except ValueError:
            curpos = 0
            cf.close()
            return curpos
        cf.close()
    return curpos

def lastPos(filename):
    with open(filename) as lfile:
        if lfile.readline():
            lfile.seek(0,2)
        else:
            return 0
        lastPos = lfile.tell()
    return lastPos

def getSeekFile():
    try:
        seekfile = sys.argv[2]
    except IndexError:
        seekfile = '/tmp/logseek'
    return seekfile

def getKey():
    try:
        tagKey = str(sys.argv[3])
    except IndexError:
        tagKey = 'Error'
    return tagKey

def getResult(filename,seekfile,tagkey):
    destPos = prePos(seekfile)
    curPos = lastPos(filename)

    if curPos &lt; destPos:
        curpos = 0

    try:
        f = open(filename)
    except IOError:
        print('Could not open file: %s' % filename)
    except FileNotFoundError:
        print('Could not open file: %s' % filename)
    else:
        f.seek(destPos)

        while curPos != 0 and f.tell() &lt; curPos:
            rresult = f.readline().strip()
            global result
            if re.search(tagkey, rresult):
                result = 1
                break
            else:
                result = 0

        with open(seekfile,'w') as sf:
            sf.write(str(curPos))
    finally:
        f.close()
    return result

if __name__ == "__main__":
    result = 0
    curpos = 0
    tagkey = getKey()
    seekfile = getSeekFile()
    result = getResult(sys.argv[1],seekfile,tagkey)
    print(result)

[root@localhost ~]# chmod +x /scripts/log.py 
[root@localhost ~]# ll /scripts/log.py 
-rwxr-xr-x 1 root root 1937 Sep  6 22:15 /scripts/log.py

//测试一下该脚本是否可用，0代表没问题
[root@localhost scripts]# /scripts/log.py /var/log/httpd/error_log
0


执行脚本检查httpd的错误日志
[root@localhost scripts]# /scripts/log.py /var/log/httpd/error_log
0


//手动添加错误信息"Error"测试效果
[root@localhost scripts]# echo 'Error' &gt;&gt; /var/log/httpd/error_log


//可以看到输出了1，1代表日志文件里有报错
[root@localhost scripts]# /scripts/log.py /var/log/httpd/error_log
1
</code></pre> 
<h3> 2-2在agent端编辑配置文件</h3> 
<pre><code class="hljs">[root@localhost ~]# vim /usr/local/etc/zabbix_agentd.conf

# Mandatory: no
# Default:
 UserParameter=check_process[*],/bin/bash /scripts/check_process.sh $1
 UserParameter=check_log[*],/scripts/log.py $1 $2 $3            //添加这行


//重启agent，生效配置
[root@localhost ~]# vim /usr/local/etc/zabbix_agentd.conf
[root@localhost ~]# pkill zabbix_agentd
[root@localhost ~]# zabbix_agentd 
[root@localhost ~]# ss -anlt
State      Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process     
LISTEN     0           128                    0.0.0.0:10050                0.0.0.0:*                    
LISTEN     0           128                    0.0.0.0:22                   0.0.0.0:*                    
LISTEN     0           128                       [::]:22                      [::]:*   

//生效配置之后，去Server端测试
//测试之前先做些测试的准备工作
//设置文件权限。因为zabbix服务端访问客户端属于其他，如果\
//文件的其他人没有读的权限，则无法监控该项
[root@localhost ~]# ll /var/log/httpd/error_log
-rw-r--r-- 1 root root 1020 Sep  6 22:25 /var/log/httpd/error_log
[root@localhost ~]# ll -d /var/log/httpd/
drwx------ 2 root root 41 Sep  6 21:33 /var/log/httpd/
[root@localhost ~]# chmod 755 /var/log/httpd/
[root@localhost ~]# ll -d /var/log/httpd/
drwxr-xr-x 2 root root 41 Sep  6 21:33 /var/log/httpd/

//因之前本地测试脚本生成了该文件，该文件的属组是本地的root用户，\
//需本地测试完后删掉，在server执行脚本生成新的文件
[root@localhost ~]# ll /tmp/logseek
-rw-r--r-- 1 root root 4 Sep  6 22:25 /tmp/logseek
[root@localhost ~]# rm -f /tmp/logseek

//Server端测试
[root@localhost ~]# zabbix_get -s 192.168.79.131 -k check_log['/var/log/httpd/error_log']
1			//会输出1是因为之前测试往httpd的error_log文件追加了‘Error’，前面又把测试的logseek记录检查文件\
			//给删除了，这是执行脚本会生成新的logseek文件，该文件会从头开始，所以检测出‘Error’
//再次执行就不会输出1了，因为再次检测从上次检测的尾部之后开始，故当前error日志没有‘Error’信息
[root@localhost ~]# zabbix_get -s 192.168.79.131 -k check_log['/var/log/httpd/error_log']
0
//去到agent查看新生成的logseek记录检查文件，可以看到属主是zabbix
[root@localhost ~]# ll /tmp/logseek
-rw-rw-r-- 1 zabbix zabbix 4 Sep  6 22:32 /tmp/logseek

</code></pre> 
<h3>2-3 在web界面添加监控项</h3> 
<p><img alt="" height="878" src="https://images2.imgbox.com/75/e7/dxAUMUuo_o.png" width="1200"></p> 
<h3>2-4 在web界面添加触发器</h3> 
<p><img alt="" height="809" src="https://images2.imgbox.com/f8/ab/05dyVJB7_o.png" width="1200"></p> 
<h3> 2-5 手动触发警告</h3> 
<pre><code class="hljs">[root@localhost ~]# systemctl start httpd
[root@localhost ~]# ss -anlt
State      Recv-Q      Send-Q           Local Address:Port            Peer Address:Port     Process     
LISTEN     0           128                    0.0.0.0:10050                0.0.0.0:*                    
LISTEN     0           128                    0.0.0.0:22                   0.0.0.0:*                    
LISTEN     0           128                          *:80                         *:*                    
LISTEN     0           128                       [::]:22                      [::]:*                    
[root@localhost ~]# echo 'Error' &gt;&gt; /var/log/httpd/error_log
</code></pre> 
<p><img alt="" height="1000" src="https://images2.imgbox.com/ef/f9/NsfcB8iA_o.png" width="1200"></p> 
<p><img alt="" height="994" src="https://images2.imgbox.com/32/e3/fsiEnoUh_o.png" width="1200"> </p> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/93ff95aac90256ef3ff3bd0378365137/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">python复制文件到指定文件夹</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2e39b84fe72bc3bed8eb5d104ef1ff61/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【JavaSE】多线程篇（四）线程的同步机制、互斥锁、线程死锁与释放锁</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>