<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Unity Shader - 搬砖日志 - URP PBR (抄作业篇，持续更新~) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Unity Shader - 搬砖日志 - URP PBR (抄作业篇，持续更新~)" />
<meta property="og:description" content="文章目录 目的环境PBR 主要渲染方程D 项GGB(desmos)D_Term 完整 Shader G 项GGBG_Term 完整 Shader F 项GGBF_Term 完整 Shader D, G, F 带入公式PBR_Test_DGF.hlslDGF_Term 应用到具体 PBR 素材上完整 Shader - 只有 PBR &#43; SH(Reflection Probe) &#43; EmissivePBR__Emissive_Lib.hlslURP_PBR_Emissive.shader References 目的 这篇文章的目的：只为了备忘、和便于回顾、复习
只适合本人自己查看
环境 下面代码的运行环境
Unity : 2019.3.11f1Pipeline : URP 这篇文章，在 2021/12 - 2022/2 初，断断续续的时间片抄完的笔记
参考资料具体查看：Reference
下面多数是抄出来的作业，少部分有自己的理解、调整的东西
这篇 PBR 中，很多都是经过各个 optimization 之后的分支代码
PBR 主要渲染方程 L o ( p , w o ) = ∫ Ω ( k d c π &#43; k s D G F 4 ( w o ⋅ n ) ( w i ⋅ n ) ) L i ( p , w i ) ( w i ⋅ n ) d w i L_o(p,w_o)=\int_{\Omega}(k_d \frac{c}{\pi} &#43; k_s \frac {D G F}{4(w_o \cdot n)(w_i \cdot n)}) L_i(p,w_i)(w_i \cdot n) dw_i Lo​(p,wo​)=∫Ω​(kd​πc​&#43;ks​4(wo​⋅n)(wi​⋅n)DGF​)Li​(p,wi​)(wi​⋅n)dwi​" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/72a9f6a18f352a888f7e17cbbd87d88b/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-06T15:35:12+08:00" />
<meta property="article:modified_time" content="2022-07-06T15:35:12+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Unity Shader - 搬砖日志 - URP PBR (抄作业篇，持续更新~)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_3" rel="nofollow">目的</a></li><li><a href="#_9" rel="nofollow">环境</a></li><li><a href="#PBR__26" rel="nofollow">PBR 主要渲染方程</a></li><li><ul><li><a href="#D__37" rel="nofollow">D 项</a></li><li><ul><li><a href="#GGBdesmos_66" rel="nofollow">GGB(desmos)</a></li><li><a href="#D_Term__Shader_72" rel="nofollow">D_Term 完整 Shader</a></li></ul> 
   </li><li><a href="#G__154" rel="nofollow">G 项</a></li><li><ul><li><a href="#GGB_194" rel="nofollow">GGB</a></li><li><a href="#G_Term__Shader_198" rel="nofollow">G_Term 完整 Shader</a></li></ul> 
   </li><li><a href="#F__287" rel="nofollow">F 项</a></li><li><ul><li><a href="#GGB_352" rel="nofollow">GGB</a></li><li><a href="#F_Term__Shader_358" rel="nofollow">F_Term 完整 Shader</a></li></ul> 
   </li><li><a href="#D_G_F__459" rel="nofollow">D, G, F 带入公式</a></li><li><ul><li><a href="#PBR_Test_DGFhlsl_482" rel="nofollow">PBR_Test_DGF.hlsl</a></li><li><a href="#DGF_Term_552" rel="nofollow">DGF_Term</a></li></ul> 
  </li></ul> 
  </li><li><a href="#_PBR__637" rel="nofollow">应用到具体 PBR 素材上</a></li><li><ul><li><a href="#_Shader___PBR__SHReflection_Probe__Emissive_649" rel="nofollow">完整 Shader - 只有 PBR + SH(Reflection Probe) + Emissive</a></li><li><ul><li><a href="#PBR__Emissive_Libhlsl_654" rel="nofollow">PBR__Emissive_Lib.hlsl</a></li><li><a href="#URP_PBR_Emissiveshader_970" rel="nofollow">URP_PBR_Emissive.shader</a></li></ul> 
  </li></ul> 
  </li><li><a href="#References_1028" rel="nofollow">References</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="_3"></a>目的</h2> 
<p>这篇文章的目的：只为了备忘、和便于回顾、复习</p> 
<p>只适合本人自己查看</p> 
<hr> 
<h2><a id="_9"></a>环境</h2> 
<p>下面代码的运行环境</p> 
<ul><li>Unity : 2019.3.11f1</li><li>Pipeline : URP</li></ul> 
<hr> 
<p>这篇文章，在 2021/12 - 2022/2 初，断断续续的时间片抄完的笔记</p> 
<p>参考资料具体查看：Reference</p> 
<p>下面多数是抄出来的作业，少部分有自己的理解、调整的东西</p> 
<p>这篇 PBR 中，很多都是经过各个 optimization 之后的分支代码</p> 
<hr> 
<h2><a id="PBR__26"></a>PBR 主要渲染方程</h2> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           L 
          
         
           o 
          
         
        
          ( 
         
        
          p 
         
        
          , 
         
         
         
           w 
          
         
           o 
          
         
        
          ) 
         
        
          = 
         
         
         
           ∫ 
          
         
           Ω 
          
         
        
          ( 
         
         
         
           k 
          
         
           d 
          
         
         
         
           c 
          
         
           π 
          
         
        
          + 
         
         
         
           k 
          
         
           s 
          
         
         
          
          
            D 
           
          
            G 
           
          
            F 
           
          
          
          
            4 
           
          
            ( 
           
           
           
             w 
            
           
             o 
            
           
          
            ⋅ 
           
          
            n 
           
          
            ) 
           
          
            ( 
           
           
           
             w 
            
           
             i 
            
           
          
            ⋅ 
           
          
            n 
           
          
            ) 
           
          
         
        
          ) 
         
         
         
           L 
          
         
           i 
          
         
        
          ( 
         
        
          p 
         
        
          , 
         
         
         
           w 
          
         
           i 
          
         
        
          ) 
         
        
          ( 
         
         
         
           w 
          
         
           i 
          
         
        
          ⋅ 
         
        
          n 
         
        
          ) 
         
        
          d 
         
         
         
           w 
          
         
           i 
          
         
        
       
         L_o(p,w_o)=\int_{\Omega}(k_d \frac{c}{\pi} + k_s \frac {D G F}{4(w_o \cdot n)(w_i \cdot n)}) L_i(p,w_i)(w_i \cdot n) dw_i 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.27195em; vertical-align: -0.91195em;"></span><span class="mop"><span class="mop op-symbol large-op" style="margin-right: 0.44445em; position: relative; top: -0.001125em;">∫</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist"><span class="" style="top: -1.78805em; margin-left: -0.44445em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Ω</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.91195em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.03148em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.10756em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.686em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 2.29633em; vertical-align: -0.936em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.03148em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.36033em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord">4</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.151392em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mord mathdefault">G</span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mclose">)</span><span class="mord"><span class="mord mathdefault">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: 0em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">n</span><span class="mclose">)</span><span class="mord mathdefault">d</span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.311664em;"><span class="" style="top: -2.55em; margin-left: -0.02691em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span></span></span></span></span></span></p> 
<ul><li>D - 法线分布函数：描述微表面法线 N 和 半角 H 同向性的比重，光滑度越高，也就是粗糙度越低(越光滑)，那么N，H 的同向性越大(反射越清晰)</li><li>G - 后面补上，看下面抄的作业中的描述，也时可以，但是还不够详细</li><li>F - 同上</li></ul> 
<hr> 
<h3><a id="D__37"></a>D 项</h3> 
<p>法线分布函数GGX(Normal Distribution Function)，即核心方程的D项</p> 
<p>D - 法线分布函数：描述微表面法线 N 和 半角 H 同向性的比重，光滑度越高，也就是粗糙度越低(越光滑)，那么N，H 的同向性越大(反射越清晰)</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          D 
         
        
          = 
         
         
          
          
            a 
           
          
            2 
           
          
          
          
            π 
           
          
            ( 
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            h 
           
           
           
             ) 
            
           
             2 
            
           
          
            ( 
           
           
           
             a 
            
           
             2 
            
           
          
            − 
           
          
            1 
           
          
            ) 
           
          
            + 
           
          
            1 
           
           
           
             ) 
            
           
             2 
            
           
          
         
        
       
         D = \frac {a^2} {\pi ((n \cdot h)^2 (a^2-1)+1)^2} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.02778em;">D</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.42711em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.49111em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.03588em;">π</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault">h</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">1</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord">1</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.740108em;"><span class="" style="top: -2.989em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord"><span class="mord mathdefault">a</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.814108em;"><span class="" style="top: -3.063em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          a 
         
        
       
         a 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">a</span></span></span></span></span> - 粗糙度</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
       
         n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span></span></span></span></span> - 法线</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          h 
         
        
       
         h 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">h</span></span></span></span></span> - normalize(L + V)，是方向与光源方向的半角向量，这里的光源方向指 计算点到光源的方向，不是光源照射的方向</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
          ⋅ 
         
        
          h 
         
        
       
         n \cdot h 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.44445em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault">h</span></span></span></span></span> - NdotH - 法线与半角向量的点乘</li></ul> 
<p>核心函数</p> 
<pre><code class="prism language-c"><span class="token comment">// #define PI 3.1415926</span>
<span class="token comment">// D 项 法线微表面分布函数</span>
<span class="token keyword">float</span> <span class="token function">D_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> NdotH<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> a2 <span class="token operator">=</span> roughness <span class="token operator">*</span> roughness<span class="token punctuation">;</span>
    <span class="token keyword">float</span> NdotH2 <span class="token operator">=</span> NdotH <span class="token operator">*</span> NdotH<span class="token punctuation">;</span>
    <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token punctuation">(</span>NdotH2 <span class="token operator">*</span> <span class="token punctuation">(</span>a2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d <span class="token operator">=</span> d <span class="token operator">*</span> d<span class="token punctuation">;</span><span class="token comment">// * PI;</span>
    <span class="token keyword">return</span> a2 <span class="token operator">/</span> d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="GGBdesmos_66"></a>GGB(desmos)</h4> 
<p>这次使用的是 desmos 不是 GGM，也是也差不多，可以看到 D_Term 只是一个拟合曲线(只要横向在 0-1 的部分曲线)，来达到近视对应 物理仪器采集的数值对应的模型，下面是可以看到 <code>NdotH</code> 0 - 1 的变化：下压 到 上拱<br> <img src="https://images2.imgbox.com/3f/41/lhH7d0G9_o.gif" alt="在这里插入图片描述"></p> 
<h4><a id="D_Term__Shader_72"></a>D_Term 完整 Shader</h4> 
<pre><code class="prism language-c"><span class="token comment">// jave.lin 2022/01/18</span>
<span class="token comment">// PBR GGX D Term</span>

Shader <span class="token string">"Test/URP_PBR_D_Term"</span>
<span class="token punctuation">{<!-- --></span>
    Properties
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">_Roughness</span> <span class="token punctuation">(</span><span class="token string">"Roughness"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">}</span>
    SubShader
    <span class="token punctuation">{<!-- --></span>
        Tags
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"RenderPipeline"</span> <span class="token operator">=</span> <span class="token string">"UniversalRenderPipeline"</span>
        <span class="token punctuation">}</span>
        Pass
        <span class="token punctuation">{<!-- --></span>
            HLSLPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl"</span></span>
            <span class="token keyword">struct</span> <span class="token class-name">appdata</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionOS <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                half3 normalOS <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionCS <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                half3 normalWS <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 positionWS <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            half _Roughness<span class="token punctuation">;</span>
            <span class="token comment">// #define PI 3.1415926</span>
            <span class="token comment">// D 项 法线微表面分布函数</span>
            <span class="token keyword">float</span> <span class="token function">D_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> NdotH<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">float</span> a2 <span class="token operator">=</span> roughness <span class="token operator">*</span> roughness<span class="token punctuation">;</span>
                <span class="token keyword">float</span> NdotH2 <span class="token operator">=</span> NdotH <span class="token operator">*</span> NdotH<span class="token punctuation">;</span>
                <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token punctuation">(</span>NdotH2 <span class="token operator">*</span> <span class="token punctuation">(</span>a2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                d <span class="token operator">=</span> d <span class="token operator">*</span> d<span class="token punctuation">;</span><span class="token comment">// * PI;</span>
                <span class="token keyword">return</span> a2 <span class="token operator">/</span> d<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionCS <span class="token operator">=</span> <span class="token function">TransformObjectToHClip</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorld</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>normalWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normalOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            half4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">{<!-- --></span>
                half3 N <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>normalWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(N, 1);</span>
                Light mainLight <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>mainLight<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(L, 1);</span>
                half3 V <span class="token operator">=</span> <span class="token function">SafeNormalize</span><span class="token punctuation">(</span>_WorldSpaceCameraPos <span class="token operator">-</span> i<span class="token punctuation">.</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(V, 1);</span>
                half3 H <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>L <span class="token operator">+</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(H, 1);</span>
                half HdotN <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">D_Function</span><span class="token punctuation">(</span>HdotN<span class="token punctuation">,</span> _Roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ENDHLSL
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/4e/24/V8CfsCQF_o.gif" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="G__154"></a>G 项</h3> 
<p>几何函数G，(Geometry function),即核心方程的G项，它是描述入射射线（即光照方向）和出射射线（视线方向）被自己的微观几何形状遮挡的比重。</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          G 
         
        
          = 
         
         
          
          
            n 
           
          
            ⋅ 
           
          
            l 
           
          
          
          
            l 
           
          
            e 
           
          
            r 
           
          
            p 
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            l 
           
          
            , 
           
          
            1 
           
          
            , 
           
          
            k 
           
          
            ) 
           
          
         
        
          × 
         
         
          
          
            n 
           
          
            ⋅ 
           
          
            v 
           
          
          
          
            l 
           
          
            e 
           
          
            r 
           
          
            p 
           
          
            ( 
           
          
            n 
           
          
            ⋅ 
           
          
            v 
           
          
            , 
           
          
            1 
           
          
            , 
           
          
            k 
           
          
            ) 
           
          
         
        
       
         G = \frac {n \cdot l} {lerp(n \cdot l, 1, k)} \times \frac {n \cdot v} {lerp(n \cdot v, 1, k)} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault">G</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 2.30744em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.37144em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 2.05745em; vertical-align: -0.936em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 1.12145em;"><span class="" style="top: -2.314em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span><span class="mclose">)</span></span></span><span class="" style="top: -3.23em;"><span class="pstrut" style="height: 3em;"></span><span class="frac-line" style="border-bottom-width: 0.04em;"></span></span><span class="" style="top: -3.677em;"><span class="pstrut" style="height: 3em;"></span><span class="mord"><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.936em;"><span class=""></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></span></p> 
<ul><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          n 
         
        
       
         n 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.43056em; vertical-align: 0em;"></span><span class="mord mathdefault">n</span></span></span></span></span> - 法线</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          l 
         
        
       
         l 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span></span></span></span></span> - 灯光方向（不是入射方向，即：入射反向，从计算点到光源的方向）</li><li><span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          k 
         
        
       
         k 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.03148em;">k</span></span></span></span></span> - NdotL 的过去系数，这里使用拟合曲线：<code>float k = pow(1 + roughness, 2) * 0.5;</code>，下面的 GGB 有图形化该曲线样式</li></ul> 
<p>G项是由2个几乎一样的子项相乘得来，故我们可以先定义子项的函数</p> 
<pre><code class="prism language-c"><span class="token comment">// G项子项</span>
<span class="token keyword">inline</span> <span class="token keyword">float</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span><span class="token keyword">float</span> dot<span class="token punctuation">,</span> <span class="token keyword">float</span> k<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> dot <span class="token operator">/</span> <span class="token function">lerp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>再去定义真正的G项，把<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         o 
        
       
         t 
        
       
         ( 
        
       
         N 
        
       
         , 
        
       
         L 
        
       
         ) 
        
       
      
        dot(N, L) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">L</span><span class="mclose">)</span></span></span></span></span>和<span class="katex--inline"><span class="katex"><span class="katex-mathml"> 
     
      
       
       
         d 
        
       
         o 
        
       
         t 
        
       
         ( 
        
       
         N 
        
       
         , 
        
       
         V 
        
       
         ) 
        
       
      
        dot(N, V) 
       
      
    </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault">d</span><span class="mord mathdefault">o</span><span class="mord mathdefault">t</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.10903em;">N</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.22222em;">V</span><span class="mclose">)</span></span></span></span></span>代入子项，相乘即可</p> 
<pre><code class="prism language-c"><span class="token comment">// G项</span>
 <span class="token keyword">float</span> <span class="token function">G_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> NdotL<span class="token punctuation">,</span> <span class="token keyword">float</span> NdotV<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">)</span>
 <span class="token punctuation">{<!-- --></span>
     <span class="token comment">// method1-k:</span>
     <span class="token comment">// // float k = pow(1 + roughness, 2) / 8.0;</span>

     <span class="token comment">// // method2-k:</span>
     <span class="token comment">// const float d = 1.0 / 8.0;</span>
     <span class="token comment">// float k = pow(1 + roughness, 2) * d;</span>

     <span class="token comment">// method3-k:</span>
     <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> roughness<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span>NdotV<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>
</code></pre> 
<h4><a id="GGB_194"></a>GGB</h4> 
<p>k 曲线，变量 roughness 在 <code>0~1</code> 的范围，值域为：<code>0.5~2.0</code><br> <img src="https://images2.imgbox.com/f9/f5/1yv8Uu0y_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="G_Term__Shader_198"></a>G_Term 完整 Shader</h4> 
<pre><code class="prism language-c"><span class="token comment">// jave.lin 2022/01/19</span>
<span class="token comment">// PBR G Term</span>

Shader <span class="token string">"Test/URP_PBR_G_Term"</span>
<span class="token punctuation">{<!-- --></span>
    Properties
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">_Roughness</span> <span class="token punctuation">(</span><span class="token string">"Roughness"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">}</span>
    SubShader
    <span class="token punctuation">{<!-- --></span>
        Tags
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"RenderPipeline"</span> <span class="token operator">=</span> <span class="token string">"UniversalRenderPipeline"</span>
        <span class="token punctuation">}</span>
        Pass
        <span class="token punctuation">{<!-- --></span>
            HLSLPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl"</span></span>
            <span class="token keyword">struct</span> <span class="token class-name">appdata</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionOS <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                half3 normalOS <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionCS <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                half3 normalWS <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 positionWS <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            half _Roughness<span class="token punctuation">;</span>
            <span class="token comment">// G项子项</span>
            <span class="token keyword">inline</span> <span class="token keyword">float</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span><span class="token keyword">float</span> dot<span class="token punctuation">,</span> <span class="token keyword">float</span> k<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> dot <span class="token operator">/</span> <span class="token function">lerp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// G项</span>
            <span class="token keyword">float</span> <span class="token function">G_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> NdotL<span class="token punctuation">,</span> <span class="token keyword">float</span> NdotV<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// method1-k:</span>
                <span class="token comment">// // float k = pow(1 + roughness, 2) / 8.0;</span>

                <span class="token comment">// // method2-k:</span>
                <span class="token comment">// const float d = 1.0 / 8.0;</span>
                <span class="token comment">// float k = pow(1 + roughness, 2) * d;</span>

                <span class="token comment">// method3-k:</span>
                <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> roughness<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span>NdotV<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionCS <span class="token operator">=</span> <span class="token function">TransformObjectToHClip</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorld</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>normalWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normalOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            half4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">{<!-- --></span>
                half3 N <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>normalWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(N, 1);</span>
                Light mainLight <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>mainLight<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(L, 1);</span>
                half3 V <span class="token operator">=</span> <span class="token function">SafeNormalize</span><span class="token punctuation">(</span>_WorldSpaceCameraPos <span class="token operator">-</span> i<span class="token punctuation">.</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(V, 1);</span>
                <span class="token comment">// half3 H = normalize(L + V);</span>
                <span class="token comment">// return half4(H, 1);</span>
                half NdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half NdotV <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">G_Function</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> NdotV<span class="token punctuation">,</span> _Roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ENDHLSL
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/e8/20/xsCS1OjN_o.gif" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="F__287"></a>F 项</h3> 
<p>菲涅尔函数F(Fresnel equation),即核心方程的F项</p> 
<p>菲涅尔反射（Fresnel Reflectance）。光线以不同角度入射会有不同的反射率。相同的入射角度，不同的物质也会有不同的反射率。万物皆有菲涅尔反射。<strong>F0</strong>是即 0 度角入射的菲涅尔反射值。大多数<strong>非金属</strong>的<strong>F0</strong>范围是 <code>0.02 - 0.04</code>，大多数<strong>金属</strong>的<strong>F0</strong>范围是 <code>0.7 - 1.0</code>。</p> 
<p>如下图（UE4 PBR文档的图片）：<br> <img src="https://images2.imgbox.com/fa/72/3yKE5kVT_o.png" alt="在这里插入图片描述"></p> 
<p>下面是 Schlick 的模型的公式对应的代码：</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          F 
         
        
          = 
         
        
          l 
         
        
          e 
         
        
          r 
         
        
          p 
         
        
          ( 
         
        
          ( 
         
        
          1 
         
        
          − 
         
        
          ( 
         
        
          n 
         
        
          ⋅ 
         
        
          v 
         
        
          ) 
         
         
         
           ) 
          
         
           5 
          
         
        
          , 
         
        
          1 
         
        
          , 
         
         
         
           F 
          
         
           0 
          
         
        
          ) 
         
        
       
         F = lerp((1-(n \cdot v))^5, 1, F_0) 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.68333em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault">e</span><span class="mord mathdefault" style="margin-right: 0.02778em;">r</span><span class="mord mathdefault">p</span><span class="mopen">(</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">n</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></span></p> 
<p>但是由于我们需要的法线方向并不是模型本身的宏观法线n，而是经过D项筛选通过的微观法线H，故需把N改成H，再将 Schlick 调整为如下数学公式（为何我觉得上面的公司更为直观，-_-，大概是因为更代码化）</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           F 
          
          
          
            S 
           
          
            c 
           
          
            h 
           
          
            l 
           
          
            i 
           
          
            c 
           
          
            k 
           
          
         
        
          ( 
         
        
          h 
         
        
          , 
         
        
          v 
         
        
          , 
         
         
         
           F 
          
         
           0 
          
         
        
          ) 
         
        
          = 
         
         
         
           F 
          
         
           0 
          
         
        
          + 
         
        
          ( 
         
        
          1 
         
        
          − 
         
         
         
           F 
          
         
           0 
          
         
        
          ) 
         
        
          ( 
         
        
          1 
         
        
          − 
         
        
          ( 
         
        
          h 
         
        
          ⋅ 
         
        
          v 
         
        
          ) 
         
         
         
           ) 
          
         
           5 
          
         
        
       
         F_{Schlick} (h, v, F_0) = F_0 + (1 - F_0)(1 - (h \cdot v))^5 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.336108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.05764em;">S</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight">h</span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">i</span><span class="mord mathdefault mtight">c</span><span class="mord mathdefault mtight" style="margin-right: 0.03148em;">k</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathdefault">h</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord mathdefault">h</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.03588em;">v</span><span class="mclose">)</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>后来unity对它进行了优化(<a href="http://filmicworlds.com/blog/optimizing-ggx-shaders-with-dotlh/" rel="nofollow">Optimizing GGX Shaders with dot(L,H)</a>)，视线方向V换成了L，如下所示，这是我们所使用的函数</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
        
          F 
         
        
          ( 
         
        
          l 
         
        
          , 
         
        
          h 
         
        
          ) 
         
        
          = 
         
         
         
           F 
          
         
           0 
          
         
        
          + 
         
        
          ( 
         
        
          1 
         
        
          − 
         
         
         
           F 
          
         
           0 
          
         
        
          ) 
         
        
          ( 
         
        
          1 
         
        
          − 
         
        
          l 
         
        
          ⋅ 
         
        
          h 
         
         
         
           ) 
          
         
           5 
          
         
        
       
         F(l, h) = F_0 + (1 - F_0) (1 - l \cdot h)^5 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="mopen">(</span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right: 0.166667em;"></span><span class="mord mathdefault">h</span><span class="mclose">)</span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.83333em; vertical-align: -0.15em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1em; vertical-align: -0.25em;"></span><span class="mord"><span class="mord mathdefault" style="margin-right: 0.13889em;">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height: 0.301108em;"><span class="" style="top: -2.55em; margin-left: -0.13889em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height: 0.15em;"><span class=""></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 0.69444em; vertical-align: 0em;"></span><span class="mord mathdefault" style="margin-right: 0.01968em;">l</span><span class="mspace" style="margin-right: 0.222222em;"></span><span class="mbin">⋅</span><span class="mspace" style="margin-right: 0.222222em;"></span></span><span class="base"><span class="strut" style="height: 1.11411em; vertical-align: -0.25em;"></span><span class="mord mathdefault">h</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.864108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>其中的5次方计算量比较大，把它变成自然对数函数进行计算可以节省计算量，后续文章里所有的5次方计算都可以换算成对数计算</p> 
<p><span class="katex--display"><span class="katex-display"><span class="katex"><span class="katex-mathml"> 
      
       
        
         
         
           x 
          
         
           y 
          
         
        
          = 
         
         
         
           e 
          
          
          
            y 
           
          
              
           
          
            l 
           
          
            n 
           
          
              
           
          
            x 
           
          
         
        
       
         x^y = e^{y \space ln \space x} 
        
       
     </span><span class="katex-html"><span class="base"><span class="strut" style="height: 0.714392em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.714392em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right: 0.277778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right: 0.277778em;"></span></span><span class="base"><span class="strut" style="height: 0.899108em; vertical-align: 0em;"></span><span class="mord"><span class="mord mathdefault">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height: 0.899108em;"><span class="" style="top: -3.113em; margin-right: 0.05em;"><span class="pstrut" style="height: 2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathdefault mtight" style="margin-right: 0.03588em;">y</span><span class="mspace mtight"><span class="mtight"> </span></span><span class="mord mathdefault mtight" style="margin-right: 0.01968em;">l</span><span class="mord mathdefault mtight">n</span><span class="mspace mtight"><span class="mtight"> </span></span><span class="mord mathdefault mtight">x</span></span></span></span></span></span></span></span></span></span></span></span></span></span></p> 
<p>故最终，我们的菲涅尔函数如下。</p> 
<pre><code class="prism language-c"><span class="token comment">// method1:</span>
<span class="token comment">// F项</span>

<span class="token keyword">inline</span> half3 <span class="token function">F0_Function</span><span class="token punctuation">(</span>half3 albedo<span class="token punctuation">,</span> half metallic<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// jave.lin :</span>
    <span class="token comment">// 非金属一般都是纯灰度：0.02 ~ 0.04</span>
    <span class="token comment">// 金属一般都是纯颜色：0.7 ~ 1.0 之间的，这里我们简单的使用一个 lerp 来模拟</span>
    <span class="token comment">// 后续其他版本的 pbr 可以调整为更加效果的</span>
    <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">0.04</span><span class="token punctuation">,</span> albedo<span class="token punctuation">,</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

half3 <span class="token function">F_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> HdotL<span class="token punctuation">,</span> half3 F<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// jave.lin : (1-x)^5 转为性能更高的来模拟：2^((-5.55473 * x- 6.98316) * x)</span>
    half Fre <span class="token operator">=</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5.55473</span> <span class="token operator">*</span> HdotL <span class="token operator">-</span> <span class="token number">6.98316</span><span class="token punctuation">)</span> <span class="token operator">*</span> HdotL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>Fre<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// // method2:</span>
<span class="token comment">// // F项</span>
<span class="token comment">// half3 F_Function(float HdotL, half3 F)</span>
<span class="token comment">// {<!-- --></span>
<span class="token comment">//     half Fre = pow(1 - HdotL, 5);</span>
<span class="token comment">//     return lerp(Fre, 1, F);</span>
<span class="token comment">// }</span>
</code></pre> 
<h4><a id="GGB_352"></a>GGB</h4> 
<p><img src="https://images2.imgbox.com/aa/fd/LoyaL2Dg_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b9/28/uTH6S618_o.gif" alt="在这里插入图片描述"></p> 
<h4><a id="F_Term__Shader_358"></a>F_Term 完整 Shader</h4> 
<pre><code class="prism language-c"><span class="token comment">// jave.lin 2022/01/19</span>
<span class="token comment">// PBR F Term</span>

Shader <span class="token string">"Test/URP_PBR_F_Term"</span>
<span class="token punctuation">{<!-- --></span>
    Properties
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Metallic</span> <span class="token punctuation">(</span><span class="token string">"_Metallic"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">}</span>
    SubShader
    <span class="token punctuation">{<!-- --></span>
        Tags
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"RenderPipeline"</span> <span class="token operator">=</span> <span class="token string">"UniversalRenderPipeline"</span>
        <span class="token punctuation">}</span>
        Pass
        <span class="token punctuation">{<!-- --></span>
            HLSLPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl"</span></span>
            <span class="token keyword">struct</span> <span class="token class-name">appdata</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionOS <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                half3 normalOS <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionCS <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                half3 normalWS <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 positionWS <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            half4 _Color<span class="token punctuation">;</span>
            half _Metallic<span class="token punctuation">;</span>

            <span class="token comment">// method1:</span>
            <span class="token comment">// F项</span>

            <span class="token keyword">inline</span> half3 <span class="token function">F0_Function</span><span class="token punctuation">(</span>half3 albedo<span class="token punctuation">,</span> half metallic<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// jave.lin :</span>
                <span class="token comment">// 非金属一般都是纯灰度：0.02 ~ 0.04</span>
                <span class="token comment">// 金属一般都是纯颜色：0.7 ~ 1.0 之间的，这里我们简单的使用一个 lerp 来模拟</span>
                <span class="token comment">// 后续其他版本的 pbr 可以调整为更加效果的</span>
                <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">0.04</span><span class="token punctuation">,</span> albedo<span class="token punctuation">,</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            half3 <span class="token function">F_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> HdotL<span class="token punctuation">,</span> half3 F<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// jave.lin : (1-x)^5 转为性能更高的来模拟：2^((-5.55473 * x- 6.98316) * x)</span>
                half Fre <span class="token operator">=</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5.55473</span> <span class="token operator">*</span> HdotL <span class="token operator">-</span> <span class="token number">6.98316</span><span class="token punctuation">)</span> <span class="token operator">*</span> HdotL<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>Fre<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// // method2:</span>
            <span class="token comment">// // F项</span>
            <span class="token comment">// half3 F_Function(float HdotL, half3 F)</span>
            <span class="token comment">// {<!-- --></span>
            <span class="token comment">//     half Fre = pow(1 - HdotL, 5);</span>
            <span class="token comment">//     return lerp(Fre, 1, F);</span>
            <span class="token comment">// }</span>
            
            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionCS <span class="token operator">=</span> <span class="token function">TransformObjectToHClip</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorld</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>normalWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normalOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            half4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// half3 N = normalize(i.normalWS);</span>
                <span class="token comment">// return half4(N, 1);</span>
                Light mainLight <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>mainLight<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(L, 1);</span>
                half3 V <span class="token operator">=</span> <span class="token function">SafeNormalize</span><span class="token punctuation">(</span>_WorldSpaceCameraPos <span class="token operator">-</span> i<span class="token punctuation">.</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(V, 1);</span>
                half3 H <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>L <span class="token operator">+</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(H, 1);</span>
                <span class="token comment">// half3 F = lerp(0.04, _Color.rgb, _Metallic);</span>
                half HdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 F <span class="token operator">=</span> <span class="token function">F0_Function</span><span class="token punctuation">(</span>_Color<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> _Metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">half4</span><span class="token punctuation">(</span><span class="token function">F_Function</span><span class="token punctuation">(</span>HdotL<span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            ENDHLSL
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/b1/4f/UyG3c5kO_o.gif" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="D_G_F__459"></a>D, G, F 带入公式</h3> 
<p>直接光的高光部分：我们把D,G,F代入公式，先计算出高光部分。注意这里经过半球积分后会乘PI，不要丢了；注意这里并未再次乘KS，因为KS=F，已经计算过了一次不需要重复计算。</p> 
<pre><code class="prism language-c">halfHdotN <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
half NdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
half NdotV <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
half HdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// ======= Direct START ======</span>

half3 F <span class="token operator">=</span> <span class="token function">F0_Function</span><span class="token punctuation">(</span>_Color<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> _Metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
half Direct_D <span class="token operator">=</span> <span class="token function">D_Function</span><span class="token punctuation">(</span>HdotN<span class="token punctuation">,</span> _Roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
half Direct_G <span class="token operator">=</span> <span class="token function">G_Function</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> NdotV<span class="token punctuation">,</span> _Roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
half3 Direct_F <span class="token operator">=</span> <span class="token function">F_Function</span><span class="token punctuation">(</span>HdotL<span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
half3 BRDFSpecSection <span class="token operator">=</span> <span class="token punctuation">(</span>Direct_D <span class="token operator">*</span> Direct_G<span class="token punctuation">)</span> <span class="token operator">*</span> Direct_F <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> NdotL <span class="token operator">*</span> NdotV<span class="token punctuation">)</span><span class="token punctuation">;</span>
half3 DirectSpeColor <span class="token operator">=</span> BRDFSpecSection <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>color <span class="token operator">*</span> NdotL <span class="token operator">*</span> PI<span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token function">half4</span><span class="token punctuation">(</span>DirectSpeColor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// ======= Direct END ======</span>
</code></pre> 
<h4><a id="PBR_Test_DGFhlsl_482"></a>PBR_Test_DGF.hlsl</h4> 
<pre><code class="prism language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__PBR_TEST_DGF_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__PBR_TEST_DGF_H__</span></span>

<span class="token comment">// jave.lin : 2022/01/19</span>

half4 _Color<span class="token punctuation">;</span>
half _Metallic<span class="token punctuation">;</span>
half _Roughness<span class="token punctuation">;</span> <span class="token comment">// 后续改到 ubo / cbuffer 中</span>

<span class="token comment">// D 项 法线微表面分布函数</span>
<span class="token keyword">float</span> <span class="token function">D_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> NdotH<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">float</span> a2 <span class="token operator">=</span> roughness <span class="token operator">*</span> roughness<span class="token punctuation">;</span>
    <span class="token keyword">float</span> NdotH2 <span class="token operator">=</span> NdotH <span class="token operator">*</span> NdotH<span class="token punctuation">;</span>
    <span class="token keyword">float</span> d <span class="token operator">=</span> <span class="token punctuation">(</span>NdotH2 <span class="token operator">*</span> <span class="token punctuation">(</span>a2 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    d <span class="token operator">=</span> d <span class="token operator">*</span> d<span class="token punctuation">;</span><span class="token comment">// * PI;</span>
    <span class="token keyword">return</span> a2 <span class="token operator">/</span> d<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// G项子项</span>
<span class="token keyword">inline</span> <span class="token keyword">float</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span><span class="token keyword">float</span> dot<span class="token punctuation">,</span> <span class="token keyword">float</span> k<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> dot <span class="token operator">/</span> <span class="token function">lerp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// G项</span>
<span class="token keyword">float</span> <span class="token function">G_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> NdotL<span class="token punctuation">,</span> <span class="token keyword">float</span> NdotV<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// method1-k:</span>
    <span class="token comment">// // float k = pow(1 + roughness, 2) / 8.0;</span>

    <span class="token comment">// // method2-k:</span>
    <span class="token comment">// const float d = 1.0 / 8.0;</span>
    <span class="token comment">// float k = pow(1 + roughness, 2) * d;</span>

    <span class="token comment">// method3-k:</span>
    <span class="token keyword">float</span> k <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> roughness<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">G_subSection</span><span class="token punctuation">(</span>NdotV<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// method1:</span>
<span class="token comment">// F项</span>
half3 <span class="token function">F_Function</span><span class="token punctuation">(</span><span class="token keyword">float</span> HdotL<span class="token punctuation">,</span> half3 F0<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// jave.lin : (1-x)^5 转为性能更高的来模拟：2^((-5.55473 * x- 6.98316) * x)</span>
    half Fre <span class="token operator">=</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5.55473</span> <span class="token operator">*</span> HdotL <span class="token operator">-</span> <span class="token number">6.98316</span><span class="token punctuation">)</span> <span class="token operator">*</span> HdotL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>Fre<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F0<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// // method2:</span>
<span class="token comment">// // F项</span>
<span class="token comment">// half F_Function(float HdotL, half F0)</span>
<span class="token comment">// {<!-- --></span>
<span class="token comment">//     half Fre = pow(1 - HdotL, 5);</span>
<span class="token comment">//     return lerp(Fre, 1, F0);</span>
<span class="token comment">// }</span>

<span class="token keyword">inline</span> half3 <span class="token function">F0_Function</span><span class="token punctuation">(</span>half3 albedo<span class="token punctuation">,</span> half metallic<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token comment">// jave.lin :</span>
    <span class="token comment">// 非金属一般都是纯灰度：0.02 ~ 0.04</span>
    <span class="token comment">// 金属一般都是纯颜色：0.7 ~ 1.0 之间的，这里我们简单的使用一个 lerp 来模拟</span>
    <span class="token comment">// 后续其他版本的 pbr 可以调整为更加效果的</span>
    <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">0.04</span><span class="token punctuation">,</span> albedo<span class="token punctuation">,</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<h4><a id="DGF_Term_552"></a>DGF_Term</h4> 
<pre><code class="prism language-c"><span class="token comment">// jave.lin 2022/01/19</span>
<span class="token comment">// PBR DGF Term</span>

Shader <span class="token string">"Test/URP_PBR_DGF_Term"</span>
<span class="token punctuation">{<!-- --></span>
    Properties
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">_Color</span> <span class="token punctuation">(</span><span class="token string">"Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_Metallic</span> <span class="token punctuation">(</span><span class="token string">"Metallic"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
        <span class="token function">_Roughness</span> <span class="token punctuation">(</span><span class="token string">"Roughness"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0.5</span>
    <span class="token punctuation">}</span>
    SubShader
    <span class="token punctuation">{<!-- --></span>
        Tags
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"RenderPipeline"</span> <span class="token operator">=</span> <span class="token string">"UniversalRenderPipeline"</span>
        <span class="token punctuation">}</span>
        Pass
        <span class="token punctuation">{<!-- --></span>
            HLSLPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl"</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Includes/PBR_Test_DGF.hlsl"</span></span>
            <span class="token keyword">struct</span> <span class="token class-name">appdata</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionOS <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
                half3 normalOS <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
            <span class="token punctuation">{<!-- --></span>
                float4 positionCS <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
                half3 normalWS <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
                float3 positionWS <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            v2f <span class="token function">vert</span> <span class="token punctuation">(</span>appdata v<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                v2f o<span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionCS <span class="token operator">=</span> <span class="token function">TransformObjectToHClip</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>positionWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorld</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                o<span class="token punctuation">.</span>normalWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorldNormal</span><span class="token punctuation">(</span>v<span class="token punctuation">.</span>normalOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> o<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            half4 <span class="token function">frag</span> <span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
            <span class="token punctuation">{<!-- --></span>
                half3 N <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>normalWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(N, 1);</span>
                Light mainLight <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>mainLight<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(L, 1);</span>
                half3 V <span class="token operator">=</span> <span class="token function">SafeNormalize</span><span class="token punctuation">(</span>_WorldSpaceCameraPos <span class="token operator">-</span> i<span class="token punctuation">.</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(V, 1);</span>
                half3 H <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>L <span class="token operator">+</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// return half4(H, 1);</span>
                half HdotN <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half NdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half NdotV <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                half HdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// ======= Direct START ======</span>

                half3 F <span class="token operator">=</span> <span class="token function">F0_Function</span><span class="token punctuation">(</span>_Color<span class="token punctuation">.</span>rgb<span class="token punctuation">,</span> _Metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                half Direct_D <span class="token operator">=</span> <span class="token function">D_Function</span><span class="token punctuation">(</span>HdotN<span class="token punctuation">,</span> _Roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
                half Direct_G <span class="token operator">=</span> <span class="token function">G_Function</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> NdotV<span class="token punctuation">,</span> _Roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 Direct_F <span class="token operator">=</span> <span class="token function">F_Function</span><span class="token punctuation">(</span>HdotL<span class="token punctuation">,</span> F<span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 BRDFSpecSection <span class="token operator">=</span> <span class="token punctuation">(</span>Direct_D <span class="token operator">*</span> Direct_G<span class="token punctuation">)</span> <span class="token operator">*</span> Direct_F <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> NdotL <span class="token operator">*</span> NdotV<span class="token punctuation">)</span><span class="token punctuation">;</span>
                half3 DirectSpeColor <span class="token operator">=</span> BRDFSpecSection <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>color <span class="token operator">*</span> NdotL <span class="token operator">*</span> PI<span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token function">half4</span><span class="token punctuation">(</span>DirectSpeColor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ======= Direct END ======</span>

            <span class="token punctuation">}</span>
            ENDHLSL
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/df/1b/2OuPLJPD_o.gif" alt="在这里插入图片描述"></p> 
<hr> 
<h2><a id="_PBR__637"></a>应用到具体 PBR 素材上</h2> 
<p><a href="https://pan.baidu.com/s/1qjGXJn3zabI8Okxs88zuiw" rel="nofollow">Vela 提供的模型</a> - 已备份到百度网盘，但不公开（700MB+）</p> 
<p>在 substance 官方也可以直接下载到：<a href="https://share-legacy.substance3d.com/libraries/1633" rel="nofollow">Vela Template</a></p> 
<p>左边是：SP，右边是 Unity URP 的 Custom PBR Shader（法线是 F0 的模拟效果不太理想，后续可以将 F0 修改为一些一些色阶图来返回 F0 的纯灰度 或是 纯金属的反射颜色才比较好的效果）</p> 
<p>天空盒 和 灯光方向、颜色、等参数都不太一样，所以效果差异就更大了<br> <img src="https://images2.imgbox.com/8e/49/W9suun29_o.png" alt="在这里插入图片描述"></p> 
<hr> 
<h3><a id="_Shader___PBR__SHReflection_Probe__Emissive_649"></a>完整 Shader - 只有 PBR + SH(Reflection Probe) + Emissive</h3> 
<p>阴影还没添加，后续再添加了</p> 
<hr> 
<h4><a id="PBR__Emissive_Libhlsl_654"></a>PBR__Emissive_Lib.hlsl</h4> 
<pre><code class="prism language-c">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__PBR_Emissive_LIB_H__</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__PBR_Emissive_LIB_H__</span></span>

    <span class="token comment">// #ifdef HAS_HALF</span>
    <span class="token comment">// #undef HAS_HALF</span>
    <span class="token comment">// #define HAS_HALF 1</span>
    <span class="token comment">// #endif</span>
    <span class="token comment">// jave.lin : 2022/02/06</span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Core.hlsl"</span></span>
    <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Packages/com.unity.render-pipelines.universal/ShaderLibrary/Lighting.hlsl"</span></span>
            

    <span class="token keyword">struct</span> <span class="token class-name">a2v</span>
    <span class="token punctuation">{<!-- --></span>
        float4 positionOS <span class="token operator">:</span> POSITION<span class="token punctuation">;</span>
        float2 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span>
        half3 normalOS <span class="token operator">:</span> NORMAL<span class="token punctuation">;</span>
        half4 tangentOS <span class="token operator">:</span> TANGENT<span class="token punctuation">;</span>
        float2 lightmapUV <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">struct</span> <span class="token class-name">v2f</span>
    <span class="token punctuation">{<!-- --></span>
        float4 positionCS <span class="token operator">:</span> SV_POSITION<span class="token punctuation">;</span>
        float4 uv <span class="token operator">:</span> TEXCOORD0<span class="token punctuation">;</span> <span class="token comment">// xy: base map uv, zw: lightmap uv</span>
        float4 normalWS <span class="token operator">:</span> TEXCOORD1<span class="token punctuation">;</span> <span class="token comment">// w: posWS.x</span>
        float4 tangentWS <span class="token operator">:</span> TEXCOORD2<span class="token punctuation">;</span> <span class="token comment">// w: posWS.y</span>
        float4 bitangentWS <span class="token operator">:</span> TEXCOORD3<span class="token punctuation">;</span> <span class="token comment">// w: posWS.z</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token function">TEXTURE2D</span><span class="token punctuation">(</span>_BaseMap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SAMPLER</span><span class="token punctuation">(</span>sampler_BaseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TEXTURE2D</span><span class="token punctuation">(</span>_MaskMap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SAMPLER</span><span class="token punctuation">(</span>sampler_MaskMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TEXTURE2D</span><span class="token punctuation">(</span>_NormalMap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SAMPLER</span><span class="token punctuation">(</span>sampler_NormalMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">TEXTURE2D</span><span class="token punctuation">(</span>_EmissiveMap<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token function">SAMPLER</span><span class="token punctuation">(</span>sampler_EmissiveMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">CBUFFER_START</span><span class="token punctuation">(</span>UnityPerMaterial<span class="token punctuation">)</span>
    float4 _BaseMap_ST<span class="token punctuation">;</span>
    half4 _BaseColor<span class="token punctuation">;</span>
    half _Metallic<span class="token punctuation">;</span>
    half _AO<span class="token punctuation">;</span>
    half _Roughness<span class="token punctuation">;</span>
    half _NormalScale<span class="token punctuation">;</span>
    half _Emissive<span class="token punctuation">;</span>
    half _EmissiveTwinkleFrequence<span class="token punctuation">;</span>
    CBUFFER_END

    <span class="token comment">// ========== Direct START =============</span>
    <span class="token comment">// 直接光照部分</span>

    <span class="token comment">// ========== 直接光照 D项 START =============</span>
    <span class="token comment">// 直接光照 D项 法线微表面分布函数</span>
    half <span class="token function">Direct_D_Function</span><span class="token punctuation">(</span>half NdotH<span class="token punctuation">,</span> half roughness<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        half a2 <span class="token operator">=</span> <span class="token function">Pow4</span><span class="token punctuation">(</span>roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half d <span class="token operator">=</span> <span class="token punctuation">(</span>NdotH <span class="token operator">*</span> NdotH <span class="token operator">*</span> <span class="token punctuation">(</span>a2 <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        d <span class="token operator">=</span> d <span class="token operator">*</span> d<span class="token punctuation">;</span><span class="token comment">// *PI;</span>
        <span class="token keyword">return</span> <span class="token function">saturate</span><span class="token punctuation">(</span>a2 <span class="token operator">/</span> d<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ========== 直接光照 D项 END =============</span>

    <span class="token comment">// ========== 直接光照 G项 START =============</span>
    <span class="token comment">// 直接光照 G项子项</span>
    <span class="token keyword">inline</span> real <span class="token function">Direct_G_subSection</span><span class="token punctuation">(</span>half dot<span class="token punctuation">,</span> half k<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> dot <span class="token operator">/</span> <span class="token function">lerp</span><span class="token punctuation">(</span>dot<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 直接光照 G项</span>
    half <span class="token function">Direct_G_Function</span><span class="token punctuation">(</span>half NdotL<span class="token punctuation">,</span> half NdotV<span class="token punctuation">,</span> half roughness<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// method1-k:</span>
        <span class="token comment">// // half k = pow(1 + roughness, 2) / 8.0;</span>

        <span class="token comment">// // method2-k:</span>
        <span class="token comment">// const half d = 1.0 / 8.0;</span>
        <span class="token comment">// half k = pow(1 + roughness, 2) * d;</span>

        <span class="token comment">// method3-k:</span>
        half k <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> roughness<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Direct_G_subSection</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> k<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">Direct_G_subSection</span><span class="token punctuation">(</span>NdotV<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 模拟 G项:Kelemen-Szirmay-Kalos Geometry Factor</span>
    <span class="token comment">// http://renderwonk.com/publications/s2010-shading-course/hoffman/s2010_physically_based_shading_hoffman_b.pdf</span>
    <span class="token comment">// 搜索：Kelemen-Szirmay-Kalos Geometry Factor</span>
    <span class="token keyword">inline</span> half <span class="token function">Direct_G_Function_Kalos</span><span class="token punctuation">(</span>half LdotH<span class="token punctuation">,</span> half roughness<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        half k <span class="token operator">=</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> roughness<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">Direct_G_subSection</span><span class="token punctuation">(</span>LdotH<span class="token punctuation">,</span> k<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ========== 直接光照 G项 END =============</span>

    <span class="token comment">// ========== 直接光照 F项 START =============</span>
    <span class="token comment">// method1:</span>
    <span class="token comment">// 直接光照 F项</span>
    half3 <span class="token function">Direct_F_Function</span><span class="token punctuation">(</span>half HdotL<span class="token punctuation">,</span> half3 F0<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        half Fre <span class="token operator">=</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5.55473</span> <span class="token operator">*</span> HdotL <span class="token operator">-</span> <span class="token number">6.98316</span><span class="token punctuation">)</span> <span class="token operator">*</span> HdotL<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>Fre<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> F0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// // method2:</span>
    <span class="token comment">// // 直接光照 F项</span>
    <span class="token comment">// half3 Direct_F_Function(half HdotL, half3 F0)</span>
    <span class="token comment">// {<!-- --></span>
        <span class="token comment">//     half Fre = pow(1 - HdotL, 5);</span>
        <span class="token comment">//     return lerp(Fre, 1, F0);</span>
    <span class="token comment">// }</span>
    <span class="token comment">// ========== 直接光照 F项 END =============</span>

    <span class="token comment">// ========== 直接光照 F0 START =============</span>
    <span class="token keyword">inline</span> half3 <span class="token function">Direct_F0_Function</span><span class="token punctuation">(</span>half3 albedo<span class="token punctuation">,</span> half metallic<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">0.04</span><span class="token punctuation">,</span> albedo<span class="token punctuation">,</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ========== 直接光照 F0 END =============</span>


    <span class="token comment">// ========== Direct END =============</span>

    <span class="token comment">// ========== Indirect START =============</span>

    real3 <span class="token function">SH_IndirectionDiff</span><span class="token punctuation">(</span>real3 normalWS<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        real4 SHCoefficients<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHAr<span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHAg<span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHAb<span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHBr<span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHBg<span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHBb<span class="token punctuation">;</span>
        SHCoefficients<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> unity_SHC<span class="token punctuation">;</span>
        real3 color <span class="token operator">=</span> <span class="token function">SampleSH9</span><span class="token punctuation">(</span>SHCoefficients<span class="token punctuation">,</span> normalWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> color<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    half3 <span class="token function">Indirect_F_Function</span><span class="token punctuation">(</span>half NdotV<span class="token punctuation">,</span> half3 F0<span class="token punctuation">,</span> half roughness<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        half fre <span class="token operator">=</span> <span class="token function">exp2</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">5.55473</span> <span class="token operator">*</span> NdotV <span class="token operator">-</span> <span class="token number">6.98316</span><span class="token punctuation">)</span> <span class="token operator">*</span> NdotV<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> F0 <span class="token operator">+</span> fre <span class="token operator">*</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> roughness <span class="token operator">-</span> F0<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    half3 <span class="token function">IndirectSpeCube</span><span class="token punctuation">(</span>half3 normalWS<span class="token punctuation">,</span> half3 viewWS<span class="token punctuation">,</span> <span class="token keyword">float</span> roughness<span class="token punctuation">,</span> half AO<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        half3 reflectDirWS <span class="token operator">=</span> <span class="token function">reflect</span><span class="token punctuation">(</span><span class="token operator">-</span>viewWS<span class="token punctuation">,</span> normalWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        roughness <span class="token operator">=</span> roughness <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1.7</span> <span class="token operator">-</span> <span class="token number">0.7</span> <span class="token operator">*</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// unity 内部不是线性 调整下 拟合曲线求近似，可以再 GGB 可视化曲线</span>
        half mipmapLevel <span class="token operator">=</span> roughness <span class="token operator">*</span> <span class="token number">6</span><span class="token punctuation">;</span> <span class="token comment">// 把粗糙度 remap 到 0~6 的 7个阶段，然后进行 texture lod 采样</span>
        half4 specularColor <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURECUBE_LOD</span><span class="token punctuation">(</span>unity_SpecCube0<span class="token punctuation">,</span> samplerunity_SpecCube0<span class="token punctuation">,</span> reflectDirWS<span class="token punctuation">,</span> mipmapLevel<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 根据不同的 mipmap level 等级进行采样</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token operator">!</span><span class="token function">defined</span><span class="token punctuation">(</span>UNITY_USE_NATIVE_HDR<span class="token punctuation">)</span></span></span>
        <span class="token comment">// 用 DecodeHDREnvironment 将解码 HDR 颜色值。</span>
        <span class="token comment">// 可以看到采样出的 RGBM 是一个 4 通道的值</span>
        <span class="token comment">// 最后的一个 M 存的是一个参数</span>
        <span class="token comment">// 解码时将前三个通道表示的颜色乘上 x*(M^y)</span>
        <span class="token comment">// x y 都是有环境贴图定义的系数</span>
        <span class="token comment">// 存储在 unity_SpecCube0_HDR 这个结构中</span>
        <span class="token keyword">return</span> <span class="token function">DecodeHDREnvironment</span><span class="token punctuation">(</span>specularColor<span class="token punctuation">,</span> unity_SpecCube0_HDR<span class="token punctuation">)</span> <span class="token operator">*</span> AO<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        <span class="token keyword">return</span> specularColor<span class="token punctuation">.</span>rgb <span class="token operator">*</span> AO<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
    <span class="token punctuation">}</span>

    half3 <span class="token function">IndirectSpeFactor</span><span class="token punctuation">(</span>half roughness<span class="token punctuation">,</span> half smoothness<span class="token punctuation">,</span> half3 BRDFspe<span class="token punctuation">,</span> half3 F0<span class="token punctuation">,</span> half NdotV<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">UNITY_COLORSPACE_GAMMA</span></span>
        half SurReduction <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">0.28</span> <span class="token operator">*</span> roughness <span class="token operator">*</span> roughness<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        half SurReduction <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">/</span> <span class="token punctuation">(</span>roughness <span class="token operator">*</span> roughness <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>SHADER_API_GLES<span class="token punctuation">)</span> </span><span class="token comment">// Lighting.hlsl 261 行</span></span>
        half Reflectivity <span class="token operator">=</span> BRDFspe<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        half Reflectivity <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">max</span><span class="token punctuation">(</span>BRDFspe<span class="token punctuation">.</span>x<span class="token punctuation">,</span> BRDFspe<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">,</span> BRDFspe<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        half GrazingTSection <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span>Reflectivity <span class="token operator">+</span> smoothness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half fre <span class="token operator">=</span> <span class="token function">Pow4</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> NdotV<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Lighting.hlsl 第 501 行</span>
        <span class="token comment">// half fre = exp2((-5.55473 * NdotV - 6.98316) * NdotV); // Lighting.hlsl 第 501 行，他是 4 次方，我们是 5 次方</span>
        <span class="token keyword">return</span> <span class="token function">lerp</span><span class="token punctuation">(</span>F0<span class="token punctuation">,</span> GrazingTSection<span class="token punctuation">,</span> fre<span class="token punctuation">)</span> <span class="token operator">*</span> SurReduction<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ========== Indirect END =============</span>

    <span class="token comment">// ========== vert START ===========</span>
    v2f <span class="token function">vert</span><span class="token punctuation">(</span>a2v i<span class="token punctuation">)</span>
    <span class="token punctuation">{<!-- --></span>
        v2f o <span class="token operator">=</span> <span class="token punctuation">(</span>v2f<span class="token punctuation">)</span><span class="token number">0</span><span class="token punctuation">;</span>
        float3 positionWS <span class="token operator">=</span> <span class="token function">TransformObjectToWorld</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>positionOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>positionCS <span class="token operator">=</span> <span class="token function">TransformWorldToHClip</span><span class="token punctuation">(</span>positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy <span class="token operator">=</span> <span class="token function">TRANSFORM_TEX</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>uv<span class="token punctuation">,</span> _BaseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>zw <span class="token operator">=</span> i<span class="token punctuation">.</span>lightmapUV<span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>normalWS<span class="token punctuation">.</span>xyz <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">TransformObjectToWorldNormal</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>normalOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>tangentWS<span class="token punctuation">.</span>xyz <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span><span class="token function">TransformObjectToWorldDir</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>tangentOS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>bitangentWS<span class="token punctuation">.</span>xyz <span class="token operator">=</span> <span class="token function">cross</span><span class="token punctuation">(</span>o<span class="token punctuation">.</span>normalWS<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> o<span class="token punctuation">.</span>tangentWS<span class="token punctuation">.</span>xyz<span class="token punctuation">)</span> <span class="token operator">*</span> i<span class="token punctuation">.</span>tangentOS<span class="token punctuation">.</span>w <span class="token operator">*</span> unity_WorldTransformParams<span class="token punctuation">.</span>w<span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>normalWS<span class="token punctuation">.</span>w <span class="token operator">=</span> positionWS<span class="token punctuation">.</span>x<span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>tangentWS<span class="token punctuation">.</span>w <span class="token operator">=</span> positionWS<span class="token punctuation">.</span>y<span class="token punctuation">;</span>
        o<span class="token punctuation">.</span>bitangentWS<span class="token punctuation">.</span>w <span class="token operator">=</span> positionWS<span class="token punctuation">.</span>z<span class="token punctuation">;</span>
        <span class="token keyword">return</span> o<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ========== vert END ===========</span>

    <span class="token comment">// ========== frag START ===========</span>
    half4 <span class="token function">frag</span><span class="token punctuation">(</span>v2f i<span class="token punctuation">)</span> <span class="token operator">:</span> SV_Target
    <span class="token punctuation">{<!-- --></span>
        half4 normalTex <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_NormalMap<span class="token punctuation">,</span> sampler_NormalMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half3 normalTS <span class="token operator">=</span> <span class="token function">UnpackNormalScale</span><span class="token punctuation">(</span>normalTex<span class="token punctuation">,</span> _NormalScale<span class="token punctuation">)</span><span class="token punctuation">;</span>
        normalTS<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> <span class="token function">saturate</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>normalTS<span class="token punctuation">.</span>xy<span class="token punctuation">,</span> normalTS<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        float3x3 T2W <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> i<span class="token punctuation">.</span>tangentWS<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> i<span class="token punctuation">.</span>bitangentWS<span class="token punctuation">.</span>xyz<span class="token punctuation">,</span> i<span class="token punctuation">.</span>normalWS<span class="token punctuation">.</span>xyz <span class="token punctuation">}</span><span class="token punctuation">;</span>
        T2W <span class="token operator">=</span> <span class="token function">transpose</span><span class="token punctuation">(</span>T2W<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half3 N <span class="token operator">=</span> <span class="token function">NormalizeNormalPerPixel</span><span class="token punctuation">(</span><span class="token function">mul</span><span class="token punctuation">(</span>T2W<span class="token punctuation">,</span> normalTS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return half4(N, 1);</span>
        Light mainLight <span class="token operator">=</span> <span class="token function">GetMainLight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        half3 L <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>mainLight<span class="token punctuation">.</span>direction<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return half4(L, 1);</span>
        float3 positionWS <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span>i<span class="token punctuation">.</span>normalWS<span class="token punctuation">.</span>w<span class="token punctuation">,</span> i<span class="token punctuation">.</span>tangentWS<span class="token punctuation">.</span>w<span class="token punctuation">,</span> i<span class="token punctuation">.</span>bitangentWS<span class="token punctuation">.</span>w<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half3 V <span class="token operator">=</span> <span class="token function">SafeNormalize</span><span class="token punctuation">(</span>_WorldSpaceCameraPos <span class="token operator">-</span> positionWS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return half4(V, 1);</span>
        half3 H <span class="token operator">=</span> <span class="token function">normalize</span><span class="token punctuation">(</span>L <span class="token operator">+</span> V<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return half4(H, 1);</span>
        half HdotN <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> N<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        half NdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        half NdotV <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        half HdotL <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span><span class="token function">dot</span><span class="token punctuation">(</span>H<span class="token punctuation">,</span> L<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1e-5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// ======= Direct START ======</span>

        half3 albedoTex <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_BaseMap<span class="token punctuation">,</span> sampler_BaseMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb <span class="token operator">*</span> _BaseColor<span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
        half3 emissiveTex <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_EmissiveMap<span class="token punctuation">,</span> sampler_EmissiveMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
        half3 maskTex <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D</span><span class="token punctuation">(</span>_MaskMap<span class="token punctuation">,</span> sampler_MaskMap<span class="token punctuation">,</span> i<span class="token punctuation">.</span>uv<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span>
        half metallic <span class="token operator">=</span> maskTex<span class="token punctuation">.</span>r <span class="token operator">*</span> _Metallic<span class="token punctuation">;</span>
        half AO <span class="token operator">=</span> <span class="token function">lerp</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> maskTex<span class="token punctuation">.</span>g<span class="token punctuation">,</span> _AO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half smoothness <span class="token operator">=</span> maskTex<span class="token punctuation">.</span>b<span class="token punctuation">;</span>
        half roughness <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> smoothness<span class="token punctuation">)</span> <span class="token operator">*</span> _Roughness<span class="token punctuation">;</span>

        <span class="token comment">// direct specular</span>
        half Direct_D <span class="token operator">=</span> <span class="token function">Direct_D_Function</span><span class="token punctuation">(</span>HdotN<span class="token punctuation">,</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//return Direct_D;</span>

        <span class="token comment">// jave.lin : 使用 Kelemen-Szirmay-Kalos Geometry Factor 优化（可以减少一个 sub G func）</span>
        <span class="token comment">// 参考：http://renderwonk.com/publications/s2010-shading-course/hoffman/s2010_physically_based_shading_hoffman_b.pdf - 搜索：Kelemen-Szirmay-Kalos Geometry Factor</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_KALOS_G_FACTOR_ON<span class="token punctuation">)</span></span></span>
        half Direct_G <span class="token operator">=</span> <span class="token function">Direct_G_Function_Kalos</span><span class="token punctuation">(</span>HdotL<span class="token punctuation">,</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        half Direct_G <span class="token operator">=</span> <span class="token function">Direct_G_Function</span><span class="token punctuation">(</span>NdotL<span class="token punctuation">,</span> NdotV<span class="token punctuation">,</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
         <span class="token comment">//return Direct_G;</span>

        half3 F0 <span class="token operator">=</span> <span class="token function">Direct_F0_Function</span><span class="token punctuation">(</span>albedoTex<span class="token punctuation">,</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//return half4(F0, 1);</span>
        half3 Direct_F <span class="token operator">=</span> <span class="token function">Direct_F_Function</span><span class="token punctuation">(</span>HdotL<span class="token punctuation">,</span> F0<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//return half4(Direct_F, 1);</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_KALOS_G_FACTOR_ON<span class="token punctuation">)</span></span></span>
        half3 BRDFSpecSection <span class="token operator">=</span> <span class="token punctuation">(</span>Direct_D <span class="token operator">*</span> Direct_G<span class="token punctuation">)</span> <span class="token operator">*</span> Direct_F <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> HdotL<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
        half3 BRDFSpecSection <span class="token operator">=</span> <span class="token punctuation">(</span>Direct_D <span class="token operator">*</span> Direct_G<span class="token punctuation">)</span> <span class="token operator">*</span> Direct_F <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> NdotL <span class="token operator">*</span> NdotV<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        <span class="token comment">//return half4(BRDFSpecSection, 1);</span>

        half3 DirectSpeColor <span class="token operator">=</span> BRDFSpecSection <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>color <span class="token operator">*</span> <span class="token punctuation">(</span>NdotL <span class="token operator">*</span> PI <span class="token operator">*</span> AO<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//return half4(DirectSpeColor, 1);</span>

        <span class="token comment">// direct diffuse</span>
        half3 KS <span class="token operator">=</span> Direct_F<span class="token punctuation">;</span>
        half3 KD <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> KS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return half4(KD, 1);</span>

        half3 emissiveColor <span class="token operator">=</span> emissiveTex <span class="token operator">*</span> <span class="token function">pow</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> _Emissive<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token function">defined</span><span class="token punctuation">(</span>_EMISSIVE_TWINKLE_ON<span class="token punctuation">)</span></span></span>
        emissiveColor <span class="token operator">*=</span> <span class="token function">sin</span><span class="token punctuation">(</span>_Time<span class="token punctuation">.</span>y <span class="token operator">*</span> _EmissiveTwinkleFrequence <span class="token operator">*</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
        half3 DirectDiffColor <span class="token operator">=</span> KD <span class="token operator">*</span> albedoTex <span class="token operator">*</span> mainLight<span class="token punctuation">.</span>color <span class="token operator">*</span> NdotL <span class="token operator">+</span> emissiveColor<span class="token punctuation">;</span>
        <span class="token comment">// return half4(DirectDiffColor, 1);</span>

        <span class="token comment">// direct lights</span>
        half3 DirectColor <span class="token operator">=</span> DirectDiffColor <span class="token operator">+</span> DirectSpeColor<span class="token punctuation">;</span>
        <span class="token comment">// return half4(DirectColor, 1);</span>

        <span class="token comment">// ======= Direct END ======</span>

        <span class="token comment">// ======= Indirect START ======</span>
        
        <span class="token comment">// indirect diffuse</span>
        half3 shColor <span class="token operator">=</span> <span class="token function">SH_IndirectionDiff</span><span class="token punctuation">(</span>N<span class="token punctuation">)</span> <span class="token operator">*</span> AO<span class="token punctuation">;</span>
        half3 Indirect_KS <span class="token operator">=</span> <span class="token function">Indirect_F_Function</span><span class="token punctuation">(</span>NdotV<span class="token punctuation">,</span> F0<span class="token punctuation">,</span> roughness<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half3 Indirect_KD <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> Indirect_KS<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> metallic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        half3 IndirectDiffColor <span class="token operator">=</span> shColor <span class="token operator">*</span> Indirect_KD <span class="token operator">*</span> albedoTex<span class="token punctuation">;</span>
        <span class="token comment">// return half4(IndirectDiffColor, 1); // jave.lin : 添加一个 反射探针 即可看到效果：reflection probe</span>

        <span class="token comment">// indirect specular</span>

        <span class="token comment">// 反射探针的间接光</span>
        half3 IndirectSpeCubeColor <span class="token operator">=</span> <span class="token function">IndirectSpeCube</span><span class="token punctuation">(</span>N<span class="token punctuation">,</span> V<span class="token punctuation">,</span> roughness<span class="token punctuation">,</span> AO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// return half4(IndirectSpeCubeColor, 1);</span>

        half3 IndirectSpeCubeFactor <span class="token operator">=</span> <span class="token function">IndirectSpeFactor</span><span class="token punctuation">(</span>roughness<span class="token punctuation">,</span> smoothness<span class="token punctuation">,</span> BRDFSpecSection<span class="token punctuation">,</span> F0<span class="token punctuation">,</span> NdotV<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//return half4(IndirectSpeCubeFactor, 1);</span>

        half3 IndirectSpeColor <span class="token operator">=</span> IndirectSpeCubeColor <span class="token operator">*</span> IndirectSpeCubeFactor<span class="token punctuation">;</span>
        <span class="token comment">// return half4(IndirectSpeColor, 1);</span>

        half3 IndirectColor <span class="token operator">=</span> IndirectDiffColor <span class="token operator">+</span> IndirectSpeColor<span class="token punctuation">;</span>
        <span class="token comment">// return half4(IndirectColor, 1);</span>

        <span class="token comment">// ======= Indirect END ======</span>

        half3 finalCol <span class="token operator">=</span> DirectColor <span class="token operator">+</span> IndirectColor<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token function">half4</span><span class="token punctuation">(</span>finalCol<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ========== frag END ===========</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre> 
<hr> 
<h4><a id="URP_PBR_Emissiveshader_970"></a>URP_PBR_Emissive.shader</h4> 
<pre><code class="prism language-c"><span class="token comment">// jave.lin 2022/02/06</span>
<span class="token comment">// URP PBR Emissive</span>

Shader <span class="token string">"Test/URP_PBR_Emissive"</span>
<span class="token punctuation">{<!-- --></span>
    Properties
    <span class="token punctuation">{<!-- --></span>
        <span class="token function">_BaseColor</span> <span class="token punctuation">(</span><span class="token string">"Color"</span><span class="token punctuation">,</span> Color<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token function">_BaseMap</span> <span class="token punctuation">(</span><span class="token string">"Albedo"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"white"</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">[</span>NoScaleOffset<span class="token punctuation">]</span> <span class="token function">_MaskMap</span> <span class="token punctuation">(</span><span class="token string">"Mask: Metalic(R), AO(G), Smoothness(B)"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"black"</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">[</span>NoScaleOffset<span class="token punctuation">]</span> <span class="token punctuation">[</span>Normal<span class="token punctuation">]</span> <span class="token function">_NormalMap</span> <span class="token punctuation">(</span><span class="token string">"Normal (RGB)"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"bump"</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token punctuation">[</span>NoScaleOffset<span class="token punctuation">]</span> <span class="token function">_EmissiveMap</span> <span class="token punctuation">(</span><span class="token string">"Emissive (RGB)"</span><span class="token punctuation">,</span> <span class="token number">2</span>D<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token string">"black"</span> <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
        <span class="token function">_Metallic</span> <span class="token punctuation">(</span><span class="token string">"Metallic"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_AO</span> <span class="token punctuation">(</span><span class="token string">"AO"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Roughness</span> <span class="token punctuation">(</span><span class="token string">"Roughness"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_NormalScale</span><span class="token punctuation">(</span><span class="token string">"NormalScale"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_Emissive</span> <span class="token punctuation">(</span><span class="token string">"Emissive"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">[</span><span class="token function">Toggle</span><span class="token punctuation">(</span>_EMISSIVE_TWINKLE_ON<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token function">_Emissve_Twinkle</span><span class="token punctuation">(</span><span class="token string">"Emissive Twinkle"</span><span class="token punctuation">,</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token function">_EmissiveTwinkleFrequence</span> <span class="token punctuation">(</span><span class="token string">"Emissive Twinkle Frequence"</span><span class="token punctuation">,</span> <span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
        <span class="token punctuation">[</span><span class="token function">Toggle</span><span class="token punctuation">(</span>_KALOS_G_FACTOR_ON<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token function">_Kalos_G_Factor</span> <span class="token punctuation">(</span><span class="token string">"Optimize with Kalos G Factor"</span><span class="token punctuation">,</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
    SubShader
    <span class="token punctuation">{<!-- --></span>
        Tags
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"RenderPipeline"</span> <span class="token operator">=</span> <span class="token string">"UniversalRenderPipeline"</span>
        <span class="token punctuation">}</span>
        Pass
        <span class="token punctuation">{<!-- --></span>
            HLSLPROGRAM
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">vertex vert</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">fragment frag</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">shader_feature _ _EMISSIVE_TWINKLE_ON</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression">shader_feature _ _KALOS_G_FACTOR_ON</span></span>
            <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"Includes/PBR__Emissive_Lib.hlsl"</span></span>
            ENDHLSL
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<hr> 
<p>jave.lin : 另外说明一下</p> 
<p>PBR 也是经验模型，是基于物理观察后的数据做的数据模型来模拟的</p> 
<p>所以比一般非物理观测模型的更加逼真一些</p> 
<p>因此才叫：PBR（基于物理(观察后)渲染(数学模型)）</p> 
<p>上面我们提到的公式，都是经过再优化（在原来的 PBR 的某个分支的模型基础上再次简化计算的模型）</p> 
<hr> 
<h2><a id="References_1028"></a>References</h2> 
<ul><li>毛神的 PBR 总结 - (毛神一路走好） 
  <ul><li><a href="https://zhuanlan.zhihu.com/p/53086060" rel="nofollow">【基于物理的渲染（PBR）白皮书】（一） 开篇：PBR核心知识体系总结与概览</a></li><li><a href="https://zhuanlan.zhihu.com/p/56967462" rel="nofollow">【基于物理的渲染（PBR）白皮书】（二） PBR核心理论与渲染光学原理总结</a></li><li><a href="https://zhuanlan.zhihu.com/p/60977923" rel="nofollow">【基于物理的渲染（PBR）白皮书】（三）迪士尼原则的BRDF与BSDF相关总结</a></li><li><a href="https://zhuanlan.zhihu.com/p/69380665" rel="nofollow">【基于物理的渲染（PBR）白皮书】（四）法线分布函数相关总结</a></li><li><a href="https://zhuanlan.zhihu.com/p/81708753" rel="nofollow">【基于物理的渲染（PBR）白皮书】（五）几何函数相关总结</a></li></ul> </li><li><a href="https://www.bilibili.com/read/cv7510082" rel="nofollow">URP管线的自学HLSL之路 第三十七篇 造一个PBR的轮子</a></li><li><a href="http://filmicworlds.com/blog/optimizing-ggx-shaders-with-dotlh/" rel="nofollow">Optimizing GGX Shaders with dot(L,H)</a></li><li><a href="https://blog.csdn.net/qq_41061477/article/details/123166077?spm=1001.2014.3001.5501">GAMES202 笔记 -Real-Time Physically-Based Materials</a></li></ul> 
<hr> 
<p>最后附上近期自己用圆珠笔话的一张画，耗时大概 40 分钟</p> 
<p>自从学习 shader 得基础光照着色后，对画画时得细节了解也会增加</p> 
<p>(希望自己不要潜得太久，就算不太顺利，也要往前看~，给自己加油！！！)</p> 
<p><img src="https://images2.imgbox.com/64/37/eOMjIIA2_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/4a3d99e48c5b77edd7e6b9d89d511549/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">STM32 cudeIDE使用J-link下载程序</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b96cb59fda876842682d07eaf60d9604/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【FPGA的基础快速入门16-------DHT１１数字温湿度传感器】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>