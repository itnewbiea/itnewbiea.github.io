<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>制作一个RISC-V的操作系统五-RISC-V汇编语言编程三 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="制作一个RISC-V的操作系统五-RISC-V汇编语言编程三" />
<meta property="og:description" content="文章目录 分析code/asm/add中的makefile相关命令 算数运算指令addadd2sub 练习5-1 分析code/asm/add中的makefile makefile
EXEC = test SRC = ${EXEC}.s GDBINIT = ../gdbinit include ../rule.mk 很明显还要去执行rule.mk
rule.mk
include ../../common.mk .DEFAULT_GOAL := all all: @${CC} ${CFLAGS} ${SRC} -Ttext=0x80000000 -o ${EXEC}.elf @${OBJCOPY} -O binary ${EXEC}.elf ${EXEC}.bin .PHONY : run run: all @echo &#34;Press Ctrl-A and then X to exit QEMU&#34; @echo &#34;------------------------------------&#34; @echo &#34;No output, please run &#39;make debug&#39; to see details&#34; @${QEMU} ${QFLAGS} -kernel ./${EXEC}.elf .PHONY : debug debug: all @echo &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/e5c6d6d8fe9869e5f895d9429603443f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-06T18:12:47+08:00" />
<meta property="article:modified_time" content="2023-12-06T18:12:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">制作一个RISC-V的操作系统五-RISC-V汇编语言编程三</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#codeasmaddmakefile_1" rel="nofollow">分析code/asm/add中的makefile</a></li><li><ul><li><a href="#_64" rel="nofollow">相关命令</a></li></ul> 
  </li><li><a href="#_68" rel="nofollow">算数运算指令</a></li><li><ul><li><a href="#add_71" rel="nofollow">add</a></li><li><a href="#add2_80" rel="nofollow">add2</a></li><li><a href="#sub_93" rel="nofollow">sub</a></li></ul> 
  </li><li><a href="#51_103" rel="nofollow">练习5-1</a></li></ul> 
</div> 
<p></p> 
<h2><a id="codeasmaddmakefile_1"></a>分析code/asm/add中的makefile</h2> 
<p>makefile</p> 
<pre><code class="prism language-bash">EXEC <span class="token operator">=</span> <span class="token builtin class-name">test</span>

SRC <span class="token operator">=</span> <span class="token variable">${EXEC}</span>.s

GDBINIT <span class="token operator">=</span> <span class="token punctuation">..</span>/gdbinit

include <span class="token punctuation">..</span>/rule.mk
</code></pre> 
<p>很明显还要去执行rule.mk</p> 
<p>rule.mk</p> 
<pre><code class="prism language-bash">include <span class="token punctuation">..</span>/<span class="token punctuation">..</span>/common.mk

.DEFAULT_GOAL :<span class="token operator">=</span> all
all:
	@<span class="token variable">${CC}</span> <span class="token variable">${CFLAGS}</span> <span class="token variable">${SRC}</span> <span class="token parameter variable">-Ttext</span><span class="token operator">=</span>0x80000000 <span class="token parameter variable">-o</span> <span class="token variable">${EXEC}</span>.elf
	@<span class="token variable">${OBJCOPY}</span> <span class="token parameter variable">-O</span> binary <span class="token variable">${EXEC}</span>.elf <span class="token variable">${EXEC}</span>.bin

.PHONY <span class="token builtin class-name">:</span> run
run: all
	@echo <span class="token string">"Press Ctrl-A and then X to exit QEMU"</span>
	@echo <span class="token string">"------------------------------------"</span>
	@echo <span class="token string">"No output, please run 'make debug' to see details"</span>
	@<span class="token variable">${QEMU}</span> <span class="token variable">${QFLAGS}</span> <span class="token parameter variable">-kernel</span> ./<span class="token variable">${EXEC}</span>.elf

.PHONY <span class="token builtin class-name">:</span> debug
debug: all
	@echo <span class="token string">"Press Ctrl-C and then input 'quit' to exit GDB and QEMU"</span>
	@echo <span class="token string">"-------------------------------------------------------"</span>
	@<span class="token variable">${QEMU}</span> <span class="token variable">${QFLAGS}</span> <span class="token parameter variable">-kernel</span> <span class="token variable">${EXEC}</span>.elf <span class="token parameter variable">-s</span> <span class="token parameter variable">-S</span> <span class="token operator">&amp;</span>
	@<span class="token variable">${GDB}</span> <span class="token variable">${EXEC}</span>.elf <span class="token parameter variable">-q</span> <span class="token parameter variable">-x</span> <span class="token variable">${GDBINIT}</span>

.PHONY <span class="token builtin class-name">:</span> code
code: all
	@<span class="token variable">${OBJDUMP}</span> <span class="token parameter variable">-S</span> <span class="token variable">${EXEC}</span>.elf <span class="token operator">|</span> <span class="token function">less</span>

.PHONY <span class="token builtin class-name">:</span> hex
hex: all
	@hexdump <span class="token parameter variable">-C</span> <span class="token variable">${EXEC}</span>.bin

.PHONY <span class="token builtin class-name">:</span> clean
clean:
	<span class="token function">rm</span> <span class="token parameter variable">-rf</span> *.o *.bin *.elf
</code></pre> 
<p>还要执行common.mk，然后按命令行中执行对应目标<br> common.mk</p> 
<pre><code class="prism language-bash">CROSS_COMPILE <span class="token operator">=</span> riscv64-unknown-elf-
CFLAGS <span class="token operator">=</span> <span class="token parameter variable">-nostdlib</span> -fno-builtin <span class="token parameter variable">-march</span><span class="token operator">=</span>rv32ima <span class="token parameter variable">-mabi</span><span class="token operator">=</span>ilp32 <span class="token parameter variable">-g</span> <span class="token parameter variable">-Wall</span>

QEMU <span class="token operator">=</span> qemu-system-riscv32
QFLAGS <span class="token operator">=</span> <span class="token parameter variable">-nographic</span> <span class="token parameter variable">-smp</span> <span class="token number">1</span> <span class="token parameter variable">-machine</span> virt <span class="token parameter variable">-bios</span> none

GDB <span class="token operator">=</span> gdb-multiarch
CC <span class="token operator">=</span> <span class="token variable">${CROSS_COMPILE}</span>gcc
OBJCOPY <span class="token operator">=</span> <span class="token variable">${CROSS_COMPILE}</span>objcopy
OBJDUMP <span class="token operator">=</span> <span class="token variable">${CROSS_COMPILE}</span>objdump
</code></pre> 
<h3><a id="_64"></a>相关命令</h3> 
<p>QEMU -s 自动在模拟器启动是启动gdbserver，gdbserver与gdb通过网络连接。gdb server默认端口1234，然后等待gdb与之连接 -S参数代表 gdbserver启动调试程序后停止然后等待用户输入.-kernel ./可执行文件 代表要加载的镜像<br> gdb -q 启动把前面乱七八糟打印的东西去掉 -x 配置脚本 gdb启动时会运行该脚本</p> 
<h2><a id="_68"></a>算数运算指令</h2> 
<p>乘除由M模块来扩展<br> RISC-V指令习惯源放后面 目的放前面</p> 
<h3><a id="add_71"></a>add</h3> 
<p><img src="https://images2.imgbox.com/98/c0/2DG581UB_o.png" alt="在这里插入图片描述"><br> 通过funct3和funct7和opcode来识别这是add指令<br> <img src="https://images2.imgbox.com/72/45/E4hRgS6P_o.png" alt="在这里插入图片描述"><br> rsn对应第n个寄存器，里面存储的值是n<br> <img src="https://images2.imgbox.com/43/a0/gTTqym7a_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/7c/09/dhqibgKJ_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="add2_80"></a>add2</h3> 
<blockquote> 
 <p>对于4和-4的补码<br> 符号扩展 只需按符号位扩展<br> 零扩展（无符号扩展） 无论啥都扩展为0<br> 对于4直接求出对应4的二进制编码为0100，（留一个为符号位）然后扩展由于是整数，左扩展0，为00000100<br> 对于-4先求出对应4的二进制编码为0100，然后取反加1，为1100，然后符号位为1，左扩展1，为11111100</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/2d/a8/R2xv0vEQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/bc/fb/sp4jEp4V_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="sub_93"></a>sub</h3> 
<p><img src="https://images2.imgbox.com/b2/0e/LqUZaTRw_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/22/10/ZDyVvNFO_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/52/d7/KcOwngZd_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="51_103"></a>练习5-1</h2> 
<ul><li> <p>对 code/asm/sub 执⾏反汇编，查看 sub x5, x6, x7 这条汇编指令对应的机器指令的编码，并对照<br> RISC-V 的 specificaion ⾃⼰解析该条指令的编码。<br> 0x407302b3对应二进制为0100000-00111-00110-000-00101-0110011<br> <img src="https://images2.imgbox.com/92/36/mZgQT0VZ_o.png" alt="在这里插入图片描述"></p> </li><li> <p>现知道某条 RISC-V 的机器指令在内存中的值为 b3 05 95 00，从左往右为从低地址到⾼地址，单位为<br> 字节，请将其翻译为对应的汇编指令。<br> 0x009505b3 对应二进制为0000000-01001-01010-000-01011-0110011<br> add,x11,x10,x9<br> <img src="https://images2.imgbox.com/e3/ec/cR8hr4y7_o.png" alt="在这里插入图片描述"></p> </li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6f1ea1eab585d3fe1bfd8eca3e8f56e8/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C语言的控制结构（顺序结构、选择结构、循环结构）详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b8b5d2573e12310f2c771df0a4345a1f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32CubeMX 按键控制LED</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>