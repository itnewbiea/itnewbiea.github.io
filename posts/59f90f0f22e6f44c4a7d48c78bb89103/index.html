<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>K8S应用服务安全(最小特权 策略方案 资源限制 调用限制 沙箱) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="K8S应用服务安全(最小特权 策略方案 资源限制 调用限制 沙箱)" />
<meta property="og:description" content="应用服务安全 1 应用服务安全1.1 最小特权1.1.1 基础知识1.1.2 安全上下文1.1.3 资源实践1.1.4 特权基础1.1.5 特权实践1.1.5 PSP实践 1.2 策略方案1.2.1 OPA简介1.2.2 特权策略1.2.3 策略进阶 1.3 资源限制1.3.1 AppArmor简介1.3.2 基础知识1.3.2 应用实践 1.4 调用限制1.4.1 Seccomp1.4.2 应用实践 1.5 应用沙箱1.5.1 gVisor应用1.5.2 环境集成1.5.3 Containerd集成1.5.4 k8s集成 1 应用服务安全 1.1 最小特权 1.1.1 基础知识 学习目标
这一节，我们从 场景解读、细节解读、小结 三个方面来学习。
场景解读
应用安全攻击
随着基于容器部署方式的改变，软件的交付速度越来越快，而为了体现应用的价值快速变现，在软件研发模式、软件架构模式、软件交付模式、软件部署模式都做了相应的调整。 虽然应用交付越来越快，但是业务受到的危害也越来越多，根据OWASP组织针对2021年全球互联网的网络安全攻击事件的统计分析，针对用户行为的攻击形式占据1/5的比例，而针对服务端软件结构漏洞的攻击占据了4/5，越来越多的攻击着重于用户数据、企业数据、相关数据的二次使用，基于这些数据进行大量的安全攻击，尤其是针对企业软件项目的安全攻击事件，很大程度上从用户的管理行为、数据泄露行为、安全管理制度漏洞等方面入手导致的安全攻击。 特点解读
我们会发现，越来越多的安全攻击事件，很大程度上是由于程序自己设计时候出现的漏洞、数据校验不合理、内部配置失误、安全体系建设等方面的不合理导致的，说白了，该进行信息紧密校验的地方我们没有做，或者说该缩小权限限制的地方我们没有加固。 方案思路
在很多项目的大部分实际的工作中，当一个开发人员或者其他相关人员请求开通访问权限时，系统管理员等负责权限的人员因为多种因素盲目的提供了访问权限，这导致了在组织内部有很多的漏洞，极有可能会造成重大安全风险。所以，目前行业中提出了一套所谓的最小特权原则（Understanding Principle of Least Privilage）来解决该问题。它的核心点是 将用户的项目操作权限限制到一个最小范围，然后从服务端入手，最大化减少安全攻击的机率 细节解读
最小特权原则
最小权限原则最早由 Saltzer 和 Schroeder 提出来的，它是指每个程序和系统用户都应该具有完成任务所必需的最小权限集合。它要求计算环境中的特定抽象层的每个模块只能访问当下所必需的信息或者资源。 最小权限的生活场景理解： 使用方面 - 一个用户应该只能访问履行他的相关职责所需访问的数据和硬件。 安全层面 - 每个合法动作最小权限，保护数据及功能，避免遭受恶意破坏的机率。 linux最小化原则示例
最小化原则对Linux系统安全来说非常重要，一般包括如下几个方面： 1." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/59f90f0f22e6f44c4a7d48c78bb89103/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-10T21:04:44+08:00" />
<meta property="article:modified_time" content="2023-07-10T21:04:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">K8S应用服务安全(最小特权 策略方案 资源限制 调用限制 沙箱)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>应用服务安全</h4> 
 <ul><li><a href="#1__1" rel="nofollow">1 应用服务安全</a></li><li><ul><li><a href="#11__3" rel="nofollow">1.1 最小特权</a></li><li><ul><li><a href="#111__5" rel="nofollow">1.1.1 基础知识</a></li><li><a href="#112__96" rel="nofollow">1.1.2 安全上下文</a></li><li><a href="#113__314" rel="nofollow">1.1.3 资源实践</a></li><li><a href="#114__435" rel="nofollow">1.1.4 特权基础</a></li><li><a href="#115__637" rel="nofollow">1.1.5 特权实践</a></li><li><a href="#115_PSP_806" rel="nofollow">1.1.5 PSP实践</a></li></ul> 
   </li><li><a href="#12__924" rel="nofollow">1.2 策略方案</a></li><li><ul><li><a href="#121_OPA_926" rel="nofollow">1.2.1 OPA简介</a></li><li><a href="#122__1083" rel="nofollow">1.2.2 特权策略</a></li><li><a href="#123__1325" rel="nofollow">1.2.3 策略进阶</a></li></ul> 
   </li><li><a href="#13__1474" rel="nofollow">1.3 资源限制</a></li><li><ul><li><a href="#131_AppArmor_1476" rel="nofollow">1.3.1 AppArmor简介</a></li><li><a href="#132__1768" rel="nofollow">1.3.2 基础知识</a></li><li><a href="#132__2188" rel="nofollow">1.3.2 应用实践</a></li></ul> 
   </li><li><a href="#14__2291" rel="nofollow">1.4 调用限制</a></li><li><ul><li><a href="#141_Seccomp_2293" rel="nofollow">1.4.1 Seccomp</a></li><li><a href="#142__2419" rel="nofollow">1.4.2 应用实践</a></li></ul> 
   </li><li><a href="#15__2574" rel="nofollow">1.5 应用沙箱</a></li><li><ul><li><a href="#151_gVisor_2576" rel="nofollow">1.5.1 gVisor应用</a></li><li><a href="#152__2674" rel="nofollow">1.5.2 环境集成</a></li><li><a href="#153_Containerd_2884" rel="nofollow">1.5.3 Containerd集成</a></li><li><a href="#154_k8s_3186" rel="nofollow">1.5.4 k8s集成</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h2><a id="1__1"></a>1 应用服务安全</h2> 
<h3><a id="11__3"></a>1.1 最小特权</h3> 
<h4><a id="111__5"></a>1.1.1 基础知识</h4> 
<p>学习目标</p> 
<p>这一节，我们从 场景解读、细节解读、小结 三个方面来学习。</p> 
<p><strong>场景解读</strong></p> 
<p>应用安全攻击</p> 
<pre><code class="prism language-powershell">	随着基于容器部署方式的改变，软件的交付速度越来越快，而为了体现应用的价值快速变现，在软件研发模式、软件架构模式、软件交付模式、软件部署模式都做了相应的调整。
	虽然应用交付越来越快，但是业务受到的危害也越来越多，根据OWASP组织针对2021年全球互联网的网络安全攻击事件的统计分析，针对用户行为的攻击形式占据1/5的比例，而针对服务端软件结构漏洞的攻击占据了4/5，越来越多的攻击着重于用户数据、企业数据、相关数据的二次使用，基于这些数据进行大量的安全攻击，尤其是针对企业软件项目的安全攻击事件，很大程度上从用户的管理行为、数据泄露行为、安全管理制度漏洞等方面入手导致的安全攻击。
</code></pre> 
<p><img src="https://images2.imgbox.com/df/c2/W4HNWChN_o.png" alt="在这里插入图片描述"></p> 
<p>特点解读</p> 
<pre><code class="prism language-powershell">	我们会发现，越来越多的安全攻击事件，很大程度上是由于程序自己设计时候出现的漏洞、数据校验不合理、内部配置失误、安全体系建设等方面的不合理导致的，说白了，该进行信息紧密校验的地方我们没有做，或者说该缩小权限限制的地方我们没有加固。
</code></pre> 
<p>方案思路</p> 
<pre><code class="prism language-powershell">	在很多项目的大部分实际的工作中，当一个开发人员或者其他相关人员请求开通访问权限时，系统管理员等负责权限的人员因为多种因素盲目的提供了访问权限，这导致了在组织内部有很多的漏洞，极有可能会造成重大安全风险。所以，目前行业中提出了一套所谓的最小特权原则（Understanding Principle of Least Privilage）来解决该问题。它的核心点是 将用户的项目操作权限限制到一个最小范围，然后从服务端入手，最大化减少安全攻击的机率
</code></pre> 
<p><img src="https://images2.imgbox.com/57/e1/DJPgdvVb_o.png" alt="在这里插入图片描述"></p> 
<p><strong>细节解读</strong></p> 
<p>最小特权原则</p> 
<pre><code class="prism language-powershell">	最小权限原则最早由 Saltzer 和 Schroeder 提出来的，它是指每个程序和系统用户都应该具有完成任务所必需的最小权限集合。它要求计算环境中的特定抽象层的每个模块只能访问当下所必需的信息或者资源。
</code></pre> 
<pre><code class="prism language-powershell">最小权限的生活场景理解：
	使用方面 <span class="token operator">-</span> 一个用户应该只能访问履行他的相关职责所需访问的数据和硬件。
	安全层面 <span class="token operator">-</span> 每个合法动作最小权限，保护数据及功能，避免遭受恶意破坏的机率。
</code></pre> 
<p>linux最小化原则示例</p> 
<pre><code class="prism language-powershell">最小化原则对Linux系统安全来说非常重要，一般包括如下几个方面：
1<span class="token punctuation">.</span>安装Linux系统最小化，即选包最小化，yum安装软件包也要最小化，没用的包不装。
2<span class="token punctuation">.</span>开机自启动服务最小化，即没用的服务不开启。
3<span class="token punctuation">.</span>操作命令最小化。例如：能用“<span class="token function">rm</span> <span class="token operator">-</span>f  就不用 <span class="token function">rm</span> <span class="token operator">-</span>rf 。
4<span class="token punctuation">.</span>登录Linux用户最小化。平时没有特殊需求不登录root，用普通用户登录即可。
5<span class="token punctuation">.</span>普通用户授权权限最小化，即只给用户必需的管理系统的命令。
6<span class="token punctuation">.</span>Linux系统文件及目录的权限设置最小化，禁止随意创建、更改、删除文件。
</code></pre> 
<p>原则的重要性</p> 
<pre><code class="prism language-powershell">1 提高安全防御机率
	大部分的安全攻击手段，都是借助于信息检测漏洞、权限管理漏洞、配置管理漏洞等因素导致，通过加强该有的安全防护手段，提高安全防御的机率。
2 降低危险范围扩大
	通过在相关场景实施最小权限手段，常用的恶意攻击手段造成的影响和作用范围就会缩小，降低同等安全等级的攻击影响。
3 加强安全体系建设
	通过多层次的权限体系设计，有助于保护关键业务系统的稳定运行，尤其是可以借助于最小权限原则来帮助或者证明项目操作活动的合规性。
</code></pre> 
<p>如何实施最小特权原则</p> 
<pre><code class="prism language-powershell">用户层面 <span class="token operator">-</span> 基于岗位角色划分与职位内容适配的权限
软件层面 <span class="token operator">-</span> 基于数据的请求进行数据信息正确性检测
操作层面 <span class="token operator">-</span> 根据场景的变化，灵活使用多层资源操作权限
管理层面 <span class="token operator">-</span> 命令审计机制、操作合规性、内部管理培训等，避免用户违规操作。
服务层面 <span class="token operator">-</span> 结合多种检测机制，有效监控和告警权限异常行为
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="112__96"></a>1.1.2 安全上下文</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、属性解析、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>容器基础</p> 
<pre><code class="prism language-powershell">	我们知道容器一般是基于 6个命名空间实现资源的隔离，而一个 Pod 就是一个容器集合，包含多个容器，那么在这种情况下，这几者命名空间是按照下面方式来使用的：
		<span class="token operator">-</span> 内部的所有容器共享底层 pause容器的 UTS<span class="token punctuation">|</span>Network 量个名称空间资源
		<span class="token operator">-</span> 可选共享命名空间：IPC，PID
		<span class="token operator">-</span> MNT和USER 两个命名空间默认没有让他们共享 <span class="token operator">--</span> 细节应用的隔离。
</code></pre> 
<p>Pod安全体系<br> <img src="https://images2.imgbox.com/6f/11/jV5HRswy_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	pod在其生命周期中，涉及到多种场景<span class="token punctuation">(</span>多容器的关联关系<span class="token punctuation">)</span>，我们将这种相关的作用关系 称为容器上下文，而涉及到权限、限制等安全相关的内容，我们称其为 安全上下文。
	我们也可以将其称之为 一组用于决定容器是如何创建和运行的约束条件，他们代表创建和运行容器时使用的运行时参数。
	它根据约束的作用范围主要包括三个级别：
		Pod级别：针对pod范围内的所有容器
		容器级别：仅针对pod范围内的指定容器
		PSP级别：PodSecurityPolicy，全局级别的Pod安全策略，涉及到准入控制相关知识
</code></pre> 
<p>Pod的策略安全性级别</p> 
<pre><code class="prism language-powershell">	Pod 安全性标准定义了三种不同的策略（Policy），以广泛覆盖安全应用场景。 这些策略是叠加式的（Cumulative），安全级别从高度宽松至高度受限。
	Privileged	
		不受限制的策略，提供最大可能范围的权限许可。此策略允许已知的特权提升。
		此类策略通常针对由特权较高、受信任的用户所管理的系统级或基础设施级负载。
	Baseline	
		限制性最弱的策略，禁止已知的策略提升。允许使用默认的（规定最少）Pod 配置。
		此策略针对的是应用运维人员和非关键性应用的开发人员。
	Restricted	
		限制性非常强的策略，遵循当前的保护 Pod 的最佳实践。
		该类策略主要针对运维人员和安全性很重要的应用的开发人员，以及不太被信任的用户。
注意：
	PSP安全策略则是控制面用来对安全上下文以及安全性上下文之外的参数实施某种设置的机制。在2020年7月， Pod 安全性策略已被废弃，取而代之的是内置的 Pod 安全性准入控制器。
</code></pre> 
<p>安全上下文作用</p> 
<pre><code class="prism language-powershell">安全上下文包括但不限于：
	自主访问控制<span class="token punctuation">(</span>Discretionary Access Control<span class="token punctuation">)</span>：基于用户ID和组ID来判定对对象的访问权限。
	安全性增强的Linux<span class="token punctuation">(</span>SELinux<span class="token punctuation">)</span>：为对象赋予安全性标签。
	以特权模式或者非特权模式运行。
	Linux 权能: 为进程赋予 root 用户的部分特权而非全部特权。
	AppArmor：使用程序配置来限制个别程序的权能。
	Seccomp：过滤进程的系统调用。
	allowPrivilegeEscalation：控制进程是否可以获得超出其父进程的特权。 
		以特权模式运行
		具有 CAP_SYS_ADMIN 权能
	readOnlyRootFilesystem：以只读方式加载容器的根文件系统。
</code></pre> 
<p>安全上下文属性</p> 
<pre><code class="prism language-powershell">apiVersion: v1
kind: Pod
metadata: <span class="token punctuation">{<!-- --></span>…<span class="token punctuation">}</span>
spec:
  securityContext:        					<span class="token comment"># Pod级别的安全上下文，对内部所有容器均有效</span>
    runAsUser &lt;integer&gt;   					<span class="token comment"># 以指定的用户身份运行容器进程，默认由镜像中的USER指定</span>
    runAsGroup &lt;integer&gt;   					<span class="token comment"># 以指定的用户组运行容器进程，默认使用的组随容器运行时</span>
    supplementalGroups  &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>integer&gt;  		<span class="token comment"># 为容器中1号进程的用户添加的附加组；</span>
    fsGroup &lt;integer&gt;  						<span class="token comment"># 为容器中的1号进程附加的一个专用组，其功能类似于sgid</span>
    runAsNonRoot &lt;boolean&gt;  				<span class="token comment"># 是否以非root身份运行</span>
    seLinuxOptions &lt;Object&gt;  				<span class="token comment"># SELinux的相关配置</span>
    sysctls  &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>Object&gt;  					<span class="token comment"># 应用到当前Pod上的名称或网络空间级别的sysctl参数设置列表</span>
    windowsOptions &lt;Object&gt;  				<span class="token comment"># Windows容器专用的设置</span>
  containers:
  <span class="token operator">-</span> name: …
    image: …
    securityContext:       					<span class="token comment"># 容器级别的安全上下文，仅生效于当前容器</span>
      runAsUser &lt;integer&gt;   				<span class="token comment"># 以指定的用户身份运行容器进程</span>
      runAsGroup &lt;integer&gt;   				<span class="token comment"># 以指定的用户组运行容器进程</span>
      runAsNonRoot &lt;boolean&gt;  				<span class="token comment"># 是否以非root身份运行</span>
      allowPrivilegeEscalation &lt;boolean&gt; 	<span class="token comment"># 是否允许特权升级</span>
      capabilities &lt;Object&gt;  				<span class="token comment"># 于当前容器上添加（add）或删除（drop）的操作内核某些资源的能力</span>
        add  &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;  					<span class="token comment"># 添加由列表格式定义的各内核能力</span>
        drop  &lt;<span class="token punctuation">[</span><span class="token punctuation">]</span>string&gt;  					<span class="token comment"># 移除由列表格式定义的各内核能力</span>
      privileged &lt;boolean&gt;  				<span class="token comment"># 是否运行为特权容器</span>
      procMount &lt;string&gt;   					<span class="token comment"># 设置容器的procMount类型，默认为DefaultProcMount；</span>
      readOnlyRootFilesystem &lt;boolean&gt; 		<span class="token comment"># 是否将根文件系统设置为只读模式</span>
      seLinuxOptions &lt;Object&gt;  				<span class="token comment"># SELinux的相关配置</span>
      windowsOptions &lt;Object&gt;  				<span class="token comment"># windows容器专用的设置</span>
      
注意：
	上面的属性，仅仅是最常用的属性，而不是所有的属性
	这些属性是在Pod资源对象的基础上来实施的
</code></pre> 
<p>属性解析</p> 
<pre><code class="prism language-powershell">容器用户级别的属性 
	runAsUser、runAsGroup	以指定的用户属性运行容器进程
相关的资源能力
    CAP_CHOWN				改变UID和GID
    CAP_MKNOD：				mknod<span class="token punctuation">(</span><span class="token punctuation">)</span>，创建设备文件； 
    CAP_NET_ADMIN			网络管理权限； 
    CAP_SYS_ADMIN 			大部分的管理权限； 
    CAP_NET_BIND_SERVER 	允许普通用户绑定1024以内的特权端口
    更多的CAP相关的属性可以通过 capsh <span class="token operator">--</span>print 命令来进行查看
特权权限能力
	修改宿主机相关内核参数
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>定制资源清单文件</p> 
<pre><code class="prism language-powershell">定制资源配置文件 01_kubernetes_server_secure_pod_test<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-web
spec:
  containers:
  <span class="token operator">-</span> name: nginx-web
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
    env:
    <span class="token operator">-</span> name: HELLO
      value: <span class="token string">"Hello Nginx"</span>
    
创建资源
kubectl apply <span class="token operator">-</span>f 01_kubernetes_server_secure_pod_test<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查效果
<span class="token comment"># kubectl get pod</span>
<span class="token comment"># kubectl exec -it nginx-web -- id</span>
uid=0<span class="token punctuation">(</span>root<span class="token punctuation">)</span> gid=0<span class="token punctuation">(</span>root<span class="token punctuation">)</span> 

</code></pre> 
<pre><code class="prism language-powershell">关闭资源
kubectl delete <span class="token operator">-</span>f 01_kubernetes_server_secure_pod_test<span class="token punctuation">.</span>yaml
</code></pre> 
<p>容器用户实践</p> 
<pre><code class="prism language-powershell">资源清单文件 02_kubernetes_server_secure_container_user<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-web
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
  containers:
  <span class="token operator">-</span> name: nginx-web
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
    env:
    <span class="token operator">-</span> name: HELLO
      value: <span class="token string">"Hello Nginx"</span>
  <span class="token operator">-</span> name: busybox-test
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
注意：
	这里使用的1000默认是容器内部的，而容器内部的1000本质上是映射宿主机上的1000id
	本地如果没有1000id，的话，<span class="token function">ps</span>查看的是1000，本地有1000的用户的话，<span class="token function">ps</span>查看到的是用户名
	如果忽略runAsGroup字段，则容器的主组 ID 将是 root（0）
    
创建资源
kubectl apply <span class="token operator">-</span>f 02_kubernetes_server_secure_container_user<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看pod运行在那个节点上
kubectl get pod nginx-web <span class="token operator">-</span>o wide

到制定node节点上用<span class="token function">ps</span>检查
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># id 1000</span>
uid=1000<span class="token punctuation">(</span>python<span class="token punctuation">)</span> gid=1000<span class="token punctuation">(</span>python<span class="token punctuation">)</span> 组=1000<span class="token punctuation">(</span>python<span class="token punctuation">)</span>
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># ps aux | grep python</span>
python    80649  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0    980     4 ?        Ss   12:54   0:00 <span class="token operator">/</span>pause
python    80803  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0   1304     4 ?        Ss   12:54   0:00 <span class="token function">sleep</span> 1h
结果显示：
	busybox容器运行的用户就是我们指定的
</code></pre> 
<pre><code class="prism language-powershell">由于容器内部的应用想要使用普通用户执行，必须让程序支持普通用户，否则的话容器应用无法正常运行
<span class="token punctuation">]</span><span class="token comment"># kubectl logs nginx-web -c nginx-web</span>
<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/startup<span class="token punctuation">.</span>sh: line 5: <span class="token operator">/</span>usr/share/nginx/html/index<span class="token punctuation">.</span>html: Permission denied
2022/09/11 04:54:18 <span class="token namespace">[warn]</span> 7<span class="token comment">#7: the "user" directive makes sense only if the master process runs with super-user privileges, ignored in /etc/nginx/nginx.conf:2</span>
nginx: <span class="token namespace">[warn]</span> the <span class="token string">"user"</span> directive makes sense only <span class="token keyword">if</span> the master <span class="token keyword">process</span> runs with super-user privileges<span class="token punctuation">,</span> ignored in <span class="token operator">/</span>etc/nginx/nginx<span class="token punctuation">.</span>conf:2
2022/09/11 04:54:18 <span class="token namespace">[emerg]</span> 7<span class="token comment">#7: mkdir() "/var/cache/nginx/client_temp" failed (13: Permission denied)</span>
nginx: <span class="token namespace">[emerg]</span> mkdir<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token string">"/var/cache/nginx/client_temp"</span> failed <span class="token punctuation">(</span>13: Permission denied<span class="token punctuation">)</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="113__314"></a>1.1.3 资源实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 容器级别、禁用root、小结 三个方面来学习。</p> 
<p><strong>容器级别</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">Security Context有两种作用范围：
	Pod 内部所有应用容器 
		<span class="token operator">-</span> pod<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>securityContext
	Pod 内部特定的应用容器
		<span class="token operator">-</span> pod<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers<span class="token punctuation">.</span>securityContext
注意：
	这两种安全上下文的定制，容器内部的优先级要高一些。
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">资源对象文件 03_kubernetes_server_secure_container_user<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test
spec:
  securityContext:
    runAsUser: 1000
    runAsGroup: 1000
  containers:
  <span class="token operator">-</span> name: busybox-test
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    securityContext:
      runAsUser: 2000
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 03_kubernetes_server_secure_container_user<span class="token punctuation">.</span>yaml

确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it busybox-test -- id</span>
uid=2000 gid=1000
结果显示：
	容器内部的安全上下文等级高一些
	
还原环境
kubectl delete <span class="token operator">-</span>f 03_kubernetes_server_secure_container_user<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>禁用root</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	默认情况下，容器的启用是以root用户身份来进行启动的，有时候，我们为了提升容器的运行安全，会禁止容器使用root身份进行启动。对于这种场景，我们可以在securityContext中通过runAsNonRoot属性来快速实现。
</code></pre> 
<pre><code class="prism language-powershell">	如果 runAsNonRoot 字段配置为 true，kubelet 在启动容器时会进行检查，如果以 UID 为 0 运行，则禁止容器启动，该 Pod 的 STATUS 变为 CreateContainerConfigError，并生成 Warning 类型事件 Error: container has runAsNonRoot and image will run as root。只有当设置 runAsUser 或者镜像本身就不是以 Root 身份运行时，该 Pod 才能正常启动。
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">资源对象文件 04_kubernetes_server_secure_container_noroot<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test
spec:
  securityContext:
    runAsNonRoot: yes
  containers:
  <span class="token operator">-</span> name: busybox-test
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
  <span class="token operator">-</span> name: busybox-test2
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    securityContext:
      runAsUser: 2000
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 04_kubernetes_server_secure_container_noroot<span class="token punctuation">.</span>yaml

确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl get pod</span>
NAME           READY   STATUS                       RESTARTS      AGE
busybox-test   1/2     CreateContainerConfigError   0             5s
<span class="token punctuation">]</span><span class="token comment"># kubectl describe pod busybox-test</span>
Events:
  <span class="token function">Type</span>     Reason     Age               <span class="token keyword">From</span>               Message
  <span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span>              <span class="token operator">--</span><span class="token operator">--</span>               <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  Warning  Failed     0s <span class="token punctuation">(</span>x4 over 14s<span class="token punctuation">)</span>  kubelet            Error: container has runAsNonRoot and image will run as root <span class="token punctuation">(</span>pod: <span class="token string">"busybox-test_default(7921d9a1-640e-4c22-a211-948d5215f27b)"</span><span class="token punctuation">,</span> container: busybox-test<span class="token punctuation">)</span>
结果显示：
	容器因为安全上下文的属性而无法启动，只有满足条件的应用容器才可以正常启动
	
还原环境
kubectl delete <span class="token operator">-</span>f 04_kubernetes_server_secure_container_noroot<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="114__435"></a>1.1.4 特权基础</h4> 
<p>学习目标</p> 
<p>这一节，我们从 特权解读、内核实践、小结 三个方面来学习。</p> 
<p><strong>特权解读</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	默认情况下，容器是不可以访问宿主上的任何设备的，这可以实现一定程度上的容器安全，但是因为一些开发场景的需求 <span class="token operator">--</span> Docker-in-Docker，即在Docker的基础上，可以模拟宿主机操作docker等超越容器本身权限的一些功。像这种能够在容器内部执行特权指令的模式，我们把它们称之为特权模式。
</code></pre> 
<p><img src="https://images2.imgbox.com/74/5d/e289k086_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">	注意：特权模式是为了方便容器应用在一定程度上能够操作宿主机相关的权限，但是无论是细粒度权限控制还是其他安全机制，用户都可以通过修改容器环境配置或在运行容器时指定参数来缩小或扩大约束。但是如果用户为不完全受控的容器提供了一些危险的配置参数，就为恶意攻击者提供了一定程度的攻击可能性。
</code></pre> 
<pre><code class="prism language-powershell">示例：kubernetes的kube-proxy组件，它以pod样式存在，它的主要目的就是pod的流量访问规则的转换，也就是说它需要使用宿主机的内核功能，实现一些防火墙策略的规则生效，我们来看一下它的yaml文件是如何定制的。
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubectl get pod kube-proxy-594xs -n kube-system -o yaml</span>
apiVersion: v1
kind: Pod
metadata:
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  name: kube-proxy-594xs
  namespace: kube-system
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
spec:
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  containers:
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    securityContext:
      privileged: true
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">为了让pod获取宿主机内核的完整权限，pod 需要在特权模式下运行。这可以通过将容器securityContext 中的 privileged 设置为true实现。
</code></pre> 
<pre><code class="prism language-powershell">资源清单文件 05_kubernetes_server_secure_container_privileged<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test
spec:
  containers:
  <span class="token operator">-</span> name: busybox-test
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
  <span class="token operator">-</span> name: busybox-test2
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    securityContext:
      privileged: true
注意：
	这里使用securityContext 的 privileged 属性来开启pod的特权模式
	
应用资源对象
kubectl apply <span class="token operator">-</span>f 05_kubernetes_server_secure_container_privileged<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">查看效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/server_secure]</span><span class="token comment"># kubectl exec -it busybox-test -c busybox-test -- ls /dev</span>
core             null             shm              termination-log
fd               ptmx             stderr           tty
full             pts              stdin            urandom
mqueue           random           stdout           zero
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/server_secure]</span><span class="token comment"># kubectl exec -it busybox-test -c busybox-test2 -- ls /dev/sd*</span>
<span class="token operator">/</span>dev/sda   <span class="token operator">/</span>dev/sda1  <span class="token operator">/</span>dev/sda2  <span class="token operator">/</span>dev/sdb   <span class="token operator">/</span>dev/sdc
结果显示：
	特权模式下的pod可以看到宿主机的很多内容
</code></pre> 
<p><strong>内核实践</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	从 Kubernetes 1<span class="token punctuation">.</span>23 版本开始，kubelet 支持使用 <span class="token operator">/</span> 或 <span class="token punctuation">.</span> 作为 sysctl 参数的分隔符。 从 Kubernetes 1<span class="token punctuation">.</span>25 版本开始，支持为 Pod 设置 sysctl 时使用设置名字带有斜线的 sysctl。 也就是说，我们可以以如下的样式来设定系统的内核参数：
		点样式：kernel<span class="token punctuation">.</span>shm_rmid_forced
		<span class="token operator">/</span>样式：kernel/shm_rmid_forced
更多的内核参数：
	https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>kernel<span class="token punctuation">.</span>org/doc/Documentation/sysctl/README
</code></pre> 
<p>内核参数</p> 
<pre><code class="prism language-powershell">	sysctl 参数分为安全和非安全的。 安全的 sysctl参数除了需要设置恰当的命名空间外，在同一节点上的不同Pod之间也必须是相互隔离的。这意味着Pod上设置安全sysctl参数有以下限制：
    必须不能影响到节点上的其他 Pod
    必须不能损害节点的健康
    必须不允许使用超出 Pod 的资源限制的 CPU 或内存资源。
</code></pre> 
<pre><code class="prism language-powershell">大多数 有命名空间的 sysctl 参数不一定被认为是 安全 的。 以下几种 sysctl 参数是 安全的：
    kernel<span class="token punctuation">.</span>shm_rmid_forced		
    	表示是否强制将共享内存和一个进程联系在一起，这样的话可以通过杀死进程来释放共享内存
    net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_local_port_range	
    	表示pod允许使用的端口范围，示例：1024 65000
    net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_syncookies
    	表示是否打开TCP同步标签，同步标签可以防止一个套接字在有过多试图连接时引起过载
    net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ping_group_range（从 Kubernetes 1<span class="token punctuation">.</span>18 开始）
    net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>ip_unprivileged_port_start（从 Kubernetes 1<span class="token punctuation">.</span>22 开始）。
    注意：
    	net<span class="token punctuation">.</span>ipv4<span class="token punctuation">.</span>tcp_syncookies 在Linux 内核 4<span class="token punctuation">.</span>4 或更低的版本中是无命名空间的。
</code></pre> 
<pre><code class="prism language-powershell">注意：
	所有安全的sysctl参数都默认启用，所有非安全的sysctl 参数都默认禁用，且必须由集群管理员在每个节点上手动开启。那些设置了不安全sysctl参数的Pod仍会被调度，但默认情况下无法正常启动。
	如需启用非安全的 sysctl参数，需要在每个节点上分别设置 kubelet 命令行参数，例如：
		kubelet <span class="token operator">--</span>allowed-unsafe-sysctls  <span class="token string">'参数1,参数2'</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">准备工作，kubernetes-node2 开启非安全参数，修改 kubelet的配置文件
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># vim /etc/sysconfig/kubelet</span>
KUBELET_EXTRA_ARGS=<span class="token string">'--allowed-unsafe-sysctls=net.core.somaxconn'</span>

参数解析：
	net<span class="token punctuation">.</span>core<span class="token punctuation">.</span>somaxconn						网卡入栈的最大连接数
	
在所有的node角色节点上配置该文件，然后重启该服务
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># systemctl restart kubelet</span>
</code></pre> 
<pre><code class="prism language-powershell">资源清单文件 06_kubernetes_server_secure_container_privileged_sysctl<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test1
spec:
  securityContext:
    sysctls:
      <span class="token operator">-</span> name: net<span class="token punctuation">.</span>core<span class="token punctuation">.</span>somaxconn
        value: <span class="token string">"6666"</span>
  nodeName: kubernetes-node1
  containers:
  <span class="token operator">-</span> name: busybox-test1
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test2
spec:
  securityContext:
    sysctls:
      <span class="token operator">-</span> name: net<span class="token punctuation">.</span>core<span class="token punctuation">.</span>somaxconn
        value: <span class="token string">"6666"</span>
  nodeName: kubernetes-node2
  containers:
  <span class="token operator">-</span> name: busybox-test2
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
属性解析：
	net<span class="token punctuation">.</span>core<span class="token punctuation">.</span>somaxconn 表示socket监听的队列数量上限
	
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 06_kubernetes_server_secure_container_privileged_sysctl<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">检查效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/server_secure]</span><span class="token comment"># kubectl get pod</span>
NAME                                  READY   STATUS            RESTARTS     AGE
busybox-test1                         0/1     SysctlForbidden   0            13s
busybox-test2                         1/1     Running           0            13s

查看报错
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/server_secure]</span><span class="token comment"># kubectl describe pod busybox-test1</span>
Name:         busybox-test1
Namespace:    default
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Events:
  <span class="token function">Type</span>     Reason           Age   <span class="token keyword">From</span>     Message
  <span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>           <span class="token operator">--</span><span class="token operator">--</span>  <span class="token operator">--</span><span class="token operator">--</span>     <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>
  Warning  SysctlForbidden  92s   kubelet  forbidden sysctl: <span class="token string">"net.core.somaxconn"</span> not allowlisted
结果显示：
	
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="115__637"></a>1.1.5 特权实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 特权粒度、简单实践、小结 三个方面来学习。</p> 
<p><strong>特权粒度</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	当我们为pod启用特权模式之后，就意味着我们为pod内部的容器提供了访问linux内核的所有能力，虽然k8s对于部分的内核参数做了一些所谓的策略限制，但是毕竟这还是很危险的，所以我们为了进一步提升特权模式下的安全，我们可以减少内核系统调用的供给 <span class="token operator">--</span> 使用Capabilities属性来限制能够使用的特权操作指令
	Capabiliteis 是一个内核级别的权限，它允许对内核调用权限进行更细力度的控制，而不是简单地以root身份进行资源的授权，这些权限包括文件权限、网络系统、系统管理等功能。
</code></pre> 
<pre><code class="prism language-powershell">简单来说：
	privileged 属性的使用，代表启用特权模式
		安全风险比较大，不懂的话，不要乱用
	Capabilities 的目的是限制某些特殊权限的使用
</code></pre> 
<pre><code class="prism language-powershell">查看常见的Capabilities权限内容
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># capsh --print</span>
Current: = cap_chown<span class="token punctuation">,</span>cap_dac_override<span class="token punctuation">,</span>cap_dac_read_search<span class="token punctuation">,</span>cap_fowner<span class="token punctuation">,</span>cap_fsetid<span class="token punctuation">,</span>cap_kill<span class="token punctuation">,</span>cap_setgid<span class="token punctuation">,</span>cap_setuid<span class="token punctuation">,</span>cap_setpcap<span class="token punctuation">,</span>cap_linux_immutable<span class="token punctuation">,</span>cap_net_bind_service<span class="token punctuation">,</span>cap_net_broadcast<span class="token punctuation">,</span>cap_net_admin<span class="token punctuation">,</span>cap_net_raw<span class="token punctuation">,</span>cap_ipc_lock<span class="token punctuation">,</span>cap_ipc_owner<span class="token punctuation">,</span>cap_sys_module<span class="token punctuation">,</span>cap_sys_rawio<span class="token punctuation">,</span>cap_sys_chroot<span class="token punctuation">,</span>cap_sys_ptrace<span class="token punctuation">,</span>cap_sys_pacct<span class="token punctuation">,</span>cap_sys_admin<span class="token punctuation">,</span>cap_sys_boot<span class="token punctuation">,</span>cap_sys_nice<span class="token punctuation">,</span>cap_sys_resource<span class="token punctuation">,</span>cap_sys_time<span class="token punctuation">,</span>cap_sys_tty_config<span class="token punctuation">,</span>cap_mknod<span class="token punctuation">,</span>cap_lease<span class="token punctuation">,</span>cap_audit_write<span class="token punctuation">,</span>cap_audit_control<span class="token punctuation">,</span>cap_setfcap<span class="token punctuation">,</span>cap_mac_override<span class="token punctuation">,</span>cap_mac_admin<span class="token punctuation">,</span>cap_syslog<span class="token punctuation">,</span>35<span class="token punctuation">,</span>36+ep
Bounding <span class="token function">set</span> =cap_chown<span class="token punctuation">,</span>cap_dac_override<span class="token punctuation">,</span>cap_dac_read_search<span class="token punctuation">,</span>cap_fowner<span class="token punctuation">,</span>cap_fsetid<span class="token punctuation">,</span>cap_kill<span class="token punctuation">,</span>cap_setgid<span class="token punctuation">,</span>cap_setuid<span class="token punctuation">,</span>cap_setpcap<span class="token punctuation">,</span>cap_linux_immutable<span class="token punctuation">,</span>cap_net_bind_service<span class="token punctuation">,</span>cap_net_broadcast<span class="token punctuation">,</span>cap_net_admin<span class="token punctuation">,</span>cap_net_raw<span class="token punctuation">,</span>cap_ipc_lock<span class="token punctuation">,</span>cap_ipc_owner<span class="token punctuation">,</span>cap_sys_module<span class="token punctuation">,</span>cap_sys_rawio<span class="token punctuation">,</span>cap_sys_chroot<span class="token punctuation">,</span>cap_sys_ptrace<span class="token punctuation">,</span>cap_sys_pacct<span class="token punctuation">,</span>cap_sys_admin<span class="token punctuation">,</span>cap_sys_boot<span class="token punctuation">,</span>cap_sys_nice<span class="token punctuation">,</span>cap_sys_resource<span class="token punctuation">,</span>cap_sys_time<span class="token punctuation">,</span>cap_sys_tty_config<span class="token punctuation">,</span>cap_mknod<span class="token punctuation">,</span>cap_lease<span class="token punctuation">,</span>cap_audit_write<span class="token punctuation">,</span>cap_audit_control<span class="token punctuation">,</span>cap_setfcap<span class="token punctuation">,</span>cap_mac_override<span class="token punctuation">,</span>cap_mac_admin<span class="token punctuation">,</span>cap_syslog<span class="token punctuation">,</span>35<span class="token punctuation">,</span>36
Securebits: 00/0x0/1'b0
 secure-noroot: no <span class="token punctuation">(</span>unlocked<span class="token punctuation">)</span>
 secure-no-suid-fixup: no <span class="token punctuation">(</span>unlocked<span class="token punctuation">)</span>
 secure-keep-caps: no <span class="token punctuation">(</span>unlocked<span class="token punctuation">)</span>
uid=0<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
gid=0<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
groups=0<span class="token punctuation">(</span>root<span class="token punctuation">)</span>
</code></pre> 
<pre><code class="prism language-powershell">常见属性解析
	CAP_CHOWN：改变UID和GID； 
    CAP_MKNOD：mknod<span class="token punctuation">(</span><span class="token punctuation">)</span>，创建设备文件； 
    CAP_NET_ADMIN：网络管理权限； 
    CAP_SYS_ADMIN：大部分的管理权限； 
    CAP_SYS_TIME：更改系统的时钟
    CAP_SYS_MODULE：装载卸载内核模块
    CAP_NET_BIND_SERVER：允许普通用户绑定1024以内的特权端口
</code></pre> 
<pre><code class="prism language-powershell">配置样式
    securityContext:
      capabilities:
        add: <span class="token punctuation">[</span><span class="token string">"NET_ADMIN"</span><span class="token punctuation">,</span><span class="token string">"SYS_TIME"</span><span class="token punctuation">]</span>		<span class="token comment"># 增加属性</span>
        drop: <span class="token punctuation">[</span><span class="token string">"CHOWN"</span><span class="token punctuation">]</span>						<span class="token comment"># 删减属性</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">构建nginx专属镜像，增加Dockerfile的暴露端口8000和iptables环境
<span class="token namespace">[root@kubernetes-master1 /data/images/web/nginx]</span><span class="token comment"># cat Dockerfile</span>
<span class="token comment"># 构建一个基于nginx的定制镜像</span>
<span class="token comment"># 基础镜像</span>
<span class="token keyword">FROM</span> kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx
<span class="token comment"># 镜像作者</span>
MAINTAINER shuji@superopsmsb<span class="token punctuation">.</span>com

<span class="token comment"># 增加iptables命令</span>
RUN apt update &amp;&amp; apt install iptables <span class="token operator">-</span>y

<span class="token comment"># 添加文件</span>
ADD scripts/startup<span class="token punctuation">.</span>sh <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/startup<span class="token punctuation">.</span>sh

<span class="token comment"># 执行命令</span>
CMD <span class="token punctuation">[</span><span class="token string">"/bin/bash"</span><span class="token punctuation">,</span> <span class="token string">"/data/scripts/startup.sh"</span><span class="token punctuation">]</span>

<span class="token comment"># 开放端口</span>
EXPOSE 80 443 8000
</code></pre> 
<pre><code class="prism language-powershell">构建镜像
docker build <span class="token operator">-</span>t kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>3 <span class="token punctuation">.</span>
提交镜像
docker push kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>3
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">资源清单文件：07_kubernetes_server_secure_container_privileged_capabilities<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx-web1
spec:
  containers:
  <span class="token operator">-</span> name: nginx
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>3
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Pod
metadata:
  name: nginx-web2
spec:
  containers:
  <span class="token operator">-</span> name: nginx
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>3
    securityContext:
      capabilities:
        add: <span class="token punctuation">[</span><span class="token string">"NET_ADMIN"</span><span class="token punctuation">,</span><span class="token string">"SYS_TIME"</span><span class="token punctuation">]</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Pod
metadata:
  name: nginx-web3
spec:
  containers:
  <span class="token operator">-</span> name: nginx
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>3
    securityContext:
      capabilities:
        add: <span class="token punctuation">[</span><span class="token string">"NET_ADMIN"</span><span class="token punctuation">,</span><span class="token string">"SYS_TIME"</span><span class="token punctuation">]</span>
        drop: <span class="token punctuation">[</span><span class="token string">"CHOWN"</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-powershell">nginx-web1测试效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/server_secure]</span><span class="token comment"># kubectl exec -it nginx-web1 -- /bin/bash</span>
root@nginx-web1:<span class="token operator">/</span><span class="token comment"># date</span>
Mon Sep 12 00:44:53 UTC 2062
root@nginx-web1:<span class="token operator">/</span><span class="token comment"># date -s 19:09</span>
date: cannot <span class="token function">set</span> date: Operation not permitted
Mon Sep 12 19:09:00 UTC 2062

root@nginx-web1:<span class="token operator">/</span><span class="token comment"># iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8000</span>
结果显示：
	nginx-web1 上不可以更改系统的时间，也不允许设定iptabels防火墙
</code></pre> 
<pre><code class="prism language-powershell">nginx-web2测试效果
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubectl exec -it nginx-web2 -- /bin/bash</span>
root@nginx-web2:<span class="token operator">/</span><span class="token comment"># date -s 19:09</span>
Mon Sep 12 19:09:00 UTC 2062
root@nginx-web1:<span class="token operator">/</span><span class="token comment"># iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8000</span>
root@nginx-web1:<span class="token operator">/</span><span class="token comment"># iptables -vnL -t nat</span>
结果显示：
	nginx-web2 上可以更改系统的时间还可以设定iptables防火墙
</code></pre> 
<pre><code class="prism language-powershell">nginx-web2测试效果
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubectl logs  nginx-web3</span>
2022/09/12 19:09:08 <span class="token namespace">[emerg]</span> 7<span class="token comment">#7: chown("/var/cache/nginx/client_temp", 101) failed (1: Operation not permitted)</span>
nginx: <span class="token namespace">[emerg]</span> chown<span class="token punctuation">(</span><span class="token string">"/var/cache/nginx/client_temp"</span><span class="token punctuation">,</span> 101<span class="token punctuation">)</span> failed <span class="token punctuation">(</span>1: Operation not permitted<span class="token punctuation">)</span>
结果显示：
	因为我们将相关权限命令移除了，所以服务无法启动
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="115_PSP_806"></a>1.1.5 PSP实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 案例解读、准入实践、小结 三个方面来学习。</p> 
<p><strong>案例解读</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	我们曾经学习过的PSP，它的目的就是基于内置准入控制器的作用，实现pod级别的更加精细化的能力控制
</code></pre> 
<p>启用psp功能</p> 
<pre><code class="prism language-powershell">编辑 <span class="token operator">/</span>etc/kubernetes/manifests/kube-apiserver<span class="token punctuation">.</span>yaml 文件，添加如下配置
	<span class="token operator">--</span><span class="token function">enable-admission</span><span class="token operator">-</span>plugins=NodeRestriction<span class="token punctuation">,</span>PodSecurityPolicy
	
由于kubeadm集群中，api-server是以静态pod的方式来进行管控的，所以我们不用重启，稍等一会，环境自然就开启了PSP功能
</code></pre> 
<pre><code class="prism language-powershell">因为PSP默认已经禁用所有的pod创建权限，所以默认情况下，我们也看不到api-server的pod的
kubectl get pod <span class="token operator">-</span>n kube-system <span class="token punctuation">|</span> grep api
注意：
	如果出现api-server的pod，是因为其他master启用PSP太慢导致的。

我们只能通过端口方式来进行检测
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># netstat -atnulp | grep 6443</span>
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:52818         10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:6443          ESTABLISHED 108627/kube-control
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:36852         10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>200:6443         ESTABLISHED 127389/kubelet
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:52350         10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:6443          ESTABLISHED 123701/kube-schedul
tcp        0      0 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>12:36314         10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>200:6443         ESTABLISHED 3109/kube-proxy
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	只要我们能够看到 6443，说明kube-apiserver服务已经启动成功了
</code></pre> 
<pre><code class="prism language-powershell">测试效果
kubectl run nginx-web <span class="token operator">--</span>image kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
kubectl get pod
</code></pre> 
<p><strong>准入实践</strong></p> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">资源清单文件 08_kubernetes_server_secure_container_privileged_psp<span class="token punctuation">.</span>yaml
apiVersion: policy/v1beta1
kind: PodSecurityPolicy
metadata:
  name: psp-restrictive
spec:
  privileged: false  <span class="token comment"># 禁用特权模式</span>
  runAsUser:
    rule: MustRunAsNonRoot: yes
  fsGroup:
    rule: RunAsAny
  supplementalGroups:
    rule: RunAsAny
  volumes:
  <span class="token operator">-</span> <span class="token string">'*'</span>
  
创建资源对象
kubectl apply <span class="token operator">-</span>f 08_kubernetes_server_secure_container_privileged_psp<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">定制角色权限
kubectl create clusterrole psp-restrictive <span class="token operator">--</span>verb=use <span class="token operator">--</span>resource=podsecuritypolicies <span class="token operator">--</span>resource-name=psp-restrictive <span class="token operator">--</span>dry-run=client

kubectl create clusterrole psp-restrictive <span class="token operator">--</span>verb=use <span class="token operator">--</span>resource=podsecuritypolicies <span class="token operator">--</span>resource-name=psp-restrictive <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml &gt;&gt; 09_kubernetes_server_secure_container_privileged_rbac<span class="token punctuation">.</span>yaml
<span class="token function">echo</span> <span class="token string">'---'</span> &gt;&gt; 09_kubernetes_server_secure_container_privileged_rbac<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">定制角色授权
kubectl create clusterrolebinding psp-restrictive <span class="token operator">--</span>clusterrole=psp-restrictive <span class="token operator">--</span><span class="token function">group</span>=<span class="token string">"system:serviceaccounts"</span> <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml

kubectl create clusterrolebinding psp-restrictive <span class="token operator">--</span>clusterrole=psp-restrictive <span class="token operator">--</span><span class="token function">group</span>=<span class="token string">"system:serviceaccounts"</span> <span class="token operator">--</span>dry-run=client <span class="token operator">-</span>o yaml &gt;&gt; 09_kubernetes_server_secure_container_privileged_rbac<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 09_kubernetes_server_secure_container_privileged_rbac<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">测试效果
kubectl delete pod nginx-web
kubectl run nginx-web <span class="token operator">--</span>image kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
kubectl get pod
结果显示：
	正常的资源可以正常的创建
</code></pre> 
<pre><code class="prism language-powershell">清理环境
kubectl delete <span class="token operator">-</span>f 08_kubernetes_server_secure_container_privileged_psp<span class="token punctuation">.</span>yaml
kubectl delete <span class="token operator">-</span>f 09_kubernetes_server_secure_container_privileged_rbac<span class="token punctuation">.</span>yaml
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h3><a id="12__924"></a>1.2 策略方案</h3> 
<h4><a id="121_OPA_926"></a>1.2.1 OPA简介</h4> 
<p>学习目标</p> 
<p>这一节，我们从 场景解读、细节解读、小结 三个方面来学习。</p> 
<p><strong>场景解读</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	虽然我们可以借助于RBAC <span class="token operator">+</span> PSP <span class="token operator">+</span> 安全上下文 能够实现相当层次的pod应用安全<span class="token punctuation">(</span>包括对特权容器、主机网络、Capability、加载卷类型等内容进行限制<span class="token punctuation">)</span>，但是这套方案有以下限制：
	1 PSP 在1<span class="token punctuation">.</span>21版本就被弃用，在1<span class="token punctuation">.</span>25版本被删除 <span class="token operator">--</span> 整合进准入控制器
	2 PSP 仅仅支持Pod级别的策略
	3 方案使用起来很复杂，而且操作的技术门槛较高，容易引起很大的漏洞。
</code></pre> 
<pre><code class="prism language-powershell">	对于Kubernetes来说，虽然未来弃用了PSP能力，但是对于CIS Kubernetes Benchmark来说，它目前仍然将PSP作为集群安全加固的检测条目，而且很多Kubernetes 安全相关软件也会据此进行检查。所以我们有必要在未来的Kubernetes版本中去寻找PSP的替代方案，常见的替代方案有：
	升级 PSP
		<span class="token operator">-</span> 加强PSP能力
    第三方策略引擎
    	OPA Gatekeeper 和 Kyverno，从另外一条路实现PSP的能力
    缺省启用宽松策略
    	<span class="token operator">-</span> 特殊应用无需PSP的能力
</code></pre> 
<pre><code class="prism language-powershell">参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/docs/concepts/security/pod-security-policy/
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/zh-cn/docs/tasks/configure-pod-container/migrate-<span class="token keyword">from</span><span class="token operator">-</span>psp/
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/blog/2021/04/06/podsecuritypolicy-deprecation-past-present-and-future/
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/blog/2019/08/06/opa-gatekeeper-policy-and-governance-<span class="token keyword">for</span><span class="token operator">-</span>kubernetes/
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/<span class="token function">open-policy</span><span class="token operator">-</span>agent/gatekeeper
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/kyverno/kyverno
</code></pre> 
<p>功能定位</p> 
<pre><code class="prism language-powershell">	如果您需要在 Kubernetes平台上寻找如何控制终端用户在集群上的行为，以及如何确保集群符合公司政策，或者说在不牺牲开发敏捷性和运营独立性的前提下确保运维合规性的话，以下策略是可以参考的点：
    所有镜像必须来自获得批准的存储库
    所有入口主机名必须是全局唯一的
    所有 Pod 必须有资源限制
    所有命名空间都必须具有列出联系的标签
	
	策略引擎的目的是使用户能够通过配置（而不是代码）自定义控制许可，并使用户了解集群的状态，而不仅仅是针对评估状态的单个对象，在这些对象准许加入的时候。大量的第三方策略引擎产品中，Gatekeeper是Kubernetes的一个可定制的许可webhook，它由Open Policy Agent <span class="token punctuation">(</span>OPA<span class="token punctuation">)</span>强制执行，OPA是Cloud Native环境下的策略引擎，由 CNCF 维护。
</code></pre> 
<p>引擎简介</p> 
<pre><code class="prism language-powershell">	Gatekeeper的发展现后经历了 v1<span class="token punctuation">.</span>0、v2<span class="token punctuation">.</span>0、v3<span class="token punctuation">.</span>0的阶段，前两个阶段是以sidecar的方式来存在，目前它是以准入控制器的方式集成在一起，用来实施基于 CRD 的策略，并可以可靠地共享已完成声明配置的策略。
	Gatekeeper目前的策略相关的配置需要借助于Rego语法来定制策略模板。
	官方文档：
		https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>openpolicyagent<span class="token punctuation">.</span>org/
		https:<span class="token operator">/</span><span class="token operator">/</span>play<span class="token punctuation">.</span>openpolicyagent<span class="token punctuation">.</span>org/
</code></pre> 
<p><img src="https://images2.imgbox.com/e8/a5/uNHXhEzQ_o.png" alt="在这里插入图片描述"></p> 
<p><strong>细节解读</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	Gatekeeper 是基于OPA的一个Kubernetes策略解决方案，可以从另外一个角度实现PSP+RBAC+安全上下文的部分功能。对于Gatekeeper来说，我们需要部署相关的环境组件，然后作为APIServer的代理人来存在，用于对所有资源的创建、更新、删除操作请求的校验，只有校验通过的请求才可以进行正常的执行，否则就被拒绝
</code></pre> 
<p><img src="https://images2.imgbox.com/2d/ef/banNuZyQ_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">github地址：
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/<span class="token function">open-policy</span><span class="token operator">-</span>agent/gatekeeper
	https:<span class="token operator">/</span><span class="token operator">/</span><span class="token function">open-policy</span><span class="token operator">-</span>agent<span class="token punctuation">.</span>github<span class="token punctuation">.</span>io/gatekeeper/website/docs/install/
</code></pre> 
<p>环境部署</p> 
<pre><code class="prism language-powershell">获取资源对象
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/server_secure
mkdir gatekeeper &amp;&amp; cd gatekeeper
wget https:<span class="token operator">/</span><span class="token operator">/</span>raw<span class="token punctuation">.</span>githubusercontent<span class="token punctuation">.</span>com/<span class="token function">open-policy</span><span class="token operator">-</span>agent/gatekeeper/master/deploy/gatekeeper<span class="token punctuation">.</span>yaml
<span class="token function">cp</span> gatekeeper<span class="token punctuation">.</span>yaml<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span><span class="token punctuation">.</span>bak<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">查看镜像文件
<span class="token punctuation">]</span><span class="token comment"># grep image: gatekeeper.yaml | uniq</span>
        image: openpolicyagent/gatekeeper:v3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-beta<span class="token punctuation">.</span>1

获取镜像
docker pull openpolicyagent/gatekeeper:v3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-beta<span class="token punctuation">.</span>1
docker tag openpolicyagent/gatekeeper:v3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-beta<span class="token punctuation">.</span>1 kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/gatekeeper:v3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-beta<span class="token punctuation">.</span>1
docker push kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/google_containers/gatekeeper:v3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-beta<span class="token punctuation">.</span>1
docker rmi openpolicyagent/gatekeeper:v3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-beta<span class="token punctuation">.</span>1

修改文件
sed <span class="token operator">-</span>i <span class="token string">'s#openpolicyagent#kubernetes-register.superopsmsb.com/google_containers#g'</span> gatekeeper<span class="token punctuation">.</span>yaml

确认效果
<span class="token punctuation">]</span><span class="token comment"># grep image: gatekeeper.yaml | uniq                    image: kubernetes-register.superopsmsb.com/google_containers/gatekeeper:v3.10.0-beta.1</span>
</code></pre> 
<p>部署Gatekeeper</p> 
<pre><code class="prism language-powershell">应用资源对象
kubectl apply <span class="token operator">-</span>f gatekeeper<span class="token punctuation">.</span>yaml

确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl get all -n gatekeeper-system</span>
NAME                                                 READY   STATUS    RESTARTS   AGE
pod/gatekeeper-audit-574546775d-245k2                1/1     Running   0          32s
pod/gatekeeper-controller-manager-7bfd877599-j2nzc   1/1     Running   0          32s
pod/gatekeeper-controller-manager-7bfd877599-mj4wv   1/1     Running   0          32s
pod/gatekeeper-controller-manager-7bfd877599-tmx75   1/1     Running   0          32s

NAME                                 <span class="token function">TYPE</span>        CLUSTER-IP      EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
service/gatekeeper-webhook-service   ClusterIP   10<span class="token punctuation">.</span>110<span class="token punctuation">.</span>191<span class="token punctuation">.</span>72   &lt;none&gt;        443/TCP   33s

NAME                                            READY   UP-TO-DATE   AVAILABLE   AGE
deployment<span class="token punctuation">.</span>apps/gatekeeper-audit                1/1     1            1           33s
deployment<span class="token punctuation">.</span>apps/gatekeeper-controller-manager   3/3     3            3           33s

NAME                                                       DESIRED   CURRENT   READY   AGE
replicaset<span class="token punctuation">.</span>apps/gatekeeper-audit-574546775d                1         1         1       33s
replicaset<span class="token punctuation">.</span>apps/gatekeeper-controller-manager-7bfd877599   3         3         3       33s
</code></pre> 
<pre><code class="prism language-powershell">确认CRD资源
<span class="token punctuation">]</span><span class="token comment"># kubectl get crd | grep gate</span>
assign<span class="token punctuation">.</span>mutations<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh                        2062-09-12T03:38:24Z
assignmetadata<span class="token punctuation">.</span>mutations<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh                2062-09-12T03:38:25Z
configs<span class="token punctuation">.</span>config<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh                          2062-09-12T03:38:25Z
constraintpodstatuses<span class="token punctuation">.</span>status<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh            2062-09-12T03:38:25Z
constrainttemplatepodstatuses<span class="token punctuation">.</span>status<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh    2062-09-12T03:38:25Z
constrainttemplates<span class="token punctuation">.</span>templates<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh           2062-09-12T03:38:25Z
modifyset<span class="token punctuation">.</span>mutations<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh                     2062-09-12T03:38:25Z
mutatorpodstatuses<span class="token punctuation">.</span>status<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh               2062-09-12T03:38:26Z
providers<span class="token punctuation">.</span>externaldata<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh                  2062-09-12T03:38:26Z
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="122__1083"></a>1.2.2 特权策略</h4> 
<p>学习目标</p> 
<p>这一节，我们从 属性解读、简单实践、小结 三个方面来学习。</p> 
<p><strong>属性解读</strong></p> 
<p>策略简介</p> 
<pre><code class="prism language-powershell">Gatekeeper 的策略通常是由两个资源对象组成的：Template 和 Constraint。
	Template包括两部分组成：
		crd 的确是一个 CRD 定义，也就是说生成一个 Template CR 对象，会随之生成一个 CRD
		targets 则是一组 rego 为主体的代码包，定制阻止资源创建的规则。

	Contsraint：定制资源对象创建的约束信息
		基于 Template 生成的 CRD对象，创建被CRD约束的资源对象列表和范围
</code></pre> 
<p>模板示例</p> 
<pre><code class="prism language-powershell">apiVersion: templates<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: 自定义资源名称
spec:
  crd:
    spec:
      names:
        kind: 定制资源类型
  targets:
    <span class="token operator">-</span> target: admission<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh
      rego: <span class="token punctuation">|</span>
        package admission   <span class="token comment"># 定制检测规则</span>
        <span class="token comment"># 检测结果如果为True(默认)，则表明违反约束限制信息，无法创建资源对象</span>
        violation<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span>: msg<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          <span class="token comment"># input.review.object 从接收的资源对象中获取信息</span>
          <span class="token comment"># spec.template.spec.containers 指的是从资源对象的属性信息中获取检测值</span>
          containers = input<span class="token punctuation">.</span>review<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>template<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          msg := sprintf<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 打印相关的信息</span>
        <span class="token punctuation">}</span>
</code></pre> 
<p>约束示例</p> 
<pre><code class="prism language-powershell">apiVersion: constraints<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: 自定义资源的类型名称
metadata:
  name: 自定义约束的名称
spec:
  match:	<span class="token comment"># 匹配的资源对象信息</span>
    namespaces: <span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span>
    kinds:
    <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
      kinds:
      <span class="token operator">-</span> <span class="token string">"Deployment"</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>定制策略模板</p> 
<pre><code class="prism language-powershell">策略模板文件 08_kubernetes_server_secure_gatekeeper_template<span class="token punctuation">.</span>yaml
apiVersion: templates<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: deploy-privileged
spec:
  crd:
    spec:
      names:
        kind: deploy-privileged
  targets:
    <span class="token operator">-</span> target: admission<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh
      rego: <span class="token punctuation">|</span>
        package admission
        violation<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span>: msg<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          containers := input<span class="token punctuation">.</span>review<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>template<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers
          container_name := containers<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>name
          containers<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>securityContext<span class="token punctuation">.</span>privileged
          msg := sprintf<span class="token punctuation">(</span><span class="token string">"提示: Deployment资源对象内部的 %v 容器禁止启用特权模式"</span><span class="token punctuation">,</span> <span class="token namespace">[container_name]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: templates<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: pod-privileged
spec:
  crd:
    spec:
      names:
        kind: pod-privileged
  targets:
    <span class="token operator">-</span> target: admission<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh
      rego: <span class="token punctuation">|</span>
        package admission
        violation<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span>: msg<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          containers := input<span class="token punctuation">.</span>review<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers
          container_name := containers<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>name
          containers<span class="token punctuation">[</span>0<span class="token punctuation">]</span><span class="token punctuation">.</span>securityContext<span class="token punctuation">.</span>privileged
          msg := sprintf<span class="token punctuation">(</span><span class="token string">"提示: Pod资源对象内部的 %v 容器禁止启用特权模式 "</span><span class="token punctuation">,</span> <span class="token namespace">[container_name]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">注意：
	package 标记go程序的入口，首行必须是它
	先创建模板，再创建约束，约束的name必须与模板的名称一样，否则无法使用，使用方式类似于RBAC
	<span class="token operator">%</span>v 代表默认的数据格式
功能：
	校验成功，标识匹配成功，需要拒绝请求，否则拒绝规则匹配失败，允许请求通过
</code></pre> 
<pre><code class="prism language-powershell">应用资源对象
kubectl apply <span class="token operator">-</span>f 08_kubernetes_server_secure_gatekeeper_template<span class="token punctuation">.</span>yaml

确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl get constrainttemplate</span>
NAME         AGE
privileged   20s
</code></pre> 
<p>定义约束</p> 
<pre><code class="prism language-powershell">约束资源文件 09_kubernetes_server_secure_gatekeeper_constraint<span class="token punctuation">.</span>yaml
apiVersion: constraints<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: deploy-privileged
metadata:
  name: deploy-privileged
spec:
  match:
    namespaces: <span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span>
    kinds:
    <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
      kinds:
      <span class="token operator">-</span> <span class="token string">"Deployment"</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: constraints<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: pod-privileged
metadata:
  name: pod-privileged
spec:
  match:
    namespaces: <span class="token punctuation">[</span><span class="token string">"default"</span><span class="token punctuation">]</span>
    kinds:     
    <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
      kinds:
      <span class="token operator">-</span> <span class="token string">"Pod"</span>      
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 09_kubernetes_server_secure_gatekeeper_constraint<span class="token punctuation">.</span>yaml

确认效果
kubectl get privileged
</code></pre> 
<pre><code class="prism language-powershell">定制资源测试文件 10_kubernetes_server_secure_gatekeeper_test<span class="token punctuation">.</span>yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-web
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      <span class="token operator">-</span> image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
        name: nginx
        securityContext:
          privileged: true
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test1
spec:
  containers:
  <span class="token operator">-</span> name: busybox1
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
  <span class="token operator">-</span> name: busybox2
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    securityContext:
      privileged: true
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test2
spec:
  containers:
  <span class="token operator">-</span> name: busybox-test
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    securityContext:
      privileged: true
</code></pre> 
<pre><code class="prism language-powershell">测试效果
<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f 10_kubernetes_server_secure_gatekeeper_test.yaml</span>
pod/busybox-test1 created
Error <span class="token keyword">from</span> server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: error when creating <span class="token string">"10_kubernetes_server_secure_gatekeeper_test.yaml"</span>: admission webhook <span class="token string">"validation.gatekeeper.sh"</span> denied the request: <span class="token namespace">[deploy-privileged]</span> 提示: Deployment资源对象内部的 nginx 容器禁止启用特权模式
Error <span class="token keyword">from</span> server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: error when creating <span class="token string">"10_kubernetes_server_secure_gatekeeper_test.yaml"</span>: admission webhook <span class="token string">"validation.gatekeeper.sh"</span> denied the request: <span class="token namespace">[pod-privileged]</span> 提示: Pod资源对象内部的 busybox-test 容器禁止启用特权模式

<span class="token punctuation">]</span><span class="token comment"># kubectl apply -f 10_kubernetes_server_secure_gatekeeper_test.yaml -n superopsmsb</span>
deployment<span class="token punctuation">.</span>apps/nginx-web created
pod/busybox-test1 created
pod/busybox-test2 created
结果显示：
	无论是pod还是deployment级别的问题都检测出来了
	由于检测规则的漏洞所以导致default空间中的一个pod被创建成功了
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="123__1325"></a>1.2.3 策略进阶</h4> 
<p>学习目标</p> 
<p>这一节，我们从 SA检测、镜像检测、小结 三个方面来学习。</p> 
<p><strong>SA检测</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">创建SA资源对象的时候，登录用户名必须与命名空间名称一致
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">策略模板文件 11_kubernetes_server_secure_gatekeeper_nscheck<span class="token punctuation">.</span>yaml
apiVersion: templates<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: namespace-check
spec:
  crd:
    spec:
      names:
        kind: namespace-check
  targets:
    <span class="token operator">-</span> target: admission<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh
      rego: <span class="token punctuation">|</span>
        package nsuser
        violation<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span>: msg<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          sa_name = input<span class="token punctuation">.</span>review<span class="token punctuation">.</span>userInfo<span class="token punctuation">.</span>username
          namespace = input<span class="token punctuation">.</span>review<span class="token punctuation">.</span>object<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>namespace
          not startswith<span class="token punctuation">(</span>sa_name<span class="token punctuation">,</span> namespace<span class="token punctuation">)</span>
          msg := sprintf<span class="token punctuation">(</span><span class="token string">"提示: 服务账号 %v 不允许到 %v 命名空间中创建SA "</span><span class="token punctuation">,</span> <span class="token namespace">[sa_name, namespace]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: constraints<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: namespace-check
metadata:
  name: namespace-check
spec:
  match:
    kinds:
      <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">""</span><span class="token punctuation">]</span>
        kinds: <span class="token punctuation">[</span><span class="token string">"ServiceAccount"</span><span class="token punctuation">]</span>
        
应用资源清单文件
kubectl apply <span class="token operator">-</span>f 11_kubernetes_server_secure_gatekeeper_nscheck<span class="token punctuation">.</span>yaml
注意：
	因为ConstraintTemplate必须在constraints之前创建，所以有可能需要执行两遍
</code></pre> 
<p>测试效果</p> 
<pre><code class="prism language-powershell">查看当前登录用户
<span class="token punctuation">]</span><span class="token comment"># kubectl config view | grep 'user: '</span>
    user: kubernetes-admin
    
尝试创建sa
<span class="token punctuation">]</span><span class="token comment"># kubectl create sa nihao</span>
error: failed to create serviceaccount: admission webhook <span class="token string">"validation.gatekeeper.sh"</span> denied the request: <span class="token namespace">[namespace-check]</span> 提示: 服务账号 kubernetes-admin 不允许到 default 命名空间中创建SA

创建Sa
kubectl create ns kubernetes-admin
kubectl create sa nihao <span class="token operator">-</span>n kubernetes-admin
结果显示：
	由于登录用户和namespace的名称一致，则创建成功
</code></pre> 
<p>简介</p> 
<pre><code class="prism language-powershell">创建资源对象的时候，镜像的仓库名称必须符合特定的要求
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">策略模板文件 12_kubernetes_server_secure_gatekeeper_imagecheck<span class="token punctuation">.</span>yaml
apiVersion: templates<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: imagecheck
spec:
  crd:
    spec:
      names:
        kind: imagecheck
      validation:
        openAPIV3Schema:
          properties:
            prefix:
              <span class="token function">type</span>: string
  targets:
    <span class="token operator">-</span> target: admission<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh
      rego: <span class="token punctuation">|</span>
        package image
        violation<span class="token punctuation">[</span><span class="token punctuation">{<!-- --></span><span class="token string">"msg"</span>: msg<span class="token punctuation">}</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
          containers = input<span class="token punctuation">.</span>review<span class="token punctuation">.</span>object<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>template<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers
          some i
          image := containers<span class="token namespace">[i]</span><span class="token punctuation">.</span>image
          not startswith<span class="token punctuation">(</span>image<span class="token punctuation">,</span> input<span class="token punctuation">.</span>parameters<span class="token punctuation">.</span>prefix<span class="token punctuation">)</span>
          msg := sprintf<span class="token punctuation">(</span><span class="token string">"提示: 镜像 '%v' 的仓库不符合要求."</span><span class="token punctuation">,</span> <span class="token namespace">[image]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token operator">--</span><span class="token operator">-</span>
apiVersion: constraints<span class="token punctuation">.</span>gatekeeper<span class="token punctuation">.</span>sh/v1beta1
kind: imagecheck
metadata:
  name: imagecheck
spec:
  match:
    kinds:
      <span class="token operator">-</span> apiGroups: <span class="token punctuation">[</span><span class="token string">"apps"</span><span class="token punctuation">]</span>
        kinds:
        <span class="token operator">-</span> <span class="token string">"Deployment"</span>
  parameters:
    prefix: <span class="token string">"kubernetes-register.superopsmsb.com/"</span>

应用资源清单文件
kubectl apply <span class="token operator">-</span>f 12_kubernetes_server_secure_gatekeeper_imagecheck<span class="token punctuation">.</span>yaml
注意：
	因为ConstraintTemplate必须在constraints之前创建，所以有可能需要执行两遍
</code></pre> 
<p>测试效果</p> 
<pre><code class="prism language-powershell">尝试创建deployment
<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment my-deploy --image=nginx</span>
error: failed to create deployment: admission webhook <span class="token string">"validation.gatekeeper.sh"</span> denied the request: <span class="token namespace">[imagecheck]</span> 提示: 镜像 <span class="token string">'nginx'</span> 的仓库不符合要求<span class="token punctuation">.</span>

创建deployment
<span class="token punctuation">]</span><span class="token comment"># kubectl create deployment my-deploy --image=kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>
deployment<span class="token punctuation">.</span>apps/my-deploy created
结果显示：
	只有符合要求的资源对象才会进行正常的创建
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h3><a id="13__1474"></a>1.3 资源限制</h3> 
<h4><a id="131_AppArmor_1476"></a>1.3.1 AppArmor简介</h4> 
<p>学习目标</p> 
<p>这一节，我们从 软件简介、环境部署、小结 三个方面来学习。</p> 
<p><strong>软件简介</strong></p> 
<p>场景定位</p> 
<pre><code class="prism language-powershell">	网络攻击越来越复杂，攻击频率越来越高，目前来说，由网络犯罪造成的损失每年将达到 数万亿美元。防火墙和系统等传统防御措施在网络外围运行的入侵检测系统不再足以保护当今的分布式企业网络。相反，需要一种“纵深防御”方法来保护组织数字基础设施的所有方面。

	在理想的世界中，应用程序将没有安全漏洞，但一旦受到损害，即使是受信任的应用程序也可能变得不可靠。AppArmor 为应用程序提供了关键的安全层。通过提供将应用程序允许的操作列入白名单的功能，AppArmor 使管理员能够将最小权限原则应用于应用程序。安装后，AppArmor 可以阻止攻击，并在发生违规时最大限度地减少或防止损坏。
</code></pre> 
<pre><code class="prism language-powershell">	AppArmor 是一项重要的安全功能，自 Ubuntu 7<span class="token punctuation">.</span>10 起默认包含在 Ubuntu 中。但是，它在后台安静地工作，因此您可能不知道它是什么以及它在做什么。

	AppArmor 阻止易受攻击的进程，限制这些进程中的安全漏洞可能造成的损害。AppArmor 也可用于锁定 Mozilla Firefox 以增加安全性，但默认情况下不这样做。
</code></pre> 
<pre><code class="prism language-powershell">	AppArmor 类似于 SELinux，在 Fedora 和 Red Hat 中默认使用。尽管它们的工作方式不同，但 AppArmor 和 SELinux 都提供“强制访问控制”（MAC）安全性。实际上，AppArmor 允许 Ubuntu 开发人员限制进程可以采取的操作。
</code></pre> 
<p><img src="https://images2.imgbox.com/ea/28/kjp9Jo2b_o.png" alt="在这里插入图片描述"></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	AppArmor是一个高效和易于使用的Linux系统安全应用程序，本质上AppArmor 是一个 Linux 内核安全模块，它通过基于 Debian 的系统中的每个应用程序配置文件实现强制访问控制 <span class="token punctuation">(</span>MAC<span class="token punctuation">)</span> 安全性。
	AppArmor对操作系统和应用程序所受到的威胁进行从内到外的保护，甚至是未被发现的0day漏洞和未知的应用程序漏洞所导致的攻击。
</code></pre> 
<pre><code class="prism language-powershell">	例如，在 Ubuntu 的默认设置中受限的一个应用程序是xxPDF查看器。该软件为了方便操作PDF资源，会在您的主机上启动一个用户帐户运行，而且它仅具有运行和处理 PDF 文档所需的最低权限。如果在 PDF 查看器中发现漏洞并打开了存在恶意代码的PDF文件，AppArmor 将限制 xxPDF查看器 可能造成的损害。在传统的 Linux 安全模型中，xxPDF查看器 可以访问您可以访问的所有内容。使用 AppArmor，您只能访问 PDF 查看器需要访问的内容。
	AppArmor 特别适用于限制可被利用的软件，例如 Web 浏览器或服务器软件。
</code></pre> 
<pre><code class="prism language-powershell">	AppArmor安全策略可以完全定义个别应用程序可以访问的系统资源与各自的特权。AppArmor包含大量的默认策略，它将先进的静态分析和基于学习的工具结合起来，AppArmor甚至可以使非常复杂的应用可以使用在很短的时间内应用成功
	作为对传统Unix的自主访问控制模块的补充，AppArmor提供了强制访问控制机制，它已经被整合到2<span class="token punctuation">.</span>6版本的Linux内核中。
</code></pre> 
<p>工作模式</p> 
<pre><code class="prism language-powershell">Apparmor有两种工作模式：enforcement、complain/learning
	Enforcement<span class="token punctuation">(</span>强制模式<span class="token punctuation">)</span>
		配置文件里列出的限制条件都会得到执行，并且对于违反这些限制条件的程序会进行日志记录。
	Complain<span class="token punctuation">(</span>记录模式<span class="token punctuation">)</span>
		配置文件里的限制条件不会得到执行，Apparmor只是对程序的行为进行记录。
		也就是说，我不禁止危险程序执行，但是我会记录相关信息。
		主要应用于程序的调试
</code></pre> 
<p>应用场景</p> 
<pre><code class="prism language-powershell">Apparmor可以对程序进行多方面的限制<span class="token punctuation">,</span>主要作用的场景如下：
	文件系统的访问控制
		Apparmor可以对某一个文件，或者某一个目录下的文件进行访问控制
		r<span class="token punctuation">(</span>读<span class="token punctuation">)</span>、w<span class="token punctuation">(</span>写<span class="token punctuation">)</span>、a<span class="token punctuation">(</span>追加<span class="token punctuation">)</span>、k<span class="token punctuation">(</span>文件锁定<span class="token punctuation">)</span>、l<span class="token punctuation">(</span>链接<span class="token punctuation">)</span>、x<span class="token punctuation">(</span>可执行<span class="token punctuation">)</span>
	资源限制
		Apparmor可以提供类似系统调用setrlimit一样的方式来限制程序可以使用的资源。
		<span class="token function">set</span> rlimit <span class="token namespace">[resource]</span> &lt;= <span class="token namespace">[value]</span>
	访问网络
		Apparmor可以程序是否可以访问网络进行限制
		network <span class="token punctuation">[</span> <span class="token namespace">[domain]</span> <span class="token namespace">[type]</span> <span class="token namespace">[protocol]</span> <span class="token punctuation">]</span>
	capability条目
		Apparmor可以限制程序是否可以进行列表里的操作
		capability setgid<span class="token punctuation">,</span>
</code></pre> 
<p>SELinux vs Apparmor</p> 
<pre><code class="prism language-powershell">	SELinux比Apparmor更安全，更灵活，同时配置起来也更复杂。
	Apparmor使用文件名（路径名）最为安全标签<span class="token punctuation">,</span>配置很简单，但是可以通过改文件名而绕过限制
	SELinux使用文件的inode作为安全标签，inode在文件系统中具有唯一性。
</code></pre> 
<p><strong>环境部署</strong></p> 
<p>需求</p> 
<pre><code class="prism language-powershell">	AppArmor 软件包默认安装在 Ubuntu 上，所有默认配置文件都在系统启动时加载。配置文件包含存储在etc/apparmor<span class="token punctuation">.</span>d/，所以我们需要准备一个ubuntu的系统环境。
	确认ubuntu主机是否默认启用了AppArmor能力
	<span class="token comment"># ls /sys/module/apparmor/</span>
	parameters  uevent
    <span class="token comment"># cat /sys/module/apparmor/parameters/enabled</span>
    Y
</code></pre> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">master节点 跨主机免密码认证
ssh-<span class="token function">copy-id</span> root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29
ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29 <span class="token string">"mkdir /data/scripts -p"</span>
<span class="token function">echo</span> <span class="token string">'10.0.0.29 kubernetes-node4.superopsmsb.com  kubernetes-node4'</span> &gt;&gt; <span class="token operator">/</span>etc/hosts

</code></pre> 
<pre><code class="prism language-powershell">master节点 传递相关文件
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts
scp 02_kubernetes_kernel_conf<span class="token punctuation">.</span>sh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29:<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/
<span class="token keyword">for</span> i in <span class="token punctuation">{<!-- --></span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>17<span class="token punctuation">}</span> 29
<span class="token keyword">do</span>
  scp <span class="token operator">/</span>etc/hosts root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span>etc/hosts
done 
ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29 <span class="token string">"hostnamectl  set-hostname kubernetes-node4"</span>
</code></pre> 
<pre><code class="prism language-powershell">node节点 内核参数调整
<span class="token operator">/</span>bin/bash <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/02_kubernetes_kernel_conf<span class="token punctuation">.</span>sh
执行容器环境部署
<span class="token operator">/</span>bin/bash <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/03_kubernetes_docker_install<span class="token punctuation">.</span>sh
</code></pre> 
<pre><code class="prism language-powershell">部署docker的专用脚本
<span class="token comment">#!/bin/bash</span>
<span class="token comment"># 功能: 安装部署Docker容器环境</span>
<span class="token comment"># 版本: v0.1</span>
<span class="token comment"># 作者: 书记</span>
<span class="token comment"># 联系: superopsmsb.com</span>

<span class="token comment"># 准备工作</span>

<span class="token comment"># 软件源配置</span>
softs_base<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment"># 安装基础软件</span>
  apt-get install apt-transport-https ca-certificates curl gnupg lsb-release <span class="token operator">-</span>y
  <span class="token comment"># 定制软件仓库源</span>
  curl <span class="token operator">-</span>fsSL https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn/docker-ce/linux/ubuntu/gpg <span class="token punctuation">|</span> sudo gpg <span class="token operator">--</span>dearmor <span class="token operator">-</span>o <span class="token operator">/</span>usr/share/keyrings/docker-archive-keyring<span class="token punctuation">.</span>gpg
<span class="token function">echo</span> \
  <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \
  <span class="token function">$<span class="token punctuation">(</span>lsb_release <span class="token operator">-</span>cs<span class="token punctuation">)</span></span> stable"</span> <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/docker<span class="token punctuation">.</span>list &gt; <span class="token operator">/</span>dev/null
  <span class="token comment"># 更新软件源</span>
  apt-get update
<span class="token punctuation">}</span>

<span class="token comment"># 软件安装</span>
soft_install<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment"># 安装最新版的docker软件</span>
  apt-get <span class="token operator">-</span>y install docker-ce docker-ce-<span class="token function">cli</span> containerd<span class="token punctuation">.</span>io
<span class="token punctuation">}</span>

<span class="token comment"># 加速器配置</span>
speed_config<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  <span class="token comment"># 定制加速器配置</span>
<span class="token function">cat</span> &gt; <span class="token operator">/</span>etc/docker/daemon<span class="token punctuation">.</span>json &lt;&lt;<span class="token operator">-</span>EOF
<span class="token punctuation">{<!-- --></span>
  <span class="token string">"registry-mirrors"</span>: <span class="token punctuation">[</span>
    <span class="token string">"http://74f21445.m.daocloud.io"</span><span class="token punctuation">,</span>
    <span class="token string">"https://registry.docker-cn.com"</span><span class="token punctuation">,</span>
    <span class="token string">"http://hub-mirror.c.163.com"</span><span class="token punctuation">,</span>
    <span class="token string">"https://docker.mirrors.ustc.edu.cn"</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"insecure-registries"</span>: <span class="token punctuation">[</span><span class="token string">"kubernetes-register.superopsmsb.com"</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">"exec-opts"</span>: <span class="token punctuation">[</span><span class="token string">"native.cgroupdriver=systemd"</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
EOF
  <span class="token comment"># 重启docker服务</span>
  systemctl restart docker
<span class="token punctuation">}</span>

<span class="token comment"># 环境监测</span>
docker_check<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  process_name=$<span class="token punctuation">(</span>docker info <span class="token punctuation">|</span> grep <span class="token string">'p D'</span> <span class="token punctuation">|</span> awk <span class="token string">'{print $NF}'</span><span class="token punctuation">)</span>
  <span class="token punctuation">[</span> <span class="token string">"${process_name}"</span> == <span class="token string">"systemd"</span> <span class="token punctuation">]</span> &amp;&amp; <span class="token function">echo</span> <span class="token string">"Docker软件部署完毕"</span> <span class="token punctuation">|</span><span class="token punctuation">|</span> <span class="token punctuation">(</span><span class="token function">echo</span> <span class="token string">"Docker软件部署失败"</span> &amp;&amp; <span class="token keyword">exit</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment"># 软件部署</span>
main<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
  softs_base
  soft_install
  speed_config
  docker_check
<span class="token punctuation">}</span>

<span class="token comment"># 调用主函数</span>
main
</code></pre> 
<pre><code class="prism language-powershell">master节点 准备cri-dockerd服务
scp <span class="token operator">/</span>usr/local/bin/cri-dockerd root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29:<span class="token operator">/</span>usr/local/bin/
scp <span class="token operator">/</span>etc/systemd/system/cri-dockerd<span class="token punctuation">.</span>service root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29:<span class="token operator">/</span>etc/systemd/system/cri-dockerd<span class="token punctuation">.</span>service
scp <span class="token operator">/</span>usr/lib/systemd/system/cri-docker<span class="token punctuation">.</span>socket root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29:<span class="token operator">/</span>usr/lib/systemd/system/cri-docker<span class="token punctuation">.</span>socket

node节点 查看效果
systemctl daemon-reload
systemctl enable cri-dockerd<span class="token punctuation">.</span>service cri-docker<span class="token punctuation">.</span>socket
systemctl <span class="token function">start</span> cri-dockerd<span class="token punctuation">.</span>service
</code></pre> 
<pre><code class="prism language-powershell">master节点获取集群信息
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubeadm token list | awk '{print $1,$2}'</span>
TOKEN TTL
abcdef<span class="token punctuation">.</span>0123456789abcdef 27y
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'</span>
2e32fbe869258151ac547ec1649af9a60d79a6080d822923bf20cf3cb6a581ce
</code></pre> 
<pre><code class="prism language-powershell">node节点安装软件
apt-get install <span class="token operator">-</span>y kubelet=1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>4-00 kubeadm=1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>4-00

node加入集群
kubeadm join 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>200:6443 <span class="token operator">--</span>token abcdef<span class="token punctuation">.</span>0123456789abcdef <span class="token operator">--</span>discovery-token-ca-cert-hash sha256:2e32fbe869258151ac547ec1649af9a60d79a6080d822923bf20cf3cb6a581ce <span class="token operator">--</span>cri-socket unix:<span class="token operator">/</span><span class="token operator">/</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/cri-dockerd<span class="token punctuation">.</span>sock
</code></pre> 
<pre><code class="prism language-powershell">测试效果
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubectl get nodes | grep node4</span>
kubernetes-node4     Ready    &lt;none&gt;          4m23s   v1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>4

<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubectl describe nodes | egrep 'Name:|AppArmor'</span>
Name:               kubernetes-master1
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Name:               kubernetes-node4
  Ready                True    Tue<span class="token punctuation">,</span> 13 Sep 2022 11:02:04 <span class="token operator">+</span>0800   Tue<span class="token punctuation">,</span> 13 Sep 2022 10:20:49 <span class="token operator">+</span>0800   KubeletReady                 kubelet is posting ready status<span class="token punctuation">.</span> AppArmor enabled
结果显示：
  	只有node4我们开启了AppArmor功能
</code></pre> 
<pre><code class="prism language-powershell">或者这种方式检查kubelet是否支持AppArmor功能
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubectl get nodes -o=jsonpath=$'{range .items[*]}{@.metadata.name}: {.status.conditions[?(@.reason=="KubeletReady")].message}\n{end}'</span>
kubernetes-master1: kubelet is posting ready status
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
kubernetes-node4: kubelet is posting ready status<span class="token punctuation">.</span> AppArmor enabled
</code></pre> 
<p>apparmor环境</p> 
<pre><code class="prism language-powershell">确认node4节点上的apparmor服务状态
方法1：
	systemctl status apparmor<span class="token punctuation">.</span>service
方法2:
	aa-status 或者 apparmor_status
	aa-status <span class="token operator">--</span>pretty-json <span class="token punctuation">(</span>以json方式检查状态效果<span class="token punctuation">)</span>

确认apparmor的环境状态
root@kubernetes-node4:~<span class="token comment"># apparmor_status</span>
apparmor module is loaded<span class="token punctuation">.</span>
<span class="token comment"># 有 33 个配置文件作为 AppArmor 配置文件加载，默认情况下全部设置为强制模式</span>
33 profiles are loaded<span class="token punctuation">.</span>
33 profiles are in enforce mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>snap/snapd/16292/usr/lib/snapd/snap-confine
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
0 profiles are in complain mode<span class="token punctuation">.</span>			<span class="token comment"># 记录模式</span>
2 processes have profiles defined<span class="token punctuation">.</span>
<span class="token comment"># cups-browsed 和 cupsd 2 个进程由具有强制模式的配置文件定义，并且在抱怨模式下没有进程</span>
2 processes are in enforce mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/sbin/cups-browsed <span class="token punctuation">(</span>903<span class="token punctuation">)</span>
   <span class="token operator">/</span>usr/sbin/cupsd <span class="token punctuation">(</span>845<span class="token punctuation">)</span>
0 processes are in complain mode<span class="token punctuation">.</span>
0 processes are unconfined but have a profile defined<span class="token punctuation">.</span>
结果显示：
	AppArmor 模块已加载，主要包括两部分的信息：配置文件和进程信息
	33 个配置文件已加载
	33 个配置文件处于强制模式。
</code></pre> 
<pre><code class="prism language-powershell">要安装您想要限制的应用程序和一些有用的 AppArmor 实用程序，请运行以下命令：
apt install apparmor-easyprof apparmor-notify apparmor-utils certspotter apparmor-profiles
常见软件包
	apparmor-profiles 	预定义的profile文件
	apparmor-utils 		管理profile的常用命令
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="132__1768"></a>1.3.2 基础知识</h4> 
<p>学习目标</p> 
<p>这一节，我们从 配置解读、命令实践、小结 三个方面来学习。</p> 
<p><strong>场景解读</strong></p> 
<p>相关配置</p> 
<pre><code class="prism language-powershell">apparmor在安装完毕后会有一系列的目录信息
	配置目录 <span class="token operator">/</span>etc/apparmor
	配置文件 <span class="token operator">/</span>etc/apparmor/parser<span class="token punctuation">.</span>conf
	
	控制目录 <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/
	文件目录 <span class="token operator">/</span>sys/kernel/security/apparmor
	
	日志目录 <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/apparmor/
</code></pre> 
<p>配置目录</p> 
<pre><code class="prism language-powershell">配置文件存储在目录中<span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d<span class="token punctuation">.</span>这些配置文件是可以包含注释的纯文本文件
root@kubernetes-node4:~<span class="token comment"># ls /etc/apparmor.d</span>
abstractions  sbin<span class="token punctuation">.</span>dhclient   usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>man   usr<span class="token punctuation">.</span>sbin<span class="token punctuation">.</span>mdnsd
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
注意：
	被管理的文件有固定的格式，比如<span class="token operator">/</span>usr/sbin/cupsd 将创建为usr<span class="token punctuation">.</span>sbin<span class="token punctuation">.</span>cupsd
	配置文件仅在执行时应用于流程。在重新启动进程之前，已经运行的程序将不会执行任何强制措施。
</code></pre> 
<pre><code class="prism language-powershell">依赖是相关通用配置
root@kubernetes-node4:~<span class="token comment"># ls /etc/apparmor.d/abstractions/</span>
apache2-common gnome openssl <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

root@kubernetes-node4:~<span class="token comment"># ls /etc/apparmor.d/disable/</span>
usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>firefox  usr<span class="token punctuation">.</span>sbin<span class="token punctuation">.</span>rsyslogd
</code></pre> 
<pre><code class="prism language-powershell">usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>firefox 在 <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/disable 目录下，标识默认情况下不启用该服务
root@kubernetes-node4:~<span class="token comment"># ll  /etc/apparmor.d/disable/usr.bin.firefox</span>
lrwxrwxrwx 1 root root 31 8月  16 02:27 <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/disable/usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>firefox <span class="token operator">-</span>&gt; <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>firefox
结果显示：
	他其实就是被apparmor管理的服务文件的链接而已
</code></pre> 
<p>查看管理配置文件</p> 
<pre><code class="prism language-powershell">AppArmor 模块配置文件定义以纯文本文件的形式储存在 <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d 目录中
root@kubernetes-node4:~<span class="token comment"># cat /etc/apparmor.d/bin.ping</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">#include &lt;tunables/global&gt;</span>
<span class="token comment"># profile定制规则名称 ping ，flags代表是配置文件标识</span>
profile ping <span class="token operator">/</span><span class="token punctuation">{<!-- --></span>usr/<span class="token punctuation">,</span><span class="token punctuation">}</span>bin/<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span>iputils-<span class="token punctuation">}</span>ping flags=<span class="token punctuation">(</span>complain<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">#include &lt;abstractions/base&gt;				# include直接导入其他配置文件</span>
  <span class="token comment">#include &lt;abstractions/consoles&gt;</span>
  <span class="token comment">#include &lt;abstractions/nameservice&gt;</span>

  capability net_raw<span class="token punctuation">,</span>
  capability setuid<span class="token punctuation">,</span>
  network inet raw<span class="token punctuation">,</span>
  network inet6 raw<span class="token punctuation">,</span>

  <span class="token comment"># 第一列是文件或路径，支持正则符号或者通配符</span>
  <span class="token comment"># 第二列是权限限定，r(读取)\w(更改)\x(执行)\m(内存映射可执行文件)</span>
  <span class="token operator">/</span><span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span>usr/<span class="token punctuation">}</span>bin/<span class="token punctuation">{<!-- --></span><span class="token punctuation">,</span>iputils-<span class="token punctuation">}</span>ping mixr<span class="token punctuation">,</span>
  <span class="token operator">/</span>etc/modules<span class="token punctuation">.</span>conf r<span class="token punctuation">,</span>

  <span class="token comment"># Site-specific additions and overrides. See local/README for details.</span>
  <span class="token comment">#include &lt;local/bin.ping&gt;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">配置文件标识
	模式标志 
		<span class="token operator">-</span> 标记配置规则是以哪种模式进行控制
		<span class="token operator">-</span> complain<span class="token punctuation">(</span>记录模式<span class="token punctuation">)</span> 和 空<span class="token punctuation">(</span>省略<span class="token operator">-</span>强制模式<span class="token punctuation">)</span>
	相对标志 
		<span class="token operator">-</span> 指出配置文件的路径
		<span class="token operator">-</span> chroot_relative<span class="token punctuation">(</span>基于chroot<span class="token punctuation">)</span>或 namespace_relative<span class="token punctuation">(</span>默认，非chroot<span class="token punctuation">)</span>
	附加标志 
		<span class="token operator">-</span> 是否为名称空间路径前方添加“<span class="token operator">/</span>”字符
		<span class="token operator">-</span> attach_disconnected 或 no_attach_disconnected<span class="token punctuation">(</span>不加<span class="token punctuation">)</span>

其他配置属性
	file 				<span class="token comment"># 允许所有文件读写</span>
	deny <span class="token operator">/</span>path/<span class="token operator">*</span><span class="token operator">*</span> w<span class="token punctuation">,</span>	<span class="token comment"># 拒绝/path/目录下的所有文件写</span>
</code></pre> 
<p><strong>命令实践</strong></p> 
<p>常用命令</p> 
<pre><code class="prism language-powershell">服务管理命令
	systemctl <span class="token function">start</span><span class="token punctuation">|</span>stop<span class="token punctuation">|</span>status<span class="token punctuation">|</span>reload apparmor<span class="token punctuation">.</span>service
</code></pre> 
<pre><code class="prism language-powershell">管理命令
	aa-status<span class="token punctuation">|</span>apparmor_status		查看AppArmor的配置文件状态
	apparmor_parser					加载AppArmor的配置文件
		&lt;profile&gt;						加载到内行中，覆盖现有配置文件
		<span class="token operator">-</span>r &lt;profile&gt;					重新加载到内行中
		<span class="token operator">-</span>R &lt;profile&gt;					删除内核中的现有配置文件
		<span class="token operator">-</span>a &lt;profile&gt;					在强制模式下加载新配置文件的默认操作。
		<span class="token operator">-</span>C &lt;profile&gt;					在记录模式下加载新的配置文件。
		<span class="token operator">-</span>q &lt;context&gt;					直接基于内容创建配置信息，无配置文件
	aa-complain						调整AppArmor为记录模式
	aa-enforce						调整AppArmor为强制模式
aa-genprof			生成profile文件
aa-logprof			查询处于apparmor的日志记录
</code></pre> 
<p>移除无效配置实践</p> 
<pre><code class="prism language-powershell">卸载不再位于 <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/ 中的所有 AppArmor 配置文件
root@kubernetes-node4:~<span class="token comment"># aa-remove-unknown</span>
Skipping profile in <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/disable: usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>firefox
Skipping profile in <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/disable: usr<span class="token punctuation">.</span>sbin<span class="token punctuation">.</span>rsyslogd
Removing <span class="token string">'snap.snap-store.ubuntu-software-local-file'</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
Removing <span class="token string">'/snap/snapd/16292/usr/lib/snapd/snap-confine'</span>
注意：
	这条命令不要随便乱执行，因为他会将一些第三方集成应用的规则移除
	
查看默认加载的配置
root@kubernetes-node4:~<span class="token comment">#cat /sys/kernel/security/apparmor/profiles</span>
</code></pre> 
<p>模式切换实践</p> 
<pre><code class="prism language-powershell">确认强制模式的进程
root@kubernetes-node4:~<span class="token comment"># aa-status | grep -A2 'processes are in enforce'</span>
2 processes are in enforce mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/sbin/cups-browsed <span class="token punctuation">(</span>903<span class="token punctuation">)</span>
   <span class="token operator">/</span>usr/sbin/cupsd <span class="token punctuation">(</span>845<span class="token punctuation">)</span>

确认记录模式的进程
root@kubernetes-node4:~<span class="token comment"># aa-complain /usr/sbin/cupsd</span>
Setting <span class="token operator">/</span>usr/sbin/cupsd to complain mode<span class="token punctuation">.</span>
root@kubernetes-node4:~<span class="token comment"># aa-status</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
1 processes are in enforce mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/sbin/cups-browsed <span class="token punctuation">(</span>903<span class="token punctuation">)</span>
1 processes are in complain mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/sbin/cupsd <span class="token punctuation">(</span>845<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">设定强制模式
root@kubernetes-node4:~<span class="token comment"># aa-enforce /usr/sbin/cupsd</span>
Setting <span class="token operator">/</span>usr/sbin/cupsd to enforce mode<span class="token punctuation">.</span>
root@kubernetes-node4:~<span class="token comment"># aa-status</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
2 processes are in enforce mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/sbin/cups-browsed <span class="token punctuation">(</span>903<span class="token punctuation">)</span>
   <span class="token operator">/</span>usr/sbin/cupsd <span class="token punctuation">(</span>845<span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p>访问限制实践</p> 
<pre><code class="prism language-powershell">准备命令
root@kubernetes-node4:~<span class="token comment"># whereis ls</span>
<span class="token function">ls</span>: <span class="token operator">/</span>usr/bin/<span class="token function">ls</span> <span class="token operator">/</span>usr/share/man/man1/<span class="token function">ls</span><span class="token punctuation">.</span>1<span class="token punctuation">.</span>gz
root@kubernetes-node4:~<span class="token comment"># cp -a /usr/bin/ls /usr/bin/nihao</span>
root@kubernetes-node4:~<span class="token comment"># nihao</span>
root@kubernetes-node4:~<span class="token comment"># ll /usr/bin/ls</span>
<span class="token operator">-</span>rwxr-xr-x 1 root root 142144 9月   5  2019 <span class="token operator">/</span>usr/bin/<span class="token function">ls</span><span class="token operator">*</span>
root@kubernetes-node4:~<span class="token comment"># ll /usr/bin/nihao</span>
<span class="token operator">-</span>rwxr-xr-x 1 root root 142144 9月   5  2019 <span class="token operator">/</span>usr/bin/nihao*
</code></pre> 
<pre><code class="prism language-powershell">生成配置文件
root@kubernetes-node4:~<span class="token comment"># aa-genprof /usr/bin/nihao</span>
Writing updated profile <span class="token keyword">for</span> <span class="token operator">/</span>usr/bin/nihao<span class="token punctuation">.</span>
Setting <span class="token operator">/</span>usr/bin/nihao to complain mode<span class="token punctuation">.</span>

Before you <span class="token keyword">begin</span><span class="token punctuation">,</span> you may wish to check <span class="token keyword">if</span> a
profile already exists <span class="token keyword">for</span> the application you
wish to confine<span class="token punctuation">.</span> See the following wiki page <span class="token keyword">for</span>
more information:
https:<span class="token operator">/</span><span class="token operator">/</span>gitlab<span class="token punctuation">.</span>com/apparmor/apparmor/wikis/Profiles

分析中: <span class="token operator">/</span>usr/bin/nihao

Please <span class="token function">start</span> the application to be profiled in
another window and exercise its functionality now<span class="token punctuation">.</span>

Once completed<span class="token punctuation">,</span> <span class="token function">select</span> the <span class="token string">"Scan"</span> option below in
order to scan the system logs <span class="token keyword">for</span> AppArmor events<span class="token punctuation">.</span>

<span class="token keyword">For</span> each AppArmor event<span class="token punctuation">,</span> you will be given the
opportunity to choose whether the access should be
allowed or denied<span class="token punctuation">.</span>
<span class="token comment"># 注意：此处另开一个终端执行nihao命令,示例：</span>
<span class="token comment"># cd </span>
<span class="token comment"># nihao</span>
<span class="token comment"># cd /media</span>
<span class="token comment"># nihao</span>
<span class="token comment"># cd /tmp/ </span>
<span class="token comment"># nihao</span>
<span class="token punctuation">[</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span>can system log <span class="token keyword">for</span> AppArmor events<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span>inish
<span class="token comment"># 然后在当前页面按 S 键</span>
Reading log entries <span class="token keyword">from</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/syslog<span class="token punctuation">.</span>
Updating AppArmor profiles in <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d<span class="token punctuation">.</span>
Complain-mode changes:

配置文件:     <span class="token operator">/</span>usr/bin/nihao
路径:       <span class="token operator">/</span>root/
New Mode: owner r
严重性:      未知

 <span class="token punctuation">[</span>1 <span class="token operator">-</span> owner <span class="token operator">/</span>root/ r<span class="token punctuation">,</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>A<span class="token punctuation">)</span>llow <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>eny<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>I<span class="token punctuation">)</span>gnore <span class="token operator">/</span> <span class="token punctuation">(</span>G<span class="token punctuation">)</span>lob <span class="token operator">/</span> Glob with <span class="token punctuation">(</span>E<span class="token punctuation">)</span>xtension <span class="token operator">/</span> <span class="token punctuation">(</span>N<span class="token punctuation">)</span>ew <span class="token operator">/</span> Audi<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>O<span class="token punctuation">)</span>wner permissions off <span class="token operator">/</span> Abo<span class="token punctuation">(</span>r<span class="token punctuation">)</span>t <span class="token operator">/</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span>inish
<span class="token comment"># 此处按 A 键,代表允许到/root/目录执行nihao命令</span>
Adding owner <span class="token operator">/</span>root/ r<span class="token punctuation">,</span> to profile<span class="token punctuation">.</span>

配置文件:     <span class="token operator">/</span>usr/bin/nihao
路径:       <span class="token operator">/</span>media/
New Mode: owner r
严重性:      未知

 <span class="token punctuation">[</span>1 <span class="token operator">-</span> owner <span class="token operator">/</span>media/ r<span class="token punctuation">,</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>A<span class="token punctuation">)</span>llow <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>eny<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>I<span class="token punctuation">)</span>gnore <span class="token operator">/</span> <span class="token punctuation">(</span>G<span class="token punctuation">)</span>lob <span class="token operator">/</span> Glob with <span class="token punctuation">(</span>E<span class="token punctuation">)</span>xtension <span class="token operator">/</span> <span class="token punctuation">(</span>N<span class="token punctuation">)</span>ew <span class="token operator">/</span> Audi<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>O<span class="token punctuation">)</span>wner permissions off <span class="token operator">/</span> Abo<span class="token punctuation">(</span>r<span class="token punctuation">)</span>t <span class="token operator">/</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span>inish
<span class="token comment"># 此处按 D 键,代表不允许到/media/目录执行nihao命令</span>
Adding deny owner <span class="token operator">/</span>media/ r<span class="token punctuation">,</span> to profile<span class="token punctuation">.</span>

配置文件:     <span class="token operator">/</span>usr/bin/nihao
路径:       <span class="token operator">/</span>tmp/
New Mode: owner r
严重性:      未知

 <span class="token punctuation">[</span>1 <span class="token operator">-</span> <span class="token comment">#include &lt;abstractions/user-tmp&gt;]</span>
  2 <span class="token operator">-</span> owner <span class="token operator">/</span>tmp/ r<span class="token punctuation">,</span>
<span class="token punctuation">(</span>A<span class="token punctuation">)</span>llow <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>eny<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>I<span class="token punctuation">)</span>gnore <span class="token operator">/</span> <span class="token punctuation">(</span>G<span class="token punctuation">)</span>lob <span class="token operator">/</span> Glob with <span class="token punctuation">(</span>E<span class="token punctuation">)</span>xtension <span class="token operator">/</span> <span class="token punctuation">(</span>N<span class="token punctuation">)</span>ew <span class="token operator">/</span> Audi<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>O<span class="token punctuation">)</span>wner permissions off <span class="token operator">/</span> Abo<span class="token punctuation">(</span>r<span class="token punctuation">)</span>t <span class="token operator">/</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span>inish
<span class="token comment"># 此处按 A 键,代表允许到/tmp/目录执行nihao命令</span>
Adding <span class="token comment">#include &lt;abstractions/user-tmp&gt; to profile.</span>

= Changed Local Profiles =

The following local profiles were changed<span class="token punctuation">.</span> Would you like to save them?
 <span class="token punctuation">[</span>1 <span class="token operator">-</span> <span class="token operator">/</span>usr/bin/nihao<span class="token punctuation">]</span>
<span class="token punctuation">(</span>S<span class="token punctuation">)</span>ave Changes <span class="token operator">/</span> Save Selec<span class="token punctuation">(</span>t<span class="token punctuation">)</span>ed Profile <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>V<span class="token punctuation">)</span>iew Changes<span class="token punctuation">]</span> <span class="token operator">/</span> View Changes b/w <span class="token punctuation">(</span>C<span class="token punctuation">)</span>lean profiles <span class="token operator">/</span> Abo<span class="token punctuation">(</span>r<span class="token punctuation">)</span>t
<span class="token comment"># 此处按 S 键,代表保存配置</span>
Writing updated profile <span class="token keyword">for</span> <span class="token operator">/</span>usr/bin/nihao<span class="token punctuation">.</span>

分析中: <span class="token operator">/</span>usr/bin/nihao

Please <span class="token function">start</span> the application to be profiled in
another window and exercise its functionality now<span class="token punctuation">.</span>

Once completed<span class="token punctuation">,</span> <span class="token function">select</span> the <span class="token string">"Scan"</span> option below in
order to scan the system logs <span class="token keyword">for</span> AppArmor events<span class="token punctuation">.</span>

<span class="token keyword">For</span> each AppArmor event<span class="token punctuation">,</span> you will be given the
opportunity to choose whether the access should be
allowed or denied<span class="token punctuation">.</span>

<span class="token punctuation">[</span><span class="token punctuation">(</span>S<span class="token punctuation">)</span>can system log <span class="token keyword">for</span> AppArmor events<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span>inish
Setting <span class="token operator">/</span>usr/bin/nihao to enforce mode<span class="token punctuation">.</span>
<span class="token comment"># 此处按 F 键,代表退出配置</span>
重启 AppArmor 到强制模式

请考虑贡献您的新配置文件！
参阅以下 wiki 页面获取更多信息：
https:<span class="token operator">/</span><span class="token operator">/</span>gitlab<span class="token punctuation">.</span>com/apparmor/apparmor/wikis/Profiles

已完成为 <span class="token operator">/</span>usr/bin/nihao 生成配置文件。
</code></pre> 
<pre><code class="prism language-powershell">确认效果
root@kubernetes-node4:~<span class="token comment"># ls /etc/apparmor.d/*.nihao</span>
<span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>nihao
root@kubernetes-node4:~<span class="token comment"># cat /etc/apparmor.d/usr.bin.nihao</span>
<span class="token comment"># Last Modified: Tue Sep 13 17:18:38 2022</span>
<span class="token comment">#include &lt;tunables/global&gt;</span>

<span class="token operator">/</span>usr/bin/nihao <span class="token punctuation">{<!-- --></span>
  <span class="token comment">#include &lt;abstractions/base&gt;</span>
  <span class="token comment">#include &lt;abstractions/user-tmp&gt;</span>

  deny owner <span class="token operator">/</span>media/ r<span class="token punctuation">,</span>

  <span class="token operator">/</span>usr/bin/nihao mr<span class="token punctuation">,</span>
  owner <span class="token operator">/</span>root/ r<span class="token punctuation">,</span>

<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">确认效果
root@kubernetes-node4:~<span class="token comment"># aa-status</span>
apparmor module is loaded<span class="token punctuation">.</span>
33 profiles are loaded<span class="token punctuation">.</span>
34 profiles are in enforce mode<span class="token punctuation">.</span>
   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/bin/nihao
另开新终端确认效果
root@kubernetes-node4:<span class="token operator">/</span>tmp<span class="token comment"># cd /media/</span>
root@kubernetes-node4:<span class="token operator">/</span>media<span class="token comment"># nihao</span>
nihao: 无法打开目录 <span class="token string">'.'</span>: 权限不够
oot@kubernetes-node4:<span class="token operator">/</span>media<span class="token comment"># cd /etc/systemd/</span>
root@kubernetes-node4:<span class="token operator">/</span>etc/systemd<span class="token comment"># nihao</span>
nihao: 无法打开目录 <span class="token string">'.'</span>: 权限不够
</code></pre> 
<pre><code class="prism language-powershell">将命令置于complain模式
root@kubernetes-node4:~<span class="token comment"># aa-complain /usr/bin/nihao</span>
Setting <span class="token operator">/</span>usr/bin/nihao to complain mode<span class="token punctuation">.</span>
root@kubernetes-node4:~<span class="token comment"># aa-status</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
1 profiles are in complain mode<span class="token punctuation">.</span>
   <span class="token operator">/</span>usr/bin/nihao
   
执行命令效果
root@kubernetes-node4:<span class="token operator">/</span>media<span class="token comment"># cd /etc/docker/</span>
root@kubernetes-node4:<span class="token operator">/</span>etc/docker<span class="token comment"># nihao</span>
daemon<span class="token punctuation">.</span>json  key<span class="token punctuation">.</span>json
结果显示：
	在记录模式下，它并不会阻止命令的执行
</code></pre> 
<pre><code class="prism language-powershell">查看日志效果
root@kubernetes-node2:~<span class="token comment"># aa-logprof</span>
Reading log entries <span class="token keyword">from</span> <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>log/syslog<span class="token punctuation">.</span>
Updating AppArmor profiles in <span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d<span class="token punctuation">.</span>
Complain-mode changes:

配置文件:     <span class="token operator">/</span>usr/bin/nihao
路径:       <span class="token operator">/</span>etc/docker/
New Mode: owner r
严重性:      未知

 <span class="token punctuation">[</span>1 <span class="token operator">-</span> owner <span class="token operator">/</span>etc/docker/ r<span class="token punctuation">,</span><span class="token punctuation">]</span>
<span class="token punctuation">(</span>A<span class="token punctuation">)</span>llow <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>D<span class="token punctuation">)</span>eny<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token punctuation">(</span>I<span class="token punctuation">)</span>gnore <span class="token operator">/</span> <span class="token punctuation">(</span>G<span class="token punctuation">)</span>lob <span class="token operator">/</span> Glob with <span class="token punctuation">(</span>E<span class="token punctuation">)</span>xtension <span class="token operator">/</span> <span class="token punctuation">(</span>N<span class="token punctuation">)</span>ew <span class="token operator">/</span> Audi<span class="token punctuation">(</span>t<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>O<span class="token punctuation">)</span>wner permissions off <span class="token operator">/</span> Abo<span class="token punctuation">(</span>r<span class="token punctuation">)</span>t <span class="token operator">/</span> <span class="token punctuation">(</span>F<span class="token punctuation">)</span>inish
<span class="token comment"># 此处按 A 键,代表允许</span>
Adding owner <span class="token operator">/</span>etc/docker/ r<span class="token punctuation">,</span> to profile<span class="token punctuation">.</span>
Enforce-mode changes:

= Changed Local Profiles =

The following local profiles were changed<span class="token punctuation">.</span> Would you like to save them?

 <span class="token punctuation">[</span>1 <span class="token operator">-</span> <span class="token operator">/</span>usr/bin/nihao<span class="token punctuation">]</span>
<span class="token punctuation">(</span>S<span class="token punctuation">)</span>ave Changes <span class="token operator">/</span> Save Selec<span class="token punctuation">(</span>t<span class="token punctuation">)</span>ed Profile <span class="token operator">/</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>V<span class="token punctuation">)</span>iew Changes<span class="token punctuation">]</span> <span class="token operator">/</span> View Changes b/w <span class="token punctuation">(</span>C<span class="token punctuation">)</span>lean profiles <span class="token operator">/</span> Abo<span class="token punctuation">(</span>r<span class="token punctuation">)</span>t
Writing updated profile <span class="token keyword">for</span> <span class="token operator">/</span>usr/bin/nihao<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">查看修改后的配置
root@kubernetes-node4:<span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d<span class="token comment"># cat /etc/apparmor.d/usr.bin.nihao</span>
<span class="token comment"># Last Modified: Tue Sep 13 17:28:29 2022</span>
<span class="token comment">#include &lt;tunables/global&gt;</span>

<span class="token operator">/</span>usr/bin/nihao <span class="token punctuation">{<!-- --></span>
  <span class="token comment">#include &lt;abstractions/base&gt;</span>
  <span class="token comment">#include &lt;abstractions/evince&gt;</span>
  <span class="token comment">#include &lt;abstractions/user-tmp&gt;</span>

  deny owner <span class="token operator">/</span>media/ r<span class="token punctuation">,</span>

  <span class="token operator">/</span>usr/bin/nihao mr<span class="token punctuation">,</span>
  owner <span class="token operator">/</span>etc/docker/ r<span class="token punctuation">,</span>			<span class="token comment"># 结果显示：这个目录可以正常的访问了</span>
  owner <span class="token operator">/</span>opt/ r<span class="token punctuation">,</span>
  owner <span class="token operator">/</span>root/ r<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>移除配置实践</p> 
<pre><code class="prism language-powershell">移除内存中的限制
root@kubernetes-node2:~<span class="token comment"># apparmor_parser -R /etc/apparmor.d/usr.bin.nihao</span>
root@kubernetes-node2:~<span class="token comment"># aa-status | grep nihao</span>

确认效果
root@kubernetes-node4:<span class="token operator">/</span>etc/systemd<span class="token comment"># nihao</span>
journald<span class="token punctuation">.</span>conf  network        pstore<span class="token punctuation">.</span>conf    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	一旦内存中的规则移除后，限制就没有了
</code></pre> 
<pre><code class="prism language-powershell">虽然内存规则移除，但是规则文件还在
root@kubernetes-node2:~<span class="token comment"># ls /etc/apparmor.d/usr.bin.nihao</span>
<span class="token operator">/</span>etc/apparmor<span class="token punctuation">.</span>d/usr<span class="token punctuation">.</span>bin<span class="token punctuation">.</span>nihao

如果不移除规则文件的话，重启apparmor规则，仍然会生效，所以我们需要把规则文件也需要移除
root@kubernetes-node2:~<span class="token comment"># rm -f /etc/apparmor.d/usr.bin.nihao</span>

这样的话，重启服务，规则也不会有了
root@kubernetes-node2:~<span class="token comment"># systemctl  restart apparmor</span>
root@kubernetes-node2:~<span class="token comment"># aa-status | grep nihao</span>
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="132__2188"></a>1.3.2 应用实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 配置解读、简单实践、小结 三个方面来学习。</p> 
<p><strong>配置解读</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	apparmor 配置文件定义了目标受限应用程序可以访问系统上的哪些资源（如网络、系统功能或文件），如果要为运行 Pod 容器指定的 AppArmor 配置文件，需要在pod的元数据位置通过添加注释的方式来实现启用AppArmor的功能：
	container<span class="token punctuation">.</span>apparmor<span class="token punctuation">.</span>security<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/&lt;container_name&gt;: &lt;profile_ref&gt;
属性解析：
	&lt;container_name&gt; 的名称是容器的简称
	&lt;profile_ref&gt;用于设定AppArmor的位置，常见样式如下：
		<span class="token operator">-</span> runtime/default 应用运行时的默认配置
		<span class="token operator">-</span> localhost/&lt;profile_name&gt; 从本地主机加载 &lt;profile_name&gt; 的配置文件
		<span class="token operator">-</span> unconfined 表示不加载配置文件
注意：
	如果容器指定了AppArmor规则，而本地主机没有的话，则pod不会启动
</code></pre> 
<pre><code class="prism language-powershell">示例：
apiVersion: v1
kind: Pod
metadata:
  name: hello
  annotations:
    <span class="token comment"># 通过注释信息定制容器使用的本地策略</span>
    container<span class="token punctuation">.</span>apparmor<span class="token punctuation">.</span>security<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/superopsmsb: localhost/apparmor_profile
spec:
  containers:
  <span class="token operator">-</span> name: superopsmsb
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<p><strong>简单实践</strong></p> 
<pre><code class="prism language-powershell">参考资料：https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/zh-cn/docs/tutorials/security/apparmor/<span class="token comment">#setting-up-nodes-with-profiles</span>
</code></pre> 
<p>创建资源访问策略</p> 
<pre><code class="prism language-powershell">apparmor在内存中生成配置规则 
apparmor_parser <span class="token operator">-</span>q &lt;&lt;EOF
<span class="token comment">#include &lt;tunables/global&gt;</span>
profile kubernetes-<span class="token function">deny-write</span> flags=<span class="token punctuation">(</span>attach_disconnected<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">#include &lt;abstractions/base&gt;</span>
  file<span class="token punctuation">,</span>
  <span class="token comment"># Deny all file writes.</span>
  deny <span class="token operator">/</span>tmp/<span class="token operator">*</span><span class="token operator">*</span> w<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
EOF'
</code></pre> 
<p>简单实践</p> 
<pre><code class="prism language-powershell">资源对象文件 13_kubernetes_server_secure_apparmor_podtest<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test
  annotations:
    container<span class="token punctuation">.</span>apparmor<span class="token punctuation">.</span>security<span class="token punctuation">.</span>beta<span class="token punctuation">.</span>kubernetes<span class="token punctuation">.</span>io/busybox-test: localhost/kubernetes-<span class="token function">deny-write</span>
spec:
  nodeName: kubernetes-node4
  containers:
  <span class="token operator">-</span> name: busybox-test
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    
创建资源清单文件
kubectl apply <span class="token operator">-</span>f 13_kubernetes_server_secure_apparmor_podtest<span class="token punctuation">.</span>yaml

检查效果
kubectl get pod
</code></pre> 
<pre><code class="prism language-powershell">确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it busybox-test -- /bin/sh</span>
<span class="token operator">/</span> <span class="token comment"># ls /tmp/</span>
<span class="token operator">/</span> <span class="token comment"># echo nihao &gt; /tmp/nihao.txt</span>
<span class="token operator">/</span>bin/sh: can't create <span class="token operator">/</span>tmp/nihao<span class="token punctuation">.</span>txt: Permission denied
<span class="token operator">/</span> <span class="token comment"># echo nihao &gt; nihao.txt</span>
<span class="token operator">/</span> <span class="token comment">#</span>
结果显示:
	借助于apparmor的策略规则实现了容器内部资源操作的限制能力了
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h3><a id="14__2291"></a>1.4 调用限制</h3> 
<h4><a id="141_Seccomp_2293"></a>1.4.1 Seccomp</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、Seccomp简介、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>简介</p> 
<pre><code class="prism language-powershell">	所谓的系统调用，其实就是用户空间进程无法直接操作底层的设备，我们只能向内核空间发起请求调用，由内核空间的驱动程序来对底层设备进行相关的操作。
	这样的话，用户层只需要关注业务层面的操作，通过技术手段借助于系统调用实现资源相关的操作，从而实现业务和技术层面的解耦
</code></pre> 
<p><img src="https://images2.imgbox.com/31/d7/BYB9Ufz6_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">在 Docker Driver 的实现中，可以分为以下三类驱动。
	graphdriver 负责容器镜像的管理
		主要就是镜像的存储和获取，当镜像下载的时候，会将镜像持久化存储到本地的指定目录；
	networkdriver 负责容器网络环境的管理
		主要就是 Docker 运行时进行 IP 分配端口映射以及启动时创建网桥和虚拟网卡；
	execdriver 负责容器命令执行的管理
		主要就是通过操作 Lxc 或者 libcontainer 实现资源隔离。
		它负责创建管理容器运行命名空间、管理分配资源和容器内部真实进程的运行；
		通过调用 libcontainer 加载容器配置 container，继而创建真正的 Docker 容器。
</code></pre> 
<p>namespace</p> 
<pre><code class="prism language-powershell">	容器可以创建出一个相对隔离的环境，就容器技术本身来说，容器的核心部分是利用了我们操作系统内核的虚拟化技术，在 Linux 内核中，实现各种资源隔离功能的技术就叫 Linux Namespace，它可以隔离一系列的系统资源。在Docker容器环境下，这些namespace主要体现在如下七个层面：
</code></pre> 
<pre><code class="prism language-powershell">PID Namespace：
	保障进程隔离，每个容器都以 PID=1 的 init 进程来启动<span class="token punctuation">,</span>其他进程的 PID 会依次递增。
	PID Namespace 使用了的参数 CLONE_NEWPID。
	父 NameSpace 可以拿到全部子 NameSpace 的状态，但每个子 NameSpace 之间是互相隔离的。

User Namespace：
	用于隔离容器中 UID、GID 以及根目录等。
	User Namespace 使用了 CLONE_NEWUSER 的参数，可配置映射宿主机和容器中的 UID、GID。
	UID 在当前的 Namespace 下，是具有容器 root 权限的，不是宿主机的。

UTS Namespace：
	保障每个容器都有独立的主机名或域名。
	UTS Namespace 使用了的参数 CLONE_NEWUTS，用来隔离 hostname 和 NIS Domain name。

<span class="token function">Mount</span> Namespace: 
	保障每个容器都有独立的目录挂载路径。
	<span class="token function">Mount</span> Namespace 使用了的参数 CLONE_NEWNS，用来隔离各个进程看到的挂载点视图。

NET Namespace：
	保障每个容器有独立的网络栈、socket 和网卡设备。
	NET Namespace 使用了参数 CLONE_NEWNET，隔离了和网络有关的资源，如网络设备、IP 地址端口等。

IPC Namespace：
	保障每个容器进程 IPC 通信隔离。
	IPC Namespace 使用了的参数 CLONE_NEWIPC，用来隔离 系统IPC 和 POSIX message队列
	在相同 IPC 命名空间的容器进程之间才可以共享内存、信号量、消息队列通信。

Cgroup Namespace：
	保障容器容器中看到的 cgroup 视图，像宿主机一样以根形式来呈现
	让容器内使用 cgroup 变得更安全。
</code></pre> 
<p>系统调用</p> 
<pre><code class="prism language-powershell">	这7 类 Namespace 主要使用如下 3 个系统调用函数，其实也就是和进程有关的调用函数。
	clone：
		创建新进程，根据传入上面的不同 NameSpace 类型，来创建不同的 NameSpace 进行隔离，
		对应的子进程也会被包含到这些 Namespace 中。
	unshare：
		将进程移出某个指定类型的 Namespace，并加入到新创建的 NameSpace 中
        容器中 NameSpace 也是通过 unshare 系统调用创建的。
    setns：
    	将进程加入到 Namespace 中
</code></pre> 
<p><strong>Seccomp简介</strong></p> 
<p>场景需求</p> 
<pre><code class="prism language-powershell">	kubernetes的所有业务活动都会以容器的方式来实现，但是有些应用业务需要涉及到底层资源的操作，所以默认情况下存在多种系统调用的方式来提升业务的高效实现。但是这些便捷性也为黑客通过进入容器，然后借助于提权操作，进入到宿主机上，进行更大的破坏提供了便捷性。
	所以我们要限制容器使用系统调用的能力。
</code></pre> 
<p>Seccomp方案</p> 
<pre><code class="prism language-powershell">	Seccomp 代表安全计算（Secure Computing）模式，自 2<span class="token punctuation">.</span>6<span class="token punctuation">.</span>12 Linux 内核版本以来，一直是 Linux 内核的一个特性。 它可以用来沙箱化进程的权限，限制进程从用户态到内核态的调用。 Kubernetes 能使你自动将加载到 节点上的 seccomp 配置文件应用到你的 Pod 和容器。
	注意：
		seccomp的配置文件目录<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/kubelet/seccomp是不存在，需要自建
</code></pre> 
<pre><code class="prism language-powershell">	对于1<span class="token punctuation">.</span>19版本之后的kubernetes来说，Seccomp可以在securityContext中进行使用：
	样式1：
		pod<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>containers<span class="token punctuation">.</span>securityContext<span class="token punctuation">.</span>seccompProfile
	样式2：
	 	pod<span class="token punctuation">.</span>spec<span class="token punctuation">.</span>securityContext<span class="token punctuation">.</span>seccompProfile
	 		localhostProfile
	 			<span class="token operator">-</span> 在<span class="token function">type</span>为Localhost的时候使用，指定profile文件的位置
	 		<span class="token function">type</span>
	 			Localhost <span class="token operator">-</span> 使用节点本地的配置文件。默认目录是<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/kubelet/seccomp<span class="token punctuation">.</span>
     			RuntimeDefault <span class="token operator">-</span> 使用容器默认的配置文件<span class="token punctuation">.</span>
     			Unconfined <span class="token operator">-</span> 不用任何配置文件<span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">注意：
	因为涉及到系统调用，所以测试的时候，一定要对特定的主机进行seccomp限制
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="142__2419"></a>1.4.2 应用实践</h4> 
<p>学习目标</p> 
<p>这一节，我们从 属性解读、简单实践、小结 三个方面来学习。</p> 
<p><strong>属性解读</strong></p> 
<p>策略文件样式</p> 
<pre><code class="prism language-powershell"><span class="token punctuation">{<!-- --></span>
    <span class="token string">"defaultAction"</span>: <span class="token string">"SCMP_ACT_ERRNO"</span><span class="token punctuation">,</span>   <span class="token comment"># 默认不执行系统调用，发起调用失败</span>
    <span class="token string">"architectures"</span>: <span class="token punctuation">[</span>
        <span class="token string">"SCMP_ARCH_X86_64"</span><span class="token punctuation">,</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"syscalls"</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"names"</span>: <span class="token punctuation">[</span>				<span class="token comment"># 该动作发起系统调用的名称列表</span>
                <span class="token string">"accept4"</span><span class="token punctuation">,</span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"action"</span>: <span class="token string">"SCMP_ACT_ALLOW"</span>  <span class="token comment"># 允许执行系统调用</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>kubernetes<span class="token punctuation">.</span>io/zh-cn/docs/tutorials/security/seccomp/
</code></pre> 
<p>常见的系统调用</p> 
<pre><code class="prism language-powershell">进程控制相关
	fork、clone、execve、<span class="token keyword">exit</span>、pause、wait、ptrace等
文件系统相关
	文件读写操作 open、creat、close、read、<span class="token function">write</span>等
	文件系统操作 access、<span class="token function">chdir</span>、chmod、chown、mkdir、<span class="token function">rmdir</span>等
系统控制相关
	ioctl、reboot、sysinfo、time等
内存管理相关
	mlock、mmap、getpagesize、sync、cacheflush等
网络管理相关
	getdomainname、setdomainname、gethostname、sethostname等
socket管理相关
	socketcall、socket、bind、connect、accept、send、listen等
用户管理相关
	getuid、setuid、getgid、setgid、getgroups、setgroups等
进程间通信相关
	sigaction、sigprocmask、signal、<span class="token function">kill</span>、pipe、semctl等
</code></pre> 
<p>环境准备</p> 
<pre><code class="prism language-powershell">以 node2 节点为例
mkdir <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/kubelet/seccomp/profiles <span class="token operator">-</span>p
cd <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/kubelet/seccomp/profiles
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备策略文件</p> 
<pre><code class="prism language-powershell">在node2上准备策略文件 <span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>lib/kubelet/seccomp/profiles/change_test<span class="token punctuation">.</span>json
<span class="token punctuation">{<!-- --></span>
    <span class="token string">"defaultAction"</span>: <span class="token string">"SCMP_ACT_ALLOW"</span><span class="token punctuation">,</span>
    <span class="token string">"syscalls"</span>: <span class="token punctuation">[</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token string">"names"</span>: <span class="token punctuation">[</span>
                <span class="token string">"chmod"</span><span class="token punctuation">,</span>
                <span class="token string">"chown"</span><span class="token punctuation">,</span>
                <span class="token string">"rmdir"</span>                
            <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token string">"action"</span>: <span class="token string">"SCMP_ACT_ERRNO"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

重启kubelet服务
systemctl restart kubelet
</code></pre> 
<p>资源对象实践</p> 
<pre><code class="prism language-powershell">资源对象文件 14_kubernetes_server_secure_seccomp_test<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: busybox-test
spec:
  nodeName: kubernetes-node2
  containers:
  <span class="token operator">-</span> name: busybox-test1
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
  <span class="token operator">-</span> name: busybox-test2
    image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/busybox
    command: <span class="token punctuation">[</span> <span class="token string">"sh"</span><span class="token punctuation">,</span> <span class="token string">"-c"</span><span class="token punctuation">,</span> <span class="token string">"sleep 1h"</span> <span class="token punctuation">]</span>
    securityContext:
      seccompProfile:
        <span class="token function">type</span>: Localhost
        localhostProfile: profiles/change_test<span class="token punctuation">.</span>json
        
应用资源对象
kubectl apply <span class="token operator">-</span>f 14_kubernetes_server_secure_seccomp_test<span class="token punctuation">.</span>yaml
</code></pre> 
<pre><code class="prism language-powershell">确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it busybox-test -c busybox-test1 -- /bin/sh/ # cd /tmp/</span>
<span class="token operator">/</span>tmp <span class="token comment"># mkdir nihao</span>
<span class="token operator">/</span>tmp <span class="token comment"># chown 1000:1000 nihao</span>
<span class="token operator">/</span>tmp <span class="token comment"># chmod +x nihao</span>
<span class="token operator">/</span>tmp <span class="token comment"># rmdir nihao</span>
<span class="token operator">/</span>tmp <span class="token comment"># ls</span>
<span class="token operator">/</span>tmp <span class="token comment"># exit</span>
结果显示：
	第一个容器操作没有任何异常
</code></pre> 
<pre><code class="prism language-powershell">确认效果
<span class="token punctuation">]</span><span class="token comment"># kubectl exec -it busybox-test -c busybox-test2 -- /bin/sh</span>
<span class="token operator">/</span> <span class="token comment"># cd /tmp/</span>
<span class="token operator">/</span>tmp <span class="token comment"># mkdir nihao</span>
<span class="token operator">/</span>tmp <span class="token comment"># chown 1000:1000 nihao</span>
chown: nihao: Operation not permitted
<span class="token operator">/</span>tmp <span class="token comment"># chmod +x nihao</span>
chmod: nihao: Operation not permitted
<span class="token operator">/</span>tmp <span class="token comment"># rmdir nihao</span>
<span class="token function">rmdir</span>: <span class="token string">'nihao'</span>: Operation not permitted
<span class="token operator">/</span>tmp <span class="token comment"># ls</span>
nihao
<span class="token operator">/</span>tmp <span class="token comment"># exit</span>
结果显示：
	第二个容器操作受到我们的seccomp的策略管控，系统调用无法执行
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h3><a id="15__2574"></a>1.5 应用沙箱</h3> 
<h4><a id="151_gVisor_2576"></a>1.5.1 gVisor应用</h4> 
<p>学习目标</p> 
<p>这一节，我们从 软件简介、原理解读、小结 三个方面来学习。</p> 
<p><strong>软件简介</strong></p> 
<p>场景</p> 
<pre><code class="prism language-powershell">	根据我们对于应用服务安全的基础了解，基于容器方式的应用程序在正常运行的时候，不可避免的在一些场景下需要直接访问linux内核的系统调用，虽然我们可以通过namespace和cgroup等方式实现一定程度上的资源隔离，但是安全性还是比较弱的，容器里的应用程序依然可以访问很多系统资源，事实上跟没有跑在容器里的应用程序一样，容器里的应用程序可以直接通过linux内核的系统调用陷入到内核，任何一个被允许的系统调用的缺陷都可以被恶意的应用程序利用，这也直接导致各种基于容器环境的漏洞借助于系统内核调用的方式实现宿主机的攻击。
</code></pre> 
<pre><code class="prism language-powershell">	虽然linux内核在不断的增强自身的安全特性，但是由于linux内核的功能限制，它不可能面面俱到最好的方式是以更高级别或者更全方位层次的实现安全隔离，最好能像程序代码松耦合一样，阻断容器内部程序对于宿主机的依赖。
</code></pre> 
<p><img src="https://images2.imgbox.com/06/04/doh2sgY3_o.png" alt="在这里插入图片描述"></p> 
<p>解决方案</p> 
<pre><code class="prism language-powershell">	样式1: 基于VM虚拟机的方案，将潜在恶意的应用程序隔离在独立的虚拟机中，例如kata linux，基于VM的方案提高了很好的隔离，但相应额外消耗的内存会多一些。在有需要运行大量container的场景下的额外资源消耗不能被忽略。虽然它可以很好的与Docker和Kubernetes进行集成。
	大规模场景中，对于资源消耗比较高，成本比较高。
</code></pre> 
<pre><code class="prism language-powershell">	样式2：基于规则的执行<span class="token punctuation">(</span>如seccomp，SELinux和AppArmor等<span class="token punctuation">)</span>允许为应用程序或容器指定细粒度的安全策略，虽然这是隔离应用程序和保持本机性能的绝佳方式，但是这些规则的技术门槛比较高，导致实现起来很不方便甚至某些场景无法实现。
</code></pre> 
<pre><code class="prism language-powershell">	样式3：Google开源的一种gVisor技术提供了另外一种sandbox思路，gVisor非常轻量级，额外的内存消耗非常小，但同时提供了和VM方案相当隔离等级。gVisor遵循了OCI标准，所以可以作为容器的一个runtime方式来执行，它可以很好的与Docker和Kubernetes进行集成。
	由于其以运行场景的限制，它可能会在系统调用繁重的工作负载时表现出较差的性能。
</code></pre> 
<p>Gvisor</p> 
<pre><code class="prism language-powershell">	gVisor是Google开源的有关容器安全的组件，是用Go语言编写的 <span class="token operator">--</span> <span class="token string">"用户空间内核(UML)"</span>，它实现了大部分的Linux系统调用命令<span class="token punctuation">(</span>240+<span class="token punctuation">)</span>，它限制了应用程序直接访问主机内核，同时能保持应用程序所期望的访问结果。也就是说，gVisor它利用现有的主机内核功能以普通的用户空间的方式运行 <span class="token operator">--</span> gVisor通过Linux底层实现Linux进程。
</code></pre> 
<pre><code class="prism language-powershell">	官网地址：https:<span class="token operator">/</span><span class="token operator">/</span>gvisor<span class="token punctuation">.</span>dev/
	github地址：https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/google/gvisor
</code></pre> 
<p><strong>原理解读</strong></p> 
<p>gvisor结构</p> 
<p><img src="https://images2.imgbox.com/8e/33/38QENHPd_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">runsc <span class="token operator">-</span> 容器入口
	gvisor包含一个叫了runsc的OCI运行时，目的是提供应用程序与主机内核之间的边界隔离，runsc实现了多个命令来执行各种功能，例如启动、停止、列出和查询容器的状态。
	gVisor将应用程序加载到runsc的内存空间中并运行，目前runsc运行时已经与Docker和Kubernetes做了集成，使运行沙箱容器sandbox变得很简单。
</code></pre> 
<pre><code class="prism language-powershell">Sentry <span class="token operator">-</span> 系统调用
	Sentry 是 gVisor 的最大组件。它实现了应用程序所需的所有内核功能，包括：系统调用、信号传递、内存管理和页面错误逻辑、线程模型等等。
	当应用程序进行系统调用时， 平台基于ptrace syscall截获并将调用重定向到Sentry，Sentry将做必要的工作来服务它。需要注意的是，Sentry 不会将系统调用传递给主机内核。作为一个用户空间应用程序，Sentry 会进行一些宿主系统调用来支持它的操作，但它不允许应用程序直接控制它进行的系统调用。
	例如，Sentry不能直接打开文件；超出沙盒的文件系统操作（不是内部<span class="token operator">/</span>proc文件、管道等）被发送到 Gofer。
</code></pre> 
<pre><code class="prism language-powershell">Gofer <span class="token operator">-</span> IO代理
	Gofer 是一个标准的主机进程，它从每个容器开始，并通过 9P 协议通过套接字或共享内存通道与 Sentry 通信。Sentry 进程在受限的 seccomp 容器中启动，无法访问文件系统资源。Gofer 调解对这些资源的所有访问，提供额外的隔离级别。
</code></pre> 
<p>镜像应用</p> 
<pre><code class="prism language-powershell">关于gvisor所支持的docker镜像有很多，官方帮我们测试了很多的基础应用镜像文件，这些文件有：
	elasticsearch、golang、httpd、java8、jenkins、mariadb、memcached、mongo、mysql、nginx、node、php、postgres、prometheus、python、redis、registry、tomcat、wordpress、等
	
参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>gvisor<span class="token punctuation">.</span>dev/docs/user_guide/compatibility/
</code></pre> 
<pre><code class="prism language-powershell">gvisor所运行的容器环境中，可以执行通用的一些linux命令，这些常见的命令有：
	apt-get、bundle、<span class="token function">cat</span>、curl、dd、df、dig、drill、env、find、gcore、gdb、gosu、grep、ifconfig、ip、less、<span class="token function">ls</span>、lsof、<span class="token function">mount</span>、nc、nmap、netstat、nslookup、ping、<span class="token function">ps</span>、route、ss、sshd、strace、tar、tcpdump、top、uptime、vim、wget等
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="152__2674"></a>1.5.2 环境集成</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>基础知识</strong></p> 
<p>环境需求</p> 
<pre><code class="prism language-powershell">	对于gVisor软件的部署，他有一些基本要求：
		要求linux 内核 4<span class="token punctuation">.</span>14<span class="token punctuation">.</span>77+
		要求Docker 版本 17<span class="token punctuation">.</span>09<span class="token punctuation">.</span>0+
	
参考资料：
	https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/google/gvisor<span class="token comment">#installing-from-source</span>
</code></pre> 
<p>linux内核</p> 
<pre><code class="prism language-powershell">官方资料：https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>kernel<span class="token punctuation">.</span>org/
最新版本：6<span class="token punctuation">.</span>0<span class="token punctuation">.</span>2
</code></pre> 
<p>更新内核</p> 
<pre><code class="prism language-powershell">检查节点的内核版本
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># uname -r</span>
3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-1160<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64
解析：
	3<span class="token punctuation">(</span>主版本号<span class="token punctuation">)</span><span class="token punctuation">.</span>10<span class="token punctuation">(</span>次版本号<span class="token punctuation">)</span><span class="token punctuation">.</span>0<span class="token punctuation">(</span>修订版本号<span class="token punctuation">)</span><span class="token operator">-</span>1160<span class="token punctuation">(</span>补丁版本<span class="token punctuation">)</span><span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64
	注意：次版本号是偶数表示稳定版本，奇数表示开发版本
</code></pre> 
<pre><code class="prism language-powershell">导入该源的秘钥
rpm <span class="token operator">--</span>import https:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>org/RPM-GPG-KEY-elrepo<span class="token punctuation">.</span>org
启用该源仓库
rpm <span class="token operator">-</span>Uvh http:<span class="token operator">/</span><span class="token operator">/</span>www<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>org/elrepo-release-7<span class="token punctuation">.</span>0-2<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>noarch<span class="token punctuation">.</span>rpm
查看有哪些内核版本可供安装
yum <span class="token operator">--</span>disablerepo=<span class="token string">"*"</span> <span class="token operator">--</span>enablerepo=<span class="token string">"elrepo-kernel"</span> list available
安装长期支持版本<span class="token punctuation">(</span>5<span class="token punctuation">.</span>4<span class="token punctuation">.</span>218<span class="token punctuation">)</span>
yum <span class="token operator">--</span>enablerepo=elrepo-kernel install kernel-lt <span class="token operator">-</span>y
</code></pre> 
<pre><code class="prism language-powershell">设置 GRUB 默认的内核版本
sed <span class="token operator">-</span>i <span class="token string">'s#GRUB_DEFAULT=.*#GRUB_DEFAULT=0#'</span> <span class="token operator">/</span>etc/default/grub

重新配置grub
grub2-mkconfig <span class="token operator">-</span>o <span class="token operator">/</span>boot/grub2/grub<span class="token punctuation">.</span>cfg

重启主机
reboot
</code></pre> 
<pre><code class="prism language-powershell">确认效果
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># uname -r</span>
5<span class="token punctuation">.</span>4<span class="token punctuation">.</span>218-1<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>elrepo<span class="token punctuation">.</span>x86_64
结果显示：
	内核已经升级完毕了
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>安装步骤</p> 
<pre><code class="prism language-powershell">参考资料：https:<span class="token operator">/</span><span class="token operator">/</span>gvisor<span class="token punctuation">.</span>dev/docs/user_guide/install/
</code></pre> 
<p>部署gvisor</p> 
<pre><code class="prism language-powershell">Centos7部署runsc
<span class="token punctuation">(</span>
  <span class="token function">set</span> <span class="token operator">-</span>e
  ARCH=$<span class="token punctuation">(</span>uname <span class="token operator">-</span>m<span class="token punctuation">)</span>
  URL=https:<span class="token operator">/</span><span class="token operator">/</span>storage<span class="token punctuation">.</span>googleapis<span class="token punctuation">.</span>com/gvisor/releases/release/latest/$<span class="token punctuation">{<!-- --></span>ARCH<span class="token punctuation">}</span>
  wget $<span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">}</span><span class="token operator">/</span>runsc $<span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">}</span><span class="token operator">/</span>runsc<span class="token punctuation">.</span>sha512 \
    $<span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">}</span><span class="token operator">/</span>containerd-shim-runsc-v1 $<span class="token punctuation">{<!-- --></span>URL<span class="token punctuation">}</span><span class="token operator">/</span>containerd-shim-runsc-v1<span class="token punctuation">.</span>sha512
  sha512sum <span class="token operator">-</span>c runsc<span class="token punctuation">.</span>sha512 \
    <span class="token operator">-</span>c containerd-shim-runsc-v1<span class="token punctuation">.</span>sha512
  <span class="token function">rm</span> <span class="token operator">-</span>f <span class="token operator">*</span><span class="token punctuation">.</span>sha512
  chmod a+rx runsc containerd-shim-runsc-v1
  sudo <span class="token function">mv</span> runsc containerd-shim-runsc-v1 <span class="token operator">/</span>usr/local/bin
<span class="token punctuation">)</span>
</code></pre> 
<p>gvisor与docker集成</p> 
<pre><code class="prism language-powershell">更新runsc
<span class="token operator">/</span>usr/local/bin/runsc install
</code></pre> 
<pre><code class="prism language-powershell">确认效果
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># cat /etc/docker/daemon.json</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span>
    <span class="token string">"runtimes"</span>: <span class="token punctuation">{<!-- --></span>
        <span class="token string">"runsc"</span>: <span class="token punctuation">{<!-- --></span>
            <span class="token string">"path"</span>: <span class="token string">"/usr/local/bin/runsc"</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">重载docker服务
sudo systemctl reload docker

确认效果
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># docker info | grep Runtime</span>
 Runtimes: runc runsc
 Default Runtime: runc
结果显示：
	Docker的运行时环境变成了runsc了
</code></pre> 
<pre><code class="prism language-powershell">如果想要让Default Runtime也更换成runsc，需要修改docker的服务文件 
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># vim /lib/systemd/system/docker.service</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
ExecStart=<span class="token operator">/</span>usr/bin/dockerd <span class="token operator">--</span>default-runtime runsc <span class="token operator">-</span>H fd:<span class="token operator">/</span><span class="token operator">/</span> <span class="token operator">--</span>containerd=<span class="token operator">/</span>run/containerd/containerd<span class="token punctuation">.</span>sock
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

重启相关服务
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># systemctl daemon-reload</span>
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># systemctl  restart docker.service</span>

注意：
	由于我们定制的镜像有可能不被gvisor所承认，所以在没有必要的情况下，不要更好默认的runc
</code></pre> 
<p>runc模式测试效果</p> 
<pre><code class="prism language-powershell">普通模式运行容器
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># docker run -d -p 555:80 --name nginx-test kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>
b10a55c3c0ce1d70e0884466f53bb266c5571d03615342a1d6c06ff4f635734c

<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># curl 10.0.0.16:555</span>
Hello Nginx<span class="token punctuation">,</span> b10a55c3c0ce-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1

默认运行的容器以系统进程的样式存在
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># ps aux | grep nginx</span>
root      72852  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0   8844  3480 ?        S    22:52   0:00 nginx: master <span class="token keyword">process</span> nginx <span class="token operator">-</span>g daemon off<span class="token punctuation">;</span>
101       72867  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0   9232  1536 ?        S    22:52   0:00 nginx: worker <span class="token keyword">process</span>
101       72868  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0   9232  1768 ?        S    22:52   0:00 nginx: worker <span class="token keyword">process</span>
root      73138  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0 112824   988 pts/0    S+   22:52   0:00 grep <span class="token operator">--</span>color=auto nginx
</code></pre> 
<pre><code class="prism language-powershell">查看底层的系统内核
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># docker exec -it nginx-test uname -r</span>
3<span class="token punctuation">.</span>10<span class="token punctuation">.</span>0-1160<span class="token punctuation">.</span>el7<span class="token punctuation">.</span>x86_64

管理容器的方式
<span class="token namespace">[root@kubernetes-node2 ~]</span><span class="token comment"># ps -ef | grep runc</span>
root       1932      1  0 19:08 ?        00:00:03 <span class="token operator">/</span>usr/bin/containerd-shim-runc-v2 <span class="token operator">-</span>namespace moby <span class="token operator">-</span>id d0a246513ea3225fd1a7be69b5c3ac009d395dcd809b1cbc1d555196d271a5c5 <span class="token operator">-</span>address <span class="token operator">/</span>run/containerd/containerd<span class="token punctuation">.</span>sock
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示:
	容器都是有runc来进行管理的
</code></pre> 
<p>runsc模式测试效果</p> 
<pre><code class="prism language-powershell">测试效果
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># docker run -d -p 666:80 --name nginx-test --runtime=runsc kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>

<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># curl 10.0.0.17:666</span>
Hello Nginx<span class="token punctuation">,</span> 76afcde42b20-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1

默认运行的容器，不再以系统进程样式存在了
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># ps aux | grep nginx</span>
root      15293  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0 112832  2276 pts/1    S+   22:54   0:00 grep <span class="token operator">--</span>color=auto nginx
</code></pre> 
<pre><code class="prism language-powershell">查看底层的系统内核
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># docker exec -it nginx-test uname -r</span>
4<span class="token punctuation">.</span>4<span class="token punctuation">.</span>0

管理容器的方式
<span class="token namespace">[root@kubernetes-node3 ~]</span><span class="token comment"># ps -ef | grep runsc</span>
root      15014  14998  0 22:53 ?        00:00:00 runsc-gofer <span class="token operator">--</span>root=<span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/docker/runtime-runc/moby <span class="token operator">--</span>log=<span class="token operator">/</span>run/containerd/io<span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>task/moby/76afcde42b2030cc959517bccff743c913aaba52b21c9c635df638bde709597f/log<span class="token punctuation">.</span>json <span class="token operator">--</span>log-format=json <span class="token operator">--</span>systemd-cgroup=true <span class="token operator">--</span>log-fd=3 gofer <span class="token operator">--</span>bundle
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	当容器发生系统调用的时候走的都是虚拟内核，如果要对内核做破坏那么也是对虚拟内核做破坏，对宿主机的内核没什么影响
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="153_Containerd_2884"></a>1.5.3 Containerd集成</h4> 
<p>学习目标</p> 
<p>这一节，我们从 基础知识、简单实践、小结 三个方面来学习。</p> 
<p><strong>场景解读</strong></p> 
<p>kubernetes操作容器</p> 
<p><img src="https://images2.imgbox.com/0e/43/F1NnlwbI_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-powershell">High-level container management
	负责kubernetes集群环境操作容器高阶运行时的工具，比如kubelet和crictl。
	
High-level conatiner runtime
	高阶运行时负责容器镜像的传输和管理、解包镜像以及使用OCI传递给低级运行时来运行容器。目前三个主要的高级容器运行时：
	containerd： Kubernetes的默认CRI容器运行时，它支持所有 OCI 兼容的运行时，并有一个特殊的 shim 用于kata-run；
	CRI-O：Kubernetes独立创建的配套CRI运行时，不是k8s发行版的默认模式
	cridockerd： 兼容 Docker 容器引擎平台的一种方式。

Low-level contianer runtime。
	专注于运行容器的实际容器运行时。低级别的容器运行时都需要遵循OCI开放容器标准，方便高级别容器运行时进行调用。常见的运行时主要有：
	runc：Docker、Podman和contained等高阶容器运行时的默认设置。
	kata-run： Kata Containers贡献的运行时，借助轻量级 VM 中实现容器之间的安全隔离。
	gVisor： 谷歌贡献的运行时，通过安全沙箱中实现容器的深层次隔离。
</code></pre> 
<p>10.0.0.29节点进行containerd配置</p> 
<pre><code class="prism language-powershell">准备工作
apt-get install apt-transport-https ca-certificates curl gnupg lsb-release <span class="token operator">-</span>y
curl <span class="token operator">-</span>fsSL https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>tuna<span class="token punctuation">.</span>tsinghua<span class="token punctuation">.</span>edu<span class="token punctuation">.</span>cn/docker-ce/linux/ubuntu/gpg <span class="token punctuation">|</span> sudo gpg <span class="token operator">--</span>dearmor <span class="token operator">-</span>o <span class="token operator">/</span>usr/share/keyrings/docker-archive-keyring<span class="token punctuation">.</span>gpg
<span class="token function">echo</span> \
  <span class="token string">"deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://mirrors.tuna.tsinghua.edu.cn/docker-ce/linux/ubuntu \
  <span class="token function">$<span class="token punctuation">(</span>lsb_release <span class="token operator">-</span>cs<span class="token punctuation">)</span></span> stable"</span> <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/docker<span class="token punctuation">.</span>list &gt; <span class="token operator">/</span>dev/null
</code></pre> 
<pre><code class="prism language-powershell">安装Containerd服务
apt-get update
apt-get install containerd<span class="token punctuation">.</span>io cri-tools <span class="token operator">-</span>y
</code></pre> 
<pre><code class="prism language-powershell">生成配置文件
systemctl enable containerd <span class="token operator">--</span>now
containerd config default &gt; <span class="token operator">/</span>etc/containerd/config<span class="token punctuation">.</span>toml
</code></pre> 
<pre><code class="prism language-powershell">修改配置文件
<span class="token namespace">[plugins]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment"># 修改pause镜像地址</span>
    sandbox_image = <span class="token string">"kubernetes-register.superopsmsb.com/google_containers/pause:3.7"</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">.</span>runc<span class="token punctuation">]</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">.</span>runc<span class="token punctuation">.</span>options<span class="token punctuation">]</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment"># 修改Cgroup驱动为systemd</span>
        SystemdCgroup = true
    <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">]</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token comment"># 定制专属的私有镜像仓库</span>
      <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>configs<span class="token punctuation">]</span>
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>configs<span class="token punctuation">.</span><span class="token string">"kubernetes-register.superopsmsb.com"</span><span class="token punctuation">.</span>tls<span class="token punctuation">]</span>
          insecure_skip_verify = true
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>configs<span class="token punctuation">.</span><span class="token string">"kubernetes-register.superopsmsb.com"</span><span class="token punctuation">.</span>auth<span class="token punctuation">]</span>
          username = <span class="token string">"shuji"</span>
          password = <span class="token string">"A12345678a"</span>

      <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>headers<span class="token punctuation">]</span>
      <span class="token comment"># 定制专属的镜像仓库</span>
      <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>mirrors<span class="token punctuation">]</span>
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>mirrors<span class="token punctuation">.</span><span class="token string">"docker.io"</span><span class="token punctuation">]</span>
          endpoint = <span class="token punctuation">[</span><span class="token string">"http://74f21445.m.daocloud.io"</span><span class="token punctuation">,</span><span class="token string">"https://docker.mirrors.ustc.edu.cn"</span><span class="token punctuation">]</span>
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>registry<span class="token punctuation">.</span>mirrors<span class="token punctuation">.</span><span class="token string">"kubernetes-register.superopsmsb.com"</span><span class="token punctuation">]</span>
          endpoint = <span class="token punctuation">[</span><span class="token string">"http://kubernetes-register.superopsmsb.com"</span><span class="token punctuation">]</span>
</code></pre> 
<pre><code class="prism language-powershell">配置命令工具
crictl config runtime-endpoint unix:<span class="token operator">/</span><span class="token operator">/</span><span class="token operator">/</span><span class="token keyword">var</span><span class="token operator">/</span>run/containerd/containerd<span class="token punctuation">.</span>sock
</code></pre> 
<pre><code class="prism language-powershell">重启containerd服务
systemctl restart containerd<span class="token punctuation">;</span> systemctl enable containerd
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>镜像操作</p> 
<pre><code class="prism language-powershell">操作方式1：有命名空间的操作限制
	查看空间：ctr ns list
	应用空间：export CONTAINERD_NAMESPACE=k8s<span class="token punctuation">.</span>io
	查看镜像：ctr i list
	获取镜像：ctr i pull image名称
操作方式2：无限制
	查看镜像：crictl images
	获取镜像：crictl pull image名称
	删除镜像：crictl rmi image名称
注意：
	关于增删改查的操作，最好使用一套命令，不要A样式创建，然后B样式删除
</code></pre> 
<pre><code class="prism language-powershell">获取镜像
crictl pull docker<span class="token punctuation">.</span>io/nginx
crictl pull kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1

确认效果
root@kubernetes-node4:<span class="token operator">/</span>etc/containerd<span class="token comment"># crictl image list</span>
IMAGE                                                       TAG                 IMAGE ID            SIZE
docker<span class="token punctuation">.</span>io/library/nginx                                     latest              605c77e624ddb       56<span class="token punctuation">.</span>7MB
kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web   v0<span class="token punctuation">.</span>1                1f0791fd0a992       56<span class="token punctuation">.</span>7MB
</code></pre> 
<p>命令升级</p> 
<pre><code class="prism language-powershell">	因为ctr 和 crictl 相关的命令与docker命令的格式有些许差别，当我们习惯使用docker命令后，为了方便使用containerd，我们可以改造命令，使用nerdctl工具来操作，格式与docker的格式完全一致。因为该工具依赖于cni的插件，所以我们还需要下载特定的cni插件
	参考资料: 
		https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/containerd/nerdctl/releases
		https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/containernetworking/plugins/releases
</code></pre> 
<pre><code class="prism language-powershell">获取软件
mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs &amp;&amp; cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>softs
wget https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/containerd/nerdctl/releases/download/v0<span class="token punctuation">.</span>23<span class="token punctuation">.</span>0/nerdctl-0<span class="token punctuation">.</span>23<span class="token punctuation">.</span>0-linux-amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
https:<span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com/containernetworking/plugins/releases/download/v1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1/cni-plugins-linux-amd64-v1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>tgz
</code></pre> 
<pre><code class="prism language-powershell">获取软件
tar zxvf nerdctl-0<span class="token punctuation">.</span>23<span class="token punctuation">.</span>0-linux-amd64<span class="token punctuation">.</span>tar<span class="token punctuation">.</span>gz
mkdir <span class="token operator">-</span>p <span class="token operator">/</span>opt/cni/bin/
tar zxf cni-plugins-linux-amd64-v1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>1<span class="token punctuation">.</span>tgz <span class="token operator">-</span>C <span class="token operator">/</span>opt/cni/bin/
<span class="token function">mv</span> nerdctl <span class="token operator">/</span>bin/
</code></pre> 
<pre><code class="prism language-powershell">定制命令补全功能
<span class="token function">echo</span> <span class="token string">'source &lt;(nerdctl completion bash)'</span> &gt;&gt; <span class="token operator">/</span>etc/profile
source <span class="token operator">/</span>etc/profile
</code></pre> 
<p>确认效果</p> 
<pre><code class="prism language-powershell">声明环境变量
root@kubernetes-node4:~<span class="token comment"># export CONTAINERD_NAMESPACE=k8s.io</span>

查看镜像信息
root@kubernetes-node4:~<span class="token comment"># nerdctl images</span>
REPOSITORY    TAG       IMAGE ID        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    SIZE         BLOB SIZE
nginx         latest    0d17b565c37b    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>    149<span class="token punctuation">.</span>1 MiB    54<span class="token punctuation">.</span>1 MiB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre> 
<pre><code class="prism language-powershell">获取镜像
root@kubernetes-node4:~<span class="token comment"># nerdctl pull nginx:latest</span>
root@kubernetes-node4:~<span class="token comment"># nerdctl pull kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1 --insecure-registry</span>

删除镜像
root@kubernetes-node4:~<span class="token comment"># nerdctl rmi nginx:latest --force</span>
</code></pre> 
<pre><code class="prism language-powershell">运行容器
root@kubernetes-node4:~<span class="token comment"># nerdctl run -d --name=web1 --restart=always kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>

查看容器
root@kubernetes-node4:~<span class="token comment"># nerdctl ps</span>
CONTAINER ID    IMAGE                                                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
76d751060dbe    kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

查看进程
root@kubernetes-node4:~<span class="token comment"># ps aux | grep nginx</span>
root       70577  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>1   8860  5588 ?        S    09:39   0:00 nginx: master <span class="token keyword">process</span> nginx <span class="token operator">-</span>g daemon off<span class="token punctuation">;</span>
systemd+   70578  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0   9280  2544 ?        S    09:39   0:00 nginx: worker <span class="token keyword">process</span>
systemd+   70579  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>0   9280  2544 ?        S    09:39   0:00 nginx: worker <span class="token keyword">process</span>
</code></pre> 
<pre><code class="prism language-powershell">关闭容器
root@kubernetes-node4:~<span class="token comment"># nerdctl stop web1</span>
web1

删除容器
root@kubernetes-node4:~<span class="token comment"># nerdctl rm web1</span>
web1
</code></pre> 
<p>Ubuntu部署gVisor</p> 
<pre><code class="prism language-powershell">准备工作
apt-get update
apt-get install <span class="token operator">-</span>y apt-transport-https ca-certificates curl gnupg
</code></pre> 
<pre><code class="prism language-powershell">软件源配置
curl <span class="token operator">-</span>fsSL https:<span class="token operator">/</span><span class="token operator">/</span>gvisor<span class="token punctuation">.</span>dev/archive<span class="token punctuation">.</span>key <span class="token punctuation">|</span> sudo gpg <span class="token operator">--</span>dearmor <span class="token operator">-</span>o <span class="token operator">/</span>usr/share/keyrings/gvisor-archive-keyring<span class="token punctuation">.</span>gpg
<span class="token function">echo</span> <span class="token string">"deb [arch=<span class="token function">$<span class="token punctuation">(</span>dpkg <span class="token operator">--</span>print-architecture<span class="token punctuation">)</span></span> signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] https://storage.googleapis.com/gvisor/releases release main"</span> <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/gvisor<span class="token punctuation">.</span>list &gt; <span class="token operator">/</span>dev/null
</code></pre> 
<pre><code class="prism language-powershell">安装runsc
apt-get update &amp;&amp; sudo apt-get install <span class="token operator">-</span>y runsc
</code></pre> 
<p>containerd使用gVisor环境</p> 
<pre><code class="prism language-powershell">编辑containerd的config<span class="token punctuation">.</span>toml文件
<span class="token namespace">[plugins]</span>
  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">]</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">]</span>
      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
      <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">]</span>
        <span class="token comment"># 增加对于runsc的支持</span>
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">.</span>runsc<span class="token punctuation">]</span>
          runtime_type = <span class="token string">"io.containerd.runsc.v1"</span>
        <span class="token punctuation">[</span>plugins<span class="token punctuation">.</span><span class="token string">"io.containerd.grpc.v1.cri"</span><span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtimes<span class="token punctuation">.</span>runc<span class="token punctuation">]</span>
          <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
          runtime_type = <span class="token string">"io.containerd.runc.v2"</span>
		  <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>          
</code></pre> 
<pre><code class="prism language-powershell">重启containerd服务
systemctl daemon-reload <span class="token punctuation">;</span> systemctl restart containerd
</code></pre> 
<pre><code class="prism language-powershell">确认效果
root@kubernetes-node4:<span class="token operator">/</span>etc/containerd<span class="token comment"># crictl info | egrep  'runtimes|runtimeType'</span>
      <span class="token string">"runtimes"</span>: <span class="token punctuation">{<!-- --></span>
          <span class="token string">"runtimeType"</span>: <span class="token string">"io.containerd.runc.v2"</span><span class="token punctuation">,</span>
          <span class="token string">"runtimeType"</span>: <span class="token string">"io.containerd.runsc.v1"</span><span class="token punctuation">,</span>
</code></pre> 
<p>测试沙箱能力</p> 
<pre><code class="prism language-powershell">运行容器
root@kubernetes-node4:~<span class="token comment"># nerdctl run -d --name=web1 --runtime=runsc -p 666:80 kubernetes-register.superopsmsb.com/superopsmsb/nginx_web:v0.1</span>

查看容器
root@kubernetes-node4:~<span class="token comment"># nerdctl ps</span>
CONTAINER ID    IMAGE                                                            <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
76d751060dbe    kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

访问容器
root@kubernetes-node4:<span class="token operator">/</span>etc/containerd<span class="token comment"># curl 10.0.0.29:666</span>
Hello Nginx<span class="token punctuation">,</span> 6e0ec44d040c-1<span class="token punctuation">.</span>23<span class="token punctuation">.</span>1
</code></pre> 
<pre><code class="prism language-powershell">查看进程
root@kubernetes-node4:~<span class="token comment"># ps aux | grep nginx</span>
结果显示：
	没有任何进程可以显示

查看runsc进程
root@kubernetes-node4:<span class="token operator">/</span>etc/containerd<span class="token comment"># ps aux | grep runsc</span>
root       75417  0<span class="token punctuation">.</span>3  0<span class="token punctuation">.</span>4 745432 19688 ?        <span class="token function">Sl</span>   09:53   0:00 runsc-gofer <span class="token operator">--</span>root=<span class="token operator">/</span>run/containerd/runc/k8s<span class="token punctuation">.</span>io <span class="token operator">--</span>log=<span class="token operator">/</span>run/containerd/io<span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>task/k8s<span class="token punctuation">.</span>io/<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	容器的进程被gVisor的沙箱管理起来了
</code></pre> 
<pre><code class="prism language-powershell">环境收尾
nerdctl stop web1
nerdctl <span class="token function">rm</span> web1
</code></pre> 
<p><strong>小结</strong></p> 
<pre><code class="prism language-powershell">
</code></pre> 
<h4><a id="154_k8s_3186"></a>1.5.4 k8s集成</h4> 
<p>学习目标</p> 
<p>这一节，我们从 节点添加、简单实践、小结 三个方面来学习。</p> 
<p><strong>节点添加</strong></p> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">master节点 跨主机免密码认证
ssh-<span class="token function">copy-id</span> root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29
ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29 <span class="token string">"mkdir /data/scripts -p"</span>
<span class="token function">echo</span> <span class="token string">'10.0.0.29 kubernetes-node4.superopsmsb.com  kubernetes-node4'</span> &gt;&gt; <span class="token operator">/</span>etc/hosts
</code></pre> 
<pre><code class="prism language-powershell">master节点 传递相关文件
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts
scp 02_kubernetes_kernel_conf<span class="token punctuation">.</span>sh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29:<span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/
<span class="token keyword">for</span> i in <span class="token punctuation">{<!-- --></span>13<span class="token punctuation">.</span><span class="token punctuation">.</span>17<span class="token punctuation">}</span> 29
<span class="token keyword">do</span>
  scp <span class="token operator">/</span>etc/hosts root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span><span class="token variable">$i</span>:<span class="token operator">/</span>etc/hosts
done 
ssh root@10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>29 <span class="token string">"hostnamectl  set-hostname kubernetes-node4"</span>
</code></pre> 
<pre><code class="prism language-powershell">node节点 内核参数调整
<span class="token operator">/</span>bin/bash <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>scripts/02_kubernetes_kernel_conf<span class="token punctuation">.</span>sh
</code></pre> 
<p>软件源配置</p> 
<pre><code class="prism language-powershell">更新软件源
curl <span class="token operator">-</span>s https:<span class="token operator">/</span><span class="token operator">/</span>mirrors<span class="token punctuation">.</span>aliyun<span class="token punctuation">.</span>com/kubernetes/apt/doc/apt-key<span class="token punctuation">.</span>gpg <span class="token punctuation">|</span> sudo apt-key add <span class="token operator">-</span>
<span class="token function">echo</span> <span class="token string">"deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main"</span> <span class="token punctuation">|</span> sudo <span class="token function">tee</span> <span class="token operator">/</span>etc/apt/sources<span class="token punctuation">.</span>list<span class="token punctuation">.</span>d/kubernetes<span class="token punctuation">.</span>list
apt update
</code></pre> 
<p>添加节点</p> 
<pre><code class="prism language-powershell">master节点获取集群信息
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># kubeadm token list | awk '{print $1,$2}'</span>
TOKEN TTL
abcdef<span class="token punctuation">.</span>0123456789abcdef 27y
<span class="token namespace">[root@kubernetes-master1 ~]</span><span class="token comment"># openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'</span>
2e32fbe869258151ac547ec1649af9a60d79a6080d822923bf20cf3cb6a581ce
</code></pre> 
<pre><code class="prism language-powershell">node节点安装软件
apt-get install <span class="token operator">-</span>y kubelet=1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>4-00 kubeadm=1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>4-00

node加入集群
kubeadm join 10<span class="token punctuation">.</span>0<span class="token punctuation">.</span>0<span class="token punctuation">.</span>200:6443 <span class="token operator">--</span>token abcdef<span class="token punctuation">.</span>0123456789abcdef <span class="token operator">--</span>discovery-token-ca-cert-hash sha256:2e32fbe869258151ac547ec1649af9a60d79a6080d822923bf20cf3cb6a581ce <span class="token operator">--</span>cri-socket unix:<span class="token operator">/</span><span class="token operator">/</span><span class="token operator">/</span>run/containerd/containerd<span class="token punctuation">.</span>sock
</code></pre> 
<pre><code class="prism language-powershell">测试效果
<span class="token namespace">[root@kubernetes-master1 /data/scripts]</span><span class="token comment"># kubectl get nodes | grep node4</span>
kubernetes-node4     Ready      &lt;none&gt;          26s   v1<span class="token punctuation">.</span>24<span class="token punctuation">.</span>4
</code></pre> 
<p>k8s支持gVisor</p> 
<pre><code class="prism language-powershell">在node4上，修改文件，让kubelet也能使用gVisor<span class="token punctuation">(</span>runsc<span class="token punctuation">)</span>
<span class="token function">cat</span> &gt; <span class="token operator">/</span>etc/systemd/system/kubelet<span class="token punctuation">.</span>service<span class="token punctuation">.</span>d/0-cri-containerd<span class="token punctuation">.</span>conf &lt;&lt;EOF
<span class="token namespace">[Service]</span>
Environment=<span class="token string">"KUBELET_EXTRA_ARGS=--container-runtime=remote --runtime-request-timeout=15m
--container-runtime-endpoint=unix:///run/containerd/containerd.sock"</span>
EOF

重启kubelet服务，让配置生效
systemctl daemon-reload <span class="token punctuation">;</span> systemctl restart kubelet<span class="token punctuation">.</span>service
</code></pre> 
<p><strong>简单实践</strong></p> 
<p>准备工作</p> 
<pre><code class="prism language-powershell">mkdir <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/gvisor/
cd <span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>kubernetes/gvisor/
</code></pre> 
<pre><code class="prism language-powershell">创建资源清单文件  01-superopsmsb-runtimeclass<span class="token punctuation">.</span>yaml
apiVersion: node<span class="token punctuation">.</span>k8s<span class="token punctuation">.</span>io/v1  
kind: RuntimeClass
metadata:
  name: superopsmsb-runtimeclass  
handler: runsc 
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 01-superopsmsb-runtimeclass<span class="token punctuation">.</span>yaml

检查效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/gvisor]</span><span class="token comment"># kubectl get runtimeclasses.node.k8s.io</span>
NAME                       HANDLER   AGE
superopsmsb-runtimeclass   runsc     63s
</code></pre> 
<p>pod测试</p> 
<pre><code class="prism language-powershell">创建资源清单文件  02-superopsmsb-runtimeclass-podtest<span class="token punctuation">.</span>yaml
apiVersion: v1
kind: Pod
metadata:
  name: superopsmsb-podtest
spec:
  runtimeClassName: superopsmsb-runtimeclass
  nodeName: kubernetes-node4
  containers:
  <span class="token operator">-</span> image: kubernetes-register<span class="token punctuation">.</span>superopsmsb<span class="token punctuation">.</span>com/superopsmsb/nginx_web:v0<span class="token punctuation">.</span>1
    imagePullPolicy: IfNotPresent
    name: nginxweb
    resources: <span class="token punctuation">{<!-- --></span><span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-powershell">应用资源清单文件
kubectl apply <span class="token operator">-</span>f 02-superopsmsb-runtimeclass-podtest<span class="token punctuation">.</span>yaml

查看效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/gvisor]</span><span class="token comment"># kubectl get pod  -o wide</span>
NAME                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   STATUS    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  NODE               <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
superopsmsb-podtest <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>   Running   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>  kubernetes-node4   <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

检查进程
root@kubernetes-node4:~<span class="token comment"># ps aux | grep podtest</span>
结果显示：
	容器应用被应用在沙箱里面了
</code></pre> 
<pre><code class="prism language-powershell">确认容器的运行效果
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/gvisor]</span><span class="token comment"># kubectl exec superopsmsb-podtest -- dmesg</span>
<span class="token punctuation">[</span>    0<span class="token punctuation">.</span>000000<span class="token punctuation">]</span> Starting gVisor<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">[</span>    3<span class="token punctuation">.</span>223390<span class="token punctuation">]</span> Ready!
</code></pre> 
<pre><code class="prism language-powershell">查看pod容器的标识
<span class="token namespace">[root@kubernetes-master1 /data/kubernetes/gvisor]</span><span class="token comment"># kubectl describe pod superopsmsb-podtest | grep containerd</span>
    Container ID:   containerd:<span class="token operator">/</span><span class="token operator">/</span>edfe3cfd5746fe82e90c83d37f7c9f28b1f0aaebf7611f13cdd1e6754599b915
</code></pre> 
<pre><code class="prism language-powershell">查看gVisor的效果
root@kubernetes-node4:~<span class="token comment"># ps aux | grep runsc | grep edfe3cfd5746fe82e90c</span>
root       91118  0<span class="token punctuation">.</span>0  0<span class="token punctuation">.</span>4 754200 18784 ?        <span class="token function">Sl</span>   10:27   0:00 runsc-gofer <span class="token operator">--</span>root=<span class="token operator">/</span>run/containerd/runsc/k8s<span class="token punctuation">.</span>io <span class="token operator">--</span>log=<span class="token operator">/</span>run/containerd/io<span class="token punctuation">.</span>containerd<span class="token punctuation">.</span>runtime<span class="token punctuation">.</span>v2<span class="token punctuation">.</span>task/k8s<span class="token punctuation">.</span>io/edfe3cfd5746fe82e90c83d37f7c9f28b1f0aaebf7611f13cdd1e6754599b915/log<span class="token punctuation">.</span>json <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
结果显示：
	pod已经通过runsc以沙箱的形式运行了
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b83d6c2b8bb1acc4b3c27d0a975e2456/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">【MySQL 】MySQL 创建数据库， MySQL 删除数据库，MySQL 选择数据库</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/69f8f0d35dec77dc3f3cf3816814ba77/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">K8S应用流程安全（镜像安全 配置管理 访问安全）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>