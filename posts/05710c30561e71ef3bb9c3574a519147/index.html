<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zookeeper安装教程及其基本使用 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zookeeper安装教程及其基本使用" />
<meta property="og:description" content="目录
zookeeper下载：
zookeeper下载官网：
本地安装配置：
启动zookeeper：
开启服务端：
启动客户端：
查看zookeeper的状态：
zoo.cfg文件解读：
zookeeper的集群安装：
报错分析：
选举机制---第一次启动：
部分概念：
选举机制---非第一次启动：
ZK集群的启动与停止脚本：
客户端命令行操作：
参数分析： 节点类型（持久/短暂/有序号/无序号）：
监听器原理：
监听原理详解：
节点的值变化监听：
节点的子节点变化监听（路径变化）:
节点删除与查看:
zookeeper下载： zookeeper下载官网： https://zookeeper.apache.org/ 点击上述，下载3.5.7版本 本地安装配置： 下载到win机上，上传到linux上，再进行解压，修改配置文件（配置文件在conf目录下）
先修改zoo文件的名称：zoo_sample.cfg 修改为 zoo.cfg（sample是模板的意思）
进入zoo.cfg文件进行配置
需要修改dataDir的路径
在zookeeper的目录下自己创建一个目录作为zookeeper的数据与事务日志的存储目录
保存退出
启动zookeeper： 进入zookeeper的bin目录下可以找到下边两个脚本便是启动脚本文件（一个客户端，一个服务端，先启动服务端再启动客户端）
开启服务端： bin/zkServer.sh start 启动客户端： 与服务端不一样，不需要start
进入后：
查看zookeeper的状态： bin/zkServer.sh status zoo.cfg文件解读： tickTime=2000：
通信心跳时间，Zookeeper服务器与客户端心跳时间，单位毫秒
initLimit=10（首次连接时限）：
Leader和Follower初始连接时能容忍的最多心跳数（tickTime的数量）
syncLimit=5（非首次连接时限）：
Leader和Follower之间通信时间如果超过syncLimit * tickTime，Leader认为Follwer死掉，从服务器列表中删除Follwer。
clientPort=2181
客户端连接端口，通常不做修改。
dataDir=/opt/module/zookeeper-3.5.7/zkData
保存Zookeeper中的数据，一般默认temp,默认的目录容易被Linux定期删除
zookeeper的集群安装： 在上边我们已经安装好了本地模式，集群模式只需要我们修改一些配置进行分发到集群的其他服务器上即可。
（1）zkData 目录下创建一个 myid 的文件在文件中添加与 server 对应的编号（相当于唯一标识符）（注意：上下不要有空行，左右不要有空格）
（2）将配置好的文件进行分发" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/05710c30561e71ef3bb9c3574a519147/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-04T22:56:45+08:00" />
<meta property="article:modified_time" content="2023-08-04T22:56:45+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zookeeper安装教程及其基本使用</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p><img alt="" height="415" src="https://images2.imgbox.com/12/68/790zgBlq_o.png" width="728"></p> 
<p id="main-toc"><strong>目录</strong></p> 
<p id="zookeeper%E4%B8%8B%E8%BD%BD%EF%BC%9A-toc" style="margin-left:0px;"><a href="#zookeeper%E4%B8%8B%E8%BD%BD%EF%BC%9A" rel="nofollow">zookeeper下载：</a></p> 
<p id="zookeeper%E4%B8%8B%E8%BD%BD%E5%AE%98%E7%BD%91%EF%BC%9A-toc" style="margin-left:40px;"><a href="#zookeeper%E4%B8%8B%E8%BD%BD%E5%AE%98%E7%BD%91%EF%BC%9A" rel="nofollow">zookeeper下载官网：</a></p> 
<p id="%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%EF%BC%9A" rel="nofollow">本地安装配置：</a></p> 
<p id="%E5%90%AF%E5%8A%A8zookeeper%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E5%90%AF%E5%8A%A8zookeeper%EF%BC%9A" rel="nofollow">启动zookeeper：</a></p> 
<p id="%C2%A0%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%C2%A0%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%9A" rel="nofollow"> 开启服务端：</a></p> 
<p id="%E5%90%AF%E5%8A%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E5%90%AF%E5%8A%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A" rel="nofollow">启动客户端：</a></p> 
<p id="%E6%9F%A5%E7%9C%8Bzookeeper%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E6%9F%A5%E7%9C%8Bzookeeper%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%9A" rel="nofollow">查看zookeeper的状态：</a></p> 
<p id="zoo.cfg%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB%EF%BC%9A-toc" style="margin-left:80px;"><a href="#zoo.cfg%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB%EF%BC%9A" rel="nofollow">zoo.cfg文件解读：</a></p> 
<p id="zookeeper%E7%9A%84%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%EF%BC%9A-toc" style="margin-left:40px;"><a href="#zookeeper%E7%9A%84%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%EF%BC%9A" rel="nofollow">zookeeper的集群安装：</a></p> 
<p id="%E6%8A%A5%E9%94%99%E5%88%86%E6%9E%90%EF%BC%9A-toc" style="margin-left:80px;"><a href="#%E6%8A%A5%E9%94%99%E5%88%86%E6%9E%90%EF%BC%9A" rel="nofollow">报错分析：</a></p> 
<p id="%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6---%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6---%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A" rel="nofollow">选举机制---第一次启动：</a></p> 
<p id="%E9%83%A8%E5%88%86%E6%A6%82%E5%BF%B5%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E9%83%A8%E5%88%86%E6%A6%82%E5%BF%B5%EF%BC%9A" rel="nofollow">部分概念：</a></p> 
<p id="%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6---%E9%9D%9E%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6---%E9%9D%9E%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A" rel="nofollow">选举机制---非第一次启动：</a></p> 
<p id="ZK%E9%9B%86%E7%BE%A4%E7%9A%84%E5%90%AF%E5%8A%A8%E4%B8%8E%E5%81%9C%E6%AD%A2%E8%84%9A%E6%9C%AC%EF%BC%9A-toc" style="margin-left:0px;"><a href="#ZK%E9%9B%86%E7%BE%A4%E7%9A%84%E5%90%AF%E5%8A%A8%E4%B8%8E%E5%81%9C%E6%AD%A2%E8%84%9A%E6%9C%AC%EF%BC%9A" rel="nofollow">ZK集群的启动与停止脚本：</a></p> 
<p id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C%EF%BC%9A" rel="nofollow">客户端命令行操作：</a></p> 
<p id="%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90%EF%BC%9A%C2%A0-toc" style="margin-left:40px;"><a href="#%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90%EF%BC%9A%C2%A0" rel="nofollow">参数分析： </a></p> 
<p id="%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B%EF%BC%88%E6%8C%81%E4%B9%85%2F%E7%9F%AD%E6%9A%82%2F%E6%9C%89%E5%BA%8F%E5%8F%B7%2F%E6%97%A0%E5%BA%8F%E5%8F%B7%EF%BC%89%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B%EF%BC%88%E6%8C%81%E4%B9%85%2F%E7%9F%AD%E6%9A%82%2F%E6%9C%89%E5%BA%8F%E5%8F%B7%2F%E6%97%A0%E5%BA%8F%E5%8F%B7%EF%BC%89%EF%BC%9A" rel="nofollow">节点类型（持久/短暂/有序号/无序号）：</a></p> 
<p id="%E7%9B%91%E5%90%AC%E5%99%A8%E5%8E%9F%E7%90%86%EF%BC%9A-toc" style="margin-left:0px;"><a href="#%E7%9B%91%E5%90%AC%E5%99%A8%E5%8E%9F%E7%90%86%EF%BC%9A" rel="nofollow">监听器原理：</a></p> 
<p id="%E7%9B%91%E5%90%AC%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%E7%9B%91%E5%90%AC%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%EF%BC%9A" rel="nofollow">监听原理详解：</a></p> 
<p id="%C2%A0%E8%8A%82%E7%82%B9%E7%9A%84%E5%80%BC%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%9A-toc" style="margin-left:40px;"><a href="#%C2%A0%E8%8A%82%E7%82%B9%E7%9A%84%E5%80%BC%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%9A" rel="nofollow"> 节点的值变化监听：</a></p> 
<p id="%E8%8A%82%E7%82%B9%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%88%E8%B7%AF%E5%BE%84%E5%8F%98%E5%8C%96%EF%BC%89%3A-toc" style="margin-left:40px;"><a href="#%E8%8A%82%E7%82%B9%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%88%E8%B7%AF%E5%BE%84%E5%8F%98%E5%8C%96%EF%BC%89%3A" rel="nofollow">节点的子节点变化监听（路径变化）:</a></p> 
<p id="%C2%A0%E8%8A%82%E7%82%B9%E5%88%A0%E9%99%A4%E4%B8%8E%E6%9F%A5%E7%9C%8B%3A-toc" style="margin-left:0px;"><a href="#%C2%A0%E8%8A%82%E7%82%B9%E5%88%A0%E9%99%A4%E4%B8%8E%E6%9F%A5%E7%9C%8B%3A" rel="nofollow"> 节点删除与查看:</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="zookeeper%E4%B8%8B%E8%BD%BD%EF%BC%9A">zookeeper下载：</h2> 
<h3 id="zookeeper%E4%B8%8B%E8%BD%BD%E5%AE%98%E7%BD%91%EF%BC%9A">zookeeper下载官网：</h3> 
<pre><code>https://zookeeper.apache.org/</code></pre> 
<p><img alt="" height="260" src="https://images2.imgbox.com/9c/25/5sy1JAM7_o.png" width="1200"></p> 
<p><img alt="" height="470" src="https://images2.imgbox.com/16/f2/QBlqDtXD_o.png" width="1017"></p> 
<p>点击上述，下载3.5.7版本 </p> 
<h3 id="%E6%9C%AC%E5%9C%B0%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%EF%BC%9A">本地安装配置：</h3> 
<p>下载到win机上，上传到linux上，再进行解压，修改配置文件（配置文件在conf目录下）</p> 
<p>先修改zoo文件的名称：zoo_sample.cfg 修改为 zoo.cfg（sample是模板的意思）</p> 
<p>进入zoo.cfg文件进行配置</p> 
<p>需要修改dataDir的路径</p> 
<p>在zookeeper的目录下自己创建一个目录作为zookeeper的数据与事务日志的存储目录</p> 
<p><img alt="" height="283" src="https://images2.imgbox.com/15/44/IWLWOYZn_o.png" width="708"></p> 
<p>保存退出</p> 
<h3 id="%E5%90%AF%E5%8A%A8zookeeper%EF%BC%9A">启动zookeeper：</h3> 
<p>进入zookeeper的bin目录下可以找到下边两个脚本便是启动脚本文件（一个客户端，一个服务端，先启动服务端再启动客户端）</p> 
<p><img alt="" height="114" src="https://images2.imgbox.com/69/8f/ZVlu2AN6_o.png" width="828"></p> 
<h4 id="%C2%A0%E5%BC%80%E5%90%AF%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%9A"> 开启服务端：</h4> 
<pre><code class="language-bash">bin/zkServer.sh start
</code></pre> 
<p> <img alt="" height="74" src="https://images2.imgbox.com/a0/5c/MGPUCDhi_o.png" width="476"></p> 
<h4 id="%E5%90%AF%E5%8A%A8%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%9A">启动客户端：</h4> 
<p>与服务端不一样，不需要start</p> 
<p><img alt="" height="118" src="https://images2.imgbox.com/6c/c3/X5wsQVkc_o.png" width="701"> 进入后：</p> 
<p><img alt="" height="282" src="https://images2.imgbox.com/f8/53/jqsHjt4Y_o.png" width="719"></p> 
<h4 id="%E6%9F%A5%E7%9C%8Bzookeeper%E7%9A%84%E7%8A%B6%E6%80%81%EF%BC%9A">查看zookeeper的状态：</h4> 
<pre><code class="language-bash">bin/zkServer.sh status
</code></pre> 
<p> <img alt="" height="122" src="https://images2.imgbox.com/d7/19/wIxsTNJz_o.png" width="635"></p> 
<h4 id="zoo.cfg%E6%96%87%E4%BB%B6%E8%A7%A3%E8%AF%BB%EF%BC%9A">zoo.cfg文件解读：</h4> 
<p>tickTime=2000：</p> 
<p>通信心跳时间，Zookeeper服务器与客户端心跳时间，单位毫秒</p> 
<p>initLimit=10（首次连接时限）：</p> 
<p>Leader和Follower<strong>初始连接</strong>时能容忍的最多心跳数（tickTime的数量）</p> 
<p>syncLimit=5（非首次连接时限）：</p> 
<p>Leader和Follower之间通信时间如果超过syncLimit * tickTime，Leader认为Follwer死掉，从服务器列表中删除Follwer。</p> 
<p>clientPort=2181<br> 客户端连接端口，通常不做修改。</p> 
<p>dataDir=/opt/module/zookeeper-3.5.7/zkData<br> 保存Zookeeper中的数据，一般默认temp,默认的目录容易被Linux定期删除</p> 
<h3 id="zookeeper%E7%9A%84%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85%EF%BC%9A">zookeeper的集群安装：</h3> 
<p>在上边我们已经安装好了本地模式，集群模式只需要我们修改一些配置进行分发到集群的其他服务器上即可。</p> 
<p>（1）zkData 目录下创建一个 myid 的文件在文件中添加与 server 对应的编号（相当于唯一标识符）（注意：上下不要有空行，左右不要有空格）</p> 
<p>（2）将配置好的文件进行分发</p> 
<pre><code>xsync zookeeper-3.5.7 
</code></pre> 
<p>（3）修改配置，分发到集群的其他服务器上后需要修改zkData 目录下的myid 的文件修改为自己的唯一标识符</p> 
<p>  (4) 修改zoo.cfg文件：</p> 
<p>因为我们在本地模式的时候已经修改了部分配置文件，我们从本地模式转变成集群模式需要在zoo.fg文件下添加配置：</p> 
<pre><code>#######################cluster########################## 
server.2=hadoop102:2888:3888 
server.3=hadoop103:2888:3888 
server.4=hadoop104:2888:3888 
</code></pre> 
<p>参数格式：</p> 
<pre><code>server.A=B:C:D</code></pre> 
<p>A 是一个数字，表示这个是第几号服务器；</p> 
<p>集群模式下配置一个文件 myid，这个文件在 dataDir 目录下，这个文件里面有一个数据 就是 A 的值，Zookeeper 启动时读取此文件，拿到里面的数据与 zoo.cfg 里面的配置信息比 较从而判断到底是哪个 server。</p> 
<p>B 是这个服务器的地址；</p> 
<p>C 是这个服务器 Follower 与集群中的 Leader 服务器交换信息的端口；</p> 
<p>D 是万一集群中的 Leader 服务器挂了，需要一个端口来重新进行选举，选出一个新的</p> 
<p>Leader，而这个端口就是用来执行选举时服务器相互通信的端口</p> 
<p>再次分发文件</p> 
<p>启动zookeeper（没有成功）</p> 
<h4 id="%E6%8A%A5%E9%94%99%E5%88%86%E6%9E%90%EF%BC%9A">报错分析：</h4> 
<p>这里我一直启动不了，因为我以前运行过本地模式，当时怀疑是存储的日志问腿，就去zkdata文件夹下删除了version-2 文件夹重启还是不能启动zookeeper，有去看了配置文件zoo.cfg，后来发现是上边新加的配置信息后边结尾带空格了，删除之后重启，启动zookeeper成功</p> 
<h2 id="%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6---%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A">选举机制---第一次启动：</h2> 
<p>本机制是在5台服务器的前提下进行的</p> 
<p>（1）服务器1启动，发起一次选举。服务器1投自己一票。此时服务器1票数一票，不够半数以上（3票），选举无法完成，服务器1状态保持为LOOKING；<br> （2）服务器2启动，再发起一次选举。服务器1和2分别投自己一票并交换选票信息：此时服务器1发现服务器2的myid比自己目前投票推举的（服务器1）大，更改选票为推举服务器2。此时服务器1票数为0票，服务器2票数为2票，没有半数以上结果，无法选举出leader，服务器1，2状态保持LOOKING</p> 
<p>（3）服务器3启动，发起一次选举。此时服务器1和2都会更改选票为服务器3。此次投票结果：服务器1为0票，服务器2为0票，服务器3为3票。此时服务器3的票数已经超过半数，服务器3当选Leader。服务器1，2更改状态为FOLLOWING，服务器3更改状态为LEADING；</p> 
<p>（4）服务器4启动，发起一次选举。此时服务器1，2，3已经不是LOOKING状态,进入follow状态，不会更改选票信息。交换选票信息结果：服务器3为3票，服务器4为1票。此时服务器4服从多数，更改选票信息为服务器3，并更改状态为FOLLOWING；<br> （5）服务器5启动，同4一样当小弟。</p> 
<p>总结：选举机制是一般都会先选举自己，发现不过半，则会转换自己的投票，转投myid比自己大的。当有服务器选票过半数后，则会选举出leader。后边的服务器就会进行比票，但是已经确定的leader与follow不会再进行改选。</p> 
<h3 id="%E9%83%A8%E5%88%86%E6%A6%82%E5%BF%B5%EF%BC%9A">部分概念：</h3> 
<p>SID：服务器ID。用来唯一标识一台ZooKeeper集群中的机器，每台机器不能重复，和myid一致。</p> 
<p>ZXID：（客户端每次执行写操作都有事务id）事务ID。ZXID是一个事务ID，用来标识一次服务器状态的变更。在某一时刻， 集群中的每台机器的ZXID值不一定完全一 致，这和ZooKeeper服务器对于客户端“更 新请求”的处理逻辑有关。</p> 
<p>Epoch：每个Leader任期的代号。没有</p> 
<p>Leader时同一轮投票过程中的逻辑时钟值是 相同的。每投完一次票这个数据就会增加</p> 
<h2 id="%E9%80%89%E4%B8%BE%E6%9C%BA%E5%88%B6---%E9%9D%9E%E7%AC%AC%E4%B8%80%E6%AC%A1%E5%90%AF%E5%8A%A8%EF%BC%9A">选举机制---非第一次启动：</h2> 
<p>（1）当ZooKeeper集群中的一台服务器出现以下两种情况之一时，就会开始进入Leader选举：</p> 
<p>服务器初始化启动。</p> 
<p>• 服务器运行期间无法和Leader保持连接。 （2）而当一台机器进入Leader选举流程时，当前集群也可能会处于以下两种状态：</p> 
<p>• 集群中本来就已经存在一个Leader。 对于第一种已经存在Leader的情况，机器试图去选举Leader时，会被告知当前服务器的Leader信息，对于该机器来说，仅仅需要和Leader机器建立连 接，并进行状态同步即可。</p> 
<p>• 集群中确实不存在Leader。</p> 
<p>假设ZooKeeper由5台服务器组成，SID分别为1、2、3、4、5，ZXID分别为8、8、8、7、7，并且此时SID为3的服务器是Leader。某一时刻，3和5服务器出现故障，因此开始进行Leader选举。 SID为1、2、4的机器投票情况（分别为EPOCH，ZXID，SID ）： （1，8，1） （1，8，2） （1，7，4） </p> 
<p>选举Leader规则： ①EPOCH大的直接胜出 ②EPOCH相同，（ZXID）事务id大的胜出</p> 
<p>③（ZXID）事务id相同，(SID)服务器id大的胜出</p> 
<h2 id="ZK%E9%9B%86%E7%BE%A4%E7%9A%84%E5%90%AF%E5%8A%A8%E4%B8%8E%E5%81%9C%E6%AD%A2%E8%84%9A%E6%9C%AC%EF%BC%9A">ZK集群的启动与停止脚本：</h2> 
<p>注：start/stop/status不要换行，会让脚本失效，显示找不到</p> 
<pre><code class="language-bash">#!/bin/bash 
 
case $1 in 
"start"){ 
 for i in hadoop102 hadoop103 hadoop104 
 do 
 echo ---------- zookeeper $i 启动 ------------ 
 ssh $i "/opt/module/zookeeper-3.5.7/bin/zkServer.sh start" 
 done 
};; 
"stop"){ 
 for i in hadoop102 hadoop103 hadoop104 
 do 
 echo ---------- zookeeper $i 停止 ------------ 
 ssh $i "/opt/module/zookeeper-3.5.7/bin/zkServer.sh stop" 
 done 
};; 
"status"){ 
 for i in hadoop102 hadoop103 hadoop104 
 do 
 echo ---------- zookeeper $i 状态 ------------ 
 ssh $i "/opt/module/zookeeper-3.5.7/bin/zkServer.sh status" 
 done 
};; 
esac</code></pre> 
<h2 id="%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%93%8D%E4%BD%9C%EF%BC%9A">客户端命令行操作：</h2> 
<p>启动特定服务器的客户端：</p> 
<pre><code class="language-bash"> bin/zkCli.sh -server hadoop102:2181
</code></pre> 
<p>查看节点信息：<br>  </p> 
<pre><code class="language-bash">ls -s /</code></pre> 
<p><img alt="" height="231" src="https://images2.imgbox.com/2e/36/TFsrtX3Z_o.png" width="521"></p> 
<h3 id="%E5%8F%82%E6%95%B0%E5%88%86%E6%9E%90%EF%BC%9A%C2%A0">参数分析： </h3> 
<p>（1）czxid：创建节点的事务 zxid</p> 
<p>每次修改 ZooKeeper 状态都会产生一个 ZooKeeper 事务 ID。事务 ID 是 ZooKeeper 中所 有修改总的次序。每次修改都有唯一的 zxid，如果 zxid1 小于 zxid2，那么 zxid1 在 zxid2 之 前发生。</p> 
<p>（2）ctime：znode 被创建的毫秒数（从 1970 年开始）</p> 
<p>（3）mzxid：znode 最后更新的事务 zxid</p> 
<p>（4）mtime：znode 最后修改的毫秒数（从 1970 年开始）</p> 
<p>（5）pZxid：znode 最后更新的子节点 zxid</p> 
<p>（6）cversion：znode 子节点变化号，znode 子节点修改次数</p> 
<p>（7）dataversion：znode 数据变化号</p> 
<p>（8）aclVersion：znode 访问控制列表的变化号</p> 
<p>（9）ephemeralOwner：如果是临时节点，这个是 znode 拥有者的 session id。如果不是 临时节点则是 0。</p> 
<p>（10）dataLength：znode 的数据长度</p> 
<p>（11）numChildren：znode 子节点数量</p> 
<h2 id="%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B%EF%BC%88%E6%8C%81%E4%B9%85%2F%E7%9F%AD%E6%9A%82%2F%E6%9C%89%E5%BA%8F%E5%8F%B7%2F%E6%97%A0%E5%BA%8F%E5%8F%B7%EF%BC%89%EF%BC%9A">节点类型（持久/短暂/有序号/无序号）：</h2> 
<p>持久（Persistent）：客户端和服务器端断开连接后，创建的节点不删除</p> 
<p>短暂（Ephemeral）：客户端和服务器端断开连接后，创建的节点自己删除</p> 
<p>持久化顺序编号目录节点：</p> 
<p>客户端与Zookeeper断开连接后，该节点依旧存在，只是Zookeeper给该节点名称进行顺序编号</p> 
<p>3）临时目录节点</p> 
<p>客户端与Zookeeper断开连接后，该节点被删除</p> 
<p>4）临时顺序编号目录节点</p> 
<p>客户端与Zookeeper断开连接后，该节点被删除，只是Zookeeper给该节点名称进行顺序编号</p> 
<p>（被删除后，会从该节点进行递增编号）</p> 
<p>示例：</p> 
<pre><code class="language-sql">create /sanguo "diaochan" </code></pre> 
<p>在你创建节点的时候必须代值</p> 
<pre><code class="language-sql">create /sanguo/shuguo "liubei" </code></pre> 
<p>不要依/结尾</p> 
<pre><code class="language-sql">ls /sanguo</code></pre> 
<p>上述代码“ls”只能查看当前节点是否有子节点，不能查看节点的值</p> 
<pre><code class="language-sql">get -s /sanguo</code></pre> 
<p>上述命令可以查看节点的值</p> 
<p><img alt="" height="251" src="https://images2.imgbox.com/2e/3f/ZElEU1Mx_o.png" width="488"></p> 
<p>上述创建的为不带序号的永久节点</p> 
<p> 创建带序号的永久节点：</p> 
<pre><code class="language-sql">create -s /sanguo/weiguo/zhangliao "zhangliao"
</code></pre> 
<p> <img alt="" height="56" src="https://images2.imgbox.com/26/76/C3zUGrCQ_o.png" width="558"></p> 
<p> 可以看到节点zhangliao是带节点的</p> 
<p>带序号的情况下，我再次执行上边语句：</p> 
<p><img alt="" height="75" src="https://images2.imgbox.com/51/74/RG53naMW_o.png" width="727"></p> 
<p> 会显示创建了002号节点 ，但是如果我们创建的是不带序号的已经存在的永久节点，那么就会报错节点已经存在</p> 
<p>创建临时节点：</p> 
<p>创建临时节点是加上  -e</p> 
<pre><code class="language-sql">create -e /sanguo/wuguo "sunquan"
</code></pre> 
<p><img alt="" height="114" src="https://images2.imgbox.com/93/c7/oX0lyC1m_o.png" width="752"></p> 
<p>这个语句是创建的不带序号的临时节点</p> 
<p>下边我们再次创建带序号的临时节点：</p> 
<p>创建的还是吴国</p> 
<pre><code class="language-sql"> create -e -s /sanguo/wuguo "zhouyu"
</code></pre> 
<p><img alt="" height="105" src="https://images2.imgbox.com/46/94/DK0W17Rc_o.png" width="765"> </p> 
<p>断开客户端，查看临时节点是否还存在：</p> 
<p><img alt="" height="98" src="https://images2.imgbox.com/e3/04/tZzehtJd_o.png" width="609"> </p> 
<p> 修改节点的值：</p> 
<p><img alt="" height="300" src="https://images2.imgbox.com/30/c6/61uNuA2O_o.png" width="632"></p> 
<h2 id="%E7%9B%91%E5%90%AC%E5%99%A8%E5%8E%9F%E7%90%86%EF%BC%9A">监听器原理：</h2> 
<p>监听器主要是监听  监听节点数据的变化 （get path [watch]）与 监听子节点增减的变化（ls path [watch]）</p> 
<h3 id="%E7%9B%91%E5%90%AC%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3%EF%BC%9A">监听原理详解：</h3> 
<p>1）首先要有一个main()线程</p> 
<p>2）在main线程中创建Zookeeper客户端，这时就会创建两个线</p> 
<p>程，一个负责网络连接通信（connet），一个负责监听（listener）。</p> 
<p>3）通过connect线程将注册的监听事件发送给Zookeeper。</p> 
<p>4）在Zookeeper的注册监听器列表中将注册的监听事件添加到列表中。</p> 
<p>5）Zookeeper监听到有数据或路径变化，就会将这个消息发送给listener线程。</p> 
<p>6）listener线程内部调用了process()方法。</p> 
<p><img alt="" height="215" src="https://images2.imgbox.com/d2/90/1FEYh98j_o.png" width="837"></p> 
<h3 id="%C2%A0%E8%8A%82%E7%82%B9%E7%9A%84%E5%80%BC%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%9A"> 节点的值变化监听：</h3> 
<p>在开启103，104两台服务器的本地客户端</p> 
<p>在hadoop104主机上注册监听/sanguo节点数据变化：</p> 
<pre><code class="language-sql"> get -w /sanguo </code></pre> 
<p>在hadoop103主机上修改/sanguo节点的数据：</p> 
<pre><code class="language-sql">set /sanguo "xisi" </code></pre> 
<p>观察hadoop104主机收到数据变化的监听：</p> 
<p><img alt="" height="101" src="https://images2.imgbox.com/8c/99/to2idLel_o.png" width="716"></p> 
<p>但是，申请监听只能监听到一次它的修改,在hadoop103再多次修改/sanguo的值，hadoop104上不会再收到监听。因为注册一次，只能监听一次。想再次监听，需要再次注册。</p> 
<h3 id="%E8%8A%82%E7%82%B9%E7%9A%84%E5%AD%90%E8%8A%82%E7%82%B9%E5%8F%98%E5%8C%96%E7%9B%91%E5%90%AC%EF%BC%88%E8%B7%AF%E5%BE%84%E5%8F%98%E5%8C%96%EF%BC%89%3A">节点的子节点变化监听（路径变化）:</h3> 
<p>在hadoop104主机上注册监听/sanguo节点的子节点变化</p> 
<pre><code class="language-sql">ls -w /sanguo </code></pre> 
<p> 在hadoop103主机/sanguo节点上创建子节点</p> 
<pre><code class="language-sql">create /sanguo/jin "simayi"</code></pre> 
<p>观察hadoop104主机收到子节点变化的监听:</p> 
<p><img alt="" height="124" src="https://images2.imgbox.com/c0/b2/vovk5AGb_o.png" width="741"></p> 
<p>注意：节点的路径变化，也是注册一次，生效一次。想多次生效，就需要多次注册。</p> 
<h2 id="%C2%A0%E8%8A%82%E7%82%B9%E5%88%A0%E9%99%A4%E4%B8%8E%E6%9F%A5%E7%9C%8B%3A"> 节点删除与查看:</h2> 
<p>删除单个节点：</p> 
<pre><code class="language-sql">delete /sanguo/jin </code></pre> 
<p> 递归删除节点：</p> 
<pre><code class="language-sql">deleteall /sanguo/shuguo </code></pre> 
<p>查看节点状态：</p> 
<pre><code class="language-sql">stat /sanguo</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6dd8832b73c0d98b24f54b0ba87f7060/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43; 对象指针</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9e75d2c2f05bd86373944f064744ee67/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">STM32F0实现IAP升级固件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>