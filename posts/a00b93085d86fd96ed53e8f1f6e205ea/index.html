<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Exynos4412 移植Linux-6.1（八）LCD驱动，解决error: implicit declaration of function ‘dma_free_writecombine’的问题 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Exynos4412 移植Linux-6.1（八）LCD驱动，解决error: implicit declaration of function ‘dma_free_writecombine’的问题" />
<meta property="og:description" content="系列文章目录 Exynos4412 移植Linux-6.1（一）下载、配置、编译Linux-6.1
Exynos4412 移植Linux-6.1（二）SD卡驱动——解决无法挂载SD卡的根文件系统
Exynos4412 移植Linux-6.1（三）SD卡驱动——解决mmc0: Timeout waiting for hardware interrupt.
Exynos4412 移植Linux-6.1（四）NandFlash卡驱动
Exynos4412 移植Linux-6.1（五）DM9000网卡驱动
Exynos4412 移植Linux-6.1（六）【已解决】SROMC寄存器的数值不正确的问题
Exynos4412 移植Linux-6.1 (七)挂载Ramdisk文件系统，【已解决】Couldn’t find valid RAM disk image starting at 0
Exynos4412 移植Linux-6.1 (八)LCD驱动，解决error: implicit declaration of function ‘dma_free_writecombine’的问题
Exynos4412 移植Linux-6.1（八）LCD驱动，解决error: implicit declaration of function ‘dma_alloc_writecombine’的问题 系列文章目录0、问题描述1、问题解决的经过（1）修改函数名（2）修改形参 2、编译结果 0、问题描述 有些博主分享了友善之臂tiny4412（Exynos4412）LCD的驱动，如下2位博主：
设备树学习之（十二）LCD驱动
Exynos4412——LCD驱动_lcd_probe
但是，移植的内核版本是Linux-4.x。我要移植的内核版本是Linux-6.1，交叉编译的时候会报错：lcd_drv.c:325:5: error: implicit declaration of function ‘dma_alloc_writecombine’; 出错的原因是内核中没有dma_alloc_writecombine()函数。
1、问题解决的经过 在Linux6.1的内核文件中确实是找不到dma_free_writecombine()函数。但是在Linux4.4的内核文件中可以找到。这个函数是在/include/linux/dma-mapping.h中声明的。
在Linux6.1的内核文件中打开/include/linux/dma-mapping.h，通过搜索关键字alloc，可以找到dma_alloc_wc()函数的声明。当发现这个的时候，我太高兴了！
（1）修改函数名 只需要把dma_alloc_writecombine()替换成dma_alloc_wc()。
（2）修改形参 dma_alloc_writecombine()与dma_alloc_wc()的第一个参数不一样。dma_alloc_wc()的第一个参数是struct device *dev，所以还需要做一些修改。定义结构体变量dev，然后修改dma_alloc_wc()的第一个参数为dev。如下：
struct device *dev = &amp;pdev-&gt;dev; …… tiny4412_lcd-&gt;screen_base = dma_alloc_wc(dev, tiny4412_lcd-&gt;fix." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/a00b93085d86fd96ed53e8f1f6e205ea/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-22T09:42:35+08:00" />
<meta property="article:modified_time" content="2023-12-22T09:42:35+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Exynos4412 移植Linux-6.1（八）LCD驱动，解决error: implicit declaration of function ‘dma_free_writecombine’的问题</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>系列文章目录</h2> 
<ul><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128569616">Exynos4412 移植Linux-6.1（一）下载、配置、编译Linux-6.1</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128624534">Exynos4412 移植Linux-6.1（二）SD卡驱动——解决无法挂载SD卡的根文件系统</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128702851">Exynos4412 移植Linux-6.1（三）SD卡驱动——解决mmc0: Timeout waiting for hardware interrupt.</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128632393">Exynos4412 移植Linux-6.1（四）NandFlash卡驱动</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128702911">Exynos4412 移植Linux-6.1（五）DM9000网卡驱动</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128748176">Exynos4412 移植Linux-6.1（六）【已解决】SROMC寄存器的数值不正确的问题</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/128772184">Exynos4412 移植Linux-6.1 (七)挂载Ramdisk文件系统，【已解决】Couldn’t find valid RAM disk image starting at 0</a></p> </li><li> <p><a href="https://blog.csdn.net/weixin_42408707/article/details/134984975">Exynos4412 移植Linux-6.1 (八)LCD驱动，解决error: implicit declaration of function ‘dma_free_writecombine’的问题</a></p> </li></ul> 
<hr> 
<p></p> 
<div class="toc"> 
 <h4>Exynos4412 移植Linux-6.1（八）LCD驱动，解决error: implicit declaration of function ‘dma_alloc_writecombine’的问题</h4> 
 <ul><li><a href="#_0" rel="nofollow">系列文章目录</a></li><li><a href="#0_18" rel="nofollow">0、问题描述</a></li><li><a href="#1_28" rel="nofollow">1、问题解决的经过</a></li><li><ul><li><a href="#1_31" rel="nofollow">（1）修改函数名</a></li><li><a href="#2_33" rel="nofollow">（2）修改形参</a></li></ul> 
  </li><li><a href="#2_45" rel="nofollow">2、编译结果</a></li></ul> 
</div> 
<p></p> 
<h2><a id="0_18"></a>0、问题描述</h2> 
<p>有些博主分享了友善之臂tiny4412（Exynos4412）LCD的驱动，如下2位博主：</p> 
<ul><li> <p><a href="https://blog.csdn.net/lizuobin2/article/details/54743381">设备树学习之（十二）LCD驱动</a></p> </li><li> <p><a href="https://blog.csdn.net/hceng_linux/article/details/89873988">Exynos4412——LCD驱动_lcd_probe</a></p> </li></ul> 
<p>但是，移植的内核版本是Linux-4.x。我要移植的内核版本是Linux-6.1，交叉编译的时候会报错：<code>lcd_drv.c:325:5: error: implicit declaration of function ‘dma_alloc_writecombine’; </code><br> 出错的原因是内核中没有dma_alloc_writecombine()函数。</p> 
<h2><a id="1_28"></a>1、问题解决的经过</h2> 
<p>在Linux6.1的内核文件中确实是找不到dma_free_writecombine()函数。但是在Linux4.4的内核文件中可以找到。这个函数是在/include/linux/dma-mapping.h中声明的。<br> 在Linux6.1的内核文件中打开/include/linux/dma-mapping.h，通过搜索关键字alloc，可以找到dma_alloc_wc()函数的声明。当发现这个的时候，我太高兴了！</p> 
<h3><a id="1_31"></a>（1）修改函数名</h3> 
<p>只需要把<code>dma_alloc_writecombine()</code>替换成<code>dma_alloc_wc()</code>。</p> 
<h3><a id="2_33"></a>（2）修改形参</h3> 
<p>dma_alloc_writecombine()与dma_alloc_wc()的第一个参数不一样。dma_alloc_wc()的第一个参数是<code>struct device *dev</code>，所以还需要做一些修改。定义结构体变量dev，然后修改dma_alloc_wc()的第一个参数为dev。如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">struct</span> <span class="token class-name">device</span> <span class="token operator">*</span>dev <span class="token operator">=</span> <span class="token operator">&amp;</span>pdev<span class="token operator">-&gt;</span>dev<span class="token punctuation">;</span>
……
tiny4412_lcd<span class="token operator">-&gt;</span>screen_base <span class="token operator">=</span> <span class="token function">dma_alloc_wc</span><span class="token punctuation">(</span>dev<span class="token punctuation">,</span> tiny4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_len<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">dma_addr_t</span> <span class="token operator">*</span><span class="token punctuation">)</span><span class="token operator">&amp;</span>tiny4412_lcd<span class="token operator">-&gt;</span>fix<span class="token punctuation">.</span>smem_start<span class="token punctuation">,</span> GFP_KERNEL<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>同样，可以解决<code>lcd_drv.c:344:5: error: implicit declaration of function ‘dma_free_writecombine’; </code>的问题。</p> 
<h2><a id="2_45"></a>2、编译结果</h2> 
<pre><code class="prism language-shell">lighthouse@VM-4-13-ubuntu:~/02_lcd_drv$ <span class="token function">make</span>
<span class="token function">make</span> <span class="token parameter variable">-C</span> /home/lighthouse/linux-6.1/ <span class="token assign-left variable">M</span><span class="token operator">=</span>/home/lighthouse/02_lcd_drv modules
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Entering directory <span class="token string">'/home/lighthouse/linux-6.1'</span>
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /home/lighthouse/02_lcd_drv/lcd_drv.o
  Building modules, stage <span class="token number">2</span>.
  MODPOST <span class="token number">1</span> modules
  CC <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /home/lighthouse/02_lcd_drv/lcd_drv.mod.o
  LD <span class="token punctuation">[</span>M<span class="token punctuation">]</span>  /home/lighthouse/02_lcd_drv/lcd_drv.ko
make<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>: Leaving directory <span class="token string">'/home/lighthouse/linux-6.1'</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/59a9a77d6b4bbeaef11b8352319dbf9f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">FPGA——XILINX原语（1）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/adc6437f68dfc4cd07043c4deafb1f4b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vditor无法渲染出现</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>