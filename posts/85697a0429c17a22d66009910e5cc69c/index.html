<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>2021-11-10 YOLOX训练最新笔记总结（coco格式） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="2021-11-10 YOLOX训练最新笔记总结（coco格式）" />
<meta property="og:description" content="1. 数据准备 如下图所示，训练图片images的格式尺寸可以不等：
标签label（.txt）一个文件对应一个txt文件：
labellmg 标注可以直接导出 .txt文件 一一对应的格式,如图：
上图换了个任务标签，细节不要在意，意思到就行~
如果是labelme生成的Json文件，like this:
json转化一下txt：
import json import os name2id = {&#39;advertisement&#39;: 0} # 此处为类别id # name2id = {&#39;person&#39;:0,&#39;helmet&#39;:1,&#39;Fire extinguisher&#39;:2,&#39;Hook&#39;:3,&#39;Gas cylinder&#39;:4} # def convert(img_size, box): dw = 1. / (img_size[0]) dh = 1. / (img_size[1]) x = (box[0] &#43; box[2]) / 2.0 - 1 y = (box[1] &#43; box[3]) / 2.0 - 1 w = box[2] - box[0] if w &lt; 0: w = box[0] - box[2] h = box[3] - box[1] if h &lt; 0: h = box[1] - box[3] x = x * dw w = w * dw y = y * dh h = h * dh return (x, y, w, h) def decode_json(json_floder_path, json_name): txt_name = txt_floder_path &#43; json_name[0:-5] &#43; &#39;." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/85697a0429c17a22d66009910e5cc69c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-09T14:48:44+08:00" />
<meta property="article:modified_time" content="2022-02-09T14:48:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">2021-11-10 YOLOX训练最新笔记总结（coco格式）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-tomorrow-night-eighties">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1__0"></a>1. 数据准备</h2> 
<p>如下图所示，训练图片images的格式尺寸可以不等：<br> <img src="https://images2.imgbox.com/dd/20/RKY4zPKr_o.png" alt="在这里插入图片描述"><br> 标签label（.txt）一个文件对应一个txt文件：<br> <img src="https://images2.imgbox.com/5f/61/mKgiKHrC_o.png" alt="在这里插入图片描述"><br> <mark>labellmg</mark> 标注可以直接导出 <mark>.txt文件</mark> 一一对应的格式,如图：<br> <img src="https://images2.imgbox.com/3c/ad/4iiponS1_o.png" alt="在这里插入图片描述"><br> 上图换了个任务标签，细节不要在意，意思到就行~<br> 如果是labelme生成的<mark>Json文件</mark>，like this:<br> <img src="https://images2.imgbox.com/5d/da/NuGjBGPT_o.png" alt="在这里插入图片描述"><br> <mark>json转化一下txt：</mark></p> 
<pre><code class="prism language-bash"><span class="token function">import</span> json
<span class="token function">import</span> os

name2id <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'advertisement'</span><span class="token builtin class-name">:</span> <span class="token number">0</span><span class="token punctuation">}</span>  <span class="token comment"># 此处为类别id</span>


<span class="token comment"># name2id = {'person':0,'helmet':1,'Fire extinguisher':2,'Hook':3,'Gas cylinder':4}</span>
<span class="token comment">#</span>
def convert<span class="token punctuation">(</span>img_size, box<span class="token punctuation">)</span>:
    dw <span class="token operator">=</span> <span class="token number">1</span>. / <span class="token punctuation">(</span>img_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    dh <span class="token operator">=</span> <span class="token number">1</span>. / <span class="token punctuation">(</span>img_size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    x <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> + box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> / <span class="token number">2.0</span> - <span class="token number">1</span>
    y <span class="token operator">=</span> <span class="token punctuation">(</span>box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> + box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> / <span class="token number">2.0</span> - <span class="token number">1</span>
    w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> - box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> w <span class="token operator">&lt;</span> <span class="token number">0</span>:
        w <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> - box<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>
    h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> - box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> h <span class="token operator">&lt;</span> <span class="token number">0</span>:
        h <span class="token operator">=</span> box<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> - box<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span>
    x <span class="token operator">=</span> x * dw
    w <span class="token operator">=</span> w * dw
    y <span class="token operator">=</span> y * dh
    h <span class="token operator">=</span> h * dh
    <span class="token builtin class-name">return</span> <span class="token punctuation">(</span>x, y, w, h<span class="token punctuation">)</span>


def decode_json<span class="token punctuation">(</span>json_floder_path, json_name<span class="token punctuation">)</span>:
    txt_name <span class="token operator">=</span> txt_floder_path + json_name<span class="token punctuation">[</span><span class="token number">0</span>:-5<span class="token punctuation">]</span> + <span class="token string">'.txt'</span>   <span class="token comment">#</span>
    txt_file <span class="token operator">=</span> open<span class="token punctuation">(</span>txt_name, <span class="token string">'w'</span><span class="token punctuation">)</span>

    json_path <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>json_floder_path, json_name<span class="token punctuation">)</span>
    data <span class="token operator">=</span> json.load<span class="token punctuation">(</span>open<span class="token punctuation">(</span>json_path, <span class="token string">'r'</span>, <span class="token assign-left variable">encoding</span><span class="token operator">=</span><span class="token string">'gb2312'</span><span class="token punctuation">))</span>

    img_w <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'imageWidth'</span><span class="token punctuation">]</span>
    img_h <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'imageHeight'</span><span class="token punctuation">]</span>

    <span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> data<span class="token punctuation">[</span><span class="token string">'shapes'</span><span class="token punctuation">]</span>:

        label_name <span class="token operator">=</span> i<span class="token punctuation">[</span><span class="token string">'label'</span><span class="token punctuation">]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token string">'shape_type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'rectangle'</span><span class="token punctuation">)</span>:
            x1 <span class="token operator">=</span> int<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            y1 <span class="token operator">=</span> int<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            x2 <span class="token operator">=</span> int<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
            y2 <span class="token operator">=</span> int<span class="token punctuation">(</span>i<span class="token punctuation">[</span><span class="token string">'points'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

            bb <span class="token operator">=</span> <span class="token punctuation">(</span>x1, y1, x2, y2<span class="token punctuation">)</span>
            bbox <span class="token operator">=</span> convert<span class="token punctuation">((</span>img_w, img_h<span class="token punctuation">)</span>, bb<span class="token punctuation">)</span>
            txt_file.write<span class="token punctuation">(</span>str<span class="token punctuation">(</span>name2id<span class="token punctuation">[</span>label_name<span class="token punctuation">]</span><span class="token punctuation">)</span> + <span class="token string">" "</span> + <span class="token string">" "</span>.join<span class="token punctuation">(</span><span class="token punctuation">[</span>str<span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token keyword">for</span> <span class="token for-or-select variable">a</span> <span class="token keyword">in</span> bbox<span class="token punctuation">]</span><span class="token punctuation">)</span> + <span class="token string">'<span class="token entity" title="\n">\n</span>'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>

    json_floder_path <span class="token operator">=</span> <span class="token string">'D:<span class="token entity" title="\\">\\</span>advertisement1622+json<span class="token entity" title="\\">\\</span>json1615<span class="token entity" title="\\">\\</span>'</span>   <span class="token comment"># json文件夹路径</span>
    txt_floder_path <span class="token operator">=</span> <span class="token string">'D:<span class="token entity" title="\\">\\</span>advertisement1622+json<span class="token entity" title="\\">\\</span>txt1615<span class="token entity" title="\\">\\</span>'</span>     <span class="token comment"># txt文件夹路径</span>
    json_names <span class="token operator">=</span> os.listdir<span class="token punctuation">(</span>json_floder_path<span class="token punctuation">)</span>
    <span class="token keyword">for</span> <span class="token for-or-select variable">json_name</span> <span class="token keyword">in</span> json_names:
        decode_json<span class="token punctuation">(</span>json_floder_path, json_name<span class="token punctuation">)</span>
</code></pre> 
<p><mark>生成训练测试验证的总json文件：</mark></p> 
<pre><code class="prism language-bash"><span class="token string">""</span>"
YOLO 格式的数据集转化为 COCO 格式的数据集
--root_dir 输入根路径
--save_path 保存文件的名字<span class="token punctuation">(</span>没有random_split时使用<span class="token punctuation">)</span>
--random_split 有则会随机划分数据集，然后再分别保存为3个文件。
<span class="token string">""</span>"

<span class="token function">import</span> os
<span class="token function">import</span> cv2
<span class="token function">import</span> json
from tqdm <span class="token function">import</span> tqdm
from sklearn.model_selection <span class="token function">import</span> train_test_split
<span class="token function">import</span> argparse

parser <span class="token operator">=</span> argparse.ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>
parser.add_argument<span class="token punctuation">(</span><span class="token string">'--root_dir'</span>, <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token string">'F:<span class="token entity" title="\\">\\</span>advertisement1622+json<span class="token entity" title="\\">\\</span>advertisementv2<span class="token entity" title="\\">\\</span>'</span>, <span class="token assign-left variable">type</span><span class="token operator">=</span>str,
                    <span class="token assign-left variable">help</span><span class="token operator">=</span><span class="token string">"root path of images and labels, include ./images and ./labels and classes.txt"</span><span class="token punctuation">)</span>
parser.add_argument<span class="token punctuation">(</span><span class="token string">'--save_path'</span>, <span class="token assign-left variable">type</span><span class="token operator">=</span>str, <span class="token assign-left variable">default</span><span class="token operator">=</span><span class="token string">'./train.json'</span>,
                    <span class="token assign-left variable">help</span><span class="token operator">=</span><span class="token string">"if not split the dataset, give a path to a json file"</span><span class="token punctuation">)</span>
parser.add_argument<span class="token punctuation">(</span><span class="token string">'--random_split'</span>, <span class="token assign-left variable">action</span><span class="token operator">=</span><span class="token string">'store_false'</span>, <span class="token assign-left variable">help</span><span class="token operator">=</span><span class="token string">"random split the dataset, default ratio is 8:1:1"</span><span class="token punctuation">)</span> <span class="token comment"># store_false = 8：1:1</span>
arg <span class="token operator">=</span> parser.parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>                                                                                            <span class="token comment"># store_true =train 全部</span>
<span class="token comment"># test_image = "F:\\advertisement1622+json\\test2017\\"    # 新建以下三个文件夹</span>
<span class="token comment"># val_image = "F:\\advertisement1622+json\\val2017\\"</span>
<span class="token comment"># train_image = "F:\\advertisement1622+json\\train2017\\"</span>

test_image <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>arg.root_dir, <span class="token string">'test2017'</span><span class="token punctuation">)</span>
val_image <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>arg.root_dir, <span class="token string">'val2017'</span><span class="token punctuation">)</span>
train_image <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>arg.root_dir, <span class="token string">'train2017'</span><span class="token punctuation">)</span>
<span class="token keyword">if</span> not os.path.exists<span class="token punctuation">(</span>test_image<span class="token punctuation">)</span>:
    os.makedirs<span class="token punctuation">(</span>test_image<span class="token punctuation">)</span>
<span class="token keyword">if</span> not os.path.exists<span class="token punctuation">(</span>val_image<span class="token punctuation">)</span>:
    os.makedirs<span class="token punctuation">(</span>val_image<span class="token punctuation">)</span>
<span class="token keyword">if</span> not os.path.exists<span class="token punctuation">(</span>train_image<span class="token punctuation">)</span>:
    os.makedirs<span class="token punctuation">(</span>train_image<span class="token punctuation">)</span>



def train_test_val_split<span class="token punctuation">(</span>img_paths, <span class="token assign-left variable">ratio_train</span><span class="token operator">=</span><span class="token number">0.889</span>, <span class="token assign-left variable">ratio_test</span><span class="token operator">=</span><span class="token number">0.1</span>, <span class="token assign-left variable">ratio_val</span><span class="token operator">=</span><span class="token number">0.001</span>,<span class="token punctuation">)</span>:
    <span class="token comment"># 这里可以修改数据集划分的比例。</span>
    assert int<span class="token punctuation">(</span>ratio_train + ratio_test + ratio_val<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span>
    train_img, middle_img <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>img_paths, <span class="token assign-left variable">test_size</span><span class="token operator">=</span><span class="token number">1</span> - ratio_train, <span class="token assign-left variable">random_state</span><span class="token operator">=</span><span class="token number">233</span><span class="token punctuation">)</span>
    ratio <span class="token operator">=</span> ratio_val / <span class="token punctuation">(</span><span class="token number">1</span> - ratio_train<span class="token punctuation">)</span>
    val_img, test_img <span class="token operator">=</span> train_test_split<span class="token punctuation">(</span>middle_img, <span class="token assign-left variable">test_size</span><span class="token operator">=</span>ratio, <span class="token assign-left variable">random_state</span><span class="token operator">=</span><span class="token number">233</span><span class="token punctuation">)</span>
    print<span class="token punctuation">(</span><span class="token string">"NUMS of train:val:test = {}:{}:{}"</span>.format<span class="token punctuation">(</span>len<span class="token punctuation">(</span>train_img<span class="token punctuation">)</span>, len<span class="token punctuation">(</span>val_img<span class="token punctuation">)</span>, len<span class="token punctuation">(</span>test_img<span class="token punctuation">))</span><span class="token punctuation">)</span>
    <span class="token builtin class-name">return</span> train_img, val_img, test_img


def yolo2coco<span class="token punctuation">(</span>root_path, random_split<span class="token punctuation">)</span>:
    originLabelsDir <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'labels'</span><span class="token punctuation">)</span>
    originImagesDir <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'images'</span><span class="token punctuation">)</span>
    with open<span class="token punctuation">(</span>os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'classes.txt'</span><span class="token punctuation">))</span> as f:
        classes <span class="token operator">=</span> f.read<span class="token punctuation">(</span><span class="token punctuation">)</span>.strip<span class="token punctuation">(</span><span class="token punctuation">)</span>.split<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># images dir name</span>
    indexes <span class="token operator">=</span> os.listdir<span class="token punctuation">(</span>originImagesDir<span class="token punctuation">)</span>

    <span class="token keyword">if</span> random_split:
        <span class="token comment"># 用于保存所有数据的图片信息和标注信息</span>
        train_dataset <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'categories'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'annotations'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'images'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        val_dataset <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'categories'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'annotations'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'images'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        test_dataset <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'categories'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'annotations'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'images'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>

        <span class="token comment"># 建立类别标签和数字id的对应关系, 类别id从0开始。</span>
        <span class="token keyword">for</span> i, cls <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>classes, <span class="token number">0</span><span class="token punctuation">)</span>:
            train_dataset<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span>.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'id'</span><span class="token builtin class-name">:</span> i, <span class="token string">'name'</span><span class="token builtin class-name">:</span> cls, <span class="token string">'supercategory'</span><span class="token builtin class-name">:</span> <span class="token string">'mark'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            val_dataset<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span>.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'id'</span><span class="token builtin class-name">:</span> i, <span class="token string">'name'</span><span class="token builtin class-name">:</span> cls, <span class="token string">'supercategory'</span><span class="token builtin class-name">:</span> <span class="token string">'mark'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
            test_dataset<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span>.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'id'</span><span class="token builtin class-name">:</span> i, <span class="token string">'name'</span><span class="token builtin class-name">:</span> cls, <span class="token string">'supercategory'</span><span class="token builtin class-name">:</span> <span class="token string">'mark'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
        train_img, val_img, test_img <span class="token operator">=</span> train_test_val_split<span class="token punctuation">(</span>indexes, <span class="token number">0.899</span>, <span class="token number">0.1</span>, <span class="token number">0.001</span><span class="token punctuation">)</span>  <span class="token comment"># 这里可以修改数据集划分的比例。</span>
    else:
        dataset <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'categories'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'annotations'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>, <span class="token string">'images'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> i, cls <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>classes, <span class="token number">0</span><span class="token punctuation">)</span>:
            dataset<span class="token punctuation">[</span><span class="token string">'categories'</span><span class="token punctuation">]</span>.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'id'</span><span class="token builtin class-name">:</span> i, <span class="token string">'name'</span><span class="token builtin class-name">:</span> cls, <span class="token string">'supercategory'</span><span class="token builtin class-name">:</span> <span class="token string">'mark'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment"># 标注的id</span>
    ann_id_cnt <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">for</span> k, index <span class="token keyword">in</span> enumerate<span class="token punctuation">(</span>tqdm<span class="token punctuation">(</span>indexes<span class="token punctuation">))</span>:
        <span class="token comment"># 支持 png jpg 格式的图片。</span>
        txtFile <span class="token operator">=</span> index.replace<span class="token punctuation">(</span><span class="token string">'images'</span>, <span class="token string">'txt'</span><span class="token punctuation">)</span>.replace<span class="token punctuation">(</span><span class="token string">'.jpg'</span>, <span class="token string">'.txt'</span><span class="token punctuation">)</span>.replace<span class="token punctuation">(</span><span class="token string">'.png'</span>, <span class="token string">'.txt'</span><span class="token punctuation">)</span>
        <span class="token comment"># 读取图像的宽和高</span>
        im <span class="token operator">=</span> cv2.imread<span class="token punctuation">(</span>os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'images/'</span><span class="token punctuation">)</span> + index<span class="token punctuation">)</span>
        height, width, _ <span class="token operator">=</span> im.shape
        <span class="token comment"># index = index.replace('.png', '.jpg')</span>
        <span class="token keyword">if</span> random_split:
            <span class="token comment"># 切换dataset的引用对象，从而划分数据集</span>
            <span class="token keyword">if</span> index <span class="token keyword">in</span> train_img:
                dataset <span class="token operator">=</span> train_dataset
                cv2.imwrite<span class="token punctuation">(</span>train_image + os.sep + index, im<span class="token punctuation">)</span>
                <span class="token comment"># print(train_image + os.sep + index)</span>
            <span class="token keyword">elif</span> index <span class="token keyword">in</span> val_img:
                dataset <span class="token operator">=</span> val_dataset
                cv2.imwrite<span class="token punctuation">(</span>val_image + os.sep + index, im<span class="token punctuation">)</span>
                <span class="token comment"># print(val_image + os.sep + index)</span>
            <span class="token keyword">elif</span> index <span class="token keyword">in</span> test_img:
                dataset <span class="token operator">=</span> test_dataset
                cv2.imwrite<span class="token punctuation">(</span>test_image + os.sep + index, im<span class="token punctuation">)</span>
                <span class="token comment"># print(test_image + os.sep + index)</span>
        <span class="token comment"># 添加图像的信息</span>
        dataset<span class="token punctuation">[</span><span class="token string">'images'</span><span class="token punctuation">]</span>.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span><span class="token string">'file_name'</span><span class="token builtin class-name">:</span> index,
                                  <span class="token string">'id'</span><span class="token builtin class-name">:</span> k,
                                  <span class="token string">'width'</span><span class="token builtin class-name">:</span> width,
                                  <span class="token string">'height'</span><span class="token builtin class-name">:</span> height<span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> not os.path.exists<span class="token punctuation">(</span>os.path.join<span class="token punctuation">(</span>originLabelsDir, txtFile<span class="token punctuation">))</span>:
            <span class="token comment"># 如没标签，跳过，只保留图片信息。</span>
            <span class="token builtin class-name">continue</span>
        with open<span class="token punctuation">(</span>os.path.join<span class="token punctuation">(</span>originLabelsDir, txtFile<span class="token punctuation">)</span>, <span class="token string">'r'</span><span class="token punctuation">)</span> as fr:
            labelList <span class="token operator">=</span> fr.readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> <span class="token for-or-select variable">label</span> <span class="token keyword">in</span> labelList:
                label <span class="token operator">=</span> label.strip<span class="token punctuation">(</span><span class="token punctuation">)</span>.split<span class="token punctuation">(</span><span class="token punctuation">)</span>
                x <span class="token operator">=</span> float<span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                y <span class="token operator">=</span> float<span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                w <span class="token operator">=</span> float<span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                h <span class="token operator">=</span> float<span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

                <span class="token comment"># convert x,y,w,h to x1,y1,x2,y2</span>
                H, W, _ <span class="token operator">=</span> im.shape
                x1 <span class="token operator">=</span> <span class="token punctuation">(</span>x - w / <span class="token number">2</span><span class="token punctuation">)</span> * W
                y1 <span class="token operator">=</span> <span class="token punctuation">(</span>y - h / <span class="token number">2</span><span class="token punctuation">)</span> * H
                x2 <span class="token operator">=</span> <span class="token punctuation">(</span>x + w / <span class="token number">2</span><span class="token punctuation">)</span> * W
                y2 <span class="token operator">=</span> <span class="token punctuation">(</span>y + h / <span class="token number">2</span><span class="token punctuation">)</span> * H
                <span class="token comment"># 标签序号从0开始计算, coco2017数据集标号混乱，不管它了。</span>
                cls_id <span class="token operator">=</span> int<span class="token punctuation">(</span>label<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                width <span class="token operator">=</span> max<span class="token punctuation">(</span><span class="token number">0</span>, x2 - x1<span class="token punctuation">)</span>
                height <span class="token operator">=</span> max<span class="token punctuation">(</span><span class="token number">0</span>, y2 - y1<span class="token punctuation">)</span>
                dataset<span class="token punctuation">[</span><span class="token string">'annotations'</span><span class="token punctuation">]</span>.append<span class="token punctuation">(</span><span class="token punctuation">{<!-- --></span>
                    <span class="token string">'area'</span><span class="token builtin class-name">:</span> width * height,
                    <span class="token string">'bbox'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>x1, y1, width, height<span class="token punctuation">]</span>,
                    <span class="token string">'category_id'</span><span class="token builtin class-name">:</span> cls_id,
                    <span class="token string">'id'</span><span class="token builtin class-name">:</span> ann_id_cnt,
                    <span class="token string">'image_id'</span><span class="token builtin class-name">:</span> k,
                    <span class="token string">'iscrowd'</span><span class="token builtin class-name">:</span> <span class="token number">0</span>,
                    <span class="token comment"># mask, 矩形是从左上角点按顺时针的四个顶点</span>
                    <span class="token string">'segmentation'</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>x1, y1, x2, y1, x2, y2, x1, y2<span class="token punctuation">]</span><span class="token punctuation">]</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                ann_id_cnt <span class="token operator">+=</span> <span class="token number">1</span>

    <span class="token comment"># 保存结果</span>
    folder <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'annotations'</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> not os.path.exists<span class="token punctuation">(</span>folder<span class="token punctuation">)</span>:
        os.makedirs<span class="token punctuation">(</span>folder<span class="token punctuation">)</span>
    <span class="token keyword">if</span> random_split:
        <span class="token keyword">for</span> <span class="token for-or-select variable">phase</span> <span class="token keyword">in</span> <span class="token punctuation">[</span><span class="token string">'instances_train2017'</span>, <span class="token string">'instances_val2017'</span>, <span class="token string">'instances_test2017'</span><span class="token punctuation">]</span>:
            json_name <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'annotations/{}.json'</span>.format<span class="token punctuation">(</span>phase<span class="token punctuation">))</span>
            with open<span class="token punctuation">(</span>json_name, <span class="token string">'w'</span><span class="token punctuation">)</span> as f:
                <span class="token keyword">if</span> phase <span class="token operator">==</span> <span class="token string">'instances_train2017'</span><span class="token builtin class-name">:</span>
                    json.dump<span class="token punctuation">(</span>train_dataset, f<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> phase <span class="token operator">==</span> <span class="token string">'instances_val2017'</span><span class="token builtin class-name">:</span>
                    json.dump<span class="token punctuation">(</span>val_dataset, f<span class="token punctuation">)</span>
                <span class="token keyword">elif</span> phase <span class="token operator">==</span> <span class="token string">'instances_test2017'</span><span class="token builtin class-name">:</span>
                    json.dump<span class="token punctuation">(</span>test_dataset, f<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">'Save annotation to {}'</span>.format<span class="token punctuation">(</span>json_name<span class="token punctuation">))</span>
    else:
        json_name <span class="token operator">=</span> os.path.join<span class="token punctuation">(</span>root_path, <span class="token string">'annotations/{}'</span>.format<span class="token punctuation">(</span>arg.save_path<span class="token punctuation">))</span>
        with open<span class="token punctuation">(</span>json_name, <span class="token string">'w'</span><span class="token punctuation">)</span> as f:
            json.dump<span class="token punctuation">(</span>dataset, f<span class="token punctuation">)</span>
            print<span class="token punctuation">(</span><span class="token string">'Save annotation to {}'</span>.format<span class="token punctuation">(</span>json_name<span class="token punctuation">))</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token builtin class-name">:</span>
    root_path <span class="token operator">=</span> arg.root_dir
    assert os.path.exists<span class="token punctuation">(</span>root_path<span class="token punctuation">)</span>
    random_split <span class="token operator">=</span> arg.random_split
    print<span class="token punctuation">(</span><span class="token string">"Loading data from "</span>, root_path, <span class="token string">"<span class="token entity" title="\n">\n</span>Whether to split the data:"</span>, random_split<span class="token punctuation">)</span>
    yolo2coco<span class="token punctuation">(</span>root_path, random_split<span class="token punctuation">)</span>
</code></pre> 
<p>自动生成annotations文件夹和里面的<mark>train/val/test.json</mark>、<strong>训练图片、验证、测试图片的文件夹</strong>：<br> <img src="https://images2.imgbox.com/1a/c2/o1GqcsRn_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/87/e3/3XHx0BGx_o.png" alt="在这里插入图片描述"></p> 
<p>最后上传的是以下数据文件：<br> <img src="https://images2.imgbox.com/5f/1c/gNnuYgHr_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="2_244"></a>2.训练开始</h2> 
<h3><a id="21_1yolox_spy__245"></a>2.1 <mark>修改文件1.yolox_s.py</mark> <strong>修改网络宽度和深度、数据集的位置、种类等参数</strong></h3> 
<pre><code class="prism language-bash">./exps/example/custom/yolox_s.py
</code></pre> 
<p><img src="https://images2.imgbox.com/37/81/o0gLD1AU_o.png" alt="在这里插入图片描述"><br> 其中yolox所用的depth和width要和模型大小（S\M\L) <mark>./exps/default/yolox_s.py(yolox_m.py/yolox_l.py)</mark> 保持一致，like this:<br> <img src="https://images2.imgbox.com/e2/b8/aEPyOzzh_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/29/e8/GOOCQjID_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ec/b1/uHojcxoO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="22__2yolox_basepy__255"></a>2.2 <mark>修改文件 2.yolox_base.py</mark> 同样修改类别、网络宽度和深度等参数</h3> 
<pre><code class="prism language-bash">./yolox/exp/yolox_base.py
</code></pre> 
<p><img src="https://images2.imgbox.com/fd/fb/qa3pzSJt_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="23__3coco_classespy__261"></a>2.3 <mark>修改文件 3.coco_classes.py</mark> 改成自己的类别，记得类别之后打“，”逗号，不然会报错</h3> 
<pre><code class="prism language-bash">./yolox/data/datasets/coco_classes.py
</code></pre> 
<p><img src="https://images2.imgbox.com/fa/b4/LRm63mVJ_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/c7/fa/aeuoZUC7_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_270"></a>3.训练起来：</h2> 
<p>终端执行：</p> 
<pre><code class="prism language-bash">python train.py -f exps/example/custom/yolox_s.py -d <span class="token number">2</span> -b <span class="token number">16</span> --fp16 -o -c yolox_s.pth --cache
</code></pre> 
<p>like this:<br> <img src="https://images2.imgbox.com/b2/15/3qqWhuzv_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/1d/5d/pZtbmf4O_o.png" alt="请添加图片描述"><br> ※<strong>注意！！！！# 遇到的一些坑和问题：</strong><br> 1.直接pip install loguru会报错，用清华镜像安装就没有问题了<br> <code>pip install loguru -i http://pypi.tuna.tsinghua.edu.cn/simple/ --trusted-host pypi.tuna.tsinghua.edu.cn</code> <img src="https://images2.imgbox.com/7e/b6/nALiIkaH_o.png" alt="请添加图片描述"><br> <img src="https://images2.imgbox.com/ea/a6/MT0v3tat_o.png" alt="请添加图片描述"></p> 
<p>2.<strong>AssertionError</strong>错误<br> 终端开始训练输入：<code>python train.py -f exps/example/custom/yolox_s.py -d 2 -b 16 --fp16 -o -c yolox_m.pth [--cache]</code><br> 会出现报错 但是之前不会。<br> 训练的代码在train.py 中，首先对训练的参数进行解析，然后调用get_exp(args.exp_file, args.name) 获取exp，调用exp.merge(args.opts)并merge训练参数，然后启动训练，报错如下：</p> 
<pre><code class="prism language-bash">Traceback <span class="token punctuation">(</span>most recent call last<span class="token punctuation">)</span>:
  File <span class="token string">"train.py"</span>, line <span class="token number">122</span>, <span class="token keyword">in</span> <span class="token operator">&lt;</span>module<span class="token operator">&gt;</span>
    exp.merge<span class="token punctuation">(</span>args.opts<span class="token punctuation">)</span>
  File <span class="token string">"/home/jovyan/YOLOX-main/yolox/exp/base_exp.py"</span>, line <span class="token number">64</span>, <span class="token keyword">in</span> merge
    assert len<span class="token punctuation">(</span>cfg_list<span class="token punctuation">)</span> % <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0</span>
AssertionError
</code></pre> 
<p>代码终端训练改成：</p> 
<pre><code class="prism language-bash">python train.py -f exps/example/custom/yolox_s.py -d <span class="token number">2</span> -b <span class="token number">16</span> --fp16 -o -c yolox_s.pth --cache
</code></pre> 
<p>去掉[–cache]外面的括号，然后正常开始训练~<br> <img src="https://images2.imgbox.com/e6/25/edbMRZNs_o.png" alt="请添加图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/e7348b4b43c0e6ad0ee0510e97100adf/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">LeetCode｜【34 在排序数组中查找元素的第一个和最后一个位置】</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/4c741ffe27f4e67ef819ded1084b49ef/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">安装clickhouse后namenode无法启动</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>