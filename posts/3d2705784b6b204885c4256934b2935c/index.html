<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Yolo V5 学习 ( 从数据集中获取图像和标签 __getitem__ ) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Yolo V5 学习 ( 从数据集中获取图像和标签 __getitem__ )" />
<meta property="og:description" content="文章目录 1.引入库2. 马赛克2.1 使用马赛克 mosaic == True2.1.1 加载马赛克图像和标签 (load_mosaic) 2.2 不使用马赛克 mosaic == False 总结 1.引入库 代码如下（示例）：
index = self.indices[index] # 获取数据集中的索引 hyp = self.hyp	# 超参数 mosaic = self.mosaic and random.random() &lt; hyp[&#39;mosaic&#39;]	# 是否使用马赛克增强 self.indices 是一个列表，包含数据集中的索引
hyp 是一个字典,包含了各种超参数,用于存储数据增强方法的概率和参数
例如，hyp[‘mosaic’] 表示使用马赛克增强的概率，hyp[‘mixup’] 表示使用 MixUp 增强的概率，hyp[‘hsv_h’]、hyp[‘hsv_s’] 和 hyp[‘hsv_v’] 分别表示 HSV 颜色空间增强的色调、饱和度和明度增益。
mosaic 通过检查 self.mosaic 和 random.random() &lt; hyp[‘mosaic’] 来实现的。如果这两个条件都为真，则将 mosaic 变量设置为 True。
2. 马赛克 2.1 使用马赛克 mosaic == True 代码如下（示例）：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3d2705784b6b204885c4256934b2935c/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-05T19:05:58+08:00" />
<meta property="article:modified_time" content="2023-05-05T19:05:58+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Yolo V5 学习 ( 从数据集中获取图像和标签 __getitem__ )</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#1_9" rel="nofollow">1.引入库</a></li><li><a href="#2__23" rel="nofollow">2. 马赛克</a></li><li><ul><li><a href="#21__mosaic___True_24" rel="nofollow">2.1 使用马赛克 mosaic == True</a></li><li><ul><li><a href="#211__load_mosaic_38" rel="nofollow">2.1.1 加载马赛克图像和标签 (load_mosaic)</a></li></ul> 
   </li><li><a href="#22__mosaic___False_138" rel="nofollow">2.2 不使用马赛克 mosaic == False</a></li></ul> 
  </li><li><a href="#_170" rel="nofollow">总结</a></li></ul> 
</div> 
<p></p> 
<hr> 
<h2><a id="1_9"></a>1.引入库</h2> 
<p>代码如下（示例）：</p> 
<pre><code class="prism language-c">index <span class="token operator">=</span> self<span class="token punctuation">.</span>indices<span class="token punctuation">[</span>index<span class="token punctuation">]</span>  # 获取数据集中的索引
hyp <span class="token operator">=</span> self<span class="token punctuation">.</span>hyp	# 超参数
mosaic <span class="token operator">=</span> self<span class="token punctuation">.</span>mosaic and random<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> hyp<span class="token punctuation">[</span><span class="token char">'mosaic'</span><span class="token punctuation">]</span>	# 是否使用马赛克增强
</code></pre> 
<p>  self.indices 是一个列表，包含数据集中的索引<br>   hyp 是一个字典,包含了各种超参数,用于存储数据增强方法的概率和参数<br> 例如，hyp[‘mosaic’] 表示使用马赛克增强的概率，hyp[‘mixup’] 表示使用 MixUp 增强的概率，hyp[‘hsv_h’]、hyp[‘hsv_s’] 和 hyp[‘hsv_v’] 分别表示 HSV 颜色空间增强的色调、饱和度和明度增益。<br>   mosaic 通过检查 self.mosaic 和 random.random() &lt; hyp[‘mosaic’] 来实现的。如果这两个条件都为真，则将 mosaic 变量设置为 True。</p> 
<h2><a id="2__23"></a>2. 马赛克</h2> 
<h3><a id="21__mosaic___True_24"></a>2.1 使用马赛克 mosaic == True</h3> 
<p>代码如下（示例）：</p> 
<pre><code class="prism language-c"><span class="token keyword">if</span> mosaic<span class="token operator">:</span>
    img<span class="token punctuation">,</span> labels <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">load_mosaic</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>	# 加载马赛克图像和标签<span class="token punctuation">,</span>返回一个包含图像和标签的元组
    shapes <span class="token operator">=</span> None
    <span class="token keyword">if</span> random<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> hyp<span class="token punctuation">[</span><span class="token char">'mixup'</span><span class="token punctuation">]</span><span class="token operator">:</span>	# 是否使用 MixUp 增强
        img<span class="token punctuation">,</span> labels <span class="token operator">=</span> <span class="token function">mixup</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> labels<span class="token punctuation">,</span> <span class="token operator">*</span>self<span class="token punctuation">.</span><span class="token function">load_mosaic</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">randint</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>	# 返回一个包含混合后的图像和标签的元组
</code></pre> 
<p>  MixUp 是一种数据增强技术，它通过将两个训练样本的特征和标签混合在一起来创建新的虚拟训练样本。使用公式实现<br> new_x = lambda * x1 + (1 - lambda) * x2 new_y = lambda * y1 + (1 - lambda) * y2<br>   其中 x1 和 x2 是图像，y1 和 y2 是标签，lambda 是一个在 [0, 1] 范围内的值，从 Beta 分布中采样得到。<br>   MixUp 可以帮助神经网络避免记忆错误的标签，因为它通过将不同的特征和标签混合在一起，使网络不会对特征和标签之间的关系过于自信。</p> 
<h4><a id="211__load_mosaic_38"></a>2.1.1 加载马赛克图像和标签 (load_mosaic)</h4> 
<p>  load_mosaic 方法用于加载马赛克图像和标签。马赛克增强是一种数据增强技术，它通过将四个训练图像拼接在一起来创建新的虚拟训练图像。</p> 
<pre><code class="prism language-c">labels4<span class="token punctuation">,</span> segments4 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>		# 用于存储马赛克图像的标签和分段
s <span class="token operator">=</span> self<span class="token punctuation">.</span>img_size	# 获取图像的大小
<span class="token macro property"><span class="token directive-hash">#</span> <span class="token directive keyword">random</span><span class="token expression"><span class="token punctuation">.</span><span class="token function">uniform</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 用于在给定范围内生成随机数</span></span>
yc<span class="token punctuation">,</span> xc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">(</span>random<span class="token punctuation">.</span><span class="token function">uniform</span><span class="token punctuation">(</span><span class="token operator">-</span>x<span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> s <span class="token operator">+</span> x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> x in self<span class="token punctuation">.</span>mosaic_border<span class="token punctuation">)</span>  # 计算马赛克图像的中心坐标	
indices <span class="token operator">=</span> <span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">+</span> random<span class="token punctuation">.</span><span class="token function">choices</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>indices<span class="token punctuation">,</span> k<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>  # 从数据集中随机选择三个索引 
random<span class="token punctuation">.</span><span class="token function">shuffle</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span>		# 然后打乱索引的顺序
<span class="token keyword">for</span> i<span class="token punctuation">,</span> index in <span class="token function">enumerate</span><span class="token punctuation">(</span>indices<span class="token punctuation">)</span><span class="token operator">:</span>		#遍历索引
	
	# 加载图像 返回图像<span class="token punctuation">,</span>形状<span class="token punctuation">,</span><span class="token punctuation">(</span>尺寸<span class="token punctuation">)</span> 形状和尺寸分别表示图像的原始形状和调整后的尺寸
    img<span class="token punctuation">,</span> _<span class="token punctuation">,</span> <span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">load_image</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>		
	
	# 根据索引在列表中的位置，计算图像在马赛克图像中的位置
    <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">0</span><span class="token operator">:</span>  # top left	
    	# <span class="token number">1.</span>初始化大图<span class="token punctuation">;</span><span class="token number">2.</span>计算当前图片放在大图中什么位置<span class="token punctuation">;</span><span class="token number">3.</span>计算在小图中取哪一部分放到大图中
        img4 <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">full</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> s <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">114</span><span class="token punctuation">,</span> dtype<span class="token operator">=</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>  # base image with <span class="token number">4</span> tiles
        x1a<span class="token punctuation">,</span> y1a<span class="token punctuation">,</span> x2a<span class="token punctuation">,</span> y2a <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>xc <span class="token operator">-</span> w<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>yc <span class="token operator">-</span> h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> xc<span class="token punctuation">,</span> yc  # xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> <span class="token function">ymax</span> <span class="token punctuation">(</span>large image<span class="token punctuation">)</span>
        x1b<span class="token punctuation">,</span> y1b<span class="token punctuation">,</span> x2b<span class="token punctuation">,</span> y2b <span class="token operator">=</span> w <span class="token operator">-</span> <span class="token punctuation">(</span>x2a <span class="token operator">-</span> x1a<span class="token punctuation">)</span><span class="token punctuation">,</span> h <span class="token operator">-</span> <span class="token punctuation">(</span>y2a <span class="token operator">-</span> y1a<span class="token punctuation">)</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h  # xmin<span class="token punctuation">,</span> ymin<span class="token punctuation">,</span> xmax<span class="token punctuation">,</span> <span class="token function">ymax</span> <span class="token punctuation">(</span>small image<span class="token punctuation">)</span>
    elif i <span class="token operator">==</span> <span class="token number">1</span><span class="token operator">:</span>  # top right
        x1a<span class="token punctuation">,</span> y1a<span class="token punctuation">,</span> x2a<span class="token punctuation">,</span> y2a <span class="token operator">=</span> xc<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>yc <span class="token operator">-</span> h<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>xc <span class="token operator">+</span> w<span class="token punctuation">,</span> s <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> yc
        x1b<span class="token punctuation">,</span> y1b<span class="token punctuation">,</span> x2b<span class="token punctuation">,</span> y2b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> h <span class="token operator">-</span> <span class="token punctuation">(</span>y2a <span class="token operator">-</span> y1a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> x2a <span class="token operator">-</span> x1a<span class="token punctuation">)</span><span class="token punctuation">,</span> h
    elif i <span class="token operator">==</span> <span class="token number">2</span><span class="token operator">:</span>  # bottom left
        x1a<span class="token punctuation">,</span> y1a<span class="token punctuation">,</span> x2a<span class="token punctuation">,</span> y2a <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>xc <span class="token operator">-</span> w<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> yc<span class="token punctuation">,</span> xc<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>s <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> yc <span class="token operator">+</span> h<span class="token punctuation">)</span>
        x1b<span class="token punctuation">,</span> y1b<span class="token punctuation">,</span> x2b<span class="token punctuation">,</span> y2b <span class="token operator">=</span> w <span class="token operator">-</span> <span class="token punctuation">(</span>x2a <span class="token operator">-</span> x1a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>y2a <span class="token operator">-</span> y1a<span class="token punctuation">,</span> h<span class="token punctuation">)</span>
    elif i <span class="token operator">==</span> <span class="token number">3</span><span class="token operator">:</span>  # bottom right
        x1a<span class="token punctuation">,</span> y1a<span class="token punctuation">,</span> x2a<span class="token punctuation">,</span> y2a <span class="token operator">=</span> xc<span class="token punctuation">,</span> yc<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>xc <span class="token operator">+</span> w<span class="token punctuation">,</span> s <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>s <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">,</span> yc <span class="token operator">+</span> h<span class="token punctuation">)</span>
        x1b<span class="token punctuation">,</span> y1b<span class="token punctuation">,</span> x2b<span class="token punctuation">,</span> y2b <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> x2a <span class="token operator">-</span> x1a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>y2a <span class="token operator">-</span> y1a<span class="token punctuation">,</span> h<span class="token punctuation">)</span>

	# 使用 NumPy 索引将源图像的一部分复制到目标图像中
    img4<span class="token punctuation">[</span>y1a<span class="token operator">:</span>y2a<span class="token punctuation">,</span> x1a<span class="token operator">:</span>x2a<span class="token punctuation">]</span> <span class="token operator">=</span> img<span class="token punctuation">[</span>y1b<span class="token operator">:</span>y2b<span class="token punctuation">,</span> x1b<span class="token operator">:</span>x2b<span class="token punctuation">]</span>  # img4<span class="token punctuation">[</span>ymin<span class="token operator">:</span>ymax<span class="token punctuation">,</span> xmin<span class="token operator">:</span>xmax<span class="token punctuation">]</span>
    # 计算 左上角 起始偏移量
    padw <span class="token operator">=</span> x1a <span class="token operator">-</span> x1b
    padh <span class="token operator">=</span> y1a <span class="token operator">-</span> y1b

    # 获取图像对应的标签和分段
    labels<span class="token punctuation">,</span> segments <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>segments<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	# 检查标签是否存在 即labels<span class="token punctuation">.</span>size是否大于零
	<span class="token keyword">if</span> labels<span class="token punctuation">.</span>size<span class="token operator">:</span>
		# 调用 xywhn2xyxy 函数将标签从归一化的 xywhn 格式转换为像素 xyxy 格式
		# 接受标签、图像宽度、图像高度和填充值作为输入，并返回转换后的标签
        labels<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xywhn2xyxy</span><span class="token punctuation">(</span>labels<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> padw<span class="token punctuation">,</span> padh<span class="token punctuation">)</span>  
        
        # 使用xyn2xy 函数将分段从归一化的 xyn 格式转换为像素 xy 格式
        # 接受分段、图像宽度、图像高度和填充值作为输入，并返回转换后的分段
        segments <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token function">xyn2xy</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> padw<span class="token punctuation">,</span> padh<span class="token punctuation">)</span> <span class="token keyword">for</span> x in segments<span class="token punctuation">]</span>
        
    # 使用<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 将标签添加到 labels4 列表
    labels4<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>labels<span class="token punctuation">)</span>
    
    # 使用<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 将分段添加到 segments4 列表
    segments4<span class="token punctuation">.</span><span class="token function">extend</span><span class="token punctuation">(</span>segments<span class="token punctuation">)</span>
</code></pre> 
<p>  self.mosaic_border 是一个包含两个元素的元组，表示马赛克边界的 x 和 y 值。<br>   random.uniform(-x, 2 * s + x) 函数用于在给定范围内生成随机数。</p> 
<p>   对于第一个位置（即左上角），代码首先创建一个填充值为 114 的全新图像</p> 
<pre><code> img4 = np.full((s * 2, s * 2, img.shape[2]), 114, dtype=np.uint8)
</code></pre> 
<p>然后，它计算源图像和目标图像的坐标：</p> 
<pre><code>x1a, y1a, x2a, y2a = max(xc - w, 0), max(yc - h, 0), xc, yc
x1b, y1b, x2b, y2b = w - (x2a - x1a), h - (y2a - y1a), w, h
</code></pre> 
<p>其中 x1a, y1a, x2a, y2a 是目标图像（即马赛克图像）中要复制到的区域的坐标，而 x1b, y1b, x2b, y2b 是源图像中要复制的区域的坐标。</p> 
<pre><code class="prism language-c"># 使用np<span class="token punctuation">.</span><span class="token function">concatenate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 将labels4 列表中的标签连接起来
labels4 <span class="token operator">=</span> np<span class="token punctuation">.</span><span class="token function">concatenate</span><span class="token punctuation">(</span>labels4<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
# 坐标计算后可能越界，调整坐标值，使其都在大图中
<span class="token keyword">for</span> x <span class="token function">in</span> <span class="token punctuation">(</span>labels4<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">*</span>segments4<span class="token punctuation">)</span><span class="token operator">:</span>
	# 使用 np<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 对标签和分段进行裁剪
	# 确保它们的值在 <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> s<span class="token punctuation">]</span> 范围内
    np<span class="token punctuation">.</span><span class="token function">clip</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token operator">*</span> s<span class="token punctuation">,</span> out<span class="token operator">=</span>x<span class="token punctuation">)</span>  

# 使用<span class="token function">copy_paste</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 增强复制粘贴
# 接受马赛克图像、标签、分段和复制粘贴概率作为输入，并返回增强后的图像、标签和分段
img4<span class="token punctuation">,</span> labels4<span class="token punctuation">,</span> segments4 <span class="token operator">=</span> <span class="token function">copy_paste</span><span class="token punctuation">(</span>img4<span class="token punctuation">,</span> labels4<span class="token punctuation">,</span> segments4<span class="token punctuation">,</span> p<span class="token operator">=</span>self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token char">'copy_paste'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

# 使用<span class="token function">random_perspective</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 做随机透视变换增强。
# 接受马赛克图像、标签、分段和各种超参数作为输入，并返回增强后的图像和标签。
img4<span class="token punctuation">,</span> labels4 <span class="token operator">=</span> <span class="token function">random_perspective</span><span class="token punctuation">(</span>img4<span class="token punctuation">,</span>
                            labels4<span class="token punctuation">,</span>
                            segments4<span class="token punctuation">,</span>
                            degrees<span class="token operator">=</span>self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token char">'degrees'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            translate<span class="token operator">=</span>self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token char">'translate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            scale<span class="token operator">=</span>self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token char">'scale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            shear<span class="token operator">=</span>self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token char">'shear'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            perspective<span class="token operator">=</span>self<span class="token punctuation">.</span>hyp<span class="token punctuation">[</span><span class="token char">'perspective'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                            border<span class="token operator">=</span>self<span class="token punctuation">.</span>mosaic_border<span class="token punctuation">)</span>  # 边界 border 
# 返回增强后的马赛克图像和标签
<span class="token keyword">return</span> img4<span class="token punctuation">,</span> labels4
</code></pre> 
<h3><a id="22__mosaic___False_138"></a>2.2 不使用马赛克 mosaic == False</h3> 
<p>代码如下（示例）：</p> 
<pre><code class="prism language-c"> img<span class="token punctuation">,</span> <span class="token punctuation">(</span>h0<span class="token punctuation">,</span> w0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>h<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token operator">=</span> self<span class="token punctuation">.</span><span class="token function">load_image</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span>	# 加载图像
 shape <span class="token operator">=</span> self<span class="token punctuation">.</span>batch_shapes<span class="token punctuation">[</span>self<span class="token punctuation">.</span>batch<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">if</span> self<span class="token punctuation">.</span>rect <span class="token keyword">else</span> self<span class="token punctuation">.</span>img_size # final letterboxed shape
 img<span class="token punctuation">,</span> ratio<span class="token punctuation">,</span> pad <span class="token operator">=</span> <span class="token function">letterbox</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span> shape<span class="token punctuation">,</span> <span class="token keyword">auto</span><span class="token operator">=</span>False<span class="token punctuation">,</span> scaleup<span class="token operator">=</span>self<span class="token punctuation">.</span>augment<span class="token punctuation">)</span>
 shapes <span class="token operator">=</span> <span class="token punctuation">(</span>h0<span class="token punctuation">,</span> w0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>h <span class="token operator">/</span> h0<span class="token punctuation">,</span> w <span class="token operator">/</span> w0<span class="token punctuation">)</span><span class="token punctuation">,</span> pad<span class="token punctuation">)</span> # 计算图像的最终字母框形状 	

 labels <span class="token operator">=</span> self<span class="token punctuation">.</span>labels<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span><span class="token punctuation">)</span>	
 <span class="token keyword">if</span> labels<span class="token punctuation">.</span>size<span class="token operator">:</span> 	# 获取图像对应的标签
 	# 从归一化的 xywh 格式转换为像素 xyxy 格式<span class="token punctuation">.</span>通过调用 xywhn2xyxy 函数并使用缩放比例和填充值来实现
 	labels<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">xywhn2xyxy</span><span class="token punctuation">(</span>labels<span class="token punctuation">[</span><span class="token operator">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> ratio<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> w<span class="token punctuation">,</span> ratio<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> h<span class="token punctuation">,</span> padw<span class="token operator">=</span>pad<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> padh<span class="token operator">=</span>pad<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

 <span class="token keyword">if</span> self<span class="token punctuation">.</span>augment<span class="token operator">:</span>	# 是否数据增强
 	img<span class="token punctuation">,</span> labels <span class="token operator">=</span> <span class="token function">random_perspective</span><span class="token punctuation">(</span>img<span class="token punctuation">,</span>
	    labels<span class="token punctuation">,</span>
	    degrees<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token char">'degrees'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	    translate<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token char">'translate'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	    scale<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token char">'scale'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	    shear<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token char">'shear'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
	    perspective<span class="token operator">=</span>hyp<span class="token punctuation">[</span><span class="token char">'perspective'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>  使用 self.load_image(index) 方法加载图像，并获取图像的原始高度和宽度（h0 和 w0）以及调整后的高度和宽度（h 和 w）<br>    字母框形状（letterbox shape）是指将图像调整为特定形状时，通过在图像周围添加填充来保持图像的纵横比。这种方法类似于在电视上观看宽屏电影时，在画面的顶部和底部添加黑色条纹。<br>   使用 letterbox 函数将图像调整为该形状,letterbox 函数返回调整后的图像、缩放比例和填充值。<br>   random_perspective 函数来应用随机透视变换。此函数接受图像、标签和各种超参数作为输入，并返回增强后的图像和标签。</p> 
<hr> 
<h2><a id="_170"></a>总结</h2> 
<p>  使用__getitem__可以快速的将数据经行预处理,并拿到处理后的图像和标签</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/8505a86871592c2bfdab75dab0e5a568/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">vue首屏白屏原因及解决办法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/74b7e66955937fc6cd8377da0dbc8571/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Vue2粒子特效</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>