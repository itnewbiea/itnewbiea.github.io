<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>python post form data_Python发送form-data请求及拼接form-data内容的方法 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="python post form data_Python发送form-data请求及拼接form-data内容的方法" />
<meta property="og:description" content="import urllib2
boundary=&#39;-------------------------7df3069603d6&#39;
data=[]
data.append(&#39;--%s&#39; % boundary)
data.append(&#39;Content-Disposition: form-data; name=&#34;app_id&#34;\r\n&#39;)
data.append(&#39;xxxxxx&#39;)
data.append(&#39;--%s&#39; % boundary)
data.append(&#39;Content-Disposition: form-data; name=&#34;version&#34;\r\n&#39;)
data.append(&#39;xxxxx&#39;)
data.append(&#39;--%s&#39; % boundary)
data.append(&#39;Content-Disposition: form-data; name=&#34;platform&#34;\r\n&#39;)
data.append(&#39;xxxxx&#39;)
data.append(&#39;--%s&#39; % boundary)
data.append(&#39;Content-Disposition: form-data; name=&#34;libzip&#34;; filename=&#34;C:\Users\danwang3\Desktop\libmsc.zip&#34;&#39;)
data.append(&#39;Content-Type: application/octet-stream\r\n&#39;)
fr=open(&#39;C:\Users\danwang3\Desktop\libmsc.zip&#39;)
content=fr.read()
data.append(content)
print content
fr.close()
data.append(&#39;--%s--\r\n&#39;%boundary)
httpBody=&#39;\r\n&#39;.join(data)
print type(httpBody)
print httpBody
postDataUrl=&#39;http://xxxxxxxx&#39;
req=urllib2.Request(postDataUrl,data=httpBody)
经过测试，使用上述方法发送一段二进制文件的时候，服务器报错，数据有问题！
问题就出在 &#39;\r\n&#39;.join(data)的编码，data内部拥有二进制数据，通过这种编码，可能是把数据转换为utf-8格式，当然有问题。
搜索了很多资料，查到可以使用requests库提交multipart/form-data 格式的数据
一个multipart/form-data 的表单数据，在http里面抓包如下：
#Content-Disposition: form-data;name=&#34;app_id&#34;
123456
#-----------------------------7df23df2a0870
#Content-Disposition: form-data;name=&#34;version&#34;
2256
-----------------------------7df23df2a0870
Content-Disposition:form-data; name=&#34;platform&#34;
ios
-----------------------------7df23df2a0870
Content-Disposition: form-data;name=&#34;libzip&#34;;filename=&#34;C:\Users\danwang3\Desktop\libmsc.zip&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/28ce6129e052149c4596f997b9ffbe5f/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-12-03T08:04:32+08:00" />
<meta property="article:modified_time" content="2020-12-03T08:04:32+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">python post form data_Python发送form-data请求及拼接form-data内容的方法</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div style="font-size:16px;"> 
 <p>import urllib2</p> 
 <p>boundary='-------------------------7df3069603d6'</p> 
 <p>data=[]</p> 
 <p>data.append('--%s' % boundary)</p> 
 <p>data.append('Content-Disposition: form-data; name="app_id"\r\n')</p> 
 <p>data.append('xxxxxx')</p> 
 <p>data.append('--%s' % boundary)</p> 
 <p>data.append('Content-Disposition: form-data; name="version"\r\n')</p> 
 <p>data.append('xxxxx')</p> 
 <p>data.append('--%s' % boundary)</p> 
 <p>data.append('Content-Disposition: form-data; name="platform"\r\n')</p> 
 <p>data.append('xxxxx')</p> 
 <p>data.append('--%s' % boundary)</p> 
 <p>data.append('Content-Disposition: form-data; name="libzip"; filename="C:\Users\danwang3\Desktop\libmsc.zip"')</p> 
 <p>data.append('Content-Type: application/octet-stream\r\n')</p> 
 <p>fr=open('C:\Users\danwang3\Desktop\libmsc.zip')</p> 
 <p>content=fr.read()</p> 
 <p>data.append(content)</p> 
 <p>print content</p> 
 <p>fr.close()</p> 
 <p>data.append('--%s--\r\n'%boundary)</p> 
 <p>httpBody='\r\n'.join(data)</p> 
 <p>print type(httpBody)</p> 
 <p>print httpBody</p> 
 <p>postDataUrl='http://xxxxxxxx'</p> 
 <p>req=urllib2.Request(postDataUrl,data=httpBody)</p> 
 <p>经过测试，使用上述方法发送一段二进制文件的时候，服务器报错，数据有问题！</p> 
 <p>问题就出在 '\r\n'.join(data)的编码，data内部拥有二进制数据，通过这种编码，可能是把数据转换为utf-8格式，当然有问题。</p> 
 <p>搜索了很多资料，查到可以使用requests库提交multipart/form-data 格式的数据</p> 
 <p>一个multipart/form-data 的表单数据，在http里面抓包如下：</p> 
 <p>#Content-Disposition: form-data;name="app_id"</p> 
 <p>123456</p> 
 <p>#-----------------------------7df23df2a0870</p> 
 <p>#Content-Disposition: form-data;name="version"</p> 
 <p>2256</p> 
 <p>-----------------------------7df23df2a0870</p> 
 <p>Content-Disposition:form-data; name="platform"</p> 
 <p>ios</p> 
 <p>-----------------------------7df23df2a0870</p> 
 <p>Content-Disposition: form-data;name="libzip";filename="C:\Users\danwang3\Desktop\libmsc.zip"</p> 
 <p>Content-Type: application/x-zip-compressed</p> 
 <p>---------------------------7df23df2a0870—</p> 
 <p>上述数据在requests里面可以模拟为：</p> 
 <p>files={'app_id':(None,'123456'),</p> 
 <p>'version':(None,'2256'),</p> 
 <p>'platform':(None,'ios'),</p> 
 <p>'libzip':('libmsc.zip',open('C:\Users\danwang3\Desktop\libmsc.zip','rb'),'application/x-zip-compressed')</p> 
 <p>}</p> 
 <p>发送上述post请求，也就是简单的</p> 
 <p>response=requests.post(url,files=files)</p> 
 <p>就这么简单</p> 
 <p>在官方网站上，requests模拟一个表单数据的格式如下：</p> 
 <p>files = {'name': (, ,, )}</p> 
 <p>这一行模拟出来的post数据为：</p> 
 <p>Content-Disposition: form-data; name='name';filename=Content-Type: --boundary</p> 
 <p>如果filename 和 content-Type不写，那么响应模拟post的数据就不会有二者。</p> 
 <p>通常使用requests 不像使用urllib2那样可以自动管理cookie，不过如果获取到cookie</p> 
 <p>可以在requests请求里面一并将cookie发送出去</p> 
 <p>requests使用的cookie格式如下：</p> 
 <p>newCookie={}</p> 
 <p>newCookie['key1']='value1'</p> 
 <p>newCookie['key2]='value2'</p> 
 <p>newCookie['key3']='value3'</p> 
 <p>发送cookie可以使用：</p> 
 <p>response=requests.post(url,cookies=newCookie)</p> 
 <p>这样就可以了</p> 
 <p>拼接form-data的post内容</p> 
 <p>#!\urs\bin\env python</p> 
 <p>#encoding:utf-8 #设置编码方式</p> 
 <p>from http2 import http</p> 
 <p>import urllib</p> 
 <p>def ReadFileAsContent(filename):</p> 
 <p>#print filename</p> 
 <p>try:</p> 
 <p>with open(filename, 'rb') as f:</p> 
 <p>filecontent = f.read()</p> 
 <p>except Exception, e:</p> 
 <p>print 'The Error Message in ReadFileAsContent(): ' + e.message</p> 
 <p>return ''</p> 
 <p>return filecontent</p> 
 <p>def get_content_type(filename):</p> 
 <p>import mimetypes</p> 
 <p>return mimetypes.guess_type(filename)[0] or 'application/octet-stream'</p> 
 <p>def isfiledata(p_str):</p> 
 <p>import re</p> 
 <p>r_c = re.compile("^f'(.*)'$")</p> 
 <p>rert = r_c.search(str(p_str))</p> 
 <p>#rert = re.search("^f'(.*)'$", p_str)</p> 
 <p>if rert:</p> 
 <p>return rert.group(1)</p> 
 <p>else:</p> 
 <p>return None</p> 
 <p>def encode_multipart_formdata(fields):</p> 
 <p>'''''</p> 
 <p>该函数用于拼接multipart/form-data类型的http请求中body部分的内容</p> 
 <p>返回拼接好的body内容及Content-Type的头定义</p> 
 <p>'''</p> 
 <p>import random</p> 
 <p>import os</p> 
 <p>BOUNDARY = '----------%s' % ''.join(random.sample('0123456789abcdef', 15))</p> 
 <p>CRLF = '\r\n'</p> 
 <p>L = []</p> 
 <p>for (key, value) in fields:</p> 
 <p>filepath = isfiledata(value)</p> 
 <p>if filepath:</p> 
 <p>L.append('--' + BOUNDARY)</p> 
 <p>L.append('Content-Disposition: form-data; name="%s"; filename="%s"' % (key, os.path.basename(filepath)))</p> 
 <p>L.append('Content-Type: %s' % get_content_type(filepath))</p> 
 <p>L.append('')</p> 
 <p>L.append(ReadFileAsContent(filepath))</p> 
 <p>else:</p> 
 <p>L.append('--' + BOUNDARY)</p> 
 <p>L.append('Content-Disposition: form-data; name="%s"' % key)</p> 
 <p>L.append('')</p> 
 <p>L.append(value)</p> 
 <p>L.append('--' + BOUNDARY + '--')</p> 
 <p>L.append('')</p> 
 <p>body = CRLF.join(L)</p> 
 <p>content_type = 'multipart/form-data; boundary=%s' % BOUNDARY</p> 
 <p>return content_type, body</p> 
 <p>其中需要注意的是文件数据的字典值，其格式为f'/path/to/file'，具体调用的形式如下：</p> 
 <p>form_data = [('gShopID','489'),("addItems", r"f'D:\case3guomei.xml'"), ('validateString', '92c99a2a36f47c6aa2f0019caa0591d2')]</p> 
 <p>form_data_re = encode_multipart_formdata(form_data)</p> 
 <p>print form_data_re</p> 
 <p>返回的内容是一个元组，第一个参数是请求头中Content-Type的值，第二个是具体post的内容。然后使用httplib的post方法就可以发送了。</p> 
 <p align="center"><img src="" alt=""></p> 
 <p>本文原创发布php中文网，转载请注明出处，感谢您的尊重！</p> 
 <p>相关文章</p> 
 <p>相关视频</p> 
 <p>网友评论</p> 
 <p>文明上网理性发言，请遵守 新闻评论服务协议我要评论</p> 
 <p align="center"><img src="" alt=""></p> 
 <p>立即提交</p> 
 <p align="center">专题推荐<img src="" alt="">独孤九贱-php全栈开发教程</p> 
 <p>全栈 100W+</p> 
 <p>主讲：Peter-Zhu 轻松幽默、简短易学，非常适合PHP学习入门</p> 
 <p align="center"><img src="" alt="">玉女心经-web前端开发教程</p> 
 <p>入门 50W+</p> 
 <p>主讲：灭绝师太 由浅入深、明快简洁，非常适合前端学习入门</p> 
 <p align="center"><img src="" alt="">天龙八部-实战开发教程</p> 
 <p>实战 80W+</p> 
 <p>主讲：西门大官人 思路清晰、严谨规范，适合有一定web编程基础学习</p> 
 <p>php中文网：公益在线php培训，帮助PHP学习者快速成长！</p> 
 <p align="center">Copyright 2014-2020 https://www.php.cn/ All Rights Reserved | 苏ICP备2020058653号-1 <img src="" alt=""></p> 
 <p align="center"><img src="" alt="">  </p> 
 <p align="center"><img src="" alt=""></p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/7aa36ddacdeb3be91959bc624d622a0d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">小白刷题——整数反转</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/995122d19aaac73c876f5877ba9ba116/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Centos7安装mysql-mysql5.7.20-之默认密码修改-使用ALTER USER命令修改</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>