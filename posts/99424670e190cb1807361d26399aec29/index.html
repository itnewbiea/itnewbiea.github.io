<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android 虚拟机与类加载机制 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android 虚拟机与类加载机制" />
<meta property="og:description" content="1、Dalvik 虚拟机 Android 应用程序运行在 Dalvik/Art 虚拟机上，并且每一个应用程序都有一个单独的 Dalvik/Art 虚拟机实例。
1.1 JVM 与 Dalvik Dalvik 虚拟机也算是一个 Java 虚拟机，它是按照 JVM 虚拟机规范实现的，二者的特性差不多，不过还是有一些区别的：
执行的指令集不同：Java 虚拟机执行的是 class 文件，Dalvik 虚拟机执行的是 dex 文件Java 虚拟机的指令集基于堆栈，Dalvik 虚拟机的指令集基于寄存器JDK 1.8 默认垃圾回收器是 Parallel Scavenge（年轻代）&#43; ParallelOld（老年代），而 Dalvik 默认垃圾回收器是 CMS DEX(Dalvik Executable Format)是专为 Dalvik 设计的一种压缩格式，它是很多 class 文件处理压缩后的产物，最终可以在 Android 运行时环境执行。
基于栈的虚拟机 基于栈的虚拟机会给每一个运行的线程分配一个独立的栈（虚拟机栈，是 JVM 运行时数据区的五大组成部分之一）。栈中记录了方法调用的历史，每有一次方法调用，栈中便会多一个栈桢。最顶部的栈桢称作当前栈桢，代表当前执行的方法。基于栈的虚拟机通过操作数栈进行所有操作。示意图如下：
对于一段很简单的代码，可以通过查看字节码文件查看它的指令：
指令含义：
ICONST_1：将 int 类型常量 1 压入操作数栈位置 1ISTORE0：将栈顶 int 类型值存入局部变量表位置 0。test() 是一个静态方法，因此局部变量表就不用把位置 0 预留出来保存 thisIADD：执行 int 类型的加法 这些指令的执行过程图如下：
基于寄存器的虚拟机 寄存器是 CPU 的组成部分，是有限存储容量的高速存储部件，它们可用来暂存指令、数据和地址。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/99424670e190cb1807361d26399aec29/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-26T21:35:02+08:00" />
<meta property="article:modified_time" content="2023-11-26T21:35:02+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android 虚拟机与类加载机制</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="1Dalvik__0"></a>1、Dalvik 虚拟机</h2> 
<p>Android 应用程序运行在 Dalvik/Art 虚拟机上，并且每一个应用程序都有一个单独的 Dalvik/Art 虚拟机实例。</p> 
<h3><a id="11_JVM__Dalvik_4"></a>1.1 JVM 与 Dalvik</h3> 
<p>Dalvik 虚拟机也算是一个 Java 虚拟机，它是按照 JVM 虚拟机规范实现的，二者的特性差不多，不过还是有一些区别的：</p> 
<ol><li>执行的指令集不同：Java 虚拟机执行的是 class 文件，Dalvik 虚拟机执行的是 dex 文件</li><li>Java 虚拟机的指令集基于堆栈，Dalvik 虚拟机的指令集基于寄存器</li><li>JDK 1.8 默认垃圾回收器是 Parallel Scavenge（年轻代）+ ParallelOld（老年代），而 Dalvik 默认垃圾回收器是 CMS</li></ol> 
<p><img src="https://images2.imgbox.com/ad/5b/SlgYwLEO_o.png" alt="两个虚拟机对比"></p> 
<blockquote> 
 <p>DEX(Dalvik Executable Format)是专为 Dalvik 设计的一种压缩格式，它是很多 class 文件处理压缩后的产物，最终可以在 Android 运行时环境执行。</p> 
</blockquote> 
<h4><a id="_16"></a>基于栈的虚拟机</h4> 
<p>基于栈的虚拟机会给每一个运行的线程分配一个独立的栈（虚拟机栈，是 JVM 运行时数据区的五大组成部分之一）。栈中记录了方法调用的历史，每有一次方法调用，栈中便会多一个栈桢。最顶部的栈桢称作当前栈桢，代表当前执行的方法。基于栈的虚拟机通过操作数栈进行所有操作。示意图如下：</p> 
<p><img src="https://images2.imgbox.com/99/aa/2f0lLb34_o.png" alt="虚拟机栈示意图"></p> 
<p>对于一段很简单的代码，可以通过查看字节码文件查看它的指令：</p> 
<p><img src="https://images2.imgbox.com/ab/64/ONRBtwxi_o.png" alt="源代码与字节码"></p> 
<p>指令含义：</p> 
<ul><li>ICONST_1：将 int 类型常量 1 压入操作数栈位置 1</li><li>ISTORE0：将栈顶 int 类型值存入局部变量表位置 0。test() 是一个静态方法，因此局部变量表就不用把位置 0 预留出来保存 this</li><li>IADD：执行 int 类型的加法</li></ul> 
<p>这些指令的执行过程图如下：</p> 
<p><img src="https://images2.imgbox.com/17/9e/D5GI2cRo_o.gif" alt="指令执行过程"></p> 
<h4><a id="_36"></a>基于寄存器的虚拟机</h4> 
<p>寄存器是 CPU 的组成部分，是有限存储容量的高速存储部件，它们可用来暂存指令、数据和地址。</p> 
<p><img src="https://images2.imgbox.com/88/31/tq553UJP_o.png" alt="寄存器结构示意图"></p> 
<p>上图是寄存器的简化结构，运行步骤如下：</p> 
<ul><li>从程序计数器指定的位置取出指令放到指令寄存器中</li><li>根据指令内容 LOADA,100 从内存地址 100 取出数据放到数据寄存器 AX 中</li><li>上一条指令执行完毕，程序计数器 +1，再从头循环上述过程。直到执行完 STOREC,108 将计算结果保存到内存地址 108 处</li></ul> 
<p>基于寄存器的虚拟机，实际上是为了模拟上述的工作流程，而不是真正的在物理上使用了 CPU 中的寄存器来完成上述工作的。</p> 
<p>基于寄存器的虚拟机中没有操作数栈和局部变量表，但是有很多虚拟寄存器（理解成用寄存器代替了操作数栈和局部变量表吧）。其实和操作数栈相同，这些寄存器也存放在运行时栈中，本质上就是一个数组。与 JVM 相似，在 DalvikVM 中每个线程都有自己的 PC 和调用栈，方法调用的活动记录以帧为单位保存在调用栈上。</p> 
<p><img src="https://images2.imgbox.com/d2/df/Ure7NXJB_o.gif" alt="基于寄存器的虚拟机执行字节码过程"></p> 
<p><img src="https://images2.imgbox.com/0d/a0/5jXcm7De_o.png" alt="栈式虚拟机vs寄存器式虚拟机"></p> 
<p>与 JVM 相比，可以发现 DalvikVM 的指令数明显减少了，数据移动次数也明显减少了（没有了在操作数栈和局部变量表之间的移动）。</p> 
<h3><a id="12_ART__Dalvik_58"></a>1.2 ART 与 Dalvik</h3> 
<p>Dalvik 虚拟机执行的是 dex 字节码，解释执行。从 Android 2.2 版本开始，支持 <strong>JIT 即时编译（JustInTime）</strong>。JIT 是指在程序运行的过程中会选择热点代码（经常执行的代码）进行编译或者优化。</p> 
<p>而 ART（Android Runtime）是在 Android 4.4 中引入的一个开发者选项，也是 Android 5.0 及更高版本的默认 Android 运行时。ART 虚拟机执行的是本地机器码。Android 的运行时从 Dalvik 虚拟机替换成 ART 虚拟机，并不要求开发者将自己的应用直接编译成目标机器码，APK 仍然是一个包含 dex 字节码的文件。</p> 
<p>ART 虚拟机执行的本地机器码是安装的时候预编译产生的。</p> 
<p>Dalvik 下安装应用时，会将 dex 字节码文件优化生成 odex 文件；ART 引入了<strong>预先编译机制（AheadOfTime）</strong>，即在安装时，ART 使用设备自带的 dex2oat 工具来编译应用，<strong>dex 中的字节码将被编译成本地机器码</strong>。进行 AOT 最恰当的时机也是在安装应用的时候。</p> 
<p><img src="https://images2.imgbox.com/fb/76/ZiAg2TbE_o.png" alt=""></p> 
<p>通过上图可以看出两个虚拟机对 dex 文件不同的处理方式：</p> 
<ul><li>Dalvik 虚拟机进行 dexopt 操作，在加载一个 dex 文件时，对 dex 文件进行验证和优化的操作，其对 dex 文件的优化结果变成了 odex(Optimizeddex)文件，这个文件和 dex 文件很像，只是使用了一些优化操作码。</li><li>ART 虚拟机进行 dex2oat 操作，采用预先编译机制，在安装时对 dex 文件执行 AOT 提前编译操作，编译为 ART 可执行的 elf 文件（机器码）。</li></ul> 
<blockquote> 
 <p>预先编译机制 AOT 是和即时编译 JIT 相对应的概念。</p> 
</blockquote> 
<h3><a id="13_Art__77"></a>1.3 Art 虚拟机的优化</h3> 
<p>Android 从最初的版本使用的是 Dalvik 虚拟机，在 2.2 版本加入了 JIT。而 Art 虚拟机在 4.4 版本是一个开发者选项，从 5.0 版本开始作为默认使用的虚拟机。</p> 
<p>由于 Art 虚拟机在安装应用时会使用 AOT 的预编译，因此 5.x 和 6.x 版本在安装应用时会比原来慢，为了解决这个问题又在 7.0 时做了改进，混合使用 AOT 编译、解释和 JIT：</p> 
<ol><li>最初安装应用时不进行任何 AOT 编译（安装又快了），运行过程中解释执行，对经常执行的方法进行 JIT，经过 JIT 编译的方法将会记录到 Profile 配置文件中</li><li>当设备闲置和充电时，编译守护进程会运行，根据 Profile 文件对常用代码进行 AOT 编译。待下次运行时（下一次启动时）直接使用</li></ol> 
<p><img src="https://images2.imgbox.com/68/87/jHykwKBQ_o.png" alt="Art优化后的工作方式"></p> 
<p>在读取 base.odex 文件执行代码时，会对经常执行的方法做 JIT 处理，放到 Profile 配置文件中，这是图中 collect 的过程；然后在设备闲置和充电时，通过 get profile 拿到这些配置文件，在 BackgroundDexOptService（这是一个 JobService）内运行 dex2oat 工具得到 base.art 文件。</p> 
<p>当应用下次运行时，去看 /data/app 目录下是否有 base.art 这个文件，如果有，就用 ClassLoader 把这个文件中的类加载进内存，以后可以执行机器码了，这样就不用再去找 base.odex 文件以解释方式执行代码了。</p> 
<h2><a id="2ClassLoader_92"></a>2、ClassLoader</h2> 
<p>任何一个 Java 程序都是由一个或多个 class 文件组成，在程序运行时，需要将 class 文件加载到 JVM 中才可以使用，负责加载这些 class 文件的就是 Java 的类加载器 ClassLoader。ClassLoader 的作用简单来说就是加载 class 文件，提供给程序运行时使用。每个 Class 对象的内部都有一个 classLoader 字段来标识自己是由哪个 ClassLoader 加载的：</p> 
<pre><code class="prism language-java"><span class="token keyword">class</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">private</span> <span class="token keyword">transient</span> <span class="token class-name">ClassLoader</span> classLoader<span class="token punctuation">;</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
</code></pre> 
<p>ClassLoader 是一个抽象类，而它在 Android 中的具体子类主要有：</p> 
<ul><li>BootClassLoader：用于加载 Android Framework 层 class 文件。</li><li>PathClassLoader：用于 Android 应用程序类加载器。可以加载指定的 dex，以及 jar、zip、apk 中的 classes.dex。</li><li>DexClassLoader：用于加载指定的 dex，以及 jar、zip、apk 中的 classes.dex。</li></ul> 
<p>用代码进行一下测试：</p> 
<pre><code class="prism language-java">    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"Activity.class 由: "</span> <span class="token operator">+</span> <span class="token class-name">Activity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 加载"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"MainActivity.class 由: "</span> <span class="token operator">+</span> <span class="token class-name">MainActivity</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 加载"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Log</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token string">"String.class 由: "</span> <span class="token operator">+</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" 加载"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>输出为：</p> 
<pre><code>D/MainActivity: Activity.class 由: java.lang.BootClassLoader@5052f32 加载
D/MainActivity: MainActivity.class 由: dalvik.system.PathClassLoader[DexPathList[[zip file "/data/app/com.example.myapplication-x6QX4W6vcSz6MxKY4vpW2w==/base.apk", dex file "/data/user/0/com.example.myapplication/app_fake_apk/app/classes.dex"],nativeLibraryDirectories=[/data/app/com.example.myapplication-x6QX4W6vcSz6MxKY4vpW2w==/lib/x86, /system/lib]]] 加载
D/MainActivity: String.class 由: java.lang.BootClassLoader@5052f32 加载
</code></pre> 
<p>MainActivity 继承自 AppCompatActivity，而 AppCompatActivity 是官方提供的第三方库中的类，不算是系统文件，因此它是被 PathClassLoader 加载的。</p> 
<blockquote> 
 <p>一些博客里说 PathClassLoader 只能加载已安装的 apk 的 dex，其实这说的应该是在 Dalvik 虚拟机上，但现在一般不用关心 Dalvik 了。</p> 
</blockquote> 
<p><img src="https://images2.imgbox.com/ec/9b/tWGsKuge_o.png" alt="ClassLoader关系图"></p> 
<h3><a id="21_PathClassLoader_128"></a>2.1 PathClassLoader</h3> 
<p>ClassLoader 的任务就是把 class 文件读取成 byte[] 然后再转换成 Class 对象，像我们平时自己做的应用中的 class 文件都是通过 PathClassLoader 进行加载的，下面结合源码来看看具体是怎么做的。</p> 
<h4><a id="loadClass_132"></a>loadClass()</h4> 
<p>类加载器都是通过 ClassLoader 的 loadClass() 去加载一个类的，那么去 PathClassLoader 中查看：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PathClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseDexClassLoader</span> <span class="token punctuation">{<!-- --></span>
    
    <span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>PathClassLoader 中没有 loadClass()，去父类 BaseDexClassLoader 中找，也没有，再向上找到抽象父类 ClassLoader：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">// 当前ClassLoader对象的父ClassLoader</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 1.找缓存，如果该类已经被加载过，直接从缓存中取。</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 2.调用父加载器（注意不是父类加载器）的loadClass()</span>
                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">// 看源码就是直接 return null（与Java不同）。</span>
                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// ClassNotFoundException thrown if class not found</span>
                    <span class="token comment">// from the non-null parent class loader</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 3.如果前面两次都没找到要加载的类，通过自己的findClass()再找一次。</span>
                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们看到 loadClass() 主要做了三件事：</p> 
<ol><li>先通过 findLoadedClass() 去找缓存，看看 name 所对应的类是否在之前被加载过，如果是，就可以直接作为返回结果了，否则就继续向下执行。</li><li>倘若缓存未命中，先让自己的父加载器通过其 loadClass() 去加载这个类，如果加载成功也就直接作为返回结果，否则执行下一步。需要注意的是，父加载器并不是指父类，与当前 ClassLoader 并不存在继承关系。</li><li>上一步加载失败后，就只能通过当前 ClassLoader 的 findClass() 去加载 name 对应的类了。</li></ol> 
<p>关于第二点的父加载器我们再多说一点。在创建 PathClassLoader 对象时，其构造方法要求传入一个 ClassLoader，就是父加载器 parent：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>这个 parent 的类型不必是 PathClassLoader 的父类，即父加载器类型不必是当前类加载器的父类。</p> 
<p>这一点在源码中也有所印证，创建系统使用的 PathClassLoader 对象时，传的 parent 是一个 BootClassLoader 实例。在 ActivityThread 的 handleBindApplication() 进行 Application 绑定时，会获取 Application Context 的 ClassLoader：</p> 
<pre><code class="prism language-java">	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">handleBindApplication</span><span class="token punctuation">(</span><span class="token class-name">AppBindData</span> data<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">// Continue loading instrumentation.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ii <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token function">initInstrumentation</span><span class="token punctuation">(</span>ii<span class="token punctuation">,</span> data<span class="token punctuation">,</span> appContext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            mInstrumentation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Instrumentation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentation<span class="token punctuation">.</span><span class="token function">basicInit</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">initInstrumentation</span><span class="token punctuation">(</span>
            <span class="token class-name">InstrumentationInfo</span> ii<span class="token punctuation">,</span> <span class="token class-name">AppBindData</span> data<span class="token punctuation">,</span> <span class="token class-name">ContextImpl</span> appContext<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">final</span> <span class="token class-name">ContextImpl</span> instrContext <span class="token operator">=</span> <span class="token class-name">ContextImpl</span><span class="token punctuation">.</span><span class="token function">createAppContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> pi<span class="token punctuation">,</span>
                appContext<span class="token punctuation">.</span><span class="token function">getOpPackageName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 获取 App Context 的 ClassLoader</span>
            <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> instrContext<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mInstrumentation <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Instrumentation</span><span class="token punctuation">)</span>
                    cl<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>instrumentationName<span class="token punctuation">.</span><span class="token function">getClassName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>
                    <span class="token string">"Unable to instantiate instrumentation "</span>
                            <span class="token operator">+</span> data<span class="token punctuation">.</span>instrumentationName <span class="token operator">+</span> <span class="token string">": "</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>  
</code></pre> 
<p>ContextImpl 的 getClassLoader() 会根据条件获取 ClassLoader 对象：</p> 
<pre><code class="prism language-java">	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ClassLoader</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> mClassLoader <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mClassLoader <span class="token operator">:</span> <span class="token punctuation">(</span>mPackageInfo <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> mPackageInfo<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>我们看保底的由系统提供的 ClassLoader：</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> <span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">SystemClassLoader</span><span class="token punctuation">.</span>loader<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">static</span> <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SystemClassLoader</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> loader <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">createSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ClassLoader</span> <span class="token function">createSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.class.path"</span><span class="token punctuation">,</span> <span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> librarySearchPath <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.library.path"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建 PathClassLoader，并指定其父加载器是 BootClassLoader</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">BootClassLoader</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>PathClassLoader 的父类是 BaseDexClassLoader，而系统为 PathClassLoader 指定的父加载器是 BootClassLoader。</p> 
<h4><a id="_274"></a>双亲委托机制</h4> 
<p>回到 ClassLoader 的 loadClass()，可以看出对于任意一个 ClassLoader，它想要加载 class 文件时，都是先去找它的父加载器去 loadClass()，这就是我们常说的<code>双亲委托机制</code>：</p> 
<blockquote> 
 <p>某个类加载器在加载类时，首先将加载任务委托给父加载器，依次递归，如果父加载器可以完成类加载任务，就成功返回；只有父加载器无法完成此加载任务或者没有父类加载器时，才自己去加载。</p> 
</blockquote> 
<p>使用双亲委托机制的原因是：</p> 
<ol><li>避免重复加载，当父加载器已经加载了该类的时候，就没有必要子 ClassLoader 再加载一次，直接去父加载器的缓存中拿就可以了。</li><li>安全性考虑，防止核心 API 库被随意篡改。</li></ol> 
<p>对于第二点，需要解释一下。比如说，没有采取双亲委托机制，即代码变成这样：</p> 
<pre><code class="prism language-java">    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span>
        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span>
    <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 找缓存，如果该类已经被加载过，直接从缓存中取。</span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>缓存中没有直接就在该 ClassLoader 对象中自己用 findClass() 去找这个类，那么假如我写一个跟系统全类名相同的类 java.lang.String，findClass() 在加载的时候就会加载到我们自己写的 java.lang.String 类，使得系统类被篡改，引发安全问题。</p> 
<p>反过来说，使用了双亲委托，那么总是 BootClassLoader 先去加载系统里边的类，相当于加了一层拦截，将篡改系统代码的隐患给拦截掉了。</p> 
<h4><a id="findClass_304"></a>findClass()</h4> 
<p>最后看到 findClass()，它在抽象基类 ClassLoader 中是一个未实现的方法：</p> 
<pre><code class="prism language-java">    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>所以就得看子类实现了，BaseDexClassLoader 重写了该方法：</p> 
<pre><code class="prism language-java">    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DexPathList</span> pathList<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">BaseDexClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span>
            <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 实例化 pathList，传入了 dex 文件的路径 dexPath</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pathList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexPathList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> dexPath<span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> isTrusted<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> suppressedExceptions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span> c <span class="token operator">=</span> pathList<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> suppressedExceptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// c 的判空处理，省略...</span>
        <span class="token keyword">return</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>在看 DexPathList 的 findClass() 之前，先看它的构造方法，会实例化一个非常重要的成员变量 dexElements：</p> 
<pre><code class="prism language-java"><span class="token operator">/</span>libcore<span class="token operator">/</span>dalvik<span class="token operator">/</span>src<span class="token operator">/</span>main<span class="token operator">/</span>java<span class="token operator">/</span>dalvik<span class="token operator">/</span>system<span class="token operator">/</span><span class="token class-name">DexPathList</span><span class="token punctuation">.</span>java：

    <span class="token keyword">private</span> <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dexElements<span class="token punctuation">;</span>
    
    <span class="token class-name">DexPathList</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> definingContext<span class="token punctuation">,</span> <span class="token class-name">String</span> dexPath<span class="token punctuation">,</span>
            <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token comment">// save dexPath for BaseDexClassLoader</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>dexElements <span class="token operator">=</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token function">splitDexPath</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">)</span><span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span>
                                           suppressedExceptions<span class="token punctuation">,</span> definingContext<span class="token punctuation">,</span> isTrusted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">// dexPath 是 dex 文件的路径，它可以是多个 dex 文件，形式为 /a/a\.dex;/a/b.dex</span>
	<span class="token comment">// 该方法会将 searchPath 中的所有文件路径分离，并创建出文件对象装入 List&lt;File&gt; 中。</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> <span class="token function">splitPaths</span><span class="token punctuation">(</span><span class="token class-name">String</span> searchPath<span class="token punctuation">,</span> <span class="token keyword">boolean</span> directoriesOnly<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>searchPath <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// File.pathSeparator是分号; 而File.separator是反斜杠\</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> path <span class="token operator">:</span> searchPath<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token class-name">File</span><span class="token punctuation">.</span>pathSeparator<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                result<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

	<span class="token comment">// 遍历 List&lt;File&gt;，将 File 封装成 DexFile 后再封装成 Element，存入 Element[]</span>
	<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">makeDexElements</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> files<span class="token punctuation">,</span> <span class="token class-name">File</span> optimizedDirectory<span class="token punctuation">,</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">IOException</span><span class="token punctuation">&gt;</span></span> suppressedExceptions<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Element</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">[</span>files<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> elementsPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> files<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token comment">// We support directories for looking up resources. Looking up resources in</span>
              <span class="token comment">// directories is useful for running libcore tests.</span>
              elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">String</span> name <span class="token operator">=</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

              <span class="token class-name">DexFile</span> dex <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token constant">DEX_SUFFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token comment">// Raw dex file (not inside a zip/jar).</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token comment">// 将普通的 file 文件封装成 DexFile 对象</span>
                      dex <span class="token operator">=</span> <span class="token function">loadDexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                          elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>dex<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                      <span class="token punctuation">}</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                      dex <span class="token operator">=</span> <span class="token function">loadDexFile</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> optimizedDirectory<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> elements<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      suppressedExceptions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>

                  <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                      elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                      elements<span class="token punctuation">[</span>elementsPos<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Element</span><span class="token punctuation">(</span>dex<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>dex <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> isTrusted<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                dex<span class="token punctuation">.</span><span class="token function">setTrusted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">logW</span><span class="token punctuation">(</span><span class="token string">"ClassLoader referenced unknown path: "</span> <span class="token operator">+</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>elementsPos <span class="token operator">!=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          elements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> elementsPos<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> elements<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>dexElements 是一个 Element 数组，而 Element 内封装着 DexFile 对象。然后我们再来看 DexPathList 的 findClass()：</p> 
<pre><code class="prism language-java">	<span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// dexElements 是一个 Element[]，查找类的工作会再次转交给 Element</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Element</span> element <span class="token operator">:</span> dexElements<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz <span class="token operator">=</span> element<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> definingContext<span class="token punctuation">,</span> suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>clazz <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">return</span> clazz<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Element</span> <span class="token punctuation">{<!-- --></span>
        
        <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">DexFile</span> dexFile<span class="token punctuation">;</span>
        
        <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> definingContext<span class="token punctuation">,</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 最终是由 DexFile 的 loadClassBinaryName() 做类的加载</span>
            <span class="token keyword">return</span> dexFile <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> dexFile<span class="token punctuation">.</span><span class="token function">loadClassBinaryName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> definingContext<span class="token punctuation">,</span> suppressed<span class="token punctuation">)</span>
                    <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>通过 Element 内封装的 DexFile 的 loadClassBinaryName() 调用 native 方法 defineClassNative() 完成类的加载：</p> 
<pre><code class="prism language-java"><span class="token operator">/</span>libcore<span class="token operator">/</span>dalvik<span class="token operator">/</span>src<span class="token operator">/</span>main<span class="token operator">/</span>java<span class="token operator">/</span>dalvik<span class="token operator">/</span>system<span class="token operator">/</span><span class="token class-name">DexFile</span><span class="token punctuation">.</span>java：
    
    <span class="token keyword">public</span> <span class="token class-name">Class</span> <span class="token function">loadClassBinaryName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> mCookie<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">,</span> suppressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Class</span> <span class="token function">defineClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Object</span> cookie<span class="token punctuation">,</span>
                                     <span class="token class-name">DexFile</span> dexFile<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Throwable</span><span class="token punctuation">&gt;</span></span> suppressed<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Class</span> result <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            result <span class="token operator">=</span> <span class="token function">defineClassNative</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> loader<span class="token punctuation">,</span> cookie<span class="token punctuation">,</span> dexFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoClassDefFoundError</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>suppressed <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                suppressed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>suppressed <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                suppressed<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
	<span class="token comment">// native 方法调用的是 /art/runtime/native/dalvik_system_DexFile.cc 中的 DexFile_defineClassNative()</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">native</span> <span class="token class-name">Class</span> <span class="token function">defineClassNative</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Object</span> cookie<span class="token punctuation">,</span>
                                                  <span class="token class-name">DexFile</span> dexFile<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">NoClassDefFoundError</span><span class="token punctuation">;</span>
</code></pre> 
<p>整个流程下来，大致是 ClassLoader 持有一个 DexPathList 对象，DexPathList 内维护着一个 Element[]，每个 Element 内都封装着一个 DexFile 可以用来加载对应的 dex 文件。时序图如下：</p> 
<p><img src="https://images2.imgbox.com/34/9a/dtP7T2XF_o.png" alt="类加载时序图"></p> 
<h3><a id="22_DexClassLoader_484"></a>2.2 DexClassLoader</h3> 
<p>PathClassLoader 与 DexClassLoader 具有共同父类 BaseDexClassLoader：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DexClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseDexClassLoader</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> optimizedDirectory<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>optimizedDirectory<span class="token punctuation">)</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PathClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">BaseDexClassLoader</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>可以看到两者唯一的区别在于：创建 DexClassLoader 需要传递一个 optimizedDirectory 参数，并且会将其创建为 File 对象传给 super，而 PathClassLoader 则直接给该参数传 null。因此两者都可以加载指定的 dex，以及 jar、zip、apk 中的 classes.dex：</p> 
<pre><code class="prism language-java">    <span class="token class-name">PathClassLoader</span> pathClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PathClassLoader</span><span class="token punctuation">(</span><span class="token string">"/sdcard/xx.dex"</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">File</span> dexOutputDir <span class="token operator">=</span> context<span class="token punctuation">.</span><span class="token function">getCodeCacheDir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">DexClassLoader</span> dexClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span><span class="token string">"/sdcard/xx.dex"</span><span class="token punctuation">,</span> dexOutputDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>其实，optimizedDirectory 参数就是 dexopt 产出 odex 的目录。那 PathClassLoader 创建时，这个目录为 null，是否意味着不进行 dexopt？并不是，optimizedDirectory 为 null 时的默认路径为：/data/dalvik-cache。</p> 
<p>在 API 26 源码中，将 DexClassLoader 的 optimizedDirectory 标记为了 deprecated 弃用，实现也变为了：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">DexClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> dexPath<span class="token punctuation">,</span> <span class="token class-name">String</span> optimizedDirectory<span class="token punctuation">,</span> <span class="token class-name">String</span> librarySearchPath<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">super</span><span class="token punctuation">(</span>dexPath<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> librarySearchPath<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>和 PathClassLoader 别无二致。</p> 
<h2><a id="3_526"></a>3、热修复原理简述</h2> 
<p>ClassLoader 的一个典型应用是热修复，简单说下原理。</p> 
<p>首先基于 ClassLoader 加载类过程的分析，找该 ClassLoader 缓存 -&gt; 让父 ClassLoader 加载 -&gt; 该 ClassLoader 自己加载 dex 文件，如果想要实现热修复，那么前两步是无法实现的，也就是说你需要在第一次加载 dex 文件时就把需要做热修复的 dex 文件（以下称补丁 dex）加载进内存。</p> 
<p>而在如何加载补丁 dex 的问题上，可以先看下图：</p> 
<p><img src="https://images2.imgbox.com/2e/8c/Ei4nSGOB_o.png" alt=""></p> 
<p>由于使用双亲委托机制加载类，两个全类名相同的类，先被加载的那个会进入内存变成 Class 对象，而后被遍历到的 dex 文件中的类就不会被加载。</p> 
<p>再加上 ClassLoader 遍历 Element 数组时是按照数组角标顺序由小到大遍历的，那么我们可以通过反射，把带有需要热修复的类的 Patch.dex 文件放到 Element 数组的最前面，然后让 ClassLoader 先加载 Patch.dex 中的类，就可以实现热修复了。</p> 
<p>以上是实现思路，实现过程可以这样安排：</p> 
<ul><li>获取到当前应用的 PathClassLoader</li><li>反射获取到 DexPathList 的成员 pathList</li><li>反射修改 pathList 的 dexElements： 
  <ol><li>把补丁包的 patch.dex 转化为 Element[]</li><li>获得 pathList 的 dexElements 属性</li><li>patch+old 合并，并反射赋值给 pathList 的 dexElements</li></ol> </li></ul> 
<p>如果对热修复感兴趣可以参考这篇文章 <a href="https://blog.csdn.net/tmacfrank/article/details/124797408">Android 热修复</a>。</p> 
<p>参考资料：</p> 
<p><a href="https://source.android.google.cn/devices/tech/dalvik?hl=zh_cn" rel="nofollow">AndroidRuntime(ART)和Dalvik</a></p> 
<p><a href="http://www.elecfans.com/emb/20190402898842.html" rel="nofollow">AndroidN混合使用AOT编译，解释和JIT三种运行时</a></p> 
<p><a href="https://www.jianshu.com/p/94255cb157f6" rel="nofollow">Android 9.0 ART编译分析（二）-Installd触发dex2oat编译流程</a></p> 
<p><a href="https://www.jianshu.com/p/c3e904dd3a70" rel="nofollow">系统ClassLoader相关及Application初始化简单分析及总结 </a></p> 
<p><a href="https://blog.csdn.net/zhangshuny/article/details/106877259">为什么PathClassLoader的父加载器(parent)是BootClassLoader？</a></p> 
<p><a href="https://www.jianshu.com/p/a620e368389a" rel="nofollow">Android动态加载之ClassLoader详解</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9ecd3c9c24045a795ee5f4ec94b522a1/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何解决Java应用程序的Jar包冲突问题，看这一篇就够了</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/80ce70ae4df9527371ce277f70fa39b7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">67_Pandas将切片应用于字符串，以提取任意位置和长度的部分</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>