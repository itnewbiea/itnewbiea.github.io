<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Android客户端网络DNS优化实践 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Android客户端网络DNS优化实践" />
<meta property="og:description" content="App网络优化是体验中很重要的一部分, 最近做了一些网络优化相关的工作, 想把最近的工作总结一下;
1. 分析app网络现状: 通过对最新版本最近一周的网络数据统计, 网络错误率中各项占比:
未知主机: 1.33%
请求超时: 0.33%
SSL证书错误: 0.13%
建立连接失败: 0.23%
平均网络请求响应时间:
1237ms 从数据看, 最高的网络错误来自于未知主机, 请求响应时长偏高;
然后通过各种更多维度的数据查看发现, 总结出了下面几个问题:
慢请求中有很多是DNS时间超长, 最长的有几百秒错误请求中, DNS错误占比最高 当然,还有其他一些错误和响应时长的问题, 比如http错误, 需要通过错误码从业务方面解决; 请求连接时长,传输和处理时长, 这些可以通过服务端优化;本次哇们主要做的是DNS相关的优化
2.DNS如何优化 2.1 关于DNS原理简单介绍: 关于DNS的相关介绍:https://www.51cto.com/article/674906.html
传统的DNS解析:
当开始 DNS 解析的时候，如果 LocalDNS 没有缓存，那就会向 LocalDNS 服务器请求（通常就是运营商），如果还是没有，就会一级一级的，从根域名查对应的顶级域名，再从顶级域名查权威域名服务器，最后通过权威域名服务器，获取具体域名对应的 IP 地址。
传统DNS缺点: 不稳定(DNS服务器被劫持或故障), 访问慢
2.2 传统DNS替代 使用HttpDNS解析:
HttpDNS其实也是对DNS解析的另一种实现方式，只是将域名解析的协议由DNS协议换成了Http协议，并不复杂。使用HTTP协议向D&#43;服务器的80端口进行请求，代替传统的DNS协议向DNS服务器的53端口进行请求，绕开了运营商的Local DNS，从而避免了使用运营商Local DNS造成的劫持和跨网问题;
HttpDNS核心是需要稳定且速度快的DNS服务器, 一般都是需要收费的; 目前有阿里DNS,腾讯云DNS等选择; (我没有尝试过收费的); 免费的有开源的七牛sdk, 需要自己配置服务器与连接方式;
七牛开源地址: https://github.com/qiniu/happy-dns-android DnsManager dns; if(DnsManager.needHttpDns()){ IResolver[] resolvers = new IResolver[2]; // dohResolver 需要配置一个支持 Doh(Dns over http) 协议的 url resolvers[0] = new DnhResolver(&#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/96c34affd707e6ffb7731d421b2e3277/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-10-25T17:18:59+08:00" />
<meta property="article:modified_time" content="2022-10-25T17:18:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Android客户端网络DNS优化实践</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>App网络优化是体验中很重要的一部分, 最近做了一些网络优化相关的工作, 想把最近的工作总结一下;</p> 
<p></p> 
<h3>1. 分析app网络现状: </h3> 
<p>通过对最新版本最近一周的网络数据统计, </p> 
<p><strong>网络错误率中各项占比:</strong></p> 
<ul><li> <p>未知主机: 1.33%</p> </li></ul> 
<ul><li> <p>请求超时: 0.33%</p> </li></ul> 
<ul><li> <p>SSL证书错误: 0.13%</p> </li></ul> 
<ul><li> <p>建立连接失败: 0.23%</p> </li></ul> 
<p><strong>平均网络请求响应时间:</strong></p> 
<ul><li>1237ms</li></ul> 
<p>从数据看, 最高的网络错误来自于未知主机, 请求响应时长偏高;</p> 
<p></p> 
<p>然后通过各种更多维度的数据查看发现, 总结出了下面几个问题:</p> 
<ul><li>慢请求中有很多是DNS时间超长, 最长的有几百秒</li><li>错误请求中, DNS错误占比最高</li></ul> 
<blockquote> 
 <p>当然,还有其他一些错误和响应时长的问题, 比如http错误, 需要通过错误码从业务方面解决; 请求连接时长,传输和处理时长, 这些可以通过服务端优化;本次哇们主要做的是DNS相关的优化</p> 
</blockquote> 
<h3>2.DNS如何优化 </h3> 
<h4>2.1 关于DNS原理简单介绍: </h4> 
<p>关于DNS的相关介绍:https://www.51cto.com/article/674906.html</p> 
<p>传统的DNS解析:</p> 
<ul><li> <p>当开始 DNS 解析的时候，如果 LocalDNS 没有缓存，那就会向 LocalDNS 服务器请求（通常就是运营商），如果还是没有，就会一级一级的，从根域名查对应的顶级域名，再从顶级域名查权威域名服务器，最后通过权威域名服务器，获取具体域名对应的 IP 地址。</p> </li></ul> 
<p><img alt="" height="488" src="https://images2.imgbox.com/11/b7/mVCHGmQH_o.png" width="687"></p> 
<p></p> 
<ul><li> <p>传统DNS缺点: 不稳定(DNS服务器被劫持或故障), 访问慢</p> </li></ul> 
<h4>2.2 传统DNS替代</h4> 
<p>使用HttpDNS解析:</p> 
<ul><li> <p>HttpDNS其实也是对DNS解析的另一种实现方式，只是将域名解析的协议由DNS协议换成了Http协议，并不复杂。使用HTTP协议向D+服务器的80端口进行请求，代替传统的DNS协议向DNS服务器的53端口进行请求，绕开了运营商的Local DNS，从而避免了使用运营商Local DNS造成的劫持和跨网问题;</p> </li></ul> 
<p><img alt="" height="380" src="https://images2.imgbox.com/55/db/5jSOiH6l_o.png" width="729"></p> 
<p> HttpDNS核心是需要稳定且速度快的DNS服务器, 一般都是需要收费的;  目前有阿里DNS,腾讯云DNS等选择; (我没有尝试过收费的); 免费的有开源的七牛sdk, 需要自己配置服务器与连接方式;</p> 
<ul><li>七牛开源地址:  https://github.com/qiniu/happy-dns-android</li></ul> 
<pre><code>DnsManager dns;
if(DnsManager.needHttpDns()){
	IResolver[] resolvers = new IResolver[2];
    // dohResolver 需要配置一个支持 Doh(Dns over http) 协议的 url
    resolvers[0] = new DnhResolver("https://dns.alidns.com/dns-query");
    resolvers[1] = AndroidDnsServer.defaultResolver(getContext());
    dns = new DnsManager(NetworkInfo.normal, resolvers);
}else{
	IResolver[] resolvers = new IResolver[2];
    resolvers[0] = AndroidDnsServer.defaultResolver(getContext());
    resolvers[1] = new DnsUdpResolver("8.8.8.8");
    dns = new DnsManager(NetworkInfo.normal, resolvers);
}</code></pre> 
<p>可支持httpDNS服务器解析(DnhResolver), 也支持自定义udp服务器(DnsUdpResolver);</p> 
<p>对于我们项目来说, 目前没有速度快且稳定的httpDns服务器, 为了速度和成功率, 我们增加了udp服务器的配置,通过一些业务策略, 可以修改dns服务器的顺序以及数量, 然后通过观察对比选出较合适的服务器;</p> 
<p>关于开放的dns服务器, 可以参考一下:</p> 
<blockquote> 
 <p><a href="https://zhuanlan.zhihu.com/p/518141267" rel="nofollow" title="2022 国内外免费公共 DNS 服务推荐 - 知乎">2022 国内外免费公共 DNS 服务推荐 - 知乎</a></p> 
</blockquote> 
<h3>3. DNS再次优化</h3> 
<h4>3.1 上线分析</h4> 
<p>通过增加dns服务器解析兜底策略, 发现DNS的错误率降低了一半,颇具效果;  但是看另一个数据就不是那么乐观了, 网络请求响应时间也增加了近一倍; 这不是我们想看到的, 紧急关掉了配置, 网络又恢复了之前水平;</p> 
<p>经过观察, 增加了时长都集中在DNS解析中; 经过本地测试, 系统的dns时长一般都在10ms内, 而三方的dns服务器时长在30~100ms, 这是在网络良好的情况下; 线上网络复杂的情况下, 这个差距肯定还会增大; 所以照这样看来, 系统dns解析还是所有dns的首选; </p> 
<p>而且慢请求中, DNS解析有记录会超过几百秒, 但是项目中okhttp的超时时间connectTimeout已经设置了30s, 说明很遗憾, 这个超时对DNS没有作用; 也就是说 dns,没有超时时间;</p> 
<h4>3.2 解决方案</h4> 
<ol><li>调整DNS服务器解析顺序, 将系统解析放在首位</li><li>设置DNS超时时间, 规避超长慢请求</li></ol> 
<p>经过两次的调整, 新版本上线后, 网络错误率下降了一倍, 响应时间也降低了30%; 目前还在观察中中, 后续持续优化中;</p> 
<h4>3.3 优化源码</h4> 
<p>关于DNS优化的源码, 可以参考<a href="https://download.csdn.net/download/qq_23992393/86819442" title="https://download.csdn.net/download/qq_23992393/86819442​​​​​​">https://download.csdn.net/download/qq_23992393/86819442​​​​​​</a></p> 
<p>不足之处,请大佬指出;</p> 
<p></p> 
<p></p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/02676e98d33b455b62797e755d1582e0/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">百度云加速配置SSL证书方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/f2f7bdc983b158582930692f4d3daa42/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于Mysql 中查询字段中包换相同字符串两次的sql</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>