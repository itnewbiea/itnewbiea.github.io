<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>lvs&#43;keepalived&#43;nginx实现四层负载&#43;七层负载 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="lvs&#43;keepalived&#43;nginx实现四层负载&#43;七层负载" />
<meta property="og:description" content="目录
一、lvs配置
二、nginx配置
三、测试
3.1 keepalived负载均衡
3.2 lvs&#43;keepalived高可用
3.3 nginx高可用
主机IPlvs01-33 11.0.1.33
lvs02-3411.0.1.34nginx0111.0.1.31nginx0211.0.1.32VIP11.0.1.30 4台主机主机添加host [root@nginx01 sbin]# cat /etc/hosts 127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 localhost localhost.localdomain localhost6 localhost6.localdomain6 11.0.1.31 nginx01 11.0.1.32 nginx02 11.0.1.33 lvs01-33 11.0.1.34 lvs02-34 一、lvs配置 以下两台lvs都要配置，除了配置文件不一样以外
lvs一定要搭配keepalived使用，配置上更简单，并且能实现主备高可用
yum install -y ipvsadm keepalived mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak vi /etc/keepalived/keepalived.conf 主机master
lb_algo字段表示负载调度算法，采用权重算法，nginx01权重为5，nginx02权重为3
需要更改的字段router_id、ens33、priority 100、VIP&#43;端口、真实IP&#43;端口
global_defs { router_id lvs01-33 # 设置lvs的id，在一个网络内应该是唯一的，一般用主机名 } vrrp_instance VI_1 { state MASTER #指定Keepalived的角色，MASTER为主，BACKUP为备 interface ens33 #指定Keepalived的角色，MASTER为主，BACKUP为备 virtual_router_id 51 #虚拟路由编号，主备要一致 priority 100 #定义优先级，数字越大，优先级越高，主DR必须大于备用DR advert_int 1 #检查间隔，默认为1s authentication { auth_type PASS auth_pass 1111 } virtual_ipaddress { 11." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/7ba46419cc78013f5ad72a93befdb462/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-31T16:11:44+08:00" />
<meta property="article:modified_time" content="2023-12-31T16:11:44+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">lvs&#43;keepalived&#43;nginx实现四层负载&#43;七层负载</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p></p> 
<p id="%E4%B8%80%E3%80%81lvs-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81lvs" rel="nofollow">一、lvs配置</a></p> 
<p style="margin-left:0px;"></p> 
<p id="%E4%B8%89%E3%80%81nginx-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81nginx" rel="nofollow">二、nginx配置</a></p> 
<p style="margin-left:0px;"></p> 
<p id="%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95" rel="nofollow">三、测试</a></p> 
<p style="margin-left:0px;"></p> 
<p id="4.1%20keepalived%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-toc" style="margin-left:40px;"><a href="#4.1%20keepalived%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1" rel="nofollow">3.1 keepalived负载均衡</a></p> 
<p style="margin-left:40px;"></p> 
<p id="4.2%20lvs%2Bkeepalived%E9%AB%98%E5%8F%AF%E7%94%A8-toc" style="margin-left:40px;"><a href="#4.2%20lvs%2Bkeepalived%E9%AB%98%E5%8F%AF%E7%94%A8" rel="nofollow">3.2 lvs+keepalived高可用</a></p> 
<p style="margin-left:40px;"></p> 
<p id="%C2%A04.3%20nginx%E9%AB%98%E5%8F%AF%E7%94%A8-toc" style="margin-left:40px;"><a href="#%C2%A04.3%20nginx%E9%AB%98%E5%8F%AF%E7%94%A8" rel="nofollow"> 3.3 nginx高可用</a></p> 
<p style="margin-left:40px;"></p> 
<hr id="hr-toc"> 
<p></p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:400px;"><tbody><tr><td style="width:175px;">主机</td><td style="width:223px;">IP</td></tr><tr><td style="width:175px;">lvs01-33</td><td style="width:223px;"> <p>11.0.1.33</p> </td></tr><tr><td style="width:175px;">lvs02-34</td><td style="width:223px;">11.0.1.34</td></tr><tr><td style="width:175px;">nginx01</td><td style="width:223px;">11.0.1.31</td></tr><tr><td style="width:175px;">nginx02</td><td style="width:223px;">11.0.1.32</td></tr><tr><td style="width:175px;">VIP</td><td style="width:223px;">11.0.1.30</td></tr></tbody></table> 
<p>4台主机主机添加host </p> 
<pre><code>[root@nginx01 sbin]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
11.0.1.31 nginx01
11.0.1.32 nginx02
11.0.1.33 lvs01-33
11.0.1.34 lvs02-34
</code></pre> 
<p> </p> 
<h2 id="%E4%B8%80%E3%80%81lvs">一、lvs配置</h2> 
<p>以下两台lvs都要配置，除了配置文件不一样以外</p> 
<p>lvs一定要搭配keepalived使用，配置上更简单，并且能实现主备高可用</p> 
<pre><code>yum install -y ipvsadm keepalived

mv /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak
vi /etc/keepalived/keepalived.conf</code></pre> 
<p>主机master</p> 
<p>lb_algo字段表示负载调度算法，采用权重算法，nginx01权重为5，nginx02权重为3</p> 
<p><strong><span style="color:#fe2c24;">需要更改的字段</span></strong>router_id、ens33、priority 100、VIP+端口、真实IP+端口</p> 
<pre><code>global_defs {  
    router_id lvs01-33  # 设置lvs的id，在一个网络内应该是唯一的，一般用主机名
}  
vrrp_instance VI_1 {  
    state MASTER   #指定Keepalived的角色，MASTER为主，BACKUP为备          
    interface ens33  #指定Keepalived的角色，MASTER为主，BACKUP为备
    virtual_router_id 51  #虚拟路由编号，主备要一致
    priority 100  #定义优先级，数字越大，优先级越高，主DR必须大于备用DR    
    advert_int 1  #检查间隔，默认为1s
    authentication {  
        auth_type PASS  
        auth_pass 1111  
    }  
    virtual_ipaddress {  
        11.0.1.30  #定义虚拟IP(VIP)为11.0.1.30，可多设，每行一个
    }  
}  
# 定义对外提供服务的LVS的VIP以及port
virtual_server 11.0.1.30 80 {  
    delay_loop 6 # 设置健康检查时间，单位是秒                    
    lb_algo wlc # 设置负载调度的算法为wlc 基于权重的调度算法                  
    lb_kind DR # 设置LVS实现负载的机制，有NAT、TUN、DR三个模式   
    nat_mask 255.255.255.0                
   #persistence_timeout 0 会话保持时间    
    protocol TCP                  
    real_server 11.0.1.31 80 {  # 指定real server1的IP地址
        weight 5   # 配置节点权值，数字越大权重越高              
        TCP_CHECK {  
        connect_timeout 10         
        nb_get_retry 3  
        delay_before_retry 3  
        connect_port 80  
        }  
    }  
    real_server 11.0.1.32 80 {  # 指定real server2的IP地址
        weight 3  # 配置节点权值，数字越大权重越高  
        TCP_CHECK {  
        connect_timeout 10  
        nb_get_retry 3  
        delay_before_retry 3  
        connect_port 80  
        }  
     }  
}
</code></pre> 
<p>备机backup</p> 
<pre><code>global_defs {  
    router_id lvs01-34  # 设置lvs的id，在一个网络内应该是唯一的
}  
vrrp_instance VI_1 {  
    state BACKUP   #指定Keepalived的角色，MASTER为主，BACKUP为备          
    interface ens33  #指定Keepalived的角色，MASTER为主，BACKUP为备
    virtual_router_id 51  #虚拟路由编号，主备要一致
    priority 90  #定义优先级，数字越大，优先级越高，主DR必须大于备用DR    
    advert_int 1  #检查间隔，默认为1s
    authentication {  
        auth_type PASS  
        auth_pass 1111  
    }  
    virtual_ipaddress {  
        11.0.1.30  #定义虚拟IP(VIP)为11.0.1.30，可多设，每行一个
    }  
}  
# 定义对外提供服务的LVS的VIP以及port
virtual_server 11.0.1.30 80 {  
    delay_loop 6 # 设置健康检查时间，单位是秒                    
    lb_algo wlc # 设置负载调度的算法为wlc 基于权重的调度算法                  
    lb_kind DR # 设置LVS实现负载的机制，有NAT、TUN、DR三个模式   
    nat_mask 255.255.255.0                
   #persistence_timeout 0 会话保持时间    
    protocol TCP                  
    real_server 11.0.1.31 80 {  # 指定real server1的IP地址
        weight 5   # 配置节点权值，数字越大权重越高              
        TCP_CHECK {  
        connect_timeout 10         
        nb_get_retry 3  
        delay_before_retry 3  
        connect_port 80  
        }  
    }  
    real_server 11.0.1.32 80 {  # 指定real server2的IP地址
        weight 3  # 配置节点权值，数字越大权重越高  
        TCP_CHECK {  
        connect_timeout 10  
        nb_get_retry 3  
        delay_before_retry 3  
        connect_port 80  
        }  
     }  
}
</code></pre> 
<p></p> 
<h2 id="%E4%B8%89%E3%80%81nginx" style="background-color:transparent;">二、nginx配置</h2> 
<p>安装nginx，并更改html页面内容为当前IP</p> 
<p>nginx安装：<a href="https://blog.csdn.net/weixin_48878440/article/details/122422845?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522170400839716800197087808%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fblog.%2522%257D&amp;request_id=170400839716800197087808&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~blog~first_rank_ecpm_v1~rank_v31_ecpm-6-122422845-null-null.nonecase&amp;utm_term=nginx&amp;spm=1018.2226.3001.4450" title="Nginx、keepalived安装详细步骤_keepalive 安装-CSDN博客">Nginx、keepalived安装详细步骤_keepalive 安装-CSDN博客</a></p> 
<p>两台nginx都要配置</p> 
<p><span style="color:#fe2c24;"><strong>以下命令是临时的，重启后失效</strong></span>，命令内容：<strong><span style="color:#fe2c24;">在lo网卡上虚拟出一个lo:0接口，添加路由，抑制两台nginx主机的ARP响应</span></strong>。注意掩码是32，目前没找到永久配置的方法，只能以自定义服务设置为开机自启动。</p> 
<pre><code>ifconfig lo:0 11.0.1.30 netmask 255.255.255.255 broadcast 11.0.1.30 

route add -host 11.0.1.30 dev lo:0

echo "1" &gt;/proc/sys/net/ipv4/conf/lo/arp_ignore

echo "2" &gt;/proc/sys/net/ipv4/conf/lo/arp_announce

echo "1" &gt;/proc/sys/net/ipv4/conf/all/arp_ignore

echo "2" &gt;/proc/sys/net/ipv4/conf/all/arp_announce</code></pre> 
<p>检测虚拟网卡接口lo:0，且IP为VIP</p> 
<pre><code>[root@nginx01 init.d]# ifconfig
ens33: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500
        inet 11.0.1.31  netmask 255.255.255.0  broadcast 11.0.1.255
        inet6 fe80::4ae3:fc87:6344:7062  prefixlen 64  scopeid 0x20&lt;link&gt;
        ether 00:0c:29:60:05:0e  txqueuelen 1000  (Ethernet)
        RX packets 35532  bytes 2276489 (2.1 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 22319  bytes 1530060 (1.4 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 0  bytes 0 (0.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo:0: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536
        inet 11.0.1.30  netmask 255.255.255.255
        loop  txqueuelen 1000  (Local Loopback)
</code></pre> 
<p><img alt="" height="430" src="https://images2.imgbox.com/28/56/DmwDB0KB_o.png" width="811"></p> 
<p> </p> 
<h2 id="%E5%9B%9B%E3%80%81%E6%B5%8B%E8%AF%95" style="background-color:transparent;">三、测试</h2> 
<p>nginx01、nginx02访问正常</p> 
<p><img alt="" height="626" src="https://images2.imgbox.com/2f/df/3hOAkv4d_o.png" width="564"></p> 
<h3 id="4.1%20keepalived%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">3.1 keepalived负载均衡</h3> 
<p><strong><span style="color:#fe2c24;">两台lvs开启keepalived</span></strong>，访问VIP，访问正常，由于我设定nginx01的权重高于nginx02，所以是nginx01返回页面，系统工具优先级选出最佳节点</p> 
<pre><code>[root@lvs01-33 ~]# systemctl start keepalived
[root@lvs01-34 ~]# systemctl start keepalived
</code></pre> 
<p><img alt="" height="270" src="https://images2.imgbox.com/06/3f/s39DQqlS_o.png" width="528"></p> 
<p>如果你想知道当前是哪个lvs在工作，只需要通过查看VIP当前在哪台lvs即可</p> 
<p><img alt="" height="364" src="https://images2.imgbox.com/1f/3e/YCzae32z_o.png" width="1043"></p> 
<h3 id="4.2%20lvs%2Bkeepalived%E9%AB%98%E5%8F%AF%E7%94%A8">3.2 lvs+keepalived高可用</h3> 
<p>将lvs01的keepalived进程关闭</p> 
<pre><code>[root@lvs01-33 ~]# systemctl stop keepalived</code></pre> 
<p><img alt="" height="366" src="https://images2.imgbox.com/17/67/OgnoBfCQ_o.png" width="1021"></p> 
<p>VIP访问仍然正常，说明lvs工作正常</p> 
<p> <img alt="" height="255" src="https://images2.imgbox.com/22/cf/YPuV1qzk_o.png" width="476"></p> 
<h3 id="%C2%A04.3%20nginx%E9%AB%98%E5%8F%AF%E7%94%A8"> 3.3 nginx高可用</h3> 
<p>将nginx01的nginx进程杀死 </p> 
<pre><code>[root@nginx01 sbin]# ./nginx -s stop</code></pre> 
<p>再次访问</p> 
<p> <img alt="" height="280" src="https://images2.imgbox.com/20/01/nUzeaJkR_o.png" width="471"></p> 
<p> 将nginx01的nginx进程重启，那么nginx01重新接管</p> 
<p><img alt="" height="343" src="https://images2.imgbox.com/05/a9/dlMlSnKf_o.png" width="503"></p> 
<p> </p> 
<p>参考文档：</p> 
<p><a href="https://www.cnblogs.com/tangyanbo/p/4305589.html" rel="nofollow" title="https://www.cnblogs.com/tangyanbo/p/4305589.html">https://www.cnblogs.com/tangyanbo/p/4305589.html</a></p> 
<p><a href="https://www.cnblogs.com/xiaocheche/p/7689432.html" rel="nofollow" title="https://www.cnblogs.com/xiaocheche/p/7689432.html">https://www.cnblogs.com/xiaocheche/p/7689432.html</a></p> 
<p>lvs详细文档：（原理、模式（NAT、TUN、DR）、调度算法）</p> 
<p><a href="https://blog.csdn.net/weixin_40470303/article/details/80541639" title="LVS负载均衡（LVS简介、三种工作模式、十种调度算法）-CSDN博客">LVS负载均衡（LVS简介、三种工作模式、十种调度算法）-CSDN博客</a></p> 
<p><a href="https://www.cnblogs.com/anay/p/9260306.html#_label7" rel="nofollow" title="https://www.cnblogs.com/anay/p/9260306.html#_label7">https://www.cnblogs.com/anay/p/9260306.html#_label7</a></p> 
<p>DR模式详细：</p> 
<p><a href="https://blog.csdn.net/liupeifeng3514/article/details/79038451" title="LVS | LVS 的三种工作方式（DR原理）（二）_lvs dr 为什么局域网-CSDN博客">LVS | LVS 的三种工作方式（DR原理）（二）_lvs dr 为什么局域网-CSDN博客</a></p> 
<p>ipvsadm常用命令： </p> 
<p><a href="https://www.linuxcool.com/ipvsadm" rel="nofollow" title="ipvsadm命令 – 管理Linux虚拟服务器 – Linux命令大全(手册)">ipvsadm命令 – 管理Linux虚拟服务器 – Linux命令大全(手册)</a></p> 
<p>arp冲突解释：</p> 
<p><a href="https://blog.csdn.net/weixin_33694172/article/details/89803918" title="【arp冲突】linux抑制arp通告-CSDN博客">【arp冲突】linux抑制arp通告-CSDN博客</a></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/2b8128c304fcdd8281b45644cbd40232/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">设计模式：工厂方法模式（讲故事图文易懂）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/dc89d556c11309b12dc0792e3f0ab3e5/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Visual Studio 2015 中 OpenGL 开发环境的搭建</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>