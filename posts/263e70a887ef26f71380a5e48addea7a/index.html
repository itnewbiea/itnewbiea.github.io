<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>C#登陆后获取另一个网页数据带验证码和token - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="C#登陆后获取另一个网页数据带验证码和token" />
<meta property="og:description" content="这篇文章是有关模拟登录网站方面的。URL信息我是goole下面的开发者工具中获得
实现步骤；
使用HttpWebRequest和HttpWebResponse
启用一个web会话获取验证码（POST或者GET）在获取验证码的时候提取CooKie和token拼接另一页面的URL获取数据 首先我建了HTTPHELPER类 如下： using System; using System.Collections.Generic; using System.Collections.Specialized; using System.IO; using System.Linq; using System.Net; using System.Reflection; using System.Text; using System.Text.RegularExpressions; using System.Threading.Tasks; namespace WindowsFormsApp4 { class HTTPHELPER { public static CookieContainer container = null; //存储验证码cookie #region 登录 public string requestM(string vaildate) //密码和账号我是直接复制页面中header里面的 { HttpWebRequest request = null; HttpWebResponse response = null; try { request = (HttpWebRequest)HttpWebRequest.Create(&#34;登录页面URL&#34;); request.Method = &#34;Post&#34;; request.ContentType = &#34;application/x-www-form-urlencoded; charset=UTF-8&#34;; request.UserAgent = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/263e70a887ef26f71380a5e48addea7a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-02-25T15:40:20+08:00" />
<meta property="article:modified_time" content="2021-02-25T15:40:20+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">C#登陆后获取另一个网页数据带验证码和token</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>这篇文章是有关模拟登录网站方面的。URL信息我是goole下面的开发者工具中获得</p> 
<p>实现步骤；</p> 
<p>     使用HttpWebRequest和HttpWebResponse</p> 
<blockquote> 
 <ol><li>启用一个web会话</li><li>获取验证码（POST或者GET）</li><li>在获取验证码的时候提取CooKie和token</li><li>拼接另一页面的URL获取数据                                                                                                                                                                                                                                                                                            首先我建了HTTPHELPER类 如下：    <pre><code class="language-cs">using System;
using System.Collections.Generic;
using System.Collections.Specialized;
using System.IO;
using System.Linq;
using System.Net;
using System.Reflection;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;

namespace WindowsFormsApp4
{
    class HTTPHELPER
    {
        public static CookieContainer container = null; //存储验证码cookie

        #region 登录
        public string requestM(string vaildate) //密码和账号我是直接复制页面中header里面的
        {
            HttpWebRequest request = null;
            HttpWebResponse response = null;
            try
            {
                request = (HttpWebRequest)HttpWebRequest.Create("登录页面URL");
                request.Method = "Post";
                request.ContentType = "application/x-www-form-urlencoded; charset=UTF-8";
                request.UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.182 Safari/537.36";
                request.AllowAutoRedirect = true;
                request.CookieContainer = container;//获取验证码时候获取到的cookie会附加在这个容器里面
                request.KeepAlive = true;//建立持久性连接
                                         //整数据
                //string postData = string.Format("userName={0}&amp;passwd={1}&amp;validateCode={2}&amp;rememberMe=true", uName, passwd, vaildate);
                string postData = string.Format("method=login&amp;checkMMFlag=0&amp;orgid=156499012&amp;password=954b9c6122038fb010c91dfa5d0c83d8&amp;orgCode={0}&amp;myCode=&amp;autologin=autologin", vaildate);

                ASCIIEncoding encoding = new ASCIIEncoding();
                byte[] bytepostData = encoding.GetBytes(postData);
                request.ContentLength = bytepostData.Length;

                //发送数据 using结束代码段释放
                using (Stream requestStm = request.GetRequestStream())
                {
                    requestStm.Write(bytepostData, 0, bytepostData.Length);
                }

                //响应
                response = (HttpWebResponse)request.GetResponse();

                string text = string.Empty;
                using (Stream responseStm = response.GetResponseStream())
                {
                    StreamReader redStm = new StreamReader(responseStm, Encoding.UTF8);
                    text = redStm.ReadToEnd();
                }
                
                return text;
            }
            catch (Exception ex)
            {
                var msg = ex.Message;
                return msg;
            }

        }
        #endregion

        #region 获取验证码
        public Stream getCodeStream(string codeUrl)
        {

            //验证码请求
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(codeUrl);
            request.Method = "GET";
            request.ContentType = "application/x-www-form-urlencoded";
            request.UserAgent = "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:5.0.1) Gecko/20100101 Firefox/5.0.1";
            request.Accept = "image/webp,*/*;q=0.8";
            request.CookieContainer = new CookieContainer();//!Very Important.!!!
            container = request.CookieContainer;
            var c = request.CookieContainer.GetCookies(request.RequestUri);
            HttpWebResponse response = (HttpWebResponse)request.GetResponse();
            response.Cookies = container.GetCookies(request.RequestUri);

            Stream stream = response.GetResponseStream();
            return stream;
        }

        #endregion
        #region 登陆成功后获取另一个页面的数据
        /// &lt;summary&gt;
        /// request最好与页面中的request headers相同
        /// &lt;/summary&gt;
        /// &lt;param name="Url"&gt;&lt;/param&gt;
        /// &lt;param name="Data"&gt;&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public string Post(string Url, string Data)
        {
            HttpWebRequest request = (HttpWebRequest)WebRequest.Create(Url);
           ///request配置请查看页面的开发者工具，尽量保证与request headers相同
            request.Method = "POST";//或者GET
            //request.Referer = Referer;
            byte[] bytes = Encoding.UTF8.GetBytes(Data);
            request.ContentType = "application/x-www-form-urlencoded; charset=UTF-8";
            request.ContentLength = bytes.Length;
            request.AllowAutoRedirect = true;
            request.Host = "主机IP";
            request.UserAgent = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/88.0.4324.182 Safari/537.36";
            
            request.CookieContainer = container;//获取验证码时候获取到的cookie会附加在这个容器里面
            Stream myResponseStream = request.GetRequestStream();
            myResponseStream.Write(bytes, 0, bytes.Length);

            HttpWebResponse response = (HttpWebResponse)request.GetResponse();
            response.Cookies = container.GetCookies(request.RequestUri);
            StreamReader myStreamReader = new StreamReader(response.GetResponseStream(), Encoding.UTF8);
            string retString = myStreamReader.ReadToEnd();

            myStreamReader.Close();
            myResponseStream.Close();

            if (response != null)
            {
                response.Close();
            }
            if (request != null)
            {
                request.Abort();
            }
            return retString;
        }
        #endregion
    }
}

</code></pre> <p>然后我建了一个winform窗体测试 页面如下：</p> </li><li> <p><img alt="" height="499" src="https://images2.imgbox.com/11/d3/tUNN4H1V_o.png" width="770"></p> </li><li> <p>winform的代码如下：</p> <pre><code class="language-cs">using Newtonsoft.Json;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.IO;
using System.Linq;
using System.Text;
using System.Text.RegularExpressions;
using System.Threading.Tasks;
using System.Windows.Forms;
using WindowsFormsApp4;

namespace 模拟登陆
{
    public partial class Form1 : Form
    {
        HTTPHELPER agent = new HTTPHELPER();
        public Form1()
        {
            InitializeComponent();
        }

        private void button1_Click(object sender, EventArgs e)
        {
            //加载验证码图片
            ReflshPicImage();
        }
        Bitmap bitmap;
        public void ReflshPicImage()
        {
            string codeUrl = "验证码的url";

            Stream stmImage = agent.getCodeStream(codeUrl);
            picValidate.Image = Image.FromStream(stmImage);
            bitmap = new Bitmap(picValidate.Image);
        }

        private void button2_Click(object sender, EventArgs e)
        {            
            var rmsg = agent.requestM(txtVaildata.Text);//
            #region 获取token

            string csrftoken = "";
            Regex Re = new Regex(@"token"" type=""hidden"" value=""([0-9\.]+)""", RegexOptions.IgnoreCase);
            MatchCollection Mc = Re.Matches(rmsg);

            if (Mc.Count == 0)
            {
                Console.WriteLine("没有匹配到数据");

            }
            else
            {
                foreach (Match M in Mc)
                {
                    csrftoken = M.Groups[1].Value.Replace("\"", string.Empty);
                }
            }

            #endregion
            //获取另一个页面数据
            string json = agent.Post("另一个页面的url" + csrftoken, "page=1&amp;rows=50");

        }
    }

}
</code></pre> <p>获取数据如下：<img alt="" height="23" src="https://images2.imgbox.com/ca/8d/tPyWAOJS_o.png" width="935"></p> </li><li> <p>参考<a href="https://blog.csdn.net/htsnoopy/article/details/7094224?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.control&amp;dist_request_id=605c03c4-c0d0-435b-91c3-4b993ed151cd&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.control">https://blog.csdn.net/htsnoopy/article/details/7094224?utm_medium=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.control&amp;dist_request_id=605c03c4-c0d0-435b-91c3-4b993ed151cd&amp;depth_1-utm_source=distribute.pc_relevant.none-task-blog-BlogCommendFromMachineLearnPai2-4.control</a></p> </li></ol> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/3e30d5715ee73c121a5be72c0017eea2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">前端解析csv文件（文本文件）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ddfbe9cd6413954943c6b25211f389de/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">小型PHP论坛搭建</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>