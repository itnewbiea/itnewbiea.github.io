<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>中间件系列 - Redis入门到实战(高级篇-多级缓存) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="中间件系列 - Redis入门到实战(高级篇-多级缓存)" />
<meta property="og:description" content="前言 学习视频： 黑马程序员Redis入门到实战教程，深度透析redis底层原理&#43;redis分布式锁&#43;企业解决方案&#43;黑马点评实战项目
中间件系列 - Redis入门到实战
本内容仅用于个人学习笔记，如有侵扰，联系删除
学习目标
JVM进程缓存Lua语法入门实现多级缓存缓存同步策略 1 什么是多级缓存 传统的缓存策略一般是请求到达Tomcat后，先查询Redis，如果未命中则查询数据库，如图：
存在下面的问题：
请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈
Redis缓存失效时，会对数据库产生冲击
多级缓存方案：
多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：
浏览器访问静态资源时，优先读取浏览器本地缓存访问非静态资源（ajax查询数据）时，访问服务端请求到达Nginx后，优先读取Nginx本地缓存如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）如果Redis查询未命中，则查询Tomcat请求进入Tomcat后，优先查询JVM进程缓存如果JVM进程缓存未命中，则查询数据库
在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个反向代理服务器，而是一个编写业务的Web服务器了。 因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：
另外，我们的Tomcat服务将来也会部署为集群模式：
可见，多级缓存的关键有两个：
一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询
另一个就是在Tomcat中实现JVM进程缓存
其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。
2 JVM进程缓存 为了演示多级缓存的案例，我们先准备一个商品查询的业务。
2.1 导入案例 为了演示多级缓存，我们先导入一个商品管理的案例，其中包含商品的CRUD功能。我们将来会给查询商品添加多级缓存。
2.1.1 安装MySQL 后期做数据同步需要用到MySQL的主从功能，所以需要大家在虚拟机中，利用Docker来运行一个MySQL容器。
2.1.1.1 准备目录 为了方便后期配置MySQL，我们先准备两个目录，用于挂载容器的数据和配置文件目录：
# 进入/tmp目录 cd /tmp # 创建文件夹 mkdir mysql # 进入mysql目录 cd mysql 2.1.1.2 运行命令 进入mysql目录后，执行下面的Docker命令：
docker run \ -p 3306:3306 \ --name mysql \ -v $PWD/conf:/etc/mysql/conf.d \ -v $PWD/logs:/logs \ -v $PWD/data:/var/lib/mysql \ -e MYSQL_ROOT_PASSWORD=123 \ --privileged \ -d \ mysql:5." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/4f2d5ceefac5c05735ec34e9b043c0e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-27T14:16:01+08:00" />
<meta property="article:modified_time" content="2023-12-27T14:16:01+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">中间件系列 - Redis入门到实战(高级篇-多级缓存)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_0"></a>前言</h2> 
<ol><li> <p>学习视频： <a href="https://www.bilibili.com/video/BV1cr4y1671t/?p=97&amp;spm_id_from=pageDriver&amp;vd_source=503d91c4d0bbdd15aaedc32c35838917" rel="nofollow">黑马程序员Redis入门到实战教程，深度透析redis底层原理+redis分布式锁+企业解决方案+黑马点评实战项目</a></p> </li><li> <p><a href="https://blog.csdn.net/wts563540/article/details/134771495">中间件系列 - Redis入门到实战</a></p> </li><li> <p>本内容仅用于个人学习笔记，如有侵扰，联系删除</p> </li><li> <p>学习目标</p> 
  <blockquote> 
   <ul><li>JVM进程缓存</li><li>Lua语法入门</li><li>实现多级缓存</li><li>缓存同步策略</li></ul> 
  </blockquote> </li></ol> 
<h2><a id="1__10"></a>1 什么是多级缓存</h2> 
<p>传统的缓存策略一般是请求到达<code>Tomcat</code>后，先查询<code>Redis</code>，如果未命中则查询数据库，如图：<br> <img src="https://images2.imgbox.com/73/a4/A8XolAYb_o.png" alt="在这里插入图片描述"><br> <strong>存在下面的问题：</strong></p> 
<ul><li> <p>请求要经过Tomcat处理，Tomcat的性能成为整个系统的瓶颈</p> </li><li> <p>Redis缓存失效时，会对数据库产生冲击</p> </li></ul> 
<p><strong>多级缓存方案：</strong></p> 
<p>多级缓存就是充分利用请求处理的每个环节，分别添加缓存，减轻Tomcat压力，提升服务性能：</p> 
<ul><li>浏览器访问静态资源时，优先读取浏览器本地缓存</li><li>访问非静态资源（ajax查询数据）时，访问服务端</li><li>请求到达Nginx后，优先读取Nginx本地缓存</li><li>如果Nginx本地缓存未命中，则去直接查询Redis（不经过Tomcat）</li><li>如果Redis查询未命中，则查询Tomcat</li><li>请求进入Tomcat后，优先查询JVM进程缓存</li><li>如果JVM进程缓存未命中，则查询数据库<br> <img src="https://images2.imgbox.com/1e/b2/vWohFkcy_o.png" alt="在这里插入图片描述"><br> 在多级缓存架构中，Nginx内部需要编写本地缓存查询、Redis查询、Tomcat查询的业务逻辑，因此这样的nginx服务不再是一个<strong>反向代理服务器</strong>，而是一个编写<strong>业务的Web服务器了</strong>。</li></ul> 
<p>因此这样的业务Nginx服务也需要搭建集群来提高并发，再有专门的nginx服务来做反向代理，如图：<br> <img src="https://images2.imgbox.com/0d/8f/qXM2YdDb_o.png" alt="在这里插入图片描述"></p> 
<p>另外，我们的Tomcat服务将来也会部署为集群模式：<br> <img src="https://images2.imgbox.com/1d/cc/pkXsZ7Bc_o.png" alt="在这里插入图片描述"><br> 可见，多级缓存的关键有两个：</p> 
<ul><li> <p>一个是在nginx中编写业务，实现nginx本地缓存、Redis、Tomcat的查询</p> </li><li> <p>另一个就是在Tomcat中实现JVM进程缓存</p> </li></ul> 
<p>其中Nginx编程则会用到OpenResty框架结合Lua这样的语言。</p> 
<h2><a id="2_JVM_46"></a>2 JVM进程缓存</h2> 
<p>为了演示多级缓存的案例，我们先准备一个商品查询的业务。</p> 
<h3><a id="21__49"></a>2.1 导入案例</h3> 
<p>为了演示多级缓存，我们先导入一个商品管理的案例，其中包含商品的CRUD功能。我们将来会给查询商品添加多级缓存。</p> 
<h4><a id="211_MySQL_51"></a>2.1.1 安装MySQL</h4> 
<p>后期做数据同步需要用到MySQL的主从功能，所以需要大家在虚拟机中，利用Docker来运行一个MySQL容器。</p> 
<h5><a id="2111__54"></a>2.1.1.1 准备目录</h5> 
<p>为了方便后期配置MySQL，我们先准备两个目录，用于挂载容器的数据和配置文件目录：</p> 
<pre><code class="prism language-sh"><span class="token comment"># 进入/tmp目录</span>
<span class="token builtin class-name">cd</span> /tmp
<span class="token comment"># 创建文件夹</span>
<span class="token function">mkdir</span> mysql
<span class="token comment"># 进入mysql目录</span>
<span class="token builtin class-name">cd</span> mysql
</code></pre> 
<h5><a id="2112__66"></a>2.1.1.2 运行命令</h5> 
<p>进入mysql目录后，执行下面的Docker命令：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token punctuation">\</span>
 <span class="token parameter variable">-p</span> <span class="token number">3306</span>:3306 <span class="token punctuation">\</span>
 <span class="token parameter variable">--name</span> mysql <span class="token punctuation">\</span>
 <span class="token parameter variable">-v</span> <span class="token environment constant">$PWD</span>/conf:/etc/mysql/conf.d <span class="token punctuation">\</span>
 <span class="token parameter variable">-v</span> <span class="token environment constant">$PWD</span>/logs:/logs <span class="token punctuation">\</span>
 <span class="token parameter variable">-v</span> <span class="token environment constant">$PWD</span>/data:/var/lib/mysql <span class="token punctuation">\</span>
 <span class="token parameter variable">-e</span> <span class="token assign-left variable">MYSQL_ROOT_PASSWORD</span><span class="token operator">=</span><span class="token number">123</span> <span class="token punctuation">\</span>
 <span class="token parameter variable">--privileged</span> <span class="token punctuation">\</span>
 <span class="token parameter variable">-d</span> <span class="token punctuation">\</span>
 mysql:5.7.25
</code></pre> 
<h5><a id="2113__82"></a>2.1.1.3 修改配置</h5> 
<p>在/tmp/mysql/conf目录添加一个my.cnf文件，作为mysql的配置文件：</p> 
<pre><code class="prism language-sh"><span class="token comment"># 创建文件</span>
<span class="token function">touch</span> /tmp/mysql/conf/my.cnf
</code></pre> 
<p>文件的内容如下：</p> 
<pre><code class="prism language-ini">[mysqld]
skip-name-resolve
character_set_server=utf8
datadir=/var/lib/mysql
server-id=1000
</code></pre> 
<h5><a id="2114__100"></a>2.1.1.4 重启</h5> 
<p>配置修改后，必须重启容器：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> restart mysql
</code></pre> 
<h4><a id="212_SQL_107"></a>2.1.2 导入SQL</h4> 
<p>接下来，利用Navicat客户端连接MySQL，然后导入课前资料提供的sql文件：<br> <img src="https://images2.imgbox.com/f7/b9/46f1bjPl_o.png" alt="在这里插入图片描述"></p> 
<p>其中包含两张表：</p> 
<ul><li><code>tb_item</code>：商品表，包含商品的基本信息</li><li><code>tb_item_stock</code>：商品库存表，包含商品的库存信息</li></ul> 
<p>之所以将库存分离出来，是因为库存是更新比较频繁的信息，写操作较多。而其他信息修改的频率非常低。</p> 
<pre><code class="prism language-sql"><span class="token comment">/*
 Navicat Premium Data Transfer

 Source Server         : 192.168.150.101
 Source Server Type    : MySQL
 Source Server Version : 50725
 Source Host           : 192.168.150.101:3306
 Source Schema         : heima

 Target Server Type    : MySQL
 Target Server Version : 50725
 File Encoding         : 65001

 Date: 16/08/2021 14:45:07
*/</span>

<span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for tb_item</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>title<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">264</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品标题'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>name<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">''</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>price<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'价格（分）'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>image<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品图片'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>category<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'类目名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>brand<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'品牌名称'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>spec<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8 <span class="token keyword">COLLATE</span> utf8_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'规格'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">1</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品状态 1-正常，2-下架，3-删除'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'更新时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>status<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span><span class="token punctuation">,</span>
  <span class="token keyword">INDEX</span> <span class="token identifier"><span class="token punctuation">`</span>updated<span class="token punctuation">`</span></span><span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>update_time<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">50002</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8_general_ci <span class="token keyword">COMMENT</span> <span class="token operator">=</span> <span class="token string">'商品表'</span> ROW_FORMAT <span class="token operator">=</span> COMPACT<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of tb_item</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span> <span class="token string">'RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4'</span><span class="token punctuation">,</span> <span class="token string">'SALSA AIR'</span><span class="token punctuation">,</span> <span class="token number">16900</span><span class="token punctuation">,</span> <span class="token string">'https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp'</span><span class="token punctuation">,</span> <span class="token string">'拉杆箱'</span><span class="token punctuation">,</span> <span class="token string">'RIMOWA'</span><span class="token punctuation">,</span> <span class="token string">'{\"颜色\": \"红色\", \"尺码\": \"26寸\"}'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10002</span><span class="token punctuation">,</span> <span class="token string">'安佳脱脂牛奶 新西兰进口轻欣脱脂250ml*24整箱装*2'</span><span class="token punctuation">,</span> <span class="token string">'脱脂牛奶'</span><span class="token punctuation">,</span> <span class="token number">68600</span><span class="token punctuation">,</span> <span class="token string">'https://m.360buyimg.com/mobilecms/s720x720_jfs/t25552/261/1180671662/383855/33da8faa/5b8cf792Neda8550c.jpg!q70.jpg.webp'</span><span class="token punctuation">,</span> <span class="token string">'牛奶'</span><span class="token punctuation">,</span> <span class="token string">'安佳'</span><span class="token punctuation">,</span> <span class="token string">'{\"数量\": 24}'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10003</span><span class="token punctuation">,</span> <span class="token string">'唐狮新品牛仔裤女学生韩版宽松裤子 A款/中牛仔蓝（无绒款） 26'</span><span class="token punctuation">,</span> <span class="token string">'韩版牛仔裤'</span><span class="token punctuation">,</span> <span class="token number">84600</span><span class="token punctuation">,</span> <span class="token string">'https://m.360buyimg.com/mobilecms/s720x720_jfs/t26989/116/124520860/644643/173643ea/5b860864N6bfd95db.jpg!q70.jpg.webp'</span><span class="token punctuation">,</span> <span class="token string">'牛仔裤'</span><span class="token punctuation">,</span> <span class="token string">'唐狮'</span><span class="token punctuation">,</span> <span class="token string">'{\"颜色\": \"蓝色\", \"尺码\": \"26\"}'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10004</span><span class="token punctuation">,</span> <span class="token string">'森马(senma)休闲鞋女2019春季新款韩版系带板鞋学生百搭平底女鞋 黄色 36'</span><span class="token punctuation">,</span> <span class="token string">'休闲板鞋'</span><span class="token punctuation">,</span> <span class="token number">10400</span><span class="token punctuation">,</span> <span class="token string">'https://m.360buyimg.com/mobilecms/s720x720_jfs/t1/29976/8/2947/65074/5c22dad6Ef54f0505/0b5fe8c5d9bf6c47.jpg!q70.jpg.webp'</span><span class="token punctuation">,</span> <span class="token string">'休闲鞋'</span><span class="token punctuation">,</span> <span class="token string">'森马'</span><span class="token punctuation">,</span> <span class="token string">'{\"颜色\": \"白色\", \"尺码\": \"36\"}'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10005</span><span class="token punctuation">,</span> <span class="token string">'花王（Merries）拉拉裤 M58片 中号尿不湿（6-11kg）（日本原装进口）'</span><span class="token punctuation">,</span> <span class="token string">'拉拉裤'</span><span class="token punctuation">,</span> <span class="token number">38900</span><span class="token punctuation">,</span> <span class="token string">'https://m.360buyimg.com/mobilecms/s720x720_jfs/t24370/119/1282321183/267273/b4be9a80/5b595759N7d92f931.jpg!q70.jpg.webp'</span><span class="token punctuation">,</span> <span class="token string">'拉拉裤'</span><span class="token punctuation">,</span> <span class="token string">'花王'</span><span class="token punctuation">,</span> <span class="token string">'{\"型号\": \"XL\"}'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">,</span> <span class="token string">'2019-05-01 00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for tb_item_stock</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>item_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品id，关联tb_item表'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>stock<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">9999</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品库存'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>sold<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token number">0</span> <span class="token keyword">COMMENT</span> <span class="token string">'商品销量'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>item_id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> COMPACT<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of tb_item_stock</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10001</span><span class="token punctuation">,</span> <span class="token number">99996</span><span class="token punctuation">,</span> <span class="token number">3219</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10002</span><span class="token punctuation">,</span> <span class="token number">99999</span><span class="token punctuation">,</span> <span class="token number">54981</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10003</span><span class="token punctuation">,</span> <span class="token number">99999</span><span class="token punctuation">,</span> <span class="token number">189</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10004</span><span class="token punctuation">,</span> <span class="token number">99999</span><span class="token punctuation">,</span> <span class="token number">974</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>tb_item_stock<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">10005</span><span class="token punctuation">,</span> <span class="token number">99999</span><span class="token punctuation">,</span> <span class="token number">18649</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

</code></pre> 
<h4><a id="213_Demo_193"></a>2.1.3 导入Demo工程</h4> 
<p>下面导入课前资料提供的工程：<br> <img src="https://images2.imgbox.com/cd/8a/bl5Y0cXR_o.png" alt="在这里插入图片描述"><br> 项目结构如图所示：<br> <img src="https://images2.imgbox.com/16/aa/9XMxuN9X_o.png" alt="在这里插入图片描述"></p> 
<p>其中的业务包括：</p> 
<ul><li>分页查询商品</li><li>新增商品</li><li>修改商品</li><li>修改库存</li><li>删除商品</li><li>根据id查询商品</li><li>根据id查询库存</li></ul> 
<p>业务全部使用<code>mybatis-plus来</code>实现，如有需要请自行修改业务逻辑。</p> 
<h5><a id="2131__211"></a>2.1.3.1 分页查询商品</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/5b/5e/FJnPKftn_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2132__215"></a>2.1.3.2 新增商品</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/99/6e/9kmf3YiP_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2133__220"></a>2.1.3.3 修改商品</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/98/bf/YfVnC6Tq_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2134__225"></a>2.1.3.4 修改库存</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/43/c0/fVG7vVyu_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2135__229"></a>2.1.3.5 删除商品</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/49/a9/eTJEayz8_o.png" alt="在这里插入图片描述"></p> 
<p>这里是采用了逻辑删除，将商品状态修改为3</p> 
<h5><a id="2136_id_235"></a>2.1.3.6 根据id查询商品</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/bb/64/SPFjjLDX_o.png" alt="在这里插入图片描述"></p> 
<p>这里只返回了商品信息，不包含库存</p> 
<h5><a id="2137_id_241"></a>2.1.3.7 根据id查询库存</h5> 
<p>在<code>com.heima.item.web</code>包的<code>ItemController</code>中可以看到接口定义：<br> <img src="https://images2.imgbox.com/f4/b2/rGIj0KVp_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2138__245"></a>2.1.3.8 启动</h5> 
<p>注意修改application.yml文件中配置的mysql地址信息：<br> <img src="https://images2.imgbox.com/03/9d/S3HD1xpc_o.png" alt="在这里插入图片描述"></p> 
<p>需要修改为自己的虚拟机地址信息、还有账号和密码。</p> 
<p>修改后，启动服务，访问：http://localhost:8081/item/10001即可查询数据</p> 
<h4><a id="214__254"></a>2.1.4 导入商品查询页面</h4> 
<p>商品查询是购物页面，与商品管理的页面是分离的。</p> 
<p>部署方式如图：<br> <img src="https://images2.imgbox.com/8e/4d/hS8Y8fZl_o.png" alt="在这里插入图片描述"></p> 
<p>我们需要准备一个反向代理的nginx服务器，如上图红框所示，将静态的商品页面放到nginx目录中。</p> 
<p>页面需要的数据通过ajax向服务端（nginx业务集群）查询。</p> 
<h5><a id="2141_nginx_265"></a>2.1.4.1 运行nginx服务</h5> 
<p>这里我已经给大家准备好了nginx反向代理服务器和静态资源。</p> 
<p>我们找到课前资料的nginx目录：<br> <img src="https://images2.imgbox.com/42/cb/e9RkFnAK_o.png" alt="在这里插入图片描述"></p> 
<p>将其拷贝到一个非中文目录下，运行这个nginx服务。</p> 
<p>运行命令：</p> 
<pre><code class="prism language-powershell"><span class="token function">start</span> nginx<span class="token punctuation">.</span>exe
</code></pre> 
<p>然后访问 http://localhost/item.html?id=10001即可：<br> <img src="https://images2.imgbox.com/ac/0f/8ayopfQy_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2142__285"></a>2.1.4.2 反向代理</h5> 
<p>现在，页面是假数据展示的。我们需要向服务器发送ajax请求，查询商品数据。</p> 
<p>打开控制台，可以看到页面有发起ajax查询数据：<br> <img src="https://images2.imgbox.com/0a/1e/gbi523e4_o.png" alt="在这里插入图片描述"></p> 
<p>而这个请求地址同样是80端口，所以被当前的nginx反向代理了。</p> 
<p>查看nginx的conf目录下的nginx.conf文件：<br> <img src="https://images2.imgbox.com/d8/ef/IzcTPxqC_o.png" alt="在这里插入图片描述"></p> 
<p>其中的关键配置如下：<br> <img src="https://images2.imgbox.com/a8/fc/5wa4Pt2m_o.png" alt="在这里插入图片描述"></p> 
<p>其中的192.168.150.101是我的虚拟机IP，也就是我的Nginx业务集群要部署的地方：<br> <img src="https://images2.imgbox.com/af/b3/W5HFg4up_o.png" alt="在这里插入图片描述"></p> 
<p>完整内容如下：</p> 
<pre><code class="prism language-nginx">
#user  nobody;
worker_processes  1;

events {
    worker_connections  1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    #tcp_nopush     on;
    keepalive_timeout  65;

    upstream nginx-cluster{
        server 192.168.150.101:8081;
    }
    server {
        listen       80;
        server_name  localhost;

	location /api {
            proxy_pass http://nginx-cluster;
        }

        location / {
            root   html;
            index  index.html index.htm;
        }

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }
}
</code></pre> 
<h3><a id="22_Caffeine_357"></a>2.2 初识Caffeine</h3> 
<p>缓存在日常开发中启动至关重要的作用，由于是存储在内存中，数据的读取速度是非常快的，能大量减少对数据库的访问，减少数据库的压力。我们把缓存分为两类：</p> 
<ul><li><strong>分布式缓存，例如Redis：</strong> 
  <ul><li>优点：存储容量更大、可靠性更好、可以在集群间共享</li><li>缺点：访问缓存有网络开销</li><li>场景：缓存数据量较大、可靠性要求较高、需要在集群间共享</li></ul> </li><li><strong>进程本地缓存，例如HashMap、GuavaCache：</strong> 
  <ul><li>优点：读取本地内存，没有网络开销，速度更快</li><li>缺点：存储容量有限、可靠性较低、无法共享</li><li>场景：性能要求较高，缓存数据量较小</li></ul> </li></ul> 
<p>我们今天会利用Caffeine框架来实现JVM进程缓存。</p> 
<p><strong><code>Caffeine</code></strong> 是一个基于Java8开发的，提供了近乎最佳命中率的高性能的本地缓存库。目前<code>Spring</code>内部的缓存使用的就是<code>Caffeine</code>。GitHub地址：<a href="https://github.com/ben-manes/caffeine">https://github.com/ben-manes/caffeine</a></p> 
<p><code>Caffeine</code>的性能非常好，下图是官方给出的性能对比：<br> <img src="https://images2.imgbox.com/93/70/xSaQjZjh_o.png" alt="在这里插入图片描述"><br> 可以看到<code>Caffeine</code>的性能遥遥领先！</p> 
<p><strong>缓存使用的基本API：</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Test</span>
<span class="token keyword">void</span> <span class="token function">testBasicOps</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 构建cache对象</span>
    <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 存数据</span>
    cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"gf"</span><span class="token punctuation">,</span> <span class="token string">"迪丽热巴"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取数据</span>
    <span class="token class-name">String</span> gf <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"gf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gf = "</span> <span class="token operator">+</span> gf<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取数据，包含两个参数：</span>
    <span class="token comment">// 参数一：缓存的key</span>
    <span class="token comment">// 参数二：Lambda表达式，表达式参数就是缓存的key，方法体是查询数据库的逻辑</span>
    <span class="token comment">// 优先根据key查询JVM缓存，如果未命中，则执行参数二的Lambda表达式</span>
    <span class="token class-name">String</span> defaultGF <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"defaultGF"</span><span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 根据key去数据库查询数据</span>
        <span class="token keyword">return</span> <span class="token string">"柳岩"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"defaultGF = "</span> <span class="token operator">+</span> defaultGF<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>结果：</strong><br> <img src="https://images2.imgbox.com/fe/4f/A10AKxwp_o.png" alt="在这里插入图片描述"></p> 
<p><code>Caffeine</code>既然是缓存的一种，肯定需要有缓存的清除策略，不然的话内存总会有耗尽的时候。</p> 
<p><strong><code>Caffeine</code>提供了三种缓存驱逐策略：</strong></p> 
<ul><li> <p><strong>基于容量</strong>：设置缓存的数量上限</p> <pre><code class="prism language-java"><span class="token comment">// 创建缓存对象</span>
<span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// 设置缓存大小上限为 1</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> </li><li> <p><strong>基于时间</strong>：设置缓存的有效时间</p> <pre><code class="prism language-java"><span class="token comment">// 创建缓存对象</span>
<span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 设置缓存有效期为 10 秒，从最后一次写入开始计时 </span>
    <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> </li><li> <p><strong>基于引用</strong>：设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。</p> </li></ul> 
<blockquote> 
 <p><strong>注意</strong>：在默认情况下，当一个缓存元素过期的时候，Caffeine不会自动立即将其清理和驱逐。而是在一次读或写操作后，或者在空闲时间完成对失效数据的驱逐。</p> 
</blockquote> 
<ul><li> <p><strong>案例</strong><br> 1）基于大小设置驱逐策略：</p> <pre><code class="prism language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testEvictByNum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建缓存对象</span>
        <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// 设置缓存大小上限为 1</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存数据</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"gf1"</span><span class="token punctuation">,</span> <span class="token string">"柳岩"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"gf2"</span><span class="token punctuation">,</span> <span class="token string">"范冰冰"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"gf3"</span><span class="token punctuation">,</span> <span class="token string">"迪丽热巴"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 延迟10ms，给清理线程一点时间</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取数据</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gf1: "</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"gf1"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gf2: "</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"gf2"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gf3: "</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"gf3"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <p>结果：<br> <img src="https://images2.imgbox.com/dc/ce/1ItcVPu3_o.png" alt="在这里插入图片描述"><br> 2）基于时间设置驱逐策略：</p> <pre><code class="prism language-java">    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testEvictByTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 创建缓存对象</span>
        <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofSeconds</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 设置缓存有效期为 10 秒</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 存数据</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">"gf"</span><span class="token punctuation">,</span> <span class="token string">"柳岩"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取数据</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gf: "</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"gf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 休眠一会儿</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1200L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"gf: "</span> <span class="token operator">+</span> cache<span class="token punctuation">.</span><span class="token function">getIfPresent</span><span class="token punctuation">(</span><span class="token string">"gf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <p>结果：<br> <img src="https://images2.imgbox.com/76/c0/DuUlVL6l_o.png" alt="在这里插入图片描述"></p> </li></ul> 
<h3><a id="23_JVM_481"></a>2.3 实现JVM进程缓存</h3> 
<h4><a id="231__483"></a>2.3.1 需求</h4> 
<p>利用Caffeine实现下列需求：</p> 
<ul><li>给根据id查询商品的业务添加缓存，缓存未命中时查询数据库</li><li>给根据id查询商品库存的业务添加缓存，缓存未命中时查询数据库</li><li>缓存初始大小为100</li><li>缓存上限为10000</li></ul> 
<h4><a id="232__491"></a>2.3.2 实现</h4> 
<p>首先，我们需要定义两个Caffeine的缓存对象，分别保存商品、库存的缓存数据。</p> 
<p>在item-service的<code>com.heima.item.config</code>包下定义<code>CaffeineConfig</code>类：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Caffeine</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Item</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">ItemStock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaffeineConfig</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token function">itemCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ItemStock</span><span class="token punctuation">&gt;</span></span> <span class="token function">stockCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">initialCapacity</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span><span class="token number">10_000</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>然后，修改item-service中的<code>com.heima.item.web</code>包下的ItemController类，添加缓存逻辑：</p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">"item"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemController</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IItemService</span> itemService<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IItemStockService</span> stockService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemCache<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">ItemStock</span><span class="token punctuation">&gt;</span></span> stockCache<span class="token punctuation">;</span>
    
    <span class="token comment">// ...其它略</span>
    
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Item</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> itemCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> itemService<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">ne</span><span class="token punctuation">(</span><span class="token string">"status"</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">one</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">"/stock/{id}"</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">ItemStock</span> <span class="token function">findStockById</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span> <span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> stockCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> key <span class="token operator">-&gt;</span> stockService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="3_Lua_565"></a>3 Lua语法入门</h2> 
<p>Nginx编程需要用到Lua语言，因此我们必须先入门Lua的基本语法。</p> 
<h3><a id="31_Lua_568"></a>3.1 初识Lua</h3> 
<p>Lua 是一种轻量小巧的脚本语言，用标准C语言编写并以源代码形式开放， 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。官网：<a href="https://www.lua.org/" rel="nofollow">https://www.lua.org/</a><br> <img src="https://images2.imgbox.com/7d/2b/FAhetRE5_o.png" alt="在这里插入图片描述"><br> Lua经常嵌入到C语言开发的程序中，例如游戏开发、游戏插件等。</p> 
<p>Nginx本身也是C语言开发，因此也允许基于Lua做拓展。</p> 
<h3><a id="31_HelloWorld_575"></a>3.1 HelloWorld</h3> 
<p>CentOS7默认已经安装了Lua语言环境，所以可以直接运行Lua代码。</p> 
<p>1）在Linux虚拟机的任意目录下，新建一个hello.lua文件<br> <img src="https://images2.imgbox.com/7d/00/1lN9xdcZ_o.png" alt="在这里插入图片描述"><br> 2）添加下面的内容</p> 
<pre><code class="prism language-lua"><span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span>  
</code></pre> 
<p>3）运行<br> <img src="https://images2.imgbox.com/89/1a/QpQoQUPg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="32__591"></a>3.2 变量和循环</h3> 
<p>学习任何语言必然离不开变量，而变量的声明必须先知道数据的类型。</p> 
<h4><a id="321_Lua_595"></a>3.2.1 Lua的数据类型</h4> 
<p>Lua中支持的常见数据类型包括：<br> <img src="https://images2.imgbox.com/16/5f/xxotuypp_o.png" alt="在这里插入图片描述"></p> 
<p>另外，Lua提供了type()函数来判断一个变量的数据类型：<br> <img src="https://images2.imgbox.com/11/20/U4tS51le_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="322__603"></a>3.2.2 声明变量</h4> 
<p>Lua声明变量的时候无需指定数据类型，而是用local来声明变量为局部变量：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 声明字符串，可以用单引号或双引号，</span>
<span class="token keyword">local</span> str <span class="token operator">=</span> <span class="token string">'hello'</span>
<span class="token comment">-- 字符串拼接可以使用 ..</span>
<span class="token keyword">local</span> str2 <span class="token operator">=</span> <span class="token string">'hello'</span> <span class="token operator">..</span> <span class="token string">'world'</span>
<span class="token comment">-- 声明数字</span>
<span class="token keyword">local</span> num <span class="token operator">=</span> <span class="token number">21</span>
<span class="token comment">-- 声明布尔类型</span>
<span class="token keyword">local</span> flag <span class="token operator">=</span> <span class="token keyword">true</span>
</code></pre> 
<p>Lua中的table类型既可以作为数组，又可以作为Java中的map来使用。数组就是特殊的table，key是数组角标而已：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 声明数组 ，key为角标的 table</span>
<span class="token keyword">local</span> arr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'python'</span><span class="token punctuation">,</span> <span class="token string">'lua'</span><span class="token punctuation">}</span>
<span class="token comment">-- 声明table，类似java的map</span>
<span class="token keyword">local</span> map <span class="token operator">=</span>  <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">}</span>
</code></pre> 
<p>Lua中的数组角标是从1开始，访问的时候与Java中类似：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 访问数组，lua数组的角标从1开始</span>
<span class="token function">print</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre> 
<p>Lua中的table可以用key来访问：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 访问table</span>
<span class="token function">print</span><span class="token punctuation">(</span>map<span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token function">print</span><span class="token punctuation">(</span>map<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="323__643"></a>3.2.3 循环</h4> 
<p>对于table，我们可以利用for循环来遍历。不过数组和普通table遍历略有差异。</p> 
<p>遍历数组：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 声明数组 key为索引的 table</span>
<span class="token keyword">local</span> arr <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">'java'</span><span class="token punctuation">,</span> <span class="token string">'python'</span><span class="token punctuation">,</span> <span class="token string">'lua'</span><span class="token punctuation">}</span>
<span class="token comment">-- 遍历数组</span>
<span class="token keyword">for</span> index<span class="token punctuation">,</span>value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token keyword">do</span>
    <span class="token function">print</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> value<span class="token punctuation">)</span> 
<span class="token keyword">end</span>
</code></pre> 
<p>遍历普通table</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 声明map，也就是table</span>
<span class="token keyword">local</span> map <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>name<span class="token operator">=</span><span class="token string">'Jack'</span><span class="token punctuation">,</span> age<span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">}</span>
<span class="token comment">-- 遍历table</span>
<span class="token keyword">for</span> key<span class="token punctuation">,</span>value <span class="token keyword">in</span> <span class="token function">pairs</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span> <span class="token keyword">do</span>
   <span class="token function">print</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> 
<span class="token keyword">end</span>
</code></pre> 
<h3><a id="33__668"></a>3.3 条件控制、函数</h3> 
<p>Lua中的条件控制和函数声明与Java类似。</p> 
<h4><a id="331__672"></a>3.3.1 函数</h4> 
<p>定义函数的语法：</p> 
<pre><code class="prism language-lua"><span class="token keyword">function</span> 函数名<span class="token punctuation">(</span> argument1<span class="token punctuation">,</span> argument2<span class="token punctuation">...</span><span class="token punctuation">,</span> argumentn<span class="token punctuation">)</span>
    <span class="token comment">-- 函数体</span>
    <span class="token keyword">return</span> 返回值
<span class="token keyword">end</span>
</code></pre> 
<p>例如，定义一个函数，用来打印数组：</p> 
<pre><code class="prism language-lua"><span class="token keyword">function</span> <span class="token function">printArr</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token function">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> 
<h4><a id="332__694"></a>3.3.2 条件控制</h4> 
<p>类似Java的条件控制，例如if、else语法：</p> 
<pre><code class="prism language-lua"><span class="token keyword">if</span><span class="token punctuation">(</span>布尔表达式<span class="token punctuation">)</span>
<span class="token keyword">then</span>
   <span class="token comment">--[ 布尔表达式为 true 时执行该语句块 --]</span>
<span class="token keyword">else</span>
   <span class="token comment">--[ 布尔表达式为 false 时执行该语句块 --]</span>
<span class="token keyword">end</span>

</code></pre> 
<p>与java不同，布尔表达式中的逻辑运算是基于英文单词：<br> <img src="https://images2.imgbox.com/f5/d7/W14as3mq_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="333__712"></a>3.3.3 案例</h4> 
<p>需求：自定义一个函数，可以打印table，当参数为nil时，打印错误信息</p> 
<pre><code class="prism language-lua"><span class="token keyword">function</span> <span class="token function">printArr</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> arr <span class="token keyword">then</span>
        <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">'数组不能为空！'</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token keyword">in</span> <span class="token function">ipairs</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token keyword">do</span>
        <span class="token function">print</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> 
<h2><a id="4__728"></a>4 实现多级缓存</h2> 
<p>多级缓存的实现离不开Nginx编程，而Nginx编程又离不开OpenResty。</p> 
<h3><a id="41_OpenResty_732"></a>4.1 安装OpenResty</h3> 
<p>OpenResty® 是一个基于 Nginx的高性能 Web 平台，用于方便地搭建能够处理超高并发、扩展性极高的动态 Web 应用、Web 服务和动态网关。具备下列特点：</p> 
<ul><li>具备Nginx的完整功能</li><li>基于Lua语言进行扩展，集成了大量精良的 Lua 库、第三方模块</li><li>允许使用Lua<strong>自定义业务逻辑</strong>、<strong>自定义库</strong></li></ul> 
<p>官方网站： <a href="https://openresty.org/cn/" rel="nofollow">https://openresty.org/cn/</a><br> <img src="https://images2.imgbox.com/58/63/gAcZKpC3_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1_742"></a>1.安装</h4> 
<p>首先你的Linux虚拟机必须联网</p> 
<h5><a id="1_745"></a><strong>1）安装开发库</strong></h5> 
<p>首先要安装OpenResty的依赖开发库，执行命令：</p> 
<pre><code class="prism language-sh">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> pcre-devel openssl-devel gcc --skip-broken
</code></pre> 
<h5><a id="2OpenResty_752"></a><strong>2）安装OpenResty仓库</strong></h5> 
<p>你可以在你的 CentOS 系统中添加 <code>openresty</code> 仓库，这样就可以便于未来安装或更新我们的软件包（通过 <code>yum check-update</code> 命令）。运行下面的命令就可以添加我们的仓库：</p> 
<pre><code class="prism language-sh">yum-config-manager --add-repo https://openresty.org/package/centos/openresty.repo
</code></pre> 
<p>如果提示说命令不存在，则运行：</p> 
<pre><code class="prism language-sh">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> yum-utils 
</code></pre> 
<p>然后再重复上面的命令</p> 
<h5><a id="3OpenResty_765"></a><strong>3）安装OpenResty</strong></h5> 
<p>然后就可以像下面这样安装软件包，比如 <code>openresty</code>：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> openresty
</code></pre> 
<h5><a id="4opm_772"></a><strong>4）安装opm工具</strong></h5> 
<p>opm是OpenResty的一个管理工具，可以帮助我们安装一个第三方的Lua模块。</p> 
<p>如果你想安装命令行工具 <code>opm</code>，那么可以像下面这样安装 <code>openresty-opm</code> 包：</p> 
<pre><code class="prism language-bash">yum <span class="token function">install</span> <span class="token parameter variable">-y</span> openresty-opm
</code></pre> 
<h5><a id="5_781"></a><strong>5）目录结构</strong></h5> 
<p>默认情况下，<code>OpenResty</code>安装的目录是：<code>/usr/local/openresty</code><br> <img src="https://images2.imgbox.com/5d/ae/MtrOaLim_o.png" alt="在这里插入图片描述"><br> 看到里面的nginx目录了吗，OpenResty就是在Nginx基础上集成了一些Lua模块。</p> 
<h5><a id="6nginx_786"></a><strong>6）配置nginx的环境变量</strong></h5> 
<p>打开配置文件：</p> 
<pre><code class="prism language-sh"><span class="token function">vi</span> /etc/profile
</code></pre> 
<p>在最下面加入两行：</p> 
<pre><code class="prism language-sh"><span class="token builtin class-name">export</span> <span class="token assign-left variable">NGINX_HOME</span><span class="token operator">=</span>/usr/local/openresty/nginx
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token variable">${NGINX_HOME}</span>/sbin:<span class="token environment constant">$PATH</span>
</code></pre> 
<p>NGINX_HOME：后面是OpenResty安装目录下的nginx的目录</p> 
<p>然后让配置生效：</p> 
<pre><code>source /etc/profile
</code></pre> 
<h4><a id="2_808"></a>2.启动和运行</h4> 
<p>OpenResty底层是基于Nginx的，查看OpenResty目录的nginx目录，结构与windows中安装的nginx基本一致：<br> <img src="https://images2.imgbox.com/7d/01/bIMaT0eF_o.png" alt="在这里插入图片描述"></p> 
<p>所以运行方式与nginx基本一致：</p> 
<pre><code class="prism language-sh"><span class="token comment"># 启动nginx</span>
nginx
<span class="token comment"># 重新加载配置</span>
nginx <span class="token parameter variable">-s</span> reload
<span class="token comment"># 停止</span>
nginx <span class="token parameter variable">-s</span> stop
</code></pre> 
<p>nginx的默认配置文件注释太多，影响后续我们的编辑，这里将nginx.conf中的注释部分删除，保留有效部分。</p> 
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，内容如下：</p> 
<pre><code class="prism language-javascript">
#user  nobody<span class="token punctuation">;</span>
worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>
error_log  logs<span class="token operator">/</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    include       mime<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
    default_type  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>

    server <span class="token punctuation">{<!-- --></span>
        listen       <span class="token number">8081</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            root   html<span class="token punctuation">;</span>
            index  index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span>50x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> <span class="token operator">/</span>50x<span class="token punctuation">.</span>html <span class="token punctuation">{<!-- --></span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在Linux的控制台输入命令以启动nginx：</p> 
<pre><code class="prism language-sh">nginx
</code></pre> 
<p>然后访问页面：http://192.168.150.101:8081，注意ip地址替换为你自己的虚拟机IP：</p> 
<h3><a id="42_OpenResty_872"></a>4.2 OpenResty快速入门</h3> 
<p>我们希望达到的多级缓存架构如图：<br> <img src="https://images2.imgbox.com/d7/b2/V4VWojbF_o.png" alt="在这里插入图片描述"><br> 其中：</p> 
<ul><li> <p>windows上的nginx用来做反向代理服务，将前端的查询商品的ajax请求代理到OpenResty集群</p> </li><li> <p>OpenResty集群用来编写多级缓存业务</p> </li></ul> 
<h4><a id="421__881"></a>4.2.1 反向代理流程</h4> 
<p>现在，商品详情页使用的是假的商品数据。不过在浏览器中，可以看到页面有发起ajax请求查询真实商品数据。</p> 
<p>这个请求如下：<br> <img src="https://images2.imgbox.com/f9/89/XupD8B0D_o.png" alt="在这里插入图片描述"><br> 请求地址是localhost，端口是80，就被windows上安装的Nginx服务给接收到了。然后代理给了OpenResty集群：<br> <img src="https://images2.imgbox.com/f1/cd/hSXxHXAs_o.png" alt="在这里插入图片描述"><br> 我们需要在OpenResty中编写业务，查询商品数据并返回到浏览器。</p> 
<p>但是这次，我们先在OpenResty接收请求，返回假的商品数据。</p> 
<h4><a id="422_OpenResty_892"></a>4.2.2 OpenResty监听请求</h4> 
<p>OpenResty的很多功能都依赖于其目录下的Lua库，需要在nginx.conf中指定依赖库的目录，并导入依赖：</p> 
<p>1）添加对OpenResty的Lua模块的加载</p> 
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，在其中的http下面，添加下面代码：</p> 
<pre><code class="prism language-nginx">#lua 模块
lua_package_path "/usr/local/openresty/lualib/?.lua;;";
#c模块     
lua_package_cpath "/usr/local/openresty/lualib/?.so;;";  
</code></pre> 
<p>2）监听/api/item路径</p> 
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，在nginx.conf的server下面，添加对/api/item这个路径的监听：</p> 
<pre><code class="prism language-nginx">location  /api/item {
    # 默认的响应类型
    default_type application/json;
    # 响应结果由lua/item.lua文件来决定
    content_by_lua_file lua/item.lua;
}
</code></pre> 
<p>这个监听，就类似于SpringMVC中的<code>@GetMapping("/api/item")</code>做路径映射。</p> 
<p>而<code>content_by_lua_file lua/item.lua</code>则相当于调用item.lua这个文件，执行其中的业务，把结果返回给用户。相当于java中调用service。</p> 
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，最终内容如下：</p> 
<pre><code class="prism language-javascript">#user  nobody<span class="token punctuation">;</span>
worker_processes  <span class="token number">1</span><span class="token punctuation">;</span>
error_log  logs<span class="token operator">/</span>error<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

events <span class="token punctuation">{<!-- --></span>
    worker_connections  <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

http <span class="token punctuation">{<!-- --></span>
    include       mime<span class="token punctuation">.</span>types<span class="token punctuation">;</span>
    default_type  application<span class="token operator">/</span>octet<span class="token operator">-</span>stream<span class="token punctuation">;</span>
    sendfile        on<span class="token punctuation">;</span>
    keepalive_timeout  <span class="token number">65</span><span class="token punctuation">;</span>
    
    # lua模块
    lua_package_path <span class="token string">"/usr/local/openresty/lualib/?.lua;;"</span><span class="token punctuation">;</span>
    # c模块     
    lua_package_cpath <span class="token string">"/usr/local/openresty/lualib/?.so;;"</span><span class="token punctuation">;</span> 

    server <span class="token punctuation">{<!-- --></span>
        listen       <span class="token number">8081</span><span class="token punctuation">;</span>
        server_name  localhost<span class="token punctuation">;</span>
        location <span class="token operator">/</span>api<span class="token operator">/</span>item <span class="token punctuation">{<!-- --></span>
            # 默认的响应类型
            default_type application<span class="token operator">/</span>json<span class="token punctuation">;</span>
            # 响应结果由lua<span class="token operator">/</span>item<span class="token punctuation">.</span>lua文件来决定
            content_by_lua_file lua<span class="token operator">/</span>item<span class="token punctuation">.</span>lua<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        location <span class="token operator">/</span> <span class="token punctuation">{<!-- --></span>
            root   html<span class="token punctuation">;</span>
            index  index<span class="token punctuation">.</span>html index<span class="token punctuation">.</span>htm<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        error_page   <span class="token number">500</span> <span class="token number">502</span> <span class="token number">503</span> <span class="token number">504</span>  <span class="token operator">/</span>50x<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
        location <span class="token operator">=</span> <span class="token operator">/</span>50x<span class="token punctuation">.</span>html <span class="token punctuation">{<!-- --></span>
            root   html<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="423itemlua_965"></a>4.2.3.编写item.lua</h4> 
<p>1）在<code>/usr/loca/openresty/nginx</code>目录创建文件夹：lua<br> <img src="https://images2.imgbox.com/b9/3a/BVYRpLpw_o.png" alt="在这里插入图片描述"><br> 2）在<code>/usr/loca/openresty/nginx/lua</code>文件夹下，新建文件：item.lua<br> <img src="https://images2.imgbox.com/b1/35/1Y47mAF8_o.png" alt="在这里插入图片描述"><br> 3）编写item.lua，返回假数据</p> 
<p>item.lua中，利用ngx.say()函数返回数据到Response中</p> 
<pre><code class="prism language-lua">ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'{"id":10001,"name":"SALSA AIR","title":"RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"拉杆箱","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}'</span><span class="token punctuation">)</span>
</code></pre> 
<p>4）重新加载配置</p> 
<pre><code class="prism language-sh">nginx <span class="token parameter variable">-s</span> reload
</code></pre> 
<p>刷新商品页面：http://localhost/item.html?id=1001，即可看到效果：<br> <img src="https://images2.imgbox.com/c6/2d/vJyg8juI_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43__986"></a>4.3 请求参数处理</h3> 
<p>上一节中，我们在OpenResty接收前端请求，但是返回的是假数据。</p> 
<p>要返回真实数据，必须根据前端传递来的商品id，查询商品信息才可以。</p> 
<p>那么如何获取前端传递的商品参数呢？</p> 
<h4><a id="431_API_993"></a>4.3.1 获取参数的API</h4> 
<p>OpenResty中提供了一些API用来获取不同类型的前端请求参数：<br> <img src="https://images2.imgbox.com/36/cb/mKCE2yKC_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="432__997"></a>4.3.2 获取参数并返回</h4> 
<p>在前端发起的ajax请求如图：<br> <img src="https://images2.imgbox.com/99/2e/uFZ4nexq_o.png" alt="在这里插入图片描述"></p> 
<p>可以看到商品id是以路径占位符方式传递的，因此可以利用正则表达式匹配的方式来获取ID</p> 
<p>1）获取商品id</p> 
<p>修改<code>/usr/loca/openresty/nginx/nginx.conf</code>文件中监听/api/item的代码，利用正则表达式获取ID：</p> 
<pre><code class="prism language-nginx">location ~ /api/item/(\d+) {
    # 默认的响应类型
    default_type application/json;
    # 响应结果由lua/item.lua文件来决定
    content_by_lua_file lua/item.lua;
}
</code></pre> 
<p>2）拼接ID并返回</p> 
<p>修改<code>/usr/loca/openresty/nginx/lua/item.lua</code>文件，获取id并拼接到结果中返回：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 获取商品id</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 拼接并返回</span>
ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span><span class="token string">'{"id":'</span> <span class="token operator">..</span> id <span class="token operator">..</span> <span class="token string">',"name":"SALSA AIR","title":"RIMOWA 21寸托运箱拉杆箱 SALSA AIR系列果绿色 820.70.36.4","price":17900,"image":"https://m.360buyimg.com/mobilecms/s720x720_jfs/t6934/364/1195375010/84676/e9f2c55f/597ece38N0ddcbc77.jpg!q70.jpg.webp","category":"拉杆箱","brand":"RIMOWA","spec":"","status":1,"createTime":"2019-04-30T16:00:00.000+00:00","updateTime":"2019-04-30T16:00:00.000+00:00","stock":2999,"sold":31290}'</span><span class="token punctuation">)</span>
</code></pre> 
<p>3）重新加载并测试</p> 
<p>运行命令以重新加载OpenResty配置：</p> 
<pre><code class="prism language-sh">nginx <span class="token parameter variable">-s</span> reload
</code></pre> 
<p>刷新页面可以看到结果中已经带上了ID：<br> <img src="https://images2.imgbox.com/57/35/rAqlydpl_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="44_Tomcat_1037"></a>4.4 查询Tomcat</h3> 
<p><img src="https://images2.imgbox.com/b7/37/EzluXAqD_o.png" alt="在这里插入图片描述"></p> 
<p>拿到商品ID后，本应去缓存中查询商品信息，不过目前我们还未建立nginx、redis缓存。因此，这里我们先根据商品id去tomcat查询商品信息。我们实现如图部分：<br> <img src="https://images2.imgbox.com/d6/c6/VoPo6skk_o.png" alt="在这里插入图片描述"></p> 
<p>需要注意的是，我们的OpenResty是在虚拟机，Tomcat是在Windows电脑上。两者IP一定不要搞错了。<br> <img src="https://images2.imgbox.com/13/22/02GBhlpf_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="441_httpAPI_1046"></a>4.4.1 发送http请求的API</h4> 
<p>nginx提供了内部API用以发送http请求：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> resp <span class="token operator">=</span> ngx<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span><span class="token string">"/path"</span><span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
    method <span class="token operator">=</span> ngx<span class="token punctuation">.</span>HTTP_GET<span class="token punctuation">,</span>   <span class="token comment">-- 请求方式</span>
    args <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>a<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span>b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment">-- get方式传参数</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> 
<p>返回的响应内容包括：</p> 
<ul><li>resp.status：响应状态码</li><li>resp.header：响应头，是一个table</li><li>resp.body：响应体，就是响应数据</li></ul> 
<p>注意：这里的path是路径，并不包含IP和端口。这个请求会被nginx内部的server监听并处理。</p> 
<p>但是我们希望这个请求发送到Tomcat服务器，所以还需要编写一个server来对这个路径做反向代理：</p> 
<pre><code class="prism language-nginx"> location /path {
     # 这里是windows电脑的ip和Java服务端口，需要确保windows防火墙处于关闭状态
     proxy_pass http://192.168.150.1:8081; 
 }
</code></pre> 
<p>原理如图：<br> <img src="https://images2.imgbox.com/79/5c/ARMHIqh0_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="442_http_1076"></a>4.4.2 封装http工具</h4> 
<p>下面，我们封装一个发送Http请求的工具，基于ngx.location.capture来实现查询tomcat。</p> 
<p>1）添加反向代理，到windows的Java服务</p> 
<p>因为item-service中的接口都是/item开头，所以我们监听/item路径，代理到windows上的tomcat服务。</p> 
<p>修改 <code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，添加一个location：</p> 
<pre><code class="prism language-nginx">location /item {
    proxy_pass http://192.168.150.1:8081;
}
</code></pre> 
<p>以后，只要我们调用<code>ngx.location.capture("/item")</code>，就一定能发送请求到windows的tomcat服务。</p> 
<p>2）封装工具类</p> 
<p>之前我们说过，OpenResty启动时会加载以下两个目录中的工具文件：<br> <img src="https://images2.imgbox.com/7b/4d/XavSCbxM_o.png" alt="在这里插入图片描述"><br> 所以，自定义的http工具也需要放到这个目录下。</p> 
<p>在<code>/usr/local/openresty/lualib</code>目录下，新建一个common.lua文件：</p> 
<pre><code class="prism language-sh"><span class="token function">vi</span> /usr/local/openresty/lualib/common.lua
</code></pre> 
<p>内容如下:</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 封装函数，发送http请求，并解析响应</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token keyword">local</span> resp <span class="token operator">=</span> ngx<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
        method <span class="token operator">=</span> ngx<span class="token punctuation">.</span>HTTP_GET<span class="token punctuation">,</span>
        args <span class="token operator">=</span> params<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span>
        <span class="token comment">-- 记录错误信息，返回404</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"http请求查询失败, path: "</span><span class="token punctuation">,</span> path <span class="token punctuation">,</span> <span class="token string">", args: "</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        ngx<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>body
<span class="token keyword">end</span>
<span class="token comment">-- 将方法导出</span>
<span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>  
    read_http <span class="token operator">=</span> read_http
<span class="token punctuation">}</span>  
<span class="token keyword">return</span> _M
</code></pre> 
<p>这个工具将read_http函数封装到_M这个table类型的变量中，并且返回，这类似于导出。</p> 
<p>使用的时候，可以利用<code>require('common')</code>来导入该函数库，这里的common是函数库的文件名。</p> 
<p>3）实现商品查询</p> 
<p>最后，我们修改<code>/usr/local/openresty/lua/item.lua</code>文件，利用刚刚封装的函数库实现对tomcat的查询：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 引入自定义common工具模块，返回值是common中返回的 _M</span>
<span class="token keyword">local</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"common"</span><span class="token punctuation">)</span>
<span class="token comment">-- 从 common中获取read_http这个函数</span>
<span class="token keyword">local</span> read_http <span class="token operator">=</span> common<span class="token punctuation">.</span>read_http
<span class="token comment">-- 获取路径参数</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 根据id查询商品</span>
<span class="token keyword">local</span> itemJSON <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span><span class="token string">"/item/"</span><span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
<span class="token comment">-- 根据id查询商品库存</span>
<span class="token keyword">local</span> itemStockJSON <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span><span class="token string">"/item/stock/"</span><span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
</code></pre> 
<p>这里查询到的结果是json字符串，并且包含商品、库存两个json字符串，页面最终需要的是把两个json拼接为一个json：<br> <img src="https://images2.imgbox.com/9c/d8/XjMpLLJ2_o.png" alt="在这里插入图片描述"><br> 这就需要我们先把JSON变为lua的table，完成数据整合后，再转为JSON。</p> 
<h4><a id="443_CJSON_1154"></a>4.4.3 CJSON工具类</h4> 
<p>OpenResty提供了一个cjson的模块用来处理JSON的序列化和反序列化。</p> 
<p>官方地址：<a href="https://github.com/openresty/lua-cjson/"> https://github.com/openresty/lua-cjson/</a></p> 
<p>1）引入cjson模块：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> cjson <span class="token operator">=</span> require <span class="token string">"cjson"</span>
</code></pre> 
<p>2）序列化：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> obj <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    name <span class="token operator">=</span> <span class="token string">'jack'</span><span class="token punctuation">,</span>
    age <span class="token operator">=</span> <span class="token number">21</span>
<span class="token punctuation">}</span>
<span class="token comment">-- 把 table 序列化为 json</span>
<span class="token keyword">local</span> json <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span>
</code></pre> 
<p>3）反序列化：</p> 
<pre><code class="prism language-lua"><span class="token keyword">local</span> json <span class="token operator">=</span> <span class="token string">'{"name": "jack", "age": 21}'</span>
<span class="token comment">-- 反序列化 json为 table</span>
<span class="token keyword">local</span> obj <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre> 
<h4><a id="444Tomcat_1187"></a>4.4.4.实现Tomcat查询</h4> 
<p>下面，我们修改之前的item.lua中的业务，添加json处理功能：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入common函数库</span>
<span class="token keyword">local</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'common'</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> read_http <span class="token operator">=</span> common<span class="token punctuation">.</span>read_http
<span class="token comment">-- 导入cjson库</span>
<span class="token keyword">local</span> cjson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cjson'</span><span class="token punctuation">)</span>

<span class="token comment">-- 获取路径参数</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
<span class="token comment">-- 根据id查询商品</span>
<span class="token keyword">local</span> itemJSON <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span><span class="token string">"/item/"</span><span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
<span class="token comment">-- 根据id查询商品库存</span>
<span class="token keyword">local</span> itemStockJSON <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span><span class="token string">"/item/stock/"</span><span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>

<span class="token comment">-- JSON转化为lua的table</span>
<span class="token keyword">local</span> item <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>itemJSON<span class="token punctuation">)</span>
<span class="token keyword">local</span> stock <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>stockJSON<span class="token punctuation">)</span>

<span class="token comment">-- 组合数据</span>
item<span class="token punctuation">.</span>stock <span class="token operator">=</span> stock<span class="token punctuation">.</span>stock
item<span class="token punctuation">.</span>sold <span class="token operator">=</span> stock<span class="token punctuation">.</span>sold

<span class="token comment">-- 把item序列化为json 返回结果</span>
ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="445_ID_1219"></a>4.4.5 基于ID负载均衡</h4> 
<p>刚才的代码中，我们的tomcat是单机部署。而实际开发中，tomcat一定是集群模式：<br> <img src="https://images2.imgbox.com/1f/28/L2txCBTw_o.png" alt="在这里插入图片描述"><br> 因此，OpenResty需要对tomcat集群做负载均衡。</p> 
<p>而默认的负载均衡规则是轮询模式，当我们查询/item/10001时：</p> 
<ul><li>第一次会访问8081端口的tomcat服务，在该服务内部就形成了JVM进程缓存</li><li>第二次会访问8082端口的tomcat服务，该服务内部没有JVM缓存（因为JVM缓存无法共享），会查询数据库</li><li>…</li></ul> 
<p>你看，因为轮询的原因，第一次查询8081形成的JVM缓存并未生效，直到下一次再次访问到8081时才可以生效，缓存命中率太低了。</p> 
<p>怎么办？</p> 
<p>如果能让同一个商品，每次查询时都访问同一个tomcat服务，那么JVM缓存就一定能生效了。</p> 
<p>也就是说，我们需要根据商品id做负载均衡，而不是轮询。</p> 
<h5><a id="1_1241"></a>1）原理</h5> 
<p>nginx提供了基于请求路径做负载均衡的算法：</p> 
<p>nginx根据请求路径做hash运算，把得到的数值对tomcat服务的数量取余，余数是几，就访问第几个服务，实现负载均衡。</p> 
<p>例如：</p> 
<ul><li>我们的请求路径是 /item/10001</li><li>tomcat总数为2台（8081、8082）</li><li>对请求路径/item/1001做hash运算求余的结果为1</li><li>则访问第一个tomcat服务，也就是8081</li></ul> 
<p>只要id不变，每次hash运算结果也不会变，那就可以保证同一个商品，一直访问同一个tomcat服务，确保JVM缓存生效。</p> 
<h5><a id="2_1260"></a>2）实现</h5> 
<p>修改<code>/usr/local/openresty/nginx/conf/nginx.conf</code>文件，实现基于ID做负载均衡。</p> 
<p>首先，定义tomcat集群，并设置基于路径做负载均衡：</p> 
<pre><code class="prism language-nginx">upstream tomcat-cluster {
    hash $request_uri;
    server 192.168.150.1:8081;
    server 192.168.150.1:8082;
}
</code></pre> 
<p>然后，修改对tomcat服务的反向代理，目标指向tomcat集群：</p> 
<pre><code class="prism language-nginx">location /item {
    proxy_pass http://tomcat-cluster;
}
</code></pre> 
<p>重新加载OpenResty</p> 
<pre><code class="prism language-sh">nginx <span class="token parameter variable">-s</span> reload
</code></pre> 
<h5><a id="3_1292"></a>3）测试</h5> 
<p>启动两台tomcat服务：<br> <img src="https://images2.imgbox.com/4e/f6/AQUk9nYi_o.png" alt="在这里插入图片描述"></p> 
<p>同时启动：<br> <img src="https://images2.imgbox.com/72/bb/uMKIYEIJ_o.png" alt="在这里插入图片描述"></p> 
<p>清空日志后，再次访问页面，可以看到不同id的商品，访问到了不同的tomcat服务：<br> <img src="https://images2.imgbox.com/a7/14/5jmclUL7_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b2/48/s50K4PKg_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="45_Redis_1305"></a>4.5 Redis缓存预热</h3> 
<p>Redis缓存会面临冷启动问题：</p> 
<p><strong>冷启动</strong>：服务刚刚启动时，Redis中并没有缓存，如果所有商品数据都在第一次查询时添加缓存，可能会给数据库带来较大压力。</p> 
<p><strong>缓存预热</strong>：在实际开发中，我们可以利用大数据统计用户访问的热点数据，在项目启动时将这些热点数据提前查询并保存到Redis中。</p> 
<p>我们数据量较少，并且没有数据统计相关功能，目前可以在启动时将所有数据都放入缓存中。</p> 
<p>1）利用Docker安装Redis</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">--name</span> redis <span class="token parameter variable">-p</span> <span class="token number">6379</span>:6379 <span class="token parameter variable">-d</span> redis redis-server <span class="token parameter variable">--appendonly</span> <span class="token function">yes</span>
</code></pre> 
<p>2）在item-service服务中引入Redis依赖</p> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-data-redis<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<p>3）配置Redis地址</p> 
<pre><code class="prism language-yaml"><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">host</span><span class="token punctuation">:</span> 192.168.150.101
</code></pre> 
<p>4）编写初始化类</p> 
<p>缓存预热需要在项目启动时完成，并且必须是拿到<code>RedisTemplate</code>之后。</p> 
<p>这里我们利用<code>InitializingBean</code>接口来实现，因为<code>InitializingBean</code>可以在对象被<code>Spring</code>创建并且成员变量全部注入后执行。</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Item</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">ItemStock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IItemService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IItemStockService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IItemService</span> itemService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IItemStockService</span> stockService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> <span class="token constant">MAPPER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 初始化缓存</span>
        <span class="token comment">// 1.查询商品信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemList <span class="token operator">=</span> itemService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.放入缓存</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Item</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.1.item序列化为JSON</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.2.存入redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"item:id:"</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.查询商品库存信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemStock</span><span class="token punctuation">&gt;</span></span> stockList <span class="token operator">=</span> stockService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.放入缓存</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ItemStock</span> stock <span class="token operator">:</span> stockList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.1.item序列化为JSON</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.2.存入redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"item:stock:id:"</span> <span class="token operator">+</span> stock<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="46_Redis_1404"></a>4.6 查询Redis缓存</h3> 
<p>现在，Redis缓存已经准备就绪，我们可以再OpenResty中实现查询Redis的逻辑了。如下图红框所示：<br> <img src="https://images2.imgbox.com/f1/97/9k3kThBW_o.png" alt="在这里插入图片描述"></p> 
<p>当请求进入OpenResty之后：</p> 
<ul><li>优先查询Redis缓存</li><li>如果Redis缓存未命中，再查询Tomcat</li></ul> 
<h4><a id="461_Redis_1417"></a>4.6.1 封装Redis工具</h4> 
<p>OpenResty提供了操作Redis的模块，我们只要引入该模块就能直接使用。但是为了方便，我们将Redis操作封装到之前的common.lua工具库中。</p> 
<p>修改<code>/usr/local/openresty/lualib/common.lua</code>文件：</p> 
<p>1）引入Redis模块，并初始化Redis对象</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入redis</span>
<span class="token keyword">local</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'resty.redis'</span><span class="token punctuation">)</span>
<span class="token comment">-- 初始化redis</span>
<span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
red<span class="token punctuation">:</span><span class="token function">set_timeouts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
</code></pre> 
<p>2）封装函数，用来释放Redis连接，其实是放入连接池</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 关闭redis连接的工具方法，其实是放入连接池</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">close_redis</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span>
    <span class="token keyword">local</span> pool_max_idle_time <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">-- 连接的空闲时间，单位是毫秒</span>
    <span class="token keyword">local</span> pool_size <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment">--连接池大小</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">set_keepalive</span><span class="token punctuation">(</span>pool_max_idle_time<span class="token punctuation">,</span> pool_size<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"放入redis连接池失败: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>
</code></pre> 
<p>3）封装函数，根据key查询Redis数据</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_redis</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">-- 获取一个连接</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"连接redis失败 : "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 查询redis</span>
    <span class="token keyword">local</span> resp<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token comment">-- 查询失败处理</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"查询Redis失败: "</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token string">", key = "</span> <span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">--得到的数据为空处理</span>
    <span class="token keyword">if</span> resp <span class="token operator">==</span> ngx<span class="token punctuation">.</span>null <span class="token keyword">then</span>
        resp <span class="token operator">=</span> <span class="token keyword">nil</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"查询Redis数据为空, key = "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token function">close_redis</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp
<span class="token keyword">end</span>
</code></pre> 
<p>4）导出</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 将方法导出</span>
<span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>  
    read_http <span class="token operator">=</span> read_http<span class="token punctuation">,</span>
    read_redis <span class="token operator">=</span> read_redis
<span class="token punctuation">}</span>  
<span class="token keyword">return</span> _M
</code></pre> 
<p>完整的common.lua：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入redis</span>
<span class="token keyword">local</span> redis <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'resty.redis'</span><span class="token punctuation">)</span>
<span class="token comment">-- 初始化redis</span>
<span class="token keyword">local</span> red <span class="token operator">=</span> redis<span class="token punctuation">:</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
red<span class="token punctuation">:</span><span class="token function">set_timeouts</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>

<span class="token comment">-- 关闭redis连接的工具方法，其实是放入连接池</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">close_redis</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span>
    <span class="token keyword">local</span> pool_max_idle_time <span class="token operator">=</span> <span class="token number">10000</span> <span class="token comment">-- 连接的空闲时间，单位是毫秒</span>
    <span class="token keyword">local</span> pool_size <span class="token operator">=</span> <span class="token number">100</span> <span class="token comment">--连接池大小</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">set_keepalive</span><span class="token punctuation">(</span>pool_max_idle_time<span class="token punctuation">,</span> pool_size<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"放入redis连接池失败: "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
<span class="token keyword">end</span>

<span class="token comment">-- 查询redis的方法 ip和port是redis地址，key是查询的key</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_redis</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">-- 获取一个连接</span>
    <span class="token keyword">local</span> ok<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">connect</span><span class="token punctuation">(</span>ip<span class="token punctuation">,</span> port<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> ok <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"连接redis失败 : "</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">nil</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 查询redis</span>
    <span class="token keyword">local</span> resp<span class="token punctuation">,</span> err <span class="token operator">=</span> red<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token comment">-- 查询失败处理</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"查询Redis失败: "</span><span class="token punctuation">,</span> err<span class="token punctuation">,</span> <span class="token string">", key = "</span> <span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">--得到的数据为空处理</span>
    <span class="token keyword">if</span> resp <span class="token operator">==</span> ngx<span class="token punctuation">.</span>null <span class="token keyword">then</span>
        resp <span class="token operator">=</span> <span class="token keyword">nil</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"查询Redis数据为空, key = "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token function">close_redis</span><span class="token punctuation">(</span>red<span class="token punctuation">)</span>
    <span class="token keyword">return</span> resp
<span class="token keyword">end</span>

<span class="token comment">-- 封装函数，发送http请求，并解析响应</span>
<span class="token keyword">local</span> <span class="token keyword">function</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token keyword">local</span> resp <span class="token operator">=</span> ngx<span class="token punctuation">.</span>location<span class="token punctuation">.</span><span class="token function">capture</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span><span class="token punctuation">{<!-- --></span>
        method <span class="token operator">=</span> ngx<span class="token punctuation">.</span>HTTP_GET<span class="token punctuation">,</span>
        args <span class="token operator">=</span> params<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> resp <span class="token keyword">then</span>
        <span class="token comment">-- 记录错误信息，返回404</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"http查询失败, path: "</span><span class="token punctuation">,</span> path <span class="token punctuation">,</span> <span class="token string">", args: "</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span>
        ngx<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token keyword">return</span> resp<span class="token punctuation">.</span>body
<span class="token keyword">end</span>
<span class="token comment">-- 将方法导出</span>
<span class="token keyword">local</span> _M <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>  
    read_http <span class="token operator">=</span> read_http<span class="token punctuation">,</span>
    read_redis <span class="token operator">=</span> read_redis
<span class="token punctuation">}</span>  
<span class="token keyword">return</span> _M
</code></pre> 
<h4><a id="462_Redis_1560"></a>4.6.2 实现Redis查询</h4> 
<p>接下来，我们就可以去修改item.lua文件，实现对Redis的查询了。</p> 
<p>查询逻辑是：</p> 
<ul><li>根据id查询Redis</li><li>如果查询失败则继续查询Tomcat</li><li>将查询结果返回</li></ul> 
<p>1）修改<code>/usr/local/openresty/lua/item.lua</code>文件，添加一个查询函数：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入common函数库</span>
<span class="token keyword">local</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'common'</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> read_http <span class="token operator">=</span> common<span class="token punctuation">.</span>read_http
<span class="token keyword">local</span> read_redis <span class="token operator">=</span> common<span class="token punctuation">.</span>read_redis
<span class="token comment">-- 封装查询函数</span>
<span class="token keyword">function</span> <span class="token function">read_data</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment">-- 查询本地缓存</span>
    <span class="token keyword">local</span> val <span class="token operator">=</span> <span class="token function">read_redis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">-- 判断查询结果</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"redis查询失败，尝试查询http， key: "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- redis查询失败，去查询http</span>
        val <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 返回数据</span>
    <span class="token keyword">return</span> val
<span class="token keyword">end</span>
</code></pre> 
<p>2）而后修改商品查询、库存查询的业务：<br> <img src="https://images2.imgbox.com/b0/56/E4Or4DHT_o.png" alt="在这里插入图片描述"></p> 
<p>3）完整的item.lua代码：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入common函数库</span>
<span class="token keyword">local</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'common'</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> read_http <span class="token operator">=</span> common<span class="token punctuation">.</span>read_http
<span class="token keyword">local</span> read_redis <span class="token operator">=</span> common<span class="token punctuation">.</span>read_redis
<span class="token comment">-- 导入cjson库</span>
<span class="token keyword">local</span> cjson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cjson'</span><span class="token punctuation">)</span>

<span class="token comment">-- 封装查询函数</span>
<span class="token keyword">function</span> <span class="token function">read_data</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment">-- 查询本地缓存</span>
    <span class="token keyword">local</span> val <span class="token operator">=</span> <span class="token function">read_redis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
    <span class="token comment">-- 判断查询结果</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"redis查询失败，尝试查询http， key: "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- redis查询失败，去查询http</span>
        val <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 返回数据</span>
    <span class="token keyword">return</span> val
<span class="token keyword">end</span>

<span class="token comment">-- 获取路径参数</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment">-- 查询商品信息</span>
<span class="token keyword">local</span> itemJSON <span class="token operator">=</span> <span class="token function">read_data</span><span class="token punctuation">(</span><span class="token string">"item:id:"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span>  <span class="token string">"/item/"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
<span class="token comment">-- 查询库存信息</span>
<span class="token keyword">local</span> stockJSON <span class="token operator">=</span> <span class="token function">read_data</span><span class="token punctuation">(</span><span class="token string">"item:stock:id:"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token string">"/item/stock/"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>

<span class="token comment">-- JSON转化为lua的table</span>
<span class="token keyword">local</span> item <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>itemJSON<span class="token punctuation">)</span>
<span class="token keyword">local</span> stock <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>stockJSON<span class="token punctuation">)</span>
<span class="token comment">-- 组合数据</span>
item<span class="token punctuation">.</span>stock <span class="token operator">=</span> stock<span class="token punctuation">.</span>stock
item<span class="token punctuation">.</span>sold <span class="token operator">=</span> stock<span class="token punctuation">.</span>sold

<span class="token comment">-- 把item序列化为json 返回结果</span>
ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h3><a id="47_Nginx_1644"></a>4.7 Nginx本地缓存</h3> 
<p>现在，整个多级缓存中只差最后一环，也就是nginx的本地缓存了。如图：<br> <img src="https://images2.imgbox.com/db/c7/hz4BSqfC_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c7/72/3ADFjHso_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="471_API_1650"></a>4.7.1 本地缓存API</h4> 
<p>OpenResty为Nginx提供了<strong>shard dict</strong>的功能，可以在nginx的多个worker之间共享数据，实现缓存功能。</p> 
<p>1）开启共享字典，在nginx.conf的http下添加配置：</p> 
<pre><code class="prism language-nginx"> # 共享字典，也就是本地缓存，名称叫做：item_cache，大小150m
 lua_shared_dict item_cache 150m; 
</code></pre> 
<p>2）操作共享字典：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 获取本地缓存对象</span>
<span class="token keyword">local</span> item_cache <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>item_cache
<span class="token comment">-- 存储, 指定key、value、过期时间，单位s，默认为0代表永不过期</span>
item_cache<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token comment">-- 读取</span>
<span class="token keyword">local</span> val <span class="token operator">=</span> item_cache<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'key'</span><span class="token punctuation">)</span>
</code></pre> 
<h4><a id="472__1669"></a>4.7.2 实现本地缓存查询</h4> 
<p>1）修改<code>/usr/local/openresty/lua/item.lua</code>文件，修改read_data查询函数，添加本地缓存逻辑：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入共享词典，本地缓存</span>
<span class="token keyword">local</span> item_cache <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>item_cache

<span class="token comment">-- 封装查询函数</span>
<span class="token keyword">function</span> <span class="token function">read_data</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment">-- 查询本地缓存</span>
    <span class="token keyword">local</span> val <span class="token operator">=</span> item_cache<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"本地缓存查询失败，尝试查询Redis， key: "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 查询redis</span>
        val <span class="token operator">=</span> <span class="token function">read_redis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 判断查询结果</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
            ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"redis查询失败，尝试查询http， key: "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token comment">-- redis查询失败，去查询http</span>
            val <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 查询成功，把数据写入本地缓存</span>
    item_cache<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> expire<span class="token punctuation">)</span>
    <span class="token comment">-- 返回数据</span>
    <span class="token keyword">return</span> val
<span class="token keyword">end</span>
</code></pre> 
<p>2）修改item.lua中查询商品和库存的业务，实现最新的read_data函数：<br> <img src="https://images2.imgbox.com/45/b5/GVP2tzkN_o.png" alt="在这里插入图片描述"></p> 
<p>其实就是多了缓存时间参数，过期后nginx缓存会自动删除，下次访问即可更新缓存。</p> 
<p>这里给商品基本信息设置超时时间为30分钟，库存为1分钟。</p> 
<p>因为库存更新频率较高，如果缓存时间过长，可能与数据库差异较大。</p> 
<p>3）完整的item.lua文件：</p> 
<pre><code class="prism language-lua"><span class="token comment">-- 导入common函数库</span>
<span class="token keyword">local</span> common <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'common'</span><span class="token punctuation">)</span>
<span class="token keyword">local</span> read_http <span class="token operator">=</span> common<span class="token punctuation">.</span>read_http
<span class="token keyword">local</span> read_redis <span class="token operator">=</span> common<span class="token punctuation">.</span>read_redis
<span class="token comment">-- 导入cjson库</span>
<span class="token keyword">local</span> cjson <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cjson'</span><span class="token punctuation">)</span>
<span class="token comment">-- 导入共享词典，本地缓存</span>
<span class="token keyword">local</span> item_cache <span class="token operator">=</span> ngx<span class="token punctuation">.</span>shared<span class="token punctuation">.</span>item_cache

<span class="token comment">-- 封装查询函数</span>
<span class="token keyword">function</span> <span class="token function">read_data</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> expire<span class="token punctuation">,</span> path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
    <span class="token comment">-- 查询本地缓存</span>
    <span class="token keyword">local</span> val <span class="token operator">=</span> item_cache<span class="token punctuation">:</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
        ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"本地缓存查询失败，尝试查询Redis， key: "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 查询redis</span>
        val <span class="token operator">=</span> <span class="token function">read_redis</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">,</span> <span class="token number">6379</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token comment">-- 判断查询结果</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> val <span class="token keyword">then</span>
            ngx<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ngx<span class="token punctuation">.</span>ERR<span class="token punctuation">,</span> <span class="token string">"redis查询失败，尝试查询http， key: "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token comment">-- redis查询失败，去查询http</span>
            val <span class="token operator">=</span> <span class="token function">read_http</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
    <span class="token comment">-- 查询成功，把数据写入本地缓存</span>
    item_cache<span class="token punctuation">:</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val<span class="token punctuation">,</span> expire<span class="token punctuation">)</span>
    <span class="token comment">-- 返回数据</span>
    <span class="token keyword">return</span> val
<span class="token keyword">end</span>

<span class="token comment">-- 获取路径参数</span>
<span class="token keyword">local</span> id <span class="token operator">=</span> ngx<span class="token punctuation">.</span>var<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>

<span class="token comment">-- 查询商品信息</span>
<span class="token keyword">local</span> itemJSON <span class="token operator">=</span> <span class="token function">read_data</span><span class="token punctuation">(</span><span class="token string">"item:id:"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token number">1800</span><span class="token punctuation">,</span>  <span class="token string">"/item/"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>
<span class="token comment">-- 查询库存信息</span>
<span class="token keyword">local</span> stockJSON <span class="token operator">=</span> <span class="token function">read_data</span><span class="token punctuation">(</span><span class="token string">"item:stock:id:"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token number">60</span><span class="token punctuation">,</span> <span class="token string">"/item/stock/"</span> <span class="token operator">..</span> id<span class="token punctuation">,</span> <span class="token keyword">nil</span><span class="token punctuation">)</span>

<span class="token comment">-- JSON转化为lua的table</span>
<span class="token keyword">local</span> item <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>itemJSON<span class="token punctuation">)</span>
<span class="token keyword">local</span> stock <span class="token operator">=</span> cjson<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>stockJSON<span class="token punctuation">)</span>
<span class="token comment">-- 组合数据</span>
item<span class="token punctuation">.</span>stock <span class="token operator">=</span> stock<span class="token punctuation">.</span>stock
item<span class="token punctuation">.</span>sold <span class="token operator">=</span> stock<span class="token punctuation">.</span>sold

<span class="token comment">-- 把item序列化为json 返回结果</span>
ngx<span class="token punctuation">.</span><span class="token function">say</span><span class="token punctuation">(</span>cjson<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="5__1762"></a>5 缓存同步</h2> 
<p>大多数情况下，浏览器查询到的都是缓存数据，如果缓存数据与数据库数据存在较大差异，可能会产生比较严重的后果。</p> 
<p>所以我们必须保证数据库数据、缓存数据的一致性，这就是缓存与数据库的同步。</p> 
<h3><a id="51__1767"></a>5.1 数据同步策略</h3> 
<p>缓存数据同步的常见方式有三种：</p> 
<p><strong>设置有效期</strong>：给缓存设置有效期，到期后自动删除。再次查询时更新</p> 
<ul><li>优势：简单、方便</li><li>缺点：时效性差，缓存过期之前可能不一致</li><li>场景：更新频率较低，时效性要求低的业务</li></ul> 
<p><strong>同步双写</strong>：在修改数据库的同时，直接修改缓存</p> 
<ul><li>优势：时效性强，缓存与数据库强一致</li><li>缺点：有代码侵入，耦合度高；</li><li>场景：对一致性、时效性要求较高的缓存数据</li></ul> 
<p><strong>异步通知：</strong> 修改数据库时发送事件通知，相关服务监听到通知后修改缓存数据</p> 
<ul><li>优势：低耦合，可以同时通知多个缓存服务</li><li>缺点：时效性一般，可能存在中间不一致状态</li><li>场景：时效性要求一般，有多个服务需要同步</li></ul> 
<p>而异步实现又可以基于MQ或者Canal来实现：</p> 
<p>1）基于MQ的异步通知：<br> <img src="https://images2.imgbox.com/0e/ff/llQl5o60_o.png" alt="在这里插入图片描述"><br> 解读：</p> 
<ul><li>商品服务完成对数据的修改后，只需要发送一条消息到MQ中。</li><li>缓存服务监听MQ消息，然后完成对缓存的更新</li></ul> 
<p>依然有少量的代码侵入。</p> 
<p>2）基于Canal的通知<br> <img src="https://images2.imgbox.com/9e/e7/mDaI6dki_o.png" alt="在这里插入图片描述"></p> 
<p>解读：</p> 
<ul><li>商品服务完成商品修改后，业务直接结束，没有任何代码侵入</li><li>Canal监听MySQL变化，当发现变化后，立即通知缓存服务</li><li>缓存服务接收到canal通知，更新缓存</li></ul> 
<p>代码零侵入</p> 
<h3><a id="52_Canal_1819"></a>5.2 安装Canal</h3> 
<h4><a id="521_Canal_1821"></a>5.2.1 认识Canal</h4> 
<p><strong>Canal [kə’næl]</strong>，译意为水道/管道/沟渠，canal是阿里巴巴旗下的一款开源项目，基于Java开发。基于数据库增量日志解析，提供增量数据订阅&amp;消费。GitHub的地址：<a href="https://github.com/alibaba/canal">https://github.com/alibaba/canal</a></p> 
<p>Canal是基于mysql的主从同步来实现的，MySQL主从同步的原理如下：<br> <img src="https://images2.imgbox.com/0a/ac/PrQ0MxBO_o.png" alt="在这里插入图片描述"></p> 
<ul><li>1）MySQL master 将数据变更写入二进制日志( binary log），其中记录的数据叫做binary log events</li><li>2）MySQL slave 将 master 的 binary log events拷贝到它的中继日志(relay log)</li><li>3）MySQL slave 重放 relay log 中事件，将数据变更反映它自己的数据</li></ul> 
<p>而Canal就是把自己伪装成MySQL的一个slave节点，从而监听master的binary log变化。再把得到的变化信息通知给Canal的客户端，进而完成对其它数据库的同步。<br> <img src="https://images2.imgbox.com/76/69/60fu9RNu_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="522_Canal_1834"></a>5.2.2 安装和配置Canal</h4> 
<p>下面我们就开启mysql的主从同步机制，让Canal来模拟salve</p> 
<h5><a id="1MySQL_1837"></a>1.开启MySQL主从</h5> 
<p>Canal是基于MySQL的主从同步功能，因此必须先开启MySQL的主从功能才可以。</p> 
<p>这里以之前用Docker运行的mysql为例：</p> 
<h6><a id="11binlog_1843"></a>1.1.开启binlog</h6> 
<p>打开mysql容器挂载的日志文件，我的在<code>/tmp/mysql/conf</code>目录:<br> <img src="https://images2.imgbox.com/f2/a9/GdE2fmYg_o.png" alt="在这里插入图片描述"><br> 修改文件：</p> 
<pre><code class="prism language-sh"><span class="token function">vi</span> /tmp/mysql/conf/my.cnf
</code></pre> 
<p>添加内容：</p> 
<pre><code class="prism language-ini">log-bin=/var/lib/mysql/mysql-bin
binlog-do-db=heima
</code></pre> 
<p>配置解读：</p> 
<ul><li><code>log-bin=/var/lib/mysql/mysql-bin</code>：设置binary log文件的存放地址和文件名，叫做mysql-bin</li><li><code>binlog-do-db=heima</code>：指定对哪个database记录binary log events，这里记录heima这个库</li></ul> 
<p>最终效果：</p> 
<pre><code class="prism language-ini">[mysqld]
skip-name-resolve
character_set_server=utf8
datadir=/var/lib/mysql
server-id=1000
log-bin=/var/lib/mysql/mysql-bin
binlog-do-db=heima
</code></pre> 
<h6><a id="12_1879"></a>1.2.设置用户权限</h6> 
<p>接下来添加一个仅用于数据同步的账户，出于安全考虑，这里仅提供对heima这个库的操作权限。</p> 
<pre><code class="prism language-mysql">create user canal@'%' IDENTIFIED by 'canal';
GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT,SUPER ON *.* TO 'canal'@'%' identified by 'canal';
FLUSH PRIVILEGES;
</code></pre> 
<p>重启mysql容器即可</p> 
<pre><code>docker restart mysql
</code></pre> 
<p>测试设置是否成功：在mysql控制台，或者Navicat中，输入命令：</p> 
<pre><code>show master status;
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/fc/ylfV93T4_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="2Canal_1900"></a>2.安装Canal</h5> 
<h6><a id="21_1901"></a>2.1.创建网络</h6> 
<p>我们需要创建一个网络，将MySQL、Canal、MQ放到同一个Docker网络中：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> network create heima
</code></pre> 
<p>让mysql加入这个网络：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> network connect heima mysql
</code></pre> 
<h6><a id="23Canal_1914"></a>2.3.安装Canal</h6> 
<p>课前资料中提供了canal的镜像压缩包:<br> <img src="https://images2.imgbox.com/85/3f/LkKK5Dn3_o.png" alt="在这里插入图片描述"><br> 大家可以上传到虚拟机，然后通过命令导入：</p> 
<pre><code>docker load -i canal.tar
</code></pre> 
<p>然后运行命令创建Canal容器：</p> 
<pre><code class="prism language-sh"><span class="token function">docker</span> run <span class="token parameter variable">-p</span> <span class="token number">11111</span>:11111 <span class="token parameter variable">--name</span> canal <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.destinations</span><span class="token operator">=</span>heima <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.master.address</span><span class="token operator">=</span>mysql:3306  <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.dbUsername</span><span class="token operator">=</span>canal  <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.dbPassword</span><span class="token operator">=</span>canal  <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.connectionCharset</span><span class="token operator">=</span>UTF-8 <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.tsdb.enable</span><span class="token operator">=</span>true <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.gtidon</span><span class="token operator">=</span>false  <span class="token punctuation">\</span>
<span class="token parameter variable">-e</span> <span class="token assign-left variable">canal.instance.filter.regex</span><span class="token operator">=</span>heima<span class="token punctuation">\</span><span class="token punctuation">\</span><span class="token punctuation">..</span>* <span class="token punctuation">\</span>
<span class="token parameter variable">--network</span> heima <span class="token punctuation">\</span>
<span class="token parameter variable">-d</span> canal/canal-server:v1.1.5
</code></pre> 
<p>说明:</p> 
<ul><li><code>-p 11111:11111</code>：这是canal的默认监听端口</li><li><code>-e canal.instance.master.address=mysql:3306</code>：数据库地址和端口，如果不知道mysql容器地址，可以通过<code>docker inspect 容器id</code>来查看</li><li><code>-e canal.instance.dbUsername=canal</code>：数据库用户名</li><li><code>-e canal.instance.dbPassword=canal</code> ：数据库密码</li><li><code>-e canal.instance.filter.regex=</code>：要监听的表名称</li></ul> 
<p>表名称监听支持的语法：</p> 
<pre><code>mysql 数据解析关注的表，Perl正则表达式.
多个正则之间以逗号(,)分隔，转义符需要双斜杠(\\) 
常见例子：
1.  所有表：.*   or  .*\\..*
2.  canal schema下所有表： canal\\..*
3.  canal下的以canal打头的表：canal\\.canal.*
4.  canal schema下的一张表：canal.test1
5.  多个规则组合使用然后以逗号隔开：canal\\..*,mysql.test1,mysql.test2 
</code></pre> 
<p><img src="https://images2.imgbox.com/1c/33/j6Xd8orP_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="53Canal_1965"></a>5.3.监听Canal</h3> 
<p>Canal提供了各种语言的客户端，当Canal监听到binlog变化时，会通知Canal的客户端。<br> <img src="https://images2.imgbox.com/8e/a7/OL2EIAPS_o.png" alt="在这里插入图片描述"><br> 我们可以利用Canal提供的Java客户端，监听Canal通知消息。当收到变化的消息时，完成对缓存的更新。</p> 
<p>不过这里我们会使用GitHub上的第三方开源的canal-starter客户端。地址：<a href="https://github.com/NormanGyllenhaal/canal-client">https://github.com/NormanGyllenhaal/canal-client</a></p> 
<p>与SpringBoot完美整合，自动装配，比官方客户端要简单好用很多。</p> 
<h4><a id="531_1977"></a>5.3.1.引入依赖：</h4> 
<pre><code class="prism language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>top.javatool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>canal-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.1-RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> 
<h4><a id="532_1989"></a>5.3.2.编写配置：</h4> 
<pre><code class="prism language-yaml"><span class="token key atrule">canal</span><span class="token punctuation">:</span>
  <span class="token key atrule">destination</span><span class="token punctuation">:</span> heima <span class="token comment"># canal的集群名字，要与安装canal时设置的名称一致</span>
  <span class="token key atrule">server</span><span class="token punctuation">:</span> 192.168.150.101<span class="token punctuation">:</span><span class="token number">11111</span> <span class="token comment"># canal服务地址</span>
</code></pre> 
<h4><a id="533Item_1999"></a>5.3.3.修改Item实体类</h4> 
<p>通过@Id、@Column、等注解完成Item与数据库表字段的映射：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">IdType</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableField</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableId</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">TableName</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Id</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Transient</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>persistence<span class="token punctuation">.</span></span><span class="token class-name">Column</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Date</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@TableName</span><span class="token punctuation">(</span><span class="token string">"tb_item"</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Item</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@TableId</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">IdType</span><span class="token punctuation">.</span><span class="token constant">AUTO</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span><span class="token comment">//商品id</span>
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">"name"</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span><span class="token comment">//商品名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span><span class="token comment">//商品标题</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> price<span class="token punctuation">;</span><span class="token comment">//价格（分）</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> image<span class="token punctuation">;</span><span class="token comment">//商品图片</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> category<span class="token punctuation">;</span><span class="token comment">//分类名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> brand<span class="token punctuation">;</span><span class="token comment">//品牌名称</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> spec<span class="token punctuation">;</span><span class="token comment">//规格</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> status<span class="token punctuation">;</span><span class="token comment">//商品状态 1-正常，2-下架</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> createTime<span class="token punctuation">;</span><span class="token comment">//创建时间</span>
    <span class="token keyword">private</span> <span class="token class-name">Date</span> updateTime<span class="token punctuation">;</span><span class="token comment">//更新时间</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> stock<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@TableField</span><span class="token punctuation">(</span>exist <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transient</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> sold<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<h4><a id="534_2045"></a>5.3.4.编写监听器</h4> 
<p>通过实现<code>EntryHandler&lt;T&gt;</code>接口编写监听器，监听Canal消息。注意两点：</p> 
<ul><li>实现类通过<code>@CanalTable("tb_item")</code>指定监听的表信息</li><li>EntryHandler的泛型是与表对应的实体类</li></ul> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>canal</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>github<span class="token punctuation">.</span>benmanes<span class="token punctuation">.</span>caffeine<span class="token punctuation">.</span>cache<span class="token punctuation">.</span></span><span class="token class-name">Cache</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">RedisHandler</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Item</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">top<span class="token punctuation">.</span>javatool<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>client<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">CanalTable</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">top<span class="token punctuation">.</span>javatool<span class="token punctuation">.</span>canal<span class="token punctuation">.</span>client<span class="token punctuation">.</span>handler<span class="token punctuation">.</span></span><span class="token class-name">EntryHandler</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@CanalTable</span><span class="token punctuation">(</span><span class="token string">"tb_item"</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ItemHandler</span> <span class="token keyword">implements</span> <span class="token class-name">EntryHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisHandler</span> redisHandler<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">Cache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemCache<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">insert</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 写数据到JVM进程缓存</span>
        itemCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写数据到redis</span>
        redisHandler<span class="token punctuation">.</span><span class="token function">saveItem</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Item</span> before<span class="token punctuation">,</span> <span class="token class-name">Item</span> after<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 写数据到JVM进程缓存</span>
        itemCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>after<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 写数据到redis</span>
        redisHandler<span class="token punctuation">.</span><span class="token function">saveItem</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 删除数据到JVM进程缓存</span>
        itemCache<span class="token punctuation">.</span><span class="token function">invalidate</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除数据到redis</span>
        redisHandler<span class="token punctuation">.</span><span class="token function">deleteItemById</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这里对Redis的操作都封装到了RedisHandler这个对象中，是我们之前做缓存预热时编写的一个类，内容如下：</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">JsonProcessingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>fasterxml<span class="token punctuation">.</span>jackson<span class="token punctuation">.</span>databind<span class="token punctuation">.</span></span><span class="token class-name">ObjectMapper</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">Item</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>pojo<span class="token punctuation">.</span></span><span class="token class-name">ItemStock</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IItemService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>heima<span class="token punctuation">.</span>item<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IItemStockService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">InitializingBean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>data<span class="token punctuation">.</span>redis<span class="token punctuation">.</span>core<span class="token punctuation">.</span></span><span class="token class-name">StringRedisTemplate</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisHandler</span> <span class="token keyword">implements</span> <span class="token class-name">InitializingBean</span> <span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">StringRedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IItemService</span> itemService<span class="token punctuation">;</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IItemStockService</span> stockService<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">ObjectMapper</span> <span class="token constant">MAPPER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectMapper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterPropertiesSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 初始化缓存</span>
        <span class="token comment">// 1.查询商品信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Item</span><span class="token punctuation">&gt;</span></span> itemList <span class="token operator">=</span> itemService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2.放入缓存</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Item</span> item <span class="token operator">:</span> itemList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.1.item序列化为JSON</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.2.存入redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"item:id:"</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 3.查询商品库存信息</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ItemStock</span><span class="token punctuation">&gt;</span></span> stockList <span class="token operator">=</span> stockService<span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4.放入缓存</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ItemStock</span> stock <span class="token operator">:</span> stockList<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token comment">// 2.1.item序列化为JSON</span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>stock<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 2.2.存入redis</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"item:stock:id:"</span> <span class="token operator">+</span> stock<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveItem</span><span class="token punctuation">(</span><span class="token class-name">Item</span> item<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">String</span> json <span class="token operator">=</span> <span class="token constant">MAPPER</span><span class="token punctuation">.</span><span class="token function">writeValueAsString</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">"item:id:"</span> <span class="token operator">+</span> item<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> json<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">JsonProcessingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteItemById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">"item:id:"</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h2><a id="6__2171"></a>6 总结</h2> 
<p><img src="https://images2.imgbox.com/22/3c/pu7FNTZ8_o.png" alt="在这里插入图片描述"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/d1a3220d4997dc055b37162009a0d4b5/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">cesiumlab中las点云转3dtiles注意颜色格式</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/bee9f29884505e7f066600d2bbe7a866/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">代码编辑器,代码（JSON，js，Markdown，html，css，java，sql）格式化 fei-editor</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>