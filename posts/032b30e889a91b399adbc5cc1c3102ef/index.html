<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>性能优化之电量和网络 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="性能优化之电量和网络" />
<meta property="og:description" content="电量 电量的分析工具 energy profiler 使用 Android 8.0 及以上版本的设备时，使用Energy Profiler 可以了解应用在哪里耗用了不必要的电量。 Energy Profiler 会监控 CPU、网络无线装置和 GPS 传感器的使用情况，并直观地显示其中每个组件消耗的电量。还会显示可能会影响耗电量的系统事件（唤醒锁定、闹钟、作业和位置信息请求）的发生次数
使用Profile 运行App。
下面红框的时间段,我打开了定位功能的页面,就显示除了location高亮
可以选择这段定位的区域,进行分析
上面的系统事件说明： **WakeLock（唤醒锁定）：**是一种机制，可在设备进入休眠模式时使 CPU或屏幕保持开启状态。例如，播放视频的应用可以使用唤醒锁定，以便在用户未与设备交互时使屏幕保持开启状态。请求唤醒锁定不是一项耗电量很高的操作，但未撤消唤醒锁定会导致屏幕或CPU 保持开启状态的时间超过必要时间，从而加快电池耗电速度。**Alarms（闹钟）：**您可以使用闹钟定期在应用上下文之外运行后台任务。当闹钟触发时，它可能会唤醒设备并运行耗电量很高的代码。**Jobs（作业）：**您可以使用作业在指定条件下（例如恢复网络连接时）执行相关操作。您可以使用 JobBuilder 创建作业，并使用JobScheduler 对这些作业进行调度。在许多情况下，建议您使用 JobScheduler对作业进行调度，而不是使用闹钟或唤醒锁定。**Location（位置）：**位置信息请求使用 GPS 传感器，这会消耗大量电量。 电量的优化 电池续航时间是移动用户体验中最重要的一个方面。没电的设备完全无法使用。因此，对于应用来说，尽可能地考虑电池续航时间是至关重要的。在我们开发时对于单个APP应该注意能够：
**减少操作：**您的应用是否存在可删减的多余操作？例如，是否可以缓存已下载的数据，而不是每次重新下载数据？**推迟操作：**应用是否需要立即执行某项操作？例如，是否可以等到设备充电后或者Wifi连接时（通常情况下使 用移动网络要比WIFI更耗电）再将数据备份到云端？**合并操作：**工作是否可以批处理，而不是多次将设备置于活动状态？比如和服务器请求不同的接口获取数 据，部分接口是否可以合并为一个？ 监控电池电量和充电状态 为了减少电池续航被我们软件的影响，我们可以通过检查电池状态以及电量来判断是否进行某些操作。比如我们可以在充电时才进行一些数据上报之类的操作。
获取充电状态 IntentFilter ifilter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED); Intent batteryStatus = registerReceiver(null, ifilter); // 是否正在充电 int status = batteryStatus.getIntExtra(BatteryManager.EXTRA_STATUS, -1); boolean isCharging = status == BatteryManager.BATTERY_STATUS_CHARGING || status == BatteryManager.BATTERY_STATUS_FULL; // 什么方式充电？ int chargePlug = batteryStatus." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/032b30e889a91b399adbc5cc1c3102ef/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-11-27T15:58:19+08:00" />
<meta property="article:modified_time" content="2020-11-27T15:58:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">性能优化之电量和网络</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="_0"></a>电量</h3> 
<h4><a id="_energy_profiler_1"></a>电量的分析工具 energy profiler</h4> 
<p>使用 Android 8.0 及以上版本的设备时，使用Energy Profiler 可以了解应用在哪里耗用了不必要的电量。 Energy Profiler 会监控 CPU、网络无线装置和 GPS 传感器的使用情况，并直观地显示其中每个组件消耗的电量。还会显示可能会影响耗电量的系统事件（唤醒锁定、闹钟、作业和位置信息请求）的发生次数<br> 使用Profile 运行App。<br> <img src="https://images2.imgbox.com/e5/36/EZjuzh88_o.png" alt="在这里插入图片描述"><br> 下面红框的时间段,我打开了定位功能的页面,就显示除了location高亮<br> <img src="https://images2.imgbox.com/0b/04/ksOCxHQD_o.png" alt="在这里插入图片描述"><br> 可以选择这段定位的区域,进行分析<br> <img src="https://images2.imgbox.com/9b/b6/d9TD4vXv_o.png" alt="在这里插入图片描述"></p> 
<h6><a id="_9"></a>上面的系统事件说明：</h6> 
<ul><li>**WakeLock（唤醒锁定）：**是一种机制，可在设备进入休眠模式时使 CPU或屏幕保持开启状态。例如，播放视频的应用可以使用唤醒锁定，以便在用户未与设备交互时使屏幕保持开启状态。请求唤醒锁定不是一项耗电量很高的操作，但未撤消唤醒锁定会导致屏幕或CPU 保持开启状态的时间超过必要时间，从而加快电池耗电速度。</li><li>**Alarms（闹钟）：**您可以使用闹钟定期在应用上下文之外运行后台任务。当闹钟触发时，它可能会唤醒设备并运行耗电量很高的代码。</li><li>**Jobs（作业）：**您可以使用作业在指定条件下（例如恢复网络连接时）执行相关操作。您可以使用 JobBuilder 创建作业，并使用JobScheduler 对这些作业进行调度。在许多情况下，建议您使用 JobScheduler对作业进行调度，而不是使用闹钟或唤醒锁定。</li><li>**Location（位置）：**位置信息请求使用 GPS 传感器，这会消耗大量电量。</li></ul> 
<h4><a id="_14"></a>电量的优化</h4> 
<p>电池续航时间是移动用户体验中最重要的一个方面。没电的设备完全无法使用。因此，对于应用来说，尽可能地考虑电池续航时间是至关重要的。在我们开发时对于单个APP应该注意能够：</p> 
<ul><li>**减少操作：**您的应用是否存在可删减的多余操作？例如，是否可以缓存已下载的数据，而不是每次重新下载数据？</li><li>**推迟操作：**应用是否需要立即执行某项操作？例如，是否可以等到设备充电后或者Wifi连接时（通常情况下使 用移动网络要比WIFI更耗电）再将数据备份到云端？</li><li>**合并操作：**工作是否可以批处理，而不是多次将设备置于活动状态？比如和服务器请求不同的接口获取数 据，部分接口是否可以合并为一个？</li></ul> 
<h5><a id="_20"></a>监控电池电量和充电状态</h5> 
<p>为了减少电池续航被我们软件的影响，我们可以通过检查电池状态以及电量来判断是否进行某些操作。比如我们可以在充电时才进行一些数据上报之类的操作。</p> 
<h6><a id="_22"></a>获取充电状态</h6> 
<pre><code class="prism language-java">IntentFilter ifilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_BATTERY_CHANGED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
Intent batteryStatus <span class="token operator">=</span> <span class="token function">registerReceiver</span><span class="token punctuation">(</span>null<span class="token punctuation">,</span> ifilter<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">// 是否正在充电 </span>
<span class="token keyword">int</span> status <span class="token operator">=</span> batteryStatus<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>BatteryManager<span class="token punctuation">.</span>EXTRA_STATUS<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">boolean</span> isCharging <span class="token operator">=</span> status <span class="token operator">==</span> BatteryManager<span class="token punctuation">.</span>BATTERY_STATUS_CHARGING <span class="token operator">||</span> status <span class="token operator">==</span> BatteryManager<span class="token punctuation">.</span>BATTERY_STATUS_FULL<span class="token punctuation">;</span> 
<span class="token comment">// 什么方式充电？ </span>
<span class="token keyword">int</span> chargePlug <span class="token operator">=</span> batteryStatus<span class="token punctuation">.</span><span class="token function">getIntExtra</span><span class="token punctuation">(</span>BatteryManager<span class="token punctuation">.</span>EXTRA_PLUGGED<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//usb </span>
<span class="token keyword">boolean</span> usbCharge <span class="token operator">=</span> chargePlug <span class="token operator">==</span> BatteryManager<span class="token punctuation">.</span>BATTERY_PLUGGED_USB<span class="token punctuation">;</span> 
<span class="token comment">//充电器 </span>
<span class="token keyword">boolean</span> acCharge <span class="token operator">=</span> chargePlug <span class="token operator">==</span> BatteryManager<span class="token punctuation">.</span>BATTERY_PLUGGED_AC<span class="token punctuation">;</span> 
Log<span class="token punctuation">.</span><span class="token function">e</span><span class="token punctuation">(</span>TAG<span class="token punctuation">,</span> <span class="token string">"isCharging: "</span> <span class="token operator">+</span> isCharging <span class="token operator">+</span> <span class="token string">" usbCharge: "</span> <span class="token operator">+</span> usbCharge <span class="token operator">+</span> <span class="token string">" acCharge:"</span> <span class="token operator">+</span> acCharge<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h6><a id="_38"></a>监控充电状态变化</h6> 
<pre><code class="prism language-java"><span class="token comment">//注册广播 </span>
IntentFilter ifilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">IntentFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//充电状态 </span>
ifilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_POWER_CONNECTED<span class="token punctuation">)</span><span class="token punctuation">;</span>
ifilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_POWER_DISCONNECTED<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//电量显著变化 </span>
ifilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_BATTERY_LOW<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//电量不足</span>
ifilter<span class="token punctuation">.</span><span class="token function">addAction</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_BATTERY_OKAY<span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token comment">//电量从低变回高 </span>
powerConnectionReceiver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PowerConnectionReceiver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">registerReceiver</span><span class="token punctuation">(</span>powerConnectionReceiver<span class="token punctuation">,</span> ifilter<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PowerConnectionReceiver</span> <span class="token keyword">extends</span> <span class="token class-name">BroadcastReceiver</span> <span class="token punctuation">{<!-- --></span> 
	<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onReceive</span><span class="token punctuation">(</span>Context context<span class="token punctuation">,</span> Intent intent<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">if</span><span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_POWER_CONNECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
			Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"充电状态：CONNECTED"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_POWER_DISCONNECTED<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
			Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"充电状态：DISCONNECTED"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_BATTERY_LOW<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"电量过低"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>intent<span class="token punctuation">.</span><span class="token function">getAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_BATTERY_OKAY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
			Toast<span class="token punctuation">.</span><span class="token function">makeText</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token string">"电量从低变回高"</span><span class="token punctuation">,</span> Toast<span class="token punctuation">.</span>LENGTH_SHORT<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre> 
<h6><a id="WorkManager_67"></a>WorkManager</h6> 
<p>如果设备在 API 级别 23 或更高级别上运行，系统会使用 JobScheduler。在 API 级别 14-22 上，系统会使用GcmNetworkManager（如果可用），否则会使用自定义 AlarmManager 和 BroadcastReciever 实现作为备用。</p> 
<pre><code class="prism language-java">Constraints constraints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Constraints<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 
	<span class="token punctuation">.</span><span class="token function">setRequiredNetworkType</span><span class="token punctuation">(</span>NetworkType<span class="token punctuation">.</span>UNMETERED<span class="token punctuation">)</span> <span class="token comment">//Wi-Fi 	</span>
	<span class="token punctuation">.</span><span class="token function">setRequiresCharging</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//在设备充电时运行 </span>
	<span class="token punctuation">.</span><span class="token function">setRequiresBatteryNotLow</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token comment">//电量不足不会运行 </span>
	<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
OneTimeWorkRequest uploadWorkRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OneTimeWorkRequest<span class="token punctuation">.</span>Builder</span><span class="token punctuation">(</span>UploadWorker<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> 
	<span class="token punctuation">.</span><span class="token function">setConstraints</span><span class="token punctuation">(</span>constraints<span class="token punctuation">)</span> 
	<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
WorkManager<span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> 
	<span class="token punctuation">.</span><span class="token function">enqueueUniqueWork</span><span class="token punctuation">(</span><span class="token string">"upload"</span><span class="token punctuation">,</span> ExistingWorkPolicy<span class="token punctuation">.</span>KEEP<span class="token punctuation">,</span>uploadWorkRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="_83"></a>网络优化</h3> 
<p>正常一条网络请求需要经过的流程是这样：</p> 
<ul><li>DNS 解析，请求DNS服务器，获取域名对应的 IP 地址；</li><li>与服务端建立连接，包括 tcp 三次握手，安全协议同步流程；</li><li>连接建立完成，发送和接收数据，解码数据。</li></ul> 
<p>这里有明显的三个优化点：</p> 
<ul><li>直接使用 IP 地址，去除 DNS 解析步骤；</li><li>不要每次请求都重新建立连接，复用连接或一直使用同一条连接(长连接)；</li><li>压缩数据，减小传输的数据大小。</li></ul> 
<h5><a id="DNS__95"></a>DNS 优化</h5> 
<p>DNS（Domain Name System），它的作用是根据域名查出IP地址，它是HTTP协议的前提，只有将域名正确的解析成IP地址后，后面的HTTP流程才能进行。<br> DNS 完整的解析流程很长，会先从本地系统缓存取，若没有就到最近的 DNS 服务器取，若没有再到主域名服务器取，每一层都有缓存，但为了域名解析的实时性，每一层缓存都有过期时间。<br> 传统的DNS解析机制有几个缺点：</p> 
<ul><li>缓存时间设置得长，域名更新不及时，设置得短，大量 DNS 解析请求影响请求速度；</li><li>域名劫持，容易被中间人攻击，或被运营商劫持，把域名解析到第三方 IP 地址，据统计劫持率会达到7%；</li><li>DNS 解析过程不受控制，无法保证解析到最快的IP； 一次请求只能解析一个域名。</li></ul> 
<p>为了解决这些问题，就有了 HTTPDNS，原理很简单，就是自己做域名解析的工作，通过 HTTP 请求后台去拿到域名对应的 IP 地址，直接解决上述所有问题。<br> HTTPDNS的好处总结就是：</p> 
<ul><li>Local DNS 劫持：由于 HttpDns 是通过 IP 直接请求 HTTP 获取服务器 A记录地址，不存在向本地运营商询问domain 解析过程，所以从根本避免了劫持问题。</li><li>DNS 解析由自己控制，可以确保根据用户所在地返回就近的 IP 地址，或根据客户端测速结果使用速度最快的 IP；</li><li>一次请求可以解析多个域名。</li></ul> 
<p>HTTPDNS 几乎成为中大型 APP 的标配。解决了第一个问题， DNS 解析耗时的问题，顺便把DNS 劫持也解决了。<br> <a href="https://help.aliyun.com/product/30100.html" rel="nofollow">httpdns</a></p> 
<h5><a id="_114"></a>连接优化</h5> 
<p>第二个问题，连接建立耗时的问题，这里主要的优化思路是复用连接，不用每次请求都重新建立连接，如何更有效率地复用连接，可以说是网络请求速度优化里最主要的点了。<br> <strong>【keep-alive】：</strong> HTTP 协议里有个 keep-alive，HTTP1.1默认开启，一定程度上缓解了每次请求都要进行TCP三次握手建立连接的耗时。原理是请求完成后不立即释放连接，而是放入连接池中，若这时有另一个请求要发出，请求的域名和端口是一样的，就直接拿出连接池中的连接进行发送和接收数据，少了建立连接的耗时。 实际上现在无论是客户端还是浏览器都默认开启了keep-alive，对同个域名不会再有每发一个请求就进行一次建连的情况，纯短连接已经不存在了。<br> 但有 keep-alive 的连接一次只能发送接收一个请求，在上一个请求处理完成之前，无法接受新的请求。若同时发起多个请求，就有两种情况：</p> 
<ul><li>若串行发送请求，可以一直复用一个连接，但速度很慢，每个请求都要等待上个请求完成再进行发送。</li><li>若并行发送请求，那么只能每个请求都要进行tcp三次握手建立新的连接</li></ul> 
<p>对并行请求的问题，新一代协议 HTTP2 提出了多路复用去解决。 HTTP2 的多路复用机制一样是复用连接，但它复用的这条连接支持同时处理多条请求，所有请求都可以并发在这条连接上进行，也就解决了上面说的并发请求需要建立多条连接带来的问题。</p> 
<p><img src="https://images2.imgbox.com/b5/e6/7NwfdeCY_o.png" alt="在这里插入图片描述"><br> 多路复用把在连接里传输的数据都封装成一个个stream，每个stream都有标识，stream的发送和接收可以是乱序的，不依赖顺序，也就不会有阻塞的问题，接收端可以根据stream的标识去区分属于哪个请求，再进行数据拼接，得到最终数据。<br> Android 的开源网络库OKhttp默认就会开启 keep-alive ，并且在Okhttp3以上版本也支持了 HTTP2。</p> 
<h5><a id="_128"></a>数据压缩</h5> 
<p>第三个问题，传输数据大小的问题。数据对请求速度的影响分两方面，一是压缩率，二是解压序列化反序列化的速度。目前最流行的两种数据格式是 json 和 protobuf，json 是字符串，protobuf 是二进制，即使用各种压缩算法压缩后，protobuf 仍会比 json 小，数据量上 protobuf 有优势，序列化速度 protobuf 也有一些优势 。</p> 
<p><a href="https://github.com/protocolbuffers/protobuf/blob/master/java/lite.md">protobuf</a></p> 
<p>除了选择不同的序列化方式（数据格式）之外，Http可以对内容（也就是body部分）进行编码，可以采用gzip这样的编码，从而达到压缩的目的。在OKhttp的 BridgeInterceptor 中会自动为我们开启gzip解压的支持。</p> 
<pre><code class="prism language-java"><span class="token keyword">boolean</span> transparentGzip <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> 
<span class="token keyword">if</span> <span class="token punctuation">(</span>userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Accept-Encoding"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null <span class="token operator">&amp;&amp;</span> userRequest<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Range"</span><span class="token punctuation">)</span> <span class="token operator">==</span> null<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
	transparentGzip <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
	requestBuilder<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Accept-Encoding"</span><span class="token punctuation">,</span> <span class="token string">"gzip"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>如果服务器响应头存在： Content-Encodin:gzip</p> 
<pre><code class="prism language-java"><span class="token comment">//服务器响应 Content-Encodin:gzip 并且有响应body数据 </span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>transparentGzip <span class="token operator">&amp;&amp;</span> <span class="token string">"gzip"</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> HttpHeaders<span class="token punctuation">.</span><span class="token function">hasBody</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
	GzipSource responseBody <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GzipSource</span><span class="token punctuation">(</span>networkResponse<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	Headers strippedHeaders <span class="token operator">=</span> networkResponse<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token string">"Content-Encoding"</span><span class="token punctuation">)</span> 
		<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">)</span> 
		<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	responseBuilder<span class="token punctuation">.</span><span class="token function">headers</span><span class="token punctuation">(</span>strippedHeaders<span class="token punctuation">)</span><span class="token punctuation">;</span> 
	String contentType <span class="token operator">=</span> networkResponse<span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Content-			Type"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	responseBuilder<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RealResponseBody</span><span class="token punctuation">(</span>contentType<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span>L<span class="token punctuation">,</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span>responseBody<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
</code></pre> 
<p>客户端也可以发送压缩数据给服务端，通过代码将请求数据压缩，并在请求中加入 Content-Encodin:gzip 即可。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> RequestBody <span class="token function">gzip</span><span class="token punctuation">(</span><span class="token keyword">final</span> RequestBody body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RequestBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
	<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> MediaType <span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">return</span> body<span class="token punctuation">.</span><span class="token function">contentType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">contentLength</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span> 
	<span class="token comment">// We don't know the compressed length in advance! </span>
	<span class="token punctuation">}</span> 
	<span class="token annotation punctuation">@Override</span> <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writeTo</span><span class="token punctuation">(</span>BufferedSink sink<span class="token punctuation">)</span> <span class="token keyword">throws</span> IOException <span class="token punctuation">{<!-- --></span> 
		BufferedSink gzipSink <span class="token operator">=</span> Okio<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">GzipSink</span><span class="token punctuation">(</span>sink<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
		body<span class="token punctuation">.</span><span class="token function">writeTo</span><span class="token punctuation">(</span>gzipSink<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		gzipSink<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> RequestBody <span class="token function">getGzipRequest</span><span class="token punctuation">(</span>String body<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> 
	RequestBody request <span class="token operator">=</span> null<span class="token punctuation">;</span> 
	<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
		request <span class="token operator">=</span> RequestBody<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span> MediaType<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">"application/octet-stream"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token function">compress</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> request<span class="token punctuation">;</span> 
<span class="token punctuation">}</span>
	
</code></pre> 
<h6><a id="_189"></a>其他</h6> 
<ul><li>1、使用webp代替png/jpg</li><li>2、不同网络的不同图片下发，如（对于原图是300x300的图片）：<br> 2/3G使用低清晰度图片：使用100X100的图片;<br> 4G再判断信号强度为强则使用使用300X300的图片，为中等则使用200x200，信号弱则使用100x100图片;<br> WiFi网络：直接下发300X300的图片</li><li>3、http开启缓存 / 首页数据加入缓存</li></ul> 
<p>总结:</p> 
<ul><li>使用protobuf替换json,需要后端也使用protobuf;同时替换的工作量有点大</li><li>对数据进行压缩</li></ul> 
<h6><a id="protobuf_202"></a>protobuf</h6> 
<p>Protobuf是一种平台无关、语言无关、可扩展且轻便高效的序列化数据结构的协议，可以用于网络通信和数据存储。 可简单类比于 XML ，其具有以下特点：</p> 
<ul><li>语言无关、平台无关。即 ProtoBuf 支持 Java、C++、Python 等多种语言，支持多个平台</li><li>高效。即比 XML 更小（3 ~ 10倍）、更快（20 ~ 100倍）、更为简单</li><li>扩展性、兼容性好。你可以更新数据结构，而不影响和破坏原有的旧程序</li></ul>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ef1da7c92a2d6abc0a4dd08e26c000f4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">laravel yii thinkphp 框架对比_PHP框架之Laravel基础知识最全总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/7aeb7324c790d4186f53376c5219a0ca/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">python数据分析用哪个ide_什么是数据科学的最佳Python IDE？</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>