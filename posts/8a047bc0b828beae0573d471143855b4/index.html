<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Unity 自定义日志输出（基于DebugConsole) - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Unity 自定义日志输出（基于DebugConsole)" />
<meta property="og:description" content="在Unity项目的测试交付阶段，有时会碰到以下几个问题：
1 项目现场的测试人员说了一些bug情况，我会需要得到日志的信息支持从而处理，output_log.txt发过来之后，看到的却是只有初始化的一些业务日志。测试人员会告诉我：“哦！我发你之前又重启了一次程序”...output_log.txt每次程序重启都会清空重写。
2 于是我让他再触发一次bug，然后立即给当前的log文件，费了些时间，总算是复现了bug，日志给发过来了。仔细研读日志，定位到了一个函数或是语句，但是崩溃的是，这个函数可能被N个其他函数调用，而那些触发路线我没有埋日志输出，无法判断到底是从哪里进来的。
3 接着我就会埋下更多的print或debug.log，然后build一个程序发过去，让他再试。幸运的是，这下找到了问题并且解决。时间一天天过去，测试人员也回来了。我们促膝长谈，他突然提到：“哦，对了，我大前天上午大概11点半，在驻场测试的时候有触发一个bug，但是后来一直都触发不了，我知道你要output_log，我当天就启动了一次程序所以文件给你带来了”，然后我无语的是，这个文件我根本不知道哪一条语句是哪个时间点的，也没有发现error类的日志输出，所以...感谢他的敬业...
所以我所遇见过的需求，大致整理就是：
1 历史日志要能保存，不应被刷新
2 日志应该反应出其打印语句所在函数是从哪里进来的
3 日志应该要有时间戳
因此，我就用了DebugConsole.cs，关于它，可以参考：http://wiki.unity3d.com/index.php/DebugConsole，它的本有的功能就不多赘述了，我主要就是用DebugConsole.instance.Log.
主要看下面的两个地方，一个是Log函数修改，一个是新增了写文件：
public static void Log(object message) { //调用堆栈的帧，堆栈跟踪 StackTrace trace = new StackTrace(true); StackFrame sf = trace.GetFrame(1); //获取是哪个类来调用的 string className = sf.GetMethod().DeclaringType.ToString().Split(&#39;&#43;&#39;)[0]; //获取是类中的那个方法调用的 string[] method = sf.GetMethod().ToString().Split(&#39; &#39;); string methodName = method[method.Length - 1].Split(&#39;(&#39;)[0] &#43; &#34;(&#34; &#43; sf.GetFileLineNumber() &#43; &#34;)&#34;;//.PadRight(15); //得到log内容 string logContent = &#34;[&#34; &#43; System.DateTime.Now.ToString(&#34;yy/MM/dd HH:mm:ss:fff&#34;) &#43; &#34;] [&#34; &#43; className &#43; &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8a047bc0b828beae0573d471143855b4/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-04-11T19:01:25+08:00" />
<meta property="article:modified_time" content="2020-04-11T19:01:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Unity 自定义日志输出（基于DebugConsole)</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p style="text-indent:33px;">在Unity项目的测试交付阶段，有时会碰到以下几个问题：</p> 
<p style="text-indent:33px;">1 项目现场的测试人员说了一些bug情况，我会需要得到日志的信息支持从而处理，output_log.txt发过来之后，看到的却是只有初始化的一些业务日志。测试人员会告诉我：“哦！我发你之前又重启了一次程序”...output_log.txt每次程序重启都会清空重写。</p> 
<p style="text-indent:33px;">2 于是我让他再触发一次bug，然后立即给当前的log文件，费了些时间，总算是复现了bug，日志给发过来了。仔细研读日志，定位到了一个函数或是语句，但是崩溃的是，这个函数可能被N个其他函数调用，而那些触发路线我没有埋日志输出，无法判断到底是从哪里进来的。</p> 
<p style="text-indent:33px;">3 接着我就会埋下更多的print或debug.log，然后build一个程序发过去，让他再试。幸运的是，这下找到了问题并且解决。时间一天天过去，测试人员也回来了。我们促膝长谈，他突然提到：“哦，对了，我大前天上午大概11点半，在驻场测试的时候有触发一个bug，但是后来一直都触发不了，我知道你要output_log，我当天就启动了一次程序所以文件给你带来了”，然后我无语的是，这个文件我根本不知道哪一条语句是哪个时间点的，也没有发现error类的日志输出，所以...感谢他的敬业...</p> 
<p style="text-indent:33px;">所以我所遇见过的需求，大致整理就是：</p> 
<p style="text-indent:33px;">1 历史日志要能保存，不应被刷新</p> 
<p style="text-indent:33px;">2 日志应该反应出其打印语句所在函数是从哪里进来的</p> 
<p style="text-indent:33px;">3 日志应该要有时间戳</p> 
<p style="text-indent:33px;">因此，我就用了DebugConsole.cs，关于它，可以参考：<a href="http://wiki.unity3d.com/index.php/DebugConsole" rel="nofollow">http://wiki.unity3d.com/index.php/DebugConsole</a>，它的本有的功能就不多赘述了，我主要就是用DebugConsole.instance.Log.</p> 
<p style="text-indent:33px;">主要看下面的两个地方，一个是Log函数修改，一个是新增了写文件：</p> 
<pre><code class="language-cs">public static void Log(object message)
{
    //调用堆栈的帧，堆栈跟踪
    StackTrace trace = new StackTrace(true);
    StackFrame sf = trace.GetFrame(1);
    //获取是哪个类来调用的
    string className = sf.GetMethod().DeclaringType.ToString().Split('+')[0];
    //获取是类中的那个方法调用的
    string[] method = sf.GetMethod().ToString().Split(' ');
    string methodName = method[method.Length - 1].Split('(')[0] + "(" + sf.GetFileLineNumber() + ")";//.PadRight(15);
    //得到log内容
    string logContent = "[" + System.DateTime.Now.ToString("yy/MM/dd HH:mm:ss:fff") + "] [" + className + "." + methodName + "] " + message.ToString();
    
    //Unity输出，DebugConsole输出，增加一个写文件
    UnityEngine.Debug.Log(logContent);
    DebugConsole.instance.AddMessage(logContent);
    DebugConsole.instance.WriteFileByLine("");
    DebugConsole.instance.WriteFileByLine(logContent);
}

public string _fPath;
public string _fName = "Debug.log.txt";
/// &lt;summary&gt;
/// 写日志的文件流处理
/// &lt;/summary&gt;
/// &lt;param name="str_info"&gt;日志内容&lt;/param&gt;
public void WriteFileByLine(string str_info)
{
    _fPath = Application.streamingAssetsPath;
    StreamWriter sw;
    if (!File.Exists(_fPath + "//" + _fName))
    {
        sw = File.CreateText(_fPath + "//" + _fName);
    }
    else
    {
        sw = File.AppendText(_fPath + "//" + _fName);
    }
    sw.WriteLine(str_info);//以行为单位写入字符串  
    sw.Close();
    sw.Dispose();//文件流释放  
}</code></pre> 
<p style="text-indent:33px;">通过上述方法，算是满足了目前的需求，但是它会一直叠加，并不是理智行为，我觉得它应该拓展以下功能：</p> 
<p style="text-indent:33px;">1 按照日期进行日志文件命名，以实现内容的分割。</p> 
<p style="text-indent:33px;">2 定时打包日志，实现清理</p> 
<p style="text-indent:33px;">3 加入日志开关</p> 
<p style="text-indent:33px;">之后如果有合适的机会，我会综合之前学习框架课程中的日志模块，再整合修改。</p> 
<p style="text-indent:33px;">我改过的DebugConsole.cs资源下载：<a href="https://download.csdn.net/download/u010941527/12322242">Unity DebugConsole 修改版</a></p> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/5bf1a443ba86aa5ab2b572727aabd59c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">nginx ingress最后的倔强: admission webhook</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/c835bfb99796a1bb5e35af022d38abd8/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Qt用QCustomplot类编译一堆error:undefined reference to `_imp___ZN8QPrinterC1ENS_11PrinterModeE&#39;—工程设置可能有问题</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>