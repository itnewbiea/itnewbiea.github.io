<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>若依 数据权限 使用 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="若依 数据权限 使用" />
<meta property="og:description" content="package com.ruoyi.common.annotation; import java.lang.annotation.*; /** * 数据权限过滤注解 * * @author ruoyi */ @Target(ElementType.METHOD) @Retention(RetentionPolicy.RUNTIME) @Documented public @interface DataScope { /** * 部门表的别名 */ public String deptAlias() default &#34;&#34;; /** * 用户表的别名 */ public String userAlias() default &#34;&#34;; } 数据权限 1.首先要在使用数据权限的物理表中添加两个字段 dept_id 以及 user_id 为的是拼接sql查询数据时能找到对应部门 或者用户
2. 在第一个service 实现类中加上注解：
@DataScope(deptAlias = &#34;b&#34;,userAlias = &#34;b&#34;）
定义注解 ： deptAlias 代表部门别名 userAlias 代表用户别名 上文注解中 b 这个别名 代表你查询sql中存在 dept_id 以及 user_id字段的物理表的别名 也就是此图 { } 这个占位符拼接deptAlias 这就是 b." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b483e02a7ddd3bfc0fbc90fb48dd0932/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-08-10T15:59:22+08:00" />
<meta property="article:modified_time" content="2023-08-10T15:59:22+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">若依 数据权限 使用</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <pre><code class="language-java">package com.ruoyi.common.annotation;

import java.lang.annotation.*;

/**
 * 数据权限过滤注解
 *
 * @author ruoyi
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Documented
public @interface DataScope
{
    /**
     * 部门表的别名
     */
    public String deptAlias() default "";

    /**
     * 用户表的别名
     */
    public String userAlias() default "";
}
</code></pre> 
<p>数据权限 </p> 
<p>1.首先要在使用数据权限的物理表中添加两个字段 dept_id 以及 user_id  为的是拼接sql查询数据时能找到对应部门 或者用户</p> 
<p>2. 在第一个service 实现类中加上注解：</p> 
<p>@DataScope(deptAlias = "<span style="color:#fe2c24;">b</span>",userAlias = "<span style="color:#fe2c24;">b</span>"）</p> 
<p>定义注解 ： deptAlias 代表部门别名 userAlias 代表用户别名 上文注解中  <span style="color:#fe2c24;">b  </span>这个别名 代表你查询sql中存在 dept_id 以及 user_id字段的物理表的别名 </p> 
<p><img alt="" height="258" src="https://images2.imgbox.com/e1/57/G4r0xywX_o.png" width="1200"></p> 
<p></p> 
<p>也就是此图 { } 这个占位符拼接deptAlias 这就是     b.dept_id   </p> 
<p></p> 
<p> </p> 
<p>3.如何拼接呢 ？</p> 
<p><img alt="" height="602" src="https://images2.imgbox.com/85/3d/tLFwJ8Zp_o.png" width="1178"></p> 
<p>原理：要使用数据权限 接口必须要有传参对象  而且这个对象必须继承 BaseEntity</p> 
<p>在 下图 aspectj  中会获取 BaseEntity中的params这个参数  把通过系统中设置的数据权限拼接成sql 赋值到params的dataScope中。</p> 
<p>4.在sql最后加上 sql拼接占位 &lt;!-- 数据范围过滤 --&gt;    若依的数据权限就可以使用了<br>                                                ${params.dataScope}</p> 
<p> <img alt="" height="270" src="https://images2.imgbox.com/e6/6c/XthEChuo_o.png" width="740"></p> 
<p> </p> 
<p></p> 
<pre><code class="language-java">package com.ruoyi.aspectj;


import com.ruoyi.common.annotation.DataScope;
import com.ruoyi.common.core.domain.BaseEntity;
import com.ruoyi.common.core.domain.entity.SysRole;
import com.ruoyi.common.core.domain.entity.SysUser;
import com.ruoyi.common.core.domain.model.LoginUser;
import com.ruoyi.common.utils.StringUtils;
import com.ruoyi.system.service.ISysUserService;
import org.aspectj.lang.JoinPoint;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.annotation.Before;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;

import static com.ruoyi.common.helper.LoginHelper.getLoginUser;

/**
 * 数据过滤处理
 *
 * @author ruoyi
 */
@Aspect
@Component
public class DataScopeAspect
{
    /**
     * 全部数据权限
     */
    public static final String DATA_SCOPE_ALL = "1";

    /**
     * 自定数据权限
     */
    public static final String DATA_SCOPE_CUSTOM = "2";

    /**
     * 部门数据权限
     */
    public static final String DATA_SCOPE_DEPT = "3";

    /**
     * 部门及以下数据权限
     */
    public static final String DATA_SCOPE_DEPT_AND_CHILD = "4";

    /**
     * 仅本人数据权限
     */
    public static final String DATA_SCOPE_SELF = "5";

    /**
     * 数据权限过滤关键字
     */
    public static final String DATA_SCOPE = "dataScope";
    @Resource
    private ISysUserService iSysUserService;

    @Before("@annotation(controllerDataScope)")
    public void doBefore(JoinPoint point, DataScope controllerDataScope) throws Throwable
    {
        clearDataScope(point);
        handleDataScope(point, controllerDataScope);
    }

    protected void handleDataScope(final JoinPoint joinPoint, DataScope controllerDataScope)
    {
        // 获取当前的用户
        LoginUser loginUser =  getLoginUser();
        if (null!=loginUser &amp;&amp; null!=loginUser.getUserId())
        {
            SysUser currentUser = iSysUserService.selectUserById(loginUser.getUserId());
            // 如果是超级管理员，则不过滤数据
            if ((null!=currentUser) &amp;&amp; !currentUser.isAdmin())
            {
                dataScopeFilter(joinPoint, currentUser, controllerDataScope.deptAlias(),
                        controllerDataScope.userAlias());
            }
        }
    }

    /**
     * 数据范围过滤
     *
     * @param joinPoint 切点
     * @param user 用户
     * @param userAlias 别名
     */
    public static void dataScopeFilter(JoinPoint joinPoint, SysUser user, String deptAlias, String userAlias)
    {
        StringBuilder sqlString = new StringBuilder();

        for (SysRole role : user.getRoles())
        {
            String dataScope = role.getDataScope();
            if (DATA_SCOPE_ALL.equals(dataScope))
            {
                sqlString = new StringBuilder();
                break;
            }
            else if (DATA_SCOPE_CUSTOM.equals(dataScope))
            {
                sqlString.append(StringUtils.format(
                        " OR {}.dept_id IN ( SELECT dept_id FROM sys_role_dept WHERE role_id = {} ) ", deptAlias,
                        role.getRoleId()));
            }
            else if (DATA_SCOPE_DEPT.equals(dataScope))
            {
                sqlString.append(StringUtils.format(" OR {}.dept_id = {} ", deptAlias, user.getDeptId()));
            }
            else if (DATA_SCOPE_DEPT_AND_CHILD.equals(dataScope))
            {
                sqlString.append(StringUtils.format(
                        " OR {}.dept_id IN ( SELECT dept_id FROM sys_dept WHERE dept_id = {} or find_in_set( {} , ancestors ) )",
                        deptAlias, user.getDeptId(), user.getDeptId()));
            }
            else if (DATA_SCOPE_SELF.equals(dataScope))
            {
                if (StringUtils.isNotBlank(userAlias))
                {
                    sqlString.append(StringUtils.format(" OR {}.user_id = {} ", userAlias, user.getUserId()));
                }
                else
                {
                    // 数据权限为仅本人且没有userAlias别名不查询任何数据
                    sqlString.append(" OR 1=0 ");
                }
            }
        }

        if (StringUtils.isNotBlank(sqlString.toString()))
        {
            Object params = joinPoint.getArgs()[0];
            if (params instanceof BaseEntity)
            {
                BaseEntity baseEntity = (BaseEntity) params;
                baseEntity.getParams().put(DATA_SCOPE, " AND (" + sqlString.substring(4) + ")");
            }
        }
    }

    /**
     * 拼接权限sql前先清空params.dataScope参数防止注入
     */
    private void clearDataScope(final JoinPoint joinPoint)
    {
        Object params = joinPoint.getArgs()[0];
        if (params instanceof BaseEntity)
        {
            BaseEntity baseEntity = (BaseEntity) params;
            baseEntity.getParams().put(DATA_SCOPE, "");
        }
    }
}
</code></pre> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/dae48e7f367e9c7fd1281d6ae4bcb401/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">C&#43;&#43;看这个</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/26e152bed198824f35dd65a393360a0d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">单芯片3路CC管理的VR转接器解决方案</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>