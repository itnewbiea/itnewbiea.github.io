<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SpringCloud3.0&#43;Sa-token&#43;Gateway网关实现鉴权和token登录拦截功能 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="SpringCloud3.0&#43;Sa-token&#43;Gateway网关实现鉴权和token登录拦截功能" />
<meta property="og:description" content="版本： Springboot3.0.5以及对应的Springcloud，SpringcloudAlibaba依赖nacos 2.2.0，sa-token1.34.0，Mysql8.0 前提： 我这边是主要是对管理员进行鉴权的，所以划分了管理员以及网关服务，而sa-token的统一鉴权是在网关服务里面设计的。Sa-token官方网址：Sa-Token 父依赖： &lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt; &lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34; xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt; &lt;properties&gt; &lt;java.version&gt;17&lt;/java.version&gt; &lt;!-- springboot 3 对应mybatis 3.0.0以上，否则会报错--&gt; &lt;mybatis-spring-boot-starter.version&gt;3.0.0&lt;/mybatis-spring-boot-starter.version&gt; &lt;spring-cloud-alibaba.version&gt;2022.0.0.0-RC1&lt;/spring-cloud-alibaba.version&gt; &lt;spring.cloud.dependencies&gt;2022.0.1&lt;/spring.cloud.dependencies&gt; &lt;/properties&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.18.26&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;8.0.31&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt; &lt;/dependency&gt; &lt;!-- Sa-Token 整合 Redis （使用 jackson 序列化方式） --&gt; &lt;dependency&gt; &lt;groupId&gt;cn.dev33&lt;/groupId&gt; &lt;artifactId&gt;sa-token-dao-redis-jackson&lt;/artifactId&gt; &lt;version&gt;1.34.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/8e71c89b0657086a94379889275baef9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-04-23T17:04:56+08:00" />
<meta property="article:modified_time" content="2023-04-23T17:04:56+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">SpringCloud3.0&#43;Sa-token&#43;Gateway网关实现鉴权和token登录拦截功能</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <blockquote> 
 <h2>版本：</h2> 
</blockquote> 
<ul><li>Springboot3.0.5以及对应的Springcloud，SpringcloudAlibaba依赖</li><li>nacos 2.2.0，sa-token1.34.0，Mysql8.0</li></ul> 
<hr> 
<blockquote> 
 <h3>前提：</h3> 
</blockquote> 
<ul><li>我这边是主要是对管理员进行鉴权的，所以划分了管理员以及网关服务，而sa-token的统一鉴权是在网关服务里面设计的。</li><li>Sa-token官方网址：<a href="https://sa-token.cc/doc.html" rel="nofollow" title="Sa-Token">Sa-Token</a></li></ul> 
<blockquote> 
 <h3>父依赖：</h3> 
</blockquote> 
<pre><code class="language-XML">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;

    &lt;properties&gt;
        &lt;java.version&gt;17&lt;/java.version&gt;
        &lt;!--        springboot 3 对应mybatis 3.0.0以上，否则会报错--&gt;
        &lt;mybatis-spring-boot-starter.version&gt;3.0.0&lt;/mybatis-spring-boot-starter.version&gt;
        &lt;spring-cloud-alibaba.version&gt;2022.0.0.0-RC1&lt;/spring-cloud-alibaba.version&gt;
        &lt;spring.cloud.dependencies&gt;2022.0.1&lt;/spring.cloud.dependencies&gt;
    &lt;/properties&gt;


    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;version&gt;1.18.26&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;mysql&lt;/groupId&gt;
            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;
            &lt;version&gt;8.0.31&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
        &lt;/dependency&gt;


        &lt;!-- Sa-Token 整合 Redis （使用 jackson 序列化方式） --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cn.dev33&lt;/groupId&gt;
            &lt;artifactId&gt;sa-token-dao-redis-jackson&lt;/artifactId&gt;
            &lt;version&gt;1.34.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
            &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;dependencyManagement&gt;

        &lt;dependencies&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
                &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
                &lt;version&gt;${mybatis-spring-boot-starter.version}&lt;/version&gt;
            &lt;/dependency&gt;

            &lt;!--springcloud alibaba--&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-alibaba-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring-cloud-alibaba.version}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;


            &lt;!-- 这里引入最新的SpringCloud依赖 --&gt;
            &lt;dependency&gt;
                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;
                &lt;version&gt;${spring.cloud.dependencies}&lt;/version&gt;
                &lt;type&gt;pom&lt;/type&gt;
                &lt;scope&gt;import&lt;/scope&gt;
            &lt;/dependency&gt;
        &lt;/dependencies&gt;
    &lt;/dependencyManagement&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre> 
<blockquote> 
 <h3>Admin服务子模块</h3> 
</blockquote> 
<h4> 依赖</h4> 
<pre><code class="language-XML">
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;3.5.3.1&lt;/version&gt;
        &lt;/dependency&gt;


        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;
            &lt;artifactId&gt;druid-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;1.1.9&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mybatis.spring.boot&lt;/groupId&gt;
            &lt;artifactId&gt;mybatis-spring-boot-starter&lt;/artifactId&gt;
        &lt;/dependency&gt;


        &lt;!--        nacos 配置中心--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- 这里需要单独导入LoadBalancer依赖 --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!-- Sa-Token 权限认证（Reactor响应式集成）, 在线文档：https://sa-token.cc --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cn.dev33&lt;/groupId&gt;
            &lt;artifactId&gt;sa-token-spring-boot3-starter&lt;/artifactId&gt;
            &lt;version&gt;1.34.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- 自定义公共模块--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.example&lt;/groupId&gt;
            &lt;artifactId&gt;commons&lt;/artifactId&gt;
            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;
            &lt;artifactId&gt;reactor-core&lt;/artifactId&gt;
            &lt;version&gt;3.5.4&lt;/version&gt;
        &lt;/dependency&gt;



    &lt;/dependencies&gt;
</code></pre> 
<p> 控制器类：按照官方文档，我们知道只需要实现它的StpUtil.login(Object id); 方法就行。</p> 
<pre><code class="language-java">@RestController
@RequestMapping("/admin")
public class AdminController{
    @Resource
    AdminService adminService;


    @PostMapping("/login")
    public R login(@RequestParam("id") int id,
                   @RequestParam("password") String password)
    {
        Admin admin=adminService.login(id,password);
        if(!ObjectUtils.isEmpty(admin))
        {
//            登录
            StpUtil1.setStpLogic(new StpLogic("admin"));
            StpUtil1.login(admin.getId());
//            获取token并返回
            return   R.success("登录成功",StpUtil1.getTokenInfo());
        }
        return R.error("登录失败");
    }
</code></pre> 
<p>上面我用的是<strong>StpUtil1</strong>而不是<strong>StpUtil</strong> ,原因是我系统有<strong>两个角色</strong>，<strong>超级管理员</strong>和<strong>管理员</strong>，所以根据官方文档我创建了一个新的类，叫做StpUtil1，然后将其StpUtil复制过来，更改其属性<strong>TYPE为admin </strong>。同理超级管理员也是创建多一个类就行，更改TYPE，这让我想起了设计模式的开闭原则哈哈哈。</p> 
<p><img alt="" height="646" src="https://images2.imgbox.com/35/42/UYM3jwjR_o.png" width="1089"></p> 
<p><img alt="" height="653" src="https://images2.imgbox.com/f6/0e/lFiuK7my_o.png" width="1050"></p> 
<p>        配置文件bootstrap.yml,因为配置数据库的配置在配置中心，这里就不放出来了</p> 
<blockquote> 
 <p><strong>Redis整合</strong></p> 
</blockquote> 
<p>这里sa-token<strong>整合redis</strong>只需要将配置文件配置，和导入依赖，sa-token就会自动将数据存入redis里面了，注意版本要对上，以防错误。</p> 
<pre><code class="language-java">server:
  port: 8081
spring:
  application:
    name: Admin-service
  profiles:
    # 环境也是和配置文件保持一致
    active: db
  cloud:
    nacos:
      config:
        # 配置文件后缀名
        file-extension: yml
        # 配置中心服务器地址，也就是Nacos地址
        server-addr: localhost:8848
        prefix: dataBase
      discovery:
        # 配置Nacos注册中心地址
        server-addr: localhost:8848
  data:
  # redis配置
    redis:
      # Redis数据库索引（默认为0）
      database: 1
      # Redis服务器地址
      host: 127.0.0.1
      # Redis服务器连接端口
      port: 6379
      # Redis服务器连接密码（默认为空）
      # password:
      # 连接超时时间
      timeout: 10s
      lettuce:
        pool:
          # 连接池最大连接数
          max-active: 200
          # 连接池最大阻塞等待时间（使用负值表示没有限制）
          max-wait: -1ms
          # 连接池中的最大空闲连接
          max-idle: 10
          # 连接池中的最小空闲连接
          min-idle: 0

</code></pre> 
<h3> Gateway服务子模块</h3> 
<h3>依赖</h3> 
<pre><code class="language-java">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;competition&lt;/artifactId&gt;
        &lt;groupId&gt;com.example&lt;/groupId&gt;
        &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;GateWay&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;!--       网关--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;cn.dev33&lt;/groupId&gt;
            &lt;artifactId&gt;sa-token-reactor-spring-boot3-starter&lt;/artifactId&gt;
            &lt;version&gt;1.34.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-openfeign&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--        一定要引入 loadbalancer才能使用 lb://进行负载均衡调用--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-loadbalancer&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;!--注册中心客户端--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;!--依赖冲突，通过该方法可以巧妙去除（重写覆盖，）父类依赖，这就是maven解决冲突的最短依赖路径原则。--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;!-- 自定义公共模块--&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.example&lt;/groupId&gt;
            &lt;artifactId&gt;commons&lt;/artifactId&gt;
            &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;
&lt;/project&gt;</code></pre> 
<blockquote> 
 <p>整合Gateway注意点</p> 
</blockquote> 
<p>值得注意的是，因为Gateway是基于 <strong>WebFlux</strong>开发的，所以呢，我们需要去到官网，找一下下资料，如图，要导入的依赖是带有<strong>reactor</strong>的噢，而且因为使用的是springboot3，所以还要将boot改为<strong>boot3</strong>，<strong>别导错依赖了！！</strong></p> 
<p><img alt="" height="398" src="https://images2.imgbox.com/0e/e2/pvOmtuzn_o.png" width="975"></p> 
<blockquote> 
 <h3> 全局过滤器类（鉴权，登录拦截token，跨域）</h3> 
</blockquote> 
<ul><li>SptUtil1和SptUtil2都是在公共模块commons中的哈，然后两者除了Type不一样其他都一样，用来区分不同管理员，超级管理员是拥有所有权限的，而管理员权限是超级管理员分配的。</li><li>所以超级管理员只要登录就可以访问各个路径啦</li><li>但是管理员就要检测一下权限了。看官网给出的详细代码解释<img alt="" height="470" src="https://images2.imgbox.com/21/ea/G8l6ygQy_o.png" width="973"></li></ul> 
<p></p> 
<pre><code class="language-java">package com.test.conf;


import cn.dev33.satoken.context.SaHolder;
import cn.dev33.satoken.exception.SaTokenException;
import cn.dev33.satoken.reactor.filter.SaReactorFilter;
import cn.dev33.satoken.router.SaHttpMethod;
import cn.dev33.satoken.router.SaRouter;
import cn.dev33.satoken.stp.StpUtil;
import cn.dev33.satoken.util.SaResult;
import com.test.entity.StpUtil1;
import com.test.entity.StpUtil2;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Primary;


/**
 * @author LiYa
 * @create 2023-04-05 22:36
 */
@Configuration
public class SaTokenConfigure  {
    // 注册 Sa-Token全局过滤器

    @Bean
    @Primary
    public SaReactorFilter getSaReactorFilter() {
        return new SaReactorFilter  ()
                // 拦截地址
                .addInclude("/**")
                // 开放地址
                .addExclude("/admin/login")
                .addExclude("/SuperAdmin/login")
                // 鉴权方法：每次访问进入
                .setAuth(obj -&gt; {
                    System.out.println("---------- sa全局认证");
                    System.out.println(StpUtil1.isLogin());
                    System.out.println(StpUtil2.isLogin());
                    System.out.println(StpUtil1.getPermissionList());
                    // 登录校验 -- 拦截所有路由，并排除/user/doLogin 用于开放登录
//                    SaRouter.match("/**", "/admin/login", r -&gt; StpUtil1.checkLogin());
                    // 角色认证 -- 拦截以 admin 开头的路由，必须具备 admin 角色或者 super-admin 角色才可以通过认证
                    // 权限认证 -- 不同模块, 校验不同权限
                    SaRouter.match("/events/**").check(r -&gt; {
                       if(StpUtil1.hasPermission("mEvent")==false &amp;&amp; StpUtil2.isLogin()==false)
                       {
                           throw new SaTokenException("没有权限噢");
                       }
                    });
                    SaRouter.match("/admin/**").check(r -&gt; {
                        if(StpUtil2.isLogin()==false)
                        {
                            throw new SaTokenException("没有权限噢");
                        }
                    });
                    SaRouter.match("/advertisement/**").check(r -&gt; {
                        if(StpUtil1.hasPermission("mAdvertisement")==false &amp;&amp; StpUtil2.isLogin()==false)
                        {
                            throw new SaTokenException("没有权限噢");
                        }
                    });
                    SaRouter.match("/award/**").check(r -&gt; {
                        if(StpUtil1.hasPermission("mAward")==false &amp;&amp; StpUtil2.isLogin()==false)
                        {
                            throw new SaTokenException("没有权限噢");
                        }
                    });
                    SaRouter.match("/notice/**").check(r -&gt; {
                        if(StpUtil1.hasPermission("mNotice")==false &amp;&amp; StpUtil2.isLogin()==false)
                        {
                            throw new SaTokenException("没有权限噢");
                        }
                    });
                })
                // 异常处理方法：每次setAuth函数出现异常时进入
                .setError(e -&gt; {
                    System.out.println("---------- sa异常认证");
                    return SaResult.error(e.getMessage());
                })
// 前置函数：在每次认证函数之前执行
        		.setBeforeAuth(obj -&gt; {
            // ---------- 设置跨域响应头 ----------
            SaHolder.getResponse()
                    // 允许指定域访问跨域资源
                    .setHeader("Access-Control-Allow-Origin", "*")
                    // 允许所有请求方式
                    .setHeader("Access-Control-Allow-Methods", "POST, GET, OPTIONS, DELETE")
                    // 有效时间
                    .setHeader("Access-Control-Max-Age", "3600")
                    // 允许的header参数
                    .setHeader("Access-Control-Allow-Headers", "*");

            // 如果是预检请求，则立即返回到前端
            SaRouter.match(SaHttpMethod.OPTIONS)
                    .free(r -&gt; System.out.println("--------OPTIONS预检请求，不做处理"))
                    .back();
        });
    }

}
</code></pre> 
<p>那么管理员的权限从哪来呢？不用思考直接看官网。</p> 
<p>只要实现了这个接口，就可以设计权限了，ohyeah，真的太腻害了 ！</p> 
<p><img alt="" height="696" src="https://images2.imgbox.com/90/b6/sum6ZMWq_o.png" width="1020"><strong>但值得注意的是，因为采用的是Springcloud，所以不能在admin服务那边实现该接口，必须要在网关服务里面实现，否则是没有的！！！！！！！空说无凭，上证据，看官网</strong></p> 
<p><img alt="" height="175" src="https://images2.imgbox.com/ae/a1/DSKExL6E_o.png" width="842"></p> 
<p> 实现StpInterface 接口的代码（在网关服务里面实现）</p> 
<pre><code class="language-java">package com.test.auth;

import cn.dev33.satoken.stp.StpInterface;
import jakarta.annotation.Resource;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

/**
 * @author LiYa
 * @create 2023-04-09 16:50
 * 通过前端传递过来的token可以找到该logintype对应的id
 */
@Component
public class stp implements StpInterface {
    @Resource
    RedisTemplate redisTemplate;


    @Override
    public List&lt;String&gt; getPermissionList(Object loginId, String loginType) {

        return (List&lt;String&gt;) redisTemplate.opsForList().range(loginType+loginId, 0,-1);
    }

    @Override
    public List&lt;String&gt; getRoleList(Object loginId, String loginType) {
        List&lt;String&gt; list =new ArrayList&lt;&gt;();
        list.add(loginType);
        return list;
    }
}
</code></pre> 
<h4>bootstrap.yml </h4> 
<pre><code class="language-java">server:
  port: 8500

spring:
  application:
    name: gateway
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
        username: nacos
        password: nacos
      config:
        extension-configs:
          - data-id: Gateway-dev.yml
            group: DEFAULT_GROUP
            refresh: true

#          - data-id: intercept-dev.yml
#            group: DEFAULT_GROUP
#            refresh: true

  data:
    # redis配置
    redis:
      # Redis数据库索引（默认为0）
      database: 1
      # Redis服务器地址
      host: 127.0.0.1
      # Redis服务器连接端口
      port: 6379
      # Redis服务器连接密码（默认为空）
      # password:
      # 连接超时时间
      timeout: 10s
      lettuce:
        pool:
          # 连接池最大连接数
          max-active: 200
          # 连接池最大阻塞等待时间（使用负值表示没有限制）
          max-wait: -1ms
          # 连接池中的最大空闲连接
          max-idle: 10
          # 连接池中的最小空闲连接
          min-idle: 0

# Sa-Token配置
sa-token:
  # token名称 (同时也是cookie名称)
  token-name: satoken
  # token有效期，单位秒，-1代表永不过期
  timeout: 2592000
  # token临时有效期 (指定时间内无操作就视为token过期)，单位秒
  activity-timeout: -1
  # 是否允许同一账号并发登录 (为false时新登录挤掉旧登录)
  is-concurrent: true
  # 在多人登录同一账号时，是否共用一个token (为false时每次登录新建一个token)
  is-share: false
  # token风格
  token-style: uuid
  # 是否输出操作日志
  is-log: false
  # 是否从cookie中读取token
  is-read-cookie: false




</code></pre> 
<hr> 
<p>接下来就是测试了，启动服务，访问登录，呐呐呐，看到返回值没有，我们这个时候就可以提取tokenValue和tokenName去访问服务了。</p> 
<p><img alt="" height="810" src="https://images2.imgbox.com/41/a2/8ElLmvcy_o.png" width="1200"></p> 
<p></p> 
<p>访问redis成功出现数据 。</p> 
<p><img alt="" height="642" src="https://images2.imgbox.com/35/fa/OyiVbVcu_o.png" width="1200"></p> 
<p>此时我们去访问某个服务，先不带token访问，毫无疑问被拦截了</p> 
<p><img alt="" height="813" src="https://images2.imgbox.com/2e/1c/HImTJt5y_o.png" width="1200"></p> 
<p>设置token，yeah成功有数据返回啦</p> 
<p><img alt="" height="793" src="https://images2.imgbox.com/18/c9/fbmHCHbC_o.png" width="1200"></p> 
<p></p> 
<hr> 
<p><strong> 总结：看官网，多实践，给博主点赞关注，这样就可以理解解决任何bug，最主要的还是多实践以及给博主点赞关注</strong>。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/aaf7f72b13051a836831dadc77206f32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">JavaScript 数字精度丢失的问题及解决方案</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/558d19f9cb40a3487ac915fa0f39a8d7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">mongodb6.0版本：window安装mongdb和启动操作数据库</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>