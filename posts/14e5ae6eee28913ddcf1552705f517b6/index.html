<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>GoogleNetv1：Going deeper with convolutions更深的卷积神经网络 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="GoogleNetv1：Going deeper with convolutions更深的卷积神经网络" />
<meta property="og:description" content="文章目录 GoogleNetv1全文翻译论文结构摘要1 引言2 相关工作3 动机和高层考虑稀疏矩阵 4 结构细节引入1x1卷积核可以减少通道数 5 GoogleNet6 训练方法7 ILSVRC 2014 分类挑战赛设置和结果8 ILSVRC 2014检测挑战赛设置和结果目标检测的平均精度和 [mAP](https://towardsdatascience.com/breaking-down-mean-average-precision-map-ae462f623a52) 9 总结 论文研究背景、成果及意义论文图表论文代码复现准备工作GoogleNetv1推理代码及运行结果GoogleNetv1训练代码及运行结果 GoogleNetv1全文翻译 论文结构 摘要 我们提出了一种代号为 Inception 的深度卷积神经网络架构，它负责在 2014 年 ImageNet 大规模视觉识别挑战赛（ILSVRC14）中为分类和检测设定新的技术水平。 该架构的主要特点是提高了网络内部计算资源的利用率。 这是通过精心设计的设计实现的，该设计允许增加网络的深度和宽度，同时保持计算预算不变。 为了优化质量，架构决策基于 Hebbian 原理和多尺度处理的直觉。 我们提交的 ILSVRC14 中使用的一种特殊形式称为 GoogLeNet，这是一种 22 层深度网络，其质量是在分类和检测的背景下进行评估的。
1 引言 在过去三年中，主要由于深度学习（更具体地说是卷积网络）[10]的进步，图像识别和目标检测的质量取得了巨大的进步。 一个令人鼓舞的消息是，大部分进展不仅是更强大的硬件、更大的数据集和更大的模型的结果，而主要是新想法、算法和改进的网络架构的结果。 例如，ILSVRC 2014 竞赛中的顶级参赛作品除了用于检测目的的同一竞赛的分类数据集外，没有使用任何新的数据源。 我们向 ILSVRC 2014 提交的 GoogLeNet 实际上使用的参数比两年前 Krizhevsky 等人 [9] 的获胜架构少了 12 倍，同时明显更加准确。 目标检测的最大收益并非来自单独使用深层网络或更大的模型，而是来自深层架构和经典计算机的协同作用视觉，如 Girshick 等人的 R-CNN 算法 [6]。
另一个值得注意的因素是，随着移动和嵌入式计算的持续发展，我们算法的效率（尤其是其功耗和内存使用）变得越来越重要。 值得注意的是，本文提出的深层架构设计的考虑因素包括了这个因素，而不是纯粹关注准确率数字。 对于大多数实验，模型的设计目的是在推理时保持 15 亿次乘加的计算预算，因此它们最终不会成为纯粹的学术好奇心，而是可以应用于现实世界，甚至以合理的成本处理大型数据集。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/14e5ae6eee28913ddcf1552705f517b6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-05T11:15:21+08:00" />
<meta property="article:modified_time" content="2024-01-05T11:15:21+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">GoogleNetv1：Going deeper with convolutions更深的卷积神经网络</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#GoogleNetv1_2" rel="nofollow">GoogleNetv1全文翻译</a></li><li><a href="#_4" rel="nofollow">论文结构</a></li><li><ul><li><a href="#_6" rel="nofollow">摘要</a></li><li><a href="#1__11" rel="nofollow">1 引言</a></li><li><a href="#2__18" rel="nofollow">2 相关工作</a></li><li><a href="#3__27" rel="nofollow">3 动机和高层考虑</a></li><li><ul><li><a href="#_44" rel="nofollow">稀疏矩阵</a></li></ul> 
   </li><li><a href="#4__48" rel="nofollow">4 结构细节</a></li><li><ul><li><a href="#1x1_58" rel="nofollow">引入1x1卷积核可以减少通道数</a></li></ul> 
   </li><li><a href="#5_GoogleNet_73" rel="nofollow">5 GoogleNet</a></li><li><a href="#6__99" rel="nofollow">6 训练方法</a></li><li><a href="#7_ILSVRC_2014__106" rel="nofollow">7 ILSVRC 2014 分类挑战赛设置和结果</a></li><li><a href="#8_ILSVRC_2014_123" rel="nofollow">8 ILSVRC 2014检测挑战赛设置和结果</a></li><li><ul><li><a href="#_mAPhttpstowardsdatasciencecombreakingdownmeanaverageprecisionmapae462f623a52_135" rel="nofollow">目标检测的平均精度和 [mAP](https://towardsdatascience.com/breaking-down-mean-average-precision-map-ae462f623a52)</a></li></ul> 
   </li><li><a href="#9__150" rel="nofollow">9 总结</a></li></ul> 
  </li><li><a href="#_161" rel="nofollow">论文研究背景、成果及意义</a></li><li><a href="#_170" rel="nofollow">论文图表</a></li><li><a href="#_177" rel="nofollow">论文代码复现准备工作</a></li><li><a href="#GoogleNetv1_179" rel="nofollow">GoogleNetv1推理代码及运行结果</a></li><li><a href="#GoogleNetv1_690" rel="nofollow">GoogleNetv1训练代码及运行结果</a></li></ul> 
</div> 
<br> 
<img src="https://images2.imgbox.com/d6/9f/mX2sJixY_o.png" alt="在这里插入图片描述"> 
<p></p> 
<h2><a id="GoogleNetv1_2"></a>GoogleNetv1全文翻译</h2> 
<p><img src="https://images2.imgbox.com/c2/90/m2YG7PlX_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_4"></a>论文结构</h2> 
<p><img src="https://images2.imgbox.com/da/43/ErrpQwIH_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="_6"></a>摘要</h3> 
<p><img src="https://images2.imgbox.com/a4/db/bljF8P1E_o.png" alt="在这里插入图片描述"></p> 
<p>我们提出了一种代号为 Inception 的深度卷积神经网络架构，它负责在 2014 年 ImageNet 大规模视觉识别挑战赛（ILSVRC14）中为分类和检测设定新的技术水平。 该架构的主要特点是提高了网络内部计算资源的利用率。 这是通过精心设计的设计实现的，该设计允许增加网络的深度和宽度，同时保持计算预算不变。 为了优化质量，<strong>架构决策基于 Hebbian 原理和多尺度处理的直觉</strong>。 我们提交的 ILSVRC14 中使用的一种特殊形式称为 <strong>GoogLeNet，这是一种 22 层深度网络</strong>，其质量是在分类和检测的背景下进行评估的。<br> <img src="https://images2.imgbox.com/21/c0/tuOQgp8b_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="1__11"></a>1 引言</h3> 
<p><img src="https://images2.imgbox.com/92/03/aIpdPFZe_o.png" alt="在这里插入图片描述"><br> 在过去三年中，主要由于深度学习（更具体地说是卷积网络）[10]的进步，图像识别和目标检测的质量取得了巨大的进步。 一个令人鼓舞的消息是，大部分进展不仅是更强大的硬件、更大的数据集和更大的模型的结果，而主要是新想法、算法和改进的网络架构的结果。 例如，ILSVRC 2014 竞赛中的顶级参赛作品除了用于检测目的的同一竞赛的分类数据集外，没有使用任何新的数据源。 我们向 ILSVRC 2014 提交的 GoogLeNet 实际上使用的参数比两年前 Krizhevsky 等人 [9] 的获胜架构少了 12 倍，同时明显更加准确。 <mark>目标检测的最大收益并非来自单独使用深层网络或更大的模型，而是来自深层架构和经典计算机的协同作用视觉，如 Girshick 等人的 R-CNN 算法 [6]。</mark></p> 
<p>另一个值得注意的因素是，随着移动和嵌入式计算的持续发展，我们算法的效率（尤其是其功耗和内存使用）变得越来越重要。 值得注意的是，本文提出的深层架构设计的考虑因素包括了这个因素，而不是纯粹关注准确率数字。 对于大多数实验，模型的设计目的是在推理时保持 15 亿次乘加的计算预算，因此它们最终不会成为纯粹的学术好奇心，而是可以应用于现实世界，甚至以合理的成本处理大型数据集。<br> <img src="https://images2.imgbox.com/a8/1c/GFunEkWB_o.png" alt="在这里插入图片描述"><br> 在本文中，我们将重点研究一种用于计算机视觉的高效深度神经网络架构，代号为 Inception，其名称源自 Lin 等人[12]的论文Network in network，并结合著名的“we need to go deeper” 互联网模因[1]。 在我们的例子中，“深度”这个词有两种不同的含义：首先，我们以“Inception模块”的形式引入了新的组织级别，还有更直接的增加网络的含义深度。 一般来说，人们可以将 Inception 模型视为 [12] 的逻辑巅峰，同时从 Arora 等人的理论工作中获得灵感和指导 [2]。 该架构的优点在 ILSVRC 2014 分类和检测挑战中得到了实验验证，其性能显着优于当前最先进的。</p> 
<h3><a id="2__18"></a>2 相关工作</h3> 
<p><img src="https://images2.imgbox.com/41/82/A2lv7hp6_o.png" alt="在这里插入图片描述"><br> 从 LeNet-5 [10] 开始，卷积神经网络 (CNN) 通常具有标准结构 - 堆叠卷积层（可选地后跟对比度归一化和最大池化），后面跟着一个或多个全连接层<code>即FC层</code>。 这种基本设计的变体在图像分类文献中很普遍，并且在 MNIST、CIFAR 以及最引人注目的 ImageNet 分类挑战中取得了迄今为止最好的结果 [9, 21]。 对于 Imagenet 等较大的数据集，最近的趋势是增加层数 [12] 和层大小 [21, 14]，同时使用 dropout [7] 来解决过拟合问题。</p> 
<p>尽管担心最大池化层会导致准确的空间信息丢失，但与[9]相同的卷积网络架构也已成功应用于定位[9,14]、物体检测[6,14,18,5]和人类姿态估计[19]。 受到灵长类视觉皮层神经科学模型的启发，Serre 等人。 [15]<strong>使用一系列不同大小的固定Gabor滤波器来处理多个尺度</strong>，类似于Inception模型。 然而，与[15]的固定2层深度模型相反，Inception模型中的所有过滤器都是学习的。 此外，Inception 层重复多次，导致 GoogLeNet 的深度模型达到 22 层模型。</p> 
<p>Network-in-Network 是 Lin 等人提出的一种方法 [12]为了增加神经网络的表征能力。 当应用于卷积层时，该方法可以被视为附加的 1×1 卷积层，后面通常是修正的线性激活 [9]。 这使其能够轻松集成到当前的 CNN 管道中。 我们在我们的架构中大量使用这种方法。 然而，在我们的设置中，1 × 1 卷积有双重目的：最关键的是，它们主要用作降维模块以消除计算瓶颈，否则会限制我们网络的大小。 这不仅可以增加网络的深度，还可以增加网络的宽度，而不会造成明显的性能损失。</p> 
<p>当前目标检测的主要方法是 Girshick 等人提出的卷积神经网络区域 (R-CNN) [6]。<mark>R-CNN 将整体检测问题分解为两个子问题：首先以与类别无关的方式利用颜色和超像素一致性等低级线索来提出潜在的对象建议，然后使用 CNN 分类器来识别这些位置的对象类别。</mark> 这种两阶段方法利用了低级线索的边界框分割的准确性，以及最先进的 CNN 的强大分类能力。 我们在检测提交中采用了类似的流程，但在两个阶段都探索了增强功能，例如用于更高对象边界框召回的多框 [5] 预测，以及用于更好地对边界框建议进行分类的集成方法。</p> 
<h3><a id="3__27"></a>3 动机和高层考虑</h3> 
<p><img src="https://images2.imgbox.com/51/14/YPkVcRxp_o.png" alt="在这里插入图片描述"><br> <strong>提高深度神经网络性能的最直接方法是增加其规模。 这包括增加网络的深度（层数）和宽度（每层的单元数量）。 这是训练更高质量模型的一种简单且安全的方法</strong>，特别是考虑到大量标记训练数据的可用性。 然而，这个简单的解决方案<mark>有两个主要缺点。</mark></p> 
<p><strong>较大的尺寸通常意味着较大的参数数量，这使得扩大的网络更容易过度拟合，特别是在训练集中标记示例的数量有限的情况下。这可能成为一个主要瓶颈，因为创建高质量训练集可能很棘手且成本高昂</strong>，特别是如果需要专业的人类评估者来区分像 ImageNet 中的细粒度视觉类别（即使在 1000 类 ILSVRC 子集中） 如图1所示<img src="https://images2.imgbox.com/af/9a/QzbHrk18_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/27/b1/3kgdZVEe_o.png" alt="在这里插入图片描述"><br> <strong>统一增加网络规模的另一个缺点是计算资源的使用急剧增加</strong>。 例如，在深度视觉网络中，如果链接两个卷积层，则其滤波器数量的任何均匀增加都会导致计算量呈二次方增加。 <strong>如果增加的容量使用效率低下（例如，如果大多数权重最终接近于零），则会浪费大量计算</strong>。 由于在实践中计算预算始终是有限的，因此即使主要目标是提高结果质量，计算资源的有效分配也优于不加选择地增加大小。</p> 
<p><strong>解决这两个问题的根本方法是最终从完全连接的架构转向稀疏连接的架构，甚至在卷积内部也是如此</strong>。 除了模仿生物系统之外，由于 Arora 等人的开创性工作，这还将具有更坚实的理论基础的优势。 [2]。 他们的主要结果表明，<mark>如果数据集的概率分布可以用一个大型的、非常稀疏的深度神经网络来表示，那么通过分析最后一层激活的相关统计并对具有高度相关输出的神经元进行聚类，可以逐层构建最优网络拓扑。 </mark>尽管严格的数学证明需要非常强大的条件，但这一说法与众所周知的赫布原理（神经元一起放电、连接在一起）产生共鸣，这一事实表明，即使在不太严格的条件下，基本思想也适用于实践。</p> 
<p>不利的一面是，当今的计算基础设施在非均匀稀疏数据结构的数值计算方面效率非常低。 即使算术运算的数量减少 100 倍，查找和缓存未命中的开销仍然占主导地位，以至于切换到稀疏矩阵不会有回报。 通过使用稳定改进、高度调整的数值库，可以利用底层 CPU 或 GPU 硬件的微小细节，实现极快的密集矩阵乘法，从而进一步拉大差距 [16, 9]。 此外，非均匀稀疏模型需要更复杂的工程和计算基础设施。 当前大多数面向视觉的机器学习系统仅通过使用卷积来利用空间域中的稀疏性。 然而，卷积被实现为与较早层中的补丁的密集连接的集合。 ConvNets传统上在特征维度上使用随机和稀疏的连接表，从[11]开始为了打破对称性和提高学习能力，趋势又回到了[9]的全连接，以便更好地优化并行计算。 <strong>结构的均匀性、大量的滤波器和更大的批量大小允许利用高效的密集计算。</strong></p> 
<p>这就提出了一个问题：是否有希望进行下一个中间步骤：一种利用额外稀疏性的架构，即使是在滤波器级别，正如理论所建议的，但通过利用密集矩阵上的计算来利用我们当前的硬件。 关于稀疏矩阵计算的大量文献（例如[3]）表明，<mark>将稀疏矩阵聚类成相对密集的子矩阵往往可以为稀疏矩阵乘法提供最先进的实用性能。 认为在不久的将来类似的方法将被用于自动构建非均匀深度学习架构似乎并不牵强。</mark><br> <img src="https://images2.imgbox.com/4c/03/HYKSqW8Z_o.png" alt="在这里插入图片描述"><br> Inception 架构最初是作为第一作者的一个案例研究，用于评估复杂网络拓扑构建算法的假设输出，该算法试图逼近 [2] 所暗示的视觉网络，并通过密集、易于获得的结构覆盖假设结果。 尽管这是一项高度推测性的工作，但仅在对拓扑的精确选择进行两次迭代之后，我们就已经可以看到相对于基于[12]的参考架构的适度收益。 经过进一步调整学习率、超参数和改进训练后方法论中，我们确定所得到的 Inception 架构在定位和对象检测的背景下特别有用，作为 [6] 和 [5] 的基础网络。 有趣的是，虽然大多数最初的架构选择都经过了彻底的质疑和测试，但结果证明它们至少是局部最优的。</p> 
<p>但必须谨慎：尽管所提出的架构在计算机视觉领域取得了成功，但其质量是否可以归因于其构建的指导原则仍然值得怀疑。 确保需要更彻底的分析和验证：例如，基于下述原理的自动化工具是否会为视觉网络找到类似但更好的拓扑。 最令人信服的证据是，自动化系统是否可以创建网络拓扑，从而使用相同的算法但具有非常不同的全局架构在其他领域获得类似的收益。 至少，Inception 架构的初步成功为未来在这个方向上的激动人心的工作提供了坚定的动力</p> 
<h4><a id="_44"></a>稀疏矩阵</h4> 
<p><img src="https://images2.imgbox.com/58/b7/wxkS7Odm_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/c0/08/G1fSRvOF_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/61/92/jKiSoPce_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="4__48"></a>4 结构细节</h3> 
<p><img src="https://images2.imgbox.com/c9/d4/DXM8A8GK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/46/37/hXsA2EJs_o.png" alt="在这里插入图片描述"><br> <strong>Inception 架构的主要思想是基于找出如何用容易获得的密集组件来近似和覆盖卷积视觉网络中的最佳局部稀疏结构</strong>。 请注意，<mark>假设平移不变性意味着我们的网络将由卷积构建块构建。 我们所需要的只是找到最佳的局部构造并在空间上重复它。</mark> 阿罗拉等人 [2]提出了一种逐层构造，其中应该分析最后一层的相关统计数据并将它们聚类成具有高相关性的单元组。 这些簇形成下一层的单元，并连接到上一层的单元。 我们假设前一层的每个单元对应于输入图像的某个区域，并且这些单元被分组到滤波器组中。 在较低层（靠近输入的层）中，相关单元将集中在局部区域。 这意味着，我们最终会得到很多集中在单个区域中的簇，并且它们可以被下一层中的 1×1 卷积层覆盖，如 [12] 中所建议的。 然而，我们也可以预期，将会有越来越少的、在空间上更分散的簇可以被较大块上的卷积所覆盖，并且在越来越大的区域上，patches的数量将会减少。 为了避免补丁对齐问题，当前的 Inception 架构仅限于滤波器大小 1×1、3×3 和 5×5，但这一决定更多是基于便利性而非必要性。 <strong>这也意味着建议的架构是所有这些层的组合，其输出滤波器组连接成单个输出向量，形成下一阶段的输入</strong>。 此外，<mark>由于池化操作对于当前最先进的卷积网络的成功至关重要，因此建议在每个此类阶段添加替代并行池化路径也应该具有额外的有益效果</mark>（见图 2(a)）<br> <img src="https://images2.imgbox.com/4d/a9/dSGf9cu5_o.png" alt="在这里插入图片描述"><br> 由于这些“Inception 模块”彼此堆叠，它们的输出相关统计数据必然会有所不同：<strong>随着更高抽象的特征被更高层捕获，它们的空间集中度预计会降低，这表明随着我们移动到更高层，3×3 和 5×5 卷积的比率应该增加</strong></p> 
<p>上述模块的一个大问题（至少在这种简单的形式中）是，即使是少量的 5×5 卷积，在具有大量滤波器的卷积层之上也可能非常昂贵。 一旦将池化单元添加到混合中，这个问题就会变得更加明显：它们的输出过滤器的数量等于前一阶段过滤器的数量。 <strong>池化层的输出与卷积层的输出的合并将导致阶段之间的输出数量不可避免地增加。</strong> 即使这种架构可能覆盖最佳稀疏结构，但它的效率非常低，导致几个阶段内的计算崩溃。<br> <img src="https://images2.imgbox.com/84/6e/LYOWNArd_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/67/67/1uGPCz2s_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="1x1_58"></a>引入1x1卷积核可以减少通道数</h4> 
<p><img src="https://images2.imgbox.com/32/2d/CVxZKWcB_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/60/c9/jPB3Ywf2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/52/f9/5q4XoqeL_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/14/ef/vAbxCQ4s_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/82/34/WKnjMym4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9a/af/hglLvJNM_o.png" alt="在这里插入图片描述"><br> 这引出了所提出的架构的第二个想法：<strong>在计算需求会增加太多的地方明智地应用降维和投影</strong>。 这是基于嵌入的成功：即使是低维嵌入也可能包含有关相对较大的图像块的大量信息。 然而，嵌入以密集、压缩的形式表示信息，并且压缩信息更难建模。 我们希望在大多数地方保持我们的表示稀疏（根据[2]的条件要求），并且仅在信号必须聚合时才压缩信号。 也就是说，1×1 卷积用于在昂贵的 3×3 和 5×5 卷积之前计算降维。 除了用作降维之外，它们还包括使用校正线性激活，这使得它们具有双重用途。 最终结果如图2(b)所示。<br> <img src="https://images2.imgbox.com/ec/d0/9s0mPar7_o.png" alt="在这里插入图片描述"><br> 一般来说，Inception 网络是由上述类型的模块相互堆叠组成的网络，<strong>偶尔有步幅为 2 的最大池层，以使网格的分辨率减半</strong>。 出于技术原因（训练期间的内存效率），仅在较高层开始使用 Inception 模块，同时保持较低层采用传统的卷积方式似乎是有益的。 这并不是绝对必要的，只是反映了我们当前实施中的一些基础设施效率低下。</p> 
<p><strong>这种架构的主要优点之一是它允许显着增加每个阶段的单元数量，而不会导致计算复杂性不受控制地激增。</strong> 降维的普遍使用允许将最后一级的大量输入滤波器屏蔽到下一层，<strong>首先降低它们的维度，然后再用大块大小对它们进行卷积</strong>。 <mark>这种设计的另一个实际有用的方面是，它符合直觉，即视觉信息应该在不同尺度上进行处理，然后进行聚合，以便下一阶段可以同时从不同尺度中提取特征。</mark></p> 
<p>计算资源的改进使用允许增加每个阶段的宽度以及阶段的数量，而不会陷入计算困难。 利用inception架构的另一种方法是创建其性能稍差但计算成本更低的版本。 我们发现，所有包含的旋钮和控制杆都可以实现计算资源的受控平衡，从而使网络比具有非 Inception 架构的类似性能网络快 2 − 3 倍，但这需要仔细的手动设计 。</p> 
<h3><a id="5_GoogleNet_73"></a>5 GoogleNet</h3> 
<p><img src="https://images2.imgbox.com/77/52/EZBBCvnz_o.png" alt="在这里插入图片描述"><br> 我们选择 GoogLeNet 作为 ILSVRC14 比赛中的队名。 这个名字是对 Yann LeCuns 开创性的 LeNet 5 网络 [10] 的致敬。 我们还使用 GoogLeNet 来指代我们在竞赛提交中使用的 Inception 架构的特定化身。 我们还使用了更深、更宽的 Inception 网络，其质量稍差，但将其添加到集成中似乎略微改善了结果。 我们省略了该网络的细节，因为我们的实验表明，确切的架构参数的影响相对较小。 出于演示目的，表 1 中描述了最成功的特定实例（名为 GoogLeNet）。 我们的集成中 7 个模型中有 6 个使用了完全相同的拓扑（使用不同的采样方法进行训练）。<br> <img src="https://images2.imgbox.com/45/25/qxGPIm6a_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ad/ea/uqObP6gK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/24/26/KH4pYgsB_o.png" alt="在这里插入图片描述"><br> <strong>所有卷积，包括 Inception 模块内的卷积，都使用修正线性激活</strong>。 <mark>我们网络中感受野的大小为 224×224，采用均值减法的 RGB 颜色通道。 “#3×3 reduce”和“#5×5 reduce”代表3×3和5×5卷积之前使用的减少层中1×1过滤器的数量。 在 pool proj 列中内置最大池化之后，可以看到投影层中 1×1 滤波器的数量。 所有这些reduction/projection层也使用修正线性激活</mark>。</p> 
<p>该网络的设计考虑到了计算效率和实用性，因此推理可以在单个设备上运行，甚至包括计算资源有限的设备，尤其是内存占用较低的设备。 <strong>当仅计算带参数的层时，网络深度为 22 层（如果我们还计算池化，则网络深度为 27 层）。 用于构建网络的层（独立构建块）总数约为 100</strong>。然而，这个数字取决于所使用的机器学习基础设施系统。 分类器之前使用平均池是基于[12]，尽管我们的实现不同之处在于我们使用了额外的线性层。 这使得我们可以轻松地针对其他标签集调整和微调我们的网络，但这主要是为了方便，我们预计它不会产生重大影响。 研究发现，从全连接层到平均池化的转变将 top-1 准确率提高了约 0.6%，但是<strong>即使在删除全连接层之后，dropout 的使用仍然至关重要。</strong></p> 
<p>考虑到网络的深度相对较大，以有效的方式将梯度传播回所有层的能力是一个问题。 一个有趣的见解是，相对较浅的网络在这项任务上的强劲表现表明，<strong>网络中间层产生的特征应该非常具有辨别力</strong>。 <strong>通过添加连接到这些中间层的辅助分类器，我们希望鼓励分类器较低阶段的区分，增加传播回来的梯度信号，并提供额外的正则化</strong>。 这些分类器采用较小的卷积网络的形式，置于 Inception (4a) 和 (4d) 模块的输出之上。 <mark>在训练期间，它们的损失以折扣权重添加到网络的总损失中（辅助分类器的损失按 0.3 加权）。 在推理时，这些辅助网络将被丢弃。</mark><br> <img src="https://images2.imgbox.com/ff/bc/PDLmMzkR_o.png" alt="在这里插入图片描述"><br> 侧面额外网络的具体结构，包括辅助分类器，如下：</p> 
<ul><li>平均池化层的过滤器大小为 5×5，步长为 3，导致 (4a) 阶段的输出为 4×4×512，(4d) 阶段的输出为 4×4×528。</li><li>具有 128 个滤波器的 1×1 卷积，用于降维和修正线性激活。</li><li>具有 1024 个单元和修正线性激活的全连接层。</li><li>dropout输出比例为 70% 的dropout层。</li><li>以 softmax 损失作为分类器的线性层（预测与主分类器相同的 1000 个类，但在推理时删除）</li></ul> 
<p>图 3 描绘了所得网络的示意图。<br> <img src="https://images2.imgbox.com/e0/69/XZTcFaax_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/b8/97/VjY7YMjY_o.png" alt="在这里插入图片描述"><br> Figure 3: GoogLeNet network with all the bells and whistles</p> 
<p><img src="https://images2.imgbox.com/aa/ce/uxZAUc01_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/fe/f9/C5o1Rqfs_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="6__99"></a>6 训练方法</h3> 
<p><img src="https://images2.imgbox.com/7d/9c/qorRp9wM_o.png" alt="在这里插入图片描述"><br> 我们的网络使用 DistBelief [4] 分布式机器学习系统进行训练，使用适量的模型和数据并行性。 尽管我们仅使用基于 CPU 的实现，但粗略估计表明，GoogLeNet 网络可以在一周内使用少量高端 GPU 进行训练以达到收敛，主要限制是内存使用。 <strong>我们的训练使用动量为 0.9 的异步随机梯度下降[17]，固定学习率计划（每 8 个周期将学习率降低 4%）</strong>。 Polyak 平均 [13] 用于创建推理时使用的最终模型。<br> <img src="https://images2.imgbox.com/fc/c1/sVCD02h1_o.png" alt="在这里插入图片描述"></p> 
<p>在比赛前的几个月里，我们的图像采样方法发生了很大的变化，并且已经融合的模型接受了其他选项的训练，有时还结合了改变的超参数，如 dropout 和学习率，因此很难给出明确的指导训练这些网络的最有效的单一方法。 更复杂的是，受[8]的启发，一些模型主要针对较小的相关crops进行训练，其他模型则针对较大的crops进行训练。 尽管如此，<strong>赛后验证效果非常好的一个方案是对图像的各种大小的块进行采样，其大小均匀分布在图像区域的 8% 到 100% 之间，其长宽比在 3/4 到 3/4 之间随机选择。</strong> 此外，我们发现 Andrew Howard [8] 的<strong>光度扭曲在某种程度上有助于对抗过度拟合</strong>。 此外，我们开始使用随机插值方法（双线性、面积、最近邻和三次，等概率）来调整大小，相对较晚，并与其他超参数变化相结合，因此我们无法确定最终结果是否受到其使用的积极影响。<br> <img src="https://images2.imgbox.com/d6/fa/xg1jDshK_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="7_ILSVRC_2014__106"></a>7 ILSVRC 2014 分类挑战赛设置和结果</h3> 
<p><img src="https://images2.imgbox.com/fe/c4/j01qrEVk_o.png" alt="在这里插入图片描述"><br> ILSVRC 2014 分类挑战涉及将图像分类为 Imagenet 层次结构中 1000 个叶节点类别之一的任务。 大约有 120 万张图像用于训练，50,000 张图像用于验证，100,000 张图像用于测试。 <mark>每张图像都与一个真实类别相关联，并且根据最高得分的分类器预测来衡量性能。 通常会报告两个数字：top-1 准确率（将真实情况与第一个预测类别进行比较）和 top-5 错误率（将真实情况与前 5 个预测类别进行比较：如果ground truth位于前 5 名之列，无论其排名如何，图像被视为正确分类）。该挑战使用前 5 个错误率进行排名。</mark></p> 
<p>我们参加了挑战，没有使用外部数据进行训练。 除了本文提到的训练技术之外，我们在测试过程中还采用了一组技术来获得更高的性能，我们将在下面详细说明。</p> 
<ul><li>我们<strong>独立训练了同一 GoogLeNet 模型的 7 个版本（包括一个更宽的版本），并用它们进行了集成预测。 这些模型使用相同的初始化（即使具有相同的初始权重，主要是由于oversight）和学习率策略进行训练，它们仅在采样方法和看到输入图像的随机顺序上有所不同。</strong><img src="https://images2.imgbox.com/90/0c/iuRcmVko_o.png" alt="在这里插入图片描述"></li><li><mark>在测试过程中</mark>，我们采用了比 Krizhevsky 等人更激进的裁剪方法 [9]。 具体来说，<strong>我们将图像大小调整为 4 个比例，其中较短的尺寸（高度或宽度）分别为 256、288、320 和 352，取这些调整大小图像的左、中、右正方形（在竖向图像的情况下，我们取顶部、中心和底部的方块）。 然后，对于每个正方形，我们采用 4 个角和中心 224×224 裁剪以及调整大小为 224×224 的正方形及其镜像版本。 这导致每张图像有 4×3×6×2 = 144 种裁剪</strong>。 Andrew Howard [8] 在前一年的文章中使用了类似的方法，我们根据经验验证了该方法的性能比提议的方案稍差。 我们注意到，<mark>在实际应用中，这种激进的cropping可能没有必要，因为在存在合理数量的crops后，更多crops的好处就变得微乎其微</mark>（正如我们稍后将展示的那样）。<img src="https://images2.imgbox.com/4e/26/9yNVLtkG_o.png" alt="在这里插入图片描述"></li><li><strong>Softmax 概率对多种crops和所有单独的分类器进行平均以获得最终预测</strong>。 在我们的实验中，我们分析了验证数据的替代方法，例如<mark>crops上的最大池化和分类器上的平均，但它们导致性能比简单平均差</mark>。<br> <img src="https://images2.imgbox.com/1a/0c/DQwcAlsE_o.png" alt="在这里插入图片描述"><br> 在本文的其余部分中，我们分析了影响最终提交的整体性能的多个因素。</li></ul> 
<p>我们最终提交的挑战赛在验证和测试数据上均获得了 6.67% 的 top-5 错误率，在其他参赛者中排名第一。 与 2012 年的 SuperVision 方法相比，相对减少了 56.5%，与上一年的最佳方法 (Clarifai) 相比，相对减少了约 40%，这两种方法都使用外部数据来训练分类器。 下表显示了一些表现最佳的方法的统计数据。</p> 
<p>我们还通过改变下表中预测图像时使用的模型数量和裁剪数量来分析和报告多个测试选择的性能。 当我们使用一种模型时，我们选择验证数据上 top-1 错误率最低的模型。 所有数字都在验证数据集上报告，以免与测试数据统计数据过度拟合。<br> <img src="https://images2.imgbox.com/8a/5d/PdhSuMhZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/67/38/wzZRKobX_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="8_ILSVRC_2014_123"></a>8 ILSVRC 2014检测挑战赛设置和结果</h3> 
<p><img src="https://images2.imgbox.com/35/2f/jrfPvS2r_o.png" alt="在这里插入图片描述"><br> <mark>ILSVRC 检测任务是在 200 个可能的类别中的图像中的对象周围生成边界框。 如果检测到的对象与真实类别匹配并且其边界框重叠至少 50%（使用 Jaccard 索引），则视为正确。</mark> 无关的检测被视为误报<code>false positive</code>并受到处罚。 与分类任务相反，每个图像可能包含许多对象或不包含对象，并且它们的尺度可能从大到小不等。 使用平均精度 (mAP) 报告结果。<br> <img src="https://images2.imgbox.com/cb/6d/HS8VvJ35_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a0/d1/csXHwoCl_o.png" alt="在这里插入图片描述"><br> <strong>GoogLeNet 所采用的检测方法与 [6] 中的 R-CNN 类似，但使用 Inception 模型作为区域分类器进行了增强。 此外，通过将选择性搜索 [20] 方法与多框 [5] 预测相结合，改进了区域提议步骤，以实现更高的对象边界框召回率。 为了减少误报<code>false positive</code>数量，超像素大小增加了 2 倍</strong>。 这使得来自选择性搜索算法的提案减半。 我们添加了来自 multi-box [5] 结果的 200 个区域提案，总共占 [6] 使用的提案的约 60%，同时将覆盖范围从 92% 增加到 93%。 通过增加覆盖率来减少提议数量的总体效果是单个模型案例的平均精度<code>mAP</code>提高了 1%。 最后，<strong>我们在对每个区域进行分类时使用 6 个 ConvNet 的集合这将结果准确率从 40% 提高到 43.9%。 请注意，与 R-CNN 相反，由于时间不够，我们没有使用边界框回归。</strong></p> 
<p>我们首先报告最重要的检测结果，并显示自第一版检测任务以来的进展情况。 与 2013 年的结果相比，准确率几乎翻了一番。 <strong>表现最好的团队都使用卷积网络</strong>。 我们在表 4 中报告了官方得分以及每个团队的常见策略：使用外部数据、集成模型或上下文模型。 外部数据通常是 ILSVRC12 分类数据，用于预训练模型，然后根据检测数据进行细化。 一些团队还提到了本地化数据的使用。 <mark>由于定位任务边界框的很大一部分不包含在检测数据集中，因此可以使用该数据预训练通用边界框回归器，就像使用分类进行预训练一样</mark>。 GoogLeNet条目没有使用本地化数据进行预训练。</p> 
<p><img src="https://images2.imgbox.com/df/ab/jjQflb28_o.png" alt="在这里插入图片描述"><br> 在表 5 中，我们仅比较使用单个模型的结果。 表现最好的模型来自 Deep Insight，令人惊讶的是，在 3 个模型的集成中仅提高了 0.3 个点，而 <strong>GoogLeNet 在集成中获得了明显更强的结果</strong>。<br> <img src="https://images2.imgbox.com/fe/bd/s4CL28Lp_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="_mAPhttpstowardsdatasciencecombreakingdownmeanaverageprecisionmapae462f623a52_135"></a>目标检测的平均精度和 <a href="https://towardsdatascience.com/breaking-down-mean-average-precision-map-ae462f623a52" rel="nofollow">mAP</a></h4> 
<p>为了计算物体检测的AP，我们首先需要了解IoU。 IoU 由预测边界框和真实边界框的交集面积与并集面积之比给出。<br> <img src="https://images2.imgbox.com/c0/c0/4fB4gDg4_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a2/7a/hUuFW6Ky_o.png" alt="在这里插入图片描述"><br> IoU 将用于确定预测的边界框 (BB) 是 TP、FP 还是 FN。不评估 TN，因为假设每个图像中都有一个对象。让我们考虑下图：<br> <img src="https://images2.imgbox.com/5e/fc/4CVHLMOk_o.png" alt="在这里插入图片描述"><br> 该图像包含一个人和马及其相应的地面真实边界框。让我们暂时忽略那匹马。我们在此图像上运行对象检测模型，并收到该人的预测边界框。传统上，如果 IoU &gt; 0.5，我们将预测定义为 TP。下面描述了可能的情况<br> <img src="https://images2.imgbox.com/75/8d/5230CIli_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/4c/4d/ZUNhupDU_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/25/85/L25kfivn_o.png" alt="在这里插入图片描述"><br> 当我们的对象检测模型错过目标时，它将被视为漏报。两种可能的情况如下:</p> 
<ul><li>当根本没有检测到的时候。</li><li>当预测的 BB IoU &gt; 0.5 但分类错误时，预测的 BB 将为 FN。</li></ul> 
<p><img src="https://images2.imgbox.com/f9/6b/pIAiKNKO_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="9__150"></a>9 总结</h3> 
<p><img src="https://images2.imgbox.com/9d/8f/zlyHJySK_o.png" alt="在这里插入图片描述"><br> 我们的结果似乎提供了坚实的证据，<strong>表明通过现成的密集构建块来近似预期的最佳稀疏结构是改进计算机视觉神经网络的可行方法。 与较浅且较不宽的网络相比，该方法的主要优点是在计算要求适度增加的情况下获得显着的质量增益。</strong> 另请注意，尽管<mark>我们既不利用上下文也不执行边界框回归，我们的检测工作仍然具有竞争力，这一事实进一步证明了 Inception 架构的优势。</mark> 尽管预计可以通过相似深度和宽度的更昂贵的网络来实现相似质量的结果，但<strong>我们的方法提供了确凿的证据，表明转向稀疏架构总体上是可行且有用的想法</strong>。 这表明未来有望在 [2] 的基础上以自动化方式创建更稀疏和更精细的结构。<br> <img src="https://images2.imgbox.com/c3/88/RDbJak7q_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/07/a7/R9PFoSMi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/18/ba/Fo8EABay_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/60/43/4aXFzv0s_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a5/42/JpaMqsjX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ec/71/BDWoG7wD_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/00/a8/usLb2gZm_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_161"></a>论文研究背景、成果及意义</h2> 
<p><img src="https://images2.imgbox.com/97/4a/iM8tWPoj_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/76/aa/5oIFpOvv_o.png" alt="在这里插入图片描述"><br> 1*1卷积可以大大减少网络参数，压缩特征图厚度<br> <img src="https://images2.imgbox.com/38/9f/pWGvjLI0_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/a1/54/K23qBYVp_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/67/16/sRewls5Z_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/71/6e/YuSo0l3p_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ae/1b/1KAiC6Zv_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_170"></a>论文图表</h2> 
<p><img src="https://images2.imgbox.com/16/3a/kP61s69Q_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ea/41/y4Q4L26W_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/66/ab/REfYipGE_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d0/4a/Xinx7nPc_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/49/46/qa9MaIGZ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/43/15/iRObL6aV_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="_177"></a>论文代码复现准备工作</h2> 
<p><img src="https://images2.imgbox.com/b9/b8/FBezfb9p_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="GoogleNetv1_179"></a>GoogleNetv1推理代码及运行结果</h2> 
<p><img src="https://images2.imgbox.com/7c/db/HGItYqEn_o.png" alt="在这里插入图片描述"><br> googlenet_inference.py</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'NLS_LANG'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'SIMPLIFIED CHINESE_CHINA.UTF8'</span>
<span class="token keyword">import</span> time
<span class="token keyword">import</span> json
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>common_tools <span class="token keyword">import</span> get_googlenet
BASE_DIR <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">img_transform</span><span class="token punctuation">(</span>img_rgb<span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    将数据转换为模型读取的形式
    :param img_rgb: PIL Image
    :param transform: torchvision.transform
    :return: tensor
    """</span>

    <span class="token keyword">if</span> transform <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string">"找不到transform！必须有transform对img进行处理"</span><span class="token punctuation">)</span>

    img_t <span class="token operator">=</span> transform<span class="token punctuation">(</span>img_rgb<span class="token punctuation">)</span>
    <span class="token keyword">return</span> img_t


<span class="token keyword">def</span> <span class="token function">process_img</span><span class="token punctuation">(</span>path_img<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># hard code</span>
    norm_mean <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
    norm_std <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>
    inference_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>norm_mean<span class="token punctuation">,</span> norm_std<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># path --&gt; img</span>
    img_rgb <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path_img<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>
    <span class="token comment"># Image.open()得到的是PIL的图片格式</span>

    <span class="token comment"># img --&gt; tensor</span>
    img_tensor <span class="token operator">=</span> img_transform<span class="token punctuation">(</span>img_rgb<span class="token punctuation">,</span> inference_transform<span class="token punctuation">)</span>
    img_tensor<span class="token punctuation">.</span>unsqueeze_<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        <span class="token comment"># chw --&gt; bchw</span>
    img_tensor <span class="token operator">=</span> img_tensor<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

    <span class="token keyword">return</span> img_tensor<span class="token punctuation">,</span> img_rgb


<span class="token keyword">def</span> <span class="token function">load_class_names</span><span class="token punctuation">(</span>p_clsnames<span class="token punctuation">,</span> p_clsnames_cn<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    加载标签名
    :param p_clsnames:
    :param p_clsnames_cn:
    :return:
    """</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>p_clsnames<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
        class_names <span class="token operator">=</span> json<span class="token punctuation">.</span>load<span class="token punctuation">(</span>f<span class="token punctuation">)</span>
    <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>p_clsnames_cn<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'UTF-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>  <span class="token comment"># 设置文件对象</span>
        class_names_cn <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> class_names<span class="token punctuation">,</span> class_names_cn


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    <span class="token comment"># config</span>
    path_state_dict <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"googlenet-1378be20.pth"</span><span class="token punctuation">)</span>
    <span class="token comment"># 图片路径</span>
    path_img <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span>  <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">"alexNet/data"</span><span class="token punctuation">,</span> <span class="token string">"Golden Retriever from baidu.jpg"</span><span class="token punctuation">)</span>
    <span class="token comment"># path_img = os.path.join(BASE_DIR, "..", "data", "tiger cat.jpg")</span>
    path_classnames <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"imagenet1000.json"</span><span class="token punctuation">)</span>
    path_classnames_cn <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"imagenet_classnames.txt"</span><span class="token punctuation">)</span>

    <span class="token comment"># load class names</span>
    cls_n<span class="token punctuation">,</span> cls_n_cn <span class="token operator">=</span> load_class_names<span class="token punctuation">(</span>path_classnames<span class="token punctuation">,</span> path_classnames_cn<span class="token punctuation">)</span>

    <span class="token comment"># 1/5 load img</span>
    img_tensor<span class="token punctuation">,</span> img_rgb <span class="token operator">=</span> process_img<span class="token punctuation">(</span>path_img<span class="token punctuation">)</span>

    <span class="token comment"># 2/5 load model</span>
    <span class="token comment"># 与论文不同处：5*5用3*3代替，所有卷积之后加入BN，</span>
    googlenet_model <span class="token operator">=</span> get_googlenet<span class="token punctuation">(</span>path_state_dict<span class="token punctuation">,</span> device<span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>

    <span class="token comment"># 3/5 inference  tensor --&gt; vector</span>
    <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        time_tic <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>
        outputs <span class="token operator">=</span> googlenet_model<span class="token punctuation">(</span>img_tensor<span class="token punctuation">)</span>
        time_toc <span class="token operator">=</span> time<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment"># 4/5 index to class names</span>
    _<span class="token punctuation">,</span> pred_int <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    _<span class="token punctuation">,</span> top5_idx <span class="token operator">=</span> torch<span class="token punctuation">.</span>topk<span class="token punctuation">(</span>outputs<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> dim<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

    pred_idx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>pred_int<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    pred_str<span class="token punctuation">,</span> pred_cn <span class="token operator">=</span> cls_n<span class="token punctuation">[</span>pred_idx<span class="token punctuation">]</span><span class="token punctuation">,</span> cls_n_cn<span class="token punctuation">[</span>pred_idx<span class="token punctuation">]</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"img: {} is: {}\n{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>path_img<span class="token punctuation">)</span><span class="token punctuation">,</span> pred_str<span class="token punctuation">,</span> pred_cn<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"time consuming:{:.2f}s"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>time_toc <span class="token operator">-</span> time_tic<span class="token punctuation">)</span><span class="token punctuation">)</span>

    <span class="token comment"># 5/5 visualization</span>
    plt<span class="token punctuation">.</span>imshow<span class="token punctuation">(</span>img_rgb<span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token string">"predict:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>pred_str<span class="token punctuation">)</span><span class="token punctuation">)</span>
    top5_num <span class="token operator">=</span> top5_idx<span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span>
    text_str <span class="token operator">=</span> <span class="token punctuation">[</span>cls_n<span class="token punctuation">[</span>t<span class="token punctuation">]</span> <span class="token keyword">for</span> t <span class="token keyword">in</span> top5_num<span class="token punctuation">]</span>
    <span class="token keyword">for</span> idx <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>top5_num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        plt<span class="token punctuation">.</span>text<span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token operator">+</span>idx<span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token string">"top {}:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>idx<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> text_str<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bbox<span class="token operator">=</span><span class="token builtin">dict</span><span class="token punctuation">(</span>fc<span class="token operator">=</span><span class="token string">'yellow'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>common_tools.py</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models


<span class="token keyword">def</span> <span class="token function">get_googlenet</span><span class="token punctuation">(</span>path_state_dict<span class="token punctuation">,</span> device<span class="token punctuation">,</span> vis_model<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    创建模型，加载参数
    :param path_state_dict:
    :return:
    """</span>
    model <span class="token operator">=</span> models<span class="token punctuation">.</span>googlenet<span class="token punctuation">(</span>init_weights<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> path_state_dict<span class="token punctuation">:</span>
        pretrained_state_dict <span class="token operator">=</span> torch<span class="token punctuation">.</span>load<span class="token punctuation">(</span>path_state_dict<span class="token punctuation">)</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>pretrained_state_dict<span class="token punctuation">)</span>
    model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">if</span> vis_model<span class="token punctuation">:</span>
        <span class="token keyword">from</span> torchsummary <span class="token keyword">import</span> summary
        summary<span class="token punctuation">(</span>model<span class="token punctuation">,</span> input_size<span class="token operator">=</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span> device<span class="token operator">=</span><span class="token string">"cpu"</span><span class="token punctuation">)</span>

    model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token keyword">return</span> model
</code></pre> 
<p><img src="https://images2.imgbox.com/d0/54/9wFgtfV3_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/93/f3/TqEhrWN8_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/61/64/18LtXKKa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/86/2e/CWjshhoY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/9e/c8/2N9YQVxW_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/5b/f6/t6IMJbIE_o.png" alt="在这里插入图片描述"><br> googlenet.py</p> 
<pre><code class="prism language-python"><span class="token keyword">import</span> warnings
<span class="token keyword">from</span> collections <span class="token keyword">import</span> namedtuple
<span class="token keyword">from</span> functools <span class="token keyword">import</span> partial
<span class="token keyword">from</span> typing <span class="token keyword">import</span> Any<span class="token punctuation">,</span> Callable<span class="token punctuation">,</span> List<span class="token punctuation">,</span> Optional<span class="token punctuation">,</span> Tuple

<span class="token keyword">import</span> torch
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>functional <span class="token keyword">as</span> F
<span class="token keyword">from</span> torch <span class="token keyword">import</span> Tensor

<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>transforms<span class="token punctuation">.</span>_presets <span class="token keyword">import</span> ImageClassification
<span class="token keyword">from</span> <span class="token punctuation">.</span><span class="token punctuation">.</span>utils <span class="token keyword">import</span> _log_api_usage_once
<span class="token keyword">from</span> <span class="token punctuation">.</span>_api <span class="token keyword">import</span> register_model<span class="token punctuation">,</span> Weights<span class="token punctuation">,</span> WeightsEnum
<span class="token keyword">from</span> <span class="token punctuation">.</span>_meta <span class="token keyword">import</span> _IMAGENET_CATEGORIES
<span class="token keyword">from</span> <span class="token punctuation">.</span>_utils <span class="token keyword">import</span> _ovewrite_named_param<span class="token punctuation">,</span> handle_legacy_interface


__all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"GoogLeNet"</span><span class="token punctuation">,</span> <span class="token string">"GoogLeNetOutputs"</span><span class="token punctuation">,</span> <span class="token string">"_GoogLeNetOutputs"</span><span class="token punctuation">,</span> <span class="token string">"GoogLeNet_Weights"</span><span class="token punctuation">,</span> <span class="token string">"googlenet"</span><span class="token punctuation">]</span>


GoogLeNetOutputs <span class="token operator">=</span> namedtuple<span class="token punctuation">(</span><span class="token string">"GoogLeNetOutputs"</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string">"logits"</span><span class="token punctuation">,</span> <span class="token string">"aux_logits2"</span><span class="token punctuation">,</span> <span class="token string">"aux_logits1"</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
GoogLeNetOutputs<span class="token punctuation">.</span>__annotations__ <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span><span class="token string">"logits"</span><span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> <span class="token string">"aux_logits2"</span><span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"aux_logits1"</span><span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">}</span>

<span class="token comment"># Script annotations failed with _GoogleNetOutputs = namedtuple ...</span>
<span class="token comment"># _GoogLeNetOutputs set here for backwards compat</span>
_GoogLeNetOutputs <span class="token operator">=</span> GoogLeNetOutputs


<span class="token keyword">class</span> <span class="token class-name">GoogLeNet</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __constants__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"aux_logits"</span><span class="token punctuation">,</span> <span class="token string">"transform_input"</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>
        aux_logits<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span>
        transform_input<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">False</span><span class="token punctuation">,</span>
        init_weights<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span><span class="token builtin">bool</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        blocks<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>List<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        dropout<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span>
        dropout_aux<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        _log_api_usage_once<span class="token punctuation">(</span>self<span class="token punctuation">)</span>
        <span class="token keyword">if</span> blocks <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            blocks <span class="token operator">=</span> <span class="token punctuation">[</span>BasicConv2d<span class="token punctuation">,</span> Inception<span class="token punctuation">,</span> InceptionAux<span class="token punctuation">]</span>
        <span class="token keyword">if</span> init_weights <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span>
                <span class="token string">"The default weight initialization of GoogleNet will be changed in future releases of "</span>
                <span class="token string">"torchvision. If you wish to keep the old behavior (which leads to long initialization times"</span>
                <span class="token string">" due to scipy/scipy#11299), please set init_weights=True."</span><span class="token punctuation">,</span>
                FutureWarning<span class="token punctuation">,</span>
            <span class="token punctuation">)</span>
            init_weights <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>blocks<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> ValueError<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"blocks length should be 3 instead of </span><span class="token interpolation"><span class="token punctuation">{<!-- --></span><span class="token builtin">len</span><span class="token punctuation">(</span>blocks<span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>
        conv_block <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        inception_block <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
        inception_aux_block <span class="token operator">=</span> blocks<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>

        self<span class="token punctuation">.</span>aux_logits <span class="token operator">=</span> aux_logits
        self<span class="token punctuation">.</span>transform_input <span class="token operator">=</span> transform_input

        self<span class="token punctuation">.</span>conv1 <span class="token operator">=</span> conv_block<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv2 <span class="token operator">=</span> conv_block<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv3 <span class="token operator">=</span> conv_block<span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>inception3a <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inception3b <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>inception4a <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">480</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">,</span> <span class="token number">208</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inception4b <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">224</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inception4c <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inception4d <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> <span class="token number">112</span><span class="token punctuation">,</span> <span class="token number">144</span><span class="token punctuation">,</span> <span class="token number">288</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inception4e <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">528</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>maxpool4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span> ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>inception5a <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">832</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">160</span><span class="token punctuation">,</span> <span class="token number">320</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>inception5b <span class="token operator">=</span> inception_block<span class="token punctuation">(</span><span class="token number">832</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">192</span><span class="token punctuation">,</span> <span class="token number">384</span><span class="token punctuation">,</span> <span class="token number">48</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">)</span>

        <span class="token keyword">if</span> aux_logits<span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>aux1 <span class="token operator">=</span> inception_aux_block<span class="token punctuation">(</span><span class="token number">512</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout_aux<span class="token punctuation">)</span>
            self<span class="token punctuation">.</span>aux2 <span class="token operator">=</span> inception_aux_block<span class="token punctuation">(</span><span class="token number">528</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">,</span> dropout<span class="token operator">=</span>dropout_aux<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            self<span class="token punctuation">.</span>aux1 <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># type: ignore[assignment]</span>
            self<span class="token punctuation">.</span>aux2 <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># type: ignore[assignment]</span>

        self<span class="token punctuation">.</span>avgpool <span class="token operator">=</span> nn<span class="token punctuation">.</span>AdaptiveAvgPool2d<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>dropout<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

        <span class="token keyword">if</span> init_weights<span class="token punctuation">:</span>
            <span class="token keyword">for</span> m <span class="token keyword">in</span> self<span class="token punctuation">.</span>modules<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">if</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    torch<span class="token punctuation">.</span>nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>trunc_normal_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> mean<span class="token operator">=</span><span class="token number">0.0</span><span class="token punctuation">,</span> std<span class="token operator">=</span><span class="token number">0.01</span><span class="token punctuation">,</span> a<span class="token operator">=</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
                <span class="token keyword">elif</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>m<span class="token punctuation">,</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>weight<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    nn<span class="token punctuation">.</span>init<span class="token punctuation">.</span>constant_<span class="token punctuation">(</span>m<span class="token punctuation">.</span>bias<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_transform_input</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform_input<span class="token punctuation">:</span>
            x_ch0 <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.229</span> <span class="token operator">/</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.485</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.5</span>
            x_ch1 <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.224</span> <span class="token operator">/</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.456</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.5</span>
            x_ch2 <span class="token operator">=</span> torch<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span>x<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0.225</span> <span class="token operator">/</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.406</span> <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">0.5</span>
            x <span class="token operator">=</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span><span class="token punctuation">(</span>x_ch0<span class="token punctuation">,</span> x_ch1<span class="token punctuation">,</span> x_ch2<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> x

    <span class="token keyword">def</span> <span class="token function">_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tuple<span class="token punctuation">[</span>Tensor<span class="token punctuation">,</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">,</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># N x 3 x 224 x 224</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 64 x 112 x 112</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 64 x 56 x 56</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 64 x 56 x 56</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 192 x 56 x 56</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        <span class="token comment"># N x 192 x 28 x 28</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception3a<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 256 x 28 x 28</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception3b<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 480 x 28 x 28</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 480 x 14 x 14</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception4a<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 512 x 14 x 14</span>
        aux1<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>aux1 <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
                aux1 <span class="token operator">=</span> self<span class="token punctuation">.</span>aux1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception4b<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 512 x 14 x 14</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception4c<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 512 x 14 x 14</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception4d<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 528 x 14 x 14</span>
        aux2<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>aux2 <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> self<span class="token punctuation">.</span>training<span class="token punctuation">:</span>
                aux2 <span class="token operator">=</span> self<span class="token punctuation">.</span>aux2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception4e<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 832 x 14 x 14</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>maxpool4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 832 x 7 x 7</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception5a<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 832 x 7 x 7</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>inception5b<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 1024 x 7 x 7</span>

        x <span class="token operator">=</span> self<span class="token punctuation">.</span>avgpool<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 1024 x 1 x 1</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># N x 1024</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 1000 (num_classes)</span>
        <span class="token keyword">return</span> x<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1

    <span class="token decorator annotation punctuation">@torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>unused</span>
    <span class="token keyword">def</span> <span class="token function">eager_outputs</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> aux2<span class="token punctuation">:</span> Tensor<span class="token punctuation">,</span> aux1<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> GoogLeNetOutputs<span class="token punctuation">:</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> self<span class="token punctuation">.</span>aux_logits<span class="token punctuation">:</span>
            <span class="token keyword">return</span> _GoogLeNetOutputs<span class="token punctuation">(</span>x<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> x  <span class="token comment"># type: ignore[return-value]</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> GoogLeNetOutputs<span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>_transform_input<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x<span class="token punctuation">,</span> aux1<span class="token punctuation">,</span> aux2 <span class="token operator">=</span> self<span class="token punctuation">.</span>_forward<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        aux_defined <span class="token operator">=</span> self<span class="token punctuation">.</span>training <span class="token keyword">and</span> self<span class="token punctuation">.</span>aux_logits
        <span class="token keyword">if</span> torch<span class="token punctuation">.</span>jit<span class="token punctuation">.</span>is_scripting<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token keyword">not</span> aux_defined<span class="token punctuation">:</span>
                warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span><span class="token string">"Scripted GoogleNet always returns GoogleNetOutputs Tuple"</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> GoogLeNetOutputs<span class="token punctuation">(</span>x<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> self<span class="token punctuation">.</span>eager_outputs<span class="token punctuation">(</span>x<span class="token punctuation">,</span> aux2<span class="token punctuation">,</span> aux1<span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">Inception</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        in_channels<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        ch1x1<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        ch3x3red<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        ch3x3<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        ch5x5red<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        ch5x5<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        pool_proj<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        conv_block<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> conv_block <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            conv_block <span class="token operator">=</span> BasicConv2d
        <span class="token comment"># 1x1</span>
        self<span class="token punctuation">.</span>branch1 <span class="token operator">=</span> conv_block<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> ch1x1<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token comment"># 3x3</span>
        self<span class="token punctuation">.</span>branch2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            conv_block<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> ch3x3red<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conv_block<span class="token punctuation">(</span>ch3x3red<span class="token punctuation">,</span> ch3x3<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
		<span class="token comment"># 5x5</span>
        self<span class="token punctuation">.</span>branch3 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            conv_block<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> ch5x5red<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment"># Here, kernel_size=3 instead of kernel_size=5 is a known bug.</span>
            <span class="token comment"># Please see https://github.com/pytorch/vision/issues/906 for details.</span>
            conv_block<span class="token punctuation">(</span>ch5x5red<span class="token punctuation">,</span> ch5x5<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>
		<span class="token comment"># pooling</span>
        self<span class="token punctuation">.</span>branch4 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Sequential<span class="token punctuation">(</span>
            nn<span class="token punctuation">.</span>MaxPool2d<span class="token punctuation">(</span>kernel_size<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> padding<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> ceil_mode<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            conv_block<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> pool_proj<span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> List<span class="token punctuation">[</span>Tensor<span class="token punctuation">]</span><span class="token punctuation">:</span>
        branch1 <span class="token operator">=</span> self<span class="token punctuation">.</span>branch1<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        branch2 <span class="token operator">=</span> self<span class="token punctuation">.</span>branch2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        branch3 <span class="token operator">=</span> self<span class="token punctuation">.</span>branch3<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        branch4 <span class="token operator">=</span> self<span class="token punctuation">.</span>branch4<span class="token punctuation">(</span>x<span class="token punctuation">)</span>

        outputs <span class="token operator">=</span> <span class="token punctuation">[</span>branch1<span class="token punctuation">,</span> branch2<span class="token punctuation">,</span> branch3<span class="token punctuation">,</span> branch4<span class="token punctuation">]</span>
        <span class="token keyword">return</span> outputs

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        outputs <span class="token operator">=</span> self<span class="token punctuation">.</span>_forward<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> torch<span class="token punctuation">.</span>cat<span class="token punctuation">(</span>outputs<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">InceptionAux</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>
        self<span class="token punctuation">,</span>
        in_channels<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        num_classes<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span>
        conv_block<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>Callable<span class="token punctuation">[</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> nn<span class="token punctuation">.</span>Module<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span>
        dropout<span class="token punctuation">:</span> <span class="token builtin">float</span> <span class="token operator">=</span> <span class="token number">0.7</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> conv_block <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            conv_block <span class="token operator">=</span> BasicConv2d
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> conv_block<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> <span class="token number">128</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>

        self<span class="token punctuation">.</span>fc1 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">2048</span><span class="token punctuation">,</span> <span class="token number">1024</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span><span class="token number">1024</span><span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>dropout <span class="token operator">=</span> nn<span class="token punctuation">.</span>Dropout<span class="token punctuation">(</span>p<span class="token operator">=</span>dropout<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        <span class="token comment"># aux1: N x 512 x 14 x 14, aux2: N x 528 x 14 x 14</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>adaptive_avg_pool2d<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># aux1: N x 512 x 4 x 4, aux2: N x 528 x 4 x 4</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 128 x 4 x 4</span>
        x <span class="token operator">=</span> torch<span class="token punctuation">.</span>flatten<span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment"># N x 2048</span>
        x <span class="token operator">=</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>self<span class="token punctuation">.</span>fc1<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
        <span class="token comment"># N x 1024</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>dropout<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 1024</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>fc2<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token comment"># N x 1000 (num_classes)</span>

        <span class="token keyword">return</span> x


<span class="token keyword">class</span> <span class="token class-name">BasicConv2d</span><span class="token punctuation">(</span>nn<span class="token punctuation">.</span>Module<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> in_channels<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> out_channels<span class="token punctuation">:</span> <span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">:</span> Any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token builtin">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__init__<span class="token punctuation">(</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>conv <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span>in_channels<span class="token punctuation">,</span> out_channels<span class="token punctuation">,</span> bias<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>bn <span class="token operator">=</span> nn<span class="token punctuation">.</span>BatchNorm2d<span class="token punctuation">(</span>out_channels<span class="token punctuation">,</span> eps<span class="token operator">=</span><span class="token number">0.001</span><span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">forward</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> x<span class="token punctuation">:</span> Tensor<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Tensor<span class="token punctuation">:</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>conv<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        x <span class="token operator">=</span> self<span class="token punctuation">.</span>bn<span class="token punctuation">(</span>x<span class="token punctuation">)</span>
        <span class="token keyword">return</span> F<span class="token punctuation">.</span>relu<span class="token punctuation">(</span>x<span class="token punctuation">,</span> inplace<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>


<span class="token keyword">class</span> <span class="token class-name">GoogLeNet_Weights</span><span class="token punctuation">(</span>WeightsEnum<span class="token punctuation">)</span><span class="token punctuation">:</span>
    IMAGENET1K_V1 <span class="token operator">=</span> Weights<span class="token punctuation">(</span>
        url<span class="token operator">=</span><span class="token string">"https://download.pytorch.org/models/googlenet-1378be20.pth"</span><span class="token punctuation">,</span>
        transforms<span class="token operator">=</span>partial<span class="token punctuation">(</span>ImageClassification<span class="token punctuation">,</span> crop_size<span class="token operator">=</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        meta<span class="token operator">=</span><span class="token punctuation">{<!-- --></span>
            <span class="token string">"num_params"</span><span class="token punctuation">:</span> <span class="token number">6624904</span><span class="token punctuation">,</span>
            <span class="token string">"min_size"</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token string">"categories"</span><span class="token punctuation">:</span> _IMAGENET_CATEGORIES<span class="token punctuation">,</span>
            <span class="token string">"recipe"</span><span class="token punctuation">:</span> <span class="token string">"https://github.com/pytorch/vision/tree/main/references/classification#googlenet"</span><span class="token punctuation">,</span>
            <span class="token string">"_metrics"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                <span class="token string">"ImageNet-1K"</span><span class="token punctuation">:</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"acc@1"</span><span class="token punctuation">:</span> <span class="token number">69.778</span><span class="token punctuation">,</span>
                    <span class="token string">"acc@5"</span><span class="token punctuation">:</span> <span class="token number">89.530</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"_ops"</span><span class="token punctuation">:</span> <span class="token number">1.498</span><span class="token punctuation">,</span>
            <span class="token string">"_file_size"</span><span class="token punctuation">:</span> <span class="token number">49.731</span><span class="token punctuation">,</span>
            <span class="token string">"_docs"</span><span class="token punctuation">:</span> <span class="token triple-quoted-string string">"""These weights are ported from the original paper."""</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span>
    DEFAULT <span class="token operator">=</span> IMAGENET1K_V1


<span class="token decorator annotation punctuation">@register_model</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token decorator annotation punctuation">@handle_legacy_interface</span><span class="token punctuation">(</span>weights<span class="token operator">=</span><span class="token punctuation">(</span><span class="token string">"pretrained"</span><span class="token punctuation">,</span> GoogLeNet_Weights<span class="token punctuation">.</span>IMAGENET1K_V1<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">googlenet</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">,</span> weights<span class="token punctuation">:</span> Optional<span class="token punctuation">[</span>GoogLeNet_Weights<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">None</span><span class="token punctuation">,</span> progress<span class="token punctuation">:</span> <span class="token builtin">bool</span> <span class="token operator">=</span> <span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token operator">**</span>kwargs<span class="token punctuation">:</span> Any<span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> GoogLeNet<span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""GoogLeNet (Inception v1) model architecture from
    `Going Deeper with Convolutions &lt;http://arxiv.org/abs/1409.4842&gt;`_.

    Args:
        weights (:class:`~torchvision.models.GoogLeNet_Weights`, optional): The
            pretrained weights for the model. See
            :class:`~torchvision.models.GoogLeNet_Weights` below for
            more details, and possible values. By default, no pre-trained
            weights are used.
        progress (bool, optional): If True, displays a progress bar of the
            download to stderr. Default is True.
        **kwargs: parameters passed to the ``torchvision.models.GoogLeNet``
            base class. Please refer to the `source code
            &lt;https://github.com/pytorch/vision/blob/main/torchvision/models/googlenet.py&gt;`_
            for more details about this class.
    .. autoclass:: torchvision.models.GoogLeNet_Weights
        :members:
    """</span>
    weights <span class="token operator">=</span> GoogLeNet_Weights<span class="token punctuation">.</span>verify<span class="token punctuation">(</span>weights<span class="token punctuation">)</span>

    original_aux_logits <span class="token operator">=</span> kwargs<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">"aux_logits"</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> weights <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token string">"transform_input"</span> <span class="token keyword">not</span> <span class="token keyword">in</span> kwargs<span class="token punctuation">:</span>
            _ovewrite_named_param<span class="token punctuation">(</span>kwargs<span class="token punctuation">,</span> <span class="token string">"transform_input"</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        _ovewrite_named_param<span class="token punctuation">(</span>kwargs<span class="token punctuation">,</span> <span class="token string">"aux_logits"</span><span class="token punctuation">,</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
        _ovewrite_named_param<span class="token punctuation">(</span>kwargs<span class="token punctuation">,</span> <span class="token string">"init_weights"</span><span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>
        _ovewrite_named_param<span class="token punctuation">(</span>kwargs<span class="token punctuation">,</span> <span class="token string">"num_classes"</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>weights<span class="token punctuation">.</span>meta<span class="token punctuation">[</span><span class="token string">"categories"</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

    model <span class="token operator">=</span> GoogLeNet<span class="token punctuation">(</span><span class="token operator">**</span>kwargs<span class="token punctuation">)</span>

    <span class="token keyword">if</span> weights <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        model<span class="token punctuation">.</span>load_state_dict<span class="token punctuation">(</span>weights<span class="token punctuation">.</span>get_state_dict<span class="token punctuation">(</span>progress<span class="token operator">=</span>progress<span class="token punctuation">,</span> check_hash<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> <span class="token keyword">not</span> original_aux_logits<span class="token punctuation">:</span>
            model<span class="token punctuation">.</span>aux_logits <span class="token operator">=</span> <span class="token boolean">False</span>
            model<span class="token punctuation">.</span>aux1 <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># type: ignore[assignment]</span>
            model<span class="token punctuation">.</span>aux2 <span class="token operator">=</span> <span class="token boolean">None</span>  <span class="token comment"># type: ignore[assignment]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            warnings<span class="token punctuation">.</span>warn<span class="token punctuation">(</span>
                <span class="token string">"auxiliary heads in the pretrained googlenet model are NOT pretrained, so make sure to train them"</span>
            <span class="token punctuation">)</span>

    <span class="token keyword">return</span> model

</code></pre> 
<p><img src="https://images2.imgbox.com/50/07/qEgoKU4v_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/64/15/W0C6pFaD_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="GoogleNetv1_690"></a>GoogleNetv1训练代码及运行结果</h2> 
<p>关于os.walk的详细用法可看这篇<a href="https://blog.csdn.net/qq_37344125/article/details/107972463">博客</a></p> 
<p>train_googlenet.py</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> os
<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>nn <span class="token keyword">as</span> nn
<span class="token keyword">import</span> torch
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> DataLoader
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>transforms <span class="token keyword">as</span> transforms
<span class="token keyword">import</span> torch<span class="token punctuation">.</span>optim <span class="token keyword">as</span> optim
<span class="token keyword">from</span> matplotlib <span class="token keyword">import</span> pyplot <span class="token keyword">as</span> plt
<span class="token keyword">import</span> torchvision<span class="token punctuation">.</span>models <span class="token keyword">as</span> models
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>my_dataset <span class="token keyword">import</span> NCFMDataSet
<span class="token keyword">from</span> tools<span class="token punctuation">.</span>common_tools <span class="token keyword">import</span> get_googlenet


BASE_DIR <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>abspath<span class="token punctuation">(</span>__file__<span class="token punctuation">)</span><span class="token punctuation">)</span>
device <span class="token operator">=</span> torch<span class="token punctuation">.</span>device<span class="token punctuation">(</span><span class="token string">"cuda"</span> <span class="token keyword">if</span> torch<span class="token punctuation">.</span>cuda<span class="token punctuation">.</span>is_available<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">else</span> <span class="token string">"cpu"</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">"__main__"</span><span class="token punctuation">:</span>

    <span class="token comment"># config</span>
    data_dir <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">"NCFM"</span><span class="token punctuation">,</span> <span class="token string">"train"</span><span class="token punctuation">)</span>
    path_state_dict <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>BASE_DIR<span class="token punctuation">,</span> <span class="token string">".."</span><span class="token punctuation">,</span> <span class="token string">"data"</span><span class="token punctuation">,</span> <span class="token string">"googlenet-1378be20.pth"</span><span class="token punctuation">)</span>
    <span class="token comment"># path_state_dict = False</span>
    num_classes <span class="token operator">=</span> <span class="token number">8</span>

    MAX_EPOCH <span class="token operator">=</span> <span class="token number">100</span>
    BATCH_SIZE <span class="token operator">=</span> <span class="token number">64</span>
    LR <span class="token operator">=</span> <span class="token number">0.001</span>
    log_interval <span class="token operator">=</span> <span class="token number">1</span>
    val_interval <span class="token operator">=</span> <span class="token number">1</span>
    start_epoch <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
    lr_decay_step <span class="token operator">=</span> <span class="token number">1</span>

    <span class="token comment"># ============================ step 1/5 数据 ============================</span>
    norm_mean <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.485</span><span class="token punctuation">,</span> <span class="token number">0.456</span><span class="token punctuation">,</span> <span class="token number">0.406</span><span class="token punctuation">]</span>
    norm_std <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0.229</span><span class="token punctuation">,</span> <span class="token number">0.224</span><span class="token punctuation">,</span> <span class="token number">0.225</span><span class="token punctuation">]</span>

    train_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment"># (256, 256) 区别</span>
        transforms<span class="token punctuation">.</span>CenterCrop<span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>RandomCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>RandomHorizontalFlip<span class="token punctuation">(</span>p<span class="token operator">=</span><span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>norm_mean<span class="token punctuation">,</span> norm_std<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    normalizes <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Normalize<span class="token punctuation">(</span>norm_mean<span class="token punctuation">,</span> norm_std<span class="token punctuation">)</span>
    valid_transform <span class="token operator">=</span> transforms<span class="token punctuation">.</span>Compose<span class="token punctuation">(</span><span class="token punctuation">[</span>
        transforms<span class="token punctuation">.</span>Resize<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">,</span> <span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>TenCrop<span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span> vertical_flip<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        transforms<span class="token punctuation">.</span>Lambda<span class="token punctuation">(</span><span class="token keyword">lambda</span> crops<span class="token punctuation">:</span> torch<span class="token punctuation">.</span>stack<span class="token punctuation">(</span><span class="token punctuation">[</span>normalizes<span class="token punctuation">(</span>transforms<span class="token punctuation">.</span>ToTensor<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span>crop<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> crop <span class="token keyword">in</span> crops<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span>

    <span class="token comment"># 构建MyDataset实例</span>
    train_data <span class="token operator">=</span> NCFMDataSet<span class="token punctuation">(</span>data_dir<span class="token operator">=</span>data_dir<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>train_transform<span class="token punctuation">)</span>
    valid_data <span class="token operator">=</span> NCFMDataSet<span class="token punctuation">(</span>data_dir<span class="token operator">=</span>data_dir<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"valid"</span><span class="token punctuation">,</span> transform<span class="token operator">=</span>valid_transform<span class="token punctuation">)</span>

    <span class="token comment"># 构建DataLoder</span>
    train_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>train_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span>BATCH_SIZE<span class="token punctuation">,</span> shuffle<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    valid_loader <span class="token operator">=</span> DataLoader<span class="token punctuation">(</span>dataset<span class="token operator">=</span>valid_data<span class="token punctuation">,</span> batch_size<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">)</span>

    <span class="token comment"># ============================ step 2/5 模型 ============================</span>
    googlenet_model <span class="token operator">=</span> get_googlenet<span class="token punctuation">(</span>path_state_dict<span class="token punctuation">,</span> device<span class="token punctuation">,</span> <span class="token boolean">False</span><span class="token punctuation">)</span>

    num_ftrs <span class="token operator">=</span> googlenet_model<span class="token punctuation">.</span>fc<span class="token punctuation">.</span>in_features
    googlenet_model<span class="token punctuation">.</span>fc <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_ftrs<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    num_ftrs_1 <span class="token operator">=</span> googlenet_model<span class="token punctuation">.</span>aux1<span class="token punctuation">.</span>fc2<span class="token punctuation">.</span>in_features
    googlenet_model<span class="token punctuation">.</span>aux1<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_ftrs_1<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>

    num_ftrs_2 <span class="token operator">=</span> googlenet_model<span class="token punctuation">.</span>aux2<span class="token punctuation">.</span>fc2<span class="token punctuation">.</span>in_features
    googlenet_model<span class="token punctuation">.</span>aux2<span class="token punctuation">.</span>fc2 <span class="token operator">=</span> nn<span class="token punctuation">.</span>Linear<span class="token punctuation">(</span>num_ftrs_2<span class="token punctuation">,</span> num_classes<span class="token punctuation">)</span>


    googlenet_model<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
    <span class="token comment"># ============================ step 3/5 损失函数 ============================</span>
    criterion <span class="token operator">=</span> nn<span class="token punctuation">.</span>CrossEntropyLoss<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment"># ============================ step 4/5 优化器 ============================</span>
    <span class="token comment"># 冻结卷积层</span>
    flag <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token comment"># flag = 1</span>
    <span class="token keyword">if</span> flag<span class="token punctuation">:</span>
        fc_params_id <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">id</span><span class="token punctuation">,</span> googlenet_model<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 返回的是parameters的 内存地址</span>
        base_params <span class="token operator">=</span> <span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token keyword">lambda</span> p<span class="token punctuation">:</span> <span class="token builtin">id</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span> <span class="token keyword">not</span> <span class="token keyword">in</span> fc_params_id<span class="token punctuation">,</span> googlenet_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span><span class="token punctuation">[</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'params'</span><span class="token punctuation">:</span> base_params<span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> LR <span class="token operator">*</span> <span class="token number">0.1</span><span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token comment"># 0</span>
            <span class="token punctuation">{<!-- --></span><span class="token string">'params'</span><span class="token punctuation">:</span> googlenet_model<span class="token punctuation">.</span>classifier<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">'lr'</span><span class="token punctuation">:</span> LR<span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>

    <span class="token keyword">else</span><span class="token punctuation">:</span>
        optimizer <span class="token operator">=</span> optim<span class="token punctuation">.</span>SGD<span class="token punctuation">(</span>googlenet_model<span class="token punctuation">.</span>parameters<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> lr<span class="token operator">=</span>LR<span class="token punctuation">,</span> momentum<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">)</span>  <span class="token comment"># 选择优化器</span>

    scheduler <span class="token operator">=</span> torch<span class="token punctuation">.</span>optim<span class="token punctuation">.</span>lr_scheduler<span class="token punctuation">.</span>StepLR<span class="token punctuation">(</span>optimizer<span class="token punctuation">,</span> step_size<span class="token operator">=</span>lr_decay_step<span class="token punctuation">,</span> gamma<span class="token operator">=</span><span class="token number">0.1</span><span class="token punctuation">)</span>  <span class="token comment"># 设置学习率下降策略</span>
    <span class="token comment"># scheduler = torch.optim.lr_scheduler.ReduceLROnPlateau(patience=5)</span>

<span class="token comment"># ============================ step 5/5 训练 ============================</span>
    train_curve <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    valid_curve <span class="token operator">=</span> <span class="token builtin">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token keyword">for</span> epoch <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>start_epoch <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> MAX_EPOCH<span class="token punctuation">)</span><span class="token punctuation">:</span>

        loss_mean <span class="token operator">=</span> <span class="token number">0.</span>
        correct <span class="token operator">=</span> <span class="token number">0.</span>
        total <span class="token operator">=</span> <span class="token number">0.</span>

        googlenet_model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span> i<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>

            <span class="token comment"># 1. forward</span>
            inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> data
            inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>
            outputs <span class="token operator">=</span> googlenet_model<span class="token punctuation">(</span>inputs<span class="token punctuation">)</span>

            <span class="token comment"># 2. backward</span>
            optimizer<span class="token punctuation">.</span>zero_grad<span class="token punctuation">(</span><span class="token punctuation">)</span>
            loss_main<span class="token punctuation">,</span> aug_loss1<span class="token punctuation">,</span> aug_loss2 <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">,</span> criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span><span class="token punctuation">,</span> \
                                              criterion<span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> labels<span class="token punctuation">)</span>
            loss <span class="token operator">=</span> loss_main <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.3</span> <span class="token operator">*</span> aug_loss1<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">0.3</span> <span class="token operator">*</span> aug_loss2<span class="token punctuation">)</span>
            loss<span class="token punctuation">.</span>backward<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 3. update weights</span>
            optimizer<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 统计分类情况</span>
            _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
            total <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
            correct <span class="token operator">+=</span> <span class="token punctuation">(</span>predicted <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

            <span class="token comment"># 打印训练信息</span>
            loss_mean <span class="token operator">+=</span> loss_main<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>
            train_curve<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss_main<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> log_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
                loss_mean <span class="token operator">=</span> loss_mean <span class="token operator">/</span> log_interval
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Training:Epoch[{:0&gt;3}/{:0&gt;3}] Iteration[{:0&gt;3}/{:0&gt;3}] Loss_main:{:.4f} Acc:{:.2%} lr:{}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    epoch<span class="token punctuation">,</span> MAX_EPOCH<span class="token punctuation">,</span> i<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> loss_mean<span class="token punctuation">,</span> correct <span class="token operator">/</span> total<span class="token punctuation">,</span> scheduler<span class="token punctuation">.</span>get_last_lr<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                loss_mean <span class="token operator">=</span> <span class="token number">0.</span>

        scheduler<span class="token punctuation">.</span>step<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 更新学习率</span>

        <span class="token comment"># validate the model</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>epoch<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> val_interval <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>

            correct_val <span class="token operator">=</span> <span class="token number">0.</span>
            total_val <span class="token operator">=</span> <span class="token number">0.</span>
            loss_val <span class="token operator">=</span> <span class="token number">0.</span>
            googlenet_model<span class="token punctuation">.</span><span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">with</span> torch<span class="token punctuation">.</span>no_grad<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                <span class="token keyword">for</span> j<span class="token punctuation">,</span> data <span class="token keyword">in</span> <span class="token builtin">enumerate</span><span class="token punctuation">(</span>valid_loader<span class="token punctuation">)</span><span class="token punctuation">:</span>
                    inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> data
                    inputs<span class="token punctuation">,</span> labels <span class="token operator">=</span> inputs<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">,</span> labels<span class="token punctuation">.</span>to<span class="token punctuation">(</span>device<span class="token punctuation">)</span>

                    bs<span class="token punctuation">,</span> ncrops<span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w <span class="token operator">=</span> inputs<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token punctuation">)</span>
                    outputs <span class="token operator">=</span> googlenet_model<span class="token punctuation">(</span>inputs<span class="token punctuation">.</span>view<span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> c<span class="token punctuation">,</span> h<span class="token punctuation">,</span> w<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    outputs_avg <span class="token operator">=</span> outputs<span class="token punctuation">.</span>view<span class="token punctuation">(</span>bs<span class="token punctuation">,</span> ncrops<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>mean<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

                    loss <span class="token operator">=</span> criterion<span class="token punctuation">(</span>outputs_avg<span class="token punctuation">,</span> labels<span class="token punctuation">)</span>

                    _<span class="token punctuation">,</span> predicted <span class="token operator">=</span> torch<span class="token punctuation">.</span><span class="token builtin">max</span><span class="token punctuation">(</span>outputs_avg<span class="token punctuation">.</span>data<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    total_val <span class="token operator">+=</span> labels<span class="token punctuation">.</span>size<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
                    correct_val <span class="token operator">+=</span> <span class="token punctuation">(</span>predicted <span class="token operator">==</span> labels<span class="token punctuation">)</span><span class="token punctuation">.</span>squeeze<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>cpu<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>numpy<span class="token punctuation">(</span><span class="token punctuation">)</span>

                    loss_val <span class="token operator">+=</span> loss<span class="token punctuation">.</span>item<span class="token punctuation">(</span><span class="token punctuation">)</span>

                loss_val_mean <span class="token operator">=</span> loss_val<span class="token operator">/</span><span class="token builtin">len</span><span class="token punctuation">(</span>valid_loader<span class="token punctuation">)</span>
                valid_curve<span class="token punctuation">.</span>append<span class="token punctuation">(</span>loss_val_mean<span class="token punctuation">)</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Valid:\t Epoch[{:0&gt;3}/{:0&gt;3}] Iteration[{:0&gt;3}/{:0&gt;3}] Loss: {:.4f} Acc:{:.2%}"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>
                    epoch<span class="token punctuation">,</span> MAX_EPOCH<span class="token punctuation">,</span> j<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_loader<span class="token punctuation">)</span><span class="token punctuation">,</span> loss_val_mean<span class="token punctuation">,</span> correct_val <span class="token operator">/</span> total_val<span class="token punctuation">)</span><span class="token punctuation">)</span>
            googlenet_model<span class="token punctuation">.</span>train<span class="token punctuation">(</span><span class="token punctuation">)</span>

    train_x <span class="token operator">=</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>train_curve<span class="token punctuation">)</span><span class="token punctuation">)</span>
    train_y <span class="token operator">=</span> train_curve

    train_iters <span class="token operator">=</span> <span class="token builtin">len</span><span class="token punctuation">(</span>train_loader<span class="token punctuation">)</span>
    valid_x <span class="token operator">=</span> np<span class="token punctuation">.</span>arange<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>valid_curve<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> train_iters<span class="token operator">*</span>val_interval <span class="token comment"># 由于valid中记录的是epochloss，需要对记录点进行转换到iterations</span>
    valid_y <span class="token operator">=</span> valid_curve

    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>train_x<span class="token punctuation">,</span> train_y<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Train'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>plot<span class="token punctuation">(</span>valid_x<span class="token punctuation">,</span> valid_y<span class="token punctuation">,</span> label<span class="token operator">=</span><span class="token string">'Valid'</span><span class="token punctuation">)</span>

    plt<span class="token punctuation">.</span>legend<span class="token punctuation">(</span>loc<span class="token operator">=</span><span class="token string">'upper right'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>ylabel<span class="token punctuation">(</span><span class="token string">'loss value'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>xlabel<span class="token punctuation">(</span><span class="token string">'Iteration'</span><span class="token punctuation">)</span>
    plt<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<p>my_dataset.py</p> 
<pre><code class="prism language-python"><span class="token comment"># -*- coding: utf-8 -*-</span>

<span class="token keyword">import</span> numpy <span class="token keyword">as</span> np
<span class="token keyword">import</span> torch
<span class="token keyword">import</span> os
<span class="token keyword">import</span> random
<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image
<span class="token keyword">from</span> torch<span class="token punctuation">.</span>utils<span class="token punctuation">.</span>data <span class="token keyword">import</span> Dataset

random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
class_name <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"ALB"</span><span class="token punctuation">,</span> <span class="token string">"BET"</span><span class="token punctuation">,</span> <span class="token string">"DOL"</span><span class="token punctuation">,</span> <span class="token string">"LAG"</span><span class="token punctuation">,</span> <span class="token string">"NoF"</span><span class="token punctuation">,</span> <span class="token string">"OTHER"</span><span class="token punctuation">,</span> <span class="token string">"SHARK"</span><span class="token punctuation">,</span> <span class="token string">"YFT"</span><span class="token punctuation">]</span>

<span class="token keyword">class</span> <span class="token class-name">NCFMDataSet</span><span class="token punctuation">(</span>Dataset<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> data_dir<span class="token punctuation">,</span> mode<span class="token operator">=</span><span class="token string">"train"</span><span class="token punctuation">,</span> split_n<span class="token operator">=</span><span class="token number">0.9</span><span class="token punctuation">,</span> rng_seed<span class="token operator">=</span><span class="token number">620</span><span class="token punctuation">,</span> transform<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token triple-quoted-string string">"""
        鱼类分类任务的Dataset
        :param data_dir: str, 数据集所在路径
        :param transform: torch.transform，数据预处理
        """</span>
        self<span class="token punctuation">.</span>mode <span class="token operator">=</span> mode
        self<span class="token punctuation">.</span>data_dir <span class="token operator">=</span> data_dir
        self<span class="token punctuation">.</span>rng_seed <span class="token operator">=</span> rng_seed
        self<span class="token punctuation">.</span>split_n <span class="token operator">=</span> split_n
        self<span class="token punctuation">.</span>data_info <span class="token operator">=</span> self<span class="token punctuation">.</span>_get_img_info<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># data_info存储所有图片路径和标签，在DataLoader中通过index读取样本</span>
        self<span class="token punctuation">.</span>transform <span class="token operator">=</span> transform

    <span class="token keyword">def</span> <span class="token function">__getitem__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">:</span>
        path_img<span class="token punctuation">,</span> label <span class="token operator">=</span> self<span class="token punctuation">.</span>data_info<span class="token punctuation">[</span>index<span class="token punctuation">]</span>
        img <span class="token operator">=</span> Image<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>path_img<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>     <span class="token comment"># 0~255</span>

        <span class="token keyword">if</span> self<span class="token punctuation">.</span>transform <span class="token keyword">is</span> <span class="token keyword">not</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            img <span class="token operator">=</span> self<span class="token punctuation">.</span>transform<span class="token punctuation">(</span>img<span class="token punctuation">)</span>   <span class="token comment"># 在这里做transform，转为tensor等等</span>

        <span class="token keyword">return</span> img<span class="token punctuation">,</span> label

    <span class="token keyword">def</span> <span class="token function">__len__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"\ndata_dir:{} is a empty dir! Please checkout your path to images!"</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_info<span class="token punctuation">)</span>

    <span class="token keyword">def</span> <span class="token function">_get_img_info</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>

        img_path <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        <span class="token keyword">for</span> root<span class="token punctuation">,</span> dirs<span class="token punctuation">,</span> files <span class="token keyword">in</span> os<span class="token punctuation">.</span>walk<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">for</span> name <span class="token keyword">in</span> files<span class="token punctuation">:</span>
                <span class="token keyword">if</span> name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">".jpg"</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
                    img_path<span class="token punctuation">.</span>append<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>root<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">)</span>

        random<span class="token punctuation">.</span>seed<span class="token punctuation">(</span>self<span class="token punctuation">.</span>rng_seed<span class="token punctuation">)</span>
        random<span class="token punctuation">.</span>shuffle<span class="token punctuation">(</span>img_path<span class="token punctuation">)</span>

        img_labels <span class="token operator">=</span> <span class="token punctuation">[</span>class_name<span class="token punctuation">.</span>index<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>basename<span class="token punctuation">(</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>dirname<span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">for</span> p <span class="token keyword">in</span> img_path<span class="token punctuation">]</span>

        split_idx <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>img_labels<span class="token punctuation">)</span> <span class="token operator">*</span> self<span class="token punctuation">.</span>split_n<span class="token punctuation">)</span>
        <span class="token comment"># split_idx = int(100 * self.split_n)</span>
        <span class="token keyword">if</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">"train"</span><span class="token punctuation">:</span>
            img_set <span class="token operator">=</span> img_path<span class="token punctuation">[</span><span class="token punctuation">:</span>split_idx<span class="token punctuation">]</span>     <span class="token comment"># 数据集90%训练</span>
            label_set <span class="token operator">=</span> img_labels<span class="token punctuation">[</span><span class="token punctuation">:</span>split_idx<span class="token punctuation">]</span>
        <span class="token keyword">elif</span> self<span class="token punctuation">.</span>mode <span class="token operator">==</span> <span class="token string">"valid"</span><span class="token punctuation">:</span>
            img_set <span class="token operator">=</span> img_path<span class="token punctuation">[</span>split_idx<span class="token punctuation">:</span><span class="token punctuation">]</span>
            label_set <span class="token operator">=</span> img_labels<span class="token punctuation">[</span>split_idx<span class="token punctuation">:</span><span class="token punctuation">]</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"self.mode 无法识别，仅支持(train, valid)"</span><span class="token punctuation">)</span>

        path_img_set <span class="token operator">=</span> <span class="token punctuation">[</span>os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>self<span class="token punctuation">.</span>data_dir<span class="token punctuation">,</span> n<span class="token punctuation">)</span> <span class="token keyword">for</span> n <span class="token keyword">in</span> img_set<span class="token punctuation">]</span>
        data_info <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">(</span>n<span class="token punctuation">,</span> l<span class="token punctuation">)</span> <span class="token keyword">for</span> n<span class="token punctuation">,</span> l <span class="token keyword">in</span> <span class="token builtin">zip</span><span class="token punctuation">(</span>path_img_set<span class="token punctuation">,</span> label_set<span class="token punctuation">)</span><span class="token punctuation">]</span>

        <span class="token keyword">return</span> data_info
</code></pre> 
<p><img src="https://images2.imgbox.com/c0/04/WhOXxbv9_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/ce/d4/RUZZGdXN_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/dc/93/mUsMv33u_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/87/94/FXsGCWaK_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/50/c9/AMdeC5cJ_o.png" alt="在这里插入图片描述"></p> 
<p><font color="#FF5B22" size="3" face="楷体">之后我会持续更新，如果喜欢我的文章，请记得一键三连哦，点赞关注收藏，你的每一个赞每一份关注每一次收藏都将是我前进路上的无限动力 ！！！↖(▔▽▔)↗感谢支持！</font></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6e113704a5d0063688999cce5be31240/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">全网最低价——组合预测模型全家桶</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/48bb9eca4ae68f19a6a63665fd8e9dc7/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">基于Java SSM框架实现旅游资源网站系统项目【项目源码&#43;论文说明】</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>