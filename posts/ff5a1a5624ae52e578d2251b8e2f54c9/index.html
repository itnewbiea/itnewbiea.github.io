<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>分布式事务 之 02 mysql 对XA事务的支持 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="分布式事务 之 02 mysql 对XA事务的支持" />
<meta property="og:description" content="文章目录 概述1. MySQL XA 事务SQL语法2. Mysql XA事务状态3 关于XID的说明4、通过jdbc操作mysql xa事务5 MySQL Connector/J XA事务支持源码简单分析参考 相关文章： 第一篇参见原文 或 【微服务专题】17-Alibaba分布式事务组件Seata实战 01 分布式事务介绍 分布式事务 之 02 mysql 对XA事务的支持 分布式事务 之 03 JTA规范 分布式事务 之 04 atomikos JTA/XA全局事务 概述 MySQL 从5.0.3开始支持XA分布式事务，且只有InnoDB存储引擎支持。MySQL Connector/J 从5.0.0版本之后开始直接提供对XA的支持。
需要注意的是， 在DTP模型中，mysql属于资源管理器(RM)。而一个完整的分布式事务中，一般会存在多个RM，由事务管理器TM来统一进行协调。因此，这里所说的mysql对XA分布式事务的支持，一般指的是单台mysql实例如何执行自己的事务分支。
1. MySQL XA 事务SQL语法 https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html
XA {START|BEGIN} xid [JOIN|RESUME] //开启XA事务，如果使用的是XA START而不是XA BEGIN，那么不支持[JOIN|RESUME]，xid是一个唯一值，表示事务分支标识符 XA END xid [SUSPEND [FOR MIGRATE]] //结束一个XA事务，不支持[SUSPEND [FOR MIGRATE]] XA PREPARE xid 准备提交 XA COMMIT xid [ONE PHASE] //提交，如果使用了ONE PHASE，则表示使用一阶段提交。两阶段提交协议中，如果只有一个RM参与，那么可以优化为一阶段提交 XA ROLLBACK xid //回滚 XA RECOVER [CONVERT XID] //列出所有处于PREPARE阶段的XA事务 下面是一个简单的msyql XA事务案例，演示了mysql作为全局事务中的一个事务分支，将一行记录插入到一个表中：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ff5a1a5624ae52e578d2251b8e2f54c9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-02-17T19:11:48+08:00" />
<meta property="article:modified_time" content="2022-02-17T19:11:48+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">分布式事务 之 02 mysql 对XA事务的支持</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><a href="#_8" rel="nofollow">概述</a></li><li><a href="#1_MySQL_XA_SQL_14" rel="nofollow">1. MySQL XA 事务SQL语法</a></li><li><a href="#2_Mysql_XA_43" rel="nofollow">2. Mysql XA事务状态</a></li><li><a href="#3_XID_71" rel="nofollow">3 关于XID的说明</a></li><li><a href="#4jdbcmysql_xa_154" rel="nofollow">4、通过jdbc操作mysql xa事务</a></li><li><a href="#5_MySQL_ConnectorJ_XA_247" rel="nofollow">5 MySQL Connector/J XA事务支持源码简单分析</a></li><li><a href="#_317" rel="nofollow">参考</a></li></ul> 
</div> 
<br> 相关文章： 
<br> 第一篇参见原文 或 
<a href="https://blog.csdn.net/m0_45406092/article/details/122985145">【微服务专题】17-Alibaba分布式事务组件Seata实战 01 分布式事务介绍</a> 
<br> 
<a href="https://blog.csdn.net/m0_45406092/article/details/121429082">分布式事务 之 02 mysql 对XA事务的支持</a> 
<br> 
<a href="https://blog.csdn.net/m0_45406092/article/details/121430473">分布式事务 之 03 JTA规范</a> 
<br> 
<a href="https://blog.csdn.net/m0_45406092/article/details/121430750">分布式事务 之 04 atomikos JTA/XA全局事务</a> 
<p></p> 
<h2><a id="_8"></a>概述</h2> 
<p>MySQL 从5.0.3开始支持XA分布式事务，且只有InnoDB存储引擎支持。MySQL Connector/J 从5.0.0版本之后开始直接提供对XA的支持。<br> <img src="https://images2.imgbox.com/6b/e1/pEr0MVrs_o.png" alt="在这里插入图片描述"><br> 需要注意的是， 在DTP模型中，mysql属于资源管理器(RM)。而一个完整的分布式事务中，一般会存在多个RM，由事务管理器TM来统一进行协调。因此，这里所说的mysql对XA分布式事务的支持，一般指的是单台mysql实例如何执行自己的事务分支。</p> 
<h2><a id="1_MySQL_XA_SQL_14"></a>1. MySQL XA 事务SQL语法</h2> 
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html" rel="nofollow">https://dev.mysql.com/doc/refman/5.7/en/xa-statements.html</a></p> 
<pre><code class="prism language-java">XA <span class="token punctuation">{<!-- --></span>START<span class="token operator">|</span>BEGIN<span class="token punctuation">}</span> xid <span class="token punctuation">[</span>JOIN<span class="token operator">|</span>RESUME<span class="token punctuation">]</span>   <span class="token comment">//开启XA事务，如果使用的是XA START而不是XA BEGIN，那么不支持[JOIN|RESUME]，xid是一个唯一值，表示事务分支标识符</span>
XA END xid <span class="token punctuation">[</span>SUSPEND <span class="token punctuation">[</span>FOR MIGRATE<span class="token punctuation">]</span><span class="token punctuation">]</span>   <span class="token comment">//结束一个XA事务，不支持[SUSPEND [FOR MIGRATE]]</span>
XA PREPARE xid 准备提交
XA COMMIT xid <span class="token punctuation">[</span>ONE PHASE<span class="token punctuation">]</span> <span class="token comment">//提交，如果使用了ONE PHASE，则表示使用一阶段提交。两阶段提交协议中，如果只有一个RM参与，那么可以优化为一阶段提交</span>
XA ROLLBACK xid  <span class="token comment">//回滚</span>
XA RECOVER <span class="token punctuation">[</span>CONVERT XID<span class="token punctuation">]</span>  <span class="token comment">//列出所有处于PREPARE阶段的XA事务</span>
</code></pre> 
<p>下面是一个简单的msyql XA事务案例，演示了mysql作为全局事务中的一个事务分支，将一行记录插入到一个表中：</p> 
<pre><code class="prism language-java">mysql<span class="token operator">&gt;</span> XA START <span class="token string">'xatest’;  //其中'</span>xatest’就是xid的值
<span class="token class-name">Query</span> OK<span class="token punctuation">,</span> <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
mysql<span class="token operator">&gt;</span> insert into <span class="token function">user</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token function">values</span><span class="token punctuation">(</span><span class="token string">"tianshozuhi"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> OK<span class="token punctuation">,</span> <span class="token number">1</span> row affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
mysql<span class="token operator">&gt;</span> XA END <span class="token string">'xatest'</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> OK<span class="token punctuation">,</span> <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
 
mysql<span class="token operator">&gt;</span> XA PREPARE <span class="token string">'xatest'</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> OK<span class="token punctuation">,</span> <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
 
mysql<span class="token operator">&gt;</span> XA COMMIT <span class="token string">'xatest'</span><span class="token punctuation">;</span>
<span class="token class-name">Query</span> OK<span class="token punctuation">,</span> <span class="token number">0</span> rows affected <span class="token punctuation">(</span><span class="token number">0.01</span> sec<span class="token punctuation">)</span>
</code></pre> 
<h2><a id="2_Mysql_XA_43"></a>2. Mysql XA事务状态</h2> 
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/xa-states.html" rel="nofollow">https://dev.mysql.com/doc/refman/5.7/en/xa-states.html</a></p> 
<p>XA事务的状态，按照如下步骤进行展开</p> 
<ol><li> <p>使用XA START来启动一个XA事务，并把它置于ACTIVE状态。</p> </li><li> <p>对于一个ACTIVE状态的 XA事务，我们可以执行构成事务的SQL语句，然后发布一个XA END语句。XA END把事务放入IDLE状态。</p> </li><li> <p>对于一个IDLE 状态XA事务，可以执行一个XA PREPARE语句或一个XA COMMIT…ONE PHASE语句：</p> 
  <ul><li> <p>XA PREPARE把事务放入PREPARED状态。在此点上的XA RECOVER语句将在其输出中包括事务的xid值，因为XA RECOVER会列出处于PREPARED状态的所有XA事务。</p> </li><li> <p>XA COMMIT…ONE PHASE用于预备和提交事务。xid值将不会被XA RECOVER列出，因为事务终止。</p> </li></ul> </li><li> <p>对于一个PREPARED状态的 XA事务，您可以发布一个XA COMMIT语句来提交和终止事务，或者发布XA ROLLBACK来回滚并终止事务。</p> </li></ol> 
<p>针对一个给定的客户端连接而言，<code>XA事务和非XA事务(即本地事务)是互斥的</code>。例如，已经执行了”XA START”命令来开启一个XA事务，则本地事务不会被启动，直到XA事务已经被提交或被 回滚为止。相反的，如果已经使用START TRANSACTION启动一个本地事务，则XA语句不能被使用，直到该事务被提交或被 回滚为止。</p> 
<p>最后，如果一个XA事务处于ACTIVE状态，是不能直接进行提交的，如果这样做，mysql会抛出异常：</p> 
<pre><code class="prism language-java"><span class="token class-name">ERROR</span> <span class="token number">1399</span> <span class="token punctuation">(</span>XAE07<span class="token punctuation">)</span><span class="token operator">:</span> XAER_RMFAIL<span class="token operator">:</span> <span class="token class-name">The</span> command cannot be executed
when global transaction is in the ACTIVE state
</code></pre> 
<h2><a id="3_XID_71"></a>3 关于XID的说明</h2> 
<p>mysql中使用xid来作为一个事务分支的标识符。事实上xid作为事务分支标识符是在XA规范中定义的，在&lt;&lt; Distributed Transaction Processing: The XA Specification&gt;&gt; 4.2 节中，规定了一个xid的结构，通过C语言进行描述，如下：</p> 
<pre><code class="prism language-java"><span class="token operator">/</span>∗
∗ <span class="token class-name">Transaction</span> branch identification<span class="token operator">:</span> XID and NULLXID<span class="token operator">:</span>
∗<span class="token operator">/</span>
#define XIDDATASIZE <span class="token number">128</span>  <span class="token operator">/</span>∗ size in bytes ∗<span class="token operator">/</span>
#define MAXGTRIDSIZE <span class="token number">64</span>  <span class="token operator">/</span>∗ maximum size in bytes of gtrid ∗<span class="token operator">/</span>
#define MAXBQUALSIZE <span class="token number">64</span>  <span class="token operator">/</span>∗ maximum size in bytes of bqual ∗<span class="token operator">/</span>
struct xid_t <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">long</span> formatID<span class="token punctuation">;</span>     <span class="token comment">/* format identifier */</span>
    <span class="token keyword">long</span> gtrid_length<span class="token punctuation">;</span> <span class="token comment">/* value 1-64 */</span>
    <span class="token keyword">long</span> bqual_length<span class="token punctuation">;</span> <span class="token comment">/* value 1-64 */</span>
    <span class="token keyword">char</span> data<span class="token punctuation">[</span>XIDDATASIZE<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token operator">/</span>∗
∗ <span class="token class-name">A</span> value of <span class="token operator">-</span><span class="token number">1</span> in formatID means that the XID is <span class="token keyword">null</span><span class="token punctuation">.</span>
∗<span class="token operator">/</span>
typedef struct xid_t XID<span class="token punctuation">;</span>
<span class="token operator">/</span>∗
∗ <span class="token class-name">Declarations</span> of routines by which <span class="token class-name">RMs</span> call <span class="token class-name">TMs</span><span class="token operator">:</span>
∗<span class="token operator">/</span>
extern <span class="token keyword">int</span> <span class="token function">ax_reg</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> XID ∗<span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
extern <span class="token keyword">int</span> <span class="token function">ax_unreg</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token keyword">long</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>XA规范定义了一个xid有4个部分组成：</p> 
<p><code>gtrid：</code></p> 
<p>全局事务标识符(global transaction identifier)，最大不能超过64字节</p> 
<p><code>bqual：</code></p> 
<p>分支限定符(branch qualifier)，最大不能超过64字节</p> 
<p><code>data：</code></p> 
<p>xid的值，其是 gtrid和bqual拼接后的内容。因为gtrid和bqual最大都是64个字节，因此data的最大长度为128。不过，在xid的结构体中，并没有gtrid和bqual，只有gtrid_length、bqual_length。由于二者的内容都存储在data中，因此我们可以根据data反推出gtrid和bqual。举例来说，假设gtrid为”g12345”(5个字节)，bqual为”b456”(4个字节)。那么在构造xid结构体时，gtrid_length=5，bqual_length=4，data=”g12345b456”，那么在反推的时候：</p> 
<p>从data[0]到data[gtrid_length-1]之间的部分就是gtrid的值；从data[gtrid_length]到data[gtrid_length+bqual_length-1]部分就是bqual的值。</p> 
<p><code>formatId：</code></p> 
<p>而formatId的作用就是记录gtrid、bqual的格式，类似于memcached中flags字段的作用。XA规范中通过一个结构体约定了xid的组成部分，但是并没有规定data中存储的gtrid、bqual内容到底应该是什么格式。你可以选择使用数字，也可以选择使用字符串，到底选择什么由开发者自行决定，只要最终能保证data中的内容是全局唯一的即可。XA规范建议使用OSI CCR风格来组织xid的内容，此时formatId应该设置为0.</p> 
<p>在mysql官方文档中，关于xid的组成也有类似的说明：</p> 
<pre><code class="prism language-java">xid<span class="token operator">:</span> gtrid <span class="token punctuation">[</span><span class="token punctuation">,</span> bqual <span class="token punctuation">[</span><span class="token punctuation">,</span> formatID <span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> 
<p>其中，bqual、formatID是可选的。解释如下：</p> 
<p>gtrid : 是一个全局事务标识符(global transaction identifier)，</p> 
<p>bqual:是一个分支限定符(branch qualifier)，如果没有提供bqual，那么默认值为空字符串’’。</p> 
<p>formatID：是一个数字，用于标记gtrid和bqual值的格式，这是一个无符号整数(unsigned integer)，也就是说，最小为0。如果没有提供formatID，那么其默认值为1。</p> 
<p>特别需要注意的是，xid作为一个事务分支的标识符，理论上只要有分支限定符(bqual)就可以了，为什么要包含全局事务标识符(gtrid)？这主要是为了管理方便，通过包含进xid，我们可以很容易的判断出这个事务分支属于哪一个全局事务。</p> 
<p>例如，前面提到 XA RECOVER命令的作用是列出所有处于PREPARE阶段的XA事务，以下是一个案例：</p> 
<pre><code class="prism language-java">mysql<span class="token operator">&gt;</span>  <span class="token class-name">XA</span> RECOVER<span class="token punctuation">;</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span> formatID <span class="token operator">|</span> gtrid_length <span class="token operator">|</span> bqual_length <span class="token operator">|</span> data         <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
<span class="token operator">|</span>        <span class="token number">1</span> <span class="token operator">|</span>            <span class="token number">6</span> <span class="token operator">|</span>            <span class="token number">6</span> <span class="token operator">|</span> g12345b67890 <span class="token operator">|</span>
<span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">+</span>
</code></pre> 
<p>这里列出的是一个分支事务xid的组成信息，根据前面的介绍，我们可以推断出：</p> 
<pre><code>gtrid是data[0]到data[gtrid_length-1]部分的内容，即data[0]到data[6-1=5]部分的内容，结果为g12345；

而bqual是data[gtrid_length]到data[gtrid_length+bqual_length-1]部分的内容，即data[6]到data[6+6-1=11]部分的内容，结果b67890。
</code></pre> 
<p>因此，根据这个信息，我们就可以判断出这个xid表示的是：全局事务(g12345)中的事务分支(b67890)。</p> 
<h2><a id="4jdbcmysql_xa_154"></a>4、通过jdbc操作mysql xa事务</h2> 
<p><code>MySQL Connector/J 从5.0.0版本之后开始直接提供对XA的支持</code>，也就是提供了java版本XA接口的实现。意味着我们可以直接通过java代码来执行mysql xa事务。</p> 
<p>需要注意的是，业务开发人员在编写代码时，不应该直接操作这些XA事务操作的接口。因为在DTP模型中，RM上的事务分支的开启、结束、准备、提交、回滚等操作，都应该是由事务管理器TM来统一管理。</p> 
<p>由于目前我们还没有接触到TM，那么我们不妨做一回"人肉事务管理器"，用你智慧的大脑，来控制多个mysql实例上xa事务分支的执行，提交/回滚。通过直接操作这些接口，你将对xa事务有更深刻的认识。</p> 
<pre><code class="prism language-java"><span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>optional<span class="token punctuation">.</span></span><span class="token class-name">MysqlXAConnection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span>jdbc2<span class="token punctuation">.</span>optional<span class="token punctuation">.</span></span><span class="token class-name">MysqlXid</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">XAConnection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>xa<span class="token punctuation">.</span></span><span class="token class-name">XAException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>xa<span class="token punctuation">.</span></span><span class="token class-name">XAResource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>transaction<span class="token punctuation">.</span>xa<span class="token punctuation">.</span></span><span class="token class-name">Xid</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DriverManager</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">PreparedStatement</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlXAConnectionTest</span> <span class="token punctuation">{<!-- --></span>
   <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
      <span class="token comment">//true表示打印XA语句,，用于调试</span>
      <span class="token keyword">boolean</span> logXaCommands <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token comment">// 获得资源管理器操作接口实例 RM1</span>
      <span class="token class-name">Connection</span> conn1 <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/test"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"shxx12151022"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAConnection</span> xaConn1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">)</span> conn1<span class="token punctuation">,</span> logXaCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAResource</span> rm1 <span class="token operator">=</span> xaConn1<span class="token punctuation">.</span><span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获得资源管理器操作接口实例 RM2</span>
      <span class="token class-name">Connection</span> conn2 <span class="token operator">=</span> <span class="token class-name">DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span><span class="token string">"jdbc:mysql://localhost:3306/test"</span><span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span>
            <span class="token string">"shxx12151022"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAConnection</span> xaConn2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span><span class="token punctuation">)</span> conn2<span class="token punctuation">,</span> logXaCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">XAResource</span> rm2 <span class="token operator">=</span> xaConn2<span class="token punctuation">.</span><span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// AP请求TM执行一个分布式事务，TM生成全局事务id</span>
      <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> gtrid <span class="token operator">=</span> <span class="token string">"g12345"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> formatId <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// ==============分别执行RM1和RM2上的事务分支====================</span>
         <span class="token comment">// TM生成rm1上的事务分支id</span>
         <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bqual1 <span class="token operator">=</span> <span class="token string">"b00001"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Xid</span> xid1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXid</span><span class="token punctuation">(</span>gtrid<span class="token punctuation">,</span> bqual1<span class="token punctuation">,</span> formatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 执行rm1上的事务分支</span>
         rm1<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMNOFLAGS<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//One of TMNOFLAGS, TMJOIN, or TMRESUME.</span>
         <span class="token class-name">PreparedStatement</span> ps1 <span class="token operator">=</span> conn1<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">"INSERT into user(name) VALUES ('tianshouzhi')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         ps1<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rm1<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMSUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// TM生成rm2上的事务分支id</span>
         <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bqual2 <span class="token operator">=</span> <span class="token string">"b00002"</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">Xid</span> xid2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MysqlXid</span><span class="token punctuation">(</span>gtrid<span class="token punctuation">,</span> bqual2<span class="token punctuation">,</span> formatId<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// 执行rm2上的事务分支</span>
         rm2<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMNOFLAGS<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token class-name">PreparedStatement</span> ps2 <span class="token operator">=</span> conn2<span class="token punctuation">.</span><span class="token function">prepareStatement</span><span class="token punctuation">(</span><span class="token string">"INSERT into user(name) VALUES ('wangxiaoxiao')"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         ps2<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         rm2<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>TMSUCCESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// ===================两阶段提交================================</span>
         <span class="token comment">// phase1：询问所有的RM 准备提交事务分支</span>
         <span class="token keyword">int</span> rm1_prepare <span class="token operator">=</span> rm1<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>xid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token keyword">int</span> rm2_prepare <span class="token operator">=</span> rm2<span class="token punctuation">.</span><span class="token function">prepare</span><span class="token punctuation">(</span>xid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">// phase2：提交所有事务分支</span>
         <span class="token keyword">boolean</span> onePhase <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">//TM判断有2个事务分支，所以不能优化为一阶段提交</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>rm1_prepare <span class="token operator">==</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>XA_OK
               <span class="token operator">&amp;&amp;</span> rm2_prepare <span class="token operator">==</span> <span class="token class-name">XAResource</span><span class="token punctuation">.</span>XA_OK
               <span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//所有事务分支都prepare成功，提交所有事务分支</span>
            rm1<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>xid1<span class="token punctuation">,</span> onePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rm2<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span>xid2<span class="token punctuation">,</span> onePhase<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span><span class="token comment">//如果有事务分支没有成功，则回滚</span>
            rm1<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>xid1<span class="token punctuation">)</span><span class="token punctuation">;</span>
            rm1<span class="token punctuation">.</span><span class="token function">rollback</span><span class="token punctuation">(</span>xid2<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">XAException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
         <span class="token comment">// 如果出现异常，也要进行回滚</span>
         e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在这个案例中，演示了2个RM的情况下分布式事务的工作流程。因为我们充当了"人肉事务管理器”TM，因此很多本应该由TM来处理的工作处理细节也直接体现在上述代码中，如:生成全局事务id和分支事务id、在RM上开启事务分支、两阶段提交等。虽然我们自己作为"人肉事务管理器”是很不可靠的，但是上述代码可以让我们了解一个TM内部的主要工作流程是怎样的。</p> 
<blockquote> 
 <p>xid是直接写死的，按道理，应该由TM负责生成。</p> 
</blockquote> 
<p>在实际开发中，代码绝不会像上表面那样复杂，因为我们通常都会使用第三方或者容器提供的TM功能，因此在操作分布式事务时，代码可以得到极大的简化。</p> 
<p>最后，由于我们设置了logXaCommands=true，程序在运行的时候回打印出执行的XA命令。如下所示：</p> 
<pre><code class="prism language-java"><span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">START</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303031</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">END</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303031</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">START</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303032</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">END</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303032</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">PREPARE</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303031</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">PREPARE</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303032</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">COMMIT</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303031</span><span class="token punctuation">,</span><span class="token number">0x1</span>
<span class="token class-name">Fri</span> <span class="token class-name">Feb</span> <span class="token number">02</span> <span class="token number">18</span><span class="token operator">:</span><span class="token number">09</span><span class="token operator">:</span><span class="token number">29</span> CST <span class="token number">2018</span> DEBUG<span class="token operator">:</span> <span class="token class-name">Executing</span> XA statement<span class="token operator">:</span> XA <span class="token class-name">COMMIT</span> <span class="token number">0x673132333435</span><span class="token punctuation">,</span><span class="token number">0x623030303032</span><span class="token punctuation">,</span><span class="token number">0x1</span>
</code></pre> 
<h2><a id="5_MySQL_ConnectorJ_XA_247"></a>5 MySQL Connector/J XA事务支持源码简单分析</h2> 
<p>最后，我们对上述源码进行一下简单的分析。在前面直接使用mysql命令操作的时候，我们通过"XA START xid”等XA命令来执行XA事务。而在上述java代码中，我们是获取了一个普通的链接<code>Connection</code>之后，封装成了<code>MysqlXAConnection</code>。如下：</p> 
<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MysqlXAConnection</span> <span class="token keyword">extends</span> <span class="token class-name">MysqlPooledConnection</span> <span class="token keyword">implements</span> <span class="token class-name">XAConnection</span><span class="token punctuation">,</span> <span class="token class-name">XAResource</span> <span class="token punctuation">{<!-- --></span>
  <span class="token keyword">private</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span> underlyingConnection<span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token class-name">Log</span> log<span class="token punctuation">;</span>
  <span class="token keyword">protected</span> <span class="token keyword">boolean</span> logXaCommands<span class="token punctuation">;</span>
   
  <span class="token comment">//构造方法</span>
  <span class="token keyword">public</span> <span class="token class-name">MysqlXAConnection</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Connection</span> connection<span class="token punctuation">,</span> <span class="token keyword">boolean</span> logXaCommands<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>connection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>underlyingConnection <span class="token operator">=</span> connection<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>log <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>logXaCommands <span class="token operator">=</span> logXaCommands<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
…
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，<code>MysqlXAConnection</code>本身就实现了<code>XAResource接口</code>，因此当调用getXAResource()方法时，返回的就是其自己</p> 
<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection#getXAResource ：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">XAResource</span> <span class="token function">getXAResource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>之后，我们调用XAResource的<code>start</code>方法来开启XA事务。start方法源码如下所示：</p> 
<p>com.mysql.jdbc.jdbc2.optional.MysqlXAConnection#start ：</p> 
<blockquote> 
 <p>start方法实际上定义在 XAResource接口中</p> 
</blockquote> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token class-name">Xid</span> xid<span class="token punctuation">,</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">XAException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">//1、封装XA命令</span>
    <span class="token class-name">StringBuilder</span> commandBuf <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span>MAX_COMMAND_LENGTH<span class="token punctuation">)</span><span class="token punctuation">;</span>
    commandBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">"XA START "</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">appendXid</span><span class="token punctuation">(</span>commandBuf<span class="token punctuation">,</span> xid<span class="token punctuation">)</span><span class="token punctuation">;</span>
   
    <span class="token comment">//2、添加flag标记</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>flags<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> TMJOIN<span class="token operator">:</span>
            commandBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" JOIN"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TMRESUME<span class="token operator">:</span>
            commandBuf<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">" RESUME"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> TMNOFLAGS<span class="token operator">:</span>
            <span class="token comment">// no-op</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">XAException</span><span class="token punctuation">(</span><span class="token class-name">XAException</span><span class="token punctuation">.</span>XAER_INVAL<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">//执行命令</span>
    <span class="token function">dispatchCommand</span><span class="token punctuation">(</span>commandBuf<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>underlyingConnection<span class="token punctuation">.</span><span class="token function">setInGlobalTx</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，<font color="blue">当我们调用MysqlXAConnection的start方法时，实际上就是执行了一个”XA START xid [JOIN|RESUME]”命令而已，和我们直接在命令行中的操作是一样一样的，只不过通过封装简化了我们的操作。</font></p> 
<blockquote> 
 <p>对应 rm1.start(xid1, XAResource.TMNOFLAGS);</p> 
</blockquote> 
<p>对于MysqlXAConnection的end、prepare、commit、rollback等方法，也都是是类似的，不再赘述。</p> 
<p>最后提示， MySQL Connector/J 中提供的XA操作接口，如上面提到的XAConnection、XAResource、Xid等，实际上都遵循了JTA规范，关于JTA规范将在下一节讲解。</p> 
<h2><a id="_317"></a>参考</h2> 
<p><a href="http://www.tianshouzhi.com/api/tutorials/distributed_transaction/384" rel="nofollow">2.0 mysql 对XA事务的支持</a>系列中的第二篇</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/a961b9b5b1958a1830efc812e95a1f4d/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">程序员工作经验总结</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/304efd7d3caf9f61819aca3b1b35fe58/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">详细新版phpstudy安装以及sqli-labs-master靶场环境搭建过程附带文件链接</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>