<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>gRPC-Java（二）：一个Demo熟悉gRPC的四种模式 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="gRPC-Java（二）：一个Demo熟悉gRPC的四种模式" />
<meta property="og:description" content="gRPC提供了四种提供服务的模式，它们分别是：
① 简单模式（Unary RPCs）；
② 客户端流模式（Client streaming RPCs）；
③ 服务端流模式（Server streaming RPCs）；
④ 双向流模式（Bidirectional streaming RPCs ）
简单模式：客户端发出单个请求，服务端返回单个响应。客户端流模式：客户端将连续的数据流发送到服务端，服务端返回一个响应；用在客户端发送多次请求到服务端情况，如分段上传图片场景等。服务端流模式：客户端发起一个请求到服务端，服务端返回连续的数据流；一般用在服务端分批返回数据的情况，客户端能持续接收服务端的数据。双向流模式：双向流就是服务端流和客户端流的整合，请求和返回都可以通过流的方式交互。 接下来，我们将通过官网的一个例子来学习一下这四种模式。
还是用到gRPC-Java（一）：构建一个使用Java语言的gRPC工程中已经创建好的项目，完整项目链接附在文末。
##一、编写.proto文件并生成代码
这里面涉及到一些protocol-buffers的语法，可以暂时不用深究，不影响理解大局。
下面的router_guide.proto文件中，使用service关键字定义了一个名为RouteGuide的服务，这个RouteGuide服务中又提供了四个使用rpc关键字定义的RPC方法，分别是：
简单模式：GetFeature；
服务端流模式：ListFeatures；
客户端流模式：RecordRoute；
双向流模式：RouteChat。
区别这四种模式的方式就是，在流模式的rpc方法参数前面加stream。举个例子：
服务端流模式ListFeatures，是这么定义的：
rpc ListFeatures(Rectangle) returns (stream Feature) {}
响应体Feature前面加了stream。
客户端流模式RecordRoute，是这么定义的：
rpc RecordRoute(stream Point) returns (RouteSummary) {}
请求体Point前面加了stream。
双向流模式RouteChat，则是在请求和响应体之前都加stream：
rpc RouteChat(stream RouteNote) returns (stream RouteNote) {}
OK，了解了proto文件里面的基本内容之后，我们继续。本文中实例程序所需要的完整的route_guide.proto文件如下：
syntax = &#34;proto3&#34;; option java_multiple_files = true; option java_package = &#34;com.zhb.grpc.examples.routeguide&#34;; option java_outer_classname = &#34;RouteGuideProto&#34;; option objc_class_prefix = &#34;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/ca597feba5e7628534d5e1df02e330f8/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-11T00:22:26+08:00" />
<meta property="article:modified_time" content="2021-10-11T00:22:26+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">gRPC-Java（二）：一个Demo熟悉gRPC的四种模式</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p>gRPC提供了四种提供服务的模式，它们分别是：<br> ① 简单模式（Unary RPCs）；<br> ② 客户端流模式（Client streaming RPCs）；<br> ③ 服务端流模式（Server streaming RPCs）；<br> ④ 双向流模式（Bidirectional streaming RPCs ）</p> 
<ul><li>简单模式：客户端发出单个请求，服务端返回单个响应。</li><li>客户端流模式：客户端将连续的数据流发送到服务端，服务端返回一个响应；用在客户端发送多次请求到服务端情况，如分段上传图片场景等。</li><li>服务端流模式：客户端发起一个请求到服务端，服务端返回连续的数据流；一般用在服务端分批返回数据的情况，客户端能持续接收服务端的数据。</li><li>双向流模式：双向流就是服务端流和客户端流的整合，请求和返回都可以通过流的方式交互。</li></ul> 
<p>接下来，我们将通过官网的一个例子来学习一下这四种模式。</p> 
<p>还是用到<a href="https://blog.csdn.net/yexiguafu/article/details/120646460">gRPC-Java（一）：构建一个使用Java语言的gRPC工程</a>中已经创建好的项目，完整项目链接附在文末。</p> 
<p>##一、编写.proto文件并生成代码</p> 
<p>这里面涉及到一些protocol-buffers的语法，可以暂时不用深究，不影响理解大局。</p> 
<p>下面的router_guide.proto文件中，使用service关键字定义了一个名为RouteGuide的服务，这个RouteGuide服务中又提供了四个使用rpc关键字定义的RPC方法，分别是：</p> 
<p>简单模式：GetFeature；<br> 服务端流模式：ListFeatures；<br> 客户端流模式：RecordRoute；<br> 双向流模式：RouteChat。</p> 
<p>区别这四种模式的方式就是，在流模式的rpc方法参数前面加stream。举个例子：<br> 服务端流模式ListFeatures，是这么定义的：<br> <code>rpc ListFeatures(Rectangle) returns (stream Feature) {}</code><br> 响应体Feature前面加了stream。</p> 
<p>客户端流模式RecordRoute，是这么定义的：<br> <code>rpc RecordRoute(stream Point) returns (RouteSummary) {}</code><br> 请求体Point前面加了stream。</p> 
<p>双向流模式RouteChat，则是在请求和响应体之前都加stream：<br> <code>rpc RouteChat(stream RouteNote) returns (stream RouteNote) {}</code></p> 
<p>OK，了解了proto文件里面的基本内容之后，我们继续。本文中实例程序所需要的完整的route_guide.proto文件如下：</p> 
<pre><code class="prism language-proto">syntax = "proto3";

option java_multiple_files = true;
option java_package = "com.zhb.grpc.examples.routeguide";
option java_outer_classname = "RouteGuideProto";
option objc_class_prefix = "RTG";

package routeguide;

// service关键字描述一个RPC Server，里面的rpc关键字描述一个RPC方法
service RouteGuide {
  // A simple RPC.
  //
  // Obtains the feature at a given position.
  //
  // A feature with an empty name is returned if there's no feature at the given
  // position.
  rpc GetFeature(Point) returns (Feature) {}

  // A server-to-client streaming RPC.
  //
  // Obtains the Features available within the given Rectangle.  Results are
  // streamed rather than returned at once (e.g. in a response message with a
  // repeated field), as the rectangle may cover a large area and contain a
  // huge number of features.
  rpc ListFeatures(Rectangle) returns (stream Feature) {}

  // A client-to-server streaming RPC.
  //
  // Accepts a stream of Points on a route being traversed, returning a
  // RouteSummary when traversal is completed.
  rpc RecordRoute(stream Point) returns (RouteSummary) {}

  // A Bidirectional streaming RPC.
  //
  // Accepts a stream of RouteNotes sent while a route is being traversed,
  // while receiving other RouteNotes (e.g. from other users).
  rpc RouteChat(stream RouteNote) returns (stream RouteNote) {}
}

// Points are represented as latitude-longitude pairs in the E7 representation
// (degrees multiplied by 10**7 and rounded to the nearest integer).
// Latitudes should be in the range +/- 90 degrees and longitude should be in
// the range +/- 180 degrees (inclusive).
message Point {
  int32 latitude = 1;
  int32 longitude = 2;
}

// A latitude-longitude rectangle, represented as two diagonally opposite
// points "lo" and "hi".
message Rectangle {
  // One corner of the rectangle.
  Point lo = 1;

  // The other corner of the rectangle.
  Point hi = 2;
}

// A feature names something at a given point.
//
// If a feature could not be named, the name is empty.
message Feature {
  // The name of the feature.
  string name = 1;

  // The point where the feature is detected.
  Point location = 2;
}

// Not used in the RPC.  Instead, this is here for the form serialized to disk.
message FeatureDatabase {
  repeated Feature feature = 1;
}

// A RouteNote is a message sent while at a given point.
message RouteNote {
  // The location from which the message is sent.
  Point location = 1;

  // The message to be sent.
  string message = 2;
}

// A RouteSummary is received in response to a RecordRoute rpc.
//
// It contains the number of individual points received, the number of
// detected features, and the total distance covered as the cumulative sum of
// the distance between each point.
message RouteSummary {
  // The number of points received.
  int32 point_count = 1;

  // The number of known features passed while traversing the route.
  int32 feature_count = 2;

  // The distance covered in metres.
  int32 distance = 3;

  // The duration of the traversal in seconds.
  int32 elapsed_time = 4;
}
</code></pre> 
<p>然后按照上一篇文章中的那样，使用protobuf-maven-plugin根据proto文件生成Java代码。执行如下两条命令：</p> 
<pre><code class="prism language-shell">mvn protobuf:compile
mvn protobuf:compile-custom
</code></pre> 
<p>生成如下图两个包中的类。</p> 
<p><img src="https://images2.imgbox.com/b0/a5/3Zpg8I1h_o.png" alt=""></p> 
<h3><a id="RPC_Server_157"></a>二、编写RPC Server端</h3> 
<p>在第一步生成代码的基础上编写一个RPC Server端，并让Server端运行起来，大致可分为如下步骤：</p> 
<p>① 重写生成的xxxGrpc.xxxImplBase类的rpc方法，做真正的业务逻辑。<br> ② 创建一个RPC Server，并监听指定的端口。稍微具体点来说就是，使用ServerBuilder.forPort(port)得到一个ServerBuilder对象，然后在此ServerBuilder对象上调用addService方法，方法的参数为①中的类。再调用build方法，建造出一个真正的包含了监听端口信息、提供的服务信息的RPC Server端。<br> ③ 调用②中server的start方法，启动RPC Server。</p> 
<p>那我们接下来就一步一步按照这个流程编写一个RPC Server吧：</p> 
<p>第一步，重写自动生成的xxxImplBase类里面的rpc方法。如下，我们重写了在proto文件中定义的4个rpc方法。关于这4种rpc的参数类型和返回值类型我们后面再讲。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">RouteGuideService</span> <span class="token keyword">extends</span> <span class="token class-name">RouteGuideGrpc<span class="token punctuation">.</span>RouteGuideImplBase</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> features<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> routeNotes <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">RouteGuideService</span><span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> features<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>features <span class="token operator">=</span> features<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets the {@link Feature} at the requested {@link Point}. If no feature at that location
     * exists, an unnamed feature is returned at the provided location.
     *
     * @param request          the requested location for the feature.
     * @param responseObserver the observer that will receive the feature at the requested point.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFeature</span><span class="token punctuation">(</span><span class="token class-name">Point</span> request<span class="token punctuation">,</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> responseObserver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token function">checkFeature</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets all features contained within the given bounding {@link Rectangle}.
     *
     * @param request          the bounding rectangle for the requested features.
     * @param responseObserver the observer that will receive the features.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">listFeatures</span><span class="token punctuation">(</span><span class="token class-name">Rectangle</span> request<span class="token punctuation">,</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> responseObserver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> left <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> right <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> top <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">int</span> bottom <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getLo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getHi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Feature</span> feature <span class="token operator">:</span> features<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> lat <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> lon <span class="token operator">=</span> feature<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lon <span class="token operator">&gt;=</span> left <span class="token operator">&amp;&amp;</span> lon <span class="token operator">&lt;=</span> right <span class="token operator">&amp;&amp;</span> lat <span class="token operator">&gt;=</span> bottom <span class="token operator">&amp;&amp;</span> lat <span class="token operator">&lt;=</span> top<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>feature<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets a stream of points, and responds with statistics about the "trip": number of points,
     * number of known features visited, total distance traveled, and total time spent.
     *
     * @param responseObserver an observer to receive the response summary.
     * @return an observer to receive the requested route points.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> <span class="token function">recordRoute</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteSummary</span><span class="token punctuation">&gt;</span></span> responseObserver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> pointCount<span class="token punctuation">;</span>
        <span class="token keyword">int</span> featureCount<span class="token punctuation">;</span>
        <span class="token keyword">int</span> distance<span class="token punctuation">;</span>
        <span class="token class-name">Point</span> previous<span class="token punctuation">;</span>
        <span class="token keyword">final</span> <span class="token keyword">long</span> startTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">Point</span> point<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          pointCount<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token function">checkFeature</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            featureCount<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token comment">// For each point after the first, add the incremental distance from the previous point to</span>
          <span class="token comment">// the total distance value.</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>previous <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            distance <span class="token operator">+=</span> <span class="token function">calcDistance</span><span class="token punctuation">(</span>previous<span class="token punctuation">,</span> point<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          previous <span class="token operator">=</span> point<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"recordRoute cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">long</span> seconds <span class="token operator">=</span> NANOSECONDS<span class="token punctuation">.</span><span class="token function">toSeconds</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">RouteSummary</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPointCount</span><span class="token punctuation">(</span>pointCount<span class="token punctuation">)</span>
                                      <span class="token punctuation">.</span><span class="token function">setFeatureCount</span><span class="token punctuation">(</span>featureCount<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDistance</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span>
                                      <span class="token punctuation">.</span><span class="token function">setElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> seconds<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Receives a stream of message/location pairs, and responds with a stream of all previous
     * messages at each of those locations.
     *
     * @param responseObserver an observer to receive the stream of previous messages.
     * @return an observer to handle requested message/location pairs.
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> <span class="token function">routeChat</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> responseObserver<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">RouteNote</span> note<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> notes <span class="token operator">=</span> <span class="token function">getOrCreateNotes</span><span class="token punctuation">(</span>note<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">// Respond with all previous notes at this location.</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RouteNote</span> prevNote <span class="token operator">:</span> notes<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RouteNote</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            responseObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>prevNote<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Now add the new note to the list</span>
          notes<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>note<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"routeChat cancelled"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          responseObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Get the notes list for the given location. If missing, create it.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> <span class="token function">getOrCreateNotes</span><span class="token punctuation">(</span><span class="token class-name">Point</span> location<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> notes <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> prevNotes <span class="token operator">=</span> routeNotes<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>location<span class="token punctuation">,</span> notes<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> prevNotes <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> prevNotes <span class="token operator">:</span> notes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Gets the feature at the given point.
     *
     * @param location the location to check.
     * @return The feature object at the point. Note that an empty name indicates no feature.
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Feature</span> <span class="token function">checkFeature</span><span class="token punctuation">(</span><span class="token class-name">Point</span> location<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Feature</span> feature <span class="token operator">:</span> features<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>feature<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> location<span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">&amp;&amp;</span> feature<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> location<span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token keyword">return</span> feature<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// No feature was found, return an unnamed feature.</span>
      <span class="token keyword">return</span> <span class="token class-name">Feature</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLocation</span><span class="token punctuation">(</span>location<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * Calculate the distance between two points using the "haversine" formula.
     * The formula is based on http://mathforum.org/library/drmath/view/51879.html.
     *
     * @param start The starting point
     * @param end   The end point
     * @return The distance between the points in meters
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">calcDistance</span><span class="token punctuation">(</span><span class="token class-name">Point</span> start<span class="token punctuation">,</span> <span class="token class-name">Point</span> end<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> r <span class="token operator">=</span> <span class="token number">6371000</span><span class="token punctuation">;</span> <span class="token comment">// earth radius in meters</span>
      <span class="token keyword">double</span> lat1 <span class="token operator">=</span> <span class="token function">toRadians</span><span class="token punctuation">(</span><span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> lat2 <span class="token operator">=</span> <span class="token function">toRadians</span><span class="token punctuation">(</span><span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> lon1 <span class="token operator">=</span> <span class="token function">toRadians</span><span class="token punctuation">(</span><span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> lon2 <span class="token operator">=</span> <span class="token function">toRadians</span><span class="token punctuation">(</span><span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> deltaLat <span class="token operator">=</span> lat2 <span class="token operator">-</span> lat1<span class="token punctuation">;</span>
      <span class="token keyword">double</span> deltaLon <span class="token operator">=</span> lon2 <span class="token operator">-</span> lon1<span class="token punctuation">;</span>

      <span class="token keyword">double</span> a <span class="token operator">=</span> <span class="token function">sin</span><span class="token punctuation">(</span>deltaLat <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>deltaLat <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span>
          <span class="token operator">+</span> <span class="token function">cos</span><span class="token punctuation">(</span>lat1<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span>lat2<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>deltaLon <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>deltaLon <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">double</span> c <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token function">atan2</span><span class="token punctuation">(</span><span class="token function">sqrt</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>r <span class="token operator">*</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>第②步，创建一个RPC Server对象。<br> 看第二个构造方法，使用ServerBuilder.forPort得到一个SeverBuilder对象，然后传给第三个构造方法去使用。先忽略第三个构造方法中features参数，这个参数是我们自己程序从文件中读出来的的信息，与gRPC框架关系不大。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> port<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Server</span> server<span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">RouteGuideServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> <span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getDefaultFeaturesFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Create a RouteGuide server listening on {@code port} using {@code featureFile} database.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">RouteGuideServer</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">URL</span> featureFile<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">ServerBuilder</span><span class="token punctuation">.</span><span class="token function">forPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">,</span> port<span class="token punctuation">,</span> <span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">parseFeatures</span><span class="token punctuation">(</span>featureFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * Create a RouteGuide server using serverBuilder as a base and features as data.
   */</span>
  <span class="token keyword">public</span> <span class="token class-name">RouteGuideServer</span><span class="token punctuation">(</span><span class="token class-name">ServerBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> serverBuilder<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">,</span> <span class="token class-name">Collection</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> features<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>port <span class="token operator">=</span> port<span class="token punctuation">;</span>
    server <span class="token operator">=</span> serverBuilder<span class="token punctuation">.</span><span class="token function">addService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RouteGuideService</span><span class="token punctuation">(</span>features<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>第③步：调用第②步中创建的Server对象的start方法，启动服务端。</p> 
<pre><code class="prism language-java">  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// 启动服务端</span>
    server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Server started, listening on "</span> <span class="token operator">+</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token annotation punctuation">@Override</span>
      <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// Use stderr here since the logger may have been reset by its JVM shutdown hook.</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"*** shutting down gRPC server since JVM is shutting down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">RouteGuideServer</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"*** server shut down"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> 
<p>成功启动服务端：</p> 
<p><img src="https://images2.imgbox.com/34/34/9mojMH0i_o.png" alt=""></p> 
<h3><a id="RPC_Client_408"></a>三、编写RPC Client端</h3> 
<p>编写完并启动RPC Server后，我们继续编写客户端。<br> 编写客户端也是有范式的，主要有如下几步：</p> 
<p>① 创建一个stub（存根），用来像调用本地方法一样调用RPC方法。<br> ② 调用远程Rpc方法，处理响应。</p> 
<p>好，我们先进行第一步创建stub，stub的话有两种，一种是blocking/synchronous stub；另一种是non-blocking/asynchronous stub。顾名思义，第一种是同步阻塞的stub，第二种是非阻塞异步的stub。在使用客户端流模式和双向流模式时，必须用asynchronous stub。也很好理解，因为如果不是异步的话，发送一个请求就必须同步地等待服务器响应，那就违反了客户端流模式和双向流模式的初衷了。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">RouteGuideClient</span><span class="token punctuation">(</span><span class="token class-name">String</span> host<span class="token punctuation">,</span> <span class="token keyword">int</span> port<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  <span class="token comment">// 创建stub需要用到此ChannelBuilder构造出来的Channel</span>
  <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token class-name">ManagedChannelBuilder</span><span class="token punctuation">.</span><span class="token function">forAddress</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">usePlaintext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/** Construct client for accessing RouteGuide server using the existing channel. */</span>
<span class="token keyword">public</span> <span class="token class-name">RouteGuideClient</span><span class="token punctuation">(</span><span class="token class-name">ManagedChannelBuilder</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> channelBuilder<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  channel <span class="token operator">=</span> channelBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 同步stub</span>
  blockingStub <span class="token operator">=</span> <span class="token class-name">RouteGuideGrpc</span><span class="token punctuation">.</span><span class="token function">newBlockingStub</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 异步stub</span>
  asyncStub <span class="token operator">=</span> <span class="token class-name">RouteGuideGrpc</span><span class="token punctuation">.</span><span class="token function">newStub</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>第②步，调用RPC方法，并处理响应。<br> 下面的代码演示了对四种模式的rpc方法该如何调用。其中的参数类型和返回值类型，我们后面再讲</p> 
<p>简单模式：</p> 
<pre><code class="prism language-java"><span class="token comment">// 构造请求体</span>
<span class="token class-name">Point</span> request <span class="token operator">=</span> <span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLatitude</span><span class="token punctuation">(</span>lat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLongitude</span><span class="token punctuation">(</span>lon<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Feature</span> feature<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
   <span class="token comment">// 调用RPC方法获得返回值对象</span>
  feature <span class="token operator">=</span> blockingStub<span class="token punctuation">.</span><span class="token function">getFeature</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">StatusRuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"RPC failed: {0}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>服务端流模式：</p> 
<pre><code class="prism language-java"><span class="token comment">// 构造请求体</span>
<span class="token class-name">Rectangle</span> request <span class="token operator">=</span>
    <span class="token class-name">Rectangle</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setLo</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLatitude</span><span class="token punctuation">(</span>lowLat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLongitude</span><span class="token punctuation">(</span>lowLon<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">setHi</span><span class="token punctuation">(</span><span class="token class-name">Point</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLatitude</span><span class="token punctuation">(</span>hiLat<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setLongitude</span><span class="token punctuation">(</span>hiLon<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 使用Iterator对象接收响应。</span>
<span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> features<span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
  features <span class="token operator">=</span> blockingStub<span class="token punctuation">.</span><span class="token function">listFeatures</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">StatusRuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"RPC failed: {0}"</span><span class="token punctuation">,</span> e<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>客户端流模式：</p> 
<p>这个代码需要对照服务端的recordRoute方法一起看。<br> 客户端一侧的responseObserver对象是用来处理服务端响应的，asyncStub调用RPC方法recordRoute用responseObserver对象作为参数，方法返回一个StreamObserver对象requestObserver，返回的这个requestObserver对象的onNext和onCompleted等方法的具体逻辑都在服务器端被重写过。使用requestObserver对象的onNext方法来向服务端发送多次请求，使用requestObserver对象的onCompleted标识发送数据结束。然后服务端根据重写的逻辑执行</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recordRoute</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Feature</span><span class="token punctuation">&gt;</span></span> features<span class="token punctuation">,</span> <span class="token keyword">int</span> numPoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"*** RecordRoute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> finishLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteSummary</span><span class="token punctuation">&gt;</span></span> responseObserver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteSummary</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">RouteSummary</span> summary<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Finished trip with {0} points. Passed {1} features. "</span>
          <span class="token operator">+</span> <span class="token string">"Travelled {2} meters. It took {3} seconds."</span><span class="token punctuation">,</span> summary<span class="token punctuation">.</span><span class="token function">getPointCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          summary<span class="token punctuation">.</span><span class="token function">getFeatureCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> summary<span class="token punctuation">.</span><span class="token function">getDistance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> summary<span class="token punctuation">.</span><span class="token function">getElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token function">fromThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
      logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"RecordRoute Failed: {0}"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
      finishLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Finished RecordRoute"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      finishLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> requestObserver <span class="token operator">=</span> asyncStub<span class="token punctuation">.</span><span class="token function">recordRoute</span><span class="token punctuation">(</span>responseObserver<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Send numPoints points randomly selected from the features list.</span>
    <span class="token class-name">Random</span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numPoints<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token keyword">int</span> index <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>features<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Point</span> point <span class="token operator">=</span> features<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Visiting point {0}, {1}"</span><span class="token punctuation">,</span> <span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token class-name">RouteGuideUtil</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      requestObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Sleep for a bit before sending the next one.</span>
      <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>rand<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>finishLatch<span class="token punctuation">.</span><span class="token function">getCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// RPC completed or errored before we finished sending.</span>
        <span class="token comment">// Sending further requests won't error, but they will just be thrown away.</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Cancel RPC</span>
    requestObserver<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Mark the end of requests</span>
  requestObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Receiving happens asynchronously</span>
  finishLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>双向流模式：</p> 
<p>双向流模式的客户端侧代码与客户端流模式一样，区别在于服务端的代码。在客户端流模式下，服务端的onNext()会处理请求参数，然后会在客户端调用onCompleted方法后才返回响应。但是双向流模式下，服务端不必等到客户端调用onCompleted方法后再返回响应，可以直接在onNext方法里就调用传进来的responseObserver的onNext方法返回给客户端响应。如下图：</p> 
<p><img src="https://images2.imgbox.com/59/f8/Xqu84LOk_o.png" alt=""></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">routeChat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
  <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"*** RoutChat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">final</span> <span class="token class-name">CountDownLatch</span> finishLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span> requestObserver <span class="token operator">=</span>
      asyncStub<span class="token punctuation">.</span><span class="token function">routeChat</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">StreamObserver</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RouteNote</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNext</span><span class="token punctuation">(</span><span class="token class-name">RouteNote</span> note<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Got message \"{0}\" at {1}, {2}"</span><span class="token punctuation">,</span> note<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> note<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> note<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onError</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token class-name">Status</span> status <span class="token operator">=</span> <span class="token class-name">Status</span><span class="token punctuation">.</span><span class="token function">fromThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
          logger<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token class-name">Level</span><span class="token punctuation">.</span>WARNING<span class="token punctuation">,</span> <span class="token string">"RouteChat Failed: {0}"</span><span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
          finishLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Finished RouteChat"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          finishLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">RouteNote</span><span class="token punctuation">[</span><span class="token punctuation">]</span> requests <span class="token operator">=</span>
        <span class="token punctuation">{<!-- --></span><span class="token function">newNote</span><span class="token punctuation">(</span><span class="token string">"First message"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newNote</span><span class="token punctuation">(</span><span class="token string">"Second message"</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token function">newNote</span><span class="token punctuation">(</span><span class="token string">"Third message"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">newNote</span><span class="token punctuation">(</span><span class="token string">"Fourth message"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">RouteNote</span> request <span class="token operator">:</span> requests<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      <span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"Sending message \"{0}\" at {1}, {2}"</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">getLatitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span><span class="token function">getLocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLongitude</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      requestObserver<span class="token punctuation">.</span><span class="token function">onNext</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">RuntimeException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token comment">// Cancel RPC</span>
    requestObserver<span class="token punctuation">.</span><span class="token function">onError</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// Mark the end of requests</span>
  requestObserver<span class="token punctuation">.</span><span class="token function">onCompleted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Receiving happens asynchronously</span>
  finishLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MINUTES<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>以下是客户端调用四个方法的截图：</p> 
<p><img src="https://images2.imgbox.com/d9/1c/0D1DHR7X_o.png" alt=""></p> 
<p>完整工程链接：<br> 链接: https://pan.baidu.com/s/1s7uDWJZq3AK4jZmGJZHYfw 提取码: cntr</p> 
<blockquote> 
 <p>参考<br> https://grpc.io/docs/languages/java/basics/</p> 
</blockquote>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/70fb1c4ad969a918d439021b2b858875/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">[Leetcode]5897. 将数组分成两个数组并最小化数组和的差</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/840c0f2c8bdf6046f2ba9c4d9856e45e/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">element Progress 环形进度条渐变样式修改</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>