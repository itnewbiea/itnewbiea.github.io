<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MongoDB通过Shell 实现集合的日常归档 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="MongoDB通过Shell 实现集合的日常归档" />
<meta property="og:description" content="MongoDB通过Shell 实现集合的日常归档
1.MongoDB数据归档的意义
和其他类型的数据库一样，归档对MongoDB同样重要。通过归档，可以保持集合中合适的数据量，对数据库的性能是一种保障，也就是大家常说的数据冷热分离。
同时，归档对数据库的管理也带来了很大方便性，例如日常的备份、灾难恢复等。
在此，不再展开叙述了。
2.集合数据归档流程图
3.归档实现代码
复制代码
The file is used by cron to Archive the data of NeedArchiveColName_Archive collection,the collection is part of NeedArchiveDBColName DB. The file is writed by DBA Carson Xu.If you find any error, please connect with me,thanks. The version is defined V.001 Version ModifyTime ModifyBy Desc Ver001 2019-02-22 14:20 Carson Xu Create the Scripts File !/bin/bash mongodb可执行文件所在文档路径，此例为4.04 ，同时支持3.4.4 command_linebin=&#34;/QQMSG/mongo_db/mongobin404/bin/mongo&#34;
command_linebinT=&#34;/QQMSG/mongo_db/mongobin404/bin/mongo&#34;
存放导出过渡文件的文档路径和文件名字，ColA可用你的集合名字替代 targetpath=&#39;/data/mongodb_back/ArchiveDB_端口号&#39;" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b3406f30a65ff0f29f73ec3658a514cf/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-04-13T17:53:28+08:00" />
<meta property="article:modified_time" content="2019-04-13T17:53:28+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">MongoDB通过Shell 实现集合的日常归档</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <div class="content-detail markdown-body"> 
 <p>MongoDB通过Shell 实现集合的日常归档<br> 1.MongoDB数据归档的意义<br>和其他类型的数据库一样，归档对MongoDB同样重要。通过归档，可以保持集合中合适的数据量，对数据库的性能是一种保障，也就是大家常说的数据冷热分离。</p> 
 <p>同时，归档对数据库的管理也带来了很大方便性，例如日常的备份、灾难恢复等。</p> 
 <p>在此，不再展开叙述了。</p> 
 <p>2.集合数据归档流程图</p> 
 <p>3.归档实现代码<br>复制代码</p> 
 <h2>The file is used by cron to Archive the data of NeedArchiveColName_Archive collection,the collection is part of NeedArchiveDBColName DB.</h2> 
 <h2>The file is writed by DBA Carson Xu.If you find any error, please connect with me,thanks.</h2> 
 <h2>The version is defined V.001</h2> 
 <h2>Version ModifyTime ModifyBy Desc</h2> 
 <h2>Ver001 2019-02-22 14:20 Carson Xu Create the Scripts File</h2> 
 <h2>!/bin/bash</h2> 
 <h6>mongodb可执行文件所在文档路径，此例为4.04 ，同时支持3.4.4</h6> 
 <p>command_linebin="/QQMSG/mongo_db/mongobin404/bin/mongo"<br>command_linebinT="/QQMSG/mongo_db/mongobin404/bin/mongo"</p> 
 <h6>存放导出过渡文件的文档路径和文件名字，ColA可用你的集合名字替代</h6> 
 <p>targetpath='/data/mongodb_back/ArchiveDB_端口号'<br>bakcollectionname=NeedArchiveColName_$(date "+%Y%m%d%H%M")</p> 
 <h6>登入账号信息</h6> 
 <p>username="账号"<br>password="账号密码"</p> 
 <h6>start 设置备份集合的开始日期和结束日期</h6> 
 <p>ParamBakStartDate=$(date -d '-46 days' "+%Y-%m-%d")<br>echo "备份NeedArchiveColName时间参数中的开始时间为：" $ParamBakStartDate </p> 
 <p>ParamBakEndDate=$(date -d '-45 days' "+%Y-%m-%d")<br>echo "备份NeedArchiveColName时间参数中的结束时间为：" $ParamBakEndDate </p> 
 <p>ParamBakStartTimeS="$(date -d $ParamBakStartDate +%s)"</p> 
 <p>ParamBakEndTimeS="$(date -d $ParamBakEndDate +%s)"</p> 
 <p>echo "备份集合的时间转换为UTC时间秒数为：" $ParamBakStartTimeS 和 $ParamBakEndTimeS</p> 
 <p>ParamBakStartTimeMS=$[$ParamBakStartTimeS <em> 1000+8</em>60<em>60</em>1000]<br>ParamBakEndTimeMS=$[$ParamBakEndTimeS <em> 1000+8</em>60<em>60</em>1000]</p> 
 <p>echo "备份集合的时间转换为UTC时间毫秒数为：" $ParamBakStartTimeMS 和 $ParamBakEndTimeMS</p> 
 <h6>end</h6> 
 <h6>start 连接源Server DB ，检查此次集合备份的文档数</h6> 
 <p>command_line="${command_linebin} localhost:端口号/NeedArchiveDBColName -u$username -p$password"<br>export docQty=$(/bin/echo 'db.NeedArchiveColName.find({NeedArchiveByField:{$gte:new Date('"$ParamBakStartDate\"'),$lt:new Date('"$ParamBakEndDate\"')}}).count()' | $command_line --quiet)<br>echo "备份前集合NeedArchiveColName的文档数据为：" $docQty</p> 
 <h6>End</h6> 
 <h6>Start 定义每次备份归档的最大阈值，防止意外情况的发生，例如：参数输入错误</h6> 
 <p>if [ $docQty -gt 2000000 ];then<br> echo "MongoDB-Archive-Exception:NeedArchiveDBColName库NeedArchiveColName集合指定时间段内的文档数过大，超过定义的安全阈值 2000000，归档终止，请检查！"<br> exit<br>fi</p> 
 <h6>end</h6> 
 <h6>start 连接目标Server DB ，检查target DB 上是否已经存在此时间内的文档</h6> 
 <p>command_lineT="${command_linebinT} 归档实例IP:归档实例端口/归档数据库Name -u$username -p$password"<br>export docQtyT=$(/bin/echo 'db.NeedArchiveColName.find({NeedArchiveByField:{$gte:new Date('"$ParamBakStartDate\"'),$lt:new Date('"$ParamBakEndDate\"')}}).count()' | $command_lineT --quiet)<br>echo "备份目标BKDB集合NeedArchiveColName备份归档前的文档数据为：" $docQtyT<br>if [ $docQtyT -gt 0 ];then<br> echo "MongoDB-Archive-Exception:NeedArchiveDBColName库NeedArchiveColName集合检查发现指定时间段内目标数据库目标集合存在异常文档数，归档终止，请检查！"<br> exit<br>fi</p> 
 <h6>end</h6> 
 <h6>start mongoexport 指定集合指定时间段内的文档，输出到指定路径下;并执行检查命令是否正常执行</h6> 
 <p>start()<br>{<!-- --><br>echo "NeedArchiveDBColName库NeedArchiveColName集合备份输出开始"<br>/QQMSG/mongo_db/mongobin404/bin/mongoexport --port 端口号 -u $username -p $password -d NeedArchiveDBColName --authenticationDatabase NeedArchiveDBColName -c NeedArchiveColName -q ' { NeedArchiveByField: { $gte:new Date('$ParamBakStartTimeMS'),$lt:new Date('$ParamBakEndTimeMS') } } ' -o ${targetpath}/${bakcollectionname}<br>echo "NeedArchiveDBColName库NeedArchiveColName集合备份输出完毕"<br>}<br>start<br>execute()<br>{<!-- --><br>if [ $? -eq 0 ]<br>then<br>echo "The MongoDB 集合 NeedArchiveColName 文档mongoexport完成!"<br>else<br>echo "The MongoDB 集合 NeedArchiveColName 文档mongoexport失败"<br>exit<br>fi<br>}</p> 
 <h6>end</h6> 
 <h6>Start mongomongoimport 将导出的备份集合导入到指定的BKDB 指定的集合中</h6> 
 <p>echo "备份输入开始"<br>/QQMSG/mongo_db/mongobin404/bin/mongoimport -h 归档实例IP --port 归档实例端口 -u $username -p $password -d 归档数据库Name --authenticationDatabase 归档数据库Name -c NeedArchiveColName --file ${targetpath}/${bakcollectionname}<br>echo "备份输入完毕"</p> 
 <h6>End</h6> 
 <h6>start 连接目标Server DB ，检查target DB 上是否已经存在此时间内的文档</h6> 
 <p>export docQtyT2=$(/bin/echo 'db.NeedArchiveColName.find({NeedArchiveByField:{$gte:new Date('"$ParamBakStartDate\"'),$lt:new Date('"$ParamBakEndDate\"')}}).count()' | $command_lineT --quiet)<br>echo "备份目标BKDB集合NeedArchiveColName备份归档后的文档数据为：" $docQtyT2</p> 
 <p>echo "比较docQty 和 docQtyT2 的大小"<br>if [ $docQty == $docQtyT2 ]; then</p> 
 <pre><code> echo "正常:时间段内源数据库集合中的文档数  和 目标数据库集合中还原后的文档数据 相等";</code></pre> 
 <p>elif [ $docQty -gt $docQtyT2 ]; then</p> 
 <pre><code>echo "MongoDB-Archive-Exception:时间段内源数据库集合中的文档数  大于  目标数据库集合中还原后的文档数据";
exit</code></pre> 
 <p>else<br> echo "MongoDB-Archive-Exception:时间段内源数据库集合中的文档数 小于 目标数据库集合中还原后的文档数据";<br> exit<br>fi</p> 
 <h6>End</h6> 
 <h6>Start Remove 源数据库源集合指定时间内的记录</h6> 
 <p>docQtyR=$(/bin/echo 'db.NeedArchiveColName.remove({NeedArchiveByField:{$gte:new Date('$ParamBakStartTimeMS'),$lt:new Date('$ParamBakEndTimeMS')}}).nRemoved' | $command_line --quiet)<br>echo "本次操作Remove集合NeedArchiveColName的文档数据为：" $docQtyR</p> 
 <h6>End</h6> 
 <h6>检查 Remove 后集合的文档数</h6> 
 <p>docQty=$(/bin/echo 'db.NeedArchiveColName.find({NeedArchiveByField:{$gte:new Date('"$ParamBakStartDate\"'),$lt:new Date('"$ParamBakEndDate\"')}}).count()' | $command_line --quiet)<br>echo "NeedArchiveDBColName库NeedArchiveColName集合 此次 Remove 后指定时间剩余的文档数据为：" $docQty</p> 
 <h6>End</h6> 
 <h6>删除导出的文件</h6> 
 <p>rm -rf ${targetpath}/${bakcollectionname}<br>if [ $? -eq 0 ]<br>then<br>echo "正常：NeedArchiveDBColName库NeedArchiveColName集合导出的文件被删除:" ${targetpath}/${bakcollectionname}<br>else<br>echo "MongoDB-Archive-Exception:NeedArchiveDBColName库NeedArchiveColName集合导出的文件未被正常删除" ${targetpath}/${bakcollectionname}<br>fi</p> 
 <h6>End</h6> 
 <p>复制代码</p> 
 <ol><li>代码说明<br>4.1 配置基本信息</li></ol> 
 <p>主要包括：mongo bin 可执行文件所在路径；导出过渡文件的定义；归档账号和密码；集合数据保留天数。</p> 
 <p>4.2 代码中关键词<br>明白关键字的含义，可在部署运行前，批量替换</p> 
 <p>代码中关键词 关键词意义<br>NeedArchiveDBColName<br>需要归档的集合所在数据库；<br>NeedArchiveColName<br>需要归档的集合名字；<br>归档数据库Name<br>归档数据库Name<br>NeedArchiveByField<br>归档依据的字段；此例中是Date类型的字段，其他类型还要调试。<br> /QQMSG/mongo_db/mongobin404/bin Mongo 可执行文件所在路径<br> 2000000 归档的最大阈值<br> ArchiveDB_端口号 过渡文件所放的位置，一个数据库一个文档。不用细化到集合<br>端口号 端口号分为源库所在实例端口，和目标库所在实例端口<br>4.3 在本例中，源库和目标库设置了相同的归档账号和对应密码<br>4.4 通过crontab 实现日常归档，执行信息（异常错误）重定向到log文件<br>归档实现代码保存到文件中，通过crontab设置文件的定时任务，实现日常归档。</p> 
 <p>执行情况 重定向（ &gt;&gt;）到指定文件。通过指定文件的监视可实现监控归档的执行情况。<br>原文地址<a href="https://www.cnblogs.com/xuliuzai/p/10698241.html" rel="nofollow">https://www.cnblogs.com/xuliuzai/p/10698241.html</a></p> 
</div>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/72169ad7044f8ac6764c99c1a31aa734/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">如何在notepad&#43;&#43;运行python代码</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/affe842e02eb42e47b1ea526f5f8ec37/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">如何禁止HTML中div点击事件</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>