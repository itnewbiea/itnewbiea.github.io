<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Ribbon架构篇 - ZoneAvoidanceRule - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Ribbon架构篇 - ZoneAvoidanceRule" />
<meta property="og:description" content="前言 ZoneAvoidanceRule 基于分区下的服务器的可用性选出可用分区列表，再从可用分区列表中随机选择一个分区，采用轮询的策略选择该分区的一个服务器。
ZoneAwareLoadBalancer 属性属性描述默认值ZoneAwareNIWSDiscoveryLoadBalancer.enabled是否开启ZoneAwareLoadBalancertrueniws.loadbalancer.default.connectionFailureCountThreshold连接失败的数量的阈值3niws.loadbalancer.default.circuitTripTimeoutFactorSeconds断路器打开的超时时间因子10niws.loadbalancer.default.circuitTripMaxTimeoutSeconds断路器打开的超时时间阈值30ZoneAwareNIWSDiscoveryLoadBalancer.default.triggeringLoadPerServerThreshold每台服务器的负载的阈值0.2niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds活跃请求数发生变化的超时时间600ZoneAwareNIWSDiscoveryLoadBalancer.default.avoidZoneWithBlackoutPercetage服务器故障率阈值0.99999 @Override public Server chooseServer(Object key) { // 如果没有开启 ZoneAwareLoadBalancer 或者 LoadBalancerStats记录的可用分区数 &lt;= 1 // 则执行 BaseLoadBalancer#chooseServer(...) 的逻辑 if (!ENABLED.get() || getLoadBalancerStats().getAvailableZones().size() &lt;= 1) { logger.debug(&#34;Zone aware logic disabled or there is only one zone&#34;); return super.chooseServer(key); } Server server = null; try { LoadBalancerStats lbStats = getLoadBalancerStats(); // 创建分区快照 Map&lt;String, ZoneSnapshot&gt; zoneSnapshot = ZoneAvoidanceRule.createSnapshot(lbStats); logger.debug(&#34;Zone snapshots: {}&#34;, zoneSnapshot); if (triggeringLoad == null) { triggeringLoad = DynamicPropertyFactory." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/3455563838fc30ac390caa23a736ac9a/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-13T20:47:39+08:00" />
<meta property="article:modified_time" content="2022-11-13T20:47:39+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Ribbon架构篇 - ZoneAvoidanceRule</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atelier-sulphurpool-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h2><a id="_4"></a>前言</h2> 
<p>ZoneAvoidanceRule 基于分区下的服务器的可用性选出可用分区列表，再从可用分区列表中随机选择一个分区，采用轮询的策略选择该分区的一个服务器。</p> 
<h2><a id="ZoneAwareLoadBalancer_11"></a>ZoneAwareLoadBalancer</h2> 
<table><thead><tr><th>属性</th><th>属性描述</th><th>默认值</th></tr></thead><tbody><tr><td>ZoneAwareNIWSDiscoveryLoadBalancer.enabled</td><td>是否开启ZoneAwareLoadBalancer</td><td>true</td></tr><tr><td>niws.loadbalancer.default.connectionFailureCountThreshold</td><td>连接失败的数量的阈值</td><td>3</td></tr><tr><td>niws.loadbalancer.default.circuitTripTimeoutFactorSeconds</td><td>断路器打开的超时时间因子</td><td>10</td></tr><tr><td>niws.loadbalancer.default.circuitTripMaxTimeoutSeconds</td><td>断路器打开的超时时间阈值</td><td>30</td></tr><tr><td>ZoneAwareNIWSDiscoveryLoadBalancer.default.triggeringLoadPerServerThreshold</td><td>每台服务器的负载的阈值</td><td>0.2</td></tr><tr><td>niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds</td><td>活跃请求数发生变化的超时时间</td><td>600</td></tr><tr><td>ZoneAwareNIWSDiscoveryLoadBalancer.default.avoidZoneWithBlackoutPercetage</td><td>服务器故障率阈值</td><td>0.99999</td></tr></tbody></table> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">// 如果没有开启 ZoneAwareLoadBalancer 或者 LoadBalancerStats记录的可用分区数 &lt;= 1</span>
		<span class="token comment">// 则执行 BaseLoadBalancer#chooseServer(...) 的逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token constant">ENABLED</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAvailableZones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Zone aware logic disabled or there is only one zone"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">chooseServer</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token class-name">Server</span> server <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">LoadBalancerStats</span> lbStats <span class="token operator">=</span> <span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 创建分区快照</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span> zoneSnapshot <span class="token operator">=</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">.</span><span class="token function">createSnapshot</span><span class="token punctuation">(</span>lbStats<span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Zone snapshots: {}"</span><span class="token punctuation">,</span> zoneSnapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>triggeringLoad <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            triggeringLoad <span class="token operator">=</span> <span class="token class-name">DynamicPropertyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDoubleProperty</span><span class="token punctuation">(</span>
                    <span class="token string">"ZoneAwareNIWSDiscoveryLoadBalancer."</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".triggeringLoadPerServerThreshold"</span><span class="token punctuation">,</span> <span class="token number">0.2d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>triggeringBlackoutPercentage <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            triggeringBlackoutPercentage <span class="token operator">=</span> <span class="token class-name">DynamicPropertyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDoubleProperty</span><span class="token punctuation">(</span>
                    <span class="token string">"ZoneAwareNIWSDiscoveryLoadBalancer."</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".avoidZoneWithBlackoutPercetage"</span><span class="token punctuation">,</span> <span class="token number">0.99999d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// 获取可用的分区集合</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableZones <span class="token operator">=</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">.</span><span class="token function">getAvailableZones</span><span class="token punctuation">(</span>zoneSnapshot<span class="token punctuation">,</span> triggeringLoad<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> triggeringBlackoutPercentage<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Available zones: {}"</span><span class="token punctuation">,</span> availableZones<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>availableZones <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span>  availableZones<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> zoneSnapshot<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">// 从可用的分区集合中随机选择一个分区</span>
            <span class="token class-name">String</span> zone <span class="token operator">=</span> <span class="token class-name">ZoneAvoidanceRule</span><span class="token punctuation">.</span><span class="token function">randomChooseZone</span><span class="token punctuation">(</span>zoneSnapshot<span class="token punctuation">,</span> availableZones<span class="token punctuation">)</span><span class="token punctuation">;</span>
            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Zone chosen: {}"</span><span class="token punctuation">,</span> zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>zone <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">// 从缓存中获取分区对应的负载均衡器，初始会创建 BaseLoadBalancer 负载均衡器</span>
                <span class="token class-name">BaseLoadBalancer</span> zoneLoadBalancer <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 默认采用轮询的策略从服务器列表中选择一个服务器</span>
                server <span class="token operator">=</span> zoneLoadBalancer<span class="token punctuation">.</span><span class="token function">chooseServer</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Error choosing server using zone aware logic for load balancer={}"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> server<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"Zone avoidance logic is not invoked."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">chooseServer</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>1、先获取可用分区集合。</p> 
<p>可用分区选取的策略如下：</p> 
<ul><li>如果只有一个分区，则选择该分区作为可用分区。</li><li>如果有多个分区，满足分区下的服务器数量大于0、服务器故障率小于阈值的、再随机排除一个服务器的负载大于平均负载的分区，作为可用分区，添加到可用分区集合中。</li></ul> 
<p>2、从可用分区集合中选择一个分区。</p> 
<p>选择策略：累加每个可用分区中的服务器数量，基于这个总数生成一个随机数，找到对应服务器所在的分区。</p> 
<p>3、从缓存中获取分区对应的负载均衡器，默认采用轮询的策略从服务器列表中选择一个服务器。</p> 
<hr> 
<p><strong>1.1 ZoneAvoidanceRule#createSnapshot</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span> <span class="token function">createSnapshot</span><span class="token punctuation">(</span><span class="token class-name">LoadBalancerStats</span> lbStats<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 遍历 LoadBalancerStats 存储的所有可用分区（即 LoadBalancerStats#upServerListZoneMap 的所有key）</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> zone <span class="token operator">:</span> lbStats<span class="token punctuation">.</span><span class="token function">getAvailableZones</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// 获取指定分区的分区快照</span>
        <span class="token class-name">ZoneSnapshot</span> snapshot <span class="token operator">=</span> lbStats<span class="token punctuation">.</span><span class="token function">getZoneSnapshot</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 将 &lt;分区,分区快照&gt; 加入到缓存中</span>
        map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> snapshot<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> map<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>创建分区快照。</p> 
<p><strong>LoadBalancerStats#getZoneSnapshot</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ZoneSnapshot</span> <span class="token function">getZoneSnapshot</span><span class="token punctuation">(</span><span class="token class-name">String</span> zone<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 如果分区为空，则创建新的分区快照并返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zone <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 将分区名小写</span>
    zone <span class="token operator">=</span> zone<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 从缓存中获取指定分区的服务器列表</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> currentList <span class="token operator">=</span> upServerListZoneMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 获取指定服务器列表的分区快照</span>
    <span class="token keyword">return</span> <span class="token function">getZoneSnapshot</span><span class="token punctuation">(</span>currentList<span class="token punctuation">)</span><span class="token punctuation">;</span>        
<span class="token punctuation">}</span>
</code></pre> 
<p>获取指定分区的分区快照。</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">ZoneSnapshot</span> <span class="token function">getZoneSnapshot</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 如果服务器列表为空或者数量为0，则创建分区快照并返回</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>servers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> instanceCount <span class="token operator">=</span> servers<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> activeConnectionsCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> activeConnectionsCountOnAvailableServer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> circuitBreakerTrippedCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> loadPerServer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> currentTime <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 遍历所有服务器</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Server</span> server<span class="token operator">:</span> servers<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 从serverStatsCache缓存中获取对应服务器的状态</span>
        <span class="token class-name">ServerStats</span> stat <span class="token operator">=</span> <span class="token function">getSingleServerStat</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>  
      	<span class="token comment">// 如果服务器对应的断路器打开，则记录触发断路器打开的服务器数量加一</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>stat<span class="token punctuation">.</span><span class="token function">isCircuitBreakerTripped</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            circuitBreakerTrippedCount<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token comment">// 否则累加可用的服务器的活跃连接数</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            activeConnectionsCountOnAvailableServer <span class="token operator">+=</span> stat<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// 累加服务器的活跃连接数</span>
        activeConnectionsCount <span class="token operator">+=</span> stat<span class="token punctuation">.</span><span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span>currentTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 如果所有服务器对应的断路器都处于打开状态，则记录每台服务器的负载为 -1</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitBreakerTrippedCount <span class="token operator">==</span> instanceCount<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceCount <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            loadPerServer <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token comment">// 否则记录服务器的平均负载 = 可用的服务器的活跃连接数 / 可用的服务器的数量(即 服务器数量 - 触发断路器打开的服务器数量)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        loadPerServer <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> activeConnectionsCountOnAvailableServer<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span>instanceCount <span class="token operator">-</span> circuitBreakerTrippedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">(</span>instanceCount<span class="token punctuation">,</span> circuitBreakerTrippedCount<span class="token punctuation">,</span> activeConnectionsCount<span class="token punctuation">,</span> loadPerServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>计算服务器的平均负载。</p> 
<p>根据服务器总数量、触发断路器打开的服务器数量、活跃连接数、服务器的平均负载创建分区快照。</p> 
<hr> 
<p><strong>ServerStats#isCircuitBreakerTripped</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isCircuitBreakerTripped</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 获取断路器打开的超时截止时间</span>
    <span class="token keyword">long</span> circuitBreakerTimeout <span class="token operator">=</span> <span class="token function">getCircuitBreakerTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>circuitBreakerTimeout <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 判断断路器打开的超时截止时间 &gt; 当前时间</span>
    <span class="token keyword">return</span> circuitBreakerTimeout <span class="token operator">&gt;</span> currentTime<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>判断断路器是否打开。</p> 
<p>策略如下：</p> 
<ul><li>断路器处于关闭状态： 
  <ul><li>断路器打开的超时截止时间 &lt;= 0</li><li>0 &lt; 断路器打开的超时截止时间 &lt;= 当前时间</li></ul> </li><li>断路器处于开启状态： 
  <ul><li>断路器打开的超时截止时间 &gt; 当前时间</li></ul> </li></ul> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getCircuitBreakerTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 获取断路器打开的持续时间</span>
    <span class="token keyword">long</span> blackOutPeriod <span class="token operator">=</span> <span class="token function">getCircuitBreakerBlackoutPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blackOutPeriod <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 上一次连接失败的时间 + 断路器打开的持续时间</span>
    <span class="token keyword">return</span> lastConnectionFailedTimestamp <span class="token operator">+</span> blackOutPeriod<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>获取断路器打开的超时截止时间。</p> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">getCircuitBreakerBlackoutPeriod</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 连续连接失败的次数</span>
    <span class="token keyword">int</span> failureCount <span class="token operator">=</span> successiveConnectionFailureCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 连接失败的数量的阈值（默认3）</span>
    <span class="token keyword">int</span> threshold <span class="token operator">=</span> connectionFailureThreshold<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>failureCount <span class="token operator">&lt;</span> threshold<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> diff <span class="token operator">=</span> <span class="token punctuation">(</span>failureCount <span class="token operator">-</span> threshold<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">16</span> <span class="token operator">?</span> <span class="token number">16</span> <span class="token operator">:</span> <span class="token punctuation">(</span>failureCount <span class="token operator">-</span> threshold<span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 2 * diff * 断路器打开的超时时间因子</span>
    <span class="token keyword">int</span> blackOutSeconds <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> diff<span class="token punctuation">)</span> <span class="token operator">*</span> circuitTrippedTimeoutFactor<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blackOutSeconds <span class="token operator">&gt;</span> maxCircuitTrippedTimeout<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        blackOutSeconds <span class="token operator">=</span> maxCircuitTrippedTimeout<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> blackOutSeconds <span class="token operator">*</span> <span class="token number">1000L</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>niws.loadbalancer.default.connectionFailureCountThreshold：连接失败的数量的阈值，默认3</p> 
 <p>niws.loadbalancer.default.circuitTripTimeoutFactorSeconds：断路器打开的超时时间因子，默认10</p> 
 <p>niws.loadbalancer.default.circuitTripMaxTimeoutSeconds：断路器打开的超时时间阈值，默认30</p> 
</blockquote> 
<p>获取断路器打开的持续时间。</p> 
<p>策略如下：</p> 
<ul><li> <p>如果连续连接失败的次数 &lt; 连续失败的数量的阈值（默认3），返回0。</p> </li><li> <p>计算 diff：【16， 连续连接失败的次数 - 连续失败的数量的阈值（默认3）】取最小值。</p> </li><li> <p>计算断路器打开的持续时间：【2 * diff * 断路器打开的超时因子，断路器打开的超时时间阈值】取最小值。</p> </li></ul> 
<hr> 
<p><strong>ServerStats#getActiveRequestCount</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getActiveRequestsCount</span><span class="token punctuation">(</span><span class="token keyword">long</span> currentTime<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
  	<span class="token comment">// 活跃请求数  </span>
  	<span class="token keyword">int</span> count <span class="token operator">=</span> activeRequestsCount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果活跃请求数 &gt; 0 并且 当前时间 - 上一次的活跃请求数发生变化的时间 &gt; 活跃请求数发生变化的超时时间，</span>
    <span class="token comment">// 则重置活跃请求数为0</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTime <span class="token operator">-</span> lastActiveRequestsCountChangeTimestamp <span class="token operator">&gt;</span> activeRequestsCountTimeout<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">||</span> count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        activeRequestsCount<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> count<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>niws.loadbalancer.serverStats.activeRequestsCount.effectiveWindowSeconds：活跃请求数发生变化的超时时间，默认600</p> 
</blockquote> 
<p>获取活跃请求数。</p> 
<hr> 
<p><strong>1.2 ZoneAvoidanceRule#getAvailableZones</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAvailableZones</span><span class="token punctuation">(</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span> snapshot<span class="token punctuation">,</span> <span class="token keyword">double</span> triggeringLoad<span class="token punctuation">,</span>
        <span class="token keyword">double</span> triggeringBlackoutPercentage<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 用分区快照中存储的分区集合初始化可用分区集合</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> availableZones <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>snapshot<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 如果分区快照中只有一个分区，则直接返回该分区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>availableZones<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> availableZones<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> worstZones <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">double</span> maxLoadPerServer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">boolean</span> limitedZoneAvailability <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span> zoneEntry <span class="token operator">:</span> snapshot<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 分区</span>
        <span class="token class-name">String</span> zone <span class="token operator">=</span> zoneEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 分区快照</span>
        <span class="token class-name">ZoneSnapshot</span> zoneSnapshot <span class="token operator">=</span> zoneEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> instanceCount <span class="token operator">=</span> zoneSnapshot<span class="token punctuation">.</span><span class="token function">getInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 如果分区快照中记录的服务器数量为0，则从可用分区集合中剔除该分区，并且设置分区可用性受限</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instanceCount <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            availableZones<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
            limitedZoneAvailability <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">double</span> loadPerServer <span class="token operator">=</span> zoneSnapshot<span class="token punctuation">.</span><span class="token function">getLoadPerServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          	<span class="token comment">// 如果 触发断路器打开的服务器数量 / 服务器总数量 &gt;= 服务器故障率阈值 或者 每台服务器的负载 &lt; 0，</span>
          	<span class="token comment">// 则从可用分区集合中移除该分区，并且设置分区可用性受限</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">)</span> zoneSnapshot<span class="token punctuation">.</span><span class="token function">getCircuitTrippedCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token operator">/</span> instanceCount <span class="token operator">&gt;=</span> triggeringBlackoutPercentage
                    <span class="token operator">||</span> loadPerServer <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                availableZones<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                limitedZoneAvailability <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
              	<span class="token comment">// 如果每台服务器的负载接近最大负载</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>loadPerServer <span class="token operator">-</span> maxLoadPerServer<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0.000001d</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">// 从最差的分区集合中添加该分区</span>
                    worstZones<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 如果每台服务器的负载 &gt; 最大负载</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>loadPerServer <span class="token operator">&gt;</span> maxLoadPerServer<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                  	<span class="token comment">// 重置最大负载</span>
                    maxLoadPerServer <span class="token operator">=</span> loadPerServer<span class="token punctuation">;</span>
                  	<span class="token comment">// 清空最差的分区集合</span>
                    worstZones<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                  	<span class="token comment">// 从最差的分区集合中添加该分区</span>
                    worstZones<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>maxLoadPerServer <span class="token operator">&lt;</span> triggeringLoad <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>limitedZoneAvailability<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> availableZones<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 从最差的分区集合中随机选择一个分区</span>
    <span class="token class-name">String</span> zoneToAvoid <span class="token operator">=</span> <span class="token function">randomChooseZone</span><span class="token punctuation">(</span>snapshot<span class="token punctuation">,</span> worstZones<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>zoneToAvoid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 从可用分区中移除该分区</span>
        availableZones<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>zoneToAvoid<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> availableZones<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> 
<blockquote> 
 <p>ZoneAwareNIWSDiscoveryLoadBalancer.default.avoidZoneWithBlackoutPercetage：服务器故障率，默认0.99999d。</p> 
</blockquote> 
<p>获取可用分区。</p> 
<p>可用分区选取的策略如下：</p> 
<ul><li> <p>如果只有一个分区，则选择该分区作为可用分区。</p> </li><li> <p>如果有多个分区，满足分区下的服务器数量大于0、服务器故障率小于阈值的、再随机排除一个服务器的负载大于平均负载的分区，作为可用分区。</p> </li></ul> 
<hr> 
<p><strong>1.3 ZoneAvoidanceRule#randomChooseZone</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">randomChooseZone</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">ZoneSnapshot</span><span class="token punctuation">&gt;</span></span> snapshot<span class="token punctuation">,</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> chooseFrom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chooseFrom <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> chooseFrom<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">String</span> selectedZone <span class="token operator">=</span> chooseFrom<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  	<span class="token comment">// 如果只有一个分区，则直接返回该分区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>chooseFrom<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> selectedZone<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">int</span> totalServerCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  	<span class="token comment">// 遍历所有分区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> zone <span class="token operator">:</span> chooseFrom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 累加每个分区下的服务器数量，获取服务器总数量</span>
        totalServerCount <span class="token operator">+=</span> snapshot<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 生成一个随机数</span>
    <span class="token keyword">int</span> index <span class="token operator">=</span> random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span>totalServerCount<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  	<span class="token comment">// 遍历所有分区</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> zone <span class="token operator">:</span> chooseFrom<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
      	<span class="token comment">// 累加服务器数量</span>
        sum <span class="token operator">+=</span> snapshot<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getInstanceCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 如果随机数小于等于上面的sum，则返回该分区</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">&lt;=</span> sum<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            selectedZone <span class="token operator">=</span> zone<span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> selectedZone<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>累加每个可用分区中的服务器数量，基于这个总数生成一个随机数，找到对应服务器所在的分区。</p> 
<hr> 
<p><strong>1.4 ZoneAwareLoadBalancer#getLoadBalancer</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@VisibleForTesting</span>
<span class="token class-name">BaseLoadBalancer</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token class-name">String</span> zone<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    zone <span class="token operator">=</span> zone<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 从缓存中获取分区对应的负载均衡器</span>
    <span class="token class-name">BaseLoadBalancer</span> loadBalancer <span class="token operator">=</span> balancers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>zone<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 如果缓存未命中</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>loadBalancer <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">IRule</span> rule <span class="token operator">=</span> <span class="token function">cloneRule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRule</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      	<span class="token comment">// 创建新的负载均衡器</span>
        loadBalancer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BaseLoadBalancer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"_"</span> <span class="token operator">+</span> zone<span class="token punctuation">,</span> rule<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLoadBalancerStats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 放到缓存中</span>
      	<span class="token class-name">BaseLoadBalancer</span> prev <span class="token operator">=</span> balancers<span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span>zone<span class="token punctuation">,</span> loadBalancer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>prev <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
           loadBalancer <span class="token operator">=</span> prev<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> 
    <span class="token keyword">return</span> loadBalancer<span class="token punctuation">;</span>        
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p><strong>1.5 BaseLoadBalancer#chooseServer</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">chooseServer</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        counter <span class="token operator">=</span> <span class="token function">createCounter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    counter<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>rule <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
          	<span class="token comment">// PredicateBasedRule#choose </span>
            <span class="token keyword">return</span> rule<span class="token punctuation">.</span><span class="token function">choose</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"LoadBalancer [{}]:  Error choosing server for key {}"</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> key<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<hr> 
<p><strong>1.6 PredicateBasedRule#choose</strong></p> 
<pre><code class="prism language-java"><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">Server</span> <span class="token function">choose</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">ILoadBalancer</span> lb <span class="token operator">=</span> <span class="token function">getLoadBalancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> server <span class="token operator">=</span> <span class="token function">getPredicate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span>lb<span class="token punctuation">.</span><span class="token function">getAllServers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>server<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>       
<span class="token punctuation">}</span>
</code></pre> 
<p><strong>AbstractServerPredicate</strong></p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> <span class="token function">chooseRoundRobinAfterFiltering</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> servers<span class="token punctuation">,</span> <span class="token class-name">Object</span> loadBalancerKey<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Server</span><span class="token punctuation">&gt;</span></span> eligible <span class="token operator">=</span> <span class="token function">getEligibleServers</span><span class="token punctuation">(</span>servers<span class="token punctuation">,</span> loadBalancerKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">absent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  	<span class="token comment">// 采用轮询的策略选择服务器</span>
    <span class="token keyword">return</span> <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span>eligible<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<pre><code class="prism language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">incrementAndGetModulo</span><span class="token punctuation">(</span><span class="token keyword">int</span> modulo<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">int</span> current <span class="token operator">=</span> nextIndex<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 采用轮询的策略</span>
        <span class="token keyword">int</span> next <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> modulo<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>nextIndex<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> current <span class="token operator">&lt;</span> modulo<span class="token punctuation">)</span>
            <span class="token keyword">return</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/13c2a8e277c1654a9f0404561b82c66c/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">OpenCASCADE（OCC）x86环境的配置以及在MFC中的应用（初探）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/582e88d17bab1ffeda947a6b77c89c3d/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Hyper-V安装（Windows11为例）</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>