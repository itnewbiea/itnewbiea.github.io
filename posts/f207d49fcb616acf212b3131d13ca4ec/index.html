<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mars3d的BusineDataLayer应该传data格式实现聚合效果 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mars3d的BusineDataLayer应该传data格式实现聚合效果" />
<meta property="og:description" content="问题：
1.通过【Mars3d】加载new mars3d.layer.BusineDataLayer(的如果不用url使用data的话，格式应该是什么样子的呢？
相关说明：实质就是就是GraphicLayer，自己加graphic进去。
使用data的话要否需要用onCreateGraphic代替symbol吗实现添加矢量的效果？
回复：
相关data的格式使用.相关代码：
import * as mars3d from &#34;mars3d&#34;
export let map // mars3d.Map三维地图对象
export let graphicLayer // 矢量图层对象
// 需要覆盖config.json中地图属性参数（当前示例框架中自动处理合并）
export const mapOptions = {
scene: {
center: {&#34;lat&#34;:32.632367,&#34;lng&#34;:118.899899,&#34;alt&#34;:4713595.4,&#34;heading&#34;:348,&#34;pitch&#34;:-69}
}
}
/**
* 初始化地图业务，生命周期钩子函数（必须）
* 框架在地图初始化完成后自动调用该函数
* @param {mars3d.Map} mapInstance 地图对象
* @returns {void} 无
*/
export function onMounted(mapInstance) {
map = mapInstance // 记录map
addBusinessLayer()
}
let historyFiresRes = {
&#34;msg&#34;: &#34;success&#34;,
&#34;code&#34;: 0," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f207d49fcb616acf212b3131d13ca4ec/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-03T10:35:11+08:00" />
<meta property="article:modified_time" content="2024-01-03T10:35:11+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mars3d的BusineDataLayer应该传data格式实现聚合效果</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>问题：</p> 
<p>1.通过【Mars3d】加载new mars3d.layer.BusineDataLayer(的如果不用url使用data的话，格式应该是什么样子的呢？</p> 
<p>相关说明：实质就是就是GraphicLayer，自己加graphic进去。</p> 
<p>使用data的话要否需要用onCreateGraphic代替symbol吗实现添加矢量的效果？</p> 
<p>回复：</p> 
<p>相关data的格式使用.相关代码：</p> 
<p>import * as mars3d from "mars3d"</p> 
<p></p> 
<p>export let map // mars3d.Map三维地图对象</p> 
<p>export let graphicLayer // 矢量图层对象</p> 
<p></p> 
<p>// 需要覆盖config.json中地图属性参数（当前示例框架中自动处理合并）</p> 
<p>export const mapOptions = {<!-- --></p> 
<p>  scene: {<!-- --></p> 
<p>    center: {"lat":32.632367,"lng":118.899899,"alt":4713595.4,"heading":348,"pitch":-69}</p> 
<p>  }</p> 
<p>}</p> 
<p></p> 
<p>/**</p> 
<p> * 初始化地图业务，生命周期钩子函数（必须）</p> 
<p> * 框架在地图初始化完成后自动调用该函数</p> 
<p> * @param {mars3d.Map} mapInstance 地图对象</p> 
<p> * @returns {void} 无</p> 
<p> */</p> 
<p>export function onMounted(mapInstance) {<!-- --></p> 
<p>  map = mapInstance // 记录map</p> 
<p><br>  </p> 
<p>  addBusinessLayer()</p> 
<p>}</p> 
<p><br><br>  </p> 
<p>let historyFiresRes = {<!-- --></p> 
<p>  "msg": "success",</p> 
<p>  "code": 0,</p> 
<p>  "data": [</p> 
<p>    {<!-- --></p> 
<p>      "acq_time": "0454",</p> 
<p>      "frp": 1.7,</p> 
<p>      "year": "2019",</p> 
<p>      "acq_date": "2019-12-04",</p> 
<p>      "latitude": 40.81285,</p> 
<p>      "confidence": "n",</p> 
<p>      "scan": 0.39,</p> 
<p>      "instrument": "VIIRS",</p> 
<p>      "geom": "POINT(118.5964 40.81285)",</p> 
<p>      "version": "2.0NRT",</p> 
<p>      "brightness": 327.7,</p> 
<p>      "bright_t31": 280.7,</p> 
<p>      "daynight": "D",</p> 
<p>      "id": 1,</p> 
<p>      "satellite": "1",</p> 
<p>      "track": 0.36,</p> 
<p>      "longitude": 118.5964</p> 
<p>    },</p> 
<p>    {<!-- --></p> 
<p>      "acq_time": "0500",</p> 
<p>      "frp": 3.2,</p> 
<p>      "year": "2019",</p> 
<p>      "acq_date": "2019-12-09",</p> 
<p>      "latitude": 41.2258,</p> 
<p>      "confidence": "n",</p> 
<p>      "scan": 0.39,</p> 
<p>      "instrument": "VIIRS",</p> 
<p>      "geom": "POINT(118.77624 41.2258)",</p> 
<p>      "version": "2.0NRT",</p> 
<p>      "brightness": 344.2,</p> 
<p>      "bright_t31": 281.6,</p> 
<p>      "daynight": "D",</p> 
<p>      "id": 2,</p> 
<p>      "satellite": "1",</p> 
<p>      "track": 0.36,</p> 
<p>      "longitude": 118.77624</p> 
<p>    },</p> 
<p>    {<!-- --></p> 
<p>      "acq_time": "1800",</p> 
<p>      "frp": 0.4,</p> 
<p>      "year": "2019",</p> 
<p>      "acq_date": "2019-12-12",</p> 
<p>      "latitude": 40.52177,</p> 
<p>      "confidence": "n",</p> 
<p>      "scan": 0.38,</p> 
<p>      "instrument": "VIIRS",</p> 
<p>      "geom": "POINT(117.60754 40.52177)",</p> 
<p>      "version": "2.0NRT",</p> 
<p>      "brightness": 296.8,</p> 
<p>      "bright_t31": 267.7,</p> 
<p>      "daynight": "N",</p> 
<p>      "id": 3,</p> 
<p>      "satellite": "1",</p> 
<p>      "track": 0.36,</p> 
<p>      "longitude": 117.60754</p> 
<p>    },</p> 
<p>    {<!-- --></p> 
<p>      "acq_time": "1724",</p> 
<p>      "frp": 1,</p> 
<p>      "year": "2019",</p> 
<p>      "acq_date": "2019-12-14",</p> 
<p>      "latitude": 40.73357,</p> 
<p>      "confidence": "n",</p> 
<p>      "scan": 0.52,</p> 
<p>      "instrument": "VIIRS",</p> 
<p>      "geom": "POINT(118.43446 40.73357)",</p> 
<p>      "version": "2.0NRT",</p> 
<p>      "brightness": 301.9,</p> 
<p>      "bright_t31": 261.3,</p> 
<p>      "daynight": "N",</p> 
<p>      "id": 4,</p> 
<p>      "satellite": "1",</p> 
<p>      "track": 0.5,</p> 
<p>      "longitude": 118.43446</p> 
<p>    },</p> 
<p>    {<!-- --></p> 
<p>      "acq_time": "1824",</p> 
<p>      "frp": 0.7,</p> 
<p>      "year": "2019",</p> 
<p>      "acq_date": "2019-12-16",</p> 
<p>      "latitude": 40.59779,</p> 
<p>      "confidence": "n",</p> 
<p>      "scan": 0.41,</p> 
<p>      "instrument": "VIIRS",</p> 
<p>      "geom": "POINT(118.62975 40.59779)",</p> 
<p>      "version": "2.0NRT",</p> 
<p>      "brightness": 297.9,</p> 
<p>      "bright_t31": 271.7,</p> 
<p>      "daynight": "N",</p> 
<p>      "id": 5,</p> 
<p>      "satellite": "1",</p> 
<p>      "track": 0.45,</p> 
<p>      "longitude": 118.62975</p> 
<p>    },</p> 
<p>    {<!-- --></p> 
<p>      "acq_time": "1824",</p> 
<p>      "frp": 1.4,</p> 
<p>      "year": "2019",</p> 
<p>      "acq_date": "2019-12-16",</p> 
<p>      "latitude": 40.52311,</p> 
<p>      "confidence": "n",</p> 
<p>      "scan": 0.55,</p> 
<p>      "instrument": "VIIRS",</p> 
<p>      "geom": "POINT(117.60539 40.52311)",</p> 
<p>      "version": "2.0NRT",</p> 
<p>      "brightness": 296.3,</p> 
<p>      "bright_t31": 269.8,</p> 
<p>      "daynight": "N",</p> 
<p>      "id": 6,</p> 
<p>      "satellite": "1",</p> 
<p>      "track": 0.43,</p> 
<p>      "longitude": 117.60539</p> 
<p>    }</p> 
<p>  ]</p> 
<p>}</p> 
<p>function addBusinessLayer() {<!-- --></p> 
<p>  // 创建矢量数据图层（业务数据图层）</p> 
<p>  graphicLayer = new mars3d.layer.BusineDataLayer({<!-- --></p> 
<p>    data: historyFiresRes,</p> 
<p>    dataColumn: "data", // 数据接口中对应列表所在的取值字段名</p> 
<p>    lngColumn: "longitude",</p> 
<p>    latColumn: "latitude",</p> 
<p>    // 点的聚合配置</p> 
<p>    clustering: {<!-- --></p> 
<p>      enabled: true,</p> 
<p>      pixelRange: 10,</p> 
<p>      clampToGround: false,</p> 
<p>    //   addHeight: 1000</p> 
<p>      // opacity: 1</p> 
<p>      // getImage: function (count) { // getImage是完全自定义方式</p> 
<p>      //   let colorIn</p> 
<p>      //   if (count &lt; 10) {<!-- --></p> 
<p>      //     colorIn = "rgba(110, 204, 57, 0.6)"</p> 
<p>      //   } else if (count &lt; 100) {<!-- --></p> 
<p>      //     colorIn = "rgba(240, 194, 12,  0.6)"</p> 
<p>      //   } else {<!-- --></p> 
<p>      //     colorIn = "rgba(241, 128, 23,  0.6)"</p> 
<p>      //   }</p> 
<p></p> 
<p>      //   const radius = 40</p> 
<p>      //   const thisSize = radius * 2</p> 
<p></p> 
<p>      //   const circleCanvas = document.createElement("canvas")</p> 
<p>      //   circleCanvas.width = thisSize</p> 
<p>      //   circleCanvas.height = thisSize</p> 
<p>      //   const circleCtx = circleCanvas.getContext("2d", { willReadFrequently: true })</p> 
<p></p> 
<p>      //   circleCtx.fillStyle = "#ffffff00"</p> 
<p>      //   circleCtx.globalAlpha = 0.0</p> 
<p>      //   circleCtx.fillRect(0, 0, thisSize, thisSize)</p> 
<p></p> 
<p>      //   // 圆形底色</p> 
<p>      //   circleCtx.globalAlpha = 1.0</p> 
<p>      //   circleCtx.beginPath()</p> 
<p>      //   circleCtx.arc(radius, radius, radius, 0, Math.PI * 2, true)</p> 
<p>      //   circleCtx.closePath()</p> 
<p>      //   circleCtx.fillStyle = colorIn</p> 
<p>      //   circleCtx.fill()</p> 
<p></p> 
<p>      //   // 数字文字</p> 
<p>      //   const text = "故障" + count</p> 
<p>      //   circleCtx.font = radius * 0.6 + "px bold normal" // 设置字体</p> 
<p>      //   circleCtx.fillStyle = "#ffffff" // 设置颜色</p> 
<p>      //   circleCtx.textAlign = "center" // 设置水平对齐方式</p> 
<p>      //   circleCtx.textBaseline = "middle" // 设置垂直对齐方式</p> 
<p>      //   circleCtx.fillText(text, radius, radius) // 绘制文字（参数：要写的字，x坐标，y坐标）</p> 
<p></p> 
<p>      //   return circleCanvas.toDataURL("image/png") // getImage方法返回任意canvas的图片即可</p> 
<p>      // }</p> 
<p>    },</p> 
<p>    symbol: {<!-- --></p> 
<p>      type: "billboardP",</p> 
<p>      styleOptions: {<!-- --></p> 
<p>        image: "img/marker/mark-blue.png",</p> 
<p>        width: 25,</p> 
<p>        height: 34, // billboard聚合必须有width、height</p> 
<p>        horizontalOrigin: Cesium.HorizontalOrigin.CENTER,</p> 
<p>        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,</p> 
<p>        scaleByDistance: new Cesium.NearFarScalar(1000, 0.7, 5000000, 0.3),</p> 
<p>        label: {<!-- --></p> 
<p>          text: "{text}",</p> 
<p>          font_size: 19,</p> 
<p>          color: Cesium.Color.AZURE,</p> 
<p>          outline: true,</p> 
<p>          outlineColor: Cesium.Color.BLACK,</p> 
<p>          outlineWidth: 2,</p> 
<p>          horizontalOrigin: Cesium.HorizontalOrigin.LEFT,</p> 
<p>          verticalOrigin: Cesium.VerticalOrigin.BOTTOM,</p> 
<p>          pixelOffset: new Cesium.Cartesian2(10, 0), // 偏移量</p> 
<p>          distanceDisplayCondition: new Cesium.DistanceDisplayCondition(0.0, 80000)</p> 
<p>        }</p> 
<p>      }</p> 
<p>    }</p> 
<p>    // 自定义创建对象，可替代symbol、</p> 
<p>    // onCreateGraphic: function (e) {<!-- --></p> 
<p>    //   const graphic = new mars3d.graphic.BillboardEntity({<!-- --></p> 
<p>    //     position: e.position,</p> 
<p>    //     style: {<!-- --></p> 
<p>    //       image: "img/marker/lace-blue.png",</p> 
<p>    //       width: 25,</p> 
<p>    //       height: 34, // 聚合必须有width、height</p> 
<p>    //       horizontalOrigin: Cesium.HorizontalOrigin.CENTER,</p> 
<p>    //       verticalOrigin: Cesium.VerticalOrigin.BOTTOM</p> 
<p>    //     },</p> 
<p>    //     attr: e.attr</p> 
<p>    //   })</p> 
<p>    //   graphicLayer.addGraphic(graphic)</p> 
<p>    // },</p> 
<p>  })</p> 
<p>  map.addLayer(graphicLayer)</p> 
<p></p> 
<p>  graphicLayer.on("clustering", function (event) {<!-- --></p> 
<p>    console.log("新增聚合对象", event)</p> 
<p>  })</p> 
<p></p> 
<p>  // 单击事件</p> 
<p>  graphicLayer.on(mars3d.EventType.click, function (event) {<!-- --></p> 
<p>    console.log("你单击了", event)</p> 
<p></p> 
<p>    if (map.camera.positionCartographic.height &gt; 90000) {<!-- --></p> 
<p>      const graphic = event.graphic</p> 
<p>      // graphic.closePopup()</p> 
<p>      if (graphic?.cluster) {<!-- --></p> 
<p>        // 单击了聚合的点</p> 
<p>        console.log("单击了聚合的点", graphic.getGraphics())</p> 
<p>      } else {<!-- --></p> 
<p>        // 单击了具体的点对象</p> 
<p>        const position = graphic.positionShow</p> 
<p>        map.flyToPoint(position, {<!-- --></p> 
<p>          radius: 5000, // 距离目标点的距离</p> 
<p>          duration: 4,</p> 
<p>          complete: function (e) {<!-- --></p> 
<p>            // 飞行完成回调方法</p> 
<p>            // graphic.openPopup()</p> 
<p>          }</p> 
<p>        })</p> 
<p>      }</p> 
<p>    }</p> 
<p>  })</p> 
<p></p> 
<p>  graphicLayer.bindPopup(function (event) {<!-- --></p> 
<p>    if (event.graphic.cluster &amp;&amp; event.graphic.getGraphics) {<!-- --></p> 
<p>      const graphics = event.graphic.getGraphics() // 对应的grpahic数组，可以自定义显示</p> 
<p>      if (graphics) {<!-- --></p> 
<p>        const inthtml = `单击了聚合点(${graphics.length}个)`</p> 
<p>        return inthtml</p> 
<p>      }</p> 
<p>    }</p> 
<p></p> 
<p>    const item = event.graphic?.attr</p> 
<p>    if (!item) {<!-- --></p> 
<p>      return false</p> 
<p>    }</p> 
<p>    const inthtml = `&lt;table style="width: auto;"&gt;</p> 
<p>                  &lt;tr&gt;</p> 
<p>                    &lt;th scope="col" colspan="2" style="text-align:center;font-size:15px;"&gt;${item.text} &lt;/th&gt;</p> 
<p>                  &lt;/tr&gt;</p> 
<p>                  &lt;tr&gt;</p> 
<p>                    &lt;td&gt;省：&lt;/td&gt;&lt;td&gt;${item.province}&lt;/td&gt;</p> 
<p>                  &lt;/tr&gt;</p> 
<p>                  &lt;tr&gt;</p> 
<p>                    &lt;td&gt;市：&lt;/td&gt; &lt;td&gt;${item.city}&lt;/td&gt;</p> 
<p>                  &lt;/tr&gt;</p> 
<p>                  &lt;tr&gt;</p> 
<p>                    &lt;td&gt;县/区：&lt;/td&gt; &lt;td&gt;${item.district}&lt;/td&gt;</p> 
<p>                  &lt;/tr&gt;</p> 
<p>                  &lt;tr&gt;</p> 
<p>                    &lt;td&gt;地址：&lt;/td&gt; &lt;td&gt;${item.address}&lt;/td&gt;</p> 
<p>                  &lt;/tr&gt;</p> 
<p>                  &lt;tr&gt;</p> 
<p>                    &lt;td&gt;视频：&lt;/td&gt; &lt;td&gt;&lt;video src='http://data.mars3d.cn/file/video/lukou.mp4' controls autoplay style="width: 300px;" &gt;&lt;/video&gt;&lt;/td&gt;</p> 
<p>                  &lt;/tr&gt;</p> 
<p>                &lt;/table&gt;`</p> 
<p>    return inthtml</p> 
<p>  })</p> 
<p>}</p> 
<p></p> 
<p>/**</p> 
<p> * 释放当前地图业务的生命周期函数</p> 
<p> * @returns {void} 无</p> 
<p> */</p> 
<p>export function onUnmounted() {<!-- --></p> 
<p>  graphicLayer.remove()</p> 
<p>  graphicLayer = null</p> 
<p></p> 
<p>  map = null</p> 
<p>}</p> 
<p></p> 
<p>// 计算贴地高度示例代码，可以将获取到的高度更新到数据库内，后续不用重复计算。</p> 
<p>export function getDataSurfaceHeight() {<!-- --></p> 
<p>  if (graphicLayer.length === 0) {<!-- --></p> 
<p>    globalMsg("数据尚未加载成功！")</p> 
<p>    return</p> 
<p>  }</p> 
<p>  showLoading()</p> 
<p></p> 
<p>  // 对图层内的数据做贴地运算,自动得到贴地高度</p> 
<p>  graphicLayer.autoSurfaceHeight().then((graphics) =&gt; {<!-- --></p> 
<p>    hideLoading()</p> 
<p></p> 
<p>    const arr = []</p> 
<p>    for (let i = 0, len = graphics.length; i &lt; len; i++) {<!-- --></p> 
<p>      const graphic = graphics[i]</p> 
<p>      const point = graphic.point</p> 
<p>      arr.push({<!-- --></p> 
<p>        ...graphic.attr,</p> 
<p>        lat: point.lat,</p> 
<p>        lng: point.lng,</p> 
<p>        z: point.alt</p> 
<p>      })</p> 
<p>    }</p> 
<p>    mars3d.Util.downloadFile("point.json", JSON.stringify({ data: arr }))</p> 
<p>  })</p> 
<p>}</p> 
<p></p> 
<p>export function enabledAggressive(val) {<!-- --></p> 
<p>  graphicLayer.clustering = val</p> 
<p>}</p> 
<p></p> 
<p>export function layerShowChange(val) {<!-- --></p> 
<p>  graphicLayer.show = val</p> 
<p>}</p> 
<p></p> 
<p>实现效果：</p> 
<p><img alt="" height="1048" src="https://images2.imgbox.com/7e/33/Cqg3DqZY_o.png" width="1200"></p> 
<p><img alt="" height="1048" src="https://images2.imgbox.com/e3/de/MsOdjFm0_o.png" width="1200"></p> 
<p></p> 
<p><img alt="" height="783" src="https://images2.imgbox.com/06/61/HHP1B63c_o.png" width="1038"></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/46f2372e9f9fd84b187b93989a7d0af4/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">云计算：OpenStack 分布式架构管理VXLAN网络（单控制节点与多计算节点）</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6a77fa59cf07a5667a6e4e60b24d0281/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">LeetCode 2487. 从链表中移除节点：单调栈</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>