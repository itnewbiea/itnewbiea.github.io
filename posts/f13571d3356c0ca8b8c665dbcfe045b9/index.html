<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>opencv&#43;pytorch&#43;ncnn使用CNN学习颜色空间RGB踩坑记（附带NCNN源码学习） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="opencv&#43;pytorch&#43;ncnn使用CNN学习颜色空间RGB踩坑记（附带NCNN源码学习）" />
<meta property="og:description" content="最近学习和使用opencv读取和处理图像，然后用pytorch训练深度学习模型，部署和推理的时候用opencv&#43;ncnn进行，过程中参考了很多网上教程和案例，结合源码发现了一个关于颜色空间的问题，很多网上资料的源码示例中并没有注意，自己也被误导了，特别记录一下，也供大家参考
核心思想总结：当我们所有的彩色图像处理都打算采用RGB格式数据的时候，切记用opencv读取图像后要将图像从BGR转成RGB，因为opencv读取彩色图像默认是BGR！！！
贴两段网上找的网友给出的代码，
代码一（opencv&#43;ncnn，C&#43;&#43;）：
cv::Mat img = cv::imread(&#34;image.jpg&#34;, 1); int w = img.cols; int h = img.rows; // subtract 128, norm to -1 ~ 1 ncnn::Mat input = ncnn::Mat::from_pixels_resize(img.data, ncnn::Mat::PIXEL_BGR, w, h, 100, 100); float mean[1] = { 128.f }; float norm[1] = { 1/128.f }; in.substract_mean_normalize(mean, norm); ncnn::Net net; net.load_param(&#34;model.param&#34;); net.load_model(&#34;model.bin&#34;); ncnn::Extractor ex = net.create_extractor(); ex.set_light_mode(true); ex.set_num_threads(4); ex.input(&#34;data&#34;, in); ncnn::Mat feat; ex.extract(&#34;output&#34;, feat); 代码二（opencv&#43;pytorch，python）：
img = cv2.imread(&#39;a.png&#39;, 1).astype(np.uint8) img = cv2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/f13571d3356c0ca8b8c665dbcfe045b9/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-01T16:22:14+08:00" />
<meta property="article:modified_time" content="2023-02-01T16:22:14+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">opencv&#43;pytorch&#43;ncnn使用CNN学习颜色空间RGB踩坑记（附带NCNN源码学习）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <blockquote> 
 <p>最近学习和使用opencv读取和处理图像，然后用pytorch训练深度学习模型，部署和推理的时候用opencv+ncnn进行，过程中参考了很多网上教程和案例，结合源码发现了一个关于颜色空间的问题，很多网上资料的源码示例中并没有注意，自己也被误导了，特别记录一下，也供大家参考</p> 
</blockquote> 
<p><strong>核心思想总结：当我们所有的彩色图像处理都打算采用RGB格式数据的时候，切记用opencv读取图像后要将图像从BGR转成RGB，因为opencv读取彩色图像默认是BGR！！！</strong></p> 
<p>贴两段网上找的网友给出的代码，<br> 代码一（opencv+ncnn，C++）：</p> 
<pre><code class="prism language-cpp">cv<span class="token double-colon punctuation">::</span>Mat img <span class="token operator">=</span> cv<span class="token double-colon punctuation">::</span><span class="token function">imread</span><span class="token punctuation">(</span><span class="token string">"image.jpg"</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> w <span class="token operator">=</span> img<span class="token punctuation">.</span>cols<span class="token punctuation">;</span>
    <span class="token keyword">int</span> h <span class="token operator">=</span> img<span class="token punctuation">.</span>rows<span class="token punctuation">;</span>

    <span class="token comment">// subtract 128, norm to -1 ~ 1</span>
    ncnn<span class="token double-colon punctuation">::</span>Mat input <span class="token operator">=</span> ncnn<span class="token double-colon punctuation">::</span><span class="token class-name">Mat</span><span class="token double-colon punctuation">::</span><span class="token function">from_pixels_resize</span><span class="token punctuation">(</span>img<span class="token punctuation">.</span>data<span class="token punctuation">,</span> ncnn<span class="token double-colon punctuation">::</span>Mat<span class="token double-colon punctuation">::</span>PIXEL_BGR<span class="token punctuation">,</span> w<span class="token punctuation">,</span> h<span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> mean<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">128.f</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">float</span> norm<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token number">1</span><span class="token operator">/</span><span class="token number">128.f</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    in<span class="token punctuation">.</span><span class="token function">substract_mean_normalize</span><span class="token punctuation">(</span>mean<span class="token punctuation">,</span> norm<span class="token punctuation">)</span><span class="token punctuation">;</span>

    ncnn<span class="token double-colon punctuation">::</span>Net net<span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">load_param</span><span class="token punctuation">(</span><span class="token string">"model.param"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    net<span class="token punctuation">.</span><span class="token function">load_model</span><span class="token punctuation">(</span><span class="token string">"model.bin"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    ncnn<span class="token double-colon punctuation">::</span>Extractor ex <span class="token operator">=</span> net<span class="token punctuation">.</span><span class="token function">create_extractor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ex<span class="token punctuation">.</span><span class="token function">set_light_mode</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ex<span class="token punctuation">.</span><span class="token function">set_num_threads</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ex<span class="token punctuation">.</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string">"data"</span><span class="token punctuation">,</span> in<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ncnn<span class="token double-colon punctuation">::</span>Mat feat<span class="token punctuation">;</span>
    ex<span class="token punctuation">.</span><span class="token function">extract</span><span class="token punctuation">(</span><span class="token string">"output"</span><span class="token punctuation">,</span> feat<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>代码二（opencv+pytorch，python）：</p> 
<pre><code class="prism language-python">img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>imread<span class="token punctuation">(</span><span class="token string">'a.png'</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>np<span class="token punctuation">.</span>uint8<span class="token punctuation">)</span>
img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>img<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">224</span><span class="token punctuation">,</span><span class="token number">224</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
img <span class="token operator">=</span> img <span class="token operator">/</span> <span class="token number">255.</span>
img <span class="token operator">=</span> torch<span class="token punctuation">.</span>from_numpy<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
img <span class="token operator">=</span> torch<span class="token punctuation">.</span>tensor<span class="token punctuation">(</span>img<span class="token punctuation">,</span> dtype<span class="token operator">=</span>torch<span class="token punctuation">.</span>float32<span class="token punctuation">)</span>
img <span class="token operator">=</span> img<span class="token punctuation">.</span>unsqueeze<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">#在第一维度上增加一个维度，作为batch size大小</span>
img <span class="token operator">=</span> img<span class="token punctuation">.</span>permute<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment"># 将图像channel提到前面即 [batch size, height, width, channel]-&gt; [batch size, channel, height, width]</span>
<span class="token triple-quoted-string string">'''
opencv读取图像的shape是（height, width，channel），
而pytorch的模型在接收图像tensor的时候要求的shape是（channel，height，width）
'''</span>
net <span class="token operator">=</span> nn<span class="token punctuation">.</span>Conv2d<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">,</span> kernel_size<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">,</span> stride<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">)</span>
a <span class="token operator">=</span> net<span class="token punctuation">(</span>img<span class="token punctuation">)</span>
</code></pre> 
<p>可以看到，这两段代码都是opencv读取了之后，做了相应的处理之后送入模型，这些处理都是关于数据格式进行的，不做程序无法运行或报错。<br> 当然，这两段代码是没有错误的，运行非常成功，于是乎，可能很多网友就和我一样，写代码的时候直接就这么用了，好像也没太多毛病。<br> <strong>然而</strong>，实际使用过程中，因为我训练的时候用pytorch直接给的开源代码训练，我注意到里面有这样的一句代码：</p> 
<pre><code class="prism language-python">img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>img<span class="token punctuation">,</span>cv2<span class="token punctuation">.</span>COLOR_BGR2RGB<span class="token punctuation">)</span>
</code></pre> 
<p>查了一些资料得知，大部分预训练模型都是在RGB这样颜色通道排序的基础下训练的。</p> 
<p><strong>但是</strong>，当我用ncnn的时候，由于跟训练使用的pytorch不是一套代码，也从python转成了C++，在参考资料的时候简单的就用了上面代码一类似的流程，运行当然是毫无问题的，并且当时也和同组小伙伴认为，因为opencv读取的图像是BGR的通道排序，于是在用函数<code>ncnn::Mat::from_pixels_resize</code>创建ncnn矩阵的时候也用参数<code>PIXEL_BGR</code>就可以了，所以有了下面这个语句：</p> 
<pre><code class="prism language-c++">ncnn::Mat input = ncnn::Mat::from_pixels_resize(img.data, ncnn::Mat::PIXEL_BGR, w, h, 100, 100);
</code></pre> 
<p>这个函数具体的讲解这里就不多说了，但是当我带着怀疑和好奇阅读ncnn源码的时候，却发现了问题。实际上，在这个函数中，如果使用参数<code>PIXEL_BGR</code>或<code>PIXEL_RBG</code>，其实都执行的是同样的操作，都是输入的img.data是什么通道顺序，那么输出就是保持什么通道顺序，不管用哪个都是一样的结果。</p> 
<p><strong>正确的应该是</strong>：把<code>PIXEL_BGR</code>或<code>PIXEL_RGB</code>改为<code>PIXEL_RGB2BGR</code>或<code>PIXEL_BGR2RGB</code>（这两个通道顺序的转换其实是一样的操作），原理大家可以看看ncnn中关于这个函数的源码，有时间或者大家有需要的，我再独立写一篇。</p> 
<p>最后说一下，因为这个错误并不影响程序的运行，只影响结果，当纠正这个错误以后，发现果然程序的最终结果比之前要好了一些！！</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/9b71dccd1740d7d9c9b0c824606424f2/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Google Chrome谷歌浏览器离完整离线安装包下载地址整理总汇</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/13becc0087411d3bc1e74c5b13624764/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">AOP的一点浅薄理解</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>