<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Linux入门攻坚——8、磁盘管理——btrfs文件系统及压缩解压缩和归档 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Linux入门攻坚——8、磁盘管理——btrfs文件系统及压缩解压缩和归档" />
<meta property="og:description" content="Btrfs（B-tree），支持CoW，写时复制；
核心特性：
多物理卷支持：btrfs可由多个底层物理卷组成：支持RAID,以联机添加、移除，修改
写时复制更新机制（CoW）：复制、更新及替换指针，而非“就地”更新；
数据及元数据校验码：checksum
子卷：sub_volume
快照：支持快照的快照；
透明压缩：
Centos6上默认没有安装。
centos7上：
使用btrfs --help可以查看帮助。
文件系统创建：
mkfs.btrfs
-L &#39;LABEL&#39; ：
-d &lt;type&gt; ：raid0，raid1raid5，raid6，raid10，single
-m &lt;profile&gt;：raid0，raid1，raid5，raid6，raid10，single，dup
-O &lt;feature&gt;
-O list-all：列出支持的所有feature；
systemctl set-default multi-user.target 设置默认字符界面启动
不需要分区，直接将磁盘做成btrfs系统 ，添加三块磁盘：
直接格式化btrfs：
属性查看：
btrfs filesystem show
使用blkid查看：
UUID相同，说明都是同一个btree卷，但是子卷是不同的。所以btrfs支持多物理卷。
查看卷标：
挂载文件系统：
mount -t btrfs /dev/sdb MOUNT_POINT
挂载的设备可以是btr卷中的任意一个物理卷名，如这里的/dev/dec，也可以使用/dev/sdd，结果一样，mount显示的挂载设备是序列号最小的物理卷。
使用/dev/sdd挂载，结果一样：
透明压缩机制：
mount -o compress={lzo | zlib} DEVICE MOUNT_POINT
特性中多了compress=lzo。压缩解压缩是自动且对用户是透明的。
btrfs系统原生支持RAID。
直接联机修改大小：
btrfs filesystem resize [-|&#43;]size MOUNT_POINT
使用max，直接调整到最大物理卷容量。
添加新的物理设备：
btrfs device add DEVICE MOUNT_POINT" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/10e6555c133e9b4e3260c4328d1e4c48/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-12-15T14:39:24+08:00" />
<meta property="article:modified_time" content="2023-12-15T14:39:24+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Linux入门攻坚——8、磁盘管理——btrfs文件系统及压缩解压缩和归档</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p>Btrfs（B-tree），支持CoW，写时复制；</p> 
<p>核心特性：<br>     多物理卷支持：btrfs可由多个底层物理卷组成：支持RAID,以联机添加、移除，修改<br>     写时复制更新机制（CoW）：复制、更新及替换指针，而非“就地”更新；<br>     数据及元数据校验码：checksum<br>     子卷：sub_volume<br>     快照：支持快照的快照；<br>     透明压缩：</p> 
<p>Centos6上默认没有安装。<br> centos7上：<br><img alt="" height="101" src="https://images2.imgbox.com/8e/d3/1wZWocRi_o.png" width="674"></p> 
<p>使用btrfs --help可以查看帮助。</p> 
<p>文件系统创建：<br>    <span style="color:#956fe7;"> mkfs.btrfs</span><br>         -L 'LABEL' ：<br>         -d &lt;type&gt; ：raid0，raid1raid5，raid6，raid10，single<br>         -m &lt;profile&gt;：raid0，raid1，raid5，raid6，raid10，single，dup<br>         -O &lt;feature&gt;<br>             -O list-all：列出支持的所有feature；<br><img alt="" height="157" src="https://images2.imgbox.com/50/00/dVNM4mOZ_o.png" width="796"></p> 
<p><span style="color:#956fe7;">systemctl set-default multi-user.target </span>   设置默认字符界面启动</p> 
<p>不需要分区，直接将磁盘做成btrfs系统   ，添加三块磁盘：<br><img alt="" height="668" src="https://images2.imgbox.com/f2/0b/a8Y2w6Di_o.png" width="708"></p> 
<p>直接格式化btrfs：<br><img alt="" height="399" src="https://images2.imgbox.com/51/98/Ryg6wxQS_o.png" width="554"></p> 
<p>属性查看：<br>         <span style="color:#956fe7;">btrfs filesystem show</span><br><img alt="" height="108" src="https://images2.imgbox.com/00/8b/4FqAX58x_o.png" width="569"><br><img alt="" height="330" src="https://images2.imgbox.com/36/0c/boYd8mDb_o.png" width="553"><br> 使用blkid查看：<br><img alt="" height="139" src="https://images2.imgbox.com/36/96/DZNZyrmP_o.png" width="806"></p> 
<p>UUID相同，说明都是同一个btree卷，但是子卷是不同的。所以btrfs支持多物理卷。<br> 查看卷标：<br><img alt="" height="94" src="https://images2.imgbox.com/d4/0a/7wefLv9u_o.png" width="484"></p> 
<p>挂载文件系统：<br>         <span style="color:#956fe7;">mount -t btrfs /dev/sdb MOUNT_POINT<br>         </span><span style="color:#494949;">挂载的设备可以是btr卷中的任意一个物理卷名，如这里的/dev/dec，也可以使用/dev/sdd，结果一样，mount显示的挂载设备是序列号最小的物理卷。</span><br><img alt="" height="309" src="https://images2.imgbox.com/c4/df/B7L0ctZe_o.png" width="804"><br> 使用/dev/sdd挂载，结果一样：<br><img alt="" height="167" src="https://images2.imgbox.com/a3/c7/LGMXnNya_o.png" width="807"><br> 透明压缩机制：<br>         <span style="color:#956fe7;">mount -o compress={lzo | zlib} DEVICE MOUNT_POINT</span><br><img alt="" height="125" src="https://images2.imgbox.com/90/20/3R3wOF2z_o.png" width="808"></p> 
<p>特性中多了compress=lzo。压缩解压缩是自动且对用户是透明的。</p> 
<p>btrfs系统原生支持RAID。<br> 直接联机修改大小：<br><span style="color:#956fe7;">btrfs filesystem resize [-|+]size MOUNT_POINT</span><br><img alt="" height="347" src="https://images2.imgbox.com/ee/48/953v98iH_o.png" width="583"><br><img alt="" height="259" src="https://images2.imgbox.com/e7/43/aolwv7XS_o.png" width="581"><br><img alt="" height="263" src="https://images2.imgbox.com/7f/dd/dBB0lB8N_o.png" width="578"></p> 
<p>使用max，直接调整到最大物理卷容量。</p> 
<p>添加新的物理设备：<br><span style="color:#956fe7;">btrfs device add DEVICE MOUNT_POINT</span><br><img alt="" height="244" src="https://images2.imgbox.com/4d/fe/B6cWuMKv_o.png" width="579"></p> 
<p>自动扩展了。<br> 使文件均衡保存，即均衡操作：<br> btrfs balance status /mybtr  ：显示均衡状态<br> btrfs balance start  /mybtr ：启动均衡操作<br><img alt="" height="310" src="https://images2.imgbox.com/cf/a7/bv4hK1cm_o.png" width="643"></p> 
<p>移除物理设备：<br><span style="color:#956fe7;">btrfs device delete /dev/sdd /mybtr </span><br><img alt="" height="358" src="https://images2.imgbox.com/44/b1/SQVQMYZ2_o.png" width="574"></p> 
<p>修改数据、元数据等的底层存储的RAID级别。<br><span style="color:#956fe7;">btrfs balance start -mconvert=raid5 /mybtr</span><br><img alt="" height="117" src="https://images2.imgbox.com/0f/c7/ocAem8un_o.png" width="582"></p> 
<p>子卷管理：<br><span style="color:#956fe7;">btrfs subvolume list /mybtr</span> ：显示子卷<br><span style="color:#956fe7;">btrfs subvolume create /mybtr/logs</span>  ：创建logs子卷<br><img alt="" height="114" src="https://images2.imgbox.com/6a/73/dy3DEiNs_o.png" width="528"></p> 
<p>挂载父卷时，同时会挂载子卷：<br><img alt="" height="173" src="https://images2.imgbox.com/b8/37/efuQxubr_o.png" width="519"></p> 
<p>也可以单独挂载子卷：<br><span style="color:#956fe7;">btrfs -o subvol=logs DEVICE MOUNT_POINT</span><br><img alt="" height="252" src="https://images2.imgbox.com/97/7f/3A01uFcs_o.png" width="550"></p> 
<p>显示子卷的信息：<span style="color:#956fe7;">btrfs subvolume show MOUNT_POINT</span></p> 
<p><img alt="" height="274" src="https://images2.imgbox.com/cc/9b/UQDwFSgg_o.png" width="632"></p> 
<p><span style="color:#956fe7;">mount -o subvolid=subvolume_id /dev/sdd /btrsub</span>，如上面显示的subvolume ID为264，可以如下挂载：</p> 
<p><img alt="" height="102" src="https://images2.imgbox.com/1b/1f/Yz4UIoDN_o.png" width="536"></p> 
<p>删除子卷：</p> 
<p><img alt="" height="149" src="https://images2.imgbox.com/21/b3/ERs98w91_o.png" width="502"></p> 
<p>创建快照：<br><img alt="" height="218" src="https://images2.imgbox.com/6d/24/EglM4hYh_o.png" width="712"></p> 
<p>创建logs的快照logs_snapshot，文件及内容相同。</p> 
<p>修改/mybtr/logs/grub2.cfg，保存，此时在快照中的文件内容不变。</p> 
<p>对单个文件创建快照：<span style="color:#956fe7;">cp --reflink grub2.cfg grub2.cfg_snap</span><br><img alt="" height="182" src="https://images2.imgbox.com/5b/f9/1E8zPOab_o.png" width="606"></p> 
<p>快照要在当前卷或其子目录下。修改grub2.cfg，快照grub2.cfg_snap保持不变。</p> 
<p>文件系统的转换，将ext转换为btrfs：<br> 先创建一个分区，格式化为ext4：<br><img alt="" height="432" src="https://images2.imgbox.com/93/f0/dE2FnD9h_o.png" width="581"></p> 
<p>要转化文件系统，先卸载，在检测，最后转换：</p> 
<p><img alt="" height="647" src="https://images2.imgbox.com/30/bf/fgnmxrK4_o.png" width="642"></p> 
<p>.<img alt="" height="144" src="https://images2.imgbox.com/27/db/hk7bb3AZ_o.png" width="763"></p> 
<p>回滚到ext系统：<br><img alt="" height="110" src="https://images2.imgbox.com/ab/6c/eu1xOKaq_o.png" width="605"></p> 
<p>btrfs子命令：filesystem、device、balance、subvolume等</p> 
<p><strong>压缩、解压缩及归档工具</strong></p> 
<p>compress/uncompress：.Z<br><span style="color:#fe2c24;">gzip/gunzip：.gz</span><br><span style="color:#fe2c24;">bzip2/bunzip2：.bz2</span><br> xz/unxz：.xz<br> zip/unzip：.zip<br> tar，cpio</p> 
<p>1、gzip/gunzip<br> gzip [OPTION] FILE<br>     -d：解压缩，相当于gunzip<br>     -c：将结果输出至标准输出，gzip -c FILE &gt; FILE.gz将保留源文件<br>     -#：指定压缩比，1-9<br> 压缩：<span style="color:#956fe7;">gzip FILE</span><br><img alt="" height="219" src="https://images2.imgbox.com/5f/a4/XPAgaO4M_o.png" width="480"><br> 解压缩：<span style="color:#956fe7;">gunzip FILE.gz</span><br><img alt="" height="131" src="https://images2.imgbox.com/e9/73/tUKoyUAG_o.png" width="470"></p> 
<p>压缩后，源文件删除，解压缩后，压缩文件删除，节省空间。</p> 
<p>zcat：不显示展开的前提下查看文本文件内容；</p> 
<p>2、bzip2/bunzip2/bzcat<br><span style="color:#956fe7;">bzip2 [OPTION] FILE</span><br>     -k：保留源文件<br>     -d：解压缩<br>     -#：1-9，压缩比<br><img alt="" height="239" src="https://images2.imgbox.com/7f/f7/rbxVINet_o.png" width="499"></p> 
<p>3、xz/unxz/xzcat<br><span style="color:#956fe7;">xz [OPTION] FILE</span><br>     -k：保留源文件<br>     -d：解压缩<br>     -#：1-9，压缩比<br><img alt="" height="165" src="https://images2.imgbox.com/5a/b4/BgvcqBml_o.png" width="492"></p> 
<p>对目录进行压缩，只能压缩目录中的文件：<br><img alt="" height="398" src="https://images2.imgbox.com/98/e9/IXaGEtj5_o.png" width="727"></p> 
<p><img alt="" height="110" src="https://images2.imgbox.com/e0/34/XlxwHGES_o.png" width="591"></p> 
<p>4、tar<br> tar [OPTION]... <br> (1)创建归档<br>     tar -c -f /PATH/TO/SOMEFILE.tar FILE...<br>     tar -cf  /PATH/TO/SOMEFILE.tar FILE...<br> (2)查看归档文件中的文件列表<br>     tar -t -f /PATH/TO/SOMEFILE.tar<br> (3)展开归档<br>     tar -x -f /PATH/TO/SOMEFILE.tar<br>     tar -x -f /PATH/TO/SOMEFILE.tar -C /PATH/OTHER</p> 
<p><img alt="" height="506" src="https://images2.imgbox.com/80/1d/ZX8UyPUt_o.png" width="700"></p> 
<p><img alt="" height="243" src="https://images2.imgbox.com/20/84/VpMt4Sn6_o.png" width="799">归档后文件大小可能变大，归档不是压缩，可以在归档的同时再压缩。</p> 
<p>结合压缩工具实现归档并压缩，使用归档的如下选项：<br>     -j：bzip2，-z：gzip，-J：xz</p> 
<p><img alt="" height="703" src="https://images2.imgbox.com/95/53/8X6ysri4_o.png" width="805"></p> 
<p>bash脚本编程：</p> 
<p>循环：for，while，until<br>     循环体：要执行的代码，可能要执行 n遍<br>         进入条件、退出条件</p> 
<p>for循环：<br>     for 变量名 in 列表；do<br>         循环体<br>      done<br> 执行机制：依次将列表中的元素赋值给“变量名”；每次赋值后即执行一次循环体；直到列表中的元素耗尽，循环结束。</p> 
<pre><code class="language-bash">  1 #!/bin/bash
  2 #
  3 
  4 if [ ! $UID -eq 0 ]; then
  5     echo "Only root."
  6     exit 1
  7 fi
  8 for username in user1 user2 user3; do
  9     if id $username &amp;&gt; /dev/null; then
 10         echo "$username exists."
 11     else
 12         useradd $username
 13         if [ $? -eq 0 ]; then
 14             echo "$username" | passwd --stdin $username &amp;&gt; /dev/null
 15             echo "Add $username finished."
 16         fi
 17     fi
 18 done</code></pre> 
<p>列表：<br>     1) 直接给出列表，用空格隔开的序列<br>     2) 整数列表：{start..end} 如{1..10}，$(seq [start] [step] end),如$(seq 2 3 10)<br>     3) 返回列表的命令：$(COMMAND),如 $(ls /var)<br>     4) glob通配机制<br>     5) 变量引用：$@，$*</p> 
<p></p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/b5ee453a96e8c7a07fd25f0017da7200/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">商用机器人，不好用是原罪</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/2e0f9e2dadb399a02efb1a1ae1d08f1a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Uniapp小程序通过camera组件实现视频拍摄</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>