<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>linux stop_machine 停机机制应用及一次触发 soft lockup 分析 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="linux stop_machine 停机机制应用及一次触发 soft lockup 分析" />
<meta property="og:description" content="文章目录 stop_mchine 引起的 soft lockup触发 soft lockup 原因分析（一）：触发 soft lockup 原因分析（二）触发 soft lockup 原因分析（三） stop_mchine 引起的 soft lockup 某次在服务器上某节点发现系统有大量 soft lockup 打印，如下：
May 8 11:46:12 node-2 kernel: watchdog: BUG: soft lockup - CPU#116 stuck for 22s! [migration/116:733] May 8 12:45:00 node-2 kernel: watchdog: BUG: soft lockup - CPU#104 stuck for 23s! [migration/104:659] May 8 12:45:34 node-2 kernel: watchdog: BUG: soft lockup - CPU#21 stuck for 23s! [migration/21:139] May 8 12:46:04 node-2 kernel: watchdog: BUG: soft lockup - CPU#121 stuck for 22s!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/b180a9ef7f443fc3dea89623cb99c9e5/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-02T22:13:25+08:00" />
<meta property="article:modified_time" content="2024-01-02T22:13:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">linux stop_machine 停机机制应用及一次触发 soft lockup 分析</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>文章目录</h4> 
 <ul><li><ul><li><ul><li><a href="#stop_mchine__soft_lockup_1" rel="nofollow">stop_mchine 引起的 soft lockup</a></li><li><a href="#_soft_lockup__611" rel="nofollow">触发 soft lockup 原因分析（一）：</a></li><li><a href="#_soft_lockup__895" rel="nofollow">触发 soft lockup 原因分析（二）</a></li><li><a href="#_soft_lockup__1106" rel="nofollow">触发 soft lockup 原因分析（三）</a></li></ul> 
  </li></ul> 
 </li></ul> 
</div> 
<p></p> 
<h4><a id="stop_mchine__soft_lockup_1"></a>stop_mchine 引起的 soft lockup</h4> 
<p>某次在服务器上某节点发现系统有大量 soft lockup 打印，如下：</p> 
<pre><code class="prism language-shell">May  <span class="token number">8</span> <span class="token number">11</span>:46:12 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#116 stuck for 22s! [migration/116:733]</span>
May  <span class="token number">8</span> <span class="token number">12</span>:45:00 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#104 stuck for 23s! [migration/104:659]</span>
May  <span class="token number">8</span> <span class="token number">12</span>:45:34 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#21 stuck for 23s! [migration/21:139]</span>
May  <span class="token number">8</span> <span class="token number">12</span>:46:04 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#121 stuck for 22s! [migration/121:764]</span>
May  <span class="token number">9</span> <span class="token number">20</span>:29:59 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#91 stuck for 22s! [migration/91:574]</span>
May  <span class="token number">9</span> <span class="token number">20</span>:32:42 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#7 stuck for 22s! [migration/7:53]</span>
May  <span class="token number">9</span> <span class="token number">20</span>:41:42 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#17 stuck for 22s! [migration/17:115]</span>
May  <span class="token number">9</span> <span class="token number">20</span>:58:52 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#102 stuck for 22s! [migration/102:647]</span>
May  <span class="token number">9</span> <span class="token number">21</span>:05:36 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#119 stuck for 22s! [migration/119:751]</span>
May <span class="token number">10</span> 05:33:26 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#29 stuck for 22s! [migration/29:188]</span>
May <span class="token number">10</span> 08:01:04 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#111 stuck for 22s! [migration/111:702]</span>
May <span class="token number">10</span> 08:35:00 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#95 stuck for 22s! [migration/95:604]</span>
May <span class="token number">10</span> 09:29:02 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#1 stuck for 22s! [migration/1:17]</span>
May <span class="token number">10</span> 09:29:31 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#49 stuck for 23s! [migration/49:317]</span>
May <span class="token number">10</span> <span class="token number">17</span>:49:42 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#17 stuck for 22s! [migration/17:115]</span>
May <span class="token number">11</span> <span class="token number">12</span>:25:24 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#107 stuck for 22s! [migration/107:678]</span>
May <span class="token number">11</span> <span class="token number">15</span>:29:46 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#30 stuck for 22s! [migration/30:194]</span>
May <span class="token number">11</span> <span class="token number">15</span>:36:38 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#35 stuck for 23s! [migration/35:225]</span>
May <span class="token number">11</span> <span class="token number">15</span>:37:16 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#104 stuck for 23s! [migration/104:659]</span>
May <span class="token number">11</span> <span class="token number">15</span>:48:31 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#59 stuck for 22s! [migration/59:378]</span>
May <span class="token number">11</span> <span class="token number">16</span>:14:52 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#115 stuck for 22s! [migration/115:727]</span>
May <span class="token number">11</span> <span class="token number">16</span>:21:34 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#39 stuck for 23s! [migration/39:249]</span>
May <span class="token number">11</span> <span class="token number">16</span>:32:50 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#45 stuck for 22s! [migration/45:286]</span>
May <span class="token number">11</span> <span class="token number">21</span>:04:48 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#107 stuck for 22s! [migration/107:678]</span>
May <span class="token number">11</span> <span class="token number">21</span>:07:44 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#122 stuck for 22s! [migration/122:770]</span>
May <span class="token number">11</span> <span class="token number">21</span>:09:39 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#90 stuck for 23s! [migration/90:568]</span>
May <span class="token number">11</span> <span class="token number">21</span>:10:14 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#17 stuck for 23s! [migration/17:115]</span>
May <span class="token number">11</span> <span class="token number">22</span>:58:19 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#68 stuck for 22s! [migration/68:433]</span>
May <span class="token number">11</span> <span class="token number">23</span>:19:25 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#0 stuck for 22s! [migration/0:12]</span>
May <span class="token number">12</span> 00:11:06 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#35 stuck for 23s! [migration/35:225]</span>
May <span class="token number">12</span> 05:11:23 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#47 stuck for 23s! [migration/47:304]</span>
May <span class="token number">12</span> 05:33:06 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#26 stuck for 22s! [migration/26:170]</span>
May <span class="token number">12</span> 05:52:54 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#24 stuck for 23s! [migration/24:157]</span>
May <span class="token number">12</span> 05:59:03 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#75 stuck for 23s! [migration/75:476]</span>
May <span class="token number">12</span> 06:10:44 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#113 stuck for 22s! [migration/113:715]</span>
May <span class="token number">12</span> 08:00:43 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#51 stuck for 23s! [migration/51:329]</span>
May <span class="token number">12</span> 09:46:55 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#59 stuck for 22s! [migration/59:378]</span>
May <span class="token number">12</span> <span class="token number">10</span>:21:18 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#34 stuck for 22s! [migration/34:219]</span>
</code></pre> 
<p>对应着 oom-killer 有大量如下输出：</p> 
<pre><code class="prism language-shell">May  <span class="token number">7</span> 04:41:13 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">3258</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:61977792kB, anon-rss:3997440kB, file-rss:0kB, shmem-rss:131136kB
May  <span class="token number">7</span> 04:45:06 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">35094</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:15836160kB, anon-rss:2320448kB, file-rss:23040kB, shmem-rss:0kB
May  <span class="token number">7</span> 05:20:06 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">45860</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:15040kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">7</span> 06:41:20 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">50009</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:26880kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">7</span> 06:59:29 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">58459</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:28864kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">7</span> 07:14:47 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">55827</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:35968kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">7</span> 07:33:02 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">45155</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:28736kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">7</span> 08:12:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">40729</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:34624kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">7</span> 09:48:26 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">41554</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:26432kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">7</span> <span class="token number">10</span>:57:37 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">32500</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:44928kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">11</span>:46:13 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">59194</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:19494912kB, anon-rss:3146752kB, file-rss:0kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">12</span>:45:09 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">14508</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:20020800kB, anon-rss:3667776kB, file-rss:0kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">12</span>:45:42 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">23826</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:58905216kB, anon-rss:2307712kB, file-rss:0kB, shmem-rss:29504kB
May  <span class="token number">8</span> <span class="token number">12</span>:46:15 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">63570</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3799424kB, anon-rss:2582912kB, file-rss:29376kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">15</span>:26:06 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">11100</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:39360kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">15</span>:34:40 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">11952</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:17024kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">15</span>:53:31 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">48826</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:32896kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">16</span>:19:09 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">23747</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:35264kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">16</span>:49:20 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">40395</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:26176kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">18</span>:07:35 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">53804</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:25344kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">18</span>:55:51 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">38744</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:36672kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">19</span>:17:05 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">61735</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:27840kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">8</span> <span class="token number">23</span>:47:17 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">24967</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:32896kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">9</span> 00:14:37 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">48592</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:2496kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 00:32:49 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">10190</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:24768kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> 00:53:59 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">23075</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:18176kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 02:24:12 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">26315</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:30016kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 02:57:25 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">18119</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724608kB, anon-rss:25280kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 03:36:36 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">8851</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724608kB, anon-rss:23232kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">9</span> 03:54:45 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">22739</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:722816kB, anon-rss:34496kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 04:40:00 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">14681</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:35008kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 06:07:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">49906</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:30528kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 06:19:24 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">43948</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:38208kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 07:22:47 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">20244</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:0kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 07:32:05 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">43764</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:29632kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> 07:38:29 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">13495</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:29696kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 08:27:07 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">54669</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:36928kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> 09:36:24 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">18866</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:24768kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">10</span>:12:31 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">50598</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:30400kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">10</span>:30:43 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">44986</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:35136kB, file-rss:7680kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">11</span>:22:03 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">36549</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:19264kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">11</span>:37:14 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">14044</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:34560kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">15</span>:22:29 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">13164</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:25792kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">15</span>:31:38 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">20864</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:23040kB, file-rss:7296kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">17</span>:08:00 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">62871</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724608kB, anon-rss:19200kB, file-rss:7808kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">17</span>:14:10 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">59009</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:43456kB, file-rss:7488kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">18</span>:43:49 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">31849</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:32064kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">19</span>:33:19 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">54047</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:32704kB, file-rss:7744kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">20</span>:30:09 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">15953</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:20143872kB, anon-rss:2332672kB, file-rss:0kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">20</span>:32:47 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">63818</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2364480kB, anon-rss:1497152kB, file-rss:29440kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">20</span>:41:47 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">35683</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:19514304kB, anon-rss:1760704kB, file-rss:0kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">20</span>:58:58 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">39435</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:19952640kB, anon-rss:2420416kB, file-rss:0kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">21</span>:02:38 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">62596</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:19996864kB, anon-rss:1951488kB, file-rss:24768kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">21</span>:05:14 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">13355</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2835456kB, anon-rss:1962816kB, file-rss:0kB, shmem-rss:0kB
May  <span class="token number">9</span> <span class="token number">21</span>:05:48 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">32524</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:19192960kB, anon-rss:1502528kB, file-rss:9600kB, shmem-rss:0kB
May <span class="token number">10</span> 05:26:56 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">57505</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:22541888kB, anon-rss:2512448kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">10</span> 05:33:31 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">56986</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:40075712kB, anon-rss:2155520kB, file-rss:0kB, shmem-rss:101440kB
May <span class="token number">10</span> 05:42:32 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">7987</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:26880kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">10</span> 08:01:17 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">23145</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3120000kB, anon-rss:1661120kB, file-rss:29632kB, shmem-rss:0kB
May <span class="token number">10</span> 08:35:08 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">21906</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3783936kB, anon-rss:1656896kB, file-rss:3584kB, shmem-rss:0kB
May <span class="token number">10</span> 09:29:02 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">9806</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3175616kB, anon-rss:2328640kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">10</span> 09:29:35 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">3020</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:4880320kB, anon-rss:1864128kB, file-rss:28416kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">10</span>:22:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">18030</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:32320kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">11</span>:43:19 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">48215</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:12096kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">13</span>:16:28 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">10895</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:35584kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">13</span>:31:36 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">39436</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:28032kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">14</span>:07:46 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">37875</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:32000kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">14</span>:34:56 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">8175</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:29760kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">14</span>:41:04 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">37468</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:1717824kB, anon-rss:928704kB, file-rss:29120kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">14</span>:41:36 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">46969</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:1872768kB, anon-rss:918976kB, file-rss:7872kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">14</span>:42:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">7609</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:8132736kB, anon-rss:474368kB, file-rss:0kB, shmem-rss:131072kB
May <span class="token number">10</span> <span class="token number">15</span>:14:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">62989</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724608kB, anon-rss:35840kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">17</span>:17:20 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">53146</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:27520kB, file-rss:7552kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">17</span>:39:18 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">21128</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2153472kB, anon-rss:1301120kB, file-rss:29184kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">17</span>:49:52 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">26559</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2222720kB, anon-rss:1284800kB, file-rss:27776kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">17</span>:50:25 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">27221</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:1805952kB, anon-rss:783616kB, file-rss:9408kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">18</span>:01:44 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">3897</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:24576kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">18</span>:04:59 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">37509</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:35264kB, file-rss:7360kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">18</span>:17:25 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">65243</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:14784kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">18</span>:34:19 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">54668</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:32320kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">19</span>:22:38 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">37281</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:21376kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">21</span>:13:51 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">42755</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:33216kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">22</span>:02:07 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">57616</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:23936kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">23</span>:08:17 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">10853</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:34944kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">23</span>:11:29 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">10597</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:722560kB, anon-rss:32512kB, file-rss:7488kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">23</span>:17:53 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">772</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:26496kB, file-rss:7488kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">23</span>:36:34 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">58347</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:24832kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">10</span> <span class="token number">23</span>:48:47 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">37046</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:21184kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">11</span> 01:10:14 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">12519</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2089664kB, anon-rss:1366336kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> 03:07:05 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">14933</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:18816kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> 03:34:23 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">51837</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:33664kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">11</span> 04:07:39 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">62314</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:29760kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> 04:28:48 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">17231</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:31744kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> 07:23:04 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">6507</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:32576kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> 09:02:17 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">58006</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724864kB, anon-rss:36416kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> 09:17:33 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">64619</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:23808kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> 09:32:52 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">51541</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724352kB, anon-rss:30016kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">10</span>:06:02 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">30405</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:0kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">12</span>:25:25 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">37136</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:4608256kB, anon-rss:1727360kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:27:17 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">41186</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724608kB, anon-rss:21568kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:29:57 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">61022</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2903104kB, anon-rss:1464320kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:36:48 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">63317</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2226112kB, anon-rss:1346432kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:37:22 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">65009</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:1938240kB, anon-rss:809664kB, file-rss:7424kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:37:22 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">52630</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:39424kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:48:05 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">33844</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3310336kB, anon-rss:2117696kB, file-rss:10880kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">15</span>:48:37 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">57758</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3939712kB, anon-rss:1716480kB, file-rss:12608kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:14:59 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">34421</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2904640kB, anon-rss:1490688kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:19:47 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">59273</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:31680kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:21:37 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">18404</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2146880kB, anon-rss:1141632kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:32:58 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">43743</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:24000960kB, anon-rss:3756736kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:36:19 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">16857</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:25363328kB, anon-rss:4943104kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:39:50 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">34741</span> <span class="token punctuation">(</span>prometheus<span class="token punctuation">)</span> total-vm:23726464kB, anon-rss:3480512kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:46:29 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">44892</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3317696kB, anon-rss:1615296kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:46:58 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">7531</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3039616kB, anon-rss:1467392kB, file-rss:12672kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:49:58 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">56856</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:38976kB, file-rss:7808kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:53:40 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">46578</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3178624kB, anon-rss:2091520kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">16</span>:54:18 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">19938</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:43427392kB, anon-rss:1224640kB, file-rss:0kB, shmem-rss:14336kB
May <span class="token number">11</span> <span class="token number">17</span>:26:10 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">7598</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:24896kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">17</span>:56:20 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">12749</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:25536kB, file-rss:7552kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">18</span>:26:34 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">49624</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:27072kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">18</span>:41:48 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">62374</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:27840kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">18</span>:54:06 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">15222</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:30464kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">20</span>:09:26 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">62856</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:28224kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">21</span>:04:20 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">12110</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:50199680kB, anon-rss:2721728kB, file-rss:0kB, shmem-rss:113728kB
May <span class="token number">11</span> <span class="token number">21</span>:04:56 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">55763</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2155776kB, anon-rss:1342720kB, file-rss:14912kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">21</span>:06:38 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">44819</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:27136kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">21</span>:07:50 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">9097</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2355712kB, anon-rss:1342336kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">21</span>:10:21 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">20170</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2207040kB, anon-rss:1275968kB, file-rss:11072kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">22</span>:24:48 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">64813</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:27456kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">22</span>:36:51 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">54968</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2906240kB, anon-rss:1553536kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">22</span>:48:59 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">40043</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723840kB, anon-rss:25856kB, file-rss:7616kB, shmem-rss:0kB
May <span class="token number">11</span> <span class="token number">22</span>:58:29 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">61711</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:49275328kB, anon-rss:1884352kB, file-rss:0kB, shmem-rss:31872kB
May <span class="token number">11</span> <span class="token number">23</span>:19:35 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">7959</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2705024kB, anon-rss:1523392kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 00:11:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">44446</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3580864kB, anon-rss:2562176kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 03:02:46 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">4064</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:43367232kB, anon-rss:1239680kB, file-rss:0kB, shmem-rss:120000kB
May <span class="token number">12</span> 04:19:16 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">22304</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:34880kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">12</span> 04:46:35 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">63348</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:21504kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">12</span> 05:01:54 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">27348</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723584kB, anon-rss:26112kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">12</span> 05:07:40 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">50741</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3442944kB, anon-rss:2492032kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 05:11:25 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">26851</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:1866752kB, anon-rss:1147008kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 05:11:59 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">21864</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2008512kB, anon-rss:829440kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 05:33:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">40076</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2223872kB, anon-rss:1390144kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 05:52:27 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">30432</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3446528kB, anon-rss:1506432kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 05:53:01 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">23365</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2289856kB, anon-rss:1090752kB, file-rss:10176kB, shmem-rss:0kB
May <span class="token number">12</span> 05:59:11 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">52980</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2767808kB, anon-rss:1950592kB, file-rss:4544kB, shmem-rss:0kB
May <span class="token number">12</span> 06:10:45 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">29581</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:51212672kB, anon-rss:1461888kB, file-rss:0kB, shmem-rss:56576kB
May <span class="token number">12</span> 06:17:14 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">52710</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3310848kB, anon-rss:2351936kB, file-rss:15296kB, shmem-rss:0kB
May <span class="token number">12</span> 06:44:07 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">47174</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724608kB, anon-rss:25152kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">12</span> 06:59:17 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">8650</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:30336kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">12</span> 07:17:31 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">13752</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723328kB, anon-rss:29632kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">12</span> 07:26:46 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">50305</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:17920kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">12</span> 07:36:13 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">50083</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:34304kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">12</span> 07:38:35 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">57073</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:54555968kB, anon-rss:1991232kB, file-rss:0kB, shmem-rss:40192kB
May <span class="token number">12</span> 07:54:49 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">52332</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:723072kB, anon-rss:36480kB, file-rss:7744kB, shmem-rss:0kB
May <span class="token number">12</span> 08:00:43 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">58592</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:2156864kB, anon-rss:1377984kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 08:19:06 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">18221</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:49555520kB, anon-rss:1504192kB, file-rss:0kB, shmem-rss:17792kB
May <span class="token number">12</span> 09:10:07 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">46778</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:51087680kB, anon-rss:1543744kB, file-rss:0kB, shmem-rss:24128kB
May <span class="token number">12</span> 09:28:10 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">52965</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3666880kB, anon-rss:1593344kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> 09:43:04 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">58450</span> <span class="token punctuation">(</span>prometheus-conf<span class="token punctuation">)</span> total-vm:724096kB, anon-rss:0kB, file-rss:7680kB, shmem-rss:0kB
May <span class="token number">12</span> 09:47:03 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">51483</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3183360kB, anon-rss:1477568kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> <span class="token number">10</span>:21:24 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">63545</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2698048kB, anon-rss:1399488kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> <span class="token number">10</span>:41:09 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">20829</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:3174208kB, anon-rss:1476288kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> <span class="token number">10</span>:59:46 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">54831</span> <span class="token punctuation">(</span>emla-controller<span class="token punctuation">)</span> total-vm:3324608kB, anon-rss:1537920kB, file-rss:0kB, shmem-rss:0kB
May <span class="token number">12</span> <span class="token number">11</span>:02:42 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">1951</span> <span class="token punctuation">(</span>emla-apiserver<span class="token punctuation">)</span> total-vm:2004928kB, anon-rss:793024kB, file-rss:4736kB, shmem-rss:0kB
</code></pre> 
<p>整理出其中一组触发的打印如下：</p> 
<pre><code class="prism language-shell">lockup:
May <span class="token number">16</span> <span class="token number">15</span>:20:02 node-2 kernel: watchdog: BUG: soft lockup - CPU<span class="token comment">#85 stuck for 22s! [migration/85:537]</span>

oom:
May <span class="token number">16</span> <span class="token number">15</span>:20:02 node-2 kernel: Memory cgroup out of memory: Killed process <span class="token number">28155</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total-vm:52594048kB, anon-rss:1463040kB, file-rss:0kB, shmem-rss:90816kB
</code></pre> 
<p>其中，整理后的 lockup 的详细输出如下：</p> 
<pre><code class="prism language-c">May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">85</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">85</span><span class="token operator">:</span><span class="token number">537</span><span class="token punctuation">]</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Hardware name<span class="token operator">:</span> WuZhou WZ<span class="token operator">-</span>FD01S4<span class="token operator">/</span>WZ<span class="token operator">-</span>FD01S4<span class="token punctuation">,</span> BIOS KL4<span class="token punctuation">.</span><span class="token number">26.</span>WZ<span class="token punctuation">.</span>S<span class="token punctuation">.</span><span class="token number">001.210803</span><span class="token punctuation">.</span>D <span class="token number">08</span><span class="token operator">/</span><span class="token number">03</span><span class="token operator">/</span><span class="token number">21</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">56</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> pstate<span class="token operator">:</span> <span class="token number">60000005</span> <span class="token punctuation">(</span>nZCv daif <span class="token operator">-</span>PAN <span class="token operator">-</span>UAO<span class="token punctuation">)</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> pc <span class="token operator">:</span> __ll_sc_atomic_add_return<span class="token operator">+</span><span class="token number">0x14</span><span class="token operator">/</span><span class="token number">0x20</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> lr <span class="token operator">:</span> rcu_momentary_dyntick_idle<span class="token operator">+</span><span class="token number">0x3c</span><span class="token operator">/</span><span class="token number">0x58</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> sp <span class="token operator">:</span> ffff00002482fd60
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x29<span class="token operator">:</span> ffff00002482fd60 x28<span class="token operator">:</span> <span class="token number">0000000000000000</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x27<span class="token operator">:</span> ffffe582c0c7b2b8 x26<span class="token operator">:</span> ffff00006128f428
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x25<span class="token operator">:</span> ffff2e2be25b6a60 x24<span class="token operator">:</span> <span class="token number">0000000000000000</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x23<span class="token operator">:</span> <span class="token number">0000000000000000</span> x22<span class="token operator">:</span> <span class="token number">0000000000000000</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x21<span class="token operator">:</span> ffff00006128f4c4 x20<span class="token operator">:</span> ffff00006128f4a0
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x19<span class="token operator">:</span> <span class="token number">0000000000000001</span> x18<span class="token operator">:</span> <span class="token number">0000000000000000</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x17<span class="token operator">:</span> <span class="token number">00000000192</span>a0d6a x16<span class="token operator">:</span> <span class="token number">0000000000000000</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x15<span class="token operator">:</span> <span class="token number">0000000000000003</span> x14<span class="token operator">:</span> <span class="token number">0000000000000002</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x13<span class="token operator">:</span> <span class="token number">0000000000000006</span> x12<span class="token operator">:</span> <span class="token number">0000000000000027</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x11<span class="token operator">:</span> <span class="token number">0000000000000017</span> x10<span class="token operator">:</span> <span class="token number">0000000000000</span>d10
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x9 <span class="token operator">:</span> ffff00002482fd40
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x8 <span class="token operator">:</span> ffffe582c0cab570
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x7 <span class="token operator">:</span> ffff00006128f4a0 x6 <span class="token operator">:</span> <span class="token number">00000004341958ff</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x5 <span class="token operator">:</span> <span class="token number">0000</span>b7571d4c0000 x4 <span class="token operator">:</span> ffffe582c0caae00
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x3 <span class="token operator">:</span> <span class="token number">0000</span>b7571d4c0000 x2 <span class="token operator">:</span> ffffe582fff6e9c0
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> x1 <span class="token operator">:</span> ffffe582fff6ea78 x0 <span class="token operator">:</span> <span class="token number">0000000000000004</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Call trace<span class="token operator">:</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> __ll_sc_atomic_add_return<span class="token operator">+</span><span class="token number">0x14</span><span class="token operator">/</span><span class="token number">0x20</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> multi_cpu_stop<span class="token operator">+</span><span class="token number">0xf4</span><span class="token operator">/</span><span class="token number">0x150</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> cpu_stopper_thread<span class="token operator">+</span><span class="token number">0xb4</span><span class="token operator">/</span><span class="token number">0x170</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> smpboot_thread_fn<span class="token operator">+</span><span class="token number">0x154</span><span class="token operator">/</span><span class="token number">0x1d8</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> kthread<span class="token operator">+</span><span class="token number">0x130</span><span class="token operator">/</span><span class="token number">0x138</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> ret_from_fork<span class="token operator">+</span><span class="token number">0x10</span><span class="token operator">/</span><span class="token number">0x18</span>
</code></pre> 
<p>可以看到报告 lockup 的点是 rcu_momentary_dyntick_idle 这个函数里面，触发 lockup 的线程是迁移线程migration/85:537。跟踪相关代码流程如下：</p> 
<pre><code class="prism language-c"> cpu_stopper_thread
  <span class="token operator">-&gt;</span> multi_cpu_stop
    <span class="token operator">-&gt;</span> rcu_momentary_dyntick_idle
</code></pre> 
<p>也就是说在迁移线程中调用 rcu_momentary_dyntick_idle函数触发了 lockup。multi_cpu_stop 代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">multi_cpu_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">multi_stop_data</span> <span class="token operator">*</span>msdata <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">multi_stop_state</span> newstate<span class="token punctuation">,</span> curstate <span class="token operator">=</span> MULTI_STOP_NONE<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cpu <span class="token operator">=</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	bool is_active<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * When called from stop_machine_from_inactive_cpu(), irq might
	 * already be disabled.  Save the state and restore it on exit.
	 */</span>
	<span class="token function">local_save_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msdata<span class="token operator">-&gt;</span>active_cpus<span class="token punctuation">)</span>
		is_active <span class="token operator">=</span> cpu <span class="token operator">==</span> <span class="token function">cpumask_first</span><span class="token punctuation">(</span>cpu_online_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		is_active <span class="token operator">=</span> <span class="token function">cpumask_test_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> msdata<span class="token operator">-&gt;</span>active_cpus<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Simple state machine */</span>
	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* Chill out and ensure we re-read multi_stop_state. */</span>
		<span class="token function">cpu_relax_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newstate <span class="token operator">=</span> <span class="token function">READ_ONCE</span><span class="token punctuation">(</span>msdata<span class="token operator">-&gt;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>newstate <span class="token operator">!=</span> curstate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			curstate <span class="token operator">=</span> newstate<span class="token punctuation">;</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>curstate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> MULTI_STOP_DISABLE_IRQ<span class="token operator">:</span>
				<span class="token function">local_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">hard_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> MULTI_STOP_RUN<span class="token operator">:</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>is_active<span class="token punctuation">)</span>
					err <span class="token operator">=</span> msdata<span class="token operator">-&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span>msdata<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">ack_state</span><span class="token punctuation">(</span>msdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curstate <span class="token operator">&gt;</span> MULTI_STOP_PREPARE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/*
			 * At this stage all other CPUs we depend on must spin
			 * in the same loop. Any reason for hard-lockup should
			 * be detected and reported on their side.
			 */</span>
			<span class="token function">touch_nmi_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">rcu_momentary_dyntick_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 触发 soft lockup</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>curstate <span class="token operator">!=</span> MULTI_STOP_EXIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">local_irq_restore</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数逻辑为：在 stop machine cpu 停机的状态下执行 msdata 中指定的回调。该函数首先会关闭中断，并在这种情况下调用 msdata-&gt;fn(msdata-&gt;data)，为了防止触发 watchdog 这里调用了 touch_nmi_watchdog 来复位 watchdog。所以从代码上看能够触发 soft lockup 的地方可能是 msdata-&gt;fn(msdata-&gt;data) 这个回调占用时间太久，或者是 rcu_momentary_dyntick_idle 这个调用时间太久。rcu_momentary_dyntick_idle 代码如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/*
 * Let the RCU core know that this CPU has gone through the scheduler,
 * which is a quiescent state.  This is called when the need for a
 * quiescent state is urgent, so we burn an atomic operation and full
 * memory barriers to let the RCU core know about it, regardless of what
 * this CPU might (or might not) do in the near future.
 *
 * We inform the RCU core by emulating a zero-duration dyntick-idle period.
 *
 * The caller must have disabled interrupts and must not be idle.
 */</span>
<span class="token keyword">void</span> <span class="token function">rcu_momentary_dyntick_idle</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">int</span> special<span class="token punctuation">;</span>

	<span class="token function">raw_cpu_write</span><span class="token punctuation">(</span>rcu_data<span class="token punctuation">.</span>rcu_need_heavy_qs<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
	special <span class="token operator">=</span> <span class="token function">atomic_add_return</span><span class="token punctuation">(</span><span class="token number">2</span> <span class="token operator">*</span> RCU_DYNTICK_CTRL_CTR<span class="token punctuation">,</span>
				    <span class="token operator">&amp;</span><span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rcu_data<span class="token punctuation">)</span><span class="token operator">-&gt;</span>dynticks<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* It is illegal to call this from idle state. */</span>
	<span class="token function">WARN_ON_ONCE</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>special <span class="token operator">&amp;</span> RCU_DYNTICK_CTRL_CTR<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">rcu_preempt_deferred_qs</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这个代码主要工作是向 rcu 报告该 cpu 经历了一个静默期，在需要报告静默期时调用该函数，并且要求调用者禁用中断并且不能 cpu 不能处于空闲状态。代码具体细节目前未研究。<br> 怀疑点1：可能导致长时间调用的点是 msdata-&gt;fn，首先看看哪些地方会注册 msdafa-&gt;fn。</p> 
<pre><code class="prism language-c">multi_cpu_stop
  <span class="token operator">-&gt;</span> <span class="token function">stop_two_cpus</span> <span class="token punctuation">(</span>注册 migrate_swap_stop 回调<span class="token punctuation">)</span>
    <span class="token operator">-&gt;</span> migrate_swap（<span class="token keyword">if</span> CONFIG_NUMA_BALANCING）
      <span class="token operator">-&gt;</span> task_numa_migrate
        <span class="token operator">-&gt;</span> numa_migrate_preferred
          <span class="token operator">-&gt;</span> <span class="token function">task_numa_fault</span> <span class="token punctuation">(</span>page fault<span class="token punctuation">)</span>
  <span class="token operator">-&gt;</span> stop_machine_cpuslocked
    <span class="token operator">-&gt;</span> stop_machine
    <span class="token operator">-&gt;</span> takedown_cpu
    <span class="token operator">-&gt;</span> 启动阶段调用 aarch64_insn_patch_text_sync <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">-&gt;</span> <span class="token function">stop_machine_from_inactive_cpu</span> <span class="token punctuation">(</span>仅 x86 调用<span class="token punctuation">)</span>
</code></pre> 
<p>第一个是 task_numa_fault 函数会最终注册 migrate_swap_stop ，代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">migrate_swap_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">migration_swap_arg</span> <span class="token operator">*</span>arg <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">rq</span> <span class="token operator">*</span>src_rq<span class="token punctuation">,</span> <span class="token operator">*</span>dst_rq<span class="token punctuation">;</span>
	<span class="token keyword">int</span> ret <span class="token operator">=</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cpu_active</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>src_cpu<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">cpu_active</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>dst_cpu<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>EAGAIN<span class="token punctuation">;</span>

	src_rq <span class="token operator">=</span> <span class="token function">cpu_rq</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>src_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dst_rq <span class="token operator">=</span> <span class="token function">cpu_rq</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>dst_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">double_raw_lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token operator">-&gt;</span>src_task<span class="token operator">-&gt;</span>pi_lock<span class="token punctuation">,</span>
			<span class="token operator">&amp;</span>arg<span class="token operator">-&gt;</span>dst_task<span class="token operator">-&gt;</span>pi_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">double_rq_lock</span><span class="token punctuation">(</span>src_rq<span class="token punctuation">,</span> dst_rq<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">task_cpu</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>dst_task<span class="token punctuation">)</span> <span class="token operator">!=</span> arg<span class="token operator">-&gt;</span>dst_cpu<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> unlock<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">task_cpu</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>src_task<span class="token punctuation">)</span> <span class="token operator">!=</span> arg<span class="token operator">-&gt;</span>src_cpu<span class="token punctuation">)</span>
		<span class="token keyword">goto</span> unlock<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cpumask_test_cpu</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>dst_cpu<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token operator">-&gt;</span>src_task<span class="token operator">-&gt;</span>cpus_allowed<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> unlock<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">cpumask_test_cpu</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>src_cpu<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token operator">-&gt;</span>dst_task<span class="token operator">-&gt;</span>cpus_allowed<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> unlock<span class="token punctuation">;</span>

	<span class="token function">__migrate_swap_task</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>src_task<span class="token punctuation">,</span> arg<span class="token operator">-&gt;</span>dst_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__migrate_swap_task</span><span class="token punctuation">(</span>arg<span class="token operator">-&gt;</span>dst_task<span class="token punctuation">,</span> arg<span class="token operator">-&gt;</span>src_cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>

	ret <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

unlock<span class="token operator">:</span>
	<span class="token function">double_rq_unlock</span><span class="token punctuation">(</span>src_rq<span class="token punctuation">,</span> dst_rq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">raw_spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token operator">-&gt;</span>dst_task<span class="token operator">-&gt;</span>pi_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">raw_spin_unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg<span class="token operator">-&gt;</span>src_task<span class="token operator">-&gt;</span>pi_lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> ret<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>从代码可以看到会获取两把锁，一个 src task 的 pi_lock 以及对应 cpu 的 rq_lock，第二个是 dst task 的 pi_lock 以及对应 cpu 的 rq_lock。从逻辑来看除非 在其他地方长时间占用 任务的 pi_lock 锁，否则应该不会导致 soft lockup。pi_lock 锁的使用主要在四个地方。</p> 
<ol><li>set_special_state (TASK_STOPPED, TASK_TRACED, TASK_DEAD)</li><li>do_exit</li><li>rt_mutext</li><li>sched migrate → …. task_rq_lock<br> 目前从 oom killer 测的堆栈回溯没有看到会竞争 pi_lock 的地方。</li></ol> 
<p>第二个是 stop_machine_cpuslocked 这个主要是在 cpus_read_lock 的保护下在停机状态执行一些回调函数。其中处理器启动阶段的替换指令，热补丁会调用，以及卸载一些 cpu（takedown_cpu）时会调用停机，这些地点也不会在运行中触发 soft lockup。</p> 
<p>最后是 stop_machine，内核常用的停机调用回调的函数。这个在许多地方会调用：各类驱动，ftrace 等，目前暂时排除这个点。<br> 综上所述，目前暂时在 msdata-&gt;fn 中没有到怀疑点，所以问题主要集中在 rcu_momentary_dyntick_idle 中。</p> 
<p>接着看一下对应的最近时间点的 oom 的详细信息，中间去除了许多打印，直接找到 dump stack 的地方：</p> 
<pre><code class="prism language-c">May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> CPU<span class="token operator">:</span> <span class="token number">121</span> PID<span class="token operator">:</span> <span class="token number">13970</span> Comm<span class="token operator">:</span> kube<span class="token operator">-</span>apiserver Kdump<span class="token operator">:</span> loaded Tainted<span class="token operator">:</span> G        W  OEL   <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span> <span class="token operator">-</span>  <span class="token operator">-</span> <span class="token number">4.18</span><span class="token number">.0</span><span class="token operator">-</span><span class="token number">147.5</span><span class="token number">.1</span><span class="token punctuation">.</span>es8_24<span class="token punctuation">.</span>aarch64<span class="token operator">+</span>numa64 #<span class="token number">1</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Hardware name<span class="token operator">:</span> WuZhou WZ<span class="token operator">-</span>FD01S4<span class="token operator">/</span>WZ<span class="token operator">-</span>FD01S4<span class="token punctuation">,</span> BIOS KL4<span class="token punctuation">.</span><span class="token number">26.</span>WZ<span class="token punctuation">.</span>S<span class="token punctuation">.</span><span class="token number">001.210803</span><span class="token punctuation">.</span>D <span class="token number">08</span><span class="token operator">/</span><span class="token number">03</span><span class="token operator">/</span><span class="token number">21</span> <span class="token number">09</span><span class="token operator">:</span><span class="token number">17</span><span class="token operator">:</span><span class="token number">56</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Call trace<span class="token operator">:</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> dump_backtrace<span class="token operator">+</span><span class="token number">0x0</span><span class="token operator">/</span><span class="token number">0x188</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> show_stack<span class="token operator">+</span><span class="token number">0x24</span><span class="token operator">/</span><span class="token number">0x30</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> dump_stack<span class="token operator">+</span><span class="token number">0x90</span><span class="token operator">/</span><span class="token number">0xb4</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> dump_header<span class="token operator">+</span><span class="token number">0x70</span><span class="token operator">/</span><span class="token number">0x238</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> oom_kill_process<span class="token operator">+</span><span class="token number">0x1ac</span><span class="token operator">/</span><span class="token number">0x1b0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> out_of_memory<span class="token operator">+</span><span class="token number">0x190</span><span class="token operator">/</span><span class="token number">0x4e0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> mem_cgroup_out_of_memory<span class="token operator">+</span><span class="token number">0x68</span><span class="token operator">/</span><span class="token number">0xa0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> try_charge<span class="token operator">+</span><span class="token number">0x6a0</span><span class="token operator">/</span><span class="token number">0x730</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> mem_cgroup_try_charge<span class="token operator">+</span><span class="token number">0x8c</span><span class="token operator">/</span><span class="token number">0x208</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> __add_to_page_cache_locked<span class="token operator">+</span><span class="token number">0x74</span><span class="token operator">/</span><span class="token number">0x270</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> add_to_page_cache_lru<span class="token operator">+</span><span class="token number">0x78</span><span class="token operator">/</span><span class="token number">0x118</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> filemap_fault<span class="token operator">+</span><span class="token number">0x444</span><span class="token operator">/</span><span class="token number">0x538</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> __xfs_filemap_fault<span class="token operator">+</span><span class="token number">0x74</span><span class="token operator">/</span><span class="token number">0x230</span> <span class="token punctuation">[</span>xfs<span class="token punctuation">]</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> xfs_filemap_fault<span class="token operator">+</span><span class="token number">0x44</span><span class="token operator">/</span><span class="token number">0x50</span> <span class="token punctuation">[</span>xfs<span class="token punctuation">]</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> __do_fault<span class="token operator">+</span><span class="token number">0x2c</span><span class="token operator">/</span><span class="token number">0xf8</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> do_fault<span class="token operator">+</span><span class="token number">0x1b0</span><span class="token operator">/</span><span class="token number">0x4b0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> __handle_mm_fault<span class="token operator">+</span><span class="token number">0x3fc</span><span class="token operator">/</span><span class="token number">0x4f0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> handle_mm_fault<span class="token operator">+</span><span class="token number">0xf8</span><span class="token operator">/</span><span class="token number">0x1a0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> do_page_fault<span class="token operator">+</span><span class="token number">0x15c</span><span class="token operator">/</span><span class="token number">0x478</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> do_translation_fault<span class="token operator">+</span><span class="token number">0x9c</span><span class="token operator">/</span><span class="token number">0xac</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> do_mem_abort<span class="token operator">+</span><span class="token number">0x50</span><span class="token operator">/</span><span class="token number">0xa8</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> do_el0_ia_bp_hardening<span class="token operator">+</span><span class="token number">0x58</span><span class="token operator">/</span><span class="token number">0x98</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> el0_ia<span class="token operator">+</span><span class="token number">0x1c</span><span class="token operator">/</span><span class="token number">0x20</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Task in <span class="token operator">/</span>kubepods<span class="token operator">/</span>besteffort<span class="token operator">/</span>podc011642f<span class="token operator">-</span>f13a<span class="token operator">-</span><span class="token number">461</span>d<span class="token operator">-</span>bf8e<span class="token operator">-</span><span class="token number">9405572077</span>b1<span class="token operator">/</span>d238ef398c00af09f7d8f5c51335056894432becfc8a82c49a7d4021980eccce killed as a result of limit of <span class="token operator">/</span>kubepods
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> memory<span class="token operator">:</span> usage <span class="token number">41943104</span>kB<span class="token punctuation">,</span> limit <span class="token number">41943488</span>kB<span class="token punctuation">,</span> failcnt <span class="token number">59146173</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> memory<span class="token operator">+</span>swap<span class="token operator">:</span> usage <span class="token number">41943360</span>kB<span class="token punctuation">,</span> limit <span class="token number">9007199254740928</span>kB<span class="token punctuation">,</span> failcnt <span class="token number">0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> kmem<span class="token operator">:</span> usage <span class="token number">0</span>kB<span class="token punctuation">,</span> limit <span class="token number">9007199254740928</span>kB<span class="token punctuation">,</span> failcnt <span class="token number">0</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">25</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Memory cgroup stats <span class="token keyword">for</span> <span class="token operator">/</span>kubepods<span class="token operator">:</span> cache<span class="token operator">:</span><span class="token number">0</span>KB rss<span class="token operator">:</span><span class="token number">0</span>KB rss_huge<span class="token operator">:</span><span class="token number">0</span>KB shmem<span class="token operator">:</span><span class="token number">0</span>KB mapped_file<span class="token operator">:</span><span class="token number">0</span>KB dirty<span class="token operator">:</span><span class="token number">0</span>KB writeback<span class="token operator">:</span><span class="token number">0</span>KB swap<span class="token operator">:</span><span class="token number">0</span>KB inactive_anon<span class="token operator">:</span><span class="token number">0</span>KB active_anon<span class="token operator">:</span><span class="token number">0</span>KB inactive_file<span class="token operator">:</span><span class="token number">0</span>KB active_file<span class="token operator">:</span><span class="token number">0</span>KB unevictable<span class="token operator">:</span><span class="token number">0</span>KB
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
May <span class="token number">16</span> <span class="token number">15</span><span class="token operator">:</span><span class="token number">20</span><span class="token operator">:</span><span class="token number">02</span> node<span class="token operator">-</span><span class="token number">2</span> kernel<span class="token operator">:</span> Memory cgroup out of memory<span class="token operator">:</span> Killed process <span class="token number">28155</span> <span class="token punctuation">(</span>mysqld<span class="token punctuation">)</span> total<span class="token operator">-</span>vm<span class="token operator">:</span><span class="token number">52594048</span>kB<span class="token punctuation">,</span> anon<span class="token operator">-</span>rss<span class="token operator">:</span><span class="token number">1463040</span>kB<span class="token punctuation">,</span> file<span class="token operator">-</span>rss<span class="token operator">:</span><span class="token number">0</span>kB<span class="token punctuation">,</span> shmem<span class="token operator">-</span>rss<span class="token operator">:</span><span class="token number">90816</span>kB
</code></pre> 
<p>通过：<code>Task in /kubepods/besteffort/podc011642f-f13a-461d-bf8e-9405572077b1/d238ef398c00af09f7d8f5c51335056894432becfc8a82c49a7d4021980eccce killed as a result of limit of /kubepods</code>信息，可以找到对应的 memory crgoup： /kubepods，查看其 memory 配置：</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>root@node<span class="token operator">-</span><span class="token number">2</span> kubepods<span class="token punctuation">]</span># cat memory<span class="token punctuation">.</span>limit_in_bytes
<span class="token number">42950131712</span>
<span class="token punctuation">[</span>root@node<span class="token operator">-</span><span class="token number">2</span> kubepods<span class="token punctuation">]</span># cat memory<span class="token punctuation">.</span>usage_in_bytes
<span class="token number">42449043456</span>
<span class="token punctuation">[</span>root@node<span class="token operator">-</span><span class="token number">2</span> kubepods<span class="token punctuation">]</span># cat memory<span class="token punctuation">.</span>max_usage_in_bytes
<span class="token number">42955702272</span>
<span class="token punctuation">[</span>root@node<span class="token operator">-</span><span class="token number">2</span> kubepods<span class="token punctuation">]</span>#
</code></pre> 
<p>可以看到最多允许该节点及其子节点使用 40G 左右内存，当前使用了 39.5G 左右内存，最大使用过 40G 多一点的内存，符合偶尔触发 oom killer 的条件。<br> 通过打印可以看到在 kube-apiserver 应用访问指令时触发了 el0_ia 指令同步异常从而进入内核并最终检测到是 mem_abort 从而触发了 pagefult。（不仅是 el0_ia，其他打印也有通过 el0_da 进入该流程，属于访问数据出现的异常）通过 pagefault，最终在分配内存时调用 mem_cgroup_try_charge 检测到所属memory cgroup的内存超限了，从而调用 mem_cgroup_out_of_memory 在组内 kill 进程来回收内存，这里 kill 掉的是 mysqld。</p> 
<p>通过 soft lockup 和 oom 的时间戳可以看到 soft lockup 是在该 oom 打印期间，报告出来的。是否是 oom 的 oom_kill_process 逻辑与迁移线程中的 rcu_momentary_dyntick_idle 存在影响导致的？</p> 
<p>构建如下测试复现脚本：<br> 启动脚本：</p> 
<pre><code class="prism language-shell">// memcg_test.sh
<span class="token comment">#!/bin/sh</span>
<span class="token function">mount</span> <span class="token parameter variable">-t</span> cgroup memory cpu

<span class="token function">mkdir</span> <span class="token parameter variable">-p</span> cpu/memcg_test
<span class="token builtin class-name">echo</span> 1000M <span class="token operator">&gt;</span> cpu/memcg_test/memory.limit_in_bytes
<span class="token builtin class-name">echo</span> <span class="token number">0</span>-15 <span class="token operator">&gt;</span> cpu/memcg_test/cpuset.cpus
<span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">&gt;</span> cpu/memcg_test/cpuset.mems
<span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> cpu/memcg_test/memory.use_hierarchy

<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> <span class="token number">1</span> <span class="token number">2000</span><span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
        <span class="token function">mkdir</span> <span class="token parameter variable">-p</span> cpu/memcg_test/test_<span class="token variable">$i</span>
        <span class="token builtin class-name">echo</span> <span class="token number">0</span>-15 <span class="token operator">&gt;</span> cpu/memcg_test/test_<span class="token variable">$i</span>/cpuset.cpus
        <span class="token builtin class-name">echo</span> <span class="token number">0</span> <span class="token operator">&gt;</span> cpu/memcg_test/test_<span class="token variable">$i</span>/cpuset.mems
        <span class="token builtin class-name">echo</span> <span class="token number">1</span> <span class="token operator">&gt;</span> cpu/memcg_test/test_<span class="token variable">$i</span>/memory.use_hierarchy
        ./alloc_mem <span class="token operator">&amp;</span>
        <span class="token builtin class-name">echo</span> <span class="token variable">$!</span> <span class="token operator">&gt;</span>cpu/memcg_test/test_<span class="token variable">$i</span>/tasks
<span class="token keyword">done</span>
</code></pre> 
<p>创建 memcg_test cgroup memory 节点，并设置该节点可以使用 1G 内存，模拟 53 环境上kubepods 创建大量子节点，设置 use_hierarchy 为 1 共用 memcg_test 的内存。<br> 其中 alloc_mem 程序代码如下：</p> 
<pre><code class="prism language-c"><span class="token comment">// alloc_mem.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h&gt;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;unistd.h&gt;</span></span>
   
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span>addr<span class="token punctuation">;</span>
 
    addr <span class="token operator">=</span> <span class="token function">malloc</span><span class="token punctuation">(</span><span class="token number">0x50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">char</span> <span class="token operator">*</span> start <span class="token operator">=</span> addr<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
        addr <span class="token operator">=</span> start<span class="token punctuation">;</span>
        <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0x50000</span><span class="token punctuation">;</span>
        <span class="token function">usleep</span><span class="token punctuation">(</span><span class="token number">5000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>a<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
            <span class="token operator">*</span>addr<span class="token operator">++</span> <span class="token operator">=</span> <span class="token number">0x3</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先分配 320KB 内存，接着对该内存区域遍历写操作，最后触发 pagefault 分配实际内存。<br> 最后一个触发脚本：</p> 
<pre><code class="prism language-shell">// alloc.sh
<span class="token comment">#!/bin/sh</span>

<span class="token keyword">for</span> <span class="token for-or-select variable">i</span> <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> <span class="token number">0</span> <span class="token number">500</span><span class="token variable">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">do</span>
        ./alloc_mem <span class="token operator">&amp;</span>
<span class="token keyword">done</span>
</code></pre> 
<p>触发原理：<br> 通过在 memcg_test 内存控制节点中创建大量分配内存任务，知道分配内存达到 memcg_test 允许的最大内存量，触发 oom killer 来回收 memcg_test 下的内存，这个时候就有概率触发 soft lockup。</p> 
<p>如何在迁移线程触发 soft lockup?<br> 经过大量测试，实际触发点是需要在 oom killer 遍历 process 时调用 stop_machine。所以在测试中，手动创建了一个线程，每隔一秒在任意 cpu 上执行一次 stop_machine 即可触发 bug。<br> stop_machine 中执行的任务是什么并不影响触发 bug。</p> 
<p>代码大致如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">update_cpu_topology</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> aa <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		aa <span class="token operator">*=</span> i<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">sathreadfn</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">msleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">stop_machine</span><span class="token punctuation">(</span>update_cpu_topology<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>tsk<span class="token punctuation">;</span>
    
	tsk <span class="token operator">=</span> <span class="token function">kthread_create</span><span class="token punctuation">(</span>sathreadfn<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">"test"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wake_up_process</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>qemu 启动脚本如下：</p> 
<pre><code class="prism language-c">#<span class="token operator">!</span><span class="token operator">/</span>bin<span class="token operator">/</span>sh

sudo qemu<span class="token operator">-</span>system<span class="token operator">-</span>x86_64 \
    <span class="token operator">-</span>cpu Skylake<span class="token operator">-</span>Server<span class="token operator">-</span>IBRS<span class="token punctuation">,</span>ss<span class="token operator">=</span>on<span class="token punctuation">,</span>vmx<span class="token operator">=</span>on<span class="token punctuation">,</span>hypervisor<span class="token operator">=</span>on<span class="token punctuation">,</span>tsc_adjust<span class="token operator">=</span>on<span class="token punctuation">,</span>clflushopt<span class="token operator">=</span>on<span class="token punctuation">,</span>umip<span class="token operator">=</span>on<span class="token punctuation">,</span>pku<span class="token operator">=</span>on<span class="token punctuation">,</span>avx512vnni<span class="token operator">=</span>on<span class="token punctuation">,</span>md<span class="token operator">-</span>clear<span class="token operator">=</span>on<span class="token punctuation">,</span>stibp<span class="token operator">=</span>on<span class="token punctuation">,</span>ssbd<span class="token operator">=</span>on<span class="token punctuation">,</span>xsaves<span class="token operator">=</span>on \
    <span class="token operator">-</span>drive format<span class="token operator">=</span>raw<span class="token punctuation">,</span>file<span class="token operator">=</span><span class="token operator">/</span>home<span class="token operator">/</span>miracle<span class="token operator">/</span>play<span class="token operator">/</span>busybox<span class="token operator">-</span><span class="token number">1.35</span><span class="token number">.0</span><span class="token operator">/</span>test<span class="token punctuation">.</span>img \
    <span class="token operator">-</span>append <span class="token string">"root=/dev/sda rootfstype=ext4 rw console=ttyS0 init=/linuxrc sched_debug"</span> \
    <span class="token operator">-</span>kernel <span class="token operator">/</span>home<span class="token operator">/</span>miracle<span class="token operator">/</span>play<span class="token operator">/</span>escore_kernel_source<span class="token operator">/</span>arch<span class="token operator">/</span>x86<span class="token operator">/</span>boot<span class="token operator">/</span>bzImage <span class="token operator">-</span>nographic \
    <span class="token operator">-</span>smp cores<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">,</span>threads<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">,</span>sockets<span class="token operator">=</span><span class="token number">2</span> \
    <span class="token operator">-</span>enable<span class="token operator">-</span>kvm \
    <span class="token operator">-</span>m <span class="token number">4</span>G \
    <span class="token operator">-</span>object memory<span class="token operator">-</span>backend<span class="token operator">-</span>ram<span class="token punctuation">,</span>id<span class="token operator">=</span>mem0<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">1</span>G \
    <span class="token operator">-</span>object memory<span class="token operator">-</span>backend<span class="token operator">-</span>ram<span class="token punctuation">,</span>id<span class="token operator">=</span>mem1<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">1</span>G \
    <span class="token operator">-</span>object memory<span class="token operator">-</span>backend<span class="token operator">-</span>ram<span class="token punctuation">,</span>id<span class="token operator">=</span>mem2<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">1</span>G \
    <span class="token operator">-</span>object memory<span class="token operator">-</span>backend<span class="token operator">-</span>ram<span class="token punctuation">,</span>id<span class="token operator">=</span>mem3<span class="token punctuation">,</span>size<span class="token operator">=</span><span class="token number">1</span>G \
    <span class="token operator">-</span>numa node<span class="token punctuation">,</span>memdev<span class="token operator">=</span>mem0<span class="token punctuation">,</span>cpus<span class="token operator">=</span><span class="token number">0</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span>nodeid<span class="token operator">=</span><span class="token number">0</span> \
    <span class="token operator">-</span>numa node<span class="token punctuation">,</span>memdev<span class="token operator">=</span>mem1<span class="token punctuation">,</span>cpus<span class="token operator">=</span><span class="token number">4</span><span class="token operator">-</span><span class="token number">8</span><span class="token punctuation">,</span>nodeid<span class="token operator">=</span><span class="token number">1</span> \
    <span class="token operator">-</span>numa node<span class="token punctuation">,</span>memdev<span class="token operator">=</span>mem2<span class="token punctuation">,</span>cpus<span class="token operator">=</span><span class="token number">9</span><span class="token operator">-</span><span class="token number">11</span><span class="token punctuation">,</span>nodeid<span class="token operator">=</span><span class="token number">2</span> \
    <span class="token operator">-</span>numa node<span class="token punctuation">,</span>memdev<span class="token operator">=</span>mem3<span class="token punctuation">,</span>cpus<span class="token operator">=</span><span class="token number">12</span><span class="token operator">-</span><span class="token number">15</span><span class="token punctuation">,</span>nodeid<span class="token operator">=</span><span class="token number">3</span>
</code></pre> 
<p>测试结果如下：</p> 
<pre><code class="prism language-c"><span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> Code<span class="token operator">:</span> c3 <span class="token number">90</span> f3 <span class="token number">0f</span> <span class="token number">1</span>e fa <span class="token number">48</span> c7 c0 <span class="token number">40</span> <span class="token number">1</span>e <span class="token number">02</span> <span class="token number">00</span> <span class="token number">65</span> c6 <span class="token number">05</span> f9 <span class="token number">91</span> <span class="token number">55</span> <span class="token number">44</span> <span class="token number">00</span> <span class="token number">65</span> <span class="token number">48</span> <span class="token number">03</span> <span class="token number">05</span> <span class="token number">65</span> <span class="token number">64</span> <span class="token number">54</span> <span class="token number">44</span> ba <span class="token number">04</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> f0 <span class="token number">0f</span> c1 <span class="token number">90</span> b8 <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token operator">&lt;</span><span class="token number">83</span><span class="token operator">&gt;</span> e2 <span class="token number">02</span> <span class="token number">74</span> <span class="token number">01</span> c3 <span class="token number">0f</span> <span class="token number">0</span>b c3 <span class="token number">66</span> <span class="token number">66</span> <span class="token number">2</span>e <span class="token number">0f</span> <span class="token number">1f</span> <span class="token number">84</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">00</span> <span class="token number">0ff</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> RSP<span class="token operator">:</span> <span class="token number">0018</span><span class="token operator">:</span>ffffb01b009e3e78 EFLAGS<span class="token operator">:</span> <span class="token number">00000212</span> ORIG_RAX<span class="token operator">:</span> ffffffffffffff13
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> RAX<span class="token operator">:</span> ffff9cdb7eba1e40 RBX<span class="token operator">:</span> <span class="token number">0000000000000001</span> RCX<span class="token operator">:</span> <span class="token number">0000000000000000</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> RDX<span class="token operator">:</span> <span class="token number">000000006063404</span>e RSI<span class="token operator">:</span> <span class="token number">0000000000000040</span> RDI<span class="token operator">:</span> ffffffffbcd26ee0
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> RBP<span class="token operator">:</span> ffffb01b00dbfea0 R08<span class="token operator">:</span> <span class="token number">0000000000000000</span> R09<span class="token operator">:</span> <span class="token number">0000000000020</span>a40
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> R10<span class="token operator">:</span> ffff9cdb7eba1200 R11<span class="token operator">:</span> <span class="token number">0000000000000001</span> R12<span class="token operator">:</span> ffffb01b00dbfec4
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> R13<span class="token operator">:</span> <span class="token number">0000000000000000</span> R14<span class="token operator">:</span> ffff9cdb7eb9c300 R15<span class="token operator">:</span> <span class="token number">0000000000000282</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> FS<span class="token operator">:</span>  <span class="token number">0000000000000000</span><span class="token punctuation">(</span><span class="token number">0000</span><span class="token punctuation">)</span> GS<span class="token operator">:</span><span class="token function">ffff9cdb7eb80000</span><span class="token punctuation">(</span><span class="token number">0000</span><span class="token punctuation">)</span> knlGS<span class="token operator">:</span><span class="token number">0000000000000000</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> CS<span class="token operator">:</span>  <span class="token number">0010</span> DS<span class="token operator">:</span> <span class="token number">0000</span> ES<span class="token operator">:</span> <span class="token number">0000</span> CR0<span class="token operator">:</span> <span class="token number">0000000080050033</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> CR2<span class="token operator">:</span> <span class="token number">00007f</span><span class="token number">593795e000</span> CR3<span class="token operator">:</span> <span class="token number">00000000</span>a660a003 CR4<span class="token operator">:</span> <span class="token number">0000000000360</span>ee0
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span> Call Trace<span class="token operator">:</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  multi_cpu_stop<span class="token operator">+</span><span class="token number">0xa6</span><span class="token operator">/</span><span class="token number">0xd0</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  <span class="token operator">?</span> cpu_stop_queue_work<span class="token operator">+</span><span class="token number">0xc0</span><span class="token operator">/</span><span class="token number">0xc0</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  cpu_stopper_thread<span class="token operator">+</span><span class="token number">0x64</span><span class="token operator">/</span><span class="token number">0xe0</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  smpboot_thread_fn<span class="token operator">+</span><span class="token number">0xb7</span><span class="token operator">/</span><span class="token number">0x150</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  kthread<span class="token operator">+</span><span class="token number">0xf7</span><span class="token operator">/</span><span class="token number">0x130</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  <span class="token operator">?</span> sort_range<span class="token operator">+</span><span class="token number">0x20</span><span class="token operator">/</span><span class="token number">0x20</span>
<span class="token punctuation">[</span>   <span class="token number">72.584951</span><span class="token punctuation">]</span>  <span class="token operator">?</span> kthread_flush_work_fn
<span class="token punctuation">[</span>   <span class="token number">72.507088</span><span class="token punctuation">]</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">9</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">9</span><span class="token operator">:</span><span class="token number">66</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>   <span class="token number">72.544143</span><span class="token punctuation">]</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">10</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">10</span><span class="token operator">:</span><span class="token number">73</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>   <span class="token number">72.544175</span><span class="token punctuation">]</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">12</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">12</span><span class="token operator">:</span><span class="token number">85</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>   <span class="token number">72.564634</span><span class="token punctuation">]</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">13</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">13</span><span class="token operator">:</span><span class="token number">92</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>   <span class="token number">72.568761</span><span class="token punctuation">]</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">14</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">14</span><span class="token operator">:</span><span class="token number">98</span><span class="token punctuation">]</span>
<span class="token punctuation">[</span>   <span class="token number">72.583969</span><span class="token punctuation">]</span> watchdog<span class="token operator">:</span> BUG<span class="token operator">:</span> soft lockup <span class="token operator">-</span> CPU#<span class="token number">15</span> stuck <span class="token keyword">for</span> <span class="token number">22</span>s<span class="token operator">!</span> <span class="token punctuation">[</span>migration<span class="token operator">/</span><span class="token number">15</span><span class="token operator">:</span><span class="token number">104</span><span class="token punctuation">]</span>
<span class="token operator">/</span> # dmesg <span class="token operator">|</span> grep <span class="token string">"Killed"</span>
<span class="token punctuation">[</span>   <span class="token number">72.593418</span><span class="token punctuation">]</span> Out of memory<span class="token operator">:</span> Killed process <span class="token number">3280</span> <span class="token punctuation">(</span>alloc_mem<span class="token punctuation">)</span> total<span class="token operator">-</span>vm<span class="token operator">:</span><span class="token number">1396</span>kB<span class="token punctuation">,</span> anon<span class="token operator">-</span>rss<span class="token operator">:</span><span class="token number">200</span>kB<span class="token punctuation">,</span> file<span class="token operator">-</span>rss<span class="token operator">:</span><span class="token number">28</span>kB<span class="token punctuation">,</span> shmem<span class="token operator">-</span>rss<span class="token operator">:</span><span class="token number">0</span>kB
</code></pre> 
<p>从上可以看到和服务器报错基本一致，在 watchdog: BUG: soft lockup 后紧跟着会出现 Killed process 的打印。</p> 
<h4><a id="_soft_lockup__611"></a>触发 soft lockup 原因分析（一）：</h4> 
<p>首先从 soft lockup 堆栈分析：</p> 
<pre><code class="prism language-c">kthread
	<span class="token operator">-&gt;</span> smpboot_thread_fn
		<span class="token operator">-&gt;</span> cpu_stopper_thread
			<span class="token operator">-&gt;</span> multi_cpu_stop
				<span class="token operator">-&gt;</span> <span class="token punctuation">(</span>soft lockup<span class="token punctuation">)</span>
</code></pre> 
<p>cpu_stopper_thread 是一个迁移线程，代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cpu_stopper_thread</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">cpu_stopper</span> <span class="token operator">*</span>stopper <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>cpu_stopper<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">struct</span> <span class="token class-name">cpu_stop_work</span> <span class="token operator">*</span>work<span class="token punctuation">;</span>

repeat<span class="token operator">:</span>
	work <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token function">raw_spin_lock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">list_empty</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>works<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		work <span class="token operator">=</span> <span class="token function">list_first_entry</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>works<span class="token punctuation">,</span>
					<span class="token keyword">struct</span> <span class="token class-name">cpu_stop_work</span><span class="token punctuation">,</span> list<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">list_del_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token operator">-&gt;</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">raw_spin_unlock_irq</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>lock<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>work<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		<span class="token class-name">cpu_stop_fn_t</span> fn <span class="token operator">=</span> work<span class="token operator">-&gt;</span>fn<span class="token punctuation">;</span>
		<span class="token keyword">void</span> <span class="token operator">*</span>arg <span class="token operator">=</span> work<span class="token operator">-&gt;</span>arg<span class="token punctuation">;</span>
		<span class="token keyword">struct</span> <span class="token class-name">cpu_stop_done</span> <span class="token operator">*</span>done <span class="token operator">=</span> work<span class="token operator">-&gt;</span>done<span class="token punctuation">;</span>
		<span class="token keyword">int</span> ret<span class="token punctuation">;</span>

		<span class="token comment">/* cpu stop callbacks must not sleep, make in_atomic() == T */</span>
		<span class="token function">preempt_count_inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		ret <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>ret<span class="token punctuation">)</span>
				done<span class="token operator">-&gt;</span>ret <span class="token operator">=</span> ret<span class="token punctuation">;</span>
			<span class="token function">cpu_stop_signal_done</span><span class="token punctuation">(</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">preempt_count_dec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">WARN_ONCE</span><span class="token punctuation">(</span><span class="token function">preempt_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			  <span class="token string">"cpu_stop: %pf(%p) leaked preempt count\n"</span><span class="token punctuation">,</span> fn<span class="token punctuation">,</span> arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">goto</span> repeat<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/* signal completion unless @done is NULL */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">cpu_stop_signal_done</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cpu_stop_done</span> <span class="token operator">*</span>done<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>done<span class="token operator">-&gt;</span>nr_todo<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">complete</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>done<span class="token operator">-&gt;</span>completion<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>首先：迁移线程从 &amp;per_cpu(cpu_stopper, cpu) 中取出本 cpu 的 stopper 结构体，stopper-&gt;works 链表中保存了当前需要在迁移线程中执行的回调函数。并依次进行回调函数调用，并且完成后通过 cpu_stop_signal_done函数中的完成量唤醒等待该回调完成的任务。而本次触发 soft lockup 的地点正是其中的一个回调：multi_cpu_stop。<br> 接着：迁移线程是一个 stop task，也就是最高优先级的线程，专用于一些必须停机操作的重要任务使用，比如任务迁移，ftrace 修改 text 段等。<br> 内核中使用 stop_machine, stop_cpus, stop_one_cpu, stop_one_cpu_nowait, stop_two_cpus 等来注册在停机时调用的函数，他们最终都会调用 cpu_stop_queue_work 或者 cpu_stop_queue_two_works函数。比如 cpu_stop_queue_work 代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> bool <span class="token function">cpu_stop_queue_work</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">cpu_stop_work</span> <span class="token operator">*</span>work<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">cpu_stopper</span> <span class="token operator">*</span>stopper <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>cpu_stopper<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">DEFINE_WAKE_Q</span><span class="token punctuation">(</span>wakeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	bool enabled<span class="token punctuation">;</span>

	<span class="token function">preempt_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">raw_spin_lock_irqsave</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	enabled <span class="token operator">=</span> stopper<span class="token operator">-&gt;</span>enabled<span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>enabled<span class="token punctuation">)</span>
		<span class="token function">__cpu_stop_queue_work</span><span class="token punctuation">(</span>stopper<span class="token punctuation">,</span> work<span class="token punctuation">,</span> <span class="token operator">&amp;</span>wakeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>done<span class="token punctuation">)</span>
		<span class="token function">cpu_stop_signal_done</span><span class="token punctuation">(</span>work<span class="token operator">-&gt;</span>done<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">raw_spin_unlock_irqrestore</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>lock<span class="token punctuation">,</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">wake_up_q</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>wakeq<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> enabled<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__cpu_stop_queue_work</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">cpu_stopper</span> <span class="token operator">*</span>stopper<span class="token punctuation">,</span>
					<span class="token keyword">struct</span> <span class="token class-name">cpu_stop_work</span> <span class="token operator">*</span>work<span class="token punctuation">,</span>
					<span class="token keyword">struct</span> <span class="token class-name">wake_q_head</span> <span class="token operator">*</span>wakeq<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">list_add_tail</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>work<span class="token operator">-&gt;</span>list<span class="token punctuation">,</span> <span class="token operator">&amp;</span>stopper<span class="token operator">-&gt;</span>works<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">wake_q_add</span><span class="token punctuation">(</span>wakeq<span class="token punctuation">,</span> stopper<span class="token operator">-&gt;</span>thread<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>通过 __cpu_stop_queue_work 将回调包装的 cpu_stop_work 挂载在 stopper-&gt;works 链表中，并且唤醒迁移线程。那么就会在迁移线程中去执行注册进来的回调。</p> 
<p>回过来看触发 bug 的回调 multi_cpu_stop，它的注册点有两个：<br> 第一处：</p> 
<pre><code class="prism language-c">handle_pte_fault
  <span class="token operator">-&gt;</span> do_numa_page
    <span class="token operator">-&gt;</span> task_numa_fault
      <span class="token operator">-&gt;</span> numa_migrate_preferred
        <span class="token operator">-&gt;</span> task_numa_migrate
          <span class="token operator">-&gt;</span> migrate_swap
            <span class="token operator">-&gt;</span> <span class="token function">stop_two_cpus</span><span class="token punctuation">(</span>arg<span class="token punctuation">.</span>dst_cpu<span class="token punctuation">,</span> arg<span class="token punctuation">.</span>src_cpu<span class="token punctuation">,</span> migrate_swap_stop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>arg<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token operator">-&gt;</span> <span class="token function">cpu_stop_queue_two_works</span><span class="token punctuation">(</span>work1 <span class="token operator">=</span> work2 <span class="token operator">=</span> multi_cpu_stop<span class="token punctuation">)</span>
</code></pre> 
<p>该处为在 page fault 处理 numa 节点交换任务时，通过在两个 cpu 中的任意一个上执行 multi_cpu_stop 函数来调用 migrate_swap_stop 来交换两个 cpu 的任务。<br> 通过测试，该处不触发 bug。</p> 
<p>第二处：</p> 
<pre><code class="prism language-c">stop_machine
  <span class="token operator">-&gt;</span> stop_machine_cpuslocked
    <span class="token operator">-&gt;</span> <span class="token function">stop_cpus</span><span class="token punctuation">(</span>cpu_online_mask<span class="token punctuation">,</span> multi_cpu_stop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>该处通过 stop_cpus 函数注册 multi_cpu_stop，并在 multi_cpu_stop 中调用我们通过 stop_machine 等注册的函数。因为执行 multi_cpu_stop 不保证 cpu 是否会离线（热插拔），所以调用 stop_cpus 时需要使用 cpus_read_lock 来保护，确保 cpu 不会离线，因此有 stop_machine_cpuslocked。</p> 
<p>该条路径触发 bug。<br> stop_machine 函数原型：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">stop_machine</span><span class="token punctuation">(</span><span class="token class-name">cpu_stop_fn_t</span> fn<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cpumask</span> <span class="token operator">*</span>cpus<span class="token punctuation">)</span><span class="token punctuation">;</span>

fn 为我们需要停机调用的回调；
data 回调使用的数据；
cpus 我们需要在哪些 cpu 上执行 fn；如果为 <span class="token constant">NULL</span>， 则为任意一个 cpu，默认为 cpumask_first（cpu0）。
</code></pre> 
<p>stop_machine 调用 stop_machine_cpuslocked 最终会调用 queue_stop_cpus_work 来注册回调，部分代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">int</span> <span class="token function">stop_machine_cpuslocked</span><span class="token punctuation">(</span><span class="token class-name">cpu_stop_fn_t</span> fn<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span>
			    <span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cpumask</span> <span class="token operator">*</span>cpus<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">multi_stop_data</span> msdata <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span> <span class="token comment">// 填充 multi_cpu_stop 中使用的数据结构</span>
		<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn<span class="token punctuation">,</span>	<span class="token comment">// 在 multi_cpu_stop 中调用的回调</span>
		<span class="token punctuation">.</span>data <span class="token operator">=</span> data<span class="token punctuation">,</span>	<span class="token comment">// 回调使用的数据</span>
		<span class="token punctuation">.</span>num_threads <span class="token operator">=</span> <span class="token function">num_online_cpus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 当前系统上线的 cpu 数量</span>
		<span class="token punctuation">.</span>active_cpus <span class="token operator">=</span> cpus<span class="token punctuation">,</span>	<span class="token comment">// 要在哪些 cpu 上执行 fn，为 NULL 默认为第一个。</span>
	<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* Set the initial state and stop all online cpus. */</span>
	<span class="token function">set_state</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msdata<span class="token punctuation">,</span> MULTI_STOP_PREPARE<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置 msdata 内部数据结构为 MULTI_STOP_PREPARE，multi_cpu_stop 中状态机的初始状态。</span>
	<span class="token keyword">return</span> <span class="token function">stop_cpus</span><span class="token punctuation">(</span>cpu_online_mask<span class="token punctuation">,</span> multi_cpu_stop<span class="token punctuation">,</span> <span class="token operator">&amp;</span>msdata<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// stop_cpus 最终调用 queue_stop_cpus_work</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>queue_stop_cpus_work代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> bool <span class="token function">queue_stop_cpus_work</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">struct</span> <span class="token class-name">cpumask</span> <span class="token operator">*</span>cpumask<span class="token punctuation">,</span>
				 <span class="token class-name">cpu_stop_fn_t</span> fn<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>arg<span class="token punctuation">,</span>
				 <span class="token keyword">struct</span> <span class="token class-name">cpu_stop_done</span> <span class="token operator">*</span>done<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">cpu_stop_work</span> <span class="token operator">*</span>work<span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">;</span>
	bool queued <span class="token operator">=</span> false<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Disable preemption while queueing to avoid getting
	 * preempted by a stopper which might wait for other stoppers
	 * to enter @fn which can lead to deadlock.
	 */</span>
	<span class="token function">preempt_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	stop_cpus_in_progress <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token function">barrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">for_each_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> cpumask<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
		work <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token function">per_cpu</span><span class="token punctuation">(</span>cpu_stopper<span class="token punctuation">.</span>stop_work<span class="token punctuation">,</span> cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>
		work<span class="token operator">-&gt;</span>fn <span class="token operator">=</span> fn<span class="token punctuation">;</span>
		work<span class="token operator">-&gt;</span>arg <span class="token operator">=</span> arg<span class="token punctuation">;</span>
		work<span class="token operator">-&gt;</span>done <span class="token operator">=</span> done<span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">cpu_stop_queue_work</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> work<span class="token punctuation">)</span><span class="token punctuation">)</span>
			queued <span class="token operator">=</span> true<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token function">barrier</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	stop_cpus_in_progress <span class="token operator">=</span> false<span class="token punctuation">;</span>
	<span class="token function">preempt_enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> queued<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>在每个 cpu 的 stopper 上挂载 worker，并通过 cpu_stop_queue_work 挂入队列并唤醒迁移线程。</p> 
<p>通过这里可知，调用 stop_machine 会使得所有 cpu 均进入停机状态，并在指定的 cpu 上完成回调，现在看看 multi_cpu_stop，代码如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* This is the cpu_stop function which stops the CPU. */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">multi_cpu_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">multi_stop_data</span> <span class="token operator">*</span>msdata <span class="token operator">=</span> data<span class="token punctuation">;</span>
	<span class="token keyword">enum</span> <span class="token class-name">multi_stop_state</span> newstate<span class="token punctuation">,</span> curstate <span class="token operator">=</span> MULTI_STOP_NONE<span class="token punctuation">;</span>
	<span class="token keyword">int</span> cpu <span class="token operator">=</span> <span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> flags<span class="token punctuation">;</span>
	bool is_active<span class="token punctuation">;</span>

	<span class="token comment">/*
	 * When called from stop_machine_from_inactive_cpu(), irq might
	 * already be disabled.  Save the state and restore it on exit.
	 */</span>
	<span class="token function">local_save_flags</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>（<span class="token number">1</span>）

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>msdata<span class="token operator">-&gt;</span>active_cpus<span class="token punctuation">)</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>（<span class="token number">2</span>）
		is_active <span class="token operator">=</span> cpu <span class="token operator">==</span> <span class="token function">cpumask_first</span><span class="token punctuation">(</span>cpu_online_mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		is_active <span class="token operator">=</span> <span class="token function">cpumask_test_cpu</span><span class="token punctuation">(</span>cpu<span class="token punctuation">,</span> msdata<span class="token operator">-&gt;</span>active_cpus<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Simple state machine */</span>
	<span class="token keyword">do</span> <span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* Chill out and ensure we re-read multi_stop_state. */</span>
		<span class="token function">cpu_relax_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		newstate <span class="token operator">=</span> <span class="token function">READ_ONCE</span><span class="token punctuation">(</span>msdata<span class="token operator">-&gt;</span>state<span class="token punctuation">)</span><span class="token punctuation">;</span> 
		<span class="token keyword">if</span> <span class="token punctuation">(</span>newstate <span class="token operator">!=</span> curstate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			curstate <span class="token operator">=</span> newstate<span class="token punctuation">;</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>curstate<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token keyword">case</span> MULTI_STOP_DISABLE_IRQ<span class="token operator">:</span>
				<span class="token function">local_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token function">hard_irq_disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> MULTI_STOP_RUN<span class="token operator">:</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>is_active<span class="token punctuation">)</span>
					err <span class="token operator">=</span> msdata<span class="token operator">-&gt;</span><span class="token function">fn</span><span class="token punctuation">(</span>msdata<span class="token operator">-&gt;</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">default</span><span class="token operator">:</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token function">ack_state</span><span class="token punctuation">(</span>msdata<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curstate <span class="token operator">&gt;</span> MULTI_STOP_PREPARE<span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/*
			 * At this stage all other CPUs we depend on must spin
			 * in the same loop. Any reason for hard-lockup should
			 * be detected and reported on their side.
			 */</span>
			<span class="token function">touch_nmi_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token function">rcu_momentary_dyntick_idle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>curstate <span class="token operator">!=</span> MULTI_STOP_EXIT<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">local_irq_restore</span><span class="token punctuation">(</span>flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> err<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（1）进入 multi_cpu_stop 后首先会保存当前中断状态，有些调用在进入 multi_cpu_stop 可能会处于禁用中断状态，我们状态机中又会主动禁用中断，所以这里保存一下以便后面恢复 irq 状态。<br> （2）如果我们在上层传入的是 NULL 那么能够执行回调的 cpu 就是第一个 cpu，否则就是我们指定的 cpumask 的所有 cpu。<br> 接下来是一个循环，循环内部存在一个简易状态机用于同步停机状态：<br> 状态机有如下顺序的状态：</p> 
<pre><code class="prism language-c"><span class="token comment">/* This controls the threads on each CPU. */</span>
<span class="token keyword">enum</span> <span class="token class-name">multi_stop_state</span> <span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* Dummy starting state for thread. */</span>
	MULTI_STOP_NONE<span class="token punctuation">,</span>
	<span class="token comment">/* Awaiting everyone to be scheduled. */</span>
	MULTI_STOP_PREPARE<span class="token punctuation">,</span>
	<span class="token comment">/* Disable interrupts. */</span>
	MULTI_STOP_DISABLE_IRQ<span class="token punctuation">,</span>
	<span class="token comment">/* Run the function */</span>
	MULTI_STOP_RUN<span class="token punctuation">,</span>
	<span class="token comment">/* Exit */</span>
	MULTI_STOP_EXIT<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> 
<p>首先是刚进入循环的初始状态 curstate = MULTI_STOP_NONE，接着通过 READ_ONCE 读取到传入的 msdata-&gt;state 的状态，从上面知道传入的状态是 MULTI_STOP_PREPARE。<br> 注意此时 multi_cpu_stop 是在所有 cpu 上执行着相同的操作，所以我们有 cpu_relax_yield READ_ONCE来确保读取到的数据一致和顺序一致。<br> 此时 newstate 不等于 curstate，那么进入 if 字段，该字段根据状态执行不同 switch case，这里现在不会执行任何操作直接 break，并且调用 ack_state。ack_state代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">multi_stop_data</span> <span class="token operator">*</span>msdata<span class="token punctuation">,</span>
		      <span class="token keyword">enum</span> <span class="token class-name">multi_stop_state</span> newstate<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/* Reset ack counter. */</span>
	<span class="token function">atomic_set</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msdata<span class="token operator">-&gt;</span>thread_ack<span class="token punctuation">,</span> msdata<span class="token operator">-&gt;</span>num_threads<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">smp_wmb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">WRITE_ONCE</span><span class="token punctuation">(</span>msdata<span class="token operator">-&gt;</span>state<span class="token punctuation">,</span> newstate<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Last one to ack a state moves to the next state. */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ack_state</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">multi_stop_data</span> <span class="token operator">*</span>msdata<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">atomic_dec_and_test</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>msdata<span class="token operator">-&gt;</span>thread_ack<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">set_state</span><span class="token punctuation">(</span>msdata<span class="token punctuation">,</span> msdata<span class="token operator">-&gt;</span>state <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

对 thread_ack 值原子减一，并且判断减一后 thread_ack 是否为 <span class="token number">0</span>，为 <span class="token number">0</span> atomic_dec_and_test 返回 true 则执行 set_state。

set_state 主要是对 thread_ack 赋值为 num_threads，并且更新 msdata<span class="token operator">-&gt;</span>state 为 newstate。
那么通过之前 stop_machine 知道，num_threads 等于 online_cpusmaks，
所以这里只有当指定的所有 cpu 都调用 ack_state 后 msdata<span class="token operator">-&gt;</span>state 状态才会往前推进，并且将 thread_ack 恢复为 num_threads 开始新一轮状态同步。
</code></pre> 
<p>接着调用 rcu_momentary_dyntick_idle 来上报一个静默期，因为在 stop_machine 里面，我们就是在经历一个静默期状态。<br> 当返回循环开始时再次通过 READ_ONCE 读取 msdata-&gt;state 的状态，那么如果此时还有其他 cpu 没有进入停机状态我们就不会开始下一个状态的执行，而是进入 else if 字段，在这里，可以看到只有当我们状态推进到 MULTI_STOP_PREPARE 时，说明所有 cpu 进入停机状态并且调用了MULTI_STOP_DISABLE_IRQ，此时可以确保中断一定是关闭的，那么我们需要在关中断期间手动复位 watchdog。<br> 同样的只有当所有 cpu 都进入下一个状态时 msdata-&gt;state 才会更新到下一个状态，此时状态来到 MULTI_STOP_RUN，这个时候 curstate 肯定和 newstate 不相等，newstate 已经来到 MULTI_STOP_RUN，curstate 还处于MULTI_STOP_DISABLE_IRQ。那么同步到 MULTI_STOP_RUN 时根据 is_active，来判断自己这个 cpu 是否需要执行这个回调，如果为 true 则说明自己需要执行，则调用 fn 回调。不需要调用的则直接 break 出去，去等待进入下一个状态。当在这里所有 cpu 都完成 fn 的调用后，cpu 同步进入 MULTI_STOP_EXIT 状态，一起退出循环，并重新恢复 irq 状态退出 multi_cpu_stop，通过完成量唤醒等待的任务。</p> 
<p>从上述状态机可知，如果 cpu 在 MULTI_STOP_PREPARE 同步状态等待时间过久，但是实际这个状态 watchdog不会手动复位，而现在又处于迁移线程中，其他线程是无法被执行的那么就有可能触发 soft lockup，见后面 watchdog 分析。</p> 
<h4><a id="_soft_lockup__895"></a>触发 soft lockup 原因分析（二）</h4> 
<p>这里简单看看 watchdog 如何触发 soft lockup。<br> 首先是系统支持检测 watchdog 后会在每个 cpu 上启动一个 watchdog 线程，用于监测系统运行，如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">struct</span> <span class="token class-name">smp_hotplug_thread</span> watchdog_threads <span class="token operator">=</span> <span class="token punctuation">{<!-- --></span>
    <span class="token punctuation">.</span>store          <span class="token operator">=</span> <span class="token operator">&amp;</span>softlockup_watchdog<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>thread_should_run  <span class="token operator">=</span> watchdog_should_run<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>thread_fn      <span class="token operator">=</span> watchdog<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>thread_comm        <span class="token operator">=</span> <span class="token string">"watchdog/%u"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>setup          <span class="token operator">=</span> watchdog_enable<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>cleanup        <span class="token operator">=</span> watchdog_cleanup<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>park           <span class="token operator">=</span> watchdog_disable<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>unpark         <span class="token operator">=</span> watchdog_enable<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watchdog</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>soft_lockup_hrtimer_cnt<span class="token punctuation">,</span>
			 <span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>hrtimer_interrupts<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">__touch_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>watchdog 线程逻辑很简单，首先将本地 cpu 的 hrtimer_interrupts 同步到本地 cpu 的 soft_lockup_hrtimer_cnt 中。<br> 最后是调用 __touch_watchdog，如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* Commands for resetting the watchdog */</span>
<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">__touch_watchdog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>watchdog_touch_ts<span class="token punctuation">,</span> <span class="token function">get_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
 * Returns seconds, approximately.  We don't need nanosecond
 * resolution, and we don't need to waste time with a big divide when
 * 2^30ns == 1.074s.
 */</span>
<span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">long</span> <span class="token function">get_timestamp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">running_clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">30LL</span><span class="token punctuation">;</span>  <span class="token comment">/* 2^30 ~= 10^9 */</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>更新 watchdog_touch_ts 的时间戳，使其与当前时间同步（单位为秒）。</p> 
<p>soft_lockup_hrtimer_cnt 的作用主要是判断当前 cpu 的 watchdog 线程是否需要运行：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">watchdog_should_run</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">return</span> <span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>hrtimer_interrupts<span class="token punctuation">)</span> <span class="token operator">!=</span>
		<span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>soft_lockup_hrtimer_cnt<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>即当 soft_lockup_hrtimer_cnt和 hrtimer_interrupts 不相等时说明 wachdog 定时器执行了，我们需要运行 watchdog 线程来同步两个变量。 hrtimer_interrupts 就是在 watchdog 的定时器中更新的，每触发一次 watchdog 则会调用 watchdog_interrupt_count 来自增 hrtimer_interrupts，如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watchdog_interrupt_count</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">__this_cpu_inc</span><span class="token punctuation">(</span>hrtimer_interrupts<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到 watchdog 线程每次运行都调用__touch_watchdog 来同步 watchdog_touch_ts 的时间为当前时间。</p> 
<p>下面看一下 watchdog 定时器：<br> 如上面结构体中的 watchdog_enable，当我们配置 smp_hotplug_thread 时会调用 setup 来配置线程，这里调用 watchdog_enable，如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">watchdog_enable</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> cpu<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>hrtimer <span class="token operator">=</span> <span class="token function">this_cpu_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>watchdog_hrtimer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/*
	 * Start the timer first to prevent the NMI watchdog triggering
	 * before the timer has a chance to fire.
	 */</span>
	<span class="token function">hrtimer_init</span><span class="token punctuation">(</span>hrtimer<span class="token punctuation">,</span> CLOCK_MONOTONIC<span class="token punctuation">,</span> HRTIMER_MODE_REL<span class="token punctuation">)</span><span class="token punctuation">;</span>
	hrtimer<span class="token operator">-&gt;</span>function <span class="token operator">=</span> watchdog_timer_fn<span class="token punctuation">;</span>
	<span class="token function">hrtimer_start</span><span class="token punctuation">(</span>hrtimer<span class="token punctuation">,</span> <span class="token function">ns_to_ktime</span><span class="token punctuation">(</span>sample_period<span class="token punctuation">)</span><span class="token punctuation">,</span>
		      HRTIMER_MODE_REL_PINNED<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* Initialize timestamp */</span>
	<span class="token function">__touch_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">/* Enable the perf event */</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>watchdog_enabled <span class="token operator">&amp;</span> NMI_WATCHDOG_ENABLED<span class="token punctuation">)</span>
		<span class="token function">watchdog_nmi_enable</span><span class="token punctuation">(</span>cpu<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">watchdog_set_prio</span><span class="token punctuation">(</span>SCHED_FIFO<span class="token punctuation">,</span> MAX_RT_PRIO <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>代码中初始化了一个 hrtimer 定时器，定时器执行 watchdog_timer_fn，周期是 sample_period，如下:</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">set_sample_period</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token comment">/*
	 * convert watchdog_thresh from seconds to ns
	 * the divide by 5 is to give hrtimer several chances (two
	 * or three with the current relation between the soft
	 * and hard thresholds) to increment before the
	 * hardlockup detector generates a warning
	 */</span>
	sample_period <span class="token operator">=</span> <span class="token function">get_softlockup_thresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>u64<span class="token punctuation">)</span>NSEC_PER_SEC <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">watchdog_update_hrtimer_threshold</span><span class="token punctuation">(</span>sample_period<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>这里大约是 20s / 5 左右。</p> 
<p>watchdog_timer_fn 定时器函数部分代码如下：</p> 
<pre><code class="prism language-c"><span class="token comment">/* watchdog kicker functions */</span>
<span class="token keyword">static</span> <span class="token keyword">enum</span> <span class="token class-name">hrtimer_restart</span> <span class="token function">watchdog_timer_fn</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">hrtimer</span> <span class="token operator">*</span>hrtimer<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> touch_ts <span class="token operator">=</span> <span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>watchdog_touch_ts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">struct</span> <span class="token class-name">pt_regs</span> <span class="token operator">*</span>regs <span class="token operator">=</span> <span class="token function">get_irq_regs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token keyword">int</span> duration<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token comment">/* kick the hardlockup detector */</span>
	<span class="token function">watchdog_interrupt_count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>

	<span class="token comment">/* kick the softlockup detector */</span>
	<span class="token function">wake_up_process</span><span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>softlockup_watchdog<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">/* .. and repeat */</span>
	<span class="token function">hrtimer_forward_now</span><span class="token punctuation">(</span>hrtimer<span class="token punctuation">,</span> <span class="token function">ns_to_ktime</span><span class="token punctuation">(</span>sample_period<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>touch_ts <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span><span class="token function">__this_cpu_read</span><span class="token punctuation">(</span>softlockup_touch_sync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
			<span class="token comment">/*
			 * If the time stamp was touched atomically
			 * make sure the scheduler tick is up to date.
			 */</span>
			<span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>softlockup_touch_sync<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">sched_clock_tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">/* Clear the guest paused flag on watchdog reset */</span>
		<span class="token function">kvm_check_and_clear_guest_paused</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">__touch_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/* check for a softlockup
	 * This is done by making sure a high priority task is
	 * being scheduled.  The task touches the watchdog to
	 * indicate it is getting cpu time.  If it hasn't then
	 * this is a good indication some task is hogging the cpu
	 */</span>
	duration <span class="token operator">=</span> <span class="token function">is_softlockup</span><span class="token punctuation">(</span>touch_ts<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">unlikely</span><span class="token punctuation">(</span>duration<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{<!-- --></span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
		<span class="token function">pr_emerg</span><span class="token punctuation">(</span><span class="token string">"BUG: soft lockup - CPU#%d stuck for %us! [%s:%d]\n"</span><span class="token punctuation">,</span>
			<span class="token function">smp_processor_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> duration<span class="token punctuation">,</span>
			current<span class="token operator">-&gt;</span>comm<span class="token punctuation">,</span> <span class="token function">task_pid_nr</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>softlockup_task_ptr_saved<span class="token punctuation">,</span> current<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">print_modules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">print_irqtrace_events</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>regs<span class="token punctuation">)</span>
			<span class="token function">show_regs</span><span class="token punctuation">(</span>regs<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			<span class="token function">dump_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span>
		<span class="token function">__this_cpu_write</span><span class="token punctuation">(</span>soft_watchdog_warn<span class="token punctuation">,</span> false<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> HRTIMER_RESTART<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>（1）获取到watchdog_touch_ts 当前值，这个值会在 watchdog 线程中一直保持更新，或者特定的调用会让这个值为 0，见后文。<br> （2）获取到当前 cpu 的 regs ，如果存在 regs 说明我们处于中断，ipi 里。<br> （3）如上所述，这里会自增 hrtimer_interrupts 变量，以便 watchdog_should_run 知道需要运行 watchdog 线程来同步该值并更新 watchdog_touch_ts 以便知道系统正在正常运行，完成自增后会尝试唤醒 watchdog 线程，来进行同步更新。此时如果上次触发定时器的线程没有运行，则watchdog_touch_ts 值不能更新，那么如果滞后当前时间戳太久了，说明当前 cpu 的线程占用 cpu 时间太久了，可能就会报告 soft lockup。<br> （4）设置下一次 定时器的到期值。<br> （5）这里会特殊处理 touch_ts等于 0 的情况，下面几个地方会设置 watchdog_touch_ts 为 0：</p> 
<pre><code class="prism language-c">touch_softlockup_watchdog_sync

touch_softlockup_watchdog
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token operator">-&gt;</span> touch_softlockup_watchdog_sched

touch_all_softlockup_watchdogs
</code></pre> 
<p>在 stop_machine 中调用的是 touch_nmi_watchdog：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">inline</span> <span class="token keyword">void</span> <span class="token function">touch_nmi_watchdog</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">arch_touch_nmi_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 对于 x86 和 arm64 为空</span>
	<span class="token function">touch_softlockup_watchdog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>也就是说在 stop_machine 中每次循环如果检测到状态没有向前推进则会把 watchdog_touch_ts 设置为 0。<br> 这里设置为 0 我的理解是当手动关中断，并且需要进行耗时操作时，我们手动调用上述 api 来复位 watchdog_touch_ts ，这样即便我们长时间没触发 watchdog 线程的执行，也可以在定时器里检测到这种长时间关中断的状态，并作额外处理，对于现在的情况则是简单的重新将当前时间戳同步到 watchdog_touch_ts ，那么后面 soft lockup 判断时就不会误报。<br> （6）这里就会去检测是否是触发了 soft lockup，代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">is_softlockup</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">long</span> touch_ts<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token keyword">unsigned</span> <span class="token keyword">long</span> now <span class="token operator">=</span> <span class="token function">get_timestamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>watchdog_enabled <span class="token operator">&amp;</span> SOFT_WATCHDOG_ENABLED<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> watchdog_thresh<span class="token punctuation">)</span><span class="token punctuation">{<!-- --></span>
		<span class="token comment">/* Warn about unreasonable delays. */</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">time_after</span><span class="token punctuation">(</span>now<span class="token punctuation">,</span> touch_ts <span class="token operator">+</span> <span class="token function">get_softlockup_thresh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> now <span class="token operator">-</span> touch_ts<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>可以看到，如果我们配置了激活 soft watchdog，并且超时阈值 watchdog_thresh 有值，则检测 soft lockup，获取当前时间戳并与 watchdog_touch_ts + watchdog_thresh * 2比较，如果 now 大于了它那么说明由 soft lockup，返回差值（阈值大概 20s）。</p> 
<p>综上可以看到，如果 watchdog_touch_ts 没有被 watchdog 线程及时更新，或者没有类似 touch_softlockup_watchdog 的 api 手动复位 watchdog_touch_ts 则会触发 soft lockup。</p> 
<p>在 stop_machine 中我们有 touch_nmi_watchdog 来复位watchdog_touch_ts 为什么还会触发 soft lockup 呢？下面看看 Cgroup memory oom killer 相关逻辑。</p> 
<h4><a id="_soft_lockup__1106"></a>触发 soft lockup 原因分析（三）</h4> 
<p>通过 oom killer 的堆栈知道，在 cgroup memory 内存超限时，我们在下述路径触发 soft lockup：</p> 
<pre><code class="prism language-c">pagefault_out_of_memory
  <span class="token operator">-&gt;</span> out_of_memory
    <span class="token operator">-&gt;</span> oom_kill_process
      <span class="token operator">-&gt;</span> <span class="token function">dump_header</span><span class="token punctuation">(</span>dump 期间触发 soft lockup<span class="token punctuation">)</span>
</code></pre> 
<p>dump_header代码如下：</p> 
<pre><code class="prism language-c"><span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">dump_header</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">oom_control</span> <span class="token operator">*</span>oc<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">task_struct</span> <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">{<!-- --></span>
	<span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"%s invoked oom-killer: gfp_mask=%#x(%pGg), nodemask=%*pbl, order=%d, oom_score_adj=%hd\n"</span><span class="token punctuation">,</span>
		current<span class="token operator">-&gt;</span>comm<span class="token punctuation">,</span> oc<span class="token operator">-&gt;</span>gfp_mask<span class="token punctuation">,</span> <span class="token operator">&amp;</span>oc<span class="token operator">-&gt;</span>gfp_mask<span class="token punctuation">,</span>
		<span class="token function">nodemask_pr_args</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>nodemask<span class="token punctuation">)</span><span class="token punctuation">,</span> oc<span class="token operator">-&gt;</span>order<span class="token punctuation">,</span>
			current<span class="token operator">-&gt;</span>signal<span class="token operator">-&gt;</span>oom_score_adj<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IS_ENABLED</span><span class="token punctuation">(</span>CONFIG_COMPACTION<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> oc<span class="token operator">-&gt;</span>order<span class="token punctuation">)</span>
		<span class="token function">pr_warn</span><span class="token punctuation">(</span><span class="token string">"COMPACTION is disabled!!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">cpuset_print_current_mems_allowed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">dump_stack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_memcg_oom</span><span class="token punctuation">(</span>oc<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">mem_cgroup_print_oom_info</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>memcg<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token punctuation">{<!-- --></span>
		<span class="token function">show_mem</span><span class="token punctuation">(</span>SHOW_MEM_FILTER_NODES<span class="token punctuation">,</span> oc<span class="token operator">-&gt;</span>nodemask<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_dump_unreclaim_slabs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token function">dump_unreclaimable_slab</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>sysctl_oom_dump_tasks<span class="token punctuation">)</span>
		<span class="token function">dump_tasks</span><span class="token punctuation">(</span>oc<span class="token operator">-&gt;</span>memcg<span class="token punctuation">,</span> oc<span class="token operator">-&gt;</span>nodemask<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> 
<p>该函数会 dump 出当前任务的内存信息，栈信息，以及对应的 memory cgroup 节点信息，以及所有可以被 kill 的 task。对于 mem_cgroup_print_oom_info 和 dump_tasks 都有大量的遍历动作，并且遍历期间有使用 rcu_read_lock 保护，此时任务是不能被调度走的（该环境 kubepods 节点下任务非常多）。<br> 所以当上述逻辑触发时，如果某个 cpu 上此时执行 stop_machine 相关的 api，则会触发停机操作，并且迁移线程中还会等待同步所有 cpu 进入停机状态才能执行回调。由于本身服务器没有配置支持抢占，加上有 rcu_read_lock 存在，我们线程执行期间是不会触发调度的，那么迁移线程一定会等到 oom_kill_process的线程执行退出后才能被执行，所以当我们停机时 stop_machine 是可能处于长时间等待状态的。如果此时等待位置是 MULTI_STOP_PREPARE 状态则会触发问题。<br> 这个是在本地进行的测试，在 multi_cpu_stop 中将else if (curstate &gt; MULTI_STOP_PREPARE)修改为else if (curstate &gt;= MULTI_STOP_PREPARE)后，本地不再触发 soft lockup。<br> 这样修改的理由是，我不等 cpu 调用了 case MULTI_STOP_DISABLE_IRQ:这条路径后才去手动触发 touch_nmi_watchdog。而是让 cpu 进入停机状态后就开始触发 touch_nmi_watchdog，这样的话，每个 cpu 进入 multi_cpu_stop 只要不能进入下一个状态都会去复位watchdog_touch_ts，因为如果处于 MULTI_STOP_PREPARE 状态长时间挂起时，watchdog 线程无法被执行，无法更新 watchdog_touch_ts，也无法通过 touch_nmi_watchdog 来复位 watchdog，那么就会触发 soft lockup。</p> 
<p>该问题目前在最新 linux-6.x 上仍然存在，或许是个潜在问题，不过能够触发上述描述的问题本身系统管理上就已经存在问题了，而因此不应该把该问题抛给内核解决，也或许是类似的因素导致社区目前仍然没有去解决该潜在的问题。</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/33965879546dc0a14623931ba4051a32/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Oracle-数据库迁移之后性能变慢问题分析</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/9430f83ac0f727e88a1a79b1152e48d1/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">MPLS动态协议LDP配置示例</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>