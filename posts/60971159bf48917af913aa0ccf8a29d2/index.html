<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>android代码控制安装apk - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="android代码控制安装apk" />
<meta property="og:description" content="android代码控制安装apk 平时我们在使用商城的时候，下载完apk就可以自动的弹出安装的画面并且有的手机还会帮你检测apk的来源是否安全。
由于项目上有个需求是远程升级apk，所以需要在自己做的程序中代码控制安装apk。
网上查询了一番后有人给出了下述方法，用PackageInstaller帮助安装apk,这个其实是一个系统预安装的apk,就是我们平时用商城安装程序吊起的界面。
一番查询后网上给出了如下的解决方案：
File apk = new File(path); Uri uri = FileProvider.getUriForFile(mContext, &#34;com.yanfeng.poc.ota.fileProvider&#34;, apk); Intent intent = new Intent(Intent.ACTION_VIEW); intent.setDataAndType(uri, &#34;application/vnd.android.package-archive&#34;); intent.setClassName(&#34;com.android.packageinstaller&#34;, &#34;com.android.packageinstaller.PackageInstallerActivity&#34;); intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION); intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK); mContext.startActivity(intent); 然后发现会报如下的错误：
java.lang.SecurityException: Permission Denial: starting Intent { act=android.intent.action.VIEW dat=content://com.yanfeng.poc.ota.fileProvider/apk/app-debug.apk typ=application/vnd.android.package-archive flg=0x10000001 cmp=com.android.packageinstaller/.PackageInstallerActivity } from ProcessRecord{a4b2c99 12176:com.yanfeng.poc.ota/u0a173} (pid=12176, uid=10173) not exported from uid 10046 一开始我以为是应用权限等级不够，不是系统应用无法拉起这个安装的界面，后来我在adb shell中用am start -n com.android.packageinstaller/.PackageInstallerActivity想要吊起界面依旧失败了，报错也类似有not exported from uid 10046这个字样，于是一番查询后发现uid其实是android资源是否能共享的一个标识符，如果在表单文件中对activity的exported设置为false那么不是同一个uid的进程不能吊起这个activity，也就是说.PackageInstallerActivity这个activity设置了exported为false，它不能用别的应用拉起它，只能是自己的activity跳转的时候拉起这个activity。于是我在adb shell中 敲入pm list package -f | grep install查看包名和apk的路径，我在安卓9.0的系统的板子上查询到了这个apk的路径如下
package:/system/priv-app/PackageInstaller/PackageInstaller.apk=com.android.packageinstaller" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/60971159bf48917af913aa0ccf8a29d2/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2020-08-17T11:05:19+08:00" />
<meta property="article:modified_time" content="2020-08-17T11:05:19+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">android代码控制安装apk</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-github-gist">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="androidapk_0"></a>android代码控制安装apk</h3> 
<p>平时我们在使用商城的时候，下载完apk就可以自动的弹出安装的画面并且有的手机还会帮你检测apk的来源是否安全。<br> 由于项目上有个需求是远程升级apk，所以需要在自己做的程序中代码控制安装apk。<br> 网上查询了一番后有人给出了下述方法，用PackageInstaller帮助安装apk,这个其实是一个系统预安装的apk,就是我们平时用商城安装程序吊起的界面。<br> 一番查询后网上给出了如下的解决方案：</p> 
<pre><code class="prism language-java">        File apk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Uri uri <span class="token operator">=</span> FileProvider<span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token string">"com.yanfeng.poc.ota.fileProvider"</span><span class="token punctuation">,</span> apk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span><span class="token string">"com.android.packageinstaller"</span><span class="token punctuation">,</span> <span class="token string">"com.android.packageinstaller.PackageInstallerActivity"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
        intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
        mContext<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后发现会报如下的错误：</p> 
<pre><code class="prism language-java">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>SecurityException<span class="token operator">:</span> Permission Denial<span class="token operator">:</span> starting Intent <span class="token punctuation">{<!-- --></span> act<span class="token operator">=</span>android<span class="token punctuation">.</span>intent<span class="token punctuation">.</span>action<span class="token punctuation">.</span>VIEW dat<span class="token operator">=</span>content<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>com<span class="token punctuation">.</span>yanfeng<span class="token punctuation">.</span>poc<span class="token punctuation">.</span>ota<span class="token punctuation">.</span>fileProvider<span class="token operator">/</span>apk<span class="token operator">/</span>app<span class="token operator">-</span>debug<span class="token punctuation">.</span>apk typ<span class="token operator">=</span>application<span class="token operator">/</span>vnd<span class="token punctuation">.</span>android<span class="token punctuation">.</span><span class="token keyword">package</span><span class="token operator">-</span>archive flg<span class="token operator">=</span><span class="token number">0x10000001</span> cmp<span class="token operator">=</span>com<span class="token punctuation">.</span>android<span class="token punctuation">.</span>packageinstaller<span class="token operator">/</span><span class="token punctuation">.</span>PackageInstallerActivity <span class="token punctuation">}</span> from ProcessRecord<span class="token punctuation">{<!-- --></span>a4b2c99 <span class="token number">12176</span><span class="token operator">:</span>com<span class="token punctuation">.</span>yanfeng<span class="token punctuation">.</span>poc<span class="token punctuation">.</span>ota<span class="token operator">/</span>u0a173<span class="token punctuation">}</span> <span class="token punctuation">(</span>pid<span class="token operator">=</span><span class="token number">12176</span><span class="token punctuation">,</span> uid<span class="token operator">=</span><span class="token number">10173</span><span class="token punctuation">)</span> not exported from uid <span class="token number">10046</span>
</code></pre> 
<p>一开始我以为是应用权限等级不够，不是系统应用无法拉起这个安装的界面，后来我在adb shell中用am start -n com.android.packageinstaller/.PackageInstallerActivity想要吊起界面依旧失败了，报错也类似有not exported from uid 10046这个字样，于是一番查询后发现uid其实是android资源是否能共享的一个标识符，如果在表单文件中对activity的exported设置为false那么不是同一个uid的进程不能吊起这个activity，也就是说.PackageInstallerActivity这个activity设置了exported为false，它不能用别的应用拉起它，只能是自己的activity跳转的时候拉起这个activity。于是我在adb shell中 敲入pm list package -f | grep install查看包名和apk的路径，我在安卓9.0的系统的板子上查询到了这个apk的路径如下<br> package:/system/priv-app/PackageInstaller/PackageInstaller.apk=com.android.packageinstaller<br> 我们把这个apk拖动到android studio内可以查看它的表单文件，它有很多个activity，大部分都是exported为false<br> 其中我找到了真正的我们应该吊起的activity<br> <br> 这个activity也是这个apk的默认启动activity。<br> 也就是所如果我们能够将需要安装的apk的参数传递给这个activity并且吊起这个activity的界面我们就能够安装上apk。</p> 
<pre><code class="prism language-java">    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.REQUEST_INSTALL_PACKAGES"</span><span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>uses<span class="token operator">-</span>permission android<span class="token operator">:</span>name<span class="token operator">=</span><span class="token string">"android.permission.READ_EXTERNAL_STORAGE"</span> <span class="token operator">/</span><span class="token operator">&gt;</span>
</code></pre> 
<p>我们在我们需要用程序控制安装apk的manifest中加入如下3个权限，吊起activity的代码如下</p> 
<pre><code class="prism language-java">            File apk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Uri uri <span class="token operator">=</span> FileProvider<span class="token punctuation">.</span><span class="token function">getUriForFile</span><span class="token punctuation">(</span>mContext<span class="token punctuation">,</span> <span class="token string">"com.yanfeng.poc.ota.fileProvider"</span><span class="token punctuation">,</span> apk<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Intent intent <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Intent</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>ACTION_VIEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setDataAndType</span><span class="token punctuation">(</span>uri<span class="token punctuation">,</span> <span class="token string">"application/vnd.android.package-archive"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">setClassName</span><span class="token punctuation">(</span><span class="token string">"com.android.packageinstaller"</span><span class="token punctuation">,</span> <span class="token string">"com.android.packageinstaller.InstallStart"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_GRANT_READ_URI_PERMISSION<span class="token punctuation">)</span><span class="token punctuation">;</span>
            intent<span class="token punctuation">.</span><span class="token function">addFlags</span><span class="token punctuation">(</span>Intent<span class="token punctuation">.</span>FLAG_ACTIVITY_NEW_TASK<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mContext<span class="token punctuation">.</span><span class="token function">startActivity</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> 
<p>然后程序就成功安装了</p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ef698ed5f2d8cf54c79c2ad659f0fc51/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">Redis的五种常用数据类型、三种特殊数据类型详解</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6ac16313d6ae46d66843ea7e54ebff23/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">Linux文本过滤某列不为空的值并写入新文本</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>