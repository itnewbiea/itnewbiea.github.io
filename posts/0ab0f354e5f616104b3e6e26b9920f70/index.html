<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>ModbusRTU\TCP消息帧解析（C#实现报文发送与解析） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="ModbusRTU\TCP消息帧解析（C#实现报文发送与解析）" />
<meta property="og:description" content="目录 知识点常用链接一、Modbus1.ModbusRTU消息帧解析2.主站poll、从站slave通讯仿真-modbusRTU1.功能码=01读线圈状态2.功能码=03读保持寄存器报文解析（寄存器存整型）报文解析（寄存器存float） 3.C#模拟主站Poll（ModbusRTU协议-组报文）4.NModbus4模拟主站poll（ModbusRTU协议）5.C#模拟主站Poll（ModbusTCP协议-组报文）6.NModbus4模拟从站slave（ModbusTCP协议）7.NModbus4模拟从站slave（ModbusRTU协议）8.modbusRTU、modbusTCP报文不同之处 二、明文TCP 知识点 PLC寄存器中存储（整型和无符号整型：2字节。长整型：4字节。单精度浮点数：4字节。双精度浮点数：8字节），我们只要知道数据类型，是2个字节一截取，还是4个字节 ，对接收到的报文进行字节截取然后编码成str就行向PLC中写入Float，float占4个字节=2个寄存器，所以要使用功能码“写多寄存器0x10”, 功能码0x06只能写一个寄存器”serialPort.write(bytes,0,bytes.Length); thread.sleep(300); serialPort.Read() 发完指令后，要等待从站响应300ms,然后再去读数据主站请求从站有两种方式：主动（手动点击查询线圈状态的按钮）被动（通过委托方式，一件事情的发生触发另外事件。场景：称菜，菜一放上去，触发去查询的功能代码块）一个F要用4个二进制表示，两个F用8个二进制表示，所以 0xFA ：表示1个字节modbusTCP响应 Tx:00 00 00 00 00 03 01 83 02 【83=1000 0011 （功能码03 的高位为1，就是异常）02是错误码代号要查表】
send()/recv()和write()/read()：发送数据和接收数据 参考链接socket原理不同协议图，
比如omoronsocekt, modbustcp,他们都是用socket进行数据交互，只是他们在应用层采用不同的协议约定，对报文进行不同方式的解析；明文协议就是直接编码不组包，其他协议都是组包发出去（如明文协议，将字符串编码后直接send
modbustcp协议，要组装发送报文为（从站地址&#43;功能码&#43;等等&#43;字符串数据）） 常用链接 虚拟串口调试工具 V6.9 汉化版免费版
串口、Modbus通信协议
一、Modbus 课程
文章介绍
一篇博客
1.ModbusRTU消息帧解析 2.主站poll、从站slave通讯仿真-modbusRTU 从站slave用于模拟PLC中的功能区，一个tab页表示一个功能模块（下图建了两个功能块）
主站poll发送请求，获取PLC中数据。
poll、slave都要设置connection、setup两个区域，只有参数配对了才能正常收发数据
1.功能码=01读线圈状态 报文都是16进制表示
16进制 0X01=0000 0001，一位16进制需要4位二进制表达（F =1111），两个16进制数字表示1个字节
线圈中数据要么是0，要么是1
读取长度：00 0A表示读取10个寄存器
响应字节数（单位是字节）：02 表示两个字节，从02往后数两个字节都是数据未位
输出状态：A2 02 这是两字节，解析：先颠倒高低位 02 A2= 0000 0010 1010 0010 再反向读取数据0100 0101 0100 0000" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/0ab0f354e5f616104b3e6e26b9920f70/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-11-28T17:54:54+08:00" />
<meta property="article:modified_time" content="2023-11-28T17:54:54+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">ModbusRTU\TCP消息帧解析（C#实现报文发送与解析）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-light">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <p></p> 
<div class="toc"> 
 <h4>目录</h4> 
 <ul><li><a href="#_1" rel="nofollow">知识点</a></li><li><a href="#_17" rel="nofollow">常用链接</a></li><li><a href="#Modbus_22" rel="nofollow">一、Modbus</a></li><li><ul><li><a href="#1ModbusRTU_26" rel="nofollow">1.ModbusRTU消息帧解析</a></li><li><a href="#2pollslavemodbusRTU_37" rel="nofollow">2.主站poll、从站slave通讯仿真-modbusRTU</a></li><li><ul><li><a href="#101_42" rel="nofollow">1.功能码=01读线圈状态</a></li><li><a href="#203_53" rel="nofollow">2.功能码=03读保持寄存器</a></li><li><ul><li><a href="#_56" rel="nofollow">报文解析（寄存器存整型）</a></li><li><a href="#float_62" rel="nofollow">报文解析（寄存器存float）</a></li></ul> 
   </li></ul> 
   </li><li><a href="#3CPollModbusRTU_67" rel="nofollow">3.C#模拟主站Poll（ModbusRTU协议-组报文）</a></li><li><a href="#4NModbus4pollModbusRTU_292" rel="nofollow">4.NModbus4模拟主站poll（ModbusRTU协议）</a></li><li><a href="#5CPollModbusTCP_298" rel="nofollow">5.C#模拟主站Poll（ModbusTCP协议-组报文）</a></li><li><a href="#6NModbus4slaveModbusTCP_505" rel="nofollow">6.NModbus4模拟从站slave（ModbusTCP协议）</a></li><li><a href="#7NModbus4slaveModbusRTU_575" rel="nofollow">7.NModbus4模拟从站slave（ModbusRTU协议）</a></li><li><a href="#8modbusRTUmodbusTCP_683" rel="nofollow">8.modbusRTU、modbusTCP报文不同之处</a></li></ul> 
  </li><li><a href="#TCP_688" rel="nofollow">二、明文TCP</a></li></ul> 
</div> 
<p></p> 
<h2><a id="_1"></a>知识点</h2> 
<ol><li>PLC寄存器中存储（整型和无符号整型：2字节。长整型：4字节。单精度浮点数：4字节。双精度浮点数：8字节），我们只要知道数据类型，是2个字节一截取，还是4个字节 ，对接收到的报文进行字节截取然后编码成str就行</li><li>向PLC中写入Float，float占4个字节=2个寄存器，所以要使用功能码“写多寄存器0x10”, 功能码0x06只能写一个寄存器”</li><li>serialPort.write(bytes,0,bytes.Length); thread.sleep(300); serialPort.Read() 发完指令后，要等待从站响应300ms,然后再去读数据</li><li>主站请求从站有两种方式：主动（手动点击查询线圈状态的按钮）被动（通过委托方式，一件事情的发生触发另外事件。场景：称菜，菜一放上去，触发去查询的功能代码块）</li><li>一个F要用4个二进制表示，两个F用8个二进制表示，所以 0xFA ：表示1个字节</li><li>modbusTCP响应 Tx:00 00 00 00 00 03 01 83 02 【83=1000 0011 （功能码03 的高位为1，就是异常）02是错误码代号要查表】<br> <img src="https://images2.imgbox.com/86/c5/nlufnGJC_o.png" alt="在这里插入图片描述"></li><li>send()/recv()和write()/read()：发送数据和接收数据 <a href="https://blog.csdn.net/baidu_15547923/article/details/90206381">参考链接</a></li><li>socket<a href="https://blog.csdn.net/yyuggjggg/article/details/126223455">原理</a></li><li>不同协议图，<br> <img src="https://images2.imgbox.com/27/da/orCzJw7g_o.png" alt="在这里插入图片描述"></li><li>比如omoronsocekt, modbustcp,他们都是用socket进行数据交互，只是他们在应用层采用不同的协议约定，对报文进行不同方式的解析；明文协议就是直接编码不组包，其他协议都是组包发出去（如明文协议，将字符串编码后直接send<br> modbustcp协议，要组装发送报文为（从站地址+功能码+等等+字符串数据））</li></ol> 
<h2><a id="_17"></a>常用链接</h2> 
<p><a href="https://www.jb51.net/softs/834377.html#downintro2" rel="nofollow">虚拟串口调试工具 V6.9 汉化版免费版</a><br> <img src="https://images2.imgbox.com/c7/85/M1Bd9ISI_o.png" alt="在这里插入图片描述"><br> <a href="https://blog.csdn.net/liyuanjunfrank/article/details/124118273">串口、Modbus通信协议</a></p> 
<h2><a id="Modbus_22"></a>一、Modbus</h2> 
<p><a href="https://www.bilibili.com/video/BV1KA411U7QR/?p=4&amp;spm_id_from=pageDriver&amp;vd_source=f00d63619365673a93ecf17f4b6307b0" rel="nofollow">课程</a><br> <a href="https://blog.csdn.net/qq_16284479/article/details/127777327">文章介绍</a><br> <a href="https://blog.csdn.net/chengcao123/article/details/126171213">一篇博客</a></p> 
<h3><a id="1ModbusRTU_26"></a>1.ModbusRTU消息帧解析</h3> 
<p><img src="https://images2.imgbox.com/fb/cd/5j8Vyjgi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/13/4a/qLPmqUIA_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/86/b8/xQzfN4gi_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/74/b0/m1xAnl6W_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/46/bb/txy0NQSa_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e0/c7/1PYYttNG_o.png" alt="在这里插入图片描述"></p> 
<p><img src="https://images2.imgbox.com/b0/1f/0FYYqIIR_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/e7/eb/mDhclvJQ_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/d6/48/z4i4DHK6_o.jpg" alt="在这里插入图片描述"></p> 
<h3><a id="2pollslavemodbusRTU_37"></a>2.主站poll、从站slave通讯仿真-modbusRTU</h3> 
<p>从站slave用于模拟PLC中的功能区，一个tab页表示一个功能模块（下图建了两个功能块）<br> 主站poll发送请求，获取PLC中数据。<br> poll、slave都要设置connection、setup两个区域，只有参数配对了才能正常收发数据<br> <img src="https://images2.imgbox.com/f9/3b/deuAo0Nc_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="101_42"></a>1.功能码=01读线圈状态</h4> 
<p><img src="https://images2.imgbox.com/f9/97/GEWWJhDs_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/31/2c/b9wqeyTl_o.png" alt="在这里插入图片描述"></p> 
<p><mark>报文都是16进制表示</mark><br> 16进制 0X01=0000 0001，一位16进制需要4位二进制表达（F =1111），两个16进制数字表示1个字节<br> 线圈中数据要么是0，要么是1<br> 读取长度：00 0A表示读取10个寄存器<br> 响应字节数（单位是字节）：02 表示两个字节，从02往后数两个字节都是数据未位<br> 输出状态：A2 02 这是两字节，解析：先颠倒高低位 02 A2= 0000 0010 1010 0010 再反向读取数据0100 0101 0100 0000<br> <img src="https://images2.imgbox.com/a0/67/ABjI4UCD_o.png" alt="在这里插入图片描述"></p> 
<h4><a id="203_53"></a>2.功能码=03读保持寄存器</h4> 
<p>寄存器中数据可以是整数，浮点型 （整型和无符号整型：2字节。长整型：4字节。单精度浮点数：4字节。双精度浮点数：8字节）<br> <img src="https://images2.imgbox.com/40/85/QCUbIKlf_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="_56"></a>报文解析（寄存器存整型）</h5> 
<p>读取长度：00 0A表示读取10个寄存器，<mark>1个寄存器是16位=2个字节，所以返回20个字节，一个整型=2字节，所以返回的是10个数据</mark><br> 响应字节数（单位是字节）：14 表示20个字节<br> 输出状态：007B 00 00 00 00 00 00 00 00 00 00 这是20个字节，解析: 第一个数为123<br> <img src="https://images2.imgbox.com/dc/1a/8feldPZU_o.png" alt="在这里插入图片描述"></p> 
<h5><a id="float_62"></a>报文解析（寄存器存float）</h5> 
<p>读取长度：00 0A表示读取10个寄存器，<mark>1个寄存器是16位=2个字节，所以返回20个字节，一个float 占4字节，所以返回的是5个数据</mark><br> 响应字节数（单位是字节）：14 表示20个字节<br> 输出状态：解析: 42 0A 00 00 通过IEEE转换标准-&gt;第一个数为34.5<br> <img src="https://images2.imgbox.com/2b/9e/XRDXFMzc_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="3CPollModbusRTU_67"></a>3.C#模拟主站Poll（ModbusRTU协议-组报文）</h3> 
<p><mark>说明</mark><br> 1.下面代码模拟的是主站，需要开启小程序mbslave作为从站PLC<br> 2.主站发起的功能码请求有：读线圈，读保持寄存器，写多个寄存器<br> 3.主站发送报文，然后对响应报文按<mark>消息帧</mark>进行解析</p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Ports</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> 通讯收发功能解析
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">"Hello World!"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//Test_0x01();</span>
            <span class="token function">Test_0x03</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Test_0x10();</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Test_0x01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">/// 01功能码-读线圈状态测试，PLC中线圈全为0</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> startAddr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> readLen <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

            <span class="token comment">// 请求</span>
            <span class="token comment">// byte[] 需要指定长度；不支持Linq</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1号从站</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 功能码：读线圈状态</span>
            <span class="token comment">// 起始地址</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>startAddr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>startAddr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读取数量</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>readLen<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>readLen<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// CRC</span>
            command <span class="token operator">=</span> <span class="token function">CRC16</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//command 为长度=8的字节{0x01 0x01 0x00 0x00 0x00 0x0A 0xBC 0x0D}</span>
            <span class="token comment">// 以上报文组装完成</span>

            <span class="token comment">// 发送-》SerialPort</span>
            <span class="token class-name">SerialPort</span> serialPort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SerialPort</span><span class="token punctuation">(</span><span class="token string">"COM1"</span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">,</span> Parity<span class="token punctuation">.</span>None<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> StopBits<span class="token punctuation">.</span>One<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打开串口</span>
            serialPort<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//将command的第0位-&gt;command.count所有数据都发出去</span>
            serialPort<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> command<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送报文为01 01 00 00 00 0A BC 0D   请求10个线圈的状态，响应时1个字节8位接收不够，所以两字节</span>
            Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//加上延时等待PLC反应时间</span>
            <span class="token comment">// 进行响应报文的接收和解析 </span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> respBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>serialPort<span class="token punctuation">.</span>BytesToRead<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//缓冲区信息</span>
            serialPort<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>respBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> respBytes<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// respBytes -&gt; 01 01 02 00 00 B9 FC</span>

            <span class="token comment">// 检查一个校验位</span>

            <span class="token comment">//对报文进行解析数据</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> respList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>respBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            respList<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//00 00 B9 FC</span>
            respList<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span>respList<span class="token punctuation">.</span>Count <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//00 00 数据报文</span>
            <span class="token comment">// 1。高低位切换</span>
            <span class="token comment">// 2。从后往前读</span>
            respList<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> respStrList <span class="token operator">=</span> respList<span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>r <span class="token operator">=&gt;</span> Convert<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> values <span class="token operator">=</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> respStrList<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            values<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            values<span class="token punctuation">.</span><span class="token function">ForEach</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>Convert<span class="token punctuation">.</span><span class="token function">ToBoolean</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//Convert.ToBoolean('1');</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Test_0x03</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//读保持寄存器  PLC中第一个寄存器为123，其他=0</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> startAddr <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> readLen <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

            <span class="token comment">// 请求</span>
            <span class="token comment">// byte[] 需要指定长度；不支持Linq</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1号从站</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">0x03</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 功能码：读保持型寄存器</span>
            <span class="token comment">// 起始地址</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>startAddr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>startAddr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 读取数量</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>readLen<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>readLen<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// CRC</span>
            command <span class="token operator">=</span> <span class="token function">CRC16</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 报文组装完成</span>
            <span class="token comment">// 发送-》SerialPort</span>
            <span class="token class-name">SerialPort</span> serialPort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SerialPort</span><span class="token punctuation">(</span><span class="token string">"COM1"</span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">,</span> Parity<span class="token punctuation">.</span>None<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> StopBits<span class="token punctuation">.</span>One<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打开串口</span>
            serialPort<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            serialPort<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> command<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 进行响应报文的接收和解析</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> respBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>serialPort<span class="token punctuation">.</span>BytesToRead<span class="token punctuation">]</span><span class="token punctuation">;</span>
            serialPort<span class="token punctuation">.</span><span class="token function">Read</span><span class="token punctuation">(</span>respBytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> respBytes<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// respBytes -&gt; 01 01 02 00 00 B9 FC</span>
            <span class="token comment">// 检查一个校验位</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> respList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>respBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            respList<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            respList<span class="token punctuation">.</span><span class="token function">RemoveRange</span><span class="token punctuation">(</span>respList<span class="token punctuation">.</span>Count <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token comment">// 拿到实际的数据部分，进行数据解析</span>
            <span class="token comment">// 明确一点：读的是无符号单精度，占两个字节</span>
            <span class="token comment">//byte[] data = new byte[2]; </span>
            <span class="token comment">//for (int i = 0; i &lt; readLen; i++)</span>
            <span class="token comment">//{<!-- --></span>
            <span class="token comment">//    // 字节序问题    小端   大端</span>
            <span class="token comment">//    data[0] = respList[i * 2 + 1];</span>
            <span class="token comment">//    data[1] = respList[i * 2];</span>
            <span class="token comment">//    // 根据此两个字节转换成想要的实际数字</span>
            <span class="token comment">//    var value = BitConverter.ToUInt16(data, 0);</span>
            <span class="token comment">//    Console.WriteLine(value);</span>
            <span class="token comment">//}</span>

            <span class="token comment">// 明确一点：读的是Float  占4个字节</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> readLen <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">// 字节序问题    小端   大端</span>
                data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> respList<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> respList<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> respList<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> respList<span class="token punctuation">[</span>i <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token comment">// 根据此两个字节转换成想要的实际数字</span>
                <span class="token class-name"><span class="token keyword">var</span></span> <span class="token keyword">value</span> <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToSingle</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>


        

        <span class="token comment">//向PLC中写入Float，float占4个字节=2个寄存器，所以要使用功能码“写多寄存器0x10”, 功能码0x06只能写一个寄存器”, </span>
        <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Test_0x10</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token comment">//写多个寄存器功能码0x10</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> startAddr <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> writeLen <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> values <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">float</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> <span class="token number">123.45f</span><span class="token punctuation">,</span> <span class="token number">14.3f</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

            <span class="token comment">// 请求</span>
            <span class="token comment">// byte[] 需要指定长度；不支持Linq</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> command <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1号从站</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">0x10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 功能码：写多个保持型寄存器</span>
            <span class="token comment">// 写入地址</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>startAddr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>startAddr<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 写入数量</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>writeLen<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>writeLen<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


            <span class="token comment">// 获取数值的byte[]</span>
            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> valueBytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> values<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> temp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>BitConverter<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                temp<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 调整字节序</span>
                valueBytes<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// 字节数</span>
            command<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span>valueBytes<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            command<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span>valueBytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// CRC</span>
            command <span class="token operator">=</span> <span class="token function">CRC16</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 报文组装完成</span>
            <span class="token comment">// 发送-》SerialPort</span>
            <span class="token class-name">SerialPort</span> serialPort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SerialPort</span><span class="token punctuation">(</span><span class="token string">"COM1"</span><span class="token punctuation">,</span> <span class="token number">9600</span><span class="token punctuation">,</span> Parity<span class="token punctuation">.</span>None<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> StopBits<span class="token punctuation">.</span>One<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 打开串口</span>
            serialPort<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            serialPort<span class="token punctuation">.</span><span class="token function">Write</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> command<span class="token punctuation">.</span>Count<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


        <span class="token keyword">static</span> <span class="token return-type class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> <span class="token function">CRC16</span><span class="token punctuation">(</span><span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">value</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">ushort</span></span> poly <span class="token operator">=</span> <span class="token number">0xA001</span><span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">ushort</span></span> crcInit <span class="token operator">=</span> <span class="token number">0xFFFF</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">value</span><span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//运算</span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> crc <span class="token operator">=</span> crcInit<span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token keyword">value</span><span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                crc <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span>crc <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    crc <span class="token operator">=</span> <span class="token punctuation">(</span>crc <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">?</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>crc <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> poly<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span>crc <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token class-name"><span class="token keyword">byte</span></span> hi <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>crc <span class="token operator">&amp;</span> <span class="token number">0xFF00</span><span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//高位置</span>
            <span class="token class-name"><span class="token keyword">byte</span></span> lo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>crc <span class="token operator">&amp;</span> <span class="token number">0x00FF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment">//低位置</span>

            <span class="token class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">AddRange</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>lo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            buffer<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>hi<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="4NModbus4pollModbusRTU_292"></a>4.NModbus4模拟主站poll（ModbusRTU协议）</h3> 
<p><img src="https://images2.imgbox.com/ec/dd/hojT8VXb_o.png" alt="在这里插入图片描述"><br> ReadHoldingRegisters(1, 0, 1)# 参数：从站地址，起始地址，读取数量<br> <img src="https://images2.imgbox.com/d6/95/eIgJ2zWt_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/82/e6/QGyDhAkX_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/48/88/pFBKfmeC_o.png" alt="在这里插入图片描述"></p> 
<h3><a id="5CPollModbusTCP_298"></a>5.C#模拟主站Poll（ModbusTCP协议-组报文）</h3> 
<p><a href="https://www.bilibili.com/video/BV1Ep4y1G7JT?p=25&amp;spm_id_from=pageDriver&amp;vd_source=f00d63619365673a93ecf17f4b6307b0" rel="nofollow">课程视频P17-P14</a></p> 
<p>03读保持寄存器报文<br> <img src="https://images2.imgbox.com/e9/7a/7mMCnjdY_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/32/7f/PEwGP2Vh_o.png" alt="在这里插入图片描述"></p> 
<p><mark>说明</mark><br> 1.下面代码模拟的是modbusTCP主站，需要开启小程序mbslave作为从站PLC，要设置slave的connection、setup两个区域的TCP相关参数<br> 2.主站发起的功能码请求有：ReadHoldingRegister，ReadInputRegister<br> 3.主站发送报文，然后对响应报文按消息帧进行解析<br> <img src="https://images2.imgbox.com/68/40/XdXuDInl_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Generic</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>IO<span class="token punctuation">.</span>Ports</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Text</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks</span><span class="token punctuation">;</span>

<span class="token keyword">namespace</span> 通讯收发功能解析
<span class="token punctuation">{<!-- --></span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ModbusTcp</span><span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">ModbusBase</span></span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token class-name">Socket</span> socket <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span>ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">public</span> <span class="token return-type class-name">Result</span> <span class="token function">connect</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> host<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> port<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                socket<span class="token punctuation">.</span><span class="token function">Connect</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>State <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                result<span class="token punctuation">.</span>State <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>Exception <span class="token operator">=</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>


        <span class="token punctuation">}</span>


        <span class="token comment">// 读保持型寄存器03</span>
        <span class="token comment">// ModbusRTU:0x01(从站地址) 03 (功能码)  0x00 0x0A(起始地址)  0x00 0x05(读取长度)   0xXX 0xXX(CRC16校验码)</span>
        <span class="token comment">// ModbusTCP:请求报文：0x00 0x00(TransationID 最大65535)  0x00 0x00 (Modbus协议标识)   0x00 0x06(后续字节数)   =&gt;  0x01 (单元标识) 0x03  0x0 0x0A 0x00 0x05</span>
        <span class="token comment">// 响应报文：                   0x00 0x00(TransationID 最大65535)   0x00 0x00 (Modbus协议标识)   0x00 0x0D(后续字节数)   =&gt;  0x01 (单元标识) 0x03（功能码）=&gt;</span>
        <span class="token comment">//                                       0x0A（返回10个字节数据） 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">///</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name="unit_id"&gt;从站地址&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="start_addr"&gt;寄存器起始地址&lt;/param&gt;</span>
        <span class="token comment">/// &lt;param name="count"&gt;读寄存器数量&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">Result</span>  <span class="token function">ReadHoldingRegister</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> unit_id <span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">ushort</span></span> start_addr<span class="token punctuation">,</span><span class="token class-name"><span class="token keyword">ushort</span></span> count<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
          
            <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span>
                
          <span class="token class-name"><span class="token keyword">ushort</span></span> tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
          <span class="token comment">//报文组装</span>
          <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> req_bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
          <span class="token punctuation">{<!-- --></span>
              <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tid<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tid<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
               <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span>
               unit_id<span class="token punctuation">,</span>
               <span class="token number">0x03</span><span class="token punctuation">,</span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>start_addr<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>start_addr<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//10进制转成16</span>
                 <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>count<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>count<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
                tid<span class="token operator">++</span><span class="token punctuation">;</span>
                tid <span class="token operator">%=</span> <span class="token number">65535</span><span class="token punctuation">;</span>

                <span class="token comment">//var req_bytes = this.ReadCommandBytes( unit_id,  0x03,start_addr,  count);</span>

            <span class="token comment">//发送请求</span>
            socket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>req_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//接收响应</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> resp_bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//由于plc返回的响应字数长度是不一样的，先取前6个字节</span>
            socket<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>resp_bytes<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">,</span><span class="token number">6</span> <span class="token punctuation">,</span>SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name"><span class="token keyword">var</span></span> len_bytes <span class="token operator">=</span> resp_bytes<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRange</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">ushort</span></span> len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span>len_bytes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> len_bytes<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解析报文中返回的有多少个字节数</span>
            resp_bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//这个resp_bytes len 表明数据中有多少个字节数据是有用的数据报文</span>
            socket<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>resp_bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上面从缓存区拿走了6个字节，现在把剩余的都拿走</span>

            <span class="token comment">//检查响应报文是否正常，功能码的高位为1，就是异常</span>
            <span class="token comment">//0x83 1000 0011</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>resp_bytes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//说明响应的是异常报文</span>
                    <span class="token comment">// 返回异常信息 根据resp_bytes[2]字节进行异常的关联</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"错误了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//提取PLC中寄存器中的数据部分报文</span>
             <span class="token class-name"><span class="token keyword">var</span></span> data_bytes <span class="token operator">=</span> resp_bytes<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRange</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> resp_bytes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>State <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>Datas <span class="token operator">=</span> data_bytes<span class="token punctuation">;</span>
              

            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                result<span class="token punctuation">.</span>State <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>Exception <span class="token operator">=</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">Result</span> <span class="token function">ReadInputRegister</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span></span> unit_id<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">ushort</span></span> start_addr<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">ushort</span></span> count<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

            <span class="token class-name">Result</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Result</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                
                <span class="token class-name"><span class="token keyword">ushort</span></span> tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                <span class="token comment">//报文组装</span>
                <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> req_bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span>
                <span class="token punctuation">{<!-- --></span>
                <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tid<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>tid<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                 <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
                 <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x06</span><span class="token punctuation">,</span>
                 unit_id<span class="token punctuation">,</span>
                 <span class="token number">0x04</span><span class="token punctuation">,</span>
                  <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>start_addr<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>start_addr<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//10进制转成16</span>
                   <span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>count<span class="token operator">/</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>count<span class="token operator">%</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">}</span><span class="token punctuation">;</span>
                tid<span class="token operator">++</span><span class="token punctuation">;</span>
                tid <span class="token operator">%=</span> <span class="token number">65535</span><span class="token punctuation">;</span>

                <span class="token comment">//var req_bytes = this.ReadCommandBytes(unit_id, 0x04, start_addr, count);</span>
                <span class="token comment">//发送请求</span>
                socket<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>req_bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">//接收响应</span>
                <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> resp_bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//由于plc返回的响应字数长度是不一样的，先取前6个字节</span>
                socket<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>resp_bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">var</span></span> len_bytes <span class="token operator">=</span> resp_bytes<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRange</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">ushort</span></span> len <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span><span class="token punctuation">(</span>len_bytes<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">256</span> <span class="token operator">+</span> len_bytes<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//解析报文中返回的有多少个字节数</span>
                resp_bytes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span>len<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//这个resp_bytes len 表明数据中有多少个字节数据是有用的数据报文</span>
                socket<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>resp_bytes<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> len<span class="token punctuation">,</span> SocketFlags<span class="token punctuation">.</span>None<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//上面从缓存区拿走了6个字节，现在把剩余的都拿走</span>

                <span class="token comment">//检查响应报文是否正常，功能码的高位为1，就是异常</span>
                <span class="token comment">//0x83 1000 0011</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>resp_bytes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&gt;</span> <span class="token number">0x80</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//说明响应的是异常报文</span>
                    <span class="token comment">// 返回异常信息 根据resp_bytes[2]字节进行异常的关联</span>
                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Exception</span><span class="token punctuation">(</span><span class="token string">"错误了"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                <span class="token comment">//解析PLC中寄存器中的数据</span>
                <span class="token class-name"><span class="token keyword">var</span></span> data_bytes <span class="token operator">=</span> resp_bytes<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRange</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> resp_bytes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>State <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>Datas <span class="token operator">=</span> data_bytes<span class="token punctuation">;</span>


            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                result<span class="token punctuation">.</span>State <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
                result<span class="token punctuation">.</span>Exception <span class="token operator">=</span> ex<span class="token punctuation">.</span>Message<span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>

        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token return-type class-name">T<span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token generic-method"><span class="token function">Getvalues</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data_bytes<span class="token punctuation">)</span><span class="token comment">//解析报文</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name"><span class="token keyword">var</span></span> type_len <span class="token operator">=</span> Marshal<span class="token punctuation">.</span><span class="token function">SizeOf</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span><span class="token type-expression class-name">T</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查类型的长度 ， int32是4字节，float是4字节</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> i <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>data_bytes<span class="token punctuation">.</span>Length<span class="token punctuation">;</span>i<span class="token operator">+=</span>type_len<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//根据数据类型将报文切割，获取一个类型的字节内容,并将字节转换成对应 的str</span>
                <span class="token class-name"><span class="token keyword">var</span></span> temp_bytes <span class="token operator">=</span> data_bytes<span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetRange</span><span class="token punctuation">(</span>i<span class="token punctuation">,</span> type_len<span class="token punctuation">)</span><span class="token punctuation">;</span>
                temp_bytes<span class="token punctuation">.</span><span class="token function">Reverse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//字序</span>
                <span class="token class-name"><span class="token keyword">short</span></span> v <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt16</span><span class="token punctuation">(</span>temp_bytes<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">ushort</span></span> vv <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToUInt16</span><span class="token punctuation">(</span>temp_bytes<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">float</span></span> vvv <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToSingle</span><span class="token punctuation">(</span>temp_bytes<span class="token punctuation">.</span><span class="token function">ToArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>

            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> 
<h3><a id="6NModbus4slaveModbusTCP_505"></a>6.NModbus4模拟从站slave（ModbusTCP协议）</h3> 
<p>用小工具poll连接自己建立的从站，可读取从站的值<br> <a href="https://www.codenong.com/cs106858263/" rel="nofollow">文章</a></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Threading</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Sockets</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Modbus<span class="token punctuation">.</span>Data</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">Modbus<span class="token punctuation">.</span>Device</span><span class="token punctuation">;</span>
 <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">slave</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 服务器提供的数据区</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span>  <span class="token class-name">DataStore</span> Data<span class="token operator">=</span>DataStoreFactory<span class="token punctuation">.</span><span class="token function">CreateDefaultDataStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//初始化服务数据区;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// Modbus服务器</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span>  <span class="token class-name">ModbusSlave</span> modbus_tcp_server<span class="token punctuation">;</span>

        <span class="token keyword">public</span>  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">modbustcpslave</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            
            modbus_tcp_server <span class="token operator">=</span> ModbusTcpSlave<span class="token punctuation">.</span><span class="token function">CreateTcp</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">TcpListener</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span><span class="token string">"127.0.0.1"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">502</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//创建ModbusTcp服务器</span>
            modbus_tcp_server<span class="token punctuation">.</span>DataStore <span class="token operator">=</span> Data<span class="token punctuation">;</span><span class="token comment">//数据区赋值</span>

            <span class="token class-name">Thread</span> th_0 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                modbus_tcp_server<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//异步 非阻塞 启动服务</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                IsBackground <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            th_0<span class="token punctuation">.</span><span class="token function">SetApartmentState</span><span class="token punctuation">(</span>ApartmentState<span class="token punctuation">.</span>STA<span class="token punctuation">)</span><span class="token punctuation">;</span>
            th_0<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span> th_1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token function">SetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//数据区数据赋值</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                IsBackground <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            th_1<span class="token punctuation">.</span><span class="token function">SetApartmentState</span><span class="token punctuation">(</span>ApartmentState<span class="token punctuation">.</span>STA<span class="token punctuation">)</span><span class="token punctuation">;</span>
            th_1<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>

        
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 设置数据</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
         <span class="token keyword">public</span>  <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">SetData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//static修饰的函数或变量都是在类初始化的时候加载的，而非静态的变量都是在对象初始化的时候加载。</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Year<span class="token punctuation">;</span>         <span class="token comment">//年</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Month<span class="token punctuation">;</span>        <span class="token comment">//月</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Day<span class="token punctuation">;</span>          <span class="token comment">//日</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Hour<span class="token punctuation">;</span>         <span class="token comment">//时</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Minute<span class="token punctuation">;</span>       <span class="token comment">//分</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Second<span class="token punctuation">;</span>       <span class="token comment">//秒</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Millisecond<span class="token punctuation">;</span>  <span class="token comment">//毫秒</span>
                <span class="token class-name">Random</span> ran <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                Data<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>ran<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">32767</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">//产生的随机数</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> 
<h3><a id="7NModbus4slaveModbusRTU_575"></a>7.NModbus4模拟从站slave（ModbusRTU协议）</h3> 
<p><a href="https://blog.csdn.net/lx_Angel/article/details/109177812">文章</a></p> 
<pre><code class="prism language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">slave_RTU</span>
    <span class="token punctuation">{<!-- --></span>
        <span class="token keyword">public</span> <span class="token class-name">ModbusSlave</span> modbus_rtu_server<span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token class-name">SerialPort</span> slavePort <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">SerialPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            slavePort<span class="token punctuation">.</span>PortName <span class="token operator">=</span> <span class="token string">"COM1"</span><span class="token punctuation">;</span>
            slavePort<span class="token punctuation">.</span>BaudRate <span class="token operator">=</span> <span class="token number">9600</span><span class="token punctuation">;</span>
            slavePort<span class="token punctuation">.</span>DataBits <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>
            slavePort<span class="token punctuation">.</span>Parity <span class="token operator">=</span> Parity<span class="token punctuation">.</span>Even<span class="token punctuation">;</span>
            slavePort<span class="token punctuation">.</span>StopBits <span class="token operator">=</span> StopBits<span class="token punctuation">.</span>One<span class="token punctuation">;</span>
            slavePort<span class="token punctuation">.</span><span class="token function">Open</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">byte</span></span> slaveID <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            modbus_rtu_server <span class="token operator">=</span> ModbusSerialSlave<span class="token punctuation">.</span><span class="token function">CreateRtu</span><span class="token punctuation">(</span>slaveID<span class="token punctuation">,</span> slavePort<span class="token punctuation">)</span><span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>ModbusSlaveRequestReceived <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler<span class="token punctuation">&lt;</span>ModbusSlaveRequestEventArgs<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Modbus_Request_Event<span class="token punctuation">)</span><span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore <span class="token operator">=</span> Modbus<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>DataStoreFactory<span class="token punctuation">.</span><span class="token function">CreateDefaultDataStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>DataStoreWrittenTo <span class="token operator">+=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">EventHandler<span class="token punctuation">&lt;</span>DataStoreEventArgs<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>Modbus_DataStoreWriteTo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Year<span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Year<span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>InputRegisters<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">ushort</span><span class="token punctuation">)</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Year<span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>CoilDiscretes<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>CoilDiscretes<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>CoilDiscretes<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


            modbus_rtu_server<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Modbus_Request_Event</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">Modbus<span class="token punctuation">.</span>Device<span class="token punctuation">.</span>ModbusSlaveRequestEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token comment">//request from master</span>
                <span class="token class-name"><span class="token keyword">byte</span></span> fc <span class="token operator">=</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>FunctionCode<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> data <span class="token operator">=</span> e<span class="token punctuation">.</span>Message<span class="token punctuation">.</span>MessageFrame<span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> byteStartAddress <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> byteNum <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> <span class="token punctuation">{<!-- --></span> data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token class-name">Int16</span> StartAddress <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt16</span><span class="token punctuation">(</span>byteStartAddress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Int16</span> NumOfPoint <span class="token operator">=</span> BitConverter<span class="token punctuation">.</span><span class="token function">ToInt16</span><span class="token punctuation">(</span>byteNum<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">bool</span></span> BOOL <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

                <span class="token class-name"><span class="token keyword">string</span></span> FCNUM <span class="token operator">=</span> fc<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                
                <span class="token keyword">if</span> <span class="token punctuation">(</span>fc<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">"6"</span><span class="token punctuation">)</span>
                <span class="token punctuation">{<!-- --></span>
                    <span class="token comment">//AO</span>
                    modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>HoldingRegisters<span class="token punctuation">[</span>StartAddress<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">16</span><span class="token punctuation">;</span>
                    modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>HoldingRegisters<span class="token punctuation">[</span>StartAddress <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">17</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                
                Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>fc<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> StartAddress<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> NumOfPoint<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> exc<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>

        <span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Modbus_DataStoreWriteTo</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">Modbus<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>DataStoreEventArgs</span> e<span class="token punctuation">)</span>
        <span class="token punctuation">{<!-- --></span>
            <span class="token comment">//this.Text = "DataType=" + e.ModbusDataType.ToString() + "  StartAdress=" + e.StartAddress;</span>
            <span class="token class-name"><span class="token keyword">int</span></span> iAddress <span class="token operator">=</span> e<span class="token punctuation">.</span>StartAddress<span class="token punctuation">;</span><span class="token comment">//e.StartAddress;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>ModbusDataType<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token keyword">case</span> ModbusDataType<span class="token punctuation">.</span>HoldingRegister<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>B<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//Set AO                 </span>
                        modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>HoldingRegisters<span class="token punctuation">[</span>e<span class="token punctuation">.</span>StartAddress <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>B<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">//e.Data.B[i] already write to slave.DataStore.HoldingRegisters[e.StartAddress + i + 1]</span>
                        <span class="token comment">//e.StartAddress starts from 0</span>
                        <span class="token comment">//You can set AO value to hardware here</span>

                        <span class="token comment">//DoAOUpdate(iAddress, e.Data.B[i].ToString());</span>
                        iAddress<span class="token operator">++</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>

                <span class="token keyword">case</span> ModbusDataType<span class="token punctuation">.</span>Coil<span class="token punctuation">:</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>A<span class="token punctuation">.</span>Count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{<!-- --></span>
                        <span class="token comment">//Set DO</span>
                        modbus_rtu_server<span class="token punctuation">.</span>DataStore<span class="token punctuation">.</span>CoilDiscretes<span class="token punctuation">[</span>e<span class="token punctuation">.</span>StartAddress <span class="token operator">+</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>A<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token comment">//e.Data.A[i] already write to slave.DataStore.CoilDiscretes[e.StartAddress + i + 1]</span>
                        <span class="token comment">//e.StartAddress starts from 0</span>
                        <span class="token comment">//You can set DO value to hardware here</span>

                        <span class="token comment">//DoDOUpdate(iAddress, e.Data.A[i]);</span>
                        iAddress<span class="token operator">++</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span>A<span class="token punctuation">.</span>Count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span>
                        <span class="token punctuation">{<!-- --></span>
                            <span class="token keyword">break</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> 
<h3><a id="8modbusRTUmodbusTCP_683"></a>8.modbusRTU、modbusTCP报文不同之处</h3> 
<p><img src="https://images2.imgbox.com/af/43/HYGqm5nv_o.png" alt="在这里插入图片描述"></p> 
<h2><a id="TCP_688"></a>二、明文TCP</h2> 
<p><a href="https://blog.csdn.net/feng8403000/article/details/120498014">博客</a><br> <a href="https://www.bilibili.com/video/BV11q4y1Q7Yr/?spm_id_from=333.788&amp;vd_source=f00d63619365673a93ecf17f4b6307b0" rel="nofollow">视频</a><br> <img src="https://images2.imgbox.com/23/6a/KcMGiNV2_o.png" alt="在这里插入图片描述"><br> <img src="https://images2.imgbox.com/cd/f7/XdvXjmXp_o.png" alt="在这里插入图片描述"></p> 
<pre><code class="prism language-csharp"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Net</span><span class="token punctuation">;</span>
         <span class="token comment">//创建Socket套接字</span>
            <span class="token class-name">Socket</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">Socket</span><span class="token punctuation">(</span>AddressFamily<span class="token punctuation">.</span>InterNetwork<span class="token punctuation">,</span> SocketType<span class="token punctuation">.</span>Stream<span class="token punctuation">,</span> ProtocolType<span class="token punctuation">.</span>Tcp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">IPEndPoint</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">IPEndPoint</span><span class="token punctuation">(</span>IPAddress<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>textBox1<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>textBox2<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{<!-- --></span> server<span class="token punctuation">.</span><span class="token function">Bind</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span><span class="token string">"无法启动服务器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            server<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//</span>
            <span class="token class-name">Socket</span> Client <span class="token operator">=</span> server<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Accept 抓取的连接请求是客户端发来的</span>
             <span class="token class-name"><span class="token keyword">string</span></span> client <span class="token operator">=</span> Client<span class="token punctuation">.</span>RemoteEndPoint<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>client<span class="token operator">+</span><span class="token string">"连接了服务器"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> b <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name"><span class="token keyword">byte</span></span><span class="token punctuation">[</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//缓冲器</span>
            <span class="token class-name"><span class="token keyword">int</span></span> length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span>
            <span class="token punctuation">{<!-- --></span>
                length <span class="token operator">=</span> Client<span class="token punctuation">.</span><span class="token function">Receive</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
               
            <span class="token punctuation">}</span>
            <span class="token keyword">catch</span>
            <span class="token punctuation">{<!-- --></span>
                MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>client <span class="token operator">+</span> <span class="token string">"失去连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{<!-- --></span>
                <span class="token class-name"><span class="token keyword">string</span></span> msg <span class="token operator">=</span> Encoding<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">GetString</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
                Client<span class="token punctuation">.</span><span class="token function">Send</span><span class="token punctuation">(</span>Encoding<span class="token punctuation">.</span>Default<span class="token punctuation">.</span><span class="token function">GetBytes</span><span class="token punctuation">(</span>textBox3<span class="token punctuation">.</span>Text<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span>
            <span class="token punctuation">{<!-- --></span>
                MessageBox<span class="token punctuation">.</span><span class="token function">Show</span><span class="token punctuation">(</span>client <span class="token operator">+</span> <span class="token string">"失去连接"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/1c6cca42231a7ae2b8d8ced4a60b5318/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">巨坑，org.apache.ibatis.binding.BindingException:Invalid bound statement (not found)绑定异常出现原因和解决方法</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/6597ab696520bd0ed8892277759ed1f0/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">20届 信息安全毕业设计(论文)选题推荐</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>