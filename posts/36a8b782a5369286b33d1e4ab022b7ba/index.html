<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Mysql不停机不锁表主从配置 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="Mysql不停机不锁表主从配置" />
<meta property="og:description" content="1. master配置 1. 主库my.cnf配置 [mysqld] log-bin=mysql-bin #开启二进制日志 server-id=100 #设置server-id,设置为当前ip的最后一个段的数字,这样不会乱 binlog-do-db=sakzss #需要同步的数据库，不在内的不同步。(不添加这行表示同步所有) binlog-ignore-db=performance_schema 配置完成后重启mysql
2. 配置mysql用户 mysql命令行下配置用户 CREATE USER &#39;slave&#39;@&#39;%&#39; IDENTIFIED BY &#39;密码&#39;;#创建用户 GRANT REPLICATION SLAVE ON *.* TO &#39;slave&#39;@&#39;%&#39;;#分配权限 flush privileges; #刷新权限 查看master状态 SHOW MASTER STATUS; 2.从库配置 docker快速新建从库命令
docker run -p 3307:3306 --name mysql-xxx -v $PWD/conf:/etc/mysql/conf.d -v $PWD/logs:/logs -v $PWD/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=xxx -d mysql:5.7 配置my.cnf设置从库id [mysqld] server-id=110 #设置server-id，192.168.0.110 slave_skip_errors=1062 #跳过主键冲突 Duplicate entry gtid_mode=on #开启gtid enforce_gtid_consistency=on #如果需要同步的数据库名相同 replicate-do-db=zxkang_sync #需要同步的数据库名。如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。 #如果需要同步的数据库名不同 replicate-rewrite-db=zxkang_sync-&gt;test # master 上的数据库名为 zxkang_sync ， slave 上的库名为 test replicate-ignore-db=mysql #不同步mysql系统数据库 slave-skip-errors = all #跳过所有的错误错误，继续执行复制操作 配置完成后重启服务。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/36a8b782a5369286b33d1e4ab022b7ba/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-20T17:30:10+08:00" />
<meta property="article:modified_time" content="2022-07-20T17:30:10+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">Mysql不停机不锁表主从配置</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="markdown_views prism-atom-one-dark">
                    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
                        <path stroke-linecap="round" d="M5,0 0,2.5 5,5z" id="raphael-marker-block" style="-webkit-tap-highlight-color: rgba(0, 0, 0, 0);"></path>
                    </svg>
                    <h3><a id="1_master_0"></a>1. master配置</h3> 
<h4><a id="1_mycnf_1"></a>1. 主库<code>my.cnf</code>配置</h4> 
<pre><code class="prism language-.properties">[mysqld]
log-bin=mysql-bin #开启二进制日志
server-id=100 #设置server-id,设置为当前ip的最后一个段的数字,这样不会乱
binlog-do-db=sakzss #需要同步的数据库，不在内的不同步。(不添加这行表示同步所有)
binlog-ignore-db=performance_schema
</code></pre> 
<p>配置完成后重启mysql</p> 
<h4><a id="2_mysql_12"></a>2. 配置mysql用户</h4> 
<ol><li>mysql命令行下配置用户</li></ol> 
<pre><code class="prism language-SQL">CREATE USER 'slave'@'%' IDENTIFIED BY '密码';#创建用户
GRANT REPLICATION SLAVE ON *.* TO 'slave'@'%';#分配权限
flush privileges;   #刷新权限
</code></pre> 
<ol start="2"><li>查看master状态</li></ol> 
<pre><code class="prism language-SQL">SHOW MASTER STATUS;
</code></pre> 
<h3><a id="2_27"></a>2.从库配置</h3> 
<p>docker快速新建从库命令</p> 
<pre><code class="prism language-Bash">docker run -p 3307:3306 --name mysql-xxx -v $PWD/conf:/etc/mysql/conf.d -v $PWD/logs:/logs -v $PWD/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=xxx -d mysql:5.7
</code></pre> 
<ol><li>配置<code>my.cnf</code>设置从库id</li></ol> 
<pre><code class="prism language-.properties">[mysqld]
server-id=110 #设置server-id，192.168.0.110
slave_skip_errors=1062 #跳过主键冲突 Duplicate entry
gtid_mode=on #开启gtid
enforce_gtid_consistency=on
#如果需要同步的数据库名相同
replicate-do-db=zxkang_sync  #需要同步的数据库名。如果不指明同步哪些库，就去掉这行，表示所有库的同步（除了ignore忽略的库）。

#如果需要同步的数据库名不同
replicate-rewrite-db=zxkang_sync-&gt;test  # master 上的数据库名为 zxkang_sync ， slave 上的库名为 test

replicate-ignore-db=mysql  #不同步mysql系统数据库
slave-skip-errors = all   #跳过所有的错误错误，继续执行复制操作
</code></pre> 
<p>配置完成后重启服务。</p> 
<ol><li>mysql下配置权限</li></ol> 
<pre><code class="prism language-SQL">CHANGE MASTER TO MASTER_HOST='192.168.0.110', MASTER_USER='slave', MASTER_PASSWORD='密码', MASTER_LOG_FILE='mysql-bin.000014', MASTER_LOG_POS=154;
</code></pre> 
<h3><a id="3_master_61"></a>3 <s>.锁master表并导出数据</s></h3> 
<ol><li><s>master节点锁表导出数据：</s></li></ol> 
<pre><code class="prism language-SQL">mysql&gt;  FLUSH  TABLES WITH READ LOCK; #锁定表
mysql&gt; show master  status; #显示position
mysqldump   -uroot   -p   --databases xxx   &gt; xxx.sql
</code></pre> 
<ol start="2"><li><s>slave节点下导入数据</s></li></ol> 
<pre><code class="prism language-SQL">mysql&gt; source xxx.sql; #导入数据
CHANGE MASTER TO MASTER_HOST='192.168.0.110', MASTER_USER='slave', MASTER_PASSWORD='密码', MASTER_LOG_FILE='mysql-bin.000014', MASTER_LOG_POS=154; #slave节点重置position
mysql&gt; start slave; # 启动同步任务
mysql&gt; SHOW SLAVE STATUS\G;#检查同步状态
</code></pre> 
<ol start="3"><li><s>master节点解锁</s></li></ol> 
<pre><code class="prism language-SQL">UNLOCK  TABLES;
</code></pre> 
<h3><a id="3_master_84"></a>3. 不锁master同步数据</h3> 
<h4><a id="1_master__86"></a>1. master 导出数据</h4> 
<p>不停机实现主从搭建的关键点就是以下两个参数：</p> 
<ul><li>–single-transaction</li><li>–master-data</li></ul> 
<p>master-data参数主要用来记录主库的binlog_file和pos，它有两个值，分别是：</p> 
<p>1:在mysqldump过程中，将binlogfile和pos信息记录在sql中，并且不是以注释信息的方式记录，这样在执行导入的时候自动执行这部分信息</p> 
<p>2:在mysqldump过程中，将binlogfile和pos信息以注释的方式记录在sql中</p> 
<p>single-transaction参数则是通过提交单一事务来确保数据一致性，通过在FLUSH TABLES WITH READ LOCK 后添加START TRANSACTION 语句，开启单一事务，此时加锁，仅仅是为了获取准确的master-data中的binlogfile和pos信息，在开启事务后，锁已经释放了，所以对业务影响很小</p> 
<p>通过以上两个参数，可以在不长时间锁表的情况下获取准确的binlogfile和pos信息，从而完成主从配置</p> 
<pre><code class="prism language-Bash">mysqldump -uroot -p -h192.168.0.100 --single-transaction --master-data=2 --databases xxx xxx &gt; databases.sql
</code></pre> 
<h4><a id="2slave_107"></a>2.slave导入数据</h4> 
<pre><code class="prism language-SQL">source databases.sql
</code></pre> 
<p>查看<code>master_log_file</code>和<code>master_log_pos</code> 参数通过master-data=2参数导出的，在sql文件里面开头部分。查看</p> 
<pre><code class="prism language-Bash">head -n 50 databases.sql
</code></pre> 
<p>从库配置主从参数：</p> 
<pre><code class="prism language-SQL">change master to master_host='xxx', master_user='xxx', master_password='xxx', master_port=3306, master_log_file='mysql-bin.000252', master_log_pos=001;
</code></pre> 
<h4><a id="3_slave_125"></a>3. 开启slave同步</h4> 
<pre><code class="prism language-开启slave同步">start slave
show slave status\G; #查看从库状态
</code></pre> 
<h4><a id="4__132"></a>4. 设置从库为只读</h4> 
<pre><code class="prism language-SQL">mysql&gt; show global variables like "%read_only%";
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| innodb_read_only      | OFF   |
| read_only             | OFF   |
| super_read_only       | OFF   |
| transaction_read_only | OFF   |
| tx_read_only          | OFF   |
+-----------------------+-------+
5 rows in set (0.03 sec)

mysql&gt; set global read_only=1;
Query OK, 0 rows affected (0.00 sec)

mysql&gt; show global variables like "%read_only%";
+-----------------------+-------+
| Variable_name         | Value |
+-----------------------+-------+
| innodb_read_only      | OFF   |
| read_only             | ON    |
| super_read_only       | OFF   |
| transaction_read_only | OFF   |
| tx_read_only          | OFF   |
+-----------------------+-------+
5 rows in set (0.00 sec)
</code></pre> 
<h3><a id="_163"></a>其他命令及操作</h3> 
<p>slave停止或重置：</p> 
<pre><code class="prism language-SQL">reset slave;
stop slave;
</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/ab733c009ae8a20a4da0936390f33f79/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">js 实现简单的红绿灯</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/22564c0abeb4d5615033eca1ea455f9b/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">关于vue-element-admin项目npm install安装依赖报错的解决方法</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>