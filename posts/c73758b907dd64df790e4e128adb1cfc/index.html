<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PackageManagerService的启动过程——Android 12（一） - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="PackageManagerService的启动过程——Android 12（一）" />
<meta property="og:description" content="目录
1. PackageManagerService概述
1.1 PackageManagerService职责
1.2 PKMS内部三把重要的锁
1.3 PKMS在SystemServer中全部业务
2. PKMS的启动
2.1 SystemServer.startBootstrapServices()
2.2 PackageManagerService.main()
2.3 PackageManagerService构造函数
2.3.1 PKMS构造函数BOOT_PROGRESS_PMS_START阶段
2.3.2 PKMS构造函数BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 阶段
2.3.3 PKMS构造函数BOOT_PROGRESS_PMS_DATA_SCAN 阶段
2.3.4 PKMS构造函数BOOT_PROGRESS_PMS_READY阶段
2.4 PKMS.installWhitelistedSystemPackages()
2.5 PackageManagerNative类
1. PackageManagerService概述 1.1 PackageManagerService职责 PackageManagerService(简称PKMS)的官方解释：随时随地跟踪所有的APKs。主要职责分为：
启动过程中扫描App所有安装目录，解析其中的Apk将相关信息加载到PKMS的数据结构中，同时同步到/data/system/packages.xml中；注册APK信息和其四大组件到PKMS中。负责App的安装和卸载。对外提供接口查询App相关信息。 1.2 PKMS内部三把重要的锁 mLock：用来守护内存中解析的package详情和其他相关状态。这是一个细粒度的锁，只应该短暂持有，因为它是系统中竞争最激烈的锁之一。
mInstallLock ：用来守护所有对installd的访问，其操作通常涉及到磁盘上应用数据繁重的读写操作。由于installd是单线程，它的操作经常会很慢，因此在持有该锁的情况下不能再获取该锁。相反，在持有该锁时如果短暂获取mLock锁时安全的。（关于installd请参考）
mSnapshotLock : 用来守护对两个snapshot字段的访问：snapshot本身和snapshot 失效标志。当持有mLock锁时不能获取该锁，相反，在持有mSnapshotLock锁时暂时获取mLock锁是安全的。
final PackageManagerTracedLock mLock; final Object mInstallLock; private final Object mSnapshotLock = new Object(); 1.3 PKMS在SystemServer中全部业务 PKMS在SystemServer.startBootstrapService()中调用PKMS.main()启动PKMS；如果设备没加密，则管理A/B OTA dexopting；
在SystemServer.startOtherServices()中，如果设备没加密，调用PKMS.updatePackagesIfNeeded()完成dex优化；调用PKMS.performFstrimIfNeeded()完成磁盘维护；最后调用PKMS.systemReady()服务启动就绪；最后调用PKMS.waitForAppDataPrepared()等待所有package准备就绪，整个过程如下图所示：
主要涉及的文件有：
/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java，代码参考地址：PackageManagerService.java
/frameworks/native/libs/binder/aidl/android/content/pm/IPackageManagerNative.aidl，代码参考地址：IPackageManagerNative.aidl
/frameworks/base/core/java/android/content/pm/IPackageManager.aidl，代码参考地址：IPackageManager.aidl" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/c73758b907dd64df790e4e128adb1cfc/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-25T13:37:25+08:00" />
<meta property="article:modified_time" content="2023-05-25T13:37:25+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">PackageManagerService的启动过程——Android 12（一）</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="1.%20PackageManagerService%E6%A6%82%E8%BF%B0-toc" style="margin-left:0px;"><a href="#1.%20PackageManagerService%E6%A6%82%E8%BF%B0" rel="nofollow">1. PackageManagerService概述</a></p> 
<p id="1.1%20PackageManagerService%E8%81%8C%E8%B4%A3-toc" style="margin-left:40px;"><a href="#1.1%20PackageManagerService%E8%81%8C%E8%B4%A3" rel="nofollow">1.1 PackageManagerService职责</a></p> 
<p id="1.2%20PKMS%E5%86%85%E9%83%A8%E4%B8%89%E6%8A%8A%E9%87%8D%E8%A6%81%E7%9A%84%E9%94%81-toc" style="margin-left:40px;"><a href="#1.2%20PKMS%E5%86%85%E9%83%A8%E4%B8%89%E6%8A%8A%E9%87%8D%E8%A6%81%E7%9A%84%E9%94%81" rel="nofollow">1.2 PKMS内部三把重要的锁</a></p> 
<p id="1.3%20PKMS%E5%9C%A8SystemServer%E4%B8%AD%E5%85%A8%E9%83%A8%E4%B8%9A%E5%8A%A1-toc" style="margin-left:40px;"><a href="#1.3%20PKMS%E5%9C%A8SystemServer%E4%B8%AD%E5%85%A8%E9%83%A8%E4%B8%9A%E5%8A%A1" rel="nofollow">1.3 PKMS在SystemServer中全部业务</a></p> 
<p id="2.%20PKMS%E7%9A%84%E5%90%AF%E5%8A%A8-toc" style="margin-left:0px;"><a href="#2.%20PKMS%E7%9A%84%E5%90%AF%E5%8A%A8" rel="nofollow">2. PKMS的启动</a></p> 
<p id="2.1%20SystemServer.startBootstrapServices()-toc" style="margin-left:40px;"><a href="#2.1%20SystemServer.startBootstrapServices%28%29" rel="nofollow">2.1 SystemServer.startBootstrapServices()</a></p> 
<p id="2.2%20PackageManagerService.main()-toc" style="margin-left:40px;"><a href="#2.2%20PackageManagerService.main%28%29" rel="nofollow">2.2 PackageManagerService.main()</a></p> 
<p id="2.3%20PackageManagerService%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0-toc" style="margin-left:40px;"><a href="#2.3%20PackageManagerService%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0" rel="nofollow">2.3 PackageManagerService构造函数</a></p> 
<p id="2.3.1%20PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5-toc" style="margin-left:80px;"><a href="#2.3.1%20PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5" rel="nofollow">2.3.1 PKMS构造函数BOOT_PROGRESS_PMS_START阶段</a></p> 
<p id="2.3.2%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_SYSTEM_SCAN_START%20%E9%98%B6%E6%AE%B5-toc" style="margin-left:80px;"><a href="#2.3.2%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_SYSTEM_SCAN_START%20%E9%98%B6%E6%AE%B5" rel="nofollow">2.3.2 PKMS构造函数BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 阶段</a></p> 
<p id="2.3.3%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_DATA_SCAN%20%E9%98%B6%E6%AE%B5-toc" style="margin-left:80px;"><a href="#2.3.3%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_DATA_SCAN%20%E9%98%B6%E6%AE%B5" rel="nofollow">2.3.3 PKMS构造函数BOOT_PROGRESS_PMS_DATA_SCAN 阶段</a></p> 
<p id="2.3.4%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_READY%E9%98%B6%E6%AE%B5-toc" style="margin-left:80px;"><a href="#2.3.4%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_READY%E9%98%B6%E6%AE%B5" rel="nofollow">2.3.4 PKMS构造函数BOOT_PROGRESS_PMS_READY阶段</a></p> 
<p id="2.4%20PKMS.installWhitelistedSystemPackages()-toc" style="margin-left:40px;"><a href="#2.4%20PKMS.installWhitelistedSystemPackages%28%29" rel="nofollow">2.4 PKMS.installWhitelistedSystemPackages()</a></p> 
<p id="2.5%C2%A0PackageManagerNative%E7%B1%BB-toc" style="margin-left:40px;"><a href="#2.5%C2%A0PackageManagerNative%E7%B1%BB" rel="nofollow">2.5 PackageManagerNative类</a></p> 
<hr id="hr-toc"> 
<p></p> 
<h2 id="1.%20PackageManagerService%E6%A6%82%E8%BF%B0">1. PackageManagerService概述</h2> 
<h3 id="1.1%20PackageManagerService%E8%81%8C%E8%B4%A3">1.1 PackageManagerService职责</h3> 
<p>PackageManagerService(简称PKMS)的官方解释：随时随地跟踪所有的APKs。主要职责分为：</p> 
<ul><li>启动过程中扫描App所有安装目录，解析其中的Apk将相关信息加载到PKMS的数据结构中，同时同步到/data/system/packages.xml中；注册APK信息和其四大组件到PKMS中。</li><li>负责App的安装和卸载。</li><li>对外提供接口查询App相关信息。</li></ul> 
<h3 id="1.2%20PKMS%E5%86%85%E9%83%A8%E4%B8%89%E6%8A%8A%E9%87%8D%E8%A6%81%E7%9A%84%E9%94%81">1.2 PKMS内部三把重要的锁</h3> 
<p><strong>mLock</strong>：用来守护内存中解析的package详情和其他相关状态。这是一个细粒度的锁，只应该短暂持有，因为它是系统中竞争最激烈的锁之一。</p> 
<p><strong>mInstallLock</strong> ：用来守护所有对installd的访问，其操作通常涉及到磁盘上应用数据繁重的读写操作。由于installd是单线程，它的操作经常会很慢，因此在持有该锁的情况下不能再获取该锁。相反，在持有该锁时如果短暂获取mLock锁时安全的。（关于installd请参考）</p> 
<p><strong>mSnapshotLock :</strong>  用来守护对两个snapshot字段的访问：snapshot本身和snapshot 失效标志。当持有mLock锁时不能获取该锁，相反，在持有mSnapshotLock锁时暂时获取mLock锁是安全的。</p> 
<pre><code>final PackageManagerTracedLock mLock;
final Object mInstallLock;
private final Object mSnapshotLock = new Object();</code></pre> 
<h3 id="1.3%20PKMS%E5%9C%A8SystemServer%E4%B8%AD%E5%85%A8%E9%83%A8%E4%B8%9A%E5%8A%A1">1.3 PKMS在SystemServer中全部业务</h3> 
<p>PKMS在SystemServer.startBootstrapService()中调用PKMS.main()启动PKMS；如果设备没加密，则管理A/B OTA dexopting；</p> 
<p>在SystemServer.startOtherServices()中，如果设备没加密，调用PKMS.updatePackagesIfNeeded()完成dex优化；调用PKMS.performFstrimIfNeeded()完成磁盘维护；最后调用PKMS.systemReady()服务启动就绪；最后调用PKMS.waitForAppDataPrepared()等待所有package准备就绪，整个过程如下图所示：</p> 
<p><img alt="" height="872" src="https://images2.imgbox.com/72/ae/PzcKThd8_o.png" width="703"></p> 
<p> 主要涉及的文件有：</p> 
<p>/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java，代码参考地址：<a href="http://aospxref.com/android-12.0.0_r3/xref/frameworks/base/services/core/java/com/android/server/pm/PackageManagerService.java#6692" rel="nofollow" title="PackageManagerService.java">PackageManagerService.java</a><br> /frameworks/native/libs/binder/aidl/android/content/pm/IPackageManagerNative.aidl，代码参考地址：<a href="http://aospxref.com/android-12.0.0_r3/xref/frameworks/native/libs/binder/aidl/android/content/pm/IPackageManagerNative.aidl?fi=IPackageManagerNative#IPackageManagerNative" rel="nofollow" title="IPackageManagerNative.aidl">IPackageManagerNative.aidl</a></p> 
<p>/frameworks/base/core/java/android/content/pm/IPackageManager.aidl，代码参考地址：<a href="http://aospxref.com/android-12.0.0_r3/xref/frameworks/base/core/java/android/content/pm/IPackageManager.aidl" rel="nofollow" title="IPackageManager.aidl">IPackageManager.aidl</a></p> 
<hr> 
<h2 id="2.%20PKMS%E7%9A%84%E5%90%AF%E5%8A%A8">2. PKMS的启动</h2> 
<h3 id="2.1%20SystemServer.startBootstrapServices()">2.1 SystemServer.startBootstrapServices()</h3> 
<pre><code class="language-java">public final class SystemServer implements Dumpable {
    private PackageManagerService mPackageManagerService;
    private PackageMamager mPackageManager;     
    private void startBootstrapServices(@NonNull TimingsTraceAndSlog t) {
        t.traceBegin("StartPackageManagerService");
        try {
            Watchdog.getInstance().pauseWatchingCurrentThread("packagemanagermain");
            mPackageManagerService = PackageManagerService.main(mSystemContext, installer,
                    domainVerificationService, mFactoryTestMode != FactoryTest.FACTORY_TEST_OFF,
                    mOnlyCore);
        } finally {
            Watchdog.getInstance().resumeWatchingCurrentThread("packagemanagermain");
        }
        //既然package manager已经启动.注册dex load report来捕获system server加载的dex文件,
        //这些dex文件会被BackgroundDexOptService优化.                        
        SystemServerDexLoadReporter.configureSystemServerDexReporter(mPackageManagerService);

        mFirstBoot = mPackageManagerService.isFirstBoot();
        mPackageManager = mSystemContext.getPackageManager();
        t.traceEnd();
        ...
    }
}
</code></pre> 
<h3 id="2.2%20PackageManagerService.main()">2.2 PackageManagerService.main()</h3> 
<p>如果设备加密，则运行core应用，即onlyCore=true，主要工作有：</p> 
<ul><li>创建Injector实例</li><li>创建PKMS实例，安装白名单</li><li>把PKMS注册到ServiceManager</li><li>创建PKMNative实例，并注册到ServiceManager中</li></ul> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {
    public static PackageManagerService main(Context context, Installer installer,
            @NonNull DomainVerificationService domainVerificationService, boolean factoryTest,
            boolean onlyCore) {
        ...
        //1.创建PKMS实例
        PackageManagerService m = new PackageManagerService(injector, onlyCore, factoryTest,
                Build.FINGERPRINT, Build.IS_ENG, Build.IS_USERDEBUG, Build.VERSION.SDK_INT,
                Build.VERSION.INCREMENTAL);
        ...
        //2.安装白名单
        m.installWhitelistedSystemPackages();
        //3.把PKMS注册到ServiceManager中
        ServiceManager.addService("package", m);
        //创建PKMNative实例
        final PackageManagerNative pmn = m.new PackageManagerNative();
        3.把PKMNative注册到ServiceManager中
        ServiceManager.addService("package_native", pmn);
        return m;
    }
}</code></pre> 
<h3 id="2.3%20PackageManagerService%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0">2.3 PackageManagerService构造函数</h3> 
<p>PKMS的构造函数非常复杂，包含四个过程：</p> 
<ul><li>第一阶段：BOOT_PROGRESS_PMS_START，初始化PKMS中重要的成员变量，其中包括构建Settings和SystemConfig对象。</li><li>第二阶段：BOOT_PROGRESS_PMS_SYSTEM_SCAN_START，扫描系统App目录</li><li>第三阶段：该阶段包含两部分：BOOT_PROGRESS_PMS_DATA_START和BOOT_PROGRESS_PMS_DATA_END，START阶段负责扫描Data分区，END阶段扫描结束做相关收尾工作，其中包含清除缓存和更新Settings。</li><li>第四阶段：BOOT_PROGRESS_PMS_READY，PMS准备就绪阶段，管理安装会话服务和请求GC。</li></ul> 
<h4 id="2.3.1%20PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0%E5%88%9D%E5%A7%8B%E5%8C%96%E9%98%B6%E6%AE%B5">2.3.1 PKMS构造函数BOOT_PROGRESS_PMS_START阶段</h4> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {
    private final PackageManagerInternal mPmInternal;
    private final ComponentResolver mComponentResolver;
    private final PermissionManagerServiceInternal mPermissionManager;
    final Settings mSettings;
    private final PackageDexOptimizer mPackageDexOptimizer;
    private final DexManager mDexManager;
    public PackageManagerService(Injector injector, boolean onlyCore, boolean factoryTest,
            final String buildFingerprint, final boolean isEngBuild,
            final boolean isUserDebugBuild, final int sdkVersion, final String incrementalVersion) {
        //1.从Injector中初始化获取锁对象
        mLock = injector.getLock();
        mInstallLock = injector.getInstallLock();
        EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_START, SystemClock.uptimeMillis());
        //2.保存Display分辨率相关对象
        mMetrics = injector.getDisplayMetrics();
        //3.与apk安装和dex优化相关的对象
        mInstaller = injector.getInstaller();
        //4.暴露PKMS本地服务给系统使用
        mPmInternal = new PackageManagerInternalImpl();
        //5.用户管理对象
        mUserManager = injector.getUserManagerService();
        //6.组件解析对象
        mComponentResolver = injector.getComponentResolver();
        //7.权限管理对象
        mPermissionManager = injector.getPermissionManagerServiceInternal();
        //8.设置相关对象
        mSettings = injector.getSettings();
        ...
        t.traceBegin("addSharedUsers");
        //9.添加system/phone/log/nfc/bluetooth/shell/se/networkstack/uwb这9种shareUserId到 mSettings
        mSettings.addSharedUserLPw("android.uid.system", Process.SYSTEM_UID,
                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);
        mSettings.addSharedUserLPw("android.uid.phone", RADIO_UID,
                ApplicationInfo.FLAG_SYSTEM, ApplicationInfo.PRIVATE_FLAG_PRIVILEGED);
        ...
        t.traceEnd();
        //Dex优化相关
        mPackageDexOptimizer = injector.getPackageDexOptimizer();
        mDexManager = injector.getDexManager();
        //ART虚拟机管理
        mArtManagerService = injector.getArtManagerService();
        //获取默认分辨率
        mContext.getSystemService(DisplayManager.class)
                .getDisplay(Display.DEFAULT_DISPLAY).getMetrics(mMetrics);
        //创建SystemConfig实例，获取设备可用的features.
        SystemConfig systemConfig = injector.getSystemConfig();
        mAvailableFeatures = systemConfig.getAvailableFeatures();
        //data/app目录
        mAppInstallDir = new File(Environment.getDataDirectory(), "app");
        //获取SystemConfig的共享库
        ArrayMap&lt;String, SystemConfig.SharedLibraryEntry&gt; libConfig = systemConfig.getSharedLibraries();
        SELinuxMMAC.readInstallPolicy();
        mPermissionManager.readLegacyPermissionsTEMP(mSettings.mPermissions);
        mFirstBoot = !mSettings.readLPw(mInjector.getUserManagerInternal().getUsers(true, false, true);
        mPermissionManager.readLegacyPermissionsTEMP(mSettings.mPermissions);
        ...
    }
}</code></pre> 
<h4 id="2.3.2%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_SYSTEM_SCAN_START%20%E9%98%B6%E6%AE%B5">2.3.2 PKMS构造函数BOOT_PROGRESS_PMS_SYSTEM_SCAN_START 阶段</h4> 
<p>这个阶段主要工作：</p> 
<ul><li>获取环境变量和/system/framework目录</li><li>扫描system/vendor/product/odm/oem等目录的priv-app、app、overlay包；</li><li>清除安装时临时文件以及其他不必要的信息</li></ul> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {
    public PackageManagerService(Injector injector, boolean onlyCore, boolean factoryTest,
            final String buildFingerprint, final boolean isEngBuild,
            final boolean isUserDebugBuild, final int sdkVersion, final String incrementalVersion) {
        ...
        synchronized (mInstallLock) {
        synchronized (mLock) {
            ...
            long startTime = SystemClock.uptimeMillis();
            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SYSTEM_SCAN_START, startTime);
            //获取环境变量
            final String bootClassPath = System.getenv("BOOTCLASSPATH");
            final String systemServerClassPath = System.getenv("SYSTEMSERVERCLASSPATH");
            //system/framework目录
            File frameworkDir = new File(Environment.getRootDirectory(), "framework");
            final VersionInfo ver = mSettings.getInternalVersion();      
            //接下来就是扫描system/vendor/product/odm/oem等目录的priv-app、app、overlay包；
            //清除安装时临时文件以及其他不必要的信息
            ...      
        }
        }
        ...
    }
}</code></pre> 
<p>系统App安装目录常见的有：</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td>/system/app</td><td>系统app，不能被普通用户卸载的app</td></tr><tr><td>/system/priv-app</td><td>系统核心app，权限更大</td></tr><tr><td>/vendor/app</td><td>OEM/ODM厂商预置的系统app</td></tr><tr><td>/vendor/priv-app</td><td>OEM/ODM厂商预置的系统app</td></tr></tbody></table> 
<p>普通用户自己安装的App在/data/app目录下。 </p> 
<h4 id="2.3.3%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_DATA_SCAN%20%E9%98%B6%E6%AE%B5">2.3.3 PKMS构造函数BOOT_PROGRESS_PMS_DATA_SCAN 阶段</h4> 
<p>该阶段包含START和END，在START阶段：扫描Data分区（它用来存储所有用户的个人数据和配置文件），更新和去除不必要的数据。在END阶段根据是否是OTA升级后的首次启动，清除缓存数据，把Settings的内容保存到package.xml中。</p> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {
    public PackageManagerService(Injector injector, boolean onlyCore, boolean factoryTest,
            final String buildFingerprint, final boolean isEngBuild,
            final boolean isUserDebugBuild, final int sdkVersion, final String incrementalVersion) {
        ...
        synchronized (mInstallLock) {
        synchronized (mLock) {
            ...
            if (!mOnlyCore) { //设备没有加密时
                EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_DATA_SCAN_START,
                        SystemClock.uptimeMillis());
                //扫描data/app目录
                scanDirTracedLI(mAppInstallDir, 0, scanFlags | SCAN_REQUIRE_KNOWN, 0,
                        packageParser, executorService);

            }
            ...      
            final PackageSetting ps = mSettings.getPackageLPr(packageName);
            if (ps != null &amp;&amp; mPackages.get(packageName) == null) {
                removePackageDataLIF(ps, userIds, null, 0, false);
            }
            
           //安装存根系统应用程序
           installSystemStubPackages(stubSystemApps, scanFlags);
installSystemStubPackages(stubSystemApps, scanFlags);
           mStorageManagerPackage = getStorageManagerPackageName();
           mSetupWizardPackage = getSetupWizardPackageNameImpl();
           //默认文本分类器package
           mDefaultTextClassifierPackage = getDefaultTextClassifierPackageName();
           //系统文本分类器package
           mSystemTextClassifierPackageName = getSystemTextClassifierPackageName(); 
           mDocumenterPackage = getDocumenterPackageName();//文档的package
           mConfiguratorPackage = getDeviceConfiguratorPackageName();//设备配置package
           //使所有客户端都能访问共享库路径
           updateAllSharedLibrariesLocked(null, null, Collections.unmodifiableMap(mPackages));
           EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_SCAN_END, SystemClock.uptimeMillis());
            ...
        }
        }
        ...
    }
}</code></pre> 
<p>下面列出Data分区部分子目录：</p> 
<table border="1" cellpadding="1" cellspacing="1" style="width:500px;"><tbody><tr><td>/data/app</td><td>存储用户自己安装的app</td></tr><tr><td>/data/data/</td><td>存储已安装app的数据目录</td></tr><tr><td>/data/app-private</td><td>App的私有存储空间</td></tr><tr><td>/data/app-lib</td><td>存储所有app的Jni库</td></tr><tr><td>/data/system</td><td>存放系统配置文件</td></tr><tr><td>/data/anr</td><td>存储ANR时的traces文件</td></tr></tbody></table> 
<blockquote> 
 <p>mSettings.readLPw()会扫描下面5个文件 <br> 1. "/data/system/packages.xml" 所有安装app信息，包括系统permissions、apk的name、codePath、version等通过AndroidManifest.xml解析的内容。<br> 2. "/data/system/packages-backup.xml" 所有安装app信息之备份的信息记录 <br> 3. "/data/system/packages.list" 所有安装app信息 <br> 4. "/data/system/packages-stopped.xml" 所有强制停止app信息 <br> 5. "/data/system/packages-stopped-backup.xml" 所有强制停止app信息之备份的信息记录。</p> 
 <p>其中packages-backup.xml和packages-stopped-backup.xml文件是在写对应文件之前，会先备份，如果写成功会把备份文件删除。</p> 
 <p>5个文件共分为三组，简单的作用描述如下： <br> packages.xml：PKMS扫描完目标文件夹后会创建该文件。当系统进行程序安装、卸载和更新等操作时，均会更新该文件。该文件保存了系统中与package 相关的一些信息。<br> packages.list：描述系统中存在的所有APK的信息。当这些程序有变动时，PKMS就会更新该文件。</p> 
 <p>packages-stopped.xml：从系统自带的设置程序中进入应用程序页面，然后在选择强制停止 （ForceStop）某个应用时，系统会将该应用的相关信息记录到此文件中。也就是该文件保存系统中被用户强制停止的Package的信息。</p> 
</blockquote> 
<h4 id="2.3.4%C2%A0PKMS%E6%9E%84%E9%80%A0%E5%87%BD%E6%95%B0BOOT_PROGRESS_PMS_READY%E9%98%B6%E6%AE%B5">2.3.4 PKMS构造函数BOOT_PROGRESS_PMS_READY阶段</h4> 
<p>这个阶段的主要工作包括：管理安装会话服务和请求GC等。</p> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {
    public PackageManagerService(Injector injector, boolean onlyCore, boolean factoryTest,
            final String buildFingerprint, final boolean isEngBuild,
            final boolean isUserDebugBuild, final int sdkVersion, final String incrementalVersion) {
        ...
        synchronized (mInstallLock) {
        synchronized (mLock) {
            ...
            EventLog.writeEvent(EventLogTags.BOOT_PROGRESS_PMS_READY, SystemClock.uptimeMillis());
            //管理安装会话的服务
            mInstallerService = mInjector.getPackageInstallerService();
            final ComponentName instantAppResolverComponent = getInstantAppResolverLPr();
            ...
            updateInstantAppInstallerLocked(null);
            ...      
            VMRuntime.getRuntime().requestConcurrentGC();//请求GC
        }
        }
        ...
    }
}</code></pre> 
<h3 id="2.4%20PKMS.installWhitelistedSystemPackages()">2.4 PKMS.installWhitelistedSystemPackages()</h3> 
<p>安装白名单中的系统App。</p> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {
    /** Install/uninstall system packages for all users based on their user-type, as applicable. */
    private void installWhitelistedSystemPackages() {
        synchronized (mLock) {
            final boolean scheduleWrite = mUserManager.installWhitelistedSystemPackages(
                    isFirstBoot(), isDeviceUpgrading(), mExistingPackages);
            if (scheduleWrite) {
                scheduleWritePackageRestrictionsLocked(UserHandle.USER_ALL);
                scheduleWriteSettingsLocked();
            }
        }
    }
    }
}</code></pre> 
<h3 id="2.5%C2%A0PackageManagerNative%E7%B1%BB">2.5 PackageManagerNative类</h3> 
<p>PackageManagerNative是PKMS的内部类，extends IPackageManagerNative.Stub，主要用来与native层通过AIDL通信。</p> 
<pre><code class="language-java">public class PackageManagerService extends IPackageManager.Stub
        implements PackageSender, TestUtilityService {​
    private class PackageManagerNative extends IPackageManagerNative.Stub {
        @Override
        public String[] getAllPackages() {
            return PackageManagerService.this.getAllPackages().toArray(new String[0]);
        }
        ...
    ​}
}</code></pre>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/82d975f6ba1fc0eeba71810bea729775/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">计算机网络3：速率、带宽、时延、吞吐量、时延带宽积、往返时间和利用率</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/931e30ea2a1d350931f82295a03fa6af/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">vant list列表组件分页场景使用 及 搜索框输入-请求数据-防抖处理</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>