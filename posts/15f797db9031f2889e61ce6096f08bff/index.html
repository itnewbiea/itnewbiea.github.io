<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>zabbix4.0-自定义脚本告警 - IT学习者博客</title>
	<script>(function(d,e){d[e]=d[e].replace("no-js","js");})(document.documentElement,"className");</script>
	<meta name="description" content="">
		<meta property="og:title" content="zabbix4.0-自定义脚本告警" />
<meta property="og:description" content="目录
1、在zabbix-server端下载mailx
2、配置mailx配置文件
3、查看zabbix-server设置的 AlertScriptsPath变量
4、在对应路径下面编写邮件脚本
5、创建一个媒介类型
6、为用户指定媒介类型
7、更改触发器表达式进行测试
1、在zabbix-server端下载mailx [root@zabbix-server ~]# yum install -y mailx 已加载插件：fastestmirror Loading mirror speeds from cached hostfile * base: mirrors.ustc.edu.cn * centos-sclo-rh: mirrors.ustc.edu.cn * centos-sclo-sclo: mirrors.ustc.edu.cn * extras: mirrors.ustc.edu.cn * updates: mirrors.ustc.edu.cn base | 3.6 kB 00:00:00 centos-sclo-rh | 3.0 kB 00:00:00 centos-sclo-sclo | 3.0 kB 00:00:00 extras | 2.9 kB 00:00:00 updates | 2.9 kB 00:00:00 zabbix | 2.9 kB 00:00:00 zabbix-non-supported | 2." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://itnewbiea.github.io/posts/15f797db9031f2889e61ce6096f08bff/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-02-25T18:52:09+08:00" />
<meta property="article:modified_time" content="2023-02-25T18:52:09+08:00" />


	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link rel="dns-prefetch" href="//fonts.googleapis.com">
	<link rel="dns-prefetch" href="//fonts.gstatic.com">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700">

	<link rel="stylesheet" href="/css/style.css">
	

	<link rel="shortcut icon" href="/favicon.ico">
		
</head>
<body class="body">
	<div class="container container--outer">
		<header class="header">
	<div class="container header__container">
		
	<div class="logo">
		<a class="logo__link" href="/" title="IT学习者博客" rel="home">
			<div class="logo__item logo__text">
					<div class="logo__title">IT学习者博客</div>
					
				</div>
		</a>
	</div>
		<div class="divider"></div>
	</div>
</header>
		<div class="wrapper flex">
			<div class="primary">
			
<main class="main" role="main">
	<article class="post">
		<header class="post__header">
			<h1 class="post__title">zabbix4.0-自定义脚本告警</h1>
			
		</header>
		<div class="content post__content clearfix">
			
<div id="content_views" class="htmledit_views">
                    <p id="main-toc"><strong>目录</strong></p> 
<p id="1%E3%80%81%E5%9C%A8zabbix-server%E7%AB%AF%E4%B8%8B%E8%BD%BDmailx-toc" style="margin-left:40px;"><a href="#1%E3%80%81%E5%9C%A8zabbix-server%E7%AB%AF%E4%B8%8B%E8%BD%BDmailx" rel="nofollow">1、在zabbix-server端下载mailx</a></p> 
<p id="2%E3%80%81%E9%85%8D%E7%BD%AEmailx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6-toc" style="margin-left:40px;"><a href="#2%E3%80%81%E9%85%8D%E7%BD%AEmailx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6" rel="nofollow">2、配置mailx配置文件</a></p> 
<p id="%C2%A03%E3%80%81%E6%9F%A5%E7%9C%8Bzabbix-server%E8%AE%BE%E7%BD%AE%E7%9A%84%C2%A0AlertScriptsPath%E5%8F%98%E9%87%8F-toc" style="margin-left:40px;"><a href="#%C2%A03%E3%80%81%E6%9F%A5%E7%9C%8Bzabbix-server%E8%AE%BE%E7%BD%AE%E7%9A%84%C2%A0AlertScriptsPath%E5%8F%98%E9%87%8F" rel="nofollow"> 3、查看zabbix-server设置的 AlertScriptsPath变量</a></p> 
<p id="4%E3%80%81%E5%9C%A8%E5%AF%B9%E5%BA%94%E8%B7%AF%E5%BE%84%E4%B8%8B%E9%9D%A2%E7%BC%96%E5%86%99%E9%82%AE%E4%BB%B6%E8%84%9A%E6%9C%AC-toc" style="margin-left:40px;"><a href="#4%E3%80%81%E5%9C%A8%E5%AF%B9%E5%BA%94%E8%B7%AF%E5%BE%84%E4%B8%8B%E9%9D%A2%E7%BC%96%E5%86%99%E9%82%AE%E4%BB%B6%E8%84%9A%E6%9C%AC" rel="nofollow">4、在对应路径下面编写邮件脚本</a></p> 
<p id="%C2%A05%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AA%92%E4%BB%8B%E7%B1%BB%E5%9E%8B-toc" style="margin-left:40px;"><a href="#%C2%A05%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AA%92%E4%BB%8B%E7%B1%BB%E5%9E%8B" rel="nofollow"> 5、创建一个媒介类型</a></p> 
<p id="6%E3%80%81%E4%B8%BA%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9A%E5%AA%92%E4%BB%8B%E7%B1%BB%E5%9E%8B-toc" style="margin-left:40px;"><a href="#6%E3%80%81%E4%B8%BA%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9A%E5%AA%92%E4%BB%8B%E7%B1%BB%E5%9E%8B" rel="nofollow">6、为用户指定媒介类型</a></p> 
<p id="%C2%A07%E3%80%81%E6%9B%B4%E6%94%B9%E8%A7%A6%E5%8F%91%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95-toc" style="margin-left:40px;"><a href="#%C2%A07%E3%80%81%E6%9B%B4%E6%94%B9%E8%A7%A6%E5%8F%91%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95" rel="nofollow"> 7、更改触发器表达式进行测试</a></p> 
<p></p> 
<h3 id="1%E3%80%81%E5%9C%A8zabbix-server%E7%AB%AF%E4%B8%8B%E8%BD%BDmailx">1、在zabbix-server端下载mailx</h3> 
<pre><code class="language-bash">[root@zabbix-server ~]# yum install -y mailx
已加载插件：fastestmirror
Loading mirror speeds from cached hostfile
 * base: mirrors.ustc.edu.cn
 * centos-sclo-rh: mirrors.ustc.edu.cn
 * centos-sclo-sclo: mirrors.ustc.edu.cn
 * extras: mirrors.ustc.edu.cn
 * updates: mirrors.ustc.edu.cn
base                                                                                             | 3.6 kB  00:00:00     
centos-sclo-rh                                                                                   | 3.0 kB  00:00:00     
centos-sclo-sclo                                                                                 | 3.0 kB  00:00:00     
extras                                                                                           | 2.9 kB  00:00:00     
updates                                                                                          | 2.9 kB  00:00:00     
zabbix                                                                                           | 2.9 kB  00:00:00     
zabbix-non-supported                                                                             | 2.9 kB  00:00:00     
正在解决依赖关系
--&gt; 正在检查事务
---&gt; 软件包 mailx.x86_64.0.12.5-19.el7 将被 安装
--&gt; 解决依赖关系完成

依赖关系解决

========================================================================================================================
 Package                   架构                       版本                               源                        大小
========================================================================================================================
正在安装:
 mailx                     x86_64                     12.5-19.el7                        base                     245 k

事务概要
========================================================================================================================
安装  1 软件包

总下载量：245 k
安装大小：466 k
Downloading packages:
mailx-12.5-19.el7.x86_64.rpm                                                                     | 245 kB  00:00:00     
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  正在安装    : mailx-12.5-19.el7.x86_64                                                                            1/1 
  验证中      : mailx-12.5-19.el7.x86_64                                                                            1/1 

已安装:
  mailx.x86_64 0:12.5-19.el7                                                                                            

完毕！
</code></pre> 
<p><span style="color:#ffd900;"><strong>#################################################### </strong></span></p> 
<h3 id="2%E3%80%81%E9%85%8D%E7%BD%AEmailx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6">2、配置mailx配置文件</h3> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>编辑mailx配置文件，添加参数 </strong></span></p> 
</blockquote> 
<pre><code class="language-bash">vim /etc/mail.rc 
</code></pre> 
<pre><code class="language-bash">set from=发件邮箱@163.com smtp=smtp.163.com
set smtp-auth-user=发件邮箱@163.com smtp-auth-password=smtp授权码
set smtp-auth=login
</code></pre> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>使用mailx测试能否发送邮件给对应收件邮箱</strong></span></p> 
</blockquote> 
<pre><code class="language-bash">echo "this is a email for test from zabbix" | mail -s "zabbix test" 收件邮箱@163.com</code></pre> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>邮件接收显示成功</strong></span></p> 
</blockquote> 
<p><img alt="" height="401" src="https://images2.imgbox.com/f3/3c/lNWlxdrv_o.png" width="646"></p> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>刚才的测试是通过mailx来发送的邮件，那么怎么让zabbix-server找到这个脚本呢？</strong></span></p> 
</blockquote> 
<p><span style="color:#ffd900;"><strong>#################################################### </strong></span> </p> 
<h3 id="%C2%A03%E3%80%81%E6%9F%A5%E7%9C%8Bzabbix-server%E8%AE%BE%E7%BD%AE%E7%9A%84%C2%A0AlertScriptsPath%E5%8F%98%E9%87%8F"> 3、查看zabbix-server设置的 AlertScriptsPath变量</h3> 
<pre><code class="language-bash">vim zabbix_server.conf 
AlertScriptsPath=/usr/lib/zabbix/alertscripts
</code></pre> 
<h3 id="4%E3%80%81%E5%9C%A8%E5%AF%B9%E5%BA%94%E8%B7%AF%E5%BE%84%E4%B8%8B%E9%9D%A2%E7%BC%96%E5%86%99%E9%82%AE%E4%BB%B6%E8%84%9A%E6%9C%AC">4、在对应路径下面编写邮件脚本</h3> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>安装dos2unix包，这个包可以将正文变成附件的形式</strong></span></p> 
</blockquote> 
<pre><code class="language-bash">yum install -y dos2unix
</code></pre> 
<pre><code class="language-bash">[root@zabbix-server alertscripts]# cd /usr/lib/zabbix/alertscripts/
[root@zabbix-server alertscripts]# cat sendmail.sh 
#!/bin/bash

sendto=$1   # 邮件发送给谁
subject=$2  # 邮件标题
body=$3     #邮件正文
FILE=/tmp/mail.tmp
echo "$body" &gt; $FILE
dos2unix -k $FILE    # 将正文变成附件
mail -s "$subject" "$sendto"  &lt; $FILE  # 发送邮件
</code></pre> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>给与脚本可执行权限、</strong></span></p> 
</blockquote> 
<pre><code class="language-bash"> chmod +x sendmail.sh 
</code></pre> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>将zabbix设置为/tmp/mail.tmp的拥有者</strong></span></p> 
</blockquote> 
<pre><code class="language-bash">chown zabbix.zabbix /tmp/mail.tmp 
</code></pre> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>执行脚本，传入三个参数，测试是否可以发送邮件</strong></span></p> 
</blockquote> 
<pre><code class="language-bash">./sendmail.sh 接收邮箱@163.com zabbix "123456zabbix"</code></pre> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>邮件接收成功</strong></span></p> 
</blockquote> 
<p><img alt="" height="251" src="https://images2.imgbox.com/31/a2/W1GLT63c_o.png" width="581"></p> 
<p><span style="color:#ffd900;"><strong>#################################################### </strong></span> </p> 
<h3 id="%C2%A05%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%AA%92%E4%BB%8B%E7%B1%BB%E5%9E%8B"> 5、创建一个媒介类型</h3> 
<p><img alt="" height="584" src="https://images2.imgbox.com/c3/bd/gf3kGTy3_o.png" width="944"></p> 
<p><img alt="" height="586" src="https://images2.imgbox.com/02/f8/nbAddEtG_o.png" width="1200"> </p> 
<p><span style="color:#ffd900;"><strong>#################################################### </strong></span> </p> 
<h3 id="6%E3%80%81%E4%B8%BA%E7%94%A8%E6%88%B7%E6%8C%87%E5%AE%9A%E5%AA%92%E4%BB%8B%E7%B1%BB%E5%9E%8B">6、为用户指定媒介类型</h3> 
<p> <img alt="" height="847" src="https://images2.imgbox.com/9c/5e/1dgU9zKe_o.png" width="1079"></p> 
<p><span style="color:#ffd900;"><strong>#################################################### </strong></span> </p> 
<h3 id="%C2%A07%E3%80%81%E6%9B%B4%E6%94%B9%E8%A7%A6%E5%8F%91%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%BF%9B%E8%A1%8C%E6%B5%8B%E8%AF%95"> 7、更改触发器表达式进行测试</h3> 
<p><img alt="" height="428" src="https://images2.imgbox.com/b6/18/KAYK00kT_o.png" width="967"></p> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong> 触发器触发成功，邮件已发送</strong></span></p> 
</blockquote> 
<p><img alt="" height="845" src="https://images2.imgbox.com/dd/7c/WDpixlQv_o.png" width="1200"></p> 
<p> <img alt="" height="424" src="https://images2.imgbox.com/1d/eb/i7EWb8sZ_o.png" width="667"></p> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong>将触发器修改回来以后，可以正常收到恢复邮件</strong></span></p> 
</blockquote> 
<p><img alt="" height="417" src="https://images2.imgbox.com/58/e8/15s1hOuB_o.png" width="833"></p> 
<p> <img alt="" height="384" src="https://images2.imgbox.com/d9/b9/yi2IGZAX_o.png" width="544"></p> 
<p> </p> 
<blockquote> 
 <p><span style="color:#1c7331;"><strong> 邮件接收成功，使用脚本发送告警邮件的方式成功。</strong></span></p> 
</blockquote> 
<p> </p>
                </div>
		</div>
	</article>
</main>


<nav class="pager flex">
	<div class="pager__item pager__item--prev">
		<a class="pager__link" href="/posts/6c843d73fe43915d4ce4a2f6f7cc0b4f/" rel="prev">
			<span class="pager__subtitle">«&thinsp;Previous</span>
			<p class="pager__title">微信电脑版字体模糊（或文字太小）怎么调整</p>
		</a>
	</div>
	<div class="pager__item pager__item--next">
		<a class="pager__link" href="/posts/966cf332d19636264208aef9fb7f111a/" rel="next">
			<span class="pager__subtitle">Next&thinsp;»</span>
			<p class="pager__title">CSDN每日一练</p>
		</a>
	</div>
</nav>


			</div>
			
		</div>
		<footer class="footer">
	<div class="container footer__container flex">
		
		<div class="footer__copyright">
			&copy; 2024 IT学习者博客.
			<span class="footer__copyright-credits">Generated with <a href="https://gohugo.io/" rel="nofollow noopener" target="_blank">Hugo</a> and <a href="https://github.com/Vimux/Mainroad/" rel="nofollow noopener" target="_blank">Mainroad</a> theme.</span>
		</div>
	</div>
</footer>
<script src="https://itnewbiea.github.io/js/foot.js"></script>


	</div>
<script async defer src="/js/menu.js"></script>
</body>
</html>